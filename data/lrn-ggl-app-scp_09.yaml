- en: Chapter 9. More Tips and Tricks and Creating an Add-on
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第9章。更多技巧和窍门以及创建插件
- en: 'In the previous chapter, you built an order processing workflow application.
    In this chapter, you will learn:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一章中，你构建了一个订单处理工作流应用程序。在本章中，你将学习：
- en: To overcome script maximum execution time restriction
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要克服脚本最大执行时间限制
- en: To use script codes from other script files or libraries
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要使用来自其他脚本文件或库的脚本代码
- en: Create add-ons that use the OAuth2 external library
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 创建使用OAuth2外部库的插件
- en: Overcoming the "script exceeded maximum execution time" error
  id: totrans-5
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 克服“脚本超出最大执行时间”错误
- en: What if one of your script functions has a bug that causes endless (not terminating)
    execution, for example, an endless for loop and/or while loop. There are no remedies
    other than carefully examining the loop terminating statements.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你的脚本函数中存在一个导致无限（不终止）执行的错误，例如无限循环和/或while循环。除了仔细检查循环终止语句外，没有其他补救措施。
- en: Sometimes, your script may be flawless or bug free, but if it needs to handle
    a large spreadsheet or external data, it may take a long time to complete the
    execution. The maximum allowed time for your script to run continuously is 6 minutes.
    If it exceeds that limit, GAS would throw the "Exceeded maximum execution time"
    exception.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 有时候，你的脚本可能完美无瑕或无错误，但如果它需要处理大型电子表格或外部数据，它可能需要很长时间才能完成执行。你的脚本连续运行的最大允许时间是6分钟。如果超过这个限制，GAS会抛出“超出最大执行时间”异常。
- en: Tip
  id: totrans-8
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 小贴士
- en: 'For a list of other limitations, please visit: [https://developers.google.com/apps-script/guides/services/quotas#current_limitations](https://developers.google.com/apps-script/guides/services/quotas#current_limitations).'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 有关其他限制的列表，请访问：[https://developers.google.com/apps-script/guides/services/quotas#current_limitations](https://developers.google.com/apps-script/guides/services/quotas#current_limitations)。
- en: To overcome this bottleneck, you can follow these steps. For example, if your
    `doLengthyProcess` function takes a long time to finish, then manually create
    a minute's trigger for the `doLengthyProcess` function so that it executes every
    10 minutes. Your function should periodically check the elapsed time since the
    start. If the function completes successfully within the time limit then, at the
    end of the function, it deletes the trigger. Otherwise, the trigger value is stored
    in a loop counter in a dedicated Sheet or in script properties. This value should
    be read and assigned to the loop counter, when the function is triggered again.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 要克服这个瓶颈，你可以遵循以下步骤。例如，如果你的`doLengthyProcess`函数需要很长时间才能完成，那么你可以手动为`doLengthyProcess`函数创建一个分钟的触发器，使其每10分钟执行一次。你的函数应该定期检查自开始以来的经过时间。如果在时间限制内成功完成，则在函数结束时删除触发器。否则，触发器值存储在专门的Sheet中的循环计数器或脚本属性中。当函数再次被触发时，应该读取并分配给循环计数器。
- en: 'A sample skeleton of such a function is given here:'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 这里给出这样一个函数的示例结构：
- en: '[PRE0]'
  id: totrans-12
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: To sum up, you create an "every minutes" trigger manually, and then the function
    executes until it completes successfully.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 总结来说，你手动创建一个“每分钟”触发器，然后函数执行直到成功完成。
- en: 'If you feel hesitant to create triggers manually, you can create them by script
    as we discussed in [Chapter 3](ch03.html "Chapter 3. Parsing and Sending E-mails"),
    *Parsing and Sending E-mails* but this time, create every minute''s trigger:'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你犹豫是否手动创建触发器，你可以按照我们在[第3章](ch03.html "第3章。解析和发送电子邮件")中讨论的方法，通过脚本创建它们，*解析和发送电子邮件*，但这次创建每分钟的触发器：
- en: '[PRE1]'
  id: totrans-15
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Here you created a trigger for the functions which do not start immediately
    but with a delay. However, if you want to automate everything, it means creating
    a trigger and calling the function immediately. Create another function `startProcess`
    as shown here:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，你为那些不是立即开始而是有延迟的函数创建了一个触发器。然而，如果你想自动化一切，这意味着创建一个触发器并立即调用函数。创建另一个函数`startProcess`，如下所示：
- en: '[PRE2]'
  id: totrans-17
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Now, you just need to run the `startProcess` function. Also, you can assign
    a menu for this function.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，你只需要运行`startProcess`函数。此外，你还可以为此函数分配一个菜单。
- en: Configuring your script project to use external libraries
  id: totrans-19
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 配置你的脚本项目以使用外部库
- en: Sometimes you would like to reuse code from other script project(s) or other
    programmer's code in your projects. You can import external code as it resides
    in the current project. You need to make a simple configuration in your current
    project.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 有时候，你可能希望在你的项目中重用来自其他脚本项目或其他程序员代码的代码。你可以将外部代码导入当前项目中，你需要在当前项目中进行简单的配置。
- en: For an example, we will explain how to import the previous chapter's code into
    the current project.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，我们将解释如何将上一章的代码导入当前项目。
- en: Open any one of your previously created scripts (for example, [Chapter 8](ch08.html
    "Chapter 8. Building a Workflow Application"), *Building a Workflow Application*)
    in the script editor, save a version if you haven't already.
  id: totrans-22
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在脚本编辑器中打开你之前创建的任何脚本（例如，[第8章](ch08.html "第8章. 构建工作流应用程序") *构建工作流应用程序*），如果你还没有保存，请保存一个版本。
- en: Now, click on the **File** menu and then **Project properties**. The **Project
    properties** dialog will open as shown here:![Configuring your script project
    to use external libraries](img/B05010_09_01.jpg)
  id: totrans-23
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，点击**文件**菜单，然后**项目属性**。**项目属性**对话框将打开，如下所示：![配置脚本项目以使用外部库](img/B05010_09_01.jpg)
- en: Copy the **Project key** value (this value should be different for your project).
  id: totrans-24
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 复制**项目密钥**值（这个值对于你的项目应该是不同的）。
- en: Open the current script, navigate to **Resources** | **Libraries…**, and then
    the **Included Libraries** dialog will open as shown here:![Configuring your script
    project to use external libraries](img/B05010_09_02.jpg)
  id: totrans-25
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开当前脚本，导航到**资源** | **库…**，然后**包含的库**对话框将打开，如下所示：![配置脚本项目以使用外部库](img/B05010_09_02.jpg)
- en: Paste **Project key** (you already copied in step 1) into the **Find a Library**
    textbox and click on the **Select** button.
  id: totrans-26
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将**项目密钥**（你在第1步中已经复制）粘贴到**查找库**文本框中，然后点击**选择**按钮。
- en: 'Now, the `Chapter 8` project will be included in the libraries list as shown
    here:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，`Chapter 8` 项目将包含在库列表中，如下所示：
- en: '![Configuring your script project to use external libraries](img/B05010_09_03.jpg)'
  id: totrans-28
  prefs: []
  type: TYPE_IMG
  zh: '![配置脚本项目以使用外部库](img/B05010_09_03.jpg)'
- en: Select the version (the version you are going to use in this current project);
    and if you like, you can change the identifier (`Chapter8`) too. Leave **Development
    Mode** off means using a selected version; set it to **on** to override the selected
    version and use the current version. Click on the **Save** button to save the
    changes.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 选择版本（你将在当前项目中使用的版本）；如果你愿意，你还可以更改标识符（`Chapter8`）。关闭**开发模式**意味着使用所选版本；将其设置为**开启**以覆盖所选版本并使用当前版本。点击**保存**按钮以保存更改。
- en: Now all the functions (except private functions, that is, function names appended
    with "`_`") and the global variables are available to use in the current project.
    For example, you can use the `doGet` function from [Chapter 8](ch08.html "Chapter 8. Building
    a Workflow Application"), *Building a Workflow Application* here by prefixing
    with the identifier. It means that you can use the `doGet` function as `Chapter8.doGet()`,
    the `getPrice` function as `Chapter8.getPrice()`, and so on.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 现在所有函数（除了私有函数，即以"`_`"结尾的函数名）和全局变量都可以在当前项目中使用。例如，你可以通过在标识符前加上前缀来使用来自[第8章](ch08.html
    "第8章. 构建工作流应用程序") *构建工作流应用程序* 的 `doGet` 函数。这意味着你可以将 `doGet` 函数作为 `Chapter8.doGet()`
    使用，将 `getPrice` 函数作为 `Chapter8.getPrice()` 使用，依此类推。
- en: 'If you need more explanation, then here is a sample usage:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你需要更多解释，请参考以下示例用法：
- en: '[PRE3]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Using JSDoc annotations
  id: totrans-33
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用 JSDoc 注解
- en: 'In the preceding test function, you can see that the code hint became active
    as soon as you type a ''`.`'' next to the identifier name (`Chapter8`). This shows
    all the functions and global variables available in the external library as shown
    here:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 在前面的测试函数中，你可以看到，一旦你在标识符名称（`Chapter8`）旁边输入一个'.'，代码提示就会立即激活。这显示了外部库中所有可用的函数和全局变量，如下所示：
- en: '![Using JSDoc annotations](img/B05010_09_04.jpg)'
  id: totrans-35
  prefs: []
  type: TYPE_IMG
  zh: '![使用 JSDoc 注解](img/B05010_09_04.jpg)'
- en: The preceding code hints are generic, for example, `index` shown as `Object`.
    For detailed code hints, you should use the JSDoc style documentations (annotations
    or comments at top lines of function definitions).
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 上述代码提示是通用的，例如，`index` 显示为 `Object`。对于详细的代码提示，你应该使用 JSDoc 风格的文档（函数定义顶部的注解或注释）。
- en: 'For example, if you used the following annotations to the `getPrice` function
    in [Chapter 8](ch08.html "Chapter 8. Building a Workflow Application"), *Building
    a Workflow Application*:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，如果你在[第8章](ch08.html "第8章. 构建工作流应用程序") *构建工作流应用程序*中对 `getPrice` 函数使用了以下注解：
- en: '[PRE4]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Then the code hint would be as shown here:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，代码提示将如下所示：
- en: '![Using JSDoc annotations](img/B05010_09_05.jpg)'
  id: totrans-40
  prefs: []
  type: TYPE_IMG
  zh: '![使用 JSDoc 注解](img/B05010_09_05.jpg)'
- en: Now, you can notice how the code hint returns with useful information for the
    `getPrice` function.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，你可以注意到代码提示如何返回有关 `getPrice` 函数的有用信息。
- en: Tip
  id: totrans-42
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 小贴士
- en: 'For further reading on JSDoc, visit: [https://developers.google.com/closure/compiler/docs/js-for-compiler](https://developers.google.com/closure/compiler/docs/js-for-compiler).'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 要进一步了解 JSDoc，请访问：[https://developers.google.com/closure/compiler/docs/js-for-compiler](https://developers.google.com/closure/compiler/docs/js-for-compiler)。
- en: Using the OAuth open source library
  id: totrans-44
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用开源 OAuth 库
- en: If your application interacts with external libraries other than Google's basic
    services, then it should be authenticated. In other words, if your application
    runs on behalf of a user, then that user should authorize your application to
    grant access to his/her data. GAS does not provide any built-in authentication
    service, but you can use an open source OAuth library.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您的应用程序与 Google 基本服务以外的外部库交互，则应该进行认证。换句话说，如果您的应用程序代表用户运行，那么该用户应该授权您的应用程序访问其数据。GAS
    不提供任何内置的认证服务，但您可以使用开源的 OAuth 库。
- en: Creating, testing, and publishing add-ons
  id: totrans-46
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建、测试和发布插件
- en: If you need to use other external libraries in your current project, you need
    to know the project key and you should have at least read access to that project.
    At the same time, every new version of the master project will not reflect in
    the client project unless the client selects the current version. Add-ons override
    this configuration hassle.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您需要在当前项目中使用其他外部库，您需要知道项目密钥，并且您应该至少有对该项目的读取权限。同时，除非客户端选择当前版本，否则主项目的每个新版本都不会反映在客户端项目中。插件可以覆盖此配置麻烦。
- en: Add-ons are installable scripts by the click of a button, no configuration required.
    You can install add-ons in Sheets, Docs, and/or Forms published by the other programmer
    or from the Google Chrome Web Store.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 插件可以通过点击按钮安装，无需配置。您可以在其他程序员发布的 Sheets、Docs 和/或 Forms 中，或从 Google Chrome Web
    Store 安装插件。
- en: Installing add-ons from Chrome Web Store
  id: totrans-49
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 从 Chrome Web Store 安装插件
- en: To install an add-on from Chrome Web Store, open the document (Sheets, Docs,
    or Forms) and click on **Get add-ons…** from the **Add-ons** menu. Select any
    one of your favorite add-ons from the **Add-ons** dialog (if you hover your mouse
    over any add-on, then a plus symbol will appear on the application; click on it
    and authorize if required). A sample **Add-ons** dialog is shown here, but the
    actual add-ons included may vary from time to time.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 要从 Chrome Web Store 安装插件，打开文档（Sheets、Docs 或 Forms），然后从 **插件** 菜单点击 **获取插件…**。从
    **插件** 对话框中选择您喜欢的任何一个插件（如果您将鼠标悬停在任何一个插件上，则应用程序上会出现一个加号符号；点击它并在需要时进行授权）。这里显示了一个示例
    **插件** 对话框，但实际包含的插件可能会随时间而变化。
- en: '![Installing add-ons from Chrome Web Store](img/B05010_09_06.jpg)'
  id: totrans-51
  prefs: []
  type: TYPE_IMG
  zh: '![从 Chrome Web Store 安装插件](img/B05010_09_06.jpg)'
- en: 'You will get that add-on installed and added to your document''s **Add-ons**
    menu. Each add-on comes with easy-to-use menu items. For example, if you installed
    **autoCrat** then the menu item would look like in the screenshot shown here:'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 您将安装该插件并将其添加到文档的 **插件** 菜单中。每个插件都附带易于使用的菜单项。例如，如果您安装了 **autoCrat**，则菜单项将类似于此处显示的截图：
- en: '![Installing add-ons from Chrome Web Store](img/B05010_09_07.jpg)'
  id: totrans-53
  prefs: []
  type: TYPE_IMG
  zh: '![从 Chrome Web Store 安装插件](img/B05010_09_07.jpg)'
- en: Creating custom add-ons
  id: totrans-54
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 创建自定义插件
- en: You can create add-ons by yourself, use within your other documents, or share
    with other users. Your users can use your add-ons but cannot see the code. So,
    you can keep your intellectual property (that is, code and data) confidential.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以自己创建插件，在您的其他文档中使用，或与其他用户共享。您的用户可以使用您的插件，但不能看到代码。因此，您可以保持您的知识产权（即代码和数据）的秘密。
- en: 'Add menu items to the **Add-on** menu such that:'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 将菜单项添加到 **插件** 菜单，以便：
- en: '[PRE5]'
  id: totrans-57
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'The `addItem` method''s first argument is the label for the menu item and the
    next one is the function name. Add the `onInstall` event function if you are going
    to publish an add-on for Chrome Web Store such that:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: '`addItem` 方法的第一个参数是菜单项的标签，下一个是函数名。如果您打算为 Chrome Web Store 发布插件，请添加 `onInstall`
    事件函数：'
- en: '[PRE6]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'The preceding function invokes the `onOpen` function while the add-on is installed
    for the first time in Sheets, Docs, or Forms. If your add-on needs a user interface,
    then create the sidebar dialog:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 前面的函数在 Sheets、Docs 或 Forms 中首次安装插件时调用 `onOpen` 函数。如果您的插件需要用户界面，则创建侧边栏对话框：
- en: '[PRE7]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: To style the sidebar (create `Sidebar.html`), you can use the officially supported
    CSS package from the [https://ssl.gstatic.com/docs/script/css/add-ons1.css](https://ssl.gstatic.com/docs/script/css/add-ons1.css)
    URL.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 要样式化侧边栏（创建 `Sidebar.html`），您可以使用从 [https://ssl.gstatic.com/docs/script/css/add-ons1.css](https://ssl.gstatic.com/docs/script/css/add-ons1.css)
    网址提供的官方支持的 CSS 包。
- en: Note
  id: totrans-63
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: For more help on this package visit [https://developers.google.com/apps-script/add-ons/css](https://developers.google.com/apps-script/add-ons/css).
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 如需更多关于此包的帮助，请访问 [https://developers.google.com/apps-script/add-ons/css](https://developers.google.com/apps-script/add-ons/css)。
- en: Testing your add-on
  id: totrans-65
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 测试您的插件
- en: 'To test your add-on within the script editor, navigate to the **Publish** |
    **Test as add-on…** menu and then within the resulting dialog select the document
    in which you want to test the add-on as shown here:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 要在脚本编辑器中测试您的插件，请转到 **发布** | **测试为插件…** 菜单，然后在出现的对话框中选择您想要测试插件的文档，如下所示：
- en: '![Testing your add-on](img/B05010_09_08.jpg)'
  id: totrans-67
  prefs: []
  type: TYPE_IMG
  zh: '![测试您的插件](img/B05010_09_08.jpg)'
- en: To share your add-on with others, it is enough to share the document. More than
    that, if you would like to publish the script, follow the **Publish** | **Deploy**
    as an add-on menu. In the resulting dialog, fill the required fields and follow
    the guidelines provided. Your add-on should strictly adhere to the Chrome Web
    Store's content and style guidelines and undergo a review process before being
    listed and made available to the public.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 要与他人共享您的插件，只需共享文档即可。更多的话，如果您想发布脚本，请按照 **发布** | **部署为插件** 菜单操作。在出现的对话框中填写所需字段并遵循提供的指南。您的插件应严格遵守
    Chrome Web Store 的内容和风格指南，并在上市和向公众提供之前经过审查流程。
- en: Note
  id: totrans-69
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: For more information on add-ons, visit [https://developers.google.com/apps-script/add-ons/](https://developers.google.com/apps-script/add-ons/).
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 如需有关插件的更多信息，请访问 [https://developers.google.com/apps-script/add-ons/](https://developers.google.com/apps-script/add-ons/)。
- en: Creating an add-on that uses an OAuth2 external library
  id: totrans-71
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 创建使用 OAuth2 外部库的插件
- en: To get hands-on experience on all aforesaid concepts, we will create an add-on
    that can send an active spreadsheet as a PDF attachment to the active user's e-mail
    ID.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 为了获得上述所有概念的实际操作经验，我们将创建一个插件，可以将活动电子表格作为 PDF 附件发送到活动用户的电子邮件地址。
- en: 'Create a new script project in Sheets. In the script editor, we will first
    create a few global variables as shown here:'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Sheets 中创建一个新的脚本项目。在脚本编辑器中，我们首先创建几个全局变量，如下所示：
- en: '[PRE8]'
  id: totrans-74
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Next, take a look at the `onOpen` and `onInstall` trigger functions.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，查看 `onOpen` 和 `onInstall` 触发器函数。
- en: '[PRE9]'
  id: totrans-76
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'In the `onOpen` trigger, we have associated the function `sendSheetAsPdfToActiveUser`
    to the **Sheet To PDF** menu item. We will create that function now:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 在 `onOpen` 触发器中，我们将 `sendSheetAsPdfToActiveUser` 函数关联到 **Sheet To PDF** 菜单项。我们现在将创建该函数：
- en: '[PRE10]'
  id: totrans-78
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'The said function sends an e-mail with the PDF attachment, which is returned
    from the `getAttachments` function. An example is given here:'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 该功能通过 `getAttachments` 函数返回的 PDF 附件发送带有附件的电子邮件。以下是一个示例：
- en: '[PRE11]'
  id: totrans-80
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: The said function prompts the user to authenticate the application if he is
    using it for the first time or already has an authenticated token but it is expired.
    If the authenticated token is valid, then it returns the PDF attachment, otherwise
    it returns false.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 该功能提示用户在首次使用或已有一个有效的认证令牌但已过期时对应用程序进行认证。如果认证令牌有效，则返回 PDF 附件，否则返回 false。
- en: 'Now, the only thing we have left to do is implementing OAuth2 flow. We will
    create a function for the same:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们唯一剩下要做的就是实现 OAuth2 流程。我们将为同一目的创建一个函数：
- en: '[PRE12]'
  id: totrans-83
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Don't forget to replace your own client ID and secret. We will see how to get
    them. Can you remember what you did to enable advanced services in [Chapter 5](ch05.html
    "Chapter 5. Creating Google Calendar and Drive Applications"), *Creating Google
    Calendar and Drive Applications*? Use the same steps here, but with a few additional
    tasks.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 不要忘记替换您自己的客户端 ID 和密钥。我们将看到如何获取它们。您还记得在 [第 5 章](ch05.html "第 5 章。创建 Google 日历和
    Drive 应用程序") *创建 Google 日历和 Drive 应用程序* 中您做了什么来启用高级服务吗？在这里使用相同的步骤，但增加一些额外的任务。
- en: 'Within the script editor, navigate to **Resources** | **Developers Console
    Project…** and click on **View Developers Console** on the dialog that opens:'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 在脚本编辑器中，转到 **资源** | **开发者控制台项目…** 并在打开的对话框中点击 **查看开发者控制台**：
- en: '![Creating an add-on that uses an OAuth2 external library](img/B05010_09_09.jpg)'
  id: totrans-86
  prefs: []
  type: TYPE_IMG
  zh: '![创建使用 OAuth2 外部库的插件](img/B05010_09_09.jpg)'
- en: That should take you to the developer's console dashboard where you can click
    on the **Enable and manage APIs** option.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 这应该会带您到开发者控制台仪表板，您可以在其中点击 **启用和管理 API** 选项。
- en: '![Creating an add-on that uses an OAuth2 external library](img/B05010_09_10.jpg)'
  id: totrans-88
  prefs: []
  type: TYPE_IMG
  zh: '![创建使用 OAuth2 外部库的插件](img/B05010_09_10.jpg)'
- en: 'Once enabled, click on **Credentials** on the left pane of the console dashboard:'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦启用，点击控制台仪表板左侧的 **凭证**：
- en: '![Creating an add-on that uses an OAuth2 external library](img/B05010_09_11.jpg)'
  id: totrans-90
  prefs: []
  type: TYPE_IMG
  zh: '![创建使用OAuth2外部库的插件](img/B05010_09_11.jpg)'
- en: 'To complete the OAuth2 flow, this callback function will be invoked, and it
    shows a message to the user. Then, the OAuth2 client IDs are listed as **Apps
    Script**. Click on **Apps Script** to see the details as shown here:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 为了完成OAuth2流程，此回调函数将被调用，并向用户显示一条消息。然后，OAuth2客户端ID被列为**Apps Script**。点击**Apps
    Script**以查看如下所示的详细信息：
- en: '![Creating an add-on that uses an OAuth2 external library](img/B05010_09_12.jpg)'
  id: totrans-92
  prefs: []
  type: TYPE_IMG
  zh: '![创建使用OAuth2外部库的插件](img/B05010_09_12.jpg)'
- en: 'You need to add an authorized redirect URL for this project. Enter the URL
    as shown here, but replaced with your project key:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 您需要为此项目添加一个授权的重定向URL。输入如下所示的URL，但替换为您的项目密钥：
- en: '[PRE13]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Before clicking on **Save**, a copy of the client ID and client secret is required
    in the `getGoogleService` function. Once this is done, click on **Save**; you
    can return to this dashboard anytime afterwards.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 在点击**保存**之前，`getGoogleService`函数中需要客户端ID和客户端密钥的副本。一旦完成，点击**保存**；之后您任何时候都可以返回此仪表板。
- en: 'Also add the `authCallback` function as shown here:'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 还需添加如下所示的`authCallback`函数：
- en: '[PRE14]'
  id: totrans-97
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'Before testing the add-on, import the OAuth2 client library using the project
    key:'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 在测试插件之前，使用项目密钥导入OAuth2客户端库：
- en: '[PRE15]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: Tip
  id: totrans-100
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 小贴士
- en: 'The following are some sample keys:'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是一些示例密钥：
- en: 'OAuth1 Lib Key: `Mb2Vpd5nfD3Pz-_a-39Q4VfxhMjh3Sh48`'
  id: totrans-102
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: OAuth1库密钥：`Mb2Vpd5nfD3Pz-_a-39Q4VfxhMjh3Sh48`
- en: 'OAuth2 Lib Key: `MswhXl8fVhTFUH_Q3UOJbXvxhMjh3Sh48`'
  id: totrans-103
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: OAuth2库密钥：`MswhXl8fVhTFUH_Q3UOJbXvxhMjh3Sh48`
- en: Note
  id: totrans-104
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: For more information on open source OAuth2 external library, visit [https://github.com/googlesamples/apps-script-oauth2](https://github.com/googlesamples/apps-script-oauth2).
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 有关开源OAuth2外部库的更多信息，请访问[https://github.com/googlesamples/apps-script-oauth2](https://github.com/googlesamples/apps-script-oauth2)。
- en: Now, you have completed all the setup steps. Refresh the spreadsheet window
    so that your add-on appears in an **Add-on** menu.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，您已完成了所有设置步骤。刷新电子表格窗口，以便您的插件出现在**插件**菜单中。
- en: 'In addition, once authenticated, you can reset or revoke the authentication
    using this function:'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，一旦认证，您可以使用此功能重置或撤销认证：
- en: '[PRE16]'
  id: totrans-108
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Notice the same service name (`PACKT`) used here.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 注意这里使用的相同的服务名称（`PACKT`）。
- en: Other useful links
  id: totrans-110
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 其他有用链接
- en: 'Tutorials: [https://developers.google.com/apps-script/articles](https://developers.google.com/apps-script/articles)'
  id: totrans-111
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 教程：[https://developers.google.com/apps-script/articles](https://developers.google.com/apps-script/articles)
- en: 'Documentation: [https://developers.google.com/apps-script/](https://developers.google.com/apps-script/)'
  id: totrans-112
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 文档：[https://developers.google.com/apps-script/](https://developers.google.com/apps-script/)
- en: 'Blog: [http://googleappsdeveloper.blogspot.in/search/label/Apps%20Script](http://googleappsdeveloper.blogspot.in/search/label/Apps%20Script)'
  id: totrans-113
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 博客：[http://googleappsdeveloper.blogspot.in/search/label/Apps%20Script](http://googleappsdeveloper.blogspot.in/search/label/Apps%20Script)
- en: Summary
  id: totrans-114
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: In this chapter, you learned how to overcome script maximum run time restrictions,
    how to import external libraries, how to use OAuth, and how to create an add-on.
    We hope you enjoyed reading this book, learning, and gathering hands-on skills
    on most aspects of the Google Apps Script. Happy coding and enjoy!
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，您学习了如何克服脚本最大运行时间限制，如何导入外部库，如何使用OAuth，以及如何创建插件。我们希望您喜欢阅读这本书，学习，并在Google
    Apps Script的大部分方面积累实践经验。祝您编码愉快，享受编程！
