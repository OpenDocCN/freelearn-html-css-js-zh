# 前言

# 为什么选择微服务？

微服务在过去几年中变得越来越受欢迎。与任何新的架构概念一样，误解的空间很大。即使是“微服务”这个术语也令人困惑。新入门者常常不确定微服务的大小是否合适（提示：这实际上并不是关于代码库的大小）并且可能会卡在如何开始这种架构风格上。

面向服务的架构并非新事物。在 20 世纪 90 年代，各种公司都在推广 Web 服务作为解决大型、不灵活代码库的解决方案。承诺是 Web 服务将提供可重用的能力，这些能力可以轻松地被您的代码库消费。像 SOAP 和 WSDL 这样的技术开始被采用，但似乎从未实现易用的承诺。与此同时，像 PHP、Ruby 和 Python 这样的开源语言以及像 Symfony、Rails 和 Django 这样的框架使得开发单体 Web 中心代码库变得更加容易。

快进几十年，我们开始看到对服务的兴趣再次兴起。那么，发生了什么变化？一方面，随着丰富 Web 和移动应用程序的出现，每个系统现在都是一个分布式系统。得益于云计算的出现，计算和存储资源比以往任何时候都便宜。容器正在改变我们关于部署和运营服务的方式。许多消费型服务正在超出其单体代码库的规模，团队发现它们难以扩展。微服务可以帮助解决许多这些挑战。

# 微服务的前提条件

微服务并非万能药。虽然它们有许多好处（我们将在后面讨论），但它们也引入了一些特定的挑战。在决定转向微服务之前，确保某些基础设施和工具到位非常重要。马丁·福勒（Martin Fowler）写过关于微服务的前提条件（[`martinfowler.com/bliki/MicroservicePrerequisites.html`](https://martinfowler.com/bliki/MicroservicePrerequisites.html)），菲尔·卡卡多（Phil Calcado）也写过（[`philcalcado.com/2017/06/11/calcados_microservices_prerequisites.html`](http://philcalcado.com/2017/06/11/calcados_microservices_prerequisites.html)）。我不会重复别人的话；相反，我只想说，在开始开发微服务之前，拥有一定程度的自动化和监控是值得的。您的团队应该能够舒适地分担值班任务，并且您应该有一个管理警报和升级的系统，例如 PagerDuty（[`pagerduty.com/`](http://pagerduty.com/)）。

# 微服务的优势

微服务的各种好处将在下一节中讨论。

# 规模化

在单体代码库中，扩展是一个全有或全无的方法。微服务使得根据各自需求扩展应用的不同部分变得更容易。例如，你可能有一个应用的部分在所有用户请求的关键路径上（即认证/授权服务），而其他部分只被用户子集使用（即搜索或消息）。不同的流量模式将转化为不同的扩展需求和不同的扩展服务的技术。需要为每个用户请求进行读取的服务应该使用使读取便宜的数据库。不需要提供强一致性结果的服务可以利用广泛的缓存。

# 团队组织

当工程师团队在各自的代码库和各自的部署上工作时，他们能够独立做出很多决策，而无需与其他团队协调。这意味着工程师可以自由地提交代码，设计自己的代码审查流程，并部署到生产环境，而无需总是需要协调。在单体应用中，工程师不得不将他们的更改放入一个队列中，然后与其他团队的更改一起在设定的时间部署，这是很常见的。如果出现问题（毒部署是导致中断最常见的原因之一），则整个更改集都会回滚，导致多个团队的工作延迟。微服务通过允许团队拥有更大的自主权来帮助你避免这种情况。

# 可靠性

当单体应用失败时，它往往会完全失败。数据库不可用，然后应用尝试在连接池中使用过时的连接，最终服务请求的线程或进程会锁定，用户只能看到死亡的白屏或无法使用的移动应用。微服务允许你根据应用特定部分的失败情况来决定如何处理。如果你的服务无法连接到数据库，可能最好是返回一个过时的缓存，或者一个空响应。如果你的服务不得不放弃并开始返回 HTTP 503 响应，上游服务可以通过应用反向压力来响应，允许服务赶上。微服务为你提供了更多的自由来隔离系统中的故障，从而为用户提供更愉快的体验。

本书将作为你在开发微服务时遇到的各种主题的便捷参考。我们将从帮助你从单体架构过渡到微服务套件的食谱开始。随后的章节将解决在选择最佳架构和管理微服务时出现的特定领域或挑战。涵盖代码的食谱将包括可用的、简单的、经过测试的示例，你可以在自己的应用程序中使用。我希望这本书能帮助你思考、规划和执行基于微服务的应用程序的开发。祝您享受阅读！

# 本书面向对象

如果你是一名希望构建有效且可扩展的微服务的开发者，那么这本书就是为你准备的。假设你具备微服务架构的基本知识。

# 本书涵盖内容

第一章，*打破单体*，展示了如何从单体架构过渡到微服务架构，食谱重点在于架构设计。你将学习如何使用这种新的架构风格开始开发功能时管理一些初始挑战。

第二章，*边缘服务*，教你如何使用开源软件将你的服务暴露给公共互联网，控制路由，扩展你的服务功能，并在部署和扩展微服务时处理许多常见挑战。

第三章，*服务间通信*，讨论了将使你能够自信地处理微服务架构中必然需要的各种交互的食谱。

第四章，*客户端模式*，讨论了建模依赖服务调用和从各种服务中聚合响应以创建特定客户端 API 的技术。我们还将讨论管理不同的微服务环境，以及使 RPC 与 JSON 和 HTTP 保持一致，以及 gRPC 和 Thrift 二进制协议。

第五章，*可靠性模式*，讨论了在设计构建微服务时可以使用的许多有用的可靠性模式，以准备和减少预期和意外的系统故障的影响。

第六章，*安全*，包含了帮助你学习在构建、部署和运营微服务时需要考虑的许多良好实践的食谱。

第七章，*监控和可观察性*，介绍了监控和可观察性的几个原则。我们将演示如何修改我们的服务以生成结构化日志。我们还将查看指标，使用多个不同的系统来收集、聚合和可视化指标。

第八章，*扩展性*，讨论了使用不同工具进行负载测试。我们还将设置 AWS 中的自动扩展组，使其按需可扩展。这将随后是容量规划策略。

第九章，*部署微服务*，讨论了容器、编排和调度，以及将更改安全地发送给用户的各种方法。本章的食谱应作为良好的起点，特别是如果您习惯于在虚拟机或裸机服务器上部署单体应用。

# 为了充分利用本书

本书假设读者对微服务架构有基本了解。其他必要的说明将在各自的食谱中提及。

# 下载示例代码文件

您可以从 [www.packtpub.com](http://www.packtpub.com) 的账户下载本书的示例代码文件。如果您在其他地方购买了本书，您可以访问 [www.packtpub.com/support](http://www.packtpub.com/support) 并注册，以便将文件直接通过电子邮件发送给您。

您可以通过以下步骤下载代码文件：

1.  在 [www.packtpub.com](http://www.packtpub.com/support) 登录或注册。

1.  选择支持选项卡。

1.  点击代码下载与勘误。

1.  在搜索框中输入书籍名称，并遵循屏幕上的说明。

文件下载后，请确保使用最新版本的以下软件解压缩或提取文件夹：

+   Windows 上的 WinRAR/7-Zip

+   Mac 上的 Zipeg/iZip/UnRarX

+   Linux 上的 7-Zip/PeaZip

该书的代码包也托管在 GitHub 上，地址为 [`github.com/PacktPublishing/Microservices-Development-Cookbook`](https://github.com/PacktPublishing/Microservices-Development-Cookbook)。我们还有其他来自我们丰富的图书和视频目录的代码包，可在 **[`github.com/PacktPublishing/`](https://github.com/PacktPublishing/)** 上找到。查看它们吧！

# 使用的约定

本书使用了多种文本约定。

`CodeInText`：表示文本中的代码单词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 账号。以下是一个示例：“在 `app/services/attachments_service.rb` 文件中打开新创建的服务对象，并将上传文件的责任移动到 `AttachmentsService#upload` 方法。”

代码块设置如下：

```js
class AttachmentsService

  def upload(message_id, user_id, file_name, data, media_type)
    message = Message.find_by!(message_id, user_id: user_id)
    file = StorageBucket.files.create(
      key:  file_name,
      body: StringIO.new(Base64.decode64(data), 'rb'),
      public: true
    )
```

任何命令行输入或输出都如下所示：

```js
brew install docker-compose
```

**粗体**：表示新术语、重要单词或您在屏幕上看到的单词。例如，菜单或对话框中的单词在文本中显示如下。以下是一个示例：“安装和管理 Kubernetes 集群超出了本书的范围。幸运的是，一个名为 **Minikube** 的项目允许您在开发机器上轻松运行单个节点 Kubernetes 集群。”

警告或重要说明看起来像这样。

小贴士和技巧看起来像这样。

# 部分

在这本书中，您会发现几个频繁出现的标题（*准备工作*，*如何操作…*）。

为了清楚地说明如何完成食谱，请按照以下方式使用这些部分：

# 准备工作

本节将向您介绍在食谱中可以期待的内容，并描述如何设置任何软件或任何为食谱所需的初步设置。

# 如何操作…

本节包含遵循食谱所需的步骤。

# 联系我们

我们始终欢迎读者的反馈。

**一般反馈**：请通过`feedback@packtpub.com`发送电子邮件，并在邮件主题中提及书籍标题。如果您对本书的任何方面有疑问，请通过`questions@packtpub.com`发送电子邮件给我们。

**勘误**：尽管我们已经尽一切努力确保内容的准确性，但错误仍然可能发生。如果您在这本书中发现了错误，我们将不胜感激，如果您能向我们报告这一点。请访问[www.packtpub.com/submit-errata](http://www.packtpub.com/submit-errata)，选择您的书籍，点击勘误提交表单链接，并输入详细信息。

**盗版**：如果您在互联网上以任何形式发现我们作品的非法副本，如果您能提供位置地址或网站名称，我们将不胜感激。请通过`copyright@packtpub.com`与我们联系，并附上材料的链接。

**如果您有兴趣成为作者**：如果您在某个领域有专业知识，并且有兴趣撰写或为书籍做出贡献，请访问[authors.packtpub.com](http://authors.packtpub.com/)。

# 评论

请留下评论。一旦您阅读并使用过这本书，为何不在您购买它的网站上留下评论呢？潜在读者可以看到并使用您的客观意见来做出购买决定，Packt 公司可以了解您对我们产品的看法，我们的作者也可以看到他们对书籍的反馈。谢谢！

如需了解更多关于 Packt 的信息，请访问[packtpub.com](https://www.packtpub.com/)。
