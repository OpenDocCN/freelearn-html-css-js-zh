# 第十四章。保护并扩展 Node.js 应用程序

规模化和保护你的应用程序非常重要。规模化和保护不是一次性任务。随着你添加新功能以增加应用程序的安全性，以及随着你的应用程序流量和数据增加，你需要扩展你的服务器。在本章中，你将学习如何使 Node.js 应用程序更加安全，以及如何扩展 Node.js 应用程序。我将假设你正在使用 Express 来创建你的网络服务器，因为它是最常见的。

在本章中，我们将介绍：

+   应用程序漏洞

+   非漏洞攻击

+   各种第三方服务来保护你的应用程序

+   检查第三方包中的安全问题

+   分配流量的技术

# 应用程序中的常见漏洞

根据维基百科，**漏洞**是应用程序中的一种弱点，允许攻击者降低系统的信息安全。应用程序暴露出不同类型的漏洞。

让我们来看看一些重要的漏洞以及如何预防它们。

## Helmet

**Helmet**是一个 Node.js 库，它通过设置各种与安全相关的 HTTP 头部来帮助你防止各种攻击。

这里列出了 Helmet 添加的各种头部：

+   `Strict-Transport-Policy`: 这个头部用于强制执行到服务器的安全（通过 SSL/TLS 的 HTTP）连接。HTTPS 防止中间人攻击。在中间人攻击中，攻击者秘密地改变客户端和服务器之间的通信。这样做是为了窃取数据、向网页添加广告等。

+   `X-Frame-Options`: 这个头部提供了点击劫持保护。**点击劫持**是一种攻击技术，攻击者使用多个透明或不透明的层来欺骗用户点击另一个页面上的按钮或链接，而用户原本意图点击的是顶级页面。因此，攻击者“劫持”了原本属于他们页面的点击，并将它们路由到其他页面，很可能是另一个应用程序、域名或两者都有。这个头部防止应用程序在 iframe 中查看，因此提供了点击劫持保护。

+   `X-XSS-Protection`: 这个头部防止反射型 XSS 攻击。反射型 XSS 攻击是一种 XSS 攻击。**跨站脚本攻击**（**XSS**）是一种注入攻击，恶意脚本被注入到原本良性和可信的网站上。XSS 攻击发生在攻击者使用一个网络应用程序发送恶意代码到不同的最终用户时，通常是以浏览器端脚本的形式。反射型 XSS 是最常见的 XSS 攻击类型。它们也被称为非持久型 XSS 攻击，因为攻击有效载荷是通过单个请求和响应传递和执行的。反射型 XSS 发生在攻击者通过将代码注入 URL 来将可执行 JavaScript 代码注入 HTML 响应中。

+   `X-Content-Type-Options`：浏览器可以覆盖响应的 `Content-Type` 头部，猜测并使用隐式内容类型处理数据。虽然这在某些场景中可能很方便，但也可能导致一些攻击，例如 MIME 混淆攻击、授权热链接等。返回 `X-Content-Type-Options` 将导致浏览器使用提供的 `Content-Type` 头部，而不是将内容解释为不同的内容类型。

+   `Content-Security-Policy`：此头部允许我们向浏览器提供一个受信任源列表，从这些源可以加载到页面上的内容，例如 JavaScript、CSS、HTML 框架、字体、图像和可嵌入对象（Java 小程序、ActiveX、音频和视频）。这有助于我们防止 XSS 攻击。

要了解更多关于 Helmet 的信息，请访问 [`www.npmjs.com/package/helmet`](https://www.npmjs.com/package/helmet)

## 跨站请求伪造

**跨站请求伪造**（**CSRF**）是一种攻击类型，其中用户的请求在用户不知情的情况下发送到服务器。

例如，如果攻击者能够找到一个可重复执行的链接，在受害者登录到目标页面时执行特定操作，他就能在受控页面上嵌入这样的链接，并诱骗受害者打开它。携带攻击的链接可能被放置在受害者登录目标网站时可能访问的位置，或者通过 HTML 邮件正文或附件发送。

防止 CSRF 攻击有多种方法。大多数 CSRF 防御技术通过在请求中嵌入额外的认证数据来实现，这使得网络应用能够检测来自未经授权位置发出的请求。

有一个名为 `csrf` 的库（[`www.npmjs.com/package/csrf`](https://www.npmjs.com/package/csrf)）适用于 Node.js，它允许你防止 CSRF 攻击。它提供了中间件来保护 Express 网络服务器免受 CSRF 攻击。

## 跨站脚本

我们之前看到了 XSS 漏洞是什么。我们基本上看到了反射型 XSS 攻击是什么。还有一种称为 **存储型 XSS** 的 XSS 攻击类型。

存储型 XSS 发生在应用程序存储了未正确过滤的用户输入时。例如，在聊天时，如果一条消息没有被清理，那么两个用户都可以通过在 `<script>` 标签内发送 JS 代码作为消息，在对方的浏览器上运行脚本。

为了防止两种类型的 XSS 攻击，我们应该始终过滤/清理用户输入。

## 会话固定

**会话固定**是一种攻击，允许攻击者劫持一个有效的用户会话。以下是一些防止会话固定的技术：

+   设置会话超时

+   经常重新生成会话令牌

+   当用户注销时，使会话令牌过期

+   在创建会话时存储用户的用户代理和 IP 地址，并在随后的 HTTP 请求中检查这些值是否匹配。

# 基于非漏洞的攻击

可以对任何类型的应用程序进行各种攻击，因为它们依赖于应用程序中的漏洞。尽管如此，应用程序可以采取很多措施来防止这些攻击。

让我们看看一些最常见的非漏洞性攻击及其预防方法。

## 服务拒绝攻击

**拒绝服务**（**DoS**）攻击是尝试暂时使服务器机器对其预期用户不可用的一种尝试。攻击者使用一台或多台机器连续向服务器发送请求，以使其关闭。

防止 DoS 的最佳方法是使用像 CloudFlare 这样的外部服务，它使用来自各种来源的大量不同技术和数据来阻止对您的服务器上的恶意请求。总是避免在您的服务器上处理 DoS，并将其留给由 DoS 专家创建的服务。

## 暴力破解攻击

**暴力破解攻击**旨在成为获取网站访问权限的最简单方法：尝试用户名和密码，一次又一次，直到成功。

这里有一些防止暴力破解攻击的方法：

+   我们可以在表单中嵌入 CAPTCHA，这可以完全防止机器人进行暴力破解攻击，并减缓人类进行的暴力破解攻击。

+   有一个名为**express-brute**的中间件程序，用于 Express 服务器，它根据几个因素限制传入请求的速率。您可以在[`www.npmjs.com/package/express-brute`](https://www.npmjs.com/package/express-brute)了解更多关于**express-brute**的信息。

# 使用安全包

您使用的 npm 包可能包含可能影响您应用程序的严重安全漏洞。不可能逐个检查每个包的代码或单独测试它们。

有一个名为`Node Security Project`的数据库，其中列出了最重要的易受攻击的包。您可以使用命令行工具，如`nsp`([`www.npmjs.com/package/nsp`](https://www.npmjs.com/package/nsp))和`requireSafe`([`www.npmjs.com/package/requiresafe`](https://www.npmjs.com/package/requiresafe))来检查您应用程序的易受攻击的依赖项。

您应该始终关注您应用程序所依赖的包的新版本发布，并对其进行更新，因为新版本通常会修复与安全相关的问题。

# 扩展 Node.js 服务器

如果您的应用程序有大量用户同时访问系统，那么显然单个服务器无法处理所有流量。它将变慢并崩溃。因此，我们需要在多个服务器上部署应用程序，并在它们之间平均分配流量。

为了在服务器之间分配流量，我们需要使用一种称为**负载均衡器**的东西。负载均衡器是一种位于应用程序服务器前面的服务器。客户端与负载均衡器通信，而不是与应用程序服务器通信；而不是处理请求，负载均衡器将请求转发到应用程序服务器；当应用程序服务器发送响应时，它将相同的响应发送给客户端。

由于负载均衡器实际上并不处理请求，它可以处理比应用程序服务器更多的请求。显然，负载均衡器不能处理无限数量的请求，因此我们可以使用多个负载均衡器。当我们使用多个负载均衡器时，它们之间的流量是通过轮询 DNS 技术来分配的。在轮询 DNS 中，指向负载均衡器的域的 IP 地址根据适当的统计模型进行变化。

**亚马逊网络服务**（**AWS**）提供了一个名为 Amazon ELB 的负载均衡器，可以用于在 Amazon EC2 服务器之间分配流量，即应用程序服务器。显然，预测您需要多少个 EC2 实例来扩展应用程序是困难的；因此，AWS 还提供了一种称为**自动扩展**的功能，可以根据需要添加/删除 EC2 实例。因此，为了托管大规模应用程序，亚马逊是最好的选择。它还提供了许多其他云服务来扩展和部署您的应用程序。

如果您不想担心服务器扩展、部署和管理的问题，那么您可以使用像 Heroku 这样的云服务，这可以让您更容易实现所有这些功能，您只需要关注应用程序代码——仅此而已。

# 摘要

在本章中，我们看到了许多用于扩展和保障 Node.js 应用程序的服务和库。我们看到了各种漏洞以及如何预防它们。请确保定期备份您的数据，这样即使您的应用程序被黑客攻击，您仍然有机会让应用程序重新运行，因为数据没有丢失。显然，关于扩展和保障 Node.js 应用程序还有很多东西要学习，因为这是一个永无止境的话题，并且新事物经常出现。
