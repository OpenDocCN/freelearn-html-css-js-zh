

# 第十三章：在 Node.js 中监控微服务

当与微服务架构和 Node.js 一起工作时，你需要监控 Node.js 中的微服务。

我们将从这个章节开始，了解监控微服务的原则。在 Node.js 环境中监控微服务对于确保系统的健康、性能和可靠性至关重要。此外，它是一个持续的过程，需要不断改进和适应不断变化的需求。通过采用全面的监控策略，团队可以主动识别和解决问题，优化性能，并确保微服务架构的整体可靠性和安全性。

到本章结束时，你将学会如何持续监控 Node.js 中的微服务。

在本章中，我们将涵盖以下主要主题：

+   结构化日志和日志级别

+   上下文信息和集中式日志管理

+   应用程序级指标、分布式跟踪和健康检查

+   基于阈值的警报和异常检测

+   请求跟踪、请求上下文传播和日志框架

在第一部分，我们将展示如何使用结构化日志进行监控并理解日志级别。

# 结构化日志和日志级别

**结构化日志**涉及将日志消息组织在预定义的格式中，通常为键值对或 JSON 对象，使其更易于机器读取，并便于分析。**日志级别**表示日志消息的严重性或重要性。

这里有一些结构化日志的最佳实践：

+   `service_name`和自定义字段。

+   **上下文信息**：在日志中包含相关的上下文信息，例如用户 ID、事务 ID 和服务特定的标识符。促进不同微服务日志之间的关联。

+   **错误信息**：对于错误日志，包括错误代码、堆栈跟踪和附加的诊断信息。这有助于**根本原因分析**（RCA）和调试。

+   **关联 ID**：使用关联 ID 来追踪跨微服务之间的请求。在每个与特定请求相关的日志条目中包含关联 ID。

+   **结构化日志库**：在 Node.js 中利用结构化日志库，如 Winston 或 Bunyan。自定义日志格式化程序以生成结构化输出。

在微服务架构中，结构化日志对于跨服务关联日志和提供丰富上下文信息特别有价值。

结构化日志是一种创建具有一致和良好定义格式的日志记录的方法，使其更容易搜索和分析。结构化日志的一些最佳实践如下：

+   使用标准格式，如 JSON，记录日志。这将使它们易于机器读取，并与各种日志管理工具兼容。

+   在您的日志记录中包含相关字段或键值对，例如时间戳、日志级别、消息、来源、上下文以及任何自定义数据。这将帮助您更有效地过滤、查询和关联日志。

+   避免记录敏感或个人信息，如密码、信用卡号码或用户名。这将防止安全漏洞并符合数据保护法规。

+   使用一致的命名和格式约定为您的字段和值。这将使您的日志更易于阅读并避免混淆。

+   使用适当的日志级别来指示日志事件的严重性和重要性。这将帮助您更有效地优先处理和解决您的问题。

这里包括日志级别的以下内容：

+   `DEBUG`：

    +   *目的*：对调试有用的详细信息。

    +   *用途*：调试信息、变量值和其他详细见解。

+   `INFO`：

    +   *目的*：关于系统事件的通用信息。

    +   *用途*：启动消息、配置细节和常规系统事件。

+   `WARN`（**警告**）：

    +   *目的*：指示可能不是关键的问题。

    +   *用途*：可能需要关注的不致命问题或条件。

+   `ERROR`：

    +   *目的*：指示需要关注的关键错误。

    +   *用途*：影响系统正常功能的问题。

+   `FATAL`/`CRITICAL`：

    +   *目的*：指示导致服务或应用程序关闭的严重错误。

    +   *用途*：系统无法恢复的临界错误。

微服务通常使用各种日志级别根据其重要性对消息进行分类。

*图 13.1* 展示了结构化日志：

![图 13.1：结构化日志（由 Freepik 上的 macrovector 提供）](img/B14980_13_01.jpg)

图 13.1：结构化日志（由 Freepik 上的 macrovector 提供）

总结来说，通过采用结构化日志并仔细管理日志级别，微服务环境可以实现更好的可观察性、更快的故障排除和整体系统可靠性的提升。在日志格式上的一致性和对细节的关注有助于更有效的日志策略。

理解了这些概念后，我们现在转向上下文信息和集中式日志管理。

# 上下文信息和集中式日志管理

日志中的上下文信息和集中式日志管理是微服务架构中有效可观察性和故障排除的关键组成部分。

## 日志中的上下文信息

在微服务中，日志中的**上下文信息**非常重要，因为它为开发者提供了所有必要的调试应用程序的信息。日志中的上下文信息包括任何有助于理解日志事件上下文的数据，例如来源、时间、位置、参数、结果或事件的原因。上下文信息可以使日志更具意义、有用和可操作，因为它可以提供故障排除、调试、监控或分析应用程序或系统行为的线索。

这里是为什么上下文日志很重要的原因：

+   **可追溯性**:

    +   *功能*: 帮助追踪请求或事务通过多个微服务的流程。

    +   *实现方式*: 使用唯一标识符，如关联 ID、跟踪 ID 或请求 ID，为属于同一事务、操作或工作流程的每个日志事件标记。这有助于对跨越多个组件或服务的日志事件进行分组和筛选，并重建日志事件的执行路径和因果关系。

+   **用户上下文**:

    +   *功能*: 提供与特定请求关联的用户信息。

    +   *实现方式*: 在日志中包含用户 ID 或相关用户上下文信息。

+   **服务标识符**:

    +   *功能*: 识别生成日志条目的特定微服务。

    +   *实现方式*: 在每个日志条目中包含服务名称或 ID。

+   **时间戳**:

    +   *功能*: 指示事件发生的时间，有助于按时间顺序分析。

    +   *实现方式*: 在日志中包含带时区信息的时间戳。

+   **错误代码**:

    +   *功能*: 帮助对错误进行分类和优先排序，以便更容易调试。

    +   *实现方式*: 在日志中包含错误代码或相关状态指示器。

+   **环境信息**:

    +   *功能*: 指示日志生成时的环境（例如，开发、生产）。

    +   *实现方式*: 在日志中包含环境指示器。

记得在日志中提供所有必要的信息。

学习了这些概念后，我们可以继续进行集中式日志管理。

## **集中式日志管理**

**集中式日志管理**在开发微服务时也非常重要，因为它可以帮助开发者节省时间并更快地调试问题。集中式日志管理是在单个平台上收集、存储、分析和管理来自各种来源和系统的日志数据的过程。日志数据是由应用程序、设备、服务器、网络或任何记录其活动、事件或变化的组件生成的信息。

这里是它为什么重要的原因：

+   **单一事实来源 (SSOT)**:

    +   *功能*: 提供一个用于存储、搜索和分析日志的单个存储库。

    +   *实现方式*: 利用日志聚合工具或集中式日志服务。

+   **高效的故障排除**:

    +   *功能*: 通过综合视图促进更快的问题识别和解决。

    +   *实现*: 使用如 ELK Stack（Elasticsearch、Logstash、Kibana）或基于云的日志解决方案等工具。

+   **警报** **和监控**:

    +   *作用*: 基于日志数据实现实时监控和警报。

    +   *实现*: 设置基于日志的洞察力的警报规则和仪表板。

+   **安全和合规性**:

    +   *作用*: 帮助进行安全分析和合规性审计。

    +   *实现*: 集中式存储简化了安全事件的日志审查。

总结来说，通过在日志中包含上下文信息并实施集中式日志管理，微服务架构可以实现更好的可见性、更快的问题解决以及开发团队和运维团队之间的协作改进。这些实践有助于构建更健壮、更易于维护的微服务生态系统。

现在，我们可以继续到下一节，我们将讨论应用级指标、分布式追踪和健康检查。

# 应用级指标、分布式追踪和健康检查

在微服务中进行有效的监控和可观察性涉及收集和分析各种类型的数据。应用级指标、分布式追踪和健康检查在理解微服务的性能、依赖关系和整体健康状况方面发挥着关键作用。

## 应用级指标

**应用级指标**对于更好地分析日志非常重要。应用级指标是衡量和监控软件应用性能、行为和质量的各种指标。应用级指标可以包括可用性、响应时间、吞吐量、错误率、用户满意度、资源利用率等方面。应用级指标可以帮助开发者、经理和利益相关者了解应用的运行情况，识别和解决问题，优化和改进应用，并确保良好的用户体验。

以下是它们为什么重要的原因：

+   **性能监控**:

    +   *作用*: 提供对微服务性能的洞察。

    +   *实现*: 测量响应时间、吞吐量和资源使用。

+   **资源利用率**:

    +   *作用*: 帮助识别资源瓶颈和低效之处。

    +   *实现*: 监控 CPU 使用、内存消耗和磁盘 I/O。

+   **错误率**:

    +   *作用*: 指示错误发生的频率和性质。

    +   *实现*: 跟踪错误率和特定错误类型。

+   **吞吐量**:

    +   *作用*: 衡量单位时间内处理请求数量。

    +   *实现*: 监控请求或事务吞吐量。

更好地理解指标将为微服务带来多项好处，其中之一是开发者可以更好地理解他们的代码如何在机器上运行。

我们现在可以继续分布式追踪。

## 分布式追踪

**分布式跟踪**之所以重要，是因为它可以识别所有由微服务及其依赖项发起的请求，并更快地进行调试。分布式跟踪在日志中是一种允许您跟踪和监控跨越多个服务、系统或组件的分布式应用程序中请求的性能和行为的技术。日志中的分布式跟踪可以帮助您识别和解决请求路径上发生的错误、问题或瓶颈，从而优化和改进用户体验和系统可靠性。

分布式跟踪之所以重要，有以下原因：

+   **请求** **流可见性**:

    +   *它做什么*: 跟踪请求在通过各种微服务中的移动。

    +   *实现*: 使用跟踪 ID 关联服务之间的请求。

+   **延迟分析**:

    +   *它做什么*: 帮助识别分布式架构中的延迟瓶颈。

    +   *实现*: 测量每个微服务处理请求所需的时间。

+   **依赖映射**:

    +   *它做什么*: 展示微服务之间的依赖关系。

    +   *实现*: 基于跟踪请求可视化依赖关系。

注意收集指标和跟踪引入的额外开销，尤其是在高吞吐量系统中。我们现在可以继续进行健康检查。

## 健康检查

**健康检查**可以帮助开发人员和工程师自动监控微服务，并在问题成为问题之前识别潜在问题。

健康检查之所以重要，有以下原因：

+   **系统可用性**:

    +   *它做什么*: 确保微服务可用且响应。

    +   *实现*: 定期检查微服务是否响应健康检查请求。

+   **主动** **问题检测**:

    +   *它做什么*: 在影响用户之前识别潜在问题。

    +   *实现*: 包括对依赖项、数据库连接和关键组件的检查。

+   `/health`) 用于健康检查端点。

集成还可以包括健康检查响应中依赖项健康状况的详细信息。

总结来说，应用级指标、分布式跟踪和健康检查是微服务架构中稳健监控和可观察策略的组成部分。这些实践为个别微服务的性能、依赖关系和健康状况提供了宝贵的见解，有助于构建更健壮和高效的系统。

在下一节中，我们将了解基于阈值的警报和异常检测。

# 基于阈值的警报和异常检测

有效的监控和警报是稳健微服务架构的关键组成部分。基于阈值的警报和异常检测机制有助于在影响系统性能之前识别问题、行为偏差和潜在问题。

## 基于阈值的警报

**基于阈值的警报**可以帮助建立基线指标以确定正常行为。它还可以允许根据不同的环境（例如，开发和生产）调整阈值。

这里是为什么基于阈值的警报很重要的原因：

+   **主动** **问题检测**：

    +   *它做什么*: 基于预定义的阈值识别异常情况。

    +   *实现方式*: 为关键指标（如响应时间、错误率和资源利用率）设置阈值。

+   **即时通知**：

    +   *它做什么*: 触发警报以实时通知利益相关者有关问题。

    +   *实现方式*: 使用警报系统通过电子邮件、消息平台或**事件管理**（**IM**）工具发送通知。

我可以向您展示如何使用**Datadog**和**Splunk**，这两款流行的可观察性工具进行警报。警报是一个功能，允许您设置规则和条件，当您的系统或应用程序中出现问题时或需要您的关注时，通知您。

使用 Datadog，您可以创建监控器，当您收到有关指标、事件、日志、集成可用性、网络端点等方面的警报。您可以配置监控器类型、查询、警报阈值、通知消息和收件人。您还可以设置恢复通知、异常检测和警报分组。您可以从**监控器**页面查看和管理您的监控器，在那里您可以查看它们的状态、历史和配置。您还可以使用 Datadog API 以编程方式创建、更新或删除监控器。有关更多详细信息，您可以查看关于警报的 Datadog 文档([`docs.datadoghq.com/`](https://docs.datadoghq.com/))。

使用 Splunk，您可以创建基于保存搜索结果的触发动作的警报。您可以配置警报类型、计划、触发条件、节流和动作。您还可以设置自适应阈值、预测分析和警报依赖。您可以从**警报**页面查看和管理您的警报，在那里您可以查看它们的状态、历史和配置。您还可以使用 Splunk REST API 以编程方式创建、更新或删除警报。有关更多详细信息，您可以查看关于警报的 Splunk 文档([`docs.splunk.com/Documentation`](https://docs.splunk.com/Documentation))。

Datadog 和 Splunk 都提供与各种通信和协作工具的集成，例如 Slack、PagerDuty、Jira 和 Microsoft Teams，以发送警报通知并启用**事件响应**（**IR**）工作流程。您还可以将 Datadog 和 Splunk 集成以关联两个平台上的指标和日志。

现在，我们可以继续讨论异常检测。

## 异常检测

**异常检测**可以帮助考虑分析多个指标以获得更全面的视角，并使用历史数据来训练模型并建立正常行为。

异常检测之所以重要，有以下原因：

+   **识别** **异常模式**：

    +   *它做什么*：检测正常模式或行为中的偏差。

    +   *实现方式*：利用统计方法或**机器学习**（**ML**）算法来识别异常。

+   **自适应监控**：

    +   *它做什么*：适应系统行为随时间的变化。

    +   *实现方式*：定期重新训练异常检测模型，以适应不断变化的模式。

+   **异常检测在不同行业** **领域的优势**：

    +   *制造业*：异常检测可以帮助检测机器、产品或过程中的故障或缺陷，并防止昂贵的故障、废品或返工。例如，异常检测可以监控发动机的声音或振动，并在出现任何异常时向操作员发出警报。

    +   *金融*：通过分析交易或消费模式，异常检测可以帮助检测欺诈或洗钱，并标记任何可疑活动。例如，如果客户从一个不熟悉的位置提取大量现金，异常检测可以向银行发出警报。

    +   *医疗保健*：通过分析生命体征、实验室结果或医学影像，异常检测可以帮助监测患者健康并检测任何疾病或并发症的迹象，并标记任何异常。例如，如果患者有异常的心跳或 X 光片中的肿瘤，异常检测可以向医生发出警报。

    +   *网络安全*：通过分析网络流量或系统日志，异常检测可以帮助检测网络攻击或入侵，并标记任何恶意或未经授权的活动。例如，如果黑客试图访问敏感数据库或安装恶意软件，异常检测可以向安全团队发出警报。

异常检测可以结合事件响应的反馈，以持续改进异常检测模型。

总结来说，基于阈值的警报和异常检测是微服务架构中主动监控策略的必要组成部分。它们使团队能够及时识别和解决问题，从而提高系统可靠性和性能。通过实施这些实践，组织可以增强其微服务生态系统的弹性，并为用户提供更好的体验。

现在，让我们继续下一节，关于请求跟踪、请求上下文传播和日志框架。

# 请求跟踪、请求上下文传播和日志框架

在微服务架构中，管理并跟踪请求在穿越各种服务时的行为对于理解系统行为、识别瓶颈和诊断问题至关重要。结合请求跟踪、上下文传播和有效的日志框架可以增强可观察性并促进高效的调试。

## 请求跟踪

**请求跟踪**可以提供端到端可见性和性能分析。日志中的请求跟踪是一种技术，允许您捕获和分析应用程序或系统处理的具体请求的详细信息。日志中的请求跟踪可以帮助您诊断和排除影响请求的问题、错误或性能问题，以优化和改进用户体验和系统可靠性。

以下是请求跟踪为何重要的原因：

+   **端到端可见性**：

    +   *作用*：提供对请求在其通过不同微服务流动过程中的整个生命周期的可见性。

    +   *实现方式*：每个微服务生成带有唯一标识符（跟踪 ID）的跟踪信息，并将其与请求一起传递。

+   **性能分析**：

    +   *作用*：帮助分析参与处理请求的每个微服务的性能。

    +   *实现方式*：使用诸如 **Zipkin**、**Jaeger** 或 **OpenTelemetry** 等工具来捕获和可视化跟踪信息。

在请求跟踪中，使用关联 ID（在每个请求中包含关联 ID 以关联跨微服务的日志和跟踪）和采样（在高吞吐量场景中实现采样以避免系统被跟踪数据淹没）是一种最佳实践。

## 请求上下文传播

在**请求上下文传播**中，了解上下文感知处理和一致日志记录非常重要。日志中的请求上下文传播是一种技术，允许您在不同组件或服务之间传递和访问有关请求的上下文信息，例如来源、时间、路径、参数、结果或错误。日志中的请求上下文传播可以帮助您诊断和排除影响请求的问题、错误或性能问题，以优化和改进用户体验和系统可靠性。

以下是它为何重要的原因：

+   **上下文感知处理**：

    +   *作用*：通过在请求中传递上下文信息，使微服务能够感知上下文。

    +   *实现方式*：在微服务之间传递上下文信息（例如，用户身份，事务 ID）。

+   **一致日志记录**：

    +   *作用*：通过传播上下文信息确保日志的一致性。

    +   *实现方式*：利用 Spring Cloud Sleuth 等框架中的上下文传播机制或自定义头。

请求上下文传播对于分布式系统，尤其是微服务来说非常重要，因为它允许您跟踪和监控跨越多个组件或服务的请求的性能和行为。请求上下文传播可以帮助您完成以下任务：

+   诊断和排除影响请求的问题、错误或性能问题，并优化和改进用户体验和系统可靠性。

+   通过检测和防止威胁、违规行为或违规来增强请求的安全性和合规性。

+   分析和报告请求的指标、趋势和洞察。

由于请求上下文传播可以帮助您诊断和排除故障、增强安全和合规性以及分析和报告，我们也可以讨论其最佳实践。

一些最佳实践如下：

+   **最小化开销**：优化上下文传播机制以最小化开销，尤其是在高吞吐量系统中。

+   **上下文丰富**：在请求通过微服务的过程中丰富上下文信息，以捕获相关细节。

请求上下文传播通过在不同处理请求的组件或服务之间传递和访问有关请求的上下文信息来实现，例如源、时间、路径、参数、结果或错误。

## 日志框架

在**日志框架**中，您需要使用最佳实践来诊断信息、审计和性能。日志框架是库或模块，允许您从您的应用程序或系统中生成和格式化日志数据。日志数据是记录您的应用程序或系统活动、事件或更改的信息。日志框架可以帮助您诊断和排除问题、错误或性能问题，并优化和改进用户体验和系统可靠性。

让我们更详细地看看日志框架：

+   **诊断信息**：

    +   *作用*：提供用于故障排除和调试的诊断信息。

    +   *实施*：记录相关的详细信息，例如输入参数、响应代码和关键事件。

+   **审计** **和合规性**：

    +   *作用*：通过捕获重要事件促进审计和合规性。

    +   *实施*：记录符合合规性要求的关键事件。

本章前面部分描述了一些日志框架的最佳实践，包括结构化日志、日志级别和集中式日志，具体为*结构化日志和日志级别*，以及*上下文信息和集中式* *日志管理*。

总结来说，请求跟踪、上下文传播和有效的日志记录是微服务架构中可观测性的核心组成部分。它们提供了对请求流程的洞察，使上下文感知处理成为可能，并促进了高效的调试和故障排除。通过实施这些实践，组织可以在其微服务生态系统中实现增强的可视性、改进的系统可靠性和更快的故障解决。

# 总结

在本章中，我们学习了关于微服务以及如何使用几个原则和工具在 Node.js 中监控微服务的大量知识。

总结来说，在 Node.js 中监控微服务涉及跟踪和分析微服务的各个方面，以确保其健康和性能。这可能包括监控响应时间、错误率和资源使用等指标。

可以使用各种工具和实践来监控 Node.js 中的微服务，包括以下内容：

+   **日志**：在 Node.js 微服务中实施全面的日志记录可以提供对其行为和性能的宝贵见解。可以使用 Winston 或 Bunyan 等工具进行结构化日志记录。

+   **指标收集**：使用 Prometheus 或 StatsD 等库从微服务中收集和公开指标，允许跟踪随时间推移的性能数据。

+   **跟踪**：使用 OpenTracing 或 Jaeger 等工具实施分布式跟踪，可以提供对请求在微服务之间流动的可见性，有助于识别性能瓶颈和错误。

+   **健康检查**：在微服务中实施健康检查，以持续监控其可用性和响应性。

+   **容器编排平台**：利用 Kubernetes 或 Docker Swarm 等容器编排平台可以提供内置的监控和指标收集功能。

+   **应用性能监控（APM）工具**：利用 APM 工具，如 New Relic、Datadog 或 AppDynamics，以深入了解 Node.js 微服务的性能。

通过利用这些工具和最佳实践，开发者可以确保他们 Node.js 微服务的可靠性和可扩展性。在下一章中，我们将学习使用 Node.js 在微服务中进行日志记录。

# 测验时间

+   什么是结构化日志和日志级别？

+   什么是集中式日志管理？

+   应用级指标是什么？

+   什么是日志框架？
