# 第一章. 为什么选择 Node.js？

与 .NET 和 Java 等平台相比，Node.js 仍然相对较新，但它在短时间内变得非常流行，甚至开始影响这些平台。这得益于其独特的编程模型、广泛的生态系统和强大的工具。

这些因素使 Node.js 成为其他平台的有力替代品。它们也可能使其令人畏惧。与其他平台相比，其独特的编程模型可能显得相当陌生。可用的库和工具的范围可能令人困惑。

本书将引导您了解 Node.js，以便您可以在应用程序中使用它。它将帮助您理解 Node.js，导航其生态系统，并利用您现有的开发技能在这个新环境中。

在本章中，我们将涵盖以下主题：

+   介绍 Node.js 平台

+   了解其执行模型如何工作

+   探索 Node.js 生态系统

+   将 JavaScript 视为语言选择

+   考虑 Node.js 的使用案例范围

# 什么是 Node.js？

Node.js 由一个 JavaScript 引擎和用于核心服务器端功能的高级 API 组成。执行引擎是专为 Chrome 浏览器开发的 V8 引擎。Node.js 将此引擎嵌入到一个独立的应用程序中，可以在浏览器之外运行 JavaScript。

在 Node.js 中，浏览器中用于支持客户端 Web 开发的标准 API，如 **文档对象模型** **(DOM)** 和 `XMLHttpRequest`，并不存在。相反，有 API 支持通用应用程序开发。这些核心 API 覆盖以下低级功能：

+   网络和安全

+   访问文件系统

+   定义和引入模块

+   抛出和消费事件

+   处理二进制数据流

+   压缩

+   UTF-8 支持

+   获取关于操作系统的基本信息

+   管理子进程

其中一些 API 可能已经从客户端 JavaScript 开发中熟悉。例如，Timers API 揭示了熟悉的 `setTimeout` 和 `setInterval` 函数。

Node.js 还提供了一些工具来帮助开发过程。这些包括控制台日志记录、调试、**读取-评估-打印循环**（**REPL**）（或交互式控制台）以及基本的断言用于测试。

## 理解 Node.js 执行模型

Node.js 的执行模型遵循浏览器中 JavaScript 的执行模型。它与大多数通用编程平台的执行模型相当不同。

正式来说，Node.js 具有单线程、非阻塞、事件驱动的执行模型。我们将在本节中定义这些术语中的每一个。

### 非阻塞

简而言之，Node.js 认识到许多程序的大部分时间都在等待其他事情发生，例如，慢速 I/O 操作，如磁盘访问和网络请求。

Node.js 通过使这些操作非阻塞来解决这个问题。这意味着程序执行可以在它们发生时继续。例如，文件系统 API 的`stat`函数用于检索关于文件的统计信息，可以如下调用：

```js
fs.stat('/hello/world', function (error, stats) {
  console.log('File last updated at: ' + stats.mtime);
});
```

`fs.stat`函数传递了两个参数：我们感兴趣的文件的名称和一个**回调函数**。`fs.stat`调用立即返回，将执行控制权交还给当前线程，但不返回值。如果`fs.stat`调用之后还有其他命令，那么这些命令将被执行。否则，线程将被释放以执行其他工作。回调函数仅在运行时与文件系统通信完成后被调用（即'*回调*'）。文件系统操作的结果传递给回调函数。

这种非阻塞方法也称为**异步**编程。其他平台也支持这种编程（例如，C#的`async`/`await`关键字和.NET 的 Task Parallel Library）。然而，在 Node.js 中，它被内建得既简单又自然。异步 API 方法都像`fs.stat`一样调用。它们都接受一个回调函数，该函数传递错误和结果参数。

### 事件驱动

Node.js 的事件驱动特性描述了操作是如何被安排的。在典型的过程式环境中，一个程序有一个入口点，执行一系列命令直到完成，或者进入循环并在每次迭代中执行一些处理。

Node.js 有一个内置的**事件循环**，它不对开发者公开。事件循环的职责是决定接下来执行哪段代码。通常，这将是一个准备好运行的回调函数，作为对其他事件的响应。例如，文件系统操作可能已完成，超时可能已过期，或者可能已到达新的网络请求。

这个内置的事件循环通过提供一致的方法并避免应用程序需要管理自己的调度，简化了异步编程。

### 单线程

Node.js 的单线程特性简单来说就是每个进程中只有一个执行线程。此外，每一块代码都保证能够运行完成，而不会被其他操作中断。这极大地简化了开发，并使得程序更容易推理。它消除了各种并发问题的可能性。例如，不需要像 Java 或.NET 那样同步/锁定对共享进程内状态的访问。一个进程不能自己死锁或在其代码中创建竞态条件。单线程编程只有在线程永远不会因为长时间运行的工作而阻塞等待时才是可行的。因此，这种简化的编程模型是由 Node.js 的非阻塞特性实现的。

## 介绍 Node.js 生态系统

内置的 Node.js API 为创建应用程序提供了一个低级核心。应用程序通常只直接使用这些 API 的一小部分。它们通常使用第三方库模块，这些模块为应用程序开发提供了更高层次的抽象。

Node.js 有自己的包管理器，**npm**。这与 .NET 的 NuGet 或 Java 的 Maven 的包管理方面类似。应用程序在简单的 JSON 文件中指定它们的依赖项。

**npm 注册表**提供了一个包的中央存储库。这个注册表迅速增长，并且已经比其他平台的相应存储库大得多（在可用的包数量方面）（见 [`www.modulecounts.com/`](http://www.modulecounts.com/)）。有数十万个包可供选择，提供了广泛的功能。

**npm 命令行工具**可以用来下载包和安装新的包。库依赖项被安装到每个应用程序的本地。一些包提供命令行工具，这些工具可能被全局安装而不是在特定项目下。

在 npm 上可用的许多框架被分为一个小型的可扩展核心和多个可组合模块。这种方法使得理解你的应用程序所依赖的库变得容易，避免了需要推理复杂重量级框架的需求。

在 Node.js 中调用非阻塞（异步）API 方法的一致性也体现在其第三方库中。这种一致性使得构建全异步的应用程序变得容易。

# 为什么选择 JavaScript？

与其他流行的**面向对象**（**OO**）语言相比，JavaScript 似乎是一种不太直观的语言。它还有一些怪癖和缺陷，这引起了批评（以及偶尔的嘲笑）。因此，它可能是一个新的编程平台的选择似乎令人惊讶。本节讨论了使 JavaScript 成为更具吸引力的选择的因素。

## 清晰的画布

JavaScript 的大小和复杂性是其吸引力的一部分。核心语言本身（不包括 DOM 等 API）小巧简单。这使得 Node.js 能够建立自己的风格和约定。

Node.js 提供的新 API 和一致的异步编程方法在更复杂、具有更大预存标准类库的语言中是不可能的。

## 函数性

JavaScript 最初被构建为浏览器客户端功能的一种编程语言。这可能不会让它成为通用编程的明显选择。

实际上，这两个用例确实有一些重要的共同点。用户界面代码自然是事件驱动的（例如，将事件处理器绑定到按钮点击）。Node.js 通过将事件驱动方法应用于通用编程来使这一点成为优点。

JavaScript 支持将函数作为一等对象。这意味着可以动态地创建函数并传递它们的引用。这与 Node.js 的异步、非阻塞方法很好地结合在一起。特别是，基于回调函数的 API 的暴露和使用变得非常容易。

## 光明的未来

在过去几年中，JavaScript 因其被广泛用于在 Web 上提供丰富功能而受到了很多关注。浏览器供应商投入了大量的工程努力来提高 JavaScript 的性能。Node.js 通过使用 Chrome 的 V8 引擎直接受益于这一点。

JavaScript 语言本身正在进行一些重大的改进，以使其变得更好。ECMAScript 2015 标准（之前称为 ES6）代表了该语言历史上最重大的修订。它引入了使语言更直观、更简洁的功能。它还解决了 JavaScript 过去被批评的缺陷，消除了陷阱，使程序更容易推理。

# 何时使用 Node.js

如本章前面所讨论的，Node.js 认识到 I/O 是许多应用的瓶颈。在大多数编程平台上，线程会在 I/O 操作上浪费时间。开发者可以采取一些方法来避免这种情况，但这些方法都需要在他们的代码中增加一些复杂性。在 Node.js 中，平台本身提供了一个完全自然的方法。

## 编写 Web 应用

Node.js 的旗舰用例是构建 Web 应用。这些应用本质上是事件驱动的，因为大多数或所有处理都是在响应 HTTP 请求时进行的。此外，许多网站本身进行的计算工作量很小。它们倾向于执行大量的 I/O 操作：

+   客户端流式请求

+   与本地或通过网络与数据库通信

+   通过网络从远程 API 拉取数据

+   从磁盘读取文件以发送回客户端

这些因素使得 I/O 操作很可能是 Web 应用的瓶颈。Node.js 的非阻塞编程模型允许 Web 应用充分利用单线程。一旦这些 I/O 操作中的任何一个开始，线程就会立即空闲出来，开始处理另一个请求。当 I/O 操作完成时，每个请求的处理将通过异步回调继续进行。处理线程只是启动并链接这些操作，而不会等待它们完成。这使得 Node.js 能够比其他平台处理每线程的请求数量要高得多。你也可以通过简单地运行多个 Node.js 进程实例来利用多个线程（例如，在多核 CPU 上）。

## 识别其他用例

当然，也有一些应用程序的 I/O 操作不多，更可能是 CPU 密集型的。Node.js 对于计算密集型应用程序可能不太适合。处理内存中大量数据的程序对 I/O 的关注较少。

虽然 Web 应用程序不是唯一的高 I/O 应用程序，但以下类别的程序也可能是 Node.js 的良好候选者：

+   操作磁盘上大量数据的工具

+   协调其他软件或硬件的监督程序

+   需要响应用户输入的非浏览器图形用户界面应用程序

Node.js 特别适合作为*粘合剂*应用程序，将来自其他远程服务的功能组合在一起。微服务作为架构模式日益流行，使得这类应用程序更加常见。

## 为什么现在？

Node.js 已经存在了几年，但如果你还没有开始使用它，现在正是时候。

Node.js v4 在 2015 年底的发布巩固了项目的治理模式，预示着 Node.js 的成熟。它还允许项目与 V8 引擎保持更紧密的更新。这意味着 Node.js 可以更直接地从 V8 的持续开发中受益。例如，V8 的安全性和性能改进现在将更快地进入 Node.js。

如本章前面所讨论的，ECMAScript 2015 标准的发布使 JavaScript 成为一个更具吸引力的语言。它从其他流行的面向对象语言中引入了有用的功能，并解决了 JavaScript 中一些长期存在的问题。

同时，围绕 Node.js 和 JavaScript 的第三方库和工具生态系统继续增长。Node.js 被主要托管平台视为一等公民。像 Google 和 Microsoft 这样的公司也在支持 JavaScript 和相关技术。

# 摘要

在本章中，我们已经了解了 Node.js 及其独特的执行模型，探讨了围绕 Node.js 和 JavaScript 不断发展的生态系统，看到了选择 JavaScript 作为语言的原因，并描述了可以从 Node.js 中受益的应用类型。

现在你已经了解了 Node.js 的工作原理以及何时使用它，是时候深入其中，并启动我们的第一个 Node.js 应用程序。
