# 第一章：介绍和构成

高性能很难，它取决于许多因素。开发人员应该不断追求最佳性能。为了实现这一点，开发人员必须了解他们使用的编程语言，更重要的是，了解语言在重负载下的性能表现，包括磁盘、内存、网络和处理器的使用情况。

开发人员只有了解语言的弱点，才能充分利用它。在一个完美的世界中，由于每个工作都不同，开发人员应该寻找最适合工作的工具。但这是不可行的，开发人员不可能知道每个最佳工具，因此他们必须为每个工作寻找第二最佳的工具。如果开发人员了解少量工具但能够精通它们，他们将会表现出色。

作为隐喻，锤子用来钉钉子，你也可以用它来打碎物体或锻造金属，但不应该用它来拧螺丝。语言和平台也是如此。有些平台非常适合做很多工作，但在其他工作上表现非常糟糕。有时可以缓解这种性能问题，但有时无法避免，这时就需要寻找更好的工具。

Node.js 不是一种语言；它实际上是建立在 V8 之上的平台，V8 是谷歌开源的 JavaScript 引擎。这个引擎实现了 ECMAScript，它本身是一种简单而非常灵活的语言。我说“简单”，是因为它没有访问网络、访问磁盘或与其他进程通信的方式。它甚至无法停止执行，因为它没有任何退出指令。这种语言需要在其上面构建一种接口模型才能发挥作用。Node.js 通过使用 libuv 暴露了一个（最好是）非阻塞的 I/O 模型来实现这一点。这种非阻塞 API 允许您访问文件系统，连接到网络服务并执行子进程。

API 还有另外两个重要元素：缓冲区和流。由于 JavaScript 字符串对 Unicode 友好，引入了缓冲区来处理二进制数据。流用作简单的事件接口来传递数据。在读取文件内容或接收网络数据包时，API 中到处都使用缓冲区和流。

流是一个模块，类似于网络模块。加载后，它提供对一些基本类的访问，这些类有助于创建可读、可写、双工和转换流。这些可以用来以简化和统一的格式执行各种数据操作。

当将二进制数据格式转换为其他格式（例如 JSON）时，缓冲区模块很容易成为您的好朋友。多个读取和写入方法帮助您转换整数和浮点数，有符号或无符号，大端或小端，从 8 位到 8 字节长。

大部分平台都设计成简单、小巧和稳定。它们被设计和准备用来创建一些高性能的应用程序。

# 性能分析

性能是在一定时间内使用一组定义的资源完成的工作量。可以使用一个或多个取决于性能目标的度量标准来分析性能。目标可以是低延迟、低内存占用、减少处理器使用，甚至减少功耗。

性能分析的行为也被称为**分析**。分析对于制作优化的应用程序非常重要，可以通过对应用程序的源代码或实例进行仪器化来实现。通过对源代码进行仪器化，开发人员可以发现常见的性能弱点。通过对应用程序实例进行仪器化，他们可以在不同的环境中测试应用程序。这种类型的仪器化也可以被称为**基准测试**。

Node.js 以快速著称。实际上，它并不是那么快；它只能达到你的资源允许的速度。Node.js 最擅长的是不会因为 I/O 任务而阻塞你的应用程序。在 Node.js 应用程序中，性能的感知可能会误导。在其他一些语言中，当应用程序任务被阻塞时——例如，由于磁盘操作——所有其他任务都会受到影响。但在 Node.js 中，这种情况通常不会发生。

有些人认为这个平台是单线程的，这是不正确的。你的代码在一个线程上运行，但还有一些线程负责 I/O 操作。由于这些操作与处理器性能相比极其缓慢，它们在一个单独的线程上运行，并在它们为你的应用程序提供信息时通知平台。阻塞 I/O 操作的应用程序性能不佳。由于 Node.js 不会阻塞 I/O，除非你希望它这样做，因此在等待 I/O 时可以执行其他操作。这极大地提高了性能。

V8 是一个开源的谷歌项目，是 Node.js 背后的 JavaScript 引擎。它负责编译和执行 JavaScript，以及管理应用程序的内存需求。它是以性能为目标设计的。V8 遵循几个设计原则来提高语言性能。该引擎具有分析器和最好和最快的垃圾收集器之一，这是其性能的关键之一。它也不会将语言编译成字节码；它会在第一次执行时直接将其编译成机器码。

在开发环境中具有良好的背景将极大地增加开发高性能应用程序成功的机会。了解解引用的工作原理或者为什么你的变量应该避免切换类型非常重要。以下是其他一些有用的提示，你可能想要遵循。你可以使用像 JSCS 这样的样式指南和像 JSHint 这样的代码检查工具来强制执行它们，对自己和团队都是如此。以下是其中一些：

+   编写小函数，因为它们更容易优化

+   使用单态参数和变量

+   更喜欢使用数组来操作数据，因为整数索引元素更快

+   尽量使用小对象，避免长的原型链。

+   避免克隆对象，因为大对象会减慢操作

## 监控

应用程序投入生产模式后，性能分析变得更加重要，因为用户的要求会比你更苛刻。用户不会接受任何超过一秒的东西，随着时间和特定负载的增加，监控应用程序的行为将变得极为重要，因为它将指出你的平台在哪里出现了问题或将在下一步出现问题。

是的，你的应用程序可能会失败，你能做的最好的就是做好准备。制定备份计划，备用硬件，并创建服务探针。基本上，预测你能想到的所有情景，并记住你的应用程序仍然会失败。以下是你应该监控的一些情景和方面：

+   在生产环境中，应用程序的使用情况对于了解应用程序在数据大小或内存使用方面的发展方向至关重要。重要的是，你要仔细定义源代码探针来监控指标——不仅是性能指标，比如每秒请求或并发请求，还有错误率和每个请求服务的异常百分比。你的应用程序会发出错误，有时会抛出异常；这是正常的，你不应该忽视它们。

+   不要忘记其他基础设施。如果你的应用程序必须达到高标准，你的基础设施也应该如此。你的服务器电源供应应该是不间断的和稳定的，因为不稳定会比应有的更快地降低你的硬件性能。

+   明智地选择你的磁盘，因为更快的磁盘更昂贵，通常存储容量更小。然而，当你的应用程序不需要那么多存储空间而速度更重要时，这实际上并不是一个坏决定。但不要只看每美元的千兆字节。有时，更重要的是看每美元的千兆位每秒。

+   此外，你的服务器温度和机房应该受到监控。高温会降低性能，你的硬件有操作温度限制。安全性，无论是物理的还是虚拟的，也非常重要。一切都符合高性能的标准，因为停止为用户提供服务的应用程序根本就不是在表现。

# 获得高性能

规划对于实现最佳结果至关重要。高性能是从基础开始构建的，从你的规划和开发方式开始。这显然取决于物理资源，因为当你没有足够的内存来完成任务时，你无法表现良好，但它也极大地取决于你如何规划和开发应用程序。精通工具将比仅仅使用它们带来更好的性能机会。

从开发的一开始就设定高标准将迫使规划更加谨慎。数据库层的糟糕规划会严重降低性能。谨慎的规划也会促使开发人员更多地考虑使用情况并更加谨慎地编程。

高性能意味着当你的所有资源都耗尽时，你必须考虑新的资源（处理器、内存、存储），而不仅仅是因为某一资源耗尽。高性能应用程序不应该在使用少量处理器和磁盘已满时需要第二台服务器。在这种情况下，你只需要更大的磁盘。

当今的应用程序不能设计为单片式。不断增长的用户群强制采用分布式架构，或者至少可以通过多个实例分配负载。这在规划初期就很重要，因为改变已经投入生产的应用程序会更加困难。

大多数常见的应用程序随着时间的推移会表现得更差，不是因为处理能力不足，而是因为数据库和磁盘上的数据量增加。你会注意到内存的重要性增加，备用磁盘对于避免停机时间至关重要。应用程序能够水平扩展非常重要，无论是将数据分片到服务器上还是跨区域分片。

分布式架构也会提高性能。地理分布的服务器可以更接近客户端，并给人以性能感知。此外，由更多服务器分布的数据库将作为一个整体处理更多流量，并允许 DevOps 实现零停机目标。这对于维护也非常有用，因为节点可以在不影响应用程序的情况下进行支持。

## 测试和基准测试

要知道应用程序在特定环境下是否表现良好，我们必须进行测试。这种测试称为基准测试。基准测试对每个应用程序都很重要。即使是相同的语言和平台，不同的应用程序可能表现不同，这可能是因为应用程序的某些部分的结构方式或数据库设计方式不同。

分析性能将指示应用程序的瓶颈，或者说，表现不佳的部分。这些部分需要改进。不断尝试改进表现最差的部分将提升应用程序的整体性能。

有很多工具可以使用，有些更专注于 JavaScript 应用程序，比如 benchmarkjs ([`benchmarkjs.com/`](http://benchmarkjs.com/)) 和 ben ([`github.com/substack/node-ben`](https://github.com/substack/node-ben))，还有一些更通用的，比如 ab ([`httpd.apache.org/docs/2.2/programs/ab.html`](http://httpd.apache.org/docs/2.2/programs/ab.html)) 和 httpload ([`github.com/perusio/httpload`](https://github.com/perusio/httpload))。根据目标，有几种不同类型的基准测试，它们如下：

+   **负载测试**是基准测试的最简单形式。它用于查看应用程序在特定负载下的性能。你可以测试并了解应用程序每秒接受多少连接，或者应用程序可以处理多少流量字节。应用程序的负载可以通过查看外部性能（如流量）和内部性能（如使用的处理器或消耗的内存）来检查。

+   **浸泡测试**用于查看应用程序在更长时间内的性能。当应用程序随着时间的推移而变得不稳定，需要进行分析以查看其反应时，就会进行这种测试。这种测试类型对于检测内存泄漏非常重要，因为一些应用程序在一些基本测试中可能表现良好，但随着时间的推移，内存泄漏和性能可能会下降。

+   **峰值测试**是在负载迅速增加时使用的，以查看应用程序的反应和性能。这种测试在可能出现峰值使用的应用程序中非常有用和重要，运营商需要知道应用程序将如何反应。Twitter 是一个很好的例子，它的应用环境可能会受到使用峰值的影响（比如体育赛事或宗教日期），需要知道基础设施将如何处理它们。

随着应用程序的增长，所有这些测试都会变得更加困难。随着用户群的增长，应用程序的规模扩大，你失去了使用现有资源进行负载测试的能力。最好为这一时刻做好准备，特别是为了监控性能并跟踪浸泡和峰值，因为你的应用程序用户开始负责持续测试负载。

## 应用程序中的组合

由于对高性能应用程序的持续需求，组合变得非常重要。组合是一种实践，你将应用程序分解为几个更小、更简单的部分，使它们更容易理解、开发和维护。它还使它们更容易测试和改进。

避免创建庞大的、单一的代码库。当你需要进行更改时，它们效果不佳，如果你需要测试和分析代码的任何部分以改进性能，也不会起作用。

Node.js 平台帮助你——在某些方面，迫使你——组合你的代码。**Node.js 包管理器**（**NPM**）是一个很棒的模块发布服务。你可以下载其他人的模块，也可以发布自己的模块。已经发布了数以万计的模块，这意味着在大多数情况下你不必重复造轮子。这很好，因为你可以避免浪费时间去创建一个模块，而是使用已经在生产中并被许多人使用的模块，这通常意味着错误将更快地被跟踪，改进也将更快地交付。

Node.js 平台允许开发人员轻松地分离代码。虽然平台并不强制你这样做，但你应该尝试并遵循一些良好的实践，比如下面描述的实践。

### 使用 NPM

除非需要，否则不要重写代码。花时间尝试一些可用的模块，并选择适合您的模块。这降低了编写错误代码的概率，并有助于发布的模块具有更大的用户群。错误将更早地被发现，并且不同环境中的更多人将测试修复。此外，您将使用更具弹性的模块。

在开始使用一些模块后，一个重要而被忽视的任务是跟踪变化，并在可能的情况下继续使用最新的稳定版本。如果一个依赖模块一年没有更新，您可能会在以后发现问题，但在一年之间的两个版本之间找出变化是很困难的。Node.js 模块往往会随着时间的推移而得到改进，API 的变化并不罕见。始终谨慎升级，并不要忘记测试。

### 将您的代码分离

同样，您应该始终将代码拆分为较小的部分。Node.js 可以帮助您以非常简单的方式做到这一点。您的文件不应该超过 5kB。如果超过了，最好考虑拆分。此外，作为一个良好的规则，每个用户定义的对象应该有自己单独的文件。根据文件命名：

```js
    // MyObject.js
    module.exports = MyObject;

    function MyObject() {
      // …
    }
    MyObject.prototype.myMethod = function () { … };
```

另一个好的规则是检查您是否有一个比应该更大的文件；也就是说，它应该在不到 5 分钟的时间内由一个新的应用程序用户轻松阅读和理解。如果不是，这意味着它太复杂了，以后跟踪和修复错误将更加困难。

### 提示

记住，当您的应用程序变得庞大时，当打开一个文件进行修复时，您将像一个新的开发人员一样。您无法记住应用程序的所有代码，需要快速吸收文件的行为。

### 拥抱异步任务

该平台设计为异步，因此您不应该违背它。有时，对一些递归任务或者简单地循环执行一系列需要串行运行的任务可能会非常困难。您应该避免创建一个处理异步任务的模块，因为有一些模块被成千上万的人使用和测试。例如，`async`是帮助开发人员更好地执行的一种简单而实用的方式，学习曲线非常平滑：

```js
    async.each(users, function (user, next) {
        // do something on each user object
        return next();
    }, function (err) {
        // done!
    });
```

这个模块有很多类似于数组对象中的方法，比如 map、reduce、filter 和 each，但是用于异步迭代。当您的应用程序变得更加复杂，一些用户操作需要一些串行任务时，这是非常有用的。错误处理也被正确地执行，执行停止也如预期般完成。该模块有助于运行串行或并行任务。

此外，通常需要串行任务的情况下，开发人员通常需要嵌套调用并进入回调地狱，但可以简单地避免这种情况。特别是在需要执行涉及多个查询的数据库事务时，这是非常有用的。

编写异步代码时的另一个常见错误是抛出错误。回调在定义它们的范围之外被调用，因此您不能简单地将回调放在`try`/`catch`块中。因此，除非这是一个非常关键的错误，应该使您的应用程序停止并退出，否则避免这样做。在 Node.js 中，抛出异常而不捕获它将触发`uncaughtException`事件。

该平台有一个对大多数开发人员来说是共识的规则——所谓的错误优先回调风格。这个规则非常重要，因为它允许更容易地重用您的代码。即使您有一个函数，其中没有抛出错误的机会，或者当您不希望它抛出并在函数内部使用某种错误处理时，您的回调应该始终将第一个参数保留给错误事件，即使它总是 null。这将允许您的函数与`async`模块一起使用。此外，其他开发人员在调试时将依赖这种风格，因此始终将第一个参数作为错误对象保留。

此外，您应该始终将函数的最后一个参数保留为回调。永远不要在回调之后定义参数：

```js
    function mySuperFunction(arg1, ..., argN, next) {
        // do some voodoo
        return next(null, my_result); // 1st argument reserved for error
    }
```

### 使用库函数

库函数是您应该使用的另一种模块类型。它们有助于处理重复的任务，每个开发人员都必须执行这些任务。一些重复的任务可以毫不费力地完成，只需使用 lodash 或 underscore 中的库函数。它们是您代码的重要部分，并且具有良好的优化，您甚至无需考虑。许多循环任务，例如基于对象键在数组中查找对象，或将对象数组映射到每个对象的键数组，都可以在这些库中用一行代码完成。首先阅读文档，以避免使用库而未充分利用其潜力。

尽管这些类型的模块可能很有用，但如果选择不当，它们也可能降低性能。一些模块旨在帮助开发人员完成某些任务，但并不针对性能，只是为了方便。换句话说，这些模块可以帮助您更快地开发，但您不应忘记每个函数的复杂性。否则，您将因为忘记其复杂性而多次调用同一个函数，而不是调用一次并保存结果。

### 提示

记住，当您开发应用程序并与一两个用户进行测试时，并不能看到高性能。那时，应用程序的速度表现良好，因为数据大小和用户数量仍然很小。但以后，您可能会后悔一些设计决定。

### 使用函数规则

函数在这个平台上非常重要。这并不奇怪，因为这种语言是功能性的，并且具有一流的函数。在编写函数时，有一些规则您应该遵循，这将使您在以后调试或优化时更加轻松。它们还可以避免一些错误，因为它们试图强制执行一些常见的结构。再次强调，您可以使用 JSCS 等工具来强制执行这些规则。

1.  始终为您的函数命名，特别是当它们作为闭包用作回调时。这样可以在代码中断时识别它们在堆栈跟踪中的位置。此外，它们允许新开发人员迅速了解函数应该做什么。但是，避免使用过长的名称：

```js
socket.on("data", function onSocketData(data) {
    // …
});
```

1.  不要嵌套您的条件，并尽早返回。如果您在函数中有一个必须返回的条件，并且如果您返回了，您就不必使用`else`语句。这样还可以避免新的缩进级别，减少代码并简化其修订。如果您不这样做，如果有两个或更多条件需要满足，您最终会陷入条件地狱，有几个级别：

```js
// do this
if (someCondition) {
    return false;
}
return someThing;

// instead of this:
if (someCondition) {
    return false;
} else {
    return someThing;
}
```

1.  创建小而简单的函数。不要让您的函数跨越屏幕可处理的行数。即使您的任务无法重用，也将函数拆分为更小的函数。最好将其放入新模块并发布。这样，如果需要，您可以在前端重用它们。这也可以使引擎在无法优化之前的大函数时优化一些较小的函数。再次强调，如果您不希望开发人员在能够触及任何内容之前阅读您的应用程序代码一两周，这一点非常重要。

### 测试您的模块

测试您的模块是一项艰巨的工作，通常被忽视，但对于为您的模块编写测试非常重要。最初的测试是最困难的。寻找一个您喜欢的测试工具，比如 vows、chai 或 mocha。如果您不知道如何开始，请阅读模块的文档，或者其他模块的测试代码。但不要放弃测试。

### 注意

如果您需要帮助，请阅读前面提到的测试工具网站，因为它们通常会帮助您入门。或者，您可以查看 Igor 的文章（https://semaphoreci.com/community/tutorials/getting-started-with-node-js-and-mocha）在 semaphore。

一旦您开始添加一个或两个测试，就会有更多的测试跟随。从一开始就测试您的模块的一个重要优势是，当您发现一个错误时，您可以为其制作一个测试用例，以便能够重现它并在将来避免它。

代码覆盖率并不是至关重要的，但可以帮助您了解您的测试覆盖了模块代码的程度，以及您是否只是测试了一小部分。有一些覆盖率模块，比如`istanbul`或`jscoverage`；选择最适合您的那个。代码覆盖率是与测试一起完成的，所以如果您不进行测试，就无法看到覆盖率。

正如您可能想要改进应用程序的性能一样，每个依赖模块都应该被检查以进行改进。只有在测试它们时才能做到这一点。依赖版本管理非常重要，但很难跟踪新版本和更改，但它们可能会给您一些好消息。有时，模块会被重构，性能会得到提升。一个很好的例子是数据库访问模块。

# 总结

Node.js 和 NPM 一起构成了一个非常好的平台，用于开发高性能的应用程序。由于它们背后的语言是 JavaScript，而且大多数应用程序都是 Web 应用程序，这些组合使它成为一个更具吸引力的选择，因为它是一个不需要学习的服务器端语言（如 PHP 或 Ruby），最终可以允许开发人员在客户端和服务器端共享代码。此外，前端和后端开发人员可以共享、阅读和改进彼此的代码。许多开发人员选择这种模式，并带来了许多他们从客户端带来的习惯。其中一些习惯不适用，因为在服务器端，异步任务必须起作用，因为有许多连接的客户端（而不是一个），性能变得至关重要。

在下一章中，我们将介绍一些开发模式，帮助应用程序保持简单、快速和可扩展，随着更多客户端的加入，开始对您的基础设施施加压力。

为 Bentham Chang 准备，Safari ID 为 bentham@gmail.com 用户编号：2843974 © 2015 Safari Books Online，LLC。此下载文件仅供个人使用，并受到服务条款的约束。任何其他使用都需要版权所有者的事先书面同意。未经授权的使用、复制和/或分发严格禁止，并违反适用法律。保留所有权利。
