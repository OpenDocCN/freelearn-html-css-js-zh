<html><head></head><body>
<div class="calibre1" id="_idContainer080">
<h1 class="chapternumber"><span class="kobospan" id="kobo.1.1">6</span></h1>
<h1 class="chaptertitle" id="_idParaDest-114"><span class="kobospan" id="kobo.2.1">Using Node.js Streams</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.3.1">One of the main tasks required in server-side development is transferring data, either reading data sent by a client or browser or writing data that must be transmitted or stored in some way. </span><span class="kobospan" id="kobo.3.2">In this chapter, I will introduce the Node.js API for dealing with data sources and data destinations, known as </span><em class="italic"><span class="kobospan" id="kobo.4.1">streams</span></em><span class="kobospan" id="kobo.5.1">. </span><span class="kobospan" id="kobo.5.2">I will explain the concept behind streams, show how they are used to deal with HTTP requests, and explain why one common source of data – the file system – should be used with caution in a server-side project. </span><em class="italic"><span class="kobospan" id="kobo.6.1">Table 6.1</span></em><span class="kobospan" id="kobo.7.1"> puts streams in context.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.8.1">Table 6.1: Putting streams in context</span></p>
<table class="table-container" id="table001-3">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.9.1">Question</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.10.1">Answer</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.11.1">What are they?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.12.1">Streams are used by Node.js to represent data sources or destinations, including HTTP requests and responses. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.13.1">Why are they useful?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.14.1">Streams don’t expose the details of how data is produced or consumed, which allows the same code to process data from any source. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.15.1">How are they used?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.16.1">Node.js provides streams to deal with HTTP requests. </span><span class="kobospan4" id="kobo.16.2">The streams API is used to read data from the HTTP request and write data to the HTTP response. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.17.1">Are there any pitfalls or limitations?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.18.1">The streams API can be a little awkward to work with, but this can be improved with the use of third-party packages, which often provide more convenient methods to perform common tasks.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.19.1">Are there any alternatives?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.20.1">Streams are integral to Node.js development. </span><span class="kobospan4" id="kobo.20.2">Third-party packages can simplify working with streams, but it is helpful to understand how streams work for when problems arise.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.21.1">Table 6.2</span></em><span class="kobospan" id="kobo.22.1"> sums up what the chapter will cover.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.23.1">Table 6.2: Chapter summary</span></p>
<table class="table-container" id="table002-3">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.24.1">Problem</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.25.1">Solution</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.26.1">Listing</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.27.1">Write data to a stream</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.28.1">Use the </span><code class="inlinecode"><span class="kobospan2" id="kobo.29.1">write</span></code><span class="kobospan" id="kobo.30.1"> or </span><code class="inlinecode"><span class="kobospan2" id="kobo.31.1">end</span></code><span class="kobospan4" id="kobo.32.1"> methods.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.33.1">4</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.34.1">Set response headers</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.35.1">Use the </span><code class="inlinecode"><span class="kobospan2" id="kobo.36.1">setHeader</span></code><span class="kobospan4" id="kobo.37.1"> method.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.38.1">5–7</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.39.1">Manage data buffering</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.40.1">Use the result from the </span><code class="inlinecode"><span class="kobospan2" id="kobo.41.1">write</span></code><span class="kobospan" id="kobo.42.1"> method and handle the </span><code class="inlinecode"><span class="kobospan2" id="kobo.43.1">drain</span></code><span class="kobospan4" id="kobo.44.1"> event.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.45.1">8–9</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.46.1">Read data from a stream</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.47.1">Handle the </span><code class="inlinecode"><span class="kobospan2" id="kobo.48.1">data</span></code><span class="kobospan" id="kobo.49.1"> and </span><code class="inlinecode"><span class="kobospan2" id="kobo.50.1">end</span></code><span class="kobospan4" id="kobo.51.1"> events or use an iterator.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.52.1">10–15</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.53.1">Connect streams</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.54.1">Use the </span><code class="inlinecode"><span class="kobospan2" id="kobo.55.1">pipe</span></code><span class="kobospan4" id="kobo.56.1"> method.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.57.1">16</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.58.1">Transform data </span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.59.1">Extend the </span><code class="inlinecode"><span class="kobospan2" id="kobo.60.1">Transform</span></code><span class="kobospan4" id="kobo.61.1"> class and use the stream object mode.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.62.1">17–19</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.63.1">Serve static files</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.64.1">Use the Express static middleware or use the </span><code class="inlinecode"><span class="kobospan2" id="kobo.65.1">sendFile</span></code><span class="kobospan" id="kobo.66.1"> and </span><code class="inlinecode"><span class="kobospan2" id="kobo.67.1">download</span></code><span class="kobospan4" id="kobo.68.1"> methods.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.69.1">20–26</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.70.1">Encode and decode data</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.71.1">Use the Express JSON middleware and the </span><code class="inlinecode"><span class="kobospan2" id="kobo.72.1">json</span></code><span class="kobospan4" id="kobo.73.1"> response method.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.74.1">27–28</span></p>
</td>
</tr>
</tbody>
</table>
<h1 class="heading" id="_idParaDest-115"><span class="kobospan" id="kobo.75.1">Preparing for this chapter</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.76.1">In this chapter, I will continue to use the </span><code class="inlinecode"><span class="kobospan" id="kobo.77.1">webapp</span></code><span class="kobospan" id="kobo.78.1"> project created in </span><em class="italic"><span class="kobospan" id="kobo.79.1">Chapter 4</span></em><span class="kobospan" id="kobo.80.1"> and modified in </span><em class="italic"><span class="kobospan" id="kobo.81.1">Chapter 3</span></em><span class="kobospan" id="kobo.82.1">. </span><span class="kobospan" id="kobo.82.2">To prepare for this chapter, replace the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.83.1">server.ts</span></code><span class="kobospan" id="kobo.84.1"> file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.85.1">src</span></code><span class="kobospan" id="kobo.86.1"> folder with the code shown in </span><em class="italic"><span class="kobospan" id="kobo.87.1">Listing 6.1</span></em><span class="kobospan" id="kobo.88.1">.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.89.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.90.1">You can download the example project for this chapter – and for all the other chapters in this book – from </span><a href="https://github.com/PacktPublishing/Mastering-Node.js-Web-Development" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.91.1">https://github.com/PacktPublishing/Mastering-Node.js-Web-Development</span></span></a><span class="kobospan" id="kobo.92.1">. </span><span class="kobospan" id="kobo.92.2">See </span><em class="italic"><span class="kobospan" id="kobo.93.1">Chapter 1</span></em><span class="kobospan" id="kobo.94.1"> for how to get help if you have problems running the examples.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.95.1">Listing 6.1: Replacing the contents of the server.Ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.96.1">import { createServer } from "http";
import express, {Express } from "express";
import { basicHandler } from "./handler";
const port = 5000;
const expressApp: Express = express();
expressApp.get("/favicon.ico", (req, resp) =&gt; {
    resp.statusCode = 404;
    resp.end();
});
expressApp.get("*", basicHandler);
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.97.1">The Express router filters out favicon requests and passes on all other HTTP GET requests to a function named </span><code class="inlinecode"><span class="kobospan" id="kobo.98.1">basicHandler</span></code><span class="kobospan" id="kobo.99.1">, which is imported from the </span><code class="inlinecode"><span class="kobospan" id="kobo.100.1">handler</span></code><span class="kobospan" id="kobo.101.1"> module. </span><span class="kobospan" id="kobo.101.2">To define the handler, replace the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.102.1">handler.ts</span></code><span class="kobospan" id="kobo.103.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.104.1">src</span></code><span class="kobospan" id="kobo.105.1"> folder with the code shown in </span><em class="italic"><span class="kobospan" id="kobo.106.1">Listing 6.2</span></em><span class="kobospan" id="kobo.107.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.108.1">Listing 6.2. </span><span class="kobospan" id="kobo.108.2">The contents of the handler.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.109.1">import { IncomingMessage, ServerResponse } from "http";
export const basicHandler = (req: IncomingMessage, resp: ServerResponse) =&gt; {
    resp.end("Hello, World");
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.110.1">This handler uses the Node.js </span><code class="inlinecode"><span class="kobospan" id="kobo.111.1">IncomingMessage</span></code><span class="kobospan" id="kobo.112.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.113.1">ServerResponse</span></code><span class="kobospan" id="kobo.114.1"> types, even though Express is used to route requests. </span><span class="kobospan" id="kobo.114.2">I will demonstrate the enhancements Express provides in the </span><em class="italic"><span class="kobospan" id="kobo.115.1">Using third-party enhancements</span></em><span class="kobospan" id="kobo.116.1"> section, but I am going to start with the built-in features that Node.js provides.</span></p>
<p class="normal"><span class="kobospan" id="kobo.117.1">Some examples in this chapter require an image file. </span><span class="kobospan" id="kobo.117.2">Create the </span><code class="inlinecode"><span class="kobospan" id="kobo.118.1">static</span></code><span class="kobospan" id="kobo.119.1"> folder and add to it an image file named </span><code class="inlinecode"><span class="kobospan" id="kobo.120.1">city.png</span></code><span class="kobospan" id="kobo.121.1">. </span><span class="kobospan" id="kobo.121.2">You can use any PNG image file as long as you name it </span><code class="inlinecode"><span class="kobospan" id="kobo.122.1">city.png</span></code><span class="kobospan" id="kobo.123.1">, or you can download the public domain panorama of the New York City skyline that I used, shown in </span><em class="italic"><span class="kobospan" id="kobo.124.1">Figure 6.1</span></em><span class="kobospan" id="kobo.125.1">, from the code repository for this chapter.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.126.1"><img alt="" src="../Images/B21959_06_01.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.127.1">Figure 6.1: The city.png file in the static folder</span></p>
<p class="normal"><span class="kobospan" id="kobo.128.1">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.129.1">Listing 6.3</span></em><span class="kobospan" id="kobo.130.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.131.1">webapp</span></code><span class="kobospan" id="kobo.132.1"> folder to start the watcher that compiles TypeScript files and executes the JavaScript that is produced.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.133.1">Listing 6.3: Starting the project</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.134.1">npm start
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.135.1">Open a web browser and request </span><code class="inlinecode"><span class="kobospan" id="kobo.136.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.137.1">. </span><span class="kobospan" id="kobo.137.2">You will see the result shown in </span><em class="italic"><span class="kobospan" id="kobo.138.1">Figure 6.2</span></em><span class="kobospan" id="kobo.139.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.140.1"><img alt="" src="../Images/B21959_06_02.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.141.1">Figure 6.2: Running the example project</span></p>
<h1 class="heading" id="_idParaDest-116"><span class="kobospan" id="kobo.142.1">Understanding streams</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.143.1">The best way to </span><a id="_idIndexMarker297" class="calibre3"/><span class="kobospan" id="kobo.144.1">understand streams is to ignore data and think about water for a moment. </span><span class="kobospan" id="kobo.144.2">Imagine you are in a room in which a pipe with a faucet enters through one wall. </span><span class="kobospan" id="kobo.144.3">Your job is to build a device that will collect the water from the pipe. </span><span class="kobospan" id="kobo.144.4">There is obviously something connected to the other end of the pipe that produces the water, but you are only able to see the faucet, and so the design of your device will be dictated by what you know: you have to create something that will connect to the pipe and receive the water when the faucet is turned on. </span><span class="kobospan" id="kobo.144.5">Having such a limited view of the system you are working with may feel like a restriction, but the pipe can be connected to any source of water and your device works just as well whether the water comes from a river or a reservoir; it is all just water coming through the pipe via the faucet, and it is always consumed consistently. </span></p>
<p class="normal"><span class="kobospan" id="kobo.145.1">At the other end of the pipe, the producer of the water has a pipe into which they pump their water. </span><span class="kobospan" id="kobo.145.2">The water producer can’t see what you have attached to the other end of the pipe and does not know how you are going to consume the water. </span><span class="kobospan" id="kobo.145.3">And it doesn’t matter, because all the producer has to do is push their water through the pipe, regardless of whether their water will be used to drive a water mill, fill a swimming pool, or run a shower. </span><span class="kobospan" id="kobo.145.4">You can change the device attached to your pipe and nothing would change for the producer, who still keeps pumping water into the same pipe in the same way.</span></p>
<p class="normal"><span class="kobospan" id="kobo.146.1">In the world of</span><a id="_idIndexMarker298" class="calibre3"/><span class="kobospan" id="kobo.147.1"> web development, a </span><em class="italic"><span class="kobospan" id="kobo.148.1">stream</span></em><span class="kobospan" id="kobo.149.1"> solves the problem of distributing data in the same way that the pipe solves the problem of distributing water. </span><span class="kobospan" id="kobo.149.2">Like a pipe, a stream has two ends. </span><span class="kobospan" id="kobo.149.3">At one end is the data producer, also known as the </span><em class="italic"><span class="kobospan" id="kobo.150.1">writer</span></em><span class="kobospan" id="kobo.151.1">, who puts a sequence of data values into the stream. </span><span class="kobospan" id="kobo.151.2">At the other end is the data consumer, also known as the </span><em class="italic"><span class="kobospan" id="kobo.152.1">reader</span></em><span class="kobospan" id="kobo.153.1">, who receives the sequence of data values from the stream. </span><span class="kobospan" id="kobo.153.2">The writer and reader each have their own API that allows them to work with the stream, as shown in </span><em class="italic"><span class="kobospan" id="kobo.154.1">Figure 6.3</span></em><span class="kobospan" id="kobo.155.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.156.1"><img alt="" src="../Images/B21959_06_03.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.157.1">Figure 6.3: The anatomy of a stream</span></p>
<p class="normal"><span class="kobospan" id="kobo.158.1">This arrangement </span><a id="_idIndexMarker299" class="calibre3"/><span class="kobospan" id="kobo.159.1">has two important characteristics. </span><span class="kobospan" id="kobo.159.2">The first is that the data arrives in the same order in which it is written, which is why streams are usually described as a </span><em class="italic"><span class="kobospan" id="kobo.160.1">sequence</span></em><span class="kobospan" id="kobo.161.1"> of data values. </span></p>
<p class="normal"><span class="kobospan" id="kobo.162.1">The second characteristic is that the data values can be written to the stream over time so that the writer doesn’t have to have all the data values ready before the first value is written. </span><span class="kobospan" id="kobo.162.2">This means that the reader can receive and start processing data while the writer is still preparing or computing later values in the sequence. </span><span class="kobospan" id="kobo.162.3">This makes streams suitable for a wide range of data sources, and they also integrate well with the Node.js programming model, as the examples in this chapter will demonstrate.</span></p>
<h1 class="heading" id="_idParaDest-117"><span class="kobospan" id="kobo.163.1">Using Node.js streams</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.164.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.165.1">streams</span></code><span class="kobospan" id="kobo.166.1"> module</span><a id="_idIndexMarker300" class="calibre3"/><span class="kobospan" id="kobo.167.1"> contains classes that represent different kinds of streams, and the two most important are described in </span><em class="italic"><span class="kobospan" id="kobo.168.1">Table 6.3</span></em><span class="kobospan" id="kobo.169.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.170.1">Table 6.3: Useful stream classes</span></p>
<table class="table-container" id="table003-3">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.171.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.172.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.173.1">Writable</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.174.1">This class provides the API for writing data to a stream.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.175.1">Readable</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.176.1">This class provides the API for reading data from a stream.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.177.1">In Node.js development, one end of a stream is usually connected to something outside of the JavaScript environment, such as a network connection or the file system, and this allows data to be read and written in the same way regardless of where it is going to or coming from.</span></p>
<p class="normal"><span class="kobospan" id="kobo.178.1">For web development, the most important use of streams is they are used to represent HTTP requests and responses. </span><span class="kobospan" id="kobo.178.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.179.1">IncomingMessage</span></code><span class="kobospan" id="kobo.180.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.181.1">ServerResponse</span></code><span class="kobospan" id="kobo.182.1"> classes, which are used to represent HTTP requests and responses, are derived from the </span><code class="inlinecode"><span class="kobospan" id="kobo.183.1">Readable</span></code><span class="kobospan" id="kobo.184.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.185.1">Writable</span></code><span class="kobospan" id="kobo.186.1"> classes.</span></p>
<h2 class="heading1" id="_idParaDest-118"><span class="kobospan" id="kobo.187.1">Writing data to a stream</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.188.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.189.1">Writable</span></code><span class="kobospan" id="kobo.190.1"> class is</span><a id="_idIndexMarker301" class="calibre3"/><span class="kobospan" id="kobo.191.1"> used to write data to a stream. </span><span class="kobospan" id="kobo.191.2">The </span><a id="_idIndexMarker302" class="calibre3"/><span class="kobospan" id="kobo.192.1">most useful features provided by the </span><code class="inlinecode"><span class="kobospan" id="kobo.193.1">Writable</span></code><span class="kobospan" id="kobo.194.1"> class are described in </span><em class="italic"><span class="kobospan" id="kobo.195.1">Table 6.4</span></em><span class="kobospan" id="kobo.196.1"> and explained in the sections that follow. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.197.1">Table 6.4: Useful Writable Features </span></p>
<table class="table-container" id="table004-2">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.198.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.199.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.200.1">write(data, callback)</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.201.1">This method writes data to the stream and invokes the optional callback function when the data has been flushed. </span><span class="kobospan" id="kobo.201.2">Data can be expressed as a </span><code class="inlinecode"><span class="kobospan2" id="kobo.202.1">string</span></code><span class="kobospan" id="kobo.203.1">, </span><code class="inlinecode"><span class="kobospan2" id="kobo.204.1">Buffer</span></code><span class="kobospan" id="kobo.205.1">, or </span><code class="inlinecode"><span class="kobospan2" id="kobo.206.1">Uint8Array</span></code><span class="kobospan" id="kobo.207.1">. </span><span class="kobospan4" id="kobo.207.2">For string values, an optional encoding can be specified.</span></p>
<p class="normal"><span class="kobospan3" id="kobo.208.1">The method returns a </span><code class="inlinecode"><span class="kobospan2" id="kobo.209.1">boolean</span></code><span class="kobospan" id="kobo.210.1"> value that indicates whether the stream is able to accept further data without exceeding its buffer size, as described in the </span><em class="italic"><span class="kobospan2" id="kobo.211.1">Avoiding excessive data buffering</span></em><span class="kobospan4" id="kobo.212.1"> section.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.213.1">end(data, callback)</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.214.1">This method tells Node.js that no further data will be sent. </span><span class="kobospan4" id="kobo.214.2">The arguments are an optional final chunk of data to write and an optional callback function that will be invoked when the data is finished.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.215.1">destroy(error)</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.216.1">This method destroys the stream immediately, without waiting for any pending data to be processed. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.217.1">closed</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.218.1">This property returns </span><code class="inlinecode"><span class="kobospan2" id="kobo.219.1">true</span></code><span class="kobospan4" id="kobo.220.1"> if the stream has been closed.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.221.1">destroyed</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.222.1">This property returns </span><code class="inlinecode"><span class="kobospan2" id="kobo.223.1">true</span></code><span class="kobospan" id="kobo.224.1"> if the </span><code class="inlinecode"><span class="kobospan2" id="kobo.225.1">destroy</span></code><span class="kobospan4" id="kobo.226.1"> method has been called.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.227.1">writable</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.228.1">This property returns </span><code class="inlinecode"><span class="kobospan2" id="kobo.229.1">true</span></code><span class="kobospan4" id="kobo.230.1"> if the stream can be written to, meaning that the stream has not ended, encountered an error, or been destroyed.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.231.1">writableEnded</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.232.1">This property returns </span><code class="inlinecode"><span class="kobospan2" id="kobo.233.1">true</span></code><span class="kobospan" id="kobo.234.1"> if the </span><code class="inlinecode"><span class="kobospan2" id="kobo.235.1">end</span></code><span class="kobospan4" id="kobo.236.1"> method has been called.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.237.1">writableHighWaterMark</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.238.1">This property returns the size of the data buffer in bytes. </span><span class="kobospan" id="kobo.238.2">The </span><code class="inlinecode"><span class="kobospan2" id="kobo.239.1">write</span></code><span class="kobospan" id="kobo.240.1"> method will return </span><code class="inlinecode"><span class="kobospan2" id="kobo.241.1">false</span></code><span class="kobospan4" id="kobo.242.1"> when the amount of buffered data exceeds this amount.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.243.1">errored</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.244.1">This property returns </span><code class="inlinecode"><span class="kobospan2" id="kobo.245.1">true</span></code><span class="kobospan4" id="kobo.246.1"> if the stream has encountered an error.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.247.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.248.1">Writable</span></code><span class="kobospan" id="kobo.249.1"> class also </span><a id="_idIndexMarker303" class="calibre3"/><span class="kobospan" id="kobo.250.1">emits events, the most useful of </span><a id="_idIndexMarker304" class="calibre3"/><span class="kobospan" id="kobo.251.1">which are described in </span><em class="italic"><span class="kobospan" id="kobo.252.1">Table 6.5</span></em><span class="kobospan" id="kobo.253.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.254.1">Table 6.5: Useful Writable Events </span></p>
<table class="table-container" id="table005-2">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.255.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.256.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.257.1">close</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.258.1">This event is emitted when the stream is closed.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.259.1">drain</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.260.1">This event is emitted when the stream can accept data without buffering.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.261.1">error</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.262.1">This event is emitted when an error occurs.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.263.1">finish</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.264.1">This event is emitted when the </span><code class="inlinecode"><span class="kobospan2" id="kobo.265.1">end</span></code><span class="kobospan4" id="kobo.266.1"> method is called and all of the data in the stream has been processed. </span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.267.1">The basic approach to using a writable stream is to call the </span><code class="inlinecode"><span class="kobospan" id="kobo.268.1">write</span></code><span class="kobospan" id="kobo.269.1"> method until all of the data has been sent to the stream, and then call the </span><code class="inlinecode"><span class="kobospan" id="kobo.270.1">end</span></code><span class="kobospan" id="kobo.271.1"> method, as shown in </span><em class="italic"><span class="kobospan" id="kobo.272.1">Listing 6.4</span></em><span class="kobospan" id="kobo.273.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.274.1">Listing 6.4: Writing Data in the handler.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.275.1">import { IncomingMessage, ServerResponse } from "http";
export const basicHandler = (req: IncomingMessage, resp: ServerResponse) =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.276.1">for (let i = 0</span></strong><strong class="screentext"><span class="kobospan" id="kobo.277.1">; i &lt; 10; i++) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.278.1">        resp.write(`Message: ${i}\n`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.279.1">    }</span></strong>
<strong class="screentext"> </strong>
<strong class="screentext"><span class="kobospan" id="kobo.280.1">    resp.end("End");</span></strong><span class="kobospan" id="kobo.281.1">
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.282.1">Save the changes, allow</span><a id="_idIndexMarker305" class="calibre3"/><span class="kobospan" id="kobo.283.1"> Node.js to restart, and then request </span><code class="inlinecode"><span class="kobospan" id="kobo.284.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.285.1">. </span><span class="kobospan" id="kobo.285.2">The handler will write its data to the response stream, producing the result shown in </span><em class="italic"><span class="kobospan" id="kobo.286.1">Figure 6.4</span></em><span class="kobospan" id="kobo.287.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.288.1"><img alt="" src="../Images/B21959_06_04.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.289.1">Figure 6.4: Writing data to an HTTP response stream</span></p>
<p class="normal"><span class="kobospan" id="kobo.290.1">It is easy to</span><a id="_idIndexMarker306" class="calibre3"/><span class="kobospan" id="kobo.291.1"> think of the endpoint of the stream as being a straight pipe to the ultimate recipient of the data, which is the web browser in this case, but that’s rarely the case. </span><span class="kobospan" id="kobo.291.2">The endpoint for most streams is the part of the Node.js API that interfaces with the operating system, in this case, the code that deals with the operating system’s network stack to send and receive data. </span><span class="kobospan" id="kobo.291.3">This indirect relationship leads to important considerations, as described in the sections that follow.</span></p>
<h3 class="heading2" id="_idParaDest-119"><span class="kobospan" id="kobo.292.1">Understanding stream enhancements</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.293.1">Some</span><a id="_idIndexMarker307" class="calibre3"/><span class="kobospan" id="kobo.294.1"> streams are enhanced to ease development, which means that the data you write to the stream won’t always be the data that is received at the other end. </span><span class="kobospan" id="kobo.294.2">In the case of HTTP responses, for example, the Node.js HTTP API aids development by ensuring that all responses conform to the basic requirements of the HTTP protocol, even when the programmer doesn’t explicitly use the features provided to set the status code and headers. </span><span class="kobospan" id="kobo.294.3">To see the content that the example in </span><em class="italic"><span class="kobospan" id="kobo.295.1">Listing 6.4</span></em><span class="kobospan" id="kobo.296.1"> writes to the stream, open a </span><a id="_idIndexMarker308" class="calibre3"/><span class="kobospan" id="kobo.297.1">new command prompt and run the Linux command shown in </span><em class="italic"><span class="kobospan" id="kobo.298.1">Listing 6.5</span></em><span class="kobospan" id="kobo.299.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.300.1">Listing 6.5: Making an HTTP Request (Linux)</span></p>
<pre class="programlisting2"><code class="hljs-code"><span class="kobospan" id="kobo.301.1">curl --include http://localhost:5000
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.302.1">If you are a Windows user, use PowerShell to run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.303.1">Listing 6.6</span></em><span class="kobospan" id="kobo.304.1"> instead.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.305.1">Listing 6.6: Making an HTTP Request (Windows)</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.306.1">(Invoke-WebRequest http://localhost:5000).RawContent
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.307.1">These commands make it easy to see the entire response sent by Node.js. </span><span class="kobospan" id="kobo.307.2">The code in </span><em class="italic"><span class="kobospan" id="kobo.308.1">Listing 6.4</span></em><span class="kobospan" id="kobo.309.1"> uses just the </span><code class="inlinecode"><span class="kobospan" id="kobo.310.1">write</span></code><span class="kobospan" id="kobo.311.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.312.1">end</span></code><span class="kobospan" id="kobo.313.1"> methods, but the HTTP response will be like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.314.1">...
</span><span class="kobospan" id="kobo.314.2">HTTP/1.1 200 OK
Connection: keep-alive
Keep-Alive: timeout=5
Transfer-Encoding: chunked
Date: Wed, 01 Nov 2023 19:46:02 GMT
X-Powered-By: Express
Message: 0
Message: 1
Message: 2
Message: 3
Message: 4
Message: 5
Message: 6
Message: 7
Message: 8
Message: 9
End
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.315.1">The Node.js HTTP API makes sure the response is legal HTTP by adding an HTTP version number, a status code and message, and a minimal set of headers. </span><span class="kobospan" id="kobo.315.2">This is a useful </span><a id="_idIndexMarker309" class="calibre3"/><span class="kobospan" id="kobo.316.1">feature, and it helps illustrate the fact that you cannot assume that the data you write to a stream will be the data that arrives at the other end.</span></p>
<p class="normal"><span class="kobospan" id="kobo.317.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.318.1">ServerResponse</span></code><span class="kobospan" id="kobo.319.1"> class demonstrates another kind of stream enhancement, which is methods or properties that write content to the stream for you, as shown in </span><em class="italic"><span class="kobospan" id="kobo.320.1">Listing 6.7</span></em><span class="kobospan" id="kobo.321.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.322.1">Listing 6.7: Using a Stream Enhancement Method in the handler.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.323.1">import { IncomingMessage, ServerResponse } from "http";
export const basicHandler = (req: IncomingMessage, resp: ServerResponse) =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.324.1">resp.setHeader("Content-Type", "text/plain");</span></strong><span class="kobospan" id="kobo.325.1">
    for (let i = 0; i &lt; 10; i++) {
        resp.write(`Message: ${i}\n`);
    }
   
    resp.end("End");
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.326.1">Behind the scenes, the </span><code class="inlinecode"><span class="kobospan" id="kobo.327.1">ServerResponse</span></code><span class="kobospan" id="kobo.328.1"> class merges the arguments passed to the </span><code class="inlinecode"><span class="kobospan" id="kobo.329.1">setHeader</span></code><span class="kobospan" id="kobo.330.1"> method with the default content used for responses. </span><span class="kobospan" id="kobo.330.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.331.1">ServerResponse</span></code><span class="kobospan" id="kobo.332.1"> class is derived from </span><code class="inlinecode"><span class="kobospan" id="kobo.333.1">Writable</span></code><span class="kobospan" id="kobo.334.1"> and implements the methods and properties described in </span><em class="italic"><span class="kobospan" id="kobo.335.1">Table 6.4</span></em><span class="kobospan" id="kobo.336.1">, but the enhancements make it easier to write content to the stream that is specific to HTTP requests, like setting a header in the response. </span><span class="kobospan" id="kobo.336.2">If you run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.337.1">Listing 6.6</span></em><span class="kobospan" id="kobo.338.1"> or </span><em class="italic"><span class="kobospan" id="kobo.339.1">Listing 6.7</span></em><span class="kobospan" id="kobo.340.1"> again, you will see the effect of calling the </span><code class="inlinecode"><span class="kobospan" id="kobo.341.1">setHeader</span></code><span class="kobospan" id="kobo.342.1"> method:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.343.1">...
</span><span class="kobospan" id="kobo.343.2">HTTP/1.1 200 OK
Connection: keep-alive
Keep-Alive: timeout=5
Transfer-Encoding: chunked
</span><strong class="screentext"><span class="kobospan" id="kobo.344.1">Content-Type: text/plain</span></strong><span class="kobospan" id="kobo.345.1">
Date: Wed, 01 Nov 2023 21:19:45 GMT
X-Powered-By: Express
...
</span></code></pre>
<h3 class="heading2" id="_idParaDest-120"><span class="kobospan" id="kobo.346.1">Avoiding excessive data buffering</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.347.1">Writable streams </span><a id="_idIndexMarker310" class="calibre3"/><span class="kobospan" id="kobo.348.1">are created with a buffer in which data is stored before it is processed. </span><span class="kobospan" id="kobo.348.2">The buffer is a way of improving performance, by allowing the producer of data to write data to the stream in bursts faster than the stream endpoint can process them.</span></p>
<p class="normal"><span class="kobospan" id="kobo.349.1">Each time the stream processes a chunk of data, it is said to have </span><em class="italic"><span class="kobospan" id="kobo.350.1">flushed</span></em><span class="kobospan" id="kobo.351.1"> the data. </span><span class="kobospan" id="kobo.351.2">When all of the data in the stream’s buffer has been processed, the stream buffer is said to have been </span><em class="italic"><span class="kobospan" id="kobo.352.1">drained</span></em><span class="kobospan" id="kobo.353.1">. </span><span class="kobospan" id="kobo.353.2">The amount of data that can be stored in the buffer is known as the </span><em class="italic"><span class="kobospan" id="kobo.354.1">high-water mark</span></em><span class="kobospan" id="kobo.355.1">. </span></p>
<p class="normal"><span class="kobospan" id="kobo.356.1">A writable stream will always accept data, even if it has to increase the size of its buffer, but this is undesirable because it increases the demand for memory that can be required for an extended period while the stream flushes the data it contains.</span></p>
<p class="normal"><span class="kobospan" id="kobo.357.1">The ideal approach is to write data to a stream until its buffer is full and then wait until that data is flushed before further data is written. </span><span class="kobospan" id="kobo.357.2">To help achieve this goal, the </span><code class="inlinecode"><span class="kobospan" id="kobo.358.1">write</span></code><span class="kobospan" id="kobo.359.1"> method returns a </span><code class="inlinecode"><span class="kobospan" id="kobo.360.1">boolean</span></code><span class="kobospan" id="kobo.361.1"> value that indicates whether the stream can receive more data without expanding its buffer beyond its target high-water mark.</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.362.1">Listing 6.8</span></em><span class="kobospan" id="kobo.363.1"> uses the value returned by the </span><code class="inlinecode"><span class="kobospan" id="kobo.364.1">write</span></code><span class="kobospan" id="kobo.365.1"> method to indicate when the stream buffer has reached capacity.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.366.1">Listing 6.8: Checking Stream Capacity in the handler.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.367.1">import { IncomingMessage, ServerResponse } from "http";
export const basicHandler = (req: IncomingMessage, resp: ServerResponse) =&gt; {
    resp.setHeader("Content-Type", "text/plain");
   </span><strong class="screentext"><span class="kobospan" id="kobo.368.1"> for (let i = 0; i &lt; </span></strong><strong class="screentext"><span class="kobospan" id="kobo.369.1">10_000; i++) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.370.1">        if (resp.write(`Message: ${i}\n`)) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.371.1">            console.log("Stream buffer is at capacity");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.372.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.373.1">    }</span></strong><span class="kobospan" id="kobo.374.1">
   
    resp.end("End");
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.375.1">You may </span><a id="_idIndexMarker311" class="calibre3"/><span class="kobospan" id="kobo.376.1">need to increase the maximum value used by the </span><code class="inlinecode"><span class="kobospan" id="kobo.377.1">for</span></code><span class="kobospan" id="kobo.378.1"> loop, but for my development PC, rapidly writing 10,000 messages to the stream will reliably reach the stream limits. </span><span class="kobospan" id="kobo.378.2">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.379.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.380.1">, and you will see messages like these produced by the Node.js console:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.381.1">...
</span><span class="kobospan" id="kobo.381.2">Stream buffer is at capacity
Stream buffer is at capacity
Stream buffer is at capacity
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.382.1">Writable streams emit the </span><code class="inlinecode"><span class="kobospan" id="kobo.383.1">drain</span></code><span class="kobospan" id="kobo.384.1"> event when their buffers have been drained, at which point more data can be written. </span><span class="kobospan" id="kobo.384.2">In </span><em class="italic"><span class="kobospan" id="kobo.385.1">Listing 6.9</span></em><span class="kobospan" id="kobo.386.1">, data is written to the HTTP response stream until the </span><code class="inlinecode"><span class="kobospan" id="kobo.387.1">write</span></code><span class="kobospan" id="kobo.388.1"> method returns </span><code class="inlinecode"><span class="kobospan" id="kobo.389.1">false</span></code><span class="kobospan" id="kobo.390.1"> and then stops writing until the </span><code class="inlinecode"><span class="kobospan" id="kobo.391.1">drain</span></code><span class="kobospan" id="kobo.392.1"> event is received. </span><span class="kobospan" id="kobo.392.2">(If you want to know when an individual chunk of data is flushed, then you can pass a callback function to the stream’s </span><code class="inlinecode"><span class="kobospan" id="kobo.393.1">write</span></code><span class="kobospan" id="kobo.394.1"> method.)</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.395.1">Listing 6.9: Avoiding Excessive Data Buffering in the handler.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.396.1">import { IncomingMessage, ServerResponse } from "http";
export const basicHandler = (req: IncomingMessage, resp: ServerResponse) =&gt; {
    resp.setHeader("Content-Type", "text/plain");
    </span><strong class="screentext"><span class="kobospan" id="kobo.397.1">let i = 0;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.398.1">    let canWrite = true;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.399.1">    const writeData = () =&gt; {</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.400.1">console.log("Started writing data"); </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.401.1">        do {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.402.1">            canWrite = resp.write(`Message: ${i++}\n`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.403.1">        } while (i &lt; 10_000 &amp;&amp; canWrite);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.404.1">        console.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.405.1">log("Buffer is at capacity");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.406.1">        if (i &lt; 10_000) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.407.1">            resp.once("drain", () =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.408.1">                console.log("Buffer has been drained");</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.409.1">writeData();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.410.1">            });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.411.1">        } else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.412.1">            resp.end("End");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.413.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.414.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.415.1">    writeData();</span></strong><span class="kobospan" id="kobo.416.1">
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.417.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.418.1">writeData</span></code><span class="kobospan" id="kobo.419.1"> function</span><a id="_idIndexMarker312" class="calibre3"/><span class="kobospan" id="kobo.420.1"> enters a </span><code class="inlinecode"><span class="kobospan" id="kobo.421.1">do...while</span></code><span class="kobospan" id="kobo.422.1"> loop that writes data to the stream until the </span><code class="inlinecode"><span class="kobospan" id="kobo.423.1">write</span></code><span class="kobospan" id="kobo.424.1"> method returns </span><code class="inlinecode"><span class="kobospan" id="kobo.425.1">false</span></code><span class="kobospan" id="kobo.426.1">. </span><span class="kobospan" id="kobo.426.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.427.1">once</span></code><span class="kobospan" id="kobo.428.1"> method is used to register a handler that will be invoked once when the </span><code class="inlinecode"><span class="kobospan" id="kobo.429.1">drain</span></code><span class="kobospan" id="kobo.430.1"> event is emitted, and which invokes the </span><code class="inlinecode"><span class="kobospan" id="kobo.431.1">writeData</span></code><span class="kobospan" id="kobo.432.1"> function to resume writing. </span><span class="kobospan" id="kobo.432.2">Once all of the data has been written, the </span><code class="inlinecode"><span class="kobospan" id="kobo.433.1">end</span></code><span class="kobospan" id="kobo.434.1"> method is called to finalize the stream.</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.435.1">Avoiding the Early End Pitfall</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.436.1">A common mistake – and one that I make regularly – is to put the call to the </span><code class="inlinecode"><span class="kobospan" id="kobo.437.1">end</span></code><span class="kobospan" id="kobo.438.1"> method outside of the callback functions that write the data, like this: </span></p>
<pre class="programlisting2"><code class="hljs-code"><code class="inlinecode2"><span class="kobospan" id="kobo.439.1">...</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.440.1">const writeData = () =&gt; {</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.441.1">    console.log("Started writing data"); </span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.442.1">    do {</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.443.1">        canWrite = resp.write(`Message: ${i++}\n`);</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.444.1">    } while (i &lt; 10_000 &amp;&amp; canWrite);</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.445.1">    console.log("Buffer is at capacity");</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.446.1">    if (i &lt; 10_000) {</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.447.1">        resp.once("drain", () =&gt; {</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.448.1">            console.log("Buffer has been drained");</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.449.1">            writeData();</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.450.1">        });</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.451.1">    }</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.452.1">}</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.453.1">writeData();</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.454.1">resp.end("End");</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.455.1">...</span></code>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.456.1">The outcome can differ but is usually an error because the callback will invoke the </span><code class="inlinecode"><span class="kobospan" id="kobo.457.1">write</span></code><span class="kobospan" id="kobo.458.1"> method after the stream has been closed, or not all the data will be written to the stream because the </span><code class="inlinecode"><span class="kobospan" id="kobo.459.1">drain</span></code><span class="kobospan" id="kobo.460.1"> event won’t be emitted. </span><span class="kobospan" id="kobo.460.2">To avoid this mistake, ensure that the </span><code class="inlinecode"><span class="kobospan" id="kobo.461.1">end</span></code><span class="kobospan" id="kobo.462.1"> method is invoked within the callback function once the data has been written.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.463.1">Use a </span><a id="_idIndexMarker313" class="calibre3"/><span class="kobospan" id="kobo.464.1">browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.465.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.466.1">, and you will see Node.js console messages that show the writing stops as the buffer reaches capacity, resuming once the buffer is drained:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.467.1">...
</span><span class="kobospan" id="kobo.467.2">Started writing data
Buffer is at capacity
Buffer has been drained
Started writing data
...
</span></code></pre>
<h2 class="heading1" id="_idParaDest-121"><span class="kobospan" id="kobo.468.1">Reading data from a stream</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.469.1">The most</span><a id="_idIndexMarker314" class="calibre3"/><span class="kobospan" id="kobo.470.1"> important source of data in a web application</span><a id="_idIndexMarker315" class="calibre3"/><span class="kobospan" id="kobo.471.1"> comes from HTTP request bodies. </span><span class="kobospan" id="kobo.471.2">The example project needs a little preparation so that the client-side code can make an HTTP request with a body. </span><span class="kobospan" id="kobo.471.3">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.472.1">index.html</span></code><span class="kobospan" id="kobo.473.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.474.1">static</span></code><span class="kobospan" id="kobo.475.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.476.1">Listing 6.10</span></em><span class="kobospan" id="kobo.477.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.478.1">Listing 6.10: The Contents of the index.html File in the static Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.479.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;script&gt;
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById("btn")
                    .addEventListener("click", sendReq);
            });
            sendReq = async () =&gt; {
                let payload = "";
                for (let i = 0; i &lt; 10_000; i++) {
                    payload += `Payload Message: ${i}\n`;
                }
                const response = await fetch("/read", {
                    method: "POST", body: payload
                })
                document.getElementById("msg").textContent
                     = response.statusText;
                document.getElementById("body").textContent
                    = await response.text();
            }
        &lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
       &lt;button id="btn"&gt;Send Request&lt;/button&gt;
       &lt;div id="msg"&gt;&lt;/div&gt;
       &lt;div id="body"&gt;&lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.480.1">This is a</span><a id="_idIndexMarker316" class="calibre3"/><span class="kobospan" id="kobo.481.1"> simple HTML document that contains some </span><a id="_idIndexMarker317" class="calibre3"/><span class="kobospan" id="kobo.482.1">JavaScript code. </span><span class="kobospan" id="kobo.482.2">I’ll make improvements later in the chapter, including separating the JavaScript and HTML content into separate files, but this is enough to get started. </span><span class="kobospan" id="kobo.482.3">The JavaScript code in </span><em class="italic"><span class="kobospan" id="kobo.483.1">Listing 6.10</span></em><span class="kobospan" id="kobo.484.1"> uses the browser’s Fetch API to send an HTTP POST request with a body that contains 1,000 lines of text. </span><em class="italic"><span class="kobospan" id="kobo.485.1">Listing 6.11</span></em><span class="kobospan" id="kobo.486.1"> updates the existing request handler so that it responds with the contents of the HTML file.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.487.1">Listing 6.11: Updating the Handlers in the handler.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.488.1">import { IncomingMessage, ServerResponse } from "http";
</span><strong class="screentext"><span class="kobospan" id="kobo.489.1">import { readFileSync } from "fs";</span></strong><span class="kobospan" id="kobo.490.1">
export const basicHandler = (req: IncomingMessage, resp: ServerResponse) =&gt; { 
    </span><strong class="screentext"><span class="kobospan" id="kobo.491.1">resp.write(readFileSync("static/index.html"));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.492.1">    resp.end();</span></strong><span class="kobospan" id="kobo.493.1">
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.494.1">I use</span><a id="_idIndexMarker318" class="calibre3"/><span class="kobospan" id="kobo.495.1"> the </span><code class="inlinecode"><span class="kobospan" id="kobo.496.1">readFileSync</span></code><span class="kobospan" id="kobo.497.1"> function to perform a blocking</span><a id="_idIndexMarker319" class="calibre3"/><span class="kobospan" id="kobo.498.1"> read of the </span><code class="inlinecode"><span class="kobospan" id="kobo.499.1">index.html</span></code><span class="kobospan" id="kobo.500.1"> file, which is simple but is not the best way to read files, as I explain later in this chapter. </span><span class="kobospan" id="kobo.500.2">To create a new handler that will be used to read the data sent by the browser, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.501.1">readHandler.ts</span></code><span class="kobospan" id="kobo.502.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.503.1">src</span></code><span class="kobospan" id="kobo.504.1"> folder with the contents shown in </span><em class="italic"><span class="kobospan" id="kobo.505.1">Listing 6.12</span></em><span class="kobospan" id="kobo.506.1">. </span><span class="kobospan" id="kobo.506.2">For the moment, this handler is a placeholder that ends the response without producing any content.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.507.1">Listing 6.12: The Contents of the readHandler.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.508.1">import { IncomingMessage, ServerResponse } from "http";
export const readHandler = (req: IncomingMessage, resp: ServerResponse) =&gt; {
    // TODO - read request body
    resp.end();
}
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.509.1">Listing 6.13</span></em><span class="kobospan" id="kobo.510.1"> completes the preparation by adding a route that matches POST requests and sends them to the new handler.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.511.1">Listing 6.13: Adding a Route in the server.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.512.1">import { createServer } from "http";
import express, {Express } from "express";
import { basicHandler } from "./handler";
</span><strong class="screentext"><span class="kobospan" id="kobo.513.1">import { readHandler } from "./readHandler";</span></strong><span class="kobospan" id="kobo.514.1">
const port = 5000;
const expressApp: Express = express();
expressApp.get("/favicon.ico", (req, resp) =&gt; {
    resp.statusCode = 404;
    resp.end();
});
expressApp.get("*", basicHandler);
</span><strong class="screentext"><span class="kobospan" id="kobo.515.1">expressApp.post("/read", readHandler);</span></strong><span class="kobospan" id="kobo.516.1">
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.517.1">Use a</span><a id="_idIndexMarker320" class="calibre3"/><span class="kobospan" id="kobo.518.1"> browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.519.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.520.1">, and you will see the button defined by the HTML document. </span><span class="kobospan" id="kobo.520.2">Click</span><a id="_idIndexMarker321" class="calibre3"/><span class="kobospan" id="kobo.521.1"> the button, and the browser will send an HTTP POST request and display the status message from the response it receives, as shown in </span><em class="italic"><span class="kobospan" id="kobo.522.1">Figure 6.5</span></em><span class="kobospan" id="kobo.523.1">. </span><span class="kobospan" id="kobo.523.2">The content presented by the browser is completely unstyled, but this is enough for now.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.524.1"><img alt="" src="../Images/B21959_06_05.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.525.1">Figure 6.5: Sending an HTTP POST request</span></p>
<h3 class="heading2" id="_idParaDest-122"><span class="kobospan" id="kobo.526.1">Understanding the Readable class</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.527.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.528.1">Readable</span></code><span class="kobospan" id="kobo.529.1"> class</span><a id="_idIndexMarker322" class="calibre3"/><span class="kobospan" id="kobo.530.1"> is used to read data from a stream. </span><em class="italic"><span class="kobospan" id="kobo.531.1">Table 6.6</span></em><span class="kobospan" id="kobo.532.1"> describes </span><a id="_idIndexMarker323" class="calibre3"/><span class="kobospan" id="kobo.533.1">the most useful </span><code class="inlinecode"><span class="kobospan" id="kobo.534.1">Readable</span></code><span class="kobospan" id="kobo.535.1"> features. </span></p>
<p class="packt_figref"><em class="italic"><span class="kobospan" id="kobo.536.1">Table 6.6</span></em><span class="kobospan" id="kobo.537.1">: Useful Readable Features</span></p>
<table class="table-container" id="table006-2">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.538.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.539.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.540.1">pause()</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.541.1">Calling this method tells the stream to temporarily stop emitting the </span><code class="inlinecode"><span class="kobospan2" id="kobo.542.1">data</span></code><span class="kobospan4" id="kobo.543.1"> event.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.544.1">resume()</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.545.1">Calling this method tells the stream to resume emitting the </span><code class="inlinecode"><span class="kobospan2" id="kobo.546.1">data</span></code><span class="kobospan4" id="kobo.547.1"> event.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.548.1">isPaused()</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.549.1">This method returns </span><code class="inlinecode"><span class="kobospan2" id="kobo.550.1">true</span></code><span class="kobospan" id="kobo.551.1"> if the stream’s </span><code class="inlinecode"><span class="kobospan2" id="kobo.552.1">data</span></code><span class="kobospan4" id="kobo.553.1"> events have been paused.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.554.1">pipe(writable)</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.555.1">This method is used to transfer the stream’s data to a </span><code class="inlinecode"><span class="kobospan2" id="kobo.556.1">Writable</span></code><span class="kobospan4" id="kobo.557.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.558.1">destroy(error)</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.559.1">This method destroys the stream immediately, without waiting for any pending data to be processed.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.560.1">closed</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.561.1">This property returns </span><code class="inlinecode"><span class="kobospan2" id="kobo.562.1">true</span></code><span class="kobospan4" id="kobo.563.1"> if the stream has been closed.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.564.1">destroyed</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.565.1">This property returns </span><code class="inlinecode"><span class="kobospan2" id="kobo.566.1">true</span></code><span class="kobospan" id="kobo.567.1"> if the </span><code class="inlinecode"><span class="kobospan2" id="kobo.568.1">destroy</span></code><span class="kobospan4" id="kobo.569.1"> method has been called.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.570.1">errored</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.571.1">This property returns </span><code class="inlinecode"><span class="kobospan2" id="kobo.572.1">true</span></code><span class="kobospan4" id="kobo.573.1"> if the stream has encountered an error.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.574.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.575.1">Readable</span></code><span class="kobospan" id="kobo.576.1"> class also emits events, the most useful of which are described in </span><em class="italic"><span class="kobospan" id="kobo.577.1">Table 6.7</span></em><span class="kobospan" id="kobo.578.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.579.1">Table 6.7: Useful Readable Events</span></p>
<table class="table-container" id="table007-1">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.580.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.581.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.582.1">data</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.583.1">This event is emitted when the stream is in flowing mode and provides access to the data in the stream. </span><span class="kobospan" id="kobo.583.2">See the </span><em class="italic"><span class="kobospan2" id="kobo.584.1">Reading Data with events</span></em><span class="kobospan4" id="kobo.585.1"> section for details.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.586.1">end</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.587.1">This event is emitted when there is no more data to be read from the stream.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.588.1">close</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.589.1">This event is emitted when the stream is closed. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.590.1">pause</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.591.1">This event is emitted when data reading is paused by calling the </span><code class="inlinecode"><span class="kobospan2" id="kobo.592.1">pause</span></code><span class="kobospan4" id="kobo.593.1"> method.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.594.1">resume</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.595.1">This event is emitted when data reading is restarted by calling the </span><code class="inlinecode"><span class="kobospan2" id="kobo.596.1">resume</span></code><span class="kobospan4" id="kobo.597.1"> method.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.598.1">error</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.599.1">This event is triggered if there is an error reading data from the stream.</span></p>
</td>
</tr>
</tbody>
</table>
<h3 class="heading2" id="_idParaDest-123"><span class="kobospan" id="kobo.600.1">Reading data with events</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.601.1">Data can be read </span><a id="_idIndexMarker324" class="calibre3"/><span class="kobospan" id="kobo.602.1">from the stream using events, as shown in </span><em class="italic"><span class="kobospan" id="kobo.603.1">Listing 6.14</span></em><span class="kobospan" id="kobo.604.1">, where a callback function is used to process data as it becomes available. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.605.1">Listing 6.14: Reading Data in the readHandler.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.606.1">import { IncomingMessage, ServerResponse } from "http";
export const readHandler = (req: IncomingMessage, resp: ServerResponse) =&gt; </span><strong class="screentext"><span class="kobospan" id="kobo.607.1">{</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.608.1">    req.setEncoding("utf-8");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.609.1">    req.on("data", (data: string) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.610.1">        console</span></strong><strong class="screentext"><span class="kobospan" id="kobo.611.1">.log(data);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.612.1">    });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.613.1">    req.on("end", () =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.614.1">        console.log("End: all data read");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.615.1">        resp.end();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.616.1">    });   </span></strong><span class="kobospan" id="kobo.617.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.618.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.619.1">data</span></code><span class="kobospan" id="kobo.620.1"> event is emitted when data is available to be read from the stream and is available for processing by the callback function used to handle the event. </span><span class="kobospan" id="kobo.620.2">The data is passed to the callback function as a </span><code class="inlinecode"><span class="kobospan" id="kobo.621.1">Buffer</span></code><span class="kobospan" id="kobo.622.1">, which represents an array of unsigned bytes, unless the </span><code class="inlinecode"><span class="kobospan" id="kobo.623.1">setEncoding</span></code><span class="kobospan" id="kobo.624.1"> method has been used to specify character encoding, in which case the data is expressed as a </span><code class="inlinecode"><span class="kobospan" id="kobo.625.1">string</span></code><span class="kobospan" id="kobo.626.1">.</span></p>
<p class="normal"><span class="kobospan" id="kobo.627.1">This example sets the character encoding to UTF-8 so that the callback function for the </span><code class="inlinecode"><span class="kobospan" id="kobo.628.1">data</span></code><span class="kobospan" id="kobo.629.1"> event will receive </span><code class="inlinecode"><span class="kobospan" id="kobo.630.1">string</span></code><span class="kobospan" id="kobo.631.1"> values, which are then written out using the </span><code class="inlinecode"><span class="kobospan" id="kobo.632.1">console.log</span></code><span class="kobospan" id="kobo.633.1"> method.</span></p>
<p class="normal"><span class="kobospan" id="kobo.634.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.635.1">end</span></code><span class="kobospan" id="kobo.636.1"> event is emitted when all of the data has been read from the stream. </span><span class="kobospan" id="kobo.636.2">To avoid a variation of the early-end pitfall I described earlier, I call the response’s </span><code class="inlinecode"><span class="kobospan" id="kobo.637.1">end</span></code><span class="kobospan" id="kobo.638.1"> method only when the readable stream’s </span><code class="inlinecode"><span class="kobospan" id="kobo.639.1">end</span></code><span class="kobospan" id="kobo.640.1"> method is emitted. </span><span class="kobospan" id="kobo.640.2">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.641.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.642.1"> and click the </span><strong class="screentext"><span class="kobospan" id="kobo.643.1">Send Request</span></strong><span class="kobospan" id="kobo.644.1"> button, and you</span><a id="_idIndexMarker325" class="calibre3"/><span class="kobospan" id="kobo.645.1"> will see a sequence of Node.js console messages as the data is read from the stream:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.646.1">...
</span><span class="kobospan" id="kobo.646.2">Payload Message: 0
Payload Message: 1
Payload Message: 2
Payload Message: 3
...
</span><span class="kobospan" id="kobo.646.3">Payload Message: 9997
Payload Message: 9998
Payload Message: 9999
End: all data read
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.647.1">The JavaScript main thread ensures that </span><code class="inlinecode"><span class="kobospan" id="kobo.648.1">data</span></code><span class="kobospan" id="kobo.649.1"> events are processed sequentially, but the basic idea is that data is read and processed as quickly as possible, such that the </span><code class="inlinecode"><span class="kobospan" id="kobo.650.1">data</span></code><span class="kobospan" id="kobo.651.1"> event will be emitted as soon as possible once data is available to be read.</span></p>
<h3 class="heading2" id="_idParaDest-124"><span class="kobospan" id="kobo.652.1">Reading data with an iterator</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.653.1">Instances of the </span><code class="inlinecode"><span class="kobospan" id="kobo.654.1">Readable</span></code><span class="kobospan" id="kobo.655.1"> class </span><a id="_idIndexMarker326" class="calibre3"/><span class="kobospan" id="kobo.656.1">can be used as a source of data in a </span><code class="inlinecode"><span class="kobospan" id="kobo.657.1">for</span></code><span class="kobospan" id="kobo.658.1"> loop, which can provide a more familiar way to read data from a stream, as shown in </span><em class="italic"><span class="kobospan" id="kobo.659.1">Listing 6.15</span></em><span class="kobospan" id="kobo.660.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.661.1">Listing 6.15: Reading Data in a Loop in the readHandler.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.662.1">import { IncomingMessage, ServerResponse } from "http";
</span><strong class="screentext"><span class="kobospan" id="kobo.663.1">export const readHandler = async (req: IncomingMessage, resp: ServerResponse) =&gt; {</span></strong><span class="kobospan" id="kobo.664.1">
    req.setEncoding("utf-8");
</span><strong class="screentext"><span class="kobospan" id="kobo.665.1">    for await (const data of req) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.666.1">        console.log(data);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.667.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.668.1">    console.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.669.1">log("End: all data read");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.670.1">    resp.end();</span></strong><span class="kobospan" id="kobo.671.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.672.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.673.1">async</span></code><span class="kobospan" id="kobo.674.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.675.1">await</span></code><span class="kobospan" id="kobo.676.1"> keywords must be used as shown in the example, but the result is that </span><a id="_idIndexMarker327" class="calibre3"/><span class="kobospan" id="kobo.677.1">the </span><code class="inlinecode"><span class="kobospan" id="kobo.678.1">for</span></code><span class="kobospan" id="kobo.679.1"> loop reads data from the stream until it is all consumed. </span><span class="kobospan" id="kobo.679.2">This example produces the same output as </span><em class="italic"><span class="kobospan" id="kobo.680.1">Listing 6.14</span></em><span class="kobospan" id="kobo.681.1">.</span></p>
<h3 class="heading2" id="_idParaDest-125"><span class="kobospan" id="kobo.682.1">Piping data to a writable stream</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.683.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.684.1">pipe</span></code><span class="kobospan" id="kobo.685.1"> method</span><a id="_idIndexMarker328" class="calibre3"/><span class="kobospan" id="kobo.686.1"> is used to connect a </span><code class="inlinecode"><span class="kobospan" id="kobo.687.1">Readable</span></code><span class="kobospan" id="kobo.688.1"> stream to a </span><code class="inlinecode"><span class="kobospan" id="kobo.689.1">Writeable</span></code><span class="kobospan" id="kobo.690.1"> stream, ensuring that all of the data is read from the </span><code class="inlinecode"><span class="kobospan" id="kobo.691.1">Readable</span></code><span class="kobospan" id="kobo.692.1"> and written to the </span><code class="inlinecode"><span class="kobospan" id="kobo.693.1">Writable</span></code><span class="kobospan" id="kobo.694.1"> without further intervention, as shown in </span><em class="italic"><span class="kobospan" id="kobo.695.1">Listing 6.16</span></em><span class="kobospan" id="kobo.696.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.697.1">Listing 6.16: Piping Data into the readHandler.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.698.1">import { IncomingMessage, ServerResponse } from "http";
export const readHandler = async (req: IncomingMessage, resp: ServerResponse) =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.699.1">req.pipe(resp);</span></strong><span class="kobospan" id="kobo.700.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.701.1">This is the simplest way to transfer data between streams, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.702.1">end</span></code><span class="kobospan" id="kobo.703.1"> method is called automatically on the </span><code class="inlinecode"><span class="kobospan" id="kobo.704.1">Writeable</span></code><span class="kobospan" id="kobo.705.1"> stream once all of the data has been transferred. </span><span class="kobospan" id="kobo.705.2">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.706.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.707.1"> and click the </span><strong class="screentext"><span class="kobospan" id="kobo.708.1">Send Request</span></strong><span class="kobospan" id="kobo.709.1"> button. </span><span class="kobospan" id="kobo.709.2">The data that is sent in the HTTP request is piped to the HTTP response and displayed in the browser window, as shown in </span><em class="italic"><span class="kobospan" id="kobo.710.1">Figure 6.6</span></em><span class="kobospan" id="kobo.711.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.712.1"><img alt="" src="../Images/B21959_06_06.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.713.1">Figure 6.6: Piping data</span></p>
<h1 class="heading" id="_idParaDest-126"><span class="kobospan" id="kobo.714.1">Transforming data</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.715.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.716.1">Transform</span></code><span class="kobospan" id="kobo.717.1"> class is</span><a id="_idIndexMarker329" class="calibre3"/><span class="kobospan" id="kobo.718.1"> used to create objects, known as </span><em class="italic"><span class="kobospan" id="kobo.719.1">transformers</span></em><span class="kobospan" id="kobo.720.1">, that receive data from a </span><code class="inlinecode"><span class="kobospan" id="kobo.721.1">Readable</span></code><span class="kobospan" id="kobo.722.1"> stream, process it in some way, and then pass it on. </span><span class="kobospan" id="kobo.722.2">Transformers are applied to streams with the </span><code class="inlinecode"><span class="kobospan" id="kobo.723.1">pipe</span></code><span class="kobospan" id="kobo.724.1"> method, as shown in </span><em class="italic"><span class="kobospan" id="kobo.725.1">Listing 6.17</span></em><span class="kobospan" id="kobo.726.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.727.1">Listing 6.17: Creating a Transformer in the readHandler.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.728.1">import { IncomingMessage, ServerResponse } from "http";
</span><strong class="screentext"><span class="kobospan" id="kobo.729.1">import { Transform } from "stream";</span></strong><span class="kobospan" id="kobo.730.1">
export const readHandler = async (req: IncomingMessage, resp: ServerResponse) =&gt; {
</span><strong class="screentext"><span class="kobospan" id="kobo.731.1">    req.pipe(createLowerTransform()).pipe(resp);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.732.1">}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.733.1">const</span></strong><strong class="screentext"><span class="kobospan" id="kobo.734.1"> createLowerTransform = () =&gt;  new Transform({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.735.1">    transform(data, encoding, callback) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.736.1">        callback(null, data.toString().toLowerCase());</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.737.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.738.1">});</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.739.1">The </span><a id="_idIndexMarker330" class="calibre3"/><span class="kobospan" id="kobo.740.1">argument to the </span><code class="inlinecode"><span class="kobospan" id="kobo.741.1">Transform</span></code><span class="kobospan" id="kobo.742.1"> constructor is an object whose </span><code class="inlinecode"><span class="kobospan" id="kobo.743.1">transform</span></code><span class="kobospan" id="kobo.744.1"> property value is a function that will be invoked when there is data to process. </span><span class="kobospan" id="kobo.744.2">The function receives three arguments: a chunk of data to process, which can be of any data type, a string encoding type, and a callback function that is used to pass on the transformed data. </span><span class="kobospan" id="kobo.744.3">In this example, the data that is received is converted to a string on which the </span><code class="inlinecode"><span class="kobospan" id="kobo.745.1">toLowerCase</span></code><span class="kobospan" id="kobo.746.1"> method is called. </span><span class="kobospan" id="kobo.746.2">The result is passed to the callback function, whose arguments are an object that represents any error that has occurred and the transformed data.</span></p>
<p class="normal"><span class="kobospan" id="kobo.747.1">The transformer is applied with the </span><code class="inlinecode"><span class="kobospan" id="kobo.748.1">pipe</span></code><span class="kobospan" id="kobo.749.1"> method and, in this case, is chained so that the data read from the HTTP request is transformed and then written to the HTTP response. </span><span class="kobospan" id="kobo.749.2">Note that a new </span><code class="inlinecode"><span class="kobospan" id="kobo.750.1">Transform</span></code><span class="kobospan" id="kobo.751.1"> object must be created for every request, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.752.1">...
</span><span class="kobospan" id="kobo.752.2">req.pipe(</span><strong class="screentext"><span class="kobospan" id="kobo.753.1">createLowerTransform()</span></strong><span class="kobospan" id="kobo.754.1">).pipe(resp);
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.755.1">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.756.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.757.1">, and click on the </span><strong class="screentext"><span class="kobospan" id="kobo.758.1">Send Request</span></strong><span class="kobospan" id="kobo.759.1"> button. </span><span class="kobospan" id="kobo.759.2">The content displayed by the browser, which comes from the HTTP response body, is all lowercase, as shown in </span><em class="italic"><span class="kobospan" id="kobo.760.1">Figure 6.7</span></em><span class="kobospan" id="kobo.761.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.762.1"><img alt="" src="../Images/B21959_06_07.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.763.1">Figure 6.7: Using a simple transformer</span></p>
<h2 class="heading1" id="_idParaDest-127"><span class="kobospan" id="kobo.764.1">Using object mode</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.765.1">The streams created </span><a id="_idIndexMarker331" class="calibre3"/><span class="kobospan" id="kobo.766.1">by the Node.js API, such as the ones used for HTTP requests or files, work only on strings and byte arrays. </span><span class="kobospan" id="kobo.766.2">This isn’t always convenient, and so some streams, including transformers, can use </span><em class="italic"><span class="kobospan" id="kobo.767.1">object mode</span></em><span class="kobospan" id="kobo.768.1">, which allows objects to be read or written. </span><span class="kobospan" id="kobo.768.2">To prepare for this example, </span><em class="italic"><span class="kobospan" id="kobo.769.1">Listing 6.18</span></em><span class="kobospan" id="kobo.770.1"> updates the JavaScript code contained within the static HTML file to send a request containing an array of JSON-formatted objects. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.771.1">Listing 6.18: Sending a JSON Request Body in the index.html File in the static Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.772.1">...
</span><span class="kobospan" id="kobo.772.2">&lt;script&gt;
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById("btn").addEventListener("click", sendReq);
    });
    sendReq = async () =&gt; {
        </span><strong class="screentext"><span class="kobospan" id="kobo.773.1">let payload = [];</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.774.1">        for (let i = 0; i &lt; 5; i++) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.775.1">            payload.push({ id: i, message: `Payload Message: ${i}\n`</span></strong><strong class="screentext"><span class="kobospan" id="kobo.776.1">});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.777.1">        }</span></strong><span class="kobospan" id="kobo.778.1">
        const response = await fetch("/read", {
           </span><strong class="screentext"><span class="kobospan" id="kobo.779.1"> method: "POST", body: JSON.stringify</span></strong><strong class="screentext"><span class="kobospan" id="kobo.780.1">(payload),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.781.1">            headers: {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.782.1">                "Content-Type": "application/json"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.783.1">            }</span></strong><span class="kobospan" id="kobo.784.1">
        });
        document.getElementById("msg").textContent = response.statusText;
        document.getElementById("body").textContent = await response.text();
    }
&lt;/script&gt;
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.785.1">The </span><a id="_idIndexMarker332" class="calibre3"/><span class="kobospan" id="kobo.786.1">data sent by the client can still be read as a string or a byte array, but a transform can be used to convert the request payload into a JavaScript object or convert a JavaScript object into a string or byte array, known as </span><em class="italic"><span class="kobospan" id="kobo.787.1">object mode</span></em><span class="kobospan" id="kobo.788.1">. </span><span class="kobospan" id="kobo.788.2">Two </span><code class="inlinecode"><span class="kobospan" id="kobo.789.1">Transform</span></code><span class="kobospan" id="kobo.790.1"> constructor configuration settings are used to tell Node.js how a transformer will behave, as described in </span><em class="italic"><span class="kobospan" id="kobo.791.1">Table 6.8</span></em><span class="kobospan" id="kobo.792.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.793.1">Table 6.8: The Transform Constructor Configuration Settings</span></p>
<table class="table-container" id="table008-1">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.794.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.795.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.796.1">readableObjectMode</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.797.1">When set to </span><code class="inlinecode"><span class="kobospan2" id="kobo.798.1">true</span></code><span class="kobospan4" id="kobo.799.1">, the transformer will consume string/byte data and produce an object.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.800.1">writableObjectMode</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.801.1">When set to </span><code class="inlinecode"><span class="kobospan2" id="kobo.802.1">true</span></code><span class="kobospan4" id="kobo.803.1">, the transformer will consume an object and produce string/byte data.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.804.1">Listing 6.19</span></em><span class="kobospan" id="kobo.805.1"> shows a transformer that sets the </span><code class="inlinecode"><span class="kobospan" id="kobo.806.1">readableObjectMode</span></code><span class="kobospan" id="kobo.807.1"> setting to </span><code class="inlinecode"><span class="kobospan" id="kobo.808.1">true</span></code><span class="kobospan" id="kobo.809.1">, which means that it will read string data from the HTTP request payload but produce a JavaScript object when its data is read.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.810.1">Listing 6.19: Parsing JSON in the readHandler.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.811.1">import { IncomingMessage, ServerResponse } from "http";
import { Transform } from "stream";
export const readHandler = async (req: IncomingMessage, resp: ServerResponse) =&gt; {   
    </span><strong class="screentext"><span class="kobospan" id="kobo.812.1">if (req.headers["content-type"] == "application/json") {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.813.1">        req.pipe(createFromJsonTransform()).on("data", (payload) =&gt;</span></strong><strong class="screentext"><span class="kobospan" id="kobo.814.1"> {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.815.1">            if (payload instanceof Array) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.816.1">                resp.write(`Received an array with ${payload.length} items`)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.817.1">            }  else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.818.1">                resp.write("Did not receive an array");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.819.1">            }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.820.1">            resp.end</span></strong><strong class="screentext"><span class="kobospan" id="kobo.821.1">();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.822.1">        });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.823.1">    } else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.824.1">        req.pipe(resp);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.825.1">    }</span></strong><span class="kobospan" id="kobo.826.1">
}
</span><strong class="screentext"><span class="kobospan" id="kobo.827.1">const createFromJsonTransform = () =&gt; new Transform({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.828.1">    readableObjectMode: true,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.829.1">    transform(data, encoding, callback</span></strong><strong class="screentext"><span class="kobospan" id="kobo.830.1">) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.831.1">        callback(null, JSON.parse(data));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.832.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.833.1">});</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.834.1">If the</span><a id="_idIndexMarker333" class="calibre3"/><span class="kobospan" id="kobo.835.1"> HTTP request has a </span><code class="inlinecode"><span class="kobospan" id="kobo.836.1">Content-Type</span></code><span class="kobospan" id="kobo.837.1"> header that indicates the payload is JSON, then the transformer is used to parse the data, which is received by the request handler using the </span><code class="inlinecode"><span class="kobospan" id="kobo.838.1">data </span></code><span class="kobospan" id="kobo.839.1">event. </span><span class="kobospan" id="kobo.839.2">The parsed payload is checked to see if it is an array, and if it is, then its length is used to generate a response. </span><span class="kobospan" id="kobo.839.3">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.840.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.841.1"> (or make sure to reload the browser so that the changes in </span><em class="italic"><span class="kobospan" id="kobo.842.1">Listing 6.18</span></em><span class="kobospan" id="kobo.843.1"> take effect), click the </span><strong class="screentext"><span class="kobospan" id="kobo.844.1">Send Request</span></strong><span class="kobospan" id="kobo.845.1"> button, and you will see the response shown in </span><em class="italic"><span class="kobospan" id="kobo.846.1">Figure 6.8</span></em><span class="kobospan" id="kobo.847.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.848.1"><img alt="" src="../Images/B21959_06_08.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.849.1">Figure 6.8: Using a transformer in object mode</span></p>
<h1 class="heading" id="_idParaDest-128"><span class="kobospan" id="kobo.850.1">Using third-party enhancements</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.851.1">In the sections</span><a id="_idIndexMarker334" class="calibre3"/><span class="kobospan" id="kobo.852.1"> that follow, I describe useful enhancements provided by the Express package to deal with streams and tasks that are related to HTTP. </span><span class="kobospan" id="kobo.852.2">Express isn’t the only package that provides these kinds of features, but it is a good default choice for new projects and gives you a foundation from which to compare alternatives. </span></p>
<h2 class="heading1" id="_idParaDest-129"><a id="_idIndexMarker335" class="calibre3"/><a id="_idIndexMarker336" class="calibre3"/><a id="_idIndexMarker337" class="calibre3"/><span class="kobospan" id="kobo.853.1">Working with files</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.854.1">One of the most</span><a id="_idIndexMarker338" class="calibre3"/><span class="kobospan" id="kobo.855.1"> important tasks for a web server is to respond to requests for files, which provide browsers with the HTML, JavaScript, and other static content required by the client-side part of the application. </span></p>
<p class="normal"><span class="kobospan" id="kobo.856.1">Node.js provides a comprehensive API to deal with files in the </span><code class="inlinecode"><span class="kobospan" id="kobo.857.1">fs</span></code><span class="kobospan" id="kobo.858.1"> module, and it has support for reading and writing streams, along with convenience features that read or write complete files, such as the </span><code class="inlinecode"><span class="kobospan" id="kobo.859.1">readFileSync</span></code><span class="kobospan" id="kobo.860.1"> function I used to read the contents of an HTML file.</span></p>
<p class="normal"><span class="kobospan" id="kobo.861.1">The reason I have not described the API in any detail is that working directly with files within a web server project is incredibly dangerous and should be avoided whenever possible. </span><span class="kobospan" id="kobo.861.2">There is a huge scope to create malicious requests whose paths </span><a id="_idIndexMarker339" class="calibre3"/><span class="kobospan" id="kobo.862.1">attempt to access files outside of the expected locations, for example. </span><span class="kobospan" id="kobo.862.2">And, through personal experience, I have learned not to let clients create or modify files on the server under any circumstances. </span></p>
<p class="normal"><span class="kobospan" id="kobo.863.1">I have worked on too many projects where malicious requests have been able to overwrite system files or simply overwhelm servers by writing so much data that storage space is exhausted.</span></p>
<p class="normal"><span class="kobospan" id="kobo.864.1">The best way to deal with files is to use a well-tested package, rather than write custom code, and it is for this reason that I have not described the features of the </span><code class="inlinecode"><span class="kobospan" id="kobo.865.1">fs</span></code><span class="kobospan" id="kobo.866.1"> module.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.867.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.868.1">If you decide to ignore my warning, then you can find details of the </span><code class="inlinecode"><span class="kobospan" id="kobo.869.1">fs</span></code><span class="kobospan" id="kobo.870.1"> module and the features it provides at </span><a href="https://nodejs.org/dist/latest-v20.x/docs/api/fs.html" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.871.1">https://nodejs.org/dist/latest-v20.x/docs/api/fs.html</span></span></a><span class="kobospan" id="kobo.872.1">.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.873.1">The Express package has integrated support to serve requests for files. </span><span class="kobospan" id="kobo.873.2">To prepare, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.874.1">client.js</span></code><span class="kobospan" id="kobo.875.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.876.1">static</span></code><span class="kobospan" id="kobo.877.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.878.1">Listing 6.20</span></em><span class="kobospan" id="kobo.879.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.880.1">Listing 6.20: The Contents of the client.js File in the static Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.881.1">document.addEventListener('DOMContentLoaded', function() {
    document.getElementById("btn").addEventListener("click", sendReq);
});
sendReq = async () =&gt; {
    let payload = [];
    for (let i = 0; i &lt; 5; i++) {
        payload.push({ id: i, message: `Payload Message: ${i}\n`});
    }
    const response = await fetch("/read", {
        method: "POST", body: JSON.stringify(payload),
        headers: {
            "Content-Type": "application/json"
        }
    })
    document.getElementById("msg").textContent = response.statusText;
    document.getElementById("body").textContent = await response.text();
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.882.1">This is the </span><a id="_idIndexMarker340" class="calibre3"/><span class="kobospan" id="kobo.883.1">same JavaScript code used in earlier examples but put into a separate file, which is the typical way of distributing JavaScript to clients. </span><em class="italic"><span class="kobospan" id="kobo.884.1">Listing 6.21</span></em><span class="kobospan" id="kobo.885.1"> updates the HTML file to link to the new JavaScript file, and it also includes the image file that was added to the project at the start of the chapter.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.886.1">Listing 6.21: Changing Content in the index.html File in the static Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.887.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
       </span><strong class="screentext"><span class="kobospan" id="kobo.888.1"> &lt;script src="client.js"&gt;&lt;/script&gt;</span></strong><span class="kobospan" id="kobo.889.1">
    &lt;/head&gt;
    &lt;body&gt;
       </span><strong class="screentext"><span class="kobospan" id="kobo.890.1">&lt;img src="city.png"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.891.1">           style="width: 100%; display: block; margin-bottom: 2px;"&gt;</span></strong><span class="kobospan" id="kobo.892.1">
       &lt;button id="btn"&gt;Send Request&lt;/button&gt;
       &lt;div id="msg"&gt;&lt;/div&gt;
       &lt;div id="body"&gt;&lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.893.1">Having prepared the content, the next step is to configure Express to serve the files. </span><span class="kobospan" id="kobo.893.2">Express comes with support for middleware components, which just means request handlers that can inspect and intercept all the HTTP requests the server receives. </span><span class="kobospan" id="kobo.893.3">Middleware components are set up with the </span><code class="inlinecode"><span class="kobospan" id="kobo.894.1">use</span></code><span class="kobospan" id="kobo.895.1"> method, and </span><em class="italic"><span class="kobospan" id="kobo.896.1">Listing 6.22</span></em><span class="kobospan" id="kobo.897.1"> sets up the middleware component that Express provides to serve files.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.898.1">Listing 6.22: Adding Support for Static Files in the server.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.899.1">import { createServer } from "http";
import express, {Express } from "express";
</span><strong class="screentext"><span class="kobospan" id="kobo.900.1">//import { basicHandler } from "./handler";</span></strong><span class="kobospan" id="kobo.901.1">
import { readHandler } from "./readHandler";
const port = 5000;
const expressApp: Express = express();
</span><strong class="screentext"><span class="kobospan" id="kobo.902.1">// expressApp.get("/favicon.ico", (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.903.1">//     resp.statusCode = 404;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.904.1">//     resp.end();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.905.1">// });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.906.1">//expressApp.get("*", basicHandler);</span></strong><span class="kobospan" id="kobo.907.1">
expressApp.post("/read", readHandler);
</span><strong class="screentext"><span class="kobospan" id="kobo.908.1">expressApp.use(express.static("static"));</span></strong><span class="kobospan" id="kobo.909.1">
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.910.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.911.1">express</span></code><span class="kobospan" id="kobo.912.1"> object, </span><a id="_idIndexMarker341" class="calibre3"/><span class="kobospan" id="kobo.913.1">which is the default export from the </span><code class="inlinecode"><span class="kobospan" id="kobo.914.1">express</span></code><span class="kobospan" id="kobo.915.1"> module, defines a method named </span><code class="inlinecode"><span class="kobospan" id="kobo.916.1">static</span></code><span class="kobospan" id="kobo.917.1"> that creates the middleware component that serves static files. </span><span class="kobospan" id="kobo.917.2">The argument to the </span><code class="inlinecode"><span class="kobospan" id="kobo.918.1">static</span></code><span class="kobospan" id="kobo.919.1"> method is the directory that contains the files, which is also named </span><code class="inlinecode"><span class="kobospan" id="kobo.920.1">static</span></code><span class="kobospan" id="kobo.921.1">. </span><span class="kobospan" id="kobo.921.2">The result is a request handler that can be registered with the </span><code class="inlinecode"><span class="kobospan" id="kobo.922.1">Express.use</span></code><span class="kobospan" id="kobo.923.1"> method.</span></p>
<p class="normal"><span class="kobospan" id="kobo.924.1">The middleware component will attempt to match request URLs to files in the </span><code class="inlinecode"><span class="kobospan" id="kobo.925.1">static</span></code><span class="kobospan" id="kobo.926.1"> directory. </span><span class="kobospan" id="kobo.926.2">The name of the directory that contains the files is omitted from the URLs, so a request for </span><code class="inlinecode"><span class="kobospan" id="kobo.927.1">http://localhost:5000/client.js</span></code><span class="kobospan" id="kobo.928.1">, for example, will be handled by returning the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.929.1">client.js</span></code><span class="kobospan" id="kobo.930.1"> file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.931.1">static</span></code><span class="kobospan" id="kobo.932.1"> folder.</span></p>
<p class="normal"><span class="kobospan" id="kobo.933.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.934.1">static</span></code><span class="kobospan" id="kobo.935.1"> method can accept a configuration object, but the default values are well-chosen and suit most projects, including using the </span><code class="inlinecode"><span class="kobospan" id="kobo.936.1">index.html</span></code><span class="kobospan" id="kobo.937.1"> as the default for requests.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.938.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.939.1">If you need to change the settings, you can see the options at </span><a href="https://expressjs.com/en/4x/api.html#express.static" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.940.1">https://expressjs.com/en/4x/api.html#express.static</span></span></a><span class="kobospan" id="kobo.941.1">.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.942.1">The </span><a id="_idIndexMarker342" class="calibre3"/><span class="kobospan" id="kobo.943.1">middleware component sets the response headers to help the client process the contents of the files that are used. </span><span class="kobospan" id="kobo.943.2">This includes setting the </span><code class="inlinecode"><span class="kobospan" id="kobo.944.1">Content-Length</span></code><span class="kobospan" id="kobo.945.1"> header to specify the amount of data the file contains, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.946.1">Content-Type</span></code><span class="kobospan" id="kobo.947.1"> header to specify the type of data.</span></p>
<p class="normal"><span class="kobospan" id="kobo.948.1">Notice that I can remove some of the existing handlers from the example. </span><span class="kobospan" id="kobo.948.2">The handler for </span><code class="inlinecode"><span class="kobospan" id="kobo.949.1">favicon.ico</span></code><span class="kobospan" id="kobo.950.1"> requests is no longer required because the new middleware will automatically generate “not found” responses when requests ask for files that don’t exist. </span><span class="kobospan" id="kobo.950.2">The catch-all route is no longer required because the </span><code class="inlinecode"><span class="kobospan" id="kobo.951.1">static</span></code><span class="kobospan" id="kobo.952.1"> middleware responds to requests with the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.953.1">index.html</span></code><span class="kobospan" id="kobo.954.1"> file. </span><span class="kobospan" id="kobo.954.2">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.955.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.956.1">, and you will see the response shown in </span><em class="italic"><span class="kobospan" id="kobo.957.1">Figure 6.9</span></em><span class="kobospan" id="kobo.958.1">, which also shows the data types that the browser has received.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.959.1"><img alt="" src="../Images/B21959_06_09.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.960.1">Figure 6.9: Using the Express static middleware</span></p>
<h3 class="heading2" id="_idParaDest-130"><span class="kobospan" id="kobo.961.1">Serving files from client-side packages</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.962.1">One source</span><a id="_idIndexMarker343" class="calibre3"/><span class="kobospan" id="kobo.963.1"> of static files is packages that are added to the Node.js project, but whose files are intended for consumption by browsers (or other HTTP clients). </span><span class="kobospan" id="kobo.963.2">A good example is the Bootstrap CSS package, which contains CSS stylesheets and JavaScript files that are used to style the HTML content displayed by browsers.</span></p>
<p class="normal"><span class="kobospan" id="kobo.964.1">If you are using a client-side framework such as Angular or React, these CSS and JavaScript files will be incorporated into a single compressed file as part of the project build process. </span></p>
<p class="normal"><span class="kobospan" id="kobo.965.1">For projects that don’t use these frameworks, the simplest way to make the files available is to set up additional instances of the static file middleware. </span><span class="kobospan" id="kobo.965.2">To prepare, run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.966.1">Listing 6.23</span></em><span class="kobospan" id="kobo.967.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.968.1">webapp</span></code><span class="kobospan" id="kobo.969.1"> folder to add the Bootstrap package to the example project. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.970.1">Listing 6.23: Adding a Package to the Example Project</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.971.1">npm install bootstrap@5.3.2
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.972.1">Listing 6.24</span></em><span class="kobospan" id="kobo.973.1"> configures Express to serve files from the package directory.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.974.1">Listing 6.24. </span><span class="kobospan" id="kobo.974.2">Adding Middleware in the server.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.975.1">import { createServer } from "http";
import express, {Express } from "express";
import { readHandler } from "./readHandler";
const port = 5000;
const expressApp: Express = express();
expressApp.post("/read", readHandler);
expressApp.use(express.static("static"));
</span><strong class="screentext"><span class="kobospan" id="kobo.976.1">expressApp.use(express.static("node_modules/bootstrap/dist"));</span></strong><span class="kobospan" id="kobo.977.1">
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.978.1">Some</span><a id="_idIndexMarker344" class="calibre3"/><span class="kobospan" id="kobo.979.1"> knowledge of the packages you are using is required. </span><span class="kobospan" id="kobo.979.2">In the case of the Bootstrap package, I know that the files used by clients are in the </span><code class="inlinecode"><span class="kobospan" id="kobo.980.1">dist</span></code><span class="kobospan" id="kobo.981.1"> folder, and so this is the folder that I specified when setting up the middleware clients. </span><span class="kobospan" id="kobo.981.2">The final step is to add a reference to a Bootstrap stylesheet and apply the styles it contains, as shown in </span><em class="italic"><span class="kobospan" id="kobo.982.1">Listing 6.25</span></em><span class="kobospan" id="kobo.983.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.984.1">Listing 6.25. </span><span class="kobospan" id="kobo.984.2">Adding a Stylesheet Reference in the index.html File in the static Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.985.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;script src="client.js"&gt;&lt;/script&gt;
       </span><strong class="screentext"><span class="kobospan" id="kobo.986.1"> &lt;</span></strong><strong class="screentext"><span class="kobospan" id="kobo.987.1">link href="css/bootstrap.min.css" rel="stylesheet" /&gt;</span></strong><span class="kobospan" id="kobo.988.1">
    &lt;/head&gt;
    &lt;body&gt;
       &lt;img src="city.png"
           style="width: 100%; display: block; margin-bottom: 2px;"&gt;
       </span><strong class="screentext"><span class="kobospan" id="kobo.989.1">&lt;button id="btn" class="</span></strong><strong class="screentext"><span class="kobospan" id="kobo.990.1">btn btn-primary my-2"&gt;Send Request&lt;/button&gt;</span></strong><span class="kobospan" id="kobo.991.1">
       &lt;div id="msg"&gt;&lt;/div&gt;
       &lt;div id="body"&gt;&lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.992.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.993.1">bootstrap.min.css</span></code><span class="kobospan" id="kobo.994.1"> file contains the styles I want to use, which are applied by adding the </span><code class="inlinecode"><span class="kobospan" id="kobo.995.1">button</span></code><span class="kobospan" id="kobo.996.1"> element to classes. </span><span class="kobospan" id="kobo.996.2">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.997.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.998.1">, and you will see the effect of the styles, as shown in </span><em class="italic"><span class="kobospan" id="kobo.999.1">Figure 6.10</span></em><span class="kobospan" id="kobo.1000.1">.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.1001.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.1002.1">See </span><a href="https://getbootstrap.com" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.1003.1">https://getbootstrap.com</span></span></a><span class="kobospan" id="kobo.1004.1"> for details of the features the Bootstrap package provides, some of which I use in later chapters. </span><span class="kobospan" id="kobo.1004.2">There are other CSS packages available if you can’t get along with Bootstrap. </span><span class="kobospan" id="kobo.1004.3">A popular alternative is Tailwind (</span><a href="https://tailwindcss.com" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.1005.1">https://tailwindcss.com</span></span></a><span class="kobospan" id="kobo.1006.1">), but a quick web search will present you with a long list of alternatives to consider.</span></p>
</div>
<figure class="mediaobject"><span class="kobospan" id="kobo.1007.1"><img alt="" src="../Images/B21959_06_10.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.1008.1">Figure 6.10: Using static content from a third-party package</span></p>
<h3 class="heading2" id="_idParaDest-131"><span class="kobospan" id="kobo.1009.1">Sending and downloading files</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.1010.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1011.1">Response</span></code><span class="kobospan" id="kobo.1012.1"> class, through </span><a id="_idIndexMarker345" class="calibre3"/><span class="kobospan" id="kobo.1013.1">which Express</span><a id="_idIndexMarker346" class="calibre3"/><span class="kobospan" id="kobo.1014.1"> provides </span><code class="inlinecode"><span class="kobospan" id="kobo.1015.1">ServerResponse</span></code><span class="kobospan" id="kobo.1016.1"> enhancements, defines the methods described in </span><em class="italic"><span class="kobospan" id="kobo.1017.1">Table 6.9</span></em><span class="kobospan" id="kobo.1018.1"> to deal with files directly. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1019.1">Table 6.9: Useful Response Methods for Files </span></p>
<table class="table-container" id="table009-1">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1020.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1021.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.1022.1">sendFile(path, config)</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.1023.1">This method sends the contents of the specified file. </span><span class="kobospan" id="kobo.1023.2">The response </span><code class="inlinecode"><span class="kobospan2" id="kobo.1024.1">Content-Type</span></code><span class="kobospan4" id="kobo.1025.1"> header is set based on the file extension.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.1026.1">download(path)</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1027.1">This method sends the contents of the specified file such that most browsers will prompt the user to save the file. </span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.1028.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1029.1">sendFile</span></code><span class="kobospan" id="kobo.1030.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1031.1">download</span></code><span class="kobospan" id="kobo.1032.1"> methods are useful because they provide solutions to problems that cannot be solved using the </span><code class="inlinecode"><span class="kobospan" id="kobo.1033.1">static</span></code><span class="kobospan" id="kobo.1034.1"> middleware. </span><em class="italic"><span class="kobospan" id="kobo.1035.1">Listing 6.26</span></em><span class="kobospan" id="kobo.1036.1"> creates simple routes that use these methods.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1037.1">Listing 6.26: Adding Routes in the server.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1038.1">import { createServer } from "http";
</span><strong class="screentext"><span class="kobospan" id="kobo.1039.1">import</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1040.1"> express, {Express, Request, Response } from "express";</span></strong><span class="kobospan" id="kobo.1041.1">
import { readHandler } from "./readHandler";
const port = 5000;
const expressApp: Express = express();
expressApp.post("/read", readHandler);
</span><strong class="screentext"><span class="kobospan" id="kobo.1042.1">expressApp.get("/sendcity", (req, resp</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1043.1">) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1044.1">    resp.sendFile("city.png", { root: "static"});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1045.1">});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1046.1">expressApp.get("/downloadcity", (req: Request, resp: Response) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1047.1">    resp.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1048.1">download("static/city.png");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1049.1">});</span></strong><span class="kobospan" id="kobo.1050.1">
expressApp.get("/json", (req: Request, resp: Response) =&gt; {
    resp.json("{name: Bob}");
});
   
expressApp.use(express.static("static"));
expressApp.use(express.static("node_modules/bootstrap/dist"));
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1051.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1052.1">sendFile</span></code><span class="kobospan" id="kobo.1053.1"> method</span><a id="_idIndexMarker347" class="calibre3"/><span class="kobospan" id="kobo.1054.1"> is useful when you need to </span><a id="_idIndexMarker348" class="calibre3"/><span class="kobospan" id="kobo.1055.1">respond with the content of a file but the request path doesn’t contain the filename. </span><span class="kobospan" id="kobo.1055.2">The arguments are the name of the file and a configuration object, whose root property specifies the directory that contains the file. </span></p>
<p class="normal"><span class="kobospan" id="kobo.1056.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1057.1">download</span></code><span class="kobospan" id="kobo.1058.1"> method sets the </span><code class="inlinecode"><span class="kobospan" id="kobo.1059.1">Content-Disposition</span></code><span class="kobospan" id="kobo.1060.1"> response header, which causes most </span><a id="_idIndexMarker349" class="calibre3"/><span class="kobospan" id="kobo.1061.1">browsers to treat the file contents as a </span><a id="_idIndexMarker350" class="calibre3"/><span class="kobospan" id="kobo.1062.1">download that should be saved. </span><span class="kobospan" id="kobo.1062.2">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.1063.1">http://localhost:5000/sendcity</span></code><span class="kobospan" id="kobo.1064.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1065.1">http://localhost:5000/downloadcity</span></code><span class="kobospan" id="kobo.1066.1">. </span><span class="kobospan" id="kobo.1066.2">The first URL will cause the browser to display the image in the browser window. </span><span class="kobospan" id="kobo.1066.3">The second URL will prompt the user to save the file. </span><span class="kobospan" id="kobo.1066.4">Both responses are shown in </span><em class="italic"><span class="kobospan" id="kobo.1067.1">Figure 6.11</span></em><span class="kobospan" id="kobo.1068.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.1069.1"><img alt="" src="../Images/B21959_06_11.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.1070.1">Figure 6.11: Using the file response enhancements</span></p>
<h2 class="heading1" id="_idParaDest-132"><span class="kobospan" id="kobo.1071.1">Automatically decoding and encoding JSON</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.1072.1">The Express package</span><a id="_idIndexMarker351" class="calibre3"/><span class="kobospan" id="kobo.1073.1"> includes a middleware component that decodes JSON response bodies automatically, performing the same task as the stream </span><a id="_idIndexMarker352" class="calibre3"/><span class="kobospan" id="kobo.1074.1">transformer I created earlier in the chapter. </span><em class="italic"><span class="kobospan" id="kobo.1075.1">Listing 6.27</span></em><span class="kobospan" id="kobo.1076.1"> enables this middleware by calling the </span><code class="inlinecode"><span class="kobospan" id="kobo.1077.1">json</span></code><span class="kobospan" id="kobo.1078.1"> method defined on the default export from the </span><code class="inlinecode"><span class="kobospan" id="kobo.1079.1">express</span></code><span class="kobospan" id="kobo.1080.1"> module. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1081.1">Listing 6.27: Enabling JSON Middleware in the server.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1082.1">import { createServer } from "http";
import express, {Express, Request, Response } from "express";
import { readHandler } from "./readHandler";
const port = 5000;
const expressApp: Express = express();
</span><strong class="screentext"><span class="kobospan" id="kobo.1083.1">expressApp.use(express.json());</span></strong><span class="kobospan" id="kobo.1084.1">
expressApp.post("/read", readHandler);
expressApp.get("/sendcity", (req, resp) =&gt; {
    resp.sendFile("city.png", { root: "static"});
});
expressApp.get("/downloadcity", (req: Request, resp: Response) =&gt; {
    resp.download("static/city.png");
});
expressApp.get("/json", (req: Request, resp: Response) =&gt; {
    resp.json("{name: Bob}");
});
   
expressApp.use(express.static("static"));
expressApp.use(express.static("node_modules/bootstrap/dist"));
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1085.1">The </span><a id="_idIndexMarker353" class="calibre3"/><span class="kobospan" id="kobo.1086.1">middleware component must be registered </span><a id="_idIndexMarker354" class="calibre3"/><span class="kobospan" id="kobo.1087.1">before the routes that read response bodies so that JSON requests are parsed before they are matched to a handler.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.1088.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.1089.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1090.1">json</span></code><span class="kobospan" id="kobo.1091.1"> method can accept a configuration object that changes the way that JSON is parsed. </span><span class="kobospan" id="kobo.1091.2">The defaults are suitable for most projects, but see </span><a href="https://expressjs.com/en/4x/api.html#express.json" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.1092.1">https://expressjs.com/en/4x/api.html#express.json</span></span></a><span class="kobospan" id="kobo.1093.1"> for details of the available options.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.1094.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1095.1">Request</span></code><span class="kobospan" id="kobo.1096.1"> class through which Express provides enhancements to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1097.1">IncomingRequest</span></code><span class="kobospan" id="kobo.1098.1"> class defines a </span><code class="inlinecode"><span class="kobospan" id="kobo.1099.1">body</span></code><span class="kobospan" id="kobo.1100.1"> property, which is assigned the object created by the JSON middleware.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1101.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1102.1">Response</span></code><span class="kobospan" id="kobo.1103.1"> body, which provides </span><code class="inlinecode"><span class="kobospan" id="kobo.1104.1">ServerResponse</span></code><span class="kobospan" id="kobo.1105.1"> enhancements, defines the </span><code class="inlinecode"><span class="kobospan" id="kobo.1106.1">json</span></code><span class="kobospan" id="kobo.1107.1"> method, which </span><a id="_idIndexMarker355" class="calibre3"/><span class="kobospan" id="kobo.1108.1">accepts an object that is serialized to JSON</span><a id="_idIndexMarker356" class="calibre3"/><span class="kobospan" id="kobo.1109.1"> and used as the response body.</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.1110.1">Listing 6.28</span></em><span class="kobospan" id="kobo.1111.1"> updates the handler to use the </span><code class="inlinecode"><span class="kobospan" id="kobo.1112.1">Request</span></code><span class="kobospan" id="kobo.1113.1"> class, disables the custom transformer, and sends a JSON response to the client.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1114.1">Listing 6.28: Using the JSON Object in the readHandler.ts File in the src Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1115.1">import { IncomingMessage, ServerResponse } from "http";
</span><strong class="screentext"><span class="kobospan" id="kobo.1116.1">//import { Transform } from "stream";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1117.1">import { Request, Response } from "express";</span></strong><span class="kobospan" id="kobo.1118.1">
export const readHandler = async (req: Request, resp: Response) =&gt; {   
    </span><strong class="screentext"><span class="kobospan" id="kobo.1119.1">if (req.headers["content-type"] == "application/json") {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1120.1">        const payload = req.body;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1121.1">        if (payload instanceof Array) {</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.1122.1">//resp.write(`Received an array with ${payload.length} items`)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1123.1">            resp.json({arraySize: payload.length});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1124.1">        }  else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1125.1">            resp.write("Did not receive an array");</span></strong><span class="kobospan" id="kobo.1126.1">
        }
        resp.end();
    } else {
        req.pipe(resp);
    }
}
</span><strong class="screentext"><span class="kobospan" id="kobo.1127.1">// const createFromJsonTransform = () =&gt; new Transform({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1128.1">//     readableObjectMode: true,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1129.1">//     transform(data, encoding, callback) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1130.1">//         callback(null, JSON.parse(data));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1131.1">//     }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1132.1">// });</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.1133.1">Use a </span><a id="_idIndexMarker357" class="calibre3"/><span class="kobospan" id="kobo.1134.1">web browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.1135.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.1136.1">, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.1137.1">Send Request</span></strong><span class="kobospan" id="kobo.1138.1"> button. </span><span class="kobospan" id="kobo.1138.2">The response will confirm that the JSON </span><a id="_idIndexMarker358" class="calibre3"/><span class="kobospan" id="kobo.1139.1">request body was parsed into a JavaScript array and the response was sent back as JSON as well, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1140.1">Figure 6.12</span></em><span class="kobospan" id="kobo.1141.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.1142.1"><img alt="" src="../Images/B21959_06_12.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.1143.1">Figure 6.12: Using the Express JSON middleware</span></p>
<h1 class="heading" id="_idParaDest-133"><span class="kobospan" id="kobo.1144.1">Summary</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.1145.1">In this chapter, I described the API features that Node.js provides to read and write data, particularly when processing an HTTP request:</span></p>
<ul class="calibre4">
<li class="bulletlist"><span class="kobospan" id="kobo.1146.1">Streams are used as abstract representations of sources and destinations for data, including HTTP requests and responses.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1147.1">Data is buffered when it is written to a stream, but it is a good idea to avoid excessive buffering because it can exhaust system resources.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1148.1">Data can be read from a stream by handling events or using a </span><code class="inlinecode"><span class="kobospan" id="kobo.1149.1">for</span></code><span class="kobospan" id="kobo.1150.1"> loop.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1151.1">Data can be piped from a readable stream to a writable stream.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1152.1">Data can be transformed as it is piped and can be between JavaScript objects and strings/byte arrays.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1153.1">Node.js provides an API to work with files, but third-party packages are the safest way to work with files in a web server project.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1154.1">Third-party packages, such as Express, provide enhancements to the Node.js streams to perform common tasks, such as decoding JSON data.</span></li>
</ul>
<p class="normal"><span class="kobospan" id="kobo.1155.1">In the next chapter, I describe two aspects of web development in which Node.js works together with other components to deliver an application.</span></p>
</div>
</body></html>