<html><head></head><body>
  <div><div><div><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Creating Heatmaps and Choropleth Maps</h1></div></div></div><p>In the first two chapters, you learned how to make a map and add points, lines, polygons, and even GeoJSON. Now, you will use these skills to create two types of thematic maps: heatmaps and choropleth maps. These maps show you concentrations of points or statistical variables using two different styles of representations.</p><p>In this chapter, we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">What is a heatmap?</li><li class="listitem" style="list-style-type: disc">How do I create a heatmap?</li><li class="listitem" style="list-style-type: disc">What is a choropleth map?</li><li class="listitem" style="list-style-type: disc">How do I create a choropleth map?</li></ul></div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec24"/>What is a heatmap?</h1></div></div></div><p>A heatmap is a color-coded grid added to a map. The colors usually range from cool colors, such as blue, to hot<a id="id164" class="indexterm"/> colors, such as yellow, orange, and red. Heatmaps represent point data in one of two ways: density or intensity. In<a id="id165" class="indexterm"/> a density map, the grid is colored red when multiple points are in close proximity of each other and blue when dispersed. High concentrations of points create the heat. In an intensity map, points<a id="id166" class="indexterm"/> are assigned a value or an intensity score. The higher the score or intensity, the hotter the color in the grid at the location of the point; inversely, the lower the score, the cooler the grid color at the point location.</p><div><div><h3 class="title"><a id="note15"/>Note</h3><p>Heatmaps are created<a id="id167" class="indexterm"/> by placing a grid over the map and calculating the points within an area through a process called Multivariate Kernel Density Estimation. For a detailed explanation and the exact formulas used, you can visit <a class="ulink" href="http://en.wikipedia.org/wiki/Multivariate_kernel_density_estimation">http://en.wikipedia.org/wiki/Multivariate_kernel_density_estimation</a>.</p></div></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec25"/>Heatmaps with Leaflet.heat</h1></div></div></div><p>The first heatmap you will make will be a density heatmap, using<a id="id168" class="indexterm"/> the <code class="literal">Leaflet.heat</code> plugin. You can download the<a id="id169" class="indexterm"/> JavaScript plugin at <a class="ulink" href="https://github.com/Leaflet/Leaflet.heat">https://github.com/Leaflet/Leaflet.heat</a>. The following steps will walk you through creating your first heatmap:</p><div><ol class="orderedlist arabic"><li class="listitem">Using <code class="literal">LeafletEssentials.html</code>, add a<a id="id170" class="indexterm"/> reference to <code class="literal">Leaflet.heat.js</code> with either a URL to a remote copy or the path to your local copy, as shown in the following code:<div><pre class="programlisting">&lt;script src="img/Leaflet-heat.js"&gt;&lt;/script&gt; or,
&lt;script src="img/Leaflet-heat.js"&gt;&lt;/script&gt;</pre></div></li><li class="listitem">Add an array of points. Your points can contain additional information but must have the latitude and longitude as the first two elements. The following code shows you three points from the code. The full code contains many more, which will allow you to create the heatmap:<div><pre class="programlisting">var points = [
[35.1555 , -106.591838 , "&lt;img src='http://farm8.staticflickr.com/7153/6831137393_fa38634fd7_m.jpg'&gt;"],
[35.0931 , -106.664177 , "&lt;img src='http://farm3.staticflickr.com/2167/2479129916_0d861b2600.jpg'&gt;"],
[35.1143 , -106.577991 , "&lt;img src='http://farm2.staticflickr.com/1416/908720823_e390a242f4.jpg'&gt;"]];</pre></div></li><li class="listitem">Lastly, create the heat layer and add it to the map:<div><pre class="programlisting">var heat = L.heatLayer(points).addTo(map);</pre></div></li></ol></div><p>Your map should look like what is shown in the following screenshot:</p><div><img src="img/4812OS_03_01.jpg" alt="Heatmaps with Leaflet.heat"/></div><p>The preceding<a id="id171" class="indexterm"/> screenshot is the default heatmap; it's<a id="id172" class="indexterm"/> not very stylish.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec28"/>Using options to style your map</h2></div></div></div><p>
<code class="literal">Leaflet.heat</code> allows you to pass options to<a id="id173" class="indexterm"/> the constructor. The <a id="id174" class="indexterm"/>options are as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">MaxZoom</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Max</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Radius</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Blur</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Gradient</code></li></ul></div><p>The most important options are <code class="literal">blur</code>, <code class="literal">maxZoom</code>, and <code class="literal">radius</code>.</p><div><div><div><div><h3 class="title"><a id="ch03lvl3sec07"/>Changing the blur value</h3></div></div></div><p>Blur merges<a id="id175" class="indexterm"/> the points<a id="id176" class="indexterm"/> the together, or not. A low blur value will create individual points, whereas a higher number will make the points merge with each other and look more fluid. Blur too much and you will wash out your points. The following screenshots show you different blur values.</p><p>The following <a id="id177" class="indexterm"/>screenshot shows you the blur value set to <code class="literal">1</code>:</p><div><img src="img/4812OS_03_03.jpg" alt="Changing the blur value"/></div><p>The following <a id="id178" class="indexterm"/>screenshot shows you the blur value set to <code class="literal">40</code>:</p><div><img src="img/4812OS_03_04.jpg" alt="Changing the blur value"/></div><p>The<a id="id179" class="indexterm"/> following<a id="id180" class="indexterm"/> screenshot shows you the blur value set to <code class="literal">80</code>:</p><div><img src="img/4812OS_03_05.jpg" alt="Changing the blur value"/></div><p>Notice how at <code class="literal">80</code>, the blur takes away any hotspots on the map; it is washed out. It will take some to adjust<a id="id181" class="indexterm"/> to finding the perfect value. Starting<a id="id182" class="indexterm"/> with the default value of <code class="literal">15</code> is a good idea.</p></div><div><div><div><div><h3 class="title"><a id="ch03lvl3sec08"/>Changing the maxZoom value</h3></div></div></div><p>The <code class="literal">maxZoom</code> option sets the points<a id="id183" class="indexterm"/> to their maximum intensity at the specified zoom. If you set the <code class="literal">maxZoom</code> option of the map, you can ignore this<a id="id184" class="indexterm"/> setting. You should set this to the zoom level where the map looks best. If you set it to too far out, the points will lose their heat as you zoom in, and if you make it too tight of a zoom, the user might not be able to see all the points on the map at once.</p></div><div><div><div><div><h3 class="title"><a id="ch03lvl3sec09"/>Changing the radius value</h3></div></div></div><p>This option should be obvious. It adjusts the radius of the points. A small number makes a small point and a large number <a id="id185" class="indexterm"/>makes a large point. The amount<a id="id186" class="indexterm"/> of data points can affect the proper radius of your points. The more points you have, the smaller you could make each point and still have a readable map. Making the radius too large will create a large blob of values that will be hard to interpret.</p></div><div><div><div><div><h3 class="title"><a id="ch03lvl3sec10"/>Setting the gradient option</h3></div></div></div><p>The <code class="literal">gradient</code> option<a id="id187" class="indexterm"/> allows you to specify the color at different levels. The default is set to <code class="literal">{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"}</code>. You can specify ranges from <code class="literal">0</code> to <code class="literal">1</code>. The outerm<a id="id188" class="indexterm"/>ost color is <code class="literal">0</code> and the center is <code class="literal">1</code>. The default setting tends to be a common color range for heatmaps that most people understand. Leaving the default is the best option, but if you need to change the colors for some reason, you can.</p><div><div><h3 class="title"><a id="note16"/>Note</h3><p>To create a color combination that is visually pleasing, you can use a tool such as Color Brewer 2. This<a id="id189" class="indexterm"/> is available at <a class="ulink" href="http://colorbrewer2.org/">http://colorbrewer2.org/</a>.</p></div></div></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec29"/>Methods of Leaflet.heat</h2></div></div></div><p>Along with the<a id="id190" class="indexterm"/> options to style your heatmap, <code class="literal">Leaflet.heat</code> has four methods as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">setOptions(options)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">addLatLng(latlng)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">setLatLngs(latlngs)</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">redraw()</code></li></ul></div><p>You can reset the style, add new data, load in all new data, and redraw the map. The method you will use most is the <a id="id191" class="indexterm"/>
<code class="literal">addLatLng()</code> method. This method<a id="id192" class="indexterm"/> allows you to append data to <a id="id193" class="indexterm"/>your map. In the previous example, you can add the following code as the last line:</p><div><pre class="programlisting">heat.addLatLng([35,-106]);</pre></div><p>The preceding code uses the <code class="literal">addLatLng()</code> method to add the point (<code class="literal">35,-106</code>) to the map. There is an excellent example of using an event with <code class="literal">addLatLng()</code> at <a class="ulink" href="http://Leaflet.github.io/Leaflet.heat/demo/draw.html">http://Leaflet.github.io/Leaflet.heat/demo/draw.html</a>. As you move the mouse, points are added<a id="id194" class="indexterm"/> to the <a id="id195" class="indexterm"/>map in real time.</p><div><div><h3 class="title"><a id="tip08"/>Tip</h3><p>The <code class="literal">redraw()</code> method is called<a id="id196" class="indexterm"/> by <code class="literal">setOptions()</code>, <code class="literal">addLatLng()</code>, and <code class="literal">setLatLngs()</code> so that you do not need to call it after executing any<a id="id197" class="indexterm"/> of these<a id="id198" class="indexterm"/> methods.</p></div></div><p>If you want to show multiple datasets on a single map, you can write a custom function to add another set. The following code adds a dataset. You will need to populate the <code class="literal">newPoints</code> variable with your other dataset:</p><div><pre class="programlisting">function add(){
heat.setLatLngs(newPoints);
}
heat.setLatLngs(newPoints);</pre></div><p>In the preceding code, a dataset named <code class="literal">newPoints</code> is added to the map and the old dataset points are removed. In your HTML, create a button to execute the function:</p><div><pre class="programlisting">&lt;button onclick="addNewPoints()"&gt;Addonclick="add ()"&gt;Add New Points&lt;/button&gt;</pre></div><p>The preceding code is the HTML that calls the <code class="literal">addNewPoints()</code>function when it is clicked on.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec30"/>Adding markers to the heatmap</h2></div></div></div><p>You need a series of <a id="id199" class="indexterm"/>points to create the heatmap, so why not use them to attach a pop up to the heat layer. In the data, there<a id="id200" class="indexterm"/> was a latitude, longitude, and a third field that contained a URL to an image. The following code shows you how to turn that data into a marker with a pop up:</p><div><pre class="programlisting">for(var i=0;i&lt;points.length;i++)
{
L.marker([parseFloat(points[i][0]),parseFloat(points[i][1])],{opacity:0}).bindPopup(points[i][2],{keepInView:true}).addTo(map);
}</pre></div><p>The preceding code is a standard for a loop that starts with <code class="literal">0</code> and executes until you have iterated through all the points—<code class="literal">points.length</code>. This creates a marker by passing each point's latitude and longitude, <code class="literal">points[i][0]</code> and <code class="literal">points[i][1]</code>, and converts them to a float value. Next, the <code class="literal">opacity</code> option is set to <code class="literal">0</code>. This makes the points invisible. The points are on the map, and they can be clicked on, but you cannot see them. This gives the appearance of the hotspot layer that contains the pop up. Lastly, the <code class="literal">bindPopup()</code> method is passed the URL to the image, <code class="literal">bindPopup(points[i][2])</code>, and is added to the map. The following screenshot shows you the pop up with the invisible markers and heat layer:</p><div><img src="img/4812OS_03_06.jpg" alt="Adding markers to the heatmap"/></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec26"/>Creating heatmaps with heatmap.js</h1></div></div></div><p>Creating a <a id="id201" class="indexterm"/>heatmap that uses intensity can be accomplished in Leaflet using <code class="literal">heatmap.js</code>. You can get <code class="literal">heatmap.js</code> at <a class="ulink" href="http://www.patrick-wied.at/static/heatmapjs/index.html">http://www.patrick-wied.at/static/heatmapjs/index.html</a>. This<a id="id202" class="indexterm"/> includes the plugins for <code class="literal">leaflet.js</code> and other mapping packages. The process to create the heatmap is similar to the previous example. The<a id="id203" class="indexterm"/> following steps will walk you through creating a heatmap:</p><div><ol class="orderedlist arabic"><li class="listitem">Using <code class="literal">LeafletEssentials.html</code>, add a reference to <code class="literal">heatmap.js</code> and <code class="literal">heatmap-Leaflet</code> with either a URL to a remote copy or the path to your local copy, as shown in the following code:<div><pre class="programlisting">&lt;script type="text/javascript" src="img/heatmap.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="img/heatmap-Leaflet"&gt;&lt;/script&gt;</pre></div></li><li class="listitem">Add a JavaScript object with the <code class="literal">max</code> value of the intensity and an array of data:<div><pre class="programlisting">Var myData={max: 46,
data: [{lat: 33.5363, lon:-117.044, value: 1},{lat: 33.5608, lon:-117.24, value: 1}]};</pre></div></li><li class="listitem">Create the heat layer and set the options:<div><pre class="programlisting">Var heatmapLayer = L.TileLayer.heatMap({
radius: 20,
opacity: 0.8,
gradient: {
                        0.45: "rgb(0,0,255)",
                        0.55: "rgb(0,255,255)",
                        0.65: "rgb(0,255,0)",
                        0.95: "rgb(255,255,0)",
                        1.0: "rgb(255,0,0)"
                    }
                });</pre></div></li><li class="listitem">Add the data to the map. Because the data is in an object, you use dot notation, referencing it as <code class="literal">objectname.data</code>; in this case, <code class="literal">myData.data</code>. You could also use <code class="literal">myData['data']</code>:<div><pre class="programlisting">heatmapLayer.addData(myData.data);</pre></div></li><li class="listitem">Lastly, modify your <code class="literal">map</code> object to add the layers:<div><pre class="programlisting">var map = new L.Map('map', {
center: new L.LatLng(35,-106),
zoom: 12,
layers: [baseLayer, heatmapLayer]
                });</pre></div></li></ol></div><div><div><h3 class="title"><a id="note17"/>Note</h3><p>Please note that currently, you might need to reference an older version of Leaflet. This will be updated in a future version of the plugin.</p></div></div><p>Your map <a id="id204" class="indexterm"/>should look like what is shown in the<a id="id205" class="indexterm"/> following screenshot:</p><div><img src="img/4812OS_03_07.jpg" alt="Creating heatmaps with heatmap.js"/></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec31"/>Modifying the heatmap options</h2></div></div></div><p>The heatmap allows you to modify three settings: <code class="literal">radius</code>, <code class="literal">opacity</code>, and <code class="literal">gradient</code>. Like the previous example, <code class="literal">gradient</code> controls the size of each point in the map. The <code class="literal">opacity</code> option <a id="id206" class="indexterm"/>allows you to specify a value between <code class="literal">0</code> and <code class="literal">1</code>. <code class="literal">0</code> is completely transparent and the heatmap layer will not show up on the map. The value <code class="literal">1</code> will make the heatmap layer solid, and you will not be able to see what is underneath each point. Somewhere between <code class="literal">.70</code> and <code class="literal">.80</code> seems to be the perfect opacity to view the heat layer and the base layer underneath. Lastly, the gradient, while best left alone, can be modified by setting a value of <code class="literal">0</code> to <code class="literal">1</code> and assigning a color. Colors in the gradient can be RGB values, or you can use color names: red, yellow, blue, or lime.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec32"/>Adding more data to the map</h2></div></div></div><p>You will eventually<a id="id207" class="indexterm"/> need to add more data to the map after it has been drawn. To do this requires you to append values to the object and then add the object again. First, to add data to the JavaScript object, you can use the following code:</p><div><pre class="programlisting">myData. push({lat:35,lon:-106,value:46});</pre></div><p>The <code class="literal">myData</code> object has a key data that is an array. You reference it by using <code class="literal">myData.data[index]</code>. You might not <a id="id208" class="indexterm"/>know how many items are in the array, so using the length of the array as the index, you will always get the next available index. This works because the length is the number of items, but the index starts at <code class="literal">0</code>. So, for a three-item array, the length is three but the last index is two. Using the length gives<a id="id209" class="indexterm"/> you the next empty index. Then, just assign a value to the index, and it will be appended to the object. Lastly, add the data to the map again:</p><div><pre class="programlisting">heatmapLayer.addData(myData.data);</pre></div><div><div><h3 class="title"><a id="note18"/>Note</h3><p>If you do not use an index, you will overwrite the data with the one item you were trying to add.</p></div></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec27"/>Creating an interactive heatmap</h1></div></div></div><p>A heatmap is an alternative visualization to a point map. A point map often becomes cluttered with large markers<a id="id210" class="indexterm"/> that make it hard to find hotspots. In an intensity heatmap, a single point could be a hotspot. The color coding of values in a heatmap makes it easy to see patterns in the data. Heatmaps can also be used to visualize other spatial data, such as tracking where a mouse moves on a web page or where a person's eyes travel when reading something on the screen. In this example, you will learn how to create a heatmap that responds to user mouse clicks on the map:</p><div><ol class="orderedlist arabic"><li class="listitem">First, include a reference to <code class="literal">Leaflet.heat.js</code>:<div><pre class="programlisting">&lt;script src="img/Leaflet-heat.js"&gt;&lt;/script&gt;</pre></div></li><li class="listitem">Next, disable the <code class="literal">doubleClickZoom</code> option on the map. Since the user will be clicking on the map to make the heatmap, you need to do this so that when the user clicks too fast, which they will, the map does not zoom:<div><pre class="programlisting">var map = L.map("map",{doubleClickZoom:false}).setView([35.10418, -106.62987], 10);</pre></div></li><li class="listitem">Create a blank dataset that can be added to the map. This allows the user to draw on a fresh canvas:<div><pre class="programlisting">var points=[];</pre></div></li><li class="listitem">Add the data to the map:<div><pre class="programlisting">var heat = L.heatLayer(points,{maxZoom:10}).addTo(map);</pre></div></li><li class="listitem">Create a function to handle the user clicks. This function will add points to the layer by catching the latitude and longitude of the mouse click. The <code class="literal">e</code> parameter is an event object that is automatically sent on the map click. The object contains information<a id="id211" class="indexterm"/> about the event and, in this example, you take the latitude and longitude, as shown in the following code:<div><pre class="programlisting">Function addpoint(e){
heat.addLatLng(e.latlng);
}</pre></div></li><li class="listitem">Connect the function to an event, in this case, <code class="literal">click</code>:<div><pre class="programlisting">map.on('click',addpoint);</pre></div></li></ol></div><p>Your map, after clicking several times, should look like what is shown in the following screenshot:</p><div><img src="img/4812OS_03_10.jpg" alt="Creating an interactive heatmap"/></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec28"/>Animating a heatmap</h1></div></div></div><p>So far, you have created<a id="id212" class="indexterm"/> a heatmap that showed you the current density of points and intensities, but what if you wanted to show a heatmap that changed over time? In this last example, you will learn how to create a heatmap animation.</p><p>An animated heatmap is not as complicated as it might sound. Animation is nothing more than adding and removing data from the map, and you have covered these skills earlier in the chapter. The trick to this example is in the organization of your data and taking advantage of timing events in JavaScript. The following steps will walk you through making an<a id="id213" class="indexterm"/> animated heatmap:</p><div><ol class="orderedlist arabic"><li class="listitem">Reference the heatmap plugin:<div><pre class="programlisting">&lt;script src="img/Leaflet-heat.js"&gt;&lt;/script&gt;</pre></div></li><li class="listitem">Next, separate your data into an array per time period. Name your data with the same name, plus a number that increments the number based on the time period. The following code can be used for this purpose:<div><pre class="programlisting">var points1=[[35,-106],[35,-106]];
var points2=[[35.10418, -106.62987],[32,-104]];
var points4=[[33, -104.],[35,-107]];</pre></div></li><li class="listitem">Add a starting dataset to the map:<div><pre class="programlisting">var heat = L.heatLayer(points1,{maxZoom:10}).addTo(map);</pre></div></li><li class="listitem">Next, create a variable that will iterate through the datasets and a string that holds the name of the datasets. Note that the iterator starts at <code class="literal">2</code>. This is because you loaded <code class="literal">points1</code> before the loop:<div><pre class="programlisting">x=2;
var name="";</pre></div></li><li class="listitem">Create an interval and pass a function and the time in milliseconds (1,000 milliseconds are equal to one second):<div><pre class="programlisting">var interval = setInterval(function(){run()},1000);</pre></div></li><li class="listitem">Create the function that will perform the animation. The following code creates a <code class="literal">name</code> string, that is, the data name concatenated with the iteration number. The current layer is removed from the map and the next layer is added. You cannot call a variable using a string as its name, so we use <code class="literal">window[name]</code>. Lastly, the code increments the <code class="literal">x</code> iterator:<div><pre class="programlisting">function run(){
name="points"+x.toString();
map.removeLayer(heat);
heat = L.heatLayer(window[name],{maxZoom:10}).addTo(map);
var x++;
}</pre></div></li></ol></div><p>When you load<a id="id214" class="indexterm"/> the map, you should see the first dataset:</p><div><img src="img/4812OS_03_11.jpg" alt="Animating a heatmap"/></div><p>Then, the data will change <a id="id215" class="indexterm"/>every second. The following screenshot shows you what the map will look like after a few seconds:</p><div><img src="img/4812OS_03_12.jpg" alt="Animating a heatmap"/></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec29"/>Creating a choropleth map with Leaflet</h1></div></div></div><p>In the previous examples, you used heatmaps to color code a map based on the density or intensity of points. A choropleth map <a id="id216" class="indexterm"/>also measures the intensity or density of a statistical variable but within polygons. A popular choropleth map is the<a id="id217" class="indexterm"/> population density by county. Choropleth maps do not require any plugins, as was the case with the heatmap examples. A choropleth map is usually created by styling GeoJSON based on a property.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec33"/>The GeoJSON data</h2></div></div></div><p>When adding a large amount of GeoJSON data to a map, it is easier to place the code in a separate JavaScript file. This<a id="id218" class="indexterm"/> clears your HTML file of hundreds of lines of code, which makes it hard to focus on building the map. When you<a id="id219" class="indexterm"/> place the GeoJSON code in a JavaScript file, you will declare it as a variable, as shown in the following code:</p><div><pre class="programlisting">var ct = {"type": "FeatureCollection", "features": [{"geometry": {"type": "Polygon", "coordinates": [[[-106.501132, 35.093911], [-106.501231, 35.09385], [-106.501481, 35.09376], [-106.50201, 35.09371], [-106.50344, 35.093728], [-106.50424, 35.093709], [-106.50574, 35.093706], [-106.50634, 35.093748], [-106.50748, 35.09368], [-106.508548, 35.0937], [-106.50984, 35.093646], [-106.51071, 35.093618], [-106.51177, 35.093641], [-106.51295, 35.093613], [-106.513934, 35.09361], [-106.51528, 35.093581], [-106.51533, 35.09648], [-106.51534, 35.096889], [-106.515398, 35.09966], [-106.515437, 35.101462], [-106.51419, 35.101452], [-106.51366, 35.10143], [-106.51334, 35.10141], [-106.51308, 35.1014], [-106.51198, 35.101329], [-106.5109, 35.1013], [-106.50975, 35.10123], [-106.50872, 35.10119], [-106.50641, 35.101106], [-106.50643, 35.101358], [-106.50441, 35.101237], [-106.50362, 35.10119], [-106.50289, 35.101146], [-106.50187, 35.101085], [-106.50083, 35.10101], [-106.50058, 35.100989], [-106.50021, 35.10096], [-106.49947, 35.100954], [-106.499153, 35.100933], [-106.49887, 35.100905], [-106.49849, 35.100892], [-106.497853, 35.100895], [-106.49745, 35.10086], [-106.497415, 35.10086], [-106.49766, 35.094788], [-106.49881, 35.09483], [-106.49947, 35.09487], [-106.49977, 35.09498], [-106.50022, 35.095099], [-106.5007, 35.094291], [-106.50093, 35.094034], [-106.501132, 35.093911]]]}, "type": "Feature", "properties": {"NAME10": "1.26", "AWATER10": 0.0, "TRACTCE10": "000126", "ALAND10": 1315885.0, "INTPTLAT10": "+35.0975423", "FUNCSTAT10": "S", "observed": "", "NAMELSAD10": "Census Tract 1.26", "COUNTYFP10": "001", "STATEFP10": "35", "MTFCC10": "G5020", "GEOID10": "35001000126", "id": 6059554, "INTPTLON10": "-106.5067917"}}]};</pre></div><p>The preceding code is for a single feature. The complete file contains 153 features. This would add over fifty 8.5" x 11" pages to your HTML file. Notice that the file is not GeoJSON but JavaScript. It is a variable<a id="id220" class="indexterm"/> declaration. When you reference this file in your HTML, you can call<a id="id221" class="indexterm"/> the <code class="literal">ct</code> variable in your script. Once you have your data as a variable in a JavaScript file, link to it in <code class="literal">LeafletEssentials.html</code>:</p><div><pre class="programlisting">&lt;script src="img/censustracts.js"&gt;&lt;/script&gt;</pre></div><p>The preceding code shows how you have referenced any included JavaScript file.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec34"/>Setting the color with a function</h2></div></div></div><p>The next step in<a id="id222" class="indexterm"/> making a choropleth map is to give<a id="id223" class="indexterm"/> each feature a color based on the statistical variable you are mapping. Define a function to handle the ranges of values, as shown in the following code:</p><div><pre class="programlisting">function color(x) {
return x &gt; 200000 ? '#990000' :
x&gt; 100000  ? '#d7301f' :
x&gt; 30000  ? '#ef6548' :
x&gt; 20000  ? '#fc8d59' :
x&gt; 10000   ? '#fdbb84' :
x&gt; 5000   ? '#fdd49e' :
x&gt; 0   ? '#fee8c8' :'#fff7ec';
              }</pre></div><p>The preceding code takes a parameter and measures a value, returning the color. Darker colors are returned for higher values. It is always best to stick to a standard coloring progression. Using<a id="id224" class="indexterm"/> a single hue progression—a single color from light to dark—should serve you well. Using a tool such as Color Brewer will <a id="id225" class="indexterm"/>help ensure that you use a <a id="id226" class="indexterm"/>good color scheme. You can find it at <a class="ulink" href="http://colorbrewer2.org/">http://colorbrewer2.org/</a>. This will provide you with color values in RGB, CMYK, and HEX.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec35"/>Styling the GeoJSON data</h2></div></div></div><p>Next, you need to create<a id="id227" class="indexterm"/> a function to style the GeoJSON data. Using a function allows you to style each individual feature<a id="id228" class="indexterm"/> based on a property. The following code will style the features:</p><div><pre class="programlisting">Function myStyle(feature) {
return {
fillColor: color(feature.properties.AWATER10),
weight: 1,
opacity: 1,
      color: 'white',
      fillOpacity: 0.85
   	 };
}</pre></div><p>The function takes the feature as a parameter and styles it using a few options. The important option is the <a id="id229" class="indexterm"/>
<code class="literal">fillColor</code> option. This is where you call the <code class="literal">color()</code>function and pass the value of <code class="literal">AWATER10</code> for each feature. Lastly, add the <code class="literal">GeoJSONLayer</code> variable to the map and use the style function as a parameter, as shown in the following code:</p><div><pre class="programlisting">var GeoJSONLayer = L.GeoJSON(ct, {style: myStyle}).addTo(map);</pre></div><p>The preceding code adds the layer to the map using the style function. The result will look like what is shown in the following screenshot:</p><div><img src="img/4812OS_03_08.jpg" alt="Styling the GeoJSON data"/></div><p>Using a total value, such as the area of water in a census tract, can be improved upon by normalizing your data using the land area. This is important because without normalization, values can be skewed. For <a id="id230" class="indexterm"/>example, assume two locations with a land area of 100 acres and 50 acres, respectively. If they both have a lake that is 10 acres, and you color code with normalization, they<a id="id231" class="indexterm"/> will be of the same color. When you normalize, the values will be <code class="literal">.1</code> and <code class="literal">.2</code>. The second location is 20 percent water and the first is only 10 percent. This fact is lost without normalization. In the next example, you will build a map that shows the difference between total and normalized values.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec30"/>Creating a normalized choropleth map</h1></div></div></div><p>In this example, you will create a<a id="id232" class="indexterm"/> choropleth map that displays both the total area and the total area divided by the total land area. The following steps will walk you through this:</p><div><ol class="orderedlist arabic"><li class="listitem">Using the code from the previous example, add another color function with values for the new ranges. They will be much smaller values than values for the total:<div><pre class="programlisting">function densitycolor(x) {
return x &gt; 0.15 ? '#990000' :
x&gt; 0.12  ? '#d7301f' :
x&gt; 0.06  ? '#ef6548' :
x&gt; 0.03  ? '#fc8d59' :
x&gt; 0.01  ? '#fdbb84' :
x&gt; 0.005   ? '#fdd49e' :
x&gt; 0   ? '#fee8c8' :'#fff7ec';                      
}</pre></div></li><li class="listitem">Next, define another style function. The key difference in this function is that the value passed<a id="id233" class="indexterm"/> to the color function will be <code class="literal">water</code>/<code class="literal">land</code>:<div><pre class="programlisting">function densityStyle(feature) {
return {
fillColor: densitycolor(feature.properties.AWATER10/feature.properties.ALAND10),
weight: 1,
opacity: 1,
      color: 'white',
      fillOpacity: 1
    };
}</pre></div></li><li class="listitem">Create two buttons on the bottom of the map to select which choropleth map is to be displayed. Connect the buttons to a function:<div><pre class="programlisting">&lt;button onclick="total()"&gt;Total&lt;/button&gt;
&lt;button onclick="density()"&gt;Water/Land&lt;/button&gt;</pre></div></li><li class="listitem">Lastly, write the functions that display the layers. Remove the other layer after you display the correct layer:<div><pre class="programlisting">function total(){
var GeoJSONLayer = L.GeoJSON(ct, {style: myStyle}).addTo(map);
removeLayer(densitylayer);
}
function density(){
var densitylayer=L.GeoJSON(ct,GeoJSON {style: densityStyle}).addTo(map);
removeLayer(GeoJSONLayer);
}</pre></div></li></ol></div><p>Your completed map should be blank. You did not load a layer on the map. You can now select which layer you want to see by clicking on one of the buttons on the bottom of the map. Try clicking on the other button. Click on the button labeled <strong>Water/Land</strong>. Your map should look like what is shown in the following screenshot:</p><div><img src="img/4812OS_03_09.jpg" alt="Creating a normalized choropleth map"/></div><p>Notice that once you <a id="id234" class="indexterm"/>normalize the land area, the areas with the most water—darkest red—are the small tracts near the <strong>Rio Grande</strong> area. These large tracts of land have water, but this makes up a small percent of the total area.</p></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec31"/>Summary</h1></div></div></div><p>In this chapter, you have taken your map-making skills beyond points, lines, polygons, and GeoJSON to create map visualizations—heatmaps and choropleth maps. You have learned how to use two different plugins to make heatmaps and how to style them for maximum visual effect. You also learned how to make your heatmap interactive and create animations to show the time series data. Choropleth maps did not require plugins. You learned how to style GeoJSON data to make a choropleth map. Lastly, you learned the difference between totals and normalized data.</p><p>In the next chapter, you will learn how to create your own markers. You will also learn about several plugins that animate and enhance the markers on your map.</p></div></div>
</body></html>