<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Building a Physics Car Game with Box2D and Canvas</h1></div></div></div><p>
<em>2D Physics Engines<a id="id823" class="indexterm"/> is a hot topic in game development. With the help of a physics engine, we can easily create a playable game by just defining an environment and a simple rule. Taking existing games as examples, players in the Angry Birds game fly birds to destroy the enemy's castle. In Cut the Rope, candy drops into the monster's mouth to progress to the next level.</em>
</p><p>In this chapter, we will learn the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Installing the Box2D JavaScript library</li><li class="listitem" style="list-style-type: disc">Creating a static ground body in the physics world</li><li class="listitem" style="list-style-type: disc">Drawing the physics world on the Canvas</li><li class="listitem" style="list-style-type: disc">Creating a dynamic box in the physics world</li><li class="listitem" style="list-style-type: disc">Advancing the world time</li><li class="listitem" style="list-style-type: disc">Adding wheels to the game</li><li class="listitem" style="list-style-type: disc">Creating the physics car</li><li class="listitem" style="list-style-type: disc">Adding force to the car with a keyboard input</li><li class="listitem" style="list-style-type: disc">Checking a collision in the Box2D world</li><li class="listitem" style="list-style-type: disc">Adding level support to our car game</li><li class="listitem" style="list-style-type: disc">Replacing the Box2D outline drawing with graphics</li><li class="listitem" style="list-style-type: disc">Adding a final touch to make the game fun to play</li></ul></div><p>The following screenshot shows what we will get by the end of this chapter; it is a car game in which a player moves the car towards the destination point:</p><div><img src="img/B04290_09_01.jpg" alt="Building a Physics Car Game with Box2D and Canvas"/></div><p>You can also play the game at <a class="ulink" href="http://makzan.net/html5-games/car-game/">http://makzan.net/html5-games/car-game/</a> to get a glimpse of the final result.</p><p>So, let's get on with it.</p><div><div><div><div><h1 class="title"><a id="ch09lvl1sec112"/>Installing the Box2D JavaScript library</h1></div></div></div><p>Now, suppose that we <a id="id824" class="indexterm"/>want to create a car game. We apply force to the <a id="id825" class="indexterm"/>car to make it move forward. The car moves on a ramp and then flies through the air. Afterwards, the car falls on the destination ramp and the game finishes. Every collision in every part of the physics world counts on this movement. If we have to make this game from scratch, then we have to calculate at least the velocity and angle of each part. Luckily, the physics library helps us to handle all these physical problems. All we have to do is to create the physics model and present it in the canvas. The engine we use is Box2D.</p><p>Box2D is a 2D physics simulation engine. The original Box2D was written in C by Erin Catto. It was later ported to Flash ActionScript. Later on, its 2.1a version was ported to JavaScript. You can find the <a id="id826" class="indexterm"/>JavaScript version of Box2D 2.1a<a id="id827" class="indexterm"/> in their Google Code project at <a class="ulink" href="https://code.google.com/p/box2dweb/">https://code.google.com/p/box2dweb/</a>.</p><div><div><h3 class="title"><a id="note33"/>Note</h3><p>At the time of writing this book, Google Code<a id="id828" class="indexterm"/> announced that they would close down in 2016. I have forked the library into a URL (<a class="ulink" href="https://github.com/makzan/Box2DWeb-Fork">https://github.com/makzan/Box2DWeb-Fork</a>) in case the original repository is not accessible.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec113"/>Time for action – installing the Box2D physics library</h1></div></div></div><p>We will set up the Box2D library. We must carry out the following steps to prepare our project:</p><div><ol class="orderedlist arabic"><li class="listitem">First, let's set up our game project. Create a folder with the following file structure. The HTML file contains an HTML template with empty content and includes all the scripts and style files. You may find the full document's source in the code bundle. Please also download the Box2D source file into the <code class="literal">js</code> folder.<div><img src="img/B04290_09_21.jpg" alt="Time for action – installing the Box2D physics library"/></div></li><li class="listitem">In the HTML body, we must define a canvas, as follows:<div><pre class="programlisting">&lt;canvas id="game" width="1300" height="600"&gt;&lt;/canvas&gt;</pre></div></li><li class="listitem">We must then alias several Box2D classes that we will use in our game; this makes it easier to refer them in the code:<div><pre class="programlisting">// Box2D alias
var b2Vec2 = Box2D.Common.Math.b2Vec2
  , b2BodyDef = Box2D.Dynamics.b2BodyDef
  , b2Body = Box2D.Dynamics.b2Body
  , b2FixtureDef = Box2D.Dynamics.b2FixtureDef
  , b2World = Box2D.Dynamics.b2World
  , b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape
  , b2CircleShape = Box2D.Collision.Shapes.b2CircleShape
  , b2DebugDraw = Box2D.Dynamics.b2DebugDraw
  , b2RevoluteJointDef = Box2D.Dynamics.Joints.b2RevoluteJointDef;</pre></div></li><li class="listitem">Now, we will <a id="id829" class="indexterm"/>create an empty world to test our Box2D<a id="id830" class="indexterm"/> library installation. Open the<code class="literal"> box2dcargame.js</code> JavaScript file and put the following code in the file to create the world:<div><pre class="programlisting">var carGame = {
}

var canvas;
var ctx;
var canvasWidth;
var canvasHeight;

function initGame() {

  carGame.world = createWorld();

  console.log("The world is created. ",carGame.world);

  // get the reference of the context
  canvas = document.getElementById('game');
  ctx = canvas.getContext('2d');
  canvasWidth = parseInt(canvas.width);
  canvasHeight = parseInt(canvas.height);
};

// Create and return the Box2D world.
function createWorld() {
  // Define the gravity
  var gravity = new b2Vec2(0, 10);

  // set to allow sleeping object
  var allowSleep = true;

  // finally create the world with 
  // gravity and sleep object parameter.
  var world = new b2World(gravity, allowSleep);
  return world;
}

// After all the definition, we init the game.
initGame();</pre></div></li><li class="listitem">Open the <code class="literal">index.html</code> file in a web browser. We should see a grey canvas with nothing there.</li></ol></div><p>We have not <a id="id831" class="indexterm"/>presented the physics world to the canvas yet. This <a id="id832" class="indexterm"/>is why we only see a blank canvas on the page. However, we have printed the newly created world in the console log. The following screenshot shows the console tracing the world object with many properties beginning with <code class="literal">m_</code>. These are the physical states of the world:</p><div><img src="img/B04290_09_02.jpg" alt="Time for action – installing the Box2D physics library"/></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec239"/>
<em>What just happened?</em>
</h2></div></div></div><p>We have just installed the Box2D JavaScript library and created an empty world to test the installation.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec240"/>Using b2World to create a new world</h2></div></div></div><p>The <code class="literal">b2World</code> class<a id="id833" class="indexterm"/> is a <a id="id834" class="indexterm"/>core class in the Box2D environment. All our physics bodies, including the ground and car, are created in this world. The following code shows us how to create a world:</p><div><pre class="programlisting">var world = new b2World(gravity, doSleep);</pre></div><p>The <code class="literal">b2World</code> class takes two arguments to initialize, which are listed in the following table with their description:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Argument</p>
</th><th style="text-align: left" valign="bottom">
<p>Type</p>
</th><th style="text-align: left" valign="bottom">
<p>Discussion</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">gravity</code>
</p>
</td><td style="text-align: left" valign="top">
<p>b2Vec2</p>
</td><td style="text-align: left" valign="top">
<p>This represents the gravity of the world</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">doSleep</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Bool</p>
</td><td style="text-align: left" valign="top">
<p>This defines whether the world ignores slept objects or not</p>
</td></tr></tbody></table></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec241"/>Setting the gravity of the world</h2></div></div></div><p>We have to define<a id="id835" class="indexterm"/> the gravity of the world. The gravity is defined by <code class="literal">b2Vec2</code>. The <code class="literal">b2Vec2</code> class is a vector of <em>x</em> and <em>y</em> axes. Therefore, the following code defines gravity with 10 units downwards:</p><div><pre class="programlisting">var gravity = new b2Vec2(0, 10);</pre></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec242"/>Setting Box2D to ignore the sleeping object</h2></div></div></div><p>A sleeping body is a <a id="id836" class="indexterm"/>dynamic body that skips simulation until it wakes up. The physics library calculates the mathematical data and collision of all the bodies in the world. The performance will slow down when there are too many bodies in the world to get calculated in every frame. When a sleeping body collides with another object, it will wake up and then turn back to sleeping mode again until the next collision.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec114"/>Creating a static ground body in the physics world</h1></div></div></div><p>The world is empty now. If we <a id="id837" class="indexterm"/>are going to place objects there, the <a id="id838" class="indexterm"/>objects will fall and finally leave our sight. Now, suppose we want to create a static ground body in the world so that objects can stand on it. We can do this in Box2D.</p></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec115"/>Time for action – creating a ground in the world</h1></div></div></div><p>Carry out the following <a id="id839" class="indexterm"/>steps to create a static <a id="id840" class="indexterm"/>ground:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the<code class="literal"> box2dcargame.js</code> JavaScript file.</li><li class="listitem">Define the following <code class="literal">pxPerMeter</code> variable in the file; this is the unit setting in the Box2D world:<div><pre class="programlisting">var pxPerMeter = 30; // 30 pixels = 1 meter</pre></div></li><li class="listitem">Add the following function to the end of the JavaScript file; this creates a fixed body as the playground:<div><pre class="programlisting">function createGround() {
  var bodyDef = new b2BodyDef;
  var fixDef = new b2FixtureDef;

  bodyDef.type = b2Body.b2_staticBody;
  bodyDef.position.x = 250/pxPerMeter;
  bodyDef.position.y = 370 /pxPerMeter;

  fixDef.shape = new b2PolygonShape();
  fixDef.shape.SetAsBox(250/pxPerMeter, 25/pxPerMeter);
  fixDef.restitution = 0.4;

  // create the body from the definition.
  var body = carGame.world.CreateBody(bodyDef);
  body.CreateFixture(fixDef);

  return body;
}</pre></div></li><li class="listitem">Call the <code class="literal">createGround</code> function in the <code class="literal">initGame</code> function after we have created the world as follows:<div><pre class="programlisting">createGround();</pre></div></li><li class="listitem">As we are still defining the logic and have not yet presented the physics world visually, we will see nothing if we open the browser. However, it is worth getting into the habit of trying it and inspecting the console window for an error message if there is any.</li></ol></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec243"/>
<em>What just happened?</em>
</h2></div></div></div><p>We have created a ground body with the shape and body definitions. This is a common process that we will use a lot to create different kinds of physical bodies in the world. So, let's get into the details of how we made it.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec244"/>Pixel per meter</h2></div></div></div><p>The size and position <a id="id841" class="indexterm"/>unit in Box2D is calculated in meters. We use pixels in screen. Therefore, we define a variable that converts a unit between meters and screen pixels. We set the value to 30, which indicates that 30 pixels equal to 1 meter. You can explore different values for your physics world.</p><p>We should not use 1 pixel to 1 meter, otherwise our object would become very large in the Box2D scale. Imagine we have a car with 100 px width, it will become 100 meters long, which is not realistic at all. By defining 30 px/meter, or any reasonable value, an object with width 100 px on screen will be about 3.33 meters long in simulation, which Box2D can handle well. For more details, please refer to the Box2D manual section 1.7 at <a class="ulink" href="http://www.box2d.org/manual.html">http://www.box2d.org/manual.html</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec245"/>Creating a shape with a fixture</h2></div></div></div><p>A fixture contains the <a id="id842" class="indexterm"/>physics properties and its shape. The physics properties define density, friction, and restitution, where restitution is basically the bounciness of the object. A shape defines the geometrical data. The shape can be a circle, rectangle, or a polygon. The following code that we used in the preceding example defines a box shape definition. The <code class="literal">SetAsBox</code> function takes two arguments: half width and half height. It is a half value, so the final area of the shape is four times the value:</p><div><pre class="programlisting">fixDef.shape = new b2PolygonShape();
fixDef.shape.SetAsBox(250/pxPerMeter, 25/pxPerMeter);
fixDef.restitution = 0.4;</pre></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec246"/>Creating a body</h2></div></div></div><p>After defining the fixture, we <a id="id843" class="indexterm"/>can then create a body definition with the given shape definition. Then, we set the initial position of the body and finally ask the world instance to create a body from our body definition. The following code shows how we create a body in the world with the given shape definition:</p><div><pre class="programlisting">bodyDef.type = b2Body.b2_staticBody;
bodyDef.position.x = 250/pxPerMeter;
bodyDef.position.y = 370 /pxPerMeter;

// create the body from the definition.
var body = carGame.world.CreateBody(bodyDef);
body.CreateFixture(fixDef);</pre></div><p>A body can be either a static body or a dynamic body. Static bodies are immovable and will not have collisions with other static bodies. Therefore, these bodies can be used as the ground or walls to become the level environment. On the other hand, a dynamic body will move following a collision with other bodies (static or dynamic) and due to gravity. We will create a dynamic box body later.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec247"/>Setting the bouncing effect with the restitution property</h2></div></div></div><p>The restitution value is <a id="id844" class="indexterm"/>between 0 and 1. In our case, the box is falling on the ground. When the restitution value is 0 on both the ground and the box, the box does not bounce at all. When either the box or the ground has a restitution value of 1, the collision is perfectly elastic.</p><div><div><h3 class="title"><a id="tip12"/>Tip</h3><p>When two bodies collide, the restitution value of that collision is the maximum value between both restitution values of both the bodies. Therefore, if a box with a restitution value of 0.4 drops on the ground with a restitution value of 0.6, this collision will use 0.6 to calculate the bouncing velocity.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec116"/>Drawing the physics world in the canvas</h1></div></div></div><p>We have created the ground, but<a id="id845" class="indexterm"/> it is only in the mathematics model. We do not <a id="id846" class="indexterm"/>see anything in the canvas because we have not drawn anything on it yet. In order to show what the physics looks like, we have to draw something according to the physics world.</p></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec117"/>Time for action – drawing the physics world into the Canvas</h1></div></div></div><p>Carry out the following steps to draw the useful debug view:</p><div><ol class="orderedlist arabic"><li class="listitem">First, open the<code class="literal"> box2dcargame.js</code> JavaScript file:<div><pre class="programlisting">var shouldDrawDebug = false;</pre></div></li><li class="listitem">Add a function that draws the debugging lines:<div><pre class="programlisting">function showDebugDraw() {
  shouldDrawDebug = true;

  //setup debug draw
  var debugDraw = new b2DebugDraw();
  debugDraw.SetSprite(document.getElementById('game').getContext('2d'));
  debugDraw.SetDrawScale(pxPerMeter);
  debugDraw.SetFillAlpha(0.3);
  debugDraw.SetLineThickness(1.0);
  debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);

  carGame.world.SetDebugDraw(debugDraw);

  carGame.world.DrawDebugData();
}</pre></div></li><li class="listitem">Add a <code class="literal">showDebugDraw</code> function call at the end of the <code class="literal">initGame</code> method:<div><pre class="programlisting">showDebugDraw();</pre></div></li><li class="listitem">Now, reopen the<a id="id847" class="indexterm"/> game in a browser, and we should <a id="id848" class="indexterm"/>see the outline of the ground body in the canvas, as shown in the following screenshot:<div><img src="img/B04290_09_03.jpg" alt="Time for action – drawing the physics world into the Canvas"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec248"/>
<em>What just happened?</em>
</h2></div></div></div><p>We have just defined a method that asks the Box2D engine to draw the physics bodies in a canvas. This is useful for debugging before we successfully add our own graphics. We can set what to display via the <code class="literal">SetFlags</code> method.</p><p>The flags are bitwise variable. This means that each bit in the flag controls one drawing type. We combine the flag by using the bitwise operator or (<code class="literal">|</code>). For example, we show the shape and joint with the following code.</p><div><pre class="programlisting">debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);</pre></div><p>There are different types of debug drawings besides the shape and joint:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Bit flag</p>
</th><th style="text-align: left" valign="bottom">
<p>Discussion</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">e_aabbBit</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id849" class="indexterm"/>draws all the bounding boxes</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">e_centerOfMassBit</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id850" class="indexterm"/>draws the center of the mass</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">e_controllerBit</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id851" class="indexterm"/>draws all the dynamics controllers</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">e_jointBit</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id852" class="indexterm"/>draws all the joint connections</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">e_pairBit</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id853" class="indexterm"/> draws the broad-phrase collision pairs</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">e_shapeBit</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id854" class="indexterm"/>draws all the shapes</p>
</td></tr></tbody></table></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec118"/>Creating a dynamic box in the physics world</h1></div></div></div><p>Imagine now that we drop a box <a id="id855" class="indexterm"/>into the world. The box falls from the air <a id="id856" class="indexterm"/>and finally hits the ground. The box bounces up a little and finally lands on the ground. This is different from what we created in the last section. In the last section, we created a static ground, which was immovable and could not be affected by gravity. Now, we will create a dynamic box.</p></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec119"/>Time for action – putting a dynamic box in the world</h1></div></div></div><p>Carry out the following steps to create our first dynamic body:</p><div><ol class="orderedlist arabic"><li class="listitem">Open our JavaScript file and add the following box creation code to the page loaded event handler. Place the code after the <code class="literal">createGround</code> function:<div><pre class="programlisting">// temporary function
function createBox() {
  var bodyDef = new b2BodyDef;
  var fixDef = new b2FixtureDef;

  bodyDef.type = b2Body.b2_dynamicBody;
  bodyDef.position.x = 50/pxPerMeter;
  bodyDef.position.y = 210/pxPerMeter;

  fixDef.shape = new b2PolygonShape();
  fixDef.shape.SetAsBox(20/pxPerMeter, 20/pxPerMeter);

  var body = carGame.world.CreateBody(bodyDef);
  body.CreateFixture(fixDef);

  return body;
}</pre></div></li><li class="listitem">We need to call our <a id="id857" class="indexterm"/>newly created <code class="literal">createBox</code> <a id="id858" class="indexterm"/>function. Place the following code after we call the <code class="literal">createGround</code> function inside <code class="literal">initGame</code>.</li><li class="listitem">Now, we will test the physics world in a browser. You should see that a box is created at the given initial position. However, the box is not falling down; this is because we still have to do something to make it fall:<div><img src="img/B04290_09_04.jpg" alt="Time for action – putting a dynamic box in the world"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec249"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just created a dynamic body in the world. In contrast to the ground body that is immovable, this box is affected by the gravity and the velocity changes during a collision. When a body contains a shape with any mass or density, it is a dynamic body. Otherwise, it is static. Therefore, we<a id="id859" class="indexterm"/> define a density to our box. Box2D will make it dynamic and calculate the mass <a id="id860" class="indexterm"/>according to the density and size of the body automatically.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec120"/>Advancing the world time</h1></div></div></div><p>The box is dynamic <a id="id861" class="indexterm"/>but it does not fall down. Are we doing anything wrong here? The answer is no. We have set up the box correctly, but we forget to advance the time in the physics world.</p><p>In the Box2D physics world, all calculations are done in a systematic iteration. The world calculates the physical transformation of all things according to the current step. When we move the <code class="literal">step</code> to the next level, the world calculates again as the new state.</p></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec121"/>Time for action – setting up the world step loop</h1></div></div></div><p>We will make the world time advance by carrying out the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">In order to advance the world step, we have to call the <code class="literal">step</code> function in the world instance periodically. We used <code class="literal">setTimeout</code> to keep calling the <code class="literal">step</code> function. Put the following function in our JavaScript logic file:<div><pre class="programlisting">function updateWorld() {
  // Move the physics world 1 step forward.
  carGame.world.Step(1/60, 10, 10);

  // display the build-in debug drawing.
  if (shouldDrawDebug) {
    carGame.world.DrawDebugData();
  }
}</pre></div></li><li class="listitem">Next, we will set up an interval in the <code class="literal">initGame</code> method:<div><pre class="programlisting">setInterval(updateWorld, 1/60);</pre></div></li><li class="listitem">We will again simulate the world in a browser. The box is created at the initialized position and falls on the ground correctly. The following screenshot shows the sequence of a box dropping on the ground: <div><img src="img/B04290_09_05.jpg" alt="Time for action – setting up the world step loop"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec250"/>
<em>What just happened?</em>
</h2></div></div></div><p>We have advanced the <a id="id862" class="indexterm"/>time of the world. Now, the physics library simulates the world in a frequency of 60 times per second. In the game loop, we call the <code class="literal">Step</code> function to the Box2D world. The <code class="literal">Step</code> function simulates the physics world one step forward. During the step, the physics engine calculates everything that happens in the world, including forces and gravity.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec122"/>Adding wheels to the game</h1></div></div></div><p>Now, we have a box <a id="id863" class="indexterm"/>in the game. Imagine now we create two circular bodies <a id="id864" class="indexterm"/>as the wheels. Then, we will have the basic components of a car—the body and the wheels.</p></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec123"/>Time for action – putting two circles in the world</h1></div></div></div><p>We will add two circles to the world by carrying out the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">html5games.box2dcargame.js</code> JavaScript file to add the wheel bodies.</li><li class="listitem">Add the following code after the box creation code. This calls the <code class="literal">createWheel</code> function which we will write to create a circular shaped body:<div><pre class="programlisting">// create two wheels in the world
createWheel(25, 230);
createWheel(75, 230);</pre></div></li><li class="listitem">Now let's work on the <code class="literal">createWheel</code> function. We design this function to create a circle-shaped body in the given world at the given <em>x</em> and <em>y</em> coordinates in<a id="id865" class="indexterm"/> the world. To do this, put the following function<a id="id866" class="indexterm"/> in our JavaScript logic file:<div><pre class="programlisting">function createWheel(x, y) {
  var bodyDef = new b2BodyDef;
  var fixDef = new b2FixtureDef;

  bodyDef.type = b2Body.b2_dynamicBody;
  bodyDef.position.x = x/pxPerMeter;
  bodyDef.position.y = y/pxPerMeter;

  fixDef.shape = new b2CircleShape();
  fixDef.shape.SetRadius(10/pxPerMeter);

  fixDef.density = 1.0;
  fixDef.restitution = 0.1;
  fixDef.friction = 4.3;

  var body = carGame.world.CreateBody(bodyDef);
  body.CreateFixture(fixDef);

  return body;
}</pre></div></li><li class="listitem">We will now reload the physics world in a web browser. This time, we should see a result similar to the one shown in the following screenshot, with a box and two wheels falling down from air:<div><img src="img/B04290_09_06.jpg" alt="Time for action – putting two circles in the world"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec251"/>
<em>What just happened?</em>
</h2></div></div></div><p>When simulating the <a id="id867" class="indexterm"/>physics world, both the box and wheels drop and collide with<a id="id868" class="indexterm"/> each other and the ground.</p><p>Creating a circular body is similar to creating a box body. The only difference is that we use a <code class="literal">CircleDef</code> class instead of the box shape definition. In the circle definition, we define the circle size by using the <code class="literal">radius</code> property instead of the <code class="literal">extents</code> property.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec124"/>Creating a physical car</h1></div></div></div><p>We have prepared <a id="id869" class="indexterm"/>the car box body and two wheel bodies. We are just one step away from making a car. Imagine that now we have a glue stick to glue the wheels to the car body. Then, the car and wheels will not separate anymore, and we will have a car. We can use <strong>joint</strong>
<a id="id870" class="indexterm"/> to achieve this. In this section, we will use <code class="literal">joint</code> to stick the wheels and the car body together.</p></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec125"/>Time for action – connecting the box and two circles with a revolute joint</h1></div></div></div><p>Carry out the following steps to <a id="id871" class="indexterm"/>create a car with the box and wheels: </p><div><ol class="orderedlist arabic"><li class="listitem">We are still working only on the logic part. Open our JavaScript logic file in a text editor.</li><li class="listitem">Create a function named <code class="literal">createCarAt</code>, which takes the coordinates as arguments. Then, move the body and the wheel creation code in this function. Afterwards, add the following highlighted joint creation code. At last, return the car body:<div><pre class="programlisting">function createCarAt(x, y) {
  var bodyDef = new b2BodyDef;
  var fixDef = new b2FixtureDef;

  // car body
  bodyDef.type = b2Body.b2_dynamicBody;
  bodyDef.position.x = 50/pxPerMeter;
  bodyDef.position.y = 210/pxPerMeter;

  fixDef.shape = new b2PolygonShape();
  fixDef.density = 1.0;
  fixDef.friction = 1.5;
  fixDef.restitution = .4;
  fixDef.shape.SetAsBox(40/pxPerMeter, 20/pxPerMeter);

  carBody = carGame.world.CreateBody(bodyDef);

  carBody.CreateFixture(fixDef);

  // creating the wheels
  var wheelBody1 = createWheel(x-25, y+20);
  var wheelBody2 = createWheel(x+25, y+20);

  // create a joint to connect left wheel with the car body
  var jointDef = new b2RevoluteJointDef();
  jointDef.Initialize(carBody, wheelBody1, new b2Vec2( (x-25)/pxPerMeter ,  (y+20)/pxPerMeter ));
  carGame.world.CreateJoint(jointDef);

  // create a joint to connect right wheel with the car body
  var jointDef = new b2RevoluteJointDef();
  jointDef.Initialize(carBody, wheelBody2, new b2Vec2( (x+25)/pxPerMeter ,  (y+20)/pxPerMeter ));
  carGame.world.CreateJoint(jointDef);

  return carBody;

}</pre></div></li><li class="listitem">In the <code class="literal">initGame</code> function, we <a id="id872" class="indexterm"/>created two wheels. Remove <a id="id873" class="indexterm"/>these lines of code that calls the <code class="literal">createWheel</code> function in the <code class="literal">initGame</code> function.</li><li class="listitem">Then, all we need to do is create a car with the initial position. Add the following code to the <code class="literal">initGame</code> function after calling the <code class="literal">createGround</code> function:<div><pre class="programlisting">carGame.car = createCarAt(50, 210);</pre></div></li><li class="listitem">It is time to save the file and run the physics world in a browser. At this time, the wheels and the car body are not separate pieces. They glue together as a car and drop on the ground correctly, as shown in the following screenshot: <div><img src="img/B04290_09_07.jpg" alt="Time for action – connecting the box and two circles with a revolute joint"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec252"/>
<em>What just happened?</em>
</h2></div></div></div><p>A joint is useful to add <a id="id874" class="indexterm"/>constraint between two bodies (or between a body and the world). There are many kinds of joints and what we used in this example is<a id="id875" class="indexterm"/> called the <a id="id876" class="indexterm"/>
<strong>revolute joint</strong>.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec253"/>Using a revolute joint to create an anchor point between two bodies</h2></div></div></div><p>The revolute joint<a id="id877" class="indexterm"/> sticks two bodies together with a common anchor point. The two bodies are then glued together and are only allowed to rotate based on the common anchor point. The left-hand side of the following screenshot shows that the two bodies are connected with an anchor. In our code example, we set the anchor point to be exactly the center point of the wheel. The right-hand side of the following screenshot shows how we set the joint. The wheel rotates because the rotation origin is at the center. This setup makes the car and wheels look real:</p><div><img src="img/B04290_09_08.jpg" alt="Using a revolute joint to create an anchor point between two bodies"/></div><p>There are other types of joints that are useful in different ways. Joints are useful to create a game environment, and as there are several types of joints, each joint type is worth a try, and you should think about how to use them. The following link consists of the Box2D<a id="id878" class="indexterm"/> manual that explains each type of joint and how we can use them on different environment setups: <a class="ulink" href="http://www.box2d.org/manual.html#_Toc258082974">http://www.box2d.org/manual.html#_Toc258082974</a>.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec126"/>Adding force to the car with a keyboard input</h1></div></div></div><p>We have the car<a id="id879" class="indexterm"/> ready now. Let's move it with <a id="id880" class="indexterm"/>our <a id="id881" class="indexterm"/>keyboard.</p></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec127"/>Time for action – adding force to the car</h1></div></div></div><p>Carry out the following steps to take the keyboard input:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the<code class="literal"> box2dcargame.js</code> JavaScript file in a text editor.</li><li class="listitem">In the page loaded event handler, we add the following <code class="literal">keydown</code> event handler at the beginning of the code. This listens to the right arrow key and the left arrow key to apply force in different directions:<div><pre class="programlisting">$(document).keydown(function(e){
  switch(e.keyCode) {
    case 39: // right arrow key to apply force towards right
      var force = new b2Vec2(100, 0);
      carGame.car.ApplyForce(force, carGame.car.GetWorldCenter());
      return false;
      break;
    case 37: // left arrow key to apply force towards left
      var force = new b2Vec2(-100, 0);
      carGame.car.ApplyForce(force, carGame.car.GetWorldCenter());
      return false;
      break;
  }
});</pre></div></li><li class="listitem">We have added forces to bodies. We need to clear forces in each step, otherwise the force accumulates:<div><pre class="programlisting">function updateWorld() {
  // existing code goes here.
  // Clear previous applied force.
  carGame.world.ClearForces();
}</pre></div></li><li class="listitem">Save the files and run our game in the browser. When you press the <em>arrow </em>keys, the car starts moving. If you keep pressing the key, the world will keep adding force to the car and make it speed away:<div><img src="img/B04290_09_09.jpg" alt="Time for action – adding force to the car"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec254"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just created an<a id="id882" class="indexterm"/> interaction with our car body. We can <a id="id883" class="indexterm"/>move the car left and right by pressing the arrow keys. It seems like the<a id="id884" class="indexterm"/> game is getting interesting now.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec255"/>Applying force to a body</h2></div></div></div><p>We can apply force<a id="id885" class="indexterm"/> to any body by calling the <code class="literal">ApplyForce</code> function in<a id="id886" class="indexterm"/> that body. The following code shows the usage of the function:</p><div><pre class="programlisting">body.ApplyForce(force, point);</pre></div><p>This function takes two arguments, which are listed in the following table:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Argument</p>
</th><th style="text-align: left" valign="bottom">
<p>Type</p>
</th><th style="text-align: left" valign="bottom">
<p>Discussion</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">force</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">b2Vec2</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the force vector to apply to the body</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">point</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">b2Vec2</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the point where the force is applied</p>
</td></tr></tbody></table></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec256"/>Clearing Force</h2></div></div></div><p>After we apply the force to bodies, the<a id="id887" class="indexterm"/> force would constantly apply to that body until we clear it. In most cases, we clear the force after each step.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec257"/>Understanding the difference between ApplyForce and ApplyImpulse</h2></div></div></div><p>Besides the <code class="literal">ApplyForce</code> function, we can also move any body by using the <code class="literal">ApplyImpulse</code> function. Both <a id="id888" class="indexterm"/>functions move the body, but <a id="id889" class="indexterm"/>they move them using a different approach. If we want to change the instance velocity of a body, then we use <code class="literal">ApplyImpulse</code> once on the body to change its velocity to meet our target value. On the other hand, we need to constantly apply force to a body to increase the speed.</p><p>For example, if we want to increase the velocity of the car, similar to like stepping on the pedal, we need to apply force to the car. If we are creating a ball game in which we need to kick-start the ball, we may use the <code class="literal">ApplyImpulse</code> function to add an instance impulse to the ball's body.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec258"/>Have a go hero</h2></div></div></div><p>Can you think about a different situation where we will need to apply force or impulse to the body?</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec259"/>Adding ramps to our game environment</h2></div></div></div><p>Now, we can move the car. However, the <a id="id890" class="indexterm"/>environment is not interesting enough<a id="id891" class="indexterm"/> to play. Imagine now there are some ramps for the car to jump, and there is a gap between two platforms over which a player has to fly the car. It will become more interesting to play with different ramp setups.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec128"/>Time for action – creating the world with ramps</h1></div></div></div><p>Carry out the following steps to create a ramp in the physics world:</p><div><ol class="orderedlist arabic"><li class="listitem">We open the game logic JavaScript file.</li><li class="listitem">In the <code class="literal">createGround</code> function, we update the function to take four arguments. The changed code is highlighted as follows:<div><pre class="programlisting">
<strong>function createGround(x, y, width, height, rotation) {</strong>
  var bodyDef = new b2BodyDef;
  var fixDef = new b2FixtureDef;

  bodyDef.type = b2Body.b2_staticBody;
  <strong>bodyDef.position.x = x /pxPerMeter;</strong>
  <strong>bodyDef.position.y = y /pxPerMeter;</strong>
  <strong>bodyDef.angle = rotation * Math.PI / 180;</strong>

  fixDef.shape = new b2PolygonShape();
  <strong>fixDef.shape.SetAsBox(width/pxPerMeter, height/pxPerMeter);</strong>
  fixDef.restitution = 0.4;
  fixDef.friction = 3.5;

  // create the body from the definition.
  var body = carGame.world.CreateBody(bodyDef);
  body.CreateFixture(fixDef);

  return body;
}</pre></div></li><li class="listitem">Now, we <a id="id892" class="indexterm"/>have a function to create the<a id="id893" class="indexterm"/> ground body. We will now replace the ground creation code in the page loaded handler function with the following code:<div><pre class="programlisting">// create the ground
createGround(250, 270, 250, 25, 0);
// create a ramp
createGround(500, 250, 65, 15, -10);
createGround(600, 225, 80, 15, -20);
createGround(1100, 250, 100, 15, 0);</pre></div></li><li class="listitem">Save the file and preview the game in a browser. We should now see a ramp and a destination platform, as shown in the following screenshot. Try to control the car by making it jump over the ramp to reach the destination without falling down. Refresh the page to restart the game if you fail:<div><img src="img/B04290_09_10.jpg" alt="Time for action – creating the world with ramps"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec260"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just wrapped the ground box creating code with a function so that we can easily create a combination of ground bodies. These ground bodies composite the level environment of the game.</p><p>In addition, this is the first time we are rotating a body. We set the rotation of the body by using the <code class="literal">rotation</code> property which takes a value in radians. By setting the rotation of a box, we can have a ramp with a varying slope setup in our game.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec261"/>Have a go hero</h2></div></div></div><p>We have set up a ramp now, and we can play with the car within the environment. How about using different kinds of joints to set up the playground? For example, how about a pulley joint to act as a lift? On the other hand, how about including a dynamic board with a joint at the center?</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec129"/>Checking collisions in the Box2D world</h1></div></div></div><p>The Box2D <a id="id894" class="indexterm"/>physics library calculates all collisions <a id="id895" class="indexterm"/>automatically. Imagine now that we set up a ground body as the destination. Players win when they successfully move the car to hit the destination. As Box2D already calculates all collisions, all we have to do is get the detected collision list and determine whether our car has hit the destination ground.</p></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec130"/>Time for action – checking a collision between the car and the destination body</h1></div></div></div><p>Carry out the following steps to handle collision:</p><div><ol class="orderedlist arabic"><li class="listitem">Again, we start from our game logic. Open the<code class="literal"> box2dcargame.js</code> JavaScript file in a text editor.</li><li class="listitem">We set up a destination ground in the ground creation code and assign it to our <code class="literal">gamewinWall</code> reference inside the <code class="literal">carGame</code> global object instance as follows:<div><pre class="programlisting">carGame.gamewinWall = createGround(1200, 215, 15, 25, 0);</pre></div></li><li class="listitem">Next, we move on to the <code class="literal">step</code> function. In each step, we get the complete contact list from the world and check whether any two colliding objects are the car and the destination ground:<div><pre class="programlisting">function checkCollision() {
  // loop all contact list 
  // to check if the car hits the winning wall.
  for (var cn = carGame.world.GetContactList(); cn != null; cn = cn.GetNext()) {
    var body1 = cn.GetFixtureA().GetBody();
    var body2 = cn.GetFixtureB().GetBody();
    if ((body1 === carGame.car &amp;&amp; body2 === carGame.gamewinWall) || (body2 === carGame.car &amp;&amp; body1 === carGame.gamewinWall))
    {
      if (cn.IsTouching()) {
        console.log("Level Passed!");
      }
    }
  }
}</pre></div></li><li class="listitem">When we<a id="id896" class="indexterm"/> call our game loop function, <code class="literal">updateWorld</code>, we <a id="id897" class="indexterm"/>call our newly-created collision checking function.<div><pre class="programlisting">checkCollision();</pre></div></li><li class="listitem">We will now save the code and open the game in a browser again. This time, we have to open the console window to track whether we get the <strong>Level</strong> <strong>Passed!</strong> output when the car hits the wall. Try to finish the game, and we should see the output in the console once the car hits the destination:<div><img src="img/B04290_09_11.jpg" alt="Time for action – checking a collision between the car and the destination body"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec262"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just created<a id="id898" class="indexterm"/> the game winning logic by checking the collision<a id="id899" class="indexterm"/> contacts. The player wins when the car successfully reaches the destination ground object.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec263"/>Getting the collision contact list</h2></div></div></div><p>In each step, Box2D <a id="id900" class="indexterm"/>calculates all collisions and puts them into a <strong>contact</strong> <strong>list</strong> in the <code class="literal">world</code> instance. We can get the contact list by using the <code class="literal">carGame.world.GetContactList()</code> function. The returned contact list is a<a id="id901" class="indexterm"/> <strong>link</strong> <strong>list</strong>. We can travel through the entire link list by using the following <code class="literal">for</code> loop:</p><div><pre class="programlisting">for (var cn = carGame.world.GetContactList(); cn != null; cn = cn.GetNext()) {
   // We have fixture 1 and fixture 2 of each contact node.
   var body1 = cn.GetFixtureA().GetBody();
   var body2 = cn.GetFixtureB().GetBody();
}</pre></div><p>When we get the collided shapes, we check whether the body of that shape is a car or the destination body. As the car shape may be in fixture 1 or fixture 2, and the same applies to <code class="literal">gamewinWall</code>, we need to check both the combinations. The additional <code class="literal">isTouching</code> function provides a more accurate collision-checking between the fixtures.</p><div><pre class="programlisting">if ((body1 === carGame.car &amp;&amp; body2 === carGame.gamewinWall) ||
   (body2 === carGame.car &amp;&amp; body1 === carGame.gamewinWall))
{
  if (cn.IsTouching()) {
    console.log("Level Passed!");
  }
}</pre></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec264"/>Have a go hero</h2></div></div></div><p>We created a game over dialog in <a class="link" href="ch07.html" title="Chapter 7. Saving the Game's Progress">Chapter 7</a>, <em>Saving the Game's Progress</em>. How about using that technique here to create a dialog showing the player passed the level when they hit the winning wall? This will also be useful as a level transition later when we add different level setups to the game.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec131"/>Restarting the game</h1></div></div></div><p>You may have already tried <a id="id902" class="indexterm"/>refreshing the page several times in the last example to make the car successfully jump to the destination. Imagine now if we could press a key to reinitialize the world. Then, we can follow the trial-and-error method until success.</p></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec132"/>Time for action – restarting the game while pressing the R key</h1></div></div></div><p>We will assign the <em>R</em> key as the<a id="id903" class="indexterm"/> restart key for our game. Now, let's perform the following set of steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Again, we only need to change the JavaScript file. Open the<code class="literal"> box2dcargame.js</code> JavaScript file in a text editor.</li><li class="listitem">We need a function to remove all the bodies:<div><pre class="programlisting">function removeAllBodies() {
  // loop all body list to destroy them
  for (var body = carGame.world.GetBodyList(); body != null; body = body.GetNext()) {
    carGame.world.DestroyBody(body);
  }
}</pre></div></li><li class="listitem">We move the create world, ramp, and the car code into a function named <code class="literal">restartGame</code>. They were originally in the page loaded handler function:<div><pre class="programlisting">function restartGame() {
  removeAllBodies();

  // create the ground
  createGround(250, 270, 250, 25, 0);

  // create a ramp
  createGround(500, 250, 65, 15, -10);
  createGround(600, 225, 80, 15, -20);
  createGround(1100, 250, 100, 15, 0);

  // create a destination ground
  carGame.gamewinWall = createGround(1200, 215, 15, 25, 0);

  // create a car
  carGame.car = createCarAt(50, 210);
}</pre></div></li><li class="listitem">Then, in the <code class="literal">initGame</code> function, we call the <code class="literal">restartGame</code> function to initialize the game as follows:<div><pre class="programlisting">restartGame();</pre></div></li><li class="listitem">Finally, we add the following highlighted code to the <code class="literal">keydown</code> handler to restart the game when the <em>R</em> key is pressed:<div><pre class="programlisting">$(document).keydown(function(e){
  switch(e.keyCode) {
    case 39: // right arrow key to apply force towards right
      var force = new b2Vec2(300, 0);
      carGame.car.ApplyForce(force, carGame.car.GetWorldCenter());
      break;
    case 37: // left arrow key to apply force towards left
      var force = new b2Vec2(-300, 0);
      carGame.car.ApplyForce(force, carGame.car.GetWorldCenter());
      break;
<strong>    case 82: // r key to restart the game</strong>
<strong>      restartGame();</strong>
<strong>      break;</strong>
  }
});</pre></div></li><li class="listitem">How about restarting<a id="id904" class="indexterm"/> the game when the player passes the level? To do this, add the following highlighted code inside the logic where we checked the collision between the car and the winning flag:<div><pre class="programlisting">console.log("Level Passed!");
<strong>restartGame();</strong>
</pre></div></li><li class="listitem">It is time to test the game in a browser. Try playing the game and press the <em>R</em> key to restart the game.</li></ol></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec265"/>
<em>What just happened?</em>
</h2></div></div></div><p>We refractored our code to create a <code class="literal">restartGame</code> function. The world is destroyed and initialized again each time we call this function. We can destroy the existing world and create a new empty one by creating a new world instance of our world variable as follows:</p><div><pre class="programlisting">carGame.world = createWorld();</pre></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec266"/>Have a go hero</h2></div></div></div><p>Now the only way to restart the game is by pressing the restart key. How about creating a ground at the bottom of the world that checks for any falling cars? When the car drops and hits the bottom ground, we know that the player has failed and then they can restart the game.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec133"/>Adding a level support to our car game</h1></div></div></div><p>Imagine now that we <a id="id905" class="indexterm"/>can level up to the next environment setup after <a id="id906" class="indexterm"/>finishing each game. We will need several environment setups for each level.</p></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec134"/>Time for action – loading the game with levels data</h1></div></div></div><p>We will refractor our code to support the loading of static ground bodies from a levels data structure. Let's work on it by carrying out the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the<code class="literal"> box2dcargame.js</code> JavaScript file in a text editor.</li><li class="listitem">We will need each ground setup on each level. Put the following code at the top of the JavaScript file. It is an array of levels. Each level is another array of objects with the position, dimension, and rotation of the static ground body:<div><pre class="programlisting">var carGame = {
   currentLevel: 0
}
carGame.levels = new Array();
carGame.levels[0] = [{"type":"car","x":50,"y":210,"fuel":20},
{"type":"box","x":250, "y":270, "width":250, "height":25, "rotation":0},
{"type":"box","x":500,"y":250,"width":65,"height":15, "rotation":-10},
{"type":"box","x":600,"y":225,"width":80,"height":15, "rotation":-20},
{"type":"box","x":950,"y":225,"width":80,"height":15, "rotation":20},
{"type":"box","x":1100,"y":250,"width":100,"height":15, "rotation":0},
{"type":"win","x":1200,"y":215,"width":15,"height":25, "rotation":0}];

carGame.levels[1] = [{"type":"car","x":50,"y":210,"fuel":20},
{"type":"box","x":100, "y":270, "width":190, "height":15, "rotation":20},
{"type":"box","x":380, "y":320, "width":100, "height":15, "rotation":-10},
{"type":"box","x":666,"y":285,"width":80,"height":15, "rotation":-32},
{"type":"box","x":950,"y":295,"width":80,"height":15, "rotation":20},
{"type":"box","x":1100,"y":310,"width":100,"height":15, "rotation":0},
{"type":"win","x":1200,"y":275,"width":15,"height":25, "rotation":0}];

carGame.levels[2] = [{"type":"car","x":50,"y":210,"fuel":20},
{"type":"box","x":100, "y":270, "width":190, "height":15, "rotation":20},
{"type":"box","x":380, "y":320, "width":100, "height":15, "rotation":-10},
{"type":"box","x":686,"y":285,"width":80,"height":15, "rotation":-32},
{"type":"box","x":250,"y":495,"width":80,"height":15, "rotation":40},
{"type":"box","x":500,"y":540,"width":200,"height":15, "rotation":0},
{"type":"win","x":220,"y":425,"width":15,"height":25, "rotation":23}];</pre></div></li><li class="listitem">Replace<a id="id907" class="indexterm"/> the <code class="literal">restartGame</code> function with the <a id="id908" class="indexterm"/>following code. This changes the function to accept a <code class="literal">level</code> argument. Then, create the ground or car by the level data:<div><pre class="programlisting">function restartGame(level) {
   carGame.currentLevel = level;
      
   // destroy existing bodies.
   removeAllBodies();// create the world 
   
   // create a ground in our newly created world
   // load the ground info from level data
   for(var i=0;i&lt;carGame.levels[level].length;i++) {
      var obj = carGame.levels[level][i];
      
      // create car
      if (obj.type === "car") {
         carGame.car = createCarAt(obj.x, obj.y);
         continue;
      }
      
      var groundBody = createGround(obj.x, obj.y, obj.width, obj.height, obj.rotation);
      
      if (obj.type === "win") {
         carGame.gamewinWall = groundBody;
      }   
   }
}</pre></div></li><li class="listitem">In the page loaded handler function, change the <code class="literal">restartGame</code> function called by providing <code class="literal">currentLevel</code> as follows:<div><pre class="programlisting">restartGame(carGame.currentLevel);</pre></div></li><li class="listitem">We also need to provide the <code class="literal">currentLevel</code> value in the restart key handler:<div><pre class="programlisting">case 82: // r key to restart the game
   restartGame(carGame.currentLevel);
   break;</pre></div></li><li class="listitem">Lastly, change<a id="id909" class="indexterm"/> the following highlighted<a id="id910" class="indexterm"/> code in the game's win logic. We move a level up in the game when the car hits the destination:<div><pre class="programlisting">if ((body1 === carGame.car &amp;&amp; body2 === carGame.gamewinWall) ||
   (body2 === carGame.car &amp;&amp; body1 === carGame.gamewinWall))
{
  if (cn.IsTouching()) {
    console.log("Level Passed!");
<strong>    restartGame(carGame.currentLevel+1);</strong>
  }
}</pre></div></li><li class="listitem">We will now run the game in the web browser. Finish the level and the game should restart at the next level:<div><img src="img/B04290_09_12.jpg" alt="Time for action – loading the game with levels data"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec267"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just created a data structure to store the levels. Then, we created the game with the given level number and constructed the world with the level data.</p><p>Each level data is an array of objects. Each object contains properties of each ground body in the world. This includes basic properties such as position, size, and rotation. There is also a property named <code class="literal">type</code>. It defines whether the body is a normal box body, car data, or the destination winning ground:</p><div><pre class="programlisting">carGame.levels[0] = [{"type":"car","x":50,"y":210,"fuel":20},
{"type":"box","x":250, "y":270, "width":250, "height":25, "rotation":0},
{"type":"box","x":500,"y":250,"width":65,"height":15,"rotation":-10},
{"type":"box","x":600,"y":225,"width":80,"height":15,"rotation":-20},
{"type":"box","x":950,"y":225,"width":80,"height":15,"rotation":20},
{"type":"box","x":1100,"y":250,"width":100,"height":15,"rotation":0},
{"type":"win","x":1200,"y":215,"width":15,"height":25,"rotation":0}];</pre></div><p>When creating<a id="id911" class="indexterm"/> the world, we use the following code to loop through <a id="id912" class="indexterm"/>all objects in the level array. We then create the car and ground bodies and reference the game winning ground according to the type:</p><div><pre class="programlisting">for(var i=0;i&lt;carGame.levels[level].length;i++) {
  var obj = carGame.levels[level][i];
  
  // create car
  if (obj.type === "car") {
    carGame.car = createCarAt(obj.x,obj.y);
    continue;
  }
  
  var groundBody = createGround(obj.x, obj.y, obj.width, obj.height, obj.rotation);
  
  if (obj.type === "win") {
    carGame.gamewinWall = groundBody;
  }   
}</pre></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec268"/>Have a go hero</h2></div></div></div><p>Now, we have several levels setup for our game. How about duplicating the level data to create more interesting levels to play? Create your own levels and play with them. It is just like how a kid builds blocks and plays with them.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec135"/>Replacing the Box2D outline drawing with graphics</h1></div></div></div><p>We have created a game<a id="id913" class="indexterm"/> that is at least playable with <a id="id914" class="indexterm"/>several levels. However, they are just some outline boxes. We cannot even distinguish between the destination body and other ground bodies in the game. Imagine now that the destination is a racing flag and there is a car graphic to represent it. This will make the game's purpose clearer.</p></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec136"/>Time for action – adding a flag graphic and a car graphic to the game</h1></div></div></div><p>Carry out the<a id="id915" class="indexterm"/> following steps to draw two graphics on<a id="id916" class="indexterm"/> our physics objects:</p><div><ol class="orderedlist arabic"><li class="listitem">We will first download the graphics we need for this example. To download the graphics, go to <a class="ulink" href="http://mak.la/book-assets">http://mak.la/book-assets</a>.</li><li class="listitem">Put the image files for this chapter in the <code class="literal">images</code> folder.</li><li class="listitem">Now, it is time to edit the <code class="literal">index.html</code> file. Add the following HTML markup to the <code class="literal">body</code> section:<div><pre class="programlisting">&lt;div id="asset"&gt;
  &lt;img id="flag" src='images/flag.png'&gt;
  &lt;img id="bus" src="img/bus.png"&gt;
  &lt;img id="wheel" src="img/wheel.png"&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">We want to hide the asset DIV that contains our <code class="literal">img</code> tags. Open the <code class="literal">cargame.css</code> file and add the following CSS rule to keep the asset DIV out of our sight:<div><pre class="programlisting">#asset {
  position: absolute;
  top: -9999px;
}</pre></div></li><li class="listitem">We will now move on to the logic part. Open the<code class="literal"> box2dcargame.js</code> JavaScript file.</li><li class="listitem">In the <code class="literal">restartGame</code> function, add the highlighted code to assign the reference of the <code class="literal">flag</code> image to the winning destination flag:<div><pre class="programlisting">if (obj.type === "win") {
  carGame.gamewinWall = groundBody;
<strong>  groundBody.SetUserData( document.getElementById('flag') );</strong>
}</pre></div></li><li class="listitem">Next, assign the reference of the <code class="literal">bus</code> image tag to the user data in the car shape. Add the following highlighted code to the car box definition creation:<div><pre class="programlisting">function createCarAt(x, y) {
  var bodyDef = new b2BodyDef;
  var fixDef = new b2FixtureDef;

  // car body
  bodyDef.type = b2Body.b2_dynamicBody;  
  <strong>bodyDef.userData = document.getElementById('bus');</strong>

  // existing code goes here.
}</pre></div><div><div><h3 class="title"><a id="note34"/>Note</h3><p>We used to get the reference of an element by the jQuery <code class="literal">$(selector)</code> method. The jQuery selector returns an array of the element objects with additional jQuery data wrapped. If we want to get the original document element reference, then we can either use the <code class="literal">document.getElementById</code> method or <code class="literal">$(selector).get(0)</code>. As <code class="literal">$(selector)</code> returns an array, <code class="literal">get(0)</code> gives the first original document element in the list</p></div></div></li><li class="listitem">Then, we<a id="id917" class="indexterm"/> need to handle the <a id="id918" class="indexterm"/>wheels. We assign the <code class="literal">wheel</code> image tag to the wheel body's <code class="literal">userData</code> property. Add the following highlighted code to the <code class="literal">createWheel</code> function<div><pre class="programlisting">function createWheel(x, y) {
  var bodyDef = new b2BodyDef;
  var fixDef = new b2FixtureDef;

  bodyDef.type = b2Body.b2_dynamicBody;
  <strong>bodyDef.userData = document.getElementById('wheel');</strong>

  // existing code goes here
}</pre></div></li><li class="listitem">We have to draw the images in the canvas. Create a new <code class="literal">drawWorld</code> function in the <code class="literal">box2dcargame.js</code> file with the following code.<div><pre class="programlisting">// drawing functions
function drawWorld(world, context) {
  for (var body = carGame.world.GetBodyList(); body != null; body = body.GetNext()) {
    if (body.GetUserData() !== null &amp;&amp; body.GetUserData() !== undefined) {
      // the user data contains the reference to the image
      var img = body.GetUserData();

      // the x and y of the image. We have to subtract the half width/height
      var x = body.GetPosition().x;
      var y = body.GetPosition().y;
      var topleftX = - $(img).width()/2;
      var topleftY = - $(img).height()/2;

      context.save();
      context.translate(x * pxPerMeter,y * pxPerMeter);
      context.rotate(body.GetAngle());
      context.drawImage(img, topleftX, topleftY);
      context.restore();
    }
  }
}</pre></div></li><li class="listitem">Finally, call the <code class="literal">drawWorld</code> function in the <code class="literal">updateWorld</code> function:<div><pre class="programlisting">function updateWorld() { 
  ctx.clearRect(0, 0, canvasWidth, canvasHeight);

  // existing code goes here.  

  // render graphics
  drawWorld(carGame.world, ctx);
} </pre></div></li><li class="listitem">Save all <a id="id919" class="indexterm"/>files and run the game <a id="id920" class="indexterm"/>in a web browser. We should see a yellow bus graphic, two wheels, and a flag as the destination. Play the game now and the game should move on to the next level when the bus hits the flag:<div><img src="img/B04290_09_13.jpg" alt="Time for action – adding a flag graphic and a car graphic to the game"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec269"/>
<em>What just happened?</em>
</h2></div></div></div><p>We are now presenting our game with minimal graphics. At least, players easily know what they are controlling and where they should go.</p><p>The Box2D library uses a canvas to render the physics world. Therefore, all techniques that we learned about a canvas can be applied here. In <a class="link" href="ch05.html" title="Chapter 5. Building a Canvas Game's Masterclass">Chapter 5</a>, <em>Building a Canvas Game's Masterclass</em>, we learned the use of the <code class="literal">drawImage</code> function to display an image in the canvas. We used this technique to draw the flag graphic in the canvas of the physics world.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec270"/>Using userData in shape and body</h2></div></div></div><p>How do we know <a id="id921" class="indexterm"/>which physics body needs to be displayed as the<a id="id922" class="indexterm"/> flag image? There is a property named <code class="literal">userData</code> in every Box2D shape and body. This property is used to store any custom data related to that shape or body. For example, we may store the filename of the graphic file or just directly store the reference to the image tag.</p><p>We have a list of image tags referencing the graphic assets that we need in the game. However, we do not want to display the image tags—they are just for the purpose of loading and referencing. We hide the asset image tags by setting their position out of the HTML bound with the following CSS style. We do not use <code class="literal">display:none</code> because we cannot get the width and height of the element that is not displayed at all. We need the width and height to position graphics correctly in the physics world:</p><div><pre class="programlisting">#asset {
   position: absolute;
   top: -9999px;
}</pre></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec271"/>Drawing graphics in every frame according to the state of its physics body</h2></div></div></div><p>The drawing from Box2D is just for <a id="id923" class="indexterm"/>development use before we replace it with our graphics.</p><p>The following code checks whether the shape has user data assigned to it. In our example, the user data is used to reference the <code class="literal">image</code> tag of a graphics asset. We get the <code class="literal">image</code> tag and pass it to the Canvas context <code class="literal">drawImage</code> function to draw.</p><p>All box and circle shapes in Box2D have the origin point at the center. However, the image drawing in the canvas needs the top-left point. Therefore, we have both <em>x</em> and <em>y</em> coordinates and offset of top-left <em>x</em> and <em>y</em> points, which is a negative half width and height of the image:</p><div><pre class="programlisting">if (body.GetUserData() !== null &amp;&amp; body.GetUserData() !== undefined) {
   // the user data contains the reference to the image
   var img = body.GetUserData();
            
   // the x and y of the image.
   // We have to subtract the half width/height
   var x = body.GetPosition().x;
   var y = body.GetPosition().y;
   var topleftX = - $(img).width()/2;
   var topleftY = - $(img).height()/2;
            
   context.save();
   context.translate(x,y);
   context.rotate(s.GetBody().GetRotation());
   context.drawImage(img, topleftX, topleftY);
   context.restore();
}</pre></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec272"/>Rotating and translating an image in the canvas</h2></div></div></div><p>We used the <code class="literal">drawImage</code> function to draw an image directly with the coordinates. However, the situation is <a id="id924" class="indexterm"/>different here. We need to rotate the drawn image. This is <a id="id925" class="indexterm"/>done by rotating the context before drawing and then<a id="id926" class="indexterm"/> restoring the rotation afterwards. We can do this <a id="id927" class="indexterm"/>by saving the context state, translating it, rotating it, and then calling the <code class="literal">restore</code> function. The following code shows how we draw an image at a given position and rotation. The <code class="literal">topleftX</code> and <code class="literal">topleftY</code> are the offset distances from the image's center origin to the top-left point:</p><div><pre class="programlisting">context.save();
context.translate(x,y);
context.rotate(s.GetBody().GetRotation());
context.drawImage(img, topleftX, topleftY);
context.restore();</pre></div><div><div><h3 class="title"><a id="tip13"/>Tip</h3><p>We do not need to make the physics body area exactly the same as its graphics. For example, if we have a round circular chicken, we can represent it in the physics world by just a ball body. Using a simple physics body can improve the performance a lot.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec273"/>Have a go hero</h2></div></div></div><p>We have learned using CSS3 transitions to animate a scoreboard. How about applying it to this car game? Moreover, how about adding some engine sounds to the car? Just try applying what we have learned throughout this book to give players a complete game experience.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec137"/>Adding a final touch to make the game fun to play</h1></div></div></div><p>Imagine now that we want <a id="id928" class="indexterm"/>to publish the game. The game logic is basically there, but it looks quite ugly with the black and white environment. In this section, we will add some final touches to the game so that it is much more attractive. We will also apply some constraints to limit the time of <code class="literal">ApplyForce</code>. This constraint makes the game more fun because it requires a player to think before he applies too much force to the car.</p></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec138"/>Time for action – decorating the game and adding a fuel limitation</h1></div></div></div><p>Carry out the following steps<a id="id929" class="indexterm"/> to turn our debug draw into a rich graphical game:</p><div><ol class="orderedlist arabic"><li class="listitem">First, we need some background images for the starting screen, game winning screen, and environment backgrounds for each level. These graphics can be found from the code bundle named <code class="literal">box2d_final_game</code>. The following screenshot shows the graphics that we need in this section:<div><img src="img/B04290_09_16.jpg" alt="Time for action – decorating the game and adding a fuel limitation"/></div></li><li class="listitem">Open the <code class="literal">index.html</code> file and replace the canvas element with the following markup. This creates two more game components named <code class="literal">current level</code> and <code class="literal">fuel</code> <code class="literal">remaining</code>, and it groups the game components into a <code class="literal">game-container</code> DIV:<div><pre class="programlisting">&lt;section id="game-container"&gt;
    &lt;canvas id="game" width='1300' height='600' class="startscreen"&gt;&lt;/canvas&gt;
   
   &lt;div id="fuel" class="progressbar"&gt;
      &lt;div class="fuel-value" style="width: 100%;"&gt;&lt;/div&gt;
   &lt;/div&gt;
   
   &lt;div id="level"&gt;&lt;/div&gt;
&lt;/section&gt;</pre></div></li><li class="listitem">Next, we will<a id="id930" class="indexterm"/> copy the <code class="literal">cargame.css</code> file from the code bundle. This contains several class-style definitions for the game. The game should look similar to the one shown in the following screenshot after we have applied the new stylesheet:<div><img src="img/B04290_09_17.jpg" alt="Time for action – decorating the game and adding a fuel limitation"/></div></li><li class="listitem">Now, we will move on to the JavaScript part. Open the <code class="literal">html5games.box2dcargame.js</code> file.</li><li class="listitem">Update the <code class="literal">carGame</code> object declaration with the following additional variable:<div><pre class="programlisting">var carGame = {
   // game state constant
   STATE_STARTING_SCREEN : 1,
   STATE_PLAYING : 2,
   STATE_GAMEOVER_SCREEN : 3,
   
   state : 0,
   
   fuel: 0,
   fuelMax: 0,

   currentLevel: 0
}</pre></div></li><li class="listitem">Now, we have the <a id="id931" class="indexterm"/>starting screen. Instead of starting the game once, the page is loaded. We'll display the starting screen and wait for the player to click on the game canvas. Add the following logic to the <code class="literal">initGame</code> function:<div><pre class="programlisting">// set the game state as "starting screen"
carGame.state = carGame.STATE_STARTING_SCREEN;

// start the game when clicking anywhere in starting screen
$('#game').click(function(){
   if (carGame.state === carGame.STATE_STARTING_SCREEN) {
      // change the state to playing.
      carGame.state = carGame.STATE_PLAYING;

      // start new game
      restartGame(carGame.currentLevel);
   }
});</pre></div></li><li class="listitem">Next, we need to handle the game-winning screen when the player passes all levels. In the winning flag-collision-checking logic, we use the following logic to determine if we show the next level or the ending screen. Find the <code class="literal">console.log("Level Passed!");</code> code in the file and replace the <code class="literal">restartGame</code> function call with the following code:<div><pre class="programlisting">if (cn.IsTouching()) {
  console.log("Level Passed!");

  if (carGame.currentLevel &lt; carGame.levels.length - 1) {
    restartGame(carGame.currentLevel+1);
  } else {
    // show game over screen
    $('#game').removeClass().addClass('gamebg_won');

    // clear the physics world
    carGame.world = createWorld();
  }
}</pre></div></li><li class="listitem">Then, we will handle the game playing background. We prepared each game background for each level setting. We will switch the background in the <code class="literal">restartGame</code> function, which corresponds to reconstructing the world:<div><pre class="programlisting">$("#level").html("Level " + (level+1));

// change the background image to fit the level
$('#game').removeClass().addClass('gamebg-level'+level);</pre></div></li><li class="listitem">With the game graphics now, we do not need the physics object outline drawing any more. We can turn off the debug drawing by setting the <code class="literal">shouldDrawDebug</code> object to <code class="literal">false</code>:<div><pre class="programlisting">var shouldDrawDebug = false;</pre></div></li><li class="listitem">Finally, let's <a id="id932" class="indexterm"/>add some constraints. Remember that in our level data, we include a mystery fuel data for the car. This is an indicator of how much fuel the car contains. We will use this fuel to limit the player's input. The fuel reduces each time a force is applied to the car. The player cannot apply any additional force once the fuel runs out. This limitation makes the game more fun to play.</li><li class="listitem">Update the arrow keys' <code class="literal">keydown</code> function with the following logic. The new code is highlighted here:<div><pre class="programlisting">switch(e.keyCode) {
  case 39: // right arrow key to apply force towards right
    if (carGame.fuel &gt; 0) {
      var force = new b2Vec2(300, 0);
      carGame.car.ApplyForce(force, carGame.car.GetWorldCenter());
      <strong>carGame.fuel -= 1;</strong>
      <strong>$(".fuel-value").width(carGame.fuel/carGame.fuelMax * 100 +'%');</strong>
    }
    return false;
    break;
  case 37: // left arrow key to apply force towards left
    if (carGame.fuel &gt; 0) {
      var force = new b2Vec2(-300, 0);
      carGame.car.ApplyForce(force, carGame.car.GetWorldCenter());
      <strong>carGame.fuel -= 1;</strong>
      <strong>$(".fuel-value").width(carGame.fuel/carGame.fuelMax * 100 +'%');</strong>
    }
    return false;
    break;
  case 82: // r key to restart the game
    restartGame(carGame.currentLevel);
    break;
}</pre></div></li><li class="listitem">In addition, in the <a id="id933" class="indexterm"/>car-creating logic in the restart game function, we initialize the fuel as follows:<div><pre class="programlisting">// create car
if (obj.type === "car") {
   carGame.car = createCarAt(obj.x,obj.y);
<strong>   carGame.fuel = obj.fuel;</strong>
<strong>   carGame.fuelMax = obj.fuel;</strong>
<strong>   $(".fuel-value").width('100%');</strong>
   continue;
}</pre></div></li><li class="listitem">Now, run the game in a browser. We should get five graphic levels. The following screenshot shows how the last four levels look:<div><img src="img/B04290_09_18.jpg" alt="Time for action – decorating the game and adding a fuel limitation"/></div></li><li class="listitem">After passing all the levels, we will get the following winning screen:<div><img src="img/B04290_09_19.jpg" alt="Time for action – decorating the game and adding a fuel limitation"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec274"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just decorated our<a id="id934" class="indexterm"/> game with more graphics. We also drew each level environment, a background image. The following screenshot illustrates how the visual ground represents the logical physics boxes. Unlike the car and the winning flag, the ground graphics are not associated with the physics ground. This is just a background image with the graphics in their respective positions. We can use this approach because those logical boxes will never move:</p><div><img src="img/B04290_09_20.jpg" alt="What just happened?"/></div><p>We can then prepare several CSS styles for each level with the level number in the class name, such as <code class="literal">.gamebg-level1</code> and <code class="literal">.gamebg-level2</code>. With each class linked with each level background, we can change the background when switching a level using the following code:</p><div><pre class="programlisting">$('#game').removeClass().addClassddClass('gamebg-level'+level);</pre></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec275"/>Adding fuel to add a constraint when applying force</h2></div></div></div><p>Now, we limit the <a id="id935" class="indexterm"/>player's input by providing limited fuel to use. The fuel decreases when players apply force to the car. We used the following <code class="literal">keydown</code> logic to decrease the fuel and prevent additional force when the car is running out of fuel:</p><div><pre class="programlisting">case 39: 
  if (carGame.fuel &gt; 0) {
    var force = new b2Vec2(300, 0);
    carGame.car.ApplyForce(force, carGame.car.GetCenterPosition());
    carGame.fuel -= 1;
    $(".fuel-value").width(carGame.fuel/carGame.fuelMax * 100 +'%');
  }</pre></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec276"/>Presenting the remaining fuel in a CSS3 progress bar</h2></div></div></div><p>In our game, we present the <a id="id936" class="indexterm"/>remaining fuel as a progress bar. The progress bar is actually a DIV inside another DIV. The following markup shows the structure of the progress bar. The outer DIV defines the maximum value and the inner DIV shows the actual value:</p><div><pre class="programlisting">&lt;div id="fuel" class="progressbar"&gt;
   &lt;div class="fuel-value" style="width: 100%;"&gt;&lt;/div&gt;
&lt;/div&gt;</pre></div><p>The following screenshot illustrates the structure of the progress bar:</p><div><img src="img/B04290_09_15.jpg" alt="Presenting the remaining fuel in a CSS3 progress bar"/></div><p>With this structure, we can show specific progress by setting the width as a percentage value. We use the following code to update the progress bar according to the percentage of the fuel:</p><div><pre class="programlisting">$(".fuel-value").width(carGame.fuel/carGame.fuelMax * 100 +'%');</pre></div><p>This is the basic logic to set up a progress bar and control it with the width style.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec139"/>Adding touch support for tablets</h1></div></div></div><p>We added touch support in <a class="link" href="ch06.html" title="Chapter 6. Adding Sound Effects to Your Games">Chapter 6</a>, <em>Adding Sound Effects to Your Games</em>. In this game, we will add<a id="id937" class="indexterm"/> touch support to make it playable on <a id="id938" class="indexterm"/>tablets.</p></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec140"/>Time for action – adding touch support</h1></div></div></div><p>Carry out the following steps to make our game work in a tablet with touch inputs:</p><div><ol class="orderedlist arabic"><li class="listitem">In <code class="literal">index.html</code> file, we add the following touch controls before the end of the <code class="literal">#game-container</code>:<div><pre class="programlisting">&lt;div id="left-button" class="touch-control"&gt;&lt;/div&gt;
&lt;div id="right-button" class="touch-control"&gt;&lt;/div&gt;
&lt;div id="restart-button" class="touch-control"&gt;Restart&lt;/div&gt;</pre></div></li><li class="listitem">We can also add a <code class="literal">&lt;meta&gt;</code> tag inside the <code class="literal">&lt;head&gt;</code> tag to control the viewport to fit the game into the iPad's 1024 px width.<div><pre class="programlisting">&lt;meta name="viewport" content="width=device-width, initial-scale=0.78, minimum-scale=0.78, maximum-scale=0.78"&gt;</pre></div></li><li class="listitem">For these controls, we add some basic styles to position them. To do this, append the following code to the <code class="literal">cargame.css</code> file:<div><pre class="programlisting">.touch-control {
  position: absolute;
}
#left-button {
  top: 0;
  left: 0;
  width: 50%;
  height: 100%;
}
#right-button {
  top: 0;
  right: 0;
  width: 50%;
  height: 100%;
}
#restart-button {
  top: 0;
  left: 50%;
  left: calc( 50% - 50px );
  width: 100px;
  height: 50px;
  text-align: center;
  line-height: 50px;
}</pre></div></li><li class="listitem">Now, we <a id="id939" class="indexterm"/>move to the <code class="literal">box2dcargame.js</code> file, and <a id="id940" class="indexterm"/>we add a function named <code class="literal">handleTouchInputs()</code>:<div><pre class="programlisting">function handleTouchInputs() {
  // Touch support
  if (!window.Touch) {
    $('.touch-control').hide();
  } else {
    $('#right-button').bind('touchstart', function(){
      if (carGame.state === carGame.STATE_STARTING_SCREEN) {
        // change the state to playing.
        carGame.state = carGame.STATE_PLAYING;

        // start new game
        restartGame(carGame.currentLevel);
      } else {
        carGame.isRightButtonActive = true;
      }
    });
    $('#left-button').bind('touchstart', function(){
      if (carGame.state === carGame.STATE_STARTING_SCREEN) {
        // change the state to playing.
        carGame.state = carGame.STATE_PLAYING;

        // start new game
        restartGame(carGame.currentLevel);
      } else {
        carGame.isLeftButtonActive = true;
      }
    });
    $('#right-button').bind('touchend', function() {
      carGame.isRightButtonActive = false;
    });
    $('#left-button').bind('touchend', function() {
      carGame.isLeftButtonActive = false;
    });
    $('#restart-button').bind('touchstart', function(){
      restartGame(carGame.currentLevel);
    })
  }
}</pre></div></li><li class="listitem">We call our <code class="literal">handleTouchInputs</code> function within the <code class="literal">initGame</code> function:<div><pre class="programlisting">handleTouchInputs();</pre></div></li><li class="listitem">We apply the force continuously until the touch up event. We can slightly adjust the value to fit the tablet. To do this, add the following code at the end of the existing <code class="literal">updateWorld</code> function:<div><pre class="programlisting">// apply force based on the touch event
if (carGame.isRightButtonActive) {
  if (carGame.fuel &gt; 0) {
    var force = new b2Vec2(50, 0);
    carGame.car.ApplyForce(force, carGame.car.GetWorldCenter());
    carGame.fuel -= 0.1;
    $(".fuel-value").width(carGame.fuel/carGame.fuelMax * 100 +'%');
  }
} else if (carGame.isLeftButtonActive) {
  if (carGame.fuel &gt; 0) {
    var force = new b2Vec2(-50, 0);
    carGame.car.ApplyForce(force, carGame.car.GetWorldCenter());
    carGame.fuel -= 0.1;
    $(".fuel-value").width(carGame.fuel/carGame.fuelMax * 100 +'%');
  }
}</pre></div></li><li class="listitem">Save all the files and run the game in a tablet, say an iPad or an Android, and we should be able to control the car by pressing the left and right sides of the game. We can also restart the level by pressing the restart button.</li></ol></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec277"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just added <a id="id941" class="indexterm"/>touch support to our game to make it playable on a<a id="id942" class="indexterm"/> tablet. We created two touch areas for the left and right force. We also created a restart button that's only viewable on touch devices:</p><div><img src="img/B04290_09_14.jpg" alt="What just happened?"/></div><p>We listen to<a id="id943" class="indexterm"/> the <code class="literal">touchstart</code> and <code class="literal">touchend</code> event on these <a id="id944" class="indexterm"/>buttons. The <code class="literal">touchstart</code> event is not like the <code class="literal">keydown</code> event that keeps firing the events. We need a Boolean to know whether the touch has started and keep a track until it ends. During touch pressing, we apply the forces in the <code class="literal">updateWorld</code> method. The frequency is different, so we adjusted the value of force and fuel consumption to make it work better in tablets.</p><div><div><div><div><h3 class="title"><a id="ch09lvl3sec06"/>Controlling the viewport scale</h3></div></div></div><p>When designing <a id="id945" class="indexterm"/>mobile web pages, we often use viewport to tell the browser to use the device width as the web page's view port width:</p><div><pre class="programlisting">&lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;</pre></div><p>In games, especially games that require tapping frequently, we may want to fix the zooming feature by setting the same value to the minimum scale and the maximum scale. Moreover, we can control the scale value to zoom the game to fit the tablet devices.</p><div><pre class="programlisting">&lt;meta name="viewport" content="width=device-width, initial-scale=0.78, minimum-scale=0.78, maximum-scale=0.78"&gt;</pre></div></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec07"/>Touch-specific buttons</h3></div></div></div><p>There is no keyboard on<a id="id946" class="indexterm"/> tablet and mobile devices. We have to create on-screen inputs for these devices. We created three on-screen buttons in this game example: left, right and restart buttons. We hid these buttons in the desktop by checking the availability of <code class="literal">window.Touch</code>:</p><div><pre class="programlisting">if (!window.Touch) {
  $('.touch-control').hide();
}</pre></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec141"/>Summary</h1></div></div></div><p>You learned a lot in this chapter about using the Box2D physics engine to create a car adventure game in canvas.</p><p>Specifically, we set up the game with the JavaScript physics engine. Then, we created static and dynamic bodies in the physics world. We set up the car by using joints to constrain bodies and wheels. We controlled the car with keyboard inputs by adding force to it. At last, we determined game-over and level-up by adding collisions in the physics world. We have now learned how to use the Box2D physics library to create a canvas-based physics game.</p><p>In the next chapter, we are going to discuss different distribution channels and put our game into a native Mac application.</p></div></body></html>