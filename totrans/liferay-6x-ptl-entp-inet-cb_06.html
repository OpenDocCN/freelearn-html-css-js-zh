<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Documents and Media in Liferay</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem">Managing files in Liferay using the Documents and Media portlet</li><li class="listitem">Managing document types and metadata sets</li><li class="listitem">Integration with the Amazon S3 cloud</li><li class="listitem">Data migration between storage hooks</li></ul></div><div><div><div><div><h1 class="title"><a id="ch06lvl1sec44"/>Introduction</h1></div></div></div><p>The primary task of any intranet is to allow efficient exchange of information between the employees of a company. In most cases, business knowledge is stored in the form of files and—if the company does not have a dedicated system—distributed between mailboxes, network drives, FTP servers, employees' computer drives, and external data carriers. In such cases, there is often a problem in determining who has the current version of the file, whether such documents exist at all, or where to find them. Liferay helps in coping with the dispersal of information by providing an internal repository of files.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec45"/>Managing files in Liferay using the Documents and Media portlet</h1></div></div></div><p>Each site in Liferay has its<a id="id301" class="indexterm"/> own separate repository, <a id="id302" class="indexterm"/>accessible by going to <strong>Admin</strong> | <strong>Site Administration</strong> | <strong>Content</strong> | <strong>Documents and Media</strong>. In addition, it is also possible to place the Documents and Media portlet on one of the pages where it can be shared between users who do not have access to the admin functionalities. The Documents and Media portlet allow us to manage all the folders and documents that can be published within a site.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec123"/>How to do it…</h2></div></div></div><p>The <a id="id303" class="indexterm"/>Documents and Media portlet provides tools to<a id="id304" class="indexterm"/> create, edit, and delete folders, documents, and shortcuts. It also enables us to create multiple documents by uploading whole groups of files. This recipe will cover all the basic actions that can be performed in order to create an efficient and easy-to-search structure of documents and folders.</p><div><div><div><div><h3 class="title"><a id="ch06lvl3sec36"/>Creating a new folder</h3></div></div></div><p>To add a new folder, perform <a id="id305" class="indexterm"/>the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Log in as an administrator and go to <strong>Admin</strong> | <strong>Site Administration</strong> | <strong>Content</strong> | <strong>Documents and Media</strong>.</li><li class="listitem">Click on the <strong>Add</strong> button.</li><li class="listitem">Select the <strong>Folder</strong> or <strong>Subfolder</strong> option.<div><img src="img/image00330.jpeg" alt="Creating a new folder"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Enter the <strong>Name (Required)</strong> of the folder.</li><li class="listitem">Enter the <strong>Description</strong> of the folder.</li><li class="listitem">Determine the <strong>Permissions</strong> for the folder by setting all actions that may be performed by<a id="id306" class="indexterm"/> specific roles (you can find more permissions after clicking on the <strong>More options</strong> link).</li><li class="listitem">Click on the <strong>Save</strong> button.</li></ol><div></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec37"/>Editing a folder</h3></div></div></div><p>To edit a folder, perform these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Log in as an <a id="id307" class="indexterm"/>administrator and go to <strong>Admin</strong> | <strong>Site Administration</strong> | <strong>Content</strong> | <strong>Documents and Media</strong>.</li><li class="listitem">Go to the folder you want to edit.</li><li class="listitem">Click on its actions icon (the down arrow icon visible when hovering on the folder miniature).<div><img src="img/image00331.jpeg" alt="Editing a folder"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on the <strong>Edit</strong> button.</li><li class="listitem">Provide a new <strong>Name</strong> for the folder.</li><li class="listitem">Enter a new <strong>Description</strong> of the folder.</li><li class="listitem">Determine the way in which document type restrictions and wokflow definition settings work for this particular folder. You can do this by setting <strong>Use document type restrictions and workflow of the parent folder</strong> by going to the <strong>Document Type Restrictions and Workflow</strong> option.</li><li class="listitem">Click on the<a id="id308" class="indexterm"/> <strong>Save</strong> button.</li></ol><div></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec38"/>Adding a new document</h3></div></div></div><p>To add a<a id="id309" class="indexterm"/> new document, perform these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Log in as an administrator and go to <strong>Admin</strong> | <strong>Site Administration</strong> | <strong>Content</strong> | <strong>Documents and Media</strong>.</li><li class="listitem">Click on the <strong>Add</strong> button.</li><li class="listitem">Select the appropriate document type, for example, Basic Document.<div><img src="img/image00332.jpeg" alt="Adding a new document"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on the<a id="id310" class="indexterm"/> <strong>Select File</strong> button and choose a file from your drive to be added to the repository.</li><li class="listitem">Enter the <strong>Title</strong> of the document (if you do not provide a title, the filename will be used as the title).</li><li class="listitem">Enter the <strong>Description</strong> of the document.</li><li class="listitem">Expand the <strong>Categorization</strong> section.</li><li class="listitem">Select <strong>Categories</strong> and type or select <strong>Tags</strong> that describe the document.<p>If there are no visible categories that can be assigned to the document, it means that either the categories for the specific site have not been created or the account of the user who is working on it does not have access to the existing dictionaries category.</p></li><li class="listitem">Determine <a id="id311" class="indexterm"/>the permissions for the document by setting all actions that may be performed by specific roles.</li><li class="listitem">Click on the <strong>Related Assets</strong> button, and find and choose documents (or other content types) that will be set as related content.</li><li class="listitem">Click on the <strong>Publish</strong> button.</li></ol><div></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec39"/>Uploading multiple documents</h3></div></div></div><p>It is also possible to add more <a id="id312" class="indexterm"/>than one document and set metadata for multiple documents at a time.</p><p>To add multiple documents, go to the <strong>Documents and Media</strong> section. Then, follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Log in as an administrator and go to <strong>Admin</strong> | <strong>Site Administration</strong> | <strong>Content</strong> | <strong>Documents and Media</strong>.</li><li class="listitem">Click on the <strong>Add</strong> button.</li><li class="listitem">Select the <strong>Multiple Documents</strong> option.</li><li class="listitem">Click on the <strong>Select Files</strong> button and choose all the files you want to upload.<div><h3 class="title"><a id="note23"/>Note</h3><p>It is also possible to choose the group of files that should be uploaded using drag-and-drop.</p></div></li><li class="listitem">After uploading all the files, mark the checkboxes next to the names of files that will have the same type, set of tags and categories, and permissions:<div><img src="img/image00333.jpeg" alt="Uploading multiple documents"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Enter the<a id="id313" class="indexterm"/> description, choose a document type, and define categories, tags, and permissions for these documents.</li><li class="listitem">Click on the <strong>Save</strong> button.</li><li class="listitem">Repeat steps 6 and 7 until all the uploaded files are saved.</li></ol><div></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec40"/>Editing documents</h3></div></div></div><p>To edit a <a id="id314" class="indexterm"/>document, perform these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Log in as an administrator and go to <strong>Admin</strong> | <strong>Site Administration</strong> | <strong>Content</strong> | <strong>Documents and Media</strong>.</li><li class="listitem">Go to the document you want to edit.</li><li class="listitem">Click on its actions icon:<div><img src="img/image00334.jpeg" alt="Editing documents"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click <a id="id315" class="indexterm"/>on the <strong>Edit</strong> button.</li><li class="listitem">Provide a new <strong>Title</strong> and <strong>Description</strong>, choose <strong>Document Type</strong>, define <strong>Categories</strong> and <strong>Tags</strong>, and choose <strong>Related Content</strong> for the edited document.</li><li class="listitem">Click on the <strong>Publish</strong> button.</li></ol><div></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec41"/>Removing folders and documents</h3></div></div></div><p>Each folder and <a id="id316" class="indexterm"/>document can be temporarily or <a id="id317" class="indexterm"/>permanently removed from the repository. Both temporary and permanent removal are done through the <em>Recycle Bin</em> mechanism.</p><p>To temporarily remove a folder or document, perform these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Go to the folder or document you want to delete.</li><li class="listitem">Click on its actions icon.</li><li class="listitem">Click on the <strong>Move to the Recycle Bin</strong> action.<div><h3 class="title"><a id="tip11"/>Tip</h3><p>You can undo this action by clicking on the undo button that will appear just after moving a document to the trash. By default, trash is enabled and keeps removed items for 30 days. The trash availability for the particular site and the maximum age of trash entries can be changed by going to <strong>Admin</strong> | <strong>Site Administration</strong> | <strong>Configurations</strong> | <strong>Site Settings</strong> | <strong>Recycle Bin</strong>.</p></div></li></ol><div></div><p>To permanently remove a folder or document, follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Go to <strong>Admin</strong> | <strong>Site Administration</strong> | <strong>Content</strong> | <strong>Recycle Bin</strong>.</li><li class="listitem">Click on the <strong>Actions</strong> button located near the name of the document you want to delete:<div><img src="img/image00335.jpeg" alt="Removing folders and documents"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on the <a id="id318" class="indexterm"/><strong>Delete</strong> action and <a id="id319" class="indexterm"/>confirm your wish by clicking on <strong>Ok</strong>.</li></ol><div></div><div><h3 class="title"><a id="note24"/>Note</h3><p>Note that when removing a folder, its whole content is also removed.</p><p>It is also possible to restore a document using the <strong>Restore</strong> action available in the <strong>Actions</strong> menu.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec124"/>How it works…</h2></div></div></div><p>Liferay's documents and media <a id="id320" class="indexterm"/>library allows us to create a tree-like structure of folders and documents. This means that each folder can contain subfolders and documents. Each document in Liferay Portal consists of a file and a set of metadata describing it.</p><p>Liferay provides many properties to configure the Documents and Media portlet. They are localized in the <code class="literal">portal-impl/src/portal.properties</code> file, which can be overridden by <code class="literal">portal-ext.properties</code> located in the <code class="literal">${liferay.home}</code> folder. One of the properties is to deny names of files or folders, regardless of the extension:</p><div><pre class="programlisting">dl.name.blacklist=con,prn,aux,nul,com1,com2,com3,com4,com5,com6,com7,com8,com9,lpt1,lpt2,lpt3,lpt4,lpt5,lpt6,lpt7,lpt8,lpt9</pre></div><p>It is also possible to define the extension's restriction and permit the addition only of defined extensions (by default, this property permits all file extensions). To reduce or add available extensions, set the following property:</p><div><pre class="programlisting">dl.file.extensions=.bmp,.css,.doc,.docx,.dot,.gif,.gz,.htm,.html,.jpg,.js,.lar,.odb,.odf,.odg,.odp,.ods,.odt,.pdf,.png,.ppt,.pptx,.rtf,.swf,.sxc,.sxi,.sxw,.tar,.tiff,.tgz,.txt,.vsd,.xls,.xlsx,.xml,.zip,.jrxml</pre></div><p>The next important and useful property is the definition of the maximum size of files. By default, it is unlimited. To change it, define how many bytes are allowed:</p><div><pre class="programlisting">dl.file.max.size=3072000</pre></div><p>The Liferay search indexer <a id="id321" class="indexterm"/>tries to index the content of the file. It is possible to define which types of extensions should be ignored. You can also define the size for indexing files:</p><div><pre class="programlisting">dl.file.indexing.ignore.extensions=.exe,.sh,.pdf
dl.file.indexing.max.size=10485760</pre></div><p>More settings are available in <code class="literal">portal-impl/src/portal.properties</code> in the Document Library portlet section.</p><div><div><div><div><h3 class="title"><a id="ch06lvl3sec42"/>Types of documents</h3></div></div></div><p>There are five default types of <a id="id322" class="indexterm"/>documents: Basic Document, Contract, Marketing Banner, Online Training, and Sales Presentation. Each type of document may contain a different set of metadata. For instance, when adding a new contract, the user can provide data such as effective date, expiration date, contract type, legal reviewer, status, and so on. The Basic Document contains only the basic information, such as name, description, tags, categories and permissions.</p><p>Very often, these default document types or metadata sets provided by Liferay are not sufficient. It is required to compose personalized types of documents containing very specific metadata information. This can be achieved using the Document Types and Metadata Sets that create tools, as described in the following recipe.</p><p>It is possible to restrict folders to contain documents of one or more particular types. The document type restrictions can be set separately for each folder or inherited from parent folders.</p></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec43"/>Permissions</h3></div></div></div><p>Each folder and document has its own permissions<a id="id323" class="indexterm"/> set, which defines the list of actions that can be performed on it by users assigned to different roles. For example, it is possible to set such permissions so that users with a specific role will have access to a specific folder, but will not see some of the files stored there.</p><div><h3 class="title"><a id="note25"/>Note</h3><p>For more information on permissions, refer to <a class="link" title="Chapter 5. Roles and Permissions" href="part0045.xhtml#aid-1AT9A1">Chapter 5</a>, <em>Roles and Permissions</em>.</p></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec44"/>Categories and tags</h3></div></div></div><p>If an intranet groups a very large number of documents, a well-designed structure cannot sufficiently help users get to the correct documents. Categories<a id="id324" class="indexterm"/> and tags<a id="id325" class="indexterm"/> provide an additional mechanism to mark, list, and search files and allow their subsequent selection with the help of dedicated portlets, such as Category Navigation, Asset Publisher, or Tag Cloud. Categories as well as documents can create a tree-like structure. Each category is placed in the dictionary and can have subcategories. Tags, on the contrary, are not stored in dictionaries and create a flat structure. It is possible to assign one or more categories and tags to a document.</p></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec45"/>Related assets</h3></div></div></div><p>In Liferay, an asset is a piece <a id="id326" class="indexterm"/>of content that can be shown on a page, such as a document, web content, blog entry, and so on. Each document can be connected to another document (or other types of assets). These documents will be listed by portlets, such as the Asset Publisher.</p></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec46"/>Additional information</h3></div></div></div><p>Let's understand in detail how Liferay <a id="id327" class="indexterm"/>stores files with the default configuration. First of all, the system reads a file's metadata, such as extension, title, size. Next, it recognizes the mime type of a file (<code class="literal">image/png</code>, <code class="literal">audio/mpeg</code>, <code class="literal">application/pdf</code>, and so on). This setting depends on the file's extension. The next thing that the portlet does is create a version. By default, the first uploaded file has the version 1.0. Liferay also recognizes in which folder and in which repository a file is added. All of this information is stored in the <code class="literal">DLFileEntry</code> table. This type of data is called metadata.</p><p>By default, physically each file is stored on a local hard drive in the <code class="literal">${liferay.home}/data/document_library</code> folder. A hierarchy of the folders is very specific. It is difficult to recognize where each file is stored. Let's examine one of the paths to the file: <code class="literal">data/document_library/10157/11501/303/1.0</code>.</p><p>As we said earlier, each file is placed in the <code class="literal">data/document_library</code> folder. The next folder name is an <code class="literal">instanceId</code>, which can be set by going to <strong>Admin</strong> | <strong>Control Panel</strong> | <strong>Configuration</strong> | <strong>Portal Instances</strong>. The next identifier is <code class="literal">folderId</code>. It is good to know that this identifier is exactly a parent folder of this file. If the file is placed in the folder's hierarchy, it is the last folder's identifier. 303 is a number stored in the <code class="literal">DLFileEntry.name</code> column. Each file has only the version name. In this example, the name of the file is 1.0. In the real world, this is a PNG image. All the necessary data for this file, such as its name, is<a id="id328" class="indexterm"/> placed in the database.</p><div><h3 class="title"><a id="tip12"/>Tip</h3><p>Be careful and remember that a file entry consists of metadata stored in the database and bytes stored on the hard drive in the specific location.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec125"/>There's more…</h2></div></div></div><p>It is also possible for the <a id="id329" class="indexterm"/>user to create a shortcut to any document that they <a id="id330" class="indexterm"/>can access. The permissions set on the shortcut enable the user to access the original document through the shortcut.</p><p>In order to create a shortcut, use these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Log in as an administrator and go to <strong>Admin</strong> | <strong>Site Administration</strong> | <strong>Content</strong> | <strong>Documents and Media</strong>.</li><li class="listitem">Click on the <strong>Add</strong> button.</li><li class="listitem">Select the appropriate shortcut.<div><img src="img/image00336.jpeg" alt="There's more…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on the <strong>Site</strong> button and choose the site containing the document for which you want to create a shortcut.</li><li class="listitem">Click on the <strong>Document</strong> button and choose the document.</li><li class="listitem">Determine the <a id="id331" class="indexterm"/>permissions for the shortcut by setting all<a id="id332" class="indexterm"/> actions that may be performed by specific roles.</li><li class="listitem">Click on the <strong>Save</strong> button.</li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec126"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">For information on permissions, refer to the <em>Creating and configuring roles</em> recipe from <a class="link" title="Chapter 5. Roles and Permissions" href="part0045.xhtml#aid-1AT9A1">Chapter 5</a>, <em>Roles and Permissions</em></li><li class="listitem">The <em>Kaleo Web installation</em> recipe from <a class="link" title="Chapter 9. Liferay Workflow Capability" href="part0065.xhtml#aid-1TVKI1">Chapter 9</a>, <em>Liferay Workflow Capability</em></li><li class="listitem">For more information on categorizing documents, refer to the <em>Tagging and categorizing content</em> recipe from <a class="link" title="Chapter 8. Search and Content Presentation Tools" href="part0059.xhtml#aid-1O8H61">Chapter 8</a>, <em>Search and Content Presentation Tool</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec46"/>Managing document types and metadata sets</h1></div></div></div><p>As was mentioned in <a id="id333" class="indexterm"/>the previous recipe, each file, while provided with metadata, becomes <a id="id334" class="indexterm"/>a document. By default, each document consists of information, such as name, description, category, tags, permissions, or related assets. Very often, the basic set is not sufficient. In such cases, it may be necessary to create a new document type, which allows us to provide a file with specific additional information.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec127"/>How to do it…</h2></div></div></div><p>It this recipe, we will describe how to define different types of documents and teach how to compose and use metadata sets.</p><div><div><div><div><h3 class="title"><a id="ch06lvl3sec47"/>Creating a new document type using metadata sets</h3></div></div></div><p>To add a new<a id="id335" class="indexterm"/> document <a id="id336" class="indexterm"/>type, perform these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Log in as an administrator and go to <strong>Admin</strong> | <strong>Site Administration</strong> | <strong>Content</strong> | <strong>Documents and Media</strong>.</li><li class="listitem">Click on the <strong>Manage</strong> button.</li><li class="listitem">Select the <strong>Document Types</strong> option.</li><li class="listitem">Click on the <strong>Add</strong> button.</li><li class="listitem">Enter the <strong>Name</strong> of the type of document.</li><li class="listitem">Enter a description of the type of document.</li><li class="listitem">Determine <strong>Metadata Fields</strong>, which will be available in this type of document, by dragging and dropping fields from the left column menu to the area on the right-hand side.</li><li class="listitem">Set all the added <a id="id337" class="indexterm"/>fields by clicking<a id="id338" class="indexterm"/> on each field and defining its properties (<strong>Field Label</strong>, <strong>Show Label</strong>, <strong>Required</strong>, <strong>Name</strong>, <strong>Predefined Value</strong>, <strong>Tip</strong>, <strong>Indexable</strong>, <strong>Repeatable</strong>, <strong>Options</strong>, and <strong>Multiple</strong>).<div><img src="img/image00337.jpeg" alt="Creating a new document type using metadata sets"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on <a id="id339" class="indexterm"/><strong>Select Additional Metadata Set</strong> and choose one<a id="id340" class="indexterm"/> of the available metadata sets (see the next section of this recipe to understand how to work with metadata sets).</li><li class="listitem">Determine the permissions for the document type by setting all actions that may be performed by specific roles.</li><li class="listitem">Click on the <strong>Save</strong> button.</li></ol><div></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec48"/>Defining metadata sets</h3></div></div></div><p>To define a new <a id="id341" class="indexterm"/>metadata set, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Log in as an administrator and go to <strong>Site Administration</strong> | <strong>Content</strong> | <strong>Documents and Media</strong>.</li><li class="listitem">Click on the <strong>Manage</strong> button.</li><li class="listitem">Select the <strong>Metadata Sets</strong> option.</li><li class="listitem">Click on the <strong>Add</strong> button.<div><img src="img/image00338.jpeg" alt="Defining metadata sets"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Enter the <strong>Name (Required)</strong> of the metadata set.</li><li class="listitem">Enter the <strong>Description</strong> of the metadata set.</li><li class="listitem">Choose <strong>Parent Metadata Set</strong>.</li><li class="listitem">Determine <strong>Metadata Fields</strong>, which will be available in this type of document.</li><li class="listitem">Click on the <strong>Save</strong> button.</li></ol><div></div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec128"/>How it works…</h2></div></div></div><p>When defining a<a id="id342" class="indexterm"/> new type of document, we not only define the scope of <a id="id343" class="indexterm"/>information that is stored with the file, but also compose a form that allows us to enter the information. Both document type forms and the metadata set form can be composed using a simple form editor. This editor contains a small library of different form fields, such as <strong>Boolean</strong>, <strong>Date</strong>, <strong>Decimal</strong>, <strong>Documents and Media</strong>, <strong>HTML</strong>, <strong>Integer</strong>, <strong>Link to Page</strong>, <strong>Number</strong>, <strong>Radio</strong>, <strong>Select</strong>, <strong>Text</strong>, and <strong>Text Box</strong>. It is worth noticing that it is also possible to create groups of fields by dragging and dropping one field (or more) onto another.</p><p>When defining a new type of document, we have to decide whether the set of fields we want to include will be used in this particular document only or with different document types. In the first case, we can compose the form directly within the new document type. In the second case, it is better to create a metadata set that can be used as a part of many document types, but is managed in one place. Similarly as in case of Liferay assets, metadata sets may be created and used in one particular scope only or, when created in global scope, may be used in all scopes within one Liferay Portal instance.</p><p>Additionally, metadata sets<a id="id344" class="indexterm"/> can inherit a set of fields from other metadata sets.</p><p>Fields can be<a id="id345" class="indexterm"/> defined by the <a id="id346" class="indexterm"/>following properties:</p><div><table border="1"><colgroup><col/><col/></colgroup><thead><tr><th valign="bottom">
<p>Type</p>
</th><th valign="bottom">
<p>Defines the type of the field</p>
</th></tr></thead><tbody><tr><td valign="top">
<p>Field Label</p>
</td><td valign="top">
<p>This allows us to provide a label for the field</p>
</td></tr><tr><td valign="top">
<p>Show Label</p>
</td><td valign="top">
<p>This lets you decide whether the label should be shown or not</p>
</td></tr><tr><td valign="top">
<p>Required</p>
</td><td valign="top">
<p>This lets you decide whether filling the field is necessary or optional</p>
</td></tr><tr><td valign="top">
<p>Name</p>
</td><td valign="top">
<p>This allows us to define the name of the field</p>
</td></tr><tr><td valign="top">
<p>Predefined Value</p>
</td><td valign="top">
<p>This allows us to define they value that will be shown by default before a user enters their own value</p>
</td></tr><tr><td valign="top">
<p>Tip</p>
</td><td valign="top">
<p>This lets you provide a short text, which will be shown as a tooltip for the field</p>
</td></tr><tr><td valign="top">
<p>Indexable</p>
</td><td valign="top">
<p>This lets you decide whether the content of the file should be indexed and searched</p>
</td></tr><tr><td valign="top">
<p>Repeatable</p>
</td><td valign="top">
<p>This allows us to determine whether the field can be repeated</p>
</td></tr><tr><td valign="top">
<p>Options</p>
</td><td valign="top">
<p>This lets you provide possible options for all the fields that allows users to choose options from a defined list</p>
</td></tr><tr><td valign="top">
<p>Multiple</p>
</td><td valign="top">
<p>This allows us to determine whether a user can choose more than one option</p>
</td></tr></tbody></table></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec129"/>See also</h2></div></div></div><p>For information on document management, refer to the <em>Managing files in Liferay using the Documents and Media portlet</em> recipe.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec47"/>Integration with the Amazon S3 cloud</h1></div></div></div><p>Liferay provides a <a id="id347" class="indexterm"/>built-in capability to communicate with the Amazon S3 cloud. This feature gives users a really powerful tool to store their documents in a cloud-based solution. The <strong>Amazon Simple Storage Service</strong> (<strong>Amazon S3</strong>) is a <a id="id348" class="indexterm"/>scalable, high-speed, low-cost, and web-based service designed for online backup and archiving of data such as documents, presentations, spreadsheets, pictures, photos, and so on. The greatest feature of the <strong>Amazon Storage</strong><a id="id349" class="indexterm"/> is the fact that it claims 99.99 percent availability of objects over a given year. Moreover, these services provide highly scalable storage that can be easily increased as data increases. The whole infrastructure has secure SSL data transfer and encryption. Amazon Simple Storage Service is a part of the bigger project called <strong>Amazon Web Services</strong><a id="id350" class="indexterm"/> (<a class="ulink" href="http://aws.amazon.com">http://aws.amazon.com</a>). This is a collection of many web services, such as computing cloud, storage cloud, databases, networking, and administration and security.</p><p>Liferay gives users a feature to store and manage documents in remote repositories. This type of repository can be Amazon S3. In order to allow communication between a portal and Amazon S3, Liferay uses <em>JetS3t toolkit</em>. It is an open source project based on Java. More details about this solution are available at <a class="ulink" href="http://www.jets3t.org/">http://www.jets3t.org/</a>. Technically, it is<a id="id351" class="indexterm"/> a <code class="literal">jets3t.jar</code> archive placed in the <code class="literal">ROOT/WEB-INF/lib/</code> folder of the deployed Liferay instance.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec130"/>How to do it…</h2></div></div></div><p>Communication between Liferay and Amazon S3 works with Amazon S3 API. In order to properly configure this access, you need to have three things: access key, secret key, and bucket name. To generate this data (access key, secret key, and bucket name), follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Log in to the <a id="id352" class="indexterm"/>Amazon Web Service console: <a class="ulink" href="https://console.aws.amazon.com">https://console.aws.amazon.com</a>.</li><li class="listitem">Go to <strong>Your Name</strong> | <strong>Security Credentials</strong> on the dockbar.</li><li class="listitem">Expand <strong>Access Keys</strong> (access key ID and secret access key).</li><li class="listitem">Click on the <strong>Create New Access Key</strong> button.</li><li class="listitem">On the popup window, you will see the following message:<p>
<strong>Your access key (access key ID and secret access key) has been created successfully.</strong>
</p><div><img src="img/image00339.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on<a id="id353" class="indexterm"/> <strong>Show Access Key</strong> and copy <strong>Access Key ID</strong> and <strong>Secret Access Key</strong>. This pair of keys will be used a little later.</li></ol><div></div><p>The next few steps are responsible for creating a new bucket, where Liferay will store its files:</p><div><ol class="orderedlist arabic"><li class="listitem">In <a class="ulink" href="https://console.aws.amazon.com">https://console.aws.amazon.com</a>, go to<a id="id354" class="indexterm"/> <strong>Services</strong> | <strong>S3</strong>.</li><li class="listitem">To create a new bucket, click on the <strong>Create Bucket</strong> button.<div><img src="img/image00340.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Fill in all required fields and save the form.</li><li class="listitem">Remember your bucket name.</li></ol><div></div><p>The last thing is Liferay Portal configuration. As we said in the beginning, Liferay provides a built-in capability to communicate with Amazon, so the configuration is not difficult. It is only a simple setting with <code class="literal">${liferay.home}/portal-ext.properties</code>:</p><div><pre class="programlisting">dl.store.impl=com.liferay.portlet.documentlibrary.store.S3Store
dl.store.s3.access.key=&lt;ACCESS KEY ID&gt;
dl.store.s3.secret.key=&lt;SECRET ACCESS KEY&gt;
dl.store.s3.bucket.name=&lt;BUCKET NAME&gt;</pre></div><p>Finally, restart<a id="id355" class="indexterm"/> your portal instance and try to upload a file in the Documents and Media portlet. From the user's point of view, it should not be any different with the upload action. In order to see the difference, you can log in to the S3 storage bucket to check out the uploaded file.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec131"/>How it works…</h2></div></div></div><p>The portal provides many configurable hooks to upload and put documents into various persistence systems. All of them are implemented as Liferay core functionalities. The basic and default persistence system is <code class="literal">FileSystemStore</code>, which keeps data in the local hard drive. Liferay provides other implementations, such as <code class="literal">AdvancedFileSystemStore</code>, <code class="literal">CMISStore</code>, <code class="literal">DBStore</code>, <code class="literal">JCRStore</code>, and <code class="literal">S3Store</code>. One of these types can be set in <code class="literal">portal-ext.properties</code>:</p><div><pre class="programlisting">dl.store.impl=com.liferay.portlet.documentlibrary.store.AdvancedFileSystemStore
dl.store.impl=com.liferay.portlet.documentlibrary.store.CMISStore
dl.store.impl=com.liferay.portlet.documentlibrary.store.DBStore
dl.store.impl=com.liferay.portlet.documentlibrary.store.FileSystemStore
dl.store.impl=com.liferay.portlet.documentlibrary.store.JCRStore
dl.store.impl=com.liferay.portlet.documentlibrary.store.S3Store</pre></div><p>The following description shows differences in storage implementation:</p><div><ul class="itemizedlist"><li class="listitem"><code class="literal">FileSystemStore</code>: This <a id="id356" class="indexterm"/>saves documents directly to the local filesystem.</li><li class="listitem"><code class="literal">AdvancedFileSystemStore</code>: Similar <a id="id357" class="indexterm"/>to <code class="literal">FileSystemStore</code>, but divides the data into buckets (folders), thus avoiding the many-files-in-one-directory limitation.</li><li class="listitem"><code class="literal">DBStore</code>: Keeps <a id="id358" class="indexterm"/>binary data in the database as blobs.</li><li class="listitem"><code class="literal">CMISStore</code>: <strong>Content Management Interoperability Services</strong> (<strong>CMIS</strong>) is a specification<a id="id359" class="indexterm"/> to improve the interoperability <a id="id360" class="indexterm"/>between <a id="id361" class="indexterm"/><strong>Enterprise Content Management</strong> (<strong>ECM</strong>) systems. Documents and Media allow users to connect to multiple third-party repositories that support CMIS 1.0 with <strong>AtomPub</strong><a id="id362" class="indexterm"/> and web service protocols. It is possible to integrate Liferay with many CMIS-compliant ECM vendors, such as SharePoint, Alfresco, Documentum, IBM FileNet, and so on.</li><li class="listitem"><code class="literal">JCRStore</code>: Implements<a id="id363" class="indexterm"/> content repository API for Java. The well-known implementation is <a id="id364" class="indexterm"/><strong>Apache Jackrabbit</strong>. So, if this hook is set, it is possible to keep binary data in the Apache Jackrabbit content repository.</li><li class="listitem"><code class="literal">S3Store</code>: Keeps data in the <a id="id365" class="indexterm"/>Amazon Simple Storage Service.</li></ul></div><p>Let's examine a code <a id="id366" class="indexterm"/>that is responsible for this integration. The <code class="literal">S3Store</code> class implements the <code class="literal">Store</code> interface. Thus, it provides all the necessary operations on files, for instance, <code class="literal">addFile</code>, <code class="literal">addDirectory</code>, <code class="literal">deleteFile</code>, <code class="literal">deleteDirectory</code>, and so on. In <code class="literal">portal-ext.properties</code>, we set the <code class="literal">dl.store.impl</code> property as the <code class="literal">S3Store</code> class.</p><p>Liferay uses the JetS3t toolkit to communicate with Amazon services. This toolkit is responsible for transferring files from/to Amazon Cloud.</p><p>In the Amazon S3 repository, the structure of the folders and files looks the same as in the local filesystem. The following screenshot shows an example of the folder hierarchy:</p><div><img src="img/image00341.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec132"/>There's more…</h2></div></div></div><p>Integration with Amazon S3 Cloud works perfectly if the document library repository is small. The problems occur when the number of concurrent users and number of files is huge. The problem is between <code class="literal">HttpClient</code> and S3 and their parallel communication (concurrent communication threads). It is possible to increase the number of connections by overriding <code class="literal">jets3t.properties</code>. To properly change it, put this file in the Tomcat classpath, for instance, in the <code class="literal">${CATALINA_BASE}/lib</code> folder. Afterwards, change the following properties and try to fit the values to your environment:</p><div><pre class="programlisting">s3service.internal-error-retry-max=10 (Liferay 6.0 and 6.1)
cloudfront-service.internal-error-retry-max=10 (Liferay 6.2)
threaded-service.max-thread-count=100
httpclient.retry-max=10
httpclient.connection-timeout-ms=90000
httpclient.socket-timeout-ms=90000
httpclient.max-connections=100</pre></div><p>The official <a id="id367" class="indexterm"/>documentation at <a class="ulink" href="https://jets3t.s3.amazonaws.com/toolkit/configuration.html">https://jets3t.s3.amazonaws.com/toolkit/configuration.html</a> describes<a id="id368" class="indexterm"/> the properties as follows:</p><div><table border="1"><colgroup><col/><col/></colgroup><thead><tr><th valign="bottom">
<p>Property name</p>
</th><th valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td valign="top">
<p>
<code class="literal">s3service.internal-error-retry-max</code>
</p>
</td><td valign="top">
<p>This refers to the<a id="id369" class="indexterm"/> maximum number of concurrent communication threads that will be started by the <code class="literal">ThreadedStorageService</code> / <code class="literal">SimpleThreadedStorageService</code> services for upload and download operations. This value should not be too high. Otherwise, you risk I/O errors due to bandwidth starvation when transferring many large files. <em>It works only with Liferay 6.0 and Liferay 6.1</em>.</p>
</td></tr><tr><td valign="top">
<p>
<code class="literal">cloudfront-service.internal-error-retry-max</code>
</p>
</td><td valign="top">
<p>This refers to the <a id="id370" class="indexterm"/>maximum number of retries that will be attempted when a CloudFront connection fails with an InternalServer error. To disable retries of InternalError failures, set this to 0. <em>It works only with Liferay 6.2</em>.</p>
</td></tr><tr><td valign="top">
<p>
<code class="literal">threaded-service.max-thread-count</code>
</p>
</td><td valign="top">
<p>This is the<a id="id371" class="indexterm"/> maximum number of concurrent communication threads that will be started by the <code class="literal">ThreadedStorageService</code> / <code class="literal">SimpleThreadedStorageService</code> services for upload and download operations. This value should not be too high. Otherwise, you risk I/O errors due to bandwidth starvation when transferring many large files.</p>
<p>The default value is <code class="literal">2</code>.</p>
<p>This value must not exceed the maximum number of HTTP connections available to JetS3t, as set by the <code class="literal">httpclient.max-connections</code> property.</p>
</td></tr><tr><td valign="top">
<p>
<code class="literal">httpclient.retry-max</code>
</p>
</td><td valign="top">
<p>This <a id="id372" class="indexterm"/>determines the number of times to retry connections when they fail with I/O errors. Set this to <code class="literal">0</code> to disable retries.</p>
<p>The default value is <code class="literal">5</code>.</p>
</td></tr><tr><td valign="top">
<p>
<code class="literal">httpclient.connection-timeout-ms</code>
</p>
</td><td valign="top">
<p>This <a id="id373" class="indexterm"/>determines the number of milliseconds to wait before a connection times out. <code class="literal">0</code> means infinity.</p>
<p>The default value is <code class="literal">60000</code>.</p>
</td></tr><tr><td valign="top">
<p>
<code class="literal">httpclient.socket-timeout-ms</code>
</p>
</td><td valign="top">
<p>This determines the<a id="id374" class="indexterm"/> number of milliseconds to wait before a socket connection times out. <code class="literal">0</code> means infinity.</p>
<p>The default value is <code class="literal">60000</code>.</p>
</td></tr><tr><td valign="top">
<p>
<code class="literal">httpclient.max-connections</code>
</p>
</td><td valign="top">
<p>This refers to the<a id="id375" class="indexterm"/> maximum number of simultaneous connections to be allowed globally.</p>
<p>The default value is <code class="literal">20</code>.</p>
<p>If you have a <a id="id376" class="indexterm"/>fast Internet connection, you can improve the performance of your S3 client by increasing this setting and the corresponding S3 Service properties, <code class="literal">s3service.max-thread-count</code> and <code class="literal">s3service.admin-max-thread-count</code>. However, be careful because, if you increase this value too much for your connection, you may exceed your available bandwidth and cause communication errors.</p>
</td></tr></tbody></table></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec133"/>See also</h2></div></div></div><p>For information on building scalable systems, refer to the <em>Scalable infrastructure</em> recipe in <a class="link" title="Chapter 12. Basic Performance Tuning" href="part0088.xhtml#aid-2JTHG1">Chapter 12</a>, <em>Basic Performance Tuning</em>.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec48"/>Data migration between storage hooks</h1></div></div></div><p>This recipe is dedicated to <a id="id377" class="indexterm"/>administrators who have to change from one<a id="id378" class="indexterm"/> store implementation to another for any reason. This example shows you how we can migrate binary files stored in the document library to other storage repositories. In our example, we will examine migration from S3Store (Amazon S3) to the local <code class="literal">FileSystemStore</code> repository hook.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec134"/>How to do it…</h2></div></div></div><p>Liferay has a built-in functionality to migrate documents between storage hooks. Let's assume that our Liferay instance is already started, and the library is connected to the Amazon S3 cloud. In order to migrate documents to the filesystem, go through the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Log in as an administrator to the Liferay instance.</li><li class="listitem">Go to <strong>Admin</strong> | <strong>Control Panel</strong>.</li><li class="listitem">Then go to <strong>Configuration</strong> | <strong>Server Administration</strong> | <strong>Data Migration</strong>.</li><li class="listitem">Scroll to the <strong>Migrate documents from one repository to another</strong> section.</li><li class="listitem">Select a new repository hook called <strong>com.liferay.portlet.documentlibrary.store.FileSystemStore</strong>.<div><img src="img/image00342.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on the <a id="id379" class="indexterm"/><strong>Execute</strong> button.</li><li class="listitem">Liferay temporarily<a id="id380" class="indexterm"/> changes the status to maintenance mode.</li><li class="listitem">Look into the <code class="literal">catalina.out</code> log and check the execution. The log file should look like this:<div><pre class="programlisting">DEBUG [liferay/convert_process-1][MaintenanceUtil:64] Please set dl.store.impl in your portal-ext.properties to use com.liferay.portlet.documentlibrary.store.FileSystemStore
[liferay/convert_process-1][ConvertProcess:47] Finished conversion for com.liferay.portal.convert.ConvertDocumentLibrary in 3010 ms</pre></div></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec135"/>How it works…</h2></div></div></div><p>Liferay provides powerful features to migrate data between store hooks. It is an important tool when our Liferay instance works and our project manager or product owner wants to change the storage system to another, such as Amazon S3 or even SharePoint. Moreover, it is possible to do it without your developers having to write custom scripts. This functionality is implemented in the <code class="literal">com.liferay.portal.convert.ConvertDocumentLibrary</code> class. The <code class="literal">doConvert</code> method invokes migration processes for the following files:</p><div><ul class="itemizedlist"><li class="listitem">Migrate images</li><li class="listitem">Migrate document libraries</li><li class="listitem">Migrate message board attachments</li><li class="listitem">Migrate wiki attachments</li></ul></div><p>In fact, these four methods call <em>Dynamic Query</em> to get all the file definitions placed in the database and physically copy them from one place to another. The structure of all the folders and files is mapped one by one.</p><div><h3 class="title"><a id="tip13"/>Tip</h3><p>Carefully study your logfile in order to make sure that all of the data is moved correctly.</p></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec136"/>See also</h2></div></div></div><p>For information on how to change a database engine, refer to the <em>Migrating content from one database to another database</em> recipe in <a class="link" title="Chapter 11. Quick Tricks and Advanced Knowledge" href="part0080.xhtml#aid-2C9D01">Chapter 11</a>, <em>Quick Tricks and Advanced Knowledge</em>.</p></div></div></body></html>