<html><head></head><body>
<div class="calibre1" id="_idContainer197">
<h1 class="chapternumber"><span class="kobospan" id="kobo.1.1">14</span></h1>
<h1 class="chaptertitle" id="_idParaDest-240"><span class="kobospan" id="kobo.2.1">Creating RESTful Web Services</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.3.1">This chapter explains how Node.js can be used to create web services that provide access to data over HTTP requests, which is</span><a id="_idIndexMarker667" class="calibre3"/><span class="kobospan" id="kobo.4.1"> a key enabler for </span><strong class="screentext"><span class="kobospan" id="kobo.5.1">single-page applications</span></strong><span class="kobospan" id="kobo.6.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.7.1">SPAs</span></strong><span class="kobospan" id="kobo.8.1">). </span><span class="kobospan" id="kobo.8.2">The chapter begins with a basic web service and then incorporates more complex features, such as partial updates and data validation. </span><em class="italic"><span class="kobospan" id="kobo.9.1">Table 14.1</span></em><span class="kobospan" id="kobo.10.1"> puts this chapter in context.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.11.1">Table 14.1: Putting RESTful web services in context</span></p>
<table class="table-container" id="table001-11">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.12.1">Question</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.13.1">Answer</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.14.1">What are they?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.15.1">RESTful web services</span><a id="_idIndexMarker668" class="calibre3"/><span class="kobospan" id="kobo.16.1"> provide access to data over HTTP requests. </span><span class="kobospan4" id="kobo.16.2">Instead of sending data embedded in HTML content, the server responds with “raw” data, usually in JSON format.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.17.1">Why are they useful?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.18.1">Web services allow clients to perform data operations, such as querying or updating data, using HTTP requests. </span><span class="kobospan4" id="kobo.18.2">This is most often used by JavaScript code executing in the browser, although any type of client can consume a web service.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.19.1">How are they used?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.20.1">The HTTP request method/verb is used to denote an operation and the request URL identifies the data on which the operations should be performed.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.21.1">Are there any pitfalls or limitations?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.22.1">There is no standard way to create a web service, which leads to significant variations in how they are designed. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.23.1">Are there any alternatives?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.24.1">Most modern web applications require some form of web service to deliver data to client-side JavaScript applications. </span><span class="kobospan4" id="kobo.24.2">That said, web services are not required for applications that are purely round-trip and that do not need to support clients.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.25.1">Table 14.2</span></em><span class="kobospan" id="kobo.26.1"> summarizes the chapter.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.27.1">Table 14.2: Chapter summary</span></p>
<table class="table-container" id="table002-11">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.28.1">Problem</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.29.1">Solution</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.30.1">Listing</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.31.1">Define a web service</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.32.1">Use the </span><a id="_idIndexMarker669" class="calibre3"/><span class="kobospan4" id="kobo.33.1">standard request handlers and return JSON data instead of HTML.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.34.1">9-15</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.35.1">Consolidate the code required to create a web service</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.36.1">Separate the code that handles HTTP requests so that the data-handling code can be isolated.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.37.1">16-18, 43-45</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.38.1">Update data with a web service</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.39.1">Handle </span><code class="inlinecode"><span class="kobospan2" id="kobo.40.1">PUT</span></code><span class="kobospan" id="kobo.41.1"> and </span><code class="inlinecode"><span class="kobospan2" id="kobo.42.1">PATCH</span></code><span class="kobospan4" id="kobo.43.1"> requests.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.44.1">19-26</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.45.1">Describe complex data changes</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.46.1">Use the JSON Patch specification.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.47.1">27-30</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.48.1">Validate the data values received by the web service</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.49.1">Perform validation before passing the data to the code that processes data.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.50.1">31-37</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.51.1">Validate the combinations of data received by the web service</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.52.1">Perform model validation.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.53.1">38-41</span></em></p>
</td>
</tr>
</tbody>
</table>
<h1 class="heading" id="_idParaDest-241"><span class="kobospan" id="kobo.54.1">Preparing for this chapter</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.55.1">This chapter uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.56.1">part2app</span></code><span class="kobospan" id="kobo.57.1"> project from </span><em class="italic"><span class="kobospan" id="kobo.58.1">Chapter 13</span></em><span class="kobospan" id="kobo.59.1">. </span><span class="kobospan" id="kobo.59.2">The examples in this chapter are easier to understand with a simple command-line client application that sends HTTP requests and displays the responses that are received. </span><span class="kobospan" id="kobo.59.3">To prepare, run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.60.1">Listing 14.1</span></em><span class="kobospan" id="kobo.61.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.62.1">part2app</span></code><span class="kobospan" id="kobo.63.1"> folder to install the </span><code class="inlinecode"><span class="kobospan" id="kobo.64.1">Inquirer</span></code><span class="kobospan" id="kobo.65.1"> package (</span><a href="https://github.com/SBoudrias/Inquirer.js" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.66.1">https://github.com/SBoudrias/Inquirer.js</span></span></a><span class="kobospan" id="kobo.67.1">), which provides features for prompting the user.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.68.1">Tip</span></strong> </p>
<p class="normal"><span class="kobospan" id="kobo.69.1">You can download the example project for this chapter – and for all other chapters in this book – from </span><a href="https://github.com/PacktPublishing/Mastering-Node.js-Web-Development" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.70.1">https://github.com/PacktPublishing/Mastering-Node.js-Web-Development</span></span></a><span class="kobospan" id="kobo.71.1">. </span><span class="kobospan" id="kobo.71.2">See </span><em class="italic"><span class="kobospan" id="kobo.72.1">Chapter 1</span></em><span class="kobospan" id="kobo.73.1"> for how to get help if you have problems running the examples.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.74.1">Listing 14.1: Installing a package</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.75.1">npm install @inquirer/prompts@3.3.0
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.76.1">Create the </span><code class="inlinecode"><span class="kobospan" id="kobo.77.1">src/cmdline</span></code><span class="kobospan" id="kobo.78.1"> folder and add to it a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.79.1">main.mjs</span></code><span class="kobospan" id="kobo.80.1">, with the contents shown in </span><em class="italic"><span class="kobospan" id="kobo.81.1">Listing 14.2</span></em><span class="kobospan" id="kobo.82.1">. </span><span class="kobospan" id="kobo.82.2">The .</span><code class="inlinecode"><span class="kobospan" id="kobo.83.1">mjs</span></code><span class="kobospan" id="kobo.84.1"> file extension tells Node.js to treat this file as a JavaScript module and allow the use of the </span><code class="inlinecode"><span class="kobospan" id="kobo.85.1">import</span></code><span class="kobospan" id="kobo.86.1"> statement.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.87.1">Listing 14.2: The contents of the main.mjs file in the src/cmdline folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.88.1">import { select } from "@inquirer/prompts";
import { ops } from "./operations.mjs";
(async function run() {
    let loop = true;
    while (loop) {
        const selection = await select({
            message: "Select an operation",
            choices: [...Object.keys(ops).map(k =&gt; {return { value: k }})]
        });
        await ops[selection]();
    }
})();
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.89.1">This code uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.90.1">Inquirer</span></code><span class="kobospan" id="kobo.91.1"> package to prompt the user to choose an operation to perform. </span><span class="kobospan" id="kobo.91.2">The choices presented to the user are obtained from the properties of an object, and making a choice executes the function assigned to that property. </span><span class="kobospan" id="kobo.91.3">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.92.1">operations.mjs</span></code><span class="kobospan" id="kobo.93.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.94.1">src/cmdline</span></code><span class="kobospan" id="kobo.95.1"> folder with the contents shown in </span><em class="italic"><span class="kobospan" id="kobo.96.1">Listing 14.3</span></em><span class="kobospan" id="kobo.97.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.98.1">Listing 14.3: The contents of the operations.mjs file in the src/cmdline folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.99.1">export const ops = {
    "Test": () =&gt; {
        console.log("Test operation selected");
    },
    "Exit": () =&gt; process.exit()
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.100.1">This file provides the operations that the user can select, with a </span><code class="inlinecode"><span class="kobospan" id="kobo.101.1">Test</span></code><span class="kobospan" id="kobo.102.1"> operation to get started and make sure everything works as it should, and an </span><code class="inlinecode"><span class="kobospan" id="kobo.103.1">Exit</span></code><span class="kobospan" id="kobo.104.1"> option that uses the Node.js </span><code class="inlinecode"><span class="kobospan" id="kobo.105.1">process.exit</span></code><span class="kobospan" id="kobo.106.1"> method to terminate the process. </span><em class="italic"><span class="kobospan" id="kobo.107.1">Listing 14.4</span></em><span class="kobospan" id="kobo.108.1"> adds an entry to the scripts section of the </span><code class="inlinecode"><span class="kobospan" id="kobo.109.1">package.json</span></code><span class="kobospan" id="kobo.110.1"> file to run the command-line client.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.111.1">Listing 14.4: Adding a script in the package.json file in the part2app folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.112.1">...
</span><span class="kobospan" id="kobo.112.2">"scripts": {
    "server": "tsc-watch --noClear --onsuccess \"node dist/server/server.js\"",
    "client": "webpack serve",
    "start": "npm-run-all --parallel server client",
    </span><strong class="screentext"><span class="kobospan" id="kobo.113.1">"cmdline": "node --watch ./src/cmdline/main.mjs"</span></strong><span class="kobospan" id="kobo.114.1">
},
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.115.1">The new entry will execute the </span><code class="inlinecode"><span class="kobospan" id="kobo.116.1">main.mjs</span></code><span class="kobospan" id="kobo.117.1"> file using Node.js. </span><span class="kobospan" id="kobo.117.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.118.1">--watch</span></code><span class="kobospan" id="kobo.119.1"> argument puts Node.js into watch mode, where it will restart if changes are detected.</span></p>
<h2 class="heading1" id="_idParaDest-242"><span class="kobospan" id="kobo.120.1">Preparing for a web service</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.121.1">To prepare for the</span><a id="_idIndexMarker670" class="calibre3"/><span class="kobospan" id="kobo.122.1"> introduction of a web service, create the </span><code class="inlinecode"><span class="kobospan" id="kobo.123.1">src/server/api</span></code><span class="kobospan" id="kobo.124.1"> folder and add to it a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.125.1">index.ts</span></code><span class="kobospan" id="kobo.126.1"> with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.127.1">Listing 14.5</span></em><span class="kobospan" id="kobo.128.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.129.1">Listing 14.5: The contents of the index.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.130.1">import { Express } from "express";
export const createApi = (app: Express) =&gt; {
    // TODO - implement API
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.131.1">This file is just a placeholder for now but will be used to configure Express to handle HTTP API requests. </span><span class="kobospan" id="kobo.131.2">The final change is to call the function defined in </span><em class="italic"><span class="kobospan" id="kobo.132.1">Listing 14.5</span></em><span class="kobospan" id="kobo.133.1"> to set up the web service, as shown in </span><em class="italic"><span class="kobospan" id="kobo.134.1">Listing 14.6</span></em><span class="kobospan" id="kobo.135.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.136.1">Listing 14.6: Configuring Express in the server.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.137.1">import { createServer } from "http";
import express, {Express } from "express";
import httpProxy from "http-proxy";
import helmet from "helmet";
import { engine } from "express-handlebars";
import { registerFormMiddleware, registerFormRoutes } from "./forms";
</span><strong class="screentext"><span class="kobospan" id="kobo.138.1">import { createApi } from "./api"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.139.1">;</span></strong><span class="kobospan" id="kobo.140.1">
const port = 5000;
const expressApp: Express = express();
const proxy = httpProxy.createProxyServer({
    target: "http://localhost:5100", ws: true
});
expressApp.set("views", "templates/server");
expressApp.engine("handlebars", engine());
expressApp.set("view engine", "handlebars");
expressApp.use(helmet());
expressApp.use(express.json());
registerFormMiddleware(expressApp);
registerFormRoutes(expressApp);
</span><strong class="screentext"><span class="kobospan" id="kobo.141.1">createApi(expressApp);</span></strong><span class="kobospan" id="kobo.142.1">
expressApp.use("^/$", (req, resp) =&gt; resp.redirect("/form"));
expressApp.use(express.static("static"));
expressApp.use(express.static("node_modules/bootstrap/dist"));
expressApp.use((req, resp) =&gt; proxy.web(req, resp));
const server = createServer(expressApp);
server.on('upgrade', (req, socket, head) =&gt; proxy.ws(req, socket, head));
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.143.1">Run the</span><a id="_idIndexMarker671" class="calibre3"/><span class="kobospan" id="kobo.144.1"> command shown in </span><em class="italic"><span class="kobospan" id="kobo.145.1">Listing 14.7</span></em><span class="kobospan" id="kobo.146.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.147.1">part2app</span></code><span class="kobospan" id="kobo.148.1"> folder to start the development tools.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.149.1">Listing 14.7: Starting the development tools</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.150.1">npm start
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.151.1">Open a second command prompt, navigate to the </span><code class="inlinecode"><span class="kobospan" id="kobo.152.1">part2app</span></code><span class="kobospan" id="kobo.153.1"> folder, and run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.154.1">Listing 14.8</span></em><span class="kobospan" id="kobo.155.1"> to start the command-line client.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.156.1">Listing 14.8: Starting the command-line client</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.157.1">npm run cmdline
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.158.1">The features provided by the </span><code class="inlinecode"><span class="kobospan" id="kobo.159.1">Inquirer</span></code><span class="kobospan" id="kobo.160.1"> package present a single choice, like this:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.161.1">? </span><span class="kobospan" id="kobo.161.2">Select an operation (Use arrow keys)
</span><span class="hljs-con-meta"><span class="kobospan" id="kobo.162.1">&gt; </span></span><span class="kobospan" id="kobo.163.1">Test
Exit
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.164.1">Use the arrow keys to move up and down the list of choices. </span><span class="kobospan" id="kobo.164.2">Selecting the </span><code class="inlinecode"><span class="kobospan" id="kobo.165.1">Test</span></code><span class="kobospan" id="kobo.166.1"> operation displays a test message, and selecting </span><code class="inlinecode"><span class="kobospan" id="kobo.167.1">Exit</span></code><span class="kobospan" id="kobo.168.1"> terminates the process. </span><span class="kobospan" id="kobo.168.2">Node.js is running in watch mode, which means that it will start the command-line </span><a id="_idIndexMarker672" class="calibre3"/><span class="kobospan" id="kobo.169.1">client again if a change is detected. </span><span class="kobospan" id="kobo.169.2">Press </span><em class="italic"><span class="kobospan" id="kobo.170.1">Ctrl + C</span></em><span class="kobospan" id="kobo.171.1"> if you want to stop the client entirely.</span></p>
<h1 class="heading" id="_idParaDest-243"><span class="kobospan" id="kobo.172.1">Understanding web services</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.173.1">There is no definitive </span><a id="_idIndexMarker673" class="calibre3"/><span class="kobospan" id="kobo.174.1">agreement about what a web service is, no single standard to follow, and no set of widely adopted patterns. </span><span class="kobospan" id="kobo.174.2">The opposite is true: there is an endless multitude of opinions, countless patterns, and an endless internet shouting match over the “correct” way to deliver data to clients. </span></p>
<p class="normal"><span class="kobospan" id="kobo.175.1">The chaos and noise surrounding web services can be overwhelming, and it can be difficult to know where to start. </span><span class="kobospan" id="kobo.175.2">However, the lack of standardization can be liberating because it means that a project can focus on delivering just the functionality that clients require, without any of the boilerplate or overheads that standardization can sometimes bring. </span></p>
<p class="normal"><span class="kobospan" id="kobo.176.1">Web services are just data access APIs that are accessed over HTTP. </span><span class="kobospan" id="kobo.176.2">A RESTful web service is just a web service that uses aspects of the HTTP requests to determine which parts of the API a client wants to use. </span><span class="kobospan" id="kobo.176.3">The term </span><em class="italic"><span class="kobospan" id="kobo.177.1">RESTful</span></em><span class="kobospan" id="kobo.178.1"> comes from </span><a id="_idIndexMarker674" class="calibre3"/><span class="kobospan" id="kobo.179.1">the</span><strong class="screentext"><span class="kobospan" id="kobo.180.1"> representational state transfer</span></strong><span class="kobospan" id="kobo.181.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.182.1">REST</span></strong><span class="kobospan" id="kobo.183.1">) pattern, but there has been so much variation and adaptation in web services that only the core premise of REST is widely used, which is that an API is defined using a combination of HTTP methods and URLs. </span><span class="kobospan" id="kobo.183.2">The HTTP method, such as GET or POST, defines the type of operation that will be</span><a id="_idIndexMarker675" class="calibre3"/><span class="kobospan" id="kobo.184.1"> performed, while the URL specifies the data object or objects to which the operation will be applied.</span></p>
<p class="normal"><span class="kobospan" id="kobo.185.1">Projects are free to create </span><a id="_idIndexMarker676" class="calibre3"/><span class="kobospan" id="kobo.186.1">web service APIs in any way, but the best web services are the ones that are simple and easy to use. </span><span class="kobospan" id="kobo.186.2">As an example, here is a URL that might identify data managed by the application:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.187.1">/api/results/1
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.188.1">There are no restrictions on how the URL is used to identify data, as long as the client and the server both understand the URL format so that data can be unambiguously identified. </span><span class="kobospan" id="kobo.188.2">If an application stores data in a database, then a URL typically identifies a specific value using a primary key, but that is just a common convention and not a requirement.</span></p>
<p class="normal"><span class="kobospan" id="kobo.189.1">The URL identifies the data, but it is the HTTP request method that specifies what should be done with that data. </span><em class="italic"><span class="kobospan" id="kobo.190.1">Table 14.3</span></em><span class="kobospan" id="kobo.191.1"> describes the HTTP methods that are commonly used in web services and the operations they conventionally</span><a id="_idIndexMarker677" class="calibre3"/><span class="kobospan" id="kobo.192.1"> represent. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.193.1">Table 14.3: Commonly used HTTP methods </span></p>
<table class="table-container" id="table003-11">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.194.1">Method</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.195.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.196.1">GET</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.197.1">This </span><a id="_idIndexMarker678" class="calibre3"/><span class="kobospan4" id="kobo.198.1">method is used to retrieve one or more data values</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.199.1">POST</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.200.1">This </span><a id="_idIndexMarker679" class="calibre3"/><span class="kobospan4" id="kobo.201.1">method is used to store a new data value</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.202.1">PUT</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.203.1">This </span><a id="_idIndexMarker680" class="calibre3"/><span class="kobospan4" id="kobo.204.1">method is used to replace an existing data value</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.205.1">PATCH</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.206.1">This </span><a id="_idIndexMarker681" class="calibre3"/><span class="kobospan4" id="kobo.207.1">method is used to update part of an existing data value</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.208.1">DELETE</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.209.1">This </span><a id="_idIndexMarker682" class="calibre3"/><span class="kobospan4" id="kobo.210.1">method is used to delete a data value</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.211.1">A</span><a id="_idIndexMarker683" class="calibre3"/><span class="kobospan" id="kobo.212.1"> web service presents an API by combining URLs and methods and will typically return JSON data. </span><span class="kobospan" id="kobo.212.2">For operations that don’t query for data, an indication of the outcome is returned and that can also be JSON data. </span><span class="kobospan" id="kobo.212.3">A basic web service might provide the combinations described in </span><em class="italic"><span class="kobospan" id="kobo.213.1">Table 14.4</span></em><span class="kobospan" id="kobo.214.1">, which also describes the results the web service will produce.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.215.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.216.1">Early web services used XML rather than JSON. </span><span class="kobospan" id="kobo.216.2">JSON became the de facto standard because it is simple and easily parsed by JavaScript clients, but you will still see the occasional reference to XML, such as the </span><code class="inlinecode"><span class="kobospan" id="kobo.217.1">XMLHttpRequest</span></code><span class="kobospan" id="kobo.218.1"> objects, that browsers provide for sending HTTP requests (although these have been superseded by the more modern Fetch API). </span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.219.1">Table 14.4: A typical web service</span></p>
<table class="table-container" id="table004-7">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.220.1">Method</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.221.1">URL</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.222.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.223.1">GET</span></code>
</code></pre>
</td>
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.224.1">/api/results/1</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.225.1">This combination gets the single value with ID </span><code class="inlinecode"><span class="kobospan2" id="kobo.226.1">1</span></code><span class="kobospan" id="kobo.227.1">, expressed as a JSON representation of a </span><code class="inlinecode"><span class="kobospan2" id="kobo.228.1">Result</span></code><span class="kobospan" id="kobo.229.1"> object. </span><span class="kobospan4" id="kobo.229.2">If there is no such ID, a 404 response will be returned.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.230.1">GET</span></code>
</code></pre>
</td>
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.231.1">/api/results</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.232.1">This combination gets all available data values, expressed as a JSON representation of an array of </span><code class="inlinecode"><span class="kobospan2" id="kobo.233.1">Result</span></code><span class="kobospan" id="kobo.234.1"> objects. </span><span class="kobospan4" id="kobo.234.2">If there is no data, an empty array will be returned.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.235.1">GET</span></code>
</code></pre>
</td>
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.236.1">/api/results?name=Alice</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.237.1">This combination finds all values with a </span><code class="inlinecode"><span class="kobospan2" id="kobo.238.1">name</span></code><span class="kobospan" id="kobo.239.1"> value of </span><code class="inlinecode"><span class="kobospan2" id="kobo.240.1">Alice</span></code><span class="kobospan" id="kobo.241.1"> and returns a JSON representation of an array of </span><code class="inlinecode"><span class="kobospan2" id="kobo.242.1">Result</span></code><span class="kobospan" id="kobo.243.1"> objects. </span><span class="kobospan4" id="kobo.243.2">An empty array will be returned if there is no matching data.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.244.1">POST</span></code>
</code></pre>
</td>
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.245.1">/api/results</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.246.1">This combination stores a value and returns a JSON representation of the stored data.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.247.1">DELETE</span></code>
</code></pre>
</td>
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.248.1">/api/results/1</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.249.1">This combination deletes the single value with ID </span><code class="inlinecode"><span class="kobospan2" id="kobo.250.1">1</span></code><span class="kobospan" id="kobo.251.1"> and returns a JSON object with a </span><code class="inlinecode"><span class="kobospan2" id="kobo.252.1">success</span></code><span class="kobospan" id="kobo.253.1"> property with a </span><code class="inlinecode"><span class="kobospan2" id="kobo.254.1">boolean</span></code><span class="kobospan4" id="kobo.255.1"> value that indicates the outcome.</span></p>
</td>
</tr>
</tbody>
</table>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.256.1">Understanding microservice</span></strong><span class="kobospan" id="kobo.257.1">s</span></p>
<p class="normal"><span class="kobospan" id="kobo.258.1">Any research on web services will quickly take you into the world of microservices, which is why I suggested it as a search term in the previous section. </span><span class="kobospan" id="kobo.258.2">Microservices are a way to design applications around business capabilities and that often involves web services. </span><span class="kobospan" id="kobo.258.3">A good overview of microservices can be found at </span><a href="https://microservices.io" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.259.1">https://microservices.io</span></span></a><span class="kobospan" id="kobo.260.1">, along with details design patterns. </span></p>
<p class="normal"><span class="kobospan" id="kobo.261.1">My view of microservices is that they are interesting but should be avoided for most projects. </span><span class="kobospan" id="kobo.261.2">The core problem that microservices address is a dysfunctional development organization that cannot be managed to provide coordinated software releases. </span><span class="kobospan" id="kobo.261.3">This is a problem that many projects face, given that any group of three or more developers immediately splits into factions that compete for resources, argue over design issues, and blame each other for delays.</span></p>
</div>
<div class="note">
<p class="normal"><span class="kobospan" id="kobo.262.1">Microservices attempt to resolve these problems by having development teams work largely in isolation and agreeing only on how different parts of the project will be integrated. </span><span class="kobospan" id="kobo.262.2">There are some excellent tools designed to support microservices, the most well-known one being Kubernetes, but the tools are incredibly complex, and adopting microservices feels like giving up on the complexities of staff management to focus on the complexities of software management. </span><span class="kobospan" id="kobo.262.3">In my experience, few HR issues have been resolved by increasing the complexity of development tools, so I am skeptical that microservices are a practical way to solve complex organizational problems. </span><span class="kobospan" id="kobo.262.4">You should form your own view, but my advice is to think carefully before adopting microservices and ask yourself whether your colleagues will behave any better in a federated development model than they do today.</span></p>
</div>
<h1 class="heading" id="_idParaDest-244"><span class="kobospan" id="kobo.263.1">Creating a basic RESTful web service</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.264.1">As a</span><a id="_idIndexMarker684" class="calibre3"/><span class="kobospan" id="kobo.265.1"> first step, </span><em class="italic"><span class="kobospan" id="kobo.266.1">Listing 14.9</span></em><span class="kobospan" id="kobo.267.1"> creates a web service that implements some of the combinations of URL and HTTP methods described in </span><em class="italic"><span class="kobospan" id="kobo.268.1">Table 14.4</span></em><span class="kobospan" id="kobo.269.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.270.1">Listing 14.9: Creating a basic web service in the index.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.271.1">import { Express } from "express";
</span><strong class="screentext"><span class="kobospan" id="kobo.272.1">import repository from "../data"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.273.1">;</span></strong><span class="kobospan" id="kobo.274.1">
export const createApi = (app: Express) =&gt; {
   </span><strong class="screentext"><span class="kobospan" id="kobo.275.1"> app.get("/api/results", async (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.276.1">        if (req.query</span></strong><strong class="screentext"><span class="kobospan" id="kobo.277.1">.name) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.278.1">            const data = await repository.getResultsByName(</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.279.1">                req.query.name.toString(), 10);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.280.1">            if (data.length</span></strong><strong class="screentext"><span class="kobospan" id="kobo.281.1"> &gt; 0) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.282.1">                resp.json(data);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.283.1">            } else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.284.1">                resp.writeHead(404);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.285.1">            }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.286.1">        }   else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.287.1">                resp.json(await repository.getAllResults(10</span></strong><strong class="screentext"><span class="kobospan" id="kobo.288.1">));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.289.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.290.1">        resp.end();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.291.1">    });</span></strong><span class="kobospan" id="kobo.292.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.293.1">The listing</span><a id="_idIndexMarker685" class="calibre3"/><span class="kobospan" id="kobo.294.1"> shows how easy it is to create an API for clients by repurposing the parts of the application created for round-trip requests. </span><span class="kobospan" id="kobo.294.2">This is how most web services start, but there are some problems and improvements that can be made, as later sections explain. </span><span class="kobospan" id="kobo.294.3">But, to complete the initial process, </span><em class="italic"><span class="kobospan" id="kobo.295.1">Listing 14.10</span></em><span class="kobospan" id="kobo.296.1"> adds operations to the client to consume the API.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.297.1">Listing 14.10: Adding operations in the operations.mjs file in the src/cmdline folder</span></p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext"><span class="kobospan" id="kobo.298.1">import { input } from "@inquirer/prompts";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.299.1">const baseUrl = "http://localhost:5000";</span></strong><span class="kobospan" id="kobo.300.1">
export const ops = {
    </span><strong class="screentext"><span class="kobospan" id="kobo.301.1">"Get All": () =&gt; sendRequest("GET", "/api/results"),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.302.1">    "Get Name": async () =&gt; {</span></strong>
<strong class="screentext">        </strong><strong class="screentext"><span class="kobospan" id="kobo.303.1">const name = await input({ message: "Name?"});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.304.1">        await sendRequest("GET", `/api/results?name=${name}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.305.1">    },</span></strong><span class="kobospan" id="kobo.306.1">
    "Exit": () =&gt; process.exit()
}
</span><strong class="screentext"><span class="kobospan" id="kobo.307.1">const sendRequest = async (method, url, body, contentType) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.308.1">    const response = await fetch</span></strong><strong class="screentext"><span class="kobospan" id="kobo.309.1">(baseUrl + url, {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.310.1">        method, headers: { "Content-Type": contentType ?? </span><span class="kobospan" id="kobo.310.2">"application/json"},</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.311.1">        body: JSON.stringify(body)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.312.1">    });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.313.1">    if (response.status == 200) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.314.1">        const</span></strong><strong class="screentext"><span class="kobospan" id="kobo.315.1"> data = await response.json();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.316.1">        (Array.isArray(data) ? </span><span class="kobospan" id="kobo.316.2">data : [data])</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.317.1">            .forEach(elem =&gt; console.log(JSON.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.318.1">stringify(elem)));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.319.1">    } else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.320.1">        console.log(response.status + " " + response.statusText);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.321.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.322.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.323.1">Node.js </span><a id="_idIndexMarker686" class="calibre3"/><span class="kobospan" id="kobo.324.1">supports the Fetch API, which is commonly used by browser-based JavaScript code to make HTTP requests. </span><span class="kobospan" id="kobo.324.2">The changes in </span><em class="italic"><span class="kobospan" id="kobo.325.1">Listing 14.10</span></em><span class="kobospan" id="kobo.326.1"> add a </span><code class="inlinecode"><span class="kobospan" id="kobo.327.1">sendRequest</span></code><span class="kobospan" id="kobo.328.1"> function that sends HTTP requests and displays their results and adds </span><code class="inlinecode"><span class="kobospan" id="kobo.329.1">Get All</span></code><span class="kobospan" id="kobo.330.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.331.1">Get Name</span></code><span class="kobospan" id="kobo.332.1"> operations. </span><span class="kobospan" id="kobo.332.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.333.1">Get Name</span></code><span class="kobospan" id="kobo.334.1"> operation uses </span><code class="inlinecode"><span class="kobospan" id="kobo.335.1">Inquirer</span></code><span class="kobospan" id="kobo.336.1"> to prompt for a name, which is then added to the HTTP request query string.</span></p>
<p class="normal"><span class="kobospan" id="kobo.337.1">The command-line client will restart when the changes in </span><em class="italic"><span class="kobospan" id="kobo.338.1">Listing 14.10</span></em><span class="kobospan" id="kobo.339.1"> are detected. </span><span class="kobospan" id="kobo.339.2">Selecting the </span><strong class="screentext"><span class="kobospan" id="kobo.340.1">Get All</span></strong><span class="kobospan" id="kobo.341.1"> option and pressing </span><em class="italic"><span class="kobospan" id="kobo.342.1">Return</span></em><span class="kobospan" id="kobo.343.1"> will display all of the available data, like this:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.344.1">...
</span><span class="kobospan" id="kobo.344.2">{"id":3,"name":"Alice","age":35,"years":10,"nextage":45}
{"id":2,"name":"Bob","age":35,"years":10,"nextage":45}
{"id":1,"name":"Alice","age":35,"years":5,"nextage":40}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.345.1">Select the </span><code class="inlinecode"><span class="kobospan" id="kobo.346.1">Get Name</span></code><span class="kobospan" id="kobo.347.1"> operation and press the </span><em class="italic"><span class="kobospan" id="kobo.348.1">Return</span></em><span class="kobospan" id="kobo.349.1"> key, and you will be prompted for a name. </span><span class="kobospan" id="kobo.349.2">Enter </span><code class="inlinecode"><span class="kobospan" id="kobo.350.1">Alice</span></code><span class="kobospan" id="kobo.351.1"> and press </span><em class="italic"><span class="kobospan" id="kobo.352.1">Return</span></em><span class="kobospan" id="kobo.353.1">, and you will see the matching results:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.354.1">...
</span><span class="kobospan" id="kobo.354.2">{"id":3,"name":"Alice","age":35,"years":10,"nextage":45}
{"id":1,"name":"Alice","age":35,"years":5,"nextage":40}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.355.1">If you </span><a id="_idIndexMarker687" class="calibre3"/><span class="kobospan" id="kobo.356.1">enter a name that doesn’t exist, the web service will respond with a 404 Not Found response.</span></p>
<h2 class="heading1" id="_idParaDest-245"><span class="kobospan" id="kobo.357.1">Getting data for the web service</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.358.1">The reason</span><a id="_idIndexMarker688" class="calibre3"/><span class="kobospan" id="kobo.359.1"> that the web service only supports two of the</span><a id="_idIndexMarker689" class="calibre3"/><span class="kobospan" id="kobo.360.1"> combinations from </span><em class="italic"><span class="kobospan" id="kobo.361.1">Table 14.4</span></em><span class="kobospan" id="kobo.362.1"> is that those are the only operations that can be performed using the repository, which was created for the needs of the round-trip application.</span></p>
<p class="normal"><span class="kobospan" id="kobo.363.1">There is no single best way to address this issue, and compromises are required. </span><span class="kobospan" id="kobo.363.2">Some projects have web service and round-trip requirements that are similar enough to share a repository, but these are rare, and trying to force consistency between the two can end up compromising one or both parts of the application.</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.364.1">Understanding GraphQL</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.365.1">GraphQL (</span><a href="https://graphql.org" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.366.1">https://graphql.org</span></span></a><span class="kobospan" id="kobo.367.1">) is a different approach to providing clients with data. </span><span class="kobospan" id="kobo.367.2">A </span><a id="_idIndexMarker690" class="calibre3"/><span class="kobospan" id="kobo.368.1">regular RESTful web service provides a specific set of </span><a id="_idIndexMarker691" class="calibre3"/><span class="kobospan" id="kobo.369.1">operations that produce the same results for all clients. </span><span class="kobospan" id="kobo.369.2">If a client needs additional data in responses, for example, then a developer must modify the web service, and then all clients will receive that new data. </span></p>
<p class="normal"><span class="kobospan" id="kobo.370.1">GraphQL still uses HTTP requests, and the data is still expressed as JSON, but clients can execute custom queries, which include selecting the data values that will be included and filtering data in different ways. </span><span class="kobospan" id="kobo.370.2">This means that clients can receive just the data they require, and different clients can receive different data.</span></p>
<p class="normal"><span class="kobospan" id="kobo.371.1">GraphQL is great, but it is more complex than a regular RESTful web service, both in terms of the server-side development and performing client queries, and most projects are better suited to conventional RESTful web services, which present a fixed set of operations and results to all clients. </span><span class="kobospan" id="kobo.371.2">GraphQL shines in projects that have large amounts of data and clients that are going to use that data in widely different ways, which the server-side developers cannot anticipate. </span><span class="kobospan" id="kobo.371.3">But, for most other projects, GraphQL is </span><a id="_idIndexMarker692" class="calibre3"/><span class="kobospan" id="kobo.372.1">too complex, and a conventional web service is simpler to create and consume.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.373.1">One alternative </span><a id="_idIndexMarker693" class="calibre3"/><span class="kobospan" id="kobo.374.1">is to create separate repositories for each </span><a id="_idIndexMarker694" class="calibre3"/><span class="kobospan" id="kobo.375.1">part of the application, which allows each to evolve independently, but inevitably leads to some degree of code duplication since some operations are likely to be needed by both round-trip and web service clients.</span></p>
<p class="normal"><span class="kobospan" id="kobo.376.1">Another alternative – and the one used in this chapter – is to create a subclass of the original repository and add the missing features. </span><span class="kobospan" id="kobo.376.2">This works when the features required by one part of the application are a subset of those required elsewhere, which is the case with the example application. </span><em class="italic"><span class="kobospan" id="kobo.377.1">Listing 14.11</span></em><span class="kobospan" id="kobo.378.1"> defines a new interface that describes additional features required for the web service. </span><span class="kobospan" id="kobo.378.2">Further methods will be required later, but this is enough for the moment.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.379.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.380.1">If you are unsure where to start, then start by creating a subclass. </span><span class="kobospan" id="kobo.380.2">If you find that you need to replace most of the features inherited from the base class, then you should split the code into two separate repositories.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.381.1">Listing 14.11: Defining a new interface in the repository.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.382.1">export interface Result {
    id: number,
    name: string,
    age: number,
    years: number,
    nextage: number
}
export interface Repository {
    saveResult(r: Result):  Promise&lt;number&gt;;
    getAllResults(limit: number) : Promise&lt;Result[]&gt;;
    getResultsByName(name: string, limit: number): Promise&lt;Result[]&gt;;
}
</span><strong class="screentext"><span class="kobospan" id="kobo.383.1">export interface ApiRepository extends </span></strong><strong class="screentext"><span class="kobospan" id="kobo.384.1">Repository {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.385.1">    getResultById(id: number): Promise&lt;Result | undefined&gt;;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.386.1">    delete(id: number) : </span></strong><strong class="screentext"><span class="kobospan" id="kobo.387.1">Promise&lt;boolean&gt;;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.388.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.389.1">The new methods allow an individual </span><code class="inlinecode"><span class="kobospan" id="kobo.390.1">Result</span></code><span class="kobospan" id="kobo.391.1"> object to be requested by its ID, and for</span><a id="_idIndexMarker695" class="calibre3"/><span class="kobospan" id="kobo.392.1"> data to be deleted by specifying</span><a id="_idIndexMarker696" class="calibre3"/><span class="kobospan" id="kobo.393.1"> an ID. </span><em class="italic"><span class="kobospan" id="kobo.394.1">Listing 14.12</span></em><span class="kobospan" id="kobo.395.1"> updates the </span><code class="inlinecode"><span class="kobospan" id="kobo.396.1">OrmRepository</span></code><span class="kobospan" id="kobo.397.1"> class to implement the new interface.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.398.1">Listing 14.12: Implementing the interface in the orm_repository.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.399.1">import { Sequelize } from "sequelize";
</span><strong class="screentext"><span class="kobospan" id="kobo.400.1">import { ApiRepository, Result } from "./repository";</span></strong><span class="kobospan" id="kobo.401.1">
import { addSeedData, defineRelationships,
    fromOrmModel, initializeModels } from "./orm_helpers";
import { Calculation, Person, ResultModel } from "./orm_models";
</span><strong class="screentext"><span class="kobospan" id="kobo.402.1">export class OrmRepository implements ApiRepository {</span></strong><span class="kobospan" id="kobo.403.1">
    sequelize: Sequelize;
    // ...constructor and methods omitted for brevity...
    </span><strong class="screentext"><span class="kobospan" id="kobo.404.1">async getResultById(id: number): Promise&lt;Result | undefined&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.405.1">        const model = </span></strong><strong class="screentext"><span class="kobospan" id="kobo.406.1">await ResultModel.findByPk(id, {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.407.1">            include: [Person, Calculation ]</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.408.1">        });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.409.1">        return model ? </span><span class="kobospan" id="kobo.409.2">fromOrmModel(model): undefined;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.410.1">    }</span></strong>
<strong class="screentext">    </strong><strong class="screentext"><span class="kobospan" id="kobo.411.1">async delete(id: number): Promise&lt;boolean&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.412.1">        const count = await ResultModel.destroy({ where: { id }});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.413.1">        return count == </span></strong><strong class="screentext"><span class="kobospan" id="kobo.414.1">1;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.415.1">    }</span></strong><span class="kobospan" id="kobo.416.1">
}
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.417.1">Listing 14.13</span></em><span class="kobospan" id="kobo.418.1"> updates the exports from the </span><code class="inlinecode"><span class="kobospan" id="kobo.419.1">data</span></code><span class="kobospan" id="kobo.420.1"> module to add the API-specific repository.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.421.1">Listing 14.13: Updating exports in the index.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext"><span class="kobospan" id="kobo.422.1">import { ApiRepository } from "./repository";</span></strong><span class="kobospan" id="kobo.423.1">
import { OrmRepository } from "./orm_repository";
</span><strong class="screentext"><span class="kobospan" id="kobo.424.1">const repository: ApiRepository = new OrmRepository();</span></strong><span class="kobospan" id="kobo.425.1">
export default repository;
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.426.1">Listing 14.14</span></em><span class="kobospan" id="kobo.427.1"> uses</span><a id="_idIndexMarker697" class="calibre3"/><span class="kobospan" id="kobo.428.1"> the new repository interface to add </span><a id="_idIndexMarker698" class="calibre3"/><span class="kobospan" id="kobo.429.1">features to the web service. </span><span class="kobospan" id="kobo.429.2">This code is difficult to read, but this will be addressed in the next section.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.430.1">Listing 14.14: Adding features in the index.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.431.1">import { Express } from "express";
import repository from "../data";
export const createApi = (app: Express) =&gt; {
    app.get("/api/results", async (req, resp) =&gt; {
        if (req.query.name) {
            const data = await repository.getResultsByName(
                req.query.name.toString(), 10);
            if (data.length &gt; 0) {
                resp.json(data);
            } else {
                resp.writeHead(404);
            }
        }   else {
                resp.json(await repository.getAllResults(10));
        }
        resp.end();
    });
   </span><strong class="screentext"><span class="kobospan" id="kobo.432.1"> app.all("/api/results/:id", </span></strong><strong class="screentext"><span class="kobospan" id="kobo.433.1">async (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.434.1">        const id = Number.parseInt(req.params.id);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.435.1">        if (req.method == "GET") {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.436.1">            const result = </span></strong><strong class="screentext"><span class="kobospan" id="kobo.437.1">await repository.getResultById(id);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.438.1">            if (result == undefined) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.439.1">                resp.writeHead(404);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.440.1">            } else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.441.1">                resp.json(result);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.442.1">            }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.443.1">        } else if (req.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.444.1">method == "DELETE") {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.445.1">            let deleted = await repository.delete(id);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.446.1">            resp.json({ deleted });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.447.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.448.1">        resp.end();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.449.1">    })</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.450.1">    app.post("/api/results", async (req, resp) =&gt; {</span></strong>
<strong class="screentext">        </strong><strong class="screentext"><span class="kobospan" id="kobo.451.1">const { name, age, years} = req.body;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.452.1">        const nextage = Number.parseInt(age) + Number.parseInt(years);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.453.1">        const id = await repository.saveResult({ </span></strong><strong class="screentext"><span class="kobospan" id="kobo.454.1">id: 0, name, age,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.455.1">            years, nextage});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.456.1">        resp.json(await repository.getResultById(id));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.457.1">        resp.end();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.458.1">    });</span></strong><span class="kobospan" id="kobo.459.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.460.1">The new </span><a id="_idIndexMarker699" class="calibre3"/><span class="kobospan" id="kobo.461.1">routes add support for querying by ID, storing new results, and deleting existing results. </span><span class="kobospan" id="kobo.461.2">The ability to store new</span><a id="_idIndexMarker700" class="calibre3"/><span class="kobospan" id="kobo.462.1"> results depends on the ability to query by ID because there is a mismatch between the result returned by the </span><code class="inlinecode"><span class="kobospan" id="kobo.463.1">Repository.saveResult</span></code><span class="kobospan" id="kobo.464.1"> method, and the result required by the web service for POST requests. </span><span class="kobospan" id="kobo.464.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.465.1">saveResult</span></code><span class="kobospan" id="kobo.466.1"> method returns the </span><code class="inlinecode"><span class="kobospan" id="kobo.467.1">Id</span></code><span class="kobospan" id="kobo.468.1"> of the newly stored object, and so an additional query is required to get the </span><code class="inlinecode"><span class="kobospan" id="kobo.469.1">Result</span></code><span class="kobospan" id="kobo.470.1"> object that has been stored so that it can be sent back to the client. </span><em class="italic"><span class="kobospan" id="kobo.471.1">Listing 14.15</span></em><span class="kobospan" id="kobo.472.1"> adds new operations to the command-line client that rely on the new web service features.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.473.1">Listing 14.15: Adding features in the operations.mjs file in the src/cmdline folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.474.1">...
</span><span class="kobospan" id="kobo.474.2">export const ops = {
    "Get All": () =&gt; sendRequest("GET", "/api/results"),
    "Get Name": async () =&gt; {
        const name = await input({ message: "Name?"});
        await sendRequest("GET", `/api/results?name=${name}`);
    },
    </span><strong class="screentext"><span class="kobospan" id="kobo.475.1">"Get ID": async () =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.476.1">        const id = await input({ </span></strong><strong class="screentext"><span class="kobospan" id="kobo.477.1">message: "ID?"});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.478.1">        await sendRequest("GET", `/api/results/${id}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.479.1">    },</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.480.1">    "Store": </span></strong><strong class="screentext"><span class="kobospan" id="kobo.481.1">async () =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.482.1">        const values = {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.483.1">            name: await input({message: "Name?"}),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.484.1">            age: await input({</span></strong><strong class="screentext"><span class="kobospan" id="kobo.485.1">message: "Age?"}),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.486.1">            years: await input({message: "Years?"})</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.487.1">        };</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.488.1">        await sendRequest("POST", "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.489.1">/api/results", values);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.490.1">    },</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.491.1">    "Delete": async () =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.492.1">        const id = await input({ message: "ID?"});</span></strong>
<strong class="screentext">        </strong><strong class="screentext"><span class="kobospan" id="kobo.493.1">await sendRequest("DELETE", `/api/results/${id}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.494.1">    },</span></strong><span class="kobospan" id="kobo.495.1">
    "Exit": () =&gt; process.exit()
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.496.1">Using the command-line client, select the </span><code class="inlinecode"><span class="kobospan" id="kobo.497.1">Get Id</span></code><span class="kobospan" id="kobo.498.1"> option and enter </span><code class="inlinecode"><span class="kobospan" id="kobo.499.1">3</span></code><span class="kobospan" id="kobo.500.1"> when prompted, which will produce the following result:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.501.1">...
</span><span class="kobospan" id="kobo.501.2">{"id":3,"name":"Alice","age":35,"years":10,"nextage":45}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.502.1">The web </span><a id="_idIndexMarker701" class="calibre3"/><span class="kobospan" id="kobo.503.1">service will return a 404 Not Found</span><a id="_idIndexMarker702" class="calibre3"/><span class="kobospan" id="kobo.504.1"> response for </span><code class="inlinecode"><span class="kobospan" id="kobo.505.1">ID</span></code><span class="kobospan" id="kobo.506.1">s that don’t exist in the database. </span><span class="kobospan" id="kobo.506.2">Select the </span><code class="inlinecode"><span class="kobospan" id="kobo.507.1">Store</span></code><span class="kobospan" id="kobo.508.1"> option and enter </span><code class="inlinecode"><span class="kobospan" id="kobo.509.1">Drew, 50, and 5</span></code><span class="kobospan" id="kobo.510.1">, when prompted for the name, age, and years values, and the response will show the new record that is stored:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.511.1">...
</span><span class="kobospan" id="kobo.511.2">{"id":4,"name":"Drew","age":50,"years":5,"nextage":55}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.512.1">Selecting the </span><code class="inlinecode"><span class="kobospan" id="kobo.513.1">Get All</span></code><span class="kobospan" id="kobo.514.1"> option will show the new record along with the existing data in the database (but bear in mind that the database is reset and reseeded every time the server-side application restarts, so don’t make any code changes):</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.515.1">...
</span><strong class="screentext"><span class="kobospan" id="kobo.516.1">{"id":4,"name":"Drew","age":50,"years":5,"nextage":55}</span></strong><span class="kobospan" id="kobo.517.1">
{"id":3,"name":"Alice","age":35,"years":10,"nextage":45}
{"id":2,"name":"Bob","age":35,"years":10,"nextage":45}
{"id":1,"name":"Alice","age":35,"years":5,"nextage":40}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.518.1">Select </span><a id="_idIndexMarker703" class="calibre3"/><span class="kobospan" id="kobo.519.1">the </span><strong class="screentext"><span class="kobospan" id="kobo.520.1">Delete</span></strong><span class="kobospan" id="kobo.521.1"> option and enter the </span><code class="inlinecode"><span class="kobospan" id="kobo.522.1">ID</span></code><span class="kobospan" id="kobo.523.1"> of the </span><a id="_idIndexMarker704" class="calibre3"/><span class="kobospan" id="kobo.524.1">newly stored item when prompted. </span><span class="kobospan" id="kobo.524.2">The result is a JSON object with a deleted property that indicates the outcome:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.525.1">...
</span><span class="kobospan" id="kobo.525.2">{"deleted":true}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.526.1">Selecting the </span><strong class="screentext"><span class="kobospan" id="kobo.527.1">Get All</span></strong><span class="kobospan" id="kobo.528.1"> option will confirm that the data has been deleted.</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.529.1">Understanding OpenAPI</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.530.1">The OpenAPI specification (</span><a href="https://www.openapis.org" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.531.1">https://www.openapis.org</span></span></a><span class="kobospan" id="kobo.532.1">) is a standard for describing web services, which </span><a id="_idIndexMarker705" class="calibre3"/><span class="kobospan" id="kobo.533.1">can help client-side developers understand how a web service is intended to be used and provides a description of the data to which it provides access. </span><span class="kobospan" id="kobo.533.2">There are tools and packages available that generate client-side code automatically from an OpenAPI description, and some JavaScript packages used to define web services will automatically generate OpenAPI documents. </span></p>
<p class="normal"><span class="kobospan" id="kobo.534.1">OpenAPI is a good idea, but it is often used as a substitute for descriptive documentation, which tends to leave a gap between the features a web service provides and how the developer intended them to be used. </span><span class="kobospan" id="kobo.534.2">If you adopt OpenAPI in your project, you must ensure that you supplement the description it produces with notes that explain how your web service should be consumed.</span></p>
</div>
<h2 class="heading1" id="_idParaDest-246"><span class="kobospan" id="kobo.535.1">Separating the HTTP code</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.536.1">The web service in </span><em class="italic"><span class="kobospan" id="kobo.537.1">Listing 14.15</span></em><span class="kobospan" id="kobo.538.1"> supports</span><a id="_idIndexMarker706" class="calibre3"/><span class="kobospan" id="kobo.539.1"> all the combinations of HTTP method and URL described in </span><em class="italic"><span class="kobospan" id="kobo.540.1">Table 14.4</span></em><span class="kobospan" id="kobo.541.1">, but the code is difficult to understand. </span><span class="kobospan" id="kobo.541.2">The web service has three tasks to perform: parsing the HTTP request, performing an operation, and preparing the HTTP response. </span><span class="kobospan" id="kobo.541.3">When the same code is responsible for all of these tasks, it can be hard to identify the statements that perform the operations because they get lost in all the HTTP handling.</span></p>
<p class="normal"><span class="kobospan" id="kobo.542.1">The result also tends to be HTTP centric, by which I mean that most developers end up writing code with as few routes as possible, and that further complicates the </span><a id="_idIndexMarker707" class="calibre3"/><span class="kobospan" id="kobo.543.1">results. </span><span class="kobospan" id="kobo.543.2">You can see this in </span><em class="italic"><span class="kobospan" id="kobo.544.1">Listing 14.14</span></em><span class="kobospan" id="kobo.545.1">, where the Express </span><code class="inlinecode"><span class="kobospan" id="kobo.546.1">all</span></code><span class="kobospan" id="kobo.547.1"> method is used to match all requests for a URL path, with the HTTP method being identified in the request handler, like this: </span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.548.1">...
</span><strong class="screentext"><span class="kobospan" id="kobo.549.1">app.all</span></strong><strong class="screentext"><span class="kobospan" id="kobo.550.1">("/api/results/:id", async (req, resp) =&gt; {</span></strong><span class="kobospan" id="kobo.551.1">
    const id = Number.parseInt(req.params.id);
    if (</span><strong class="screentext"><span class="kobospan" id="kobo.552.1">req.method</span></strong><span class="kobospan" id="kobo.553.1"> == "GET") {
        const result = await repository.getResultById(id);
        if (result == undefined) {
            resp.writeHead(404);
        } else {
            resp.json(result);
        }
    } </span><strong class="screentext"><span class="kobospan" id="kobo.554.1">else if (req.method</span></strong><span class="kobospan" id="kobo.555.1"> == "DELETE") {
        let deleted = await repository.delete(id);
        resp.json({ deleted });
    }
    resp.end();
})
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.556.1">I end up writing this kind of code all the time. </span><span class="kobospan" id="kobo.556.2">The code compiles, and the web service works, but it is difficult to maintain because different aspects of the web service are intertwined.</span></p>
<p class="normal"><span class="kobospan" id="kobo.557.1">Web services are more easily written and maintained if the code that handles the HTTP requests is extracted into an adapter, with the added benefit that web services that require the same set of HTTP methods and URL formats can use the same adapter code. </span><span class="kobospan" id="kobo.557.2">To describe the functionality of a web service, add a file </span><a id="_idIndexMarker708" class="calibre3"/><span class="kobospan" id="kobo.558.1">named </span><code class="inlinecode"><span class="kobospan" id="kobo.559.1">http_adapter.ts</span></code><span class="kobospan" id="kobo.560.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.561.1">src/server/api</span></code><span class="kobospan" id="kobo.562.1"> folder with the code in </span><em class="italic"><span class="kobospan" id="kobo.563.1">Listing 14.16</span></em><span class="kobospan" id="kobo.564.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.565.1">Listing 14.16: The contents of the http_adapter.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.566.1">import { Express, Response } from "express";
export interface WebService&lt;T&gt; {
    getOne(id: any) : Promise&lt;T | undefined&gt;;
    getMany(query: any) : Promise&lt;T[]&gt;;
    store(data: any) : Promise&lt;T | undefined&gt;;
    delete(id: any): Promise&lt;boolean&gt;;
}
export function createAdapter&lt;T&gt;(app: Express, ws: WebService&lt;T&gt;, baseUrl: string) {
    app.get(baseUrl, async (req, resp) =&gt; {
        try {
            resp.json(await ws.getMany(req.query));
            resp.end();
        } catch (err) { writeErrorResponse(err, resp) }
    });
    app.get(`${baseUrl}/:id`, async (req, resp) =&gt; {
        try {
            const data = await ws.getOne((req.params.id));
            if (data == undefined) {
                    resp.writeHead(404);
            } else {
                    resp.json(data);
            }
            resp.end();
        } catch (err) { writeErrorResponse(err, resp) }
    });
    app.post(baseUrl, async (req, resp) =&gt; {
        try {
            const data = await ws.store(req.body);
            resp.json(data);
            resp.end();
        } catch (err) { writeErrorResponse(err, resp) }
    });
    app.delete(`${baseUrl}/:id`, async (req, resp) =&gt; {
        try {
            resp.json(await ws.delete(req.params.id));
            resp.end();
        } catch (err) { writeErrorResponse(err, resp) }
    });
    const writeErrorResponse = (err: any, resp: Response) =&gt; {
        console.error(err);
        resp.writeHead(500);
        resp.end();
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.567.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.568.1">WebService&lt;T&gt;</span></code><span class="kobospan" id="kobo.569.1"> interface describes a web service that operates on type </span><code class="inlinecode"><span class="kobospan" id="kobo.570.1">T</span></code><span class="kobospan" id="kobo.571.1">, with methods </span><a id="_idIndexMarker709" class="calibre3"/><span class="kobospan" id="kobo.572.1">that describe the operations required to support the basic web service features. </span><span class="kobospan" id="kobo.572.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.573.1">createAdapter&lt;T&gt;</span></code><span class="kobospan" id="kobo.574.1"> function creates Express routes that rely on the </span><code class="inlinecode"><span class="kobospan" id="kobo.575.1">WebService&lt;T&gt;</span></code><span class="kobospan" id="kobo.576.1"> methods to produce results. </span><span class="kobospan" id="kobo.576.2">To create an implementation of the </span><code class="inlinecode"><span class="kobospan" id="kobo.577.1">WebService&lt;T&gt;</span></code><span class="kobospan" id="kobo.578.1"> interface for </span><code class="inlinecode"><span class="kobospan" id="kobo.579.1">Result</span></code><span class="kobospan" id="kobo.580.1"> data, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.581.1">results_api.ts</span></code><span class="kobospan" id="kobo.582.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.583.1">src/server/api</span></code><span class="kobospan" id="kobo.584.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.585.1">Listing 14.17</span></em><span class="kobospan" id="kobo.586.1">.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.587.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.588.1">I generally define JavaScript functions using the fat arrow syntax because it feels more natural to me. </span><span class="kobospan" id="kobo.588.2">However, I used the </span><code class="inlinecode"><span class="kobospan" id="kobo.589.1">function</span></code><span class="kobospan" id="kobo.590.1"> keyword in </span><em class="italic"><span class="kobospan" id="kobo.591.1">Listing 14.16</span></em><span class="kobospan" id="kobo.592.1"> to define the </span><code class="inlinecode"><span class="kobospan" id="kobo.593.1">createAdapter&lt;T&gt;</span></code><span class="kobospan" id="kobo.594.1"> function, because the way that TypeScript type parameters are expressed on fat arrow functions seems awkward to me. </span><span class="kobospan" id="kobo.594.2">The equivalent function signature in fat arrow form is: </span></p>
<p class="normal"><code class="inlinecode"><span class="kobospan" id="kobo.595.1">export const createAdapter = &lt;T&gt;(app: Express, ws: WebService&lt;T&gt;, baseUrl: string) =&gt; {</span></code></p>
<p class="normal"><span class="kobospan" id="kobo.596.1">Putting the type parameter after the equals sign seems jarring to me, although you are free to follow either syntax as your preferences dictate.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.597.1">Listing 14.17: The contents of the results_api.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.598.1">import { WebService } from "./http_adapter";
</span><strong class="screentext"><span class="kobospan" id="kobo.599.1">import { Result } from "../data/repository";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.600.1">import repository from "../data";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.601.1">export class ResultWebService</span></strong><strong class="screentext"><span class="kobospan" id="kobo.602.1"> implements WebService&lt;Result&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.603.1">    getOne(id: any): Promise&lt;Result | undefined&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.604.1">        return repository.getResultById(Number</span></strong><strong class="screentext"><span class="kobospan" id="kobo.605.1">.parseInt(id));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.606.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.607.1">    getMany(query: any): Promise&lt;Result[]&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.608.1">        if (query.name) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.609.1">            return repository.getResultsByName(query.name</span></strong><strong class="screentext"><span class="kobospan" id="kobo.610.1">, 10);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.611.1">        } else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.612.1">            return repository.getAllResults(10);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.613.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.614.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.615.1">    async store(data: any): Promise&lt;Result</span></strong><strong class="screentext"><span class="kobospan" id="kobo.616.1"> | undefined&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.617.1">        const { name, age, years} = data;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.618.1">        const nextage = Number.parseInt(age) + Number.parseInt(years);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.619.1">        const id = await repository.saveResult</span></strong><strong class="screentext"><span class="kobospan" id="kobo.620.1">({ id: 0, name, age,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.621.1">            years, nextage});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.622.1">        return await repository.getResultById(id);       </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.623.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.624.1">    delete(id: any): Promise&lt;boolean&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.625.1">        return repository.delete</span></strong><strong class="screentext"><span class="kobospan" id="kobo.626.1">(Number.parseInt(id));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.627.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.628.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.629.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.630.1">ResultWebService</span></code><span class="kobospan" id="kobo.631.1"> class implements the </span><code class="inlinecode"><span class="kobospan" id="kobo.632.1">WebService&lt;Result&gt;</span></code><span class="kobospan" id="kobo.633.1"> interface and implements the methods by using the repository features. </span><em class="italic"><span class="kobospan" id="kobo.634.1">Listing 14.18</span></em><span class="kobospan" id="kobo.635.1"> uses the new adapter to </span><a id="_idIndexMarker710" class="calibre3"/><span class="kobospan" id="kobo.636.1">register the web service, replacing the mixed code.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.637.1">Listing 14.18: Using the adapter in the index.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.638.1">import { Express } from "express";
</span><strong class="screentext"><span class="kobospan" id="kobo.639.1">//import repository from "../data";</span></strong><span class="kobospan" id="kobo.640.1">
import { createAdapter } from "./http_adapter";
import { ResultWebService } from "./results_api";
export const createApi = (app: Express) =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.641.1">createAdapter(app, new ResultWebService(), "/api/results");</span></strong><span class="kobospan" id="kobo.642.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.643.1">There is no change in the behavior of the web service, but removing the code that deals with HTTP requests and responses makes the web service easier to understand and maintain.</span></p>
<h1 class="heading" id="_idParaDest-247"><span class="kobospan" id="kobo.644.1">Updating data</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.645.1">There are two ways to support </span><a id="_idIndexMarker711" class="calibre3"/><span class="kobospan" id="kobo.646.1">updates in web services: replacing </span><a id="_idIndexMarker712" class="calibre3"/><span class="kobospan" id="kobo.647.1">data and patching data. </span><span class="kobospan" id="kobo.647.2">An HTTP PUT request is sent when the client wants to completely replace data, and the request body contains all of the data the web service will need for the replacement. </span><span class="kobospan" id="kobo.647.3">An HTTP </span><code class="inlinecode"><span class="kobospan" id="kobo.648.1">PATCH</span></code><span class="kobospan" id="kobo.649.1"> method is used when the client wants to modify data, and the request body contains a description of how that data should be modified. </span></p>
<p class="normal"><span class="kobospan" id="kobo.650.1">Supporting updates with PUT requests is simpler to implement but requires the client to provide a complete replacement for the stored data. </span><span class="kobospan" id="kobo.650.2">PATCH requests are more complex but offer more flexibility and can be more efficient because only the changes are sent to the web service.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.651.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.652.1">It can be hard to know which approach to adopt at the start of a new project when the types of updates clients will send are unknown. </span><span class="kobospan" id="kobo.652.2">My advice is to start by supporting complete updates because they are simpler to implement and move to partial updates only if you find that the unchanged data values start to outnumber the changed values.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.653.1">This chapter demonstrates both PUT and PATCH requests. </span><span class="kobospan" id="kobo.653.2">To prepare, </span><em class="italic"><span class="kobospan" id="kobo.654.1">Listing 14.19</span></em><span class="kobospan" id="kobo.655.1"> adds a new method to the </span><code class="inlinecode"><span class="kobospan" id="kobo.656.1">ApiRepository</span></code><span class="kobospan" id="kobo.657.1"> interface that will allow data to be updated.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.658.1">Listing 14.19: Adding a method in the repository.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.659.1">...
</span><span class="kobospan" id="kobo.659.2">export interface ApiRepository extends Repository {
    getResultById(id: number): Promise&lt;Result | undefined&gt;;
    delete(id: number) : Promise&lt;boolean&gt;;
    </span><strong class="screentext"><span class="kobospan" id="kobo.660.1">update(r: Result) : Promise&lt;Result</span></strong><strong class="screentext"><span class="kobospan" id="kobo.661.1"> | undefined&gt;   </span></strong><span class="kobospan" id="kobo.662.1">
}
...
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.663.1">Listing 14.20</span></em><span class="kobospan" id="kobo.664.1"> implements this method using the Sequelize ORM package.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.665.1">Listing 14.20: Updating data in the orm_repository.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.666.1">import { Sequelize, or } from "sequelize";
import { ApiRepository, Result } from "./repository";
import { addSeedData, defineRelationships,
    fromOrmModel, initializeModels } from "./orm_helpers";
import { Calculation, Person, ResultModel } from "./orm_models";
export class OrmRepository implements ApiRepository {
    sequelize: Sequelize;
    // ...constructor and methods omitted for brevity...
  </span><strong class="screentext"><span class="kobospan" id="kobo.667.1">  async </span></strong><strong class="screentext"><span class="kobospan" id="kobo.668.1">update(r: Result) : Promise&lt;Result | undefined &gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.669.1">        const mod = await this.sequelize.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.670.1">transaction(async (transaction) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.671.1">            const stored = await ResultModel.findByPk(r.id);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.672.1">            if (stored !== null) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.673.1">                const [person] = </span></strong><strong class="screentext"><span class="kobospan" id="kobo.674.1">await Person.findOrCreate({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.675.1">                    where: { name : r.name}, transaction</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.676.1">                });               </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.677.1">                const [calculation] = await Calculation.findOrCreate({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.678.1">                    where: {</span></strong>
<strong class="screentext">                        </strong><strong class="screentext"><span class="kobospan" id="kobo.679.1">age: r.age, years: r.years, nextage: r.nextage</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.680.1">                    }, transaction</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.681.1">                });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.682.1">                stored.personId = person.id;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.683.1">                stored.calculationId = calculation.id;</span></strong>
<strong class="screentext">                </strong><strong class="screentext"><span class="kobospan" id="kobo.684.1">return await stored.save({transaction});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.685.1">            }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.686.1">        });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.687.1">        return mod ? </span><span class="kobospan" id="kobo.687.2">this.getResultById(mod.id) : undefined;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.688.1">    }</span></strong><span class="kobospan" id="kobo.689.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.690.1">Updating the data </span><a id="_idIndexMarker713" class="calibre3"/><span class="kobospan" id="kobo.691.1">in the example means changing either the name or calculation associated with a result. </span><span class="kobospan" id="kobo.691.2">The implementation of </span><a id="_idIndexMarker714" class="calibre3"/><span class="kobospan" id="kobo.692.1">the </span><code class="inlinecode"><span class="kobospan" id="kobo.693.1">update</span></code><span class="kobospan" id="kobo.694.1"> method performs an update in four steps, all of which are performed as a transaction. </span><span class="kobospan" id="kobo.694.2">The first step is to read the data that is to be updated from the database using the </span><code class="inlinecode"><span class="kobospan" id="kobo.695.1">id</span></code><span class="kobospan" id="kobo.696.1"> property of the </span><code class="inlinecode"><span class="kobospan" id="kobo.697.1">Result</span></code><span class="kobospan" id="kobo.698.1"> parameter:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.699.1">...
</span><span class="kobospan" id="kobo.699.2">const stored = await ResultModel.findByPk(r.id);
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.700.1">If there is a matching entry in the database, the </span><code class="inlinecode"><span class="kobospan" id="kobo.701.1">findOrCreate</span></code><span class="kobospan" id="kobo.702.1"> method is used to locate the </span><code class="inlinecode"><span class="kobospan" id="kobo.703.1">Person</span></code><span class="kobospan" id="kobo.704.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.705.1">Calculation</span></code><span class="kobospan" id="kobo.706.1"> data that matches the </span><code class="inlinecode"><span class="kobospan" id="kobo.707.1">Result</span></code><span class="kobospan" id="kobo.708.1"> parameter or create new data if there are no matches. </span><span class="kobospan" id="kobo.708.2">The next step is to update the </span><code class="inlinecode"><span class="kobospan" id="kobo.709.1">ID</span></code><span class="kobospan" id="kobo.710.1">s so the stored data refers to the new </span><code class="inlinecode"><span class="kobospan" id="kobo.711.1">Person</span></code><span class="kobospan" id="kobo.712.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.713.1">Calculation</span></code><span class="kobospan" id="kobo.714.1"> records and write the changes to the database, which is done using the </span><code class="inlinecode"><span class="kobospan" id="kobo.715.1">save</span></code><span class="kobospan" id="kobo.716.1"> method:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.717.1">...
</span><span class="kobospan" id="kobo.717.2">stored.personId = person.id;
stored.calculationId = calculation.id;
return await stored.save({transaction});
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.718.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.719.1">save</span></code><span class="kobospan" id="kobo.720.1"> method </span><a id="_idIndexMarker715" class="calibre3"/><span class="kobospan" id="kobo.721.1">is smart enough to detect changes and </span><a id="_idIndexMarker716" class="calibre3"/><span class="kobospan" id="kobo.722.1">will only update the database for properties whose values have changed. </span><span class="kobospan" id="kobo.722.2">The final step is performed after the transaction has been committed and returns the modified data using the </span><code class="inlinecode"><span class="kobospan" id="kobo.723.1">getResultById</span></code><span class="kobospan" id="kobo.724.1"> method.</span></p>
</div>


<div class="calibre1" id="_idContainer197">
<h2 class="heading1" id="_idParaDest-248"><span class="kobospan" id="kobo.725.1">Replacing data with PUT requests</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.726.1">PUT requests are the </span><a id="_idIndexMarker717" class="calibre3"/><span class="kobospan" id="kobo.727.1"> simplest to implement because the</span><a id="_idIndexMarker718" class="calibre3"/><span class="kobospan" id="kobo.728.1"> web service simply uses the data sent by the client to replace the stored data. </span><em class="italic"><span class="kobospan" id="kobo.729.1">Listing 14.21</span></em><span class="kobospan" id="kobo.730.1"> extends the interface that describes web services to add a new method and extends the HTTP wrapper to use the interface method to handle PUT requests. </span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.731.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.732.1">Not every web service uses PUT requests for updates. </span><span class="kobospan" id="kobo.732.2">POST requests are often used both to store new data and update data, using the URL to differentiate between operations, so that the URL used for an update will include a unique </span><code class="inlinecode"><span class="kobospan" id="kobo.733.1">ID</span></code><span class="kobospan" id="kobo.734.1"> (</span><code class="inlinecode"><span class="kobospan" id="kobo.735.1">/api/results/1</span></code><span class="kobospan" id="kobo.736.1">) and the URL used to store data will not (</span><code class="inlinecode"><span class="kobospan" id="kobo.737.1">/api/results</span></code><span class="kobospan" id="kobo.738.1">).</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.739.1">Listing 14.21: Adding methods in the http_adapter.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.740.1">import { Express, Response } from "express";
export interface WebService&lt;T&gt; {
    getOne(id: any) : Promise&lt;T | undefined&gt;;
    getMany(query: any) : Promise&lt;T[]&gt;;
    store(data: any) : Promise&lt;T | undefined&gt;;
    delete(id: any): Promise&lt;boolean&gt;;
  </span><strong class="screentext"><span class="kobospan" id="kobo.741.1">  replace(id: any, data: any): Promise&lt;T | undefined&gt;;</span></strong><span class="kobospan" id="kobo.742.1">
}
export function createAdapter&lt;T&gt;(app: Express, ws: WebService&lt;T&gt;, baseUrl: string) {
    // ...routes omitted for brevity...
 </span><strong class="screentext"><span class="kobospan" id="kobo.743.1">   app.put(`${baseUrl}/:id`, async</span></strong><strong class="screentext"><span class="kobospan" id="kobo.744.1"> (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.745.1">        try {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.746.1">            resp.json(await ws.replace(req.params.id, req.body));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.747.1">            resp.end();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.748.1">        } catch (err) { writeErrorResponse</span></strong><strong class="screentext"><span class="kobospan" id="kobo.749.1">(err, resp) }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.750.1">    });</span></strong><span class="kobospan" id="kobo.751.1">
    const writeErrorResponse = (err: any, resp: Response) =&gt; {
        console.error(err);
        resp.writeHead(500);
        resp.end();
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.752.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.753.1">replace</span></code><span class="kobospan" id="kobo.754.1"> method added to the </span><code class="inlinecode"><span class="kobospan" id="kobo.755.1">WebService&lt;T&gt;</span></code><span class="kobospan" id="kobo.756.1"> interface accepts an </span><code class="inlinecode"><span class="kobospan" id="kobo.757.1">id</span></code><span class="kobospan" id="kobo.758.1"> and a </span><code class="inlinecode"><span class="kobospan" id="kobo.759.1">data</span></code><span class="kobospan" id="kobo.760.1"> object. </span><span class="kobospan" id="kobo.760.2">The new route matches requests with the PUT method, extracts the </span><code class="inlinecode"><span class="kobospan" id="kobo.761.1">ID</span></code><span class="kobospan" id="kobo.762.1"> from the URL, and uses the request body for the data. </span><span class="kobospan" id="kobo.762.2">Implementing the</span><a id="_idIndexMarker719" class="calibre3"/><span class="kobospan" id="kobo.763.1"> method in the web service is a matter </span><a id="_idIndexMarker720" class="calibre3"/><span class="kobospan" id="kobo.764.1">of receiving the data from the HTTP wrapper and passing it on to the repository, as shown in </span><em class="italic"><span class="kobospan" id="kobo.765.1">Listing 14.22</span></em><span class="kobospan" id="kobo.766.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.767.1">Listing 14.22: Replacing data in the results_api.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.768.1">import { WebService } from "./http_adapter";
import { Result } from "../data/repository";
import repository from "../data";
export class ResultWebService implements WebService&lt;Result&gt; {
    // ...methods omitted for brevity...
    </span><strong class="screentext"><span class="kobospan" id="kobo.769.1">replace(id: any, data: any): Promise&lt;Result | undefined&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.770.1">        const { name, age, years, nextage } = data;</span></strong>
<strong class="screentext">        </strong><strong class="screentext"><span class="kobospan" id="kobo.771.1">return repository.update({ id, name, age, years, nextage });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.772.1">    }</span></strong><span class="kobospan" id="kobo.773.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.774.1">The data</span><a id="_idIndexMarker721" class="calibre3"/><span class="kobospan" id="kobo.775.1"> received from the HTTP wrapper is</span><a id="_idIndexMarker722" class="calibre3"/><span class="kobospan" id="kobo.776.1"> deconstructed into constant values that are combined with the </span><code class="inlinecode"><span class="kobospan" id="kobo.777.1">id</span></code><span class="kobospan" id="kobo.778.1"> parameter and passed to the repository’s </span><code class="inlinecode"><span class="kobospan" id="kobo.779.1">update</span></code><span class="kobospan" id="kobo.780.1"> method.</span></p>
<p class="normal"><span class="kobospan" id="kobo.781.1">The last step is to add an operation to the command-line client that will send the PUT request, as shown in </span><em class="italic"><span class="kobospan" id="kobo.782.1">Listing 14.23</span></em><span class="kobospan" id="kobo.783.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.784.1">Listing 14.23: Supporting updates in the operations.mjs file in the src/cmdline folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.785.1">...
</span><span class="kobospan" id="kobo.785.2">export const ops = {
    // ...properties/functions omitted for brevity...
   </span><strong class="screentext"><span class="kobospan" id="kobo.786.1"> "Replace": async () =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.787.1">        const id = await input({ message: "ID?"});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.788.1">        const values = {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.789.1">            name</span></strong><strong class="screentext"><span class="kobospan" id="kobo.790.1">: await input({message: "Name?"}),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.791.1">            age: await input({message: "Age?"}),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.792.1">            years</span></strong><strong class="screentext"><span class="kobospan" id="kobo.793.1">: await input({message: "Years?"}),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.794.1">            nextage: await input({message: "Next Age?"})</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.795.1">        };</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.796.1">        await</span></strong><strong class="screentext"><span class="kobospan" id="kobo.797.1"> sendRequest("PUT", `/api/results/${id}`, values);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.798.1">    },</span></strong><span class="kobospan" id="kobo.799.1">
    "Exit": () =&gt; process.exit()
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.800.1">The operation is called </span><code class="inlinecode"><span class="kobospan" id="kobo.801.1">Replace</span></code><span class="kobospan" id="kobo.802.1"> and it prompts for all the values required to store data and sends them to the web service using an HTTP </span><code class="inlinecode"><span class="kobospan" id="kobo.803.1">PUT</span></code><span class="kobospan" id="kobo.804.1"> request. </span><span class="kobospan" id="kobo.804.2">Select the new </span><strong class="screentext"><span class="kobospan" id="kobo.805.1">Replace</span></strong><span class="kobospan" id="kobo.806.1"> option from the command line and enter </span><code class="inlinecode"><span class="kobospan" id="kobo.807.1">1</span></code><span class="kobospan" id="kobo.808.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.809.1">Joe</span></code><span class="kobospan" id="kobo.810.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.811.1">35</span></code><span class="kobospan" id="kobo.812.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.813.1">10</span></code><span class="kobospan" id="kobo.814.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.815.1">45</span></code><span class="kobospan" id="kobo.816.1"> when prompted. </span><span class="kobospan" id="kobo.816.2">This operation will update the result whose </span><code class="inlinecode"><span class="kobospan" id="kobo.817.1">ID</span></code><span class="kobospan" id="kobo.818.1"> is </span><code class="inlinecode"><span class="kobospan" id="kobo.819.1">1</span></code><span class="kobospan" id="kobo.820.1"> with a new name, like this:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.821.1">...
</span><span class="kobospan" id="kobo.821.2">? </span><span class="kobospan" id="kobo.821.3">Select an operation Replace
? </span><span class="kobospan" id="kobo.821.4">ID? </span><span class="kobospan" id="kobo.821.5">1
? </span><span class="kobospan" id="kobo.821.6">Name? </span><span class="kobospan" id="kobo.821.7">Joe
? </span><span class="kobospan" id="kobo.821.8">Age? </span><span class="kobospan" id="kobo.821.9">35
? </span><span class="kobospan" id="kobo.821.10">Years? </span><span class="kobospan" id="kobo.821.11">10
? </span><span class="kobospan" id="kobo.821.12">Next Age? </span><span class="kobospan" id="kobo.821.13">45
{"id":1,"name":"Joe","age":35,"years":10,"nextage":45}
? </span><span class="kobospan" id="kobo.821.14">Select an operation Get All
{"id":3,"name":"Alice","age":35,"years":10,"nextage":45}
{"id":2,"name":"Bob","age":35,"years":10,"nextage":45}
</span><strong class="screentext"><span class="kobospan" id="kobo.822.1">{"id":1,"name":"Joe","age":35,"years":10,"nextage":45}</span></strong><span class="kobospan" id="kobo.823.1">
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.824.1">The name</span><a id="_idIndexMarker723" class="calibre3"/><span class="kobospan" id="kobo.825.1"> is changed but the other values are the </span><a id="_idIndexMarker724" class="calibre3"/><span class="kobospan" id="kobo.826.1">same, so the relationship between the result and the calculation in the database remains unchanged.</span></p>
<h2 class="heading1" id="_idParaDest-249"><span class="kobospan" id="kobo.827.1">Modifying data with PATCH requests</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.828.1">PATCH requests </span><a id="_idIndexMarker725" class="calibre3"/><span class="kobospan" id="kobo.829.1">allow a client to ask a web server to</span><a id="_idIndexMarker726" class="calibre3"/><span class="kobospan" id="kobo.830.1"> apply partial updates, without having to send a complete data record. </span><span class="kobospan" id="kobo.830.2">There is no standard way to describe partial changes in a PATCH request and any data format can be used, just as long as the client and the web service both understand how data is identified and how changes are described. </span><span class="kobospan" id="kobo.830.3">To support PATCH requests, </span><em class="italic"><span class="kobospan" id="kobo.831.1">Listing 14.24</span></em><span class="kobospan" id="kobo.832.1"> adds a new method to the web service interface and defines a route that matches PATCH requests. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.833.1">Listing 14.24: Supporting PATCH requests in the http_adapter.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.834.1">import { Express, Response } from "express";
export interface WebService&lt;T&gt; {
    getOne(id: any) : Promise&lt;T | undefined&gt;;
    getMany(query: any) : Promise&lt;T[]&gt;;
    store(data: any) : Promise&lt;T | undefined&gt;;
    delete(id: any): Promise&lt;boolean&gt;;
    replace(id: any, data: any): Promise&lt;T | undefined&gt;;
    </span><strong class="screentext"><span class="kobospan" id="kobo.835.1">modify</span></strong><strong class="screentext"><span class="kobospan" id="kobo.836.1">(id: any, data: any): Promise&lt;T | undefined&gt;;   </span></strong><span class="kobospan" id="kobo.837.1">
}
export function createAdapter&lt;T&gt;(app: Express, ws: WebService&lt;T&gt;, baseUrl: string) {
    // ...routes omitted for brevity...
    </span><strong class="screentext"><span class="kobospan" id="kobo.838.1">app.patch(`${baseUrl}/:id`, async (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.839.1">        try {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.840.1">            resp.json(await</span></strong><strong class="screentext"><span class="kobospan" id="kobo.841.1"> ws.modify(req.params.id, req.body));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.842.1">            resp.end();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.843.1">        } catch (err) { writeErrorResponse(err, resp) }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.844.1">    });</span></strong><span class="kobospan" id="kobo.845.1">
    const writeErrorResponse = (err: any, resp: Response) =&gt; {
        </span><span class="hljs-number"><span class="kobospan" id="kobo.846.1">con</span></span><span class="kobospan" id="kobo.847.1">sole.error(err);
        resp.writeHead(500);
        resp.end();
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.848.1">The simplest way </span><a id="_idIndexMarker727" class="calibre3"/><span class="kobospan" id="kobo.849.1">to support partial updates is to</span><a id="_idIndexMarker728" class="calibre3"/><span class="kobospan" id="kobo.850.1"> allow the client to provide a JSON object that contains only replacement values and omits any property that should be left unchanged, as shown in </span><em class="italic"><span class="kobospan" id="kobo.851.1">Listing 14.25</span></em><span class="kobospan" id="kobo.852.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.853.1">Listing 14.25: Modifying data in the results_api.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.854.1">import { WebService } from "./http_adapter";
import { Result } from "../data/repository";
import repository from "../data";
export class ResultWebService implements WebService&lt;Result&gt; {
    // ...methods omitted for brevity...
    </span><span class="kobospan" id="kobo.854.2">async modify(id: any, data: any): Promise&lt;Result | undefined&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.855.1">    const dbData = await this.getOne(id);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.856.1">        if (dbData !== undefined) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.857.1">            Object.entries(dbData).</span></strong><strong class="screentext"><span class="kobospan" id="kobo.858.1">forEach(([prop, val]) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.859.1">                (dbData as any)[prop] = data[prop] ?? </span><span class="kobospan" id="kobo.859.2">val;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.860.1">            });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.861.1">            return await this.replace(id, dbData)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.862.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.863.1">    }</span></strong><span class="kobospan" id="kobo.864.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.865.1">The </span><a id="_idIndexMarker729" class="calibre3"/><span class="kobospan" id="kobo.866.1">implementation method enumerates</span><a id="_idIndexMarker730" class="calibre3"/><span class="kobospan" id="kobo.867.1"> the properties defined by the </span><code class="inlinecode"><span class="kobospan" id="kobo.868.1">Result</span></code><span class="kobospan" id="kobo.869.1"> interface and checks to see whether the data received from the request contains a replacement value. </span><span class="kobospan" id="kobo.869.2">New values are applied to update the existing data, which is then passed to the repository’s </span><code class="inlinecode"><span class="kobospan" id="kobo.870.1">replace</span></code><span class="kobospan" id="kobo.871.1"> method to be stored. </span><span class="kobospan" id="kobo.871.2">Notice that the repository is used in the same way for replacements and updates and that it is the job of the web service to prepare the data for storage. </span><em class="italic"><span class="kobospan" id="kobo.872.1">Listing 14.26</span></em><span class="kobospan" id="kobo.873.1"> adds an operation to the command-line client that sends PATCH requests.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.874.1">Listing 14.26: Sending PATCH requests in the operations.mjs file in the src/cmdline folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.875.1">...
</span><span class="kobospan" id="kobo.875.2">export const ops = {
    // ...properties/functions omitted for brevity...
    </span><strong class="screentext"><span class="kobospan" id="kobo.876.1">"Modify": async () =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.877.1">        const id = await</span></strong><strong class="screentext"><span class="kobospan" id="kobo.878.1"> input({ message: "ID?"});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.879.1">        const values = {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.880.1">            name: await input({message: "Name?"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.881.1">}),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.882.1">            age: await input({message: "Age?"}),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.883.1">            years: await input({message: "Years?"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.884.1">}),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.885.1">            nextage: await input({message: "Next Age?"})</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.886.1">        };</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.887.1">        await sendRequest("PATCH", `/api/results/${id}`</span></strong><strong class="screentext"><span class="kobospan" id="kobo.888.1">,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.889.1">            Object.fromEntries(Object.entries(values)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.890.1">                .filter(([p, v]) =&gt; v !== "")));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.891.1">    },</span></strong><span class="kobospan" id="kobo.892.1">
    "Exit": () =&gt; process.exit()
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.893.1">This operation prompts for values in the same way as for PUT requests, but the JavaScript </span><code class="inlinecode"><span class="kobospan" id="kobo.894.1">Object.fromEntries</span></code><span class="kobospan" id="kobo.895.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.896.1">Object.entries</span></code><span class="kobospan" id="kobo.897.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.898.1">filter</span></code><span class="kobospan" id="kobo.899.1"> functions are used to exclude any property for which no value is provided so that a partial update is sent to the web service.</span></p>
<p class="normal"><span class="kobospan" id="kobo.900.1">Select the new </span><strong class="screentext"><span class="kobospan" id="kobo.901.1">Modify</span></strong><span class="kobospan" id="kobo.902.1"> option from the command line and enter </span><code class="inlinecode"><span class="kobospan" id="kobo.903.1">2</span></code><span class="kobospan" id="kobo.904.1"> for the </span><code class="inlinecode"><span class="kobospan" id="kobo.905.1">ID</span></code><span class="kobospan" id="kobo.906.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.907.1">Clara</span></code><span class="kobospan" id="kobo.908.1"> for the </span><a id="_idIndexMarker731" class="calibre3"/><span class="kobospan" id="kobo.909.1">name, and then press </span><em class="italic"><span class="kobospan" id="kobo.910.1">Return</span></em><span class="kobospan" id="kobo.911.1"> for</span><a id="_idIndexMarker732" class="calibre3"/><span class="kobospan" id="kobo.912.1"> the other prompts. </span><span class="kobospan" id="kobo.912.2">This operation will update the result whose </span><code class="inlinecode"><span class="kobospan" id="kobo.913.1">ID</span></code><span class="kobospan" id="kobo.914.1"> is </span><code class="inlinecode"><span class="kobospan" id="kobo.915.1">2</span></code><span class="kobospan" id="kobo.916.1"> with a new name, like this:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.917.1">...
</span><span class="kobospan" id="kobo.917.2">? </span><span class="kobospan" id="kobo.917.3">Select an operation Modify
? </span><span class="kobospan" id="kobo.917.4">ID? </span><span class="kobospan" id="kobo.917.5">2
? </span><span class="kobospan" id="kobo.917.6">Name? </span><span class="kobospan" id="kobo.917.7">Clara
? </span><span class="kobospan" id="kobo.917.8">Age?
</span><span class="kobospan" id="kobo.917.9">? </span><span class="kobospan" id="kobo.917.10">Years?
</span><span class="kobospan" id="kobo.917.11">? </span><span class="kobospan" id="kobo.917.12">Next Age?
</span><span class="kobospan" id="kobo.917.13">{"id":2,"name":"Clara","age":35,"years":10,"nextage":45}
? </span><span class="kobospan" id="kobo.917.14">Select an operation Get All
{"id":3,"name":"Alice","age":35,"years":10,"nextage":45}
</span><strong class="screentext"><span class="kobospan" id="kobo.918.1">{"id":2,"name":"Clara","age":35,"years":10,"nextage":45}</span></strong><span class="kobospan" id="kobo.919.1">
{"id":1,"name":"Alice","age":35,"years":5,"nextage":40}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.920.1">The client sent only a new name value to the web service and didn’t need to send values for the properties whose values were not changed.</span></p>
<h3 class="heading2" id="_idParaDest-250"><span class="kobospan" id="kobo.921.1">Using JSON Patch</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.922.1">The approach used in the previous section is useful when the only updates sent by the client are changes to existing data values. </span><span class="kobospan" id="kobo.922.2">Many projects fall into this category, and it is a useful technique when the data becomes too complex for replacement requests and the only changes are providing updated values. </span></p>
<p class="normal"><span class="kobospan" id="kobo.923.1">The</span><a id="_idIndexMarker733" class="calibre3"/><span class="kobospan" id="kobo.924.1"> JSON Patch format (</span><a href="https://jsonpatch.com" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.925.1">https://jsonpatch.com</span></span></a><span class="kobospan" id="kobo.926.1">) can be used for more</span><a id="_idIndexMarker734" class="calibre3"/><span class="kobospan" id="kobo.927.1"> complex updates. </span><span class="kobospan" id="kobo.927.2">A JSON Patch document contains a series of operations that are applied to a JSON document. </span><span class="kobospan" id="kobo.927.3">A JSON Patch document to update the value of the </span><code class="inlinecode"><span class="kobospan" id="kobo.928.1">name</span></code><span class="kobospan" id="kobo.929.1"> property, for example, would look like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.930.1">...
</span><span class="kobospan" id="kobo.930.2">[{ "op": "replace", "path": "/name", "value": "Bob" }]
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.931.1">JSON Patch</span><a id="_idIndexMarker735" class="calibre3"/><span class="kobospan" id="kobo.932.1"> documents contain an array of JSON objects, with </span><code class="inlinecode"><span class="kobospan" id="kobo.933.1">op</span></code><span class="kobospan" id="kobo.934.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.935.1">path</span></code><span class="kobospan" id="kobo.936.1"> properties that describe the operation to be performed and the target for that operation. </span><span class="kobospan" id="kobo.936.2">Additional properties are required for some operations, such as the </span><code class="inlinecode"><span class="kobospan" id="kobo.937.1">value</span></code><span class="kobospan" id="kobo.938.1"> property used to specify the new value for the replace operation. </span><em class="italic"><span class="kobospan" id="kobo.939.1">Table 14.5</span></em><span class="kobospan" id="kobo.940.1"> describes the JSON Patch operations. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.941.1">Table 14.5: The JSON Patch operations</span></p>
<table class="table-container" id="table005-6">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.942.1">Operation</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.943.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.944.1">add</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.945.1">This</span><a id="_idIndexMarker736" class="calibre3"/><span class="kobospan" id="kobo.946.1"> operation adds a property to the JSON document, with the name and value specified by the </span><code class="inlinecode"><span class="kobospan2" id="kobo.947.1">path</span></code><span class="kobospan" id="kobo.948.1"> and </span><code class="inlinecode"><span class="kobospan2" id="kobo.949.1">value</span></code><span class="kobospan4" id="kobo.950.1"> properties.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.951.1">remove</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.952.1">This </span><a id="_idIndexMarker737" class="calibre3"/><span class="kobospan" id="kobo.953.1">operation removes a property from the JSON document, specified by the </span><code class="inlinecode"><span class="kobospan2" id="kobo.954.1">path</span></code><span class="kobospan4" id="kobo.955.1"> property.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.956.1">replace</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.957.1">This </span><a id="_idIndexMarker738" class="calibre3"/><span class="kobospan" id="kobo.958.1">operation changes the property specified by the </span><code class="inlinecode"><span class="kobospan2" id="kobo.959.1">path</span></code><span class="kobospan" id="kobo.960.1"> property using the value assigned to the </span><code class="inlinecode"><span class="kobospan2" id="kobo.961.1">value</span></code><span class="kobospan4" id="kobo.962.1"> property.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.963.1">copy</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.964.1">This </span><a id="_idIndexMarker739" class="calibre3"/><span class="kobospan" id="kobo.965.1">operation duplicates a property specified by the </span><code class="inlinecode"><span class="kobospan2" id="kobo.966.1">from</span></code><span class="kobospan" id="kobo.967.1"> property to the location specified by the </span><code class="inlinecode"><span class="kobospan2" id="kobo.968.1">path</span></code><span class="kobospan4" id="kobo.969.1"> property.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.970.1">move</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.971.1">This </span><a id="_idIndexMarker740" class="calibre3"/><span class="kobospan" id="kobo.972.1">operation moves a property specified by the </span><code class="inlinecode"><span class="kobospan2" id="kobo.973.1">from</span></code><span class="kobospan" id="kobo.974.1"> property to the location specified by the </span><code class="inlinecode"><span class="kobospan2" id="kobo.975.1">path</span></code><span class="kobospan4" id="kobo.976.1"> property.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.977.1">test</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.978.1">This </span><a id="_idIndexMarker741" class="calibre3"/><span class="kobospan" id="kobo.979.1">property checks to see that the JSON document contains a property and value specified by the </span><code class="inlinecode"><span class="kobospan2" id="kobo.980.1">path</span></code><span class="kobospan" id="kobo.981.1"> and </span><code class="inlinecode"><span class="kobospan2" id="kobo.982.1">value</span></code><span class="kobospan" id="kobo.983.1"> properties. </span><span class="kobospan4" id="kobo.983.2">No other operations will be performed if this operation fails.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.984.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.985.1">path</span></code><span class="kobospan" id="kobo.986.1"> property is used to identify values in the JSON document using the JSON Pointer syntax, which is described at </span><a href="https://datatracker.ietf.org/doc/html/rfc6901" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.987.1">https://datatracker.ietf.org/doc/html/rfc6901</span></span></a><span class="kobospan" id="kobo.988.1">, and which can be used to select properties and array elements. </span><span class="kobospan" id="kobo.988.2">The location </span><code class="inlinecode"><span class="kobospan" id="kobo.989.1">/name</span></code><span class="kobospan" id="kobo.990.1">, for example, denotes a </span><code class="inlinecode"><span class="kobospan" id="kobo.991.1">name</span></code><span class="kobospan" id="kobo.992.1"> property at the top level of the JSON document.</span></p>
<p class="normal"><span class="kobospan" id="kobo.993.1">JSON Patch documents can be parsed and applied using custom code, but it is easier to use one of the available open-source JavaScript packages. </span><span class="kobospan" id="kobo.993.2">Run the command shown</span><a id="_idIndexMarker742" class="calibre3"/><span class="kobospan" id="kobo.994.1"> in </span><em class="italic"><span class="kobospan" id="kobo.995.1">Listing 14.27</span></em><span class="kobospan" id="kobo.996.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.997.1">part2app</span></code><span class="kobospan" id="kobo.998.1"> folder to install the </span><code class="inlinecode"><span class="kobospan" id="kobo.999.1">fast-json-patch</span></code><span class="kobospan" id="kobo.1000.1"> package (</span><a href="https://github.com/Starcounter-Jack/JSON-Patch" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.1001.1">https://github.com/Starcounter-Jack/JSON-Patch</span></span></a><span class="kobospan" id="kobo.1002.1">), which is a popular </span><a id="_idIndexMarker743" class="calibre3"/><span class="kobospan" id="kobo.1003.1">JSON Patch package. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1004.1">Listing 14.27: Installing the JSON Patch package</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.1005.1">npm install fast-json-patch@3.1.1
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.1006.1">Listing 14.28</span></em><span class="kobospan" id="kobo.1007.1"> updates the web service so that the </span><code class="inlinecode"><span class="kobospan" id="kobo.1008.1">modify</span></code><span class="kobospan" id="kobo.1009.1"> method will treat the data it receives as a JSON Patch document and apply it using the </span><code class="inlinecode"><span class="kobospan" id="kobo.1010.1">fast-json-patch</span></code><span class="kobospan" id="kobo.1011.1"> package.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1012.1">Listing 14.28: Using JSON Patch in the result_api.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1013.1">import { WebService } from "./http_adapter";
import { Result } from "../data/repository";
import repository from "../data";
</span><strong class="screentext"><span class="kobospan" id="kobo.1014.1">import * as jsonpatch from "fast-json-patch";</span></strong><span class="kobospan" id="kobo.1015.1">
export class ResultWebService implements WebService&lt;Result&gt; {
    // ...methods omitted for brevity...
    </span><span class="kobospan" id="kobo.1015.2">async modify(id: any, data: any): Promise&lt;Result | undefined&gt; {
        const dbData = await this.getOne(id);
        if (dbData !== undefined) {
           </span><strong class="screentext"><span class="kobospan" id="kobo.1016.1"> return await this.replace(id,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1017.1">                jsonpatch.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1018.1">applyPatch(dbData, data).newDocument);</span></strong><span class="kobospan" id="kobo.1019.1">
        }
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1020.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1021.1">applyPatch</span></code><span class="kobospan" id="kobo.1022.1"> method is used to process the JSON Patch document to an object. </span><span class="kobospan" id="kobo.1022.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1023.1">result</span></code><span class="kobospan" id="kobo.1024.1"> object defines a </span><code class="inlinecode"><span class="kobospan" id="kobo.1025.1">newDocument</span></code><span class="kobospan" id="kobo.1026.1"> property that returns the modified object, which can be stored in the database.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1027.1">The HTTP </span><code class="inlinecode"><span class="kobospan" id="kobo.1028.1">Content-Type</span></code><span class="kobospan" id="kobo.1029.1"> header is set to </span><code class="inlinecode"><span class="kobospan" id="kobo.1030.1">application/json-patch+json</span></code><span class="kobospan" id="kobo.1031.1"> when sending a JSON Patch document and this type is not decoded automatically by the Express JSON middleware component. </span><em class="italic"><span class="kobospan" id="kobo.1032.1">Listing 14.29</span></em><span class="kobospan" id="kobo.1033.1"> configures the JSON middleware so that normal JSON payloads and JSON Patch payloads will be decoded. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1034.1">Listing 14.29: Enabling JSON Patch decoding in the server.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1035.1">...
</span><span class="kobospan" id="kobo.1035.2">expressApp.use(helmet());
</span><strong class="screentext"><span class="kobospan" id="kobo.1036.1">expressApp.use(express.json({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1037.1">    type: ["application/json", "application/json-patch+json"]</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1038.1">}));</span></strong><span class="kobospan" id="kobo.1039.1">
registerFormMiddleware(expressApp);
registerFormRoutes(expressApp);
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1040.1">The JSON </span><a id="_idIndexMarker744" class="calibre3"/><span class="kobospan" id="kobo.1041.1">middleware accepts a configuration object whose </span><code class="inlinecode"><span class="kobospan" id="kobo.1042.1">type</span></code><span class="kobospan" id="kobo.1043.1"> property can be configured with an array of content types to decode. </span><span class="kobospan" id="kobo.1043.2">The final step is to create a JSON Patch document in the command-line client, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1044.1">Listing 14.30</span></em><span class="kobospan" id="kobo.1045.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1046.1">Listing 14.30: Using JSON Patch in the operations.mjs file in the src/cmdline folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1047.1">...
</span><span class="kobospan" id="kobo.1047.2">"Modify": async () =&gt; {
    const id = await input({ message: "ID?"});
    const values = {
        name: await input({message: "Name?"}),
        age: await input({message: "Age?"}),
        years: await input({message: "Years?"}),
        nextage: await input({message: "Next Age?"})
    };
   </span><strong class="screentext"><span class="kobospan" id="kobo.1048.1"> await sendRequest("PATCH", `/api/results/${id}`,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1049.1">        Object.entries(values).filter((</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1050.1">[p, v]) =&gt; v !== "")</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1051.1">            .map(([p, v]) =&gt; ({ op: "replace", path: "/" + p, value</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1052.1">: v})),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1053.1">            "application/json-patch+json");</span></strong><span class="kobospan" id="kobo.1054.1">
},
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1055.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1056.1">fast-json-patch</span></code><span class="kobospan" id="kobo.1057.1"> package is capable of generating a JSON Patch document, but it is easier to create patches with custom code than it is to apply them, and the modified statement in </span><em class="italic"><span class="kobospan" id="kobo.1058.1">Listing 14.30</span></em><span class="kobospan" id="kobo.1059.1"> creates </span><code class="inlinecode"><span class="kobospan" id="kobo.1060.1">replace</span></code><span class="kobospan" id="kobo.1061.1"> operations for each of the values entered by the user.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1062.1">There is no change in the way the client and web service behave, which you can confirm by selecting the </span><code class="inlinecode"><span class="kobospan" id="kobo.1063.1">Modify</span></code><span class="kobospan" id="kobo.1064.1"> option from the command line and entering </span><code class="inlinecode"><span class="kobospan" id="kobo.1065.1">2</span></code><span class="kobospan" id="kobo.1066.1"> for the </span><code class="inlinecode"><span class="kobospan" id="kobo.1067.1">ID</span></code><span class="kobospan" id="kobo.1068.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1069.1">Clara</span></code><span class="kobospan" id="kobo.1070.1"> for the name, and then pressing return for the other prompts. </span><span class="kobospan" id="kobo.1070.2">This is the same change performed earlier in the chapter and it should produce the</span><a id="_idIndexMarker745" class="calibre3"/><span class="kobospan" id="kobo.1071.1"> same results, like this:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.1072.1">...
</span><span class="kobospan" id="kobo.1072.2">? </span><span class="kobospan" id="kobo.1072.3">Select an operation Modify
? </span><span class="kobospan" id="kobo.1072.4">ID? </span><span class="kobospan" id="kobo.1072.5">2
? </span><span class="kobospan" id="kobo.1072.6">Name? </span><span class="kobospan" id="kobo.1072.7">Clara
? </span><span class="kobospan" id="kobo.1072.8">Age?
</span><span class="kobospan" id="kobo.1072.9">? </span><span class="kobospan" id="kobo.1072.10">Years?
</span><span class="kobospan" id="kobo.1072.11">? </span><span class="kobospan" id="kobo.1072.12">Next Age?
</span><span class="kobospan" id="kobo.1072.13">{"id":2,"name":"Clara","age":35,"years":10,"nextage":45}
? </span><span class="kobospan" id="kobo.1072.14">Select an operation Get All
{"id":3,"name":"Alice","age":35,"years":10,"nextage":45}
</span><strong class="screentext"><span class="kobospan" id="kobo.1073.1">{"id":2,"name":"Clara","age":35,"years":10,"nextage":45}</span></strong><span class="kobospan" id="kobo.1074.1">
{"id":1,"name":"Alice","age":35,"years":5,"nextage":40}
...
</span></code></pre>
<h1 class="heading" id="_idParaDest-251"><span class="kobospan" id="kobo.1075.1">Validating client data</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.1076.1">Web services </span><a id="_idIndexMarker746" class="calibre3"/><span class="kobospan" id="kobo.1077.1">cannot trust the data that is received from clients</span><a id="_idIndexMarker747" class="calibre3"/><span class="kobospan" id="kobo.1078.1"> and are subject to the same kinds of issues that affect HTML forms. </span><span class="kobospan" id="kobo.1078.2">Malicious users can craft HTTP requests or alter the client-side JavaScript code to send data values that will cause errors or create unexpected results, similar to the problems with form data described in </span><em class="italic"><span class="kobospan" id="kobo.1079.1">Chapter 11</span></em><span class="kobospan" id="kobo.1080.1">. </span></p>
<p class="normal"><span class="kobospan" id="kobo.1081.1">The difficulty with web services is validating data in a way that doesn’t undermine the code clarity that came from isolating the statements that handle HTTP requests. </span><span class="kobospan" id="kobo.1081.2">If every web service method validates its data directly, the result is a mess of duplicated code statements that bury the web service functionality and are difficult to read and entertain. </span><span class="kobospan" id="kobo.1081.3">The best approach to validation is to describe validation requirements and apply them outside of the web service.</span></p>
<h2 class="heading1" id="_idParaDest-252"><span class="kobospan" id="kobo.1082.1">Creating the validation infrastructure</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.1083.1">Allowing the</span><a id="_idIndexMarker748" class="calibre3"/><span class="kobospan" id="kobo.1084.1"> validation requirements of a web service to be expressed clearly and concisely requires infrastructure that hides away the messy implementation details. </span></p>
<p class="normal"><span class="kobospan" id="kobo.1085.1">The starting point is to define the types that describe validation for an entire web service, a web service method, and a single validation rule. </span><span class="kobospan" id="kobo.1085.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.1086.1">validation_types.ts</span></code><span class="kobospan" id="kobo.1087.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1088.1">src/server/api</span></code><span class="kobospan" id="kobo.1089.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.1090.1">Listing 14.31</span></em><span class="kobospan" id="kobo.1091.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1092.1">Listing 14.31: The contents of the validation_types.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1093.1">export interface WebServiceValidation  {
    keyValidator?: ValidationRule;
    getMany?: ValidationRequirements;
    store?: ValidationRequirements;
    replace?: ValidationRequirements;
    modify?: ValidationRequirements;
}
export type ValidationRequirements = {
    [key: string] : ValidationRule
}
export type ValidationRule =
    ((value: any) =&gt; boolean)[] |
    {
        required? </span><span class="kobospan" id="kobo.1093.2">: boolean,
        validation: ((value: any) =&gt; boolean)[],
        converter?: (value: any) =&gt; any,
    }
export class ValidationError implements Error {
    constructor(public name: string, public message: string) {}
    stack?: string | undefined;
    cause?: unknown;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1094.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1095.1">WebServiceValidation</span></code><span class="kobospan" id="kobo.1096.1"> type describes the validation requirements for a web service. </span><span class="kobospan" id="kobo.1096.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1097.1">keyValidator</span></code><span class="kobospan" id="kobo.1098.1"> property specifies the validation requirements for the </span><code class="inlinecode"><span class="kobospan" id="kobo.1099.1">ID</span></code><span class="kobospan" id="kobo.1100.1"> values that identify data records, using the </span><code class="inlinecode"><span class="kobospan" id="kobo.1101.1">ValidationRule</span></code><span class="kobospan" id="kobo.1102.1"> type. </span><span class="kobospan" id="kobo.1102.2">A </span><code class="inlinecode"><span class="kobospan" id="kobo.1103.1">ValidationRule</span></code><span class="kobospan" id="kobo.1104.1"> can either be an array of test functions that will be applied to a value, or an object that additionally specifies whether a value is required and a converter that will transform the value into the type expected by the web service method.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1105.1">The </span><a id="_idIndexMarker749" class="calibre3"/><span class="kobospan" id="kobo.1106.1">other properties defined by the </span><code class="inlinecode"><span class="kobospan" id="kobo.1107.1">WebServiceValidation</span></code><span class="kobospan" id="kobo.1108.1"> type correspond to the web service methods that consume data. </span><span class="kobospan" id="kobo.1108.2">These properties can be assigned a </span><code class="inlinecode"><span class="kobospan" id="kobo.1109.1">ValidationRequirements</span></code><span class="kobospan" id="kobo.1110.1"> object, which can specify the shape of the object expected by the web service, and a </span><code class="inlinecode"><span class="kobospan" id="kobo.1111.1">ValidationRule</span></code><span class="kobospan" id="kobo.1112.1"> for each of them. </span><span class="kobospan" id="kobo.1112.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1113.1">ValidationError</span></code><span class="kobospan" id="kobo.1114.1"> class represents a problem validating the data sent by the client in a request.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1115.1">The next step is to define functions that will apply the requirements described using the types in </span><em class="italic"><span class="kobospan" id="kobo.1116.1">Listing 14.31</span></em><span class="kobospan" id="kobo.1117.1"> to validate data. </span><span class="kobospan" id="kobo.1117.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.1118.1">validation_functions.ts</span></code><span class="kobospan" id="kobo.1119.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1120.1">src/server/api</span></code><span class="kobospan" id="kobo.1121.1"> folder with the code shown in </span><em class="italic"><span class="kobospan" id="kobo.1122.1">Listing 14.32</span></em><span class="kobospan" id="kobo.1123.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1124.1">Listing 14.32: The contents of the validation_functions.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1125.1">import { ValidationError, ValidationRequirements, ValidationRule,
    WebServiceValidation } from "./validation_types";
export type ValidationResult = [valid: boolean, value: any];
export function validate(data: any, reqs: ValidationRequirements): any {
    let validatedData: any = {};
    Object.entries(reqs).forEach(([prop, rule]) =&gt; {
        const [valid, value] = applyRule(data[prop], rule);
        if (valid) {
            validatedData[prop] = value;
        } else {
            throw new ValidationError(prop, "Validation Error");
        }
    });
    return validatedData;
}
function applyRule(val: any,
</span><span>    </span><span class="kobospan" id="kobo.1126.1">    rule: ValidationRule): ValidationResult {
    const required = Array.isArray(rule) ? </span><span class="kobospan" id="kobo.1126.2">true : rule.required;
    const checks = Array.isArray(rule) ? </span><span class="kobospan" id="kobo.1126.3">rule : rule.validation;
    const convert = Array.isArray(rule) ? </span><span class="kobospan" id="kobo.1126.4">(v: any) =&gt; v : rule.converter;
    if (val === null || val == undefined || val === "") {
        return [required ? </span><span class="kobospan" id="kobo.1126.5">false : true, val];
    }
    let valid = true;
    checks.forEach(check =&gt; {
        if (!check(val)) {
            valid = false;
        }
    });
    return [valid, convert ? </span><span class="kobospan" id="kobo.1126.6">convert(val) : val];
}
export function validateIdProperty&lt;T&gt;(val: any,
        v: WebServiceValidation) : any {
    if (v.keyValidator) {
        const [valid, value] = applyRule(val, v.keyValidator);
        if (valid) {
            return value;
        }
        throw new ValidationError("ID", "Validation Error");               
    }
    return val;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1127.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1128.1">validate</span></code><span class="kobospan" id="kobo.1129.1"> function accepts a </span><code class="inlinecode"><span class="kobospan" id="kobo.1130.1">data</span></code><span class="kobospan" id="kobo.1131.1"> object and a </span><code class="inlinecode"><span class="kobospan" id="kobo.1132.1">ValidationRequirements</span></code><span class="kobospan" id="kobo.1133.1"> object. </span><span class="kobospan" id="kobo.1133.2">Each property specified by the </span><code class="inlinecode"><span class="kobospan" id="kobo.1134.1">ValidationRequirements</span></code><span class="kobospan" id="kobo.1135.1"> object is read from the </span><code class="inlinecode"><span class="kobospan" id="kobo.1136.1">data</span></code><span class="kobospan" id="kobo.1137.1"> object and validated. </span><span class="kobospan" id="kobo.1137.2">The result is an object that contains validated </span><code class="inlinecode"><span class="kobospan" id="kobo.1138.1">data</span></code><span class="kobospan" id="kobo.1139.1"> that can be trusted by the web service. </span><code class="inlinecode"><span class="kobospan" id="kobo.1140.1">ValidationError</span></code><span class="kobospan" id="kobo.1141.1"> is thrown if a data property doesn’t meet its validation requirements.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1142.1">To </span><a id="_idIndexMarker750" class="calibre3"/><span class="kobospan" id="kobo.1143.1">integrate the validation process as smoothly as possible, I am going to insert a validation layer between the HTTP adapter and the web service. </span><span class="kobospan" id="kobo.1143.2">The validation layer will receive the request and response from the adapter, validate the data, and pass it on to the web service. </span><span class="kobospan" id="kobo.1143.3">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.1144.1">validation_adapter.ts</span></code><span class="kobospan" id="kobo.1145.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1146.1">src/server/api</span></code><span class="kobospan" id="kobo.1147.1"> folder with the contents shown in </span><em class="italic"><span class="kobospan" id="kobo.1148.1">Listing 14.33</span></em><span class="kobospan" id="kobo.1149.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1150.1">Listing 14.33: The validation_adapter.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1151.1">import { WebService } from "./http_adapter";
import { validate, validateIdProperty } from "./validation_functions";
import { WebServiceValidation } from "./validation_types";
export class Validator&lt;T&gt; implements WebService&lt;T&gt; {
    constructor(private ws: WebService&lt;T&gt;,
        private validation: WebServiceValidation) {}
    getOne(id: any): Promise&lt;T | undefined&gt; {
        return this.ws.getOne(this.validateId(id));
    }
    getMany(query: any): Promise&lt;T[]&gt; {
        if (this.validation.getMany) {
            query = validate(query, this.validation.getMany);
        }
        return this.ws.getMany(query);
    }
    store(data: any): Promise&lt;T | undefined&gt; {
        if (this.validation.store) {
            data = validate(data, this.validation.store);
        }
        return this.ws.store(data);
    }
    delete(id: any): Promise&lt;boolean&gt; {
        return this.ws.delete(this.validateId(id));
    }
    replace(id: any, data: any): Promise&lt;T | undefined&gt; {
        if (this.validation.replace) {
            data = validate(data, this.validation.replace);
        }
        return this.ws.replace(this.validateId(id), data);
    }
    modify(id: any, data: any): Promise&lt;T | undefined&gt; {
        if (this.validation.modify) {
            data = validate(data, this.validation.modify);
        }
        return this.ws.modify(this.validateId(id), data);
    }
    validateId(val: any) {
        return validateIdProperty(val, this.validation);
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1152.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1153.1">ID</span></code><span class="kobospan" id="kobo.1154.1"> values</span><a id="_idIndexMarker751" class="calibre3"/><span class="kobospan" id="kobo.1155.1"> included in URLs are validated using the </span><code class="inlinecode"><span class="kobospan" id="kobo.1156.1">validateIdProperty</span></code><span class="kobospan" id="kobo.1157.1"> function, and any additional data is validated using the </span><code class="inlinecode"><span class="kobospan" id="kobo.1158.1">validate</span></code><span class="kobospan" id="kobo.1159.1"> function. </span><span class="kobospan" id="kobo.1159.2">If validation fails, </span><code class="inlinecode"><span class="kobospan" id="kobo.1160.1">ValidationError</span></code><span class="kobospan" id="kobo.1161.1"> will be thrown. </span><em class="italic"><span class="kobospan" id="kobo.1162.1">Listing 14.34</span></em><span class="kobospan" id="kobo.1163.1"> updates the HTTP adapter to catch exceptions thrown when a request is handled and generates a </span><code class="inlinecode"><span class="kobospan" id="kobo.1164.1">400 Bad Request</span></code><span class="kobospan" id="kobo.1165.1"> response for validation errors and a </span><code class="inlinecode"><span class="kobospan" id="kobo.1166.1">500 Internal Server Error</span></code><span class="kobospan" id="kobo.1167.1"> response for any other issue.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1168.1">Listing 14.34: Handling validation errors in the http_adapter.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1169.1">import { Express, Response } from "express";
</span><strong class="screentext"><span class="kobospan" id="kobo.1170.1">import { ValidationError } from "./validation_types";</span></strong><span class="kobospan" id="kobo.1171.1">
export interface WebService&lt;T&gt; {
    getOne(id: any) : Promise&lt;T | undefined&gt;;
    getMany(query: any) : Promise&lt;T[]&gt;;
    store(data: any) : Promise&lt;T | undefined&gt;;
    delete(id: any): Promise&lt;boolean&gt;;
    replace(id: any, data: any): Promise&lt;T | undefined&gt;,
    modify(id: any, data: any): Promise&lt;T | undefined&gt;   
}
export function createAdapter&lt;T&gt;(app: Express, ws: WebService&lt;T&gt;, baseUrl: string) {
    // ...routes omitted for brevity...
    </span><span class="kobospan" id="kobo.1171.2">const writeErrorResponse = (err: any, resp: Response) =&gt; {
        console.error(err);
       </span><strong class="screentext"><span class="kobospan" id="kobo.1172.1"> resp.writeHead(err </span></strong><strong class="screentext"><span class="kobospan" id="kobo.1173.1">instanceof ValidationError ? </span><span class="kobospan" id="kobo.1173.2">400 : 500);</span></strong>
<strong class="screentext">       </strong><span class="kobospan" id="kobo.1174.1"> resp.end();
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1175.1">Notice that no details of the validation problem are included in the result sent to the client. </span><span class="kobospan" id="kobo.1175.2">It would be possible to send the client a JSON object that describes the validation issues, but in practical terms, clients are rarely able to make sensible use of such information. </span><span class="kobospan" id="kobo.1175.3">Validation requirements are encountered during the development process and are best included in the developer documentation so that the client can validate the data received from the user before sending it to the web service. </span></p>
<p class="normal"><span class="kobospan" id="kobo.1176.1">Relying on the web service to provide validation errors that can be presented to the user is a problematic process and one that should be avoided, even when the client and web service are written by the same team. </span><span class="kobospan" id="kobo.1176.2">When you publish a web service, you</span><a id="_idIndexMarker752" class="calibre3"/><span class="kobospan" id="kobo.1177.1"> should expect to provide support to the client-side developers as they consume the functionality you provide.</span></p>
<h2 class="heading1" id="_idParaDest-253"><span class="kobospan" id="kobo.1178.1">Defining validation for the Result API</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.1179.1">The </span><a id="_idIndexMarker753" class="calibre3"/><span class="kobospan" id="kobo.1180.1">complexity of validation is in the infrastructure, which allows the validation requirements for a web service to be defined concisely. </span><span class="kobospan" id="kobo.1180.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.1181.1">results_api_validation.ts</span></code><span class="kobospan" id="kobo.1182.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.1183.1">src/server/api</span></code><span class="kobospan" id="kobo.1184.1"> folder with the contents shown in </span><em class="italic"><span class="kobospan" id="kobo.1185.1">Listing 14.35</span></em><span class="kobospan" id="kobo.1186.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1187.1">Listing 14.35: The contents of the results_api_validation.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1188.1">import { ValidationRequirements, ValidationRule,
    WebServiceValidation } from "./validation_types";
import validator from "validator";
const intValidator : ValidationRule = {
    validation: [val =&gt; validator.isInt(val)],
    converter: (val) =&gt; Number.parseInt(val)
}
const partialResultValidator: ValidationRequirements = {
    name: [(val) =&gt; !validator.isEmpty(val)],
    age: intValidator,
    years: intValidator
}
export const ResultWebServiceValidation: WebServiceValidation = {
    keyValidator: intValidator,
    store: partialResultValidator,
    replace: {
        ...partialResultValidator,
        nextage: intValidator
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1189.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1190.1">ResultWebServiceValidation</span></code><span class="kobospan" id="kobo.1191.1"> object defines the </span><code class="inlinecode"><span class="kobospan" id="kobo.1192.1">keyValidator</span></code><span class="kobospan" id="kobo.1193.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.1194.1">store</span></code><span class="kobospan" id="kobo.1195.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.1196.1">replace</span></code><span class="kobospan" id="kobo.1197.1"> properties, which indicates that the web service requires its </span><code class="inlinecode"><span class="kobospan" id="kobo.1198.1">ID</span></code><span class="kobospan" id="kobo.1199.1"> values to be validated, as well as the data used by the </span><code class="inlinecode"><span class="kobospan" id="kobo.1200.1">store</span></code><span class="kobospan" id="kobo.1201.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1202.1">replace</span></code><span class="kobospan" id="kobo.1203.1"> methods.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1204.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1205.1">ValidationRule</span></code><span class="kobospan" id="kobo.1206.1"> named </span><code class="inlinecode"><span class="kobospan" id="kobo.1207.1">intValidator</span></code><span class="kobospan" id="kobo.1208.1"> describes validation for integer values, with</span><a id="_idIndexMarker754" class="calibre3"/><span class="kobospan" id="kobo.1209.1"> a </span><code class="inlinecode"><span class="kobospan" id="kobo.1210.1">validation</span></code><span class="kobospan" id="kobo.1211.1"> property that uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.1212.1">validator</span></code><span class="kobospan" id="kobo.1213.1"> package to ensure a value is an integer and a </span><code class="inlinecode"><span class="kobospan" id="kobo.1214.1">converter</span></code><span class="kobospan" id="kobo.1215.1"> function that parses the value to a </span><code class="inlinecode"><span class="kobospan" id="kobo.1216.1">number</span></code><span class="kobospan" id="kobo.1217.1">. </span></p>
<p class="normal"><span class="kobospan" id="kobo.1218.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1219.1">intValidator</span></code><span class="kobospan" id="kobo.1220.1"> is used on its own as the key validator and in the </span><code class="inlinecode"><span class="kobospan" id="kobo.1221.1">ValidationRequirements</span></code><span class="kobospan" id="kobo.1222.1"> object named </span><code class="inlinecode"><span class="kobospan" id="kobo.1223.1">partialResultValidator</span></code><span class="kobospan" id="kobo.1224.1">, which validates the </span><code class="inlinecode"><span class="kobospan" id="kobo.1225.1">name</span></code><span class="kobospan" id="kobo.1226.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.1227.1">age</span></code><span class="kobospan" id="kobo.1228.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.1229.1">years</span></code><span class="kobospan" id="kobo.1230.1"> properties that are required by the </span><code class="inlinecode"><span class="kobospan" id="kobo.1231.1">store</span></code><span class="kobospan" id="kobo.1232.1"> method. </span><span class="kobospan" id="kobo.1232.2">The validation requirements for the </span><code class="inlinecode"><span class="kobospan" id="kobo.1233.1">replace</span></code><span class="kobospan" id="kobo.1234.1"> method extend those used by the </span><code class="inlinecode"><span class="kobospan" id="kobo.1235.1">store</span></code><span class="kobospan" id="kobo.1236.1"> method by adding a </span><code class="inlinecode"><span class="kobospan" id="kobo.1237.1">nextage</span></code><span class="kobospan" id="kobo.1238.1"> property.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1239.1">This approach to validation allows a web service’s data requirements to be expressed separately from the application of those requirements. </span><em class="italic"><span class="kobospan" id="kobo.1240.1">Listing 14.36</span></em><span class="kobospan" id="kobo.1241.1"> wraps the web service in its validator.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1242.1">Listing 14.36: Applying validation in the index.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1243.1">import { Express } from "express";
import { createAdapter } from "./http_adapter";
import { ResultWebService } from "./results_api";
</span><strong class="screentext"><span class="kobospan" id="kobo.1244.1">import { Validator } from "./validation_adapter";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1245.1">import { ResultWebServiceValidation } from "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1246.1">./results_api_validation";</span></strong><span class="kobospan" id="kobo.1247.1">
export const createApi = (app: Express) =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.1248.1">createAdapter(app, new Validator(new </span></strong><strong class="screentext"><span class="kobospan" id="kobo.1249.1">ResultWebService(),</span></strong>
       <strong class="screentext"><span class="kobospan" id="kobo.1250.1"> ResultWebServiceValidation), "/api/results");</span></strong><span class="kobospan" id="kobo.1251.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1252.1">The final change is a small one, which takes advantage of the type conversion performed by the validation system, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1253.1">Listing 14.37</span></em><span class="kobospan" id="kobo.1254.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1255.1">Listing 14.37: Relying on type conversion in the results_api.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1256.1">...
</span><span class="kobospan" id="kobo.1256.2">async store(data: any): Promise&lt;Result | undefined&gt; {
    const { name, age, years} = data;
   </span><strong class="screentext"><span class="kobospan" id="kobo.1257.1"> //const nextage = Number.parseInt(age) + Number.parseInt(years);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1258.1">    const nextage = age + years;  </span></strong><span class="kobospan" id="kobo.1259.1">     
    const id = await repository.saveResult({ id: 0, name, age,
        years, nextage});
    return await repository.getResultById(id);       
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1260.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1261.1">store</span></code><span class="kobospan" id="kobo.1262.1"> method </span><a id="_idIndexMarker755" class="calibre3"/><span class="kobospan" id="kobo.1263.1">won’t be called unless the </span><code class="inlinecode"><span class="kobospan" id="kobo.1264.1">age</span></code><span class="kobospan" id="kobo.1265.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1266.1">years</span></code><span class="kobospan" id="kobo.1267.1"> buttons have been converted to </span><code class="inlinecode"><span class="kobospan" id="kobo.1268.1">number</span></code><span class="kobospan" id="kobo.1269.1"> values, which means that the </span><code class="inlinecode"><span class="kobospan" id="kobo.1270.1">store</span></code><span class="kobospan" id="kobo.1271.1"> method doesn’t need to perform its own conversions.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1272.1">To test validation, select the command-line client’s Get </span><code class="inlinecode"><span class="kobospan" id="kobo.1273.1">ID</span></code><span class="kobospan" id="kobo.1274.1"> option and enter </span><code class="inlinecode"><span class="kobospan" id="kobo.1275.1">ABC</span></code><span class="kobospan" id="kobo.1276.1"> when prompted. </span><span class="kobospan" id="kobo.1276.2">The validation check will reject this value, and produce a </span><code class="inlinecode"><span class="kobospan" id="kobo.1277.1">400 Bad Request</span></code><span class="kobospan" id="kobo.1278.1"> response, like this:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.1279.1">...
</span><span class="kobospan" id="kobo.1279.2">? </span><span class="kobospan" id="kobo.1279.3">Select an operation Get ID
? </span><span class="kobospan" id="kobo.1279.4">ID? </span><span class="kobospan" id="kobo.1279.5">ABC
400 Bad Request
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1280.1">Select the </span><strong class="screentext"><span class="kobospan" id="kobo.1281.1">Store</span></strong><span class="kobospan" id="kobo.1282.1"> option and enter </span><code class="inlinecode"><span class="kobospan" id="kobo.1283.1">Joe</span></code><span class="kobospan" id="kobo.1284.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.1285.1">30</span></code><span class="kobospan" id="kobo.1286.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.1287.1">Ten</span></code><span class="kobospan" id="kobo.1288.1"> when prompted. </span><span class="kobospan" id="kobo.1288.2">The last value fails validation and causes another </span><code class="inlinecode"><span class="kobospan" id="kobo.1289.1">400</span></code><span class="kobospan" id="kobo.1290.1"> response.</span></p>
<h2 class="heading1" id="_idParaDest-254"><span class="kobospan" id="kobo.1291.1">Performing model validation</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.1292.1">Not all </span><a id="_idIndexMarker756" class="calibre3"/><span class="kobospan" id="kobo.1293.1">validation can be done before the request is passed to the web service method that will generate a response. </span><span class="kobospan" id="kobo.1293.2">One example is PATCH requests, where the client can send partial updates that may lead to inconsistent data in the database, such as providing a new </span><code class="inlinecode"><span class="kobospan" id="kobo.1294.1">years</span></code><span class="kobospan" id="kobo.1295.1"> value without a corresponding </span><code class="inlinecode"><span class="kobospan" id="kobo.1296.1">nextage</span></code><span class="kobospan" id="kobo.1297.1"> value, so that the calculation result doesn’t make sense. </span></p>
<p class="normal"><span class="kobospan" id="kobo.1298.1">Validating this kind of update cannot be done until the update has been applied to the existing stored data, which means that it must be done by the web service method, which is the earliest point in the update process where the changes and the stored data are both available. </span><span class="kobospan" id="kobo.1298.2">This is often known as </span><em class="italic"><span class="kobospan" id="kobo.1299.1">model validation</span></em><span class="kobospan" id="kobo.1300.1">, although there is no consistent terminology.</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.1301.1">Listing 14.38</span></em><span class="kobospan" id="kobo.1302.1"> defines a new data type that combines the existing validation with a </span><a id="_idIndexMarker757" class="calibre3"/><span class="kobospan" id="kobo.1303.1">new rule that applies to the entire data model object.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1304.1">Listing 14.38: Adding a type in the validation_types.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1305.1">export interface WebServiceValidation  {
    keyValidator?: ValidationRule;
    getMany?: ValidationRequirements;
    store?: ValidationRequirements;
    replace?: ValidationRequirements;
    modify?: ValidationRequirements;
}
export type ValidationRequirements = {
    [key: string] : ValidationRule
}
export type ValidationRule =
    ((value: any) =&gt; boolean)[] |
    {
        required? </span><span class="kobospan" id="kobo.1305.2">: boolean,
        validation: ((value: any) =&gt; boolean)[],
        converter?: (value: any) =&gt; any,
    }
export class ValidationError implements Error {
    constructor(public name: string, public message: string) {}
    stack?: string | undefined;
    cause?: unknown;
}
</span><strong class="screentext"><span class="kobospan" id="kobo.1306.1">export type ModelValidation = {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1307.1">    modelRule?: ValidationRule,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1308.1">    propertyRules?: ValidationRequirements</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1309.1">}</span></strong>
</code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.1310.1">Listing 14.39</span></em><span class="kobospan" id="kobo.1311.1"> uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.1312.1">ModelValidation</span></code><span class="kobospan" id="kobo.1313.1"> type in a new function that can be used to </span><a id="_idIndexMarker758" class="calibre3"/><span class="kobospan" id="kobo.1314.1">validate an object before it is stored.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1315.1">Listing 14.39: Adding a function in the validation_functions.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext"><span class="kobospan" id="kobo.1316.1">import { ModelValidation, ValidationError, ValidationRequirements</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1317.1">,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1318.1">    ValidationRule, WebServiceValidation } from "./validation_types";</span></strong><span class="kobospan" id="kobo.1319.1">
export type ValidationResult = [valid: boolean, value: any];
// ...functions omitted for brevity...
</span><strong class="screentext"><span class="kobospan" id="kobo.1320.1">export function validateModel(model: any, rules: ModelValidation) : any {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1321.1">    if (rules.propertyRules) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1322.1">        model = validate(model, rules.propertyRules);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1323.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1324.1">    if (rules.modelRule) {</span></strong>
<strong class="screentext">        </strong><strong class="screentext"><span class="kobospan" id="kobo.1325.1">const [valid, data] = applyRule(model, rules.modelRule);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1326.1">        if (valid) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1327.1">            return data;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1328.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1329.1">        throw new ValidationError("Model", "Validation Error");                       </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1330.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1331.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.1332.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1333.1">validateModel</span></code><span class="kobospan" id="kobo.1334.1"> function applies the rules for each property and then applies the model-wide rule. </span><span class="kobospan" id="kobo.1334.2">The property rules may perform type conversions and so the result from the property checks is used as the input for the model-wide validation. </span><em class="italic"><span class="kobospan" id="kobo.1335.1">Listing 14.40</span></em><span class="kobospan" id="kobo.1336.1"> defines the validation required for a </span><code class="inlinecode"><span class="kobospan" id="kobo.1337.1">Result</span></code><span class="kobospan" id="kobo.1338.1"> object.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1339.1">Listing 14.40: Defining a model validator in the result_api_validation.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext"><span class="kobospan" id="kobo.1340.1">import { ModelValidation, ValidationRequirements, ValidationRule,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1341.1">    WebServiceValidation } from "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1342.1">./validation_types";</span></strong><span class="kobospan" id="kobo.1343.1">
import validator from "validator";
const intValidator : ValidationRule = {
    </span><strong class="screentext"><span class="kobospan" id="kobo.1344.1">validation: [val =&gt; validator.isInt(val.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1345.1">toString())],</span></strong><span class="kobospan" id="kobo.1346.1">
    converter: (val) =&gt; Number.parseInt(val)
}
const partialResultValidator: ValidationRequirements = {
    name: [(val) =&gt; !validator.isEmpty(val)],
    age: intValidator,
    years: intValidator
}
export const ResultWebServiceValidation: WebServiceValidation = {
    keyValidator: intValidator,
    store: partialResultValidator,
    replace: {
        ...partialResultValidator,
        nextage: intValidator
    }
}
</span><strong class="screentext"><span class="kobospan" id="kobo.1347.1">export const ResultModelValidation : ModelValidation = {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1348.1">    propertyRules: { ...partialResultValidator, nextage: intValidator },</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1349.1">    modelRule</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1350.1">: [(m: any) =&gt; m.nextage === m.age + m.years]</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1351.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.1352.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1353.1">propertyRules</span></code><span class="kobospan" id="kobo.1354.1"> property </span><a id="_idIndexMarker759" class="calibre3"/><span class="kobospan" id="kobo.1355.1">uses the validation rules created for earlier examples. </span><span class="kobospan" id="kobo.1355.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1356.1">modelRule</span></code><span class="kobospan" id="kobo.1357.1"> property checks to see that the </span><code class="inlinecode"><span class="kobospan" id="kobo.1358.1">nextage</span></code><span class="kobospan" id="kobo.1359.1"> value is the sum of the </span><code class="inlinecode"><span class="kobospan" id="kobo.1360.1">age</span></code><span class="kobospan" id="kobo.1361.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1362.1">years</span></code><span class="kobospan" id="kobo.1363.1"> properties.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1364.1">A small change is required to the rule used to validate integers. </span><span class="kobospan" id="kobo.1364.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1365.1">isInt</span></code><span class="kobospan" id="kobo.1366.1"> method provided by the </span><code class="inlinecode"><span class="kobospan" id="kobo.1367.1">validator</span></code><span class="kobospan" id="kobo.1368.1"> package only operates on string values, but a partial update may combine the </span><code class="inlinecode"><span class="kobospan" id="kobo.1369.1">string</span></code><span class="kobospan" id="kobo.1370.1"> values received from the HTTP request with </span><code class="inlinecode"><span class="kobospan" id="kobo.1371.1">number</span></code><span class="kobospan" id="kobo.1372.1"> values read from the database. </span><span class="kobospan" id="kobo.1372.2">To avoid exceptions, the value being checked is always converted to a string.</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.1373.1">Listing 14.41</span></em><span class="kobospan" id="kobo.1374.1"> updates the web service to use the model validation feature for the </span><code class="inlinecode"><span class="kobospan" id="kobo.1375.1">replace</span></code><span class="kobospan" id="kobo.1376.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1377.1">modify</span></code><span class="kobospan" id="kobo.1378.1"> methods, ensuring that inconsistent data isn’t written to the database.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1379.1">Listing 14.41: Validating data in the results_api.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1380.1">import { WebService } from "./http_adapter";
import { Result } from "../data/repository";
import repository from "../data";
import * as jsonpatch from "fast-json-patch";
</span><strong class="screentext"><span class="kobospan" id="kobo.1381.1">import { validateModel } from "./validation_functions";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1382.1">import { ResultModelValidation } from "./results_api_validation"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1383.1">;</span></strong><span class="kobospan" id="kobo.1384.1">
export class ResultWebService implements WebService&lt;Result&gt; {
    getOne(id: any): Promise&lt;Result | undefined&gt; {
        </span><strong class="screentext"><span class="kobospan" id="kobo.1385.1">return repository.getResultById(id);</span></strong><span class="kobospan" id="kobo.1386.1">
    }
    getMany(query: any): Promise&lt;Result[]&gt; {
        if (query.name) {
            return repository.getResultsByName(query.name, 10);
        } else {
            return repository.getAllResults(10);
        }
    }
    async store(data: any): Promise&lt;Result | undefined&gt; {
        const { name, age, years} = data;
        const nextage = age + years;
        const id = await repository.saveResult({ id: 0, name, age,
            years, nextage});
        return await repository.getResultById(id);       
    }
    delete(id: any): Promise&lt;boolean&gt; {
        return repository.delete(Number.parseInt(id));
    }
    replace(id: any, data: any): Promise&lt;Result | undefined&gt; {
        const { name, age, years, nextage } = data;
        </span><strong class="screentext"><span class="kobospan" id="kobo.1387.1">const validated = validateModel</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1388.1">({ name, age, years, nextage },</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1389.1">            ResultModelValidation)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1390.1">        return repository.update({ id, ...validated });</span></strong><span class="kobospan" id="kobo.1391.1">
    }
    async modify(id: any, data: any): Promise&lt;Result | undefined&gt; {
        const dbData = await this.getOne(id);
        if (dbData !== undefined) {
            return await this.replace(id,
                jsonpatch.applyPatch(dbData, data).newDocument);
        }
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1392.1">The </span><a id="_idIndexMarker760" class="calibre3"/><span class="kobospan" id="kobo.1393.1">validation can be performed in the </span><code class="inlinecode"><span class="kobospan" id="kobo.1394.1">replace</span></code><span class="kobospan" id="kobo.1395.1"> method, which allows replacements and updates to be validated consistently.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1396.1">Select the command-line client’s </span><code class="inlinecode"><span class="kobospan" id="kobo.1397.1">Replace</span></code><span class="kobospan" id="kobo.1398.1"> option and enter </span><code class="inlinecode"><span class="kobospan" id="kobo.1399.1">1</span></code><span class="kobospan" id="kobo.1400.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.1401.1">Joe</span></code><span class="kobospan" id="kobo.1402.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.1403.1">20</span></code><span class="kobospan" id="kobo.1404.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.1405.1">10</span></code><span class="kobospan" id="kobo.1406.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.1407.1">25</span></code><span class="kobospan" id="kobo.1408.1"> when prompted. </span><span class="kobospan" id="kobo.1408.2">This is invalid data because the </span><code class="inlinecode"><span class="kobospan" id="kobo.1409.1">nextage</span></code><span class="kobospan" id="kobo.1410.1"> value should be </span><code class="inlinecode"><span class="kobospan" id="kobo.1411.1">30</span></code><span class="kobospan" id="kobo.1412.1">, so the validation process fails and a </span><code class="inlinecode"><span class="kobospan" id="kobo.1413.1">400 Bad Request</span></code><span class="kobospan" id="kobo.1414.1"> response is produced, like this:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.1415.1">...
</span><span class="kobospan" id="kobo.1415.2">? </span><span class="kobospan" id="kobo.1415.3">Select an operation Replace
? </span><span class="kobospan" id="kobo.1415.4">ID? </span><span class="kobospan" id="kobo.1415.5">1
? </span><span class="kobospan" id="kobo.1415.6">Name? </span><span class="kobospan" id="kobo.1415.7">Joe
? </span><span class="kobospan" id="kobo.1415.8">Age? </span><span class="kobospan" id="kobo.1415.9">20
? </span><span class="kobospan" id="kobo.1415.10">Years? </span><span class="kobospan" id="kobo.1415.11">10
? </span><span class="kobospan" id="kobo.1415.12">Next Age? </span><span class="kobospan" id="kobo.1415.13">25
400 Bad Request
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1416.1">The combination of request and model validation ensures that the web service only receives and stores valid data, while the abstracted HTTP and validation features help simplify the web service implementation so that it is easier to understand and maintain.</span></p>
<h1 class="heading" id="_idParaDest-255"><span class="kobospan" id="kobo.1417.1">Using a package for web services</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.1418.1">There are excellent packages available for creating web services, although the lack of standardization means that you have to find one that suits your preferences about how web services should function, which may be different from the approach I have taken in this chapter. </span><span class="kobospan" id="kobo.1418.2">I like the </span><a id="_idIndexMarker761" class="calibre3"/><span class="kobospan" id="kobo.1419.1">Feathers package (</span><a href="https://feathersjs.com" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.1420.1">https://feathersjs.com</span></span></a><span class="kobospan" id="kobo.1421.1">), which works similarly to the custom code in this chapter and has good integrations with popular databases </span><a id="_idIndexMarker762" class="calibre3"/><span class="kobospan" id="kobo.1422.1">and other packages, including Express. </span></p>
<p class="normal"><span class="kobospan" id="kobo.1423.1">But there are plenty of good packages available, and a good tip is to search for microservices, which has become such a hot term that some packages position themselves as being part of the microservices ecosystem.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1424.1">Run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.1425.1">Listing 14.42</span></em><span class="kobospan" id="kobo.1426.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.1427.1">part2app</span></code><span class="kobospan" id="kobo.1428.1"> folder to install the Feathers package and the integrations with Express. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1429.1">Listing 14.42: Installing packages</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.1430.1">npm install @feathersjs/feathers@5.0.14
npm install @feathersjs/express@5.0.14
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1431.1">The </span><a id="_idIndexMarker763" class="calibre3"/><span class="kobospan" id="kobo.1432.1">Feathers packages contain TypeScript type declarations, but they override the declarations for the Express package. </span><span class="kobospan" id="kobo.1432.2">A change to the compiler configuration is required to work around this issue, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1433.1">Listing 14.43</span></em><span class="kobospan" id="kobo.1434.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1435.1">Listing 14.43: Changing the compiler configuration in the tsconfig.json file in the part2app folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1436.1">{
    "extends": "@tsconfig/node20/tsconfig.json",
     "compilerOptions": {                      
         "rootDir": "src/server",  
         "outDir": "dist/server/",
         </span><strong class="screentext"><span class="kobospan" id="kobo.1437.1">"noImplicitAny": false</span></strong><span class="kobospan" id="kobo.1438.1">
     },
     "include": ["src/server/**/*"]
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1439.1">The Feathers integration with Express works by extending the existing API, and the type declarations that the package provides are different from those provided by the </span><code class="inlinecode"><span class="kobospan" id="kobo.1440.1">@types/express</span></code><span class="kobospan" id="kobo.1441.1"> package.</span></p>
<h2 class="heading1" id="_idParaDest-256"><span class="kobospan" id="kobo.1442.1">Creating an adaptor for web services</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.1443.1">The </span><a id="_idIndexMarker764" class="calibre3"/><span class="kobospan" id="kobo.1444.1">Feathers package describes web </span><a id="_idIndexMarker765" class="calibre3"/><span class="kobospan" id="kobo.1445.1">services using a series of methods, similar to the interface used by the custom code earlier in the chapter. </span><span class="kobospan" id="kobo.1445.2">There are some small differences, but the two approaches are similar enough that a simple adapter will allow the custom HTTP-handling code to be replaced with the Feathers package, without needing to make changes to the web service. </span><span class="kobospan" id="kobo.1445.3">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.1446.1">feathers_adapter.ts</span></code><span class="kobospan" id="kobo.1447.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1448.1">src/server/api</span></code><span class="kobospan" id="kobo.1449.1"> folder with the contents shown in </span><em class="italic"><span class="kobospan" id="kobo.1450.1">Listing 14.44</span></em><span class="kobospan" id="kobo.1451.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1452.1">Listing 14.44: The contents of the feathers_adapter.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1453.1">import { Id, NullableId, Params } from "@feathersjs/feathers";
import { WebService } from "./http_adapter";
export class FeathersWrapper&lt;T&gt; {
       
    constructor(private ws: WebService&lt;T&gt;) {}
    get(id: Id) {
        return this.ws.getOne(id);
    }
    find(params: Params) {
        return this.ws.getMany(params.query);
    }
    create(data: any, params: Params) {
        return this.ws.store(data);
    }
    remove(id: NullableId, params: Params) {
        return this.ws.delete(id);
    }  
    update(id: NullableId, data: any, params: Params) {
        return this.ws.replace(id, data);
    }
    patch(id: NullableId, data: any, params: Params) {
        return this.ws.modify(id, data);
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1454.1">The </span><a id="_idIndexMarker766" class="calibre3"/><span class="kobospan" id="kobo.1455.1">Feathers API provides types that</span><a id="_idIndexMarker767" class="calibre3"/><span class="kobospan" id="kobo.1456.1"> represent </span><code class="inlinecode"><span class="kobospan" id="kobo.1457.1">ID</span></code><span class="kobospan" id="kobo.1458.1"> values, request bodies, and query parameters, but there are only so many ways an HTTP request can be represented, so it is a simple process to bridge between the Feathers package and the custom code. </span><span class="kobospan" id="kobo.1458.2">Later examples will use the Feathers API directly, but this approach demonstrates how easy it is to adapt existing code to work with third-party packages.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1459.1">The Feathers integration with Express assumes that Feathers will extend the Express API to add features. </span><em class="italic"><span class="kobospan" id="kobo.1460.1">Listing 14.45</span></em><span class="kobospan" id="kobo.1461.1"> uses the Feathers functionality to create a web service without changing the rest of the application.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1462.1">Listing 14.45: Using Feathers in the index.ts file in the src/server/api folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1463.1">import { Express } from "express";
import { createAdapter } from "./http_adapter";
import { ResultWebService } from "./results_api";
import { Validator } from "./validation_adapter";
import { ResultWebServiceValidation } from "./results_api_validation";
</span><strong class="screentext"><span class="kobospan" id="kobo.1464.1">import</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1465.1"> { FeathersWrapper } from "./feathers_adapter";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1466.1">import { feathers } from "@feathersjs/feathers";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1467.1">import feathersExpress, { rest } from "@feathersjs/express";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1468.1">import</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1469.1"> { ValidationError } from "./validation_types";</span></strong><span class="kobospan" id="kobo.1470.1">
export const createApi = (app: Express) =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.1471.1">// createAdapter(app, new Validator(new ResultWebService(),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1472.1">    //     ResultWebServiceValidation), "/api/results");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1473.1">    const feathersApp = feathersExpress(feathers(), app).configure(rest());</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1474.1">    const service = new Validator(</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1475.1">new ResultWebService(),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1476.1">        ResultWebServiceValidation);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1477.1">    feathersApp.use('/api/results', new FeathersWrapper(service));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1478.1">    feathersApp.hooks({</span></strong>
<strong class="screentext">        </strong><strong class="screentext"><span class="kobospan" id="kobo.1479.1">error: {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1480.1">            all: [(ctx) =&gt; {                       </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1481.1">                    if (ctx.error instanceof ValidationError) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1482.1">                        ctx.http = { status: </span></strong><strong class="screentext"><span class="kobospan" id="kobo.1483.1">400};</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1484.1">                        ctx.error = undefined;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1485.1">                    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1486.1">                }]</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1487.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1488.1">    });</span></strong><span class="kobospan" id="kobo.1489.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1490.1">The </span><a id="_idIndexMarker768" class="calibre3"/><span class="kobospan" id="kobo.1491.1">enhanced version of Express is created by </span><a id="_idIndexMarker769" class="calibre3"/><span class="kobospan" id="kobo.1492.1">this statement:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1493.1">...
</span><span class="kobospan" id="kobo.1493.2">const feathersApp = feathersExpress(feathers(), app).configure(rest());
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1494.1">This incantation enables Feathers and configures it to support RESTful queries. </span><span class="kobospan" id="kobo.1494.2">Feathers can be used in different ways, and RESTful requests are only one of the ways that clients can communicate with Feathers’ server-side components.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1495.1">Feathers </span><a id="_idIndexMarker770" class="calibre3"/><span class="kobospan" id="kobo.1496.1">supports </span><em class="italic"><span class="kobospan" id="kobo.1497.1">hooks</span></em><span class="kobospan" id="kobo.1498.1">, which allow functions</span><a id="_idIndexMarker771" class="calibre3"/><span class="kobospan" id="kobo.1499.1"> to be executed at key moments in the request life cycle. </span><span class="kobospan" id="kobo.1499.2">Hooks are a useful feature and can be used for tasks </span><a id="_idIndexMarker772" class="calibre3"/><span class="kobospan" id="kobo.1500.1">including validation and error handling. </span><span class="kobospan" id="kobo.1500.2">Validation is handled by the custom code in this example, but this statement defines a hook that will be invoked when an exception is thrown while handling a request:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1501.1">...
</span><span class="kobospan" id="kobo.1501.2">feathersApp.hooks({
    error: {
        all: [(ctx) =&gt; {
            if (ctx.error instanceof ValidationError) {
                ctx.http = { status: 400};
                ctx.error = undefined;
            }
        }]
    }
});
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1502.1">The custom code throws </span><code class="inlinecode"><span class="kobospan" id="kobo.1503.1">ValidationError</span></code><span class="kobospan" id="kobo.1504.1"> when validation fails, which Feathers handles by sending a 500 response. </span><span class="kobospan" id="kobo.1504.2">Hooks receives a context object that provides details of the request and its outcome, and this statement changes the response status code if </span><code class="inlinecode"><span class="kobospan" id="kobo.1505.1">ValidationError</span></code><span class="kobospan" id="kobo.1506.1"> has occurred. </span><span class="kobospan" id="kobo.1506.2">There is no change in the way the web service works because it uses the same custom code-handling requests. </span><span class="kobospan" id="kobo.1506.3">But, having seen how RESTful web services operate and how they can be created, moving to a package such as Feathers allows the same features to be utilized without the need for custom code.</span></p>
<h1 class="heading" id="_idParaDest-257"><span class="kobospan" id="kobo.1507.1">Summary</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.1508.1">In this chapter, I demonstrated how the HTTP features provided by Node.js and enhanced by the Express package, can be used to create a RESTful web service.</span></p>
<ul class="calibre4">
<li class="bulletlist"><span class="kobospan" id="kobo.1509.1">The HTTP request URL identifies the data and the HTTP method denotes the operation that will be performed.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1510.1">The JSON format is used by most web services, which has replaced XML as the default data format.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1511.1">There is little standardization in the way that web services are implemented, although there are some common conventions that are widely used, particularly relating to the operations that HTTP methods represent.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1512.1">The data received by web services must be validated before it can be safely used.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1513.1">Web services are most easily written by separating the implementation from the code that handles HTTP requests and performs validation.</span></li>
</ul>
<p class="normal"><span class="kobospan" id="kobo.1514.1">In the next chapter, I will demonstrate how HTTP requests can be authenticated and how the user’s identity can be used for authorization.</span></p>
</div>
</body></html>