<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch11"/>Chapter 11. Adding Security and Authentication</h1></div></div></div><p>In previous chapters, we mocked up users so that we could test various functions, but obviously this isn't how we want our application to work going forward. We want only authorized users to be able to add and edit their lists and share them with others. Our application is currently not very secure.</p><p>Authentication is a basic functionality of almost every web application. We have a great option for managing users signing up, logging in, and accessing privileged routes. We will install Passport authentication middleware for Node.js, configure it for local authentication, and set up session management. We will secure our dashboard route so that only authenticated users see their own dashboard.</p><p>In this chapter, we will use Node.js and Express middleware to secure our SPA by preventing common exploits such as <strong>Cross-Site Request Forgery</strong> (<strong>CSRF</strong>). We'll also talk about additional security concerns that we'll handle during deployment.</p><p>Here are the topics that would be covered in this chapter:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Setting up <strong>Passport</strong> to authenticate users</li><li class="listitem" style="list-style-type: disc">Creating local authentication strategies for signing up and logging in</li><li class="listitem" style="list-style-type: disc">Modeling users with <strong>Mongoose</strong></li><li class="listitem" style="list-style-type: disc">Securing routes</li><li class="listitem" style="list-style-type: disc">Adding security headers and preventing CSRF attacks on our application</li></ul></div><div><div><div><div><h1 class="title"><a id="ch11lvl1sec61"/>Adding authentication with Passport</h1></div></div></div><p>Passport is a Node.js plugin that has the singular purpose of authenticating requests. That is, making sure only people who are logged in and who should be able to make certain requests are able to do so. Authentication is a basic security feature of every web application, including SPAs.</p><p>Passport is extremely flexible, allowing authentication through a number of different means, called strategies. Strategies include logging in with a simple username and password, or using <strong>OAuth</strong> to log in with Facebook or Twitter. Passport provides over 100 different strategies we should use for authentication. This chapter will focus on a local authentication strategy, while the following chapter will integrate social media strategies.</p><p>Like most plugins used with Express, Passport is middleware and so its use will be familiar to us. This is a great architecture as well, because it keeps concerns separated in our application.</p><div><div><div><div><h2 class="title"><a id="ch11lvl2sec128"/>Installing Passport</h2></div></div></div><p>The first thing we need to do is to install Passport. Getting the actual Passport module couldn't be easier, we just use <code class="literal">npm</code> to install it:</p><pre class="programlisting">
<strong>$ npm install passport --save</strong>
<strong>passport@0.3.2 node_modules/passport</strong>
<strong>|- pause@0.0.1</strong>
<strong>|_ passport-strategy@1.0.0</strong>
</pre><p>We also need to install each strategy we're going to use for Passport separately:</p><pre class="programlisting">
<strong>$ npm install passport-local -save</strong>
<strong>passport-local@1.0.0 node_modules/passport-local</strong>
<strong>|_ passport-strategy@1.0.0</strong>
</pre><p>The last thing we need is some middleware to manage user sessions. For that, we'll install the <code class="literal">express-session</code> package:</p><pre class="programlisting">
<strong>$ npm install express-session -save</strong>
<strong>express-session@1.13.0 node_modules/express-session</strong>
<strong>|- utils-merge@1.0.0</strong>
<strong>|- cookie-signature@1.0.6</strong>
<strong>|- parseurl@1.3.1</strong>
<strong>|- cookie@0.2.3</strong>
<strong>|- on-headers@1.0.1</strong>
<strong>|- depd@1.1.0</strong>
<strong>|- crc@3.4.0</strong>
<strong>|- uid-safe@2.0.0 (base64-url@1.2.1)</strong>
</pre><p>Next, we need to add Passport into our app. Open up our main <code class="literal">app.js</code> file and make the following modifications:</p><pre class="programlisting">var express = require('express'); &#13;
var path = require('path'); &#13;
var favicon = require('serve-favicon'); &#13;
var logger = require('morgan'); &#13;
var cookieParser = require('cookie-parser'); &#13;
var bodyParser = require('body-parser'); &#13;
var isJSON = require('./utils/json'); &#13;
var routing = require('resource-routing'); &#13;
var controllers = path.resolve('./controllers'); &#13;
 &#13;
//Database stuff &#13;
var mongodb = require('mongodb'); &#13;
var monk = require('monk'); &#13;
var db = monk('localhost:27017/giftapp'); &#13;
 &#13;
var routes = require('./routes/index'); &#13;
var users = require('./routes/users'); &#13;
var dashboard = require('./routes/dashboard'); &#13;
 &#13;
var app = express(); &#13;
 &#13;
// view engine setup &#13;
app.set('views', path.join(__dirname, 'views')); &#13;
app.set('view engine', 'ejs'); &#13;
 &#13;
app.set('x-powered-by', false); &#13;
 &#13;
app.locals.appName = "My Gift App"; &#13;
 &#13;
// uncomment after placing your favicon in /public &#13;
//app.use(favicon(path.join(__dirname, 'public', 'favicon.ico'))); &#13;
app.use(logger('dev')); &#13;
app.use(bodyParser.json()); &#13;
app.use(bodyParser.urlencoded({ extended: false })); &#13;
app.use(cookieParser()); &#13;
app.use(express.static(path.join(__dirname, 'public'))); &#13;
app.use(isJSON); &#13;
 &#13;
<strong>var passport = require('passport');</strong>
<strong>var expressSession = require('express-session');</strong>
<strong>app.use(expressSession({secret: 'someKeyYouPick'}));</strong>
<strong>app.use(passport.initialize());</strong>
<strong>app.use(passport.session());</strong> &#13;
 &#13;
//Database middleware &#13;
app.use(function(req,res,next){ &#13;
    req.db = db; &#13;
    next(); &#13;
}); &#13;
 &#13;
app.use('/', routes); &#13;
app.use('/users', users); &#13;
app.use('/dash', dashboard); &#13;
 &#13;
routing.resources(app, controllers, "giftlist"); &#13;
routing.expose_routing_table(app, { at: "/my-routes" }); &#13;
 &#13;
// catch 404 and forward to error handler &#13;
app.use(function(req, res, next) { &#13;
  var err = new Error('Not Found'); &#13;
  err.status = 404; &#13;
  next(err); &#13;
}); &#13;
 &#13;
// error handlers &#13;
 &#13;
// development error handler &#13;
// will print stacktrace &#13;
if (app.get('env') === 'development') { &#13;
  app.use(function(err, req, res, next) { &#13;
    res.status(err.status || 500); &#13;
    res.render('error', { &#13;
      message: err.message, &#13;
      error: err &#13;
    }); &#13;
  }); &#13;
} &#13;
 &#13;
// production error handler &#13;
// no stacktraces leaked to user &#13;
app.use(function(err, req, res, next) { &#13;
  res.status(err.status || 500); &#13;
  res.render('error', { &#13;
    message: err.message, &#13;
    error: {} &#13;
  }); &#13;
}); &#13;
 &#13;
 &#13;
module.exports = app; &#13;
</pre><p>It's important that we require and initialize Passport before any of the routing, to make sure our authentication is available to our routes. In initializing <code class="literal">expressSession</code>, set a secret key that's something different than what I've given you here. It can be any string, really.</p><p>We are almost ready. Express local strategy assumes users stored in a MongoDB database. We already have a MongoDB database with a users' table, but we really need to enforce some consistency, and it would be nice to have an easy way to model our data.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec129"/>Using Mongoose to configure the database</h2></div></div></div><p>We're going to use a package called Mongoose. Mongoose is a data modeling tool for Node.js, used widely in Express packages. Where we accessed our database directly before, we are now going to let Mongoose do a lot of the heavy lifting for us.</p><div><div><div><div><h3 class="title"><a id="ch11lvl3sec143"/>Installing and configuring Mongoose</h3></div></div></div><p>As with other modules, we will use <code class="literal">npm</code> to install <code class="literal">mongoose</code>:</p><pre class="programlisting">
<strong>$ npm install mongoose -save</strong>
<strong>mongoose@4.3.7 node_modules/mongoose</strong>
<strong>|- ms@0.7.1</strong>
<strong>|- regexp-clone@0.0.1</strong>
<strong>|- hooks-fixed@1.1.0</strong>
<strong>|- async@0.9.0</strong>
<strong>|- mpromise@0.5.4</strong>
<strong>|- mpath@0.1.1</strong>
<strong>|- muri@1.0.0</strong>
<strong>|- sliced@0.0.5</strong>
<strong>|- kareem@1.0.1</strong>
<strong>|- bson@0.4.21</strong>
<strong>|- mquery@1.6.3 (bluebird@2.9.26)</strong>
<strong>|_ mongodb@2.1.4 (es6-promise@3.0.2, readable-stream@1.0.31, kerberos@0.0.18, mongodb-core@1.2.32)</strong>
</pre><p>Now we will add the code to initialize Mongoose in our <code class="literal">app.js</code> file:</p><pre class="programlisting">var express = require('express'); &#13;
var path = require('path'); &#13;
var favicon = require('serve-favicon'); &#13;
var logger = require('morgan'); &#13;
var cookieParser = require('cookie-parser'); &#13;
var bodyParser = require('body-parser'); &#13;
var isJSON = require('./utils/json'); &#13;
var routing = require('resource-routing'); &#13;
var controllers = path.resolve('./controllers'); &#13;
 &#13;
//Database stuff &#13;
var mongodb = require('mongodb'); &#13;
var monk = require('monk'); &#13;
var db = monk('localhost:27017/giftapp'); &#13;
 &#13;
<strong>var mongoose = require('mongoose');</strong>
<strong>mongoose.connect('localhost:27017/giftapp');</strong> &#13;
 &#13;
var routes = require('./routes/index'); &#13;
var users = require('./routes/users'); &#13;
var dashboard = require('./routes/dashboard'); &#13;
 &#13;
var app = express(); &#13;
 &#13;
// view engine setup &#13;
app.set('views', path.join(__dirname, 'views')); &#13;
app.set('view engine', 'ejs'); &#13;
 &#13;
app.set('x-powered-by', false); &#13;
 &#13;
app.locals.appName = "My Gift App"; &#13;
 &#13;
// uncomment after placing your favicon in /public &#13;
//app.use(favicon(path.join(__dirname, 'public', 'favicon.ico'))); &#13;
app.use(logger('dev')); &#13;
app.use(bodyParser.json()); &#13;
app.use(bodyParser.urlencoded({ extended: false })); &#13;
app.use(cookieParser()); &#13;
app.use(express.static(path.join(__dirname, 'public'))); &#13;
app.use(isJSON); &#13;
 &#13;
var passport = require('passport'); &#13;
var expressSession = require('express-session'); &#13;
app.use(expressSession({secret: 'mySecretKey'})); &#13;
app.use(passport.initialize()); &#13;
app.use(passport.session()); &#13;
 &#13;
//Database middleware &#13;
app.use(function(req,res,next){ &#13;
    req.db = db; &#13;
    next(); &#13;
}); &#13;
 &#13;
app.use('/', routes); &#13;
app.use('/users', users); &#13;
app.use('/dash', dashboard); &#13;
 &#13;
routing.resources(app, controllers, "giftlist"); &#13;
routing.expose_routing_table(app, { at: "/my-routes" }); &#13;
 &#13;
// catch 404 and forward to error handler &#13;
app.use(function(req, res, next) { &#13;
  var err = new Error('Not Found'); &#13;
  err.status = 404; &#13;
  next(err); &#13;
}); &#13;
 &#13;
// error handlers &#13;
 &#13;
// development error handler &#13;
// will print stacktrace &#13;
if (app.get('env') === 'development') { &#13;
  app.use(function(err, req, res, next) { &#13;
    res.status(err.status || 500); &#13;
    res.render('error', { &#13;
      message: err.message, &#13;
      error: err &#13;
    }); &#13;
  }); &#13;
} &#13;
 &#13;
// production error handler &#13;
// no stacktraces leaked to user &#13;
app.use(function(err, req, res, next) { &#13;
  res.status(err.status || 500); &#13;
  res.render('error', { &#13;
    message: err.message, &#13;
    error: {} &#13;
  }); &#13;
}); &#13;
 &#13;
 &#13;
module.exports = app; &#13;
</pre><p>Here, we require in the Mongoose library and initialize it with the URL of our local database.</p></div><div><div><div><div><h3 class="title"><a id="ch11lvl3sec144"/>Creating the user model</h3></div></div></div><p>Mongoose uses predefined data models to validate, store, and access MongoDB databases. We need to create a model that will represent our user documents. We already have a <code class="literal">users</code> collection in our <code class="literal">db</code>, so let's blow that away to avoid any conflicts or confusion.</p><p>Make sure you have a terminal window open with the Mongo daemon running. If not, just open a new terminal and type <code class="literal">mongod</code> to start it. In a second terminal window, start the MongoDB command-line tool by typing <code class="literal">mongo</code>.</p><p>Once that's running, type the following:</p><pre class="programlisting">
<strong>&gt; use giftapp</strong>
<strong>switched to db giftapp</strong>
<strong>&gt; show collections</strong>
<strong>giftapp</strong>
<strong>giftlist</strong>
<strong>system.indexes</strong>
<strong>test</strong>
<strong>users</strong>
<strong>&gt; db.users.drop()</strong>
<strong>true</strong>
<strong>&gt; show collections</strong>
<strong>giftapp</strong>
<strong>giftlist</strong>
<strong>system.indexes</strong>
<strong>test</strong>
</pre><p>We make sure we're using the Gift App database. We then run <code class="literal">showcollections</code> to list the collections, and see there's a <code class="literal">users</code> collection. We run the <code class="literal">db.users.drop()</code> collection method to drop the collection. Then we show the collections again to check that the users collection has been removed.</p><p>With that complete, create a new folder called models. Inside that folder, create a file called <code class="literal">user.js</code>:</p><pre class="programlisting">var mongoose = require('mongoose'); &#13;
var Schema = mongoose.Schema; &#13;
module.exports = mongoose.model('User', new Schema({ &#13;
    id: String, &#13;
    username: String, &#13;
    email: String, &#13;
    password: String, &#13;
    firstName: String, &#13;
    lastName: String &#13;
})); &#13;
</pre><p>We require mongoose at the top of the file and then create a model called <code class="literal">User</code> with the <code class="literal">mongoose.model()</code> function. That function takes a string, which becomes the model name, and an object, which represents the actual model. In our case, we have an <code class="literal">id</code>, <code class="literal">username</code>, <code class="literal">email</code>, <code class="literal">password</code>, <code class="literal">firstName</code>, and <code class="literal">lastName</code>, which are each defined as strings. Mongoose will ensure that every <code class="literal">User</code> document stored in our database matches this format definition.</p><div><div><h3 class="title"><a id="note14"/>Note</h3><p>The default for the Passport local strategy is for there to be a <code class="literal">username</code> and <code class="literal">password</code> field. This could be changed if you wanted to just use <code class="literal">email</code> and <code class="literal">password</code> or some other scheme.</p></div></div></div></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec130"/>Setting up Passport strategies</h2></div></div></div><p>Now we have to set up a local Passport strategy. We need to extend this strategy to handle users logging in and signing up.</p><div><div><div><div><h3 class="title"><a id="ch11lvl3sec145"/>Initializing Passport</h3></div></div></div><p>Create a new directory called <code class="literal">passport</code>. Create a file called <code class="literal">init.js</code>:</p><pre class="programlisting">var User = require('../models/user'); &#13;
 &#13;
module.exports = function(passport){ &#13;
  passport.serializeUser(function(user, done) { &#13;
        done(null, user._id); &#13;
    }); &#13;
 &#13;
    passport.deserializeUser(function(id, done) { &#13;
        User.findById(id, function(err, user) { &#13;
 &#13;
            done(err, user); &#13;
        }); &#13;
    }); &#13;
} &#13;
</pre><p>This code gives Passport access to our <code class="literal">User</code> model. The serialize and deserialize functions are used to look up a user from the database (deserialize) and to store user information to the session of <code class="literal">User</code> (serialize).</p><p>Now let's initialize Passport using our <code class="literal">init</code> function in our main <code class="literal">app.js</code> file:</p><pre class="programlisting">var express = require('express'); &#13;
var path = require('path'); &#13;
var favicon = require('serve-favicon'); &#13;
var logger = require('morgan'); &#13;
var cookieParser = require('cookie-parser'); &#13;
var bodyParser = require('body-parser'); &#13;
var isJSON = require('./utils/json'); &#13;
var routing = require('resource-routing'); &#13;
var controllers = path.resolve('./controllers'); &#13;
 &#13;
//Database stuff &#13;
var mongodb = require('mongodb'); &#13;
 &#13;
var mongoose = require('mongoose'); &#13;
mongoose.connect('localhost:27017/giftapp'); &#13;
 &#13;
var routes = require('./routes/index'); &#13;
var users = require('./routes/users'); &#13;
var dashboard = require('./routes/dashboard'); &#13;
 &#13;
var app = express(); &#13;
 &#13;
// view engine setup &#13;
app.set('views', path.join(__dirname, 'views')); &#13;
app.set('view engine', 'ejs'); &#13;
 &#13;
app.set('x-powered-by', false); &#13;
 &#13;
app.locals.appName = "My Gift App"; &#13;
 &#13;
// uncomment after placing your favicon in /public &#13;
//app.use(favicon(path.join(__dirname, 'public', 'favicon.ico'))); &#13;
app.use(logger('dev')); &#13;
app.use(bodyParser.json()); &#13;
app.use(bodyParser.urlencoded({ extended: false })); &#13;
app.use(cookieParser()); &#13;
app.use(express.static(path.join(__dirname, 'public'))); &#13;
app.use(isJSON); &#13;
 &#13;
<strong>var flash = require('connect-flash');</strong>
<strong>app.use(flash());</strong> &#13;
 &#13;
var passport = require('passport'); &#13;
var expressSession = require('express-session'); &#13;
app.use(expressSession({secret: 'mySecretKey'})); &#13;
app.use(passport.initialize()); &#13;
app.use(passport.session()); &#13;
 &#13;
<strong>var initializePassport = require('./passport/init');</strong>
<strong>initializePassport(passport);</strong> &#13;
 &#13;
//Database middleware &#13;
app.use(function(req,res,next){ &#13;
    req.db = db; &#13;
    next(); &#13;
}); &#13;
 &#13;
app.use('/', routes); &#13;
app.use('/users', users); &#13;
app.use('/dash', dashboard); &#13;
 &#13;
routing.resources(app, controllers, "giftlist"); &#13;
routing.expose_routing_table(app, { at: "/my-routes" }); &#13;
 &#13;
// catch 404 and forward to error handler &#13;
app.use(function(req, res, next) { &#13;
  var err = new Error('Not Found'); &#13;
  err.status = 404; &#13;
  next(err); &#13;
}); &#13;
 &#13;
// error handlers &#13;
 &#13;
// development error handler &#13;
// will print stacktrace &#13;
if (app.get('env') === 'development') { &#13;
  app.use(function(err, req, res, next) { &#13;
    res.status(err.status || 500); &#13;
    res.render('error', { &#13;
      message: err.message, &#13;
      error: err &#13;
    }); &#13;
  }); &#13;
} &#13;
 &#13;
// production error handler &#13;
// no stacktraces leaked to user &#13;
app.use(function(err, req, res, next) { &#13;
  res.status(err.status || 500); &#13;
  res.render('error', { &#13;
    message: err.message, &#13;
    error: {} &#13;
  }); &#13;
}); &#13;
  &#13;
module.exports = app; &#13;
</pre><p>We require in our <code class="literal">init</code> file, assigning the exported function to the variable name <code class="literal">initializePassport</code>, then we invoke that function passing an instance of Passport into it.</p><p>We also added a new library before the Passport code, <code class="literal">connect-flash</code>. This allows us to store flash messages in session such as <em>invalid password</em> and pass them back to display to a view. We need to install this software with <code class="literal">npm</code>:</p><pre class="programlisting">
<strong>$ npm install connect-flash --save</strong>
<strong>connect-flash@0.1.1 node_modules/connect-flash</strong>
</pre></div><div><div><div><div><h3 class="title"><a id="ch11lvl3sec146"/>Creating the signup strategy</h3></div></div></div><p>Now let's build out and require the strategy for signing users up.</p><p>First things first, we need to add a library for hashing the user password so we don't store unencrypted passwords in our database, that's bad news. We're going to use a module called <code class="literal">bycrypt-nodejs</code>, which is easily installed using <code class="literal">npm</code>:</p><pre class="programlisting">
<strong>$ npm install bcrypt-nodejs --save</strong>
<strong>bcrypt-nodejs@0.0.3 node_modules/bcrypt-nodejs</strong>
</pre><p>In your <code class="literal">passport</code> directory, create a new file called <code class="literal">signup.js</code>:</p><pre class="programlisting">var LocalStrategy   = require('passport-local').Strategy; &#13;
var User = require('../models/user'); &#13;
var bCrypt = require('bcrypt-nodejs'); &#13;
 &#13;
module.exports = function(passport){ &#13;
 &#13;
    passport.use('signup', new LocalStrategy({ &#13;
            passReqToCallback : true &#13;
        }, &#13;
        function(req, username, password, done) { &#13;
            //this is asynchronous &#13;
            process.nextTick(function () { &#13;
                console.log('inside signup'); &#13;
                // see if user already exists &#13;
                User.findOne({'username': username}, function (err, user) { &#13;
                    if (err) { &#13;
                        console.log('Error in SignUp: ' + err); &#13;
                        return done(err); &#13;
                    } &#13;
                    // user exists &#13;
                    if (user) { &#13;
                        console.log('User already exists'); &#13;
                        return done(null, false, req.flash('message', 'User&#13;
                        Already Exists')); &#13;
                    } else { &#13;
                        //create a new User and store to the&#13;
                        database &#13;
                        var user = new User(); &#13;
 &#13;
                        user.username = username; &#13;
                        user.email = req.param('email'); &#13;
                        user.password = &#13;
                        bCrypt.hashSync(password,&#13;
                        bCrypt.genSaltSync(10), null); &#13;
                        user.firstName = &#13;
                        req.param('firstName'); &#13;
                        user.lastName = req.param('lastName'); &#13;
 &#13;
 &#13;
                        user.save(function (err) { &#13;
                            if (err) { &#13;
                                console.log('save error ' + &#13;
                                             err); &#13;
                                throw err; &#13;
                            } &#13;
                            console.log("saving") &#13;
                            return done(null, user); &#13;
                        }); &#13;
                    } &#13;
                }); &#13;
            }); &#13;
 &#13;
        }) &#13;
    ); &#13;
 &#13;
} &#13;
</pre><p>We require the modules we need, which includes a reference to the Mongoose <code class="literal">User</code> module. We set up the strategy with a call to <code class="literal">passport.use()</code>. The first argument is the name of the strategy, in this case, <code class="literal">signup</code>. The next argument is a call to construct a new <code class="literal">LocalStrategy</code>.</p><p>That call receives an object, in this case containing <code class="literal">passReqToCallback = true</code>. This makes the request object available to the callback function, which is next. This is important so that we have the info for the signup.</p><p>The callback function sets up a new function called <code class="literal">newSignup</code>, which does the bulk of the work. We first search to see if there is a user with the specified username. If there is, we exit and set a flash message that the user already exists. If the user doesn't exist, we create a new one. Finally, we pass the function to the next tick of the Node.js event loop to be executed.</p><p>You'll note that the actual callback functionality executes inside a call to <code class="literal">process.nextTick()</code> due to the asynchronous nature of this call.</p><p>Now let's edit our <code class="literal">init.js</code> file to include and initialize our signup strategy:</p><pre class="programlisting">var signup = require('./signup'); &#13;
var User = require('../models/user'); &#13;
 &#13;
module.exports = function(passport){ &#13;
 &#13;
  passport.serializeUser(function(user, done) { &#13;
 &#13;
        done(null, user._id); &#13;
    }); &#13;
 &#13;
    passport.deserializeUser(function(id, done) { &#13;
        User.findById(id, function(err, user) { &#13;
 &#13;
            done(err, user); &#13;
        }); &#13;
    }); &#13;
 &#13;
    signup(passport); &#13;
 &#13;
} &#13;
</pre><p>We simply require our signup module and then invoke the exported function inside our <code class="literal">init</code> function.</p></div><div><div><div><div><h3 class="title"><a id="ch11lvl3sec147"/>Creating the login strategy</h3></div></div></div><p>So, now we have the signup strategy to create users, we need a strategy for users to log in. Create a new file in the <code class="literal">passport</code> directory, called <code class="literal">signin.js</code>:</p><pre class="programlisting">var LocalStrategy   = require('passport-local').Strategy; &#13;
var User = require('../models/user'); &#13;
var bCrypt = require('bcrypt-nodejs'); &#13;
 &#13;
module.exports = function(passport){ &#13;
 &#13;
    passport.use('login', new LocalStrategy({ &#13;
            passReqToCallback : true &#13;
        }, &#13;
        function(req, username, password, done) { &#13;
             &#13;
            User.findOne({ 'username' :  username }, &#13;
                function(err, user) { &#13;
                    if (err) &#13;
                        return done(err); &#13;
                    if (!user){ &#13;
                        // username not found &#13;
                        return done(null, false, req.flash('message', 'Username&#13;
                        or password incorrect.')); &#13;
                    } &#13;
 &#13;
                    if (!bCrypt.compareSync(password, user.password)){ &#13;
                        //password is invalid &#13;
                        return done(null, false, req.flash('message', 'Username &#13;
                        or password incorrect.')); &#13;
                    } &#13;
                    //success condition &#13;
                    return done(null, user); &#13;
                } &#13;
            ); &#13;
 &#13;
        }) &#13;
    ); &#13;
     &#13;
} &#13;
</pre><p>Once again, we require in our dependencies. We then create and export a function that, when invoked, creates a new Passport strategy for login.</p><p>The first thing we do is query the database to see if a user with our <code class="literal">username</code> exists. If the user doesn't exist, we set an error message in the flash and return the result of the done function, with the second argument being false.</p><p>The next step, assuming we matched on a <code class="literal">username</code>, is to use the <code class="literal">bCrypt.compareSync()</code> function to check that the password passed in matches the hashed password for the user from the database. If it doesn't, we again set an error message on the flash and then return done, with the second argument being false.</p><p>Finally, assuming the <code class="literal">username</code> returns a <code class="literal">user</code>, and the <code class="literal">password</code> matches, we authenticate merely by returning done, with the second argument being the <code class="literal">user</code>.</p><p>Now, we'll load and initialize the login strategy in our <code class="literal">init.js</code> file:</p><pre class="programlisting">var signup = require('./signup'); &#13;
var login = require('./login'); &#13;
var User = require('../models/user'); &#13;
 &#13;
module.exports = function(passport){ &#13;
 &#13;
 &#13;
    passport.serializeUser(function(user, done) { &#13;
 &#13;
        done(null, user._id); &#13;
    }); &#13;
 &#13;
    passport.deserializeUser(function(id, done) { &#13;
        User.findById(id, function(err, user) { &#13;
 &#13;
            done(err, user); &#13;
        }); &#13;
    }); &#13;
 &#13;
    signup(passport); &#13;
    login(passport); &#13;
 &#13;
} &#13;
</pre><p>Just like with the signup strategy, we simply require the login strategy module then invoke the exported function.</p></div><div><div><div><div><h3 class="title"><a id="ch11lvl3sec148"/>Creating routes for authentication</h3></div></div></div><p>Now we've set up Passport, we can't quite sign up or log in users yet. We need to set up routes and views to render the signup and login experience.</p><p>Create a new file called <code class="literal">login.js</code> in your <code class="literal">routes</code> folder:</p><pre class="programlisting">var express = require('express'); &#13;
var router = express.Router(); &#13;
 &#13;
 &#13;
module.exports = function(passport){ &#13;
 &#13;
 &#13;
    router.get('/', function(req, res) { &#13;
         &#13;
        res.render('login/login', { message: req.flash('message') }); &#13;
    }); &#13;
 &#13;
 &#13;
    router.post('/', passport.authenticate('login', { &#13;
        successRedirect: '/dash', &#13;
        failureRedirect: '/login', &#13;
        failureFlash : true &#13;
    })); &#13;
 &#13;
 &#13;
    router.get('/signup', function(req, res){ &#13;
        res.render('login/signup',{message: req.flash('message')}); &#13;
    }); &#13;
 &#13;
 &#13;
    router.post('/signup', passport.authenticate('signup', { &#13;
        successRedirect: '/dash', &#13;
        failureRedirect: '/login/signup', &#13;
        failureFlash : true &#13;
    })); &#13;
 &#13;
 &#13;
 &#13;
    router.get('/signout', function(req, res) { &#13;
        req.logout(); &#13;
        res.redirect('/login'); &#13;
    }); &#13;
 &#13;
    return router; &#13;
} &#13;
</pre><p>As you can see, we export a function that sets up routes for logging in, signing up, and logging out. We expect an instance of <code class="literal">passport</code> to be passed when the function is invoked. When a user logs in successfully, they will be redirected to the <code class="literal">/dash</code> path.</p><p>Now let's add the routes to our main <code class="literal">app.js</code> file:</p><pre class="programlisting">var express = require('express'); &#13;
var path = require('path'); &#13;
var favicon = require('serve-favicon'); &#13;
var logger = require('morgan'); &#13;
var cookieParser = require('cookie-parser'); &#13;
var bodyParser = require('body-parser'); &#13;
var isJSON = require('./utils/json'); &#13;
var routing = require('resource-routing'); &#13;
var controllers = path.resolve('./controllers'); &#13;
 &#13;
//Database stuff &#13;
var mongodb = require('mongodb'); &#13;
 &#13;
var mongoose = require('mongoose'); &#13;
mongoose.connect('localhost:27017/giftapp'); &#13;
 &#13;
var routes = require('./routes/index'); &#13;
var users = require('./routes/users'); &#13;
var dashboard = require('./routes/dashboard'); &#13;
 &#13;
var app = express(); &#13;
 &#13;
// view engine setup &#13;
app.set('views', path.join(__dirname, 'views')); &#13;
app.set('view engine', 'ejs'); &#13;
 &#13;
app.set('x-powered-by', false); &#13;
 &#13;
app.locals.appName = "My Gift App"; &#13;
 &#13;
// uncomment after placing your favicon in /public &#13;
//app.use(favicon(path.join(__dirname, 'public', 'favicon.ico'))); &#13;
app.use(logger('dev')); &#13;
app.use(bodyParser.json()); &#13;
app.use(bodyParser.urlencoded({ extended: false })); &#13;
app.use(cookieParser()); &#13;
app.use(express.static(path.join(__dirname, 'public'))); &#13;
app.use(isJSON); &#13;
 &#13;
var flash = require('connect-flash'); &#13;
app.use(flash()); &#13;
 &#13;
var passport = require('passport'); &#13;
var expressSession = require('express-session'); &#13;
app.use(expressSession({secret: 'mySecretKey'})); &#13;
app.use(passport.initialize()); &#13;
app.use(passport.session()); &#13;
 &#13;
var initializePassport = require('./passport/init'); &#13;
initializePassport(passport); &#13;
 &#13;
//Database middleware &#13;
app.use(function(req,res,next){ &#13;
    req.db = db; &#13;
    next(); &#13;
}); &#13;
 &#13;
app.use('/', routes); &#13;
app.use('/users', users); &#13;
app.use('/dash', dashboard); &#13;
 &#13;
<strong>var login = require('./routes/login')(passport);</strong>
<strong>app.use('/login', login);</strong> &#13;
 &#13;
routing.resources(app, controllers, "giftlist"); &#13;
routing.expose_routing_table(app, { at: "/my-routes" }); &#13;
 &#13;
// catch 404 and forward to error handler &#13;
app.use(function(req, res, next) { &#13;
  var err = new Error('Not Found'); &#13;
  err.status = 404; &#13;
  next(err); &#13;
}); &#13;
 &#13;
// error handlers &#13;
 &#13;
// development error handler &#13;
// will print stacktrace &#13;
if (app.get('env') === 'development') { &#13;
  app.use(function(err, req, res, next) { &#13;
    res.status(err.status || 500); &#13;
    res.render('error', { &#13;
      message: err.message, &#13;
      error: err &#13;
    }); &#13;
  }); &#13;
} &#13;
 &#13;
// production error handler &#13;
// no stacktraces leaked to user &#13;
app.use(function(err, req, res, next) { &#13;
  res.status(err.status || 500); &#13;
  res.render('error', { &#13;
    message: err.message, &#13;
    error: {} &#13;
  }); &#13;
}); &#13;
 &#13;
 &#13;
module.exports = app; &#13;
</pre><p>You'll notice that we necessarily pass a reference to Passport to the route.</p></div><div><div><div><div><h3 class="title"><a id="ch11lvl3sec149"/>Creating views for authentication</h3></div></div></div><p>Now that we have the routes to sign up and log in, we need views to render and show the <code class="literal">user</code>.</p><p>Create a login folder in your views directory. In that folder, create a new template called <code class="literal">signup.ejs</code>:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html&gt; &#13;
&lt;head &gt; &#13;
    &lt;title&gt;Signup&lt;/title&gt; &#13;
 &#13;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt; &#13;
 &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"&gt; &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"&gt; &#13;
 &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
 &#13;
&lt;nav class="nav navbar-default"&gt; &#13;
    &lt;div class="container-fluid"&gt; &#13;
        &lt;div class="navbar-header"&gt; &#13;
            &lt;a class="navbar-brand" href="#"&gt; Giftapp Signup&lt;/a&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/nav&gt; &#13;
 &#13;
&lt;div class="container"&gt; &#13;
    &lt;% if(message){ %&gt; &#13;
    &lt;div class="row"&gt; &#13;
        &lt;div class="col-md-4 col-md-offset-4" role="alert"&gt; &#13;
            &lt;%= message %&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
    &lt;% } %&gt; &#13;
 &#13;
    &lt;div class="row"&gt; &#13;
        &lt;div class="col-md-6 col-md-offset-3"&gt; &#13;
            &lt;form method="post" action="/login/register"&gt; &#13;
                &lt;div class="form-group"&gt; &#13;
                    &lt;label for="username"&gt;Username&lt;/label&gt; &#13;
                    &lt;input type="text" class="form-control" id="username" &#13;
                     name="username" placeholder="username"&gt; &#13;
                &lt;/div&gt; &#13;
                &lt;div class="form-group"&gt; &#13;
                    &lt;label for="password"&gt;Password&lt;/label&gt; &#13;
                    &lt;input type="password" class="form-control" id="password" &#13;
                     name="password" placeholder="Password"&gt; &#13;
                &lt;/div&gt; &#13;
                &lt;div class="form-group"&gt; &#13;
                    &lt;label for="email"&gt;Email address&lt;/label&gt; &#13;
                    &lt;input type="email" class="form-control" id="email" &#13;
                      name="email" placeholder="Email"&gt; &#13;
                &lt;/div&gt; &#13;
                &lt;div class="form-group"&gt; &#13;
                    &lt;label for="firstName"&gt;First Name&lt;/label&gt; &#13;
                    &lt;input type="text" class="form-control" id="firstName" &#13;
                      name="firstName" placeholder="First Name"&gt; &#13;
                &lt;/div&gt; &#13;
 &#13;
                &lt;div class="form-group"&gt; &#13;
                    &lt;label for="lastName"&gt;Last Name&lt;/label&gt; &#13;
                    &lt;input type="text" class="form-control" id="lastName" &#13;
                     name="lastName" placeholder="Last Name"&gt; &#13;
                &lt;/div&gt; &#13;
                &lt;button type="submit" class="btn btn-default"&gt;Submit&lt;/button&gt; &#13;
            &lt;/form&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
 &#13;
 &#13;
&lt;/div&gt; &#13;
 &#13;
&lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>This is a pretty standard form for signup, and we've used some <code class="literal">Bootstrap</code> classes to pretty things up a bit. If you start up your server and navigate to <code class="literal">http://localhost:3000/login/signup</code>, you'll see the following:</p><p>
</p><div><img src="img/image_11_001.jpg" alt="Creating views for authentication"/></div><p>
</p><p>If you fill out the form—making sure to have at least a <code class="literal">username</code> and <code class="literal">password-</code>you should create a <code class="literal">user</code> and be redirected to the <code class="literal">/dash</code> URL. It's not impressive yet, but it looks as follows:</p><p>
</p><div><img src="img/image_11_002.jpg" alt="Creating views for authentication"/></div><p>
</p><p>Now, if you start up your MongoDB command line and look, you'll see a <code class="literal">users</code> collection once again. Mongoose created that automatically for us. If you create a couple of users, you can see them here:</p><pre class="programlisting">
<strong>&gt; db.users.find({}).pretty()</strong>
<strong>{</strong>
<strong>  "_id" : ObjectId("56ae11990d7ca83f048f3c2a"),</strong>
<strong>  "lastName" : "Moore",</strong>
<strong>  "firstName" : "John",</strong>
<strong>  "password" :&#13;
      "$2a$10$OFhNNsA5MKrWCyFG9nATq.CIpTYZ5DH.jr8FnJYYFzgH7P4qM5QZy",</strong>
<strong>  "email" : "john@johnmoore.ninja",</strong>
<strong>  "username" : "ninja",</strong>
<strong>  "__v" : 0</strong>
<strong>}</strong>
<strong>{</strong>
<strong>  "_id" : ObjectId("56ae18d10d7ca83f048f3c2b"),</strong>
<strong>  "lastName" : "Blanks",</strong>
<strong>  "firstName" : "Billy",</strong>
<strong>  "password" :&#13;
      "$2a$10$NZQz8Nq4hBjSuU5yvO1Lnen.sy.sxEWwht0nPrIlP3aKC0jUrgSTq",</strong>
<strong>  "email" : "billy@fakeemailaddress.com",</strong>
<strong>  "username" : "billy",</strong>
<strong>  "__v" : 0</strong>
<strong>}</strong>
</pre><p>You see that we have two users. I created each of these using the signup form. Only the hash of their passwords is stored in the database. To round out signup in production, you would want to at least validate users' <code class="literal">email</code> addresses, but for development purposes, it's easier for us to be able to create fake accounts at will.</p><p>Now we need a form for logging in. Create a new <code class="literal">login.ejs</code> template in your <code class="literal">views/login</code> directory:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html&gt; &#13;
&lt;head &gt; &#13;
    &lt;title&gt;Signup&lt;/title&gt; &#13;
 &#13;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt; &#13;
 &#13;
    &lt;link rel="stylesheet"&#13;
    href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"&gt; &#13;
    &lt;link rel="stylesheet"&#13;
     href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-&#13;
     theme.min.css"&gt; &#13;
 &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
 &#13;
&lt;nav class="nav navbar-default"&gt; &#13;
    &lt;div class="container-fluid"&gt; &#13;
        &lt;div class="navbar-header"&gt; &#13;
            &lt;a class="navbar-brand" href="#"&gt; Giftapp Login&lt;/a&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/nav&gt; &#13;
 &#13;
&lt;div class="container"&gt; &#13;
    &lt;% if(message){ %&gt; &#13;
    &lt;div class="row"&gt; &#13;
        &lt;div class="col-md-4 col-md-offset-4" role="alert"&gt; &#13;
            &lt;%= message %&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
    &lt;% } %&gt; &#13;
 &#13;
    &lt;div class="row"&gt; &#13;
        &lt;div class="col-md-6 col-md-offset-3"&gt; &#13;
            &lt;form method="post" action="/login"&gt; &#13;
                &lt;div class="form-group"&gt; &#13;
                    &lt;label for="username"&gt;Username&lt;/label&gt; &#13;
                    &lt;input type="text" class="form-control" id="username"&#13;
                     name="username" placeholder="username"&gt; &#13;
                &lt;/div&gt; &#13;
                &lt;div class="form-group"&gt; &#13;
                    &lt;label for="password"&gt;Password&lt;/label&gt; &#13;
                    &lt;input type="password" class="form-control" id="password" &#13;
                     name="password" placeholder="Password"&gt; &#13;
                &lt;/div&gt; &#13;
 &#13;
                &lt;button type="submit" class="btn btn-default"&gt;Submit&lt;/button&gt; &#13;
            &lt;/form&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
 &#13;
 &#13;
&lt;/div&gt; &#13;
 &#13;
&lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>Going to <code class="literal">http://localhost:3000/login</code> gives us a page that looks like the following:</p><p>
</p><div><img src="img/image_11_003.jpg" alt="Creating views for authentication"/></div><p>
</p><p>Logging in with a correct set of user credentials will take you to our still-boring <code class="literal">/dash</code> route. Logging in with incorrect credentials returns us to the login route and populates the flash message:</p><p>
</p><div><img src="img/image_11_004.jpg" alt="Creating views for authentication"/></div><p>
</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch11lvl1sec62"/>Authenticating requests</h1></div></div></div><p>The main part of our application is our user dashboard, where our user will be able to create <code class="literal">giftlists</code>. Previously, we would access a user's dashboard by passing the user <code class="literal">id</code> in the dashboard URL. Obviously, there is no authentication here, and it's not a secure way of doing it.</p><p>Now we want users to log in before viewing only their own dashboard. If they go to the dashboard URL directly, they should be redirected to a login page.</p><p>We are going to handle this in stereotypical Express fashion by writing a piece of middleware to handle adding authentication for routes.</p><div><div><div><div><h2 class="title"><a id="ch11lvl2sec131"/>Adding authentication-check middleware</h2></div></div></div><p>Passport gives us in-session access to check if a user is currently authenticated. We can use this to easily protect whole sections of an application, or add authentication on a route-by-route basis.</p><p>Create a new file called <code class="literal">authenticated.js</code> in your <code class="literal">utils</code> directory:</p><pre class="programlisting">var authenticated = function (req, res, next) { &#13;
 &#13;
    if (req.isAuthenticated()){ &#13;
        return next(); &#13;
    } else { &#13;
        res.redirect('/login'); &#13;
    } &#13;
 &#13;
} &#13;
 &#13;
module.exports = authenticated; &#13;
</pre><p>Our authenticated function is set up with the signature of all Express middleware—with arguments for request, response, and next. We check the return value of a call to the request object's <code class="literal">isAuthenticed()</code> function—this is something Passport provides to us.</p><p>If we are authenticated, we merely pass the request forward by calling <code class="literal">next()</code>. If we aren't authenticated, we will redirect the request to the <code class="literal">/login</code> route, rendering our login page.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec132"/>Inserting middleware into routes</h2></div></div></div><p>Next, we want to insert our new middleware where we want to use it, in our dashboard route file:</p><pre class="programlisting">var express = require('express'); &#13;
var router = express.Router(); &#13;
<strong>var isAuthenticated = require('../utils/authenticated');</strong>
<strong>router.get('/', isAuthenticated, function(req, res, next) {</strong>
<strong>    res.send('respond with a resource');</strong>
<strong>});</strong> &#13;
 &#13;
router.param('id', function(req, res, next, id) { &#13;
    var db = req.db; &#13;
    var collection = db.get('giftlist'); &#13;
 &#13;
    collection.find({'owner_id':id}, {}, function(err,giftlists){ &#13;
        if(err){ &#13;
            res.send(err); &#13;
        }else if(giftlists){ &#13;
            req.giftlists = giftlists; &#13;
            collection = db.get('users'); &#13;
            collection.findOne({"_id":id}, function(err, user){ &#13;
                if(err){ &#13;
                    res.send(err); &#13;
                } else { &#13;
 &#13;
                    req.user = user; &#13;
                    next(); &#13;
                } &#13;
 &#13;
            }); &#13;
 &#13;
        } else { &#13;
            res.send(new Error('User not found.')); &#13;
        } &#13;
    }); &#13;
}); &#13;
 &#13;
 &#13;
 &#13;
router.get('/:id', function(req, res, next){ &#13;
    res.render('dash/dashboard', {user: req.user, giftlists: req.giftlists}); &#13;
}); &#13;
 &#13;
module.exports = router; &#13;
</pre><p>We require our new module into the router file, assigning it to the <code class="literal">isAuthenticated</code> variable. Next, we add the middleware to the main route.</p><p>Restarting your server should log you out. If you want to log out without restarting your server, you can access the sign-out route at <code class="literal">http://localhost:3000/login/signout</code>. You can then try to access <code class="literal">/dash</code>, and you'll be redirected back to login. Signing back in as a valid user will redirect you to dash, which will render properly.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec133"/>Changing the dashboard route</h2></div></div></div><p>Before, we set up our <code class="literal">dash/:id</code> route to look up the user using a <code class="literal">param</code> function. That's no longer going to suit our purposes. What we want is to show an authenticated user their own dashboard after logging in. Fortunately, Passport has already cached the user data we need in-session for us so we don't have to look the user up every time we render the dashboard.</p><p>Let's make some changes to our <code class="literal">dashboard</code> router:</p><pre class="programlisting">var express = require('express'); &#13;
var router = express.Router(); &#13;
var isAuthenticated = require('../utils/authenticated'); &#13;
 &#13;
router.get('/', isAuthenticated, function(req, res, next) { &#13;
 &#13;
 &#13;
    var db = req.db; &#13;
    var collection = db.get('giftlist'); &#13;
 &#13;
    collection.find({'owner_id':req.user._id}, {}, function(err,giftlists){ &#13;
        if(err){ &#13;
            res.send(err); &#13;
        }else { &#13;
            giftlists = giftlists || []; &#13;
            res.render('dash/dashboard', {user: req.user, giftlists: giftlists}); &#13;
        } &#13;
    }); &#13;
}); &#13;
 &#13;
module.exports = router; &#13;
</pre><p>Now we've simplified the code a bit. Our <code class="literal">/:id</code> route is now gone and the only route remaining is the main route, which gets triggered by get requests to <code class="literal">/dash</code>.</p><p>We already have user data cached in the request thanks to Passport, so it saves us one database lookup, helping our code perform better. We still look up the gift lists owned by this user, then we render the dashboard template we built earlier, which contains our single-page application frontend.</p><p>We get the following:</p><p>
</p><div><img src="img/image_11_005.jpg" alt="Changing the dashboard route"/></div><p>
</p><p>So we have authenticated the user and stashed the <code class="literal">user</code> object in the session, making it available during the request.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch11lvl1sec63"/>Securing Express</h1></div></div></div><p>Authentication is perhaps the most important and one of the trickier topics with regard to securing a web application from the front. Certainly, there are lots of different threat vectors.</p><div><div><div><div><h2 class="title"><a id="ch11lvl2sec134"/>Helmet</h2></div></div></div><p>One of the easiest things we can do to secure our Express application is to install and use the security middleware called Helmet. Helmet adds a number of security headers and policies, as well as preventing some attacks, such as <code class="literal">clickjacking</code>.</p><p>It does most of this under the covers, without the need for configuration on our part. For more detailed information, and to find alternative ways to <code class="literal">congigure</code> it.</p><p>To get started with Helmet, first install it using <code class="literal">npm</code>:</p><pre class="programlisting">
<strong>$ npm install helmet --save</strong>
<strong>helmet@1.1.0 node_modules/helmet</strong>
<strong>|- nocache@1.0.0</strong>
<strong>|- hide-powered-by@1.0.0</strong>
<strong>|- dont-sniff-mimetype@1.0.0</strong>
<strong>|- dns-prefetch-control@0.1.0</strong>
<strong>|- ienoopen@1.0.0</strong>
<strong>|- hpkp@1.0.0</strong>
<strong>|- x-xss-protection@1.0.0</strong>
<strong>|- hsts@1.0.0 (core-util-is@1.0.2)</strong>
<strong>|- frameguard@1.0.0 (lodash.isstring@3.0.1)</strong>
<strong>|- connect@3.4.0 (parseurl@1.3.1, utils-merge@1.0.0, finalhandler@0.4.0)</strong>
<strong>|_ helmet-csp@1.0.3 (lodash.isfunction@3.0.6, platform@1.3.0, camelize@1.0.0, lodash.assign@3.2.0, content-security-policy-builder@1.0.0, lodash.reduce@3.1.2, lodash.some@3.2.3)</strong>
</pre><p>You can actually see by the names of the submodules what some of the protections include.</p><p>Next, we simply need to add the module to our main <code class="literal">app.js</code> file:</p><pre class="programlisting">var express = require('express'); &#13;
var path = require('path'); &#13;
var favicon = require('serve-favicon'); &#13;
var logger = require('morgan'); &#13;
var cookieParser = require('cookie-parser'); &#13;
var bodyParser = require('body-parser'); &#13;
var isJSON = require('./utils/json'); &#13;
var routing = require('resource-routing'); &#13;
var controllers = path.resolve('./controllers'); &#13;
<strong>var helmet = require('helmet');</strong> &#13;
 &#13;
//Database stuff &#13;
var mongodb = require('mongodb'); &#13;
var monk = require('monk'); &#13;
var db = monk('localhost:27017/giftapp'); &#13;
 &#13;
var mongoose = require('mongoose'); &#13;
mongoose.connect('localhost:27017/giftapp'); &#13;
 &#13;
var routes = require('./routes/index'); &#13;
var users = require('./routes/users'); &#13;
var dashboard = require('./routes/dashboard'); &#13;
 &#13;
var app = express(); &#13;
 &#13;
// view engine setup &#13;
app.set('views', path.join(__dirname, 'views')); &#13;
app.set('view engine', 'ejs'); &#13;
 &#13;
app.set('x-powered-by', false); &#13;
 &#13;
app.locals.appName = "My Gift App"; &#13;
 &#13;
// uncomment after placing your favicon in /public &#13;
//app.use(favicon(path.join(__dirname, 'public', 'favicon.ico'))); &#13;
app.use(logger('dev')); &#13;
app.use(bodyParser.json()); &#13;
app.use(bodyParser.urlencoded({ extended: false })); &#13;
app.use(cookieParser()); &#13;
app.use(express.static(path.join(__dirname, 'public'))); &#13;
app.use(isJSON); &#13;
 &#13;
var flash = require('connect-flash'); &#13;
app.use(flash()); &#13;
 &#13;
var passport = require('passport'); &#13;
var expressSession = require('express-session'); &#13;
app.use(expressSession({secret: 'mySecretKey'})); &#13;
app.use(passport.initialize()); &#13;
app.use(passport.session()); &#13;
 &#13;
var initializePassport = require('./passport/init'); &#13;
initializePassport(passport); &#13;
 &#13;
//Database middleware &#13;
app.use(function(req,res,next){ &#13;
    req.db = db; &#13;
    next(); &#13;
}); &#13;
 &#13;
<strong>app.use('helmet');</strong> &#13;
 &#13;
app.use('/', routes); &#13;
app.use('/users', users); &#13;
app.use('/dash', dashboard); &#13;
 &#13;
var login = require('./routes/login')(passport); &#13;
app.use('/login', login); &#13;
 &#13;
routing.resources(app, controllers, "giftlist"); &#13;
routing.expose_routing_table(app, { at: "/my-routes" }); &#13;
 &#13;
// catch 404 and forward to error handler &#13;
app.use(function(req, res, next) { &#13;
  var err = new Error('Not Found'); &#13;
  err.status = 404; &#13;
  next(err); &#13;
}); &#13;
 &#13;
// error handlers &#13;
 &#13;
// development error handler &#13;
// will print stacktrace &#13;
if (app.get('env') === 'development') { &#13;
  app.use(function(err, req, res, next) { &#13;
    res.status(err.status || 500); &#13;
    res.render('error', { &#13;
      message: err.message, &#13;
      error: err &#13;
    }); &#13;
  }); &#13;
} &#13;
 &#13;
// production error handler &#13;
// no stacktraces leaked to user &#13;
app.use(function(err, req, res, next) { &#13;
  res.status(err.status || 500); &#13;
  res.render('error', { &#13;
    message: err.message, &#13;
    error: {} &#13;
  }); &#13;
}); &#13;
 &#13;
 &#13;
module.exports = app; &#13;
</pre><p>And there you have it. We've mitigated a pile of common web security vulnerabilities.</p><p>Please note that <code class="literal">app.use('helmet')</code> must come before any of the routes or the protection will not be in place for those routes.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec135"/>CSRF</h2></div></div></div><p>One of the most common web attack vectors is the <strong>Cross-Site Request Forgery</strong> (<strong>CSRF</strong>). CSRF is an attack where some untrusted source, such as another website or even an e-mail, takes advantage of a user's authenticated status to execute privileged code on another application. You can find more detailed information about CSRF at <a class="ulink" href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)">https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)</a>.</p><p>Once again, middleware to the rescue:</p><pre class="programlisting">
<strong>$ npm install csurf --save</strong>
<strong>csurf@1.8.3 node_modules/csurf</strong>
<strong>|- cookie@0.1.3</strong>
<strong>|- cookie-signature@1.0.6</strong>
<strong>|- http-errors@1.3.1 (inherits@2.0.1, statuses@1.2.1)</strong>
<strong>|_ csrf@3.0.1 (rndm@1.2.0, base64-url@1.2.1, scmp@1.0.0, uid-safe@2.1.0)</strong>
</pre><p>The <code class="literal">csurf</code> middleware is then plugged into our <code class="literal">app.js</code> the same way, with Helmet required in and then used. Please note that the <code class="literal">app.use('csurf')</code> must come after the <code class="literal">cookie parser</code> and <code class="literal">express-session</code> middleware, since it uses both.</p><p>Next, we edit our <code class="literal">login</code> routes file:</p><pre class="programlisting">var express = require('express'); &#13;
var router = express.Router(); &#13;
 &#13;
 &#13;
module.exports = function(passport){ &#13;
 &#13;
 &#13;
    router.get('/', function(req, res) { &#13;
<strong>        res.render('login/login', { message: req.flash('message'), csrfToken:&#13;
        req.csrfToken() });</strong> &#13;
    }); &#13;
 &#13;
 &#13;
    router.post('/', passport.authenticate('login', { &#13;
        successRedirect: '/dash', &#13;
        failureRedirect: '/login', &#13;
        failureFlash : true &#13;
    })); &#13;
 &#13;
 &#13;
    router.get('/signup', function(req, res){ &#13;
        console.log('signing up'); &#13;
<strong>        res.render('login/signup',{message: req.flash('message'), csrfToken:&#13;
        req.csrfToken()});</strong> &#13;
    }); &#13;
 &#13;
 &#13;
    router.post('/register', passport.authenticate('signup', { &#13;
        successRedirect: '/dash', &#13;
        failureRedirect: '/login/signup', &#13;
        failureFlash : true &#13;
    })); &#13;
 &#13;
    router.get('/signout', function(req, res) { &#13;
        req.logout(); &#13;
        res.redirect('/login'); &#13;
    }); &#13;
 &#13;
    return router; &#13;
} &#13;
</pre><p>We add a CSRF token to the data we pass to the <code class="literal">login</code> and <code class="literal">signup</code> pages.</p><p>Next, we add a hidden field to our <code class="literal">login</code> and <code class="literal">signup</code> pages:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html&gt; &#13;
&lt;head &gt; &#13;
    &lt;title&gt;Signup&lt;/title&gt; &#13;
 &#13;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt; &#13;
 &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"&gt; &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"&gt; &#13;
 &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
 &#13;
&lt;nav class="nav navbar-default"&gt; &#13;
    &lt;div class="container-fluid"&gt; &#13;
        &lt;div class="navbar-header"&gt; &#13;
            &lt;a class="navbar-brand" href="#"&gt; Giftapp Signup&lt;/a&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/nav&gt; &#13;
 &#13;
&lt;div class="container"&gt; &#13;
    &lt;% if(message){ %&gt; &#13;
    &lt;div class="row"&gt; &#13;
        &lt;div class="col-md-4 col-md-offset-4" role="alert"&gt; &#13;
            &lt;%= message %&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
    &lt;% } %&gt; &#13;
 &#13;
    &lt;div class="row"&gt; &#13;
        &lt;div class="col-md-6 col-md-offset-3"&gt; &#13;
            &lt;form method="post" action="/login/register"&gt; &#13;
                &lt;div class="form-group"&gt; &#13;
                    &lt;label for="username"&gt;Username&lt;/label&gt; &#13;
                    &lt;input type="text" class="form-control" &#13;
                     id="username" name="username" placeholder="username"&gt; &#13;
                &lt;/div&gt; &#13;
                &lt;div class="form-group"&gt; &#13;
                    &lt;label for="passwordd"&gt;Password&lt;/label&gt; &#13;
                    &lt;input type="password" class="form-control" id="password" &#13;
                      name="password" placeholder="Password"&gt; &#13;
                &lt;/div&gt; &#13;
                &lt;div class="form-group"&gt; &#13;
                    &lt;label for="email"&gt;Email address&lt;/label&gt; &#13;
                    &lt;input type="email" class="form-control" id="email" &#13;
                     name="email" placeholder="Email"&gt; &#13;
                &lt;/div&gt; &#13;
                &lt;div class="form-group"&gt; &#13;
                    &lt;label for="firstName"&gt;First Name&lt;/label&gt; &#13;
                    &lt;input type="text" class="form-control"  &#13;
                     id="firstName" name="firstName" placeholder="First Name"&gt; &#13;
                &lt;/div&gt; &#13;
 &#13;
                &lt;div class="form-group"&gt; &#13;
                    &lt;label for="lastName"&gt;Last Name&lt;/label&gt; &#13;
                    &lt;input type="text" class="form-control" id="lastName"&#13;
                     name="lastName" placeholder="Last Name"&gt; &#13;
                &lt;/div&gt; &#13;
<strong>           &lt;input type="hidden" name="_csrf" value="&lt;% csrfToken %&gt;"&gt;</strong> &#13;
&lt;button type="submit" class="btn btn-default"&gt;Submit&lt;/button&gt; &#13;
 &#13;
            &lt;/form&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div &#13;
 &#13;
 &#13;
&lt;/div&gt; &#13;
 &#13;
&lt;/body&gt; &#13;
 &#13;
&lt;/html&gt; &#13;
</pre><p>Restarting our server, reloading our login or <code class="literal">signup</code> page, and viewing source, you'll see a hidden input tag like the following:</p><pre class="programlisting">&lt;input type="hidden" name="_csrf" value="UBDtLOuZ-emrxDagDmIjxxsomxFS2pSeXKb4"&gt; &#13;
</pre><p>That hidden field gets passed back with our request and checked for validity.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec136"/>Taking additional security measures</h2></div></div></div><p>We've taken some basic, yet powerful, steps to secure our application against some of the biggest threats. A full exploration of the possible threats and security measures is beyond the scope of this book, but there are a few considerations worth mentioning.</p><div><div><div><div><h3 class="title"><a id="ch11lvl3sec150"/>Implementing HTTPS</h3></div></div></div><p>Implementing HTTPS when you deploy to production prevents a number of different man-in-the-middle attacks, and prevents data from being intercepted and modified along the way. We'll explore this in the chapter on deploying to production.</p><p>Furthermore, you can set your cookies to be secure. Again, we'll cover this when we talk about deployment.</p></div><div><div><div><div><h3 class="title"><a id="ch11lvl3sec151"/>Avoiding running as root</h3></div></div></div><p>One of the reasons we use port <code class="literal">3000</code> locally is that in many environments, running on port <code class="literal">80</code> (the standard HTTP port) requires running as root. A well-known security policy is that all processes should be run with as few privileges as possible. Again, this is something we'll take of when we deploy—mostly by using a PaaS provider.</p></div><div><div><div><div><h3 class="title"><a id="ch11lvl3sec152"/>Validating user input</h3></div></div></div><p>Right now, our application does very little input validation—except that <code class="literal">username</code> and <code class="literal">password</code> are required for signup and login. But we can and should check user input on both the client and server side.</p><p>We will add some input validation in the next chapter.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch11lvl1sec64"/>Summary</h1></div></div></div><p>We started this chapter by installing and configuring the Passport middleware for Node.js. Passport provides us with a framework for authentication, including creating new users, logging in, and securing specific routes. We then built out local authentication strategies for logging in and signing up.</p><p>We created routes and view templates for logging in and signing up, and redirected successful attempts to our main dashboard URL. We were able to reduce database lookups by relying on Passport caching our user in-session.</p><p>Finally, we enhanced the security of our application by using Helmet to add security headers to requests, and using <code class="literal">csurf</code> to mitigate CSRF attempts. We closed by discussing a few additional security concerns when moving the application into a production environment.</p></div></body></html>