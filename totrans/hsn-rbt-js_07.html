<html><head></head><body>
        

                            
                    <h1 class="header-title">Using Servos for Measured Movement</h1>
                
            
            
                
<p>Now that we've looked at motors, let's look at a more precise way to add to movement to our projects: the servo. We'll dive into how to wire up one servo, then another, and how to code both a single servo and multiple ones. </p>
<p>The following topics will be covered in this chapter:</p>
<ul>
<li>Differences between motors and servos</li>
<li>Getting a servo working with Johnny-Five</li>
<li>Project – two servos and the REPL</li>
<li>Project – the continuous servo</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Technical requirements</h1>
                
            
            
                
<p>You'll need your Pi, Cobbler, PWM hat, 2 hobby servos, and the AA battery pack from <a href="ace6b253-c47c-454d-b201-9efe7f9a761f.xhtml" target="_blank"/><a href="4135cf2d-d967-49b3-bf2b-37f82e7f5f62.xhtml" target="_blank">Chapter 6</a>, <em>Using Motors to Move Your Project</em>. You'll also need a continuous servo. Finally, you'll need your light sensor. Optional, but helpful, is a Popsicle or other small stick and some tape for turning our servo into a meter.</p>
<p>The code for this chapter is available at: <a href="https://github.com/PacktPublishing/Hands-On-Robotics-with-JavaScript/tree/master/Chapter07">https://github.com/PacktPublishing/Hands-On-Robotics-with-JavaScript/tree/master/Chapter07</a>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Differences between motors and servos</h1>
                
            
            
                
<p>The average hobby servo looks like this:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-592 image-border" src="img/4fe97e2a-ac4e-4b33-8685-1737f2be8447.png" style="width:83.33em;height:47.75em;"/></p>
<p>Also pictured are common accessories: some different arms, and mounting screws/washers. The wire ends terminate in a solid socket of three: perfect for attaching to our PWM hat.</p>
<p>The motors we worked with last chapter have some very basic differences, and we should explore them before we start our servo project.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Calculated movements</h1>
                
            
            
                
<p>Unlike the motors we dealt with in the previous chapter, you can make precise and calculated movements with a servo. Name a degree between 0 and 180 on a regular servo, and it will go. Motors (excluding stepper motors, which aren't covered in this book) cannot make these precise movements. So if you're looking to make a wheel go and you don't care about accurate movements, use a motor. When you're looking to make the joint of a limb that needs to move precisely with other joints, time to use a servo.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Regular versus continuous servos</h1>
                
            
            
                
<p>There are two kinds of servos, and they look remarkably alike. The other kind is called a continuous servo. They work very similar to regular servos in Johnny-Five, as you can see in the documentation for <em>servo.continuous</em>, which is on the same page as the servo documentation. The main difference is that while a regular servo can only go 180 degrees, a continuous one can go full 360 and continue spinning in the same direction indefinitely. Some favor using these to move wheels in their vehicle projects, and that's just fine!</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Powering servos and motors</h1>
                
            
            
                
<p>This is where servos and motors are very similar: while one servo tends to take less power than a motor, many projects make use of more servos than they would motors, and that can mean a strain on your Pi. If you add a lot of servos, you're going to want to provide external power to the PWM hat; many use 3-4 AA battery packs. I recommend using the one we used for motors in <a href="4135cf2d-d967-49b3-bf2b-37f82e7f5f62.xhtml" target="_blank">Chapter 6</a>, <em>Using Motors to Move Your Project</em>.</p>
<p>Powering your servos off of the Pi can have consequences that you wouldn't expect-- if you're getting memory leak issues while running servo code, it can be because you're pulling too much power from the Pi!<br/>
In general, if you're having weird issues with running servo code, make sure your servos are adequately powered by an external source.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting a servo working with Johnny-Five</h1>
                
            
            
                
<p>To get a servo working with Johnny-Five, we'll look at the Johnny-Five servo object, talk about wiring the servo to our PWM hat, and write our first piece of code to get the servo to sweep back and forth.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">The Johnny-Five servo object</h1>
                
            
            
                
<p>Looking at the servo page in the API section of the Johnny-Five documentation, we will look first for our constructor. Because we're still using the PCA9685 PWM hat, our constructor will look like this:</p>
<pre>let servo = new five.Servo({<br/>  controller: "PCA9685",<br/>  pin: 0 <br/>});<br/></pre>
<p>As for moving the servo, there are a few method described in the docs to move the servo. The first move can be to a fixed position:</p>
<pre>servo.to(degree)<br/>servo.min()<br/>servo.max()<br/>servo.home() <br/>servo.center()</pre>
<p>Or, another is to sweep back and forth, either as far back and forth as possible, or between a range:</p>
<pre>servo.sweep() // goes 0-180 and back, then repeats<br/>servo.sweep(minDegree, maxDegree) // goes min to max and back, then repeats</pre>
<p>You can also stop a moving servo:</p>
<pre>servo.stop()</pre>
<p>Now that we have a good grasp on coding our servo in Johnny-Five, let's wire up a servo and test our new knowledge.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Wiring the servo to our PWM hat</h1>
                
            
            
                
<p>Wiring the servo to the PWM hat is relatively simple; you need to line up the 3-pin socket of the servo to the column of pins you want. You also need to attach the power leads of the shield to AA battery pack from <a href="4135cf2d-d967-49b3-bf2b-37f82e7f5f62.xhtml" target="_blank">Chapter 6</a>, <em>Using Motors to Move Your Project</em>.</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-450 image-border" src="img/dc2a8e90-51b4-4a41-8a73-3332e0af8115.png" style="width:42.17em;height:39.58em;"/></p>
<p>I find that figuring out which pin is ground, then making sure that socket is on the bottom, helps. Ground wires on servos are typically black or brown in color. Then, line up the socket and slide it onto the pins in the first column (pin 0).</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-593 image-border" src="img/ca2ade60-1337-4608-b729-b5d48ca94565.png" style="width:44.08em;height:38.83em;"/></p>
<p>We've hooked up our servo and given power to the PWM hat, so let's code up a servo.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Coding your first servo sweep</h1>
                
            
            
                
<p>In a file called <kbd>single-servo.js</kbd>, we're going to set up our board, the our servo, and when it's ready, tell it to sweep back and forth:</p>
<div><pre>const Raspi = require('raspi-io')<br/>const five = require('johnny-five')<br/><br/>const board = new five.Board({<br/> io: new Raspi()<br/>})<br/><br/>board.on('ready', () =&gt; {<br/> let servo = new five.Servo({<br/> controller: "PCA9685",<br/> pin: 0<br/> })<br/> <br/> servo.sweep()<br/>})</pre>
<p>Move the file into its own folder on the Pi, navigate to that folder in your Pi SSH session, and run the following:</p>
<pre><strong>npm init -y</strong><br/><strong>npm i --save johnny-five raspi-io</strong><br/><strong>sudo node single-servo.js</strong></pre>
<p>You should see the servo move back and forth. Great! Now it's time to control two servos using the Johnny-Five Servos object and the command-line REPL.</p>
</div>


            

            
        
    

        

                            
                    <h1 class="header-title">Project – two servos and the REPL</h1>
                
            
            
                
<p>Now that we have one servo up and running, we're going to wire up a second one and use the REPL to explore the Johnny-Five Servos object, which is meant to help control several servos at once.</p>
<p>First, let's wire up our second servo.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Wiring up a second servo</h1>
                
            
            
                
<p>Take the second servo, figure out which side is ground, put that one on the bottom, and slide the three-pin socket over the pins in the second column (pin 1):</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-452 image-border" src="img/2de508fb-45f0-441c-a334-f848908783c1.png" style="width:38.67em;height:36.42em;"/></p>
<p>Now that we've wired up a second servo, let's start coding our Johnny-Five servos object!</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Using the Johnny-Five servos object</h1>
                
            
            
                
<p>The Johnny-Five servos object is meant to help you group servos in ways that make sense for projects with many servos, such as hexapods with six legs, each containing multiple servos.</p>
<p class="mce-root"/>
<p>You can create a <kbd>Servos</kbd> object in a few different ways; the way we will use is to pass an array of constructed <kbd>servo</kbd> objects:</p>
<pre>let servos = new five.Servos([servoOne, servoTwo])</pre>
<p>This is where the magic happens—now that our <kbd>servo</kbd> objects are grouped in a <kbd>Servos</kbd> object, we can control them both independently and as a group:</p>
<pre>servoOne.to(0) // Sets servoOne to 0 degrees<br/>servoTwo.to(180) // Sets servoTwo to 180 degrees<br/>servos.center() // Sets both servos to 90 degrees</pre>
<p>And <em>all servo object functions are available on the Servos object.</em></p>
<p>Let's add this to our code.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Adding the Servos object to our code</h1>
                
            
            
                
<p>In the same folder as <kbd>single-servo.js</kbd>, create a new file, <kbd>servos-repl.js</kbd>, and copy the contents of <kbd>single-servo.js</kbd> into it. </p>
<p>Then, in the <kbd>board.on('ready')</kbd> handler, rename <kbd>servo</kbd> to <kbd>servoOne</kbd> and add a constructor for <kbd>servoTwo</kbd> on pin <kbd>1</kbd> of the PWM hat:</p>
<pre>let servoOne = new five.Servo({<br/>  controller: "PCA9685",<br/>  pin: 0<br/>})<br/><br/>let servoTwo = new five.Servo({<br/>  controller: "PCA9685",<br/>  pin: 1<br/>})</pre>
<p>Then, we'll construct a <kbd>Servos</kbd> object containing <kbd>servoOne</kbd> and <kbd>servoTwo</kbd>:</p>
<pre>let servos = new five.Servos([servoOne, servoTwo])</pre>
<p>Now that our servos are coded, let's add Johnny-Five REPL functionality so we can control our servos from the command line.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Adding in REPL functionality</h1>
                
            
            
                
<p>First, delete the <kbd>servo.sweep()</kbd> line from <kbd>servos-repl.js</kbd>, as it'll cause an error now. Instead, place this code, which will allow us to access both of our servos and our servos group object from the command-line, on the Pi:</p>
<pre>board.repl.inject({<br/>  servoOne,<br/>  servoTwo,<br/>  servos<br/>})</pre>
<p>Now we're ready to play with our servos!</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Playing with our servos on the command line</h1>
                
            
            
                
<p>Load the folder onto the Pi, navigate to the folder in your Pi SSH session, and run the following:</p>
<pre><strong>sudo node servos-repl.js</strong></pre>
<p>Once you see <kbd>Board Initialized</kbd>, the REPL is ready for commands. Try these out for starters:</p>
<pre>servoOne.to(0) <br/>servoTwo.to(180)<br/>servos.center()</pre>
<p>Use the Johnny-Five documentation on servo to see what other fun things you can try with your servos from the command line!</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Project – light meter with the servo</h1>
                
            
            
                
<p>Let's build a project where our servo servos as a light meter that sweeps between 0 and 180 degrees based on the reading from the light sensor.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Adding in the light sensor</h1>
                
            
            
                
<p>First, we need to wire the light sensor to the board. Remember, I<sup>2</sup>C devices can share an SDA and SCL pin as long as they have different addresses (which the TSL2591, at 0x29, and the PWM hat, at 0x40, do). </p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-454 image-border" src="img/de142e6a-1142-4f49-a35a-a2307c5ae823.png" style="width:37.92em;height:35.67em;"/></p>
<p>Now that we've wired up the sensor, we'll take on the (optional) task of modifying our servo to look more like a meter.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Making the servo into a meter</h1>
                
            
            
                
<p>Take the servo horn and, with the center of the horn facing away from you, move it as far to the left as possible (0 degrees). <em>Do not use a lot of force or you'll strip the gears.</em> Then, use the tape to tape your stick to the servo horn to make it appear longer. then, you can tape it down to a desk or onto a wall, with your meter pointing left. You can see my attempt in the following diagram:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-736 image-border" src="img/bd241b33-a6bc-459b-81ad-f62539f44f77.png" style="width:40.92em;height:19.08em;"/></p>
<p>Now that we have our light sensor wired up and our meter cobbled together, let's code our light meter.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Coding the project</h1>
                
            
            
                
<p>Create a new file in your <kbd>project</kbd> folder called <kbd>light-meter.js</kbd>. Set up your normal scaffolding: requiring in Johnny-Five and Raspi-IO, setting up our <kbd>Board</kbd> object, and creating the <kbd>board.on('ready')</kbd> handler:</p>
<pre>const Raspi = require('raspi-io')<br/>const five = require('johnny-five')<br/><br/>const board = new five.Board({<br/>  io: new Raspi()<br/>})<br/><br/>board.on('ready', () =&gt; {<br/>})</pre>
<p>Inside the <kbd>board.on('ready')</kbd> handler, construct your <kbd>Servo</kbd> and <kbd>Light</kbd> objects:</p>
<pre>let servo = new five.Servo({<br/>  controller: "PCA9685",<br/>  pin: 0<br/>})<br/><br/>let lightSensor = new five.Light({<br/>  controller: 'TLS2561'<br/>})</pre>
<p>Then, we need to build a <kbd>lightSensor.on('change')</kbd> handler. We're going to use the <kbd>Sensor.scaleTo([min, max])</kbd> to scale the 0-255 input of the light sensor to the <kbd>0</kbd>-<kbd>180</kbd> output of the <kbd>servo</kbd>:</p>
<pre>lightSensor.on('change', function(){<br/>  servo.to(this.scaleTo([0, 180]))<br/>})</pre>
<p>And that's it! Let's get it on the Pi and see it at work.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Running and using our light meter</h1>
                
            
            
                
<p>Load your <kbd>project</kbd> folder onto the Pi, navigate to the folder in your Pi SSH session, and run the following command:</p>
<pre><strong>sudo node light-sensor.js</strong></pre>
<p>Then, cover the light sensor, or shine a light onto it—the servo should move back and forth accordingly.</p>
<p>Now that we've explored the servo as a means of communicating data as well as creating motion, let's take a look at the continuous servo.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Project – the continuous servo</h1>
                
            
            
                
<p>Continuous servos are a little like a motor combined with a regular servo: you lose the ability to go to specific degrees like a regular servo, but you can stop instantly instead of coasting to a stop like many motors. You can tell a continuous servo to move clockwise or counterclockwise at different speeds, and you can tell it to stop.</p>
<p>Let's wire up a continuous servo and play with its abilities via the Johnny-Five REPL.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Wiring up the servo</h1>
                
            
            
                
<p>The only difference in the wiring is continuous servos look different from regular servos in that nearly all have a disc instead of a horn. And most have red, white, and black power, signal, and ground wires, respectively.</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-456 image-border" src="img/37eb26e1-e496-42ef-8d94-5cb089f8b34a.png" style="width:42.42em;height:40.92em;"/></p>
<p>(Fritzing didn't have a continuous servo object, so we'll have to make due.)</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Continuous servo constructor and methods</h1>
                
            
            
                
<p>The constructor for the continuous servo is reminiscent of the RGB LED constructor, in that it is a property of the <kbd>Servo</kbd> object. Otherwise, it looks very similar to the <kbd>Servo</kbd> constructor with our PWM hat:</p>
<pre>let continuousServo = new five.Servo.Continuous({<br/>  controller: "PCA9685",<br/>  pin: 0<br/>})</pre>
<p>There are three methods we can use with the continuous servo:</p>
<pre>Servo.Continuous.cw([speed of 0-1]) // turns the servo clockwise<br/>Servo.Continuous.ccw([speed of 0-1]) // turns the servo counter-clockwise<br/>Servo.Continuous.stop() // stops the servo</pre>
<p>Now that we know how to use it and have it wired up, let's write a quick program that lets us play with our continuous servo in the REPL.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Using the REPL with the continuous servo</h1>
                
            
            
                
<p>Create a file in your <kbd>project</kbd> folder called <kbd>continuous-servo-repl.js</kbd>, and start with your usual setup:</p>
<pre>const Raspi = require('raspi-io')<br/>const five = require('johnny-five')<br/><br/>const board = new five.Board({<br/>  io: new Raspi()<br/>})<br/><br/>board.on('ready', () =&gt; {<br/>})</pre>
<p>Then, in our <kbd>board.on('ready')</kbd> handler, construct the <kbd>Servo.Continuous</kbd> object:</p>
<pre>let continuousServo = new five.Servo.Continuous({<br/>  controller: "PCA9685",<br/>  pin: 0<br/>})</pre>
<p class="mce-root"/>
<p>Finally, after the constructor, inject the continuous servo into the REPL so we can use it:</p>
<pre>board.repl.inject({<br/>  continuousServo<br/>})</pre>
<p>Now we can load it up and try it out!</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Playing with the continuous servo in the REPL</h1>
                
            
            
                
<p>Load your <kbd>project</kbd> folder onto the Pi, navigate to the folder in your Pi SSH session, and run the following command:</p>
<pre><strong>sudo node continuous-servo-repl.js</strong></pre>
<p>Once you see <kbd>Board Initialized</kbd>, you can try controlling the continuous servo by entering commands into the Johnny-Five REPL:</p>
<pre>continuousServo.cw(1) // see how fast it can go!<br/>continuousServo.ccw(.5) // it changes directions near-instantaneously!<br/>continuousServo.stop() // and stops very quickly, too!</pre>
<p>It is because of the ability to change direction and stop quickly that some prefer continuous servos to motors for wheeled robots—it's always great to have options.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Summary</h1>
                
            
            
                
<p>In this chapter, we learned how servos differ from motors, and the difference between regular and continuous servos. We also learned about the constructor for the Johnny-Five servo object and its functions. Next, we built a project that taught us how to group servos with the servos object, and control them from the Pi's command line via REPL. Then, we built a project that showed the ability of the servo to convey information as well as create movement by building a light meter. Finally, we learned more about and played with continuous servos.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Questions</h1>
                
            
            
                
<ol>
<li>What are the differences between servos and motors?</li>
<li>What is the difference between regular and continuous servos?</li>
<li>Why do servos require an external power source?</li>
<li>When would you use servos over motors?</li>
<li>What are the benefits of the servos object?</li>
</ol>


            

            
        
    </body></html>