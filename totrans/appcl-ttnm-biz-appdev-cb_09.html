<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;App Security Using Encryption and Other Techniques"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. App Security Using Encryption and Other Techniques</h1></div></div></div><p>In this chapter we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using secure properties</li><li class="listitem" style="list-style-type: disc">Object and string encryption</li><li class="listitem" style="list-style-type: disc">Working with encrypted files</li><li class="listitem" style="list-style-type: disc">Handling protected PDFs on iOS</li><li class="listitem" style="list-style-type: disc">Android lock screen monitor</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec60"/>Introduction</h1></div></div></div><p>It is common for Enterprise applications to contain private or confidential information. For this reason, encryption, file locking, and secure app lifecycle management are fundamental requirements when developing Enterprise Titanium apps. The core Titanium SDK provides limited functionality in this area such as one-way hashing and basic app events, but to fully meet security requirements, third-party modules such as <code class="literal">Securely</code> are needed.</p><p>In this chapter, we will discuss how to use the <code class="literal">Securely</code> framework to handle common secure programming tasks such as file and string encryption. <code class="literal">Securely</code> provides access to each platform's security APIs in a cross-platform and Titanium-friendly way. Through a series of recipes, we will demonstrate how to leverage the <code class="literal">Securely</code> framework within our existing Titanium Enterprise app.</p></div></div>
<div class="section" title="Using secure properties"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec61"/>Using secure properties</h1></div></div></div><p>The Titanium SDK provides a<a id="id823" class="indexterm"/> <code class="literal">Ti.App.Properties</code> object, which <a id="id824" class="indexterm"/>provides a convenient way to persist user and application information. The <code class="literal">Securely</code> framework provides a familiar API designed to mirror <code class="literal">Ti.App.Properties</code>, which allows you to persist this information in a secure fashion. This recipe describes how to use the <code class="literal">Securely.Properties</code> object<a id="id825" class="indexterm"/> to store, read, and remove data in/from an encrypted and secure manner.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec130"/>Getting ready</h2></div></div></div><p>This recipe uses the <code class="literal">Securely</code> <a id="id826" class="indexterm"/>native module. This module and other code assets can be downloaded from the source <a id="id827" class="indexterm"/>provided by the book, or individually through the links provided in the <span class="emphasis"><em>See also</em></span> section at the end of this recipe. Installing these in your project is straightforward. Simply, copy the <code class="literal">modules</code> folder into your project as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5343_09_01.jpg" alt="Getting ready"/></div><div class="section" title="Adding the module reference"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec222"/>Adding the module reference</h3></div></div></div><p>After copying the <a id="id828" class="indexterm"/>mentioned folder, you will need to click on your <span class="strong"><strong>tiapp.xml</strong></span> file in Titanium Studio and add a reference to the <code class="literal">bencoding.securely</code> module as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5343_09_02.jpg" alt="Adding the module reference"/></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec131"/>How to do it...</h2></div></div></div><p>This recipe is designed to run within the context of a <code class="literal">Ti.UI.Window</code> or other component within a single Titanium context. The code samples in this section demonstrate how to use the Secure properties of <code class="literal">Securely</code> using the same tests that Appcelerator uses for the Titanium SDK's <code class="literal">Ti.App.Properties</code> class. For more information, please refere to the <code class="literal">app.js</code> included with the recipe's source.</p><div class="section" title="Creating the namespace"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec223"/>Creating the namespace</h3></div></div></div><p>Once you have added <a id="id829" class="indexterm"/>the <code class="literal">Securely</code> module to your project, you need to create your application namespace in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the module into your code as the following code snippet demonstrates:</p><div class="informalexample"><pre class="programlisting">//Create our application namespace
var my = {
  secure : require('bencoding.securely'),
  isAndroid : Ti.Platform.osname === 'android',
  testObjects:{
    testList : [
      {name:'Name 1', address:'1 Main St'},
      {name:'Name 2', address:'2 Main St'}	
    ]
  }
};</pre></div></div><div class="section" title="Creating the secure properties object"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec224"/>Creating the secure properties object</h3></div></div></div><p>After the app <a id="id830" class="indexterm"/>namespace has been <a id="id831" class="indexterm"/>created, the next step is to create a new properties object. This object contains the following property values that must be set at creation time:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">secret</code>: This is a required parameter. <code class="literal">secret</code> is the password used to encrypt and decrypt all property values. The same <code class="literal">secret</code> used to encrypt must be used during the decryption process or a <code class="literal">null</code> value will be returned.</li><li class="listitem" style="list-style-type: disc"><code class="literal">identifier</code>: This parameter is optional. If no value is provided, the bundle name on iOS or the <code class="literal">PackageName</code> on Android is used. <code class="literal">identifier</code> allows you to segment each property with an identifier, if needed.</li><li class="listitem" style="list-style-type: disc"><code class="literal">accessGroup</code>: This parameter is an optional value used on the iOS platform. Access groups can be used to share keychain items among two or more applications. If no access group is provided, the keychain values will only be accessible within the app saving the values.</li><li class="listitem" style="list-style-type: disc"><code class="literal">encryptFieldNames</code>: This parameter is an optional value only used on the Android platform. When set to <code class="literal">true</code>, <code class="literal">Securely</code> will create an MD5 hash using the provided <code class="literal">secret</code> for all property names.<div class="informalexample"><pre class="programlisting">var properties = my.secure.createProperties({
  secret:"sshh_dont_tell",
  identifier:"myPropertyIdentifier",
  accessGroup:"myAccessGroup",
  encryptFieldNames:false
});</pre></div></li></ul></div></div><div class="section" title="Result comparison helper"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec225"/>Result comparison helper</h3></div></div></div><p>The <code class="literal">displayResults</code> function shown in the <a id="id832" class="indexterm"/>following code snippet is used to compare the test result with the expected value. Based on the comparison, the proper message is generated for presenting to the user.</p><div class="informalexample"><pre class="programlisting">function displayResults(result, expected) {
  if (result instanceof Array) {
    return displayResults(JSON.stringify(result), 
    JSON.stringify(expected));
  }else{
    if (result === expected) {
      return "Success ("+result+"=="+expected+")";
    } else {
      return "Fail: " + result + "!=" + expected;
    }
  }
};</pre></div></div><div class="section" title="Reading secure properties without defaults"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec226"/>Reading secure properties without defaults</h3></div></div></div><p>Each supported property <a id="id833" class="indexterm"/>type has a<a id="id834" class="indexterm"/> <code class="literal">get</code> method. For example, to read a Boolean property, the <code class="literal">getBool</code> method is called and a name is provided. This API works similar to the <code class="literal">Ti.App.Properties</code> object within the Titanium SDK, with added support for reading and decrypting secure properties. If no stored value is available, a null or default value type is provided. The following snippet demonstrates how to read saved secure property values:</p><div class="informalexample"><pre class="programlisting">Ti.API.info('Bool: ' + displayResults(properties.getBool('whatever'),
(my.isAndroid ? false : null)));

Ti.API.info('Double: ' + 
displayResults(properties.getDouble('whatever'),
(my.isAndroid ? 0: null)));

Ti.API.info('int: ' + displayResults(properties.getInt('whatever'),
(my.isAndroid ? 0 : null)));

Ti.API.info('String: ' + 
displayResults(properties.getString('whatever'),null));

Ti.API.debug('StringList: ' + 
displayResults(properties.getList('whatever'),null));</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note22"/>Note</h3><p>On iOS, null values are returned for any property without a saved value. Due to Android's type system, Boolean values will return <code class="literal">false</code> if no value is stored and numeric values will return zero. All other Android values will return null similar to iOS.</p></div></div></div><div class="section" title="Reading secure properties with defaults"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec227"/>Reading secure properties with defaults</h3></div></div></div><p>Also similar <a id="id835" class="indexterm"/>to <code class="literal">Ti.App.Properties</code>, <code class="literal">Securely</code> provides<a id="id836" class="indexterm"/> the ability to read and decrypt a secure property and provide a default value if there is no stored value for the requested secure property.</p><div class="informalexample"><pre class="programlisting">Ti.API.info('Bool: ' + 
displayResults(properties.getBool('whatever',true),true));

Ti.API.info('Double: ' + 
displayResults(properties.getDouble('whatever',2.5),2.5));

Ti.API.info('int: ' + 
displayResults(properties.getInt('whatever',1),1));

Ti.API.info('String: ' + 
displayResults(properties.getString('whatever',"Fred"),"Fred"));

Ti.API.debug('StringList: ' + 
displayResults(properties.getList('whatever'),testList));</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note23"/>Note</h3><p>The default value is not encrypted or persisted during the read process.</p></div></div></div><div class="section" title="Setting secure property values"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec228"/>Setting secure property values</h3></div></div></div><p>Each <a id="id837" class="indexterm"/>supported property type has a <code class="literal">set</code> method used<a id="id838" class="indexterm"/> to encrypt and persist values. For example, to save and encrypt a Boolean property and the <code class="literal">setBool</code> method, and provide a property name and Boolean value. This API works similar to the <code class="literal">Ti.App.Properties</code> object within the Titanium SDK. <code class="literal">Securely</code> supports both encrypting and writing the value to the secure properties directly. The following code snippet demonstrates how to save the following values to secure and encrypted storage:</p><div class="informalexample"><pre class="programlisting">properties.setString('MyString','I am a String Value ');
properties.setInt('MyInt',10);
properties.setBool('MyBool',true);
properties.setDouble('MyDouble',10.6);
properties.setList('MyList',my.testObjects.testList);</pre></div><p>To demonstrate the <a id="id839" class="indexterm"/>properties were saved correctly, the <code class="literal">get</code> method<a id="id840" class="indexterm"/> is called for each file and the results are printed to the console within Titanium Studio.</p><div class="informalexample"><pre class="programlisting">Ti.API.info('MyString: '+ properties.getString('MyString'));
Ti.API.info('MyInt: '+ properties.getString('MyInt'));
Ti.API.info('MyBool: '+ properties.getString('MyBool'));
Ti.API.info('MyDouble: '+ properties.getString('MyDouble'));
var list = properties.getList('MyList');
Ti.API.info('List: ' + JSON.stringify(list));</pre></div></div><div class="section" title="Listing secure property field names"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec229"/>Listing secure property field names</h3></div></div></div><p>The property names <a id="id841" class="indexterm"/>can be returned as an <a id="id842" class="indexterm"/>array by calling the <code class="literal">listProperties</code> method on the <code class="literal">Securely</code> property object. The following code snippet demonstrates how to use this method to print a JSON representation of the <code class="literal">names</code> array to the console within Titanium Studio.</p><div class="informalexample"><pre class="programlisting">if(!properties.hasFieldsEncrypted()){
  var allProperties = properties.listProperties();
  Ti.API.info(JSON.stringify(allProperties));
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note24"/>Note</h3><p>If field name encryption is enabled, the <code class="literal">listProperties</code> method will return <code class="literal">null</code>. As the field names are encrypted with a one-way hash, the original names are no longer available.</p></div></div></div><div class="section" title="Removing secure properties"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec230"/>Removing secure properties</h3></div></div></div><p>You can remove properties <a id="id843" class="indexterm"/>using two methods on the<a id="id844" class="indexterm"/> <code class="literal">Securely</code> properties object. The <code class="literal">removeProperty</code> and <code class="literal">removeAllProperties</code> are designed to be familiar and mirror the methods with the same name on the Titanium SDK's <code class="literal">Ti.App.Properties</code> object.</p><p>The <code class="literal">removeProperty</code> method will remove the provided secure property name, if it exists.</p><div class="informalexample"><pre class="programlisting">properties.removeProperty('MyInt');</pre></div><p>The <code class="literal">removeAllProperties</code> method will remove all properties within the identifier <a id="id845" class="indexterm"/>provided when<a id="id846" class="indexterm"/> creating the properties object.</p><div class="informalexample"><pre class="programlisting">properties.removeAllProperties();</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note25"/>Note</h3><p>In our recipe, the <code class="literal">remove</code> property functions are called at the end of the test so that the results can be recreated reliably each time.</p></div></div></div><div class="section" title="Check if a secure property exists"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec231"/>Check if a secure property exists</h3></div></div></div><p>The Securely property object provides the <code class="literal">hasProperty</code> method<a id="id847" class="indexterm"/> to provide the ability to check if a secure property exists. If the property exists, a Boolean <code class="literal">true</code> value is returned, otherwise a result of <code class="literal">false</code> is provided. This API is designed to be familiar as it mirrors the <code class="literal">Ti.App.Properties.hasProperty</code> function within the core Titanium SDK.</p><div class="informalexample"><pre class="programlisting">Ti.API.info("Does MyInt property exist? " + 
properties.hasProperty('MyInt'));</pre></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec132"/>How it works...</h2></div></div></div><p>The underlying infrastructure for secure properties is implemented differently depending on the platform running your application. Although <code class="literal">Securely</code> provides a cross-platform API, it is important to understand how each platform has been implemented and its associated security considerations.</p><div class="section" title="Secure properties on iOS"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec232"/>Secure properties on iOS</h3></div></div></div><p>The <code class="literal">Securely</code> framework <a id="id848" class="indexterm"/>saves all property values as<a id="id849" class="indexterm"/> serialized strings within the iOS Keychain. This provides secure storage and since it is part of iOS does not require any dependencies. Since <code class="literal">Securely</code> uses the iOS keychain service, it is recommended that your organization review Apple's Keychain documents before storing sensitive data within the securely-managed container.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note26"/>Note</h3><p>It is important to remember since the iOS Keychain service is used, your Secure Property values will still be available within the iOS Keychain after your app has been uninstalled. The <code class="literal">removeAllProperties</code> method<a id="id850" class="indexterm"/> must be called if you wish to remove all keychain items before removal of the app.</p></div></div></div><div class="section" title="Secure properties on Android"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec233"/>Secure properties on Android</h3></div></div></div><p>The <code class="literal">Securely</code> framework saves <a id="id851" class="indexterm"/>all property values as <a id="id852" class="indexterm"/>serialized and AES-encrypted strings into Android's <code class="literal">SharedPreferences</code>. Although Android introduced native keychain support in API level 14, the <code class="literal">Securely</code> module was designed to accommodate a larger number of devices and targets API level 8 and higher. It is recommended that your Enterprise reviews the secure properties' implementation within <code class="literal">Securely</code> to ensure it is in compliance with your corporate or industry standards and requirements.</p></div><div class="section" title="Secure property considerations"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec234"/>Secure property considerations</h3></div></div></div><p>By default on Android, the property <a id="id853" class="indexterm"/>names are not encrypted. This can be enabled by setting the <code class="literal">encryptFieldNames</code> on creation of the <code class="literal">properties</code> object. Due to the need to encrypt all property names, this property can only be set on creation of a new <code class="literal">properties</code> object. When field name encryption is enabled, <code class="literal">Securely</code> will create a SHA-1 hash for each field name using the <code class="literal">secret</code> property value provided. Enabling this feature creates performance considerations. Regression and performance testing is recommended before implementing your existing Titanium app.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec133"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To learn more about the iOS Keychain, please review Apple's documentation available at <a class="ulink" href="https://developer.apple.com/library/mac/#documentation/security/Conceptual/keychainServConcepts/01introduction/introduction.html">https://developer.apple.com/library/mac/#documentation/security/Conceptual/keychainServConcepts/01introduction/introduction.html</a>.</li><li class="listitem" style="list-style-type: disc">To learn more about Android's SharedPreferences, please review the documentation available at <a class="ulink" href="http://developer.android.com/reference/android/content/SharedPreferences.html">http://developer.android.com/reference/android/content/SharedPreferences.html</a>.</li></ul></div></div></div>
<div class="section" title="Object and string encryption"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec62"/>Object and string encryption</h1></div></div></div><p>During the Enterprise<a id="id854" class="indexterm"/> Titanium development cycle, there is often the requirement to encrypt in-process or persisted JavaScript objects or variables. The <code class="literal">Securely</code> framework provides a <code class="literal">StringCrypto</code> proxy with convenience methods for key generation of AES and DES bi-directional encryption.</p><p>This recipe describes how to use the <code class="literal">Securely.StringCrypto</code> object<a id="id855" class="indexterm"/> to encrypt and decrypt JavaScript objects in a secure manner.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note27"/>Note</h3><p>AES and DES implementations of <code class="literal">Securely</code> are designed to be specific to the device platform. If there is a need to exchange AES or DES encrypted data, access device, platform or to a third-party service, testing is recommended to verify the implementations match.</p></div></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec134"/>Getting ready</h2></div></div></div><p>This recipe uses the <code class="literal">Securely</code> native module. This module and other code assets can be downloaded from the source provided by the book. Installing these in your project is straightforward. Simply copy the <code class="literal">modules</code> folder into the root of your Titanium Project. Please review the <span class="emphasis"><em>Getting ready</em></span> section of the <span class="emphasis"><em>Using secure properties</em></span> recipe for instructions on module setup before continuing.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec135"/>How to do it...</h2></div></div></div><p>This example is designed to run within the context of a <code class="literal">Ti.UI.Window</code> or other component within a single Titanium context. This section demonstrates how to use the <code class="literal">StringCrypto</code> method of <code class="literal">Securely</code> to encrypt JavaScript objects. For more information, please reference the <code class="literal">app.js</code> included with the recipe's source.</p><div class="section" title="Creating the namespace"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec235"/>Creating the namespace</h3></div></div></div><p>Once you have <a id="id856" class="indexterm"/>added the <code class="literal">Securely</code> module to your project, you need to create your application namespace in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the module into your code as the following code snippet demonstrates:</p><div class="informalexample"><pre class="programlisting">//Create our application namespace
var my = {
  secure : require('bencoding.securely'),
  isAndroid : Ti.Platform.osname === 'android'
};</pre></div></div><div class="section" title="Generating keys"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec236"/>Generating keys</h3></div></div></div><p>Key generation<a id="id857" class="indexterm"/> is an important part of cryptography and to assist with this process, <code class="literal">Securely</code> has two built-in convenience methods.</p><div class="section" title="Generating a derived key"><div class="titlepage"><div><div><h4 class="title"><a id="ch09lvl4sec22"/>Generating a derived key</h4></div></div></div><p>The first key generation <a id="id858" class="indexterm"/>convenience method is called <code class="literal">generateDerivedKey</code>. This method includes the string input provided by the user into the salt algorithm used to determine the key. This approach is helpful if the seed value needs to be known or derived by another accessing system. The following steps demonstrate two common approaches for generating the seed value to be provided to the<a id="id859" class="indexterm"/> <code class="literal">generateDerivedKey</code> method:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A common approach is to create a new GUID as the seed from which the key is generated. The following code snippet demonstrates this approach using the <code class="literal">Ti.Platform.createUUID</code> method to generate a GUID:<div class="informalexample"><pre class="programlisting">var usingGUID = 
my.secure.generateDerivedKey(Ti.Platform.createUUID());</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note28"/>Note</h3><p>The <code class="literal">generateDrivedKey</code> method will use the parameter provided to create a new key each time it is called.</p></div></div></li><li class="listitem" style="list-style-type: disc">Another, less random method of key generation is to provide the Titanium app GUID as the seed value. The following code snippet demonstrates how to use the <code class="literal">Ti.App.guid</code> to create a derived key using the GUID from your project's <code class="literal">tiapp.xml</code> file.<div class="informalexample"><pre class="programlisting">var usingAppID = my.secure.generateDerivedKey(Ti.App.guid);</pre></div></li></ul></div></div><div class="section" title="Generating a random key"><div class="titlepage"><div><div><h4 class="title"><a id="ch09lvl4sec23"/>Generating a random key</h4></div></div></div><p>The second <a id="id860" class="indexterm"/>key generation convenience method is called <code class="literal">generateRandomKey</code>. As its name indicates, a random alphanumeric string is generated and used as the seed value. The following code snippet demonstrates how to create a key value using the <code class="literal">generateRandomKey</code> method.</p><div class="informalexample"><pre class="programlisting">var randomKey = my.secure.generateRandomKey();</pre></div></div><div class="section" title="Creating the stringCrypto object"><div class="titlepage"><div><div><h4 class="title"><a id="ch09lvl4sec24"/>Creating the stringCrypto object</h4></div></div></div><p>The next step in the <a id="id861" class="indexterm"/>cryptographic process<a id="id862" class="indexterm"/> for strings and objects is to create a new instance of the <code class="literal">stringCrypto</code> proxy. The following code snippet shows how to create a new proxy object named <code class="literal">stringCrypto</code>.</p><div class="informalexample"><pre class="programlisting">var stringCrypto = my.secure.createStringCrypto();</pre></div></div></div><div class="section" title="Using DES encryption"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec237"/>Using DES encryption</h3></div></div></div><p>
<code class="literal">Securely</code> supports<a id="id863" class="indexterm"/> the<a id="id864" class="indexterm"/> older <span class="strong"><strong>Data Encryption Standard</strong></span> (<span class="strong"><strong>DES</strong></span>)<a id="id865" class="indexterm"/> encryption algorithm. Support for this algorithm is primarily provided for intercommunication with legacy systems. Wherever possible, the stronger AES encryption should be used instead.</p></div><div class="section" title="Encrypting using DES"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec238"/>Encrypting using DES</h3></div></div></div><p>The <code class="literal">DESEncrypt</code> method<a id="id866" class="indexterm"/> <a id="id867" class="indexterm"/>requires a key and a string to encrypt. This method will then return a DES encrypted string. If an error is generated during the encryption process a null value is returned. The following demonstrates how to encrypt both a JavaScript string and object using this method.</p><div class="informalexample"><pre class="programlisting">var desEncryptedString = stringCrypto.DESEncrypt
(usingGUID,
plainTextString);
var desEncryptedObject = stringCrypto.DESEncrypt
(usingGUID,
JSON.stringify(plainObject));</pre></div><p>Any non-JavaScript string elements must first be converted into a JavaScript string before being provided to the <code class="literal">DESEncrypt</code> function.</p></div><div class="section" title="Decrypting using DES"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec239"/>Decrypting using DES</h3></div></div></div><p>The <code class="literal">DESDecrypt</code> method<a id="id868" class="indexterm"/> <a id="id869" class="indexterm"/>is used to decrypt a string encrypted with the DES algorithm. This method requires the key and a string with the encrypted value. The <code class="literal">DESDecrypt</code> method will then return a string with the decrypted value. The following snippet demonstrates how to use the <code class="literal">DESDecrypt</code> method to decrypt both a string and object.</p><div class="informalexample"><pre class="programlisting">var desDecryptedString = stringCrypto.DESDecrypt
(usingGUID,
desEncryptedString);</pre></div><p>The following code snippet demonstrates how to use <code class="literal">JSON.parse</code> to re-build the JavaScript object from the decrypted JSON string.</p><div class="informalexample"><pre class="programlisting">var desDecryptedObject = JSON.parse
(stringCrypto.DESDecrypt(usingGUID,
desEncryptedObject));</pre></div></div><div class="section" title="Encrypting using AES"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec240"/>Encrypting using AES</h3></div></div></div><p>The<a id="id870" class="indexterm"/> <code class="literal">AESEncrypt</code> method<a id="id871" class="indexterm"/> requires a key and a string to encrypt. This method will then return an AES-encrypted string. If an error is generated during the encryption process, a null value is returned. The following code snippet demonstrates how to encrypt both a JavaScript string and object using this method.</p><div class="informalexample"><pre class="programlisting">var aesEncryptedString = stringCrypto.AESEncrypt
(usingGUID,
plainTextString);
var aesEncryptedObject = stringCrypto.AESEncrypt
(usingGUID,
JSON.stringify(plainObject));</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note29"/>Note</h3><p>Any non-JavaScript string elements must first be converted into a JavaScript string before being provided to the <code class="literal">AESEncrypt</code> function.</p></div></div></div><div class="section" title="Decrypting using AES"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec241"/>Decrypting using AES</h3></div></div></div><p>The<a id="id872" class="indexterm"/> <code class="literal">AESDecrypt</code> method<a id="id873" class="indexterm"/> is used to decrypt a string encrypted with the AES algorithm. This method requires the key and a string with the encrypted value. The <code class="literal">AESDecrypt</code> method will then return a string with the decrypted value. The following code snippet demonstrates how to use the <code class="literal">AESDecrypt</code> method to decrypt both a string and an object.</p><div class="informalexample"><pre class="programlisting">var aesDecryptedString = stringCrypto.AESDecrypt
(usingGUID,
aesEncryptedString);</pre></div><p>The following code snippet demonstrates how to use <code class="literal">JSON.parse</code> to rebuild the JavaScript object from the decrypted JSON string.</p><div class="informalexample"><pre class="programlisting">var aesDecryptedObject = JSON.parse
(stringCrypto.AESDecrypt(usingGUID,
aesEncryptedObject));</pre></div></div><div class="section" title="Titanium object encryption"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec242"/>Titanium object encryption</h3></div></div></div><p>Titanium SDK objects such as <code class="literal">Ti.UI.View</code> are not real JavaScript objects, and therefore, cannot be serialized and encrypted effectively. To encrypt Titanium objects, you must first copy all of the Titanium object's properties into a pure JavaScript object and then convert the JavaScript object to a JSON string as shown earlier. During the decryption process, the reverse approach can be taken to recreate the Titanium object.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec136"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">This recipe uses the <code class="literal">Securely</code> module, for installation details please review the <span class="emphasis"><em>Getting ready</em></span> section of the <span class="emphasis"><em>Using secure properties</em></span> recipe</li><li class="listitem" style="list-style-type: disc">To learn more about DES encryption, please review processing standards publication published by the <span class="strong"><strong>National Institute of Standards and Technology</strong></span> (<span class="strong"><strong>NIST</strong></span>)<a id="id874" class="indexterm"/> available at <a class="ulink" href="http://www.itl.nist.gov/fipspubs/fip46-2.htm">http://www.itl.nist.gov/fipspubs/fip46-2.htm</a></li><li class="listitem" style="list-style-type: disc">To learn more about AES encryption, please review processing standards publication published by the NIST available at <a class="ulink" href="http://csrc.nist.gov/publications/fips/fips197/fips-197.pdf">http://csrc.nist.gov/publications/fips/fips197/fips-197.pdf</a></li><li class="listitem" style="list-style-type: disc">To learn more about Cryptographic Services used in the iOS implementation, please review Apples documentation available at <a class="ulink" href="https://developer.apple.com/library/mac/#documentation/security/Conceptual/cryptoservices/Introduction/Introduction.html">https://developer.apple.com/library/mac/#documentation/security/Conceptual/cryptoservices/Introduction/Introduction.html#//apple_ref/doc/uid/TP40011172-CH1-SW1</a></li><li class="listitem" style="list-style-type: disc">To learn more about Cryptographic Ciphers used in the Android implementation, please review the Android documentation available at <a class="ulink" href="http://developer.android.com/reference/javax/crypto/Cipher.html">http://developer.android.com/reference/javax/crypto/Cipher.html</a></li></ul></div></div></div>
<div class="section" title="Working with encrypted files"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec63"/>Working with encrypted files</h1></div></div></div><p>File encryption<a id="id875" class="indexterm"/> is a fundamental building block for enterprise mobile development. Due to the sensitivity of data collected by most enterprise apps, it is recommended that all persisted files are encrypted.</p><p>This recipe demonstrates<a id="id876" class="indexterm"/> how to use the <code class="literal">Securely</code> framework to both encrypt and decrypt files. Through the use of the File Crypto sample, we will provide step-by-step instructions on how to work with local encrypted files from within your Titanium app.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec137"/>Getting ready</h2></div></div></div><p>This recipe uses the <code class="literal">Securely</code> native module. This module and other code assets can be downloaded from the source provided by the book. Simply copy the <code class="literal">modules</code> folder into the root of your Titanium project. Please review the <span class="emphasis"><em>Getting ready</em></span> section of <span class="emphasis"><em>Using secure properties</em></span> recipe for instructions on module setup before continuing.</p><p>After installing the <code class="literal">Securely</code> module, you need to copy the <code class="literal">PlainText.txt</code> file into the <code class="literal">Resources</code> folder of your project. This file will be used by the recipe to create the initial encrypted file.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec138"/>How to do it...</h2></div></div></div><p>Once you have added the <code class="literal">module</code> folder and <code class="literal">PlaintText.txt</code> sample file into your project, you need to create your application namespace in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the module into your code as the following code snippet demonstrates:</p><div class="informalexample"><pre class="programlisting">//Create our application namespace
var my = {
  secure : require('bencoding.securely'),
  isAndroid : Ti.Platform.osname === 'android'
};</pre></div><div class="section" title="Creating the UI"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec243"/>Creating the UI</h3></div></div></div><p>This recipe walks through how to <a id="id877" class="indexterm"/>use the <code class="literal">Securely</code> module along with Titanium's <code class="literal">Ti.Filesystem</code> namespace to encrypt and decrypt files. The test harness pictured in the following screenshot is used to demonstrate how to perform these crypto actions:</p><div class="mediaobject"><img src="graphics/5343_09_03.jpg" alt="Creating the UI"/></div><p>Now perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step in creating the test harness is to create a <code class="literal">Ti.UI.Window</code>, which is used to attach all UI elements.<div class="informalexample"><pre class="programlisting">var win = Ti.UI.createWindow({
  backgroundColor: '#fff', title: 'File Crypto Example', 
  barColor:'#000',layout:'vertical',fullscreen:false
});</pre></div></li><li class="listitem">The next step in creating our test harness UI is to add a <code class="literal">Ti.UI.TextField</code> named <code class="literal">txtPassword</code>. This control is used to obtain the password used during the encryption and decryption operations.<div class="informalexample"><pre class="programlisting">var txtPassword = Ti.UI.createTextField({
  value:'foo123',hintText:'Enter Password',
  height:45, left:5, right:5, passwordMask:true
});
win.add(txtPassword);</pre></div></li><li class="listitem">The next step in creating our test harness UI is to add a <code class="literal">Ti.UI.Button</code> named <code class="literal">btnEncrypt</code>. This control will be used to launch the file encryption process.<div class="informalexample"><pre class="programlisting">var btnEncrypt = Ti.UI.createButton({
  title:'Encrypt', top:25, height:45, left:5, right:5	
});
win.add(btnEncrypt);</pre></div></li><li class="listitem">The final step in creating our test harness UI is to add a <code class="literal">Ti.UI.Button</code> named <code class="literal">btnDecrypt</code>. This control will be used to launch the file decryption process. Please note the encryption process launched when the <code class="literal">btnEncrypt</code> button is <a id="id878" class="indexterm"/>tapped must be run first.<div class="informalexample"><pre class="programlisting">var btnDecrypt = Ti.UI.createButton({
  title:'Decrypt', top:25, height:45, left:5, right:5	
});
win.add(btnDecrypt);</pre></div></li></ol></div></div><div class="section" title="Encrypting a file"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec244"/>Encrypting a file</h3></div></div></div><p>The file <a id="id879" class="indexterm"/>encryption process is demonstrated using the <code class="literal">click</code> event of the <code class="literal">btnEncrypt Ti.UI.Button</code>. This section describes how to use the <code class="literal">AESEncrypt</code> method of <code class="literal">Securely</code> for file encryption using the AES encryption algorithm.</p><div class="informalexample"><pre class="programlisting">btnEncrypt.addEventListener('click',function(x){</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step in the file encryption process is to create a callback method to receive the results from the <code class="literal">AESEncrypt</code> method. The following <code class="literal">onEncryptCompleted</code> method demonstrates how to check for the different results provided during the callback process.<div class="informalexample"><pre class="programlisting">  function onEncryptCompleted(e){
    if(e.success){
      var test = Ti.Filesystem.getFile(e.to);
      Ti.API.info("Test file contents:\n" + 
      (test.read()).text);
    }else{
      alert('failed due to: ' + e.message);
    }
  };</pre></div></li><li class="listitem">Next a new instance of the <code class="literal">FileCrypto</code> object of the <code class="literal">Securely</code> framework must be created.<div class="informalexample"><pre class="programlisting">  var fileCrypto = my.secure.createFileCrypto();</pre></div></li><li class="listitem">Then <code class="literal">Ti.FileSystem.File</code> objects are created for the input and output files.<div class="informalexample"><pre class="programlisting">  var plainTextFile = Ti.Filesystem.getFile(
  Ti.Filesystem.resourcesDirectory, 
  'PlainText.txt'),
  futureEncrypted = Ti.Filesystem.getFile(
  Ti.Filesystem.applicationDataDirectory, 
  'encryptedFile.txt');</pre></div></li><li class="listitem">Finally the <a id="id880" class="indexterm"/><code class="literal">AESEncrypt</code> method is called with the following parameters:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">password</code>: The <code class="literal">password</code> parameter is the key used in the file encryption process. The same password must be provided later if you wish to decrypt the file.</li><li class="listitem" style="list-style-type: disc"><code class="literal">from</code>: The <code class="literal">from</code> parameter provides a <code class="literal">nativePath</code> reference to the file that will be encrypted. Please note the file itself is not encrypted, but simply used as the source to generate an encrypted file at the path provided in the <code class="literal">to</code> parameter.</li><li class="listitem" style="list-style-type: disc"><code class="literal">to</code>: The <code class="literal">to</code> parameter provides the <code class="literal">nativePath</code> reference to where the encrypted file should be generated. The application must be able to write to this file path or an IO exception will be generated.</li><li class="listitem" style="list-style-type: disc"><code class="literal">completed</code>: The <code class="literal">completed</code> parameter provides a reference to the callback method to be used upon completion of the execution of the <code class="literal">AESEncrypt</code> method.<div class="informalexample"><pre class="programlisting">  fileCrypto.AESEncrypt({
    password:txtPassword.value,
    from:plainTextFile.nativePath,
    to:futureEncrypted.nativePath,
    completed:onEncryptCompleted
  });
});</pre></div></li></ul></div></li></ol></div></div><div class="section" title="Decrypting a file"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec245"/>Decrypting a file</h3></div></div></div><p>The file decryption process is<a id="id881" class="indexterm"/> demonstrated using the <code class="literal">click</code> event of the <code class="literal">btnDecrypt Ti.UI.Button</code>. The following section describes how to use <code class="literal">AESDecrypt</code> method of <code class="literal">Securely</code> for file decryption using the AES encryption algorithm. Please note that the same password used to encrypt the file must be provided in the decryption process.</p><div class="informalexample"><pre class="programlisting">btnDecrypt.addEventListener('click',function(x){</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step in the file decryption process is to create a callback method to receive the results from the <code class="literal">AESDecrypt</code> method. The following <code class="literal">onDecryptCompleted</code> method demonstrates how to check for the different results provided during the callback process:<div class="informalexample"><pre class="programlisting">  function onDecryptCompleted(e){
    if(e.success){
      var test = Ti.Filesystem.getFile(e.to);
      Ti.API.info("Test file contents:\n" + 
      (test.read()).text);
    }else{
      alert('failed due to: ' + e.message);
    }
  };</pre></div></li><li class="listitem">Next the <code class="literal">Ti.FileSystem.File</code> objects are created for the input and output files.<div class="informalexample"><pre class="programlisting">  var encryptedFile = Ti.Filesystem.getFile(
  Ti.Filesystem.applicationDataDirectory, 
  'encryptedFile.txt'),
  futureDecrypted = Ti.Filesystem.getFile(
  Ti.Filesystem.applicationDataDirectory, 
  'decryptedFile.txt');</pre></div></li><li class="listitem">Then a new instance of the <code class="literal">FileCrypto</code> object of <code class="literal">Securely</code> must be created.<div class="informalexample"><pre class="programlisting">  var fileCrypto = my.secure.createFileCrypto();</pre></div></li><li class="listitem">Finally the <code class="literal">AESDecrypt</code> method is called with the following parameters:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">password</code>: The <code class="literal">password</code> parameter is the key used in the file decryption process. This password must match the key provided during the file encryption process. If the passwords differ, an error will be provided to the callback method.</li><li class="listitem" style="list-style-type: disc"><code class="literal">from</code>: The <code class="literal">from</code> parameter provides a <code class="literal">nativePath</code> reference to the file that will be decrypted. Please note the file itself is not decrypted, but simply used as the source to generate a decrypted file at the path provided in the <code class="literal">to</code> parameter.</li><li class="listitem" style="list-style-type: disc"><code class="literal">to</code>: The <code class="literal">to</code> <a id="id882" class="indexterm"/>parameter provides the <code class="literal">nativePath</code> reference to where the decrypted file should be generated. The application must be able to write to this file path or an IO exception will be generated.</li><li class="listitem" style="list-style-type: disc"><code class="literal">completed</code>: The <code class="literal">completed</code> parameter provides a reference to the callback method to be used upon completion of the execution of the <code class="literal">AESDecrypt</code> method.<div class="informalexample"><pre class="programlisting">  fileCrypto.AESDecrypt({
    password:txtPassword.value,
    from:encryptedFile.nativePath,
    to:futureDecrypted.nativePath,
    completed:onDecryptCompleted
  });
});</pre></div></li></ul></div></li></ol></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec139"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">This recipe uses the <code class="literal">Securely</code> module, for installation details please review the <span class="emphasis"><em>Getting ready</em></span> section of the <span class="emphasis"><em>Using secure properties</em></span> recipe</li><li class="listitem" style="list-style-type: disc"><code class="literal">Securely</code> uses the <code class="literal">RNCryptor</code> library on iOS for file encryption. For documentation, licensing, and source, please visit <a class="ulink" href="https://github.com/rnapier/RNCryptor">https://github.com/rnapier/RNCryptor</a></li></ul></div></div></div>
<div class="section" title="Handling protected PDFs on iOS"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec64"/>Handling protected PDFs on iOS</h1></div></div></div><p>Working with and <a id="id883" class="indexterm"/>exchanging PDF files is common practice<a id="id884" class="indexterm"/> within a majority of organizations. Apple has provided APIs within iOS native access to lock and unlock PDF documents making implementing secure practices for this file format much easier. The <code class="literal">Securely</code> module<a id="id885" class="indexterm"/> exposes these native iOS APIs for your Titanium app to leverage.</p><p>This recipe demonstrates how to use the <code class="literal">Securely</code> framework to lock and unlock PDF files. Through the use of the PDF Locker sample, we will provide step-by-step instructions on how to protect and work with PDFs on the local device from within your Titanium app.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec140"/>Getting ready</h2></div></div></div><p>This recipe uses the <code class="literal">Securely</code> native module. This module and other code assets can be downloaded from the source provided by the book. Installing these in your project is straightforward. Simply copy the <code class="literal">modules</code> folder into your project as shown in the following screenshot. Next copy the <code class="literal">w4.pdf</code> file into the <code class="literal">Resources</code> folder of your project. This file will be used by the recipe to create the initial encrypted file:</p><div class="mediaobject"><img src="graphics/5343_09_04.jpg" alt="Getting ready"/></div><p>After copying the <code class="literal">modules</code> folder, you will need to update the <code class="literal">tiapp.xml</code> references as demonstrated in the <span class="emphasis"><em>Getting ready</em></span> section of the <span class="emphasis"><em>Using secure properties</em></span> recipe.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec141"/>How to do it...</h2></div></div></div><p>Once you have <a id="id886" class="indexterm"/>added the <code class="literal">module</code> folder and <code class="literal">w4.pdf</code> sample file into <a id="id887" class="indexterm"/>your project, you need to create your application namespace in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the module into your code as the following code snippet demonstrates:</p><div class="informalexample"><pre class="programlisting">//Create our application namespace
var my = {
  secure : require('bencoding.securely')
};</pre></div><div class="section" title="Creating the recipe's UI"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec246"/>Creating the recipe's UI</h3></div></div></div><p>This recipe walks through how to use the <code class="literal">Securely</code> module along with Titanium's <code class="literal">Ti.FileSystem</code> namespace to lock or unlock PDF files. The test harness pictured in the following screenshot is used to demonstrate how to perform these secure PDF actions:</p><div class="mediaobject"><img src="graphics/5343_09_05.jpg" alt="Creating the recipe's UI"/></div><p>Now perform the<a id="id888" class="indexterm"/> following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first<a id="id889" class="indexterm"/> step in creating this test harness is a <code class="literal">Ti.UI.Window</code>, which is created to attach all UI elements.<div class="informalexample"><pre class="programlisting">var win = Ti.UI.createWindow({
  backgroundColor: '#fff', title: 'PDF Protection Example', 
  barColor:'#000',layout:'vertical'
});</pre></div></li><li class="listitem">The next step in creating our test harness UI is to add a <code class="literal">Ti.UI.TextField</code> named <code class="literal">txtPassword</code>. This control is used to obtain the password used during the encryption and decryption operations.<div class="informalexample"><pre class="programlisting">var txtPassword = Ti.UI.createTextField({
  value:'foo123',hintText:'Enter Password',
  height:45, left:5, right:5, passwordMask:true
});	
win.add(txtPassword);</pre></div></li><li class="listitem">The next step in creating our test harness UI is to add a <code class="literal">Ti.UI.Button</code> named <code class="literal">btnLock</code>. This control will be used to launch the PDF lock/protection process.<div class="informalexample"><pre class="programlisting">var btnLock = Ti.UI.createButton({
  title:'Lock PDF', top:25, height:45, left:5, right:5
});
win.add(btnLock);</pre></div></li><li class="listitem">The next step in creating our test harness UI is to add a <code class="literal">Ti.UI.Button</code> named <code class="literal">btnUnlock</code>. This control will be used to launch the PDF unlock or password removal process.<div class="informalexample"><pre class="programlisting">var btnUnlock = Ti.UI.createButton({
  title:'Unlock PDF', top:25, height:45, left:5, right:5
});
win.add(btnUnlock);</pre></div></li></ol></div></div><div class="section" title="Protecting a PDF file"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec247"/>Protecting a PDF file</h3></div></div></div><p>The PDF <a id="id890" class="indexterm"/>protecting or locking process is <a id="id891" class="indexterm"/>demonstrated<a id="id892" class="indexterm"/> using the <code class="literal">click</code> event of the <code class="literal">btnLock Ti.UI.Button</code>. The following section describes how to use the <code class="literal">protect</code> method of <code class="literal">Securely</code> for PDF locking:</p><div class="informalexample"><pre class="programlisting">btnLock.addEventListener('click',function(x){</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step in the file decryption process is to create a callback method to receive the results from the <code class="literal">AESDecrypt</code> method. The following <code class="literal">onProtected</code> method demonstrates how to check for the different results provided during the callback process.<div class="informalexample"><pre class="programlisting">  function onProtected(e){
    if(e.success){
      alert('Protected PDF file created at: ' + e.to);
    }else{
      alert('failed due to: ' + e.message);
    }
  };</pre></div></li><li class="listitem">Next <code class="literal">Ti.FileSystem.File</code> objects are created for the input and output files.<div class="informalexample"><pre class="programlisting">  var inputFile = Ti.Filesystem.getFile(
  Ti.Filesystem.resourcesDirectory, 
  'w4.pdf'),
  outputFile = Ti.Filesystem.getFile(
  Ti.Filesystem.applicationDataDirectory, 
  'locked.pdf');</pre></div></li><li class="listitem">Then a new instance of the <code class="literal">PDF</code> object of <code class="literal">Securely</code> must be created.<div class="informalexample"><pre class="programlisting">  var pdf = my.secure.createPDF();</pre></div></li><li class="listitem">Finally the <code class="literal">protect</code> method is called with the following parameters:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">userPassword</code>: The <code class="literal">userPassword</code> parameter is the user-level password for the PDF. This field is required.</li><li class="listitem" style="list-style-type: disc"><code class="literal">ownerPassword</code>: The <code class="literal">ownerPassword</code> parameter is the owner-level password for the PDF. Although this is optional, this value must be set in order to password-protect the document.</li><li class="listitem" style="list-style-type: disc"><code class="literal">from</code>: The <code class="literal">from</code> parameter provides a <code class="literal">nativePath</code> reference to the PDF file to be protected. Please note that the file itself is not locked, but simply used as the source to generate a protected PDF file at the path provided in the <code class="literal">to</code> parameter.</li><li class="listitem" style="list-style-type: disc"><code class="literal">to</code>: The <code class="literal">to</code> parameter provides the <code class="literal">nativePath</code> reference to where the protected PDF file should be generated. The application must be able to write to this file path or an IO exception will be generated.</li><li class="listitem" style="list-style-type: disc"><code class="literal">allowCopy</code>: The <code class="literal">allowCopy</code> is a <a id="id893" class="indexterm"/>Boolean <a id="id894" class="indexterm"/>parameter indicating whether the document allows copying when unlocked with the user password. This parameter defaults to <code class="literal">true</code> and is optional.</li><li class="listitem" style="list-style-type: disc"><code class="literal">completed</code>: The <code class="literal">completed</code> parameter provides a reference to the callback method to be used upon completion of the execution of the <code class="literal">protect</code> method.<div class="informalexample"><pre class="programlisting">  pdf.protect({
    userPassword:txtPassword.value,
    ownerPassword:txtPassword.value,
    from:inputFile.nativePath,
    to:outputFile.nativePath,
    allowCopy:false,
    completed:onProtected
  });
});</pre></div></li></ul></div></li></ol></div></div><div class="section" title="Unlocking a PDF file"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec248"/>Unlocking a PDF file</h3></div></div></div><p>The process of<a id="id895" class="indexterm"/> unlocking <a id="id896" class="indexterm"/>or removing PDF protection from an existing PDF file<a id="id897" class="indexterm"/> is demonstrated using the <code class="literal">click</code> event of the <code class="literal">btnUnlock Ti.UI.Button</code>. The following steps describes how to use the <code class="literal">punprotect</code> method of <code class="literal">Securely</code> for PDF unlocking:</p><div class="informalexample"><pre class="programlisting">btnUnlock.addEventListener('click',function(x){</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step in unlocking a protected PDF file is to create a callback method to receive the results from the <code class="literal">unprotect</code> method. The following <code class="literal">onUnlock</code> method demonstrates how to check for the different results provided during the callback process.<div class="informalexample"><pre class="programlisting">  function onUnlock(e){
    if(e.success){
      alert('Unlocked PDF file created at: ' + e.to);
    }else{
      alert('failed due to: ' + e.message);
    }
  };</pre></div></li><li class="listitem">Next the <code class="literal">Ti.FileSystem.File</code> objects are created for the input and output files.<div class="informalexample"><pre class="programlisting">  var protectedFile = Ti.Filesystem.getFile(
  Ti.Filesystem.applicationDataDirectory, 
  'locked.pdf'),
  unlockedFile = Ti.Filesystem.getFile(
  Ti.Filesystem.applicationDataDirectory, 
  'unlocked.pdf');</pre></div></li><li class="listitem">Then, a new instance of the <code class="literal">PDF</code> object of <code class="literal">Securely</code> must be created.<div class="informalexample"><pre class="programlisting">  var pdf = my.secure.createPDF();</pre></div></li><li class="listitem">Finally the <code class="literal">unprotect</code> method is called with the following parameters:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">password</code>: The password parameter is the key used to unlock the protected PDF file.  This password must match the owner password used in locking the document.</li><li class="listitem" style="list-style-type: disc"><code class="literal">from</code>: The from parameter provides a nativePath reference to the protected PDF file.  Please note the PDF file itself is not unlocked, but simply used as the source to generate a new unlocked PDF file at the path provided in the to parameter.</li><li class="listitem" style="list-style-type: disc"><code class="literal">to</code>: The to parameter provides the nativePath reference to where the unlocked PDF file should be generated.  The application must be able to write to this file path or an IO exception will be generated.</li><li class="listitem" style="list-style-type: disc"><code class="literal">completed</code>: The <code class="literal">completed</code> parameter provides a reference to the callback <a id="id898" class="indexterm"/>method to be used upon <a id="id899" class="indexterm"/>completion of the execution of the <code class="literal">unprotect</code> method.<div class="informalexample"><pre class="programlisting">  pdf.unprotect({
    password:txtPassword.value,
    from:protectedFile.nativePath,
    to:unlockedFile.nativePath,
    completed:onUnlock
  });
});</pre></div></li></ul></div></li></ol></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec142"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">This recipe uses the <code class="literal">Securely</code> module. For installation details, please review the <span class="emphasis"><em>Getting ready</em></span> section of the <span class="emphasis"><em>Using secure properties</em></span> recipe.</li></ul></div></div></div>
<div class="section" title="Android lock screen monitor"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec65"/>Android lock screen monitor</h1></div></div></div><p>Due to the inherent nature of <a id="id900" class="indexterm"/>Titanium Android architecture, it can be challenging to determine when the app has been placed into the background or the lock screen has been activated. These actions are important life cycle events to track for password and application access. For example, you might wish to display a login screen within your app if the user has locked their device since last entering your app.</p><p>The following recipe demonstrates how to use the <code class="literal">Securely</code> framework to check if the user has a lock screen pattern enabled and fire an event when the screen is locked or unlocked.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec143"/>Getting ready</h2></div></div></div><p>This recipe uses the <code class="literal">Securely</code> native module. This module and other code assets can be downloaded from the source provided by the book. Installing these in your project is straightforward. Simply copy the <code class="literal">modules</code> folder into your project as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5343_09_06.jpg" alt="Getting ready"/></div><p>After copying the <code class="literal">modules</code> folder, you will need to update the <code class="literal">tiapp.xml</code> references as demonstrated in the Getting ready section of the <span class="emphasis"><em>Using secure properties</em></span> recipe.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec144"/>How to do it...</h2></div></div></div><p>Once you have added the <code class="literal">module</code> folder into your project, you need to create your application namespace in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the module into your code as the following code snippet demonstrates:</p><div class="informalexample"><pre class="programlisting">//Create our application namespace
var my = {
  secure : require('bencoding.securely')
};</pre></div><div class="section" title="Creating the recipe's UI"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec249"/>Creating the recipe's UI</h3></div></div></div><p>This recipe uses <a id="id901" class="indexterm"/>a single <code class="literal">Ti.UI.Window</code> object to host and demonstrate the different available lock screen methods and events. The following code snippet shows how this object is created.</p><div class="informalexample"><pre class="programlisting">var win = Ti.UI.createWindow({
  backgroundColor: '#fff', title: 'Lock Screen Monitor', 
  fullscreen:false, exitOnClose:true
});</pre></div></div><div class="section" title="Verifying if the lock pattern is enabled"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec250"/>Verifying if the lock pattern is enabled</h3></div></div></div><p>This recipe is dependent <a id="id902" class="indexterm"/>on the user enabling a passcode or lock pattern. If this feature is not enabled, the recipe will still function by simply providing when the screen has been disabled from a power consumption standpoint.</p><p>The following steps discuss how to verify if the user has enabled the lock screen functionality:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step is to create a new <code class="literal">Securely.Platform</code> proxy as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">  var platform = my.secure.createPlatform();</pre></div></li><li class="listitem">The <code class="literal">Securely.Platform</code> proxy provides many security-related methods. When the <code class="literal">lockPatternEnabled</code> method is called, a Boolean is provided indicating if the user has enabled this feature on their device.<div class="informalexample"><pre class="programlisting">  if(!platform.lockPatternEnabled()){
    alert('lock screen is not enabled on this device');
  }</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note30"/>Note</h3><p>Depending on your organization's passcode policy, you may wish to disable the app if a lock screen has not been implemented.</p></div></div></li></ol></div></div><div class="section" title="Creating a Lock Helper"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec251"/>Creating a Lock Helper</h3></div></div></div><p>The <code class="literal">Securely.LockScreenHelper</code> proxy object<a id="id903" class="indexterm"/> provides the initialization methods needed to start monitoring lock screen activity. The following code snippet demonstrates how to use this proxy to start the monitoring process:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step in the lock screen monitoring process is to create a new <code class="literal">Securely.LockScreenHelper</code> proxy as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">var lockHelper = my.secure.createLockScreenHelper();</pre></div></li><li class="listitem">Next the <code class="literal">startMonitorForScreenOff</code> method is called. This registers a broadcast receiver to listen for the <code class="literal">ACTION_SCREEN_OFF</code> broadcast.<div class="informalexample"><pre class="programlisting">lockHelper.startMonitorForScreenOff();</pre></div></li><li class="listitem">Then the<a id="id904" class="indexterm"/> <code class="literal">startMonitorForScreenOn</code> method is called. This registers a broadcast receiver to listen for the <code class="literal">ACTION_SCREEN_ON</code> broadcast.<div class="informalexample"><pre class="programlisting">lockHelper.startMonitorForScreenOn();</pre></div></li></ol></div></div><div class="section" title="Screen lock events"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec252"/>Screen lock events</h3></div></div></div><p>Both <a id="id905" class="indexterm"/>the <code class="literal">startMonitorScreenOff</code> and <code class="literal">startMonitorScreenOn</code> methods described earlier will emit global events when their subscribed broadcast is received. The following snippet demonstrates how to create application listeners to subscribe to these events:</p><div class="informalexample"><pre class="programlisting">Ti.App.addEventListener('BCX:SCREEN_OFF',function(e){
  Ti.API.info('Last locked at ' + 
  String.DateFormat(new Date(e.actionTime)));
});

Ti.App.addEventListener('BCX:SCREEN_ON',function(e){
  Ti.API.info('Last unlocked at ' + 
  String.DateFormat(new Date(e.actionTime)));
});</pre></div><p>Each event is provided information to assist in managing your app state. Using the prior example snippet, the <code class="literal">e</code> argument is provided two properties by Securely.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">actionName</code>: This is the full Android intent action name.</li><li class="listitem" style="list-style-type: disc"><code class="literal">actionTime</code>: This provides date/time in seconds format on when the last event was called. This can be converted into a JavaScript date using <code class="literal">new Date(e.actionTime)</code>.</li></ul></div></div><div class="section" title="Using window focus for monitoring"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec253"/>Using window focus for monitoring</h3></div></div></div><p>This recipe <a id="id906" class="indexterm"/>uses the <code class="literal">focus</code> event on the example <code class="literal">Ti.UI.Window</code> to demonstrate how to check if the device has been locked since the last time the <code class="literal">Ti.UI.Window</code> had focus. One use of this pattern would be to check if an internal passcode screen should be presented or to check if a session needs to be re-established.</p><div class="informalexample"><pre class="programlisting">win.addEventListener('focus',function(e){</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">wasLocked</code> method is called to determine if the device has been locked.<div class="informalexample"><pre class="programlisting">  if(lockHelper.wasLocked()){</pre></div></li><li class="listitem">The <code class="literal">isShowingLockScreen</code> method can also be used to determine if the device is currently presenting the lock screen to the user.<div class="informalexample"><pre class="programlisting">    if(!lockHelper.isShowingLockScreen()){</pre></div></li><li class="listitem">The <code class="literal">resetMonitorForScreenOff</code> method can also be used to reset the value returned by <code class="literal">wasLocked</code>. This is helpful in tracking if the device has been locked between<a id="id907" class="indexterm"/> app sessions.<div class="informalexample"><pre class="programlisting">      lockHelper.resetMonitorForScreenOff();

    }
  }	
});</pre></div></li></ol></div></div><div class="section" title="Stop monitoring"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec254"/>Stop monitoring</h3></div></div></div><p>It is important to<a id="id908" class="indexterm"/> stop monitoring and remove the global listeners when the app no longer needs this functionality. The following code snippet demonstrates how this is performed using the <code class="literal">close</code> event of the <code class="literal">Ti.UI.Window</code>.</p><div class="informalexample"><pre class="programlisting">win.addEventListener('close',function(e){
  lockHelper.stopMonitoring();
  Ti.App.removeEventListener('BCX:SCREEN_ON',screenON);
  Ti.App.removeEventListener('BCX:SCREEN_OFF',screenOFF); 
});	</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note31"/>Note</h3><p>Monitoring can be stopped individually by using <code class="literal">stopMonitorForScreenOff</code> or <code class="literal">stopMonitorForScreenOn</code>. To stop all monitoring, the <code class="literal">stopMonitoring</code> convenience method can be used to remove both receivers.</p></div></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec145"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To learn more about the <code class="literal">android.intent.action.SCREEN_ON</code> and <code class="literal">android.intent.action.SCREEN_OFF</code> intents used, please visit the official Android documentation available at <a class="ulink" href="http://developer.android.com/reference/android/content/Intent.html">http://developer.android.com/reference/android/content/Intent.html</a>.</li><li class="listitem" style="list-style-type: disc">This recipe uses the <code class="literal">Securely</code> module. For installation details, please review the <span class="emphasis"><em>Getting ready</em></span> section of the <span class="emphasis"><em>Using secure properties</em></span> recipe.</li></ul></div></div></div></body></html>