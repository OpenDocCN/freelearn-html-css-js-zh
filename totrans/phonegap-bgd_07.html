<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Accessing the Device Sensors and Locations API</h1></div></div></div><p>
<em>The use of device sensors opens the doors to sophisticated apps, which may improve user experience and enhance the capabilities of a modern app. It's very important for a mobile developer to understand the power and limitations of device sensors in order to effectively use the APIs provided by the PhoneGap framework. Location data allows a mobile developer to tag every piece of information with the device's position. In this chapter, you will also learn to couple the Location API with your app.</em>
</p><p>In this chapter, you will:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Learn which are the most common device sensors and how to use them in order to enhance the user experience</li><li class="listitem" style="list-style-type: disc">Get an overview of the device orientation and device motion events using the accelerometer</li><li class="listitem" style="list-style-type: disc">Learn how to work with device sensors directly with JavaScript</li><li class="listitem" style="list-style-type: disc">Learn how to use the Compass API of PhoneGap</li><li class="listitem" style="list-style-type: disc">Learn about geolocation and how its data is available in the device</li><li class="listitem" style="list-style-type: disc">Learn how to use the PhoneGap Geolocation API and how to integrate the Google Maps API in an app</li></ul></div><p>Location data allows a mobile developer to tag every piece of information with the device's position. This kind of meat tagging enables the use of very contextualized apps. The PhoneGap framework provides a Geolocation API that is simple to use, easy to understand, and very powerful.</p><div><div><div><div><h1 class="title"><a id="ch07lvl1sec63"/>Introducing device sensors</h1></div></div></div><p>Humans have<a id="id507" class="indexterm"/> senses (touch, hear, smell, and so on); a phone has digital "senses": touch, geolocation, orientation, and motion. A sensor is a device component that measures a physical quantity and converts it into a signal that is understandable to software. Modern mobile phones come with a variety of sensors that can support users when completing their daily tasks. By tapping into a device sensor, you can enhance the end user experience and develop sophisticated apps.</p><p>Sensors can be hardware-based or software-based. Hardware-based sensors are physical components built into a handset or tablet device. They derive their data by directly measuring specific environmental properties such as acceleration, geomagnetic field strength, or angular change. Software-based sensors are not physical devices, although they mimic hardware-based sensors.</p><p>Typical device sensors are the <a id="id508" class="indexterm"/>
<strong>accelerometer</strong>, <strong>gyroscope</strong>, <strong>compass</strong>, <strong>barometer</strong>, <strong>orientation sensor</strong>, and so on.</p><p>Not all<a id="id509" class="indexterm"/> devices, nor their operating systems support the same<a id="id510" class="indexterm"/> sensors, so you <a id="id511" class="indexterm"/>have to know which <a id="id512" class="indexterm"/>devices you want to target before considering which sensors to use in your app. The device sensors typically are divided into the following<a id="id513" class="indexterm"/> categories:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Motion sensors</li><li class="listitem" style="list-style-type: disc">Environmental sensors</li><li class="listitem" style="list-style-type: disc">Position sensors</li></ul></div><p>The<a id="id514" class="indexterm"/> <strong>motion sensors</strong>
<a id="id515" class="indexterm"/> measure acceleration forces and rotational forces along the three axes. Hardware parts such as the accelerometer, gravity sensors, gyroscopes, and rotational vector sensors belong to this category. The <a id="id516" class="indexterm"/>
<strong>environmental sensors</strong>
<a id="id517" class="indexterm"/> measure various environmental parameters such as ambient air temperature and pressure, illumination, and humidity. The barometers, photometers, and thermometers belong to this category of sensors. The <a id="id518" class="indexterm"/>
<strong>position sensors</strong>
<a id="id519" class="indexterm"/> measure the physical position of a device.</p><p>As already mentioned, each operating system offers different sensors. From a developer's point of view, this means that to work on different platforms, you have to understand how sensors work on each one. When working with PhoneGap, you can safely use the <strong>Accelerometer</strong>
<a id="id520" class="indexterm"/> and <a id="id521" class="indexterm"/>
<strong>Compass</strong> APIs across different platforms. Furthermore, you can rely on the <strong>onboard browser</strong> capabilities<a id="id522" class="indexterm"/> to get additional sensor information such as the device orientation.</p><p>The accelerometer<a id="id523" class="indexterm"/> is actually made up of three accelerometers and each one measures the changes in velocity (that is, linear acceleration) overtime along the linear path on the axes <em>x</em>, <em>y</em>, and <em>z</em>. Combining the data of the three accelerometers, you can get the device movement and orientation.</p><p>The gyroscope<a id="id524" class="indexterm"/> is always part of the motion sensors and it measures the rate of <a id="id525" class="indexterm"/>rotation around the <a id="id526" class="indexterm"/>three axes, usually <strong>roll</strong>, <strong>pitch</strong>, and <strong>yaw</strong>.</p><p>The<a id="id527" class="indexterm"/> magnetometer<a id="id528" class="indexterm"/> measures the strength of the magnetic field surrounding the device and in the absence of any strong local fields, these measurements will refer to the magnetic field of the Earth. In this way, the device is able to determine its <strong>heading</strong> with respect to the geomagnetic North Pole; using the heading values, it's possible to determine the yaw of the device too. Magnetic heading updates are available even if the user has switched off location updates in the settings application; the reported values are positive numbers from <strong>0</strong> to <strong>360</strong>. The real heading of the user, when they are holding the device in landscape mode, is the reported heading plus 90 degrees.</p><p>The <a id="id529" class="indexterm"/>iOS platform provides all the common sensors a developer can expect such as accelerometer, magnetometer, gyroscope, and the proximity sensor.</p><p>The Android platform<a id="id530" class="indexterm"/> provides four additional sensors that allows you to monitor various environmental properties: ambient <strong>humidity</strong>, <strong>luminance</strong>, ambient <strong>pressure</strong>, and ambient <strong>temperature</strong>. All the <a id="id531" class="indexterm"/>sensors <a id="id532" class="indexterm"/>are <a id="id533" class="indexterm"/>hardware-based and are <a id="id534" class="indexterm"/>available only if a manufacturer has built them into a device.</p><div><div><h3 class="title"><a id="note28"/>Note</h3><p>You can find a complete demo of the Android sensors on the Google Play store; just search and install the <em>Android Sensor Box</em> app.</p></div></div><p>The Windows Phone 7.5/8 platform offers wide support for sensors. You can use the <strong>Inclinometer</strong> sensor<a id="id535" class="indexterm"/> to detect the pitch, roll, and yaw of the device or you can create complex 3D apps using the<a id="id536" class="indexterm"/> <strong>Quaternion</strong> sensor (quaternion is the quotient of two directed lines in a three-dimensional space). For a complete overview of the Windows Phone sensor APIs, please refer<a id="id537" class="indexterm"/> to the online documentation at <a class="ulink" href="http://msdn.microsoft.com/library/windows/apps/windows.devices.sensors">http://msdn.microsoft.com/library/windows/apps/windows.devices.sensors</a>.</p><p>The location capabilities of a device rely on several sensors called position sensors. Devices normally use multiple positioning methods to provide different granularities of location data. The sources of position data vary in terms of accuracy, startup time, and power signature, and include the following:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">GPS</li><li class="listitem" style="list-style-type: disc">A-GPS</li><li class="listitem" style="list-style-type: disc">Cell tower triangulation</li><li class="listitem" style="list-style-type: disc">Wi-Fi triangulation</li><li class="listitem" style="list-style-type: disc">IP address</li></ul></div><p>With the continuous evolution of sensors, end user expectations are growing and the quality of the apps available on the market is increasing.</p><div><div><h3 class="title"><a id="note29"/>Note</h3><p>
<strong>Lapka Electronics</strong> released a set of sensors and an app that is able to translate environmental data to read values easily. Using their sensors and app, you can measure electromagnetic pollution, humidity, amounts of nitrates in raw foods and drinking water, and so on. More information <a id="id538" class="indexterm"/>about these sensors is available online at <a class="ulink" href="http://mylapka.com/">http://mylapka.com/</a>.</p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec63"/>Sensors and human-computer interaction</h2></div></div></div><p>Sensors <a id="id539" class="indexterm"/>evolved <a id="id540" class="indexterm"/>and are still evolving very fast and are influencing how creative people are designing apps. The new generation of apps rely on voice commands, gestures, and more in order to allow the user to control apps in a more intuitive way. An app is now able to perceive the user's intentions based on the sensor data it collects. The use of sensors to make apps (and computers) more intuitive to control is known as <a id="id541" class="indexterm"/>
<strong>perceptual computing</strong>. This initiative is led by Intel and has various applications including video conferencing, gaming, and so on.</p><p>By contrast, <strong>augmented reality</strong> <a id="id542" class="indexterm"/>is about extending how humans interface with the physical world through computers. Using an augmented reality interface, you can add additional information to the external environment and create amazing and useful apps. On mobile devices, the implementation of an augmented reality application heavily depends on the sensors on the devices, such as video cameras and orientation sensor.</p><p>A nice example of the kind of interactions you can reach through sensors is an app for iOS named <a id="id543" class="indexterm"/>
<strong>Car Finder</strong>. The app stores the position of a car when the user takes a picture of it and then provides to the user the information needed to find where he/she had parked the car.</p><p>The capability to use sensors and the data they return is increasingly paramount for mobile developers. The sensors supported by PhoneGap are limited, but PhoneGap is simply a wrapper that makes it easier to separate your presentation layer from the native device code. For this reason, you can start to write additional native code around the PhoneGap wrapper to extend its capabilities.</p><div><div><h3 class="title"><a id="note30"/>Note</h3><p>An interesting resource on sensor development is available on the Microsoft website at <a class="ulink" href="http://research.microsoft.com/en-us/groups/sendev/">http://research.microsoft.com/en-us/groups/sendev/</a>, where you can find papers and resources to help you get started with sensors.</p></div></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec64"/>Accelerometer</h1></div></div></div><p>The<a id="id544" class="indexterm"/> PhoneGap Accelerometer API allows you to detect the device movement change values relative to device orientation. Note that the accelerometer detects the values as a delta movement relative to the current device position. Even more important, it takes into consideration the effect of gravity (that is, <em>9.81 m/s</em><sup><em>2</em></sup>), so that when a device is lying flat on a table facing up, the value returned should be <em>x = 0</em>, <em>y = 0</em>, and <em>z = 9.81</em>.</p><p>As with any other plugin, you have to install the plugin before you can use it in your project. The plugin can be added to your project using the following command:</p><div><pre class="programlisting">
<strong>$ cordova plugin add cordova-plugin-device-motion</strong>
</pre></div><p>Once the plugin is installed on the project, a <code class="literal">navigator.Accelerometer</code> global object, is created and it is available to use once the <code class="literal">deviceready</code> event is fired. However, it is recommended that you still check for its presence before using it:</p><div><pre class="programlisting">document.addEventListener("deviceready", onDeviceReady, false);

function onDeviceReady() {
    if( typeof navigator.accelerometer === "undefined"){
        //plugin is ready now
    }
}</pre></div><p>You can detect the device acceleration data using the <code class="literal">getCurrentAcceleration</code> method or by setting up a watcher through the <code class="literal">watchAcceleration</code> method. Both methods are available on the <code class="literal">navigator.accelerometer</code> object and accept similar arguments.</p><p>The <code class="literal">getCurrentAcceleration</code> method accepts a success and a failure callback function as an argument and doesn't return anything. The <code class="literal">watchAcceleration</code> method accepts an additional argument in order to define the options and return a reference to the current watcher.</p><p>In order to constantly watch the acceleration data, you have to define the frequency at which you want to recover data and store the value returned by the <code class="literal">watchAcceleration</code> method in a variable:</p><div><pre class="programlisting">var options = {frequency: 300};
var currentAcceleration = navigator.accelerator.watchAcceleration 
                          (onSuccess, onFailure, options);</pre></div><p>The <code class="literal">onSuccess</code> handler receives an <code class="literal">Acceleration</code> object as an argument, accessing its property and making it possible to read the acceleration on each axis:</p><div><pre class="programlisting">function onSuccess(acceleration) {

    console.log('Acceleration X: ' + acceleration.x );
    console.log('Acceleration Y: ' + acceleration.y);
    console.log('Acceleration Z: ' + acceleration.z );

};</pre></div><p>The failure <a id="id545" class="indexterm"/>handler doesn't receive any argument, but it's pretty useful to handle possible errors when accessing the device's accelerometer:</p><div><pre class="programlisting">function onError() {

    console.log('Error accessing the accelerometer');

};</pre></div><p>In order to stop watching the accelerometer data, it's sufficient to call the <code class="literal">clearWatch</code> method defined on the <code class="literal">accelerator</code> object, passing the reference to the variable previously used to store the result of the <code class="literal">watchAcceleration</code> method:</p><div><pre class="programlisting">navigator.accelerometer.clearWatch(currentAcceleration);</pre></div><p>This method doesn't accept any additional handler.</p><div><div><h3 class="title"><a id="tip10"/>Tip</h3><p>All the sensor APIs of PhoneGap work in a similar way; you will always have to use a <code class="literal">getCurrentSENSOR</code> and a <code class="literal">watchSENSOR</code> method (where <code class="literal">SENSOR</code> is the name of the sensor) to obtain data from the sensor. In order to stop watching a sensor, you will always use the <code class="literal">clearWatch</code> method.</p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec64"/>Detecting shakes</h2></div></div></div><p>Using<a id="id546" class="indexterm"/> the information recovered from the accelerometer API, it's possible to understand whether the user is shaking the device.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec65"/>Device orientation events</h2></div></div></div><p>The cordova-plugin-device-motion<a id="id547" class="indexterm"/> plugin only supports access to the acceleration information. In order to handle the orientation changes, you have to rely on the JavaScript APIs<a id="id548" class="indexterm"/> of the target platform browser. When you want to update the user interface when the device orientation changes, you have to use CSS media queries; any other business logic can be handled using JavaScript due to the fact that PhoneGap uses the web view to render the app user interface.</p><p>Using JavaScript, you can set up a listener for the <code class="literal">orientationchange</code> event and another listener for the <code class="literal">deviceorientation</code> event in order to handle the device orientation. The first event is fired each time the orientation of the device changes; the second event is fired when the physical orientation of the device changes. Both the listeners have to be registered to the <code class="literal">window</code> object:</p><div><pre class="programlisting">window.addEventListener('orientationchange', EVENT_HANDLER);
window.addEventListener('deviceorientation', EVENT_HANDLER);</pre></div><p>The <a id="id549" class="indexterm"/>
<code class="literal">orientationchange</code> event handler<a id="id550" class="indexterm"/> is commonly used to detect the screen orientation after it has changed. Once the orientation changes, the app receives a notification for several events. The following table summarizes these events and the orientation property value:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Device and user gesture</p>
</th><th style="text-align: left" valign="bottom">
<p>Events fired</p>
</th><th style="text-align: left" valign="bottom">
<p>Orientation</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>iPad to landscape<a id="id551" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">resize</code>
</p>
<p>
<code class="literal">orientationchange</code>
</p>
</td><td style="text-align: left" valign="top">
<p>0</p>
<p>90</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>iPad to portrait<a id="id552" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">resize</code>
</p>
<p>
<code class="literal">orientationchange</code>
</p>
</td><td style="text-align: left" valign="top">
<p>90</p>
<p>0</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>iPhone to landscape<a id="id553" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">resize</code>
</p>
<p>
<code class="literal">orientationchange</code>
</p>
</td><td style="text-align: left" valign="top">
<p>0</p>
<p>90</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>iPhone to portrait<a id="id554" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">resize</code>
</p>
<p>
<code class="literal">orientationchange</code>
</p>
</td><td style="text-align: left" valign="top">
<p>90</p>
<p>0</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Android phone to landscape<a id="id555" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">orientationchange</code>
</p>
<p>
<code class="literal">resize</code>
</p>
</td><td style="text-align: left" valign="top">
<p>90</p>
<p>90</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Android phone to portrait<a id="id556" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">orientationchange</code>
</p>
<p>
<code class="literal">resize</code>
</p>
</td><td style="text-align: left" valign="top">
<p>0</p>
<p>0</p>
</td></tr></tbody></table></div><p>The <code class="literal">deviceorientation</code> event is very powerful. It returns to the handler an instance of the <code class="literal">DeviceOrientationEvent</code> event with the following information:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">alpha</code>: This returns the rotation of the device around the <em>z</em> axis</li><li class="listitem" style="list-style-type: disc"><code class="literal">beta</code>: This returns the rotation of the device around the <em>x</em> axis</li><li class="listitem" style="list-style-type: disc"><code class="literal">gamma</code>: This returns the rotation of the device around the <em>y</em> axis</li></ul></div><div><div><h3 class="title"><a id="tip11"/>Tip</h3><p>In order to improve the performance of your app, consider using the <code class="literal">event-handler</code> function to do no more than save current values from the sensor data into variables. Then, move your calculations or DOM manipulations into a new function executed at a fixed time.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec66"/>Handling orientation with JavaScript</h2></div></div></div><p>It's time to<a id="id557" class="indexterm"/> put into<a id="id558" class="indexterm"/> practice what you have learned about the device orientation events. Let's work on a very basic sample that is able to show the screen orientation in a <code class="literal">div</code> element rotated according to the device's physical orientation.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec65"/>Time for action – handling device orientation with JavaScript</h1></div></div></div><p>Execute the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the command-line tool and create a new PhoneGap project named <code class="literal">orientationevents</code>, and add the platforms you want to target for this example.</li><li class="listitem">Install the plugin to your project:<div><pre class="programlisting">
<strong>$ phonegap plugin add cordova-plugin-device-motion</strong>
</pre></div></li><li class="listitem">Go to the <code class="literal">www</code> folder, open the <code class="literal">index.html</code> file, and add <code class="literal">div</code> with the <code class="literal">#orientation</code> ID inside the main <code class="literal">div</code> of the app beneath <code class="literal">#deviceready</code>:<div><pre class="programlisting">&lt;div class="app"&gt;
    &lt;h1&gt;Apache Cordova&lt;/h1&gt;
    &lt;div id="deviceready"&gt;
        ......
    &lt;/div&gt;
    &lt;div id="orientation"&gt;
    &lt;/div&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Go to the <code class="literal">css</code> folder <a id="id559" class="indexterm"/>and define two new rules inside the <code class="literal">index.css</code> file to give a border and a bigger font size to <code class="literal">div</code> and its content. You can even add the CSS styles directly to the <code class="literal">head</code> section of your HTML page:<div><pre class="programlisting">#orientation{

    width: 230px;
    border: 1px solid rgb(10, 1, 1);

}

#orientation p{
    font-size: 36px;
    font-weight: bold;
    text-align: center;

}</pre></div></li><li class="listitem">Go to the <code class="literal">js</code> folder, open the <code class="literal">index.js</code> file, and define a new function to easily detect whether<a id="id560" class="indexterm"/> the device can handle the <code class="literal">orientationchange</code> and <code class="literal">deviceorientation</code> events. Alternatively, you can even have the script embedded in your HTML page:<div><pre class="programlisting">orientationSupported: function(){

    try {
        return 'DeviceOrientationEvent' in window &amp;&amp;
        window['DeviceOrientationEvent'] !== null;
    } catch (e) {
        return false;
    }

}</pre></div></li><li class="listitem">In the <code class="literal">deviceready</code> function, add two listeners if the device supports the <code class="literal">orientationchange</code> and <code class="literal">deviceorientation</code> events:<div><pre class="programlisting">if(orientationSupported){

    window.addEventListener('orientationchange', orientationChanged);
    window.addEventListener('deviceorientation', updateOrientation);

}else{

     alert('Orientation not supported!');

}</pre></div></li><li class="listitem">Define the <code class="literal">orientationChanged</code> event handler and use it to print the current device orientation on screen:<div><pre class="programlisting">orientationChanged: function(){

    var element = document.querySelector('#orientation');
    element.innerHTML = '&lt;p&gt;' + window.orientation + '&lt;/p&gt;';

}</pre></div></li><li class="listitem">Define the<a id="id561" class="indexterm"/> handler for the <code class="literal">deviceorientation</code> event and use the information provided by the device's sensor to change the 3D transformation of the <code class="literal">div</code> orientation:<div><pre class="programlisting">updateOrientation: function(event){

    var alpha = event.alpha,
    beta = event.beta,
    gamma = event.gamma;

    var element = document.querySelector('#orientation');
    var rotation = 'rotateZ(' + alpha + 'deg) rotate(' + beta + 'deg) rotateY(' + gamma + 'deg)';
// For brevity the browser prefixes have been removed
    element.style.transform = rotation;

}</pre></div></li><li class="listitem">Open the command-line tool again, locate the main project folder, and then compile the app and test it on every platform you previously added.</li></ol></div><p>Here is the <a id="id562" class="indexterm"/>complete code of this example:</p><div><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;!--Other section removed for sake of simplicity --&gt;
        &lt;title&gt;Media Capture Example&lt;/title&gt;
        &lt;style&gt;
          #orientation{
            width: 230px;
            border: 1px solid rgb(10, 1, 1);
          }

          #orientation p{
            font-size: 36px;
            font-weight: bold;
            text-align: center;
          }
        &lt;/style&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;div class="app"&gt;
        &lt;h1&gt;Apache Cordova&lt;/h1&gt;
        &lt;div id="deviceready"&gt;&lt;/div&gt;
        &lt;div id="orientation"&gt;&lt;/div&gt;
      &lt;/div&gt;

      &lt;script type="text/javascript" src="img/cordova.js"&gt;&lt;/script&gt;
      &lt;script type="text/javascript"&gt;

        document.addEventListener("deviceready", onDeviceReady, false);

        function onDeviceReady() {
          if(orientationSupported){
            window.addEventListener('orientationchange', orientationChanged);
            window.addEventListener('deviceorientation', updateOrientation);
          }else{
            alert('Orientation not supported!');
          }
        }

        orientationSupported: function(){
          try {
            return 'DeviceOrientationEvent' in window &amp;&amp;
            window['DeviceOrientationEvent'] !== null;
          } catch (e) {
            return false;
          }
        }
        orientationChanged: function(){
          var element = document.querySelector('#orientation');
          element.innerHTML = '&lt;p&gt;' + window.orientation + '&lt;/p&gt;';
        }

        updateOrientation: function(event){

          var alpha = event.alpha,
          var beta = event.beta,
          var gamma = event.gamma;

          var element = document.querySelector('#orientation');
          var rotation = 'rotateZ(' + alpha + 'deg) rotate(' + beta + 'deg) rotateY(' + gamma + 'deg)';
          // For brevity the browser prefixes have been removed
          element.style.transform = rotation;
        }

      &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec67"/>
<em>What just happened?</em>
</h2></div></div></div><p>You <a id="id563" class="indexterm"/>handled the<a id="id564" class="indexterm"/> orientation events using JavaScript and deployed the result to a device using PhoneGap. The app is able to get the device screen orientation and the current position in real time.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec66"/>Compass</h1></div></div></div><p>The <a id="id565" class="indexterm"/>PhoneGap Compass API allows you to obtain the direction that the device is pointing to. The compass is a sensor that detects the direction or heading in which the device is pointed and returns the heading of the device in degrees using values from <code class="literal">0</code> to <code class="literal">359.99</code>. The Compass API works similarly to the Accelerometer API; in fact, you can read the current device heading or you can define a watcher in order to continuously read the heading value.</p><p>The Compass API is available on the <code class="literal">compass</code> property of the <code class="literal">navigator</code> object and exposes the following functions:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">compass.getCurrentHeading</code>: This<a id="id566" class="indexterm"/> reads the current compass heading through a handler</li><li class="listitem" style="list-style-type: disc"><code class="literal">compass.watchHeading</code>: This <a id="id567" class="indexterm"/>reads the compass heading at a specific time interval through a handler and returns a reference to it</li><li class="listitem" style="list-style-type: disc"><code class="literal">compass.clearWatch</code>: This <a id="id568" class="indexterm"/>stops a previously defined time interval reading handler</li></ul></div><p>The <code class="literal">getCurrentHeading</code> and <code class="literal">watchHeading</code> functions accept very similar arguments; the only difference is the last argument of the <code class="literal">watchHeading</code> function that allows you to configure it. In order to read the current heading of the device, it is sufficient to execute the <code class="literal">getCurrentHeading</code> function, specifying a success and an error handler:</p><div><pre class="programlisting">navigator.compass.getCurrentHeading(onSuccess, onError);</pre></div><p>The <code class="literal">onSuccess</code> handler receives as an argument a <code class="literal">CompassHeading</code> object with the following properties:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">magneticHeading</code>: This <a id="id569" class="indexterm"/>is the heading in degrees from <code class="literal">0</code> to <code class="literal">359.99</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">trueHeading</code>: This<a id="id570" class="indexterm"/> is the heading relative to the geographic North Pole in degrees</li><li class="listitem" style="list-style-type: disc"><code class="literal">headingAccuracy</code>: This<a id="id571" class="indexterm"/> is the deviation between the reported heading and the true heading in degrees</li><li class="listitem" style="list-style-type: disc"><code class="literal">timestamp</code>: This <a id="id572" class="indexterm"/>is the time at which this heading was determined</li></ul></div><p>The error handler receives a <code class="literal">CompassError</code> object as an argument; the <code class="literal">CompassError</code> object has a property named <code class="literal">code</code> that returns two possible values such as <code class="literal">CompassError.COMPASS_INTERNAL_ERR</code> or <code class="literal">CompassError.COMPASS_NOT_SUPPORTED</code>:</p><div><pre class="programlisting">function onError (error) {
    switch(true){

        case error.code == CompassError.COMPASS_INTERNAL_ERR:
        navigator.notification.alert('Compass Error!', null, 'Info', 'OK');
        break;

        case error.code == CompassError.COMPASS_NOT_SUPPORTED:
        navigator.notification.alert('Compass Unavailable!', null, 'Info', 'OK');
        break;

        default:
        navigator.notification.alert('Generic Error!', null,'Info', 'OK');

    }
}</pre></div><p>The <code class="literal">watchHeading</code> function <a id="id573" class="indexterm"/>works like the <code class="literal">getCurrentHeading</code> function. The only difference is that it accepts an additional <code class="literal">CompassOption</code> object that allows you to set up how often to retrieve the compass heading in milliseconds (that is, frequency) and the change in degrees required to initiate the success handler (that is, filter):</p><div><pre class="programlisting">var options = {<strong>frequency</strong>: 300};
var currentHeading = navigator.compass.watchHeading(
                     onSuccess, onError, <strong>options</strong>);</pre></div><p>In order to stop watching the heading value changes, it is sufficient to use the <code class="literal">clearWatch</code> function and the reference to the current heading watcher:</p><div><pre class="programlisting">clearWatch(currentHeading);</pre></div><div><div><h3 class="title"><a id="note31"/>Note</h3><p>The <code class="literal">trueHeading</code> property of the <code class="literal">CompassHeading</code> object is not supported on Android. It returns the same value as <code class="literal">magneticHeading</code>, and the <code class="literal">headingAccuracy</code> value will always be <code class="literal">0</code> as there is no difference between <code class="literal">magneticHeading</code> and <code class="literal">trueHeading</code>.</p><p>On iOS, the <code class="literal">trueHeading</code> property is returned only when location services are running using the <code class="literal">watchLocation</code> function.</p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec68"/>Creating a compass</h2></div></div></div><p>Reading the <a id="id574" class="indexterm"/>current heading of a device is a common task for a developer in several use cases such as traffic apps, augmented reality apps, or any app that incorporates a sense of direction. Let's see how to create a complete compass with PhoneGap:</p><div><div><h3 class="title"><a id="note32"/>Note</h3><p>The images used to render the compass are available under the Creative Commons license at <a class="ulink" href="http://commons.wikimedia.org/wiki/File:Compass.svg">http://commons.wikimedia.org/wiki/File:Compass.svg</a>. Before starting to work on this example, download the image and create three separate PNG files for the background, dial, and arrow. As it's a SVG vector file, you can handle each layer of the image and edit it as your wish. To edit the image, you can use any vector editing applications such as Adobe Illustrator or a free application such as Inkscape.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec67"/>Time for action – using the Compass API</h1></div></div></div><p>Execute the<a id="id575" class="indexterm"/> following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the command-line tool, create a new PhoneGap project named <code class="literal">compass</code>, and add the platforms you want to target for this example.</li><li class="listitem">Add the Compass API plugin using the following command:<div><pre class="programlisting">
<strong>$ cordova plugin add cordova-plugin-device-orientation</strong>
</pre></div></li><li class="listitem">Go to the <code class="literal">www</code> folder and open the <code class="literal">index.html</code> file. The three <code class="literal">div</code> tags are used to handle the compass arrows and the background:<div><pre class="programlisting">&lt;section id="compass"&gt;
    &lt;div id="compassbg"&gt;&lt;/div&gt;
    &lt;div id="north"&gt;&lt;/div&gt;
    &lt;div id="arrow"&gt;&lt;/div&gt;
&lt;/section&gt;</pre></div></li><li class="listitem">Go to the <code class="literal">css</code> folder, open the <code class="literal">index.css</code> file, and define the rules needed to have a separate background for each element of the compass:<div><pre class="programlisting">#compassbg {
    background-image: url(../img/Compass.png);
}
#north {
    background-image: url(../img/arrow_direction.png);
}

#arrow {
    background-image: url(../img/arrow_beta.png);
}

#compass, #arrow, #north, #compassbg  {
    background-repeat: no-repeat;
    background-size: cover;
    position: fixed;
    width: 286px;
    height: 286px;

}</pre></div></li><li class="listitem">Go to the <code class="literal">js</code> folder, open the <code class="literal">index.js</code> file, and add a new variable in order to store a reference to the watcher that you will define to monitor the device heading. Alternatively, you can have the scripts embedded directly in the page:<div><pre class="programlisting">var currentHeading = null;</pre></div></li><li class="listitem">Locate the <code class="literal">deviceready</code> function and add inside it the snippet of code needed in order to check the device heading every 150 milliseconds:<div><pre class="programlisting">var options = {frequency: 150};
currentHeading = navigator.compass.watchHeading (onCompassSuccess,onCompassError, options);</pre></div></li><li class="listitem">Create a new function named <code class="literal">onCompassSuccess</code> and inside its body, start to read the heading data stored in the received argument; use it to rotate the compass elements:<div><pre class="programlisting">function onCompassSuccess(heading){
  var magneticHeading = heading.magneticHeading;
  var trueHeading = heading.trueHeading;

  var compass = document.querySelector('#compassbg');
  var north = document.querySelector('#north');

  var compassRotation = 'rotate(' + magneticHeading + 'deg)';
  var northRotation = 'rotate(' + trueHeading + 'deg)';
  var compassSytle = compass.style;
  var northStyle = north.style;

  compassStyle.transform = compassRotation;
  northStyle.transform = northRotation;
}</pre></div></li><li class="listitem">Define the function to capture the failures, if any:<div><pre class="programlisting">function onCompassError(error){
  alert("Error with Compass");
}</pre></div></li><li class="listitem">Open the command-line tool again, locate the main project folder, compile the app, and test it on every platform you previously added.</li></ol></div><p>For the example, we<a id="id576" class="indexterm"/> just saw, you can find the complete code here:</p><div><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;!--Other section removed for sake of simplicity --&gt;
        &lt;title&gt;Media Capture Example&lt;/title&gt;
        &lt;style&gt;
          #compassbg {
            background-image: url(../img/Compass.png);
          }
          #north {
            background-image: url(../img/arrow_direction.png);
          }

          #arrow {
            background-image: url(../img/arrow_beta.png);
          }

          #compass, #arrow, #north, #compassbg  {
            background-repeat: no-repeat;
            background-size: cover;
            position: fixed;
            width: 286px;
            height: 286px;
          }

        &lt;/style&gt;

    &lt;/head&gt;
    &lt;body&gt;

      &lt;section id="compass"&gt;
        &lt;div id="compassbg"&gt;&lt;/div&gt;
        &lt;div id="north"&gt;&lt;/div&gt;
        &lt;div id="arrow"&gt;&lt;/div&gt;
      &lt;/section&gt;

      &lt;script type="text/javascript" src="img/cordova.js"&gt;&lt;/script&gt;

      &lt;script type="text/javascript"&gt;
        var currentHeading = null;

        document.addEventListener("deviceready", onDeviceReady, false);

        function onDeviceReady() {
          var options = {frequency: 150};

          currentHeading = navigator.compass.watchHeadingonCompassSuccess, onCompassError, options);
        }

        function onCompassSuccess(heading){
          var magneticHeading = heading.magneticHeading;
          var trueHeading = heading.trueHeading;

          var compass = document.querySelector('#compassbg');
          var north = document.querySelector('#north');

          var compassRotation = 'rotate(' + magneticHeading + 'deg)';
          var northRotation = 'rotate(' + trueHeading + 'deg)';
          var compassSytle = compass.style;
          var northStyle = north.style;

          compassStyle.transform = compassRotation;
          northStyle.transform = northRotation;
        }

        function onCompassError(error){
          alert("Error with Compass");
        }
      &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec69"/>
<em>What just happened?</em>
</h2></div></div></div><p>You<a id="id577" class="indexterm"/> implemented a real, cross-platform compass using the PhoneGap API. In the process, you learned how to use a pretty complex feature of mobile device sensors.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec68"/>An introduction to geolocation</h1></div></div></div><p>The term <a id="id578" class="indexterm"/>
<strong>geolocation</strong> is used in order to refer to the identification process of the real-world geographic location of an object. Devices that are able to detect the user's position are becoming more common each day and we are now used to getting <a id="id579" class="indexterm"/>content based on our location (<strong>geo targeting</strong>).</p><p>Using the<a id="id580" class="indexterm"/> <strong>Global Positioning System</strong> (<strong>GPS</strong>)—a space-based satellite navigation system that provides location and time information consistently across the globe—you can now get the accurate location of a device. During the early 1970s, the US military created Navstar, which is a defense navigation satellite system. Navstar was the system that created the basis for the GPS infrastructure used today by billions of devices. As of October 2014, 68 GPS satellites have been successfully placed in the orbit around the Earth (refer to <a class="ulink" href="http://en.wikipedia.org/wiki/List_of_GPS_satellite_launches">http://en.wikipedia.org/wiki/List_of_GPS_satellite_launches</a> for a detailed report about the past and planned launches).</p><p>The location of a device is represented through a point. This point is comprised of two components: latitude and longitude. There are many methods for modern devices to determine the location information; these include the following:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">GPS</li><li class="listitem" style="list-style-type: disc">IP address</li><li class="listitem" style="list-style-type: disc">GSM/CDMA cell IDs</li><li class="listitem" style="list-style-type: disc">Wi-Fi and Bluetooth MAC address</li></ul></div><p>Each approach <a id="id581" class="indexterm"/>delivers the same information; what changes is the accuracy of the device's position. The GPS satellites continuously transmit information that can parse; for example, the general health of the GPS array, roughly where all of the satellites are in orbit, information on the precise orbit or path of the transmitting satellite, and the time of the transmission. The receiver calculates its own position by timing the signals sent by any of the satellites in the array that is visible.</p><div><div><h3 class="title"><a id="note33"/>Note</h3><p>The process of measuring the distance from a point to a group of satellites in order to locate a position is known as <a id="id582" class="indexterm"/>
<strong>trilateration</strong>. The distance is determined using the speed of light as a constant, along with the time that the signal left the satellites.</p></div></div><p>The emerging trend in mobile development is GPS-based "people discovery" apps such as Highlight, Sonar, Banjo, and Foursquare. Each app has different features and has been built for different purposes, but all of them share the same killer feature: using location as a piece of metadata in order to filter information according to the user's needs.</p></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec69"/>The PhoneGap Geolocation API</h1></div></div></div><p>The <a id="id583" class="indexterm"/>Geolocation API is not a part of the HTML5 specification, but it is tightly integrated with mobile development. The PhoneGap Geolocation API and the W3C Geolocation API mirror each other; both define the same methods and relative arguments. There are several devices that already implement the W3C Geolocation API; for those devices, you can use native support instead of the PhoneGap API.</p><div><div><h3 class="title"><a id="note34"/>Note</h3><p>As per the HTML specification, the user has to explicitly allow the website or the app to use the device's current position.</p></div></div><p>The Geolocation API is exposed through the <code class="literal">geolocation</code> object child of the <code class="literal">navigator</code> object and consists of the following three methods:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">getCurrentPosition()</code>: This<a id="id584" class="indexterm"/> returns the device position</li><li class="listitem" style="list-style-type: disc"><code class="literal">watchPosition()</code>: This <a id="id585" class="indexterm"/>watches for changes in the device position</li><li class="listitem" style="list-style-type: disc"><code class="literal">clearWatch()</code>: This<a id="id586" class="indexterm"/> stops the watcher for the device's position changes</li></ul></div><p>The <code class="literal">watchPosition()</code> and <code class="literal">clearWatch()</code> methods work in the same way that the <code class="literal">setInterval()</code> and <code class="literal">clearInterval()</code> methods work; in fact, the first one returns an identifier that is passed in to the second one. The <code class="literal">getCurrentPosition()</code> and <code class="literal">watchPosition()</code> methods mirror each other and take the same arguments: a success and a failure callback function and an optional <code class="literal">configuration</code> object. The <code class="literal">configuration</code> object is used in <a id="id587" class="indexterm"/>order to specify the maximum age of a cached value of the device's position, in order to set a timeout after which the method will fail and specify whether the application requires only accurate results:</p><div><pre class="programlisting">var options = {maximumAge: 3000, timeout: 5000, 
               enableHighAccuracy: true };
navigator.geolocation.watchPosition(onSuccess, onFailure, options);</pre></div><div><div><h3 class="title"><a id="tip12"/>Tip</h3><p>Only the first argument is mandatory, but it's recommended to always handle the failure use case.</p></div></div><p>The success handler function receives a <code class="literal">Position</code> object as an argument. Accessing its properties, you can read the device's coordinates and the creation timestamp of the object that stores the coordinates:</p><div><pre class="programlisting">function onSuccess(position) {

    console.log('Coordinates: ' + position.coords);
    console.log('Timestamp: ' + position.timestamp);

}</pre></div><p>The <code class="literal">coords</code> property of the <code class="literal">Position</code> object contains a <code class="literal">Coordinates</code> object; so far, the most important properties of this object are <code class="literal">longitude</code> and <code class="literal">latitude</code>. Using those properties, it's possible to start to integrate positioning information as relevant metadata in your app.</p><p>The failure handler receives a <code class="literal">PositionError</code> object as an argument. Using the <code class="literal">code</code> and the <code class="literal">message</code> property of this object, you can gracefully handle every possible error:</p><div><pre class="programlisting">function onError(error) {
    console.log('message: ' + error.message);
    console.log ('code: ' + error.code);

}</pre></div><p>The <code class="literal">message</code> property returns a detailed description of the error and the <code class="literal">code</code> property returns an integer; the possible values are represented through the following pseudo constants:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">PositionError.PERMISSION_DENIED</code>: This <a id="id588" class="indexterm"/>indicates that the user denied the app to use the device's current position</li><li class="listitem" style="list-style-type: disc"><code class="literal">PositionError.POSITION_UNAVAILABLE</code>: This<a id="id589" class="indexterm"/> indicates that the position of the device cannot be determined<div><div><h3 class="title"><a id="note35"/>Note</h3><p>If you want to recover the last available position when the <code class="literal">POSITION_UNAVAILABLE</code> error is returned, you have to write a custom plugin that uses the platform-specific API. Android and iOS have this feature. You can find a detailed example at <a class="ulink" href="http://stackoverflow.com/questions/10897081/retrieving-last-known-geolocation-phonegap">http://stackoverflow.com/questions/10897081/retrieving-last-known-geolocation-phonegap</a>.</p></div></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">PositionError.TIMEOUT</code>: This<a id="id590" class="indexterm"/> indicates that the specified timeout has elapsed before the implementation could successfully acquire a new <code class="literal">Position</code> object.</li></ul></div><div><div><h3 class="title"><a id="note36"/>Note</h3><p>JavaScript doesn't support constants such as Java and other object-oriented programming languages. With the term "pseudo constants," I refer to those values that should never change in a JavaScript app.</p></div></div><p>One of the most <a id="id591" class="indexterm"/>common tasks to perform with the device position information is to show the device location on a map. You can quickly perform this task by integrating Google Maps in your app; the only requirement is a valid API key. To get the key, use the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Visit the APIs' console at <a class="ulink" href="https://code.google.com/apis/console">https://code.google.com/apis/console</a> and log in with your Google account.</li><li class="listitem">Select <strong>APIs &amp; auth</strong> in the left-hand side menu.</li><li class="listitem">Select <strong>Google Maps JavaScript API</strong> and activate the service.</li></ol></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec70"/>Time for action – showing device position with Google Maps</h1></div></div></div><p>Get ready to add a <a id="id592" class="indexterm"/>map renderer to the PhoneGap default app template. Execute the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the command-line tool and create a new PhoneGap project named <code class="literal">MapSample</code>:<div><pre class="programlisting">
<strong>$ cordova create MapSample</strong>
</pre></div></li><li class="listitem">Change the working directory to the newly created project:<div><pre class="programlisting">
<strong>$ cd MapSample</strong>
</pre></div></li><li class="listitem">Add the required platform to the project. For example, we will add Android to this project:<div><pre class="programlisting">
<strong>$ cordova platform add android</strong>
</pre></div></li><li class="listitem">Add the Geolocation API plugin using the following command:<div><pre class="programlisting">
<strong>$ cordova plugin add cordova-plugin-geolocation</strong>
</pre></div></li><li class="listitem">Go to the <code class="literal">www</code> folder, open the <code class="literal">index.html</code> file, remove all the existing content, and add a <code class="literal">div</code> element with the <code class="literal">id</code> value as <code class="literal">#map</code> inside the <code class="literal">body</code> tag:<div><pre class="programlisting">&lt;div id='map'&gt;&lt;/div&gt;</pre></div></li><li class="listitem">Include the <code class="literal">cordova.js</code> file that will be added to the app at runtime:<div><pre class="programlisting">&lt;script type="text/javascript" src="img/cordova.js"&gt;&lt;/script&gt;</pre></div></li><li class="listitem">Add a new <code class="literal">script</code> tag to include the Google Maps JavaScript library. Replace the <code class="literal">YOUR_API_KEY</code> value with your actual Google Maps API key:<div><pre class="programlisting">&lt;script type="text/javascript"
   src="img/strong>&amp;sensor=true"&gt;
&lt;/script&gt;</pre></div></li><li class="listitem">Create a new CSS style to give an appropriate size to the <code class="literal">div</code> element and its content:<div><pre class="programlisting">#map{

    width: 280px;
    height: 230px;
    display: block;
    margin: 5px auto;
    position: relative;

}</pre></div></li><li class="listitem">In the JavaScript section, define a new function named <code class="literal">initMap</code>:<div><pre class="programlisting">function initMap(lat, long){

    // The code needed to show the map and the
    // device position will be added here

   }</pre></div></li><li class="listitem">In the<a id="id593" class="indexterm"/> body of the function, define an <code class="literal">options</code> object in order to specify how the map has to be rendered:<div><pre class="programlisting">var options = {

    zoom: 8,
    center: new google.maps.LatLng(lat, long),
    mapTypeId: google.maps.MapTypeId.ROADMAP

};</pre></div></li><li class="listitem">Add to the body of the <code class="literal">initMap</code> function the code to initialize the rendering of the map and to show a marker representing the current device's position over it:<div><pre class="programlisting">var map = new google.maps.Map(document.getElementById('map'), options);

var markerPoint = new google.maps.LatLng(lat, long);

var marker = new google.maps.Marker({

    position: markerPoint,
    map: map,
    title: 'Device\'s Location'

});</pre></div></li><li class="listitem">Define a function to use as the success handler and call from its body the <code class="literal">initMap</code> function previously defined:<div><pre class="programlisting">function onSuccess(position){

    var coords = position.coords;
    initMap(coords.latitude, coords.longitude);

}</pre></div></li><li class="listitem">Define another function in order to have a failure handler that is able to notify the user that something went wrong:<div><pre class="programlisting">function onFailure(error){

    alert(error.message);

}</pre></div></li><li class="listitem">Go into <a id="id594" class="indexterm"/>the <code class="literal">deviceready</code> function and add as the last statement the call to the Geolocation API needed to recover the device's position:<div><pre class="programlisting">navigator.geolocation.getCurrentPosition(app.onSuccess, app.onFailure, {timeout: 5000, enableAccuracy: false});</pre></div></li><li class="listitem">Open the command-line tool, build the app, and then run it on your testing devices:<div><pre class="programlisting">
<strong>$ cordova build</strong>
<strong>$ cordova run android</strong>
</pre></div></li></ol></div><p>Here is the <a id="id595" class="indexterm"/>project's complete code for your reference:</p><div><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;GeoLocation Example&lt;/title&gt;

&lt;style&gt;
  #map{
    width: 280px;
    height: 230px;
    display: block;
    margin: 5px auto;
    position: relative;
  }
&lt;/style&gt;

&lt;/head&gt;
&lt;body&gt;

&lt;div id='map'&gt;&lt;/div&gt;

&lt;script type="text/javascript" src="img/cordova.js"&gt;&lt;/script&gt;

&lt;script type="text/javascript" src="img/js?key=YOUR_API_KEY&amp;sensor=true"&gt;&lt;/script&gt;

&lt;script type="text/javascript"&gt;
  var currentHeading = null;

  document.addEventListener("deviceready", onDeviceReady, false);

  function onDeviceReady() {
    navigator.geolocation.getCurrentPosition(onSuccess, onFailure, {timeout: 5000, enableAccuracy: false});
  }

  function onSuccess(position){
    var coords = position.coords;
    initMap(coords.latitude, coords.longitude);
  }

  function initMap(lat, long){
    var options = {
      zoom: 8,
      center: new google.maps.LatLng(lat, long),
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    var map = new google.maps.Map(document.getElementById('map'), options);

    var markerPoint = new google.maps.LatLng(lat, long);

    var marker = new google.maps.Marker({
      position: markerPoint,
      map: map,
      title: 'Device\'s Location'
    });
  }

  function onFailure(error){
    alert(error.message);
  }

&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec70"/>
<em>What just happened?</em>
</h2></div></div></div><p>You integrated <a id="id596" class="indexterm"/>Google Maps inside an app. This map is an interactive map most users are familiar with—the most common gestures are already working and the Google Street View controls are already enabled.</p><div><div><h3 class="title"><a id="tip13"/>Tip</h3><p>To successfully load the Google Maps API on iOS, it's mandatory to whitelist the <code class="literal">googleapis.com</code> and <code class="literal">gstatic.com</code> domains. Open the <code class="literal">.plist</code> file of the project as source code (right-click on the file and then <strong>Open As</strong> | <strong>Source Code</strong>) and add the following array of domains:</p><div><pre class="programlisting">&lt;key&gt;ExternalHosts&lt;/key&gt;
&lt;array&gt;
    &lt;string&gt;*.googleapis.com&lt;/string&gt;
    &lt;string&gt;*.gstatic.com&lt;/string&gt;
&lt;/array&gt;</pre></div></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec71"/>Other geolocation data</h2></div></div></div><p>In the<a id="id597" class="indexterm"/> previous example, you only used the <code class="literal">latitude</code> and <code class="literal">longitude</code> properties of the <code class="literal">position</code> object that you received. There are other attributes that can be accessed as properties of the <code class="literal">Coordinates</code> object:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">altitude</code>: This<a id="id598" class="indexterm"/> gives the height of the device, in meters, above the sea level</li><li class="listitem" style="list-style-type: disc"><code class="literal">accuracy</code>: This<a id="id599" class="indexterm"/> gives the accuracy level of the latitude and longitude, in meters; it can be used to show a radius of accuracy when mapping the device's position</li><li class="listitem" style="list-style-type: disc"><code class="literal">altitudeAccuracy</code>: This<a id="id600" class="indexterm"/> gives the accuracy of the altitude in meters</li><li class="listitem" style="list-style-type: disc"><code class="literal">heading</code>: This <a id="id601" class="indexterm"/>gives the direction of the device in degrees clockwise from true north</li><li class="listitem" style="list-style-type: disc"><code class="literal">speed</code>: This<a id="id602" class="indexterm"/> gives the current ground speed of the device in meters per second</li></ul></div><p>The <code class="literal">latitude</code> and <code class="literal">longitude</code> properties are the best supported of these properties, and the ones that will be most useful when communicating with remote APIs. The other properties are mainly useful if you're developing an application for which geolocation is a core component of its standard functionality, such as apps that make use of this data to create a flow of information contextualized to the geolocation data. The <code class="literal">accuracy</code> property is the most important of these additional features, because as an application developer, you typically won't know which particular sensor is giving you the location and you can use the <code class="literal">accuracy</code> property as a range in your queries to external services.</p><p>There are several APIs that allow you to discover interesting data related to a place; among these, the most interesting are the Google Places API and the Foursquare API.</p><div><div><h3 class="title"><a id="note37"/>Note</h3><p>The Google Places and Foursquare online documentation is very well organized and it's the right place to start if you want to dig deeper into these topics. You can access the<a id="id603" class="indexterm"/> Google Places docs at <a class="ulink" href="https://developers.google.com/maps/documentation/javascript/places">https://developers.google.com/maps/documentation/javascript/places</a> and Foursquare<a id="id604" class="indexterm"/> at <a class="ulink" href="https://developer.foursquare.com/">https://developer.foursquare.com/</a>.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec71"/>Summary</h1></div></div></div><p>In this chapter, you learned how to work with device sensors to enhance the functionality of your app. You also learned how to get the geolocation information from a device and how to integrate external geolocation service in the app. Furthermore, you continued to gain an understanding of the PhoneGap APIs that allow you to create powerful native apps.</p><p>In the next chapter, you will start to work with some advanced concepts of using PhoneGap.</p></div></body></html>