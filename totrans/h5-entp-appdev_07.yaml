- en: 'Chapter 7. The App: Showing Ratings via Canvas'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Until now, we have seen ways to lay out and draw elements in our enterprise
    application using CSS and images. If we need to create complex visualizations
    and/or animations based on dynamic data, the use of `DOM` objects becomes intricate
    and its manipulation slow. For that reason, the `canvas` tag was introduced in
    the HTML5 specification. The `canvas` tag defines a rectangular area where we
    can draw anything using its JavaScript API. This chapter introduces the `canvas`
    tag for data visualizations and simple animations.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter, we will cover:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: Charting
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Preparing our code
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Everything depends on the context (2D and 3D contexts)
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Charting
  id: totrans-6
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Our current implementation of MovieNow uses a subset of the data provided by
    the `movielistings.php` web service. Some of the data not used includes ratings
    from MetaCritic, EditorBoost, and general user ratings (`avgMetaCriticRating`,
    `editorBoost`, and `avgUserRating` respectively). MovieNow users would love to
    see that information in the form of bar charts. For that, we will use `canvas`.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  id: totrans-8
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Although it is possible to render this information using `DOM` objects it can
    be slower and more restrictive.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
- en: Preparing our code
  id: totrans-10
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'We need to add a new interaction to show the ratings chart with a click. Let
    us remove our current on-click interaction:'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-12
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'The new interaction will include two buttons: one to show the movie description
    and the other to show the ratings chart. Inside the `img` folder, you will find
    an `options.png` image sprite. It has icons for both information and charts.'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
- en: '![Preparing our code](img/5689_07_01.jpg)'
  id: totrans-14
  prefs: []
  type: TYPE_IMG
- en: 'Using the `details-button` and `charting-button` classes, let us add some styles
    to `styles.css`. Each button will be 45 px x 45 px, using absolute positioning
    to place it in the bottom-right corner:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-16
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Place the details button to the left-hand side of the charting button:'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-18
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Set the correct image for the charting button:'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-20
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'In the `displayShowtimes` function of `movienow.geolocation.js`, we will need
    to change the HTML structure to add our new buttons:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-22
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'We will also place our chart container with its canvas. At this point, we are
    going to use the HTML5 custom data attribute – `data-feed`, to store information
    about ratings in each canvas:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-24
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Note
  id: totrans-25
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: HTML5 custom data attributes allow the embedding of metadata on HTML elements.
    Your attribute name must have a prefix, `data-`, followed at least by one character
    string; in our case we use the word `feed` so our attribute name is `data-feed`.
    It does not allow uppercase and the value is a string.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
- en: 'Putting it together, we get:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-28
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Add some spacing before the charting elements in `styles.css`:'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-30
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'To hide and show the `charting` and `description` areas, we are going to use
    the `desc` class. If the `desc` class is applied to the `li` tag, we will hide
    `charting` and show `description`. Otherwise, we hide `description` and show `charting`:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Back to `movienow.geolocation.js`, we define methods to show chart (`showCharts`)
    and show details (`showDetails`). For `showCharts`, we will use jQuery''s chaining
    capability. `$(event.target)` if the button is clicked, so we go two levels up
    using `parent()`; remove the `desc` class from the current object (`li`), add
    the `open` class, and find the first `canvas` element:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Tip
  id: totrans-35
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: jQuery allows for the concatenation of method calls applying each method to
    the result of the previous one. This improves performance but sometimes goes against
    readability.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
- en: 'We are going to create a function called `charts` to draw each canvas, this
    function will take the `canvas` object as a parameter. Our final method should
    look like the following:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Apply the same train of thought to show details:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  id: totrans-40
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Add event handlers for a click to open and close:'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  id: totrans-42
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Now we create `movienow.charts.js` and add the `charts` method:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Notice that the `charts` method calls the `drawBarChart` method. We use this
    construct to change the drawing method later.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
- en: 'Remember to include `movienow.charts.js` in `index.html`:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  id: totrans-47
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Everything depends on the context
  id: totrans-48
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Canvas provides APIs to draw in two or three dimensions, where supported. Canvas
    2D has wider support than Canvas 3D; the latter is generally not supported on
    any mobile browser.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
- en: 'You can define what API to use by getting the canvas context. Let us suppose
    that `chart` is our `canvas` object. If you want to draw in two dimensions, you
    can use:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Then, you can use the 2D API to draw, for example, a red square defining its
    color:'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  id: totrans-53
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'Draw the shape as follows:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'For the 3D API, the use is far more complicated. First, it is still not fully
    supported as some browsers recognize `webgl`:'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  id: totrans-57
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'While others use `experimental-webgl`:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: This is because the `webgl` specification is still in development. Use of WebGL
    requires knowledge of computer graphics and concepts like cameras, lights, textures,
    materials, mapping, and so on.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
- en: 2D context
  id: totrans-61
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: We are going to create a horizontal bar chart to show MetaCritic, EditorBoost,
    and user ratings. The idea is to use green, yellow, and red to indicate how high
    or low the rating is.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following image, we can see our chart design:'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
- en: '![2D context](img/5689_07_02.jpg)'
  id: totrans-64
  prefs: []
  type: TYPE_IMG
- en: Based on the `movienow.charts.js` structure we have established, let us write
    the `drawBarChart` method. As we do not want to redraw our canvas every time we
    call this method, we are going to use the `painted` class as a flag to determine
    if the canvas is already drawn.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
- en: 'We can then save `canvas` as a jQuery object:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'Then, we can verify if it has the `painted` class:'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'Inside our conditional, we split `data-feed` that contains rating information
    in order to iterate over it, building a bar for each rating category:'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'We then get the 2D context:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: An overview of the Canvas 2D Drawing API
  id: totrans-74
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Let us go over the most useful methods of Canvas in a 2D context:'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
- en: Styles
  id: totrans-76
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'The methods used for setting styles in Canvas 2D API are explained as follows:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
- en: '`context.strokeStyle(value)`: This receives a string containing a CSS color
    of the stroke; if no parameter is passed, it returns the current style for stroking
    shapes.'
  id: totrans-78
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.fillStyle(value)`: It receives a string with the CSS color for filling
    shapes; if no parameter is passed, it returns the current fill style.'
  id: totrans-79
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Tip
  id: totrans-80
  prefs:
  - PREF_IND
  - PREF_H3
  type: TYPE_NORMAL
- en: '`strokeStyle` and `fillStyle` can receive `CanvasGradient` or `CanvasPattern`
    as a parameter, allowing you to draw gradients and patterns. For more information
    about how to create gradients and patterns, you can check out the canvas 2D API
    specification: [http://dev.w3.org/2006/canvas-api/canvas-2d-api.html](http://dev.w3.org/2006/canvas-api/canvas-2d-api.html).'
  id: totrans-81
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '`context.lineWidth(value)`: It defines the width of the lines using pixels.
    It only accepts positive values; if no value is passed, it acts like a getter
    and returns the current line width.'
  id: totrans-82
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.lineCap(value)`: It sets the style of the end (or cap) of lines. Possible
    values are `butt`, `round`, and `square`. If no value is passed, it returns the
    current line cap.'
  id: totrans-83
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.lineJoin(value)`: It sets the style of the connection of lines. Possible
    values are `bevel`, `round`, and `miter`. If no value is passed, it returns the
    current line joint style.'
  id: totrans-84
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Font styles
  id: totrans-85
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'The methods used for setting font styles in canvas 2D API are explained as
    follows:'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
- en: '`context.font(value)`: It defines the style of the fonts using a string with
    CSS syntax. If no value is passed, it returns the current font style.'
  id: totrans-87
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.fillText``(text,x,y[, maxWidth])`: It draws text. It receives a `text`
    string with the information to draw `x` and `y` coordinates in pixels and `maxWidth`
    that defines the maximum size in pixels for the container''s width, which is optional.'
  id: totrans-88
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.strokeText(text,x,y[, maxWidth])`: It behaves like `fillText` but
    draws only the stroke of the text.'
  id: totrans-89
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Drawing simple shapes
  id: totrans-90
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'The methods used for drawing simple shapes in the Canvas 2D API are as follows:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
- en: '`context.clearRect(x, y, w, h)`: It defines a rectangle with coordinates `x`
    and `y`, width `w`, and height `h`, and clears all pixels inside the area defined.
    Values are in pixels.'
  id: totrans-92
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.fillRect(x, y, w, h)`: It draws a rectangle with coordinates `x` and
    `y`, width `w` and height `h` using the predefined `fillStyle`.'
  id: totrans-93
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.strokeRect``(x, y, w, h)`: It draws the stroke of a rectangle with
    coordinates `x` and `y`, width `w`, and height `h` using the predefined `strokeStyle`.'
  id: totrans-94
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Drawing complex shapes
  id: totrans-95
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: To create more complex shapes, Canvas 2D API allows you to define paths and
    subpaths. A path is a collection of subpaths while a subpath is a list of points
    connected by lines or curves.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
- en: The current project does not require complex shapes, but it is good to know
    the methods that allow you to draw curves and lines making it possible to draw
    any figure.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
- en: We need to be aware that our context always contains a current path, and it
    is not possible to have more than one.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
- en: '`co``ntext.beginPath()`: It resets the current path'
  id: totrans-99
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.closePath()`: It closes the current path and creates a new one with
    a first point that uses the same coordinates as the last subpath point'
  id: totrans-100
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.moveTo(x, y)`: It creates a new subpath with coordinates `x` and `y`'
  id: totrans-101
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.lineTo(x, y)`: It creates a line between the current point and a new
    point with coordinates `x` and `y` adding the latest to the current subpath'
  id: totrans-102
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.quadraticCurveTo(cpx, cpy, x, y)`: It creates a quadratic curve between
    the current point and a new point with coordinates `x` and `y` using a control
    point, defined with coordinates `cpx` on the x axis, and `cpy` on the y axis'
  id: totrans-103
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, x, y)`: It creates a Bezier
    curve between the current point and a new point with coordinates `x` and `y` using
    two control points cp1(`cp1x`, `cp1y`) and cp2 (`cp2x`, `cp2y`)'
  id: totrans-104
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.arcTo(x1, y2, x2, y2, radius)`: It connects the current point with
    a new point with coordinates `x1` and `y1`, then creates a new point with coordinates
    `x2` and `y2` joined with the previous one by an arc with radius defined by the
    parameter `radius`'
  id: totrans-105
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.rect(x, y, w, h)`: It adds a rectangle with coordinates `x` and `y`,
    width `w`, and height `h` to the list of subpaths'
  id: totrans-106
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.fill()`: It applies the current fill style to fill the subpaths'
  id: totrans-107
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.stroke()`: It applies the current stroke style to create stroke lines
    for the subpaths'
  id: totrans-108
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`context.isPointInPath(x, y)`: It returns `true` if the point defined by coordinates
    `x` and `y` is in the current path and `false` otherwise'
  id: totrans-109
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'There are other methods that can be useful for more complicated drawings and
    animations; you can look at the canvas specification here: [http://dev.w3.org/2006/canvas-api/canvas-2d-api.html](http://dev.w3.org/2006/canvas-api/canvas-2d-api.html).'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
- en: Drawing charts
  id: totrans-111
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'First, let us define the text style for that context and a variable to count
    the current bar index (in case not all movies have the same number of rating categories):'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  id: totrans-113
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'Iterate over rating categories and get the current value:'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  id: totrans-115
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'We draw (only if the value is bigger than `0`) first a gray bar (`#292929`)
    that defines a width of `290` px and a height of `26` px. Using the syntax `fillRect(x,y,width,height)`,
    notice that we use `36` to give 10 pixels of separation between bars:'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  id: totrans-117
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: Note
  id: totrans-118
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The canvas origin is positioned in the upper-left corner of the canvas DOM object.
    Positive values go below origin and to the right-hand side.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
- en: 'We can then draw our color bar. For that, we define a `getChartColor` method
    that returns different colors depending on the rating value using green for higher
    ones, yellow for mediums, and red for lowest:'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  id: totrans-121
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'Using our `getChartColor` method and current rating value `val`, we can set
    the shape:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  id: totrans-123
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'To draw the rating category title, we change fill style to a transparent white,
    and then we use `fillText` with syntax `fillText(text, x,y)`:'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE29]'
  id: totrans-125
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: Tip
  id: totrans-126
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Notice that we can use hexadecimal, RGB, or RGBA colors to define `fillStyle`.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
- en: 'Finally, we write a validation such that if there is no data we show a message
    that says **No Data Available**:'
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE30]'
  id: totrans-129
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'Wrap it all together:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE31]'
  id: totrans-131
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: 'In this example, we do not need to clear our canvas area because we are not
    animating or changing information after our first draw. However, if we do require
    redrawing, we can use:'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE32]'
  id: totrans-133
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: Note
  id: totrans-134
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Canvas 2D context provides a procedural approach to drawing—creating bitmap
    images. If we need to use vectorial graphics instead of bitmaps it's possible
    to use Scalable Vector Graphics (SVG), which provides a declarative approach using
    XML. To know more about SVG you can research here [http://www.w3.org/Graphics/SVG/](http://www.w3.org/Graphics/SVG/).
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
- en: 'The Canvas 2D API is supported in all modern browsers including Internet Explorer
    since Version 9.0\. As we have shown in [Chapter 2](ch02.html "Chapter 2. HTML5
    Starter Kit: Useful Tools"), *HTML Starter Kit: Useful Tools*, it is still possible
    to support previous versions of Internet Explorer using ExplorerCanvas [http://code.google.com/p/explorercanvas/downloads/list](http://code.google.com/p/explorercanvas/downloads/list).'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
- en: 3D context – WebGL and experimental WebGL
  id: totrans-137
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Now that we saw a two-dimensional implementation of our chart solution, let
    us try to create a three-dimensional version and add some animations to make things
    more interesting.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-139
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: When we think of user experience, a general rule is that less is more. That
    means that keeping things simple should make our application more usable. In this
    case, we are going to add animations that are not needed for the sake of learning
    how to do it.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
- en: In our case we are going to draw bar charts using WebGL and rating categories
    titles using DOM objects.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
- en: 'The final implementation should look like the following:'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
- en: '![3D context – WebGL and experimental WebGL](img/5689_07_03.jpg)'
  id: totrans-143
  prefs: []
  type: TYPE_IMG
- en: Entering a tridimensional world
  id: totrans-144
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The WebGL specification is based on the OpenGL for Embedded Systems 2.0 (or
    OpenGL ES) specification. Unless you are familiar with OpenGL and you need to
    work with low level manipulations, it is suggested that you use a library that
    abstracts the use of it. Among the advantages are more readable code, less development
    time, and better extensibility.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
- en: In our case, we selected `Three.js`, a JavaScript library that simplifies the
    use of WebGL using common metaphors used in other tridimensional libraries.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  id: totrans-147
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Consider project objectives when you have to decide which library to use, and
    think in terms of future improvements and limitations of that library.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
- en: Three.js
  id: totrans-149
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '`Three.js` is a JavaScript library that abstracts 3D manipulation allowing
    us to use simple metaphors like scenes, cameras, objects, and so on. You can download
    `Three.js` from [https://github.com/mrdoob/three.js/ a](https://github.com/mrdoob/three.js/
    a)nd read its documentation at [http://mrdoob.github.com/three.js/docs/50/](http://mrdoob.github.com/three.js/docs/50/).'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
- en: 'Let us go over some basic concepts:'
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
- en: Scene
  id: totrans-152
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: The scene is the virtual environment where we can insert objects. Every object
    must be in a `scene` in order to visualize it.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
- en: You can create scenes using `scene = new THREE.Scene()` and add an object to
    it using `scene.add(object)`.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
- en: Camera
  id: totrans-155
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: A camera indicates which section of our scene to visualize. Think of it as a
    movie; if we want to record a specific place, we need to point our camera at it.
    `Three.js` provides an abstract `Camera` class for cameras, two basic cameras,
    and two extra implementations of cameras.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
- en: '`OrthographicCamera` defines an orthographic projection defined by a cube formed
    for the constructor parameters:'
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE33]'
  id: totrans-158
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: '`left` – defines left plane using a float that indicates position'
  id: totrans-159
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`right` – defines right plane using a float that indicates position'
  id: totrans-160
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`top` – defines top plane using a float that indicates position'
  id: totrans-161
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`bottom` – defines bottom plane using a float that indicates position'
  id: totrans-162
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`near` – defines the plane nearest to the camera or near plane using a float
    that indicates position'
  id: totrans-163
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`far` – defines the plane farthest to the camera or far plane using a float
    that indicates position'
  id: totrans-164
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`PerspectiveCamera` defines a perspective projection using field of view, aspect
    ratio, near and far values:'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE34]'
  id: totrans-166
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: '`fov` – defines the angle that indicates the field of view represented by a
    float'
  id: totrans-167
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`aspect` – defines the camera aspect ratio defined by a float'
  id: totrans-168
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`near` – as in `OrtographicCamera` defines near plane using a float'
  id: totrans-169
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`far` – as in `OrtographicCamera` defines far plane using a float'
  id: totrans-170
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'A visual representation of a perspective camera is shown in the following figure:'
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
- en: '![Camera](img/5689EN_07_04.jpg)'
  id: totrans-172
  prefs: []
  type: TYPE_IMG
- en: Material
  id: totrans-173
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Materials define a set of properties that describe the appearance of objects.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
- en: Texture
  id: totrans-175
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Textures define appearance of objects using images (or procedural patterns).
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
- en: Mesh
  id: totrans-177
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Meshes are part of the list of objects than can be added to the scene. You can
    assign geometries and materials to a mesh.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
- en: Geometry
  id: totrans-179
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Geometry is a representation of an object that can be assigned to a mesh. In
    our case, we are going to use `CubeGeometry` to define our bars.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
- en: 'To start, we will download and include `three.js` in our `index.html` file:'
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE35]'
  id: totrans-182
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: 'We then add a new parameter to our `charts` class to specify which rendering
    we would like to use:'
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE36]'
  id: totrans-184
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: 'We define as default **3DChart** in the `showCharts` method:'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE37]'
  id: totrans-186
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: 'Now let us write our 3D drawing method `draw3DChart`. As our previous two-dimensional
    drawing method, this one takes our `canvas` as a parameter:'
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE38]'
  id: totrans-188
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: 'As before, we verify if Canvas has the `painted` class to avoid initializing
    it again. We can then verify WebGL support and, if it is not supported, we render
    our 2D charts:'
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE39]'
  id: totrans-190
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: 'Inside `webGLSupport`, we get our ratings data, `canvas` dimensions, and a
    variable to store time for animation:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE40]'
  id: totrans-192
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: 'Now we define a `three.js` renderer using WebGL, which contains our new canvas,
    and set its dimensions:'
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE41]'
  id: totrans-194
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: We assign the `data` attribute and the `painted` class to the renderer DOM element
    (`canvas`) and replace our old `canvas` with this one.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE42]'
  id: totrans-196
  prefs: []
  type: TYPE_PRE
  zh: '[PRE42]'
- en: We implement our camera using field of vision (FOV) 45 degree, aspect ratio
    based on canvas dimensions, near of 1 and far of 1000, and we position our camera
    to 700 on the z axis.
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE43]'
  id: totrans-198
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: 'Then we define our scene, a `bars` array to store meshes to be rendered later,
    an `index` as in our 2D example and a `labels` string to store the DOM object
    that will show the titles:'
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE44]'
  id: totrans-200
  prefs: []
  type: TYPE_PRE
  zh: '[PRE44]'
- en: 'Iterate over rating categories as our previous example. We get a color for
    our current value using `getChartColor` and replace `#` with `0x` because of the
    color notation used:'
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE45]'
  id: totrans-202
  prefs: []
  type: TYPE_PRE
  zh: '[PRE45]'
- en: 'As we will have six faces for each bar, we will have six different materials.
    Each one will have its own color, so we define arrays for `colors` and `materials`.
    We fill our title information in the `labels` string too:'
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE46]'
  id: totrans-204
  prefs: []
  type: TYPE_PRE
  zh: '[PRE46]'
- en: 'Notice that we can have more than one material assigned. In this case, we use
    the following to define a transparent fill for our solids:'
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE47]'
  id: totrans-206
  prefs: []
  type: TYPE_PRE
  zh: '[PRE47]'
- en: 'The following draws the edges:'
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE48]'
  id: totrans-208
  prefs: []
  type: TYPE_PRE
  zh: '[PRE48]'
- en: 'Each `bar` is defined as a mesh with geometry. Use the following `CubeGeometry`
    syntax:'
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE49]'
  id: totrans-210
  prefs: []
  type: TYPE_PRE
  zh: '[PRE49]'
- en: 'This creates a new `CubeGeometry` object:'
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE50]'
  id: totrans-212
  prefs: []
  type: TYPE_PRE
  zh: '[PRE50]'
- en: Animating our geometries
  id: totrans-213
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: We are going to animate the growing of the bars, so we will scale them on the
    x axis.
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE51]'
  id: totrans-215
  prefs: []
  type: TYPE_PRE
  zh: '[PRE51]'
- en: 'Meshes have their reference points at their centers, so positioning the mesh
    and setting the overdraw to manage transparent geometries, we have:'
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE52]'
  id: totrans-217
  prefs: []
  type: TYPE_PRE
  zh: '[PRE52]'
- en: 'We add the bar to our scene and to our array with the final width that we should
    have at the end of our animation:'
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE53]'
  id: totrans-219
  prefs: []
  type: TYPE_PRE
  zh: '[PRE53]'
- en: 'So our iteration should look as follows:'
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE54]'
  id: totrans-221
  prefs: []
  type: TYPE_PRE
  zh: '[PRE54]'
- en: 'At this point, we have not rendered anything. We can remedy that by setting
    the `labels` string and appending it:'
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE55]'
  id: totrans-223
  prefs: []
  type: TYPE_PRE
  zh: '[PRE55]'
- en: 'We set a `three` structure that we will use for our rendering, and then we
    call our render method – `animate3DChart`:'
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE56]'
  id: totrans-225
  prefs: []
  type: TYPE_PRE
  zh: '[PRE56]'
- en: 'Our `draw3DChart` method looks as follows:'
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE57]'
  id: totrans-227
  prefs: []
  type: TYPE_PRE
  zh: '[PRE57]'
- en: Finishing up
  id: totrans-228
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'We create a `window.requestAnimFrame` method to abstract the definition of
    our `timeout` for animation. Notice that we use `1000/60`. This indicates 60 frames
    per second (`FPS`):'
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE58]'
  id: totrans-230
  prefs: []
  type: TYPE_PRE
  zh: '[PRE58]'
- en: 'For the `animate3DChart` method, we simply define a variable to stop our animation
    (`isReady`), and scale and position each `bar` stopping when we reach 100 percent
    scale (in this case `1`):'
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE59]'
  id: totrans-232
  prefs: []
  type: TYPE_PRE
  zh: '[PRE59]'
- en: 'If we want to rotate each bar with no stop, we can define some values to control
    the animation:'
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE60]'
  id: totrans-234
  prefs: []
  type: TYPE_PRE
  zh: '[PRE60]'
- en: We can then substitute `isReady=(three.bars[i].object.scale.x>=1)` with `three.bars[i].object.rotation.x
    += angleChange`.
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
- en: 'To modify rotation on the x axis, we can add the following:'
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE61]'
  id: totrans-237
  prefs: []
  type: TYPE_PRE
  zh: '[PRE61]'
- en: The canvas WebGL API is not fully supported by all browsers. You can use the
    3D API for Firefox 4.0+, Chrome, Opera, and Safari since Version 5.1 (on OSX or
    higher, but not Safari for iOS devices or Safari for Windows).
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  id: totrans-239
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: WebGL is disabled by default on Safari. To enable WebGL on Safari, click on
    the **Safari** menu and select **Preferences**, then click on the **Advanced**
    tab. At the bottom, check the **Show Develop menu in menu bar** checkbox. Open
    the **Develop** menu and then select **Enable WebGL**.
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
- en: For Internet Explorer, you can enable WebGL support by installing the Chrome
    Frame plugin [http://www.google.com/chromeframe](http://www.google.com/chromeframe).
    Google Chrome Frame replaces the rendering mechanism of Internet Explorer with
    Google Chrome's versions of the WebKit layout engine and V8 JavaScript engine.
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
  zh: 对于Internet Explorer，您可以通过安装Chrome Frame插件[http://www.google.com/chromeframe](http://www.google.com/chromeframe)来启用WebGL支持。Google
    Chrome Frame用Google Chrome的WebKit布局引擎和V8 JavaScript引擎的版本替换了Internet Explorer的渲染机制。
- en: Summary
  id: totrans-242
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: Although the canvas specification is still in development, we can apply its
    APIs for innumerable use cases in our enterprise applications. Charts, scientific
    visualization, diagrams, and animated wizards are merely the tip of the iceberg.
    As developers, we should always give ample consideration to fallbacks or alternative
    solutions in the event something is not supported to ensure proper cross-platform
    compatibility.
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管画布规范仍在开发中，我们仍然可以在我们的企业应用中应用其API，以应对无数的使用场景。图表、科学可视化、图表和动画向导只是冰山一角。作为开发者，我们应该始终充分考虑回退或替代方案，以防某些功能不受支持，以确保适当的跨平台兼容性。
- en: The next chapter will cover drag-and-drop capabilities and event delegation
    using HTML5.
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: 下一章将介绍使用HTML5的拖放功能和事件委托。
