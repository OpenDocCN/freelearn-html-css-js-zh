<html><head></head><body><div class="chapter" title="Chapter&#xA0;1.&#xA0;Data Structure"><div class="titlepage"><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Data Structure</h1></div></div></div><p>This book will take you step-by-step through the process of building a clear and user-friendly sales management database in Ext JS using information from an existing database.</p><p>This book is intended for intermediate Ext JS developers with operational knowledge of MySQL and who want to improve their programming skills and create a higher-level application.</p><p>The finished application will give you a working sales management database. However, the true value of this book is the hands-on process of creating the application, and the opportunity to easily transfer and incorporate features introduced in this book in your own future applications.</p><p>The standout features<a id="id0" class="indexterm"/> we will look at while building this application are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>History-supported back button functionality</strong></span>: We will customize the Ext JS function to create a lighter method to scroll forwards and backwards while staying on a single page.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>More efficient screen management</strong></span>: We'll learn how simply registering a screen and naming conventions can help you cut down on the screen change processes; meaning you can focus more on the implementation behind each screen. Also, it will be easier to interact with the history just by conforming to this architecture.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Communication methods with Ext.Direct</strong></span>: Ext.Direct<a id="id1" class="indexterm"/> has a close affinity with Ext applications which makes for easier connection, easier maintenance, and removes the need for the client side to change the URL. Also, if you use Ext.Direct, you can reduce the stress on the server side as it combines multiple server requests into just one request.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Data display methods with charts</strong></span>: In Ext JS, by simply adjusting the store and the data structure set to display in a grid, we can display the data graphically in a chart.</li></ul></div><p>This chapter will give you the basic building blocks of your database. In this chapter of the book, you will write the SQL code and and create tables in MySQL.</p><div class="section" title="The structure of the application – User, Customer, Quotation, Quotations, Bill, and Bills"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec08"/>The structure of the application – User, Customer, Quotation, Quotations, Bill, and Bills</h1></div></div></div><p>First, let's look<a id="id2" class="indexterm"/> at the structure of the application we're about to build. This is a sales management application built for the user to register customers, send quotations for orders, and finally to invoice the customer with a bill.</p><p>The user can input data in to the <code class="literal">Customer</code> table. The customer can be an individual or a company, either way, each customer receives a unique ID.</p><p>The <code class="literal">Quotation</code> table represents the final quotation sent to the customer. The <code class="literal">Quotations</code> table contains the individual items being ordered in the quotation.</p><p>A bill is the final invoice sent to the customer. As with the <code class="literal">Quotations</code> table, the <code class="literal">Bills</code> table refers to the individual items ordered by the customer.</p></div></div>
<div class="section" title="The user"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec09"/>The user</h1></div></div></div><p>The<a id="id3" class="indexterm"/> user data<a id="id4" class="indexterm"/> is a simple structure that is used to log in to a system. It has an e-mail address, a password, and a name.</p><p>Do not delete the user data and physically manage it with a flag. It is connected to other data structures with joint ownership, recording the date and time when it was created along with the updated date and time.</p><p>When we design a table with a model of MySQL, it looks similar to the following table. After having carried out MD5, we perform SHA1. Then, we will have 40 characters and can store the password.</p><div class="mediaobject"><img src="graphics/5446OS_01_01.jpg" alt="The user"/></div></div>
<div class="section" title="The customer"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec10"/>The customer</h1></div></div></div><p>The <a id="id5" class="indexterm"/>customer data <a id="id6" class="indexterm"/>contains the name and address of the company or client. It lets the <code class="literal">Quotation</code> and <code class="literal">Bill</code> tables perform a relation of this data and use the data. Being the master data, adding to and deleting from the user interface is not available at this time. However, as you develop the application, you eventually should be able to edit this data.</p><p>The following screenshot shows the input fields for registering a customer. The sections under the <code class="literal">Name</code> column are the fields that need to be filled in for each customer. The <code class="literal">Type</code> column refers to the type of data to be entered, such as words, numbers, and dates. The <code class="literal">Key</code> column allows data to be referenced between different tables.</p><div class="mediaobject"><img src="graphics/5446OS_01_02.jpg" alt="The customer"/></div></div>
<div class="section" title="Quotation and Quotations"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec11"/>Quotation and Quotations</h1></div></div></div><p>The <code class="literal">Quotation</code> and <code class="literal">Quotations</code> tables have a 1-N relationship.</p><p>In <code class="literal">Quotation</code><a id="id7" class="indexterm"/>, you can save the basic information of the document, and in <code class="literal">Quotations</code> you can store each item being ordered.</p><div class="section" title="Quotation"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec06"/>Quotation</h2></div></div></div><p>This following screenshot<a id="id8" class="indexterm"/> shows the fields necessary for <code class="literal">Quotation</code>. The table headings are the same as in the <code class="literal">Customer</code> table explained previously, so let's fill this out accordingly.</p><div class="mediaobject"><img src="graphics/5446OS_01_03.jpg" alt="Quotation"/></div></div><div class="section" title="Quotations"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec07"/>Quotations</h2></div></div></div><p>This is<a id="id9" class="indexterm"/> the <a id="id10" class="indexterm"/>same as before, so let's go ahead and fill this out. The parent refers to the overall quotation that the <code class="literal">Quotations</code> (individual items) table belongs to.</p><div class="mediaobject"><img src="graphics/5446OS_01_04.jpg" alt="Quotations"/></div></div></div>
<div class="section" title="Bill and Bills"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec12"/>Bill and Bills</h1></div></div></div><p>The <code class="literal">Bill</code> table<a id="id11" class="indexterm"/> is almost the same as the <code class="literal">Quotation</code> table. However, the <code class="literal">Bill</code> table can sometimes contain the ID of an associated <code class="literal">Quotation</code> table.</p><div class="section" title="Bill"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec08"/>Bill</h2></div></div></div><p>The following screenshot shows the <a id="id12" class="indexterm"/>
<code class="literal">Bill</code> table:</p><div class="mediaobject"><img src="graphics/5446OS_01_05.jpg" alt="Bill"/></div></div><div class="section" title="Bills"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec09"/>Bills</h2></div></div></div><p>Similar to <a id="id13" class="indexterm"/>
<code class="literal">Quotations</code>, in <code class="literal">Bills</code><a id="id14" class="indexterm"/> you can store each item that is ordered:</p><div class="mediaobject"><img src="graphics/5446OS_01_06.jpg" alt="Bills"/></div></div></div>
<div class="section" title="Creating and dealing with the customer structure tables"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec13"/>Creating and dealing with the customer structure tables</h1></div></div></div><p>We will be using <a id="id15" class="indexterm"/>MySQL, and the database character is set to <code class="literal">utf8</code> and collation is set to <code class="literal">utf8_bin</code>. When SQL describes the details of what we defined previously, each of these components are as follows.</p><div class="section" title="The User table"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec10"/>The User table</h2></div></div></div><p>The <a id="id16" class="indexterm"/>
<code class="literal">User</code> table <a id="id17" class="indexterm"/>we prepared earlier becomes operational when the following code is executed. It's important to remember to include <code class="literal">AUTO_INCREMENT</code> in the <code class="literal">id</code> column; otherwise, you have to input it manually:</p><div class="informalexample"><pre class="programlisting">SET NAMES utf8;
SET FOREIGN_KEY_CHECKS = 0;

DROP TABLE IF EXISTS 'users';
CREATE TABLE 'users' (
  'id' bigint(20) NOT NULL AUTO_INCREMENT,
  'status' tinyint(1) NOT NULL DEFAULT '1',
  'email' varchar(255) NOT NULL,
  'passwd' char(40) NOT NULL,
  'lastname' varchar(20) NOT NULL,
  'firstname' varchar(20) NOT NULL,
  'modified' datetime DEFAULT NULL,
  'created' datetime NOT NULL,
  PRIMARY KEY ('id')
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC;

SET FOREIGN_KEY_CHECKS = 1;</pre></div></div><div class="section" title="The Customer table"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec11"/>The Customer table</h2></div></div></div><p>Once the <a id="id18" class="indexterm"/>following code is <a id="id19" class="indexterm"/>executed, the <code class="literal">Customer</code> table becomes operational:</p><div class="informalexample"><pre class="programlisting">SET NAMES utf8;
SET FOREIGN_KEY_CHECKS = 0;

DROP TABLE IF EXISTS 'customers';
CREATE TABLE 'customers' (
  'id' bigint(20) NOT NULL AUTO_INCREMENT,
  'status' tinyint(1) NOT NULL DEFAULT '1',
  'name' varchar(255) NOT NULL,
  'addr1' varchar(255) NOT NULL,
  'addr2' varchar(255) DEFAULT NULL,
  'city' varchar(50) NOT NULL,
  'state' varchar(50) NOT NULL,
  'zip' varchar(10) NOT NULL,
  'country' varchar(50) NOT NULL,
  'phone' varchar(50) NOT NULL,
  'fax' varchar(50) DEFAULT NULL,
  'modified' datetime DEFAULT NULL,
  'created' datetime NOT NULL,
  PRIMARY KEY ('id')
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC;

SET FOREIGN_KEY_CHECKS = 1;</pre></div><p>This is the foundation of creating an initial set of tables that can later be populated with data.</p></div><div class="section" title="The Quotation table"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec12"/>The Quotation table</h2></div></div></div><p>This is the <a id="id20" class="indexterm"/>corresponding code for the <a id="id21" class="indexterm"/>
<code class="literal">Quotation</code> table. As with the <code class="literal">Customer</code> table, this code snippet will lay the foundation of our table.</p><div class="informalexample"><pre class="programlisting">SET NAMES utf8;
SET FOREIGN_KEY_CHECKS = 0;

DROP TABLE IF EXISTS 'quotation';
CREATE TABLE 'quotation' (
  'id' bigint(20) NOT NULL AUTO_INCREMENT,
  'status' tinyint(1) NOT NULL DEFAULT '1',
  'customer' bigint(20) NOT NULL,
  'note' text NOT NULL,
  'modified' datetime DEFAULT NULL,
  'created' datetime NOT NULL,
  PRIMARY KEY ('id')
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC;

DROP TABLE IF EXISTS 'quotations';
CREATE TABLE 'quotations' (
  'id' bigint(20) NOT NULL AUTO_INCREMENT,
  'status' tinyint(1) NOT NULL DEFAULT '1',
  'parent' bigint(20) NOT NULL,
  'description' varchar(255) NOT NULL,
  'qty' int(11) NOT NULL,
  'price' int(11) NOT NULL,
  'sum' int(11) NOT NULL,
  'modified' datetime DEFAULT NULL,
  'created' datetime NOT NULL,
  PRIMARY KEY ('id'),
  KEY 'parent' ('parent')
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC;

SET FOREIGN_KEY_CHECKS = 1;</pre></div></div><div class="section" title="The Bill table"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec13"/>The Bill table</h2></div></div></div><p>As<a id="id22" class="indexterm"/> with<a id="id23" class="indexterm"/> the previous two code snippets, the following code for the <code class="literal">Bill</code> table is very similar to the <code class="literal">Quotation</code> table, so this can be found in the source file under <code class="literal">04_bill_table.sql</code>.</p><p>These are all the tables we need for this database. Now let's move on to testing after creating each operation.</p></div></div>
<div class="section" title="Creating each operation and testing"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec14"/>Creating each operation and testing</h1></div></div></div><p>Because we<a id="id24" class="indexterm"/> will<a id="id25" class="indexterm"/> use PHP in later stages, let's prepare each operation now. Here, we will insert some temporary data.</p><p>Remember to check that the acquisition and update operations are working properly.</p><div class="section" title="User authentication"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec14"/>User authentication</h2></div></div></div><p>These <a id="id26" class="indexterm"/>are some SQL code you can use to develop your database.</p><p>You can look for a user by inputting an e-mail address and password. You can assume it was successful if the count is <code class="literal">1</code>.</p><p>For increased password security, after having carried out MD5 encryption, you should store the password as a character string of 40 characters after being put through SHA1.</p><div class="informalexample"><pre class="programlisting">SELECT
    COUNT(id) as auth
FROM
    users
WHERE
    users.email = 'extkazuhiro@xenophy.com'
AND
    users.passwd = SHA1(MD5('password'))
AND
    users.status = 1;</pre></div></div><div class="section" title="Selecting the user list"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec15"/>Selecting the user list</h2></div></div></div><p>This is <a id="id27" class="indexterm"/>used when you want to collect data for use in a grid. Make note of the fact that we are not performing the limit operation with <code class="literal">PagingToolbar</code>:</p><div class="informalexample"><pre class="programlisting">SELECT
    users.id,
    users.email,
    users.lastname,
    users.firstname
FROM
    users
WHERE
    users.status = 1;</pre></div></div><div class="section" title="Adding users"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec16"/>Adding users</h2></div></div></div><p>To add a<a id="id28" class="indexterm"/> user, put the current time in <code class="literal">created</code> and <code class="literal">modified</code>:</p><div class="informalexample"><pre class="programlisting">INSERT INTO users (
    email,
    passwd,
    lastname,
    firstname,
    modified,
    created
) VALUES (
    'someone@xenophy.com',
    SHA1(MD5('password')),
    'Kotsutsumi',
    'Kazuhiro',
    NOW(),
    NOW()
);</pre></div></div><div class="section" title="Updating the user information"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec17"/>Updating the user information</h2></div></div></div><p>Every time<a id="id29" class="indexterm"/> the <code class="literal">modified</code> file should be set to <code class="literal">NOW()</code> for it to be used as a time stamp. Other fields should be updated as needed.</p><div class="informalexample"><pre class="programlisting">UPDATE
    users
SET
    email='extkazuhiro@xenophy.com',
    passwd=SHA1(MD5('password')),
    lastname='Kotsutsumi',
    firstname='Kazuhiro',
    modified=NOW()
WHERE
    id=1</pre></div></div><div class="section" title="Deleting users"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec18"/>Deleting users</h2></div></div></div><p>Deletion<a id="id30" class="indexterm"/> from this system is not a hard purge where the user data is permanently deleted. Instead we will use a soft purge, where the user data is not displayed after deletion but remains in the system. Therefore, note that we will use <code class="literal">UPDATE</code>, not <code class="literal">DELETE</code>. In the following code, <code class="literal">status=9</code> denotes that the user has been deleted but not displayed. (<code class="literal">status=1</code> will denote that the user is active).</p><div class="informalexample"><pre class="programlisting">UPDATE
    users
SET
    status=9
WHERE
    id=1</pre></div></div></div>
<div class="section" title="The Customers table"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec15"/>The Customers table</h1></div></div></div><p>Although <a id="id31" class="indexterm"/>
<code class="literal">Add</code>, <code class="literal">Update</code>, and <code class="literal">Delete</code> are <a id="id32" class="indexterm"/>necessary operations, we'll come to these in the later chapter, so we can leave it out at this time.</p><div class="section" title="The customer information list"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec19"/>The customer information list</h2></div></div></div><p>Here we are<a id="id33" class="indexterm"/> preparing the SQL code to pull information about customers later on:</p><div class="informalexample"><pre class="programlisting">SELECT
    customers.id,
    customers.name,
    customers.addr1,
    customers.addr2,
    customers.city,
    customers.state,
    customers.zip,
    customers.country,
    customers.phone,
    customers.fax
FROM
    customers
WHERE
    customers.status = 1;</pre></div></div><div class="section" title="Selecting the quotation list"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec20"/>Selecting the quotation list</h2></div></div></div><p>Next <a id="id34" class="indexterm"/>comes the code for selecting the <code class="literal">Quotation</code> lists. This is similar to what we saw for the customer information list. For the code, please refer to the source file under <code class="literal">11_s</code>
<code class="literal">electing_quotation_list.sql</code>.</p></div><div class="section" title="Items"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec21"/>Items</h2></div></div></div><p>The<a id="id35" class="indexterm"/> code for items will select the quotation items from the database. This will pick up items where <code class="literal">quotations.status</code> is <code class="literal">1</code> and <code class="literal">quotation.parent</code> is <code class="literal">1</code>:</p><div class="informalexample"><pre class="programlisting">SELECT quotations.description, 
  quotations.qty, 
  quotations.price, 
  quotations.sum
FROM
  quotations
WHERE
  quotations.'status' = 1
AND
  quotations.parent = 1</pre></div><p>As this is similar to <code class="literal">Customers</code>, you can again leave out <code class="literal">Add</code>, <code class="literal">Update</code>, and <code class="literal">Delete</code> for now.</p></div></div>
<div class="section" title="The Bill table"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec16"/>The Bill table</h1></div></div></div><p>Again <a id="id36" class="indexterm"/>let's <a id="id37" class="indexterm"/>leave out <code class="literal">Add</code>, <code class="literal">Update</code> and <code class="literal">Delete</code> for now because the <code class="literal">Bill</code> table is similar to what preceded this.</p><p>It's straightforward to say that once a quotation has been accepted, a bill is produced. Therefore, in data structures such as ours, <code class="literal">Quotation</code> and <code class="literal">Bill</code> are related. The only difference is that <code class="literal">Bill</code> contains the extra <code class="literal">Quotation</code> ID to create the relationship between the two.</p><p>Also, remember the customer information list is almost the same as the quotation list.</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec17"/>Summary</h1></div></div></div><p>In this chapter, we have defined the structure of the database we will use in this book.</p><p>You might have your own databases that you want to present in Ext JS. This is just a sample database that we can build on in the coming chapters.</p><p>In the next chapter we will begin the process of building the whole application. Don't worry, we'll explain each step.</p></div></body></html>