<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;3.&#xA0;Front-end Patterns"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03" class="calibre1"/>Chapter 3. Front-end Patterns</h1></div></div></div><p class="calibre7">This chapter will cover a useful set of patterns that will speed up your frontend workflow. Meteor makes it easy to build rich frontend experiences, but we have to be careful with the number of computations our interface requires to function. Too many computations will slow down mobile devices. In this chapter, we are going to learn how to keep our computations short, DOM simple, and animations effective. You will learn the following topics:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Responsive design</li><li class="listitem">Super helpers</li><li class="listitem">Variable types</li><li class="listitem">Quick forms</li><li class="listitem">Loading</li><li class="listitem">Animations</li><li class="listitem">Search engine optimization</li></ul></div></div>

<div class="book" title="Chapter&#xA0;3.&#xA0;Front-end Patterns">
<div class="book" title="Responsive design"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch03lvl1sec21" class="calibre1"/>Responsive design</h1></div></div></div><p class="calibre7">An application is always judged<a id="id127" class="calibre1"/> by how it looks. Now that we know how to make it perform, we need to learn how to make it look good. Nowadays, it is common practice to build the frontend while keeping the following two things in mind:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre2">Minimalism</strong></span>: This <a id="id128" class="calibre1"/>style of design makes your site concise by exposing only the necessary elements to have the site functioning. Less is more.</li><li class="listitem"><span class="strong"><strong class="calibre2">Responsive</strong></span>: This <a id="id129" class="calibre1"/>style of programming makes your site usable everywhere, no matter how big the screen is. The HTML markup will always adapt depending on the width of the screen.</li></ul></div><p class="calibre7">Here, we are only going to cover how to program a responsive frontend because minimalism is a vast and highly debatable topic.</p></div></div>

<div class="book" title="Chapter&#xA0;3.&#xA0;Front-end Patterns">
<div class="book" title="Responsive design">
<div class="book" title="General settings"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch03lvl2sec37" class="calibre1"/>General settings</h2></div></div></div><p class="calibre7">The first layer of<a id="id130" class="calibre1"/> customization begins with the <code class="email">kyleking:customizable-bootstrap-stylus</code> package that we have already installed. Follow these steps to set this up:</p><p class="calibre7">Create the following directory:</p><p class="calibre7">
<code class="email">/_globals/client/bootstrap/custom.bootstrap.json</code>.</p><p class="calibre7">(Leave the JSON file empty.)</p><p class="calibre7">Run the Meteor project using this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">meteor</strong></span>
</pre></div><p class="calibre7">You will notice three new files have been added. These files will compile at runtime to produce your version of Twitter Bootstrap.</p><p class="calibre7">Open <code class="email">/_globals/client/bootstrap/custom.bootstrap.json</code>, and make sure that all variables are set to <code class="email">true</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">{"_route":"/_globals/client/bootstrap/custom.bootstrap.json"},</strong></span>
{
  "modules" : {
    "variables": true,
    "mixins": true,

    "normalize": true,
    "print": true,
    "glyphicons": true,

    "scaffolding": true,
    "utilities": true,
    "type": true,
    "code": true,
    "grid": true,
    "tables": true,
    "forms": true,
    "buttons": true,

    "component-animations": true,
    "dropdowns": true,
    "button-groups": true,
    "input-groups": true,
    "navs": true,
    "navbar": true,
    "breadcrumbs": true,
    "pagination": true,
    "pager": true,
    "labels": true,
    "badges": true,
    "jumbotron": true,
    "thumbnails": true,
    "alerts": true,
    "progress-bars": true,
    "media": true,
    "list-group": true,
    "panels": true,
    "responsive-embed": true,
    "wells": true,
    "close": true,

    "modals": true,
    "tooltip": true,
    "popovers": true,
    "carousel": true,

    "responsive-utilities": true
  }
}</pre></div><p class="calibre7">By setting all the variables to <code class="email">true</code>, we are reeling in all the functionality that <code class="email">bootstrap</code> has. If there is anything you do not want to use from the framework, you can deactivate it by setting it to <code class="email">false</code> in this file.</p><p class="calibre7">You will need to<a id="id131" class="calibre1"/> manually restart Meteor for these changes to take effect. So press <span class="strong"><em class="calibre11">Ctrl</em></span> + <span class="strong"><em class="calibre11">C</em></span> on your terminal to stop Meteor and run the <code class="email">meteor</code> command again.</p><p class="calibre7">Now we can edit <code class="email">bootstrap</code>. Start by opening the <code class="email">/_globals/client/bootstrap/custom.bootstrap.import.styl</code> directory. Here, you are going to find a library of the Stylus variables that we can play with.</p><p class="calibre7">Let's remove rounded corners and modify button border colors:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">// /_globals/client/bootstrap/custom.bootstrap.import.styl</strong></span>

...

// Line #114
$border-radius-base ?=       0px
$border-radius-large ?=      0px
$border-radius-small ?=      0px
...

// Line #156
$btn-default-color ?=            #333
$btn-default-bg ?=               #fff
$btn-default-border ?=           $btn-default-color

$btn-primary-color ?=            #fff
$btn-primary-bg ?=               $brand-primary
$btn-primary-border ?=           $btn-primary-bg

$btn-success-color ?=            #fff
$btn-success-bg ?=               $brand-success
$btn-success-border ?=           $btn-success-bg

$btn-info-color ?=               #fff
$btn-info-bg ?=                  $brand-info
$btn-info-border ?=              $btn-info-bg

$btn-warning-color ?=            #fff
$btn-warning-bg ?=               $brand-warning
$btn-warning-border ?=           $btn-warning-bg

$btn-danger-color ?=             #fff
$btn-danger-bg ?=                $brand-danger
$btn-danger-border ?=            $btn-danger-bg</pre></div><p class="calibre7">What if we need to<a id="id132" class="calibre1"/> use bootstrap mixins and variables for custom style sheets? We can use the <code class="email">@import</code> command whenever we need to gain access to everything:</p><div class="informalexample"><pre class="programlisting">@import "_globals/bootstrap/client/custom.bootstrap.import.styl"</pre></div><p class="calibre7">Let's customize our products page by adding a large promoter. Rewrite the products template with a new <code class="email">#promoter</code> header:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">//- /products/client/products.jade</strong></span>

template(name="products")
  div#products.template
    header#promoter
      h3 Your Brand</pre></div><p class="calibre7">Before we write our product styles, let's create a global style sheet for any application-wide styling at <code class="email">/_globals/client/main.styl</code>. Here, we are going to make sure that our initial views are set correctly so that we may properly make use of relative units:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">// /_globals/client/main.styl</strong></span>

html, body, #__flow-root, #__flow-root &gt; .template
html, body, body &gt; .template
    height:100%</pre></div><p class="calibre7">With this set of rules, we are basically making sure that everything has the height of the viewport including our first <code class="email">.template</code> DOM element. This technique allows us to have relative percentage heights work as expected.</p><p class="calibre7">We also need to set the root DOM element for BlazeLayout. Let's do this in a client/server configuration file:</p><div class="informalexample"><pre class="programlisting"># /_globals/router/config.coffee

if Meteor.isClient
  BlazeLayout.setRoot 'body'</pre></div><p class="calibre7">Now, create the directory for the <code class="email">products</code> styles: <code class="email">/products/client/products.styl</code>. We will start by importing our variables into the file and setting some simple rules to make the promoter look good:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">// products/client/products.styl</strong></span>
@import "_globals/bootstrap/custom.bootstrap.import.styl"

#products
  #promoter
    background: $brand-primary
    height: 80%</pre></div><p class="calibre7">Great, this sets <a id="id133" class="calibre1"/>up our <code class="email">promoter</code> section for any promotional images that we may want to add, and the site looks decent (but not good enough yet) on mobile.</p></div></div></div>

<div class="book" title="Chapter&#xA0;3.&#xA0;Front-end Patterns">
<div class="book" title="Responsive design">
<div class="book" title="Bootstrap"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch03lvl2sec38" class="calibre1"/>Bootstrap</h2></div></div></div><p class="calibre7">Bootstrap<a id="id134" class="calibre1"/> is a library of CSS rules that makes development of simple layouts quick, thanks to the library of classes that it includes.</p><p class="calibre7">Let's extend our products template to upgrade our <code class="email">#promoter</code> header and add a <code class="email">#features</code> section. We will use bootstrap to manage the grid in this case:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">//- /products/client/products.jade</strong></span>

template(name="products")
  div#products.template
    header#promoter
      div.container
        div.row
          div.col-xs-12
            h3 Your Brand

    section#features
      div.container
        div.row
          div.col-xs-12.col-sm-4
            h3.text-center
              span.fa-stack.fa-lg
                i.fa.fa-square.fa-stack-2x.text-primary
                i.fa.fa-users.fa-inverse.fa-stack-1x
            h5.text-center 24 Hour Support

          div.col-xs-12.col-sm-4
            h3.text-center
              span.fa-stack.fa-lg
                i.fa.fa-square.fa-stack-2x.text-primary
                i.fa.fa-truck.fa-inverse.fa-stack-1x
            h5.text-center Next Day Delivery

          div.col-xs-12.col-sm-4
            h3.text-center
              span.fa-stack.fa-lg
                i.fa.fa-square.fa-stack-2x.text-primary
                i.fa.fa-bomb.fa-inverse.fa-stack-1x
            h5.text-center Mind Blown Guarantee</pre></div><p class="calibre7">We are doing quite a few things here but nothing complex. First, we wrapped the contents of our <code class="email">#promoter</code> header in bootstraps' grid. Bootstrap grids work only as advertised when they are under a <code class="email">row</code> class. The <code class="email">container</code> class controls our page-wide breakpoints.</p><p class="calibre7">Bootstrap<a id="id135" class="calibre1"/> columns are set using the <code class="email">col-</code> class prefix followed by the target screen size, then an optional offset indicator, and finally, the number of columns that the element will span or offset:</p><div class="informalexample"><pre class="programlisting">div.col-&lt;screen size&gt;-&lt;optional offset&gt;-&lt;number of columns&gt;</pre></div><div class="informalexample"><table border="1" class="calibre12"><colgroup class="calibre13"><col class="calibre14"/><col class="calibre14"/><col class="calibre14"/></colgroup><thead class="calibre15"><tr class="calibre16"><th valign="bottom" class="calibre17">
<p class="calibre18">Class</p>
</th><th valign="bottom" class="calibre17">
<p class="calibre18">Breakpoint</p>
</th><th valign="bottom" class="calibre17">
<p class="calibre18">Offset</p>
</th></tr></thead><tbody class="calibre19"><tr class="calibre16"><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">col-xs-*</code>
</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">&lt;768px</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">col-xs-offset-*</code>
</p>
</td></tr><tr class="calibre16"><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">col-sm-*</code>
</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">≥768px</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">col-sm-offset-*</code>
</p>
</td></tr><tr class="calibre16"><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">col-md-*</code>
</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">≥992px</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">col-md-offset-*</code>
</p>
</td></tr><tr class="calibre16"><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">col-lg-*</code>
</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">≥1200px</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">col-lg-offset-*</code>
</p>
</td></tr></tbody></table></div><p class="calibre7">Bootstrap has a total of 12 columns (this can be modified in our <code class="email">variables</code> file); each column supports offsetting and nesting too. Remember, the smallest screen size will override all other screen sizes if the other screen sizes are not defined. So, if you want three columns of every size, you will only need to define it for the smallest size screen. In this example, we are separating our <code class="email">#features</code> section into three columns of every size above 768 px and treating this as a single column in anything below 768 px.</p><p class="calibre7">If at any point you need to nest bootstrap columns, then you will need to place these new columns under a <code class="email">row</code> class. The following example centers a six-column long <code class="email">div</code> inside another six-column long <code class="email">div</code>:</p><div class="informalexample"><pre class="programlisting">div.row
  div.col-xs-6
  div.col-xs-6
    div.row
      div.col-xs-6.col-xs-offset-3</pre></div><p class="calibre7">We are <a id="id136" class="calibre1"/>using Font Awesome to create some icons for our <code class="email">#features</code> section as well. Here, we are using one of the Font Awesome's lesser known <a id="id137" class="calibre1"/>
<span class="strong"><strong class="calibre2">icon stacking</strong></span> feature. To use this feature, you only need to wrap a set of Font Awesome icons with a <code class="email">span.fa-stack</code> element.</p><p class="calibre7">Font Awesome has a list of about 500 icons. If you want to use a different set of icons, feel free to check out the list of icons online at <a class="calibre1" href="http://fortawesome.github.io/Font-Awesome/icons">http://fortawesome.github.io/Font-Awesome/icons</a>.</p><p class="calibre7">Now let's add a little bit of Jeet and Rupture to our frontend.</p></div></div></div>

<div class="book" title="Chapter&#xA0;3.&#xA0;Front-end Patterns">
<div class="book" title="Responsive design">
<div class="book" title="Jeet grid systems with Rupture"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch03lvl2sec39" class="calibre1"/>Jeet grid systems with Rupture</h2></div></div></div><p class="calibre7">The version of Stylus that we<a id="id138" class="calibre1"/> have installed (<code class="email">mquandalle:stylus</code>) comes packaged with a lot of useful mixins, the most notable ones being <span class="strong"><strong class="calibre2">Jeet</strong></span> <a id="id139" class="calibre1"/>and <a id="id140" class="calibre1"/>
<span class="strong"><strong class="calibre2">Rupture</strong></span>. Jeet is a grid system that is superior to Twitter Bootstrap because it is more flexible, and Rupture is a set of functions that simplifies media queries. Knowing how to leverage both Jeet and Twitter Bootstrap will increase the quality of your frontend designs.</p><p class="calibre7">Let's patch up our <code class="email">#promoter</code> header to make our page more user friendly for users that are in landscape mode on smaller devices:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">// products/client/products.styl</strong></span>
@import "_globals/client/bootstrap/custom.bootstrap.import.styl"
@import "jeet" // Add jeet

#products
  #promoter
    background: $brand-primary
    height: 80%

    +below($screen-sm-min) // If the screen width is smaller than -sm
      +portrait() // And the device is in portrait mode
        height: 30%

      +landscape() // And the device is in landscape mode
        col(1/3)
        height: 100%

  #features
    +below($screen-sm-min) // If the screen width is smaller than -sm
      +landscape() // And the device is in landscape mode
        col(2/3)
        height: 100%

        .container
          width:100% // Override bootstrap container</pre></div><p class="calibre7">Rupture adds several <a id="id141" class="calibre1"/>mixins to easily control the <code class="email">@media</code> queries: <code class="email">below</code>, <code class="email">above</code>, <code class="email">between</code>, <code class="email">landscape</code>, <code class="email">portrait</code> and many more. You will find yourself using <code class="email">below</code>, <code class="email">landscape</code>, and <code class="email">portrait</code> more often than the rest. To use these mixins in Stylus, we simply prefix a plus sign (<code class="email">+</code>) before the command.</p><p class="calibre7">In this example, we are using <code class="email">+below($screen-sm-min)</code> to define the CSS rules for all the devices whose widths are below bootstrap's <code class="email">-sm</code> breakpoint. Then we will use <code class="email">+portrait()</code> and <code class="email">+landscape()</code> to define CSS rules for portrait and landscape modes.</p><p class="calibre7">Next, we will use Jeet to control master columns using the <code class="email">col()</code> mixin. This mixin takes in a fraction that defines the width of the element as a fraction. Consider the numerator as the number of columns that you want the element to take up and the denominator as the total number of columns:</p><div class="informalexample"><pre class="programlisting">col(&lt;column width&gt;/&lt;number of columns&gt;)</pre></div><p class="calibre7">In this example, when we switch to landscape mode on a small device, our <code class="email">#promoter</code> header is one column wide out of three, while our <code class="email">#features</code> section is two columns wide out of three.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Super helpers"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03lvl1sec22" class="calibre1"/>Super helpers</h1></div></div></div><p class="calibre7">In Meteor, you will quickly find yourself<a id="id142" class="calibre1"/> repeating helpers among templates for simple things such as formatting. We can prevent repetition by creating a global dictionary of functions—this is what we call a super helper. To do this, we are going to tap into Meteor's rendering engine—Blaze.</p><p class="calibre7">It is important to understand that Blaze is deeply integrated with Spacebars, and Spacebars is Meteor's updated version of HandlebarsJS. HandlebarsJS is a JavaScript templating engine that enables the use of helpers and components on the frontend using <code class="email">{{}}</code>. This legacy means that Spacebars has a lot of the HandlebarsJS functionality. So, much of the documentation found in HandlebarsJS applies to Meteor helpers as well.</p></div>

<div class="book" title="Super helpers">
<div class="book" title="Defining a Blaze helper"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch03lvl2sec40" class="calibre1"/>Defining a Blaze helper</h2></div></div></div><p class="calibre7">Meteor exposes the<a id="id143" class="calibre1"/> <code class="email">Template.registerHelper</code> function to create global helpers. Let's<a id="id144" class="calibre1"/> create something to help us format money:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /_globals/client/formatters.coffee</strong></span>

Template.registerHelper "format_money", (value) -&gt;
  if _.isNumber value
    "$#{(value / 100).toFixed(2)}"</pre></div><p class="calibre7">As you can see, the syntax for a global helper is exactly the same as it would be for a template helper. Now, we can use this helper in any template. Let's create a product template under our <code class="email">/products</code> directory for our <code class="email">products</code> template and try it out here:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">//- /products/client/product.jade</strong></span>

template(name="product")
  div.col-xs-12.col-sm-4.col-md-3
    article#product
      h5 {{name}}

      div.offer
        span.price {{format_money price}}</pre></div><p class="calibre7">We will need to patch our products template as well:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">//- /products/client/products.jade</strong></span>

template(name="products")
  div#products.template
    header#promoter
      ...
    section#features
      ...

    br
    section#featured_products
      div.container
        div.row
          each products
            +product</pre></div><p class="calibre7">Let's add some<a id="id145" class="calibre1"/> temporary entries to our products collection. We will use<a id="id146" class="calibre1"/> these entries throughout the rest of the chapter:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">@Products = new Mongo.Collection "products"</strong></span>

if Meteor.isServer
  if Products.find().count() is 0
    Products.insert
      name:"Nuka Cola"
      price: 1099

    Products.insert
      name:"1up Soda"
      price: 999

    Products.insert
      name:"JuggerNog"
      price: 899

<span class="strong"><strong class="calibre2"># /products/client/products.coffee</strong></span>

Template.created "products", -&gt;
  ...

Template.products.helpers
  products: -&gt;
    Products.find()</pre></div><p class="calibre7">Note that in this data schema we are defining <code class="email">price</code> in cents. This is a common practice when dealing with money in JavaScript to avoid arithmetic floating point issues. What does this mean? Go to your web browser's console, and run the following operation: <code class="email">0.1 + 0.2</code>. Oddly enough, JavaScript does not respond with <code class="email">0.3</code>; it responds with <code class="email">0.3000000000004</code> instead. The reason for this is JavaScript's internal 64-bit floating point representation of decimal numbers. This means that JavaScript does not fully understand what a decimal number is. This is why, we do not use decimal numbers when we deal with <a id="id147" class="calibre1"/>money, we <a id="id148" class="calibre1"/>just use the smallest available denomination.</p></div></div>

<div class="book" title="Super helpers">
<div class="book" title="Making a global dictionary"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch03lvl2sec41" class="calibre1"/>Making a global dictionary</h2></div></div></div><p class="calibre7">Wait, we can still make this<a id="id149" class="calibre1"/> formatter more widely available in our <a id="id150" class="calibre1"/>application. Let's turn this into a dictionary and share it with our controllers. In other words, we want to be able to use a helper such as <code class="email">{{format.money amount}}</code> and use this in our CoffeeScript in the form of <code class="email">format.money amount</code> as well:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /_globals/client/formatters.coffee</strong></span>

@format =
  money: (value) -&gt;
    if _.isNumber value
      "$#{(value / 100).toFixed(2)}"

Template.registerHelper "format", -&gt;
  format</pre></div><p class="calibre7">First, we create an object that holds our definitions, and we make it global using <code class="email">@</code> (which is equal to <code class="email">this</code>). Then we place this object of definitions inside a global helper. Simple! Now we know how to build a super helper that we can use anywhere. To test this, type <code class="email">format.money(1099)</code> in your browser's console; this should return <span class="strong"><strong class="calibre2">"$10.99"</strong></span>.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Variable types"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03lvl1sec23" class="calibre1"/>Variable types</h1></div></div></div><p class="calibre7">There are four types of variables that we <a id="id151" class="calibre1"/>need to understand to optimize our frontend workflow: <span class="strong"><strong class="calibre2">session</strong></span>, <span class="strong"><strong class="calibre2">persistent</strong></span>, <span class="strong"><strong class="calibre2">file scope</strong></span>, and <span class="strong"><strong class="calibre2">ReactiveVar</strong></span>. With these variables, we can build dynamic sites easily based on how the user is interacting with the view.</p><p class="calibre7">The session variables are variables that exist only during a session. A session begins whenever a user hits the site. These variables can be shared across routes and are reactive.</p><p class="calibre7">The persistent variables are variables that are stored in local storage so that they can be read even after the session closes.</p><p class="calibre7">The file scoped variables are variables that only exist within the scope of the file. These are generally not reactive.</p><p class="calibre7">The ReactiveVar variables can be scoped to the file or globally and are reactive. These variables do not persist the way session variables do.</p></div>

<div class="book" title="Variable types">
<div class="book" title="Session variables"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch03lvl2sec42" class="calibre1"/>Session variables</h2></div></div></div><p class="calibre7">Some Meteor <a id="id152" class="calibre1"/>developers believe that <a id="id153" class="calibre1"/>session variables are overused. This is definitely true, if you are not managing them. For the most part, session variables should be used to handle data that is shared across multiple routes in your application, have no place in your database, need reactivity, and persist through a hot code reload.</p><p class="calibre7">If you stop and think about it, not many things require all of these attributes. At first, you may rely on them heavily to control your frontend, but as your frontend becomes more minimal, you will realize there is no need for them.</p><p class="calibre7">Still, if you are going to use them, you should follow two rules to maintain them, as shown here:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Template-based taxonomy</li><li class="listitem">Clear them if you are not going to use them</li></ul></div><p class="calibre7">The taxonomy of session variables should always follow the <code class="email">&lt;template.variable&gt;</code> pattern to keep them from polluting each other. Suppose we want to control a global alert using session variables, the session variable would look like this:</p><div class="informalexample"><pre class="programlisting">Session.set "products.alert",true</pre></div><p class="calibre7">Once our user leaves the view, we should clear the session variable. The <code class="email">clear</code> function is added by the <code class="email">u2622:persistent-session</code> package that we installed in <a class="calibre1" title="Chapter 1. Getting Started with Meteor" href="part0014_split_000.html#page">Chapter 1</a>, <span class="strong"><em class="calibre11">Getting Started with Meteor</em></span>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># Clear "products.alert" variable after "products" template is destroyed</strong></span>
Template.destroyed "products", -&gt;
  Session.clear "products.alert"

<span class="strong"><strong class="calibre2"># Clear all variables after the "products" template is destroyed</strong></span>
Template.destroyed "products", -&gt;
  Session.clear()</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="tip04" class="calibre1"/>Tip</h3><p class="calibre7">Do not use session variables along with Meteor methods to obtain server data. While the method works, it makes your data vulnerable and easy to modify on the client.</p></div><p class="calibre7">Also, try to stay<a id="id154" class="calibre1"/> away from using session variables that are<a id="id155" class="calibre1"/> composed of complex objects with multiple keys or arrays. You will quickly find yourself using lesser lookup tools such as <code class="email">_.find</code> and <code class="email">_.findWhere</code> to use the data.</p></div></div>

<div class="book" title="Variable types">
<div class="book" title="Persistent variables"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch03lvl2sec43" class="calibre1"/>Persistent variables</h2></div></div></div><p class="calibre7">Persistent variables <a id="id156" class="calibre1"/>are session variables that persist through a session. In Meteor, a common<a id="id157" class="calibre1"/> session variable will reset if the user refreshes the page. Persistent variables leverage AmplifyJS, which in turn uses HTML5 local storage and fallbacks to store the variable inside the user's browser. These types of variables exist because of the <code class="email">u2622:persistent-session</code> package.</p><p class="calibre7">We can use this variable to keep track of our users' orders, in case they leave the site and are not logged in. So, if the user opens up an order and fills it with items, they can come back to it later without making a user account on our site.</p><p class="calibre7">Let's create an <code class="email">add-to-cart</code> button that will leverage the persistent variables:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /products/client/product.coffee</strong></span>

Template.product.events
  "click button.add-to-cart": (event) -&gt;
<span class="strong"><strong class="calibre2">    # Get the session variable</strong></span>
    order_id = Session.get "global.order"
    order = Orders.findOne order_id

<span class="strong"><strong class="calibre2">    # Insert Order if it doesn't exist</strong></span>
    unless order
      order_id = Orders.insert
        status:"new"
        total_products:0
        subtotal:0
        total:0
    else
      order_id = order._id

<span class="strong"><strong class="calibre2">    # Set the session variable for future reference</strong></span>
    Session.setPersistent "global.order",order_id

<span class="strong"><strong class="calibre2">    # Find the order</strong></span>
    order = Orders.findOne order_id

<span class="strong"><strong class="calibre2">    # Check for details on this product</strong></span>
    detail = OrderDetails.findOne
      product:@_id
      order:order._id

    if detail
<span class="strong"><strong class="calibre2">      # Increase by one if the details exist</strong></span>
      OrderDetails.update detail._id,
        $inc:
          quantity:1

      Orders.update order._id,
        $inc:
          total_products:1
          subtotal:@price
          total:@price
    else
<span class="strong"><strong class="calibre2">      # Insert if details do not exist</strong></span>
      OrderDetails.insert
        quantity:1
        product:@_id
        order:order._id

      Orders.update order._id,
        $inc:
          total_products:1
          subtotal:@price
          total:@price</pre></div><p class="calibre7">We will need to build a<a id="id158" class="calibre1"/> publisher for this to work, but we have to make a<a id="id159" class="calibre1"/> choice. As we have both <code class="email">products</code> and <code class="email">product</code> template, each one could subscribe to a publisher and pull in the same data. Should we subscribe from the <code class="email">product</code> or the <code class="email">products</code> template? Let's do both! Extending the products publisher will ensure that we get all the data that the template needs while the attached publisher will help us manage our "product details" page and promos when we need it to:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /products/server/products_pub.coffee</strong></span>
Meteor.publish "products", (ops={}) -&gt;
  ...

  if ops.order and not _.isEmpty ops.order
    @relations
      collection:Orders
      filter:
        _id:ops.order
        status:"new"
      mappings:[
        {
          collection:OrderDetails
          key:"order"
        }
      ]</pre></div><p class="calibre7">Then we wire up our subscriber with the order key on the client side:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /products/client/products.coffee</strong></span>

Template.created "products", -&gt;
  @autorun =&gt;
    ...

    order = Session.get "global.order"
    if order and not _.isEmpty order
      _.extend filter,
        order:order

    @subscribe "products", filter</pre></div><p class="calibre7">With this, now we can add products to an order, refresh the site, and still come back to our order. Let's finish <a id="id160" class="calibre1"/>building <a id="id161" class="calibre1"/>the publisher for the <code class="email">product</code> template:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /products/server/product_pub.coffee</strong></span>

Meteor.publish "product", (ops={}) -&gt;
  if ops.product and not _.isEmpty ops.product
    @relations
      collection:Products
      options:
        _id:ops.product
      mappings:[
        {
          key:"product"
          collection:ProductImages
        }
        {
          collection:ProductsTags
          key:"product"
          mappings: [
            {
              collection:Tags
              foreign_key:"tag"
            }
          ]
        }
      ]

    if ops.order and not _.isEmpty ops.order
      @relations
        collection:Orders
        filter:
          _id:ops.order
          status:"new"
        mappings:[
          {
            collection:OrderDetails
            key:"order"
            filter:
              product:ops.product
          }
        ]

  @ready()</pre></div><p class="calibre7">Notice that our <a id="id162" class="calibre1"/>product is bringing in only the data that is pertinent to that product <a id="id163" class="calibre1"/>and for that order. Now we can program our subscriber:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /products/client/product.coffee</strong></span>

Template.created "product", -&gt;
  @autorun =&gt;
    filter = {}

    # Get the product ID from the context
    product = @data._id
    _.extend filter,
      product:product

    # Get the order if any
    order = Session.get "global.order"
    if order and not _.isEmpty order
      _.extend filter,
        order:order

    @subscribe "product", filter

...</pre></div></div></div>

<div class="book" title="Variable types">
<div class="book" title="File scope variables"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch03lvl2sec44" class="calibre1"/>File scope variables</h2></div></div></div><p class="calibre7">These are the <a id="id164" class="calibre1"/>types of variables you will want <a id="id165" class="calibre1"/>to use most of the time. What are they? They are regular variables! This means that they are not reactive, so watch out. Regular variables are scoped for the file only, so you do not need to worry about interfering with the variables that are named the same in other files.</p><p class="calibre7">These variables are useful for things such as lists that you know will not change and that you will not need anywhere else in the application. To use one, simply type out a variable outside your <a id="id166" class="calibre1"/>Meteor-specific<a id="id167" class="calibre1"/> functions.</p></div></div>

<div class="book" title="Variable types">
<div class="book" title="The ReactiveVar variables"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch03lvl2sec45" class="calibre1"/>The ReactiveVar variables</h2></div></div></div><p class="calibre7">The ReactiveVar <a id="id168" class="calibre1"/>variables are reactive <a id="id169" class="calibre1"/>variables that are not available to the console in the way that session variables are. This makes them great for things that are reactive and that we want to keep relatively difficult to access for the user from the console.</p><p class="calibre7">If at any point you are creating a highly reactive interface, you should fill it up with these variables so that you do not have to worry about managing them. These variables cleared automatically if there is a hot code reload or a page refresh.</p><p class="calibre7">To create a reactive variable, you simply define a variable with its constructor:</p><div class="informalexample"><pre class="programlisting">reactive_variable = new ReactiveVar(&lt;optional-default-value&gt;)</pre></div><p class="calibre7">This variable will expose setter and getter functions. This means that you use the <code class="email">.get</code> command to see the value of the variable and the <code class="email">.set</code> command to change it:</p><div class="informalexample"><pre class="programlisting"># Get the value of the variable
reactive_variable.get()

# Set the value of the variable
reactive_variable.set "hello"</pre></div><p class="calibre7">Let's use the ReactiveVar variables to create a rich number input interface for our quantity field. We will start by defining a route name as <code class="email">order_quantity</code> with a <code class="email">product</code> parameter:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /orders/cart/cart_route.coffee</strong></span>

FlowRouter.route "/cart",
  ...

FlowRouter.route "/cart/:product/quantity",
  name:"order_quantity"
  action: -&gt;
    FlowLayout.render "layout",
      content:"order_quantity"</pre></div><p class="calibre7">We can wire up our product with a new button that will take us to the modify quantity view and passes to our product ID:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /products/client/product.coffee</strong></span>

Template.created "product", -&gt;
  ...

Template.product.events
  "click button.add-to-cart": (event) -&gt;
    ...

  "click button.modify-quantity": -&gt;
    FlowRouter.go "order_quantity",
      product:@_id

<span class="strong"><strong class="calibre2">//- /products/client/product.jade</strong></span>

template(name="product")
  div.col-xs-12.col-sm-4.col-md-3
    article#product
      h5 {{name}}

      div.offer
        span.price {{format.money price}}

      button.add-to-cart.btn.btn-block.btn-primary Add to Cart

      button.modify-quantity.btn.btn-block.btn-info Quantity</pre></div><p class="calibre7">Now we need to<a id="id170" class="calibre1"/> design a responsive number pad. First, let's add a<a id="id171" class="calibre1"/> global <code class="email">vertical-align</code> class to our <code class="email">/_globals/client/main.styl</code> directory so that we can easily align things vertically:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">// /_globals/client/main.styl</strong></span>

.vertical-align
  position:relative
  transform:translateY(-50%)
  top:50%</pre></div><p class="calibre7">We will use Jeet to control this design since it requires more specific control of our DOM elements. Let's start <a id="id172" class="calibre1"/>by creating the layout of the<a id="id173" class="calibre1"/> page in our <code class="email">order_quantity</code> template:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">//- /orders/cart/client/order_quantity.jade</strong></span>

template(name="order_quantity")
  div#order_quantity.template
    section#number
      h1.text-center.vertical-align {{total}}

    section#number-pad
      each numbers
        div.number
          h2.text-center.vertical-align {{number}}

      div.delete
        p.text-center.vertical-align
          i.fa.fa-undo.fa-2x

      div.add-to-cart
        p.text-center.vertical-align
          i.fa.fa-check.fa-2x</pre></div><p class="calibre7">Notice that we are using the <code class="email">vertical-align</code> class on the element that we want to align vertically. We are going to make each of these elements a large button. Also, we will create a <code class="email">numbers</code> helper to write out our numbers to the number pad, and the <code class="email">total</code> helper will be our reactive variable. Let's have a look at our styles before we create our helpers:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">// /orders/cart/client/order_quantity.styl</strong></span>

@import "_globals/client/bootstrap/custom.bootstrap.import.styl"
@import "jeet" // Add jeet

#order_quantity
  overflow:hidden
  background:$brand-primary
  color:white

  section#number
    height:50%
    h1
      margin:0

  section#number-pad
    height:50%
    .number, .delete, .add-to-cart
      cursor:pointer
      height:25%
      col(1/3,gutter:0,cycle:3)
      h2, p
        margin:0</pre></div><p class="calibre7">In this example, we <a id="id174" class="calibre1"/>have passed the parameters to Jeet: <code class="email">gutter</code> and <code class="email">cycle</code>. Gutter makes sure that there are no margins, while cycle makes sure that the elements can only make rows with a maximum of 3 elements per row. We have made each section take up exactly 50 percent of the height of the screen but ensured that scrolling wouldn't happen by <a id="id175" class="calibre1"/>setting <code class="email">overflow</code> to hidden. Knowing that we are always going to have four rows of numbers, we set our height for each number to 25 percent.</p><p class="calibre7">Now let's put our <code class="email">ReactiveVar</code> variable knowledge to work. First, we set up our variable and attach it to the template instance using this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /orders/cart/client/order_quantity.coffee</strong></span>

<span class="strong"><strong class="calibre2"># Attach a reactive variable to the instance</strong></span>
<span class="strong"><strong class="calibre2"># this variable controls our total</strong></span>
Template.created "order_quantity", -&gt;
  @total = new ReactiveVar()</pre></div><p class="calibre7">Let's build the <code class="email">numbers</code> helper and the helper that will render our (<code class="email">total</code>) reactive variable:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /orders/cart/client/order_quantity.coffee</strong></span>

...

Template.order_quantity.helpers
<span class="strong"><strong class="calibre2">  # Create a list of numbers for the number pad</strong></span>
  "numbers": -&gt;
    _.map [1,2,3,4,5,6,7,8,9,0], (v,k) -&gt;
      number:String v

<span class="strong"><strong class="calibre2">  # Get the reactive variable</strong></span>
<span class="strong"><strong class="calibre2">  # this will automatically update when the variable changes</strong></span>
  "total": -&gt;
    Template.instance().total.get()</pre></div><p class="calibre7">We need to handle <a id="id176" class="calibre1"/>the events to update our <code class="email">ReactiveVar</code> <a id="id177" class="calibre1"/>variable:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /orders/cart/client/order_quantity.coffee</strong></span>

...

Template.order_quantity.events
<span class="strong"><strong class="calibre2">  # Concatenate numbers to make it work like a number pad</strong></span>
  "click .number": (event,i) -&gt;
    total = i.total.get()

    if total
      new_total = "#{total}#{@number}"
    else
      new_total = "#{@number}"

    i.total.set new_total

<span class="strong"><strong class="calibre2">  # Remove last number from string</strong></span>
  "click .delete": (event,i) -&gt;
    total = i.total.get()

    if total
      i.total.set total.slice 0,-1

  "click .add-to-cart": (event,i) -&gt;
<span class="strong"><strong class="calibre2">    # Get the session variable</strong></span>
    order_id = Session.get "global.order"
    order = Orders.findOne order_id

<span class="strong"><strong class="calibre2">    # Get the total</strong></span>
    total = i.total.get()
    unless total
      return
    else
      total = Number total

<span class="strong"><strong class="calibre2">    # Get the product with the ID from the router</strong></span>
    product = Products.findOne FlowRouter.current().params.product

<span class="strong"><strong class="calibre2">    # Insert Order if it doesn't exist</strong></span>
    unless order
      order_id = Orders.insert
        status:"new"
        total_products:0
        subtotal:0
        total:0
    else
      order_id = order._id

<span class="strong"><strong class="calibre2">    # Set the session variable for future reference</strong></span>
    Session.setPersistent "global.order",order_id

<span class="strong"><strong class="calibre2">    # Find the order</strong></span>
    order = Orders.findOne order_id

<span class="strong"><strong class="calibre2">    # Check for details on this product</strong></span>
    detail = OrderDetails.findOne
      product:product._id
      order:order._id

    if detail
<span class="strong"><strong class="calibre2">      # Increase by one if the details exist</strong></span>
      OrderDetails.update detail._id,
        $inc:
          quantity:total

      Orders.update order_id,
        $inc:
          total_products:1
          subtotal:product.price * total
          total:product.price * total
    else
<span class="strong"><strong class="calibre2">      # Insert if details do not exist</strong></span>
      OrderDetails.insert
        quantity:total
        product:product
        order:order._id

      Orders.update order._id,
        $inc:
          total_products:1
          subtotal:product.price * total
          total:product.price * total

    FlowRouter.go "products"</pre></div><p class="calibre7">If you take a<a id="id178" class="calibre1"/> good look at how the <code class="email">add-to-cart</code> event works, you <a id="id179" class="calibre1"/>will notice that it is almost identical to the event that we wrote for the products template. We are effectively repeating ourselves at this moment, but we will make our code less repetitive through <code class="email">Meteor.methods</code> later.</p><p class="calibre7">Notice how we are using ReactiveVar the same way as we would use a session variable with the difference that we are not exposing the variable to the console. This helps to make the interface a bit more secure.</p><p class="calibre7">Let's not forget to add our publishers for this view to work, we will need <code class="email">Products</code>, <code class="email">Orders</code>, and <code class="email">OrderDetails</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /orders/cart/client/order_quantity.coffee</strong></span>

Template.created "order_quantity", -&gt;
  @total = new ReactiveVar()

  @autorun =&gt;
    @subscribe "order_quantity",
      product:FlowRouter.current().params.product
      order:Session.get "global.order"

<span class="strong"><strong class="calibre2"># /orders/cart/server/order_quantity_pub.coffee</strong></span>

Meteor.publish "order_quantity", (ops={}) -&gt;
  if ops.product and not _.isEmpty ops.product
    @relations
      collection:Products
      filter:
        _id:ops.product

    @relations
      collection:Orders
      filter:
        _id:ops.order
        status:"new"
      mappings:[
        {
          key:"order"
          collection:OrderDetails
          filter:
            product:ops.product
        }
      ]

  @ready()</pre></div><p class="calibre7">We learned how to build a custom form <a id="id180" class="calibre1"/>using ReactiveVar <a id="id181" class="calibre1"/>variables. The topic covers ReactiveVar and touches on Jeet. We learned how to use reactive variables to create rich UX.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Forms"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03lvl1sec24" class="calibre1"/>Forms</h1></div></div></div><p class="calibre7">So far, our buttons and forms have <a id="id182" class="calibre1"/>been highly inefficient because they are not easy to repeat, and therefore, not easy to maintain. There are two ways that we can use to make our code easier to manage:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Meteor Methods</li><li class="listitem">Autoform</li></ul></div><p class="calibre7">With Meteor Methods, we can easily create<a id="id183" class="calibre1"/> <span class="strong"><strong class="calibre2">repeatable</strong></span> and <span class="strong"><strong class="calibre2">secure</strong></span> functions <a id="id184" class="calibre1"/>while autoforms can identify the structure of a collection and generate form elements from it. This provides a decent layer of security without much effort as well. Autoform and Meteor Methods can be used together as well for further security.</p><p class="calibre7">The autoform method can be implemented through the <code class="email">aldeed:autoform</code> and <code class="email">aldeed:collection2</code> packages.</p></div>

<div class="book" title="Forms">
<div class="book" title="Meteor Methods"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch03lvl2sec46" class="calibre1"/>Meteor Methods</h2></div></div></div><p class="calibre7">Meteor Methods<a id="id185" class="calibre1"/> can be used on the client or the server. They are created by using the <code class="email">Meteor.methods(&lt;object-of-functions&gt;)</code> function and run with the <code class="email">Meteor.call(&lt;function-name&gt;, &lt;callback function&gt;)</code> function. Running a meteor method from the client causes 2 versions of the same function to run. One runs on the server and manipulates data while the other runs on the client and simulates data manipulation. This is what we call a Method Stub. Let's look at some example code to understand this concept:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># Define your method CLIENT SIDE</strong></span>
Meteor.methods
  say_hello: -&gt;
    console.log "hello"

<span class="strong"><strong class="calibre2"># Define your method SERVER SIDE</strong></span>
Meteor.methods
  say_hello: -&gt;
    console.log "I don't want to say hello"

<span class="strong"><strong class="calibre2"># Run the function CLIENT SIDE</strong></span>
Meteor.call "say_hello"</pre></div><p class="calibre7">Once you run the function, the Meteor Method activates both the server-side and client-side functions. So the server in this case will log "I don't want to say hello" to the console while the client will log "hello". This is a special feature that Meteor provides to help validate code or run other functions in parallel on the server without exposing sensitive data to the client.</p><p class="calibre7">Still, it is important to note that the client-side method will run immediately while the server-side method will take longer. The client-side code should, therefore, be used for simulation while the server-side code should be used for validation.</p><p class="calibre7">Let's define and use a Meteor Method that runs on both the client and the server. Let's start by redefining the <code class="email">add-to-cart</code> events that we had programmed earlier:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /orders/cart/cart_methods.coffee</strong></span>

Meteor.methods
  "cart.add-to-cart": (ops={},callback) -&gt;
    #ops
      # order
      # product
      # quantity

    order = Orders.findOne ops.order
    product = Products.findOne ops.product

    # Insert Order if it doesn't exist
    unless order
      order_id = Orders.insert
        status:"new"
        total_products:0
        subtotal:0
        total:0
    else
      order_id = order._id

    # Set the session variable for future reference
    if Meteor.isClient
      Session.setPersistent "global.order",order_id

    # Find the order
    order = Orders.findOne order_id

    # Check for details on this product
    detail = OrderDetails.findOne
      product:product._id
      order:order._id

    if detail
      # Increase by one if the details exist
      OrderDetails.update detail._id,
        $inc:
          quantity:ops.quantity

      Orders.update order._id,
        $inc:
          total_products:ops.quantity
          subtotal:product.price * ops.quantity
          total:product.price * ops.quantity
    else
      # Insert if details do not exist
      OrderDetails.insert
        quantity:ops.quantity
        product:product._id
        order:order._id

      Orders.update order._id,
        $inc:
          total_products:ops.quantity
          subtotal:product.price * ops.quantity
          total:product.price * ops.quantity

    # Run the callback function if it exists
    callback and callback(null, true)</pre></div><p class="calibre7">Notice that we have <a id="id186" class="calibre1"/>modified the way that we are setting our persistent session variable. The server does not have a session object, so we need to make sure that this snippet of code only runs on the client using <code class="email">Meteor.isClient</code>. We have modified the rest of our code to accept quantity, a product ID, and an order ID, which is all we need to be able to manage both the events.</p><p class="calibre7">Also, we added a line at the end of the method to check for a callback function and run it, if it exists. Observe how we have accepted a function as one of our parameters in the beginning of the function. To follow in Meteor's footsteps, we return <code class="email">null</code> as the error object and <code class="email">true</code> as the result after the function has completed. Now let's replace the events:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /orders/cart/client/order_quantity.coffee</strong></span>

# Attach a reactive variable to the instance
# this variable controls our total
Template.created "order_quantity", -&gt;
  ...

Template.order_quantity.helpers
  ...

Template.order_quantity.events
  ...

  "click .add-to-cart": (event,i) -&gt;
    # Get the total
    total = i.total.get()
    unless total
      return
    else
      total = Number total

    Meteor.call "cart.add-to-cart",
      order:Session.get "global.order"
      product:FlowRouter.current().params.product
      quantity:total
      (error,r) -&gt;
        if not error
          FlowRouter.go "products"

<span class="strong"><strong class="calibre2"># /products/client/product.coffee</strong></span>

Template.created "product", -&gt;
  ...


Template.product.events
  "click button.add-to-cart": (event) -&gt;
    Meteor.call "cart.add-to-cart",
      order:Session.get "global.order"
      product:@_id
      quantity:1
      (error,r) -&gt;
        if not error
          FlowRouter.go "products"</pre></div><p class="calibre7">Meteor Methods <a id="id187" class="calibre1"/>are great to create rich and easily repeatable user interfaces, but you will eventually find yourself repeating certain patterns if you are only updating a single collection. This is where autoforms come in.</p></div></div>

<div class="book" title="Forms">
<div class="book" title="Autoform"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch03lvl2sec47" class="calibre1"/>Autoform</h2></div></div></div><p class="calibre7">The <code class="email">autoform</code> plugin<a id="id188" class="calibre1"/> was installed together with the <code class="email">collection2</code> plugin. Both of these work together to quickly create forms that support error handling for you. Documentation on these plugins is vast, but it is necessary to read this to make your views safe and easy to <a id="id189" class="calibre1"/>build. You can find this documentation at <a class="calibre1" href="https://github.com/aldeed/meteor-autoform">https://github.com/aldeed/meteor-autoform</a>. We are going to cover a simple pattern to show you how to easily manipulate autoforms.</p><p class="calibre7">To use autoform, you need to first create a <code class="email">collection2</code> schema for your collection. This defines the rules that autoform is going to use to validate and generate our input fields. Let's populate our products schema:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /_globals/lib/collections/products/products_collection.coffee</strong></span>

@Products = new Mongo.Collection "products"

Products.attachSchema new SimpleSchema
  name:
    type:String
    label:"Name"

  description:
    type:String
    label:"Description"
    optional:true

  sku:
    type:String
    label:"SKU"
    optional:true

  price:
    type:Number
    label:"Price"</pre></div><p class="calibre7">In this snippet of code, we are defining every field within a <code class="email">new SimpleSchema</code> constructor, then we have attached the schema to the collection using the <code class="email">.attachSchema</code> function. The <code class="email">SimpleSchema</code> constructor takes an object where the first key defines the name of the field and the object within that key defines the way the field will behave. We will dive into this further in the next chapter.</p><p class="calibre7">Attaching a schema to our collections makes sure that the client-side console commands cannot add information to the database that is not a part of the schema. Let's reset our project to make sure our new products adapt to the new schema:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">meteor reset</strong></span>
</pre></div><p class="calibre7">Now we can create <a id="id190" class="calibre1"/>a simple insert form for our products collection using autoforms. Let's create the template and route:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">//- /products/client/create_product.jade</strong></span>

template(name="create_product")
  h3.text-center create product

  div.container
    div.row
      div.col-xs-12
        +autoForm collection="Products" type="insert" id="insert_product" preserveForm="true"
          +afQuickField name="name" autocorrect="off" autocomplete="off"
          +afQuickField name="price"
          +afQuickField name="description"
          +afQuickField name="sku"

          button.btn.btn-block.btn-primary Add Product

<span class="strong"><strong class="calibre2"># /products/products_route.coffee</strong></span>

FlowRouter.route "/",
  ...

FlowRouter.route "/products/create",
  name:"create_product"
  action: -&gt;
    FlowLayout.render "layout",
      content:"create_product"</pre></div><p class="calibre7">Notice that we do not need to write a controller to make this work. There are two critical components that we need to understand in this case: <code class="email">autoForm</code> and <code class="email">afQuickField</code>.</p><p class="calibre7">When we use <code class="email">autoForm</code> with a collection, we have to declare the name of the collection using the <code class="email">collection</code> parameter. Also, we need to define whether the form is doing an insert, update, or method call using the <code class="email">type</code> parameter, and finally, we give the form an <code class="email">id</code> that will be used as the HTML <code class="email">id</code> attribute for the form. Additionally, we pass the <code class="email">preserveForm</code> parameter to make sure that the data persists through hot code reloads. There are several other parameters that autoform takes, but these are the most commonly used.</p><p class="calibre7">The <code class="email">afQuickField</code> component <a id="id191" class="calibre1"/>specifically creates a <code class="email">bootstrap3</code> input field that can easily handle errors. Notice that we can add HTML attributes (such as <code class="email">autocorrect</code> and <code class="email">autocomplete</code>) to these components as well as parameters. There are a variety of ways to customize these inputs but we recommend only two: modifying the CSS directly or leveraging <code class="email">afFieldInput</code> and <code class="email">afFieldIsInvalid</code> to build new elements.</p><p class="calibre7">Let's customize our <code class="email">price</code> field a little bit more:</p><div class="informalexample"><pre class="programlisting">    div.form-group(class="{{#if afFieldIsInvalid name='price'}} has-error has-feedback {{/if}}")

      label.control-label {{afFieldLabelText name="price"}}

      +afFieldInput name="price" validation="submit"

      if afFieldIsInvalid name="price"
        span.glyphicon.glyphicon-certificate.form-control-feedback
        span.help-block {{afFieldMessage name="price"}}</pre></div><p class="calibre7">By doing this, we are very easily adding a <code class="email">glyphicon</code> to our field using bootstraps' classes, but this can be useful for adapting our forms to any framework, if needed.</p><p class="calibre7">There is still a bit of an issue with this form though, people input prices in dollars instead of cents, but our schema only accepts cents. Let's transform this data before it is submitted using autoform's <span class="strong"><strong class="calibre2">hooks</strong></span>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /products/client/create_product.coffee</strong></span>

AutoForm.addHooks "insert_product",
  formToDoc: (product) -&gt;
    product.price = product.price * 100

    product

  docToForm: (product) -&gt;
    product.price = product.price / 100

    product</pre></div><p class="calibre7">Autoform has a long list of hooks, but by far the most useful one for transformations is <code class="email">formToDoc</code>. This function runs every time the form is converted to a document for processing, this includes<a id="id192" class="calibre1"/> before the errors are processed. We do not use the "before hook" because this hook will run after processing errors. Also, we are using a <code class="email">docToForm</code> hook to make sure that our <code class="email">price</code> field stays intact after a code reload. Autoform has the following hooks:</p><div class="informalexample"><pre class="programlisting">before:
  insert:
  update:
  update-pushArray:
  method:
  method-update:
  normal:
after:
  insert:
  update:
  update-pushArray:
  method:
  method-update:
  normal:
onSubmit:
onSuccess:
onError:
formToDoc:
formToModifier:
docToForm:
beginSubmit:
endSubmit:</pre></div><p class="calibre7">With this, we can quickly create forms and modify them to the way we like while preserving usability. Stay away from fields that require arrays! They are difficult to manage in our application and can always be expressed as a new collection in our models.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Loading data"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03lvl1sec25" class="calibre1"/>Loading data</h1></div></div></div><p class="calibre7">The performance of our<a id="id193" class="calibre1"/> frontend can suffer if we do not load data correctly because it can make the DOM redraw quickly multiple times. If the calculations are complex, then we need to wait for all our data to be available and calculate everything in one single sweep. If we do not wait for data, then calculations will run as the data is received, which in turn will cause the DOM to redraw multiple times very quickly.</p><p class="calibre7">To solve this issue, we can easily check whether our subscribers are ready and show a loading symbol until they are.</p></div>

<div class="book" title="Loading data">
<div class="book" title="Designing the loading indicator"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch03lvl2sec48" class="calibre1"/>Designing the loading indicator</h2></div></div></div><p class="calibre7">We start by creating a <a id="id194" class="calibre1"/>loading template. Let's use font awesome to handle our animations and make sure that we can easily change the color of the loader:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">//- /loader/loader.jade</strong></span>

template(name="loader")
  div#loader.template
    div(class="{{color_class}}").vertical-align.text-center
      i.fa.fa-5x.fa-cog.fa-spin

<span class="strong"><strong class="calibre2">// /loader/loader.styl</strong></span>

#loader
  height:100%</pre></div><p class="calibre7">In this case, we are using the <code class="email">fa-spin</code> class to make the cog spin and adding a <code class="email">color_class</code> helper that will take bootstraps' <code class="email">text-</code> classes to define colors. Also, we made sure that the loader fills the contents of whatever is holding it so that everything aligns nicely when we use it.</p></div></div>

<div class="book" title="Loading data">
<div class="book" title="Implementing the loading indicator"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch03lvl2sec49" class="calibre1"/>Implementing the loading indicator</h2></div></div></div><p class="calibre7">Let's implement the loading<a id="id195" class="calibre1"/> indicator for our list of products. Due to the way we are going to implement this, we could easily have our interface show the loading indicator for each product or the list of products. It will be more efficient to control the latter.</p><p class="calibre7">So let's modify our products template:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">//- /products/client/products.jade</strong></span>

template(name="products")
  div#products.template
    header#promoter
      ...

    section#features
      ...

    section#featured_products
      div.container
        div.row
<span class="strong"><strong class="calibre2">          if Template.subscriptionsReady</strong></span>
            each products
              +product
          else
            div(style="height:160px;")
              +loader color_class="text-primary"

    br</pre></div><p class="calibre7">Meteor core exposes a special <code class="email">Template.subscriptionsReady</code> helper that checks whether the subscriptions made in that template instance are all in the ready state. This is one of the hidden advantages of using <code class="email">@subscribe</code> from our <code class="email">Template.created</code> function instead of <code class="email">Meteor.subscribe</code>.</p><p class="calibre7">In this case, we only run the <code class="email">each</code> iteration on the <code class="email">products</code> variable until all subscriptions are ready. Before this happens, we render our <code class="email">loader</code> component in our primary color.</p><p class="calibre7">The advantage to this<a id="id196" class="calibre1"/> pattern is that we can control exactly where we want our loader to be and when we want it to appear.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Animations and transitions"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03lvl1sec26" class="calibre1"/>Animations and transitions</h1></div></div></div><p class="calibre7">Animation for the <a id="id197" class="calibre1"/>web is a vast field that is still growing and can get highly complex if you want it to be. At the end of the day though, efficient animations are what make a real difference. How do you make an animation efficient? You keep it simple, and you let the browser animate it for you. Stay away<a id="id198" class="calibre1"/> from using JavaScript to identify positions and change colors. Animations that are heavy on JavaScript will always have terrible performance. This poor performance happens because JavaScript cannot run effectively in all devices, so multiple changes to the DOM occur at the maximum allowed speed of the device without using video memory.</p><p class="calibre7">Canvas<a id="id199" class="calibre1"/> is an HTML element that is designed to render changes using JavaScript and WebGL. Animating anything through canvas will boost performance, but it is meant more for applications that want to do graphically intensive work such as 3D rendering or sprite animations for a game. We will not cover canvas in this book because you will probably never need it.</p><p class="calibre7">Ignoring the power of canvas leaves us with two CSS tools to make rich animations: <code class="email">animation</code> and <code class="email">transition</code>. The <code class="email">animation</code> property is meant for complex animations that require keyframes, while the <code class="email">transition</code> property is meant for simple change-of-state animations. Let's look at an example of each to first understand how they work, then we will apply them to Meteor.</p></div>

<div class="book" title="Animations and transitions">
<div class="book" title="Animating with CSS"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch03lvl2sec50" class="calibre1"/>Animating with CSS</h2></div></div></div><p class="calibre7">The <code class="email">transition</code> property is the easiest<a id="id200" class="calibre1"/> property to understand. You basically define which property you are going to animate and how, within a CSS property:</p><div class="informalexample"><pre class="programlisting">.box
  transition: &lt;CSS property&gt; &lt;duration&gt; &lt;timing function&gt; &lt;delay&gt;</pre></div><p class="calibre7">It's important to realize that because of <a id="id201" class="calibre1"/>
<span class="strong"><strong class="calibre2">Stylus Nib</strong></span> (another useful Stylus plugin included in this package), we do not have to worry about vendor prefixes for this particular property. Nib will handle this for us automatically. By adding the transition property to the <code class="email">box</code> class, we are telling the browser to animate any change that occurs on the defined property. How do these changes occur? With new classes. Let's look at a small example:</p><div class="informalexample"><pre class="programlisting">.box
  transition: opacity 300ms ease-in
  opacity: 0
  .in
    opacity: 1</pre></div><p class="calibre7">With this set of CSS rules, we are making the box invisible until the <code class="email">.in</code> class is dynamically added. Once the class is added, then the DOM element will fade in. The available timing functions are: <code class="email">ease</code>, <code class="email">linear</code>, <code class="email">ease-in</code>, <code class="email">ease-out</code>, <code class="email">ease-in-out</code>, <code class="email">step-start</code>, and <code class="email">step-end</code>.</p><p class="calibre7">The <code class="email">animation</code> property is a <a id="id202" class="calibre1"/>bit more complex because it does not require a dynamic class to activate the animation:</p><div class="informalexample"><pre class="programlisting">.box
  animation:
    &lt;animation name&gt;
    &lt;duration&gt;
    &lt;timing function&gt;
    &lt;delay&gt;
    &lt;direction&gt;
    &lt;iteration count&gt;
    &lt;fill mode&gt;
    &lt;play state&gt;

@keyframes &lt;animation name&gt;
  0%
    background:blue
  50%
    background:green
  100%
    background:red</pre></div><p class="calibre7">As you can see, the difference between a transition and an animation is the level of control you can have over the animation. By using an <code class="email">animation name</code> and the <code class="email">@keyframes</code> selector, we can control at which point of the animation we want our properties to change and to what. You can change the number on the keyframe to whatever number you want.</p><p class="calibre7">Notice that the <code class="email">animation</code> property has a few new parameters: <code class="email">iteration count</code>, <code class="email">fill mode</code>, and <code class="email">play state</code>. The <code class="email">iteration count</code> parameter defines how many times an animation is going to play; you can set this to infinite or a specific number. The <code class="email">fill mode</code> defines the state at which you want the element to be when it is not animating: <code class="email">forwards</code> sets values to the last defined keyframe, <code class="email">backwards</code> to the first defined keyframe, both sets to <code class="email">first</code> and <code class="email">last</code>, and <code class="email">none</code> will do nothing (default). The <code class="email">play state</code> controls whether an animation is playing or not (paused or running).</p><p class="calibre7">We can use a second <a id="id203" class="calibre1"/>CSS selector to control our <code class="email">play state</code>, if we need to in the same way that we did for our <code class="email">transition</code> property.</p></div></div>

<div class="book" title="Animations and transitions">
<div class="book" title="Executing animations in Meteor"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch03lvl2sec51" class="calibre1"/>Executing animations in Meteor</h2></div></div></div><p class="calibre7">In Meteor, it is very easy to <a id="id204" class="calibre1"/>control the classes that are rendered on the DOM <a id="id205" class="calibre1"/>using helpers, so we can quickly inject a class that will trigger our CSS animation. We will have issues when we want to trigger animations on elements that do not exist in the DOM.</p><p class="calibre7">For example, once our products have loaded, they just pop in. What if we want to make the list fade in and the loader fade out instead? This is where Meteor's hidden <code class="email">@_uihooks</code> function comes into play.</p><p class="calibre7">At the time of writing, this feature is in beta and is still a bit buggy. The best way to handle all the issues that this is causing is through the <code class="email">percolate:momentum</code> package. This avoids the need to understand the issues that <code class="email">uihooks</code> currently has and how to get around them.</p><p class="calibre7">The <code class="email">momentum</code> package is designed to intercept Blaze by using the <code class="email">@_uihooks</code> function that is made available in the context of the <code class="email">Template.rendered</code> function. It is very easy to use and comes packaged with VelocityJS, a jQuery plugin that handles transitions somewhat effectively. We can use a combination of both to help keep things simple.</p><p class="calibre7">To customize momentum, we need to register momentum plugins that handle the three hooks that can occur in our DOM: <code class="email">insertElement</code>, <code class="email">removeElement</code>, and <code class="email">moveElement</code>.</p><div class="informalexample"><table border="1" class="calibre12"><colgroup class="calibre13"><col class="calibre14"/><col class="calibre14"/></colgroup><tbody class="calibre19"><tr class="calibre16"><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">insertElement</code>
</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">Occurs when a DOM element is created</p>
</td></tr><tr class="calibre16"><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">removeElement</code>
</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">Occurs when a DOM element is destroyed</p>
</td></tr><tr class="calibre16"><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">moveElement</code>
</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">Occurs when a DOM element is moved from it's DOM location (sorting can cause this to be triggered)</p>
</td></tr></tbody></table></div><p class="calibre7">Let's build the plugin named <code class="email">fade-fast</code> that will control the fading in and out of our loading indicator of our products:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /_globals/client/momentum/fade-fast.coffee</strong></span>

Momentum.registerPlugin 'fade-fast', (options) -&gt;
  insertElement: (node, next) -&gt;
    $(node)
      .addClass "animate opacity invisible"
      .insertBefore(next)

    Meteor.setTimeout -&gt;
        $(node).removeClass "invisible"
      ,250

  removeElement: (node) -&gt;
    $(node).velocity opacity:0, 250, "easeOut", -&gt;
      $(this).remove()</pre></div><p class="calibre7">We use the <code class="email">node</code> variable<a id="id206" class="calibre1"/> to modify the elements that we are going <a id="id207" class="calibre1"/>to inject into the DOM, and we always use <code class="email">insertBefore</code> with the <code class="email">next</code> variable as a parameter to render. Notice that in this case, when we insert, we are adding three classes before the items are rendered to the DOM, and then after 250 milliseconds, we remove the invisible class.</p><p class="calibre7">When an element is removed, we will use <code class="email">velocity</code> to modify <code class="email">opacity</code> and bring this down to <code class="email">0</code> in exactly <code class="email">250</code> milliseconds. Velocity takes in a callback command that we will use to finally remove the element from the DOM.</p><p class="calibre7">Now we can add our styles and place the helper inside our view:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">//- /products/client/products.jade</strong></span>

  ...

    section#featured_products
      div.container
        div.row
<span class="strong"><strong class="calibre2">          +momentum(plugin="fade-fast")</strong></span>
            if Template.subscriptionsReady
              each products
                div.col-xs-12.col-sm-4.col-md-3
                  +product
            else
              div(style="height:160px;")
                +loader color_class="text-primary"

<span class="strong"><strong class="calibre2">// _globals/client/main.styl</strong></span>

.vertical-align
  ...

.animate
  &amp;.opacity
    transition: opacity 500ms
    opacity:1

    &amp;.invisible
      opacity:0</pre></div><p class="calibre7">Notice that we have <a id="id208" class="calibre1"/>added a <code class="email">momentum(plugin="fade-fast")</code> component <a id="id209" class="calibre1"/>that defines which plugin to use around the area that is going to render elements with animations. Then we create the classes that will use CSS transition to make each DOM element fade in.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="SEO"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03lvl1sec27" class="calibre1"/>SEO</h1></div></div></div><p class="calibre7">Meteor has one big problem. It <a id="id210" class="calibre1"/>does not support server-side rendering out of the box. This means that robots don't know how to parse our pages because the server does not render the page, the client does! There are many ways to solve this issue. You can try using <code class="email">meteorhacks:ssr</code> to enable server-side rendering or you can let a service automate this for you for free. We are going to use a service to keep things simple.</p></div>

<div class="book" title="SEO">
<div class="book" title="Prerender.io"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch03lvl2sec52" class="calibre1"/>Prerender.io</h2></div></div></div><p class="calibre7">Meet <a id="id211" class="calibre1"/>prerender.io, the easiest way to get<a id="id212" class="calibre1"/> your site parsed. Prerender.io is mostly a free service that understands exactly how to parse your page. It basically navigates to your <code class="email">webapp</code> and parses each page, and then when a bot hits our <code class="email">webapp</code>, our server will fetch the parsed page from prerender.io and respond with this instead.</p><p class="calibre7">The service is free for the webapps that have a minimal number of pages that get hit by bots. The more dynamic and the more pages you have, the higher the price will be, but this is unlikely unless you are building a highly dynamic public web page. Even then, the <code class="email">prerender.io</code> project can be downloaded and set up personally (so it's still free).</p><p class="calibre7">We have installed the <code class="email">dfischer:prerenderio</code> package to easily set up the service. The only thing that is left is for us is to authorize. First, go to <a class="calibre1" href="http://www.prerender.io">www.prerender.io</a> and open an account, then click the <span class="strong"><strong class="calibre2">INSTALL TOKEN</strong></span> tab on their navbar, and copy your token. Now paste your token under the configuration file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /_globals/server/prerenderio.coffee</strong></span>

prerenderio.set "prerenderToken","&lt;yourtoken&gt;"</pre></div><p class="calibre7">Simple! Your site is now crawl-able. Now let's configure our router to work with prerender and add a 404 page:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /router/config.coffee</strong></span>

if Meteor.isClient
  Template.created -&gt;
    except = [
      "Template.__dynamicWithDataContext"
      "Template.__dynamic"
      "Template.layout"
      "Template.layout"
      "body"
    ]

    unless _.contains except, @view.name
      window.prerenderReady = false

      if @subscriptionsReady()
        window.prerenderReady = true

FlowRouter.notFound =
  action: -&gt;
    FlowLayout.render "layout",
      content:"not_found"</pre></div><p class="calibre7">Notice that we<a id="id213" class="calibre1"/> are creating a global <code class="email">Template.created</code> hook function<a id="id214" class="calibre1"/> and setting <code class="email">prerenderReady</code> to <code class="email">false</code> by default. Then, we check whether our subscriptions are ready using <code class="email">@subscriptionsReady()</code> and set <code class="email">prerenderReady</code> to <code class="email">true</code>. It's important to understand that <code class="email">@subscriptionsReady()</code> only checks for subscriptions made through <code class="email">@subscribe</code> within the template!</p><p class="calibre7">Also, notice that we are creating a list of exceptions. This is to ensure that we only check for subscribers on templates that need them.</p><p class="calibre7">This pattern ensures prerender does not cache the page until it has actually loaded all the data. Why not use <code class="email">FlowRouter</code> global triggers? Sadly, these triggers do not have access to the template instance that is being rendered (since there can be many). If you need more control, you can set this per route/template.</p><p class="calibre7">Let's work on our <a id="id215" class="calibre1"/>404 page<a id="id216" class="calibre1"/> template:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">//- /router/client/not_found.jade</strong></span>

template(name="not_found")
  div#not_found.template
    div.text-center.vertical-align
      h3 404!
      h5 Page not found!</pre></div><p class="calibre7">To make sure our 404 page prints out the correct 404 response, we are going to have to use <code class="email">Meta</code>.</p></div></div>

<div class="book" title="SEO">
<div class="book" title="Using Meta"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch03lvl2sec53" class="calibre1"/>Using Meta</h2></div></div></div><p class="calibre7">To control<a id="id217" class="calibre1"/> prerender, we need to <a id="id218" class="calibre1"/>use the <code class="email">yasinuslu:blaze-meta</code> package. This package basically injects a template to our <code class="email">head</code> HTML tag so that we can easily set tags. Prerender uses tags to identify whether the page should respond with a 404. We can use Meta to set our title, description, keywords, and robots properties as well. Let's start by making our 404 page respond with a 404:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /router/client/not_found.coffee</strong></span>

Template.rendered "not_found", -&gt;
  Meta.set [
    {
      name:"name"
      property:"prerender-status-code"
      content:"404"
    }
    {
      name:"name"
      property:"robots"
      content:"noindex, nofollow"
    }
  ]</pre></div><p class="calibre7">The <code class="email">Meta</code> object has only four functions: <code class="email">set</code>, <code class="email">setTitle</code>, <code class="email">unset</code>, and <code class="email">config</code>. It is unlikely that you will use <code class="email">unset</code> because metatags do not persist through routes. Both the <code class="email">set</code> and <code class="email">unset</code> functions require an array of objects, and each object requires all the three keys: <code class="email">name</code>, <code class="email">property</code>, and <code class="email">content</code>.</p><p class="calibre7">In the preceding example, we are setting <code class="email">prerender-status-code</code> to <code class="email">404</code> and <code class="email">robots</code> to <code class="email">noindex, nofollow</code>. With this, we ensure that our 404 page in fact returns a 404 error and that crawlers do not index the page.</p><p class="calibre7">Also, we need to <a id="id219" class="calibre1"/>configure <code class="email">Meta</code> so<a id="id220" class="calibre1"/> that the name of the page is always correct:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /router/config.coffee</strong></span>

if Meteor.isClient
  Meta.config
    options:
      title:"Crashing Meteor"
      suffix:""

  ...</pre></div><p class="calibre7">Since <code class="email">Meta</code> is controlling our <code class="email">title</code> tag, we need to remove that tag from <code class="email">layout.jade</code>.</p></div></div>

<div class="book" title="SEO">
<div class="book" title="Schema.org"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch03lvl2sec54" class="calibre1"/>Schema.org</h2></div></div></div><p class="calibre7">Now that our<a id="id221" class="calibre1"/> site is crawl-able, we want our <a id="id222" class="calibre1"/>products to shine for search engines. Let's upgrade our products to enable Rich Snippets. Rich Snippets follow schema.org standards to build structured data for search engine crawlers such as Google to interpret. With this information, search engines can present your data on their site more prominently, make searches more effective, and even use it in other services. Following their guidelines is a good idea because Google uses these guidelines for its crawler.</p><p class="calibre7">To do this, all we need to do is set <a id="id223" class="calibre1"/>as many schema.org's properties as possible on our product page. Visit <a class="calibre1" href="http://schema.org/Product">http://schema.org/Product</a> for a full list of the available properties. The properties that are most used are:</p><div class="informalexample"><table border="1" class="calibre12"><colgroup class="calibre13"><col class="calibre14"/><col class="calibre14"/><col class="calibre14"/></colgroup><thead class="calibre15"><tr class="calibre16"><th valign="bottom" class="calibre17">
<p class="calibre18">Property</p>
</th><th valign="bottom" class="calibre17">
<p class="calibre18">Type</p>
</th><th valign="bottom" class="calibre17">
<p class="calibre18">Description</p>
</th></tr></thead><tbody class="calibre19"><tr class="calibre16"><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">name</code> (required)</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">Text</code>
</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">The name of the product</p>
</td></tr><tr class="calibre16"><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">image</code>
</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">URL</code>
</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">The URL of the product</p>
</td></tr><tr class="calibre16"><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">description</code>
</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">Text</code>
</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">The description of the product</p>
</td></tr><tr class="calibre16"><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">offers</code>
</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">OFFER OBJECT</code>
</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">This includes multiple parameters that define the price of the object</p>
</td></tr><tr class="calibre16"><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">price</code> (required)</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">Number</code>
</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">The price of the product</p>
</td></tr><tr class="calibre16"><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">priceCurrency</code> (required)</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">
<code class="literal">Text (ISO 4217) [ex: USD]</code>
</p>
</td><td valign="top" class="calibre20">
<p class="calibre18">The currency of the price</p>
</td></tr></tbody></table></div><p class="calibre7">Now let's put this to practice using the <code class="email">MicroData</code> spec:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">//- /products/client/product.jade</strong></span>

template(name="product")
  article#product(itemscope itemtype="http://schema.org/Product")
    h5(itemprop="name") {{name}}

    div.offer(itemprop="offers" itemscope itemtype="http://schema.org/Offer")
      meta(itemprop="priceCurrency" content="USD")
      span.price(itemprop="price") {{format.money price}}

    button.add-to-cart.btn.btn-block.btn-primary Add 1 to Cart

    button.modify-quantity.btn.btn-block.btn-info Add more to Cart</pre></div><p class="calibre7">As you can see, to <a id="id224" class="calibre1"/>use the <code class="email">MicroData</code> spec, you need to add a variety of custom attributes to your <a id="id225" class="calibre1"/>view. For the most part, anytime you are going to declare what a particular thing is, you need to express this via the <code class="email">itemscope</code> and <code class="email">itemtype</code> attributes. When we want to declare properties under this declaration, we need to make sure our DOM elements are children of this declaration and that the property is declared through the <code class="email">itemprop</code> attribute.</p></div></div>
<div class="book" title="Summary"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch03lvl1sec28" class="calibre1"/>Summary</h1></div></div></div><p class="calibre7">This chapter covered several useful patterns that make the implementation of rich and minimal interfaces easy. First, we learned how to use the Twitter Bootstrap framework together with Jeet and Rupture; this improved the way we organize our DOM. Also, we learned how to make super helpers—functions that we can call in both views and controllers.</p><p class="calibre7">We took a dive into the different kinds of variables that we can use to keep our code safe and to create rich interfaces. Also, we learned how to use Meteor Methods and autoform to easily save information. We covered how to implement a simple loading indicator and how to get animations working in Meteor. To finish up, we learned how to implement a little SEO using prerender.io and the <code class="email">Meta</code> package.</p><p class="calibre7">The next chapter will cover application-wide patterns. <a class="calibre1" title="Chapter 4. Application Patterns" href="part0035_split_000.html#page">Chapter 4</a>, <span class="strong"><em class="calibre11">Application Patterns</em></span> will teach us how to filter and page through collections, how to fully secure our application, and how to integrate with external APIs.</p></div></body></html>