<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Scripting with Jelly</h1>
                </header>
            
            <article>
                
<p class="mce-root">In this chapter, we are going to look at scripting with Jelly. We will look at how to write Jelly code to create custom pages and scripts to meet your needs. We will also take a look at UI macros and how these are created in ServiceNow, as well as look at an example to further our knowledge in this area.</p>
<p>The following topics will be covered in this chapter:</p>
<ul>
<li>Jelly scripting</li>
<li>UI macros</li>
<li>Jelly scripting examples</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Jelly scripting</h1>
                </header>
            
            <article>
                
<p>Jelly scripting knowledge is important to build custom pages and scripts, and also to amend Jelly code that exists in ServiceNow as part of the platform to work in a different way for your own purposes. We introduced Jelly scripting and how it can be used in a UI page in the last chapter. Let's remind ourselves what the Jelly tags ServiceNow gives us look like:</p>
<pre>&lt;?xml version="1.0" encoding="utf-8" ?&gt;<br/>&lt;j:jelly trim="false"    &gt;<br/><br/>&lt;/j:jelly&gt;</pre>
<p>Once these tags are in place, we can start to include our Jelly code inside. This can be added to a UI page or UI macro. We will take a look at UI macros later in the chapter.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Evaluate</h1>
                </header>
            
            <article>
                
<p>First, let's have a look at the <kbd>&lt;g:evaluate&gt;</kbd> tag. This tag allows us to write JavaScript inside the tag and set a variable value at the end, if required. </p>
<p>The <kbd>&lt;g:evaluate&gt;</kbd> tag is arguably the most used tag in Jelly, and is certainly one to get to grips with. Remember that we can use <kbd>g</kbd> or <kbd>g2</kbd> for our tag, depending on which phase we want this script to run in.</p>
<p>Let's have a look at an example of the <kbd>&lt;g:evaluate&gt;</kbd> tag in action:</p>
<pre>&lt;g2:evaluate var="jvar_variable"&gt;<br/>     var setVariable = 'Set variable to string';<br/>     setVariable;<br/>&lt;/g2:evaluate&gt;</pre>
<p>In the preceding example, we are going to run the code in the second phase, so we are using <kbd>g2</kbd> in the tag we define. In the tag definition, we are also defining a variable name to use with <kbd>var="jvar_variable"</kbd>. We can name the variable different names, but we must always prefix the variable with <kbd>jvar</kbd> for it to work.</p>
<p>Here, we are setting <kbd>jvar_variable</kbd> to the string value in the script. In an <kbd>evaluate</kbd> tag, we just need to make the last line of our expression the variable we want to set the evaluate variable to. In our example, we have used <kbd>setVariable</kbd>, so <kbd>jvar_variable</kbd> becomes the value of <kbd>setVariable</kbd>, which is our string.</p>
<p>There are some parameters we can use in a <kbd>&lt;g:evaluate&gt;</kbd> tag; let's see these used in another example:</p>
<pre>&lt;g2:evaluate var="jvar_onHoldIncidents" object="true" jelly="true"&gt;<br/>    var holdIncident = new GlideRecord('incident');<br/>    holdIncident.addQuery('state', jelly.jvar_onHoldState);<br/>    holdIncident.query();<br/>    holdIncident;<br/>&lt;/g2:evaluate&gt;</pre>
<p>In this example, we can see two new parameters for the <kbd>&lt;g:evaluate&gt;</kbd> tag: <kbd>object</kbd> and <kbd>jelly</kbd>. The <kbd>object</kbd> tag dictates whether the <kbd>jvar</kbd> variable should be treated as an <kbd>object</kbd>. For our example, it would be the <kbd>GlideRecord</kbd> query, and so we would want this held as an object for later scripting. </p>
<p>The other new parameter is <kbd>jelly</kbd>. This parameter, if set to <kbd>true</kbd>, allows us to use <kbd>jelly</kbd> variables in our script. For our example, we are using the <kbd>jvar_onHoldState</kbd> variable, which we are assuming has been set to <kbd>3</kbd> in a previous <kbd>&lt;g:evaluate&gt; tag</kbd>. We need the <kbd>jelly</kbd> parameter set to <kbd>true</kbd> so we can use this variable in our example script.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">If</h1>
                </header>
            
            <article>
                
<p>The <kbd>if</kbd> tag in Jelly script works in a similar way to a JavaScript <kbd>if</kbd> statement. It is used to run code if a set condition is met. As we can set <kbd>if</kbd> statements in JavaScript, whether you want to use the Jelly <kbd>if</kbd> rather than the JavaScript <kbd>if</kbd> is up to you.</p>
<p>We can use the <kbd>if</kbd> tag to check whether a <kbd>GlideRecord</kbd> object has any records inside it. Let's have a look at how this is done using our example from the <kbd>evaluate</kbd> tag:</p>
<pre>&lt;g2:evaluate var="jvar_onHoldIncidents" object="true" jelly="true"&gt;<br/>    var holdIncident = new GlideRecord('incident');<br/>    holdIncident.addQuery('state', jelly.jvar_onHoldState);<br/>    holdIncident.query();<br/>    holdIncident;<br/>&lt;/g2:evaluate&gt;<br/><br/>&lt;j:if test="${!jvar_onHoldIncidents.hasNext()}"&gt;<br/>   No on hold incidents.<br/>&lt;/j:if&gt;<br/>&lt;j:if test="${jvar_onHoldIncidents.next()}"&gt;<br/>   There are ${jvar_onHoldIncidents.getRowCount()} incidents on hold currently.<br/>&lt;/j:if&gt;</pre>
<div>
<div class="mw-body">
<div class="mw-body-content">
<p class="mw-highlight mw-content-ltr">In our example, we are showing a message depending on whether there are currently on-hold incidents in the instance. The <kbd>if</kbd> statement has one parameter, which is <kbd>test</kbd>, which is the expression we need to evaluate to <kbd>true</kbd> to run the code inside the script in the tag.</p>
<p>This type of <kbd>if</kbd> statement is helpful to run conditions against <kbd>GlideRecord</kbd> objects.</p>
</div>
</div>
</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">UI macros</h1>
                </header>
            
            <article>
                
<p>UI macros are scripts that can be included in UI pages and in other areas throughout the ServiceNow platform. By separating them out from individual UI pages, it makes them easy to reuse across the platform, too.</p>
<p>UI macros are seen throughout the ServiceNow platform, running the service catalog cart and approval summarizers. Let's have a look at how they are created.</p>
<p>A UI macro is quite a simple form, with only a few fields. First, we need to give our UI macro a name. After that, we can add a description, and then complete the XML field. The XML field is an XML type field and works in a very similar way to the HTML field on a UI page. We fill in the XML field with the Jelly script we want to run when this UI macro is run.</p>
<p>We are also given the same Jelly code that we are given when creating a new UI page in the XML field:</p>
<pre>&lt;?xml version="1.0" encoding="utf-8" ?&gt;<br/>&lt;j:jelly trim="false"    &gt;<br/><br/>&lt;/j:jelly&gt;</pre>
<p>To recap, these tags introduce Jelly scripting, and we can start writing our Jelly script inside the Jelly tags.</p>
<p>We can also invoke a macro from a UI page by using a <kbd>macro_invoke</kbd> tag. Let's see how this works:</p>
<div>
<div class="mw-body">
<div class="mw-body-content">
<div class="mw-content-ltr">
<div class="mw-highlight mw-content-ltr">
<pre><span class="nt">&lt;g:macro_invoke</span> <span class="na">macro=</span><span class="s">"kb_article_footer"</span> <span class="nt">/&gt;</span></pre></div>
</div>
<p>We use the <kbd>macro_invoke</kbd> tag and the macro parameter to invoke our UI macro. We just need to give the name of the UI macro in the macro parameter, as in the preceding example. This example will invoke the <kbd>kb_article_footer</kbd> UI macro.</p>
<p>It is possible to invoke a UI macro inside a UI macro, too. To do this, we use a <kbd>g</kbd> tag with the name of the macro inside the tag. We can see how this works in the script:</p>
</div>
<div>
<div>
<div class="mw-body">
<div class="mw-body-content">
<div class="mw-content-ltr">
<div class="mw-highlight mw-content-ltr">
<pre><span class="nt">&lt;g:ui_button</span> <span class="nt">/&gt;</span></pre></div>
<p>This will invoke the <kbd>ui_button</kbd> inside this UI macro.</p>
<p>UI macros are a great way of writing chunks of Jelly code that can easily be reused throughout the ServiceNow platform. They are especially useful to add to your UI pages. </p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Script examples</h1>
                </header>
            
            <article>
                
<div>
<div class="mw-body">
<div>
<div>
<div class="mw-body">
<p>In this chapter, we have seen how to script in Jelly and how to create a UI page ourselves. Let's bring these two abilities together to make a working UI macro.</p>
<p>This is an example of a request I have been asked for before – an approval summary on the group approval record. Here, we need to create a UI macro and a formatter to add to the group approval form.</p>
<p>Let's start with our group approval summarizer code, creating a brief summary of the task record we will be approving with our group approval:</p>
</div>
</div>
</div>
</div>
<pre>&lt;?xml version="1.0" encoding="utf-8" ?&gt;<br/>&lt;j:jelly trim="false"    &gt;<br/>  &lt;tr&gt;<br/>    &lt;td class="label_left" width="100%"&gt;<br/>      &lt;label style="margin-left: 12px"&gt; Summary of Record being requested for approval:<br/>        &lt;g:label_spacing/&gt; <br/>      &lt;/label&gt;<br/>    &lt;/td&gt;<br/>  &lt;/tr&gt;<br/>  &lt;tr&gt;<br/>    &lt;td&gt;<br/>      &lt;table width="100%"&gt;<br/>       &lt;tr&gt;<br/>          &lt;td class="label_left" width="150px"&gt;<br/>            &lt;label style="margin-left: 10px"&gt;Short Description: <br/>            &lt;/label&gt;<br/>          &lt;/td&gt;<br/>          &lt;td&gt; $[current.parent.short_description]<br/>            &lt;g:label_spacing/&gt; <br/>          &lt;/td&gt;<br/>        &lt;/tr&gt;<br/>        &lt;tr&gt;<br/>          &lt;td class="label_left" width="150px"&gt;<br/>            &lt;label style="margin-left: 10px"&gt;Priority: <br/>            &lt;/label&gt;<br/>          &lt;/td&gt;<br/>          &lt;td&gt; $[current.parent.priority]<br/>            &lt;g:label_spacing/&gt; <br/>          &lt;/td&gt;<br/>        &lt;/tr&gt;<br/>        &lt;tr&gt;<br/>          &lt;td class="label_left" width="150px"&gt;<br/>            &lt;label style="margin-left: 10px"&gt;Opened by: <br/>            &lt;/label&gt;<br/>          &lt;/td&gt;<br/>          &lt;td&gt; $[current.parent.opened_by.getDisplayValue()]<br/>            &lt;g:label_spacing/&gt; <br/>          &lt;/td&gt;<br/>        &lt;/tr&gt; <br/>        &lt;tr&gt;<br/>          &lt;td class="label_left" width="150px"&gt;<br/>            &lt;label style="margin-left: 10px"&gt;Description: <br/>            &lt;/label&gt;<br/>          &lt;/td&gt;<br/>          &lt;td&gt; $[current.parent.description]<br/>            &lt;g:label_spacing/&gt; <br/>          &lt;/td&gt;<br/>        &lt;/tr&gt; <br/>      &lt;/table&gt; <br/>    &lt;/td&gt;<br/>  &lt;/tr&gt;<br/>&lt;/j:jelly&gt;</pre></div>
<p>As you can see, in this example, there is a fair amount of code, but a lot of this is HTML tags, so there is not much real content. In the example, we are creating a table containing some of the details of the record being approved so that the current group approver can see what they are approving. </p>
<p>The labels and spacing are HTML, and you can find this type of script in the UI macros ServiceNow provides for you. The interesting aspect of the code is in setting the task values. We use the dollar sign to declare the start of the variable, then curly or square brackets for phase one or phase two variables, respectively. Here, we are using square brackets to use the second phase, as our data will change and we do not want it to be cached.</p>
<p>We have named this UI macro <kbd>group_approval_summarizer</kbd>; let's take a look at what it looks like in ServiceNow in <em>Figure 8.1</em>:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-529 image-border" src="assets/3ad02886-33ca-43a4-a478-fb0df40bda04.png" style="width:115.75em;height:75.75em;"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 8.1: UI macro to show a summary of a record being approved</div>
<p>Now that we have our UI macro, we need to build a formatter to link to the UI macro that we can place on the group approval form. The <span class="packt_screen">Formatter</span> needs a <span class="packt_screen">Name</span>, a link to the UI macro, and to be on the group approval table. We can see an example of the formatter in <em>Figure 8.2</em>:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-530 image-border" src="assets/4fb0593a-4e12-45ca-85db-0f3ddbb6e4cc.png" style="width:92.50em;height:24.67em;"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 8.2: Formatter to display a UI macro</div>
<p>Now that we have the formatter, we can add the formatter to the group approval form layout to see our UI macro appear. The results of our UI macro on a group approval form can be seen in <em>Figure 8.3</em>:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/bb9b0e56-e05d-4fb5-94cf-e5ef240a574a.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Figure 8.3: Group approval form with added approval summary</div>
<p>In the preceding figure, we can see the output from our UI macro. This example shows how you can make a UI macro add value to forms in ServiceNow, adding extra data you cannot add with the form layout or designer.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we looked at scripting in Jelly. We explored the various tags of Jelly and how to use them together to create Jelly scripts. Using these Jelly techniques, we looked at how to create a UI macro containing Jelly script and saw a practical example of creating a UI macro to use in the ServiceNow platform.</p>
<p>In the next chapter, we will look at debugging in ServiceNow. We will look at the debugging tools ServiceNow provides for you in debugging scripts, fields, and the logs you have access to, to help fix errors.</p>


            </article>

            
        </section>
    </body></html>