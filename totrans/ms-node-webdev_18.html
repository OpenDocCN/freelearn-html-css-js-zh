<html><head></head><body>
<div class="calibre1" id="_idContainer224">
<h1 class="chapternumber"><span class="kobospan" id="kobo.1.1">16</span></h1>
<h1 class="chaptertitle" id="_idParaDest-277"><span class="kobospan" id="kobo.2.1">SportsStore: A Real Application</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.3.1">In each of the previous chapters, I focused on a particular feature required by web applications, which allowed me to dig into detail. </span><span class="kobospan" id="kobo.3.2">In this part of the book, I show how the features described in earlier chapters are combined to build a simple but realistic e-commerce application.</span></p>
<p class="normal"><span class="kobospan" id="kobo.4.1">My application, called</span><a id="_idIndexMarker849" class="calibre3"/><span class="kobospan" id="kobo.5.1"> SportsStore, will follow the classic approach taken by online stores everywhere. </span><span class="kobospan" id="kobo.5.2">I will create an online product catalog that customers can browse or search through, a shopping cart where users can add and remove products, and a checkout where customers can enter their shipping details. </span><span class="kobospan" id="kobo.5.3">I will also create an administration area that provides facilities to manage the catalog, and I will protect it so that only authorized users can make changes.</span></p>
<p class="normal"><span class="kobospan" id="kobo.6.1">My goal in this part of the book is to give you a sense of what real web application development is by creating as realistic an example as possible. </span><span class="kobospan" id="kobo.6.2">I want to focus on Node.js, of course, so I have simplified integration with external systems, such as the database, and omitted others entirely, such as payment processing.</span></p>
<h1 class="heading" id="_idParaDest-278"><span class="kobospan" id="kobo.7.1">Understanding the project structure</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.8.1">The SportsStore application </span><a id="_idIndexMarker850" class="calibre3"/><span class="kobospan" id="kobo.9.1">spans six chapters and contains many files, some of which have the same name, either because that’s what TypeScript/JavaScript requires or because of my development style. </span><span class="kobospan" id="kobo.9.2">There will be multiple </span><code class="inlinecode"><span class="kobospan" id="kobo.10.1">index.ts</span></code><span class="kobospan" id="kobo.11.1"> files, for example, because that’s the filename that JavaScript uses when importing from modules. </span><span class="kobospan" id="kobo.11.2">There will also be </span><a id="_idIndexMarker851" class="calibre3"/><span class="kobospan" id="kobo.12.1">multiple files whose name contains the term </span><em class="italic"><span class="kobospan" id="kobo.13.1">helper</span></em><span class="kobospan" id="kobo.14.1"> because that’s how I tend to write code that supports some other part of the application. </span><span class="kobospan" id="kobo.14.2">For quick reference, </span><em class="italic"><span class="kobospan" id="kobo.15.1">Table 16.1</span></em><span class="kobospan" id="kobo.16.1"> provides a high-level overview of the structure of the completed SportsStore project, which will provide context as you read through the chapters and follow the examples. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.17.1">Table 16.1: The project layout and key files</span></p>
<table class="table-container" id="table001-13">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.18.1">Folder</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.19.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.20.1">dist</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.21.1">This folder will contain the JavaScript files created by the TypeScript compiler, which will be executed by Node.js.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.22.1">src</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.23.1">This folder will contain all of the source code for the SportsStore application and will be compiled into the </span><code class="inlinecode"><span class="kobospan2" id="kobo.24.1">dist</span></code><span class="kobospan4" id="kobo.25.1"> folder.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.26.1">src/admin</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.27.1">This folder supports the administration features created in </span><em class="italic"><span class="kobospan2" id="kobo.28.1">Chapter 20</span></em><span class="kobospan4" id="kobo.29.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.30.1">src/config</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.31.1">This folder contains the code that provides configuration settings to the rest of the application, which is read from configuration files and environment settings.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.32.1">src/data</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.33.1">This folder contains all the functionality related to handling data.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.34.1">src/data/orm</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.35.1">This folder contains the </span><code class="inlinecode"><span class="kobospan2" id="kobo.36.1">Sequelize</span></code><span class="kobospan4" id="kobo.37.1"> implementation of the data model.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.38.1">src/data/validation</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.39.1">This folder contains the code to validate user input.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.40.1">src/helpers</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.41.1">This folder contains helpers for the logicless template package.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.42.1">src/routes</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.43.1">This folder contains the HTTP routes that match and handle requests.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.44.1">src/authentication.ts</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.45.1">The code in this file configures user authentication. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.46.1">src/errors.ts</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.47.1">The code in this file creates HTTP error responses.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.48.1">src/server.ts</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.49.1">The code in this file is executed when the SportsStore application starts and is responsible for setting up the application features and creating the HTTP server.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.50.1">src/sessions.ts</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.51.1">The code in this file sets up cookie-based HTTP sessions.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.52.1">templates</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.53.1">This folder contains templates the server will use to render content for HTML clients. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.54.1">products.json</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.55.1">This file contains product data that will be used to populate the catalog. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.56.1">server.config.json</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.57.1">This is the main configuration file for the application. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.58.1">development.env</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.59.1">This file is used to store secrets as environment variables during development.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.60.1">The structure of the </span><em class="italic"><span class="kobospan" id="kobo.61.1">SportsStore</span></em><span class="kobospan" id="kobo.62.1"> project reflects, at least in part, the way that I like to</span><a id="_idIndexMarker852" class="calibre3"/><span class="kobospan" id="kobo.63.1"> write software. </span><span class="kobospan" id="kobo.63.2">You don’t have to follow this pattern in your projects, and I encourage you to find ways to organize features such that they correspond to how you think about the problems you need to solve.</span></p>
<h1 class="heading" id="_idParaDest-279"><span class="kobospan" id="kobo.64.1">Creating the project</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.65.1">Open</span><a id="_idIndexMarker853" class="calibre3"/><span class="kobospan" id="kobo.66.1"> a new command prompt, navigate to a convenient location, and create a folder named </span><code class="inlinecode"><span class="kobospan" id="kobo.67.1">sportsstore</span></code><span class="kobospan" id="kobo.68.1">. </span><span class="kobospan" id="kobo.68.2">Navigate to the </span><code class="inlinecode"><span class="kobospan" id="kobo.69.1">sportsstore</span></code><span class="kobospan" id="kobo.70.1"> folder, run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.71.1">Listing 16.1</span></em><span class="kobospan" id="kobo.72.1"> to initialize the project, and create the </span><code class="inlinecode"><span class="kobospan" id="kobo.73.1">package.json</span></code><span class="kobospan" id="kobo.74.1"> file.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.75.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.76.1">You can download the example project for this chapter – and for all the other chapters in this book – from </span><a href="https://github.com/PacktPublishing/Mastering-Node.js-Web-Development" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.77.1">https://github.com/PacktPublishing/Mastering-Node.js-Web-Development</span></span></a><span class="kobospan" id="kobo.78.1">. </span><span class="kobospan" id="kobo.78.2">See </span><em class="italic"><span class="kobospan" id="kobo.79.1">Chapter 1</span></em><span class="kobospan" id="kobo.80.1"> for how to get help if you have problems running the examples.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.81.1">Listing 16.1: Initializing the project</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.82.1">npm init -y
</span></code></pre>
<h2 class="heading1" id="_idParaDest-280"><span class="kobospan" id="kobo.83.1">Setting up the development tools</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.84.1">I am</span><a id="_idIndexMarker854" class="calibre3"/><span class="kobospan" id="kobo.85.1"> going to start by setting up a toolchain that will monitor the TypeScript files in the project, and then compile and execute them when there is a change. </span><span class="kobospan" id="kobo.85.2">Run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.86.1">Listing 16.2</span></em><span class="kobospan" id="kobo.87.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.88.1">sportsstore</span></code><span class="kobospan" id="kobo.89.1"> folder to install the development tool packages. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.90.1">Listing 16.2: Installing the development tool packages</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.91.1">npm install --save-dev typescript@5.2.2
npm install --save-dev tsc-watch@6.0.4
npm install --save-dev nodemon@3.0.3
npm install --save-dev @tsconfig/node20
npm install --save-dev @types/node@20.6.1
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.92.1">These packages are described in </span><em class="italic"><span class="kobospan" id="kobo.93.1">Table 16.2</span></em><span class="kobospan" id="kobo.94.1"> for quick reference.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.95.1">Table 16.2: The development packages </span></p>
<table class="table-container" id="table002-13">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.96.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.97.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.98.1">typescript</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.99.1">This package contains the TypeScript compiler. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.100.1">tsc-watch</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.101.1">This package monitors the TypeScript files in a project and compiles them when there is a change. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.102.1">nodemon</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.103.1">This package monitors a wider range of file types and executes a command when a change is detected. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.104.1">@tsconfig/node20</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.105.1">This package contains a TypeScript compiler configuration file for Node.js projects. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.106.1">@types/node</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.107.1">This package contains type descriptions for the Node.js API.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.108.1">Create the </span><code class="inlinecode"><span class="kobospan" id="kobo.109.1">src</span></code><span class="kobospan" id="kobo.110.1"> folder, and add to it a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.111.1">server.ts</span></code><span class="kobospan" id="kobo.112.1"> with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.113.1">Listing 16.3</span></em><span class="kobospan" id="kobo.114.1">, which will act as a placeholder while setting up the development tools.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.115.1">Listing 16.3: The contents of the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.116.1">console.log("Hello, SportsStore");
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.117.1">To </span><a id="_idIndexMarker855" class="calibre3"/><span class="kobospan" id="kobo.118.1">configure the TypeScript compiler, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.119.1">tsconfig.json</span></code><span class="kobospan" id="kobo.120.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.121.1">sportsstore</span></code><span class="kobospan" id="kobo.122.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.123.1">Listing 16.4</span></em><span class="kobospan" id="kobo.124.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.125.1">Listing 16.4: The contents of the tsconfig.json file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.126.1">{
    "extends": "@tsconfig/node20/tsconfig.json",
     "compilerOptions": {                      
         "rootDir": "src/",  
         "outDir": "dist/"       
     },
     "include": ["src/**/*"]
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.127.1">The configuration builds on the basic settings provided by the </span><code class="inlinecode"><span class="kobospan" id="kobo.128.1">@tsconfig/node20</span></code><span class="kobospan" id="kobo.129.1"> package, specifying that the source files can be found in the </span><code class="inlinecode"><span class="kobospan" id="kobo.130.1">src</span></code><span class="kobospan" id="kobo.131.1"> folder and the compiled JavaScript files should be written to the </span><code class="inlinecode"><span class="kobospan" id="kobo.132.1">src</span></code><span class="kobospan" id="kobo.133.1"> folder.</span></p>
<p class="normal"><span class="kobospan" id="kobo.134.1">To set up the file watchers, replace the </span><code class="inlinecode"><span class="kobospan" id="kobo.135.1">scripts</span></code><span class="kobospan" id="kobo.136.1"> section of the </span><code class="inlinecode"><span class="kobospan" id="kobo.137.1">package.json</span></code><span class="kobospan" id="kobo.138.1"> file and add the </span><code class="inlinecode"><span class="kobospan" id="kobo.139.1">nodemonConfig</span></code><span class="kobospan" id="kobo.140.1"> section, as shown in </span><em class="italic"><span class="kobospan" id="kobo.141.1">Listing 16.5</span></em><span class="kobospan" id="kobo.142.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.143.1">Listing 16.5: Setting the scripts section of the package.json file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.144.1">{
  "name": "sportsstore",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
</span><strong class="screentext"><span class="kobospan" id="kobo.145.1">  "scripts": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.146.1">    "watch": "tsc-watch --noClear --onsuccess \"node dist/server.js\"",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.147.1">    "start": "nodemon --exec npm run watch"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.148.1">  },</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.149.1">  "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.150.1">nodemonConfig": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.151.1">    "ext": "js,handlebars,json",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.152.1">    "ignore": ["dist/**", "node_modules/**"]</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.153.1">  },</span></strong><span class="kobospan" id="kobo.154.1">
  "keywords": [],
  "author": "",
  "license": "ISC",
  "devDependencies": {
    "@tsconfig/node20": "^20.1.2",
    "@types/node": "^20.6.1",
    "nodemon": "^3.0.3",
    "tsc-watch": "^6.0.4",
    "typescript": "^5.2.2"
  }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.155.1">Earlier</span><a id="_idIndexMarker856" class="calibre3"/><span class="kobospan" id="kobo.156.1"> chapters used only the </span><code class="inlinecode"><span class="kobospan" id="kobo.157.1">tsc-watch</span></code><span class="kobospan" id="kobo.158.1"> package to monitor and build TypeScript files, and restart the application when there is a change. </span><span class="kobospan" id="kobo.158.2">This can be frustrating when working with other file types, such as templates, where changes do not trigger a restart. </span><span class="kobospan" id="kobo.158.3">Bundler packages, such as webpack (used in </span><em class="italic"><span class="kobospan" id="kobo.159.1">Chapter 7</span></em><span class="kobospan" id="kobo.160.1">), can be used to create complex build pipelines, but my preference is to combine </span><code class="inlinecode"><span class="kobospan" id="kobo.161.1">tsc-watch</span></code><span class="kobospan" id="kobo.162.1"> with the </span><code class="inlinecode"><span class="kobospan" id="kobo.163.1">nodemon</span></code><span class="kobospan" id="kobo.164.1"> package, which restarts a process when a file is changed. </span><span class="kobospan" id="kobo.164.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.165.1">start</span></code><span class="kobospan" id="kobo.166.1"> script uses </span><code class="inlinecode"><span class="kobospan" id="kobo.167.1">nodemon</span></code><span class="kobospan" id="kobo.168.1"> to run </span><code class="inlinecode"><span class="kobospan" id="kobo.169.1">tsc-watch</span></code><span class="kobospan" id="kobo.170.1">, which in turn starts the TypeScript compiler in watch mode. </span><span class="kobospan" id="kobo.170.2">If a TypeScript file is changed, then the TypeScript compiler compiles the TypeScript files into JavaScript, which is then executed by the </span><code class="inlinecode"><span class="kobospan" id="kobo.171.1">tsc-watch</span></code><span class="kobospan" id="kobo.172.1"> package. </span><span class="kobospan" id="kobo.172.2">If a non-TypeScript file is changed, then the </span><code class="inlinecode"><span class="kobospan" id="kobo.173.1">nodemon</span></code><span class="kobospan" id="kobo.174.1"> package restarts </span><code class="inlinecode"><span class="kobospan" id="kobo.175.1">tsc-watch</span></code><span class="kobospan" id="kobo.176.1">, which ensures that the application is restarted. </span><span class="kobospan" id="kobo.176.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.177.1">nodemonConfig</span></code><span class="kobospan" id="kobo.178.1"> section specifies the file extension that </span><code class="inlinecode"><span class="kobospan" id="kobo.179.1">nodemon</span></code><span class="kobospan" id="kobo.180.1"> reacts to and a set of directories to ignore. </span><span class="kobospan" id="kobo.180.2">This is not a perfect arrangement of tools, but it is reliable and responsive, and I have had fewer problems using these packages than when trying to configure webpack, which has some limitations when dealing with TypeScript files.</span></p>
<p class="normal"><span class="kobospan" id="kobo.181.1">Open a new command prompt, navigate to the </span><code class="inlinecode"><span class="kobospan" id="kobo.182.1">sportsstore</span></code><span class="kobospan" id="kobo.183.1"> folder, and run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.184.1">Listing 16.6</span></em><span class="kobospan" id="kobo.185.1"> to start the build process.</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.186.1">Listing 16.6: Starting the build process
</span></code></pre>
<pre class="programlisting2"><code class="hljs-code"><span class="kobospan" id="kobo.187.1">npm start
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.188.1">The </span><a id="_idIndexMarker857" class="calibre3"/><span class="kobospan" id="kobo.189.1">build tools will generate pure JavaScript files, which will be executed by Node.js, producing the following output:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.190.1">...
</span><span class="kobospan" id="kobo.190.2">Hello, SportsStore
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.191.1">Changes to files will be detected automatically, triggering a new build and then executing the output.</span></p>
<h2 class="heading1" id="_idParaDest-281"><span class="kobospan" id="kobo.192.1">Handling HTTP requests</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.193.1">The </span><a id="_idIndexMarker858" class="calibre3"/><span class="kobospan" id="kobo.194.1">next step is to add support to handle HTTP requests, which is the foundation for the SportsStore application and everything that it does. </span><span class="kobospan" id="kobo.194.2">Run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.195.1">Listing 16.7</span></em><span class="kobospan" id="kobo.196.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.197.1">sportsstore</span></code><span class="kobospan" id="kobo.198.1"> folder to add the HTTP packages. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.199.1">Listing 16.7: Installing the basic application packages</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.200.1">npm install express@4.18.2
npm install helmet@7.1.0
npm install --save-dev @types/express@4.17.20
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.201.1">These packages are described in </span><em class="italic"><span class="kobospan" id="kobo.202.1">Table 16.3</span></em><span class="kobospan" id="kobo.203.1"> for quick reference, but they provide enhancements to the basic Node.js HTTP features and set a sensible content security policy.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.204.1">Table 16.3: The HTTP handling packages </span></p>
<table class="table-container" id="table003-13">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.205.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.206.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.207.1">express</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.208.1">This package contains the Express HTTP framework, which was introduced in </span><em class="italic"><span class="kobospan2" id="kobo.209.1">Chapter 5</span></em><span class="kobospan4" id="kobo.210.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.211.1">helmet</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.212.1">This package is used to set an HTTP content security policy, as described in </span><em class="italic"><span class="kobospan2" id="kobo.213.1">Chapter 7</span></em><span class="kobospan4" id="kobo.214.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.215.1">@types/express</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.216.1">This package contains type descriptions for the Express API.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.217.1">Replace the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.218.1">server.ts</span></code><span class="kobospan" id="kobo.219.1"> file with the code shown in </span><em class="italic"><span class="kobospan" id="kobo.220.1">Listing 16.8</span></em><span class="kobospan" id="kobo.221.1"> to create a </span><a id="_idIndexMarker859" class="calibre3"/><span class="kobospan" id="kobo.222.1">basic HTTP server. </span><span class="kobospan" id="kobo.222.2">(Plain HTTP will be used for development, and HTTPS will be introduced in </span><em class="italic"><span class="kobospan" id="kobo.223.1">Chapter 21</span></em><span class="kobospan" id="kobo.224.1"> when the application is prepared for deployment.)</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.225.1">Listing 16.8: Creating a basic HTTP server in the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.226.1">import { createServer } from "http";
import express, { Express } from "express";
import helmet from "helmet";
const port = 5000;
const expressApp: Express = express();
expressApp.use(helmet());
expressApp.use(express.json());
expressApp.use(express.urlencoded({extended: true}))
expressApp.get("/", (req, resp) =&gt; {
    resp.send("Hello, SportsStore");
})
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.227.1">The new code uses Express and enables support to decode JSON and form-encoded content, using the </span><code class="inlinecode"><span class="kobospan" id="kobo.228.1">json</span></code><span class="kobospan" id="kobo.229.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.230.1">urlencoded</span></code><span class="kobospan" id="kobo.231.1"> methods. </span><span class="kobospan" id="kobo.231.2">There is a single route that handles </span><code class="inlinecode"><span class="kobospan" id="kobo.232.1">GET</span></code><span class="kobospan" id="kobo.233.1"> requests and responds with a string. </span><span class="kobospan" id="kobo.233.2">Open a web browser, request </span><code class="inlinecode"><span class="kobospan" id="kobo.234.1">http://localhost:5500</span></code><span class="kobospan" id="kobo.235.1">, and you should see the response shown in </span><em class="italic"><span class="kobospan" id="kobo.236.1">Figure 16.1</span></em><span class="kobospan" id="kobo.237.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.238.1"><img alt="" src="../Images/B21959_16_01.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.239.1">Figure 16.1: A response from the application</span></p>
<h2 class="heading1" id="_idParaDest-282"><span class="kobospan" id="kobo.240.1">Creating a configuration system</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.241.1">The port </span><a id="_idIndexMarker860" class="calibre3"/><span class="kobospan" id="kobo.242.1">on which the server listens for HTTP requests is hardcoded into the </span><code class="inlinecode"><span class="kobospan" id="kobo.243.1">server.ts</span></code><span class="kobospan" id="kobo.244.1"> file, which means that changing ports will require a new version of the application to be built and deployed. </span><span class="kobospan" id="kobo.244.2">A more flexible approach is to define settings in a configuration file, which is read when the application starts and can be modified without requiring a code change.</span></p>
<p class="normal"><span class="kobospan" id="kobo.245.1">Create the </span><code class="inlinecode"><span class="kobospan" id="kobo.246.1">src/config</span></code><span class="kobospan" id="kobo.247.1"> folder, and add to it a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.248.1">environment.ts</span></code><span class="kobospan" id="kobo.249.1">, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.250.1">Listing 16.9</span></em><span class="kobospan" id="kobo.251.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.252.1">Listing 16.9: The contents of the environment.ts file in the src/config folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.253.1">export enum Env {
    Development = "development", Production = "production"
}
export const getEnvironment = () : Env =&gt; {
    const env = process.env.NODE_ENV;
    return  env === undefined || env === Env.Development
        ? </span><span class="kobospan" id="kobo.253.2">Env.Development : Env.Production;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.254.1">Most applications require different configurations for different environments, such as development and production. </span><span class="kobospan" id="kobo.254.2">The convention for Node.js is to specify the environment using an environment variable, named </span><code class="inlinecode"><span class="kobospan" id="kobo.255.1">NODE_ENV</span></code><span class="kobospan" id="kobo.256.1">. </span><span class="kobospan" id="kobo.256.2">Applications can support as many environments as needed, but a minimal approach is to support development and production environments. </span><span class="kobospan" id="kobo.256.3">If the </span><code class="inlinecode"><span class="kobospan" id="kobo.257.1">NODE_ENV</span></code><span class="kobospan" id="kobo.258.1"> variable isn’t set or has been set to </span><code class="inlinecode"><span class="kobospan" id="kobo.259.1">development</span></code><span class="kobospan" id="kobo.260.1">, then the application is in the development environment. </span><span class="kobospan" id="kobo.260.2">The code in </span><em class="italic"><span class="kobospan" id="kobo.261.1">Listing 16.9</span></em><span class="kobospan" id="kobo.262.1"> allows the environment to be read consistently, without the need for different parts of the application to inspect and interpret environment variables.</span></p>
<p class="normal"><span class="kobospan" id="kobo.263.1">The </span><a id="_idIndexMarker861" class="calibre3"/><span class="kobospan" id="kobo.264.1">environment is important for a configuration system because it allows a base configuration file to be supplemented with settings that are specific to each environment. </span><span class="kobospan" id="kobo.264.2">The simplest way to define configuration settings is to use the JSON format, which can be parsed into JavaScript objects at runtime. </span><span class="kobospan" id="kobo.264.3">Objects read from multiple configuration files can be merged to create the overall configuration. </span><span class="kobospan" id="kobo.264.4">JavaScript doesn’t have integrated support for merging objects, so add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.265.1">merge.ts</span></code><span class="kobospan" id="kobo.266.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.267.1">src/config</span></code><span class="kobospan" id="kobo.268.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.269.1">Listing 16.10</span></em><span class="kobospan" id="kobo.270.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.271.1">Listing 16.10: The contents of the merge.ts file in the src/config folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.272.1">export const merge = (target: any, source: any) : any =&gt; {
    Object.keys(source).forEach(key =&gt; {
        if (typeof source[key] === "object"
                &amp;&amp; !Array.isArray(source[key])) {
            if (Object.hasOwn(target, key)) {
                merge(target[key], source[key]);
            } else {
                Object.assign(target, source[key])
            }
        } else {
            target[key] = source[key];
        }
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.273.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.274.1">merge</span></code><span class="kobospan" id="kobo.275.1"> function accepts </span><code class="inlinecode"><span class="kobospan" id="kobo.276.1">source</span></code><span class="kobospan" id="kobo.277.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.278.1">target</span></code><span class="kobospan" id="kobo.279.1"> objects and copies the properties defined by the </span><code class="inlinecode"><span class="kobospan" id="kobo.280.1">source</span></code><span class="kobospan" id="kobo.281.1"> object to the </span><code class="inlinecode"><span class="kobospan" id="kobo.282.1">target</span></code><span class="kobospan" id="kobo.283.1">, overriding the existing values. </span><span class="kobospan" id="kobo.283.2">Next, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.284.1">index.ts</span></code><span class="kobospan" id="kobo.285.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.286.1">src/config</span></code><span class="kobospan" id="kobo.287.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.288.1">Listing 16.11</span></em><span class="kobospan" id="kobo.289.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.290.1">Listing 16.11: The contents of the index.ts file in the src/config folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.291.1">import { readFileSync } from "fs";
import { getEnvironment, Env } from "./environment";
import { merge } from "./merge";
const file = process.env.SERVER_CONFIG ?? </span><span class="kobospan" id="kobo.291.2">"server.config.json"
const data = JSON.parse(readFileSync(file).toString());
try {
    const envFile = getEnvironment().toString() + "." </span><span class="kobospan" id="kobo.291.3">+ file;
    const envData = JSON.parse(readFileSync(envFile).toString());
    merge(data, envData);
} catch {
    // do nothing - file doesn't exist or isn't readable
}
export const getConfig = (path: string, defaultVal: any = undefined) : any =&gt; {
    const paths = path.split(":");
    let val = data;
    paths.forEach(p =&gt; val = val[p]);
    return val ?? </span><span class="kobospan" id="kobo.291.4">defaultVal;
}
export { getEnvironment, Env };
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.292.1">The </span><a id="_idIndexMarker862" class="calibre3"/><span class="kobospan" id="kobo.293.1">code in </span><em class="italic"><span class="kobospan" id="kobo.294.1">Listing 16.11</span></em><span class="kobospan" id="kobo.295.1"> uses an environment variable named </span><code class="inlinecode"><span class="kobospan" id="kobo.296.1">SERVER_CONFIG</span></code><span class="kobospan" id="kobo.297.1"> to get the name of the configuration file, falling back to </span><code class="inlinecode"><span class="kobospan" id="kobo.298.1">server.config.json</span></code><span class="kobospan" id="kobo.299.1"> if the variable isn’t defined. </span><span class="kobospan" id="kobo.299.2">The contents of the file are read and merged with an environment-specific file, the name of which is determined by appending the current environment, such as </span><code class="inlinecode"><span class="kobospan" id="kobo.300.1">production.server.config.json</span></code><span class="kobospan" id="kobo.301.1">. </span><span class="kobospan" id="kobo.301.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.302.1">getConfig</span></code><span class="kobospan" id="kobo.303.1"> function accepts a string in the form </span><code class="inlinecode"><span class="kobospan" id="kobo.304.1">http:port</span></code><span class="kobospan" id="kobo.305.1">, where keys are separated by colons (the </span><code class="inlinecode"><span class="kobospan" id="kobo.306.1">:</span></code><span class="kobospan" id="kobo.307.1"> character). </span><span class="kobospan" id="kobo.307.2">The keys are used to navigate through the configuration data to find a value. </span><span class="kobospan" id="kobo.307.3">A default value can be provided, which will be returned if a value has not been loaded from the configuration files. </span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.308.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.309.1">Environment variables can be set on most platforms, but Node.js also supports </span><code class="inlinecode"><span class="kobospan" id="kobo.310.1">.env</span></code><span class="kobospan" id="kobo.311.1"> files, which can be used to set values and are loaded with the Node </span><code class="inlinecode"><span class="kobospan" id="kobo.312.1">--env-file</span></code><span class="kobospan" id="kobo.313.1"> argument. </span><span class="kobospan" id="kobo.313.2">In </span><em class="italic"><span class="kobospan" id="kobo.314.1">Chapter 21</span></em><span class="kobospan" id="kobo.315.1">, I will set environment variables as part of the containerization process used to prepare the application for deployment.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.316.1">To start the </span><a id="_idIndexMarker863" class="calibre3"/><span class="kobospan" id="kobo.317.1">configuration, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.318.1">server.config.json</span></code><span class="kobospan" id="kobo.319.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.320.1">sportsstore</span></code><span class="kobospan" id="kobo.321.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.322.1">Listing 16.12</span></em><span class="kobospan" id="kobo.323.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.324.1">Listing 16.12: The contents of the server.config.json file in the SportsStore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.325.1">{
    "http": {
        "port": 5000
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.326.1">The configuration file defines a section named </span><code class="inlinecode"><span class="kobospan" id="kobo.327.1">http</span></code><span class="kobospan" id="kobo.328.1"> that contains a </span><code class="inlinecode"><span class="kobospan" id="kobo.329.1">port</span></code><span class="kobospan" id="kobo.330.1"> setting. </span><em class="italic"><span class="kobospan" id="kobo.331.1">Listing 16.13</span></em><span class="kobospan" id="kobo.332.1"> updates the </span><code class="inlinecode"><span class="kobospan" id="kobo.333.1">server.ts</span></code><span class="kobospan" id="kobo.334.1"> file to use this configuration setting to listen to HTTP requests, with a fallback value that will be used if no configuration setting has been defined.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.335.1">Listing 16.13: Using configuration data in the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.336.1">import { createServer } from "http";
import express, { Express } from "express";
import helmet from "helmet";
</span><strong class="screentext"><span class="kobospan" id="kobo.337.1">import { getConfig } from "./config";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.338.1">const port = getConfig("http:port", 5000);</span></strong><span class="kobospan" id="kobo.339.1">
const expressApp: Express = express();
expressApp.use(helmet());
expressApp.use(express.json());
expressApp.use(express.urlencoded({extended: true}))
expressApp.get("/", (req, resp) =&gt; {
    resp.send("Hello, SportsStore");
})
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.340.1">The </span><a id="_idIndexMarker864" class="calibre3"/><span class="kobospan" id="kobo.341.1">configuration file will be populated as new features are added, but the overall effect is to allow the settings used by the application to change without altering code files.</span></p>
<h2 class="heading1" id="_idParaDest-283"><span class="kobospan" id="kobo.342.1">Adding application routes</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.343.1">As the </span><a id="_idIndexMarker865" class="calibre3"/><span class="kobospan" id="kobo.344.1">application grows, there will be a large number of HTTP routes to define and manage, so it will be useful to introduce a structure that allows related routes to be grouped and easily located. </span><span class="kobospan" id="kobo.344.2">Create the </span><code class="inlinecode"><span class="kobospan" id="kobo.345.1">src/routes</span></code><span class="kobospan" id="kobo.346.1"> folder, and add to it a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.347.1">catalog.ts</span></code><span class="kobospan" id="kobo.348.1"> with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.349.1">Listing 16.14</span></em><span class="kobospan" id="kobo.350.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.351.1">Listing 16.14: The contents of the catalog.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.352.1">import { Express } from "express";
export const createCatalogRoutes = (app: Express) =&gt; {
    app.get("/", (req, resp) =&gt; {
        resp.send("Hello, SportsStore Route");
    })
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.353.1">This file will contain the routes that present a catalog of products to the user, but it contains a placeholder for now. </span><span class="kobospan" id="kobo.353.2">To combine the individual route modules so that they can be applied in a single step, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.354.1">index.ts</span></code><span class="kobospan" id="kobo.355.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.356.1">src/routes</span></code><span class="kobospan" id="kobo.357.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.358.1">Listing 16.15</span></em><span class="kobospan" id="kobo.359.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.360.1">Listing 16.15: The contents of the index.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.361.1">import { Express } from "express";
import { createCatalogRoutes } from "./catalog";
export const createRoutes = (app: Express) =&gt; {
    createCatalogRoutes(app);
}
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.362.1">Listing 16.16</span></em><span class="kobospan" id="kobo.363.1"> uses</span><a id="_idIndexMarker866" class="calibre3"/><span class="kobospan" id="kobo.364.1"> the new module to enable the routes it defines.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.365.1">Listing 16.16: Applying routes to the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.366.1">import { createServer } from "http";
import express, { Express } from "express";
import helmet from "helmet";
import { getConfig } from "./config";
</span><strong class="screentext"><span class="kobospan" id="kobo.367.1">import { createRoutes } from "./routes";</span></strong><span class="kobospan" id="kobo.368.1">
const port = getConfig("http:port", 5000);
const expressApp: Express = express();
expressApp.use(helmet());
expressApp.use(express.json());
expressApp.use(express.urlencoded({extended: true}))
</span><strong class="screentext"><span class="kobospan" id="kobo.369.1">// expressApp.get("/", (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.370.1">//     resp.send("Hello, SportsStore");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.371.1">// })</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.372.1">createRoutes(expressApp);</span></strong><span class="kobospan" id="kobo.373.1">
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.374.1">Use a web browser request, </span><code class="inlinecode"><span class="kobospan" id="kobo.375.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.376.1">, and you will see the response shown in </span><em class="italic"><span class="kobospan" id="kobo.377.1">Figure 16.2</span></em><span class="kobospan" id="kobo.378.1">, which shows the response has been generated by the </span><a id="_idIndexMarker867" class="calibre3"/><span class="kobospan" id="kobo.379.1">request handler defined in </span><em class="italic"><span class="kobospan" id="kobo.380.1">Listing 16.14</span></em><span class="kobospan" id="kobo.381.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.382.1"><img alt="" src="../Images/B21959_16_02.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.383.1">Figure 16.2: The effect of a separate module for routes</span></p>
<h2 class="heading1" id="_idParaDest-284"><span class="kobospan" id="kobo.384.1">Adding support for HTML templates</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.385.1">HTML templates</span><a id="_idIndexMarker868" class="calibre3"/><span class="kobospan" id="kobo.386.1"> will be used to render the content presented to the user. </span><span class="kobospan" id="kobo.386.2">Run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.387.1">Listing 16.17</span></em><span class="kobospan" id="kobo.388.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.389.1">sportsstore</span></code><span class="kobospan" id="kobo.390.1"> folder to install the packages required to support templates. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.391.1">Listing 16.17: Installing template packages</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.392.1">npm install bootstrap@5.3.2
npm install handlebars@4.7.8
npm install express-handlebars@7.1.2
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.393.1">These packages are described in </span><em class="italic"><span class="kobospan" id="kobo.394.1">Table 16.4</span></em><span class="kobospan" id="kobo.395.1"> for quick reference.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.396.1">Table 16.4: The template packages </span></p>
<table class="table-container" id="table004-9">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.397.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.398.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.399.1">bootstrap</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.400.1">This package contains CSS stylesheets that are used to style the HTML content produced by the application. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.401.1">handlebars</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.402.1">This package contains the Handlebars template engine, which was introduced in </span><em class="italic"><span class="kobospan2" id="kobo.403.1">Chapter 10</span></em><span class="kobospan4" id="kobo.404.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.405.1">express-handlebars</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.406.1">This package integrates the Handlebars template engine with the Express package.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.407.1">As explained in </span><em class="italic"><span class="kobospan" id="kobo.408.1">Chapter 10</span></em><span class="kobospan" id="kobo.409.1">, the templates rendered by the Handlebars package rely on helper functions instead of including code expressions. </span><span class="kobospan" id="kobo.409.2">Create the </span><code class="inlinecode"><span class="kobospan" id="kobo.410.1">src/helpers</span></code><span class="kobospan" id="kobo.411.1"> folder, and add to it a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.412.1">env.ts</span></code><span class="kobospan" id="kobo.413.1"> with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.414.1">Listing 16.18</span></em><span class="kobospan" id="kobo.415.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.416.1">Listing 16.18: The contents of the env.ts file in the src/helpers folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.417.1">import { Env, getEnvironment } from "../config";
export const isDevelopment = (value: any) =&gt; {
    return getEnvironment() === Env.Development
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.418.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.419.1">isDevelopment</span></code><span class="kobospan" id="kobo.420.1"> helper </span><a id="_idIndexMarker869" class="calibre3"/><span class="kobospan" id="kobo.421.1">can be used to determine whether the application has been configured for development or production. </span><span class="kobospan" id="kobo.421.2">To set up the template system, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.422.1">index.ts</span></code><span class="kobospan" id="kobo.423.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.424.1">src/helpers</span></code><span class="kobospan" id="kobo.425.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.426.1">Listing 16.19</span></em><span class="kobospan" id="kobo.427.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.428.1">Listing 16.19. </span><span class="kobospan" id="kobo.428.2">The contents of the index.ts file in the src/helpers folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.429.1">import { Express } from "express";
import { getConfig } from "../config";
import { engine } from "express-handlebars";
import * as env_helpers from "./env";
const location = getConfig("templates:location");
const config = getConfig("templates:config");
export const createTemplates = (app: Express) =&gt; {
    app.set("views", location);
    app.engine("handlebars", engine({
        ...config, helpers: {...env_helpers }
    }));
    app.set("view engine", "handlebars");
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.430.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.431.1">createTemplates</span></code><span class="kobospan" id="kobo.432.1"> function configures the template engine and registers it with Express. </span><span class="kobospan" id="kobo.432.2">Add the settings to the configuration file, as shown in </span><em class="italic"><span class="kobospan" id="kobo.433.1">Listing 16.20</span></em><span class="kobospan" id="kobo.434.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.435.1">Listing 16.20: Adding settings to the server.config.json file in the SportsStore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.436.1">{
    "http": {
        "port": 5000
    },
    </span><strong class="screentext"><span class="kobospan" id="kobo.437.1">"templates": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.438.1">        "location": "templates",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.439.1">        "config": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.440.1">            "layoutsDir": "templates",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.441.1">            "defaultLayout":</span></strong><strong class="screentext"><span class="kobospan" id="kobo.442.1"> "main_layout.handlebars",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.443.1">            "partialsDir": "templates"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.444.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.445.1">    }</span></strong><span class="kobospan" id="kobo.446.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.447.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.448.1">getConfig</span></code><span class="kobospan" id="kobo.449.1"> function defined in </span><em class="italic"><span class="kobospan" id="kobo.450.1">Listing 16.11</span></em><span class="kobospan" id="kobo.451.1"> can be used to get entire configuration </span><a id="_idIndexMarker870" class="calibre3"/><span class="kobospan" id="kobo.452.1">sections, as well as individual values, and these sections can be used to directly configure packages. </span><span class="kobospan" id="kobo.452.2">This statement is used to get a configuration section:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.453.1">...
</span><span class="kobospan" id="kobo.453.2">const </span><strong class="screentext"><span class="kobospan" id="kobo.454.1">config</span></strong><span class="kobospan" id="kobo.455.1"> = getConfig("templates:config");
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.456.1">The result is an object whose properties correspond to the </span><code class="inlinecode"><span class="kobospan" id="kobo.457.1">templates:config</span></code><span class="kobospan" id="kobo.458.1"> section of the configuration file, which has been parsed from JSON into a JavaScript object and is used to configure the template engine:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.459.1">...
</span><span class="kobospan" id="kobo.459.2">app.engine("handlebars", engine({
    ...</span><strong class="screentext"><span class="kobospan" id="kobo.460.1">config</span></strong><span class="kobospan" id="kobo.461.1">, helpers: {...env_helpers }
}));
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.462.1">The properties read from the configuration file are combined with the helper functions imported from the </span><code class="inlinecode"><span class="kobospan" id="kobo.463.1">helpers</span></code><span class="kobospan" id="kobo.464.1"> module.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.465.1">Note</span></strong></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.466.1">Listing 16.20</span></em><span class="kobospan" id="kobo.467.1"> configures the template engine so that templates, partials, and layouts are all in the same folder. </span><span class="kobospan" id="kobo.467.2">This is not a requirement, but I prefer to keep the files together and use the filename to indicate the content rendered by a template.</span></p>
</div>
<h3 class="heading2" id="_idParaDest-285"><span class="kobospan" id="kobo.468.1">Creating layouts and templates</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.469.1">Create</span><a id="_idIndexMarker871" class="calibre3"/><span class="kobospan" id="kobo.470.1"> the </span><code class="inlinecode"><span class="kobospan" id="kobo.471.1">sportsstore/templates</span></code><span class="kobospan" id="kobo.472.1"> folder, and add to it a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.473.1">index.handlebars</span></code><span class="kobospan" id="kobo.474.1"> with the</span><a id="_idIndexMarker872" class="calibre3"/><span class="kobospan" id="kobo.475.1"> placeholder contents shown in </span><em class="italic"><span class="kobospan" id="kobo.476.1">Listing 16.21</span></em><span class="kobospan" id="kobo.477.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.478.1">Listing 16.21: The contents of the index.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.479.1">&lt;div class="h4 m-2"&gt;Hello, SportsStore&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.480.1">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.481.1">main_layout.handlebars</span></code><span class="kobospan" id="kobo.482.1"> to the templates folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.483.1">Listing 16.22</span></em><span class="kobospan" id="kobo.484.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.485.1">Listing 16.22: The contents of the main_layout.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.486.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;link href="/css/bootstrap.min.css" rel="stylesheet" /&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="bg-dark text-white p-2"&gt;
            &lt;span class="navbar-brand ml-2"&gt;SPORTS STORE&lt;/span&gt;
        &lt;/div&gt;
        {{{ body }}}
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.487.1">The layout contains an HTML document that includes a </span><code class="inlinecode"><span class="kobospan" id="kobo.488.1">link</span></code><span class="kobospan" id="kobo.489.1"> element for the CSS stylesheet from the </span><code class="inlinecode"><span class="kobospan" id="kobo.490.1">Bootstrap</span></code><span class="kobospan" id="kobo.491.1"> package and a </span><em class="italic"><span class="kobospan" id="kobo.492.1">SportsStore</span></em><span class="kobospan" id="kobo.493.1"> header. </span><em class="italic"><span class="kobospan" id="kobo.494.1">Listing 16.23</span></em><span class="kobospan" id="kobo.495.1"> completes the setup for the templates.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.496.1">Listing 16.23: Completing the template setup in the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.497.1">import { createServer } from "http";
import express, { Express } from "express";
import helmet from "helmet";
import { getConfig } from "./config";
import { createRoutes } from "./routes";
i</span><strong class="screentext"><span class="kobospan" id="kobo.498.1">mport { createTemplates } from "./helpers";</span></strong><span class="kobospan" id="kobo.499.1">
const port = getConfig("http:port", 5000);
const expressApp: Express = express();
expressApp.use(helmet());
expressApp.use(express.json());
expressApp.use(express.urlencoded({extended: true}))
</span><strong class="screentext"><span class="kobospan" id="kobo.500.1">expressApp.use(express.static("node_modules/bootstrap/dist"));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.501.1">createTemplates(expressApp);</span></strong><span class="kobospan" id="kobo.502.1">
createRoutes(expressApp);
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.503.1">In </span><a id="_idIndexMarker873" class="calibre3"/><span class="kobospan" id="kobo.504.1">addition to calling the </span><code class="inlinecode"><span class="kobospan" id="kobo.505.1">createTemplates</span></code><span class="kobospan" id="kobo.506.1"> function, </span><em class="italic"><span class="kobospan" id="kobo.507.1">Listing 16.23</span></em><span class="kobospan" id="kobo.508.1"> uses the Express </span><code class="inlinecode"><span class="kobospan" id="kobo.509.1">static</span></code><span class="kobospan" id="kobo.510.1"> middleware to serve content </span><a id="_idIndexMarker874" class="calibre3"/><span class="kobospan" id="kobo.511.1">from the Bootstrap package. </span><em class="italic"><span class="kobospan" id="kobo.512.1">Listing 16.24</span></em><span class="kobospan" id="kobo.513.1"> uses a template to render a response instead of returning a plain string.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.514.1">Listing 16.24: Using a template in the catalog.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.515.1">import { Express } from "express";
export const createCatalogRoutes = (app: Express) =&gt; {
    app.get("/", (req, resp) =&gt; {
        </span><strong class="screentext"><span class="kobospan" id="kobo.516.1">//resp.send("Hello, SportsStore Route");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.517.1">        resp.render("index");</span></strong><span class="kobospan" id="kobo.518.1">
    })
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.519.1">Use a </span><a id="_idIndexMarker875" class="calibre3"/><span class="kobospan" id="kobo.520.1">browser</span><a id="_idIndexMarker876" class="calibre3"/><span class="kobospan" id="kobo.521.1"> to request </span><code class="inlinecode"><span class="kobospan" id="kobo.522.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.523.1">, and you will see the response shown in </span><em class="italic"><span class="kobospan" id="kobo.524.1">Figure 16.3</span></em><span class="kobospan" id="kobo.525.1">, which is produced using a template and a layout.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.526.1"><img alt="" src="../Images/B21959_16_03.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.527.1">Figure 16.3: Adding layouts to the application</span></p>
<h2 class="heading1" id="_idParaDest-286"><span class="kobospan" id="kobo.528.1">Creating error handlers</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.529.1">Express </span><a id="_idIndexMarker877" class="calibre3"/><span class="kobospan" id="kobo.530.1">includes support to generate responses when a request is made for a URL for which there is no handler, or when a handler throws an error. </span><span class="kobospan" id="kobo.530.2">To demonstrate the default error handlers and prepare for custom replacements, </span><em class="italic"><span class="kobospan" id="kobo.531.1">Listing 16.25</span></em><span class="kobospan" id="kobo.532.1"> defines routes that always create errors. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.533.1">Listing 16.25: Creating errors in the catalog.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.534.1">import { Express } from "express";
export const createCatalogRoutes = (app: Express) =&gt; {
    app.get("/", (req, resp) =&gt; {
        resp.render("index");
    })
    </span><strong class="screentext"><span class="kobospan" id="kobo.535.1">app.get("/err", (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.536.1">        throw new Error ("Something bad happened");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.537.1">    });</span></strong>
<strong class="screentext"> </strong>
<strong class="screentext"><span class="kobospan" id="kobo.538.1">    app.get("/asyncerr"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.539.1">, async (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.540.1">        throw new Error ("Something bad happened asynchronously");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.541.1">    });</span></strong><span class="kobospan" id="kobo.542.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.543.1">Use a </span><a id="_idIndexMarker878" class="calibre3"/><span class="kobospan" id="kobo.544.1">browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.545.1">http://localhost:5000/nosuchfile</span></code><span class="kobospan" id="kobo.546.1">, and you will see the default response created by Express, which is shown on the left side of </span><em class="italic"><span class="kobospan" id="kobo.547.1">Figure 16.3</span></em><span class="kobospan" id="kobo.548.1">. </span><span class="kobospan" id="kobo.548.2">This error is shown when no handler generates a response. </span><span class="kobospan" id="kobo.548.3">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.549.1">http://localhost:5000/err</span></code><span class="kobospan" id="kobo.550.1">, and you will see the other error message shown in </span><em class="italic"><span class="kobospan" id="kobo.551.1">Figure 16.4</span></em><span class="kobospan" id="kobo.552.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.553.1"><img alt="" src="../Images/B21959_16_04.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.554.1">Figure 16.4: A default Express error message</span></p>
<p class="normal"><span class="kobospan" id="kobo.555.1">The handler for errors doesn’t deal with errors thrown by asynchronous handlers. </span><span class="kobospan" id="kobo.555.2">You can see the problem by requesting </span><code class="inlinecode"><span class="kobospan" id="kobo.556.1">http://localhost:5000/asyncerr</span></code><span class="kobospan" id="kobo.557.1">. </span><span class="kobospan" id="kobo.557.2">A stack trace will be written at the Node.js console, but no response is sent to the browser, which will eventually assume that the application has refused to accept the HTTP request.</span></p>
<p class="normal"><span class="kobospan" id="kobo.558.1">There is an </span><a id="_idIndexMarker879" class="calibre3"/><span class="kobospan" id="kobo.559.1">excellent package that adds support for errors in asynchronous handlers. </span><span class="kobospan" id="kobo.559.2">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.560.1">Listing 16.26</span></em><span class="kobospan" id="kobo.561.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.562.1">sportsstore</span></code><span class="kobospan" id="kobo.563.1"> folder to add the package, which is called </span><code class="inlinecode"><span class="kobospan" id="kobo.564.1">express-async-errors</span></code><span class="kobospan" id="kobo.565.1">, to the project.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.566.1">Listing 16.26: Adding the asynchronous error package</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.567.1">npm install express-async-errors@3.1.1
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.568.1">For quick reference, this package is described in </span><em class="italic"><span class="kobospan" id="kobo.569.1">Table 16.5</span></em><span class="kobospan" id="kobo.570.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.571.1">Table 16.5: The errors package</span></p>
<table class="table-container" id="table005-8">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.572.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.573.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.574.1">express-async-errors</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.575.1">This package adds support to process errors produced by asynchronous request handlers. </span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.576.1">The custom error handlers will use templates to display formatted responses. </span><span class="kobospan" id="kobo.576.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.577.1">not_found.handlebars</span></code><span class="kobospan" id="kobo.578.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.579.1">templates</span></code><span class="kobospan" id="kobo.580.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.581.1">Listing 16.27</span></em><span class="kobospan" id="kobo.582.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.583.1">Listing 16.27: The contents of the not_found.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.584.1">&lt;div class="h2 bg-danger text-white text-center p-2 my-2"&gt;
    404 - Not Found
&lt;/div&gt;
&lt;div class="text-center"&gt;
    &lt;a class="btn btn-secondary" href="/"&gt;OK&lt;/a&gt;
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.585.1">This template will be rendered when a request isn’t matched by a route. </span><span class="kobospan" id="kobo.585.2">It doesn’t include any dynamic content, but it will be displayed within the default layout. </span><span class="kobospan" id="kobo.585.3">Next, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.586.1">error.handlebars</span></code><span class="kobospan" id="kobo.587.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.588.1">templates</span></code><span class="kobospan" id="kobo.589.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.590.1">Listing 16.28</span></em><span class="kobospan" id="kobo.591.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.592.1">Listing 16.28: The contents of the error.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.593.1">&lt;div class="h2 bg-danger text-white text-center p-2 my-2"&gt;
    500 - Error
&lt;/div&gt;
&lt;div class="text-center"&gt;
    &lt;a class="btn btn-secondary" href="/"&gt;OK&lt;/a&gt;
&lt;/div&gt;
{{#if (isDevelopment) }}
    &lt;div class="h4 bg-danger text-white p-1 mt-2"&gt;Error Details&lt;/div&gt;
    &lt;div class="h5 p-1"&gt;Message: {{ error.message }}&lt;/div&gt;
    &lt;div class="font-monospace p-1"&gt;{{error.stack}}&lt;/div&gt;
 {{/if }}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.594.1">This </span><a id="_idIndexMarker880" class="calibre3"/><span class="kobospan" id="kobo.595.1">template uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.596.1">isDevelopment</span></code><span class="kobospan" id="kobo.597.1"> helper to include details of the error when the application is configured in the development environment. </span><em class="italic"><span class="kobospan" id="kobo.598.1">Listing 16.29</span></em><span class="kobospan" id="kobo.599.1"> adds a new configuration section that specifies the error template files.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.600.1">Listing 16.29: Adding a configuration section to the server.config.json file in the SportsStore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.601.1">{
    "http": {
        "port": 5000
    },
    "templates": {
        "location": "templates",
        "config": {
            "layoutsDir": "templates",
            "defaultLayout": "main_layout.handlebars",
            "partialsDir": "templates"
        }
    },
   </span><strong class="screentext"><span class="kobospan" id="kobo.602.1"> "errors": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.603.1">        "400": "not_found",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.604.1">        "500": "error"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.605.1">    }   </span></strong><span class="kobospan" id="kobo.606.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.607.1">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.608.1">errors.ts</span></code><span class="kobospan" id="kobo.609.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.610.1">src</span></code><span class="kobospan" id="kobo.611.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.612.1">Listing 16.30</span></em><span class="kobospan" id="kobo.613.1">. </span><span class="kobospan" id="kobo.613.2">This file imports the </span><code class="inlinecode"><span class="kobospan" id="kobo.614.1">express-async-errors</span></code><span class="kobospan" id="kobo.615.1"> module, which is all that’s required to use the package, and defines error handlers that use templates to generate</span><a id="_idIndexMarker881" class="calibre3"/><span class="kobospan" id="kobo.616.1"> responses.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.617.1">Listing 16.30: The contents of the errors.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.618.1">import { Express, ErrorRequestHandler } from "express";
import { getConfig } from "./config";
import "express-async-errors";
const template400 = getConfig("errors:400");
const template500 = getConfig("errors:500");
export const createErrorHandlers = (app: Express) =&gt; {
    app.use((req, resp) =&gt; {
        resp.statusCode = 404;
        resp.render(template400);
    });
    const handler: ErrorRequestHandler = (error, req, resp, next) =&gt; {
        console.log(error);
        if (resp.headersSent) {
            return next(error);
        }
        try {
            resp.statusCode = 500;
            resp.render(template500, { error} );
        } catch (newErr) {
            next(error);
        }
    }
    app.use(handler);
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.619.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.620.1">createErrorHandlers</span></code><span class="kobospan" id="kobo.621.1"> function sets up a request handler that will generate a 404 response, and that will be the last handler to run when a request is received. </span><span class="kobospan" id="kobo.621.2">There is also an error handler, which works like a middleware component but with an additional </span><code class="inlinecode"><span class="kobospan" id="kobo.622.1">error</span></code><span class="kobospan" id="kobo.623.1"> parameter. </span><span class="kobospan" id="kobo.623.2">There is a danger that something will go wrong when rendering an error response, in which case the default error handler will be used. </span><span class="kobospan" id="kobo.623.3">To prevent the new error from being the one displayed to the user, a try/catch block is used, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.624.1">catch</span></code><span class="kobospan" id="kobo.625.1"> clause invokes the </span><code class="inlinecode"><span class="kobospan" id="kobo.626.1">next</span></code><span class="kobospan" id="kobo.627.1"> method using the original error, which tells Express which error needs to be processed.</span></p>
<p class="normal"><span class="kobospan" id="kobo.628.1">To </span><a id="_idIndexMarker882" class="calibre3"/><span class="kobospan" id="kobo.629.1">complete the setup, </span><em class="italic"><span class="kobospan" id="kobo.630.1">Listing 16.31</span></em><span class="kobospan" id="kobo.631.1"> calls the </span><code class="inlinecode"><span class="kobospan" id="kobo.632.1">createErrorHandlers</span></code><span class="kobospan" id="kobo.633.1"> function as part of the application startup.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.634.1">Listing 16.31: Setting up error handlers in the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.635.1">import { createServer } from "http";
import express, { Express } from "express";
import helmet from "helmet";
import { getConfig } from "./config";
import { createRoutes } from "./routes";
import { createTemplates } from "./helpers";
</span><strong class="screentext"><span class="kobospan" id="kobo.636.1">import { createErrorHandlers } from "./errors";</span></strong><span class="kobospan" id="kobo.637.1">
const port = getConfig("http:port", 5000);
const expressApp: Express = express();
expressApp.use(helmet());
expressApp.use(express.json());
expressApp.use(express.urlencoded({extended: true}))
expressApp.use(express.static("node_modules/bootstrap/dist"));
createTemplates(expressApp);
createRoutes(expressApp);
</span><strong class="screentext"><span class="kobospan" id="kobo.638.1">createErrorHandlers</span></strong><strong class="screentext"><span class="kobospan" id="kobo.639.1">(expressApp);</span></strong><span class="kobospan" id="kobo.640.1">
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.641.1">Save the changes, and use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.642.1">http://localhost:5000/nosuchfile</span></code><span class="kobospan" id="kobo.643.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.644.1">http://localhost:5000/err</span></code><span class="kobospan" id="kobo.645.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.646.1">http://localhost:5000/asyncerr</span></code><span class="kobospan" id="kobo.647.1">. </span><span class="kobospan" id="kobo.647.2">Asynchronous errors are now handled correctly, and users will </span><a id="_idIndexMarker883" class="calibre3"/><span class="kobospan" id="kobo.648.1">see the custom error responses, which are shown in </span><em class="italic"><span class="kobospan" id="kobo.649.1">Figure 16.5</span></em><span class="kobospan" id="kobo.650.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.651.1"><img alt="" src="../Images/B21959_16_05.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.652.1">Figure 16.5: Custom error responses</span></p>
<h1 class="heading" id="_idParaDest-287"><span class="kobospan" id="kobo.653.1">Starting the data model</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.654.1">Once the</span><a id="_idIndexMarker884" class="calibre3"/><span class="kobospan" id="kobo.655.1"> basic building blocks are in place, it is time to start working on the data model. </span><span class="kobospan" id="kobo.655.2">For the SportsStore </span><a id="_idIndexMarker885" class="calibre3"/><span class="kobospan" id="kobo.656.1">application, the key data is a catalog of products from which customers will make selections. </span><span class="kobospan" id="kobo.656.2">Run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.657.1">Listing 16.32</span></em><span class="kobospan" id="kobo.658.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.659.1">sportsstore</span></code><span class="kobospan" id="kobo.660.1"> folder to install the data storage packages. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.661.1">Listing 16.32: Adding data storage packages</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.662.1">npm install sqlite3@5.1.6
npm install sequelize@6.35.1
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.663.1">For quick reference, these packages are described in </span><em class="italic"><span class="kobospan" id="kobo.664.1">Table 16.6</span></em><span class="kobospan" id="kobo.665.1">. </span><span class="kobospan" id="kobo.665.2">I am going to use SQLite during development because it is easy to set up and then change to PostgreSQL, which is a more conventional database server, in </span><em class="italic"><span class="kobospan" id="kobo.666.1">Chapter 21</span></em><span class="kobospan" id="kobo.667.1"> to prepare for deployment.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.668.1">Table 16.6: The data packages </span></p>
<table class="table-container" id="table006-6">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.669.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.670.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.671.1">sqlite3</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.672.1">This package contains the SQLite database manager, which stores its data in a file and was first used in </span><em class="italic"><span class="kobospan2" id="kobo.673.1">Chapter 12</span></em><span class="kobospan4" id="kobo.674.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.675.1">sequelize</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.676.1">This package contains the </span><code class="inlinecode"><span class="kobospan2" id="kobo.677.1">Sequelize</span></code><span class="kobospan" id="kobo.678.1"> ORM framework, which maps between relational data and JavaScript objects and was introduced in </span><em class="italic"><span class="kobospan2" id="kobo.679.1">Chapter 12</span></em><span class="kobospan4" id="kobo.680.1">. </span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.681.1">There</span><a id="_idIndexMarker886" class="calibre3"/><span class="kobospan" id="kobo.682.1"> are different ways to create data models for web applications. </span><span class="kobospan" id="kobo.682.2">As I explained in </span><em class="italic"><span class="kobospan" id="kobo.683.1">Chapter 12</span></em><span class="kobospan" id="kobo.684.1">, I like to use a </span><a id="_idIndexMarker887" class="calibre3"/><span class="kobospan" id="kobo.685.1">repository that allows the details of how the data is stored to be hidden from the rest of the application. </span><span class="kobospan" id="kobo.685.2">Create the </span><code class="inlinecode"><span class="kobospan" id="kobo.686.1">src/data</span></code><span class="kobospan" id="kobo.687.1"> folder, and add to it a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.688.1">catalog_models.ts</span></code><span class="kobospan" id="kobo.689.1"> file with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.690.1">Listing 16.33</span></em><span class="kobospan" id="kobo.691.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.692.1">Listing 16.33: The contents of the catalog_models.ts file in the src/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.693.1">export interface  Product {
    id?: number;
    name: string;
    description: string;
    price: number;
   
    category?: Category;
    supplier?: Supplier;
}
export interface Category {
    id?: number;
    name: string;
    products?: Product[];
}
export interface Supplier {
    id?: number;
    name: string;
   
    products?: Product[];
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.694.1">This file defines three model interfaces that provide the building blocks for a basic product catalog. </span><span class="kobospan" id="kobo.694.2">A real online store would have a more complex data model, but</span><a id="_idIndexMarker888" class="calibre3"/><span class="kobospan" id="kobo.695.1"> much of the additional complexity relates to external processes, such as procurement, dispatch, customer service, and so on, which won’t be part of the </span><em class="italic"><span class="kobospan" id="kobo.696.1">SportsStore</span></em><span class="kobospan" id="kobo.697.1"> application. </span><span class="kobospan" id="kobo.697.2">These</span><a id="_idIndexMarker889" class="calibre3"/><span class="kobospan" id="kobo.698.1"> three interfaces in </span><em class="italic"><span class="kobospan" id="kobo.699.1">Listing 16.33</span></em><span class="kobospan" id="kobo.700.1"> are enough to get started. </span><span class="kobospan" id="kobo.700.2">To describe a repository, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.701.1">catalog_repository.ts</span></code><span class="kobospan" id="kobo.702.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.703.1">src/data</span></code><span class="kobospan" id="kobo.704.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.705.1">Listing 16.34</span></em><span class="kobospan" id="kobo.706.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.707.1">Listing 16.34: The contents of the catalog_repository.ts file in the src/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.708.1">import { Category, Product, Supplier } from "./catalog_models";
export interface CatalogRepository {
    getProducts(): Promise&lt;Product[]&gt;;
    storeProduct(p: Product): Promise&lt;Product&gt;;
    getCategories() : Promise&lt;Category[]&gt;;
    storeCategory(c: Category): Promise&lt;Category&gt;;
    getSuppliers(): Promise&lt;Supplier[]&gt;;
    storeSupplier(s: Supplier): Promise&lt;Supplier&gt;;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.709.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.710.1">CatalogRepository</span></code><span class="kobospan" id="kobo.711.1"> interface defines methods to query and store objects that implement the </span><code class="inlinecode"><span class="kobospan" id="kobo.712.1">Product</span></code><span class="kobospan" id="kobo.713.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.714.1">Category</span></code><span class="kobospan" id="kobo.715.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.716.1">Supplier</span></code><span class="kobospan" id="kobo.717.1"> interfaces.</span></p>
<h2 class="heading1" id="_idParaDest-288"><span class="kobospan" id="kobo.718.1">Implementing the repository</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.719.1">The </span><a id="_idIndexMarker890" class="calibre3"/><span class="kobospan" id="kobo.720.1">use of a repository means that the details of how data is stored don’t have to align with how data is used by the rest of the application. </span><span class="kobospan" id="kobo.720.2">In </span><em class="italic"><span class="kobospan" id="kobo.721.1">Chapter 12</span></em><span class="kobospan" id="kobo.722.1">, for example, I used a set of conversion functions to convert the data read from the database into the format expected by the rest of the application. </span><span class="kobospan" id="kobo.722.2">This works well because it means that the application gets data in a format that is natural to work with, and the repository gets data that is easily stored and queried. </span><span class="kobospan" id="kobo.722.3">The downside is that data must be transformed as it passes between the repository and the rest of the application.</span></p>
<p class="normal"><span class="kobospan" id="kobo.723.1">An </span><a id="_idIndexMarker891" class="calibre3"/><span class="kobospan" id="kobo.724.1">alternative approach is to implement the repository so that it stores data without transformation, ensuring that the results of querying the database, for example, are objects whose type matches the expectations of the rest of the application. </span><span class="kobospan" id="kobo.724.2">This approach doesn’t require conversion functions, but it can require some effort to override the default behavior of the ORM package. </span><span class="kobospan" id="kobo.724.3">This is the approach that I am going to take for the SportsStore application.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.725.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.726.1">This isn’t an issue if you are using an object database, such as MongoDB, or if you are writing native SQL queries without using an ORM package. </span><span class="kobospan" id="kobo.726.2">However, as noted in </span><em class="italic"><span class="kobospan" id="kobo.727.1">Chapter 12</span></em><span class="kobospan" id="kobo.728.1">, relational databases are used by the majority of projects, and ORM packages allow developers to perform complex queries without needing deep SQL knowledge.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.729.1">To get started, create the </span><code class="inlinecode"><span class="kobospan" id="kobo.730.1">src/data/orm/models</span></code><span class="kobospan" id="kobo.731.1"> folder, and add to it a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.732.1">catalog_models.ts</span></code><span class="kobospan" id="kobo.733.1">, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.734.1">Listing 16.35</span></em><span class="kobospan" id="kobo.735.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.736.1">Listing 16.35: The contents of the catalog_models.ts file in the src/data/orm/models folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.737.1">import { Model, CreationOptional, ForeignKey, InferAttributes,
    InferCreationAttributes  } from "sequelize";
export class ProductModel extends Model&lt;InferAttributes&lt;ProductModel&gt;,
        InferCreationAttributes&lt;ProductModel&gt;&gt; {
    declare id?: CreationOptional&lt;number&gt;;
    declare name: string;
    declare description: string;
    declare price: number;
    declare categoryId: ForeignKey&lt;CategoryModel["id"]&gt;;
    declare supplierId: ForeignKey&lt;SupplierModel["id"]&gt;;
    declare category?: InferAttributes&lt;CategoryModel&gt;
    declare supplier?: InferAttributes&lt;SupplierModel&gt;
}
export class CategoryModel extends Model&lt;InferAttributes&lt;CategoryModel&gt;,
        InferCreationAttributes&lt;CategoryModel&gt;&gt;   {
    declare id?: CreationOptional&lt;number&gt;;
    declare name: string;
   
    declare products?:  InferAttributes&lt;ProductModel&gt;[];
}
export class SupplierModel extends Model&lt;InferAttributes&lt;SupplierModel&gt;,
        InferCreationAttributes&lt;SupplierModel&gt;&gt;  {
    declare id?: CreationOptional&lt;number&gt;;  
    declare name: string;
    declare products?:  InferAttributes&lt;ProductModel&gt;[];
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.738.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.739.1">ProductModel</span></code><span class="kobospan" id="kobo.740.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.741.1">CategoryModel</span></code><span class="kobospan" id="kobo.742.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.743.1">SupplierModel</span></code><span class="kobospan" id="kobo.744.1"> classes conform to the interfaces</span><a id="_idIndexMarker892" class="calibre3"/><span class="kobospan" id="kobo.745.1"> defined in </span><em class="italic"><span class="kobospan" id="kobo.746.1">Listing 16.33</span></em><span class="kobospan" id="kobo.747.1">, with some additions required for storage in a relational database, which means that the objects created by the ORM package will have a superset of the properties expected by the rest of the application – notably, the </span><code class="inlinecode"><span class="kobospan" id="kobo.748.1">categoryId</span></code><span class="kobospan" id="kobo.749.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.750.1">supplierId</span></code><span class="kobospan" id="kobo.751.1"> properties defined by the </span><code class="inlinecode"><span class="kobospan" id="kobo.752.1">ProductModel</span></code><span class="kobospan" id="kobo.753.1"> class, which represent relationships between tables in the database.</span></p>
<p class="normal"><span class="kobospan" id="kobo.754.1">To describe the format and relationships between the model classes, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.755.1">catalog_helpers.ts</span></code><span class="kobospan" id="kobo.756.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.757.1">src/data/orm/models</span></code><span class="kobospan" id="kobo.758.1"> folder </span><a id="_idIndexMarker893" class="calibre3"/><span class="kobospan" id="kobo.759.1">with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.760.1">Listing 16.36</span></em><span class="kobospan" id="kobo.761.1">.</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.762.1">The iterative process of defining a data model</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.763.1">Figuring out the </span><code class="inlinecode"><span class="kobospan" id="kobo.764.1">Sequelize</span></code><span class="kobospan" id="kobo.765.1"> configuration for this example took a couple of hours of trial and error, which is not easily conveyed in the linear progression shown by a book example. </span><span class="kobospan" id="kobo.765.2">I wrote the code in </span><em class="italic"><span class="kobospan" id="kobo.766.1">Listing 16.35</span></em><span class="kobospan" id="kobo.767.1"> at the same time as the initial implementation of the repository. </span><span class="kobospan" id="kobo.767.2">This allowed me to make sure that the data storage and queries worked as expected, and to reset the database each time I made a change.</span></p>
<p class="normal"><span class="kobospan" id="kobo.768.1">There are two challenges in this process: ensuring that the database schema makes sense and that results conform to the model interfaces.</span></p>
<p class="normal"><span class="kobospan" id="kobo.769.1">To check the schema, I use the excellent DB Browser for SQLite (</span><a href="https://sqlitebrowser.org" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.770.1">https://sqlitebrowser.org</span></span></a><span class="kobospan" id="kobo.771.1">) package, which allows SQLite databases to be opened and inspected. </span><span class="kobospan" id="kobo.771.2">This allows me to check that I have configured </span><code class="inlinecode"><span class="kobospan" id="kobo.772.1">Sequelize</span></code><span class="kobospan" id="kobo.773.1"> to correctly create the relationships between tables, and it also allows me to check that data is written as it should be.</span></p>
<p class="normal"><span class="kobospan" id="kobo.774.1">To check that data objects are created correctly, I query the database and write out the results as JSON data. </span><span class="kobospan" id="kobo.774.2">This reveals the structure of the objects created by </span><code class="inlinecode"><span class="kobospan" id="kobo.775.1">Sequelize</span></code><span class="kobospan" id="kobo.776.1"> and lets me see how columns in the database are represented as JavaScript object properties.</span></p>
<p class="normal"><span class="kobospan" id="kobo.777.1">Once you have confirmed that </span><code class="inlinecode"><span class="kobospan" id="kobo.778.1">Sequelize</span></code><span class="kobospan" id="kobo.779.1"> creates data objects correctly, the final step is to make sure that you have described those objects accurately with the </span><code class="inlinecode"><span class="kobospan" id="kobo.780.1">declare</span></code><span class="kobospan" id="kobo.781.1"> keyword. </span><span class="kobospan" id="kobo.781.2">Bear in mind that the TypeScript annotations applied to the model classes are not used by </span><code class="inlinecode"><span class="kobospan" id="kobo.782.1">Sequelize</span></code><span class="kobospan" id="kobo.783.1"> and only exist so that the TypeScript compiler can check the way that data is used. </span><span class="kobospan" id="kobo.783.2">The type annotations have no effect at runtime because </span><code class="inlinecode"><span class="kobospan" id="kobo.784.1">Sequelize</span></code><span class="kobospan" id="kobo.785.1"> creates objects dynamically, so it is important to confirm that the data is stored and retrieved as you intended and that the type annotations correctly describe those processes.</span></p>
</div>
<div class="note">
<p class="normal"><span class="kobospan" id="kobo.786.1">This can be a time-consuming process – and for some, it is an argument in favor of object databases – but working methodically and checking the results after each change will keep you on the right path.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.787.1">Listing 16.36: The contents of the catalog_helpers.ts file in the src/data/orm/models folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.788.1">import { DataTypes, Sequelize } from "sequelize";
import { CategoryModel, ProductModel, SupplierModel } from "./catalog_models";
const primaryKey = {
    id: { type: DataTypes.INTEGER, autoIncrement: true, primaryKey: true }
};
export const initializeCatalogModels = (sequelize: Sequelize) =&gt; {
    ProductModel.init({
        ...primaryKey,
        name: { type: DataTypes.STRING},       
        description: { type: DataTypes.STRING},
        price: { type: DataTypes.DECIMAL(10, 2) }
    }, { sequelize })
    CategoryModel.init({
        ...primaryKey,
        name: { type: DataTypes.STRING}
    }, { sequelize });
    SupplierModel.init({
        ...primaryKey,
        name: { type: DataTypes.STRING}
    }, { sequelize})
    ProductModel.belongsTo(CategoryModel,
        { foreignKey: "categoryId", as: "category"});   
    ProductModel.belongsTo(SupplierModel,
        { foreignKey: "supplierId", as: "supplier"});
    CategoryModel.hasMany(ProductModel,
        { foreignKey: "categoryId", as: "products"});
    SupplierModel.hasMany(ProductModel,
        { foreignKey: "supplierId", as: "products"});
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.789.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.790.1">initializeCatalogModels</span></code><span class="kobospan" id="kobo.791.1"> function accepts a </span><code class="inlinecode"><span class="kobospan" id="kobo.792.1">Sequelize</span></code><span class="kobospan" id="kobo.793.1"> object, which is used to initialize the model classes and create the relationships between them. </span><span class="kobospan" id="kobo.793.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.794.1">belongsTo</span></code><span class="kobospan" id="kobo.795.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.796.1">hasMany</span></code><span class="kobospan" id="kobo.797.1"> methods used to create the relationships between models accept a configuration object, which is used to override the default names used for the foreign key and association properties.</span></p>
<p class="normal"><span class="kobospan" id="kobo.798.1">To </span><a id="_idIndexMarker894" class="calibre3"/><span class="kobospan" id="kobo.799.1">complete the initial ORM models, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.800.1">index.ts</span></code><span class="kobospan" id="kobo.801.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.802.1">src/data/orm/models</span></code><span class="kobospan" id="kobo.803.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.804.1">Listing 16.37</span></em><span class="kobospan" id="kobo.805.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.806.1">Listing 16.37: The contents of the index.ts file in the src/data/orm/models folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.807.1">import { Sequelize } from "sequelize";
import { initializeCatalogModels } from "./catalog_helpers";
export { ProductModel, CategoryModel, SupplierModel } from "./catalog_models";
export const initializeModels = (sequelize: Sequelize) =&gt; {
    initializeCatalogModels(sequelize);
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.808.1">This file will be updated as new model classes are created and will help organize the features required for different parts of the application.</span></p>
<h3 class="heading2" id="_idParaDest-289"><span class="kobospan" id="kobo.809.1">Creating the repository class</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.810.1">My </span><a id="_idIndexMarker895" class="calibre3"/><span class="kobospan" id="kobo.811.1">preference for repositories is to break up the code into smaller sections that are more easily maintained. </span><span class="kobospan" id="kobo.811.2">This is purely a matter of personal style, but I don’t like large code files, and I am willing to accept some degree of complexity if I can split up something like a repository into more manageable pieces.</span></p>
<p class="normal"><span class="kobospan" id="kobo.812.1">The way that JavaScript supports this style of development is called </span><em class="italic"><span class="kobospan" id="kobo.813.1">mixins</span></em><span class="kobospan" id="kobo.814.1">, where classes are defined as function results, which allows complex functionality to be built up piece by piece. </span><span class="kobospan" id="kobo.814.2">To start the implementation of the repository, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.815.1">core.ts</span></code><span class="kobospan" id="kobo.816.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.817.1">src/data/orm</span></code><span class="kobospan" id="kobo.818.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.819.1">Listing 16.38</span></em><span class="kobospan" id="kobo.820.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.821.1">Listing 16.38: The contents of the core.ts file in the src/data/orm folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.822.1">import { Sequelize } from "sequelize";
import { getConfig } from "../../config";
import { initializeModels, CategoryModel, ProductModel, SupplierModel }
    from "./models";
import { readFileSync } from "fs";
const config = getConfig("catalog:orm_repo");
const logging = config.logging
        ? </span><span class="kobospan" id="kobo.822.2">{ logging: console.log, logQueryParameters: true}
        : { logging: false };
export class BaseRepo {
    sequelize: Sequelize;
   
    constructor() {
        this.sequelize = new Sequelize({ ...config.settings, ...logging })
        this.initModelsAndDatabase();
    }
    async initModelsAndDatabase() : Promise&lt;void&gt; {
        initializeModels(this.sequelize);
        if (config.reset_db) {
            await this.sequelize.drop();
            await this.sequelize.sync();
            await this.addSeedData();
        } else {
            await this.sequelize.sync();           
        }
    }   
    async addSeedData() {
        const data = JSON.parse(readFileSync(config.seed_file).toString());
        await this.sequelize.transaction(async (transaction) =&gt; {
            await SupplierModel.bulkCreate(data.suppliers, { transaction });
            await CategoryModel.bulkCreate(data.categories, { transaction });
            await ProductModel.bulkCreate(data.products, { transaction });
        });
    }   
}
export type Constructor&lt;T = {}&gt; = new (...args: any[]) =&gt; T;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.823.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.824.1">BaseRepo</span></code><span class="kobospan" id="kobo.825.1"> class </span><a id="_idIndexMarker896" class="calibre3"/><span class="kobospan" id="kobo.826.1">is responsible for configuring </span><code class="inlinecode"><span class="kobospan" id="kobo.827.1">Sequelize</span></code><span class="kobospan" id="kobo.828.1">, which is done by reading a configuration section, appending the logging settings, and invoking the constructor. </span><span class="kobospan" id="kobo.828.2">There is an </span><code class="inlinecode"><span class="kobospan" id="kobo.829.1">initModelsAndDatabase</span></code><span class="kobospan" id="kobo.830.1"> model that calls the </span><code class="inlinecode"><span class="kobospan" id="kobo.831.1">initializeModels</span></code><span class="kobospan" id="kobo.832.1"> function and, if configured, resets the database and invokes the </span><code class="inlinecode"><span class="kobospan" id="kobo.833.1">addSeedData</span></code><span class="kobospan" id="kobo.834.1"> method to populate the database with seed data. </span><span class="kobospan" id="kobo.834.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.835.1">addSeedData</span></code><span class="kobospan" id="kobo.836.1"> method reads a JSON data file and uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.837.1">Sequelize</span></code> <code class="inlinecode"><span class="kobospan" id="kobo.838.1">bulkCreate</span></code><span class="kobospan" id="kobo.839.1"> method to store multiple objects in a single operation, which is a good way to populate the database. </span><span class="kobospan" id="kobo.839.2">The last statement in </span><em class="italic"><span class="kobospan" id="kobo.840.1">Listing 16.38</span></em><span class="kobospan" id="kobo.841.1"> defines a type that will be used to create the </span><code class="inlinecode"><span class="kobospan" id="kobo.842.1">mixin</span></code><span class="kobospan" id="kobo.843.1"> and represents a type that can be instantiated with the </span><code class="inlinecode"><span class="kobospan" id="kobo.844.1">new</span></code><span class="kobospan" id="kobo.845.1"> keyword.</span></p>
<p class="normal"><span class="kobospan" id="kobo.846.1">The next step is to define the query features. </span><span class="kobospan" id="kobo.846.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.847.1">queries.ts</span></code><span class="kobospan" id="kobo.848.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.849.1">src/data/orm</span></code><span class="kobospan" id="kobo.850.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.851.1">Listing 16.39</span></em><span class="kobospan" id="kobo.852.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.853.1">Listing 16.39: The contents of the queries.ts file in the src/data/orm folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.854.1">import { CategoryModel, ProductModel, SupplierModel } from "./models";
import { BaseRepo, Constructor } from "./core"
export function AddQueries&lt;TBase extends Constructor&lt;BaseRepo&gt;&gt;(Base: TBase) {
    return class extends Base {
        getProducts() {
            return ProductModel.findAll({
                include: [
                    {model: SupplierModel, as: "supplier" },
                    {model: CategoryModel, as: "category"}],
                raw: true, nest: true
            });
        }
   
        getCategories() {
            return CategoryModel.findAll({
                raw: true, nest: true
            })
        }
   
        getSuppliers() {
            return SupplierModel.findAll({
                raw: true, nest:true
            });
        }       
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.855.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.856.1">AddQueries</span></code><span class="kobospan" id="kobo.857.1"> function accepts a base class and returns a new class that adds the </span><code class="inlinecode"><span class="kobospan" id="kobo.858.1">getProducts</span></code><span class="kobospan" id="kobo.859.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.860.1">getCategories</span></code><span class="kobospan" id="kobo.861.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.862.1">getSuppliers</span></code><span class="kobospan" id="kobo.863.1"> methods. </span><span class="kobospan" id="kobo.863.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.864.1">getProducts</span></code><span class="kobospan" id="kobo.865.1"> method includes associated data in its query, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.866.1">model</span></code><span class="kobospan" id="kobo.867.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.868.1">as</span></code><span class="kobospan" id="kobo.869.1"> properties are required to match the configuration in </span><em class="italic"><span class="kobospan" id="kobo.870.1">Listing 16.36</span></em><span class="kobospan" id="kobo.871.1">, where the default property names used by </span><code class="inlinecode"><span class="kobospan" id="kobo.872.1">Sequelize</span></code><span class="kobospan" id="kobo.873.1"> were overridden so that query results conformed to the data model interfaces.</span></p>
<p class="normal"><span class="kobospan" id="kobo.874.1">All of the </span><a id="_idIndexMarker897" class="calibre3"/><span class="kobospan" id="kobo.875.1">query methods are configured with the </span><code class="inlinecode"><span class="kobospan" id="kobo.876.1">raw</span></code><span class="kobospan" id="kobo.877.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.878.1">nest</span></code><span class="kobospan" id="kobo.879.1"> options set to </span><code class="inlinecode"><span class="kobospan" id="kobo.880.1">true</span></code><span class="kobospan" id="kobo.881.1">. </span><span class="kobospan" id="kobo.881.2">The objects created by </span><code class="inlinecode"><span class="kobospan" id="kobo.882.1">Sequelize</span></code><span class="kobospan" id="kobo.883.1"> cannot be used directly with the Handlebars template engine, which places restrictions on how properties are defined. </span><span class="kobospan" id="kobo.883.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.884.1">Sequelize</span></code><span class="kobospan" id="kobo.885.1"> object appears like a regular JavaScript object, but values are presented in a way that allows for changes to be tracked so that the database can be updated, which is contrary to the expectations Handlebars has for the data it processes. </span><span class="kobospan" id="kobo.885.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.886.1">raw</span></code><span class="kobospan" id="kobo.887.1"> option tells </span><code class="inlinecode"><span class="kobospan" id="kobo.888.1">Sequelize</span></code><span class="kobospan" id="kobo.889.1"> not to process the data it receives, which means that simple data objects are created. </span><span class="kobospan" id="kobo.889.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.890.1">nest</span></code><span class="kobospan" id="kobo.891.1"> option ensures that nested values, such as those produced for associated data, are presented as nested data objects.</span></p>
<p class="normal"><span class="kobospan" id="kobo.892.1">These configuration settings were not required in </span><em class="italic"><span class="kobospan" id="kobo.893.1">Part 2</span></em><span class="kobospan" id="kobo.894.1"> of this book because conversion functions were used, which meant that the objects created by </span><code class="inlinecode"><span class="kobospan" id="kobo.895.1">Sequelize</span></code><span class="kobospan" id="kobo.896.1"> were not the ones consumed by the template engine. </span><span class="kobospan" id="kobo.896.2">Using the </span><code class="inlinecode"><span class="kobospan" id="kobo.897.1">raw</span></code><span class="kobospan" id="kobo.898.1"> setting works when the structure of the data read from the database naturally matches the data structure the application requires, which depends on the query being executed. </span><span class="kobospan" id="kobo.898.2">For queries with complex associations between data – of which there are examples in later chapters – the </span><code class="inlinecode"><span class="kobospan" id="kobo.899.1">raw</span></code><span class="kobospan" id="kobo.900.1"> keyword will produce results that cannot be used directly, and in these cases, the best approach is to allow </span><code class="inlinecode"><span class="kobospan" id="kobo.901.1">Sequelize</span></code><span class="kobospan" id="kobo.902.1"> to process the results, and then use the </span><code class="inlinecode"><span class="kobospan" id="kobo.903.1">toJSON</span></code><span class="kobospan" id="kobo.904.1"> method that is inherited by all </span><code class="inlinecode"><span class="kobospan" id="kobo.905.1">Sequelize</span></code><span class="kobospan" id="kobo.906.1"> model objects to create simple objects that can be used with templates.</span></p>
<p class="normal"><span class="kobospan" id="kobo.907.1">The</span><a id="_idIndexMarker898" class="calibre3"/><span class="kobospan" id="kobo.908.1"> generic type arguments used to describe the </span><code class="inlinecode"><span class="kobospan" id="kobo.909.1">AddQueries</span></code><span class="kobospan" id="kobo.910.1"> function allow TypeScript to understand that the result combines the features defined by the base class, plus the new methods. </span><span class="kobospan" id="kobo.910.2">As noted previously, working this way is not required, but it does allow small amounts of related functionality to be defined in a way that is easy to maintain and combined to produce a more complex component.</span></p>
<p class="normal"><span class="kobospan" id="kobo.911.1">To implement the repository storage methods, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.912.1">storage.ts</span></code><span class="kobospan" id="kobo.913.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.914.1">src/data/orm</span></code><span class="kobospan" id="kobo.915.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.916.1">Listing 16.40</span></em><span class="kobospan" id="kobo.917.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.918.1">Listing 16.40: The contents of the storage.ts file in the src/data/orm folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.919.1">import { Transaction } from "sequelize";
import { Category, Product, Supplier } from "../catalog_models";
import { CategoryModel, ProductModel, SupplierModel } from "./models";
import { BaseRepo, Constructor } from "./core"
export function AddStorage&lt;TBase extends Constructor&lt;BaseRepo&gt;&gt;(Base: TBase)  {
    return class extends Base {
        storeProduct(p: Product) {
            return  this.sequelize.transaction(async (transaction) =&gt; {
   
                if (p.category) {
                    p.category = await this.storeCategory(p.category)
                }
                if (p.supplier) {
                    p.supplier = await this.storeSupplier(p.supplier);
                }
               
                const [stored] = await ProductModel.upsert({
                    id: p.id, name: p.name, description: p.description,
                    price: p.price, categoryId: p.category?.id,
                    supplierId: p.supplier?.id
                }, { transaction });
                return stored;
            });
        }
   
        async storeCategory(c: Category, transaction?: Transaction) {
            const [stored] = await CategoryModel.upsert({
                id: c.id, name: c.name
            }, { transaction});
            return stored;
        }
   
        async storeSupplier(s: Supplier, transaction?: Transaction) {
            const [stored] = await SupplierModel.upsert({
                id: s.id, name: s.name
            }, {transaction});
            return stored;
        }      
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.920.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.921.1">storeCategory</span></code><span class="kobospan" id="kobo.922.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.923.1">storeSupplier</span></code><span class="kobospan" id="kobo.924.1"> methods define optional parameters that allow </span><a id="_idIndexMarker899" class="calibre3"/><span class="kobospan" id="kobo.925.1">operations to be included in a transaction. </span><span class="kobospan" id="kobo.925.2">Because these parameters are optional, these methods are valid implementations of the ones defined by the repository interface. </span><span class="kobospan" id="kobo.925.3">The </span><code class="inlinecode"><span class="kobospan" id="kobo.926.1">storeProduct</span></code><span class="kobospan" id="kobo.927.1"> method uses the transaction parameter to ensure that data is written atomically, and the use of the mixin means that the </span><code class="inlinecode"><span class="kobospan" id="kobo.928.1">sequelize</span></code><span class="kobospan" id="kobo.929.1"> property defined in </span><em class="italic"><span class="kobospan" id="kobo.930.1">Listing 16.38</span></em><span class="kobospan" id="kobo.931.1"> is accessible in </span><em class="italic"><span class="kobospan" id="kobo.932.1">Listing 16.40</span></em><span class="kobospan" id="kobo.933.1">. </span><span class="kobospan" id="kobo.933.2">All three methods use the </span><code class="inlinecode"><span class="kobospan" id="kobo.934.1">upsert</span></code><span class="kobospan" id="kobo.935.1"> method to create or update data if it already exists, which means they can be used to both store and update data.</span></p>
<p class="normal"><span class="kobospan" id="kobo.936.1">To combine the three parts of the mixin into a single class, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.937.1">index.ts</span></code><span class="kobospan" id="kobo.938.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.939.1">src/data/orm</span></code><span class="kobospan" id="kobo.940.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.941.1">Listing 16.41</span></em><span class="kobospan" id="kobo.942.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.943.1">Listing 16.41: The contents of the index.ts file in the src/data/orm folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.944.1">import { CatalogRepository } from "../catalog_repository";
import { BaseRepo } from "./core";
import { AddQueries } from "./queries";
import { AddStorage } from "./storage";
const RepoWithQueries = AddQueries(BaseRepo);
const CompleteRepo = AddStorage(RepoWithQueries);
export const CatalogRepoImpl = CompleteRepo;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.945.1">The </span><a id="_idIndexMarker900" class="calibre3"/><span class="kobospan" id="kobo.946.1">process of creating a mixin starts by calling the function that adds the query methods to the </span><code class="inlinecode"><span class="kobospan" id="kobo.947.1">BaseRepo</span></code><span class="kobospan" id="kobo.948.1"> class, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.949.1">...
</span><span class="kobospan" id="kobo.949.2">const RepoWithQueries = </span><strong class="screentext"><span class="kobospan" id="kobo.950.1">AddQueries</span></strong><span class="kobospan" id="kobo.951.1">(BaseRepo);
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.952.1">The result is a class that combines the base features and the query methods, and this is passed to the function that adds the storage methods:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.953.1">...
</span><span class="kobospan" id="kobo.953.2">const CompleteRepo = </span><strong class="screentext"><span class="kobospan" id="kobo.954.1">AddStorage</span></strong><span class="kobospan" id="kobo.955.1">(RepoWithQueries);
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.956.1">The result is a class that defines all the methods and can be instantiated with the new keyword. </span><span class="kobospan" id="kobo.956.2">The combined class can be instantiated and used as an implementation of the </span><code class="inlinecode"><span class="kobospan" id="kobo.957.1">CategoryRepository</span></code><span class="kobospan" id="kobo.958.1"> interface:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.959.1">...
</span><span class="kobospan" id="kobo.959.2">export const </span><strong class="screentext"><span class="kobospan" id="kobo.960.1">CatalogRepoImpl</span></strong><span class="kobospan" id="kobo.961.1"> = CompleteRepo;
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.962.1">I like being able to compose features this way, and I find it useful to be able to keep the storage methods separate from the query methods, for example, but I appreciate that not everyone dislikes long code files as much as I do. </span><span class="kobospan" id="kobo.962.2">However, even if you don’t want to adopt this technique in your projects, it does serve as a demonstration</span><a id="_idIndexMarker901" class="calibre3"/><span class="kobospan" id="kobo.963.1"> of the flexibility that JavaScript provides to compose features with class expressions.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.964.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.965.1">I use a repository for the main parts of the </span><em class="italic"><span class="kobospan" id="kobo.966.1">SportsStore</span></em><span class="kobospan" id="kobo.967.1"> application. </span><span class="kobospan" id="kobo.967.2">However, just to show the alternative, the administration features in </span><em class="italic"><span class="kobospan" id="kobo.968.1">Chapter 20</span></em><span class="kobospan" id="kobo.969.1"> are implemented by working directly with </span><code class="inlinecode"><span class="kobospan" id="kobo.970.1">Sequelize</span></code><span class="kobospan" id="kobo.971.1"> in the HTTP request handlers.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.972.1">To instantiate the repository implementation so that an instance can be used by the rest of the application, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.973.1">index.ts</span></code><span class="kobospan" id="kobo.974.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.975.1">src/data</span></code><span class="kobospan" id="kobo.976.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.977.1">Listing 16.42</span></em><span class="kobospan" id="kobo.978.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.979.1">Listing 16.42: The contents of the index.ts file in the src/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.980.1">import { CatalogRepository } from "./catalog_repository";
import { CatalogRepoImpl} from "./orm";
export const catalog_repository: CatalogRepository = new CatalogRepoImpl();
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.981.1">This file will be the point at which the implementations of repository interfaces will be created and added to in later chapters, as different types of data are added to the application. </span><span class="kobospan" id="kobo.981.2">But for now, the file exports an object named </span><code class="inlinecode"><span class="kobospan" id="kobo.982.1">catalog_repository</span></code><span class="kobospan" id="kobo.983.1"> that implements the </span><code class="inlinecode"><span class="kobospan" id="kobo.984.1">CatalogRepository</span></code><span class="kobospan" id="kobo.985.1"> interface. </span><span class="kobospan" id="kobo.985.2">Notice that the TypeScript compiler can determine that the combination of methods conforms to the </span><code class="inlinecode"><span class="kobospan" id="kobo.986.1">CatalogRepository</span></code><span class="kobospan" id="kobo.987.1"> interface.</span></p>
<h2 class="heading1" id="_idParaDest-290"><span class="kobospan" id="kobo.988.1">Defining the configuration settings</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.989.1">The </span><a id="_idIndexMarker902" class="calibre3"/><span class="kobospan" id="kobo.990.1">repository is set up using configuration settings, which are defined in </span><em class="italic"><span class="kobospan" id="kobo.991.1">Listing 16.43</span></em><span class="kobospan" id="kobo.992.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.993.1">Listing 16.43: Adding settings to the server.config.json file in the SportsStore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.994.1">{
    "http": {
        "port": 5000
    },
    "templates": {
        "location": "templates",
        "config": {
            "layoutsDir": "templates",
            "defaultLayout": "main_layout.handlebars",
            "partialsDir": "templates"
        }
    },
    "errors": {
        "400": "not_found",
        "500": "error"
    },
   </span><strong class="screentext"><span class="kobospan" id="kobo.995.1"> "catalog": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.996.1">        "orm_repo": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.997.1">            "settings": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.998.1">                "dialect": "sqlite",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.999.1">                "storage": "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1000.1">catalog.db"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1001.1">            },</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1002.1">            "logging": true,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1003.1">            "reset_db": true,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1004.1">            "seed_file": "products.json"</span></strong><strong class="screentext"> </strong>
<strong class="screentext"><span class="kobospan" id="kobo.1005.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1006.1">    }</span></strong><span class="kobospan" id="kobo.1007.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1008.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1009.1">catalog:orm_repo</span></code><span class="kobospan" id="kobo.1010.1"> section is read by the base class defined in </span><em class="italic"><span class="kobospan" id="kobo.1011.1">Listing 16.38</span></em><span class="kobospan" id="kobo.1012.1">. </span><span class="kobospan" id="kobo.1012.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1013.1">settings</span></code><span class="kobospan" id="kobo.1014.1"> section is passed to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1015.1">Sequelize</span></code><span class="kobospan" id="kobo.1016.1"> constructor and specifies that data should be stored in an SQLite database file named </span><code class="inlinecode"><span class="kobospan" id="kobo.1017.1">catalog.db</span></code><span class="kobospan" id="kobo.1018.1">. </span><span class="kobospan" id="kobo.1018.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1019.1">logging</span></code><span class="kobospan" id="kobo.1020.1"> setting determines whether the repository configures </span><code class="inlinecode"><span class="kobospan" id="kobo.1021.1">Sequelize</span></code><span class="kobospan" id="kobo.1022.1"> to log messages, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.1023.1">rest_db</span></code><span class="kobospan" id="kobo.1024.1"> setting determines whether the database is reset and seeded every time the</span><a id="_idIndexMarker903" class="calibre3"/><span class="kobospan" id="kobo.1025.1"> repository is created, which can be useful during development but will be disabled when the application is prepared for deployment in </span><em class="italic"><span class="kobospan" id="kobo.1026.1">Chapter 21</span></em><span class="kobospan" id="kobo.1027.1">.</span></p>
<h2 class="heading1" id="_idParaDest-291"><span class="kobospan" id="kobo.1028.1">Defining the seed data</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.1029.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1030.1">seed_file</span></code><span class="kobospan" id="kobo.1031.1"> setting</span><a id="_idIndexMarker904" class="calibre3"/><span class="kobospan" id="kobo.1032.1"> added in </span><em class="italic"><span class="kobospan" id="kobo.1033.1">Listing 16.43</span></em><span class="kobospan" id="kobo.1034.1"> specifies the name of the file that will be used to seed the catalog database with product data. </span><span class="kobospan" id="kobo.1034.2">To define the data, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.1035.1">products.json</span></code><span class="kobospan" id="kobo.1036.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1037.1">sportsstore</span></code><span class="kobospan" id="kobo.1038.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.1039.1">Listing 16.44</span></em><span class="kobospan" id="kobo.1040.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1041.1">Listing 16.44: The contents of the products.json file in the SportsStore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1042.1">{
    "suppliers": [
        { "id": 1, "name": "Acme Industries"},
        { "id": 2, "name": "Big Boat Co"},
        { "id": 3, "name": "London Chess"}
    ],
    "categories": [
        { "id": 1, "name": "Watersports"},
        { "id": 2, "name": "Soccer"},
        { "id": 3, "name": "Chess"}
    ],
    "products": [
        {"id": 1, "name": "Kayak", "description": "A boat for one person",
         "price": 275.00, "categoryId": 1, "supplierId": 2 },
        {"id": 2, "name": "Lifejacket",
            "description": "Protective and fashionable",
            "price": 48.95, "categoryId": 1, "supplierId": 2 },
        { "id": 3, "name": "Soccer Ball",
            "description": "FIFA-approved size and weight",
            "price": 19.50, "categoryId": 2, "supplierId": 1 },
        { "id": 4, "name": "Corner Flags",
            "description": "Give your playing field a professional touch",
            "price": 34.95, "categoryId": 2, "supplierId": 1 },
        { "id": 5, "name": "Stadium",
            "description": "Flat-packed 35,000-seat stadium",
            "price": 79500, "categoryId": 2, "supplierId": 1 },
        { "id": 6, "name": "Thinking Cap",
            "description": "Improve brain efficiency by 75%", "price": 16,
            "categoryId": 3, "supplierId": 3 },           
        { "id": 7, "name": "Unsteady Chair",
            "description": "Secretly give your opponent a disadvantage",
            "price": 29.95, "categoryId": 3, "supplierId": 3 },
        { "id": 8, "name": "Human Chess Board",
            "description": "A fun game for the family", "price": 75,
            "categoryId": 3, "supplierId": 3 },
        { "id": 9, "name": "Bling King",
            "description": "Gold-plated, diamond-studded King",
            "price": 1200, "categoryId": 3, "supplierId": 3 }           
    ]
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1043.1">This </span><a id="_idIndexMarker905" class="calibre3"/><span class="kobospan" id="kobo.1044.1">data defines three suppliers, three categories, and nine products. </span><span class="kobospan" id="kobo.1044.2">Real online stores have larger catalogs, of course, but this data will be enough to continue building the application.</span></p>
<h2 class="heading1" id="_idParaDest-292"><span class="kobospan" id="kobo.1045.1">Using the catalog data</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.1046.1">The</span><a id="_idIndexMarker906" class="calibre3"/><span class="kobospan" id="kobo.1047.1"> next step is to confirm that the repository works as expected by presenting the user with a list of products. </span><em class="italic"><span class="kobospan" id="kobo.1048.1">Listing 16.45</span></em><span class="kobospan" id="kobo.1049.1"> uses the repository to read the product data from the database.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1050.1">Listing 16.45: Querying data in the catalog.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1051.1">import { Express } from "express";
</span><strong class="screentext"><span class="kobospan" id="kobo.1052.1">import { catalog_repository } from "../data";</span></strong><span class="kobospan" id="kobo.1053.1">
export const createCatalogRoutes = (app: Express) =&gt; {
   </span><strong class="screentext"><span class="kobospan" id="kobo.1054.1"> app.get("/"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1055.1">, async (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1056.1">        const products = await catalog_repository.getProducts();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1057.1">        resp.render("index", { products });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1058.1">    })</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1059.1">    // app.get("/err", (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1060.1">    //     throw new Error ("Something bad happened");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1061.1">    // });</span></strong>
<strong class="screentext"> </strong>
<strong class="screentext"><span class="kobospan" id="kobo.1062.1">    // app.get("/asyncerr", async (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1063.1">    //     throw new Error ("Something bad happened asynchronously");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1064.1">    // });</span></strong><span class="kobospan" id="kobo.1065.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1066.1">Replace </span><a id="_idIndexMarker907" class="calibre3"/><span class="kobospan" id="kobo.1067.1">the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.1068.1">index.handlebars</span></code><span class="kobospan" id="kobo.1069.1"> file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.1070.1">templates</span></code><span class="kobospan" id="kobo.1071.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.1072.1">Listing 16.46</span></em><span class="kobospan" id="kobo.1073.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1074.1">Listing 16.46: The contents of the index.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1075.1">&lt;table class="table table-sm table-striped"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Description&lt;/th&gt;
            &lt;th&gt;Price&lt;/th&gt;&lt;th&gt;Category&lt;/th&gt;&lt;th&gt;Supplier&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        {{#each products }}
            &lt;tr&gt;
                &lt;td&gt;{{id}}&lt;/td&gt;&lt;td&gt;{{name}}&lt;/td&gt;
                &lt;td&gt;{{description}}&lt;/td&gt;&lt;td&gt;{{price}}&lt;/td&gt;
                &lt;td&gt;{{category.name}}&lt;/td&gt;&lt;td&gt;{{supplier.name}}&lt;/td&gt;
            &lt;/tr&gt;
        {{/each}}
    &lt;/tbody&gt;
&lt;/table&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1076.1">This isn’t the final presentation of the data, but putting the product data into a table is a good way to check that all of the fields are accessible and read from the database, before figuring out the detailed formatting. </span><span class="kobospan" id="kobo.1076.2">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.1077.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.1078.1">, and</span><a id="_idIndexMarker908" class="calibre3"/><span class="kobospan" id="kobo.1079.1"> you will see the data shown in </span><em class="italic"><span class="kobospan" id="kobo.1080.1">Figure 16.6</span></em><span class="kobospan" id="kobo.1081.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.1082.1"><img alt="" src="../Images/B21959_16_06.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.1083.1">Figure 16.6: Displaying data</span></p>
<h1 class="heading" id="_idParaDest-293"><span class="kobospan" id="kobo.1084.1">Summary</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.1085.1">In this chapter, we started work on the </span><em class="italic"><span class="kobospan" id="kobo.1086.1">SportsStore</span></em><span class="kobospan" id="kobo.1087.1"> project, and we demonstrated how the key features described in earlier chapters are combined to create a more realistic web application:</span></p>
<ul class="calibre4">
<li class="bulletlist"><span class="kobospan" id="kobo.1088.1">The development tools monitor TypeScript files and other project resources so that the code is built and executed when changes are detected.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1089.1">The configuration system locates and merges JSON files to present consolidated settings that can be read consistently by the rest of the application and overridden with environment-specific values.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1090.1">Routes defined using the Express package handle HTTP requests and generate responses, using templates rendered by the Handlebars template engine.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1091.1">Custom error handlers produce responses consistent with the rest of the application and deal with errors in asynchronous request handlers.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1092.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1093.1">Sequelize</span></code><span class="kobospan" id="kobo.1094.1"> package creates a database that stores product data in an SQLite database, which will be replaced with PostgreSQL before deployment.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1095.1">The database is reset and reseeded with data every time the application starts.</span></li>
</ul>
<p class="normal"><span class="kobospan" id="kobo.1096.1">In the next chapter, we will continue building the SportsStore application by completing the product catalog and introducing a shopping cart.</span></p>
</div>
</body></html>