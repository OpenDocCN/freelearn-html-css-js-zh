<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Getting Started with AWS and Amazon CLI</h1>
                </header>
            
            <article>
                
<p><span><strong>Amazon Web Services</strong> (<strong>AWS</strong>) is the collection of all the tools and services that Amazon provides for developers in the cloud. There is a huge range of services available, from a server hosting to machine learning, from game streaming to digital marketing. Each of these services has been designed to perform one thing really well, but the biggest benefit is how well each of the services works together.</span></p>
<p><span>In this chapter, we will create an AWS account and explore the AWS console. Once we've got our account set up we'll learn about Lambda functions, creating one of our own. This will start out as a very simple Lambda, but we'll increase the functionality as we go through the rest of this book.</span></p>
<p><span>The next section of this chapter will talk about the different ways in which we can edit Lambdas and the advantages and disadvantages of each method.</span></p>
<p><span>The final section will cover how to create an amazing local development environment, using AWS CLI, build scripts, and Git. By the end of this chapter, we'll have a local environment where we can easily deploy our Lambdas without ever having to go onto AWS and we can back up all of our work to remote Git repositories.</span></p>
<p><span>This chapter will cover the following:</span></p>
<ul>
<li><span>Creating and configuring an AWS account</span></li>
<li><span>Creating a Lambda in AWS Console</span></li>
<li><span>Three methods for editing Lambdas</span></li>
<li><span>Creating an amazing local development environment using AWS CLI, build scripts, and Git</span></li>
</ul>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p><span>In this chapter, we'll be creating a few Lambdas as well as creating a build script.</span></p>
<p><span>All of the code can be found at</span> <a href="http://bit.ly/chatbot-ch2"><span>http://bit.ly/chatbot-ch2.</span></a></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating an account</h1>
                </header>
            
            <article>
                
<p><span>To access all of these services you need to create a free AWS developer account. Go to</span> <a href="https://aws.amazon.com/"><span>aws.amazon.com</span></a> <span>and click</span> <span class="packt_screen">Create a Free Account</span>. <span>To create an account you need to follow the sign-up process. The process is very thorough and requires you to enter payment details and receive an automated phone call. This process is to validate that you are a genuine user.</span></p>
<p><span>Once you've created your AWS account you can access all of the services through the</span> <span>Amazon Console (<a href="https://console.aws.amazon.com/">console.aws.amazon.com</a>)</span><span>. There is a lot of useful information on the console page.</span> <span class="packt_screen">Build a solution</span> <span>and</span> <span class="packt_screen">Learn to build</span> <span>are tutorials and information on how to use some of the services. </span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting your region</h1>
                </header>
            
            <article>
                
<p><span>For this book, you will need to set your regi</span>on to <span class="packt_screen">N. Virginia</span> or <span class="packt_screen">Ireland</span>. Lex <span>is currently (April 2018) available in those two regions.</span></p>
<p><span>AWS has this concept of regions, which are locations around the world where Amazon have their cloud service centers. Each region is separate from all the others for most applications. It is best practice to deploy services to the regions closest to where they'll be used. If your customers are on the west coast of America then choosing <span class="packt_screen">N. California</span> or <span class="packt_screen">Oregon</span> would be best, whilst choosing <span class="packt_screen">Ireland</span> wouldn't be a great choice. Their data would have to go halfway around the world and back each time they use your product.</span></p>
<p><span>One other consideration for the regions is that not every region is equal. Some regions have the larger working capacity, while some don't even have all of the services.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Navigating around AWS</h1>
                </header>
            
            <article>
                
<p><span>Getting around AWS has been designed to be as easy as possible. At the top of every page is a banner with a link to the console home page, a dropdown with every service available, account and location settings, and a support menu:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/42294334-3023-4260-94e9-2bc9ea8662c7.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">AWS menu and Service dropdown</div>
<p><span>The link to the home page and the service dropdown are the two options that you'll be using a lot throughout your time in AWS. When you're editing a Lambda and need to check a table name in Dynamo or you're creating an API Gateway for your EC2, you'll be switching between services a lot.</span></p>
<p><span>You can also pin your favorite service to your banner using the drawing pin icon. This makes switching between your most used services even quicker.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a Lambda</h1>
                </header>
            
            <article>
                
<p><span>AWS Lambda functions are incredible! They’re functions that are hosted on AWS that can be triggered in many different ways. Lambda functions are <em>serverless</em>, which means that you don't need to run a server to use them. This makes it a lot quicker and easier to set up and use.</span></p>
<p><span>One of the best parts of AWS Lambdas is that you only pay for the time the Lambda function is running. Got something that only runs once an hour and only takes two seconds? You’ll only be charged for 48 seconds a day! That’s insane compared to running a 24/7 AWS EC2 server or your own private server.</span></p>
<p class="mce-root"/>
<p><span>Today, we’ll create a Lambda function and look at the three best ways to work with the code.</span></p>
<p><span>Once you’ve got your AWS account set up, there are a few ways to create a new Lambda function. We’re going to start by using the AWS Console.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">AWS Console</h1>
                </header>
            
            <article>
                
<p><span>Within the AWS Console, you can find AWS Lambda in <span class="packt_screen">Services</span> | <span class="packt_screen">Compute</span> | <span class="packt_screen">Lambda</span>, which takes you to the Lambda Console:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/35b426c5-b280-4400-bfd0-3a95f8af2eb6.png" style=""/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">AWS Compute services</div>
<p><span>This is what you’ll see if this is your first Lambda. Click that <span class="packt_screen">Create function</span> button to start setting up your first function.</span></p>
<p><span>You’ll end up on the setup page, where you configure some aspects of the function (name, runtime, role). You can create a Lambda from Blueprints or Serverless Application Repos, but in this example, we'll select <span class="packt_screen">Author from scratch</span>.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting up the Lambda</h1>
                </header>
            
            <article>
                
<p><span>Enter the name for your function (this must be unique to your user or sub-account), choose your Runtime (We'll use <span class="packt_screen">Node.js 8.10</span>), and select</span> <span><em><span class="packt_screen">Create new role from template(s)</span></em></span>. Giv<span>e this new role a relevant name, such as </span><kbd>lambdaBasic</kbd> <span>or</span> <kbd>NoPolicyRol</kbd>, <span>and leave <span class="packt_screen">Policy templates</span> blank. When we create a more complex Lambda, we'll have to create a role with policies and permissions:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/7357f583-b6b1-4c2c-9168-2b33b66652cd.png" style=""/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">New Lambda with a new role</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Writing your Lambda function's code</h1>
                </header>
            
            <article>
                
<p><span>Once you've created your Lambda you are sent into the function editor within the Lambda Management Console. There is a lot going on this page, but we're focused on the section titled</span> <span class="packt_screen">Function code</span><span>.</span></p>
<p><span>When you first create a Lambda, it is created with a very basic function already implemented. This is nice as it gives you a starting point to build your function on. As we're using <span class="packt_screen">Node.js 8.10</span> as our runtime, there will be a single parameter of</span> the <kbd>event</kbd> and then <span>we will return our answer.</span></p>
<p><span>As a basic example, we'll create a Lambda that takes your name and age and tells you what your maximum heart rate is. This can be done more efficiently than the way we are going to do it, but this is done more as a way to demonstrate some techniques for use within Lambdas.</span></p>
<p class="mce-root"/>
<p><span>To start, we will</span> <kbd><span>console.log</span></kbd> <span>out the event and then extract the</span> <span><kbd>name</kbd><em> </em></span><span>and</span> <kbd><span>age</span></kbd><span>. I'm going to use ES6 destructuring but you can also do this using normal variable declaration:</span></p>
<pre><span>exports.handler = async (event) =&gt; {<br/>   console.log(event);<br/>   let { name, age } = event;<br/>    // same as =&gt; let name = event.name; let age = event.age<br/>    return 'Hello from Lambda!'<br/>};<br/></span></pre>
<p><span>Now that we have the</span> <span><kbd>name</kbd></span> <span>and</span> <kbd><span>age</span></kbd> <span>from the event, we can pass those into a function that converts them into a string:</span></p>
<pre><span>const createString = (name, age) =&gt; {<br/>  return `Hi ${name}, you are ${age} years old.`;<br/>};<br/></span></pre>
<p><span>If you haven't seen this sort of string before, they're called</span> <strong>template strings</strong> <span>and they're much neater than previous string concatenation. Backticks start and end the string and you can insert data using <kbd>${data}</kbd>.</span></p>
<p><span>Now we can change</span> <kbd>'Hello from Lambda!'</kbd> to <kbd>createString(name, age)</kbd> <span>and our function will return our new string:</span></p>
<pre><span>exports.handler = async (event) =&gt; {<br/>   console.log(event);<br/>   let { name, age } = event;<br/>    // same as =&gt; let name = event.name; let age = event.age<br/>    return </span><span>createString(name, age);<br/>};</span></pre>
<p><span>Make sure to save your changes by clicking the</span> <span>bright orange</span> <span class="packt_screen">Save</span> <span>button in the upper-right corner of your Lambda toolbar:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/d33992ac-6b2c-4ef3-b769-598772ca56bf.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Lambda toolbar</div>
<p><span>To test this out, we c</span>an click <span class="packt_screen">Test</span> in th<span>e Lambda toolbar.</span></p>
<p><span>When we click on</span> <span><em><span class="packt_screen">Test</span></em></span><span>, a</span> <span class="packt_screen">Configure test event</span> <span>popup opens. We can use this to decide what gets sent to our Lambda in the event payload. Give your test a name and then we can configure our data. For this Lambda it is very simple, just an object with key</span>s of <kbd>"name"</kbd> and <kbd>"age"</kbd>. Here's m<span>ine:</span></p>
<pre><span>{<br/>  "name": "Sam",<br/>   "age": "24"<br/>}<br/></span></pre>
<p><span>You can set your values to whatever you want and then click</span> <span class="packt_screen">Save</span> <span>at the bottom of the configuration screen. Now the dropdown to the left of the</span> <span class="packt_screen">Test</span> <span>button has changed to be your new test name. To run the test, simply click the</span> <span class="packt_screen">Test</span> <span>button:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/8593e166-dfc9-4963-9546-865e1b6bb62f.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Lambda result</div>
<p><span>If your response is still</span> <kbd>'Hello from Lambda!'</kbd>, t<span>hen make sure you've saved your function and run the test again. As you can see, I got the response of</span> <span class="packt_screen">"Hi Sam, you are 24 years old."</span><span>, which is what we expected. As well as the response, we get a <span class="packt_screen">RequestID</span> and <span class="packt_screen">Function Logs</span>. Remember when we added that</span> <kbd>console.log(event)</kbd> <span>to our code? You can now see that the object </span><span><kbd>{ name: 'Sam', age: '24' }</kbd></span> wa<span>s logged out. If you want to see more of your logs or logs from previous Lambda calls, they're all stored in CloudWatch. To get to CloudWatch you can either search for it in the services or get there by selecting</span> <span class="packt_screen">Monitoring</span> <span>at the top of the Lambda Console and then clicking</span> <span><em><span class="packt_screen">View logs in CloudWatch</span></em></span>.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The<span>re are also some interesting graphs inside</span> <span class="packt_screen">Monitoring</span> <span>that can tell you a lot about how well your function is working:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/b9840468-0791-4883-a5d2-b8f2a2ad466b.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">View logs in CloudWatch</div>
<p><span>Lambda functions can be created in a single file like we have done, but they also work with multiple files. When your Lambda is doing very complex tasks, you can break each section out into its own file to improve organization and readability.</span></p>
<p><span>We're going to create a new file called</span> <kbd>hr.js</kbd>, <span>and inside we're going to create and export another function. This function is going to calculate your maximum heart rate based on your age. Create the new file by right-clicking in the folder menu and selecting</span> <span class="packt_screen">New File</span> <span>and call it</span> <kbd>hr.js</kbd>. <span>Open up that file and we'll create a</span> <kbd><span>calculateHR</span></kbd> <span>function:</span></p>
<pre><span>module.exports = {<br/>    calculateHR: (age) =&gt; {<br/>        return 220 - age;<br/>    }<br/>}<br/></span></pre>
<p><span>Now, back</span> in our <kbd>index.js</kbd> <span>file we need to import our</span> <kbd>hr.js</kbd><span> </span><span>file and call the</span> <kbd>calculateHR</kbd> <span>function:</span></p>
<pre><span>const HR = require('./hr');<br/></span><span>exports.handler = async (event) =&gt; {</span><br/><span>   console.log(event);<br/>    let { name, age } = event;<br/></span><span>    return createString(name, age);</span><br/><span>};</span><br/><span>const createString = (name, age) =&gt; {</span><br/><span> return `Hi ${name}, you are ${age} years old and have a maximum heart rate of ${HR.calculateHR(age)}.`;</span><br/><span>};</span></pre>
<p><span>When we run our last test again, we get a new response of</span> <kbd><span>"Hi Sam, you are 24 years old and have a maximum heart rate of 196."</span></kbd><span>. This could have been done a lot more effectively, but this was done more to show you some ways that you can write code in Lambda functions.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Triggering Lambdas</h1>
                </header>
            
            <article>
                
<p><span>In your first Lambda, the way that we tested it was by triggering it with a test. To make Lambdas useful, we need to be able to trigger it from different places.</span></p>
<p><span>In the Lambda Console, near the top, there is a</span> <span class="packt_screen">Designer</span> <span>section. This section allows you to change how the Lambda interacts with other services and therefore the user. On the left of the section is an</span> <span class="packt_screen">Add triggers</span> <span>menu with a selection of options. Each of these is a system of services that you can set up to trigger the function. These are not all of the ways to trigger a Lambda and we'll be using other methods in the future.</span></p>
<p><span>The most important ones for us are</span> <span class="packt_screen">API Gateway</span> and <span class="packt_screen">Alexa Skill Kit</span><span>, but the other triggers can be very useful for other projects. API Gateway is the way to expose the Lambda to the outside world. You create an API endpoint, and anyone can hit that endpoint and that data will be processed by your Lambda. We'll be creating an API in</span> <a href="55111d86-d89c-4d8e-9577-8625a9654f4a.xhtml" target="_blank">Chapter 7</a>, <em>Publishing Your Chatbot to Facebook, Slack, Twilio and HTTP</em>. <span>The Alexa Skill Kit is a service for building Alexa Skills and these can trigger Lambdas too, and we'll be doing this in the next chapter.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Methods for working with Lambdas</h1>
                </header>
            
            <article>
                
<p><span>One of the big advantages of Lambdas is that you can choose how you write and edit them. There are three main ways to do so:</span></p>
<ul>
<li><span>Lambda Console</span></li>
<li><span>Cloud9</span></li>
<li><span>On your local machine</span></li>
</ul>
<p><span>I’m going to cover all three and discuss the advantages and disadvantages of each of them.</span></p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Method 1 – Lambda Console</h1>
                </header>
            
            <article>
                
<p><span>This is the way that we have just created our first Lambda function. In the Lambda Console, we have a basic editor. It’s based on the Cloud9 IDE and works well for simple Lambda functions.</span></p>
<p><span><strong>The advantages:</strong></span></p>
<ul>
<li><span>It’s a good editor</span></li>
<li><span>You can access it from any computer through your AWS Console</span></li>
</ul>
<p><span><strong>The disadvantages:</strong></span></p>
<ul>
<li><span>It doesn’t seem to be very stable. Sometimes it doesn’t let you save so you have to copy all of your work to a local file, reload the page, and copy your work back. I hope that this gets fixed soon!</span></li>
<li><span>It doesn’t have a command-line interface. This means that you can’t install <kbd>npm</kbd></span> <span>packages using this method alone.</span></li>
<li><span>You need internet access to work on your Lambdas.</span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Method 2 – Cloud9 editor</h1>
                </header>
            
            <article>
                
<p><span>Amazon recently acquired Cloud9, an online development platform. It runs a very basic version of Ubuntu that is integrated with the rest of the AWS platform.</span></p>
<p><span>Search for <kbd>Cloud9</kbd> in the AWS Console, go to the page, and select <span class="packt_screen">Create environment</span>. From here you give your environment a name and go to the next step.</span></p>
<p><span>Here you get to choose what you want to run this environment on. The great thing is that t2.micro is free-tier-eligible, so you can use this method without getting charged anything if you're on the free tier. I’ve never needed anything more powerful than a t2.micro.</span></p>
<p><span>Complete the setup process and you’ll end up in your new Cloud9 environment!</span></p>
<p><span>The cool thing about this is that you have access to all of your Lambda functions from inside your Cloud9 environment. Click <span class="packt_screen">AWS Resources</span> and under <span class="packt_screen">Remote Functions</span>, you'll find all of your functions. Click on the Lambda function you want to edit and then hit the download icon above to import it into your environment:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/98dd55ee-b2c7-47d0-a9dd-de1484fd7669.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Accessing remote Lambdas</div>
<p><span>Once that's done, it'll just be like you're working on it locally.</span></p>
<p><span>Once you’re finished, just select the function you’ve been working on from the local list and hit the upload button. Within a few seconds, it’ll be live with all your changes.</span></p>
<p><span><strong>The advantages</strong></span>:</p>
<ul>
<li><span>Again, this is all remote so you don’t need to worry about forgetting to commit your work or saving it to a memory stick if you work on multiple machines.</span></li>
<li><span>Accessing your functions and reuploading them is super easy. This is by far the best bit about this method.</span></li>
<li><span>You now have an integrated terminal, allowing you to install <kbd>npm</kbd> packages and do everything else you want to do using the terminal.</span></li>
</ul>
<p><span><strong>The disadvantages</strong></span>:</p>
<ul>
<li><span>It still has the same stability issues that the Lambda Console editor has. I’ve had multiple occasions where I’ve tried to save the function but couldn’t, and have had to copy to local, refresh, and recopy to Cloud 9. This becomes very annoying very quickly.</span></li>
<li><span>You need internet access to work on your Lambdas.</span></li>
</ul>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Method 3 – Local editing</h1>
                </header>
            
            <article>
                
<p><span>I'm going to do this one a little differently. I'll list the advantages and disadvantages of a basic usage and then show you how to make it much better.</span></p>
<p><span><strong>The advantages</strong></span>:</p>
<ul>
<li><span>Local editing is how most developers will work. We can use our favorite IDE, extensions, and color schemes.</span></li>
<li><span>It’s stable (as long as your computer is).</span></li>
<li><span>You can work on your Lambdas without needing an internet connection.</span></li>
</ul>
<p><span><strong>The disadvantages</strong></span>:</p>
<ul>
<li><span>There’s no fancy button to get and upload your work to AWS</span></li>
<li><span>Your work is local, so having multiple users or just working on multiple devices is more complex</span></li>
</ul>
<p><span>To make this method into the perfect system, we are going to make use of Amazon CLI and Git. It should take about 15 minutes to set up everything we need!</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating the best local development environment</h1>
                </header>
            
            <article>
                
<p><span>As we've already seen, there are some brilliant aspects of writing Lambdas locally, which is why we are going to use it throughout this book. We're going to choose an IDE and install NodeJS and NPM before setting up a folder structure for our Lambdas. Finally, we'll use the AWS CLI and Git to create awesome tools to get rid of the normal disadvantages of working locally.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Choosing an IDE</h1>
                </header>
            
            <article>
                
<p><span>Which IDE you use is down to personal preference; there are a few great ones out there, including Atom, Komodo, and Brackets. If you already have a personal favorite then you can use that, but all of the examples will use <strong>Visual Studio Code</strong> (<strong>VS Code</strong>).</span></p>
<p><span>VS Code is an open source IDE developed by Microsoft and is made for macOS, Linux, and Windows. It has built-in support for JavaScript, Node, and TypeScript and you can install extensions from the extension library. These extensions are one of the biggest advantages to using VS Code as they allow you to customize so much about your experience. From colored indentations to linting, from better icons to auto-formatters. They vary from the</span> <span><em>sort of interesting</em></span> <span>to the</span> <span><em>making your life far easier</em></span><span>.</span></p>
<p><span>As well as the extensions, VS Code has more great features such as an integrated terminal, Git integration, and a built-in debugger. If you've not tried it before, I would recommend trying it out for a week and seeing how it compares to your current IDE of choice.</span></p>
<p><span>To install VS Code, just go to</span> <a href="https://code.visualstudio.com/"><span>code.visualstudio.com</span></a><span> and download the version you need for your operating system.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing Node and NPM</h1>
                </header>
            
            <article>
                
<p><span>Node is the runtime that allows us to run JavaScript code on a server. It has gained massive favor over the last few years and is powering applications in almost every sector of technology. It is also one of the runtimes that can be chosen on Lambda functions.</span></p>
<p><span>Along with Node, we get <strong>Node Package Manager</strong> (<kbd>npm</kbd>), which is the largest ecosystem of open source libraries in the world. This is great for us and we'll be using some of these packages throughout this book.</span></p>
<p><span>To install Node and <kbd>npm</kbd> you can download the installation packages from</span> <a href="https://nodejs.org/"><span>nodejs.org</span></a><span> or through a package manager. Make sure that you install at least version 8.11.1 because we will be using</span> <span><em>async/await</em></span> <span>in our work, and this requires at least version 8. Once you have installed everything you can test that it's working by typing</span> <span><kbd>node -v</kbd></span> <span>; you should get something like</span> <span><kbd>v8.11.1</kbd></span><span>. You can also test <kbd>npm</kbd> by typing <kbd>npm -v</kbd>.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Folder structure</h1>
                </header>
            
            <article>
                
<p><span>To properly organize all of your Lambdas it is a good idea to have them all stored in a single folder. This will allow a single script to create and update all of your Lambdas. Within this main folder, having sub-folders containing groups of Lambdas is definitely a good idea. You can very quickly build up a large number of Lambdas.</span></p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting up AWS CLI</h1>
                </header>
            
            <article>
                
<p><span>To upload our work directly to AWS, we can use the AWS CLI. This allows us to manage our AWS services from the command line and create scripts to automate common tasks. For us, the most important CLI commands are the ones that allow us to create and update Lambdas. With automated scripts we now have the ability to quickly and easily create and deploy Lambdas, fixing the first of the</span> <span><em>local editing</em></span> <span>limitations.</span></p>
<p><span>To use the AWS CLI, we first need to set it up. You can install it by typing <kbd>npm install -g aws-cli</kbd> into your terminal.</span></p>
<p><span>Now we need to set up a user for our CLI to log in as. Log in to your AWS Console and navigate to or search for</span> <kbd>IAM</kbd><span>. Click</span> <span class="packt_screen">Add user</span> <span>so we can set up a user for our CLI. You're asked to give the user a name, so choose something like</span> <kbd>cli-user</kbd> <span>so that it is easily identifiable. Select</span> <span class="packt_screen">Programmatic access</span><span>, which will allow us to act as the user remotely, and click</span> <span class="packt_screen">Next: Permissions</span><span>.</span></p>
<p><span>In the <span class="packt_screen">Permissions</span> screen, choose to</span> <span class="packt_screen">Attach existing policies directly</span> <span>and select</span> <span class="packt_screen">AdministratorAccess</span><span>. This will let you do whatever you want through your CLI. You can set stricter policies on this user if you want, or if you are giving another person access to your account.</span></p>
<p><span>There’s another screen before you end up being shown your access keys. Copy your access keys and open a terminal. Run the command</span> <kbd>aws configure</kbd>, <span>which will ask you for four things:</span></p>
<pre>AWS Access Key ID [None]: "Your Access Key ID<br/>"AWS Secret Access Key [None]: "Your Secret Access Key"<br/>Default region name [eu-west-1]:<br/>Default output format [json]:</pre>
<p><span>The first two are found on the last page of the user creation. The third must be the region you chose earlier</span> (<kbd>eu-west-1</kbd> <span>or</span> <kbd>us-east-1</kbd><span>), and the last one can be left as default.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a Lambda using AWS CLI</h1>
                </header>
            
            <article>
                
<p><span>Now that we’ve got the CLI set up, we can use it to make our lives much easier. To create a new function, you need to have a folder containing an</span> <kbd>index.js</kbd> <span>file with a basic Lambda code in. Navigate into that folder in your terminal and now you can run these commands:</span></p>
<pre><strong><span>zip ./index.zip *<br/>aws lambda create-function \<br/> --function-name your-function-name \<br/>--runtime nodejs8.10 \<br/></span><span>--role your-lambda-role \<br/> --handler index.handler \<br/> --zip-file fileb://index.zip</span></strong></pre>
<p class="mce-root"><span>Switch out the</span> <kbd>your-lambda-role</kbd><span> </span><span>for the <kbd>arn</kbd> of the role that you created earlier. You can find this by going back to the</span> <kbd>IAM</kbd><span> </span><span>service in AWS and selecting</span> <span><kbd>Roles</kbd> </span><span>and clicking on your Lambda role:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/8709b28d-257e-4a49-bc49-42b1e9789a1e.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Find your role ARN</div>
<p><span>When you run this it will return a JSON blob with some information about your newly created Lambda.</span></p>
<p><span>If you edit your <kbd>index.js</kbd> code and want to update the Lambda, then there are three commands you need to run:</span></p>
<pre><strong><span>rm index.zip<br/></span><span>zip ./index.zip *</span></strong><br/><strong><span>aws lambda update-function-code \<br/>--function-name your-function-name \<br/>--zip-file fileb://index.zip</span></strong></pre>
<p><span>Using these scripts, you can now write your code locally and deploy it to AWS. This is good but it can be improved, which is what we're going to do next.</span></p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">AWS CLI build script</h1>
                </header>
            
            <article>
                
<p><span>These CLI commands are good, but typing this all out every time you want to upload a new Lambda version becomes annoying. We’re going to use a build script to automate these commands and add in a few extra features.</span></p>
<div class="packt_infobox">This script is going to be a bash script, so if you are running macOS or Linux then this will work natively. If you are on Windows then you'll need to install a bash terminal on your machine.</div>
<p><span>For this exact script to work, you need to have a folder structure as shown in the following screenshot. Each Lambda has a folder with the relevant files:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/1dd899f5-315e-48ba-aa00-aef0dcf573c5.png" style=""/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Folder structure</div>
<p><span>We will create a script that not only runs the basic AWS CLI commands, but also does extra checks, runs <kbd>npm install</kbd>, and echos out details about the progress. This script will be executed by running</span> <span><kbd>./build lambda-folder</kbd></span><span>.</span></p>
<p><span>Create a new file called</span> <kbd>build.sh</kbd> i<span>n your <kbd>lambdas</kbd> folder. Alternatively, you can download this file from <a href="http://bit.ly/chatbot-ch2">http://bit.ly/chatbot-ch2</a> and follow along to see how it works.</span></p>
<p><span>To start, we will check that exactly one parameter has been passed in the command. <kbd>"$#"</kbd> means the number of parameters and <kbd>-ne 1</kbd> mea</span>ns not equal to 1<span>:</span></p>
<pre><span>if [ "$#" -ne 1 ]; then<br/></span><span>echo "Usage : ./build.sh lambdaName";</span><br/><span> exit 1;</span><br/><span>fi</span></pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p><span>Next, we need to move into the folder for the selected Lambda and check that the folder exists:</span></p>
<pre><span>lambda=${1%/}; // # Removes trailing slashes<br/></span><span>echo "Deploying $lambda";</span><br/><span>cd $lambda;</span><br/><span>if [ $? -eq 0 ]; then</span><br/><span> echo "...."</span><br/><span>else</span><br/><span>echo "Couldn't cd to directory $lambda. You may have mis-spelled the lambda/directory name";<br/></span><span>exit 1</span><br/><span>fi</span></pre>
<p><span>We don't want to upload our Lambda without making sure that we've installed all of the dependencies, so we make sure to run</span> <span><kbd>npm install</kbd></span><span> and check that it has been successful:</span></p>
<pre>echo "npm installing...";<br/>npm install<br/>if [$? -eq 0 ]; then<br/>    echo "done";<br/>else<br/>    echo "npm install failed";<br/>    exit 1;<br/>fi</pre>
<p><span>The last of the setup steps is to check t</span>hat <kbd>aws-cli</kbd> is inst<span>alled:</span></p>
<pre><span>echo "Checking that aws-cli is installed"<br/></span><span>which aws</span><br/><span>if [ $? -eq 0 ]; then</span><br/><span> echo "aws-cli is installed, continuing..."</span><br/><span>else</span><br/><span>echo "You need aws-cli to deploy this lambda. Google 'aws-cli install'"</span><br/><span>exit 1</span><br/><span>fi</span></pre>
<p><span>With everything set up, we can create our new ZIP file. Before creating the ne</span>w <kbd>.zip</kbd> file, we'll <span>delete the old one. Creating a new one this time is a little bit more advanced than before. W</span>e exclude <kbd>.git</kbd>, <kbd>.sh</kbd>, and <kbd>.zip</kbd> files as w<span>ell as excluding</span> <kbd>test</kbd> folders and <kbd>node_modules/aws-sdk</kbd> fro<span>m the file. We ca</span>n exclude <kbd>aws-sdk</kbd> because it is already installed on all Lambda functions and we don't want to upload Git files, bash scripts, or other <kbd>.zip</kbd> files:</p>
<pre><span>echo "removing old zip"<br/>rm archive.zip;</span></pre>
<pre><span>echo "creating a new zip file"<br/>zip archive.zip * -r -x .git/\* \*.sh tests/\* node_modules/aws-sdk/\* \*.zip<br/></span></pre>
<p><span>Now, all there is left to do is to upload it to AWS. We want to make this as easy as possible so we're going to try creating a new function. If that errors then we'll try updating the function. This could be done as a</span> <span><em>get</em></span><span> </span><span>and then</span> <span><em>create</em></span><span> </span><span>or</span> <span><em>update</em></span><span>, </span><span>but a failure</span> to <span><em>create</em></span><span> </span><span>is actually quicker than a</span> <span><em>get</em></span>:</p>
<pre><span>echo "Uploading $lambda to $region";<br/>aws lambda create-function --function-name $lambda --runtime nodejs8.10 --role arn:aws:iam::095363550084:role/service-role/Dynamo --handler index.handler --zip-file fileb://index.zip --publish<br/>if [ $? -eq 0 ]; then<br/>  echo "!! Create successful !!"<br/>   exit 1;<br/>fi<br/>aws lambda update-function-code --function-name $lambda --zip-file fileb://archive.zip --publish<br/>if [ $? -eq 0 ]; then<br/>echo "!! Update successful !!"<br/>else<br/>echo "Upload failed"<br/>echo "If the error was a 400, check that there are no slashes in your lambda name"<br/> echo "Lambda name = $lambda"<br/>exit 1;<br/>fi</span></pre>
<p><span>To make the script executable, we need to change the permissions on the file. To do this, we run <kbd>chmod +x ./build.sh</kbd>.</span></p>
<p><span>Now, all you need to do is to navigate to the main folder where the</span> <span>Lambdas function resides and run </span><span><kbd>./build.sh example-lambda</kbd></span><span>. If you have Lambdas folders</span> <span>nested in groups, then navigate into the group folders and run</span> <span><kbd>../build.sh lambda-in-group</kbd></span><span>.</span></p>
<p><span>If you want, you can move the build script to your home directory to make execution</span> <span><kbd>~/build.sh lambda-function</kbd></span>, <span>which is only useful if you have Lambdas in separate folders or highly nested folders.</span></p>
<p><span>This script could be modified and expanded to include region-specific uploading, batch uploading multiple Lambda functions, Git integration, and lots more.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Git</h1>
                </header>
            
            <article>
                
<p><span>A lot of people reading this will use Git already. There’s a reason for that—it makes life simpler. Having a Git repository for all of your Lambda functions is a great way to work with teams of developers or by yourself on multiple machines.</span></p>
<p><span>Installing Git on your system varies depending on your operating system. Linux users can install Git through the command line, macOS users can install using Homebrew or via download, and Windows users have to install Git via download. Details on exactly how to install for your system are available on</span> <a href="https://git-scm.com/"><span>git-scm.com</span></a><span>.</span></p>
<p><span>Once you have Git installed, navigate in the terminal to your Lambda folder. When inside that folder, run</span> <span><kbd>git init</kbd></span> <span>to create an empty repository. When you open your Lambda folder in VS Code, you will now have a number hovering over the Git symbol. This means that you have edited that number of files since your last Git commit.</span></p>
<p><span>Committing to Git is like taking a snapshot of all of the work in the folder and saving it. This is useful as it allows you to see how your work changes over time. To commit your work (take the snapshot) you have two options.</span></p>
<p><span>You can use the Git integration with VS Code to create the commit. Click on the Git symbol with the number hovering over it. When you click on that, it opens the changes menu, showing you all of the files that you have changed since your last commit, or all of your files if this is your first commit. To commit the changed work, type a message into the message box at the top and click the tick above that:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/7408a1da-e61a-47c4-8823-59ba000b021a.png" style=""/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Git commit using VS Code integration</div>
<p><span>If you want to use the command line you need to enter</span> <span><kbd>git add *</kbd></span> <span>to add all of your changed files to the commit you're about to do. Then type</span> <span><kbd>git commit -m "My first git commit!"</kbd></span><span>. The text between the quote marks is your commit message.</span></p>
<p><span>In both cases, your commit message should describe the changes that you've made in this commit. Your first commit will probably be <kbd>"creating my first function"</kbd>.</span></p>
<p><span>Another massive advantage to Git is that you can easily create remote Git repositories. These are data centers that will store your Git commits so you can access them from anywhere in the world. The major two are GitHub and Bitbucket but there are lots more. They both have free versions, but GitHub is only free for public repositories so anyone can see your work.</span></p>
<p><span>Once you've signed up for an account and created a repository, you'll be given a URL for it. In your terminal, navigate to your folder and run</span> <kbd>git add remote origin &lt;your url&gt;</kbd><span>. This means that you can send work from your local machine to your online repository. Just type</span> <span><kbd>git push origin master</kbd></span> <span>to send your latest commits to your online repository. Getting them back is just as simple; just type </span><span><kbd>git pull origin master</kbd></span> <span>and your local code will update to add in any changes made in your repository.</span></p>
<p><span>This is great for teams as it allows you to all work on your own machines but be able to get each other's changes.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Local development setup</h1>
                </header>
            
            <article>
                
<p><span>To summarize your new local development setup, you have the following:</span></p>
<ul>
<li><span>A powerful IDE – VS Code</span></li>
<li><span>Amazon CLI-powered build scripts to create and update functions</span></li>
<li><span>Git to store your work remotely and allow easier teamwork</span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p><span>In this chapter, we have learned about Amazon Web Services and created an account, giving us access to all of these services.</span></p>
<p><span>We created our first Lambda function using the Lambda Console, and advanced it to use multiple functions, template strings, and requiring in code from other files.</span></p>
<p class="mce-root"/>
<p class="mce-root"/>
<p><span>Next, we discussed the three main ways to create Lambdas, namely the Lambda Console, Cloud9, and using local development. We also looked at the advantages and disadvantages of each.</span></p>
<p><span>Finally, we used the AWS-CLI and Git to make our local development setup far more powerful. The build script that we used allows us to create and update Lambdas without ever having to go onto AWS.</span></p>
<p>In the next chapter, we will learn to build our first Alexa Skills using the Alexa Skills Kit.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<ol>
<li><span>Name the three main ways to create and edit Lambda functions.</span></li>
<li><span>What does AWS stand for?</span></li>
<li><span>What are the two main limitations of a basic local development setup?</span></li>
<li><span>What tools do we use to improve our local development setup?</span></li>
</ol>


            </article>

            
        </section>
    </body></html>