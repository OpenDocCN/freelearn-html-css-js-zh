<html><head></head><body>
<div id="_idContainer104">
<h1 class="chapter-number" id="_idParaDest-80" lang="en-GB"><a id="_idTextAnchor079"/><span class="koboSpan" id="kobo.1.1">8</span></h1>
<h1 id="_idParaDest-81" lang="en-GB"><a id="_idTextAnchor080"/><span class="koboSpan" id="kobo.2.1">Publishing npm Packages</span></h1>
<p lang="en-GB"><span class="koboSpan" id="kobo.3.1">Before now, our main focus has been to learn everything about improving and contributing to existing projects, but quite often, this is not everything. </span><span class="koboSpan" id="kobo.3.2">Some projects will need to be initiated correctly by you and one part of this process is to decide which packages should actually </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.4.1">be reused.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.5.1">We’ve already learned that reusability in Node.js is primarily gained through the module system, which can be enhanced by third-party dependencies in the form of npm packages. </span><span class="koboSpan" id="kobo.5.2">In this chapter, you’ll learn how you can publish npm packages yourself. </span><span class="koboSpan" id="kobo.5.3">This way, a functionality implemented once can be shared among the team working on the same project or </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.6.1">with anyone.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.7.1">To achieve our goal in this chapter, first, we’ll set up a simple library to serve our case well. </span><span class="koboSpan" id="kobo.7.2">Then, we publish this library to the official npm registry in a way that makes the code available to any Node.js developer. </span><span class="koboSpan" id="kobo.7.3">If you want to keep your library a bit less exposed, then the following sections will be interesting for you. </span><span class="koboSpan" id="kobo.7.4">In these, you will first learn how to select other registries before you actually select a local registry to use for publishing </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.8.1">and installation.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.9.1">Finally, we’ll also look at ways to broaden the scope of our library – by making it </span><strong class="bold" lang=""><span class="koboSpan" id="kobo.10.1">isomorphic</span></strong><span class="koboSpan" id="kobo.11.1"> or exposing it as a tool. </span><span class="koboSpan" id="kobo.11.2">In summary, we’ll cover the following key topics in </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.12.1">this chapter:</span></span></p>
<ul>
<li lang="en-GB"><span class="koboSpan" id="kobo.13.1">Publishing to the </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.14.1">official registry</span></span></li>
<li lang="en-GB"><span class="koboSpan" id="kobo.15.1">Selecting another npm registry </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.16.1">via </span></span><span class="No-Break" lang=""><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.17.1">.npmrc</span></strong></span></li>
<li lang="en-GB"><span class="koboSpan" id="kobo.18.1">Setting </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.19.1">up Verdaccio</span></span></li>
<li lang="en-GB"><span class="koboSpan" id="kobo.20.1">Writing </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.21.1">isomorphic libraries</span></span></li>
<li lang="en-GB"><span class="koboSpan" id="kobo.22.1">Publishing a </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.23.1">cross-platform tool</span></span></li>
</ul>
<h1 id="_idParaDest-82" lang="en-GB"><a id="_idTextAnchor081"/><span class="koboSpan" id="kobo.24.1">Technical requirements</span></h1>
<p lang="en-GB"><span class="koboSpan" id="kobo.25.1">The complete source code for this chapter is available </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.26.1">at </span></span><a href="https://github.com/PacktPublishing/Modern-Frontend-Development-with-Node.js/tree/main/Chapter08"><span class="No-Break" lang=""><span class="koboSpan" id="kobo.27.1">https://github.com/PacktPublishing/Modern-Frontend-Development-with-Node.js/tree/main/Chapter08</span></span></a><span class="No-Break" lang=""><span class="koboSpan" id="kobo.28.1">.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.29.1">The CiA videos for this chapter can be accessed </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.30.1">at </span></span><a href="https://bit.ly/3UmhN4B"><span class="No-Break" lang=""><span class="koboSpan" id="kobo.31.1">https://bit.ly/3UmhN4B</span></span></a><span class="No-Break" lang=""><span class="koboSpan" id="kobo.32.1">.</span></span></p>
<h1 id="_idParaDest-83" lang="en-GB"><a id="_idTextAnchor082"/><span class="koboSpan" id="kobo.33.1">Publishing to the official registry</span></h1>
<p lang="en-GB"><span class="koboSpan" id="kobo.34.1">Let’s start by creating a </span><a id="_idIndexMarker293"/><span class="koboSpan" id="kobo.35.1">small library that uses a structure that can be seen very often in Node.js projects. </span><span class="koboSpan" id="kobo.35.2">The structure consists of an </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.36.1">src</span></strong><span class="koboSpan" id="kobo.37.1"> folder, where the original sources are located, and a </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.38.1">lib</span></strong><span class="koboSpan" id="kobo.39.1"> folder, containing the output to be used by the target system. </span><span class="koboSpan" id="kobo.39.2">The target system could either be something such as a bundler for browser applications or a specific version </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.40.1">of Node.js.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.41.1">To initialize this kind of project, we can use the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.42.1">npm</span></strong><span class="koboSpan" id="kobo.43.1"> command-line utility as we </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.44.1">did before:</span></span></p>
<pre class="console" lang="en-GB"><span class="koboSpan" id="kobo.45.1">
$ npm init -y</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.46.1">Now, we’ll set everything up. </span><span class="koboSpan" id="kobo.46.2">First, we will install </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.47.1">esbuild</span></strong><span class="koboSpan" id="kobo.48.1"> as a development dependency. </span><span class="koboSpan" id="kobo.48.2">This can be very helpful for transforming our source files into usable </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.49.1">library files:</span></span></p>
<pre class="console" lang="en-GB"><span class="koboSpan" id="kobo.50.1">
$ npm install esbuild --save-dev</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.51.1">Next, we change </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.52.1">package.json</span></strong><span class="koboSpan" id="kobo.53.1"> to fit </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.54.1">our needs:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.55.1">package.json</span></p>
<pre class="source-code" lang="en-GB"><span class="koboSpan" id="kobo.56.1">{
  "name": "lib-test-florian-rappl",
  "version": "1.0.0",
  "description": "Just a test library",
  "keywords": [],
  "author": "Florian Rappl",
  "license": "MIT",
  "main": "lib/index.js",
  "source": "src/index.js",
  "scripts": {
    "build": "esbuild src/*.js --platform=node --outdir=lib
      --format=cjs"
  },
  "devDependencies": {
    "esbuild": "^0.15.0"
  }
}</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.57.1">Importantly, replace the chosen placeholder’s name (</span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.58.1">florian-rappl</span></strong><span class="koboSpan" id="kobo.59.1"> in the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.60.1">name</span></strong><span class="koboSpan" id="kobo.61.1"> field and </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.62.1">Florian Rappl</span></strong><span class="koboSpan" id="kobo.63.1"> in the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.64.1">author</span></strong><span class="koboSpan" id="kobo.65.1"> field) with your name. </span><span class="koboSpan" id="kobo.65.2">For the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.66.1">name</span></strong><span class="koboSpan" id="kobo.67.1"> field, make sure to only use </span><a id="_idIndexMarker294"/><span class="koboSpan" id="kobo.68.1">letters allowed for package name identifiers. </span><span class="koboSpan" id="kobo.68.2">Also, feel free to change the </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.69.1">selected license.</span></span></p>
<p class="callout-heading" lang="en-GB"><span class="koboSpan" id="kobo.70.1">Licenses</span></p>
<p class="callout" lang="en-GB"><span class="koboSpan" id="kobo.71.1">An important piece of information in every </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.72.1">package.json</span></strong><span class="koboSpan" id="kobo.73.1"> is the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.74.1">license</span></strong><span class="koboSpan" id="kobo.75.1"> field. </span><span class="koboSpan" id="kobo.75.2">While the MIT License is a very good choice for many open-source projects, it is by no means the only one. </span><span class="koboSpan" id="kobo.75.3">Other popular choices include the Apache License 2.0, BSD 3-Clause, and the </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.76.1">ISC License.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.77.1">Now, we’ll add some content to our </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.78.1">source file:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.79.1">src/index.js</span></p>
<pre class="source-code" lang="en-GB"><span class="koboSpan" id="kobo.80.1">import { readFile } from "fs";
import { resolve } from "path";
export function getLibName() {
  const packagePath = resolve(__dirname,
    "../package.json");
  return new Promise((resolve, reject) =&gt; {
    readFile(packagePath, "utf8", (err, content) =&gt; {
      if (err) {
        reject(err);
      } else {
        const { name, version } = JSON.parse(content);
        resolve(`${name}@${version}`);
      }
    });
  });</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.81.1">This file was written in a</span><a id="_idIndexMarker295"/><span class="koboSpan" id="kobo.82.1"> way that makes sense for us as developers, but cannot be run by Node.js directly. </span><span class="koboSpan" id="kobo.82.2">The problem is twofold. </span><span class="koboSpan" id="kobo.82.3">First, we are using ESM syntax without guaranteeing that Node.js supports this. </span><span class="koboSpan" id="kobo.82.4">Second, we are mixing ESM constructs such as </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.83.1">import</span></strong><span class="koboSpan" id="kobo.84.1"> and </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.85.1">export</span></strong><span class="koboSpan" id="kobo.86.1"> with CommonJS constructs such </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.87.1">as </span></span><span class="No-Break" lang=""><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.88.1">__dirname</span></strong></span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.89.1">.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.90.1">Luckily, we already installed </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.91.1">esbuild</span></strong><span class="koboSpan" id="kobo.92.1"> to take care of this, with the defined </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.93.1">build</span></strong><span class="koboSpan" id="kobo.94.1"> script actually using it </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.95.1">for convenience:</span></span></p>
<pre class="console" lang="en-GB"><span class="koboSpan" id="kobo.96.1">
$ npm run build

&gt; lib-test-florian-rappl@1.0.0 build /home/node/code/example01

&gt; esbuild src/*.js --platform=node --outdir=lib --format=cjs

  lib/index.js  1.4kb

</span><span class="koboSpan" id="kobo.97.1"><img alt="" src="image/022.png"/></span><span class="koboSpan" id="kobo.98.1"> Done in 2ms</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.99.1">At this point, we have two directories in our project: </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.100.1">src</span></strong><span class="koboSpan" id="kobo.101.1">, containing the original sources, and </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.102.1">lib</span></strong><span class="koboSpan" id="kobo.103.1">, containing the CommonJS output. </span><span class="koboSpan" id="kobo.103.2">This is also reflected in </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.104.1">package.json</span></strong><span class="koboSpan" id="kobo.105.1">, where the source field points to </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.106.1">src/index.js</span></strong><span class="koboSpan" id="kobo.107.1"> and the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.108.1">main</span></strong><span class="koboSpan" id="kobo.109.1"> field points </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.110.1">to </span></span><span class="No-Break" lang=""><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.111.1">lib/index.js</span></strong></span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.112.1">.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.113.1">Just as a reminder: the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.114.1">main</span></strong><span class="koboSpan" id="kobo.115.1"> field tells Node.js what module to use in case the package is included via </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.116.1">require</span></strong><span class="koboSpan" id="kobo.117.1"> – for example, </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.118.1">require('lib-test-florian-rappl')</span></strong><span class="koboSpan" id="kobo.119.1"> would reference and evaluate the </span><span class="No-Break" lang=""><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.120.1">lib/index.js</span></strong></span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.121.1"> file.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.122.1">Let’s say you want to </span><a id="_idIndexMarker296"/><span class="koboSpan" id="kobo.123.1">publish this package now to the official npm registry. </span><span class="koboSpan" id="kobo.123.2">For this, you first need an account on </span><a href="https://npmjs.com/signup"><span class="koboSpan" id="kobo.124.1">npmjs.com/signup</span></a><span class="koboSpan" id="kobo.125.1">. </span><span class="koboSpan" id="kobo.125.2">Once successfully registered and logged in, you should see a view similar to that in </span><span class="No-Break" lang=""><em class="italic" lang=""><span class="koboSpan" id="kobo.126.1">Figure 8</span></em></span><span class="No-Break" lang=""><em class="italic" lang=""><span class="koboSpan" id="kobo.127.1">.1</span></em></span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.128.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer099">
<span class="koboSpan" id="kobo.129.1"><img alt="Figure 8.1 – The view on npmjs.com once logged in " src="image/Figure_8.1_B18989.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.130.1">Figure 8.1 – The view on npmjs.com once logged in</span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.131.1">On your own machine, you can now authenticate to the official npm registry by running </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.132.1">the following:</span></span></p>
<pre class="console" lang="en-GB"><span class="koboSpan" id="kobo.133.1">
$ npm login</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.134.1">This will request your username and password. </span><span class="koboSpan" id="kobo.134.2">Alternatively, you could authenticate using so-called access tokens. </span><span class="koboSpan" id="kobo.134.3">This is especially useful for scripts, such as automation running in a CI/CD pipeline. </span><span class="koboSpan" id="kobo.134.4">To generate a new access token, follow the link highlighted in </span><span class="No-Break" lang=""><em class="italic" lang=""><span class="koboSpan" id="kobo.135.1">Figure 8</span></em></span><span class="No-Break" lang=""><em class="italic" lang=""><span class="koboSpan" id="kobo.136.1">.1</span></em></span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.137.1">.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.138.1">Now that you have </span><a id="_idIndexMarker297"/><span class="koboSpan" id="kobo.139.1">authenticated the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.140.1">npm</span></strong><span class="koboSpan" id="kobo.141.1"> utility, you can go ahead and publish </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.142.1">your package:</span></span></p>
<pre class="console" lang="en-GB"><span class="koboSpan" id="kobo.143.1">
$ npm publish

npm notice

npm notice </span><span class="koboSpan" id="kobo.144.1"><img alt="" src="image/015.png"/></span><span class="koboSpan" id="kobo.145.1">  lib-test-florian-rappl@1.0.0

npm notice === Tarball Contents ===

npm notice 1.5kB lib/index.js

npm notice 425B  src/index.js

npm notice 344B  package.json

npm notice === Tarball Details ===

npm notice name:          lib-test-florian-rappl

npm notice version:       1.0.0

npm notice package size:  1.1 kB

npm notice unpacked size: 2.3 kB

npm notice shasum:        2b5d224949f9112eeaee435a876a8ea15ed3e7cd

npm notice integrity:     sha512-cBq1czwmN4vep[...]/vXrORFGjRjnA==

npm notice total files:   3

npm notice

+ lib-test-florian-rappl@1.0.0</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.146.1">This will package your project as a compressed archive. </span><span class="koboSpan" id="kobo.146.2">Then, the utility will upload the tarball to the official </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.147.1">npm registry.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.148.1">Now, you can go</span><a id="_idIndexMarker298"/><span class="koboSpan" id="kobo.149.1"> to </span><a href="https://npmjs.com"><span class="koboSpan" id="kobo.150.1">npmjs.com</span></a><span class="koboSpan" id="kobo.151.1"> to look for your package name. </span><span class="koboSpan" id="kobo.151.2">You should see the package info page similar to </span><span class="No-Break" lang=""><em class="italic" lang=""><span class="koboSpan" id="kobo.152.1">Figure 8</span></em></span><em class="italic" lang=""><span class="koboSpan" id="kobo.153.1">.2</span></em><span class="koboSpan" id="kobo.154.1"> with more details about the published package. </span><span class="koboSpan" id="kobo.154.2">Note that we did not include a </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.155.1">README.md</span></strong><span class="koboSpan" id="kobo.156.1"> or </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.157.1">any keywords:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer101">
<span class="koboSpan" id="kobo.158.1"><img alt="Figure 8.2 – The details of the published package " src="image/Figure_8.2_B18989.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.159.1">Figure 8.2 – The details of the published package</span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.160.1">One thing that you might consider is to give your package a scope. </span><span class="koboSpan" id="kobo.160.2">When you publish a package with a scope, then you’ll need to configure the access settings of the package. </span><span class="koboSpan" id="kobo.160.3">By default, non-scoped packages are public, and scoped packages </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.161.1">are private.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.162.1">For publishing a scoped package to the official npm registry, you’ll first need to be either a member or owner of an organization on the npm website. </span><span class="koboSpan" id="kobo.162.2">The organization name must match the name of </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.163.1">the scope.</span></span></p>
<p class="callout-heading" lang="en-GB"><span class="koboSpan" id="kobo.164.1">Package scope</span></p>
<p class="callout" lang="en-GB"><span class="koboSpan" id="kobo.165.1">A good way to group packages is to put them in a common scope. </span><span class="koboSpan" id="kobo.165.2">The scope has to start with an “@” symbol, which is followed by the name of the scope. </span><span class="koboSpan" id="kobo.165.3">The rules for the name of the scope are identical to package names. </span><span class="koboSpan" id="kobo.165.4">Besides grouping packages, scopes can be used to place certain packages in a different registry without much trouble. </span><span class="koboSpan" id="kobo.165.5">Most importantly, scopes can be reserved on the official npm registry, such that only authorized accounts can publish new packages using a </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.166.1">reserved scope.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.167.1">To consistently </span><a id="_idIndexMarker299"/><span class="koboSpan" id="kobo.168.1">publish a scoped package such as </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.169.1">@foo/bar</span></strong><span class="koboSpan" id="kobo.170.1"> with public access, you need to modify the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.171.1">package.json</span></strong><span class="koboSpan" id="kobo.172.1">. </span><span class="koboSpan" id="kobo.172.2">The relevant configuration is stored in a property </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.173.1">called </span></span><span class="No-Break" lang=""><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.174.1">publishConfig</span></strong></span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.175.1">:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.176.1">package.json</span></p>
<pre class="source-code" lang="en-GB"><span class="koboSpan" id="kobo.177.1">{
  "name": "@foo/bar",
  // ... </span><span class="koboSpan" id="kobo.177.2">like beforehand
  "publishConfig": {
    "access": "public"
  }
}</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.178.1">Alternatively, the access configuration could also be set directly when using the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.179.1">npm publish</span></strong><span class="koboSpan" id="kobo.180.1"> command with the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.181.1">--</span></strong><span class="No-Break" lang=""><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.182.1">access=publish</span></strong></span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.183.1"> flag.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.184.1">So far, we have only discussed how we can publish something to the official npm registry. </span><span class="koboSpan" id="kobo.184.2">What about choosing some other npm registry? </span><span class="koboSpan" id="kobo.184.3">For this, we need to change the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.185.1">.</span></strong><span class="No-Break" lang=""><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.186.1">npmrc</span></strong></span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.187.1"> file.</span></span></p>
<h1 id="_idParaDest-84" lang="en-GB"><a id="_idTextAnchor083"/><span class="koboSpan" id="kobo.188.1">Selecting another npm registry via .npmrc</span></h1>
<p lang="en-GB"><span class="koboSpan" id="kobo.189.1">To configure the</span><a id="_idIndexMarker300"/><span class="koboSpan" id="kobo.190.1"> behavior of npm, a special file called </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.191.1">.npmrc</span></strong><span class="koboSpan" id="kobo.192.1"> is used. </span><span class="koboSpan" id="kobo.192.2">We’ve already briefly touched on this file in </span><a href="B18989_03.xhtml#_idTextAnchor033"><span class="No-Break" lang=""><em class="italic" lang=""><span class="koboSpan" id="kobo.193.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.194.1">, </span><em class="italic" lang=""><span class="koboSpan" id="kobo.195.1">Choosing a Package Manager</span></em><span class="koboSpan" id="kobo.196.1">. </span><span class="koboSpan" id="kobo.196.2">This file </span><a id="_idIndexMarker301"/><span class="koboSpan" id="kobo.197.1">can be used not only to determine the source of the packages but also to define where to </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.198.1">publish to.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.199.1">A simple modification might look </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.200.1">as follows:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.201.1">.npmrc</span></p>
<pre class="source-code" lang="en-GB"><span class="koboSpan" id="kobo.202.1">; Lines starting with a semicolon or
# with a hash symbol are comments
registry=https://mycustomregistry.example.org</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.203.1">This way, all installations and publish attempts will be performed at </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.204.1">https://mycustomregistry.example.org</span></strong><span class="koboSpan" id="kobo.205.1"> instead of the official registry located </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.206.1">at </span></span><span class="No-Break" lang=""><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.207.1">https://registry.npmjs.org</span></strong></span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.208.1">.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.209.1">Quite often, this extreme approach is unnecessary or even unwanted. </span><span class="koboSpan" id="kobo.209.2">Instead, you might only want to use </span><a id="_idIndexMarker302"/><span class="koboSpan" id="kobo.210.1">another registry for a subset of the packages. </span><span class="koboSpan" id="kobo.210.2">In the most common case, the subset is already defined by </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.211.1">a scope.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.212.1">Let’s say the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.213.1">@foo</span></strong><span class="koboSpan" id="kobo.214.1"> scope that </span><a id="_idIndexMarker303"/><span class="koboSpan" id="kobo.215.1">we used in the previous section with the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.216.1">@foo/bar</span></strong><span class="koboSpan" id="kobo.217.1"> package should be bound to a custom registry, while all the other packages can still be resolved by the official one. </span><span class="koboSpan" id="kobo.217.2">The following </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.218.1">.npmrc</span></strong> <span class="No-Break" lang=""><span class="koboSpan" id="kobo.219.1">covers this:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.220.1">.npmrc</span></p>
<pre class="source-code" lang="en-GB"><span class="koboSpan" id="kobo.221.1">@foo:registry=https://mycustomregistry.example.org</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.222.1">While the local </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.223.1">.npmrc</span></strong><span class="koboSpan" id="kobo.224.1"> – that is, the one adjacent to a </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.225.1">package.json</span></strong><span class="koboSpan" id="kobo.226.1"> of a project – should be used to define the registries, a global </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.227.1">.npmrc</span></strong><span class="koboSpan" id="kobo.228.1"> – located in your home directory – should be used to provide information regarding authentication. </span><span class="koboSpan" id="kobo.228.2">Quite often, a private registry can only be used with such </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.229.1">authentication information:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.230.1">~/.npmrc</span></p>
<pre class="source-code" lang="en-GB"><span class="koboSpan" id="kobo.231.1">//mycustomregistry.example.org/:username="myname"
//mycustomregistry.example.org/:_password="mysecret"
//mycustomregistry.example.org/:email=foo@bar.com
always-auth=true</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.232.1">The </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.233.1">always-auth</span></strong><span class="koboSpan" id="kobo.234.1"> setting is used to tell </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.235.1">npm</span></strong><span class="koboSpan" id="kobo.236.1"> that even </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.237.1">GET</span></strong><span class="koboSpan" id="kobo.238.1"> requests – that is, requests for resolving or </span><a id="_idIndexMarker304"/><span class="koboSpan" id="kobo.239.1">downloading packages – need to use the </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.240.1">provided authentication.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.241.1">An easy way to test</span><a id="_idIndexMarker305"/><span class="koboSpan" id="kobo.242.1"> custom configuration is to roll out your own npm registry. </span><span class="koboSpan" id="kobo.242.2">A good way of doing that locally is to use the open source </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.243.1">project </span></span><span class="No-Break" lang=""><strong class="bold" lang=""><span class="koboSpan" id="kobo.244.1">Verdaccio</span></strong></span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.245.1">.</span></span></p>
<h1 id="_idParaDest-85" lang="en-GB"><a id="_idTextAnchor084"/><span class="koboSpan" id="kobo.246.1">Setting up Verdaccio</span></h1>
<p lang="en-GB"><span class="koboSpan" id="kobo.247.1">There are a couple </span><a id="_idIndexMarker306"/><span class="koboSpan" id="kobo.248.1">of commercial registry options out there. </span><span class="koboSpan" id="kobo.248.2">Arguably, the most popular option is to get a pro plan for the official npm registry. </span><span class="koboSpan" id="kobo.248.3">This way, you’ll be able to publish and manage private packages. </span><span class="koboSpan" id="kobo.248.4">Whatever option you pick, you will always have to use a cloud version for publishing </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.249.1">your packages.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.250.1">Especially for playing around with the publishing process, having a registry locally would be great. </span><span class="koboSpan" id="kobo.250.2">A great option is to leverage </span><strong class="bold" lang=""><span class="koboSpan" id="kobo.251.1">Verdaccio</span></strong><span class="koboSpan" id="kobo.252.1"> for this. </span><span class="koboSpan" id="kobo.252.2">Verdaccio can be either run by cloning the Verdaccio code repository, running the </span><strong class="bold" lang=""><span class="koboSpan" id="kobo.253.1">Docker</span></strong><span class="koboSpan" id="kobo.254.1"> container provided by Verdaccio, or </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.255.1">using </span></span><span class="No-Break" lang=""><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.256.1">npx</span></strong></span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.257.1">.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.258.1">Let’s go for the </span><span class="No-Break" lang=""><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.259.1">npx</span></strong></span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.260.1"> approach:</span></span></p>
<pre class="console" lang="en-GB"><span class="koboSpan" id="kobo.261.1">
$ npx verdaccio

 warn --- config file  - ~/.config/verdaccio/config.yaml

 info --- plugin successfully loaded: verdaccio-htpasswd

 info --- plugin successfully loaded: verdaccio-audit

 warn --- http address - http://localhost:4873/ - verdaccio/5.14.0</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.262.1">Now that Verdaccio is running, you can go to the URL shown in the console. </span><span class="koboSpan" id="kobo.262.2">You should see Verdaccio’s home page as shown in </span><span class="No-Break" lang=""><em class="italic" lang=""><span class="koboSpan" id="kobo.263.1">Figure 8</span></em></span><span class="No-Break" lang=""><em class="italic" lang=""><span class="koboSpan" id="kobo.264.1">.3</span></em></span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.265.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer102">
<span class="koboSpan" id="kobo.266.1"><img alt="Figure 8.3 – The home page of Verdaccio with publishing instructions " src="image/Figure_8.3_B18989.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.267.1">Figure 8.3 – The home page of Verdaccio with publishing instructions</span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.268.1">Let’s say we want to publish the package we created earlier to Verdaccio instead of the official npm registry. </span><span class="koboSpan" id="kobo.268.2">The steps we need</span><a id="_idIndexMarker307"/><span class="koboSpan" id="kobo.269.1"> to follow </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.270.1">are these:</span></span></p>
<ol>
<li lang="en-GB"><span class="koboSpan" id="kobo.271.1">Authenticate against the new registry (in Verdaccio, you can use whatever credentials you’d like by default, but </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.272.1">npm</span></strong><span class="koboSpan" id="kobo.273.1"> requires you </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.274.1">to authenticate)</span></span></li>
<li lang="en-GB"><span class="koboSpan" id="kobo.275.1">Either configure the URL to your running instance of Verdaccio via a </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.276.1">.npmrc</span></strong><span class="koboSpan" id="kobo.277.1"> file or by explicitly using the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.278.1">--registry</span></strong><span class="koboSpan" id="kobo.279.1"> flag with the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.280.1">npm </span></strong><span class="No-Break" lang=""><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.281.1">publish</span></strong></span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.282.1"> command</span></span></li>
</ol>
<p lang="en-GB"><span class="koboSpan" id="kobo.283.1">In practice, these two steps look </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.284.1">as follows:</span></span></p>
<pre class="console" lang="en-GB"><span class="koboSpan" id="kobo.285.1">
$ npm adduser --registry http://localhost:4873/

Username: foo

Password:

Email: (this IS public) foo@bar.com

Logged in as foo on http://localhost:4873/.

</span><span class="koboSpan" id="kobo.285.2">$ npm publish --registry http://localhost:4873

npm notice

npm notice </span><span class="koboSpan" id="kobo.286.1"><img alt="" src="image/015.png"/></span><span class="koboSpan" id="kobo.287.1">  lib-test-florian-rappl@1.0.0

npm notice === Tarball Contents ===

npm notice 1.5kB lib/index.js

npm notice 425B  src/index.js

npm notice 344B  package.json

npm notice === Tarball Details ===

npm notice name:          lib-test-florian-rappl

npm notice version:       1.0.0

npm notice package size:  1.1 kB

npm notice unpacked size: 2.3 kB

npm notice shasum:        2b5d224949f9112eeaee435a876a8ea15ed3e7cd

npm notice integrity:     sha512-cBq1czwmN4vep[...]/vXrORFGjRjnA==

npm notice total files:   3

npm notice

+ lib-test-florian-rappl@1.0.0</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.288.1">Once published, the package is also listed on the website of the Verdaccio instance accessible at http://localhost:4873/. </span><span class="koboSpan" id="kobo.288.2">This, of course, is mostly useful for testing out a publishing process or for speeding up npm installations with a local cache. </span><span class="koboSpan" id="kobo.288.3">Most of the time, having a local</span><a id="_idIndexMarker308"/><span class="koboSpan" id="kobo.289.1"> npm registry is not </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.290.1">really necessary.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.291.1">One question might come up at this point: how can we make sure that a published package can be used by most users? </span><span class="koboSpan" id="kobo.291.2">What requirements need to be fulfilled for actually using a package in a client-based application running in the browser, as well as in a server-based application running </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.292.1">in Node.js?</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.293.1">The concept of being pretty much target-independent is called being isomorphic. </span><span class="koboSpan" id="kobo.293.2">The terminology itself does not go uncriticized and some people actually prefer to call it universal. </span><span class="koboSpan" id="kobo.293.3">Having</span><a id="_idIndexMarker309"/><span class="koboSpan" id="kobo.294.1"> isomorphic code is great for gaining flexibility. </span><span class="koboSpan" id="kobo.294.2">Let’s see what is needed to deploy </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.295.1">isomorphic packages.</span></span></p>
<h1 id="_idParaDest-86" lang="en-GB"><a id="_idTextAnchor085"/><span class="koboSpan" id="kobo.296.1">Writing isomorphic libraries</span></h1>
<p lang="en-GB"><span class="koboSpan" id="kobo.297.1">The holy grail of web </span><a id="_idIndexMarker310"/><span class="koboSpan" id="kobo.298.1">development is the ability to write code not solely for the frontend or the backend but for both parts. </span><span class="koboSpan" id="kobo.298.2">Many frameworks and tools try to give us </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.299.1">this capability.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.300.1">To be accessible to multiple platforms, we not only need to ship multiple variants of our code but also only use APIs that are available on all supported platforms. </span><span class="koboSpan" id="kobo.300.2">For instance, if you want to make an HTTP request, then using </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.301.1">fetch</span></strong><span class="koboSpan" id="kobo.302.1"> would be the right call for modern browsers. </span><span class="koboSpan" id="kobo.302.2">However, </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.303.1">fetch</span></strong><span class="koboSpan" id="kobo.304.1"> was not available in less recent versions of Node.js. </span><span class="koboSpan" id="kobo.304.2">Therefore, you might need to solve </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.305.1">this differently.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.306.1">In the case of HTTP requests, there are already isomorphic libraries available – that is, libraries that will just do the right thing depending on the target runtime. </span><span class="koboSpan" id="kobo.306.2">You should only depend on </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.307.1">these libraries.</span></span></p>
<p class="callout-heading" lang="en-GB"><span class="koboSpan" id="kobo.308.1">Isomorphic fetch</span></p>
<p class="callout" lang="en-GB"><span class="koboSpan" id="kobo.309.1">The HTTP request problem can be solved in many ways – that is, by choosing an isomorphic library such as </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.310.1">axios</span></strong><span class="koboSpan" id="kobo.311.1"> or </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.312.1">isomorphic-fetch</span></strong><span class="koboSpan" id="kobo.313.1">, the issue can be delegated to a dependency. </span><span class="koboSpan" id="kobo.313.2">The advantage of this method is that we do not need to find out what ways we need to follow on each platform. </span><span class="koboSpan" id="kobo.313.3">Additionally, testing and verification are much simpler </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.314.1">that way.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.315.1">For now, we will focus on providing multiple variants. </span><span class="koboSpan" id="kobo.315.2">If we want to publish our library with support for multiple module formats – say CommonJS and ESM – we can do that by extending the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.316.1">package.json</span></strong><span class="koboSpan" id="kobo.317.1">. </span><span class="koboSpan" id="kobo.317.2">Setting </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.318.1">type</span></strong><span class="koboSpan" id="kobo.319.1"> to </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.320.1">module</span></strong><span class="koboSpan" id="kobo.321.1"> will tell Node.js that the module referenced by the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.322.1">main</span></strong><span class="koboSpan" id="kobo.323.1"> field actually follows ESM. </span><span class="koboSpan" id="kobo.323.2">In addition, we can define all of the package’s exports explicitly – with an additional option to define what module to use depending on the used target platform and </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.324.1">module system.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.325.1">Let’s see an example of this kind </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.326.1">of configuration:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.327.1">package.json</span></p>
<pre class="source-code" lang="en-GB"><span class="koboSpan" id="kobo.328.1">{
  // ... </span><span class="koboSpan" id="kobo.328.2">like beforehand
  "type": "module",
  "main": "dist/index.js",
  "exports": {
    ".": {
      "browser": {
        "require": "./lib/index.min.js",
        "default": "./dist/index.min.js"
      },
      "default": {
        "require": "./lib/index.js",
        "default": "./dist/index.js"
      }
    }
  }
}</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.329.1">In the case of our small library, there is a significant difference between the browser version and the non-browser</span><a id="_idIndexMarker311"/><span class="koboSpan" id="kobo.330.1"> version. </span><span class="koboSpan" id="kobo.330.2">However, for optimization, we’ve used minified modules for the browser, while all other platforms including Node.js will resolve to </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.331.1">non-minified modules.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.332.1">To create output suitable for CommonJS, we can use the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.333.1">build</span></strong><span class="koboSpan" id="kobo.334.1"> script that we’ve </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.335.1">derived already:</span></span></p>
<pre class="console" lang="en-GB"><span class="koboSpan" id="kobo.336.1">
$ esbuild src/*.js --platform=node --outdir=lib --format=cjs</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.337.1">The output for ESM is similar, but contains one </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.338.1">important change:</span></span></p>
<pre class="console" lang="en-GB"><span class="koboSpan" id="kobo.339.1">
$ esbuild src/*.js --platform=node --outdir=dist --format=esm --define:__dirname="'.'"</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.340.1">The crucial change is to avoid using the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.341.1">__dirname</span></strong><span class="koboSpan" id="kobo.342.1"> global variable, which only works in Node.js using CommonJS. </span><span class="koboSpan" id="kobo.342.2">Instead, we just use the current directory. </span><span class="koboSpan" id="kobo.342.3">The change is not perfect, but should get the </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.343.1">job done.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.344.1">Right now, everything seems to be well prepared – but actually, it’s not. </span><span class="koboSpan" id="kobo.344.2">The most important thing is still missing – the removal of the Node.js inbuilt package references. </span><span class="koboSpan" id="kobo.344.3">Our simple library references </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.345.1">fs</span></strong><span class="koboSpan" id="kobo.346.1"> and </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.347.1">path</span></strong><span class="koboSpan" id="kobo.348.1">, but these packages do not exist in the browser. </span><span class="koboSpan" id="kobo.348.2">They would not </span><a id="_idIndexMarker312"/><span class="koboSpan" id="kobo.349.1">know how to work there. </span><span class="koboSpan" id="kobo.349.2">Luckily, in this case, we have multiple solutions. </span><span class="koboSpan" id="kobo.349.3">The best one is arguably to replace the dynamic file read with a static import of the </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.350.1">package’s </span></span><span class="No-Break" lang=""><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.351.1">package.json</span></strong></span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.352.1">:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.353.1">index.js</span></p>
<pre class="source-code" lang="en-GB"><span class="koboSpan" id="kobo.354.1">import { name, version } from '../package.json';
export function getLibName() {
  return `${name}@${version}`;
}</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.355.1">Of course, this kind of algorithmic change is not always possible. </span><span class="koboSpan" id="kobo.355.2">In the given scenario, we also benefit from </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.356.1">esbuild</span></strong><span class="koboSpan" id="kobo.357.1">’s bundle option, which will include the necessary parts from the referenced JSON file to produce an output file that matches </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.358.1">our expectations.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.359.1">With these changes in mind, let’s see how the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.360.1">build</span></strong><span class="koboSpan" id="kobo.361.1"> scripts </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.362.1">are defined:</span></span></p>
<pre class="source-code" lang="en-GB"><span class="koboSpan" id="kobo.363.1">{
  // ... </span><span class="koboSpan" id="kobo.363.2">like beforehand
  "scripts": {
    "build-cjs-node": "esbuild src/*.js --platform=node
      --outdir=lib --format=cjs",
    "build-cjs-browser": "esbuild src/*.js --platform=node
      --outdir=lib --bundle --format=cjs --minify --entry-
      names=[name].min",
    "build-cjs": "npm run build-cjs-node &amp;&amp; npm run build-
      cjs-browser",
    "build-esm-node": "esbuild src/*.js --platform=node
      --outdir=dist --format=esm",
    "build-esm-browser": "esbuild src/*.js --platform=node
      --outdir=dist --bundle --format=esm --minify --entry-
      names=[name].min",
    "build-esm": "npm run build-esm-node &amp;&amp; npm run build-
      esm-browser",
    "build": "npm run build-cjs &amp;&amp; npm run build-esm"
  }
}</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.364.1">It makes sense to define the scripts so that they can be run independently but also conveniently together without much effort. </span><span class="koboSpan" id="kobo.364.2">In many cases, the tool you’ve chosen has to be configured extensively to have the desired behavior. </span><span class="koboSpan" id="kobo.364.3">In the case of our example, </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.365.1">esbuild</span></strong><span class="koboSpan" id="kobo.366.1"> was already quite</span><a id="_idIndexMarker313"/><span class="koboSpan" id="kobo.367.1"> equipped for the task – everything that we needed could be done via the </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.368.1">command-line options.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.369.1">One additional case that can be covered with an npm package is to actually provide a tool. </span><span class="koboSpan" id="kobo.369.2">Ideally, these are tools to be run with Node.js making it a cross-platform tool. </span><span class="koboSpan" id="kobo.369.3">Let’s see how we can write and publish this kind </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.370.1">of tool.</span></span></p>
<h1 id="_idParaDest-87" lang="en-GB"><a id="_idTextAnchor086"/><span class="koboSpan" id="kobo.371.1">Publishing a cross-platform tool</span></h1>
<p lang="en-GB"><span class="koboSpan" id="kobo.372.1">Node.js would not be so powerful without its </span><a id="_idIndexMarker314"/><span class="koboSpan" id="kobo.373.1">ecosystem. </span><span class="koboSpan" id="kobo.373.2">As we learned in </span><a href="B18989_01.xhtml#_idTextAnchor015"><span class="No-Break" lang=""><em class="italic" lang=""><span class="koboSpan" id="kobo.374.1">Chapter 1</span></em></span></a><span class="koboSpan" id="kobo.375.1">, </span><em class="italic" lang=""><span class="koboSpan" id="kobo.376.1">Learning the Internals of Node.js</span></em><span class="koboSpan" id="kobo.377.1">, relying on the power of its ecosystem was an elementary design decision. </span><span class="koboSpan" id="kobo.377.2">Here, npm takes the leading role by defining the package metadata in </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.378.1">package.json</span></strong><span class="koboSpan" id="kobo.379.1">, as well as the installation </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.380.1">of packages.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.381.1">During the installation of a package, a couple of things are happening. </span><span class="koboSpan" id="kobo.381.2">After the package has been downloaded, it will be copied to a target directory. </span><span class="koboSpan" id="kobo.381.3">For a local installation with </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.382.1">npm</span></strong><span class="koboSpan" id="kobo.383.1">, this is the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.384.1">node_modules</span></strong><span class="koboSpan" id="kobo.385.1"> folder. </span><span class="koboSpan" id="kobo.385.2">For a global installation with </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.386.1">npm</span></strong><span class="koboSpan" id="kobo.387.1">, the target will be globally available in your home directory. </span><span class="koboSpan" id="kobo.387.2">There is, however, one more thing to do. </span><span class="koboSpan" id="kobo.387.3">If the package contains a tool, then </span><a id="_idIndexMarker315"/><span class="koboSpan" id="kobo.388.1">a reference to the tool will be put into a special directory, which is </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.389.1">node_modules/.bin</span></strong><span class="koboSpan" id="kobo.390.1"> for a </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.391.1">local installation.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.392.1">If you go back to the code from the previous chapter, you will see that, for example, </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.393.1">jest</span></strong><span class="koboSpan" id="kobo.394.1"> is available in </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.395.1">node_modules/.bin</span></strong><span class="koboSpan" id="kobo.396.1">. </span><span class="koboSpan" id="kobo.396.2">This is the same </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.397.1">jest</span></strong><span class="koboSpan" id="kobo.398.1"> executable that we started with </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.399.1">npx</span></strong><span class="koboSpan" id="kobo.400.1">. </span><span class="koboSpan" id="kobo.400.2">Let’s take </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.401.1">the following:</span></span></p>
<pre class="console" lang="en-GB"><span class="koboSpan" id="kobo.402.1">
$ ./node_modules/.bin/jest --help</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.403.1">We can compare it </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.404.1">to this:</span></span></p>
<pre class="console" lang="en-GB"><span class="koboSpan" id="kobo.405.1">
$ npx jest --help</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.406.1">Both will yield the same result. </span><span class="koboSpan" id="kobo.406.2">The reason is that </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.407.1">npx</span></strong><span class="koboSpan" id="kobo.408.1"> for local installation is just a convenient tool to avoid writing out the path. </span><span class="koboSpan" id="kobo.408.2">As a reminder, you should opt for local installations over </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.409.1">global installations.</span></span></p>
<p class="callout-heading" lang="en-GB"><span class="koboSpan" id="kobo.410.1">npx and npm</span></p>
<p class="callout" lang="en-GB"><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.411.1">npx</span></strong><span class="koboSpan" id="kobo.412.1"> is another command that comes together with the installation of npm. </span><span class="koboSpan" id="kobo.412.2">From a command perspective, </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.413.1">npm</span></strong><span class="koboSpan" id="kobo.414.1"> is used to manage the dependencies, while </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.415.1">npx</span></strong><span class="koboSpan" id="kobo.416.1"> is used to run packages. </span><span class="koboSpan" id="kobo.416.2">The </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.417.1">npm</span></strong><span class="koboSpan" id="kobo.418.1"> utility also has a </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.419.1">run</span></strong><span class="koboSpan" id="kobo.420.1"> subcommand, which runs commands that are defined in the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.421.1">scripts</span></strong><span class="koboSpan" id="kobo.422.1"> section of </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.423.1">package.json</span></strong><span class="koboSpan" id="kobo.424.1">, whereas </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.425.1">npx</span></strong><span class="koboSpan" id="kobo.426.1"> runs commands as defined in the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.427.1">bin</span></strong><span class="koboSpan" id="kobo.428.1"> section of </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.429.1">npm packages.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.430.1">Now, the question is how can we create a package that also adds a script to the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.431.1">.bin</span></strong><span class="koboSpan" id="kobo.432.1"> folder so that it just works when installed? </span><span class="koboSpan" id="kobo.432.2">The answer lies in the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.433.1">package.json</span></strong><span class="koboSpan" id="kobo.434.1"> of our </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.435.1">previous library.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.436.1">Let’s modify </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.437.1">package.json</span></strong> <span class="No-Break" lang=""><span class="koboSpan" id="kobo.438.1">a bit:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.439.1">package.json</span></p>
<pre class="source-code" lang="en-GB"><span class="koboSpan" id="kobo.440.1">{
  "name": "@foo/tool",
  "version": "1.0.0",
  "description": "A simple tool greeting the user.",
  "bin": {
    "hello": "lib/hello.js"
  },
  "license": "MIT"
}</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.441.1">We added a </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.442.1">bin</span></strong><span class="koboSpan" id="kobo.443.1"> section that defines a single script to be referenced from the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.444.1">.bin</span></strong><span class="koboSpan" id="kobo.445.1"> directory. </span><span class="koboSpan" id="kobo.445.2">The reference should be called </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.446.1">hello</span></strong><span class="koboSpan" id="kobo.447.1"> and pointed to the </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.448.1">lib/hello.js</span></strong><span class="koboSpan" id="kobo.449.1"> file within </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.450.1">this package.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.451.1">Let’s also add the </span><a id="_idIndexMarker316"/><span class="koboSpan" id="kobo.452.1">script to run when </span><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.453.1">hello</span></strong> <span class="No-Break" lang=""><span class="koboSpan" id="kobo.454.1">is called:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.455.1">hello.js</span></p>
<pre class="source-code" lang="en-GB"><span class="koboSpan" id="kobo.456.1">#!/usr/bin/env node
// check that at least one argument has been provided
if (process.argv.length &lt; 3) {
  console.log("No argument provided.");
  return process.exit(1);
}
// take the last argument
const name = process.argv.pop();
console.log(`Hello ${name}!`);</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.457.1">This will essentially check whether at least one argument was given and print a message in the console using the </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.458.1">last argument.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.459.1">Let’s see the behavior when running directly </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.460.1">via </span></span><span class="No-Break" lang=""><strong class="source-inline" lang=""><span class="koboSpan" id="kobo.461.1">node</span></strong></span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.462.1">:</span></span></p>
<pre class="console" lang="en-GB"><span class="koboSpan" id="kobo.463.1">
$ node hello.js

No argument provided.

</span><span class="koboSpan" id="kobo.463.2">$ node index.js foo

Hello foo!</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.464.1">Now, the package can be published as before – for example, by choosing our local </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.465.1">Verdaccio instance:</span></span></p>
<pre class="console" lang="en-GB"><span class="koboSpan" id="kobo.466.1">
$ npm publish --registry http://localhost:4873</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.467.1">In a new project, you can now install the dependency and run </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.468.1">the tool:</span></span></p>
<pre class="console" lang="en-GB"><span class="koboSpan" id="kobo.469.1">
$ npm install @foo/tool --registry http://localhost:4873

$ npx hello bar

Hello bar!</span></pre>
<p lang="en-GB"><span class="koboSpan" id="kobo.470.1">With that, we have seen</span><a id="_idIndexMarker317"/><span class="koboSpan" id="kobo.471.1"> the most crucial aspects regarding the publishing process of npm packages. </span><span class="koboSpan" id="kobo.471.2">Let’s recap what we </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.472.1">have learned.</span></span></p>
<h1 id="_idParaDest-88" lang="en-GB"><a id="_idTextAnchor087"/><span class="koboSpan" id="kobo.473.1">Summary</span></h1>
<p lang="en-GB"><span class="koboSpan" id="kobo.474.1">In this chapter, you have learned about what it takes to publish a package to an npm registry – whether it is an official or private one. </span><span class="koboSpan" id="kobo.474.2">You also touched on a commonly used npm registry in the form </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.475.1">of Verdaccio.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.476.1">Equipped with the knowledge from this chapter, you should now be able to write reusable libraries that work in browser-based applications as well as in Node.js-based applications. </span><span class="koboSpan" id="kobo.476.2">You are also now capable of publishing tools that are based on Node.js. </span><span class="koboSpan" id="kobo.476.3">In a sense, these tools are just libraries with some additional fields in their associated </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.477.1">package metadata.</span></span></p>
<p lang="en-GB"><span class="koboSpan" id="kobo.478.1">In the next chapter, we will have a look at a different approach to structuring code – placing multiple packages in a single repository known as </span><span class="No-Break" lang=""><span class="koboSpan" id="kobo.479.1">a monorepo.</span></span></p>
</div>
</body></html>