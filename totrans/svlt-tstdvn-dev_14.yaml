- en: '14'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Testing Authentication
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Many web applications will involve authenticating users. This chapter shows
    how you can write tests for this functionality. These tests cover logging in,
    logging out, and ensuring that your application is only accessible to logged-in
    users.
  prefs: []
  type: TYPE_NORMAL
- en: This chapter is not a walkthrough and only includes a small amount of detail
    on the application code required to implement authentication. The book repository
    uses the **Auth.js** library, but the same testing techniques will work regardless
    of the implementation approach.
  prefs: []
  type: TYPE_NORMAL
- en: 'The chapter covers the following key topics:'
  prefs: []
  type: TYPE_NORMAL
- en: Testing authentication with Playwright
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Testing authentication with Vitest
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: By the end of the chapter, you’ll have seen how to write tests that cover all
    aspects of authentication.
  prefs: []
  type: TYPE_NORMAL
- en: Technical requirements
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The code for the chapter can be found online at [https://github.com/PacktPublishing/Svelte-with-Test-Driven-Development/tree/main/Chapter14/Complete](https://github.com/PacktPublishing/Svelte-with-Test-Driven-Development/tree/main/Chapter14/Complete).
  prefs: []
  type: TYPE_NORMAL
- en: If you want to run the code in this sample, you’ll need to create a `.env` file
    with some environment variables. There’s an example file named `.env.example`
    that you can copy and save as `.env`, which should work, but if you want to try
    the GitHub OAuth integration, you’ll need to do some configuration within GitHub.
  prefs: []
  type: TYPE_NORMAL
- en: You’ll find more detailed information in the repository’s `README.md` file.
  prefs: []
  type: TYPE_NORMAL
- en: Testing authentication with Playwright
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: This section details the groundwork required for effective testing with your
    Playwright tests. First, we look at how to provide hard-coded authentication credentials
    for your end-to-end tests. Then we use this to verify that users can log in and
    log out of the application. Finally, we’ll update the existing tests so that they
    ensure the user is logged in before attempting to test the application functionality.
  prefs: []
  type: TYPE_NORMAL
- en: What about Cucumber?
  prefs: []
  type: TYPE_NORMAL
- en: If you’re using Cucumber tests with Playwright, then the same techniques presented
    here will also work for you.
  prefs: []
  type: TYPE_NORMAL
- en: Creating an auth profile for dev and test modes
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: It’s fairly typical to use OAuth authentication strategies that delegate authentication
    responsibilities to a third-party provider, such as Google or GitHub. However,
    when it comes to writing end-to-end tests, it’s impractical to maintain user accounts
    with these third parties just for the purposes of testing. For one thing, account
    passwords expire and need to be reset periodically. And that kind of work needs
    to be documented, tracked and scheduled.
  prefs: []
  type: TYPE_NORMAL
- en: Another solution is to provide a special hard-coded credential that can be used
    to log in when the application server is run in a specific test mode. Your Playwright
    tests can then use this credential to log in.
  prefs: []
  type: TYPE_NORMAL
- en: 'Our solution does this in the following way:'
  prefs: []
  type: TYPE_NORMAL
- en: Playwright starts the server with an additional environment variable, `VITE_ALLOW_CREDENTIALS`,
    that is set to `true`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The `Auth.js` initialization code looks for this credential, and, if it is found,
    enables login via its credentials mechanism. There is a single user, `api`, which
    has no password associated with it.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: This user can then be used by both the API tests and your application dev mode.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'To ensure Playwright starts with the right environment variable, the `playwright.config.js`
    file changes like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'Then, the application has a file named `src/authProviders.js` that checks for
    the credential, shown in the following code snippet. This sample is specific to
    `Auth.js`, but other authentication libraries can be initialized similarly. The
    key point is that the expected `authProviders` is an array that may or may not
    contain the special credentials provider, depending on the value of the environment
    variable:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: With the application primed, it’s ready to be used in our tests.
  prefs: []
  type: TYPE_NORMAL
- en: Writing tests for login
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: It’s important to have one test for a successful login flow and one for an unsuccessful
    one. Having these tests ensures you have automated test coverage of these pages.
  prefs: []
  type: TYPE_NORMAL
- en: 'Here’s an example of a successful login test. It can be found in the `tests/login.test.js`
    repository file. It navigates to the usual `/birthdays` route, then looks for
    a button named `api` user, and clicks the button again (which, this time, acts
    to submit the login information). It then checks that the user has been redirected
    to the main page and can see the **Birthday** **list** heading:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: Note the use of the `page.waitForLoadState` Playwright function. This is necessary
    to ensure that all the relevant `Auth.js` code has run and eventually renders
    the sign-in button.
  prefs: []
  type: TYPE_NORMAL
- en: 'Next is the test for an unsuccessful login. For this, we can give any username
    other than `api`, so this test supplies the `unknown user` text, which gives the
    data some useful context:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: That covers the tests for the new login functionality. Next, we need to update
    existing tests to ensure they continue to work.
  prefs: []
  type: TYPE_NORMAL
- en: Updating existing tests to authenticate the user
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The existing tests we have in `tests/birthdays.test.js` need to be updated so
    that each test starts with a logged-in user. We can do this using a `beforeEach`
    block, which has the advantage that the original tests doesn’t need to be modified.
  prefs: []
  type: TYPE_NORMAL
- en: Auth.js provides a neat API-like endpoint that we can call directly. This means
    that we don’t need to navigate through the web form for each test, which reduces
    the amount of work each test needs to do.
  prefs: []
  type: TYPE_NORMAL
- en: 'The `login` function is defined in the following code snippet. It mimics the
    action of clicking the `username` field value of `api`. It’s also important to
    send the `origin` header with this request; otherwise, it will be rejected:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: 'That can then be triggered for each test in `tests/birthday.test.js` by sending
    it to `test.beforeEach`, like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: That completes the Playwright tests. You’ll note I’ve left out any test to check
    what happens when you go to the `/birthday` route in an unauthenticated state.
    We’ll cover that in the Vitest tests in the next section.
  prefs: []
  type: TYPE_NORMAL
- en: Testing authentication with Vitest
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Now we drop down a level and get into specifics. Our tests will focus on the
    `/birthdays` route and how it is presented given authentication data.
  prefs: []
  type: TYPE_NORMAL
- en: The Auth.js library utilizes SvelteKit’s session mechanism for passing authentication
    information into components, so what we do is harness that via the `parent.session`
    object and the `locals.getSession` function. All we have to do is use test doubles
    to mimic the responses we want.
  prefs: []
  type: TYPE_NORMAL
- en: We start by defining a session factory that can be used to set up these session
    test doubles. Then we’ll update page load tests with new authentication functionality,
    and finally, we’ll end with updating the form action tests.
  prefs: []
  type: TYPE_NORMAL
- en: Defining a session factory
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Here’s the definition of `src/factories/session.js`, which defines four exports
    that are used in the subsequent tests:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'A `loggedInSession` object can be used as the `parent` property that’s passed
    to your page load. The Auth.js authentication process will run before your route
    is loaded and merged into this `parent` value. So, `loggedInSession` is just a
    dummy object: in the context of our tests, any value at all constitutes a valid,
    logged-in user.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The `loggedOutSession` object is similar: this time, a `null` value for `session`
    means that the user is not authenticated.'
  prefs: []
  type: TYPE_NORMAL
- en: The `loggedInLocalsSession` and `loggedOutLocalsSession` values are to be used
    in place of SvelteKit’s `locals` property that is passed to your form action.
    This property is a collection of functions that the form action can make use of.
  prefs: []
  type: TYPE_NORMAL
- en: Next, we’ll see how to make use of these tests.
  prefs: []
  type: TYPE_NORMAL
- en: Updating existing tests for page load functions
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Now let’s update the page load function so that it has the necessary load function.
    We’ll also write a test to ensure that the page does *not* load any data if the
    user is not authenticated.
  prefs: []
  type: TYPE_NORMAL
- en: 'There’s a new import needed in `src/routes/birthdays/page.server.test.js`,
    shown in the following code block. These are the two factories that will be used
    to provide values for the `parent` property passed to the `load` function:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: 'Then, the `describe` block is updated to create a `parent` variable that is
    defaulted to a logged-in user:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: 'Each of the tests also needs to be updated to pass this new `parent` property
    into the `load` function:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: 'You’ll also want to add a test to check that the endpoint won’t work without
    the correct authentication. In the following example, we override the default
    `parent` property with `loggedOutSession` and then test that the returned page
    has a `303` status, meaning the browser is being redirected. It also checks the
    page being redirected to is the `/``login` route:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: That completes the tests for the `load` function.
  prefs: []
  type: TYPE_NORMAL
- en: Updating existing tests for form actions
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'For the form action tests, the `import` statement is updated with the remaining
    two factory functions:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: 'Then, the `describe` block is updated to include a `locals` variable that is
    set within `beforeEach`. Note that this time the variable is defined as `let`
    because the `loggedInLocalsSession` factory is responsible for setting up the
    `vi.fn` spy function:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: 'Then `performFormAction` changes to include the `locals` property. Since this
    is the function that our tests call to invoke the form action, none of the tests
    themselves need to change:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: 'Finally, we need a test to check what happens if the form is submitted when
    the user is not authenticated. In this case, we return a `300` status code rather
    than a redirect, but you could choose to go back to the previous form page, as
    you would with a validation error. That would help in the scenario where the user’s
    session has expired. Here’s the simpler version:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: That completes the Vitest changes required to support our authentication implementation.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: This chapter briefly looked at the kinds of tests you’ll need for testing authentication.
  prefs: []
  type: TYPE_NORMAL
- en: Playwright end-to-end tests should check the login flows, both successful and
    unsuccessful. They should also make use of fake credentials where possible and
    ensure that any routes are accessible only by authenticated users who are logged
    in using a `test.beforeEach` call.
  prefs: []
  type: TYPE_NORMAL
- en: 'Vitest tests for authenticated routes work differently. They focus on the `session`
    object that SvelteKit returns: does it have a valid value or not?'
  prefs: []
  type: TYPE_NORMAL
- en: 'While this covers the basics, most applications will have much more complex
    needs: for example, your application might have individual data stores for each
    user, not just one global data store such as our Birthdays application.'
  prefs: []
  type: TYPE_NORMAL
- en: The Playwright website contains good documentation on how to test specific patterns,
    such as having multiple user roles interact within one test. That can be found
    at [https://playwright.dev/docs/auth](https://playwright.dev/docs/auth).
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we’ll look at testing Svelte Stores.
  prefs: []
  type: TYPE_NORMAL
