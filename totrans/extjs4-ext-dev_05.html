<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Chart Downloader"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Chart Downloader</h1></div></div></div><p>In this chapter we are going to develop an Ext JS plugin, which will help us to download a chart as an image. This <a id="id207" class="indexterm"/>plugin will generate a button and when the button is clicked, it will perform the required functionality, such that the plugin container's chart item will be downloaded as an image.</p><p>In this chapter we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Functional requirements</li><li class="listitem" style="list-style-type: disc">Planning and coding the chart downloader</li></ul></div><div class="section" title="Functional requirements"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec37"/>Functional requirements</h1></div></div></div><p>We want to develop a plugin that will facilitate downloading a chart as an image. The plugin will <a id="id208" class="indexterm"/>generate a button at the container's bottom toolbar. If the container does not contain any toolbar at the bottom, this plugin should create a bottom toolbar for the container and then it will generate the button within the toolbar. When this button is clicked, the plugin will search for a chart item within the container and will download the chart as an image.</p></div></div>
<div class="section" title="Planning and coding the chart downloader"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec38"/>Planning and coding the chart downloader</h1></div></div></div><p>The plugin's container <a id="id209" class="indexterm"/>may or may not have the bottom bar, so we need to <a id="id210" class="indexterm"/>search for the bottom bar within the container. If found, we will use that, otherwise we need to create the bottom bar, and then we can add the download button to that bottom bar.</p><p>Now let us start coding for the plugin.</p><div class="informalexample"><pre class="programlisting">Ext.define('Examples.plugin.ChartDownload', {

  alias : 'plugin.chartdownload',

  config : {
    chartXtype: 'chart',
    downloadButtonText: 'Download as image',
    chartNotFoundErrorMsg: 'No valid chart type found!',
    errorText: 'Error'
  }
…</pre></div><p>Here we are providing a configuration option <code class="literal">chartXtype</code> so that we can configure this plugin with a <a id="id211" class="indexterm"/>proper xtype of the chart, which we are targeting to download as an image. Now let us <a id="id212" class="indexterm"/>define the<a id="id213" class="indexterm"/> required <code class="literal">init</code> function for this <a id="id214" class="indexterm"/>plugin:</p><div class="informalexample"><pre class="programlisting">init : function(container) {

  this.container = container;

  if (!container.rendered) {
    container.on('afterrender', this.handleAfterRender, this);
  } else {
    this.handleAfterRender();
  }

}</pre></div><p>And now let us define the <a id="id215" class="indexterm"/>
<code class="literal">handleAfterRender</code> function:</p><div class="informalexample"><pre class="programlisting">handleAfterRender : function(container) {

  this.chart = this.container.down(this.getChartXtype());

  if(!Ext.isDefined(this.chart) || this.chart ==null){
    Ext.Function.defer(function(){
      this.showErrorMessage({
        title: this.getErrorText(),
        text: this.getChartNotFoundErrorMsg()
      })
    }, 1000, this);
  }

  else{

    this.addDownloadButton();
  }

},</pre></div><p>In this function, we are trying to get the chart component, and if the chart component isn't found, we will show an error message. And if the chart component is found, we will call the <a id="id216" class="indexterm"/>
<code class="literal">addDownloadButton</code> function, which will create and add the download button. Now let us define the <code class="literal">addDownloadButton</code> function:</p><div class="informalexample"><pre class="programlisting">addDownloadButton: function(){

  var toolbar = this.getToolbar(),
  itemsToAdd = [],
  placeholder = '-&gt;',
  button = {
    iconCls : 'icon-export',
    text : this.getDownloadButtonText(),
    handler: this.saveChart,
    scope : this
  };

  if(toolbar.items.items.length === 0){
    itemsToAdd.push(placeholder);
  }

  itemsToAdd.push(button);
  toolbar.add(itemsToAdd); 
}</pre></div><p>In this <a id="id217" class="indexterm"/>function, first we are trying to get the bottom toolbar <a id="id218" class="indexterm"/>by calling the <code class="literal">getToolbar</code> function and <a id="id219" class="indexterm"/>then <a id="id220" class="indexterm"/>adding the download button to that toolbar. Now let us define the <code class="literal">getToolbar</code> function:</p><div class="informalexample"><pre class="programlisting">getToolbar: function(){

  var dockedItems = this.container.getDockedItems(),
  toolbar = null,
  hasToolbar = false;

  if(dockedItems.length&gt;0){
    Ext.each(dockedItems, function(item){
      if(item.xtype ==='toolbar' &amp;&amp; item.dock == 'bottom'){
        hasToolbar = true;
        toolbar = item;
        return false;
      }
    });
  }

  if(!hasToolbar){
    toolbar = this.container.addDocked({
      xtype: 'toolbar',
      dock: 'bottom'
    })[0];
  }

  return toolbar;

}</pre></div><p>You can see that in this function we are trying to get the container's bottom toolbar and if the toolbar is found, we are using that, and if not found, we are creating a new bottom toolbar. Now <a id="id221" class="indexterm"/>let us define the <code class="literal">saveChart</code> function<a id="id222" class="indexterm"/>, which will be<a id="id223" class="indexterm"/> called by clicking on <a id="id224" class="indexterm"/>the <span class="strong"><strong>Download</strong></span> button:</p><div class="informalexample"><pre class="programlisting">saveChart: function(){

  this.chart.save({
    type : 'image/png'
  });

}</pre></div><p>Here we use the plugin within a window:</p><div class="informalexample"><pre class="programlisting">Ext.define('Examples.view.chartdownloadplugin.ChartDownloadPluginWindow', {
  extend : 'Ext.Window',
  alias : 'widget.chartdownloadpluginwindow',
  requires : ['Examples.view.chartdownloadplugin.Chart',
             'Examples.plugin.ChartDownload'],

  constructor : function(config) {

    Ext.apply(this, {
      modal : true,
      width : 400,
      height : 300,
      title : 'ChartDownloadPlugin',
      layout : {
        type:'fit'
      },
      plugins:['chartdownload'],
        items : [Ext.create('Examples.view.chartdownloadplugin.Chart')],
      buttons : [{
        text : 'OK',
        handler : function() {
          this.close();
        },
        scope : this
      }]
    });
    this.callParent(arguments);
  }
});</pre></div><p>And the following <a id="id225" class="indexterm"/>screenshot is the output where we used our <a id="id226" class="indexterm"/>chart downloader <a id="id227" class="indexterm"/>plugin:</p><div class="mediaobject"><img src="graphics/3725OS_05_01.jpg" alt="Planning and coding the chart downloader"/></div><p>You can see that the <span class="strong"><strong>Download as image</strong></span> button is generated at the window's bottom bar, and users can download the image by clicking on this button.</p><p>Now let us test this with another container that has no bottom bar defined:</p><div class="informalexample"><pre class="programlisting">Ext.define('Examples.view.chartdownloadplugin.ChartDownloadPluginWindow', {
  extend : 'Ext.Window',
  alias : 'widget.chartdownloadpluginwindow',
  requires : ['Examples.view.chartdownloadplugin.Chart',
          'Examples.plugin.ChartDownload'],

  constructor : function(config) {

    Ext.apply(this, {
      modal : true,
      width : 400,
      height : 300,
      title : 'ChartDownloadPlugin',
      layout : {
        type:'fit'
      },
      items : [{
        xtype:'panel',
        plugins:['chartdownload'],
        layout:'fit',
        items:[Ext.create('Examples.view.chartdownloadplugin.Chart')]
      }],
      buttons : [{
        text : 'OK',
        handler : function() {
          this.close();
        },
        scope : this
      }]
    });
    this.callParent(arguments);

  }
});</pre></div><p>And <a id="id228" class="indexterm"/>the following <a id="id229" class="indexterm"/>screenshot is the <a id="id230" class="indexterm"/>output:</p><div class="mediaobject"><img src="graphics/3725OS_05_02.jpg" alt="Planning and coding the chart downloader"/></div><p>You can<a id="id231" class="indexterm"/> see that the download button is now generated within the <a id="id232" class="indexterm"/>nested <a id="id233" class="indexterm"/>panel's bottom bar.</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec39"/>Summary</h1></div></div></div><p>In this chapter we've developed an Ext JS plugin that can download a chart as an image. Through this chapter we've learned the way we can create the Ext JS plugins and how easily we can inject functionality through the Ext JS plugins. In the next chapter, we will go through a very popular plugin for grid searching, where users can select or deselect the grid columns on which they want to apply the search.</p></div></body></html>