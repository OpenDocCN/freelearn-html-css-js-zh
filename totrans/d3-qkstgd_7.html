<html><head></head><body>
        

                            
                    <h1 class="header-title">Using Physics to Create a Force-Directed Graph</h1>
                
            
            
                
<p>This chapter will cover how to make a force-directed graph that will visualize the relationships between various nodes.</p>
<p>In this lesson, you will learn about the following topics:</p>
<ul>
<li>Creating a physics-based force that will center nodes</li>
<li>Creating a physics-based force that make the nodes repel each other</li>
<li>Creating a physics-based force that will link the nodes to show their relationships</li>
</ul>
<p>The complete code for this section can be found at <a href="https://github.com/PacktPublishing/D3.js-Quick-Start-Guide/tree/master/Chapter07">https://github.com/PacktPublishing/D3.js-Quick-Start-Guide/tree/master/Chapter07</a>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">What is a force-directed graph?</h1>
                
            
            
                
<p>A <strong>force</strong>-<strong>directed</strong> <strong>graph</strong> is a graph that is affected by various forces (such as gravity and repulsion). It can be extremely helpful when creating graphs of relationships.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to set up a graph of relationships</h1>
                
            
            
                
<p>The following sections will provide an overview of what we're going to build. The overview will cover the display side and the physics side of the implementation.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Display</h1>
                
            
            
                
<p>The display aspect controls what we see; the display will include the following:</p>
<ul>
<li>A list of nodes representing people, displayed as circles</li>
<li>A list of links representing connections between people, displayed as lines</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Physics</h1>
                
            
            
                
<p>The physics of the simulation control how the elements interact, as follows:</p>
<ul>
<li>A centering force at the center of the SVG will draw all of the nodes toward it</li>
<li>A repulsive force on each node will prevent the nodes from getting too close to each other</li>
<li>Link forces will connect each of the nodes, so that they don't repel each other too much</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Setting up the HTML</h1>
                
            
            
                
<p>Our file will be a pretty standard <kbd>index.html</kbd> file, but we'll need two <kbd>&lt;g&gt;</kbd> elements, as follows:</p>
<ul>
<li>One to contain the nodes (<strong>people</strong>: circles)</li>
<li>One to contain the links (<strong>relationship</strong>: lines)</li>
</ul>
<p>Here's what our code should look like:</p>
<div><pre>&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8"&gt;
        &lt;title&gt;&lt;/title&gt;
        &lt;script src="img/d3.v5.min.js"&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;svg&gt;
            &lt;g id="nodes"&gt;&lt;/g&gt;
            &lt;g id="links"&gt;&lt;/g&gt;
        &lt;/svg&gt;
        &lt;script src="img/app.js" charset="utf-8"&gt;&lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre></div>
<p class="mce-root"/>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Setting up styling for nodes and links</h1>
                
            
            
                
<p>Create an <kbd>app.css</kbd> file for our circles (nodes/people) and lines (links/relationships), as follows:</p>
<div><pre>circle {
    fill: red;
    r: 5;
}

line {
    stroke: grey;
    stroke-width: 1;
}</pre></div>
<p>Don't forget to create a link to it in your <kbd>index.html</kbd> file, as follows:</p>
<div><pre>&lt;head&gt;
    &lt;link rel="stylesheet" href="app.css"&gt;
    &lt;script src="img/d3.v5.min.js"&gt;&lt;/script&gt;
&lt;/head&gt;</pre></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Setting up the SVG</h1>
                
            
            
                
<p>At the top of our <kbd>app.js</kbd> file, add the following:</p>
<div><pre>var WIDTH = 300;
var HEIGHT = 200;

d3.select("svg")
    .attr("width", WIDTH)
    .attr("height", HEIGHT);</pre></div>
<p>If we open <kbd>index.html</kbd> in Chrome and look at Elements in the Developer tools, we should see the following:</p>
<div><img class="aligncenter size-full wp-image-439 image-border" src="img/16f08b43-ba5d-4f3b-a62c-3b96f7d00010.png" style=""/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Adding data for people</h1>
                
            
            
                
<p>Let's create an array of people at the bottom of <kbd>app.js</kbd>, as follows:</p>
<div><pre>var nodesData =  [
    {"name": "Charlie"},<br/>    {"name": "Mac"},<br/>    {"name": "Dennis"},<br/>    {"name": "Dee"},<br/>    {"name": "Frank"},<br/>    {"name": "Cricket"}<br/>];</pre></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Adding data for relationships</h1>
                
            
            
                
<p>Now, let's create the relationships by adding the following array to the bottom of <kbd>app.js</kbd>. Note that the attributes must be <kbd>source</kbd> and <kbd>target</kbd>, in order for D3 to do its magic:</p>
<div><pre>var linksData = [
    {"source": "Charlie", "target": "Mac"},<br/>    {"source": "Dennis", "target": "Mac"},<br/>    {"source": "Dennis", "target": "Dee"},<br/>    {"source": "Dee", "target": "Mac"},<br/>    {"source": "Dee", "target": "Frank"},<br/>    {"source": "Cricket", "target": "Dee"}<br/>];</pre></div>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Add circles to the SVG</h1>
                
            
            
                
<p>Add the following to the bottom of <kbd>app.js</kbd>:</p>
<div><pre>var nodes = d3.select("#nodes")
    .selectAll("circle")
    .data(nodesData)
    .enter()
    .append("circle");</pre>
<p>This will create a circle for each element in our <kbd>nodesData</kbd> array. Our Developer  tools should look as follows:</p>
<div><img class="aligncenter size-full wp-image-440 image-border" src="img/58ec4cff-78b6-4ac3-a9c6-a43b50452483.png" style=""/></div>
</div>


            

            
        
    

        

                            
                    <h1 class="header-title">Adding lines to the SVG</h1>
                
            
            
                
<p>Add the following to the bottom of <kbd>app.js</kbd>:</p>
<div><pre>var links = d3.select("#links")
    .selectAll("line")
    .data(linksData)
    .enter()
    .append("line");</pre></div>
<p class="mce-root"/>
<p>This will create a line for each element in our <kbd>linksData</kbd> array. Our Developer tools should look as follows:</p>
<div><img src="img/753db92b-2732-4ce4-b2c2-ed84e79a3064.png" style=""/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Creating a simulation</h1>
                
            
            
                
<p>Now, we'll generate a simulation by adding the following to the bottom of <kbd>app.js</kbd>:</p>
<div><pre>d3.forceSimulation()</pre></div>
<p>Note that this simply creates a simulation; it doesn't specify how the simulation should run. Let's tell it which data to act on by modifying the previous line of code, as follows:</p>
<div><pre>d3.forceSimulation()
    .nodes(nodesData) // add this line</pre></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Specifying how the simulation affects visual elements</h1>
                
            
            
                
<p>At this point, our visualization still looks the same, as indicated by the following screenshot:</p>
<div><img src="img/c04f2e60-4f3f-4ee8-9c9e-8b1b079df294.png" style=""/></div>
<p>Let's make our simulation affect the circles/lines that we created, as follows:</p>
<ul>
<li>The simulation runs <strong>ticks</strong>, which run very quickly.  Think of this a series of steps that happen very quickly, like the ticking of a stopwatch, but faster.</li>
<li>Each time a new tick occurs, you can update the visual elements. This allows our simulation to animate.</li>
<li>D3 will calculate and tack positional data onto our regular data, so that we can make use of it.</li>
</ul>
<p>Add the following to the bottom of <kbd>app.js</kbd>:</p>
<div><pre>d3.forceSimulation()
    .nodes(nodesData)
    .on("tick", function(){
        nodes.attr("cx", function(datum) {return datum.x;})
            .attr("cy", function(datum) {return datum.y;});

        links.attr("x1", function(datum) {return datum.source.x;})
            .attr("y1", function(datum) {return datum.source.y;})
            .attr("x2", function(datum) {return datum.target.x;})
            .attr("y2", function(datum) {return datum.target.y;});
    });</pre></div>
<p>Now, our circles distance themselves from each other a little bit, but this is just a side effect of not having any forces attached to them. We'll add forces next:</p>
<div><img src="img/97c9e4f7-fe37-4ac5-9e5d-1dec8cfbb1e9.png"/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Creating forces</h1>
                
            
            
                
<p>Let's create a centering force at the center of screen, which will pull all of the elements toward it. Adjust the code that we added in the previous step, so that it looks as follows. Not that we only add <kbd>.force("center_force", d3.forceCenter(WIDTH / 2, HEIGHT / 2)) </kbd>to the previous code:</p>
<div><pre>d3.forceSimulation()
    .nodes(nodesData)<br/>    // add the line below this comment
    .force("center_force", d3.forceCenter(WIDTH / 2, HEIGHT / 2))             .on("tick", function(){
        nodes.attr("cx", function(datum) {return datum.x;})
            .attr("cy", function(datum) {return datum.y;});

        links.attr("x1", function(datum) {return datum.source.x;})
            .attr("y1", function(datum) {return datum.source.y;})
            .attr("x2", function(datum) {return datum.target.x;})
            .attr("y2", function(datum) {return datum.target.y;});
    });</pre></div>
<p>Now our circles are pulled towards the center of the SVG element:</p>
<div><img class="aligncenter size-full wp-image-444 image-border" src="img/351ca6f3-3830-4426-9944-bb434fdb8cdf.png" style=""/></div>
<p>Create a force on each of the nodes, so that they repel each other. Just like in the last step, we will only add <kbd>.force("charge_force", d3.forceManyBody())</kbd> to the previous code:</p>
<div><pre>d3.forceSimulation()
    .nodes(nodesData)
    .force("center_force", d3.forceCenter(WIDTH / 2, HEIGHT / 2))<br/>    // add the line below this comment
    .force("charge_force", d3.forceManyBody())
    .on("tick", function(){
        nodes.attr("cx", function(datum) {return datum.x;})
            .attr("cy", function(datum) {return datum.y;});

        links.attr("x1", function(datum) {return datum.source.x;})
            .attr("y1", function(datum) {return datum.source.y;})
            .attr("x2", function(datum) {return datum.target.x;})
            .attr("y2", function(datum) {return datum.target.y;});
    });</pre></div>
<p>You'll notice that the <kbd>cx</kbd>/<kbd>cy</kbd> values for the circles initially change rapidly, before finally stopping. This is because D3 is running a simulation. Note that <kbd>center_force</kbd> is trying to reach a state of equilibrium with <kbd>charge_force</kbd>. You'll even notice that when you first load the page, the circles move outward from the center. This is due to the same reason:</p>
<div><img class="aligncenter size-full wp-image-445 image-border" src="img/42db87cd-8b24-4e29-92d2-4547f86f2a31.png" style=""/></div>
<p>Finally, we'll create the links between the nodes, so that they don't repel each other too much. Just like in the last step, we will add the following code to the previous code:</p>
<pre>.force("links", d3.forceLink(linksData).id(function(datum){
    return datum.name
}).distance(160))</pre>
<p>Our last chunk of code should now look as follows:</p>
<div><pre>d3.forceSimulation()
    .nodes(nodesData)
    .force("center_force", d3.forceCenter(WIDTH / 2, HEIGHT / 2))
    .force("charge_force", d3.forceManyBody())<br/>    //add the three lines below this comment
    .force("links", d3.forceLink(linksData).id(function(datum){<br/>        return datum.name
    }).distance(160))
    .on("tick", function(){
        nodes.attr("cx", function(datum) {return datum.x; })
            .attr("cy", function(datum) {return datum.y; });

        links.attr("x1", function(datum) {return datum.source.x;})
            .attr("y1", function(datum) {return datum.source.y;})
            .attr("x2", function(datum) {return datum.target.x;})
            .attr("y2", function(datum) {return datum.target.y;});
    });</pre></div>
<ul>
<li>The d3.forceLink function takes the array of links. It then uses the source and target attributes of each link data object to connect the nodes via their <kbd>.name</kbd> properties (as specified in the return value of the function we just wrote).</li>
<li>You can tack on <kbd>.distance()</kbd> to specify how long the lines are visually between each circle.</li>
</ul>
<p>Finally, our graph looks as follows:</p>
<div><img src="img/8fe9b4bf-b520-4caf-92f6-216729eed8cf.png"/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Summary</h1>
                
            
            
                
<p>In this chapter, we used D3 to create a graph that visualizes relationships between various nodes of data. This can be very useful in scenarios such as graphing a friend network, showing parent/child company relationships, or displaying a company's staff hierarchy.</p>
<p>In <a href="9e68fb4c-044a-40ec-ba46-3181bc2b7b5f.xhtml">Chapter 8</a>, <em>Mapping</em>, we'll cover how to create a map from GeoJSON data.</p>


            

            
        
    </body></html>