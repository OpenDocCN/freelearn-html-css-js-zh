<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch09"/>Chapter 9. The App: Getting the Word Out via Twitter</h1></div></div></div><p>This chapter covers our second example of usage of third-party APIs—using the Twitter API as an example—and HTML5 form validation capabilities. Twitter is a social network that allows users to publish and view messages of up to 140 characters. This social network provides a public API that allows developers to do a variety of things. As an exercise, we are going to add Twitter OAuth authentication and message posting to MovieNow, introducing HTML5 form validation. </p><p>For this chapter, some basic skill on backend technologies is required. You can review the basics of PHP at the following location: <a class="ulink" href="http://php.net/manual/en/tutorial.php">http://php.net/manual/en/tutorial.php</a>.</p><p>Although we use PHP, it is possible to select another solution and its respective Twitter library (<a class="ulink" href="https://dev.twitter.com/docs/twitter-libraries">https://dev.twitter.com/docs/twitter-libraries</a>). There are libraries for Java, .NET, Ruby, and so on.</p><p>Through this chapter we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Registering our application</li><li class="listitem" style="list-style-type: disc">How to tweet in MovieNow</li><li class="listitem" style="list-style-type: disc">Authenticating</li><li class="listitem" style="list-style-type: disc">Posting tweets</li><li class="listitem" style="list-style-type: disc">New input field types</li></ul></div><div><div><div><div><h1 class="title"><a id="ch09lvl1sec71"/>Registering our application</h1></div></div></div><p>To use the Twitter AP<a id="id531" class="indexterm"/>I, we need a Twitter account to register our application. If you do not have a Twitter account, you can register one for free at <a class="ulink" href="http://www.twitter.co">http://www.twitter.com</a>.</p><p>After registering and logging in, you can go to the Twitter<a id="id532" class="indexterm"/> developer page at <a class="ulink" href="https://dev.twitter.com/">https://dev.twitter.com/</a>.<a id="id533" class="indexterm"/>
</p><div><img src="img/5689_09_01.jpg" alt="Registering our application"/></div><p>Click on the <strong>Create an app</strong> link and enter the <strong>Name</strong>, <strong>Description</strong>, and <strong>Website</strong> value of your application. <strong>Callback URL</strong> is the address to which your app will be redirected after users grant permissions to use their accounts. In this case, you can redirect to your index page. </p><div><img src="img/5689_09_02.jpg" alt="Registering our application"/></div><a id="id534" class="indexterm"/><p>After this you only need to accept the terms and conditions, enter the CAPTCHA, and click on <strong>Create your Twitter application</strong>.</p><p>Now that you have your Twitter application created, you can see its details in the following page. The most important parameters are <strong>Consume key</strong> and <strong>Consume secret</strong>, they are used to authenticate your pp. <a id="id535" class="indexterm"/>
</p><div><div><h3 class="title"><a id="tip47"/>Tip</h3><p>You shouldn't expose <strong>Consume key</strong> and <strong>Consume secret</strong> to the client. All sensitive data should be encrypted.</p></div></div><div><img src="img/5689_09_04.jpg" alt="Registering our application"/></div><a id="id536" class="indexterm"/><p>By default, Twitter has the <strong>Access</strong> level as <strong>Read only</strong>. We can go to the <strong>Settings</strong> tab, and set <strong>Read and Write</strong> in the <strong>Application Type</strong> section and upload an avatar for our application in the <strong>Application Icon</strong> section.</p><div><img src="img/5689_09_05.jpg" alt="Registering our application"/></div><a id="id537" class="indexterm"/><p>We are ready to start using the Twitter API.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec72"/>How to tweet in MovieNow?</h1></div></div></div><a id="id538" class="indexterm"/><a id="id539" class="indexterm"/><p>To tweet using MovieNow, we need two pieces of functionality: Twitter OAuth authentication and status update (tweet). </p><p>The workflow of our example is simple: the user authenticates using a <strong>Sign In</strong> button in the upper-right corner of MovieNow, then we show the username and avatar, and when the user drags a movie to select it (or clicks on iPhone and other drag-disabled devices), we show a tweet form with movie details, that can be posted by clicking on the <strong>Tweet</strong> button.</p><p>To simplify our example we are going to use a Twitter-async PHP library that wraps the Twitter API and provides asynchronous calls: <a class="ulink" href="https://github.com/jmathai/twitter-async">https://github.com/jmathai/twitter-async</a>. </p><div><div><h3 class="title"><a id="tip48"/>Tip</h3><p>Jaisen Mathai's Twitter-async documentation can be found at <a class="ulink" href="http://www.jaisenmathai.com/articles/twitter-async-documentation.html">http://www.jaisenmathai.com/articles/twitter-async-documentation.html</a>.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec73"/>Authenticating</h1></div></div></div><a id="id540" class="indexterm"/><p>Download the Twitter-async library and put it in a <code class="literal">lib</code> folder that we will create in the root of the application directory. We should have:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">EpiCurl.php</code> – abstracts the parallel processing using PHP <code class="literal">multi_curl</code> functions</li><li class="listitem" style="list-style-type: disc"><code class="literal">EpiOauth.php</code> – contains basic methods for OAuth authentication</li><li class="listitem" style="list-style-type: disc"><code class="literal">EpiTwitter.php</code> – extends <code class="literal">EpiOauth</code> and abstracts the Twitter API authentication and requests</li></ul></div><p>Additionally, we can create a PHP file called <code class="literal">secret.php</code> to store our <code class="literal">consume key</code> and <code class="literal">consume secret</code> (you can find them in your Twitter application account page).</p><div><pre class="programlisting">&lt;?php
  $consumer_key = "&lt;PLACE YOUR CONSUMER KEY HERE&gt;";
  $consumer_secret = "&lt;PLACE YOUR CONSUMER SECRET KEY HERE&gt;";
?&gt;</pre></div><p>We need to change our <code class="literal">index.html</code> page extension to <code class="literal">index.php</code> to add PHP code. After that we call the PHP <code class="literal">session_start</code> method to start a new session (or resume a previous one if one exists). Then, we import our libraries. Finally, we can instantiate the <code class="literal">EpiTwitter</code> class with our consumer key (<code class="literal">$consumer_key</code>) and consumer secret <code class="literal">($consume</code>
<code class="literal">_secret</code>). <a id="id541" class="indexterm"/>
</p><div><pre class="programlisting">&lt;?php
  session_start();
  include 'lib/EpiCurl.php';
  include 'lib/EpiOAuth.php';
  include 'lib/EpiTwitter.php';
  include 'lib/secret.php';
  $twitterObj = new EpiTwitter($consumer_key, $consumer_secret);
?&gt;</pre></div><p>
<code class="literal">$twitterObj</code> has the information needed to start a new Twitter OAuth session or get user information using the existing one. To show Twitter login or logged information we are going to have two possible cases in our <code class="literal">header</code>:</p><p>If user is not logged in and/or application is not authorized:</p><div><pre class="programlisting">&lt;header&gt;
  &lt;div class="logo"&gt;
  &lt;/div&gt;
  &lt;div class="twitter-info"&gt;
    &lt;a href='url'&gt;&lt;div class='twitter-signin'&gt;&lt;/div&gt;&lt;/a&gt;
  &lt;/div&gt;
&lt;/header&gt;</pre></div><p>If user is logged in:</p><div><pre class="programlisting">&lt;header&gt;
  &lt;div class="logo"&gt;
  &lt;/div&gt;
  &lt;div class="twitter-info"&gt;
    &lt;a href='http://www.twitter.com/username' target='_blank' class='twitter-data'&gt;&lt;img src='avatar' width='30' height='30'/&gt;&lt;span&gt;username&lt;/span&gt;&lt;/a&gt;
  &lt;/div&gt;
&lt;/header&gt;</pre></div><div><div><h3 class="title"><a id="tip49"/>Tip</h3><p>Notice that we added the class logo to differentiate <code class="literal">divs</code> with the MovieNow logo inside our <code class="literal">header</code>.</p></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec75"/>User not logged and/or application not authorized</h2></div></div></div><a id="id542" class="indexterm"/><p>When our users are not logged in, we want to show a link to the Twitter login page and/or authentication page in MovieNow in the upper-right corner.</p><div><img src="img/5689_09_06.jpg" alt="User not logged and/or application not authorized"/></div><p>To do that, we obtain the authorization URL from <code class="literal">$twitterObj</code> and create a link with it:</p><div><pre class="programlisting">$url = $twitterObj-&gt;getAuthorizationUrl();
echo "&lt;a href='$url'&gt;&lt;div class='twitter-signin'&gt;&lt;/div&gt;&lt;/a&gt;";</pre></div><p>If users access this link and they are already logged into Twitter, they will go directly to the MovieNow authorization screen:</p><div><img src="img/5689_09_07.jpg" alt="User not logged and/or application not authorized"/></div><a id="id543" class="indexterm"/><p>If users are not logged into Twitter, they will see the login screen first.</p><div><img src="img/5689_09_08.jpg" alt="User not logged and/or application not authorized"/></div><a id="id544" class="indexterm"/><p>After logging in, they will see the Twitter MovieNow authorization screen. When the login/authorization process ends, browsers are redirected to your <strong>Callback URL</strong>.</p><div><div><h3 class="title"><a id="tip50"/>Tip</h3><p>Remember that you can change your <strong>Callback URL</strong> anytime by going to <a class="ulink" href="https://dev.twitter.com/">https://dev.twitter.com/</a> and changing it in the <strong>Settings</strong> tab.</p></div></div><a id="id545" class="indexterm"/><p>The callback URL will receive <code class="literal">oauth_verifier</code> and <code class="literal">oauth_token</code> as parameters. We need to use <code class="literal">oauth_token</code> to set the user session information. In session we are going to store <code class="literal">$_SESSION['oauth_token']</code> and <code class="literal">$_SESSION['oauth_token_secret']</code>. If they are set, then the user is already logged in. If not, we need to use <code class="literal">$_GET['oauth_token']</code> to set our session information.</p><p>First, we verify:</p><div><pre class="programlisting">if(isset($_GET['oauth_token']) || (isset($_SESSION['oauth_token']) &amp;&amp; isset($_SESSION['oauth_token_secret']))){
  if(!isset($_SESSION['oauth_token']) || !isset($_SESSION['oauth_token_secret'])){
    //SET SESSION HERE
  }
}</pre></div><p>Then, to set our session, we use <code class="literal">$twitterObj</code> passing <code class="literal">$_GET['oauth_token']</code>:</p><div><pre class="programlisting">$twitterObj-&gt;setToken($_GET['oauth_token']);</pre></div><p>We then access the token information to set our session:</p><div><pre class="programlisting">$token = $twitterObj-&gt;getAccessToken();
$_SESSION['oauth_token']=$token-&gt;oauth_token;
$_SESSION['oauth_token_secret']=$token-&gt;oauth_token_secret;</pre></div><p>Finally, we set our token using <code class="literal">oauth_token</code> and <code class="literal">oauth_token_secret</code> obtained from the <code class="literal">getAccessToken</code> method:</p><div><pre class="programlisting">$twitterObj-&gt;setToken($token-&gt;oauth_token, $token-&gt;oauth_token_secret); </pre></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec76"/>User logged in</h2></div></div></div><a id="id546" class="indexterm"/><p>If users are logged in, they would like to see something that informs them that they are logged in. For that reason, we are going to show their Twitter avatar and username in the upper-right corner of our header.</p><div><img src="img/5689_09_09.jpg" alt="User logged in"/></div><div><div><h3 class="title"><a id="tip51"/>Tip</h3><p>It is a good practice to show login and user logged information in the same space in any enterprise application.</p></div></div><a id="id547" class="indexterm"/><p>Now we only need to get user information, so we can use <code class="literal">get_accountVerify_credentials</code> to get the username and avatar location:</p><div><pre class="programlisting">$twitterInfo= $twitterObj-&gt;get_accountVerify_credentials();
$username = $twitterInfo-&gt;screen_name;
$avatar = $twitterInfo-&gt;profile_image_url;</pre></div><p>Build a link to the Twitter user account and display the avatar:</p><div><pre class="programlisting">echo "&lt;a href='http://www.twitter.com/$username' target='_blank' class='twitter-data'&gt;&lt;img src='$avatar' width='30' height='30'/&gt;&lt;span&gt; $username&lt;/span&gt;&lt;/a&gt;";</pre></div><p>Wrapping it all together, we have:</p><div><pre class="programlisting">&lt;header&gt;&lt;div class="logo"&gt;
  &lt;/div&gt;
  &lt;div class="twitter-info"&gt;
  &lt;?php
    if(isset($_GET['oauth_token']) || (isset($_SESSION['oauth_token']) &amp;&amp; isset($_SESSION['oauth_token_secret']))){if(!isset($_SESSION['oauth_token']) || !isset($_SESSION['oauth_token_secret'])){$twitterObj-&gt;setToken($_GET['oauth_token']);
        $token = $twitterObj-&gt;getAccessToken();                                
        $_SESSION['oauth_token']=$token-&gt;oauth_token;                                
        $_SESSION['oauth_token_secret']=$token-&gt;oauth_token_secret;                                
        $twitterObj-&gt;setToken($token-&gt;oauth_token, $token-&gt;oauth_token_secret);}else{
        $twitterObj-&gt;setToken($_SESSION['oauth_token'],$_SESSION['oauth_token_secret']);}
      $twitterInfo= $twitterObj-&gt;get_accountVerify_credentials();
      $username = $twitterInfo-&gt;screen_name;
      $avatar = $twitterInfo-&gt;profile_image_url;
      echo "&lt;a href='http://www.twitter.com/$username' target='_blank' class='twitter-data'&gt;&lt;img src='$avatar' width='30' height='30'/&gt;&lt;span&gt; $username&lt;/span&gt;&lt;/a&gt;";}else{
      $url = $twitterObj-&gt;getAuthorizationUrl();
      echo "&lt;a href='$url'&gt;&lt;div class='twitter-signin'&gt;&lt;/div&gt;&lt;/a&gt;";
    }
  ?&gt;
  &lt;/div&gt;
&lt;/header&gt;<a id="id548" class="indexterm"/>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec77"/>Adding some styles</h2></div></div></div><a id="id549" class="indexterm"/><p>Now that our login interaction is done, we can add styles in <code class="literal">styles.css</code>.</p><p>First, we change the <code class="literal">div</code> style of <code class="literal">header</code> to <code class="literal">logo</code> to have another <code class="literal">div</code> tag with different styles inside <code class="literal">header</code>. Remember to change this in the Retina Display case too (<code class="literal">@media only screen and (-webkit-min-device-pixel-ratio:2),only screen and (min-device-pixel-ratio: 2)</code>). </p><p>The <code class="literal">twitter-info</code> class is our container for Twitter information whether the user is logged in or not. We set <code class="literal">position</code> to <code class="literal">absolute</code> to hide the username and show only the user avatar when devices with smaller screens are used.</p><div><pre class="programlisting">header .twitter-info{
  position:absolute;
  top:20px;
  right:0;
}</pre></div><p>We can remove the outline from links:</p><div><pre class="programlisting">header .twitter-info a{
  outline:none;
}</pre></div><div><div><h3 class="title"><a id="tip52"/>Tip</h3><p>You can remove all outlines from links using <code class="literal">a{outline:none;}</code>.</p></div></div><p>Add login image and dimensions:</p><div><pre class="programlisting">header .twitter-signin{
  width:100px;
  height:36px;
  background:url(../img/twitter-signin.png);
}</pre></div><a id="id550" class="indexterm"/><p>Position the user avatar:</p><div><pre class="programlisting">header a.twitter-data img{
  position:absolute;
  left:-38px;
}</pre></div><p>Set the text style information for the username:</p><div><pre class="programlisting">header a.twitter-data{
  line-height:30px;
  color:#fff;
  text-decoration:none;
  font-size:.8em;
  padding-right:10px;
}</pre></div><p>Inside the <code class="literal">@media only screen and (max-width: 737px)</code> media query we need to hide the username and show only the Twitter avatar if the user is not logged in.</p><p>Hide part of <code class="literal">twitter-info</code> block:</p><div><pre class="programlisting">header .twitter-info{
  right:-67px;
}</pre></div><p>Move the avatar:</p><div><pre class="programlisting">header a.twitter-data img{
  left:-88px;
}</pre></div><p>Hide the username:</p><div><pre class="programlisting">header a.twitter-data span{
  display:none;
}</pre></div><p>Now our Twitter login process on devices with smaller screens should look like the following screenshot:<a id="id551" class="indexterm"/>
</p><div><img src="img/5689_09_10.jpg" alt="Adding some styles"/></div><p>After you click on the Twitter button at the top, you will be redirected to the Twitter authentication page (if you are not logged into Twitter, it will redirect you to the login page first).<a id="id552" class="indexterm"/>
</p><div><img src="img/5689_09_11.jpg" alt="Adding some styles"/></div><p>If you authorize the application, then the next screen will show your Twitter avatar in the top section of the page.<a id="id553" class="indexterm"/>
</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec74"/>Posting tweets</h1></div></div></div><p>Our user is now authenticated. The next step is to allow for tweeting about movies. In this case, let us use AJAX to call a service that receives a message to tweet as a <code class="literal">tweet</code> parameter.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec78"/>Service</h2></div></div></div><a id="id554" class="indexterm"/><p>Let us create a file called <code class="literal">tweet.php</code> and store it in the root of our application. Import the Twitter-async libraries and <code class="literal">secret.php</code> configuration file:</p><div><pre class="programlisting">include 'lib/EpiCurl.php';
include 'lib/EpiOAuth.php';
include 'lib/EpiTwitter.php';
include 'lib/secret.php';</pre></div><p>We are going to return a JSON object indicating whether the tweet was successfully posted or not. Let us define a variable <code class="literal">$result</code> and set default status to <code class="literal">ok</code>.</p><div><pre class="programlisting">$result = array('status' =&gt; 'ok');</pre></div><p>We can instantiate <code class="literal">EpiTwitter</code> with our application info and verify the session. If no session exists, set the status to <code class="literal">error</code>:</p><div><pre class="programlisting">  $twitterObj = new EpiTwitter($consumer_key, $consumer_secret);
  if(isset($_SESSION['oauth_token']) &amp;&amp; isset($_SESSION['oauth_token_secret'])){
  //TWEET
  }else{
    $result["status"]="error";
  }</pre></div><p>If the session exists, set the <code class="literal">$twitterObj</code> token and verify credentials:</p><div><pre class="programlisting">  $twitterObj-&gt;setToken($_SESSION['oauth_token'],$_SESSION['oauth_token_secret']);
  $twitterInfo= $twitterObj-&gt;get_accountVerify_credentials();</pre></div><p>If we have the <code class="literal">tweet</code> parameter, we unescape our message and invoke the <code class="literal">post_statusesUpdate</code> API passing our tweet inside <code class="literal">status</code>, an indexed array. We can then save the response in a <code class="literal">$temp</code> variable.</p><div><pre class="programlisting">$msg = stripcslashes($_REQUEST['tweet']);
$update_status = $twitterObj-&gt;post_statusesUpdate(array('status' =&gt; $msg));
$temp = $update_status-&gt;response;</pre></div><p>Finally, we validate if <code class="literal">$temp</code> contains an error and return <code class="literal">$result</code> as JSON:</p><div><pre class="programlisting">if($temp["error"])$result["status"]="error";
echo json_encode($result);</pre></div><a id="id555" class="indexterm"/><p>Wrapping it all together, we should have:</p><div><pre class="programlisting">&lt;?php
  include 'lib/EpiCurl.php';
  include 'lib/EpiOAuth.php';
  include 'lib/EpiTwitter.php';
  include 'lib/secret.php';
  $result = array('status' =&gt; 'ok');
  $twitterObj = new EpiTwitter($consumer_key, $consumer_secret);
  if(isset($_SESSION['oauth_token']) &amp;&amp; isset($_SESSION['oauth_token_secret'])){
    $twitterObj-&gt;setToken($_SESSION['oauth_token'],$_SESSION['oauth_token_secret']);
    $twitterInfo= $twitterObj-&gt;get_accountVerify_credentials();
    if($_REQUEST['tweet']){
      $msg = stripcslashes($_REQUEST['tweet']);
      $update_status = $twitterObj-&gt;post_statusesUpdate(array('status' =&gt; $msg));
      $temp = $update_status-&gt;response;
    }
  }else{
    $result["status"]="error";
  }
  if($temp["error"])$result["status"]="error";
  echo json_encode($result);
?&gt;</pre></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec79"/>Applying HTML</h2></div></div></div><a id="id556" class="indexterm"/><p>We are going to display our tweet form as a modal window with a curtain to obscure the rest of the application. We will start by adding the code for the tweet form at the end of the body in <code class="literal">index.php</code>. Next, we will set up the curtain to cover our page (we will style this as black with transparency):</p><div><pre class="programlisting">&lt;div class="modal-background-color"&gt;&lt;/div&gt;</pre></div><p>For our modal area, we will create a section:</p><div><pre class="programlisting">&lt;section class="modal-background"&gt;&lt;/section&gt;</pre></div><div><div><h3 class="title"><a id="tip53"/>Tip</h3><p>For <code class="literal">modal-background-color</code> we do not use <code class="literal">section</code> because it doesn't have any semantic information.</p></div></div><p>We will define the tweet window as a <code class="literal">div</code>:</p><div><pre class="programlisting">&lt;div class="tweet"&gt;&lt;/div&gt;</pre></div><p>We can then add a bar with title and a close button:</p><div><pre class="programlisting">&lt;div class="tweet"&gt;
  &lt;div class="tweet-bar"&gt;
    &lt;h2&gt;Tweet&lt;/h2&gt;
    &lt;div id="close-tweet"&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre></div><p>Lastly, we have our tweet form itself. Notice that we set the <code class="literal">maxlength</code> attribute of the <code class="literal">textarea</code> to 140 since tweets can be no more than 140 characters.</p><div><div><h3 class="title"><a id="tip54"/>Tip</h3><p>The <code class="literal">maxlength</code> attribute in the <code class="literal">textatarea</code> element is not supported by Internet Explorer 9 or previous versions. This is because it was not standard for <code class="literal">textarea</code> in the HTML 4.01 specification, but it was added later in HTML5.</p></div></div><div><pre class="programlisting">&lt;form id="twitter"&gt;
  &lt;textarea  name="tweet" rows="5" id="tweet" title="Tweet Required!" <strong>maxlength="140"</strong> <strong>required</strong>&gt;&lt;/textarea&gt;
    &lt;div class="char-counter"&gt;&lt;input type='submit' value='tweet' name='submit' id='tweet-submit' /&gt;
      &lt;div id="count"&gt;140&lt;/div&gt;
  &lt;/div&gt;
&lt;/form&gt;</pre></div><p>Putting it all together, we have:</p><div><pre class="programlisting">&lt;div class="modal-background-color"&gt;&lt;/div&gt;
&lt;section class="modal-background"&gt;
  &lt;div class="tweet"&gt;
    &lt;div class="tweet-bar"&gt;
      &lt;h2&gt;Tweet&lt;/h2&gt;
      &lt;div id="close-tweet"&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;form id="twitter"&gt;
      &lt;textarea  name="tweet" rows="5" id="tweet" title="Tweet Required!" maxlength="140" required&gt;&lt;/textarea&gt;
      &lt;div class="char-counter"&gt;&lt;input type='submit' value='tweet' name='submit' id='tweet-submit' /&gt;
        &lt;div id="count"&gt;140&lt;/div&gt;
      &lt;/div&gt;
    &lt;/form&gt;
  &lt;/div&gt;
&lt;/section&gt;</pre></div><a id="id557" class="indexterm"/><p>Notice that we are using the <code class="literal">required</code> attribute to indicate that this field can not be blank. The <code class="literal">required</code> attribute is an HTML5 attribute used for form validation. We are using <code class="literal">maxlength</code> as well to limit the number of characters allowed.</p><div><pre class="programlisting">&lt;textarea  name="tweet" rows="5" id="tweet" title="Tweet Required!" <strong>maxlength="140"</strong> <strong>required</strong>&gt;&lt;/textarea&gt;</pre></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec80"/>Adding more styles</h2></div></div></div><a id="id558" class="indexterm"/><p>We have the HTML structure of our tweet window, but we haven't added styles yet. Our final design should look like the following screenshot:</p><div><img src="img/5689_09_13.jpg" alt="Adding more styles"/></div><a id="id559" class="indexterm"/><p>To achieve this we are going to add some styles in <code class="literal">styles.css</code>.</p><div><ol class="orderedlist arabic"><li class="listitem">We set <code class="literal">modal-background-color</code> to cover our page using <code class="literal">fixed</code> positioning and <code class="literal">z-index: 5000</code>. This background should be black with an opacity of 80 percent.<div><pre class="programlisting">.modal-background-color{
  bottom: 0;
  left: 0;
  right: 0;
  top: 0;
  background-color:#000;
  opacity: 0.8;
  display:none;
  -moz-opacity: 0.8;
  -khtml-opacity: 0.8;
  filter: alpha(opacity=80);
  -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=80)";	
  position: fixed;
  z-index: 5000;
}</pre></div><div><div><h3 class="title"><a id="tip55"/>Tip</h3><p>Although <code class="literal">-ms-filter</code> is being used to give support for older versions of Internet Explorer, it is a proprietary solution of Microsoft that does not follow the standard.</p></div></div></li><li class="listitem"><a id="id560" class="indexterm"/>We want <code class="literal">modal-background</code> to be on top of <code class="literal">modal-background-color</code>, so we use <code class="literal">z-index: 5100</code>. Both areas should be hidden by default with <code class="literal">display:none</code> as shown in the following code snippet:<div><pre class="programlisting">.modal-background{
  bottom: 0;
  left: 0;
  right: 0;
  top: 0;
  display:none;
  position: fixed;
  z-index: 5100;
}</pre></div></li><li class="listitem">Our <code class="literal">tweet</code> area is white with rounded corners and centered using <code class="literal">margin:110px auto</code>:<div><pre class="programlisting">.tweet{
  background-color:#fff;
  border-radius:4px 4px;
  -moz-border-radius:4px 4px;
  -webkit-border-radius:4px 4px;
  -o-border-radius:4px 4px;
  width:470px;
  margin:110px auto;
}</pre></div></li><li class="listitem">We then float the tweet title left and add some padding:<div><pre class="programlisting">.tweet h2{
  float:left;
  padding:8px 15px 6px;
}</pre></div></li><li class="listitem">For our text area <code class="literal">#tweet</code>, we remove the outline, add some padding and margin, and set rounded corners border style and font style:<div><pre class="programlisting">#tweet{
  outline:none;
  padding:5px 5px;
  resize:none;
  width:430px;
  margin:15px 15px 8px;
  border-radius:4px 4px 0 0;
  -moz-border-radius:4px 4px 0 0;
  -webkit-border-radius:4px 4px 0 0;
  -o-border-radius:4px 4px 0 0;
  border:1px solid #d3d3d3;
  font-size:1em;
  line-height:1.4em;
}</pre></div></li><li class="listitem"><a id="id561" class="indexterm"/>By default, our submit button <code class="literal">#tweet-submit</code> is gray:<div><pre class="programlisting">#tweet-submit{
  padding:6px 12px;
  background-color:#f6f6f6;
  font-size:.8em;
  border-radius:4px 4px;
  -moz-border-radius:4px 4px;
  -webkit-border-radius:4px 4px;
  -o-border-radius:4px 4px;
  border:1px solid #d3d3d3;
  cursor:pointer;
  color:#888;
  font-weight:bold;
}</pre></div></li><li class="listitem">Add an <code class="literal">active</code> class to set the style when it is active, coloring our button with a blue gradient, blue border, and white font:<div><pre class="programlisting">#tweet-submit.active{
  background:linear-gradient(top, #33BCEF, #019AD2);
  background:-o-linear-gradient(top, #33BCEF, #019AD2);
  background:-moz-linear-gradient(top, #33BCEF, #019AD2);
  background:-webkit-linear-gradient(top, #33BCEF, #019AD2);
  background:-ms-linear-gradient(top, #33BCEF, #019AD2);
  border-color:#057ed0;
  color:#fff;
}</pre></div></li><li class="listitem">On hover, make it a little darker:<div><pre class="programlisting">#tweet-submit.active:hover{
  background:linear-gradient(top, #2DADDC, #0271BF);
  background:-o-linear-gradient(top, #2DADDC, #0271BF);
  background:-moz-linear-gradient(top, #2DADDC, #0271BF);
  background:-webkit-linear-gradient(top, #2DADDC, #0271BF);
  background:-ms-linear-gradient(top, #2DADDC, #0271BF);
}</pre></div></li><li class="listitem"><a id="id562" class="indexterm"/>Float the character counter and submit button to the right and remove the outline:<div><pre class="programlisting">#tweet-submit,#count{
  float:right;
  outline:none;
}</pre></div></li><li class="listitem">Set the character counter font style:<div><pre class="programlisting">#count{
  line-height:30px;
  padding-right:14px;
  color:#999;
  font-size:.9em;
}</pre></div></li><li class="listitem">Add the <code class="literal">close.png</code> sprite image to <code class="literal">#close-tweet</code> button and set its styles:<div><pre class="programlisting">#close-tweet{
  cursor:pointer;
  border-left:1px solid #ccc;
  width:30px;
  height:30px;
  float:right;
  background-image:url(../img/close.png);
}</pre></div></li><li class="listitem">Move the image on hover:<div><pre class="programlisting">#close-tweet:hover{
  background-color:#E5E5E5;
  background-position:0 -30px;
}</pre></div></li><li class="listitem">Add a different style to the bar that contains the title and close button. Notice that we round off upper-left and right corners:<div><pre class="programlisting">.tweet-bar{
  border-radius:4px 4px 0 0;
  -moz-border-radius:4px 4px 0 0;
  -webkit-border-radius:4px 4px 0 0;
  -o-border-radius:4px 4px 0 0;
  background-color:#ececec;
  color:#666;
  font-size:.9em;
  border-bottom:1px solid #ccc;
  overflow:hidden;
}</pre></div></li><li class="listitem"><a id="id563" class="indexterm"/>Finally, set <code class="literal">height</code> for the area that contains the tweet submit button and character counter:<div><pre class="programlisting">.char-counter{
  height:40px;
  padding:0 14px;
}</pre></div></li><li class="listitem">For mobile devices, add a different <code class="literal">width</code> for the text area and tweet window using the <code class="literal">@media only screen and (max-width: 737px) </code>media query:<div><pre class="programlisting">.tweet{
  width:300px;
}
#tweet{
  width:258px;
}</pre></div></li></ol></div><p>Our tweet windows should look like the following screenshot on devices with smaller screens:</p><div><img src="img/5689_09_14.jpg" alt="Adding more styles"/></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec81"/>Adding JavaScript interactions</h2></div></div></div><a id="id564" class="indexterm"/><p>Now we need to add the respective JavaScript to connect the dots. Let us create a new file <code class="literal">movienow.tweet.js</code> in the <code class="literal">js</code> folder. We import that file before <code class="literal">movienow.draganddrop.js</code> inside <code class="literal">index.php</code>:</p><div><pre class="programlisting">&lt;script src="img/ios-orientationchange-fix.js"&gt;&lt;/script&gt;
&lt;script src="img/jquery-1.8.0.min.js"&gt;&lt;/script&gt;
&lt;script src="img/jquery.xdomainajax.js"&gt;&lt;/script&gt;
&lt;script src="img/three.js"&gt;&lt;/script&gt;
<strong>&lt;script src="img/movienow.tweet.js"&gt;&lt;/script&gt;</strong>&lt;script src="img/movienow.draganddrop.js"&gt;&lt;/script&gt;
&lt;script src="img/movienow.charts.js"&gt;&lt;/script&gt;&lt;script src="img/movienow.geolocation.js"&gt;&lt;/script&gt;
&lt;script src="img/movienow.js"&gt;&lt;/script&gt;</pre></div><div><div><h3 class="title"><a id="tip56"/>Tip</h3><p>As you noticed we are using a bunch of JavaScript libraries, it is good practice to implement minification techniques for our JavaScript and CSS to reduce the size of our files and the number of requests.</p></div></div><p>Define the main code structure and add a variable <code class="literal">twitterReady</code> to verify if the tweet window is initialized:</p><div><pre class="programlisting">var movienow = movienow || {};
movienow.tweet = (function(){
  var that = this;
  var twitterReady = false;
})();</pre></div><p>Hide and show functionality will be handled by <code class="literal">showTweetArea</code> and <code class="literal">hideTweetArea</code> functions. For <code class="literal">showTweetArea</code>, we verify if <code class="literal">twitterReady</code> is <code class="literal">true</code>; if not we call <code class="literal">initTweet</code> function to set Twitter window events and assign <code class="literal">true</code> to <code class="literal">twitterReady</code>. </p><p>We can assign <code class="literal">message</code> (with default text) to the text area and show the tweet window. If the user is not logged in, we show an alert.</p><div><pre class="programlisting">this.showTweetArea = function(title, time) {if(!twitterReady){
    that.initTweet();twitterReady=true;
    }
  if($(".twitter-data").length&gt;0){
    var message = "I'm going to "+title+" "+time;
    $("#tweet").val(message);
    that.updateCount();
    $(".modal-background").css("display", "block");
    $(".modal-background-color").css("display", "block");
    $("html,body").css("overflow","auto");}
else{
    alert("Please login in twitter to tweet this");}
  };</pre></div><div><div><h3 class="title"><a id="tip57"/>Tip</h3><p>A more elegant way to show notifications and errors in our enterprise application is to define custom modal windows using HTML and style them with CSS. Moreover, it is possible to use template engines (like Mustache, found at <a class="ulink" href="http://mustache.github.com">http://mustache.github.com</a>) to implement this solution.</p></div></div><a id="id565" class="indexterm"/><p>Notice that we set <code class="literal">$("html,body").css("overflow","auto")</code> to hide the browser scroll bar.</p><p>The <code class="literal">hideTweetArea</code> method<a id="id566" class="indexterm"/> hides the tweet window and restores the browser scroll bar:</p><div><pre class="programlisting">this.hideTweetArea = function() {
  $(".modal-background").css("display", "none");
  $(".modal-background-color").css("display", "none");
     $("html,body").css("overflow","hidden");
}</pre></div><p>To update the character counter, we add an <code class="literal">updateCount</code> method<a id="id567" class="indexterm"/>. We extract the <code class="literal">#tweet</code> text area message and validate its length against 140 characters. We add the <code class="literal">active</code> class to our submit button only when it is possible to tweet.</p><div><pre class="programlisting">this.updateCount = function(){
  var info=$("#tweet").val();
  var count= 140 - info.length;
  $('#count').html(count);
  if(count===140||count&lt;0){
    $('#tweet-submit').removeClass("active");
  }else{
    $('#tweet-submit').addClass("active");
  }
};</pre></div><p>A native alternative to implement this is the use of the attribute <code class="literal">disabled</code> in our input field instead of adding and removing the <code class="literal">active</code> class.</p><p>Our initialization method, <code class="literal">initTweet</code>, adds the necessary events:</p><div><pre class="programlisting">this.initTweet = function() {
  $("#tweet").keyup(that.updateCount);
     $("#twitter").submit(that.tweet);
  $("#close-tweet").click(that.hideTweetArea);
};</pre></div><a id="id568" class="indexterm"/><p>Finally, we create a method to call our PHP service:</p><div><pre class="programlisting">this.tweet = function(event) {
  if($("#twitter")[0].checkValidity()){
    $.ajax({
      url: 'tweet.php',
      data: $("#twitter").serialize(),
      success: function(info){
        var data = that.objectifyJSON(info);
        if(data.status!="ok"){
          alert("Ops! There was an error sending your tweet, please try again.");
        }else{
          that.hideTweetArea();
        }
      }
    });
  }
  return false;
};</pre></div><p>The <code class="literal">checkValidity</code> method<a id="id569" class="indexterm"/> is an HTML5 JavaScript function that allows us to verify whether the fields are valid. In our case, since the text area is required, the validation is that it is not empty.</p><p>Since we are using AJAX, we add return <code class="literal">false</code> at the end to avoid a page refresh on submit.</p><div><div><h3 class="title"><a id="tip58"/>Tip</h3><p>Typically, we would need to extract all inputs from the form and construct a data parameter for our AJAX call. There is a useful function in jQuery called <code class="literal">serialize</code> that constructs this for us.</p></div></div><p>Put it all together and we should have:</p><div><pre class="programlisting">var movienow = movienow || {};
movienow.tweet = (function(){
  var that = this;
  var twitterReady = false;
  this.initTweet = function() {
    $("#tweet").keyup(that.updateCount);
    $("#twitter").submit(that.tweet);
    $("#close-tweet").click(that.hideTweetArea);
  };
  this.tweet = function(event) {
    if($("#twitter")[0].checkValidity()){
      $.ajax({
        url: 'tweet.php',
        data: $("#twitter").serialize(),
        success: function(info){
          var data = that.objectifyJSON(info);
          if(data.status!="ok"){
            alert("Ops! There was an error sending your tweet, please try again.");
          }else{
            that.hideTweetArea();
          }
        }
      });
    }
    return false;
  };
  this.updateCount = function(){
    var info=$("#tweet").val();
    var count= 140 - info.length;
    $('#count').html(count);
    if(count==140||count&lt;0){
      $('#tweet-submit').removeClass("active");
    }else{
      $('#tweet-submit').addClass("active");
    }
  };
  this.showTweetArea = function(title, time) {
    if(!twitterReady){
      that.initTweet();
      twitterReady=true;
    }
    if($(".twitter-data").length&gt;0){
      var message = "I'm going to "+title+" "+time;
      $("#tweet").val(message);
      that.updateCount();
      $(".modal-background").css("display", "block");
      $(".modal-background-color").css("display", "block");
      $("html,body").css("overflow","auto");
    }else{
      alert("Please login in twitter to tweet this");
    }
  };
  this.hideTweetArea = function() {
    $(".modal-background").css("display", "none");
    $(".modal-background-color").css("display", "none");
    $("html,body").css("overflow","hidden");
  }
})();</pre></div><div><div><h3 class="title"><a id="tip59"/>Tip</h3><p>
<code class="literal">checkValidity</code> is not available in all browsers. It is recommended to give support across browsers writing your own <a id="id570" class="indexterm"/>
<code class="literal">checkValidity</code> function when it is not available. You can check out one approach to this solution on the <a class="ulink" href="http://perplexed.co.uk/5201_making_html5_form_backwards_compatible.htm">http://perplexed.co.uk/5201_making_html5_form_backwards_compatible.htm</a> page.</p></div></div><a id="id571" class="indexterm"/><p>What remains is to add a call in <code class="literal">movienow.dragnaddrop.js</code>. Inside our listener for the drop event, we add:</p><div><pre class="programlisting">that.showTweetArea(event.dataTransfer.getData('Title'),event.dataTransfer.getData('Time'));</pre></div><p>So, we now have:</p><div><pre class="programlisting">$('#dropzone')[0].addEventListener('drop', function(event) {
  if (event.stopPropagation) event.stopPropagation();
  if (event.preventDefault) event.preventDefault();
  var html='&lt;div class="selected-time"&gt;';
  html+='&lt;div class="title"&gt;'+event.dataTransfer.getData('Title')+'&lt;/div&gt;';
  html+='&lt;div class="time"&gt;'+event.dataTransfer.getData('Time')+'&lt;/div&gt;';		
  html+='&lt;/div&gt;';
  $('#dropstage').append(html).show();
<strong>that.showTweetArea(event.dataTransfer.getData('Title'),event.dataTransfer.getData('Time'));</strong>
  return false;
});</pre></div><a id="id572" class="indexterm"/><p>For mobile and non-drag-and-drop-enabled devices, we add:</p><div><pre class="programlisting">var iOS = !!navigator.userAgent.match('iPhone OS') || !!navigator.userAgent.match('iPad');
if(('draggable' in document.createElement('span'))&amp;&amp;!iOS){
  //PREVIOUS CODE
}else{
  $(".showtime").bind('click', function(event){
    var info=$(this)[0].title;
    var time=$(this).html();
    that.showTweetArea(info,time);
  });
}</pre></div><p>Our tweet system is ready. If we select a movie (dragging or clicking depending on the device), we can tweet by clicking on the <strong>tweet</strong> button.</p><div><img src="img/5689_09_15.jpg" alt="Adding JavaScript interactions"/></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec82"/>Form validation support across browsers</h2></div></div></div><a id="id573" class="indexterm"/><p>As in other HTML5 features, form validation is not consistent across browsers. In our case, if we select a movie, delete the text area content in the tweet window, and try to submit, the behavior will be different in each browser.</p><p>In Firefox, the form validation we see is a red border and a message.</p><div><img src="img/5689_09_16.jpg" alt="Form validation support across browsers"/></div><a id="id574" class="indexterm"/><p>In Chrome, form validation uses title to show <strong>Tweet Required!</strong> message but does not show the red border.</p><div><img src="img/5689_09_17.jpg" alt="Form validation support across browsers"/></div><p>Safari only blocks the submit action.</p><a id="id575" class="indexterm"/><p>Even if form validation becomes consistent, the user interface elements of every browser are totally different (you will notice a black tooltip in Firefox and a white one with an icon in Chrome). For now, validation can be done with JavaScript from scratch or with jQuery plugins<a id="id576" class="indexterm"/> (<a class="ulink" href="http://docs.jquery.com/Plugins/Validation">http://docs.jquery.com/Plugins/Validation</a>).</p><p>To disable HTML5 form validation, add the<a id="id577" class="indexterm"/> <code class="literal">novalidate</code> attribute to the form.</p><div><div><h3 class="title"><a id="tip60"/>Tip</h3><p>Even if data is validated on the client side, it must also be validated on the server side. Remember that for some users it is pretty easy to change JavaScript code.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec75"/>New input fields types</h1></div></div></div><p>HTML5 introduces new input types for forms. These allow better control and validation, but sadly are not fully supported in all modern browsers. They are shown as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">color</code> is used to select colors<a id="id578" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">date</code> allows for date selection<a id="id579" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">datetime</code> allows for date and time selection<a id="id580" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">datetime-local</code> allows for date and time selection with no time zone<a id="id581" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">email</code> is used for input fields that should contain email address<a id="id582" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">month</code> allows for month and year selection<a id="id583" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">number</code> is used for inputs with numeric values<a id="id584" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">range</code> renders as a slider that allows for selection of a value within a range of numbers<a id="id585" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">search</code> is used for search fields<a id="id586" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">tel</code> is used for entering telephone numbers<a id="id587" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">time</code> allows for time selection<a id="id588" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">url</code> is used for inputs that should contain valid URLs<a id="id589" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">week</code> allows for week and year selection<a id="id590" class="indexterm"/></li></ul></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec76"/>Summary</h1></div></div></div><p>With a wide range of social networks and services offering their data via APIs, we can enrich our enterprise applications by complementing them with more data and functionality. Moreover, you can use OAuth authentication to provide alternative authentication methods to your users. Lastly, HTML5 form validation and the new input types appear to not be sufficiently mature to apply them as solutions for enterprise applications; instead fallback JavaScript solutions should be implemented to provide the same experience across browsers. We hope browser developers adopt this part of the HTML5 specification soon because it will translate to shorter development cycles, more reliable form data, and better experiences for the user.</p><p>In the next chapter, we will cover Web Workers and the power they give enterprise applications by adding the ability to run background processes and multi-thread our applications.</p></div></body></html>