<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Building a Workflow Application</h1></div></div></div><p>In the previous chapter, you learned to create interactive web pages using <code class="literal">ContentService</code>, <code class="literal">HtmlService</code>, <code class="literal">doGet</code>, and <code class="literal">doPost</code> functions. You also built RSS feed and timesheet applications.</p><p>In this chapter, you will learn:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To create a workflow application</li><li class="listitem" style="list-style-type: disc">The workflow involved in an order processing system</li></ul></div><p>A Google Sheet holds all data, needed to create a workflow application, on various steps. It acts as the backbone of the order processing system.</p><div><div><h3 class="title"><a id="tip20"/>Tip</h3><p>While working on published web applications, keep in mind that the following script code versions are independent of each other:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The already saved versions</li><li class="listitem" style="list-style-type: disc">The published version</li><li class="listitem" style="list-style-type: disc">The last saved codes</li></ul></div><p>So remember to publish the App every time you make updates to the code.</p></div></div><div><div><div><div><h1 class="title"><a id="ch08lvl1sec70"/>Order processing workflow – steps explained</h1></div></div></div><p>The following are the <a class="indexterm" id="id339"/>steps involved in the order processing workflow:</p><div><ol class="orderedlist arabic"><li class="listitem">The user opens an online form and sends an order by mentioning the item, quantity, delivery address, and mode of payment.</li><li class="listitem">The Google Sheet sends a confirmation e-mail to both the <strong>User</strong> and <strong>Accounts</strong> section.</li><li class="listitem">The <strong>Accounts</strong> section verifies the payment and forwards it to the <strong>Order Processing</strong> section.</li><li class="listitem">The <strong>Order Processing</strong> section dispatches the order to the delivery address and updates shipment details.</li><li class="listitem">The user confirms the delivery.</li></ol></div><p>You can also refer to the<a class="indexterm" id="id340"/> pictorial representation of these steps in the following image:</p><div><img alt="Order processing workflow – steps explained" src="img/B05010_08_01.jpg"/></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec71"/>Configuring Google Sheets</h1></div></div></div><p>Various forms, e-mails, and<a class="indexterm" id="id341"/> their components are explained<a class="indexterm" id="id342"/> here:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">User form:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Item</li><li class="listitem" style="list-style-type: disc">Unit price</li><li class="listitem" style="list-style-type: disc">Quantity</li><li class="listitem" style="list-style-type: disc">Total price (calculated)</li><li class="listitem" style="list-style-type: disc">Delivery address</li><li class="listitem" style="list-style-type: disc">Phone</li><li class="listitem" style="list-style-type: disc">E-mail</li><li class="listitem" style="list-style-type: disc">Payment details</li></ul></div><div><div><h3 class="title"><a id="note09"/>Note</h3><p>Upon the order<a class="indexterm" id="id343"/> submission, the script sends confirmation e-mails to both the <strong>User</strong> and <strong>Accounts</strong> section.</p></div></div></li><li class="listitem" style="list-style-type: disc">Confirmation e-mail to the user:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Order number</li><li class="listitem" style="list-style-type: disc">Item</li><li class="listitem" style="list-style-type: disc">Unit price</li><li class="listitem" style="list-style-type: disc">Quantity</li><li class="listitem" style="list-style-type: disc">Total price</li><li class="listitem" style="list-style-type: disc">Delivery address</li><li class="listitem" style="list-style-type: disc">Phone number</li><li class="listitem" style="list-style-type: disc">Payment details</li></ul></div></li><li class="listitem" style="list-style-type: disc">E-mail to the <strong>Accounts</strong> section:<p>It is same as the user confirmation e-mail; however, an additional link to the dispatch form is included.</p><div><div><h3 class="title"><a id="note10"/>Note</h3><p>On receiving order e-mails, the <strong>Accounts</strong> section verifies if the payment details are okay, and then forwards that e-mail to the <strong>Order Processing</strong> section. The <strong>Order Processing</strong>/<strong>Dispatch</strong> section clicks on the link to open the dispatch form, fills in shipment details, and submits the form.</p></div></div></li><li class="listitem" style="list-style-type: disc">The dispatch form:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Order number</li><li class="listitem" style="list-style-type: disc">Item</li><li class="listitem" style="list-style-type: disc">Quantity</li><li class="listitem" style="list-style-type: disc">Delivery address</li><li class="listitem" style="list-style-type: disc">Shipment details</li></ul></div><div><div><h3 class="title"><a id="note11"/>Note</h3><p>On the dispatch form <a class="indexterm" id="id344"/>submission, the script updates shipment details in the spreadsheet and sends a dispatch notification e-mail to the user.</p></div></div></li><li class="listitem" style="list-style-type: disc">Post-dispatch<a class="indexterm" id="id345"/> e-mail to the user:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Order number</li><li class="listitem" style="list-style-type: disc">Delivery address</li><li class="listitem" style="list-style-type: disc">Shipment details</li><li class="listitem" style="list-style-type: disc">Acknowledge the delivery (link)</li></ul></div><div><div><h3 class="title"><a id="note12"/>Note</h3><p>The user clicks on the acknowledgement link, and then the script updates the delivery date corresponding to the order number row in the spreadsheet.</p></div></div></li></ul></div><p>Now, create a new Google<a class="indexterm" id="id346"/> Sheet with two Sheets/tabs named <code class="literal">Orders</code> and <code class="literal">Stock</code>. Format the <code class="literal">Orders</code> Sheet column headers as shown in the following screenshot:</p><div><img alt="Configuring Google Sheets" src="img/B05010_08_03.jpg"/></div><p>Format the <code class="literal">Stock</code> Sheet columns and populate the test data in it as shown here:</p><div><img alt="Configuring Google Sheets" src="img/B05010_08_04.jpg"/></div><p>The items and<a class="indexterm" id="id347"/> corresponding unit prices will be populated in the<a class="indexterm" id="id348"/> <code class="literal">Orders</code> form.</p></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec72"/>Creating the Order form</h1></div></div></div><p>In the <code class="literal">Code.gs</code> file, define<a class="indexterm" id="id349"/> the following <a class="indexterm" id="id350"/>global variables:</p><div><pre class="programlisting">// Replace with your spreadsheet's ID.
var ss = SpreadsheetApp
    .openById("spreadsheet's id");

var SheetOrders = ss.getSheetByName("Orders");
var SheetStock = ss.getSheetByName("Stock");</pre></div><p>Create the <code class="literal">doGet</code> function:</p><div><pre class="programlisting">function doGet(){
  var template = HtmlService.createTemplateFromFile("Order");
  var html = template.evaluate();
  return HtmlService.createHtmlOutput(html);
}</pre></div><p>The preceding function<a class="indexterm" id="id351"/> returns the <code class="literal">Order</code> form from the <code class="literal">Order.html</code> template. Create<a class="indexterm" id="id352"/> a new HTML file named <code class="literal">Order</code> and enter the following code in it:</p><div><pre class="programlisting">&lt;!-- Order.html --&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;

  &lt;head&gt;
    &lt;base target="_top"&gt;
  &lt;/head&gt;
  
  &lt;body&gt;
    &lt;form&gt;
      &lt;table&gt;
        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Select Item:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;
          &lt;select&gt;
            &lt;option value="Item 1"&gt;Item 1&lt;/option&gt;
            &lt;option value="Item 2"&gt;Item 2&lt;/option&gt;
            &lt;option value="Item 3"&gt;Item 3&lt;/option&gt;
            &lt;option value="Item 4"&gt;Item 4&lt;/option&gt;
            &lt;option value="Item 5"&gt;Item 5&lt;/option&gt;
          &lt;/select&gt;
        &lt;/td&gt;
        &lt;/tr&gt;
        
        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Unit price:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type="text" /&gt;&lt;/td&gt;
        &lt;/tr&gt;
        
        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Quantity:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type="number" value="1" /&gt;&lt;/td&gt;
        &lt;/tr&gt;

        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Total price:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type="text" /&gt;&lt;/td&gt;
        &lt;/tr&gt;
        
        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Deliver to:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;textarea placeholder="Enter delivery address."&gt;
        &lt;/textarea&gt;&lt;/td&gt;
        &lt;/tr&gt;
        
        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Phone:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input placeholder="Enter phone number." /&gt;&lt;/td&gt;
        &lt;/tr&gt;
        
        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;E-Mail:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input placeholder="Enter email address." /&gt;&lt;/td&gt;
        &lt;/tr&gt;
        
        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Payment details:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type="text"
              placeholder="Enter payment details." /&gt;&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/table&gt;
      
      &lt;br /&gt;
      &lt;input type="button" value="Submit" /&gt;
    &lt;/form&gt;
  &lt;/body&gt;

&lt;/html&gt;</pre></div><p>Publish the script using the<a class="indexterm" id="id353"/> following settings:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Execute the <a class="indexterm" id="id354"/>app as:<p>
<strong>Me</strong> (your e-mail ID)</p></li><li class="listitem" style="list-style-type: disc">Who has access to the app:<p>
<strong>Anyone, even anonymous</strong>
</p></li></ul></div><p>Click on the <strong>Deploy</strong> button, authorize if asked. The rendered application will be similar to the following screenshot:</p><div><img alt="Creating the Order form" src="img/B05010_08_05.jpg"/></div><p>This form is a basic one <a class="indexterm" id="id355"/>and not fancy. The item's selections are hard coded; only five fixed items. The user<a class="indexterm" id="id356"/> may not know the items which are currently available with the supplier, any new items that have been added to the list, or the current unit price for each item. Above all, we did not add any functionality to the <strong>Submit</strong> button.</p></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec73"/>Enhancing the Order form</h1></div></div></div><p>To enhance<a class="indexterm" id="id357"/> the <code class="literal">Order</code> form, update<a class="indexterm" id="id358"/> the <code class="literal">doGet</code> function as follows:</p><div><pre class="programlisting">function doGet(){
  var template = HtmlService.createTemplateFromFile("Order");
  template.pricelist = getPrice();

  var html = template.evaluate();
  return HtmlService.createHtmlOutput(html);
}</pre></div><p>The price list is assigned to the template as a 2-dimensional array and is returned by the function shown here:</p><div><pre class="programlisting">function getPrice(){
  var data = SheetStock.getDataRange().getValues();
  
  // remove header row.
  data.shift();

  return data;
}</pre></div><p>In the <code class="literal">Order.html</code> file, update the <code class="literal">select</code> tag markup as shown in this code snippet:</p><div><pre class="programlisting">&lt;td&gt;
  &lt;select id="item" name="item"&gt;
    &lt;? for(var i in pricelist){ ?&gt;
      &lt;option value="&lt;?= pricelist[i][0] ?&gt;" &gt; &lt;?= pricelist[i][0] ?&gt;&lt;/option&gt;
    &lt;? } ?&gt;
  &lt;/select&gt;
&lt;/td&gt;</pre></div><p>The drop-down items will reflect whatever is included or updated in the <code class="literal">Stock</code> Sheet. The default item will be the top-most or the first item in the list. So we have to put a default unit price for that item. Hence, update the <strong>Unit price</strong> input field as shown here:</p><div><pre class="programlisting">&lt;td&gt;&lt;input id="unit_price" name="unit_price" type="text" readonly value="&lt;?= pricelist[0][1] ?&gt;" /&gt;&lt;/td&gt;</pre></div><p>The <code class="literal">Order</code> form users are not going to enter the unit price, so it can be read only. We set default value for <code class="literal">quantity</code> as <code class="literal">1</code> and the default value for the total price as the unit price.</p><p>Update<a class="indexterm" id="id359"/> the <code class="literal">body</code> tag as<a class="indexterm" id="id360"/> follows:</p><div><pre class="programlisting">  &lt;body&gt;
    &lt;form&gt;
      &lt;table&gt;
        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Select Item:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;select id="item" name="item"&gt;
          &lt;? for(var i in pricelist){ ?&gt;
              &lt;option value="&lt;?= pricelist[i][0] ?&gt;" &gt;&lt;?= pricelist[i][0] ?&gt;&lt;/option&gt;
          &lt;? } ?&gt;
        &lt;/select&gt;&lt;/td&gt;
        &lt;/tr&gt;
        
        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Unit price:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input id="unit_price" name="unit_price" type="text" readonly value="&lt;?= pricelist[0][1] ?&gt;" /&gt;&lt;/td&gt;
        &lt;/tr&gt;
        
        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Quantity:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input id="quantity" name="quantity" type="number" value="1" /&gt;&lt;/td&gt;
        &lt;/tr&gt;

        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Total price:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input id="total_price" name="total_price" type="text" readonly value="&lt;?= pricelist[0][1] ?&gt;" /&gt;&lt;/td&gt;
        &lt;/tr&gt;
        
        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Deliver to:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;textarea name="delivery_address"
              placeholder="Enter delivery address."&gt;
              &lt;/textarea&gt;&lt;/td&gt;
        &lt;/tr&gt;
        
        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Phone:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input name="phone" type="phone"
              placeholder="Enter phone number." /&gt;&lt;/td&gt;
        &lt;/tr&gt;
        
        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;E-Mail:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input name="email" type="email"
              placeholder="Enter email address." /&gt;&lt;/td&gt;
        &lt;/tr&gt;
        
        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Payment details:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input name="payment_details" type="text" placeholder="Enter payment details." /&gt;&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/table&gt;
      
      &lt;br /&gt;
      &lt;input class="blue" id="btnSubmit" type="button" value="Submit" /&gt;
    &lt;/form&gt;
  &lt;/body&gt;</pre></div><p>For the <code class="literal">select</code> element, we<a class="indexterm" id="id361"/> need an <code class="literal">onchange</code> event handler so that, if the user selects any item, the corresponding unit price should be retrieved from the spreadsheet and displayed in the <strong>Unit price</strong> input field. At the same time, the total price should be <a class="indexterm" id="id362"/>calculated as per quantity and unit price. Add script handlers along with the CSS style sheet in the <code class="literal">head</code> element. Update the code for the <code class="literal">head</code> tag as shown here:</p><div><pre class="programlisting">  &lt;head&gt;
    &lt;base target="_top"&gt;

    &lt;link rel="stylesheet" href="//ssl.gstatic.com/docs/script/css/add-ons1.css" /&gt;

    &lt;script src="img/jquery.min.js"&gt;&lt;/script&gt;
    
    &lt;script&gt;
        // On document load, assigns events to elements.
        $(function(){
        $("#item").change(getUnitPrice);
        $("#quantity").change(calcTotalPrice);
        $("#btnSubmit").click(submit);
      });
      
      /*
       * Retrieves corresponding unit price for the selected item
       * and calculates the total price.
       *
       */
      function getUnitPrice(){
        google.script.run
        .withSuccessHandler(function(price){
          $("#unit_price").val(price);
          calcTotalPrice();
        })
        .getPrice( $("#item").prop("selectedIndex") );
      };

      function calcTotalPrice(){
        $("#total_price").val( $("#unit_price").val() * $("#quantity").val() );
      };
      
      function submit(){
        // Remove already displayed messages, if any.
        $("#success,#error").remove();

        this.disabled = true;

        google.script.run
          .withSuccessHandler(function(msg,elm){
             elm.disabled = false;
             showSuccess(msg,elm);
           })
          .withFailureHandler(function(msg, elm){
             elm.disabled = false;
             showError(msg, elm);
           })
          .withUserObject(this)
          .postOrder( this.parentNode );
          // submit button's parent, i.e. form.
      }
      

      function showSuccess(msg,elm) {
        var span = $('&lt;span id="success"&gt; &lt;font color="green"&gt; ' + msg + '&lt;/font&gt;&lt;/span&gt;');

        $(elm).after(span);
      }
      

      function showError(msg,elm) {
        var span = $('&lt;span id="error" class="error"&gt; ' + msg + '&lt;/span&gt;');

        $(elm).after(span);
      }
    &lt;/script&gt;
  &lt;/head&gt;</pre></div><p>The <code class="literal">getPrice</code> server function needs to recognize the selected item index as an argument, so we will update it as<a class="indexterm" id="id363"/> shown here:</p><div><pre class="programlisting">function getPrice(index){
  var data = SheetStock.getDataRange().getValues();
  
  // remove header row.
  data.shift();
  
  return typeof index == "undefined" ? data : data[index][1];
}</pre></div><p>Now, this function <a class="indexterm" id="id364"/>works when called from the <code class="literal">doGet</code> function as well as from the preceding HTML client code. When called from the <code class="literal">doGet</code> function, it returns the complete price list, otherwise just the unit price of a selected item.</p><p>This helper function validates an e-mail. Returns <code class="literal">true</code> if valid otherwise <code class="literal">false</code>:</p><div><pre class="programlisting">function isValidEmail_(email) {
  var regex = /^([\w-\.]+@([\w-]+\.)+[\w-]{2,6})?$/;
  return regex.test(email);
}</pre></div><p>Next, add a form submission handler function (<code class="literal">postOrder</code>). If the order is placed, then this handler should update the spreadsheet and send an e-mail confirmation to the user as well as to the <strong>Accounts</strong> department:</p><div><pre class="programlisting">function postOrder(form){
  
  // Validate user email
  if( !isValidEmail_(form.email) )
    throw "please provide a valid email id.";

  /*
   *  Date used as order number, 
   *  which helps to have distinctive number.
   *  However, you may use any other number or string.
   *
   *  Prepend 'new' with '+' to get 'value' (number) of the date.
   *
   */
  var orderNumber = +new Date();
  
  // Construct form element values in an array.
  var order = [
    orderNumber,
    form.item,
    form.unit_price,
    form.quantity,
    form.total_price,
    form.delivery_address,
    form.phone,
    form.email,
    form.payment_details
  ];
  
  SheetOrders.appendRow(order);
  
  var htmlBody = "&lt;p&gt;Order number: " + orderNumber + "&lt;/p&gt;";
  htmlBody += "&lt;p&gt;Item: " + form.item + "&lt;/p&gt;";
  htmlBody += "&lt;p&gt;Unit price: " + form.unit_price + "&lt;/p&gt;";
  htmlBody += "&lt;p&gt;Quantity: " + form.quantity + "&lt;/p&gt;";
  htmlBody += "&lt;p&gt;Total price: " + form.total_price + "&lt;/p&gt;";
  htmlBody += "&lt;p&gt;Delivery address: " + form.delivery_address
              + "&lt;/p&gt;";

  htmlBody += "&lt;p&gt;Phone number: " + form.phone + "&lt;/p&gt;";
  htmlBody += "&lt;p&gt;Payment details: " + form.payment_details
              + "&lt;/p&gt;";

  htmlBody += "&lt;p&gt;Please quote the order number in your " + "correspondence.&lt;/p&gt;";
  
  // Send an e-mail to the user.
  MailApp.sendEmail({
    to: form.email,
    subject: "Order placed",
    htmlBody: htmlBody
  });
  
  htmlBody += "&lt;p&gt;&amp;nbsp;&lt;/p&gt;";
  htmlBody += '&lt;p&gt;Click &lt;a href="'
              + ScriptApp.getService().getUrl()
              + '?order_number=' + orderNumber
              + '" &gt;here&lt;/a&gt; to dispatch the order.&lt;/p&gt;';
  
  /*
   * Send an e-mail to the Accounts department with the same * content as to the user e-mail, additionally a clickable URL * with the order number appended as a query to the published * URL.
   *
   */
  MailApp.sendEmail({
    to: "Accounts department email id",
    subject: "Order - " + orderNumber,
    htmlBody: htmlBody
  });
  
  // Return confirmation message to user.
  return "Order placed successfully and more details " \+ "has been sent to " + form.email;
};</pre></div><p>Remember to publish<a class="indexterm" id="id365"/> the script again with a new version. Now, the form <a class="indexterm" id="id366"/>should look like this:</p><div><img alt="Enhancing the Order form" src="img/B05010_08_06.jpg"/></div><p>The sample submitted <a class="indexterm" id="id367"/>data in the spreadsheet looks as follows:</p><div><img alt="Enhancing the Order form" src="img/B05010_08_07.jpg"/></div><p>The sample content <a class="indexterm" id="id368"/>of the user e-mail looks as follows:</p><div><img alt="Enhancing the Order form" src="img/B05010_08_08.jpg"/></div><p>The only difference<a class="indexterm" id="id369"/> of the e-mail content to the <strong>Accounts</strong> section is an additional link (which you can see in the sample e-mail content screenshot as follows) of the dispatch form (we will create this form next).</p><div><img alt="Enhancing the Order form" src="img/B05010_08_09.jpg"/></div><p>Up to this point, what<a class="indexterm" id="id370"/> we have set up is:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The user can<a class="indexterm" id="id371"/> submit the <code class="literal">Order</code> form</li><li class="listitem" style="list-style-type: disc">Script appends the submitted data to the spreadsheet</li><li class="listitem" style="list-style-type: disc">Script sends confirmation e-mails both to the user and the <strong>Accounts</strong> department</li></ul></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec74"/>Creating the dispatch form</h1></div></div></div><p>As mentioned earlier, we <a class="indexterm" id="id372"/>will create the dispatch form now. Create a new HTML<a class="indexterm" id="id373"/> file named as <code class="literal">Dispatch</code> and enter the following code in it:</p><div><pre class="programlisting">&lt;!-- Dispatch.html --&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;base target="_top"&gt;
    &lt;link rel="stylesheet" href="//ssl.gstatic.com/docs/script/css/add-ons1.css" /&gt;
    &lt;script src="img/jquery.min.js"&gt;&lt;/script&gt;
    
    &lt;script&gt;
      // On document load, assign submit function to the submit
      //  button's click event
      $(function(){
        $("#btnSubmit").click(submit);
      });
      

      function submit(){
        // Remove already displayed messages, if any.
        $("#success,#error").remove();
        this.disabled = true;

        google.script.run
          .withSuccessHandler(function(msg,elem){
             elem.disabled = false;
             showSuccess(msg,elem);
           })
          .withFailureHandler(function(msg, elm){
             elm.disabled = false;
             showError(msg, elm);
           })
          .withUserObject(this)
          .dispatchOrder( this.parentNode );
      }
      

      function showSuccess(msg,elm) {
        var span = $('&lt;span id="success"&gt; &lt;font color="green"&gt; ' + msg + '&lt;/font&gt;&lt;/span&gt;');
        $(elm).after(span);
      }
      

      function showError(msg,elm) {
        var span = $('&lt;span id="error" class="error"&gt; ' + msg + '&lt;/span&gt;');
        $(elm).after(span);
      }
    &lt;/script&gt;
  &lt;/head&gt;
  
  &lt;body&gt;
    &lt;form&gt;
      &lt;table&gt;
        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Order number:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input name="order_number" type="text" readonly value="&lt;?= order[0] ?&gt;" /&gt;&lt;/td&gt;
        &lt;/tr&gt;

        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Item:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type="text" readonly
             value="&lt;?= order[1] ?&gt;" /&gt;&lt;/td&gt;
        &lt;/tr&gt;
        
        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Quantity:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type="number" readonly
             value="&lt;?= order[3] ?&gt;" /&gt;&lt;/td&gt;
        &lt;/tr&gt;

        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Deliver to:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;textarea readonly value="&lt;?= order[5] ?&gt;"&gt; &lt;/textarea&gt;&lt;/td&gt;
        &lt;/tr&gt;

        &lt;tr&gt;
        &lt;td&gt;&lt;label&gt;Shipment details:&lt;/label&gt;&lt;/td&gt;
        &lt;td&gt;&lt;textarea name="shipment_details" placeholder="Enter shipment details." &gt;
              &lt;/textarea&gt;&lt;/td&gt;
        &lt;/tr&gt;
        
        &lt;tr&gt;
        &lt;td&gt;&lt;input name="email" type="hidden"
             value="&lt;?= order[7] ?&gt;" /&gt;&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/table&gt;
      
      &lt;br /&gt;
      &lt;input class="blue" id="btnSubmit" type="button" value="Submit" /&gt;
    &lt;/form&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div><p>The script handlers are a<a class="indexterm" id="id374"/> subset of the <code class="literal">Order</code> form handlers, and most<a class="indexterm" id="id375"/> of the HTML elements are read-only, except the shipment details. The dispatch form looks like:</p><div><img alt="Creating the dispatch form" src="img/B05010_08_10.jpg"/></div><p>We can use only one <code class="literal">doGet</code> function in a script project or web application, but we have to use two forms with the same published URL. How can we open two different forms with the same published URL?</p><p>You remember that <a class="indexterm" id="id376"/>we appended the order number to the published URL in the <code class="literal">postOrder</code> handler. An example of the dispatch URL with the order number as a query string will look as follows:</p><div><pre class="programlisting">https://script.google.com/macros/s/AKfycbwRUVS6z5rjrAw8M- au9_ICYzixTVB3msLOCmoF5JCBVFNzY_7k/exec<strong>?order_number=1451875765851</strong>
</pre></div><p>The preceding URL is <a class="indexterm" id="id377"/>nothing but the published URL with the order number appended as a query string.</p><p>We will update the <code class="literal">doGet</code> function to parse this query string. If the order number is present, then return the dispatch form; otherwise, return the <code class="literal">Order</code> form:</p><div><pre class="programlisting">function doGet(e){
  var orderNumber = e.parameter.order_number;

  if(orderNumber){
  
    /*
     *  If order number present in query string
     *  then serve dispatch form to order processing unit.
     *
     */
    var template = HtmlService.createTemplateFromFile("Dispatch");
    var data = SheetOrders.getDataRange().getValues();
    
    for(var i in data){
      if( data[i][0] == orderNumber ){
        template.order = data[i];
        break;
      }
    };
    
  } else {

    /*
     *  If order number not present in query string
     *  then serve order form to the user.
     *
     */
    var template = HtmlService.createTemplateFromFile("Order");
    template.pricelist = getPrice();
    
  };
    
  var html = template.evaluate();
  return HtmlService.createHtmlOutput(html);
}</pre></div><p>Now, the <code class="literal">doGet</code> function can handle both situations.</p></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec75"/>Dispatching the articles</h1></div></div></div><p>As soon as the dispatch<a class="indexterm" id="id378"/> person enters the shipment details in the dispatch form and submits it, the script should update the shipment details in the spreadsheet and should <a class="indexterm" id="id379"/>send a notification e-mail to the user. So, we will add the <code class="literal">dispatchOrder</code> server function to handle these tasks:</p><div><pre class="programlisting">function dispatchOrder(form){
  // Shipment details column number minus 1.
  const SHIPMENT_DETAILS = 9;
  
  var orderNumber = form.order_number;
  var deliveryAddress = form.delivery_address;
  var userEmail = form.email;
  var shipmentDetails = form.shipment_details;
  
  var data = SheetOrders.getDataRange().getValues();
  
  for(var i = 0; i &lt; data.length; i++){
    if(data[i][0] == orderNumber){
      SheetOrders.getRange(i+1, SHIPMENT_DETAILS+1)
        .setValue(shipmentDetails);
      
      var htmlBody = "&lt;p&gt;Order number: "
          + orderNumber + " has been dispatched to &lt;/p&gt;"
          + "&lt;p&gt;" + deliveryAddress + "&lt;/p&gt;"
          + "&lt;p&gt;By " + shipmentDetails + "&lt;/p&gt;"
          + "&lt;p&gt;&amp;nbsp;&lt;/p&gt;"
          + '&lt;p&gt;Click &lt;a href="' + ScriptApp.getService().getUrl()
          + '?order_number=' + orderNumber
          + '&amp;delivered=true" &gt;here&lt;/a&gt; '
          + 'to acknowledge the delivery.&lt;/p&gt;';
      
      // Send email to the user
      MailApp.sendEmail({
        to: userEmail,
        subject: "Order dispatched",
        htmlBody: htmlBody
      });
      
      // Return confirmation to the dispatch team.
      return "Shipment details updated and user notified by " \+ "an e-mail.";
    }
  };
  
  // Displays error if query order_number not found in sheet.
  throw "Order number not found.";
};</pre></div><p>A sample<a class="indexterm" id="id380"/> dispatch notification <a class="indexterm" id="id381"/>e-mail content is shown here:</p><div><img alt="Dispatching the articles" src="img/B05010_08_11.jpg"/></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec76"/>Enabling the user to acknowledge the article delivery</h1></div></div></div><p>If the user receives the items, then he/she clicks on the link to acknowledge. The same published URL is<a class="indexterm" id="id382"/> used this time too with an additional delivered<a class="indexterm" id="id383"/> query string.</p><p>For example:</p><div><pre class="programlisting">https://script.google.com/macros/s/AKfycbwaqlj_kBAn9LLav0qv6GmXlWk-hwIosHA- 1_1YoMutiiuGy84/exec?order_number=1451875765851<strong>&amp;delivered=true</strong>
</pre></div><p>To handle this <a class="indexterm" id="id384"/>query, the <code class="literal">doGet</code> function should be updated again <a class="indexterm" id="id385"/>as follows:</p><div><pre class="programlisting">function doGet(e){
  var delivered = e.parameter.delivered;
  
  if(delivered){
    // If order delivered then just update delivery date.
    updateDelivery(e);
    
    // Returning text content is enough, HtmlService not needed.
    return ContentService.createTextOutput("Thank you!");
  }
  
  var orderNumber = e.parameter.order_number;

  if(orderNumber){
    
    /*
     *  If order number present in query string
     *  then serve dispatch form to order processing unit.
     *
     */
    var template = HtmlService.createTemplateFromFile("Dispatch");
    var data = SheetOrders.getDataRange().getValues();
    
    for(var i in data){
      if( data[i][0] == orderNumber ){
        template.order = data[i];
        break;
      }
    };

  } else {

    /*
     *  If order number not present in query string
     *  then serve order form to the user.
     *
     */
    var template = HtmlService.createTemplateFromFile("Order");
    template.pricelist = getPrice();
    
  };
    
  var html = template.evaluate();
  return HtmlService.createHtmlOutput(html);
}</pre></div><p>Another handler, the<a class="indexterm" id="id386"/> <code class="literal">updateDelivery</code> function, should be added as follows:</p><div><pre class="programlisting">function updateDelivery(e){
  // Delivery date column number minus one.
  const DELIVERED_ON = 10;
  
  var orderNumber = e.parameter.order_number;
  var deliveryDate = new Date();
  var data = SheetOrders.getDataRange().getValues();
  
  // Update delivery date on matched order number.
  for(var i = 0; i &lt; data.length; i++){
    if(""+data[i][0] == orderNumber){
      SheetOrders.getRange(i+1, DELIVERED_ON+1)
        .setValue(deliveryDate);
    }
  };
}</pre></div><p>This function updates the current date as the delivered date. A sample<a class="indexterm" id="id387"/> spreadsheet with the <code class="literal">Delivered on</code> column updated is shown as follows:</p><div><img alt="Enabling the user to acknowledge the article delivery" src="img/B05010_08_12.jpg"/></div><p>Congratulations! You have created a full-blown, real-world order processing workflow application.</p></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec77"/>Summary</h1></div></div></div><p>In this chapter, you learned and created a useful real-world order processing application. In the next chapter, you will learn to overcome script in maximum execution time and learn to use script code from other script files or libraries including OAuth library. You will also learn to create add-ons.</p></div></body></html>