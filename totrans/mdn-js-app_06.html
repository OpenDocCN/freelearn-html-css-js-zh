<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Building a Live Score Site"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Building a Live Score Site</h1></div></div></div><p>The best way to master socket.io is by building a real-world application, which is what we will be doing in this chapter. A live score website <a id="id214" class="indexterm"/>shows score changes in real time to the user as soon as the administrator updates the scores. We will create a football live score website. Discussing how to build a live score website will help us study socket.io in depth, as it requires socket.io authentication, and optionally, integrating socket.io with Express. Our live score website will provide an admin panel for the administrators to update the score.</p><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Accessing cookies in the socket.io middleware</li><li class="listitem" style="list-style-type: disc">Discussing HTTP basic authentication</li><li class="listitem" style="list-style-type: disc">Integrating socket.io with Express</li><li class="listitem" style="list-style-type: disc">Discussing socket.io authentication</li></ul></div><div class="section" title="Building the backend"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec30"/>Building the backend</h1></div></div></div><p>Before <a id="id215" class="indexterm"/>we start building the backend of our live score site, let's first set up our directory and files.</p><p>We will only write code for the backend and frontend architecture and functionality, not any HTML and CSS design code.</p><p>The exercise files of this chapter contain two directories: <code class="literal">Initial</code> and <code class="literal">Final</code>. In both the directories, you will find a directory named <code class="literal">Live-Score</code>. In the <code class="literal">Final/Live-Score</code> directory, you will get the complete live score website source code. In the <code class="literal">Initial/Live-Score</code> directory, you will only find HTML and CSS files for our live score site. The <code class="literal">Initial/Live-Score</code> directory is to help you quickly get started with building the live score site.</p><p>In the <code class="literal">Initial/LiveScore</code> directory, you will find the <code class="literal">public</code> directory, <code class="literal">app.js</code> file, and <code class="literal">package.json</code> file. Inside the <code class="literal">public</code> directory, you will find <code class="literal">css</code>, <code class="literal">html</code>, and <code class="literal">js</code> directories. In the <code class="literal">css</code> and <code class="literal">html</code> directories, you will find HTML files and CSS files for our user and administrator pages. In the <code class="literal">js</code> directory, you will find <code class="literal">admin.js</code> and <code class="literal">index.js</code> files, inside which you will place the socket.io client code for the administrator <a id="id216" class="indexterm"/>and users, respectively. Similarly, in the <code class="literal">html</code> directory, you will find <code class="literal">index.html</code> and <code class="literal">admin.html</code> files that will be served to the users and administrator respectively.</p><p>Inside the <code class="literal">package.json</code> file, place the following code:</p><div class="informalexample"><pre class="programlisting">{
  "name": "Live-Score",
  "dependencies": {
    "express": "4.13.3",
    "socket.io": "1.3.7",
    "basic-auth": "1.0.3",
    "socket.io-cookie": "0.0.1"
  }
}</pre></div><p>Now run the <code class="literal">npm install</code> command inside the <code class="literal">Initial/Live-Score</code> directory to download <code class="literal">express</code>, <code class="literal">socket.io</code>, <code class="literal">basic-auth</code>, and <code class="literal">socket.io-cookie</code> npm packages.</p><div class="section" title="Integrating socket.io server with the Express server"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec36"/>Integrating socket.io server with the Express server</h2></div></div></div><p>We can <a id="id217" class="indexterm"/>integrate the socket.io server <a id="id218" class="indexterm"/>with the Express server with <a id="id219" class="indexterm"/>just a few lines of code. Here is the code to integrate the socket.io server with the Express server.</p><p>Create an <code class="literal">app.js</code> file and place the following code in it:</p><div class="informalexample"><pre class="programlisting">var express = require("express");  
var app = express();  
var server = require("http").createServer(app);  
var io = require("socket.io")(server, {path: "/socket-io"});

server.listen(8080);</pre></div><p>The fourth line is where the main integration happens. Here we are using the <code class="literal">/socket-io</code> path for socket.io handshaking.</p><p>Finally, we are listening on port number <code class="literal">8080</code>. That is, both Express server and socket.io server will listen on port number <code class="literal">8080</code>.</p></div><div class="section" title="Serving static files and HTML to the users"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec37"/>Serving static files and HTML to the users</h2></div></div></div><p>Now <a id="id220" class="indexterm"/>we <a id="id221" class="indexterm"/>need to write the code to server HTML, CSS, and JavaScript files to the site users. The following is the code to do this. Place this code <a id="id222" class="indexterm"/>in the <code class="literal">app.js</code> file right <a id="id223" class="indexterm"/>after the previous snippet:</p><div class="informalexample"><pre class="programlisting">app.use(express.static(__dirname + "/public"));

app.get("/", function(httpRequest, httpResponse, next){
  httpResponse.sendFile(__dirname + "/public/html/index.html");
})</pre></div><p>Here, the first line of the code is serving static files. The rest of the code is serving <code class="literal">index.html</code> to the site users when they visit the root path.</p></div><div class="section" title="Serving HTML to the administrator and protecting the admin panel"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec38"/>Serving HTML to the administrator and protecting the admin panel</h2></div></div></div><p>We <a id="id224" class="indexterm"/>only want the administrators <a id="id225" class="indexterm"/>to access the admin panel to update the scores. So, for visitors to access the admin panel, they must enter the username and password. We will use the HTTP basic authentication to protect the admin panel.</p><p>The following is the code to authenticate and serve HTML to the administrator:</p><div class="informalexample"><pre class="programlisting">var basicAuth = require("basic-auth");

function uniqueNumber() {
  var date = Date.now();

  if (date &lt;= uniqueNumber.previous) {
    date = ++uniqueNumber.previous;
  } else {
    uniqueNumber.previous = date;
  }

  return date;
}

uniqueNumber.previous = 0;

var authenticated_users = {};

var auth = function (req, res, next){
  var user = basicAuth(req);

  if(!user || user.name !== "admin" || user.pass !== "admin")
  {
    res.statusCode = 401;
    res.setHeader("WWW-Authenticate", "Basic realm='Authorization Required'");
    res.end("Access denied");
  }
  else
  {
    var id = uniqueNumber();
    authenticated_users[id] = id;
    res.cookie("authentication_id", id);
    next();
  }
}

app.get("/admin", auth, function(httpRequest, httpResponse, next){
  httpResponse.sendFile(__dirname + "/public/html/admin.html");
})</pre></div><p>Here <a id="id226" class="indexterm"/>is how the code <a id="id227" class="indexterm"/>works:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">First, we imported the <code class="literal">basic-auth</code> library, which is used to implement basic authentication in Express.</li><li class="listitem" style="list-style-type: disc">Then, we wrote a custom function to generate a unique number whenever it's called.</li><li class="listitem" style="list-style-type: disc">We also created a function with the name <code class="literal">auth</code>, which will be used to check whether the visitor is authenticated. If not, then we will send an HTTP status code 404, asking the visitor to provide the username and password. If the visitor is authenticated, then we will generate a unique number and store it as a cookie in the administrator's browser. Later on, this cookie will be used by the socket.io server to check whether the administrator is authenticated.</li><li class="listitem" style="list-style-type: disc">Finally, we created a route with the <code class="literal">/admin</code> path, which has two route handlers attached to it. The first one is the <code class="literal">auth</code> function to check for authentication and the second serves the <code class="literal">admin.html</code> file.</li></ul></div></div><div class="section" title="Socket.IO cookie authentication and broadcasting messages to a namespace"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec39"/>Socket.IO cookie authentication and broadcasting messages to a namespace</h2></div></div></div><p>We <a id="id228" class="indexterm"/>will have two namespaces <a id="id229" class="indexterm"/>in our socket.io server: the default namespace where users will connect and the <code class="literal">/admin</code> namespace where the administrator will connect.</p><p>A socket.io client will not require authentication to connect to the default namespace. However, to <a id="id230" class="indexterm"/>connect to the <code class="literal">/admin</code> namespace, the socket.io will need authentication.</p><p>Updates <a id="id231" class="indexterm"/>made by the administrator will be broadcasted to all the users in the default namespace.</p><p>Here is the code for creating the <code class="literal">/admin</code> namespace, broadcasting messages to the default namespace, and implementing authentication for the <code class="literal">/admin</code> namespace. Place this code in the <code class="literal">app.js</code> file:</p><div class="informalexample"><pre class="programlisting">var cookieParser = require("socket.io-cookie");

var admin = io.of("/admin");

admin.use(cookieParser);

admin.use(function(socket, next) {
  if(socket.request.headers.cookie.authentication_id in authenticated_users)
  {
    next();
  }
  else
  {
    next(new Error("Authentication required"));
  }
});

admin.on("connection", function(socket){
  socket.on("message", function(message){
    io.send(message);
  });
})</pre></div><p>Here is how the code works:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">First, we imported the socket.io-cookie middleware, which is used to parse the HTTP <code class="literal">Cookie</code> header</li><li class="listitem" style="list-style-type: disc">Then, we created the <code class="literal">/admin</code> namespace</li><li class="listitem" style="list-style-type: disc">We also parsed the cookie using the socket.io-cookie middleware</li><li class="listitem" style="list-style-type: disc">Then, we wrote our own middleware to check whether <code class="literal">authentication_id</code> exists, and if yes, then whether it was valid</li><li class="listitem" style="list-style-type: disc">Finally, we listened to the <code class="literal">message</code> event and broadcasted the message to the users in the default namespace</li></ul></div><p>Now we are done with our backend. Run the <code class="literal">node app.js</code> command inside the initial directory. Then visit <code class="literal">http://localhost:8080</code> and <code class="literal">http://localhost:8080/admin</code> in <a id="id232" class="indexterm"/>any browser. Here, I <a id="id233" class="indexterm"/>am assuming that you are running the Express server locally.</p><p>When you visit <code class="literal">http://localhost:8080</code>, you will see the following screen:</p><div class="mediaobject"><img src="graphics/B05154_06_01.jpg" alt="Socket.IO cookie authentication and broadcasting messages to a namespace"/></div><p>There is nothing inside the box yet as the user hasn't received any messages.</p><p>When you visit <code class="literal">http://localhost:8080/admin</code>, you will see the following screen:</p><div class="mediaobject"><img src="graphics/B05154_06_02.jpg" alt="Socket.IO cookie authentication and broadcasting messages to a namespace"/></div><p>Now enter <code class="literal">admin</code> as <span class="strong"><strong>User Name</strong></span> and <span class="strong"><strong>Password</strong></span> and click on <span class="strong"><strong>Log In</strong></span>. You will see the following screen:</p><div class="mediaobject"><img src="graphics/B05154_06_03.jpg" alt="Socket.IO cookie authentication and broadcasting messages to a namespace"/></div></div></div></div>
<div class="section" title="Building the frontend"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec31"/>Building the frontend</h1></div></div></div><p>Let's write <a id="id234" class="indexterm"/>the frontend code for the users and administrators. socket.io client instances of users will listen to incoming messages from the server and display them. Whereas, socket.io client instances of administrator will send messages to the server so that the messages can be broadcasted to the users.</p><p>The following is the socket.io client code for the users. Place this code inside the <code class="literal">index.js</code> file:</p><div class="informalexample"><pre class="programlisting">var socket = io("http://localhost:8080", {path: "/socket-io"});

socket.on("connect", function () {
	socket.on("message", function (msg) {
    document.getElementById("messages").innerHTML = "&lt;li&gt;&lt;div&gt;&lt;h4&gt;" + msg.team1_name + "(" + msg.team1_goals + ") : " + msg.team2_name + "(" + msg.team2_goals + ")" + "&lt;/h4&gt;&lt;p&gt;" + msg.desc + "&lt;/p&gt;&lt;/div&gt;&lt;/li&gt;" + document.getElementById("messages").innerHTML; 
  });
});</pre></div><p>This code is self-explanatory.</p><p>Here is the socket.io client code for the administrators. Place this code inside the <code class="literal">admin.js</code> file:</p><div class="informalexample"><pre class="programlisting">var socket = io("http://localhost:8080/admin", {path: "/socket-io"});

document.getElementById("submit-button").addEventListener("click", function(){
  var team1_name = document.getElementById("team1-name").value;
  var team2_name = document.getElementById("team2-name").value;
  var team1_goals = document.getElementById("team1-goals").value;
  var team2_goals = document.getElementById("team2-goals").value;
  var desc = document.getElementById("desc").value;

  if(team1_goals == "" || team2_goals == "" || team1_name == "" || team2_name == "")
  {
    alert("Please enter all details");
  }

  socket.send({
    team1_name: team1_name,
    team2_name: team2_name,
    team1_goals: team1_goals,
    team2_goals: team2_goals,
    desc: desc
  });
}, false)</pre></div><p>This <a id="id235" class="indexterm"/>is how the preceding code works:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In the first line, we connected to the socket.io <code class="literal">/admin</code> namespace. If the cookie is invalid in any case, then the connection will fail.</li><li class="listitem" style="list-style-type: disc">We also made sure that the team names and their scores are filled, otherwise we will display an alert message asking them to enter all the details.</li><li class="listitem" style="list-style-type: disc">Then, we sent the message to the socket.io server.</li></ul></div></div>
<div class="section" title="Testing the website"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec32"/>Testing the website</h1></div></div></div><p>Now <a id="id236" class="indexterm"/>we are done building our live score website. To test the site, refresh the <code class="literal">http://localhost:8080/</code> and <code class="literal">http://localhost:8080/admin</code> pages.</p><p>Now, in the <code class="literal">admin</code> panel, fill the form with some sample data, and click on the <span class="strong"><strong>Send</strong></span> button:</p><div class="mediaobject"><img src="graphics/B05154_06_04.jpg" alt="Testing the website"/></div><p>On <a id="id237" class="indexterm"/>the user page, you should see something similar to the following image:</p><div class="mediaobject"><img src="graphics/B05154_06_05.jpg" alt="Testing the website"/></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec33"/>Summary</h1></div></div></div><p>In this chapter, we saw how to build a live score website using socket.io and Express. You should now be comfortable with building any kind of application that requires bidirectional communication in real time. You should now try building a chat application, multiplayer game, or something else where socket.io would be very useful.</p><p>So, overall you learned socket.io in depth, WebSockets, and bidirectional communication.</p></div></body></html>