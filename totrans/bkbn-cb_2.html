<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;Models"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Models</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating a model</li><li class="listitem" style="list-style-type: disc">Operating with model attributes</li><li class="listitem" style="list-style-type: disc">Operating with model identifier</li><li class="listitem" style="list-style-type: disc">Validating model attributes</li><li class="listitem" style="list-style-type: disc">Overriding getters and setters</li><li class="listitem" style="list-style-type: disc">Creating undo points to store/restore a model's state</li><li class="listitem" style="list-style-type: disc">Implementing workflow for a model</li><li class="listitem" style="list-style-type: disc">Using advanced validation in a model</li><li class="listitem" style="list-style-type: disc">Validating an HTML form</li><li class="listitem" style="list-style-type: disc">Working with nested attributes in a model</li><li class="listitem" style="list-style-type: disc">Implementing a one-to-one relationship</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec17"/>Introduction</h1></div></div></div><p>In this chapter we are going to learn what a Backbone model<a class="indexterm" id="id86"/> is and how can we use it. We are also going to consider various Backbone extensions, which provide lots of improvement and bring amazing features to our models.</p><p>The first three recipes of the current chapter contain information for beginners who are not familiar with Backbone yet; and other recipes bring additional value and cover more advanced topics.</p></div></div>
<div class="section" title="Creating a model"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec18"/>Creating a model</h1></div></div></div><p>A model <a class="indexterm" id="id87"/>is a building brick of any MVC application, which contains data, provides validation, performs access control, and implements specific business logic required by an application. In <code class="literal">Backbone.js</code>, a model is defined by extending its instance from the <code class="literal">Backbone.Model</code> object. In this recipe, we are going to learn how to work with models in <code class="literal">Backbone.js</code>.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec24"/>How to do it...</h2></div></div></div><p>Perform the following steps to define a new model object and create its instance:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Define a model by extending <code class="literal">Backbone.Model</code>.<div class="informalexample"><pre class="programlisting">  var InvoiceItemModel = Backbone.Model.extend({

  });</pre></div><p>There is no need to define a data structure inside the model object, because Backbone allows it to be defined dynamically when the model is initialized.</p></li><li class="listitem">Create a <code class="literal">Backbone.Model</code> instance and initialize it with attribute values.<div class="informalexample"><pre class="programlisting">  var invoiceItemModel = new InvoiceItemModel({
    date: '2013-04-24',
    description: 'Wooden Toy House',
    price: 22,
    quantity: 3
  });</pre></div></li></ol></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec25"/>There's more...</h2></div></div></div><p>In this section, we are going to learn how to clone a model and how to initialize a model with default values.</p><div class="section" title="Cloning a model"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec02"/>Cloning a model</h3></div></div></div><p>When <a class="indexterm" id="id88"/>you assign a model to another variable, it makes one model reflect changes in another model. If you need an independent copy of a model, use the <a class="indexterm" id="id89"/>
<code class="literal">clone()</code> method.</p><div class="informalexample"><pre class="programlisting">newModel = invoiceItemModel.clone();</pre></div></div><div class="section" title="Setting default attribute values"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec03"/>Setting default attribute values</h3></div></div></div><p>Sometimes, <a class="indexterm" id="id90"/>you may want your model to have attributes that are initialized with default values when a new model instance is created, so you don't need to set them manually. Here is how default attributes are defined:</p><div class="informalexample"><pre class="programlisting">  var InvoiceItemModel = Backbone.Model.extend({

    // Define default attributes.
    defaults: {
      date: '',
      description: '',
      price: 0,
      quantity: 1
    },
  });</pre></div><p>The following <a class="indexterm" id="id91"/>example shows that the <code class="literal">quantity</code> and <code class="literal">date</code> attributes are initialized by default:</p><div class="informalexample"><pre class="programlisting">  var invoiceItemModel2 = new InvoiceItemModel({
    description: 'Farm Animal Set',
    price: 17
  });

  invoiceItemModel2.get('date') != undefined; // true
  invoiceItemModel2.get('quantity'); // 1</pre></div></div><div class="section" title="Setting default attribute values with a multiline expression"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec04"/>Setting default attribute values with a multiline expression</h3></div></div></div><p>If you want to <a class="indexterm" id="id92"/>set default values with a multiline expression you can wrap it into a function and call it when setting default attributes in <code class="literal">defaults</code>.</p><div class="informalexample"><pre class="programlisting">  // Create new model object
  var InvoiceItemModel = Backbone.Model.extend({

    // Set default attributes.
      defaults: {
        description: '',
        price: 0,
        quantity: 1,
      
    // Use function for multiline expression.
        date: function() {
          var date = new Date();

        // Return attribute value.
          return date.toISOString();
        }
      }
    });</pre></div><p>There is also a way to do the same in the <code class="literal">initialize()</code> method, which is called right after the model <a class="indexterm" id="id93"/>object is created and initialized with values.</p><div class="informalexample"><pre class="programlisting">  // Crate new model
  var InvoiceItemModel = Backbone.Model.extend({

    // Set default values.
    defaults: {
      description: '',
      price: 0,
      quantity: 1,
    },

    // Set default values in initialize method.
    // Following method is run after the object is created.
    initialize: function() {

      // Check that attribute is not initialized yet.
        if (!this.has('date')) {
          var date = new Date();
        
        // Set attribute value.
          this.set('date', date.toISOString());
        }
      }
    }</pre></div><p>In the <code class="literal">initialize()</code> method<a class="indexterm" id="id94"/> we set the <code class="literal">date</code> attribute to today's date using JavaScript's <code class="literal">Date</code> object. Before doing this, we need to check that the <code class="literal">date</code> attribute is not initialized yet, so we do not override it.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip05"/>Tip</h3><p>If the default attributes are defined, then they can override the attributes defined in the <code class="literal">initialize()</code> method, and so we need to remove such attributes from the <code class="literal">default</code> values, otherwise they are initialized as defaults instead.</p></div></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec26"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In the current recipe examples, we used the <code class="literal">has()</code> and <code class="literal">set()</code> methods, which are described in the following recipe: <span class="emphasis"><em>Operating with model attributes</em></span></li></ul></div></div></div>
<div class="section" title="Operating with model attributes"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec19"/>Operating with model attributes</h1></div></div></div><p>Attributes <a class="indexterm" id="id95"/>are where a model stores all its data. Unlike model properties, which are used for storing internal object information, attributes cannot be accessed via the <code class="literal">.</code> operator. There are special methods to work with them, which we are going to learn in this recipe.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec27"/>How to do it...</h2></div></div></div><p>The main methods to work with model attributes are <code class="literal">get()</code>, <code class="literal">set()</code>, <code class="literal">unset()</code>,and <code class="literal">clear()</code>.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Use the <code class="literal">get()</code> method<a class="indexterm" id="id96"/> to get an attribute value.<div class="informalexample"><pre class="programlisting">var quantity = invoiceItemModel.get('quantity');</pre></div><p>If the attribute is not found, <code class="literal">undefined</code> is returned.</p></li><li class="listitem">Use the <code class="literal">set()</code> method <a class="indexterm" id="id97"/>to update/create a single attribute value.<div class="informalexample"><pre class="programlisting">invoiceItemModel.set('quantity', 5);</pre></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To update multiple attributes use key-value format.<div class="informalexample"><pre class="programlisting">    invoiceItemModel.set({
      quantity: 5,
      price: 10
    });</pre></div></li></ul></div><p>When setting an attribute if it does not exist, one is created. The <code class="literal">set()</code> method returns a reference with the value <code class="literal">true</code> to the model, if validation does not fail; otherwise returns the value <code class="literal">false</code>. We will learn more about validation in the recipe, <span class="emphasis"><em>Validating model attributes</em></span>.</p></li><li class="listitem">Use the <a class="indexterm" id="id98"/><code class="literal">unset()</code> method to delete an attribute from a model.<div class="informalexample"><pre class="programlisting">invoiceItemModel.unset('quantity');</pre></div></li><li class="listitem">Use the <code class="literal">clear()</code> method<a class="indexterm" id="id99"/> to delete all attributes from a model.<div class="informalexample"><pre class="programlisting">invoiceItemModel.clear();</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec28"/>How it works...</h2></div></div></div><p>Attributes are stored in the <code class="literal">attributes</code> property. It is better not to access attributes directly and to use methods we have learned previously; otherwise, it can break the event triggering mechanism or integration with other Backbone extensions.</p><p>When a new module is initialized, values from the <code class="literal">defaults</code> property are assigned to the <code class="literal">attributes</code> one.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec29"/>There's more…</h2></div></div></div><p>In this section we are going to learn some useful methods with the model attributes.</p><div class="section" title="Checking if a model has an attribute"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec05"/>Checking if a model has an attribute</h3></div></div></div><p>To check if a <a class="indexterm" id="id100"/>model has an attribute, use the <code class="literal">has()</code> method. It returns <code class="literal">true</code> if the attribute exists, otherwise <code class="literal">false</code>.</p><div class="informalexample"><pre class="programlisting">if (!invoiceItemModel.has('quantity')) {
  console.log('Quantity attribute does not exists!')
}</pre></div></div><div class="section" title="Getting HTML escaped attribute value"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec06"/>Getting HTML escaped attribute value</h3></div></div></div><p>If you are going to <a class="indexterm" id="id101"/>display user-entered text, which you assume is in plain text format, you should worry about security issues. The best way to prevent vulnerability which may lead to possible XSS attacks is to use the <code class="literal">escape()</code> method before outputting any user entered text. This disallows the browser to parse any HTML code by escaping HTML characters. Let's figure out how it works:</p><div class="informalexample"><pre class="programlisting">  var hacker = new Backbone.Model({
    name: "&lt;script&gt;alert('xss')&lt;/script&gt;"
  });
  var escaped_name = hacker.escape('name');
  // &amp;lt;script&amp;gt;alert('xss')&amp;lt;/script&amp;gt;</pre></div></div></div></div>
<div class="section" title="Operating with the model identifier"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec20"/>Operating with the model identifier</h1></div></div></div><p>Each <a class="indexterm" id="id102"/>model has a unique identifier property ID, which allows distinguishing one model from another. When developing a Backbone application it is often required to operate with an identifier.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec30"/>How to do it...</h2></div></div></div><p>The following steps explains how to set and get the <code class="literal">id</code> property:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Setting and getting the <code class="literal">id</code> property is really easy.<div class="informalexample"><pre class="programlisting">  invoiceItemModel.id = Math.random().toString(36).substr(2);</pre></div><p>Getting the id property looks as follows:</p><div class="informalexample"><pre class="programlisting">  var id = invoiceItemModel.id;</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec31"/>How it works...</h2></div></div></div><p>The <code class="literal">id</code> property<a class="indexterm" id="id103"/> provides direct access to an attribute where the identifier is stored. By default it is <code class="literal">id</code>; however, you can override it by setting <code class="literal">idAttribute</code> when extending a model.</p><div class="informalexample"><pre class="programlisting">  var Meal = Backbone.Model.extend({
    idAttribute: "_id"
  });</pre></div><p>When a new model is created, the identifier is empty unless it is manually assigned.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec32"/>There's more...</h2></div></div></div><p>If <code class="literal">id</code> is not initialized yet in your model, then you can use a client identifier, which can be accessed using the <code class="literal">cid</code> property. The value of <code class="literal">cid</code> is unique and assigned automatically when a new model instance is created. Client IDs can take forms, such as <code class="literal">c0</code>, <code class="literal">c1</code>, <code class="literal">c2</code>, and so on.</p></div></div>
<div class="section" title="Validating model attributes"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec21"/>Validating model attributes</h1></div></div></div><p>To prevent <a class="indexterm" id="id104"/>unexpected behavior, we often need to validate model attributes.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec33"/>How to do it...</h2></div></div></div><p>Perform the following steps to set up an attribute validation:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Validation can be done by defining the <a class="indexterm" id="id105"/><code class="literal">validate()</code> method.<div class="informalexample"><pre class="programlisting">  var InvoiceItemModel = Backbone.Model.extend({

    // Define validation criteria.
    validate: function(attrs) {
      if (attrs.quantity &lt;= 0) {
        return "quantity can't be negative or equal to zero";
      }
    }
  });</pre></div><p>The <code class="literal">attrs</code> parameter<a class="indexterm" id="id106"/> contains the attribute values that were changed. The <code class="literal">validate()</code> method will return an error message if they do not validate.</p></li><li class="listitem">Attribute validation is triggered on the <code class="literal">save()</code> method<a class="indexterm" id="id107"/>. It can also trigger on the <code class="literal">set()</code> method if you pass <code class="literal">{validate: true}</code> as the last parameter.<div class="informalexample"><pre class="programlisting">  var invoiceItemModel = new InvoiceItemModel({
    description: 'Wooden Toy House',
    price: 10
  });

    // Set value that is not valid.
    invoiceItemModel.set('quantity', -1, {validate: true});</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip06"/>Tip</h3><p>When validating a model you can still access old attribute values with the help of <code class="literal">this.get()</code> or <code class="literal">this.attributes</code>.</p></div></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec34"/>How it works...</h2></div></div></div><p><code class="literal">validate</code> is called <a class="indexterm" id="id108"/>before <code class="literal">save()</code>, and accepts the updated model attributes, which are passed from <code class="literal">save()</code>. If <code class="literal">validate()</code> returns an error string, <code class="literal">save()</code> will not continue, and the model attributes will not be modified. Failed validation triggers the <code class="literal">invalid</code> event. If you want validation to be triggered in the <code class="literal">set()</code> method, pass <code class="literal">{validate: true}</code> as the last parameter.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec35"/>There's more...</h2></div></div></div><p>In this section, we are going to investigate more details about validation.</p><div class="section" title="Handling validation errors"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec07"/>Handling validation errors</h3></div></div></div><p>If a <a class="indexterm" id="id109"/>model does not validate, we often need to<a class="indexterm" id="id110"/> continue running an application and provide a custom code for handling events. Let's check out how it is done.</p><div class="informalexample"><pre class="programlisting">  invoiceItemModel.on("invalid", function(model, error) {
    console.log(error);
  });</pre></div><p>Such an error handler should be bound before the validation event is triggered.</p><p>There is also another way of handling events, which allows us to pass an error handling function as an option to the <code class="literal">set()</code>, <code class="literal">fetch()</code>, <code class="literal">save()</code>, or <code class="literal">destroy()</code> methods.</p><div class="informalexample"><pre class="programlisting">  var invoiceItemModel2 = new InvoiceItemModel({
    description: 'Animal Farm',
    price: 17
  });
    invoiceItemModel2.set({quantity: 0}, {
      invalid: function(model, error) {
        console.log(error);
      },
      validate: true
    });</pre></div></div><div class="section" title="Triggering validation manually"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec08"/>Triggering validation manually</h3></div></div></div><p>Though validation is<a class="indexterm" id="id111"/> performed every time a model is updated or saved to the storage, sometimes you may want to check manually if the model validates. Let's figure out how to do it.</p><div class="informalexample"><pre class="programlisting">  var invoiceItemModel3 = new InvoiceItemModel({
    description: 'Wooden Toy House',
    price: 10,
    quantity: -5
  });
    invoiceItemModel3.isValid(); // false</pre></div><p><code class="literal">isValid()</code> returns true or false, but does not trigger the <code class="literal">invalid</code> event.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec36"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Handling events of Backbone objects</em></span> in <a class="link" href="ch05.html" title="Chapter 5. Events and Bindings">Chapter 5</a>, <span class="emphasis"><em>Events and Bindings</em></span></li></ul></div></div></div>
<div class="section" title="Overriding getters and setters"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec22"/>Overriding getters and setters</h1></div></div></div><p>Sometimes it is <a class="indexterm" id="id112"/>required to override getters or setters in your application. There can be different reasons to do so:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">An attribute is stored in a different format rather than a format for input or output</li><li class="listitem" style="list-style-type: disc">You have a virtual attribute that is not stored in the model, but depends on other attributes</li><li class="listitem" style="list-style-type: disc">Prevent illegal values to be assigned to an attribute</li></ul></div><p>By default, Backbone does not allow users to override getters or setters, but there is an extension named <code class="literal">Backbone.Mutators</code>, which allows you to do so.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec37"/>Getting ready</h2></div></div></div><p>There is a link to download <code class="literal">Backbone.Mutators</code> from the <span class="strong"><strong>GitHub</strong></span> page <a class="ulink" href="https://github.com/asciidisco/Backbone.Mutators">https://github.com/asciidisco/Backbone.Mutators</a>.</p><p>To include this extension into your project, save the <code class="literal">backbone.mutators.js</code> file into the <code class="literal">lib</code> folder and include a reference to it in <code class="literal">index.html</code>.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note02"/>Note</h3><p>Including a Backbone extension into your project is described in the <span class="emphasis"><em>Extending application with plugins</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Backbone">Chapter 1</a>, <span class="emphasis"><em>Understanding Backbone</em></span> in detail.</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec38"/>How to do it...</h2></div></div></div><p>We can specify <a class="indexterm" id="id113"/>a getter or setter for a virtual attribute that does not exist. This can be helpful in some cases, for example, if a virtual attribute depends on other attributes.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Introduce a new virtual attribute by overriding getter for it.<div class="informalexample"><pre class="programlisting">  var BuyerModel = Backbone.Model.extend({
    
    // Use mutators
    mutators: {

    // Introduce virtual attribute.
      fullName: {
        get: function () {
          return this.firstName + ' ' + this.lastName;
        }
      }
    }
  });</pre></div><p>In the model object, we defined a new <code class="literal">mutators</code> attribute<a class="indexterm" id="id114"/>, which provides our model with a getter for the new virtual attribute named <code class="literal">fullName</code>. This attribute is not assumed to be stored in the model, because it contains values of existing attributes <code class="literal">firstName</code> and <code class="literal">lastName</code>. Now, let's see how we can use an overridden getter.</p><div class="informalexample"><pre class="programlisting">  var buyerModel = new BuyerModel();
  buyerModel.set({
    firstName: 'John',
    lastName: 'Smith'
  });

    buyerModel.get('fullName'); // John Smith
    buyerModel.get('firstName'); // John
    buyerModel.get('lastName'); // Smith</pre></div></li><li class="listitem">Override setter, so the virtual attribute is not actually saved in the model, but other attributes are updated instead.<div class="informalexample"><pre class="programlisting">  var BuyerModel = Backbone.Model.extend({

    // Use mutators
    mutators: {

      // Introduce virtual attribute.
      fullName: {
        set: function (key, value, options, set) {
          var names = value.split(' ');
          this.set('firstName', names[0], options);
          this.set('lastName', names[1], options);
        }
      }
    }
  });</pre></div><p>In the setter for the <code class="literal">fullName</code> attribute, we split a value into an array and <a class="indexterm" id="id115"/>then assign the <code class="literal">firstName</code> and <code class="literal">lastName</code> attributes with its parts. Here is an example which demonstrates how it can be used:</p><div class="informalexample"><pre class="programlisting">    var buyerModel2 = new BuyerModel()
    buyerModel2.set('fullName', 'Joe Bloggs');

    buyerModel2.get('fullName'); // Joe Bloggs
    buyerModel2.get('firstName'); // Joe
    buyerModel2.get('lastName'); // Bloggs</pre></div></li></ol></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip07"/>Tip</h3><p><span class="strong"><strong>Initialize attributes using the set() method</strong></span></p><p>If you use setter mutator for an attribute, the only way to trigger it is to call the <code class="literal">set()</code> method. Setter mutator won't work if you assign attributes when creating a new model, because in this case the <code class="literal">change</code> event is not triggered. Otherwise, you need to trigger the <code class="literal">change</code> event for a specific property.</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec39"/>How it works...</h2></div></div></div><p>The <code class="literal">Backbone.Mutators</code> extension overrides the <code class="literal">get()</code> and <code class="literal">set()</code> methods of <code class="literal">Bakcbone.Model</code>. New methods try to call overridden getters and setters. If not, run the original <code class="literal">get()</code> or <code class="literal">set()</code> methods.</p><p>It also overrides the <code class="literal">toJSON()</code> method<a class="indexterm" id="id116"/> and replaces attributes which have overridden getter.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec40"/>There's more...</h2></div></div></div><p>In this section, we are going to learn the advanced usage of the <code class="literal">Backbone.Mutators</code> extension.</p><div class="section" title="Overriding getter and setter of an existing attribute"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec09"/>Overriding getter and setter of an existing attribute</h3></div></div></div><p>Overriding <a class="indexterm" id="id117"/>setter of an existing attribute may be done if you need the attribute to be stored in a different format rather than the one in which it is outputted or inputted. You can override getter and setter for this attribute and solve this problem. Let's see how to use <code class="literal">Backbone.Mutators</code> for existing attributes:</p><div class="informalexample"><pre class="programlisting">  var BuyerModel = Backbone.Model.extend({

    // Use mutators.
    mutators: {

      // Override existing attribute.
      vip: {
        get: function() {
          return this.vip === true ? 'VIP' : 'Regular';
        },
        set: function (key, value, options, set) {
          set(key, value === 'VIP', options);
        }
      }
    }
  });</pre></div><p>In this model, there is the <code class="literal">vip</code> attribute, which is <code class="literal">boolean</code>. We want this attribute to be represented as a string to the user, so we are going to override getter and setter for it.</p><p>The usage syntax stays the same as for a regular attribute.</p><div class="informalexample"><pre class="programlisting">    var buyerModel3 = new BuyerModel();
    buyerModel2.set({
      fullName: 'Mister X',
      vip: 'VIP'
    });

    buyerModel2.get('vip'); // VIP
    buyerModel2.attributes.vip; // true</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip08"/>Tip</h3><p>Mutators aim to override setters or getters, but they do not modify attribute values itself. You can always get the original attributes by accessing the <code class="literal">attributes</code> property of a model.</p></div></div></div><div class="section" title="Handling mutators events"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec10"/>Handling mutators events</h3></div></div></div><p>You can<a class="indexterm" id="id118"/> bind callback to the <code class="literal">mutators:set:*</code> event. Here is how it is done:</p><div class="informalexample"><pre class="programlisting">    buyerModel3.on('mutators:set:fullName',
      function (a, b, c, d) {
        console.log('mutators:set:fullName is triggered');
    });

    buyerModel3.set({
      fullName: 'Mister Y'
    });</pre></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec41"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Handling events of Backbone objects</em></span> in <a class="link" href="ch05.html" title="Chapter 5. Events and Bindings">Chapter 5</a>, <span class="emphasis"><em>Events and Bindings</em></span></li></ul></div></div></div>
<div class="section" title="Creating undo points to store/restore a model's state"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec23"/>Creating undo points to store/restore a model's state</h1></div></div></div><p>Sometimes, you may need to manage the states of a model in your application. This can be useful in one of the following cases:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Your application requires an undo/redo feature</li><li class="listitem" style="list-style-type: disc">You want to implement transactions</li><li class="listitem" style="list-style-type: disc">Your application emulates some process</li><li class="listitem" style="list-style-type: disc">You want to change a model temporarily and then restore it</li></ul></div><p>Typically for all of <a class="indexterm" id="id119"/>the previous cases developers often use the <code class="literal">Memento</code> pattern. There is an implementation of this pattern in Backbone, which is available in the <code class="literal">Backbone.Memento</code> extension. This extension allows developers to store or restore a model's state and provides a stack for operating with multiple states.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec42"/>Getting ready</h2></div></div></div><p>You can download the <code class="literal">Backbone.Memento</code> extension<a class="indexterm" id="id120"/> from the <span class="strong"><strong>GitHub</strong></span> page <a class="ulink" href="https://github.com/derickbailey/backbone.memento">https://github.com/derickbailey/backbone.memento</a>. To include this extension into your project, save the <code class="literal">backbone.memento.js</code> file into the <code class="literal">lib</code> folder and include a reference to it in <code class="literal">index.html</code>.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note03"/>Note</h3><p>Including a Backbone extension into your project is described in the <span class="emphasis"><em>Extending application with plugins</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Backbone">Chapter 1</a>, <span class="emphasis"><em>Understanding Backbone</em></span> in detail.</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec43"/>How to do it...</h2></div></div></div><p>Perform the <a class="indexterm" id="id121"/>following steps to operate model states:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Extend a model with the <code class="literal">Backbone.Memento</code> extension in the <code class="literal">initialize()</code> method.<div class="informalexample"><pre class="programlisting">  var InvoiceItemModel = Backbone.Model.extend({

    // Extend model instance with memento instance.
    initialize: function() {
      _.extend(this, new Backbone.Memento(this));
    }
  });</pre></div></li><li class="listitem">Create the model instance and initialize it with values.<div class="informalexample"><pre class="programlisting">  var invoiceItemModel = new InvoiceItemModel();
  invoiceItemModel.set('price', 10);</pre></div></li><li class="listitem">Use the <code class="literal">store()</code> method<a class="indexterm" id="id122"/> to save a state.<div class="informalexample"><pre class="programlisting">  invoiceItemModel.store();</pre></div></li><li class="listitem">Update the model with temporary values.<div class="informalexample"><pre class="programlisting">  invoiceItemModel.set('price', 20);</pre></div></li><li class="listitem">Use the <code class="literal">restore()</code> method<a class="indexterm" id="id123"/> to retrieve a previously saved state.<div class="informalexample"><pre class="programlisting">  invoiceItemModel.restore();</pre></div></li><li class="listitem">Retrieve model values of the saved state.<div class="informalexample"><pre class="programlisting">  invoiceItemModel.get('price'); // 10</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec44"/>How it works...</h2></div></div></div><p>Memento uses the <span class="strong"><strong>LIFO</strong></span> (<span class="strong"><strong>last in, first out</strong></span>) data structure<a class="indexterm" id="id124"/>, also known as stack, for storing model states. So it is possible to save model states multiple times, and then restore them in a backward direction. The following diagram shows how it works:</p><div class="mediaobject"><img alt="How it works..." src="graphics/2728OS_02_01.jpg"/></div><p>Each time you call the <code class="literal">store()</code> method, the state is saved on top of the stack. Each time you call the <code class="literal">restore()</code> method, the <a class="indexterm" id="id125"/>state that was saved last is restored and deleted from the top of the stack.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec45"/>There's more...</h2></div></div></div><p>In this section, we are going to understand the advanced features of Memento.</p><div class="section" title="Working with the Memento stack"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec11"/>Working with the Memento stack</h3></div></div></div><p>Here is an <a class="indexterm" id="id126"/>example which demonstrates how to work with such stack of states:</p><div class="informalexample"><pre class="programlisting">    // States stack demo.
    var invoiceItemModel2 = new InvoiceItemModel();
    invoiceItemModel2.set('price', 10);

    // Save state and update value.
    invoiceItemModel2.store();
    invoiceItemModel2.set('price', 20);
    
    // Save state and update value.
    invoiceItemModel2.store();
    invoiceItemModel2.set('price', 30);

    // Restore last state and get value.
    invoiceItemModel2.restore();
    invoiceItemModel2.get('price'); // 20

    // Restore last state and get value.
    invoiceItemModel2.restore();
    invoiceItemModel2.get('price'); // 10</pre></div><p>As we can see <a class="indexterm" id="id127"/>in the preceding code, dealing with stacks is quite easy.</p></div><div class="section" title="Restoring from the first state in the stack"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec12"/>Restoring from the first state in the stack</h3></div></div></div><p>Sometimes,<a class="indexterm" id="id128"/> it is required to reset a model to the state in which it was first saved in the stack, no matter how many states were saved after. This can be done using the <code class="literal">restart()</code> method.</p><div class="informalexample"><pre class="programlisting">    invoiceItemModel3.restart();</pre></div></div><div class="section" title="Ignoring attributes from being restored"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec13"/>Ignoring attributes from being restored</h3></div></div></div><p>There is an interesting feature in <code class="literal">Backbone.Memento</code>, which allows you to ignore some model attributes from being saved or restored. It is very useful if a model contains some technical properties, which is not intended to be used as part of the state. When extending a model in the <code class="literal">initialize()</code> method, pass the properties to be ignored in the <code class="literal">ignore</code> option.</p><div class="informalexample"><pre class="programlisting">  var AnotherInvoiceItemModel = Backbone.Model.extend({

    // Extend model instance with memento instance.
    // Ignore restoring of description attribute.
    initialize: function() {
      _.extend(this, new Backbone.Memento(
        this, {ignore: ["description"]}
      ));
    }
  });</pre></div></div><div class="section" title="Working with collections"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec14"/>Working with collections</h3></div></div></div><p>The Memento extension also allows to extend a collection with Memento functionality. It provides the same methods when working with collections <code class="literal">store()</code>, <code class="literal">restore()</code>, and <code class="literal">restart()</code>.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec46"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">There is also another extension named <code class="literal">Backbone.actAs.Mementoable</code>, which implements the Memento pattern in a more accurate way, because it uses separate objects for storing states. It is more flexible, but does not provide stack out of the box and cannot ignore specific attributes from being saved/restored.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Backbone.actAs.Mementoable</code> can be downloaded from the <span class="strong"><strong>GitHub</strong></span> page <a class="ulink" href="https://github.com/iVariable/Backbone.actAs.Mementoable">https://github.com/iVariable/Backbone.actAs.Mementoable</a>.</li><li class="listitem" style="list-style-type: disc">You can learn more about working with collections in <a class="link" href="ch03.html" title="Chapter 3. Collections">Chapter 3</a>, <span class="emphasis"><em>Collections</em></span>.</li></ul></div></div></div>
<div class="section" title="Implementing workflow for a model"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec24"/>Implementing workflow for a model</h1></div></div></div><p>If you are implementing a business logic, which assumes that a model can be in different states and there are special rules applied to a state change, you should use the <code class="literal">workflow.js</code> extension, which is very helpful for building such kind of functionality.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec47"/>Getting ready</h2></div></div></div><p>You can download the <code class="literal">workflow.js</code> extension<a class="indexterm" id="id129"/> from the GitHub page <a class="ulink" href="https://github.com/kendagriff/workflow.js">https://github.com/kendagriff/workflow.js</a>. To include this extension into your project, save the <code class="literal">workflow.js</code> file into the <code class="literal">lib</code> folder and include a reference to it in <code class="literal">index.html</code>.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note04"/>Note</h3><p>Including a Backbone extension into your project is described in the <span class="emphasis"><em>Extending application with plugins</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Backbone">Chapter 1</a>, <span class="emphasis"><em>Understanding Backbone</em></span> in detail.</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec48"/>How to do it...</h2></div></div></div><p>Let's create a <a class="indexterm" id="id130"/>workflow for <code class="literal">InvoiceModel</code>, because it has a <code class="literal">status</code> attribute, which represents the model state and is well suited for a workflow example.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Draw a graph of the states and possible transitions.<div class="mediaobject"><img alt="How to do it..." src="graphics/2728OS_02_02.jpg"/></div><p>Available states are draft, issued, paid, and canceled. There are also a few transitions available that allow one state to be changed into another. If there is no appropriate transition, then such a change is not possible.</p></li><li class="listitem">Define <code class="literal">workflow</code> <a class="indexterm" id="id131"/>in code.<div class="informalexample"><pre class="programlisting">  var InvoiceModel = Backbone.Model.extend({
    
    // Define workflow states.
    workflow: {

      // Define initial state.
      initial: 'draft',

      // Define state transitions.
      events: [
        { name: 'issue', from: 'draft', to: 'issued' },
        { name: 'payout', from: 'issued', to: 'paid' },
        { name: 'cancel', from: 'draft', to: 'canceled' },
        { name: 'cancel', from: 'issued', to: 'canceled' },
      ]
    },

    initialize: function() {
      // Extend model instance with workflow instance.
      // Set attribute name which contains status.
      _.extend(this,
        new Backbone.Workflow(this, {attrName: 'status'})
      );
    }
  });</pre></div><p>As we can see, there is a new <code class="literal">workflow</code> property which describes our workflow. Transitions are defined in an array, which is assigned to the <code class="literal">events</code> property.</p><p>Each element of the transitions array should contain the name of the transition, from state, and to state. Initial state of the model should be defined in the <code class="literal">initial</code> property.</p><p>In the previous example, in the <code class="literal">initialize()</code> method, we extend our model object with an instance of the <code class="literal">Backbone.Workflow</code> object and pass the state attribute name (<code class="literal">attrName</code>) as an option, which contains <code class="literal">'status'</code> instead of the default value <code class="literal">'workflow_state'</code>.</p></li><li class="listitem">Trigger <a class="indexterm" id="id132"/>workflow transition by calling the <a class="indexterm" id="id133"/><code class="literal">triggerEvent()</code> method.<div class="informalexample"><pre class="programlisting">    var invoiceModel = new InvoiceModel();
    invoiceModel.get('status'); // draft

    invoiceModel.triggerEvent('issue');
    invoiceModel.get('status'); // issued

    invoiceModel.triggerEvent('payout');
    invoiceModel.get('status') // paid</pre></div><p>As we can see in the preceding code, <code class="literal">triggerEvent()</code> accepts a single parameter, which is the transition name. In case if an inappropriate transition is triggered, then an exception is thrown.</p></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec49"/>How it works...</h2></div></div></div><p>The <code class="literal">Workflow.js</code> extension is written on <span class="strong"><strong>CoffeeScript</strong></span><a class="indexterm" id="id134"/> and is quite easy to understand. It just provides the <code class="literal">triggerEvent()</code> method, which switches the <code class="literal">workflow</code> property and triggers an event.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec50"/>There's more...</h2></div></div></div><p>In this section, we are going to learn how to handle transition events.</p><div class="section" title="Binding callbacks to transition events"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec15"/>Binding callbacks to transition events</h3></div></div></div><p>Sometimes, you <a class="indexterm" id="id135"/>may want to execute a code when a specific transition is triggered. In this case, you need to bind a callback function to a transition event. This callback is executed if an event is being triggered.</p><p><code class="literal">Workflow.js</code> provides two types of events <code class="literal">transition:from:*</code> and <code class="literal">transition:to:*</code>. The first one is triggered when a workflow loses a specific state, and the second one is triggered when a workflow reaches a specific state. Let's define event bindings for our model.</p><div class="informalexample"><pre class="programlisting">  var InvoiceModel = Backbone.Model.extend({
    
    // Define workflow states.
    // [workflow definition goes here]

    initialize: function() {
      // Extend model instance with workflow instance.
      // Set attribute name which contains status.
      _.extend(this,
        new Backbone.Workflow(this, {attrName: 'status'})
      );

      // Bind reaction on event when status changes from
      // draft to any.
      this.bind('transition:from:draft', function() {
        this.set('createdDate', new Date().toISOString());
      });

      // Bind reaction on event when status changes
      // from any to paid.
      this.bind('transition:to:paid, function() {
        this.set('payoutDate', new Date().toISOString());
      });
    }
  });</pre></div><p>In the preceding example, we bind a couple of callbacks, which update date attributes when appropriate <a class="indexterm" id="id136"/>events are triggered.</p><p>The next code snippet is an example which demonstrates what happens when workflow events are triggered.</p><div class="informalexample"><pre class="programlisting">    var invoiceModel = new InvoiceModel();
    invoiceModel.get('status'); // draft

    invoiceModel.triggerEvent('issue');
    invoiceModel.get('status'); // issued
    invoiceModel.get('createdDate');
    // 2012-05-01T12:00:10.234Z

    invoiceModel.triggerEvent('payout');
    invoiceModel.get('status') // paid
    invoiceModel.get('payoutDate');
    // 2012-05-01T12:00:10.238Z</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip09"/>Tip</h3><p><span class="strong"><strong>Always use the triggerEvent() method when changing state</strong></span></p><p>Event callback is executed if an event is triggered by the <code class="literal">triggerEvent()</code> method only. That is why an event callback is not executed when an object is initialized or if you use the <code class="literal">set()</code> method to update the workflow state.</p></div></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec51"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Handling events of Backbone objects</em></span> in <a class="link" href="ch05.html" title="Chapter 5. Events and Bindings">Chapter 5</a>, <span class="emphasis"><em>Events and Bindings</em></span></li></ul></div></div></div>
<div class="section" title="Using advanced validation in a model"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec25"/>Using advanced validation in a model</h1></div></div></div><p>By default, Backbone <a class="indexterm" id="id137"/>provides a simple way for validating <a class="indexterm" id="id138"/>model attributes using the <code class="literal">validate()</code> method, which allows to create your own validating function, but this can take more developer's time compared to the usage of existing solutions.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec52"/>Getting ready</h2></div></div></div><p>Why don't you save time with another Backbone extension named <code class="literal">Backbone.Validation</code>, which provides lots of features and allows to reuse existing validators. It is available to download from the <span class="strong"><strong>GitHub</strong></span> page <a class="ulink" href="https://github.com/thedersen/backbone.validation">https://github.com/thedersen/backbone.validation</a>.</p><p>To include this extension into your project, save the <code class="literal">backbone-validation.js</code> file in the <code class="literal">lib</code> folder and include a reference to it in <code class="literal">index.html</code>.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note05"/>Note</h3><p>Including a Backbone extension into your project is described in the <span class="emphasis"><em>Extending application with plugins</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Backbone">Chapter 1</a>, <span class="emphasis"><em>Understanding Backbone</em></span> in detail.</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec53"/>How to do it...</h2></div></div></div><p>Perform the following steps to set the validation criteria for a model:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Extend <code class="literal">Backbone.object()</code> with <code class="literal">Backbone.Validation.mixin</code>.<div class="informalexample"><pre class="programlisting">  _.extend(Backbone.Model.prototype, Backbone.Validation.mixin);</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note06"/>Note</h3><p>There is more information about mixins in the <span class="emphasis"><em>Using mixins with Backbone objects</em></span> recipe in <a class="link" href="ch08.html" title="Chapter 8. Special Techniques">Chapter 8</a>, <span class="emphasis"><em>Special Techniques</em></span>.</p></div></div></li><li class="listitem">Define<a class="indexterm" id="id139"/> the validation criteria in the <code class="literal">validation</code> property.<div class="informalexample"><pre class="programlisting">  var BuyerModel = Backbone.Model.extend({
    
    // Defining a validation criteria.
    validation: {
      name: {
        required: true
      },
      email: {
        pattern: 'email'
      }
    }
  });</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec54"/>How it works...</h2></div></div></div><p>The <code class="literal">Backbone.Validation</code> extension<a class="indexterm" id="id140"/> overrides the <code class="literal">validate()</code> method of <code class="literal">Backbone.Model</code>, so we can still call the <code class="literal">validate()</code> and <code class="literal">isValid()</code> methods as usual, and validation is performed automatically when a model is updated. Let's check this out.</p><div class="informalexample"><pre class="programlisting">    var buyerModel = new BuyerModel();

    // Set attribute values which do not validate.
    buyerModel.set({
      email: 'http://example.com'
    }, {validate: true});

    // Check if model is valid.
    buyerModel.isValid(); // false
    buyerModel.get('email'); // undefined</pre></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec55"/>There's more...</h2></div></div></div><p>In this section, we are going to learn more about built-in validators.</p><div class="section" title="Using built-in validators"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec16"/>Using built-in validators</h3></div></div></div><p>In the <a class="indexterm" id="id141"/>previous example, we reused existing validators, such as <a class="indexterm" id="id142"/>
<code class="literal">required</code> and <code class="literal">pattern</code>. They are named built-in validators. In this recipe, we are going to learn how to use all of them.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>required</strong></span>: It <a class="indexterm" id="id143"/>validates <a class="indexterm" id="id144"/>if the attribute is required or not. It can be equal to true or false.<div class="informalexample"><pre class="programlisting">  var BuyerModel = Backbone.Model.extend({
    validation: {
      name: {
        required: true
      },
    }
  });</pre></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>acceptance</strong></span>: It <a class="indexterm" id="id145"/>validates if something has to be <a class="indexterm" id="id146"/>accepted, for example, terms of use. It checks whether the attribute value is true or false. It works with <code class="literal">boolean</code> attributes.<div class="informalexample"><pre class="programlisting">   var UserRegistrationModel = Backbone.Model.extend({
    validation: {
      terms: {
        acceptance: true
      },
    }
  });</pre></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>min</strong></span>: It <a class="indexterm" id="id147"/>validates<a class="indexterm" id="id148"/> that the attribute value has to be a number and equal to or greater than the min value specified.<div class="informalexample"><pre class="programlisting">  var BuyerModel = Backbone.Model.extend({
    validation: {
      age: {
        min: 18
      },
    }
  });</pre></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>max</strong></span>: It <a class="indexterm" id="id149"/>validates that the attribute value has to be a number <a class="indexterm" id="id150"/>and equal to or less than the max value specified.<div class="informalexample"><pre class="programlisting">  var EventRegistrationModel = Backbone.Model.extend({
    validation: {
      guests: {
        max: 2
      },
    }
  });</pre></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>range</strong></span>: It <a class="indexterm" id="id151"/>validates<a class="indexterm" id="id152"/> that the attribute value has to be a number and equal to or between the two numbers specified.<div class="informalexample"><pre class="programlisting">  var ChildTicketModel = Backbone.Model.extend({
    validation: {
      age: {
        range: [2, 12]
      },
    }
  });</pre></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>length</strong></span>: It <a class="indexterm" id="id153"/>validates<a class="indexterm" id="id154"/> that the attribute value has to be a string with length equal to the length value specified.<div class="informalexample"><pre class="programlisting">  var AddressModel = Backbone.Model.extend({
    validation: {
      zip: {
        length: 5
      },
    }
  });</pre></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>minLength</strong></span>: It <a class="indexterm" id="id155"/>validates that the attribute value has to<a class="indexterm" id="id156"/> be a string with length equal to or greater than the min length value specified.<div class="informalexample"><pre class="programlisting">  var UserModel = Backbone.Model.extend({
    validation: {
      password: {
        minLength: 8
      },
    }
  });</pre></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>maxLength</strong></span>: It <a class="indexterm" id="id157"/>validates that the attribute value <a class="indexterm" id="id158"/>has to be a string with length equal to or less than the max length value specified.<div class="informalexample"><pre class="programlisting">  var UserModel = Backbone.Model.extend({
    validation: {
      password: {
        maxLength: 8
      },
    }
  });</pre></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>rangeLength</strong></span>: It <a class="indexterm" id="id159"/>validates that the attribute <a class="indexterm" id="id160"/>value has to be a string and equal to or between the two numbers specified.<div class="informalexample"><pre class="programlisting">  var BuyerModel = Backbone.Model.extend({
    validation: {
      phoneNumber: {
        rangeLength: [10, 12]
      },
    }
  });</pre></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>oneOf</strong></span>: It <a class="indexterm" id="id161"/>validates that the attribute value has to be <a class="indexterm" id="id162"/>equal to one of the elements in the specified array. It uses case-sensitive matching.<div class="informalexample"><pre class="programlisting">  var BuyerModel = Backbone.Model.extend({
    validation: {
      type: {
        oneOf: [''person'', ''organization'']
      },
    }
  });</pre></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>equalTo</strong></span>: It <a class="indexterm" id="id163"/>validates that the attribute value has to <a class="indexterm" id="id164"/>be equal to the value of the attribute with the name specified.<div class="informalexample"><pre class="programlisting">  var UserModel = Backbone.Model.extend({
    validation: {
      password: {
        required: true
      },
      passwordRepeat: {
        equalTo: 'password'
      }
    }
  });</pre></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>pattern</strong></span>: It <a class="indexterm" id="id165"/>validates that the attribute value has to match<a class="indexterm" id="id166"/> the pattern specified. It can be a regular expression or the name of one of the built-in patterns.<div class="informalexample"><pre class="programlisting">var BuyerModel = Backbone.Model.extend({
  validation: {
    email: {
      pattern: 'email'
    }
  }
});</pre></div><p>Pattern can accept one of the following attribute values:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>number</strong></span>: matches any decimal number</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>digits</strong></span>: matches any digit sequence</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>email</strong></span>: matches a valid email address</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>url</strong></span>: matches any valid URL</li></ul></div><p>You can also specify any regular expression instead.</p><div class="informalexample"><pre class="programlisting">var BuyerModel = Backbone.Model.extend({
  validation: {
    phoneNumber: {
      pattern: /^(\+\d)*\s*(\(\d{3}\)\s*)*\d{3}(-{0,1}|\s{0,1})\d{2}(-{0,1}|\s{0,1})\d{2}$/
    }
  }
});</pre></div></li></ul></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec56"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In this recipe, we learned the basics of the <code class="literal">Backbone.Validation</code> extension, though there are even more techniques that you can find on the <span class="strong"><strong>GitHub</strong></span> documentation page <a class="ulink" href="https://github.com/thedersen/backbone.validation">https://github.com/thedersen/backbone.validation</a>.</li><li class="listitem" style="list-style-type: disc">There are also a couple of alternatives to <code class="literal">Backbone.Validation</code>. They are <code class="literal">Backbone.validations</code> and <code class="literal">Backbone.Validator</code> extensions. They are all very similar, but <code class="literal">Backbone.Validation</code> has better documentation and provides more methods and events.</li></ul></div></div></div>
<div class="section" title="Validating an HTML form"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec26"/>Validating an HTML form</h1></div></div></div><p>Most of the <a class="indexterm" id="id167"/>web applications use HTML forms for data input, and Backbone is not an exception. An application should let the user know about any validation errors. Implementation of such functionality could fall on the developers' shoulders, but not in Backbone!</p><p>Fortunately, <code class="literal">Backbone.Validation</code><a class="indexterm" id="id168"/> provides integration with a view and works well with HTML forms.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec57"/>Getting ready</h2></div></div></div><p>Make sure you have the <code class="literal">Backbone.Validation</code> extension installed. Installation is described in the previous recipe <span class="emphasis"><em>Using advanced validation in a model</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec58"/>How to do it...</h2></div></div></div><p>Perform the following step to validate a form:</p><p>To allow form validation, we need to bind a view to a <code class="literal">Backbone.Validation</code> object in the <code class="literal">initialize()</code> method of the view.</p><div class="informalexample"><pre class="programlisting">Backbone.Validation.bind(this);</pre></div><p><code class="literal">Backbone.Validation</code> assumes that your model is stored in <code class="literal">this.model</code> and you have implemented getting data from the form elements and updating model values with it.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec59"/>How it works...</h2></div></div></div><p>If a user enters <a class="indexterm" id="id169"/>information that does not validate, then <code class="literal">Backbone.Validation</code> adds the <code class="literal">invalid</code> class to an appropriate form element and sets the <code class="literal">data-error</code> attribute with an error message.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note07"/>Note</h3><p><code class="literal">data-*</code> attributes are an HTML5 feature. They can be easily displayed with the help of CSS3 or custom JavaScript. They are also supported by major web frontend frameworks, such as jQueryMobile or Twitter Bootstrap.</p></div></div><p>The following screenshot illustrates how <code class="literal">Backbone.Validation</code> validates wrong data entered into the HTML form:</p><div class="mediaobject"><img alt="How it works..." src="graphics/2728OS_02_03.jpg"/></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec60"/>There's more...</h2></div></div></div><p>The following <a class="indexterm" id="id170"/>code snippet is a full listing of the example for this recipe:</p><div class="informalexample"><pre class="programlisting">(function($){

  // Define new model.
  var BuyerModel = Backbone.Model.extend({
    defaults: {
      name: '',
      age: ''
    },

    // Define validation criteria.
    validation: {
      name: {
        required: true
      },
      age: {
        min: 18
      }
    }
  });

  var BuyerModelFormView = Backbone.View.extend({

    // Bind Backbone.Validation to a view.
    initialize: function(){
      Backbone.Validation.bind(this);
    },

    // Define a template.
    template: _.template('\
      &lt;form&gt;\
        Enter name:\
        &lt;input name="name" type="text" value="&lt;%= name %&gt;"&gt;&lt;br&gt;\
        Enter age:\
        &lt;input name="age" type="text" value="&lt;%= age %&gt;"&gt;&lt;br&gt;\
        &lt;input type="button" name="save" value="Save"&gt;\
      &lt;/form&gt;\
    '),

    // Render view.
    render: function(){
      // Render template with model values.
      var html = this.template(this.model.toJSON());

      // Update html.
      $(this.el).html(html);
    },

    // Bind save callback click event.
    events: {
      'click [name~="save"]': 'save'
    },

    // Save callback.
    save: function(){
      
      // Update model attributes.
      this.model.set({
        name: $('[name~="name"]').val(),
        age: $('[name~="age"]').val()
      });
    }
  });


  $(document).ready(function () {
     // Create new model instance.
     var buyerModel = new BuyerModel();

     // Create new view instance.
     var buyerModelFormView = new BuyerModelFormView({
       model: buyerModel,
       el: 'body'
     });

     // Render view.
     buyerModelFormView.render();
  });
})(jQuery);</pre></div></div></div>
<div class="section" title="Working with nested attributes in a model"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec27"/>Working with nested attributes in a model</h1></div></div></div><p>Sometimes <a class="indexterm" id="id171"/>nested attributes are required to operate with complex hierarchical structures stored in the model. This is typically done by using JavaScript objects as <a class="indexterm" id="id172"/>nested attributes; however, it is not a Backbone way. Fortunately, there is the <code class="literal">Backbone-Nested</code> extension, which provides various improvements when working with nested attributes.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec61"/>Getting ready</h2></div></div></div><p>You can download the <code class="literal">Backbone-Nested</code> extension from the <span class="strong"><strong>GitHub</strong></span> page <a class="ulink" href="https://github.com/afeld/backbone-nested">https://github.com/afeld/backbone-nested</a>. To include this extension into your project, save the <code class="literal">backbone-nested.js</code> file into the <code class="literal">lib</code> folder and include a reference to it in <code class="literal">index.html</code>.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note08"/>Note</h3><p>Including Backbone extension into your project is described in the <span class="emphasis"><em>Extending application with plugins</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Backbone">Chapter 1</a>, <span class="emphasis"><em>Understanding Backbone</em></span> in detail.</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec62"/>How to do it...</h2></div></div></div><p>Perform the following steps to use nested attributes in a model:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Use <code class="literal">Backnone.NestedModel</code> as the base object when extending a new model.<div class="informalexample"><pre class="programlisting">  var BuyerModel = Backbone.NestedModel.extend({

  });</pre></div></li><li class="listitem">Set the nested attribute value with the help of dot syntax provided by the <code class="literal">Backbone-Nested</code> extension.<div class="informalexample"><pre class="programlisting">    buyerModel.set({
      'name.title': 'Mr',
      'name.generation': 'II'
    });</pre></div><p>You can still <a class="indexterm" id="id173"/>use object syntax, which is typical to JavaScript, to set multiple values.</p><div class="informalexample"><pre class="programlisting">    buyerModel.set({
      name: {
        first: 'John',
        last: 'Smith',
        middle: {
          initial: 'P',
          full: 'Peter'
        }
      }
    });</pre></div></li><li class="listitem">Get the<a class="indexterm" id="id174"/> attribute value with the dot syntax.<div class="informalexample"><pre class="programlisting">    buyerModel.get('name.middle.full'); // Peter
    buyerModel.get('name.middle');
    // { full: 'Peter', initial: 'P }
    buyerModel.get('name.title'); // Mr</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec63"/>How it works...</h2></div></div></div><p>The <code class="literal">Backbone-Nested</code> extension provides a new model object <code class="literal">Backbone.NestedModel</code> based on <code class="literal">Backbone.Model</code>. It overrides existing methods, such as <code class="literal">get()</code>, <code class="literal">set()</code>, <code class="literal">has()</code>, <code class="literal">toJSON</code>, and so on. It also provides new <code class="literal">add()</code> and <code class="literal">remove()</code> methods.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec64"/>There's more...</h2></div></div></div><p>This section describes advanced usage of the <code class="literal">Backbone-Nested</code> extension.</p><div class="section" title="Working with a nested array of attributes"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec17"/>Working with a nested array of attributes</h3></div></div></div><p>Of course, there is a <a class="indexterm" id="id175"/>way of working with a bit more <a class="indexterm" id="id176"/>complex structures, such as nested array of attributes. You can set it using the object syntax as well.</p><div class="informalexample"><pre class="programlisting">    buyerModel.set({
      'addresses': [
        {city: 'Brooklyn', state: 'NY'},
        {city: 'Oak Park', state: 'IL'}
      ]
    });</pre></div><p>Or you can set attributes in the nested array with a dot and bracket syntax, as shown in following example:</p><div class="informalexample"><pre class="programlisting">    buyerModel.set({
      'addresses[1].state': 'MI'
    });</pre></div><p>And the same syntax is used for getting attributes from the nested array.</p><div class="informalexample"><pre class="programlisting">    buyerModel.get('addresses[0].state'); // NY
    buyerModel.get('addresses[1].state'); // MI</pre></div></div><div class="section" title="Adding/removing elements to/from a nested array"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec18"/>Adding/removing elements to/from a nested array</h3></div></div></div><p><code class="literal">Backbone-Nested</code> provides <a class="indexterm" id="id177"/>additional methods<a class="indexterm" id="id178"/> to work with nested arrays. The <code class="literal">add</code> method adds a new element to a nested array. Here is how it works.</p><div class="informalexample"><pre class="programlisting">    buyerModel.add('addresses', {
      city: 'Seattle',
      state: 'WA'
    });

    buyerModel.get('addresses[2]');
    // { city: 'Seattle', state: 'WA' }</pre></div><p>The <code class="literal">remove()</code> method removes desired elements from a nested array. Let's see how it is done.</p><div class="informalexample"><pre class="programlisting">    buyerModel.remove('addresses[1]');

    buyerModel.get('addresses').length; // 2</pre></div></div><div class="section" title="Binding callbacks to an events"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec19"/>Binding callbacks to an events</h3></div></div></div><p>When binding a callback to an <a class="indexterm" id="id179"/>event, you can use the same dot and bracket syntax as described previously. Let's check out the following example of binding a callback to an event:</p><div class="informalexample"><pre class="programlisting">    buyerModel.bind('change:addresses[0].city', function(model, value){
      console.log(value);
    });

    buyerModel.set('addresses[0].city', 'Chicago');</pre></div><p>Moreover, <code class="literal">Backbone-Nested</code> provides additional <code class="literal">add:*</code> and <code class="literal">remove:*</code> events for handling array update events.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec65"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">There is more information about event handling available in the recipe <span class="emphasis"><em>Handling events of Backbone objects</em></span> in <a class="link" href="ch05.html" title="Chapter 5. Events and Bindings">Chapter 5</a>, <span class="emphasis"><em>Events and Bindings</em></span>.</li><li class="listitem" style="list-style-type: disc">There are a couple of alternatives to the <code class="literal">Backbone-Nested</code> extension, such as <code class="literal">Backbone-deep-model</code> and <code class="literal">Backbone-dotattr</code>. They are all very similar, but <code class="literal">Backbone-Nested</code> provides more features, and is better maintained.</li></ul></div></div></div>
<div class="section" title="Implementing a one-to-one relationship"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec28"/>Implementing a one-to-one relationship</h1></div></div></div><p>Mostly in any <a class="indexterm" id="id180"/>application, we may need to have models that are related to each other. For example, a blog post model can have a relationship with a model of its author or have a connection to a comment model.</p><p>We may also need to access comments quickly when dealing with a blog post, or list all blog posts of a specific author. Moreover, we may want to export blog posts with author info and comments in a single JSON format.</p><p>In a Backbone app, this can be implemented with the help of the <code class="literal">Backbone-relational</code> extension.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec66"/>Getting ready</h2></div></div></div><p>You can download the <code class="literal">Backbone-relational</code> extension from the <span class="strong"><strong>GitHub</strong></span> page <a class="ulink" href="https://github.com/PaulUithol/Backbone-relational">https://github.com/PaulUithol/Backbone-relational</a>. To include <code class="literal">Backbone-relational</code> into your project, save the <code class="literal">backbone-relational.js</code> file into the <code class="literal">lib</code> folder and include a reference to it in <code class="literal">index.html</code>.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note09"/>Note</h3><p>Including a Backbone extension into your project is described in the <span class="emphasis"><em>Extending application with plugins</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Backbone">Chapter 1</a>, <span class="emphasis"><em>Understanding Backbone</em></span> in detail.</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec67"/>How to do it...</h2></div></div></div><p>Let's recall our<a class="indexterm" id="id181"/> Invoice application and try to find out how we can apply a one-to-one relationship there. Let's say we want buyers to log in to the application and view all invoices assigned to them.</p><p>In this case, we need to store buyer credentials somewhere. It can be a new <code class="literal">UserModel</code> associated with an existing <code class="literal">BuyerModel</code>. We know that for each user there is a single buyer and vice versa, so we are dealing with a one-to-one relationship. Let's implement one such one-to-one relationship.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Extend models from <code class="literal">Backbone.RelationalModel</code> and pass the <code class="literal">relations</code> property with a relationship definition.<div class="informalexample"><pre class="programlisting">  // Define new model object.
  var UserModel = Backbone.RelationalModel.extend({

  });

  // Define new model object.
  var BuyerModel = Backbone.RelationalModel.extend({

    // Define one-to-one relationship.
    relations: [
      {
         // Relationship type
         type: Backbone.HasOne,

         // Relationship key in BuyerModel.
         key: 'user',

         // Related model.
         relatedModel: UserModel,

         // Define reverse relationship.
         reverseRelation: {
           type: Backbone.HasOne,
           key: 'buyer'
         }
      }
    ]
  });</pre></div><p>As we see from the previous example, the <code class="literal">relations</code> property takes an array, so multiple relationships are possible.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip10"/>Tip</h3><p>Note that <code class="literal">UserModel</code> should be defined before <code class="literal">BuyerModel</code>, because it is referenced afterwards in the code (in the <code class="literal">relations</code> property of <code class="literal">BuyerModel</code>).</p></div></div></li><li class="listitem">Initialize a<a class="indexterm" id="id182"/> one-to-one relationship by referencing the <code class="literal">UserModel</code> instance in the <code class="literal">BuyerModel</code> instance or vice versa.<div class="informalexample"><pre class="programlisting">    var userModel1 = new UserModel({
      login: 'jsmith',
      email: 'jsmith@example.com'
    });

    var buyerModel1 = new BuyerModel({
      firstName: 'John',
      lastName: 'Smith',
      user: userModel1
    });</pre></div><p>There is also a way to do the same by passing a single input JSON when creating both <code class="literal">BuyerModel</code> and <code class="literal">UserModel</code>.</p><div class="informalexample"><pre class="programlisting">    var buyerModel = new BuyerModel({
      firstName: 'John',
      lastName: 'Smith',
      user: {
        login: 'jsmith',
        email: 'jsmith@example.com'
      }
    });</pre></div></li><li class="listitem">If a reversed relation is defined, pass a <code class="literal">BuyerModel</code> array when initializing <code class="literal">UserModel</code>.<div class="informalexample"><pre class="programlisting">    var userModel = new UserModel({
      login: 'jsmith',
      email: 'jsmith@example.com',
      buyer: {
        firstName: 'John',
        lastName: 'Smith'
      }
    });</pre></div></li><li class="listitem">Optionally, access the related model with the help of the <code class="literal">get()</code> method.<div class="informalexample"><pre class="programlisting">    buyerModel1.get('user').get('email');
    // jsmith@example.com
    userModel1.get('buyer').get('lastName'); // Smith</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec68"/>How it works...</h2></div></div></div><p>Each <code class="literal">Backbone.RelationalModel</code> registers itself with <code class="literal">Backbone.Store</code> upon creation (and is removed<a class="indexterm" id="id183"/> from the <code class="literal">Store</code> when destroyed). When creating or updating an attribute that is a key in a relation, removed related objects are notified of their removal, and new related objects are looked up in the <code class="literal">Store</code>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec69"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">One-to-many relationships and many-to-many relationships are described in the recipe <span class="emphasis"><em>Implementing a one-to-many relationship</em></span> in <a class="link" href="ch03.html" title="Chapter 3. Collections">Chapter 3</a>, <span class="emphasis"><em>Collections</em></span>.</li><li class="listitem" style="list-style-type: disc">Complete documentation to the <code class="literal">Backbone-relational</code> extension can be found on the <span class="strong"><strong>GitHub</strong></span> page <a class="ulink" href="https://github.com/PaulUithol/Backbone-relational">https://github.com/PaulUithol/Backbone-relational</a>.</li><li class="listitem" style="list-style-type: disc">Also, there are a couple of alternatives to <code class="literal">Backbone-relational</code>, which are very similar and known as <code class="literal">Backbone-associations</code> and <code class="literal">ligament.js</code>. However, they do not provide one-to-many and many-to-many relationships.</li></ul></div></div></div></body></html>