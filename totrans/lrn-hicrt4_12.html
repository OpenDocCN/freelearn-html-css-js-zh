<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch12"/>Chapter 12. Highcharts and jQuery Mobile</h1></div></div></div><p>Highcharts does not only work in desktop browsers; it also supports mobile platforms. In this chapter, we will explore how to deploy Highcharts to mobile platforms with a web mobile framework, jQuery Mobile, that is built on top of jQuery. A very brief introduction to jQuery Mobile is given. We will look into a couple of areas that are crucial to understanding the basics of the mobile framework. Then, we will integrate Highcharts and jQuery Mobile by building a mobile application using an Olympic 2012 medals table. We will demonstrate how to apply mobile events such as swipe, rotation, and pinch to navigate through the charts. In this chapter, we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Introducing jQuery Mobile</li><li class="listitem" style="list-style-type: disc">Understanding mobile page structure</li><li class="listitem" style="list-style-type: disc">Understanding page initialization</li><li class="listitem" style="list-style-type: disc">Linking between mobile pages</li><li class="listitem" style="list-style-type: disc">Integrating Highcharts and jQuery Mobile</li><li class="listitem" style="list-style-type: disc">Drilling down for data from one chart to another</li><li class="listitem" style="list-style-type: disc">Changing chart displays with touch actions: swipe, rotate, and pinch</li></ul></div><div><div><div><div><h1 class="title"><a id="ch12lvl1sec73"/>A short introduction to jQuery Mobile</h1></div></div></div><p>This chapter is not a full tutorial for<a id="id841" class="indexterm"/> jQuery Mobile (jQM) by any means, but it is a quick-start guide for using it with Highcharts. JQuery Mobile is a web development framework for mobile devices built on top of jQuery. It is designed to be compatible across all mobile platforms, and the UI look and feel emulate native mobile applications. The benefit of this is low cost development in a single-source code, without the need for testing across all mobile platforms and browsers.</p><p>Before we drill down into how Highcharts can be integrated with jQM, a few important concepts need to be understood.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec74"/>Understanding mobile page structure</h1></div></div></div><p>The most important<a id="id842" class="indexterm"/> concept in jQM is to understand the structure of a mobile page, which is not the same as a normal HTML page. A mobile page is constructed inside an HTML <code class="literal">&lt;div&gt;</code> box with a jQM-specific attribute, <code class="literal">data-role='page'</code>, marked as a boundary. In fact, the <code class="literal">data-*</code> syntax is <strong>Customer Data Attributes</strong><a id="id843" class="indexterm"/> defined in HTML5 standard. This allows web developers to store custom data specific to the page or application, which can easily access the data attribute values. For more information on APIs for HTML<a id="id844" class="indexterm"/> visit <a class="ulink" href="http://dev.w3.org/html5/spec/single-page.html#custom-data-attribute">http://dev.w3.org/html5/spec/single-page.html#custom-data-attribute</a>. Within a mobile page, normal HTML tags, such as input, hyperlinks, select, and so on, are used.</p><p>An HTML document can contain multiple mobile pages and links through an anchor and the <code class="literal">id</code> attribute. An anchor is the same as a normal HTML anchor (for example, <code class="literal">#chart</code>). The framework resolves the anchor reference and retrieves a mobile page with the matching <code class="literal">id</code> attribute, which has the following syntax:</p><div><pre class="programlisting">&lt;div data-role="page" id="chart"&gt;     </pre></div><p>The following is an example of a single mobile page in an HTML document:</p><div><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt; 
  &lt;title&gt;My Page&lt;/title&gt; 
  &lt;meta name="viewport" 
        content="width=device-width, initial-scale=1, 
                 maximum-scale=1, user-scalable=0"&gt;
  &lt;!-- CDN loading of jQuery and jQM --&gt;
  &lt;link rel="stylesheet" 
   href="https://code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.css" /&gt;
  &lt;script  
   src="img/jquery-2.1.1.min.js"&gt;&lt;/script&gt;
  &lt;script 
   src="img/jquery.mobile-1.4.3.min.js"&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div data-role="page"&gt;
     &lt;div data-role="header"&gt;
         &lt;h1&gt;jQuery Mobile&lt;/h1&gt;
     &lt;/div&gt;&lt;!-- /header --&gt;
     &lt;div data-role="content"&gt;
          ....
     &lt;/div&gt;
  &lt;/div&gt;&lt;!-- /page --&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div><p>Depending on the <a id="id845" class="indexterm"/>purpose of the mobile application, all the pages can be built into a single HTML document or they can exist in separate documents. One important aspect is that, if multiple mobile pages are defined within a document, the first page in the <code class="literal">&lt;body&gt;</code> tag is always loaded on the screen. In jQM, a page is generally composed of the head and content, optionally a footer and navigation bar. Each component also has a <code class="literal">&lt;div&gt;</code> box with <code class="literal">data-role</code> to indicate the type of component within a mobile page. The following code shows how multiple mobile pages in a document are loaded:</p><div><pre class="programlisting">&lt;div data-role="page" &gt;
   &lt;div data-role="header"&gt;
      &lt;h1&gt;jQuery Mobile&lt;/h1&gt;
      &lt;a href="#config" data-rel='dialog' 
         data-icon="gear"&gt;Options&lt;/a&gt;
   &lt;/div&gt;&lt;!-- /header --&gt;
   &lt;div data-role="content"&gt;
       ....
   &lt;/div&gt;
&lt;/div&gt;&lt;!-- /page --&gt;

&lt;!-- Page for the option dialog --&gt;
&lt;div data-role="page" id='config'&gt;
   &lt;div data-role="header"&gt;
       &lt;h1&gt;Config&lt;/h1&gt;
   &lt;/div&gt;&lt;!-- /header --&gt;

   &lt;div data-role="content"&gt;
       &lt;a href="#" data-role="button" 
          data-rel="back" &gt;Cancel&lt;/a&gt;
   &lt;/div&gt;
&lt;/div&gt;&lt;!-- /page --&gt;</pre></div><p>As we can see, there are two <code class="literal">&lt;div&gt;</code> boxes with the <code class="literal">data-role='page'</code> attribute. The first <code class="literal">&lt;div&gt;</code> box is the same as the previous example with an additional <code class="literal">Options</code> link button that redirects to the second mobile page, <code class="literal">id='config'</code>. The <code class="literal">data-icon="gear"</code> attribute decorates the button with a gear icon provided by the framework.</p><p>For the <a id="id846" class="indexterm"/>full list of icons visit <a class="ulink" href="http://demos.jquerymobile.com/1.4.3/icons">http://demos.jquerymobile.com/1.4.3/icons</a>. When the button is pressed, it will open the second page as a modal dialog box due to the <code class="literal">data-rel='dialog'</code> attribute. The following screenshot shows the view of the first mobile page as it appears on an iPhone:</p><div><img src="img/7451OS_12_01.jpg" alt="Understanding mobile page structure"/></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec75"/>Understanding page initialization</h1></div></div></div><p>In this section, we will look at why<a id="id847" class="indexterm"/> we don't use the traditional DOM-ready method to run initialization code for mobile pages. Suppose a page's content requires some sort of initialization, then using the traditional DOM-ready method <code class="literal">$.ready</code> can have a negative effect. This is because the <code class="literal">$.ready</code> method runs as soon as all the DOMs inside the document are loaded. In other words, we have no control over when to run the jQM page initialization code if it is inside the DOM ready handler.</p><p>However, jQM provides a specific event, <code class="literal">pageinit</code>, that caters for this scenario. All we need to do is to assign an <code class="literal">id</code> value inside the <code class="literal">&lt;div data-role='page'&gt;</code> markup, then define the <code class="literal">pageinit</code> event handler for that <code class="literal">id</code> value. Whenever a page is going to be initialized for display, this event is triggered. Note that the <code class="literal">$.ready</code> method is still going to be called, but we just don't use it in jQM. To demonstrate this concept, let us use the previous multipage example with an additional <code class="literal">$.ready</code> call:</p><div><pre class="programlisting">  &lt;script type="text/javascript"&gt;
      $(document).on('pageinit', '#main_page', function() {
           alert('jQuery Mobile: pageinit for Main page');
      });

      $(document).on('pageinit', '#config', function() {
           alert('jQuery Mobile: pageinit for Config page');
      });

      $(document).ready(function() {
           alert('jQuery ready');
      });
  &lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt; 
    &lt;!--  MAIN PAGE --&gt;
    &lt;div data-role="page" id='main_page'&gt;
       &lt;div data-role="header"&gt;
          &lt;h1&gt;jQuery Mobile&lt;/h1&gt;
             &lt;a href="#config" data-rel='dialog' 
                data-icon="gear" 
                class='ui-btn-right'&gt;Options&lt;/a&gt;
       &lt;/div&gt;&lt;!-- /header --&gt;

       &lt;div data-role="content" id=''&gt;
       &lt;/div&gt;
    &lt;/div&gt;&lt;!-- /page --&gt;

    &lt;!-- CONFIG PAGE --&gt;
    &lt;div data-role="page" id='config' &gt;
       &lt;div data-role="header"&gt;
          &lt;h1&gt;Config&lt;/h1&gt;
       &lt;/div&gt;&lt;!-- /header --&gt;

       &lt;div data-role="content"&gt;
          &lt;a href="" data-role="button" 
             data-rel="back" &gt;Cancel&lt;/a&gt;
       &lt;/div&gt;
    &lt;/div&gt;&lt;!-- /page --&gt;</pre></div><p>There are two mobile <a id="id848" class="indexterm"/>pages defined in this example: <code class="literal">main_page</code> and <code class="literal">config</code>. Each mobile page is tied to its <code class="literal">pageinit</code> event handler. With the <code class="literal">$.ready</code> method, we can observe the call sequence with other <code class="literal">pageinit</code> events. When we first load the document to the browser, we see the following screenshot:</p><div><img src="img/7451OS_12_02.jpg" alt="Understanding page initialization"/></div><p>Remember that jQM <a id="id849" class="indexterm"/>always displays the first page in the HTML body. That means the <code class="literal">pageinit</code> event for <code class="literal">main_page</code> is fired as soon as the DOM for <code class="literal">main_page</code> is fully loaded and initialized for the display. It is also important to understand that, at the point of execution, the DOM for the subsequent <code class="literal">config</code> page is not loaded yet. When we touch the <strong>OK</strong> button, the execution resumes and the DOM for the <code class="literal">config</code> page is then loaded. Hence all the DOMs in the document are loaded and the <code class="literal">$.ready</code> method is then called; it shows the second alert message as shown in the following screenshot:</p><div><img src="img/7451OS_12_03.jpg" alt="Understanding page initialization"/></div><p>When we touch the <a id="id850" class="indexterm"/>
<strong>OK</strong> button, the alert box disappears and the control returns back to the browser. Now, if we touch the <strong>Options</strong> button in the top right-hand corner, the <code class="literal">config</code> dialog page is initialized and displayed on the screen. Hence the <code class="literal">pageinit</code> handler for the <code class="literal">config</code> page is called:</p><div><img src="img/7451OS_12_04.jpg" alt="Understanding page initialization"/></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec76"/>Linking between mobile pages</h1></div></div></div><p>The second important<a id="id851" class="indexterm"/> concept in jQM is how the mobile pages are linked together. Understanding this concept can help us to design a web mobile application with a fluid user experience. In jQM, there are two ways to load an external mobile page: HTTP and Ajax. Depending on how we set the <code class="literal">data-</code> attribute, it interprets the <code class="literal">href</code> value and decides which way to load a mobile page. By default, apart from the first document load that is a normal HTTP transfer, the mobile page is loaded through Ajax.</p><p>The following block diagram explains how multiple mobile page blocks are managed within a document:</p><div><img src="img/7451OS_12_05.jpg" alt="Linking between mobile pages"/></div><p>When a mobile page <a id="id852" class="indexterm"/>invokes another mobile page, the jQM framework basically parses the <code class="literal">href</code> value. Since this is an anchor reference, it indicates that this is an internal mobile page block. The framework locates the page block from the current DOM by matching the <code class="literal">id</code> value. It then initializes and renders the page, which also triggers the <code class="literal">pageinit</code> event for page B as shown in the previous block diagram.</p><p>Suppose we have two separate HTML documents in which a button on one page is referring to the other document. The following block diagram describes the scenario:</p><div><img src="img/7451OS_12_06.jpg" alt="Linking between mobile pages"/></div><p>In this case, we add an <a id="id853" class="indexterm"/>attribute, <code class="literal">data-ajax="false"</code> (for the sake of a simpler approach to managing the JavaScript code), to tell jQM that this button requires a document load instead of a background Ajax load. This is important because otherwise the <code class="literal">pageinit</code> handler code (or any JavaScript file) inside the <code class="literal">&lt;script&gt;</code> tag will not be loaded for the new mobile page, <code class="literal">B.html</code>.</p><div><div><h3 class="title"><a id="note22"/>Note</h3><p>JavaScript code can be embedded inside a <code class="literal">&lt;script&gt;</code> tag within a mobile page block and executed. The downside of this approach is that it requires more code management, as each page block has its own <code class="literal">pageinit</code> handler code.</p></div></div><p>There is an alternative way to load Ajax in multiple documents, but we will leave it here. This is more than sufficient to implement a simple mobile web application. Readers can learn more from the jQuery Mobile documentation.</p></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec77"/>Highcharts in touch-screen environments</h1></div></div></div><p>The good thing about <a id="id854" class="indexterm"/>Highcharts is that it works perfectly well on<a id="id855" class="indexterm"/> both desktop browsers and web mobile environments without requiring any change of code. The only part that needs some consideration is events handling, because mobile devices are all touch-screen based and that means the mouse cursor is invisible.</p><p>In Highcharts, all the mouse hover events can still be triggered in touch devices, even though the mouse cursor is not shown. For instance, suppose we define a series with the <code class="literal">mouseOut</code>, <code class="literal">mouseOver</code>, and <code class="literal">click</code> events handling. If we touch the series, both the <code class="literal">mouseOver</code> and <code class="literal">click</code> events are triggered. However, if we touch another series causing the previous selected series to be unselected, a <code class="literal">mouseOut</code> event for the first series is fired. Needless to say, the sequence of events would be different with a real pointing device. In general, we should refrain from using any mouse hover events in touch-screen based devices.</p><p>In the next section, we <a id="id856" class="indexterm"/>will learn how to integrate jQM with <a id="id857" class="indexterm"/>Highcharts, including how to apply touch events to charts, how to use the chart <code class="literal">click</code> events to launch another chart and mobile page, and so on.</p></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec78"/>Integrating Highcharts and jQuery Mobile using an Olympic medals table application</h1></div></div></div><p>In this section, we will build a <a id="id858" class="indexterm"/>mobile application for browsing the results of the Olympic 2012 medals table. This application is only tested on iPhone and iPad. The startup screen provides four menus for looking up the results, as shown in the following screenshot:</p><div><img src="img/7451OS_12_07.jpg" alt="Integrating Highcharts and jQuery Mobile using an Olympic medals table application"/></div><p>The initial page is made up of a list of four hyperlinks referring to other pages, as shown in the following code:</p><div><pre class="programlisting">  &lt;head&gt;
      &lt;!-- CDN load of Highcharts, jQuery and jQM --&gt;
      ....
  &lt;/head&gt;
  &lt;body&gt;
  &lt;div data-role="page"&gt;
     &lt;div data-role="header"&gt;
        &lt;h1&gt;London Olympic 2012 &lt;/h1&gt;
     &lt;/div&gt;&lt;!-- /header --&gt;

     &lt;div data-role="content"&gt;
         &lt;ul data-role="listview" data-inset="true"&gt;
             &lt;li&gt;&lt;a href="./gold.html" 
<strong>                  data-ajax="false" &gt;Top 10 countries by gold&lt;/a&gt;&lt;/li&gt;</strong>
             &lt;li&gt;&lt;a href="./medals.html" 
<strong>                  data-ajax="false" &gt;Top 10 countries by medals&lt;/a&gt;&lt;/li&gt;</strong>
             &lt;li&gt;&lt;a href="#"&gt;A-Z countries&lt;/a&gt;&lt;/li&gt;
             &lt;li&gt;&lt;a href="#"&gt;A-Z olympians&lt;/a&gt;&lt;/li&gt;
         &lt;/ul&gt;
     &lt;/div&gt;
  &lt;/div&gt;&lt;!-- /page --&gt;
  &lt;/body&gt;</pre></div><p>So, when the <a id="id859" class="indexterm"/>
<strong>Top 10 countries by gold</strong> button is clicked, the <code class="literal">gold.html</code> file is HTTP-loaded (not Ajax) because we define <code class="literal">data-ajax="false"</code>. Since it is an HTTP load, the whole page, <code class="literal">gold.html</code>, is loaded onto the browser as well as everything within the <code class="literal">&lt;script&gt;</code> tags that are being executed.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec86"/>Loading up the gold medals page</h2></div></div></div><p>The following is the<a id="id860" class="indexterm"/> content of the <code class="literal">gold.html</code> file:</p><div><pre class="programlisting">   &lt;head&gt;
      &lt;!-- CDN load of Highcharts, jQuery and jQM --&gt;
      ....
      &lt;script type="text/javascript" src="img/common.js"&gt;&lt;/script&gt;
      &lt;script type="text/javascript" src="img/gold.js"&gt;&lt;/script&gt;
   &lt;/head&gt;
   &lt;body&gt;
   &lt;div data-role="page" id='gold_chart'&gt;
      &lt;div data-role="header"&gt;
       &lt;a href="olympic.html" data-icon="home" 
          data-iconpos="notext"&gt;Home&lt;/a&gt;
       &lt;h1&gt;London Olympic 2012 - Top 10 countries by gold&lt;/h1&gt;
       &lt;a href="#options" data-rel='dialog' 
          data-icon="gear" id='options'&gt;Options&lt;/a&gt;
      &lt;/div&gt;&lt;!-- /header --&gt;

      &lt;div data-role="content"&gt;
        &lt;div id='chart_container'&gt;&lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;&lt;!-- /page --&gt;

    &lt;!-- options dialog --&gt;
    &lt;div data-role="page" id='options' &gt;
       ....
    &lt;/div&gt;
  &lt;/body&gt;</pre></div><p>Since this whole<a id="id861" class="indexterm"/> HTML document is HTTP-loaded onto the browser, the <code class="literal">common.js</code> and <code class="literal">gold.js</code> files <a id="id862" class="indexterm"/>are also loaded (See <a class="ulink" href="http://joekuan.org/Learning_Highcharts/Chapter_12/">http://joekuan.org/Learning_Highcharts/Chapter_12/</a>). The file <code class="literal">common.js</code> contains common routine code shared in the demo, such as device detection, orientation detection, chart creation, and so on. The <code class="literal">gold.js</code> file contains the <code class="literal">pageinit</code> handler code for all the mobile pages in the <code class="literal">gold.html</code> file. As the mobile page block, <code class="literal">gold_chart</code>, is the first defined block in the document, it is automatically loaded and rendered to the display; thus, the <code class="literal">pageinit</code> event for the <code class="literal">gold_chart</code> page block is triggered.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec87"/>Detecting device properties</h2></div></div></div><p>For detecting<a id="id863" class="indexterm"/> mobile devices, the techniques range from string matching of the <code class="literal">navigator.userAgent</code> option, <code class="literal">jQuery.support</code>, <code class="literal">jQuery.browser</code> (deprecated), CSS media queries, to a third-party plugin such as Modernizer<a id="id864" class="indexterm"/> (see <a class="ulink" href="http://modernizr.com/">http://modernizr.com/</a> for details). However, there is no standard way of doing this. Perhaps it is due to the diverse requirements for compatibility checks. It is beyond the scope of this book to debate the merits of each technique. For this demo, all we are interested in is the difference in screen size; that is, if there is more space in the display (such as with tablet devices), then we display the full country name in the charts instead of the country code, which is used for smaller devices (touch phones). We assume the following technique is sufficient to differentiate between phone and tablet devices:</p><div><pre class="programlisting">function getDevice() { 
    return ($(window).width() &gt; 320)  ? "tablet" : "phone";
}</pre></div><p>The <code class="literal">$(window).width</code> property returns the width of the device in pixels, regardless of the device orientation. As for getting the current device orientation, we have the following <a id="id865" class="indexterm"/>method:</p><div><pre class="programlisting">function getOrientation() { 
    return (window.innerHeight/window.innerWidth) &gt; 1 ?           
            'portrait' : 'landscape';
} </pre></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec88"/>Plotting a Highcharts chart on a mobile device</h2></div></div></div><p>The following is <a id="id866" class="indexterm"/>the <code class="literal">pageinit</code> handler code for the <code class="literal">gold_chart</code> mobile page:</p><div><pre class="programlisting">$(document).on('pageinit', '#gold_chart', 
     function() {
       var device = getDevice();

       // current orientation
       var orientation = getOrientation();

       $.olympicApp = $.olympicApp || {};

       // Setup the point click events for all the 
       // country medal charts – used by plotGoldChart method
       var pointEvt = {
           events: {
              click: function(evt) { ... }
           }
       };

       // Switch between column and pie chart
       $('#chart_container').on('swipeleft', 
             function(evt) { ... } );

       $('#chart_container').on('swiperight', 
             function(evt) { ... } );

       // Switch between column and bar chart on 
       // smaller display
       $(document).on('orientationchange', 
             function(evt) { ... } );

       // General method for plotting gold medal chart
       // Used by dialog box also to toggle chart options
       // such as column stacking, labels etc
       $.olympicApp.plotGoldChart = function(chart, options) {
              .....
       };
       // Create and display Highcharts for gold medal chart
       $.olympicApp.goldChart = createChart({
              device: device,
              orientation: orientation, 
              load: $.olympicApp.plotGoldChart,
              type: (orientation == 'landscape') ?
                    'bar' : 'column',
              // legend and title settings specific
              ....

       });
    }
 );</pre></div><p>The touch events<a id="id867" class="indexterm"/> such as <code class="literal">swipeleft</code>, <code class="literal">swiperight</code>, and <code class="literal">orientationchange</code> will be discussed later on. The event handler, <code class="literal">pointEvt</code>, drills down further to another chart when the user taps on a country bar in the gold medal chart. We will also explore this interaction later on. Let's first focus on the last part of the code, which creates the chart. The <code class="literal">createChart</code> method is a general routine to create a Highcharts graph that has the common options shared by all the chart mobile pages. For example, the <code class="literal">renderTo</code> option is always set to <code class="literal">chart_container</code>, which is inside the <code class="literal">data-role='content'</code> attribute. The following code shows the <code class="literal">createChart</code> implementation:</p><div><pre class="programlisting">   // Main routine for creating chart
   function createChart(options) {

      // Based on the device display and current orientation
      // Work out the spacing options, labels orientation
      return new Highcharts.Chart({
          chart: {
              renderTo: 'chart_container',
              type: options.type,
              events: {
                  load: function(chart) {
                      // Execute the page general plot routine
                      options.load &amp;&amp; 
                      options.load(chart, options);
                  }
              },
              spacingLeft: ....,
              ....
          },
          title: { text: options.title },
          xAxis: {
             labels: ....
          },
          ....
      });
   }      </pre></div><p>Note that there is no <a id="id868" class="indexterm"/>series defined in the <code class="literal">options</code> parameter and the <code class="literal">options.load</code> property is set up to call the <code class="literal">plotGoldChart</code> function once the chart is created and loaded into the browser. The following code snippet is part of the <code class="literal">plotGoldChart</code> function:</p><div><pre class="programlisting">  // chart is the target chart object to apply new settings,
  // options is an object containing the new settings
  $.olympicApp.plotGoldChart = 
   function(chart, options) {

       // Get the top 10 countries with the
       // most gold medals
       $.getJSON('./gold_10.json', 

           function(result) {

               var device = getDevice();

               // Remove any series in the chart if exists
               ....

               // If display pie chart, 
               // then we only plot the gold medals series
               if (options &amp;&amp; options.type == 'pie') {
                   var goldOpt = { 
                       data: [], 
                       point: pointEvt,
                       type: 'pie',
                       dataLabels: { ... }
                   };
                   $.each(result.rows, 
                       function(idx, data) { 
                           goldOpt.data.push({ 

                              // If device is phone, 
                              // set short country labels
                              // otherwise full names
                              name: (device === 'phone') ?
                                  data.code : data.country,  
                              y: data.gold, 
                              color: pieGoldColors[idx] 
                           });
                   });
                   chart.addSeries(goldOpt, false);

                   // Disable option button for pie chart
                   $('#options').addClass('ui-disabled');

               } else {
                   // Sorting out chart option - stacking, 
                   // dataLabels if specified in the option
                   // parameters
                   var dataLabel = (options &amp;&amp; 
                                    options.dataLabel) ? {
                       enabled: true,
                       rotation: 
                         (getOrientation() == 'landscape') ?
                         0 : -45,
                       color: '#404040'
                       } : {
                       enabled: false
                   } ;
                   var stacking = (options &amp;&amp;
                       options.stacking) || null;

                   var bronzeOpt = { 
                       data: [], name: 'Bronze', 
                       color: '#BE9275', 
                       stacking: stacking,
                       dataLabels: dataLabel, 
                       point: pointEvt 
                      };
                   var silverOpt = { 
                       data: [], name: 'Silver', 
                       color: '#B5B5B5', 
                       stacking: stacking,
                       dataLabels: dataLabel, 
                       point: pointEvt 
                   };
                   var goldOpt = { 
                       data: [], 
                       name: 'Gold', 
                       color: '#FFB400', 
                       point: pointEvt, 
                       stacking: stacking,
                       dataLabels: dataLabel 
                   };
                   var category = [];
    
                   $.each(result.rows, 
                       function(idx, data) {
                          // Display country code on phone
                          // otherwise name 
                             category.push((device === 'phone') ?
                                   data.code : data.country);
                          goldOpt.data.push(data.gold);
                          silverOpt.data.push(data.silver);
                          bronzeOpt.data.push(data.bronze);
                   });
                                        
                   chart.xAxis[0].setCategories(category);
                   chart.addSeries(bronzeOpt, false);
                   chart.addSeries(silverOpt, false);
                   chart.addSeries(goldOpt, false);
                   // Enable the option button for the
                   // column chart
                   $('#options').removeClass('ui-disabled');
               }
               chart.redraw();
            });   // function(result)
     };  // function(chart, …</pre></div><p>The <code class="literal">plotGoldChart</code> method is<a id="id869" class="indexterm"/> a general routine to plot a series into an existing chart. The <code class="literal">options</code> parameter is a configuration object with new settings to be applied to the chart. First, the function invokes an Ajax call, <code class="literal">gold_10.json</code>, to get the top 10 countries with the most gold medals. Here is what the result looks like in JSON format:</p><div><pre class="programlisting">{"rows": [{
  "country":"United States","gold":46,"silver":29,"bronze":29,
  "total":104,"code":"USA"
},{
  "country":"China","gold":38,"silver":27,"bronze":23,
  "total":88,"code":"CHN"
},{
  "country":"Great Britain &amp; N.Ireland",
  "gold":29,"silver":17,"bronze":19, "total":65,"code":"GBR"
},{
  "country":"Russia Federation",
  "gold":24,"silver":26,"bronze":32,"total":82,"code":"RUS"
}, {   ....
}]</pre></div><p>Upon the results being<a id="id870" class="indexterm"/> returned, the handler function examines the <code class="literal">options</code> parameter for series type, device orientation, and other fields (stacking and data labels from the <code class="literal">config</code> dialog, which we will discuss later). Then, it creates the chart based on the settings. If the <code class="literal">type</code> property is <code class="literal">column</code>, then we create three column series called <code class="literal">Gold</code>, <code class="literal">Silver</code>, and <code class="literal">Bronze</code> with the point <code class="literal">click</code> event configured. If the <code class="literal">type</code> value is <code class="literal">pie</code>, then it creates a single pie series of gold medals with a gradual change of colors and data labels.</p><p>So, when the <code class="literal">gold_chart</code> page is first loaded, a column chart is created and displayed. The following screenshot shows the initial column chart in portrait mode:</p><div><img src="img/7451OS_12_08.jpg" alt="Plotting a Highcharts chart on a mobile device"/></div><p>If we touch the legend items to display the number of silver and bronze medals, the chart looks like the following screenshot:</p><div><img src="img/7451OS_12_09.jpg" alt="Plotting a Highcharts chart on a mobile device"/></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec89"/>Switching graph options with the jQuery Mobile dialog box</h2></div></div></div><p>The <strong>Options</strong> button<a id="id871" class="indexterm"/> in the top right-hand corner is only enabled if the current display chart is a column chart. It launches an option dialog box for switching stack columns and data labels. The following code is for the mobile page for the dialog box:</p><div><pre class="programlisting">&lt;div data-role="page" id='options' &gt;
    &lt;div data-role="header"&gt;
       &lt;h1&gt;Config&lt;/h1&gt;
    &lt;/div&gt;&lt;!-- /header --&gt;

    &lt;div data-role="content"&gt;
       &lt;label for="stacking"&gt;Stacking:&lt;/label&gt;
       &lt;select name="stacking" id="stacking" 
               data-role="slider"&gt;
           &lt;option selected="selected"&gt;Off&lt;/option&gt;
           &lt;option&gt;On&lt;/option&gt;
       &lt;/select&gt;

       &lt;label for="dataLabel"&gt;Show Values:&lt;/label&gt;
       &lt;select name="dataLabel" id="dataLabel" 
               data-role="slider"&gt;
           &lt;option selected="selected"&gt;Off&lt;/option&gt;
           &lt;option&gt;On&lt;/option&gt;
       &lt;/select&gt;
 
       &lt;a href="#" data-role="button" 
          data-rel="back" id='updateChart' &gt;Update&lt;/a&gt;
       &lt;a href="#" data-role="button" 
          data-rel="back" &gt;Cancel&lt;/a&gt;
    &lt;/div&gt;
&lt;/div&gt;&lt;!-- /page --&gt;</pre></div><p>The <code class="literal">&lt;select&gt;</code> markups<a id="id872" class="indexterm"/> in jQM are rendered as slider switches with the <code class="literal">data-role='slider'</code> attribute and the hyperlinks are rendered as dialog buttons with the <code class="literal">data-role='button'</code> attribute. The following screenshot shows the dialog page:</p><div><img src="img/7451OS_12_10.jpg" alt="Switching graph options with the jQuery Mobile dialog box"/></div><p>Likewise, we program the <code class="literal">pageinit</code> handler for the dialog page to initialize the <strong>Update</strong> button action:</p><div><pre class="programlisting">  $(document).on('pageinit', '#options', 
        function() {
            var myApp = $.olympicApp;

         $('#updateChart').click(function() {

             var stacking = 
                 ($('#stacking').val() === 'Off') ? 
                    null: 'normal';
             var dataLabel = 
                 !($('#dataLabel').val() == 'off');

             myApp.plotGoldChart(myApp.goldChart, {
                 stacking: stacking,
                 dataLabel: dataLabel
             });
         });
  });</pre></div><p>Actually, the action<a id="id873" class="indexterm"/> code for the button is very simple. Since we define the <strong>Update</strong> button with the <code class="literal">data-rel='back'</code> attribute, as soon as we tap the button, the dialog box is closed and we go back to the previous page. The option values from the <code class="literal">&lt;select&gt;</code> inputs are passed to the <code class="literal">plotGoldChart</code> routine to redraw the current chart. The following is a screenshot with only <strong>Show Values</strong> switched on:</p><div><img src="img/7451OS_12_11.jpg" alt="Switching graph options with the jQuery Mobile dialog box"/></div><p>The following screenshot shows a column chart with both stacking and data labeling switched on:</p><div><img src="img/7451OS_12_12.jpg" alt="Switching graph options with the jQuery Mobile dialog box"/></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec90"/>Changing the graph presentation with a swipeleft motion event</h2></div></div></div><p>Here, we enhance the <a id="id874" class="indexterm"/>experience by adding a <code class="literal">swipeleft</code> event to a chart. What we try to achieve is to apply a swipe motion from the right-hand side to the left-hand side on an existing column chart. This action switches the column chart to a pie chart with the same dataset, and vice versa with the swiperight motion:</p><div><pre class="programlisting">    // Switch to pie chart
    $('#chart_container').on('swipeleft', 
        function(evt) {
            var myApp = $.olympicApp;
            if (myApp.goldChart.series[0].type == 'column') {
                myApp.plotGoldChart(myApp.goldChart, { 
                   type: 'pie'                       
                });
            }
        });
   // Switch back to default column chart
    $('#chart_container').on('swiperight', 
        function(evt) {
            var myApp = $.olympicApp;
            if (myApp.goldChart.series[0].type == 'pie') {
                myApp.plotGoldChart(myApp.goldChart);
            }
    });</pre></div><p>The guard condition<a id="id875" class="indexterm"/> inside the handler is to stop redrawing the chart with the same presentation. The following is the view after the <code class="literal">swipeleft</code> action:</p><div><img src="img/7451OS_12_13.jpg" alt="Changing the graph presentation with a swipeleft motion event"/></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec91"/>Switching the graph orientation with the orientationchange event</h2></div></div></div><p>Assume that we are <a id="id876" class="indexterm"/>viewing the column chart on a touch-phone device in the portrait position. If we rotate the device, the chart will resize itself but the scale along the <em>y</em> axis is squashed. As a result, there is less clarity when comparing how well each country did. To overcome that, we use another jQuery Mobile event, <code class="literal">orientationchange</code>, that triggers when the mobile device is rotated. Here is the implementation for the handler:</p><div><pre class="programlisting">var device = ($(window).width() &gt; 750) ? 'tablet' : 'phone';

// Switch between vertical and horizontal bar
$(document).on('orientationchange', 
       function(evt) {

        // We only do this for phone device because
        // the display is narrow
        // Tablet device have enough space, the 
        // chart will look fine in both orientations
        if (device == 'phone') {

           var myApp = $.olympicApp;
           var orientation = getOrientation();

           // I have to destroy the chart and recreate
           // to get the inverted axes and legend box
           // relocated
           myApp.goldChart.destroy();

           // create the chart optimized for horizontal
           // view and invert the axis. 
           myApp.goldChart = createChart({
                device: device,
                orientation: orientation,
                inverted: (orientation === 'landscape'),
                load: myApp.plotGoldChart,
                legend: ....,
           }); 

           // Hide the address bar
           window.scrollTo(0,1);
        }
       }
   );</pre></div><p>We recreate the chart <a id="id877" class="indexterm"/>with the <code class="literal">inverted</code> option set to <code class="literal">true</code> to swap both <em>x</em> and <em>y</em> axes, as well as positioning the legend in the lower-right corner instead. A method for the chart <code class="literal">load</code> event is also set up in the configuration. In the end, an inverted chart is produced, as shown in the following screenshot:</p><div><img src="img/7451OS_12_14.jpg" alt="Switching the graph orientation with the orientationchange event"/></div><p>The following is a screenshot from a tablet device showing the gold and silver medals' chart:</p><div><img src="img/7451OS_12_15.jpg" alt="Switching the graph orientation with the orientationchange event"/></div><p>The <code class="literal">plotGoldChart</code> method <a id="id878" class="indexterm"/>detects a larger display and renders the chart (using the <code class="literal">setCategories</code> method) with full country names instead of the country code from the JSON result.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec79"/>Drilling down for data with the point click event</h1></div></div></div><p>So far we have only fiddled with the top<a id="id879" class="indexterm"/> countries ordered by gold medals. Let's see how we can use a Highcharts event to navigate around other charts in jQuery Mobile. Back with the <code class="literal">pageinit</code> handler code for <code class="literal">chart_page</code>, we declared the <code class="literal">pointEvt</code> variable, which is a <code class="literal">click</code> event handler shared by all the series in gold medal charts. The following code is for the event:</p><div><pre class="programlisting"> var pointEvt = {
     events: {
         click: function(evt) {
             document.location.href = './sport.html?country=' 
             // Country code or name
             + encodeURIComponent(this.category) + 
             // Medal color
             '&amp;color=' + this.series.name;
         }
     }
 };</pre></div><p>This event is triggered by<a id="id880" class="indexterm"/> touching a bar in a column chart or a slice in a pie chart. As a result, it loads a new document page (<code class="literal">sport.html</code>) with a bar chart. The URL for the document page is built inside the handler with the selected country code and the medal color as parameters. The HTML content of the page is listed in the next section. The <code class="literal">this</code> keyword refers to the data point (that is, the country bar) being clicked. The bar chart displays the list of sports in which the selected country won medals, along with the medal color. The following screenshot shows a chart for a list of sports in which Great Britain and Northern Ireland won gold medals:</p><div><img src="img/7451OS_12_16.jpg" alt="Drilling down for data with the point click event"/></div><p>Inside the new page, it uses similar code to the gold medal countries chart to produce the graph shown in the preceding screenshot. The only difference is that it is embedded with the point <code class="literal">click</code> callbacks. We <a id="id881" class="indexterm"/>will see that in the next section.</p></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec80"/>Building a dynamic content dialog with the point click event</h1></div></div></div><p>Now we know which<a id="id882" class="indexterm"/> sports have achieved<a id="id883" class="indexterm"/> gold medals in the Olympics, but we want to further find out who the medalists are. Let's touch the <strong>Athletics</strong> bar in the chart. A dialog box appears and presents a list of athletes in thumbnails along with their names, photos, and their event information, as shown in the following screenshot:</p><div><img src="img/7451OS_12_17.jpg" alt="Building a dynamic content dialog with the point click event"/></div><p>Notice that the dialog box shown in the preceding screenshot is not a static HTML page. This is constructed via a point <code class="literal">click</code> event and builds the dialog box content dynamically from the result. The problem is that, in order to launch a dialog page in jQM, we need to have a button somewhere on the page to start from. The trick is to create a jQM hidden button and a program to invoke the click action from inside the event handler. The following code is the HTML (<code class="literal">sport.html</code>) for both the hidden button and dialog page:</p><div><pre class="programlisting">&lt;!-- hidden dialog --&gt;
&lt;a id='hiddenDialog' href="#atheletes_dialog" 
   data-rel="dialog" data-transition="pop"   
   style='display:none;'&gt;&lt;/a&gt;
&lt;!-- medalists page --&gt;
&lt;div data-role="page" id='atheletes_dialog' &gt;
   &lt;div data-role="header"&gt;
      &lt;h1&gt;&lt;/h1&gt;
   &lt;/div&gt;&lt;!-- /header --&gt;

   &lt;div data-role="content"&gt;
      &lt;ul data-role="listview" data-inset="true"
          id='atheletes_list' &gt;
      &lt;/ul&gt;
   &lt;/div&gt;

   &lt;a href="" data-role="button" data-rel="back"&gt;Cancel&lt;/a&gt;
&lt;/div&gt;&lt;!-- /page --&gt;</pre></div><p>The following is the<a id="id884" class="indexterm"/> implementation of the<a id="id885" class="indexterm"/> <code class="literal">click</code> handler for the sports chart:</p><div><pre class="programlisting">point: {
    events: {
        click: function(evt) {
            var params = {
                country : urlParams.country,
                color : urlParams.color.toLowerCase(),
                sport : this.category
            };

            // Set the title for dialog
            $('#atheletes_dialog h1').text(this.category + 
               " (" + urlParams.country + ") - " +
               urlParams.color + " medalists");

            // Simulate a button click to launch the 
            // list view dialog
            $('#hiddenDialog').click();

            // Launch ajax query, append the result into 
            // a list and launch the dialog
            $.getJSON('./olympic.php', params,  
               function(result) {
                                         
                 $("#atheletes_list").empty();
                 $.each(result.rows, 
                    function(idx, athelete) {
                       // Formatting the image, name, and
                       // the sport event
                       var content = "&lt;li&gt;&lt;img src='" +
                          athelete.image + "' /&gt;" + "&lt;h3&gt;" + 
                          athelete.name + "&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;"
                          + athelete.event +
                          "&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;" + 
                          athelete.desc + "&lt;/p&gt;&lt;/li&gt;";
                                                   
                       $("#atheletes_list").append(content);
                    });
                    // Need this to apply the format to 
                    // the new entry
                    $('#atheletes_list').listview('refresh');
            });  // getJSON
        }
     }</pre></div><p>First, we assemble the title for the dialog page ready to launch. Then, we trigger an action click to the hidden button with the call as follows:</p><div><pre class="programlisting">$('#hiddenDialog').click();</pre></div><p>This in turn generates a <a id="id886" class="indexterm"/>click event to launch the <a id="id887" class="indexterm"/>dialog page. Then, we issue an Ajax query for the list of medalists with the current selected country, medal color, and sport as the filters. The server page, <code class="literal">olympic.php</code>, contains the Olympic result of each nation. It sorts the result according to the URL parameters and formats the ordered list in JSON format. We then convert each item from the JSON result and insert them into the <code class="literal">&lt;ul&gt;</code> list, <code class="literal">atheletes_list</code>.</p></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec81"/>Applying the gesturechange (pinch actions) event to a pie chart</h1></div></div></div><p>So far, we have only<a id="id888" class="indexterm"/> explored actions<a id="id889" class="indexterm"/> involving a single touch point. Our next goal is to learn how to apply more advanced action events with multi-touch. One of the most common actions is the pinch-in/out for zooming out/in respectively. The Safari browser for iOS supports this motion with the <code class="literal">gesturestart</code>, <code class="literal">gesturechange</code>, and <code class="literal">gestureend</code> events. Whenever there are two or more fingers touching the screen, the <code class="literal">gesturestart</code> event is fired. Then, the <code class="literal">gesturechange</code> event is triggered when the fingers are moved on the screen. When the fingers leave the screen, the <code class="literal">gestureend</code> event is generated. In returning control to the event handler, if the action is recognized, a certain property in the event object is updated. For instance, the <code class="literal">scale</code> property in the event object is set to larger than 1.0 for pinch-out and less than 1.0 for pinch-in. For the <code class="literal">GestureEvent</code> class <a id="id890" class="indexterm"/>reference, please see <a class="ulink" href="https://developer.apple.com/library/mac/documentation/AppleApplications/Reference/SafariWebContent/HandlingEvents/HandlingEvents.html">https://developer.apple.com/library/mac/documentation/AppleApplications/Reference/SafariWebContent/HandlingEvents/HandlingEvents.html</a>.</p><p>In this section, we will <a id="id891" class="indexterm"/>apply the pinch motions<a id="id892" class="indexterm"/> to a pie chart. For the pinch-out action, we turn the pie chart into a doughnut chart with extra information on the outer ring—and vice versa for pinch-in, turning the doughnut chart back to a pie chart. First of all, let's launch a new chart, <strong>Top 10 countries by medals</strong>, the second item from the front menu. The following screenshot is the output of the chart:</p><div><img src="img/7451OS_12_18.jpg" alt="Applying the gesturechange (pinch actions) event to a pie chart"/></div><p>When we perform a pinch-out action, the chart is redrawn as shown in the following screenshot:</p><div><img src="img/7451OS_12_19.jpg" alt="Applying the gesturechange (pinch actions) event to a pie chart"/></div><p>The outer ring shows<a id="id893" class="indexterm"/> the ratio of each color <a id="id894" class="indexterm"/>medal for each country. Moreover, the original pie chart data labels move inwards to make space for the outer ring. Let's see how the <code class="literal">gesturechange</code> event is implemented. The following is the code inside the <code class="literal">pageinit</code> handler:</p><div><pre class="programlisting">      $('#chart_container').on('gesturechange', 
          function(evt) {
              evt = evt.originalEvent || evt;
              var myApp = $.olympicApp;

              if (evt.scale &gt; 1) {
                  // Pinch open - from pie chart to 
                  // donut chart
                  if (!myApp.medalChart.series[1].visible) {
                      myApp.medalChart.destroy();
                      myApp.medalChart = createChart({
                          orientation: getOrientation(),
                          device: device,
                          outerRing: true,
                          load: myApp.plotMedalChart
                      });
                  }
              } else if (myApp.medalChart.series[1].visible) {
                  // Pinch close
                  myApp.medalChart.destroy();
                  myApp.medalChart = createChart({
                      orientation: getOrientation(),
                      device: device,
                      load: myApp.plotMedalChart
                  });
              } 
      });</pre></div><p>We bind the <a id="id895" class="indexterm"/>gesture event to the chart <a id="id896" class="indexterm"/>container. This event handler is called whenever there is a multi-touch gesture made on the screen, such as a pinch or rotate motion. In order to make sure this is a pinch action, we need to look into the original event generated by the browser that is wrapped by the jQuery layer. We will examine whether the <code class="literal">scale</code> property has been set and decide whether it is pinch-in or pinch-out, then we will recreate the pie or doughnut chart if necessary.</p></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec82"/>Summary</h1></div></div></div><p>The goal of this chapter was to deploy Highcharts graphs on mobile touch devices. To do that, we used a mobile web development framework, jQuery Mobile. We worked through a very brief introduction and the concepts of the framework. We then examined how to integrate Highcharts with jQuery Mobile.</p><p>Then, we demonstrated a mobile application to show the results of the Olympic 2012 medals table. A menu of charts was built using the jQuery Mobile dialog page, and then we showed how to use the single-touch, multi-touch, and orientation events to navigate between charts. We also showed how to use the Highcharts click event to build a dialog page dynamically.</p><p>In the next chapter, we will learn how to apply Highcharts with ExtJs, a very powerful and popular <strong>Rich Internet Application</strong> (<strong>RIA</strong>) framework for building a desktop-style application.</p></div></body></html>