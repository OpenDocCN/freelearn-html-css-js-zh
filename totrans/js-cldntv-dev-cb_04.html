<html><head></head><body>
        

                            
                    <h1 class="header-title">Leveraging the Edge of the Cloud</h1>
                
            
            
                
<p class="mce-root">In this chapter, the following recipes will be covered:</p>
<ul>
<li class="mce-root">Serving a single-page application from the CDN</li>
<li class="mce-root">Associating a custom domain name with a CDN</li>
<li class="mce-root">Serving a website from the CDN</li>
<li class="mce-root">Deploying a service behind a CDN</li>
<li class="mce-root">Serving static JSON from a CDN</li>
<li class="mce-root">Triggering the invalidation of content in a CDN</li>
<li class="mce-root">Executing code at the edge of the cloud</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Introduction</h1>
                
            
            
                
<p>The edge of the cloud is likely the single most underrated layer of cloud-native systems. However, as I have previously mentioned, my first cloud-native <em>wow</em> moment was when I realized I could run a <strong>single-page application</strong> (<strong>SPA</strong>) presentation layer from the edge without the complexity, risk, and cost of running an elastic load balancer and multiple EC2 instances. Furthermore, leveraging the edge brings global scale to certain aspects of cloud-native systems without expending additional effort on multi-regional deployments. Our end users enjoy reduced latency, while we reduce the load on the internals of our system, reduce cost, and increase security. The recipes in this chapter cover a multitude of ways we can leverage the edge of the cloud to advance the quality of our cloud-native system, with minimum effort.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Serving a single-page application from a CDN</h1>
                
            
            
                
<p>In the <em>Deploying a single-page application</em> recipe, we covered the steps required to serve a single-page application from an S3 bucket. It is great fun to watch the light bulb turn on in an architect's mind when he or she realizes that such a simple deployment process can deliver so much scalability. Here is a recent quote from one of my customers—<em>That's it? No really, that's it</em>? In this recipe, we take this process one step further and demonstrate how easily we can add a CloudFront <strong>Content Delivery Network</strong> (<strong>CDN</strong>) layer in front of S3 to avail ourselves of even more valuable features.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Create the project from the following template:</li>
</ol>
<pre style="padding-left: 30px">$ sls create --template-url https://github.com/danteinc/js-cloud-native-cookbook/tree/master/ch4/cdn-spa --path cncb-cdn-spa</pre>
<ol start="2">
<li>Navigate to the <kbd>cncb-cdn-spa</kbd> directory with <kbd>cd cncb-cdn-spa</kbd>.</li>
<li>Review the file named <kbd>serverless.yml</kbd> with the following content:</li>
</ol>
<pre style="padding-left: 30px">service: cncb-cdn-spa<br/><br/>provider:<br/>  name: aws<br/><br/>plugins:<br/>  - serverless-spa-deploy<br/>  - <strong>serverless-spa-config</strong><br/><br/>custom:<br/>  spa:<br/>    files:<br/>      - source: ./build<br/>        globs: '**/*'<br/>        headers:<br/>          <strong>CacheControl</strong>: max-age=31536000 # 1 year<br/>      - source: ./build<br/>        globs: 'index.html'<br/>        headers:<br/>          <strong>CacheControl</strong>: max-age=300 # 5 minutes</pre>
<ol start="4">
<li>Install the dependencies with <kbd>npm install</kbd>.</li>
<li>Run the tests with <kbd>npm test</kbd>.</li>
<li>Review the contents generated in the <kbd>.serverless</kbd> directory:</li>
</ol>
<pre style="padding-left: 30px">{<br/> "Resources": {<br/>    ...<br/>    "WebsiteBucket": {<br/>      "Type": "AWS::S3::Bucket",<br/>      "Properties": {<br/>        "AccessControl": "PublicRead",<br/>        "WebsiteConfiguration": {<br/>          "IndexDocument": "index.html",<br/>          "ErrorDocument": "index.html"<br/>        }<br/>      }<br/>    },<br/>    "WebsiteDistribution": {<br/>      "Type": "AWS::CloudFront::Distribution",<br/>      "Properties": {<br/>        "DistributionConfig": {<br/>          "Comment": "Website: test-cncb-cdn-spa (us-east-1)",<br/>          "Origins": [<br/>            {<br/>              "Id": "<strong>S3Origin</strong>",<br/>              "DomainName": {<br/>                "Fn::Select": [<br/>                  1,<br/>                  {<br/>                    "Fn::Split": [<br/>                      "//",<br/>                      {<br/>                        "Fn::GetAtt": [<br/>                          "WebsiteBucket",<br/>                          "WebsiteURL"<br/>                        ]<br/>                      }<br/>                    ]<br/>                  }<br/>                ]<br/>              },<br/>              "CustomOriginConfig": {<br/>                "OriginProtocolPolicy": "http-only"<br/>              }<br/>            }<br/>          ],<br/>          "Enabled": true,<br/>          "PriceClass": "PriceClass_100",<br/>          "DefaultRootObject": "index.html",<br/>          "CustomErrorResponses": [<br/>            {<br/>              "ErrorCachingMinTTL": 0,<br/>              "ErrorCode": 404,<br/>              "ResponseCode": 200,<br/>              "ResponsePagePath": "/index.html"<br/>            }<br/>          ],<br/>          "<strong>DefaultCacheBehavior</strong>": {<br/>            "TargetOriginId": "S3Origin",<br/>            "AllowedMethods": [<br/>              "GET",<br/>              "HEAD"<br/>            ],<br/>            "CachedMethods": [<br/>              "HEAD",<br/>              "GET"<br/>            ],<br/>            "Compress": true,<br/>            "ForwardedValues": {<br/>              "QueryString": false,<br/>              "Cookies": {<br/>                "Forward": "none"<br/>              }<br/>            },<br/>            "MinTTL": 0,<br/>            "DefaultTTL": 0,<br/>            "ViewerProtocolPolicy": "allow-all"<br/>          }<br/>        }<br/>      }<br/>    }<br/>  },<br/>  ...<br/>}</pre>
<ol start="7">
<li>Build the app with <kbd>npm run build</kbd>.</li>
<li>Deploy the stack:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ npm run dp:lcl -- -s $MY_STAGE</strong><br/><br/>&gt; cncb-cdn-spa@1.0.0 dp:lcl &lt;path-to-your-workspace&gt;/cncb-cdn-spa<br/>&gt; sls deploy -v -r us-east-1 "-s" "john"<br/><br/>Serverless: Packaging service...<br/>...<br/>Serverless: Stack update finished...<br/>...<br/>Stack Outputs<br/><strong>WebsiteDistributionURL: https://dqvo8ga8z7ao3.cloudfront.net</strong><br/><strong>WebsiteS3URL: http://cncb-cdn-spa-john-websitebucket-1huxcgjseaili.s3-website-us-east-1.amazonaws.com</strong><br/>WebsiteBucketName: cncb-cdn-spa-john-websitebucket-1huxcgjseaili<br/>WebsiteDistributionId: E3JF634XQF4PE9<br/>...<br/>Serverless: Path: ./build<br/>Serverless: File: asset-manifest.json (application/json)<br/>...</pre>
<p>Deploying a CloudFront distribution can take upwards of 20 minutes or more.</p>
<ol start="9">
<li>Review the stack and CloudFront distribution in the AWS Console.</li>
<li>Browse to <kbd>WebsiteS3URL</kbd> and <kbd>WebsiteDistributionURL</kbd>, shown in the stack output, and note the performance difference between the two in the network tab of your browser's inspect tool, with the cache enabled and disabled:</li>
</ol>
<pre style="padding-left: 30px">http://&lt;see WebsiteS3URL output&gt;.s3-website-us-east-1.amazonaws.com<br/>http://&lt;see WebsiteDistributionURL output&gt;.cloudfront.net</pre>
<ol start="11">
<li>Remove the stack once you are finished with <kbd>npm run rm:lcl -- -s $MY_STAGE</kbd>.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>The configuration of a CloudFront distribution is verbose and boilerplate. The <kbd>serverless-spa-config</kbd> plugin simplifies the effort, encapsulates the best practices, and allows for configuration by exception. In this recipe, we use all the defaults. In the generated <kbd>.serverless/cloudformation-template-update-stack.json</kbd> template, we can see that the <kbd>WebsiteBucket</kbd> is defined and configured as the default <kbd>S3Origin</kbd>, with the <kbd>index.html</kbd> file as the <kbd>DefaultRootObject</kbd>. The <kbd>PriceClass</kbd> defaults to North America and Europe, to minimize the amount of time it takes to provision the distribution. The error handling of the bucket (<kbd>ErrorDocument</kbd>) and the distribution (<kbd>CustomErrorResponses</kbd>) is configured to delegate error handling to the logic of the SPA.</p>
<p>The main purpose of the distribution is to cache the SPA resources at the edge. This logic is handled by two pieces. First, the <kbd>DefaultCacheBehavior</kbd> is set up with a <kbd>DefaultTTL</kbd> of zero, to ensure that the cache-control headers of the individual resources in the bucket are used to control the TTL. Second, the <kbd>serverless-spa-deploy</kbd> plugin is configured with two different <kbd>CacheControl</kbd> settings. Everything other than the <kbd>index.html</kbd> file is deployed with a max-age of one year because Webpack names these resources with a hash value that is generated for each build to implicitly bust the cache. The <kbd>index.html</kbd> file must have a constant name, because it is the <kbd>DefaultRootObject</kbd>, so we set its max-age to 5 minutes. This means that within approximately five minutes of a deployment, we can expect end users to start receiving the latest code changes. After five minutes, the browser will ask the CDN for the <kbd>index.html</kbd> file and the CDN will return an error 304 if the ETag is unchanged. This strikes a balance between minimizing data transfer and allowing changes to propagate quickly. You can increase or decrease the max-age as you see fit.</p>
<p>At this point, we are using the CDN to improve download performance for the user by pushing the resources to the edge to reduce latency, and compressing the resources to reduce bandwidth. This alone is reason enough to leverage the edge of the cloud. Additional features include custom domain names, SSL certificates, logging, and integration with a <strong>web application firewall</strong> (<strong>WAF</strong>). We will cover these topics in further recipes.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Associating a custom domain name with a CDN</h1>
                
            
            
                
<p>In the <em>Serving a single-page application from a CDN</em> recipe, we covered the steps required to add a CloudFront CDN layer in front of S3 and avail ourselves of more valuable features. One of these features is the ability to associate a custom domain name with the resources served from the CDN, such as a single-page application or a cloud-native service. In this recipe, we will take the deployment process another step further and demonstrate how to add a Route53 record set and a CloudFront alias.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>You will need a registered domain name and a Route53 hosted zone, which you can use in this recipe to create a subdomain for the SPA that will be deployed.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Create the project from the following template:</li>
</ol>
<pre style="padding-left: 30px">$ sls create --template-url https://github.com/danteinc/js-cloud-native-cookbook/tree/master/ch4/cdn-dns --path cncb-cdn-dns</pre>
<ol start="2">
<li>Navigate to the <kbd>cncb-cdn-dns</kbd> directory with <kbd>cd cncb-cdn-dns</kbd>.</li>
<li>Review the file named <kbd>serverless.yml</kbd> with the following content:</li>
</ol>
<pre style="padding-left: 30px">service: cncb-cdn-dns<br/><br/>provider:<br/>  name: aws<br/><br/>plugins:<br/>  - serverless-spa-deploy<br/>  - <strong>serverless-spa-config</strong><br/><br/>custom:<br/>  spa:<br/>    files:<br/>      ...   <br/>  dns:<br/>    <strong>hostedZoneId</strong>:  Z1234567890123<br/>    <strong>domainName</strong>: example.com<br/>    <strong>endpoint</strong>: app.${self:custom.dns.domainName}</pre>
<ol start="4">
<li>Update the <kbd>serverless.yml</kbd> file with your <kbd>hostedZoneId</kbd> and <kbd>domainName</kbd>.</li>
<li>Install the dependencies with <kbd>npm install</kbd>.</li>
<li>Run the tests with <kbd>npm test</kbd>.</li>
<li>Review the contents generated in the <kbd>.serverless</kbd> directory:</li>
</ol>
<pre style="padding-left: 30px">{<br/>  "Resources": {<br/>    ...<br/>    "WebsiteDistribution": {<br/>      "Type": "AWS::CloudFront::Distribution",<br/>      "Properties": {<br/>        "DistributionConfig": {<br/>          ...<br/>          "<strong>Aliases</strong>": [<br/>            "app.example.com"<br/>          ],<br/>          ...<br/>          }<br/>        }<br/>      }<br/>    },<br/>    "<strong>WebsiteEndpointRecord</strong>": {<br/>      "Type": "AWS::Route53::RecordSet",<br/>      "Properties": {<br/>        "<strong>HostedZoneId</strong>": "Z1234567890123",<br/>        "<strong>Name</strong>": "app.example.com.",<br/>        "Type": "A",<br/>        "AliasTarget": {<br/>          "HostedZoneId": "Z2FDTNDATAQYW2",<br/>          "DNSName": {<br/>            "Fn::GetAtt": [<br/>              "WebsiteDistribution",<br/>              "DomainName"<br/>            ]<br/>          }<br/>        }<br/>      }<br/>    }<br/>  },<br/>  ...<br/>}</pre>
<ol start="8">
<li>Build the app with <kbd>npm run build</kbd>.</li>
<li>Deploy the stack:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ npm run dp:lcl -- -s $MY_STAGE</strong><br/><br/>&gt; cncb-cdn-dns@1.0.0 dp:lcl &lt;path-to-your-workspace&gt;/cncb-cdn-dns<br/>&gt; sls deploy -v -r us-east-1 "-s" "john"<br/><br/>Serverless: Packaging service...<br/>...<br/>Serverless: Stack update finished...<br/>...<br/>Stack Outputs<br/>WebsiteDistributionURL: https://dwrdvnqsnetay.cloudfront.net<br/>WebsiteS3URL: http://cncb-cdn-dns-john-websitebucket-1dwzb5bfkv34s.s3-website-us-east-1.amazonaws.com<br/>WebsiteBucketName: cncb-cdn-dns-john-websitebucket-1dwzb5bfkv34s<br/><strong>WebsiteURL: http://app.example.com</strong><br/>WebsiteDistributionId: ED6YKAFJDF2ND<br/>...</pre>
<p>Deploying a CloudFront distribution can take upwards of 20 minutes or more.</p>
<ol start="10">
<li>Review the stack, Route53, and CloudFront distribution in the AWS Console.</li>
<li>Browse to <kbd>WebsiteURL</kbd>, shown in the stack output:</li>
</ol>
<pre style="padding-left: 30px">http://app.example.com &lt;see WebsiteURL output&gt;</pre>
<ol start="12">
<li>Remove the stack once you are finished with <kbd>npm run rm:lcl -- -s $MY_STAGE</kbd>.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>In this recipe, we improve on the <em>Serving a single-page application from a CDN</em> recipe by adding a custom domain name for the SPA. In <kbd>serverless.yml</kbd>, we added the <kbd>hostedZoneId</kbd>, <kbd>domainName</kbd>, and <kbd>endpoint</kbd> values. These values trigger the <kbd>serverless-spa-config</kbd> plugin to configure the <kbd>WebsiteEndpointRecord</kbd> in Route53, and set the <kbd>Aliases</kbd> on the CloudFront distribution.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Serving a website from the CDN</h1>
                
            
            
                
<p>As an industry, we have a tendency to create very dynamic websites, even when the content does not change frequently. Some <strong>Content Management Systems</strong> (<strong>CMS</strong>) recalculate content for every request, even when the content has not changed. These requests pass through multiple layers, read from the database, and then calculate and return the response. It is not uncommon to see average response times in the range of five seconds. It is said that doing the same thing over and over again and expecting a different result is the definition of insanity.</p>
<p>Cloud-native systems take an entirely different approach to creating websites. JAMstack (<a href="https://jamstack.org">https://jamstack.org</a>) is a modern, cloud-native approach based on client-side JavaScript, reusable APIs, and Markup. These static sites are managed by Git workflows, generated by CI/CD pipelines, and deployed to the edge of the cloud many times a day. This is yet another example of cloud-native challenging us to rewire our software engineering brains. This recipe demonstrates the generation and deployment of these static websites.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Create the project from the following template:</li>
</ol>
<pre style="padding-left: 30px">$ sls create --template-url https://github.com/danteinc/js-cloud-native-cookbook/tree/master/ch4/cdn-site --path cncb-cdn-site</pre>
<ol start="2">
<li>Navigate to the <kbd>cncb-cdn-site</kbd> directory with <kbd>cd cncb-cdn-site</kbd>.</li>
<li>Review the file named <kbd>serverless.yml</kbd> with the following content:</li>
</ol>
<pre style="padding-left: 30px">service: cncb-cdn-site<br/><br/>provider:<br/>  name: aws<br/><br/>plugins:<br/>  - serverless-spa-deploy<br/>  - serverless-spa-config<br/><br/>custom:<br/>  spa:<br/>    files:<br/>      - source: ./dist<br/>        globs: '**/*'<br/>        headers:<br/>          CacheControl: max-age=31536000 # 1 year<br/>    <strong>redirect</strong>: true<br/>  dns:<br/>    <strong>hostedZoneId</strong>:  Z1234567890123<br/>    <strong>domainName</strong>: example.com<br/>    <strong>endpoint</strong>: www.${self:custom.dns.domainName}</pre>
<ol start="4">
<li>Update the <kbd>serverless.yml</kbd> file with your <kbd>hostedZoneId</kbd> and <kbd>domainName</kbd>.</li>
<li>Install the dependencies with <kbd>npm install</kbd>.</li>
<li>Run the tests with <kbd>npm test</kbd>.</li>
<li>Review the contents generated in the <kbd>.serverless</kbd> directory:</li>
</ol>
<pre style="padding-left: 30px">{<br/>  "Resources": {<br/>    ...<br/>    "RedirectBucket": {<br/>      "Type": "AWS::S3::Bucket",<br/>      "Properties": {<br/>        "BucketName": "example.com",<br/>        "WebsiteConfiguration": {<br/>          "RedirectAllRequestsTo": {<br/>            <strong>"HostName": "www.example.com"</strong><br/>          }<br/>        }<br/>      }<br/>    },<br/>    "WebsiteDistribution": {<br/>      "Type": "AWS::CloudFront::Distribution",<br/>      "Properties": {<br/>        "DistributionConfig": {<br/> "Comment": "Website: test-cncb-cdn-site (us-east-1)",<br/>        ...<br/>          "Aliases": [<br/>            <strong>"www.example.com"</strong><br/>          ],<br/>        ...<br/>        }<br/>      }<br/>    },<br/>    "RedirectDistribution": {<br/>      "Type": "AWS::CloudFront::Distribution",<br/>      "Properties": {<br/>        "DistributionConfig": {<br/>          "Comment": "<strong>Redirect</strong>: test-cncb-cdn-site (us-east-1)",<br/>        ...<br/>          "Aliases": [<br/>            <strong>"example.com"</strong><br/>          ],<br/>        ...<br/>        }<br/>      }<br/>    },<br/>    "WebsiteEndpointRecord": {<br/>      "Type": "AWS::Route53::RecordSet",<br/>      "Properties": {<br/>        "HostedZoneId": "Z1234567890123",<br/>        <strong>"Name": "www.example.com.",</strong><br/>        "Type": "A",<br/>        "AliasTarget": {<br/>          "HostedZoneId": "Z2FDTNDATAQYW2",<br/>          "DNSName": {<br/>            "Fn::GetAtt": [<br/>              "WebsiteDistribution",<br/>              "DomainName"<br/>            ]<br/>          }<br/>        }<br/>      }<br/>    },<br/>    "<strong>RedirectEndpointRecord</strong>": {<br/>      "Type": "AWS::Route53::RecordSet",<br/>      "Properties": {<br/>        "HostedZoneId": "Z1234567890123",<br/>        <strong>"Name": "example.com.",</strong><br/>        "Type": "A",<br/>        "AliasTarget": {<br/>          "HostedZoneId": "Z2FDTNDATAQYW2",<br/>          "DNSName": {<br/>            "Fn::GetAtt": [<br/>              "RedirectDistribution",<br/>              "DomainName"<br/>            ]<br/>          }<br/>        }<br/>      }<br/>    }<br/>  },<br/>  ...<br/>}</pre>
<ol start="8">
<li>Deploy the stack:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ npm run dp:lcl -- -s $MY_STAGE</strong><br/><br/>&gt; cncb-cdn-site@1.0.0 dp:lcl &lt;path-to-your-workspace&gt;/cncb-cdn-site<br/>&gt; sls deploy -v -r us-east-1 "-s" "john"<br/><br/>Serverless: Packaging service...<br/>...<br/>Serverless: Stack update finished...<br/>...<br/>Stack Outputs<br/>WebsiteDistributionURL: https://d2ooxtd49ayyfd.cloudfront.net<br/>WebsiteS3URL: http://cncb-cdn-site-john-websitebucket-mrn9ntyltxim.s3-website-us-east-1.amazonaws.com<br/>WebsiteBucketName: cncb-cdn-site-john-websitebucket-mrn9ntyltxim<br/><strong>WebsiteURL: http://www.example.com</strong><br/>WebsiteDistributionId: E10ZLN9USZTDSO<br/>...<br/>Serverless: Path: ./dist<br/>Serverless: File: after/c2Vjb25kLXBvc3Q=/index.html (text/html)<br/>Serverless: File: after/dGhpcmQtcG9zdA==/index.html (text/html)<br/>Serverless: File: after/Zm91cnRoLXBvc3Q=/index.html (text/html)<br/>Serverless: File: after/ZmlmdGgtcG9zdA==/index.html (text/html)<br/>Serverless: File: after/Zmlyc3QtcG9zdA==/index.html (text/html)<br/>Serverless: File: blog/fifth-post/index.html (text/html)<br/>Serverless: File: blog/first-post/index.html (text/html)<br/>Serverless: File: blog/fourth-post/index.html (text/html)<br/>Serverless: File: blog/second-post/index.html (text/html)<br/>Serverless: File: blog/third-post/index.html (text/html)<br/>Serverless: File: favicon.ico (image/x-icon)<br/>Serverless: File: index.html (text/html)<br/>Serverless: File: phenomic/content/posts/by-default/1/desc/date/limit-2.json (application/json)<br/>Serverless: File: phenomic/content/posts/by-default/1/desc/date/limit-2/after-c2Vjb25kLXBvc3Q=.json (application/json)<br/>Serverless: File: phenomic/content/posts/by-default/1/desc/date/limit-2/after-dGhpcmQtcG9zdA==.json (application/json)<br/>Serverless: File: phenomic/content/posts/by-default/1/desc/date/limit-2/after-Zm91cnRoLXBvc3Q=.json (application/json)<br/>Serverless: File: phenomic/content/posts/by-default/1/desc/date/limit-2/after-ZmlmdGgtcG9zdA==.json (application/json)<br/>Serverless: File: phenomic/content/posts/by-default/1/desc/date/limit-2/after-Zmlyc3QtcG9zdA==.json (application/json)<br/>Serverless: File: phenomic/content/posts/item/fifth-post.json (application/json)<br/>Serverless: File: phenomic/content/posts/item/first-post.json (application/json)<br/>Serverless: File: phenomic/content/posts/item/fourth-post.json (application/json)<br/>Serverless: File: phenomic/content/posts/item/second-post.json (application/json)<br/>Serverless: File: phenomic/content/posts/item/third-post.json (application/json)<br/>Serverless: File: phenomic/phenomic.main.9a7f8f5f.js (application/javascript)<br/>Serverless: File: robots.txt (text/plain)</pre>
<p>Deploying a CloudFront distribution can take upwards of 20 minutes or more.</p>
<ol start="9">
<li>Review the stack, Route53, and CloudFront distribution in the AWS Console.</li>
<li>Browse to <kbd>WebsiteURL</kbd>, shown in the stack output, and again without the <kbd>www.</kbd>, and observe the redirect to <kbd>www</kbd>:</li>
</ol>
<pre style="padding-left: 30px">http://www.example.com &lt;see WebsiteURL output&gt;<br/>http://example.com &lt;see WebsiteURL output&gt;  </pre>
<ol start="11">
<li>Browse through the website pages.</li>
<li>Remove the stack once you are finished with <kbd>npm run rm:lcl -- -s $MY_STAGE</kbd>.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>In this recipe, we use a static site generator called <strong>Phenomic</strong> (<a href="https://www.staticgen.com/phenomic">https://www.staticgen.com/phenomic</a>). There is a seemingly endless array of tools enumerated on the <strong>StaticGen</strong> site (<a href="https://www.staticgen.com">https://www.staticgen.com</a>). With Phenomic, we write the website in a combination of ReactJS and Markdown. Then, we isomorphically generate the JavaScript and Markdown into a set of static resources that we deploy to S3, as can be seen in the deployment output. I have pre-built the website and included the generated resources in the repository. A typical SPA downloads the JavaScript and generates the site in the browser. Depending on the website, this process can be lengthy and noticeable. Runtime-based isomorphic generation performs this process on the server-side before returning the website to the browser. A JAMstack website, on the other hand, is statically generated at deployment time, which results in the best runtime performance. Although the website is static, the pages contain dynamic JavaScript that is written just like in any ReactJS SPA. These websites are frequently updated and re-deployed multiple times per day, which adds another dynamic dimension without having to ask the server on every request if something has changed.</p>
<p>These sites are typically deployed to a <kbd>www</kbd> subdomain, and support redirecting the root domain to this subdomain. Building on the <em>Serving a single-page application from a CDN</em> and <em>Associating a custom domain name with CDN</em> recipes, this recipe leverages the <kbd>serverless-spa-deploy</kbd> and <kbd>serverless-spa-config</kbd> plugins and adds some additional settings. We specify the <kbd>endpoint</kbd> as <kbd>www.${self:custom.dns.domainName}</kbd> and set the redirect flag to <kbd>true</kbd>. This, in turn, creates the <kbd>RedirectBucket</kbd>, which performs the redirects, along with an additional <kbd>RedirectDistribution</kbd> and <kbd>RedirectEndpointRecord</kbd> to support the root domain.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Deploying a service behind a CDN</h1>
                
            
            
                
<p>When we think of a CDN, it is typical to think that they are only useful for serving up static content. However, it is an AWS best practice to place CloudFront in front of all resources, even dynamic services, to improve security and performance. From a security perspective, CloudFront minimizes the attack surfaces and handles DDOS attacks at the edge to reduce the load on internal components. With regard to performance, CloudFront optimizes the pipe between the edge and availability zones, which improves performance even for <kbd>POST</kbd> and <kbd>PUT</kbd> operations. Furthermore, even a cache-control header of just a few seconds can have a significant impact on <kbd>GET</kbd> operations. In this recipe, we will demonstrate how to add CloudFront in front of the AWS API Gateway.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Create the project from the following template:</li>
</ol>
<pre style="padding-left: 30px">$ sls create --template-url https://github.com/danteinc/js-cloud-native-cookbook/tree/master/ch4/cdn-service --path cncb-cdn-service</pre>
<ol start="2">
<li>Navigate to the <kbd>cncb-cdn-service</kbd> directory with <kbd>cd cncb-cdn-service</kbd>.</li>
<li>Review the file named <kbd>serverless.yml</kbd> with the following content:</li>
</ol>
<pre style="padding-left: 30px">service: cncb-cdn-service<br/><br/>provider:<br/>  name: aws<br/>  runtime: nodejs8.10<br/>  endpointType: <strong>REGIONAL</strong><br/><br/>functions:<br/>  hello:<br/>    handler: handler.hello<br/>    events:<br/>      - http:<br/>          path: hello<br/>          method: get<br/>          cors: true<br/><br/>resources:<br/>  Resources:<br/>    ApiDistribution:<br/>      Type: AWS::CloudFront::Distribution<br/>      Properties:<br/>        DistributionConfig:<br/>          ...<br/>          <strong>Origins</strong>:<br/>            - Id: ApiGateway<br/>              <strong>DomainName</strong>:<br/>                Fn::Join:<br/>                  - "."<br/>                  - - Ref: <strong>ApiGatewayRestApi</strong><br/>                    - execute-api.${opt:region}.amazonaws.com<br/>              <strong>OriginPath</strong>: /${opt:stage}<br/>              CustomOriginConfig:<br/>                OriginProtocolPolicy: https-only<br/>                OriginSSLProtocols: [ TLSv1.2 ]<br/>          ...<br/>          <strong>DefaultCacheBehavior</strong>:<br/>            TargetOriginId: <strong>ApiGateway</strong><br/>            <strong>AllowedMethods</strong>: [ DELETE, GET, HEAD, OPTIONS, PATCH, POST, PUT ]<br/>            <strong>CachedMethods</strong>: [ GET, HEAD, OPTIONS ]<br/>            <strong>Compress</strong>: true<br/>            ForwardedValues:<br/>              QueryString: true<br/>              <strong>Headers</strong>: [ Accept, Authorization ]<br/>              Cookies:<br/>                Forward: all<br/>            MinTTL: 0<br/>            <strong>DefaultTTL</strong>: 0<br/>            ViewerProtocolPolicy: https-only<br/><br/>  Outputs:<br/>    ApiDistributionId:<br/>      Value:<br/>        Ref: ApiDistribution  <br/>    <strong>ApiDistributionEndpoint</strong>:<br/>      Value:<br/>        Fn::Join:<br/>          - ''<br/>          - - https://<br/>            - Fn::GetAtt: [ ApiDistribution, DomainName ]</pre>
<ol start="4">
<li>Review the file named <kbd>handler.js</kbd> with the following content:</li>
</ol>
<pre style="padding-left: 30px">module.exports.hello = (request, context, callback) =&gt; {<br/>  const response = {<br/>    statusCode: 200,<br/>    headers: {<br/>      <strong>'Cache-Control': 'max-age=5'</strong>,<br/>    },<br/>    body: ...,<br/>  };<br/><br/>  callback(null, response);<br/>};</pre>
<ol start="5">
<li>Install the dependencies with <kbd>npm install</kbd>.</li>
<li>Run the tests with <kbd>npm test</kbd>.</li>
<li>Review the contents generated in the <kbd>.serverless</kbd> directory.</li>
<li>Deploy the stack:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ npm run dp:lcl -- -s $MY_STAGE</strong><br/><br/>&gt; cncb-cdn-service@1.0.0 dp:lcl &lt;path-to-your-workspace&gt;/cncb-cdn-service<br/>&gt; sls deploy -v -r us-east-1 "-s" "john"<br/><br/>Serverless: Packaging service...<br/>...<br/>Serverless: Stack update finished...<br/>...<br/>endpoints:<br/>  GET - https://5clnzj3knc.execute-api.us-east-1.amazonaws.com/john/hello<br/>functions:<br/>  hello: cncb-cdn-service-john-hello<br/><br/>Stack Outputs<br/><strong>ApiDistributionEndpoint: https://d1vrpoljefctug.cloudfront.net</strong><br/>ServiceEndpoint: https://5clnzj3knc.execute-api.us-east-1.amazonaws.com/john<br/>...<br/>ApiDistributionId: E2X1H9ZQ1B9U0R</pre>
<p>Deploying a CloudFront distribution can take upwards of 20 minutes or more.</p>
<ol start="9">
<li>Review the stack and CloudFront distribution in the AWS Console.</li>
<li>Invoke the endpoint shown in the stack output, with the following <kbd>curl</kbd> command, multiple times to see the difference in performance for the cached results:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ curl -s -D - -w "Time: %{time_total}" -o /dev/null  https://&lt;see stack output&gt;.cloudfront.net/hello | egrep -i 'X-Cache|Time'<br/></strong><br/>X-Cache: Miss from cloudfront<br/>Time: 0.324<br/>$ curl ...<br/>X-Cache: Hit from cloudfront<br/>Time: 0.168<br/>$ curl ...<br/>X-Cache: Hit from cloudfront<br/>Time: 0.170<br/>$ curl ...<br/>X-Cache: Miss from cloudfront<br/>Time: 0.319<br/>$ curl ...<br/>X-Cache: Hit from cloudfront<br/>Time: 0.167<strong><br/></strong></pre>
<ol start="11">
<li>Remove the stack once you are finished with <kbd>npm run rm:lcl -- -s $MY_STAGE</kbd>.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>The first thing to note in the <kbd>serverless.yml</kbd> file is that the <kbd>endpointType</kbd> is set to <kbd>REGIONAL</kbd>. By default, AWS API Gateway will provision a CloudFront distribution. However, we do not have access to this distribution and cannot take advantage of all its features. Plus, the default does not support multi-regional deployments. Therefore, we specify <kbd>REGIONAL</kbd> so that we can manage the CDN ourselves. Next, we need to configure the <kbd>Origins</kbd>. We specify the <kbd>DomainName</kbd> to point to the regional API Gateway endpoint, and we specify the stage as the <kbd>OriginPath</kbd>, so that we no longer need to include it in the URL.</p>
<p>Next, we configure the <kbd>DefaultCacheBehavior</kbd>. We allow both read and write methods, and we cache the read methods. We set <kbd>DefaultTTL</kbd> to zero to ensure that the <kbd>Cache-Control</kbd> headers set in the service code are used to control the TTL. In this recipe, the code sets the <kbd>max-age</kbd> to 5 seconds, and we can see that our cache hits respond approximately twice as fast. We also set <kbd>Compress</kbd> to <kbd>true</kbd> to minimize data transfer for both increased performance and to help reduced cost. It is important to forward all the <kbd>Headers</kbd> that are expected by the backend. For example, the authorization header is crucial for securing a service with OAuth 2.0, as we will discuss in the <em>Securing an API gateway with OAuth 2.0</em> recipe in <a href="75b256e5-1fe4-4c9e-ab56-28cef7a8a0ab.xhtml">Chapter 5</a>, <em>Securing Cloud-Native Systems</em>.</p>
<p>Note that <kbd>ApiGatewayRestApi</kbd> is the logical resource ID that is created and controlled by the Serverless Framework.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Serving static JSON from a CDN</h1>
                
            
            
                
<p>In the <em>Implementing a search BFF</em> recipe, we created a service that serves some content from a materialized view in Elasticsearch via an API Gateway, and other content directly from a materialized view in S3. This is a great approach that can cost-effectively deliver under extremely heavy loads. In this recipe, we will demonstrate how to add a single CloudFront distribution in front of both the API Gateway and S3 to encapsulate these internal design decisions behind a single domain name.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Create the project from the following template:</li>
</ol>
<pre style="padding-left: 30px">$ sls create --template-url https://github.com/danteinc/js-cloud-native-cookbook/tree/master/ch4/cdn-json --path cncb-cdn-json</pre>
<ol start="2">
<li>Navigate to the <kbd>cncb-cdn-json</kbd> directory with <kbd>cd cncb-cdn-json</kbd>.</li>
<li>Review the file named <kbd>serverless.yml</kbd> with the following content:</li>
</ol>
<pre style="padding-left: 30px">service: cncb-cdn-json<br/><br/>provider:<br/>  name: aws<br/>  runtime: nodejs8.10<br/>  endpointType: <strong>REGIONAL</strong><br/>  ...<br/><br/>functions:<br/>  search:<br/>    handler: handler.search<br/>    ...<br/><br/>resources:<br/>  Resources:<br/>    ApiDistribution:<br/>      Type: AWS::CloudFront::Distribution<br/>      Properties:<br/>        DistributionConfig:<br/>          ...<br/>          Origins:<br/>            - Id: <strong>S3Origin</strong><br/>              DomainName:<br/>                Fn::Join:<br/>                  - "."<br/>                  - - Ref: <strong>Bucket</strong><br/>                    - s3.amazonaws.com<br/>              ...<br/>            - Id: <strong>ApiGateway</strong><br/>              DomainName:<br/>                Fn::Join:<br/>                  - "."<br/>                  - - Ref: <strong>ApiGatewayRestApi</strong><br/>                    - execute-api.${opt:region}.amazonaws.com<br/>              OriginPath: /${opt:stage}<br/>              ...<br/>          ...<br/>          DefaultCacheBehavior:<br/>            TargetOriginId: <strong>S3Origin</strong><br/>            AllowedMethods:<br/>              - GET<br/>              - HEAD<br/>            CachedMethods:<br/>              - HEAD<br/>              - GET<br/>            ...<br/>            MinTTL: 0<br/>            DefaultTTL: 0<br/>            ...<br/>          CacheBehaviors:<br/>            - TargetOriginId: <strong>ApiGateway</strong><br/>              <strong>PathPattern: /search</strong><br/>              AllowedMethods: [ GET, HEAD, OPTIONS ]<br/>              CachedMethods: [ GET, HEAD, OPTIONS ]<br/>              ...<br/>              MinTTL: 0<br/>              DefaultTTL: 0<br/>              ...<br/><br/>    Bucket:<br/>      Type: AWS::S3::Bucket<br/>...</pre>
<ol start="4">
<li>Install the dependencies with <kbd>npm install</kbd>.</li>
<li>Run the tests with <kbd>npm test</kbd>.</li>
<li>Review the contents generated in the <kbd>.serverless</kbd> directory.</li>
<li>Deploy the stack:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ npm run dp:lcl -- -s $MY_STAGE</strong><br/><br/>&gt; cncb-cdn-json@1.0.0 dp:lcl &lt;path-to-your-workspace&gt;/cncb-cdn-json<br/>&gt; sls deploy -v -r us-east-1 "-s" "john"<br/><br/>Serverless: Packaging service...<br/>...<br/>Serverless: Stack update finished...<br/>...<br/>endpoints:<br/>  GET - https://hvk3o94wij.execute-api.us-east-1.amazonaws.com/john/search<br/>functions:<br/>  search: cncb-cdn-json-john-search<br/>  load: cncb-cdn-json-john-load<br/><br/>Stack Outputs<br/>...<br/><strong>ApiDistributionEndpoint: https://dfktdq2w7ht2p.cloudfront.net</strong><br/>BucketName: cncb-cdn-json-john-bucket-ls21fzjp2qs2<br/>ServiceEndpoint: https://hvk3o94wij.execute-api.us-east-1.amazonaws.com/john<br/>ApiDistributionId: E3JJREB1B4TIGL</pre>
<p>Deploying a CloudFront distribution can take upwards of 20 minutes or more.</p>
<ol start="8">
<li>Review the stack and CloudFront distribution in the AWS Console.</li>
</ol>
<ol start="9">
<li>Invoke the following command to load data:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ sls invoke -f load -r us-east-1 -s $MY_STAGE -d '{"id":"44444444-5555-1111-1111-000000000000","name":"thing one"}'</strong><br/><br/>{<br/>    "ETag": "\"3f4ca01316d6f88052a940ab198b2dc7\""<br/>}<br/><br/><strong>$ sls invoke -f load -r us-east-1 -s $MY_STAGE -d '{"id":"44444444-5555-1111-2222-000000000000","name":"thing two"}'</strong><br/><br/>{<br/>    "ETag": "\"926f41091e2f47208f90f9b9848dffd0\""<br/>}<br/><br/><strong>$ sls invoke -f load -r us-east-1 -s $MY_STAGE -d '{"id":"44444444-5555-1111-3333-000000000000","name":"thing three"}'</strong><br/><br/>{<br/>    "ETag": "\"2763ac570ff0969bd42182506ba24dfa\""<br/>}</pre>
<ol start="10">
<li>Invoke the endpoint shown in the stack output with the following <kbd>curl</kbd> commands:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ curl </strong><strong>https://&lt;see stack output&gt;.cloudfront.net/</strong><strong>search | json_pp<br/></strong><br/>[<br/>   "https://dfktdq2w7ht2p.cloudfront.net/things/44444444-5555-1111-1111-000000000000",<br/>   "https://dfktdq2w7ht2p.cloudfront.net/things/44444444-5555-1111-2222-000000000000",<br/>   "https://dfktdq2w7ht2p.cloudfront.net/things/44444444-5555-1111-3333-000000000000"<br/>]<strong><br/><br/>$ curl -s -D - -w "Time: %{time_total}" -o /dev/null https://&lt;see stack output&gt;.cloudfront.net/things/44444444-5555-1111-1111-000000000000 | egrep -i 'X-Cache|Time'<br/></strong><br/>X-Cache: Miss from cloudfront<br/>Time: 0.576<br/>$ curl ...<br/>X-Cache: Hit from cloudfront<br/>Time: 0.248<strong><br/></strong></pre>
<ol start="11">
<li>Remove the stack with <kbd>npm run rm:lcl -- -s $MY_STAGE</kbd>.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>This recipe builds on the <em>Deploying a service behind a CDN</em> recipe. The main difference in this recipe is that we have multiple <kbd>Origins</kbd> and multiple <kbd>CacheBehaviors</kbd>, one each for our <kbd>Bucket</kbd> and our <kbd>ApiGatewayRestApi</kbd>. We use the <kbd>DefaultCacheBehavior</kbd> for our <kbd>S3Origin</kbd>, because we could store many different business domains in the bucket with different paths. Conversely, there is a single <kbd>PathPattern</kbd> (<kbd>/search</kbd>) that needs to be directed to our <kbd>APIGateway</kbd> origin, therefore we define this under <kbd>CacheBehaviors</kbd>. Again, in all cases, we set the <kbd>DefaultTTL</kbd> to zero to ensure our cache-control headers control the TTL. The end result is that our multiple origins now look like one from the outside.</p>
<p>Note that <kbd>ApiGatewayRestApi</kbd> is the logical resource ID that is created and controlled by the Serverless Framework.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Triggering the invalidation of content in a CDN</h1>
                
            
            
                
<p>In the <em>Implementing a search BFF</em> recipe, we statically serve dynamic JSON content from S3, and in the <em>Serving static JSON from a CDN</em> recipe, we add a cache-control header with a long max-age to further improve the performance. This technique works great for content that is dynamic, yet changes at a slow and unpredictable rate. In this recipe, we will demonstrate how to improve on this design by responding to data change events and invalidating the cache so that the latest data is retrieved.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Create the project from the following template:</li>
</ol>
<pre style="padding-left: 30px">$ sls create --template-url https://github.com/danteinc/js-cloud-native-cookbook/tree/master/ch4/cdn-invalidate --path cncb-cdn-invalidate</pre>
<ol start="2">
<li>Navigate to the <kbd>cncb-cdn-invalidate</kbd> directory with <kbd>cd cncb-cdn-invalidate</kbd>.</li>
</ol>
<ol start="3">
<li>Review the file named <kbd>serverless.yml</kbd> with the following content:</li>
</ol>
<pre style="padding-left: 30px">service: cncb-cdn-invalidate<br/><br/>provider:<br/>  name: aws<br/>  runtime: nodejs8.10<br/>  ...<br/><br/>functions:<br/>  load:<br/>    ...<br/>  <strong>trigger</strong>:<br/>    handler: handler.<strong>trigger</strong><br/>    events:<br/>      - sns:<br/>          arn: <br/>            Ref: BucketTopic<br/>          topicName: ${self:service}-${opt:stage}-trigger<br/>    environment:<br/>      <strong>DISABLED</strong>: false<br/>      <strong>DISTRIBUTION_ID</strong>:<br/>        Ref: ApiDistribution<br/><br/>resources:<br/>  Resources:<br/>    Bucket:<br/>      Type: AWS::S3::Bucket<br/>      DependsOn: [ BucketTopic, BucketTopicPolicy ]<br/>      Properties:<br/>        <strong>NotificationConfiguration</strong>:<br/>          TopicConfigurations:<br/>            - Event: s3:ObjectCreated:Put<br/>              Topic:<br/>                Ref: BucketTopic<br/>    <strong>BucketTopic</strong>: <br/>      Type: AWS::SNS::Topic<br/>      Properties: <br/>        TopicName: ${self:service}-${opt:stage}-trigger<br/>    BucketTopicPolicy: ${file(includes.yml):BucketTopicPolicy}<br/>    <br/>    ApiDistribution:<br/>      Type: AWS::CloudFront::Distribution<br/>      Properties:<br/>        DistributionConfig:<br/>          ...</pre>
<ol start="4">
<li>Review the file named <kbd>handler.js</kbd> with the following content:</li>
</ol>
<pre style="padding-left: 30px">module.exports.<strong>trigger</strong> = (event, context, cb) =&gt; {<br/>  _(process.env.<strong>DISABLED</strong> === 'true' ? [] : event.Records)<br/>    .flatMap(messagesToTriggers)<br/>    .flatMap(<strong>invalidate</strong>)<br/>    .collect()<br/>    .toCallback(cb);<br/>};<br/><br/>const messagesToTriggers = r =&gt; _(JSON.parse(r.Sns.Message).Records);<br/><br/>const <strong>invalidate</strong> = (trigger) =&gt; {<br/>  const params = {<br/>    DistributionId: process.env.<strong>DISTRIBUTION_ID</strong>,<br/>    InvalidationBatch: {<br/>      CallerReference: uuid.v1(),<br/>      Paths: {<br/>        Quantity: 1,<br/>        Items: [`/${<strong>trigger.s3.object.key</strong>}`]<br/>      }<br/>    }<br/>  };<br/><br/>  const cf = new aws.CloudFront();<br/>  return _(cf.<strong>createInvalidation</strong>(params).promise());<br/>};</pre>
<ol start="5">
<li>Install the dependencies with <kbd>npm install</kbd>.</li>
<li>Run the tests with <kbd>npm test</kbd>.</li>
<li>Review the contents generated in the <kbd>.serverless</kbd> directory.</li>
<li>Deploy the stack:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ npm run dp:lcl -- -s $MY_STAGE</strong><br/><br/>&gt; cncb-cdn-invalidate@1.0.0 dp:lcl &lt;path-to-your-workspace&gt;/cncb-cdn-invalidate<br/>&gt; sls deploy -v -r us-east-1 "-s" "john"<br/><br/>Serverless: Packaging service...<br/>...<br/>Serverless: Stack update finished...<br/>...<br/>functions:<br/>  load: cncb-cdn-invalidate-john-load<br/>  trigger: cncb-cdn-invalidate-john-trigger<br/><br/>Stack Outputs<br/>BucketArn: arn:aws:s3:::cncb-cdn-invalidate-john-bucket-z3u7jc60piub<br/>BucketName: cncb-cdn-invalidate-john-bucket-z3u7jc60piub<br/><strong>ApiDistributionEndpoint: https://dgmob5bgqpnpi.cloudfront.net</strong><br/>TopicArn: arn:aws:sns:us-east-1:123456789012:cncb-cdn-invalidate-john-trigger<br/>...<br/>ApiDistributionId: EV1QUKWEQV6XN</pre>
<p>Deploying a CloudFront distribution can take upwards of 20 minutes or more.</p>
<ol start="9">
<li>Review the stack in the AWS Console.</li>
<li>Invoke the following command to load data:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ sls invoke -f load -r us-east-1 -s $MY_STAGE -d '{"id":"44444444-6666-1111-1111-000000000000","name":"thing one"}'</strong><br/><br/>{<br/>    "ETag": "\"3f4ca01316d6f88052a940ab198b2dc7\""<br/>}</pre>
<ol start="11">
<li>Invoke the endpoint shown in the stack output with the following <kbd>curl</kbd> commands:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ curl </strong><strong>https://&lt;see stack output&gt;.cloudfront.net/things/44444444-6666-1111-1111-000000000000</strong><strong> | json_pp<br/></strong><br/>{<br/>   "name" : "thing one",<br/>   "id" : "44444444-6666-1111-1111-000000000000"<br/>}<strong><br/></strong></pre>
<ol start="12">
<li>Invoke the following command to load data:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ sls invoke -f load -r us-east-1 -s $MY_STAGE -d '{"id":"44444444-6666-1111-1111-000000000000","name":"thing one again"}'</strong><br/><br/>{<br/>    "ETag": "\"edf9676ddcc150f722f0f74b7a41bd7f\""<br/>}</pre>
<ol start="13">
<li>Take a look at the logs for the <kbd>trigger</kbd> function:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ sls logs -f trigger -r us-east-1 -s $MY_STAGE</strong><br/><br/>2018-05-20 02:43:16 ... params: {"DistributionId":"EV1QUKWEQV6XN","<strong>InvalidationBatch</strong>":{"CallerReference":"13a8e420-5bf9-11e8-818d-9de0acd70c96","Paths":{"Quantity":1,"Items":["<strong>/things/44444444-6666-1111-1111-000000000000</strong>"]}}}<br/>2018-05-20 02:43:17 ... {"Location":"https://cloudfront.amazonaws.com/2017-10-30/distribution/EV1QUKWEQV6XN/invalidation/I33URVVAO02X7I","Invalidation":{"Id":"I33URVVAO02X7I","Status":"<strong>InProgress</strong>","CreateTime":"2018-05-20T06:43:17.102Z","InvalidationBatch":{"Paths":{"Quantity":1,"Items":["/things/44444444-6666-1111-1111-000000000000"]},"CallerReference":"13a8e420-5bf9-11e8-818d-9de0acd70c96"}}}</pre>
<ol start="14">
<li>Invoke the endpoint shown in the stack output with the following <kbd>curl</kbd> commands until the invalidation completes and the output changes:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ curl </strong><strong>https://&lt;see stack output&gt;.cloudfront.net/things/44444444-6666-1111-1111-000000000000</strong><strong> | json_pp<br/></strong><br/>{<br/>   "name" : "thing one again",<br/>   "id" : "44444444-6666-1111-1111-000000000000"<br/>}<strong><br/></strong></pre>
<ol start="15">
<li>Remove the stack once you are finished with <kbd>npm run rm:lcl -- -s $MY_STAGE</kbd>.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>This recipe builds on the <em>Implementing a materialized view in S3</em> and <em>Implementing a search BFF</em> recipes. We define the bucket's <kbd>NotificationConfiguration</kbd> to send events to the SNS <kbd>BucketTopic</kbd> so that we can trigger more than one consumer. In the <em>Implementing a search BFF</em> recipe, we triggered indexing in Elasticsearch. In this recipe, we demonstrate how we can also trigger the invalidation of the cache in the CloudFront distribution. The <kbd>trigger</kbd> function creates an invalidation request for each <kbd>trigger.s3.object.key</kbd>. These invalidations will force the CDN to retrieve these resources from the origin the next time they are requested.</p>
<p>A slow flow of invalidations does not incur significant cost. However, large batches of individual invalidations can be costly. This could occur during a data conversion process when enhancing a service. In these cases, the <kbd>DISABLED</kbd> environment variable should be set to <kbd>true</kbd> before executing the conversion. Then, manually invalidate the distribution with a wildcard when the conversion is complete.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Executing code at the edge of the cloud</h1>
                
            
            
                
<p>AWS Lambda@Edge is a feature that allows functions to execute at the edge of the cloud in response to CloudFront events. This capability opens some interesting opportunities to control, modify, and generate content at the edge of the cloud with extremely low latency. I think we are only just beginning to uncover the potential use cases that can be implemented with this new feature. This recipe demonstrates the association of a bare-bones function with a CloudFront distribution. The function responds with an Unauthorized (403) status code when an authorization header is not present in the request.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Create the project from the following template:</li>
</ol>
<pre style="padding-left: 30px">$ sls create --template-url https://github.com/danteinc/js-cloud-native-cookbook/tree/master/ch4/cdn-lambda --path cncb-cdn-lambda</pre>
<ol start="2">
<li>Navigate to the <kbd>cncb-cdn-lambda</kbd> directory with <kbd>cd cncb-cdn-lambda</kbd>.</li>
<li>Review the file named <kbd>serverless.yml</kbd> with the following content:</li>
</ol>
<pre style="padding-left: 30px">service: cncb-cdn-lambda<br/><br/>plugins:<br/>  - <strong>serverless-plugin-cloudfront-lambda-edge</strong><br/><br/>provider:<br/>  name: aws<br/>  runtime: nodejs8.10<br/>  ...<br/><br/>functions:<br/>  <strong>authorize</strong>:<br/>    handler: handler.authorize<br/>    <strong>memorySize: 128</strong><br/><strong>    timeout: 1</strong><br/><strong>    lambdaAtEdge:</strong><br/><strong>      distribution: 'ApiDistribution'</strong><br/><strong>      eventType: 'viewer-request'</strong><br/>  ...<br/><br/>resources:<br/>  Resources:<br/>    Bucket:<br/>      Type: AWS::S3::Bucket<br/><br/>    ApiDistribution:<br/>      Type: AWS::CloudFront::Distribution<br/>      Properties:<br/>        DistributionConfig:<br/>          ...</pre>
<ol start="4">
<li>Install the dependencies with <kbd>npm install</kbd>.</li>
<li>Run the tests with <kbd>npm test</kbd>.</li>
<li>Review the contents generated in the <kbd>.serverless</kbd> directory:</li>
</ol>
<pre style="padding-left: 30px">...<br/>"LambdaFunctionAssociations": [<br/>  {<br/>    "EventType": "viewer-request",<br/>    "LambdaFunctionARN": {<br/>      "Ref": "AuthorizeLambdaVersionSticfT7s2DCStJsDgzhTCrXZB1CjlEXXc3bR4YS1owM"<br/>    }<br/>  }<br/>]<br/>...</pre>
<ol start="7">
<li>Deploy the stack:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ npm run dp:lcl -- -s $MY_STAGE</strong><br/><br/>&gt; cncb-cdn-lambda@1.0.0 dp:lcl &lt;path-to-your-workspace&gt;/cncb-cdn-lambda<br/>&gt; sls deploy -v -r us-east-1 "-s" "john"<br/><br/>Serverless: Packaging service...<br/>...<br/>Serverless: Stack update finished...<br/>...<br/>functions:<br/>  authorize: cncb-cdn-lambda-john-authorize<br/>  load: cncb-cdn-lambda-john-load<br/><br/>Stack Outputs<br/><strong>ApiDistributionEndpoint: https://d1kktmeew2xtn2.cloudfront.net</strong><br/>BucketName: cncb-cdn-lambda-john-bucket-olzhip1qvzqi<br/>...<br/>ApiDistributionId: E2VL0VWTW5IXUA<br/><br/></pre>
<p>Deploying a CloudFront distribution can take upwards of 20 minutes or more. Any changes to these functions will cause a redeploy of the distribution, because the distribution is linked to the function version.</p>
<ol start="8">
<li>Review the stack, function, and CloudFront distribution in the AWS Console.</li>
<li>Invoke the following command to load the data:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ sls invoke -f load -r us-east-1 -s $MY_STAGE -d '{"id":"44444444-7777-1111-1111-000000000000","name":"thing one"}'</strong><br/><br/>{<br/>    "ETag": "\"3f4ca01316d6f88052a940ab198b2dc7\""<br/>}</pre>
<ol start="10">
<li>Invoke the endpoint shown in the stack output with the following <kbd>curl</kbd> commands:</li>
</ol>
<pre style="padding-left: 30px"><strong>$ curl -v -H "Authorization: Bearer 1234567890" https://</strong><strong>&lt;see stack output&gt;</strong><strong>.cloudfront.net/things/44444444-7777-1111-1111-000000000000 | json_pp<br/></strong><br/>...<br/>&gt; <strong>Authorization</strong>: Bearer 1234567890<br/>&gt;<br/>&lt; HTTP/1.1 <strong>200</strong> OK<br/>...<br/>{<br/>   "name" : "thing one",<br/>   "id" : "44444444-7777-1111-1111-000000000000"<br/>}<strong><br/><br/></strong><strong>$ curl -v </strong><strong>https://&lt;see stack output&gt;.cloudfront.net/things/44444444-7777-1111-1111-000000000000 | json_pp</strong><strong><br/></strong><br/>...<br/>&lt; HTTP/1.1 401 <strong>Unauthorized</strong><br/>...<br/>[<br/>   {<br/>      "Records" : [<br/>         {<br/>            "cf" : {<br/>               "config" : {<br/>                  "<strong>eventType</strong>" : "viewer-request",<br/>                  "requestId" : "zDpj1UckJLTIln8dwak2ZL1SX0LtWfGPhg3mC1EGIgfRd6gzJFVeqg==",<br/>                  "distributionId" : "E2VL0VWTW5IXUA",<br/>                  "distributionDomainName" : "d1kktmeew2xtn2.cloudfront.net"<br/>               },<br/>           ...<br/>            }<br/>         }<br/>      ]<br/>   },<br/>   {<br/>    ...<br/>      "<strong>logGroupName</strong>" : "/aws/lambda/us-east-1.cncb-cdn-lambda-john-authorize",<br/>    ...<br/>   },<br/>   {<br/>      "<strong>AWS_REGION</strong>" : "us-east-1",<br/>    ...<br/>   }<br/>]<strong><br/></strong></pre>
<ol start="11">
<li>Review the logs in the AWS Console.</li>
<li>Remove the stack once you are finished with <kbd>npm run rm:lcl -- -s $MY_STAGE</kbd>.</li>
</ol>
<p>Lambda@Edge replicates functions to multiple regions per the <kbd>PriceClass</kbd> of the distribution. A function cannot be deleted until all the replicas have been deleted. This should happen within several hours of deleting the distribution. Therefore, removing the stack will initially fail, and can be repeated after the replicas have been deleted.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>In this recipe, we use the <kbd>serverless-plugin-cloudfront-lambda-edge</kbd> plugin to associate the <kbd>authorize</kbd> function with the CloudFront <kbd>ApiDistribution</kbd>. We specify the <kbd>distribution</kbd> and the <kbd>eventType</kbd> under the <kbd>lambdaAtEdge</kbd> element. The plugin then uses this information to create the <kbd>LambdaFunctionAssociations</kbd> element on the distribution in the generated CloudFormation template. The <kbd>eventType</kbd> can be set to <kbd>viewer-request</kbd>, <kbd>origin-request</kbd>, <kbd>origin-response</kbd>, or <kbd>view-response</kbd>. This recipe uses the <kbd>viewer-request</kbd>, because it needs access to the authorization header sent by the viewer. We explicitly set the <kbd>memorySize</kbd> and <kbd>timeout</kbd> for the function, because Lambda@Edge imposes restrictions on these values.</p>
<p>Lambda@Edge records <kbd>console.log</kbd> statements in the region associated with the specific edge location that was accessed. This recipe returns <kbd>logGroupName</kbd> and <kbd>AWS_REGION</kbd> in the response to help demonstrate where to find the logs.</p>


            

            
        
    </body></html>