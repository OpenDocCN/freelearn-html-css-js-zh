<html><head></head><body>
        

                            
                    <h1 class="header-title">Building Authentication with passport.js</h1>
                
            
            
                
<p>Authentication is a vital part of any application. Authentication is a way to secure the applications we build. Every application needs some kind of mechanism for authentication. It helps us to identify the users making requests to the application server. </p>
<p>In this chapter, we will discuss the following topics:</p>
<ul>
<li>Creating a login and a register page</li>
<li>Installing and configuring <kbd>passport.js</kbd></li>
<li>Learning more about the <kbd>passport.js</kbd> strategy, that is, the <strong>JSON Web Token</strong> (<strong>JWT</strong>) strategy</li>
<li>Learn more about <kbd>passport.js</kbd> Local Strategy</li>
<li>Creating necessary endpoints in the application server to handle register and login requests</li>
</ul>
<p>We can build the user authentication by ourselves. However, it adds a lot of configuration and lot of headaches. <kbd>passport.js</kbd> is a package that allows us to configure authentication efficiently, taking a very small amount of time. If you want to learn and develop all by yourself, I encourage you to do so. That will give you more insights into how everything works. However, for this book, we will use this awesome tool called <kbd>passport.js</kbd>, which is very easy to integrate and learn.</p>
<p>Up until this chapter, we have created a dynamic web application that displays all the movies that we have added via the Movie Add form and the API on the home page. We have a way of adding these movies to the database via the frontend as well. Now, since this will be a public web application, we cannot allow everyone to add movies by themselves without logging in. Only a user who logs in will have access and be able to add movies. Also, in order to rate a movie, a user should log in first and then rate the movie. </p>


            

            
        
    

        

                            
                    <h1 class="header-title">Introduction to passport.js</h1>
                
            
            
                
<p><kbd>passport.js</kbd> is a middleware provided by Node.js for authentication. The functionality of <kbd>passport.js</kbd> is to authenticate the requests that are made to the server. It provides several strategies for authentication. <kbd>passport.js</kbd> provides strategies to such as local strategy, Facebook strategy, Google strategy, Twitter strategy, and JWT strategy. In this chapter, we will focus on using the JWT strategy.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">JWT</h1>
                
            
            
                
<p>JWT is a way of authenticating the requests using a token-based approach. There are two methods of authenticating requests: cookie-based authentication, and token-based authentication. The cookie-based authentication mechanism saves the user's session ID in the browser's cookie, whereas the token-based mechanism uses a signed token that will look like this:</p>
<pre>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjVhNjhhNDMzMDJkMWNlZDU5YjExNDg3MCIsImlhdCI6MTUxNzI0MjM1M30.5xY59iTIjpt9ukDmxseNAGbOdz6weWL1drJkeQzoO3M</pre>
<p>This token is then validated on every request that we make to the <kbd>controllers</kbd>.</p>
<p>For our application, we will use a combination of both. When a user requests to log in to the app, we will create a signed token for them and then add that token to the browser's cookie. The next time when the user logs in, we will read that token from the cookie and validate that token using the <kbd>passport-jwt</kbd> module in the server, and then decide whether or not to log that user in.</p>
<p>If you look at the preceding token carefully, you will see that the token has three parts separated by a period (<kbd>.</kbd>); each part has its own meaning:</p>
<ul>
<li>The first part represents the header</li>
<li>The second part represents the payload</li>
<li>The third part represents the signature</li>
</ul>
<p>To be able to use this JWT, we will need to add a package. To do that, we can just run the following command:</p>
<pre><strong>$ npm install jsonwebtoken --save</strong><br/></pre>
<p>To start using this package, let's define it in <kbd>server.js</kbd> as well:</p>
<pre>...<br/>const morgan = require('morgan')<br/>const fs = require('fs')<br/><strong>const jwt = require('jsonwebtoken');</strong><br/>...</pre>


            

            
        
    

        

                            
                    <h1 class="header-title">Installing passport.js</h1>
                
            
            
                
<p>Just like any other <kbd>npm</kbd> package, we can install <kbd>passport.js</kbd> by running the following command:</p>
<pre><strong>$ npm install passport --save</strong></pre>
<p>On successful installation, you should have those package listed on your <kbd>package.json</kbd> as well:</p>
<pre>...<br/>"nodemon": "^1.14.10",<br/><strong>"</strong><strong>passport"</strong><strong>: "^0.4.0"</strong><strong>,</strong><br/>"sass-loader": "^6.0.6",<br/>...</pre>
<p>You can also do this by first adding the package to your <kbd>package.json</kbd> file and then running the following command:</p>
<pre><strong>$ npm install</strong></pre>


            

            
        
    

        

                            
                    <h1 class="header-title">Configuring passport</h1>
                
            
            
                
<p>Just like any other <kbd>node</kbd> package, we will need to configure the package for <kbd>passport.js</kbd>. In our <kbd>server.js</kbd> file, add the following lines of code:</p>
<pre>...<br/>const mongoose = require('mongoose');<br/>const cors = require('cors');<br/>const morgan = require('morgan');<br/>const fs = require('fs');<br/>const jwt = require('jsonwebtoken');<br/><strong>const passport = require('passport');</strong><br/><br/>const app = express();<br/>const router = express.Router();<br/>app.use(morgan('combined'));<br/>app.use(bodyParser.json());<br/>app.use(cors());<br/><strong>app.use(passport.initialize());</strong><br/>...</pre>
<p>The preceding code just initialized <kbd>passport.js</kbd> in our application. We still need to configure a couple of things to start using the JWT authentication mechanism.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">passport.js strategies</h1>
                
            
            
                
<p>As mentioned previously, <kbd>passport.js</kbd> provides a lot of strategies for easy integration. One of the strategies that we will be working on with is the JWT strategy. We have already added <kbd>passport.js</kbd> and initialized it. Now, let's add this strategy as well.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Installing the passport-jwt strategy</h1>
                
            
            
                
<p>Just installing passport module is not sufficient for our needs. <kbd>passport.js</kbd> provides its strategies in separate <kbd>npm</kbd> packages. For <kbd>jwt</kbd> authentication, we have to install the <kbd>passport-jwt</kbd> module, as follows:</p>
<pre><strong>$ npm install passport-jwt --save</strong></pre>
<p>On successful installation, you should have these packages listed in the <kbd>package.json</kbd> file of the application:</p>
<pre>...<br/>"nodemon": "^1.14.10",<br/>"passport": "^0.4.0",<strong><br/>"passport-jwt": "^3.0.1",</strong><br/>"sass-loader": "^6.0.6",<br/>...<br/></pre>


            

            
        
    

        

                            
                    <h1 class="header-title">Configuring the passport-jwt strategy</h1>
                
            
            
                
<p>Now that we have all the things we need, let's jump into the configuration setting for the JWT strategy. Add the following lines of code in <kbd>server.js</kbd>:</p>
<pre>...<br/>const morgan = require('morgan');<br/>const fs = require('fs');<br/>const jwt = require('jsonwebtoken');<br/>const passport = require('passport');<br/><strong>const passportJWT = require('passport-jwt');<br/>const ExtractJwt = passportJWT.ExtractJwt;</strong><br/><strong>const JwtStrategy = passportJWT.Strategy;</strong><br/><strong>const jwtOptions = {}</strong><br/><strong>jwtOptions.jwtFromRequest = ExtractJwt.fromAuthHeaderWithScheme('jwt');</strong><br/><strong>jwtOptions.secretOrKey = 'movieratingapplicationsecretkey';</strong><br/><br/>const app = express();<br/>const router = express.Router();<br/>...</pre>
<p>The preceding code is enough to get us started. We will need <kbd>JwtStrategy</kbd> from <kbd>passport.js</kbd>, and <kbd>ExtractJwT</kbd> will be used to extract the payload data in the <kbd>jwt</kbd> token.</p>
<p>We have also defined a variable to set the JWT <kbd>auth</kbd> settings, which has a secret key configured. This secret key will be used to sign the payloads of any requests. </p>
<p>You can also create a separate file to store your important keys. </p>


            

            
        
    

        

                            
                    <h1 class="header-title">Using the JWT strategy</h1>
                
            
            
                
<p>Now we are all set up to use the services provided by <kbd>passport.js</kbd>. Let's quickly recap what we have done so far:</p>
<ol>
<li>Installed passport, <kbd>passport-jwt</kbd>, and <kbd>jsonwebtoken</kbd></li>
<li>Configured all settings for these three packages</li>
</ol>
<p>The next steps are as follows:</p>
<ol>
<li>Creating our user model</li>
<li>Creating API endpoints for the user entity, that is, sign in and sign up</li>
<li>Building our authentication views,  that is, the login page and register page</li>
<li>Using the JWT strategy to finally authenticate the requests</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">Setting up user registration</h1>
                
            
            
                
<p>Let's start with adding the functionality to sign up users to our app.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Creating a User model</h1>
                
            
            
                
<p>We don't have a collection yet to manage the users. We will have three parameters in our <kbd>User</kbd> model: <kbd>name</kbd>, <kbd>email</kbd>, and <kbd>password</kbd>. Let's go ahead and create our <kbd>User</kbd> model called <kbd>User.js</kbd> in the <kbd>models</kbd> directory:</p>
<pre><strong>const mongoose = require('mongoose');</strong><br/><br/><strong>const Schema = mongoose.Schema;</strong><br/><strong>const UserSchema = new Schema({</strong><br/><strong>  name: String,</strong><br/><strong>  email: String,</strong><br/><strong>  password: String,</strong><br/><strong>});</strong><br/><br/><strong>const User = mongoose.model('User', UserSchema);</strong><br/><strong>module.exports = User;</strong></pre>
<p>As you can see, the following are the three attributes for the user: <kbd>name</kbd>, <kbd>email</kbd>, and <kbd>password</kbd>. </p>


            

            
        
    

        

                            
                    <h1 class="header-title">Installing bcryptjs</h1>
                
            
            
                
<p>Now, we cannot save these user's passwords in plain text, so we will need a mechanism to encrypt them. Fortunately, we already have a package designed to encrypt passwords, which is <kbd>bcryptjs</kbd>. Let's first add this package to our application:</p>
<pre><strong>$ npm install bcryptjs --save</strong></pre>
<p>When the package is installed, let's add the initialization block in the <kbd>User.js</kbd> model:</p>
<pre>const mongoose = require('mongoose');<br/><strong>const bcryptjs = require('bcryptjs');</strong><br/><br/>const Schema = mongoose.Schema;<br/>const UserSchema = new Schema({<br/>  name: String,<br/>  email: String,<br/>  password: String,<br/>});<br/><br/>const User = mongoose.model('User', UserSchema);<br/>module.exports = User;</pre>
<p>Now, when we save a user, we should create our own method to add users to the database, as we want to encrypt their passwords. So, let's add the following code to <kbd>models/User.js</kbd>:</p>
<pre>...<br/>const User = mongoose.model('User', UserSchema);<br/>module.exports = User;<br/><br/><strong>module.exports.createUser = (newUser, callback) =&gt; {</strong><br/><strong>  bcryptjs.genSalt(10, (err, salt) =&gt; {</strong><br/><strong>    bcryptjs.hash(newUser.password, salt, (error, hash) =&gt; {</strong><br/><strong>      // store the hashed password</strong><br/><strong>      const newUserResource = newUser;</strong><br/><strong>      newUserResource.password = hash;</strong><br/><strong>      newUserResource.save(callback);</strong><br/><strong>    });</strong><br/><strong>  });</strong><br/><strong>};</strong><br/>...</pre>
<p>In the preceding code, we have used the <kbd>bcrypt</kbd> library, which uses a <kbd>genSalt</kbd> mechanism to convert a password into an encrypted string. The preceding method—<kbd>createUser</kbd>—in the <kbd>User</kbd> model takes the <kbd>user</kbd> object, converts the user-provided password into a bcrypted password, and then saves it to the database.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Adding API endpoint to register a user</h1>
                
            
            
                
<p>Now that we have our model ready, let's move on to creating an endpoint to create a user. For that, let's first create a controller called  <kbd>users.js</kbd> in the <kbd>controllers</kbd> folder to manage all user related requests. Since we have added a code block to initialize all the files inside the <kbd>controllers</kbd> directory in <kbd>server.js</kbd>, we do not need to require those files here.</p>
<p>In <kbd>users.js</kbd>, replace the file's contents with the following code:</p>
<pre><strong>const User = require('../models/User.js');</strong><br/><br/><strong>module.exports.controller = (app) =&gt; {</strong><br/><strong>  // register a user</strong><br/><strong>  app.post('/users/register', (req, res) =&gt; {</strong><br/><strong>    const name = req.body.name;</strong><br/><strong>    const email = req.body.email;</strong><br/><strong>    const password = req.body.password;</strong><br/><strong>    const newUser = new User({</strong><br/><strong>      name,</strong><br/><strong>      email,</strong><br/><strong>      password,</strong><br/><strong>    });</strong><br/><strong>    User.createUser(newUser, (error, user) =&gt; {</strong><br/><strong>      if (error) { console.log(error); }</strong><br/><strong>      res.send({ user });</strong><br/><strong>    });</strong><br/><strong>  });</strong><br/><strong>};</strong></pre>
<p>In the preceding code, we have added an endpoint, that makes a POST request to the <kbd>http://localhost:8081/users/register</kbd>  URL, takes the <kbd>name</kbd>, <kbd>email</kbd>, and <kbd>password</kbd> of the user, and saves them to our database. In the response, it returns the user that was just created. It's quite simple.</p>
<p>Now, let's test this endpoint in Postman. You should be able to see the user returned in the response:</p>
<div><img class="alignnone size-full wp-image-462 image-border" src="img/64757a12-83f6-4ab9-a3d9-a61e0f19b6fd.png" style="width:162.50em;height:92.67em;"/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Creating a register view page</h1>
                
            
            
                
<p>Let's add a view page for the users to sign up. For that, we will need to create a form that takes the <kbd>name</kbd>, <kbd>email</kbd>, and <kbd>password</kbd> parameters. Create a file called <kbd>Register.vue</kbd> inside <kbd>src/components</kbd>:</p>
<pre><strong>&lt;template&gt;</strong><br/><strong>  &lt;v-form v-model="valid" ref="form" lazy-validation&gt;</strong><br/><strong>    &lt;v-text-field</strong><br/><strong>      label="Name"</strong><br/><strong>      v-model="name"</strong><br/><strong>      required</strong><br/><strong>    &gt;&lt;/v-text-field&gt;</strong><br/><strong>    &lt;v-text-field</strong><br/><strong>      label="Email"</strong><br/><strong>      v-model="email"</strong><br/><strong>      :rules="emailRules"</strong><br/><strong>      required</strong><br/><strong>    &gt;&lt;/v-text-field&gt;</strong><br/><strong>    &lt;v-text-field</strong><br/><strong>      label="Password"</strong><br/><strong>      v-model="password"</strong><br/><strong>      required</strong><br/><strong>    &gt;&lt;/v-text-field&gt;</strong><br/><strong>    &lt;v-text-field</strong><br/><strong>      name="input-7-1"</strong><br/><strong>      label="Confirm Password"</strong><br/><strong>      v-model="confirm_password"</strong><br/><strong>    &gt;&lt;/v-text-field&gt;</strong><br/><strong>    &lt;v-btn</strong><br/><strong>      @click="submit"</strong><br/><strong>      :disabled="!valid"</strong><br/><strong>    &gt;</strong><br/><strong>      submit</strong><br/><strong>    &lt;/v-btn&gt;</strong><br/><strong>    &lt;v-btn @click="clear"&gt;clear&lt;/v-btn&gt;</strong><br/><strong>  &lt;/v-form&gt;</strong><br/><strong>&lt;/template&gt;</strong></pre>
<p>The <kbd>vue</kbd> file is a simple template file that contains the form components. The next step is to add a route for that file. </p>
<p>In <kbd>src/router/index.js</kbd>, add the following lines of code:</p>
<pre>import Vue from 'vue';<br/>import Router from 'vue-router';<br/>import Home from '@/components/Home';<br/>import Contact from '@/components/Contact';<br/>import AddMovie from '@/components/AddMovie';<br/>import Movie from '@/components/Movie';<br/><strong>import Register from '@/components/Register';</strong><br/><br/>Vue.use(Router);<br/><br/>export default new Router({<br/>  mode: 'history',<br/>  routes: [<br/>    {<br/>      path: '/',<br/>      name: 'Home',<br/>      component: Home,<br/>    },<br/>    {<br/>      path: '/contact',<br/>      name: 'Contact',<br/>      component: Contact,<br/>    },<br/>    {<br/>      path: '/movies/add',<br/>      name: 'AddMovie',<br/>      component: AddMovie,<br/>    },<strong><br/>    </strong>{<strong><br/>     </strong> path: '/movies/:id',<strong><br/>      </strong>name: 'Movie',<strong><br/>      </strong>component: Movie,<strong><br/>    </strong>},<br/><strong>    {</strong><br/><strong>      path: '/users/register',</strong><br/><strong>      name: 'Register',</strong><br/><strong>      component: Register,</strong><br/><strong>    },</strong><br/>  ],<br/>});</pre>
<p>That's it! Now, let's navigate to <kbd>http://localhost.com:8080/users/register</kbd>:</p>
<div><img src="img/45360b7b-0695-4de3-a24c-25b3bcdf6448.png"/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Adding submit and clear methods in the register form</h1>
                
            
            
                
<p>The next step is to add functionality to the <kbd>submit</kbd> and <kbd>clear</kbd> methods. Let's add some methods to <kbd>Register.vue</kbd>:</p>
<pre>...<br/>    &lt;v-btn @click="clear"&gt;clear&lt;/v-btn&gt;<br/>  &lt;/v-form&gt;<br/>&lt;/template&gt;<br/><strong>&lt;script&gt;</strong><br/><strong>export default {</strong><br/><strong>  data: () =&gt; ({</strong><br/><strong>    valid: true,</strong><br/><strong>    name: '',</strong><br/><strong>    email: '',</strong><br/><strong>    password: '',</strong><br/><strong>    confirm_password: '',</strong><br/><strong>    emailRules: [</strong><br/><strong>      v =&gt; !!v || 'E-mail is required',</strong><br/><strong>      v =&gt; /\S+@\S+\.\S+/.test(v) || 'E-mail must be valid',</strong><br/><strong>    ],</strong><br/><strong>  }),</strong><br/><strong>  methods: {</strong><br/><strong>    async submit() {</strong><br/><strong>      if (this.$refs.form.validate()) {</strong><br/><strong>        // add process here</strong><br/><strong>      }</strong><br/><strong>    },</strong><br/><strong>    clear() {</strong><br/><strong>      this.$refs.form.reset();</strong><br/><strong>    },</strong><br/><strong>  },</strong><br/><strong>};</strong><br/><strong>&lt;/script&gt;</strong></pre>
<p>We have also added some validations for the registration form here. It validates the email provided by the user according to the given regex.</p>
<p>We have added two methods, <kbd>submit</kbd> and <kbd>clear</kbd>. The <kbd>clear</kbd> method resets the form values; pretty straightforward, right?  Now, when we click on the <kbd>submit</kbd> button, the validations are run first. If all the validations pass, then only the logic inside the <kbd>submit</kbd> method is processed. Here, we need to make a request to the server with the user parameters where <kbd>axios</kbd> comes into play.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Introducing axios</h1>
                
            
            
                
<p>The axios is a mechanism to send request data to the server. You can think of it as an AJAX request in JavaScript. With <kbd>axios</kbd>, we can handle success and error responses from the server effectively.</p>
<p>To install <kbd>axios</kbd>, run the following command:</p>
<pre><strong>$ npm install axios --save</strong></pre>


            

            
        
    

        

                            
                    <h1 class="header-title">Using axios</h1>
                
            
            
                
<p>Now, let's modify our <kbd>Register.vue</kbd> file to implement <kbd>axios</kbd>—replace the content inside the <kbd>script</kbd> tag as follows:</p>
<pre>...<br/>&lt;/v-form&gt;<br/>&lt;/template&gt;<br/>&lt;script&gt;<br/><strong>import axios from 'axios';</strong><br/><br/>export default {<br/>  data: () =&gt; ({<br/>    valid: true,<br/>    name: '',<br/>    email: '',<br/>    password: '',<br/>    confirm_password: '',<br/>    emailRules: [<br/>      v =&gt; !!v || 'E-mail is required',<br/>      v =&gt; /\S+@\S+\.\S+/.test(v) || 'E-mail must be valid',<br/>    ],<br/>  }),<br/>  methods: {<br/>    <strong>async submit() {</strong><br/><strong>      if (this.$refs.form.validate()) {</strong><br/><strong>        return axios({</strong><br/><strong>          method: 'post',</strong><br/><strong>          data: {</strong><br/><strong>            name: this.name,</strong><br/><strong>            email: this.email,</strong><br/><strong>            password: this.password,</strong><br/><strong>          },</strong><br/><strong>          url: 'http://localhost:8081/users/register',</strong><br/><strong>          headers: {</strong><br/><strong>            'Content-Type': 'application/json',</strong><br/><strong>          },</strong><br/><strong>        })</strong><br/><strong>          .then(() =&gt; {</strong><br/><strong>            this.$swal(</strong><br/><strong>              'Great!',</strong><br/><strong>              'You have been successfully registered!',</strong><br/><strong>              'success',</strong><br/><strong>            );</strong><br/><strong>            this.$router.push({ name: 'Login' });</strong><br/><strong>          })</strong><br/><strong>          .catch((error) =&gt; {</strong><br/><strong>            const message = error.response.data.message;</strong><br/><strong>            this.$swal('Oh oo!', `${message}`, 'error');</strong><br/><strong>          });</strong><br/><strong>      }</strong><br/><strong>      return true;</strong><br/><strong>    },</strong><br/><strong>    clear() {</strong><br/><strong>      this.$refs.form.reset();</strong><br/><strong>    },</strong><br/>  },<br/>};<br/>&lt;/script&gt;</pre>
<p>If you are familiar with <kbd>ajax</kbd>, you should be able to quickly understand the code. If not, don't worry, it's actually quite simple. The <kbd>axios</kbd> method takes important parameters, such as the <kbd>request</kbd> method (in preceding case, <kbd>post</kbd>), the data parameters or the payloads, and a URL endpoint to hit. It takes these parameters and routes them to either the <kbd>then()</kbd> method or <kbd>catch()</kbd> method depending on the server's response. </p>
<p>If the request is successful, it goes to the <kbd>then()</kbd> method; if not, it goes to the <kbd>catch()</kbd> method. Now, the success and failure of the requests are also customizable according to our needs. For the preceding scenario, we will simply pass an error response if the <kbd>user</kbd> is not saved to the database. We can also do it for the validations. </p>
<p>So, let's also modify <kbd>users.js</kbd> inside the <kbd>controller</kbd> method to accommodate these changes:</p>
<pre>const User = require('../models/User.js');<br/><br/>module.exports.controller = (app) =&gt; {<br/>  // register a user<br/>  app.post('/users/register', (req, res) =&gt; {<br/>    const name = req.body.name;<br/>    const email = req.body.email;<br/>    const password = req.body.password;<br/>    const newUser = new User({<br/>      name,<br/>      email,<br/>      password,<br/>    });<br/>    User.createUser(newUser, (error, user) =&gt; {<br/>      <strong>if (error) {</strong><br/><strong>        res.status(422).json({</strong><br/><strong>          message: 'Something went wrong. Please try again after some time!',</strong><br/><strong>        });</strong><br/><strong>      }</strong><br/>      res.send({ user });<br/>    });<br/>  });<br/>};</pre>
<p>As you can see in the preceding code, if there is a failure in the request, we will send a message saying <kbd>Something went wrong</kbd>. We can also display different types of message depending on the server's response. </p>


            

            
        
    

        

                            
                    <h1 class="header-title">Setting up the user login</h1>
                
            
            
                
<p>Now that we have successfully implemented the login process for a user, let's start building the functionality to log users in to our app.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Modifying the User model</h1>
                
            
            
                
<p>To log in users to the app, we will take the following two parameters: the user's email and their password. We will need to query the database to find the record with their given email; so, let's add a method that will extract the user according to the username:</p>
<pre>...<br/>const User = mongoose.model('User', UserSchema);<br/>module.exports = User;<br/><br/>module.exports.createUser = (newUser, callback) =&gt; {<br/>  bcryptjs.genSalt(10, (err, salt) =&gt; {<br/>    bcryptjs.hash(newUser.password, salt, (error, hash) =&gt; {<br/>      // store the hashed password<br/>      const newUserResource = newUser;<br/>      newUserResource.password = hash;<br/>      newUserResource.save(callback);<br/>    });<br/>  });<br/>};<br/><br/><strong>module.exports.getUserByEmail = (email, callback) =&gt; {</strong><br/><strong>  const query = { email };</strong><br/><strong>  User.findOne(query, callback);</strong><br/><strong>};</strong></pre>
<p>The preceding method will return the user that has the given email.</p>
<p>As I mentioned, another thing that we will need to check is the password. Let's add method that compares the password provided by the user while logging in to the password that is saved in our database:</p>
<pre>...<br/>module.exports.getUserByEmail = (email, callback) =&gt; {<br/>  const query = { email };<br/>  User.findOne(query, callback);<br/>};<br/><br/><strong>module.exports.comparePassword = (candidatePassword, hash, callback) =&gt; {</strong><br/><strong>  bcryptjs.compare(candidatePassword, hash, (err, isMatch) =&gt; {</strong><br/><strong>    if (err) throw err;</strong><br/><strong>    callback(null, isMatch);</strong><br/><strong>  });</strong><br/><strong>};</strong></pre>
<p>The preceding method takes both user-provided password and the saved password and returns <kbd>true</kbd> or <kbd>false</kbd> depending on whether the passwords match or not.</p>
<p>Now we are all set to jump into the controller part.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Adding an API endpoint to log a user in</h1>
                
            
            
                
<p>We have added the methods required for a user to be able to log in. Now, the most important part of this chapter lies here. We need to set up the JWT <kbd>auth</kbd> mechanism to enable a user to log in.</p>
<p>In <kbd>users.js</kbd>, add the following lines of code:</p>
<pre>const User = require('../models/User.js');<br/><br/><strong>const passportJWT = require('passport-jwt');</strong><br/><strong>const jwt = require('jsonwebtoken');</strong><br/><br/><strong>const ExtractJwt = passportJWT.ExtractJwt;</strong><br/><strong>const jwtOptions = {};</strong><br/><strong>jwtOptions.jwtFromRequest = ExtractJwt.fromAuthHeaderWithScheme('jwt');</strong><br/><strong>jwtOptions.secretOrKey = 'thisisthesecretkey';</strong><br/><br/>module.exports.controller = (app) =&gt; {<br/>  // register a user<br/>  app.post('/users/register', (req, res) =&gt; {<br/>    const name = req.body.name;<br/>    const email = req.body.email;<br/>    const password = req.body.password;<br/>    const newUser = new User({<br/>      name,<br/>      email,<br/>      password,<br/>    });<br/>    User.createUser(newUser, (error, user) =&gt; {<br/>      if (error) {<br/>        res.status(422).json({<br/>          message: 'Something went wrong. Please try again after some time!',<br/>        });<br/>      }<br/>      res.send({ user });<br/>    });<br/>  });<br/><br/>  <strong>// login a user</strong><br/><strong>  app.post('/users/login', (req, res) =&gt; {</strong><br/><strong>    if (req.body.email &amp;&amp; req.body.password) {</strong><br/><strong>      const email = req.body.email;</strong><br/><strong>      const password = req.body.password;</strong><br/><strong>      User.getUserByEmail(email, (err, user) =&gt; {</strong><br/><strong>        if (!user) {</strong><br/><strong>          res.status(404).json({ message: 'The user does not exist!' });</strong><br/><strong>        } else {</strong><br/><strong>          User.comparePassword(password, user.password, (error, isMatch) =&gt; {</strong><br/><strong>            if (error) throw error;</strong><br/><strong>            if (isMatch) {</strong><br/><strong>              const payload = { id: user.id };</strong><br/><strong>              const token = jwt.sign(payload, jwtOptions.secretOrKey);</strong><br/><strong>              res.json({ message: 'ok', token });</strong><br/><strong>            } else {</strong><br/><strong>              res.status(401).json({ message: 'The password is incorrect!' });</strong><br/><strong>            }</strong><br/><strong>          });</strong><br/><strong>        }</strong><br/><strong>      });</strong><br/><strong>    }</strong><br/><strong>  });</strong><br/>};</pre>
<p>Since the JWT strategy is a part of <kbd>passport.js</kbd>, we will need to initialize that as well. We also need to add some configurations for JWT options to extract the data from the payload, and unencrypt it and then encrypt it again when a request is made to the server.</p>
<p>The secret key is something that you can configure. It basically represents the token of your app. Ensure that it is not easily guessable.</p>
<p>Also, we have added an endpoint, which makes a POST request to <kbd>localhost:8081/users/login</kbd> and takes the user's email and password. The following are a couple of things that this method does:</p>
<ul>
<li>Checks whether the user with the given email exists. If it does not exist, it sends a status code of 404, stating that the user does not exist in our app.</li>
<li>Compares the provided password with our user's password in the app. If there is no match, it sends an error response stating that passwords do not match.</li>
<li>If everything goes fine, it signs the user's payload with the JWT signature, generates a token, and responds with that token.</li>
</ul>
<p>Now, let's test this endpoint in Postman. You should be able to see the token returned in the response, as follows:</p>
<div><img class="alignnone size-full wp-image-464 image-border" src="img/9d43f252-4443-4cdb-b915-48e3fd30c63f.png" style="width:60.50em;height:33.67em;"/></div>
<p>In the preceding screenshot, note that JWT takes the payload, signs it, and generates a random token.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Creating a register view page</h1>
                
            
            
                
<p>Let's add a view page for the users to log in now. For that, like we did on the register page, we will need to create a form that takes the email and password parameters. Create a file called <kbd>Login.vue</kbd> inside <kbd>src/components</kbd>, as follows:</p>
<pre><strong>&lt;template&gt;</strong><br/><strong>  &lt;v-form v-model="valid" ref="form" lazy-validation&gt;</strong><br/><strong>    &lt;v-text-field</strong><br/><strong>      label="Email"</strong><br/><strong>      v-model="email"</strong><br/><strong>      :rules="emailRules"</strong><br/><strong>      required</strong><br/><strong>    &gt;&lt;/v-text-field&gt;</strong><br/><strong>    &lt;v-text-field</strong><br/><strong>      label="Password"</strong><br/><strong>      v-model="password"</strong><br/><strong>      required</strong><br/><strong>    &gt;&lt;/v-text-field&gt;</strong><br/><strong>    &lt;v-btn</strong><br/><strong>      @click="submit"</strong><br/><strong>      :disabled="!valid"</strong><br/><strong>    &gt;</strong><br/><strong>      submit</strong><br/><strong>    &lt;/v-btn&gt;</strong><br/><strong>    &lt;v-btn @click="clear"&gt;clear&lt;/v-btn&gt;</strong><br/><strong>  &lt;/v-form&gt;</strong><br/><strong>&lt;/template&gt;</strong></pre>
<p>The <kbd>vue</kbd> file is a simple template file that contains the form components. The next thing to do is to add a route for that file. </p>
<p>In <kbd>src/router/index.js</kbd>, add the following code:</p>
<pre>import Vue from 'vue';<br/>import Router from 'vue-router';<br/>import Home from '@/components/Home';<br/>import Contact from '@/components/Contact';<br/>import AddMovie from '@/components/AddMovie';<br/>import Movie from '@/components/Movie';<br/>import Register from '@/components/Register';<br/><strong>import Login from '@/components/Login';</strong><br/><br/>Vue.use(Router);<br/><br/>export default new Router({<br/>  mode: 'history',<br/>  routes: [<br/>    {<br/>      path: '/',<br/>      name: 'Home',<br/>      component: Home,<br/>    },<br/>    {<br/>      path: '/contact',<br/>      name: 'Contact',<br/>      component: Contact,<br/>    },<br/>    {<br/>      path: '/movies/add',<br/>      name: 'AddMovie',<br/>      component: AddMovie,<br/>    },<br/>    {<br/>      path: '/movies/:id',<br/>      name: 'Movie',<br/>      component: Movie,<br/>    },<br/>    {<br/>      path: '/users/register',<br/>      name: 'Register',<br/>      component: Register,<br/>    },<br/>    <strong>{</strong><br/><strong>      path: '/users/login',</strong><br/><strong>      name: 'Login',</strong><br/><strong>      component: Login,</strong><br/><strong>    },</strong><br/>  ],<br/>});</pre>
<p>That's it. Now, let's navigate to <kbd>http://localhost.com:8080/users/login</kbd>:</p>
<div><img src="img/36840d36-9b09-4219-9797-57ad3e10df90.png"/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Adding submit and clear methods to the login form</h1>
                
            
            
                
<p>The next step is to add functionality in the <kbd>submit</kbd> and <kbd>clear</kbd> methods. Let's add some methods to <kbd>Login.vue</kbd>. The <kbd>clear</kbd> method is the same as on the register page. For the <kbd>submit</kbd> method, we will use the <kbd>axios</kbd> method here. We have already categorized our success and error messages in the controller. Now we just need to make sure that they are displayed in the UI:</p>
<pre>...<br/>&lt;/v-form&gt;<br/>&lt;/template&gt;<br/><strong>&lt;script&gt;</strong><br/><strong>import axios from 'axios';</strong><br/><br/><strong>export default {</strong><br/><strong>  data: () =&gt; ({</strong><br/><strong>    valid: true,</strong><br/><strong>    email: '',</strong><br/><strong>    password: '',</strong><br/><strong>    emailRules: [</strong><br/><strong>      v =&gt; !!v || 'E-mail is required',</strong><br/><strong>      v =&gt; /\S+@\S+\.\S+/.test(v) || 'E-mail must be valid',</strong><br/><strong>    ],</strong><br/><strong>  }),</strong><br/><strong>  methods: {</strong><br/><strong>    async submit() {</strong><br/><strong>      return axios({</strong><br/><strong>        method: 'post',</strong><br/><strong>        data: {</strong><br/><strong>          email: this.email,</strong><br/><strong>          password: this.password,</strong><br/><strong>        },</strong><br/><strong>        url: 'http://localhost:8081/users/login',</strong><br/><strong>        headers: {</strong><br/><strong>          'Content-Type': 'application/json',</strong><br/><strong>        },</strong><br/><strong>      })</strong><br/><strong>        .then((response) =&gt; {</strong><br/><strong>          window.localStorage.setItem('auth', response.data.token);</strong><br/><strong>          this.$swal('Great!', 'You are ready to start!', 'success');</strong><br/><strong>          this.$router.push({ name: 'Home' });</strong><br/><strong>        })</strong><br/><strong>        .catch((error) =&gt; {</strong><br/><strong>          const message = error.response.data.message;</strong><br/><strong>          this.$swal('Oh oo!', `${message}`, 'error');</strong><br/><strong>          this.$router.push({ name: 'Login' });</strong><br/><strong>        });</strong><br/><strong>    },</strong><br/><strong>    clear() {</strong><br/><strong>      this.$refs.form.reset();</strong><br/><strong>    },</strong><br/><strong>  },</strong><br/><strong>};</strong><br/><strong>&lt;/script&gt;</strong></pre>
<p>The validations are the same as on the register page. We have added two methods, <kbd>submit</kbd> and <kbd>clear</kbd>. The <kbd>clear</kbd> method resets the form values, and the <kbd>submit</kbd> method simply hits the API endpoint, taking the parameter from the form, and responds with the correct message, which is then displayed in the UI. Upon successful completion, the user will be redirected to the home page.</p>
<p>The important part here is that since we are interacting on the client side, we will need the previously generated JWT token to be saved somewhere. The best way to access the token is by saving it to the browser's session. So, we have set a key called <kbd>auth</kbd>, which saves the JWT token in the local storage. Whenever any other requests are made, the request will first check whether it is a valid token or not and perform the action accordingly.</p>
<p>The following is what we have done so far:</p>
<ul>
<li>Added <kbd>getUserByEmail()</kbd> and <kbd>comparePassword()</kbd> to the Users model</li>
<li>Created a login view page</li>
<li>Added methods to be able to submit and clear the form</li>
<li>Generated a JWT signed token and saved it to the session for reuse later</li>
<li>Displayed success and error messages</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Authenticating our user in Home.vue</h1>
                
            
            
                
<p>The last thing we need to do is check whether the current logged in user is authorized to view the movie listing page or not. Although it makes sense to make the home page (movie listing page) accessible to all users, for learning purpose, let's add JWT authorization when a user goes to the home page. Let's make the home page not accessible to the outside users who are not in our app.</p>
<p>In <kbd>movies.js</kbd>, add the following piece of code:</p>
<pre>const MovieSchema = require('../models/Movie.js');<br/>const Rating = require('../models/Rating.js');<br/><strong>const passport = require('passport');</strong><br/><br/>module.exports.controller = (app) =&gt; {<br/>  // fetch all movies<br/>  <strong>app.get('/movies', passport.authenticate('jwt', { session: false }), (req, res) =&gt; {</strong><br/>    MovieSchema.find({}, 'name description release_year genre', (error, movies) =&gt; {<br/>      if (error) { console.log(error); }<br/>      res.send({<br/>        movies,<br/>      });<br/>    });<br/>  });<br/>...</pre>
<p>Yup, that's it! We will need to initialize passport and just add <kbd>passport.authenticate('jwt', { session: false })</kbd>. We have to pass the JWT token and the passport JWT strategy automatically authenticates the current user. </p>
<p>Now, let's also send the JWT token while making a request to the movie listing page. In <kbd>Home.vue</kbd>, add the following code:</p>
<pre>...<br/>&lt;script&gt;<br/>import axios from 'axios';<br/><br/>export default {<br/>  name: 'Movies',<br/>  data() {<br/>    return {<br/>      movies: [],<br/>    };<br/>  },<br/>  mounted() {<br/>    this.fetchMovies();<br/>  },<br/>  methods: {<br/>    <strong>async fetchMovies() {</strong><br/><strong>      const token = window.localStorage.getItem('auth');</strong><br/><strong>      return axios({</strong><br/><strong>        method: 'get',</strong><br/><strong>        url: 'http://localhost:8081/movies',</strong><br/><strong>        headers: {</strong><br/><strong>          Authorization: `JWT ${token}`,</strong><br/><strong>          'Content-Type': 'application/json',</strong><br/><strong>        },</strong><br/><strong>      })</strong><br/><strong>        .then((response) =&gt; {</strong><br/><strong>          this.movies = response.data.movies;</strong><br/><strong>          this.current_user = response.data.current_user;</strong><br/><strong>        })</strong><br/><strong>        .catch(() =&gt; {</strong><br/><strong>        });</strong><br/><strong>    },</strong><br/>  },<br/>};<br/>&lt;/script&gt;</pre>
<p>While making the <kbd>axios</kbd> call, we will have to pass one extra parameter in the headers. We need to read the token from the local storage and pass it to the movies API through the headers. </p>
<p>With this, any user who is not logged in to the app will not be able to view the movie listing page.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Serving static files for Vue components</h1>
                
            
            
                
<p>Before jumping into the Local Strategy, let's learn a little bit about how we can make our Vue.js components to be served statically. Since we are using a separate frontend and backend, it can be a daunting task to keep maintaining these two versions, and especially while deploying the app, it can take a lot longer to configure everything. So, to manage our app better, we will build the Vue.js app, which will be a production build, and use the Node.js server only to serve the files. For that, we will be using a separate package called serve-static. So, let's go ahead and install the package:</p>
<pre><strong>$ npm install serve-static --save<br/></strong></pre>
<p>Now, let's add the following contents to our <kbd>server.js</kbd> file:</p>
<pre>const express = require('express');<br/>const bodyParser = require('body-parser');<br/>const mongoose = require('mongoose');<br/>const cors = require('cors');<br/>const morgan = require('morgan');<br/>const fs = require('fs');<br/>const session = require('express-session');<br/>const config = require('./config/Config');<br/>const passport = require('passport');<br/>const app = express();<br/>const router = express.Router();<br/><strong>const serveStatic = require('serve-static');</strong><br/><br/>app.use(morgan('combined'));<br/>app.use(bodyParser.json());<br/>app.use(cors());<br/><br/>...<br/><br/>// Include controllers<br/>fs.readdirSync("controllers").forEach(function (file) {<br/>  if(file.substr(-3) == ".js") {<br/>    const route = require("./controllers/" + file)<br/>    route.controller(app)<br/>  }<br/>})<br/><strong>app.use(serveStatic(__dirname + "/dist"));</strong><br/>...</pre>
<p>With this, let's now build our application with the following command:</p>
<pre><strong>$ npm run build <br/></strong></pre>
<p>The preceding command will create the necessary static files inside the <kbd>dist</kbd> folder in the application that will be served by the Node.js server, which is in the 8081 port. After the build, we now do not need to run the following command:</p>
<pre><strong>$ npm run dev<br/></strong></pre>
<p>Also, now since we will be running our node server only, the application should be available at the URL <kbd>http://localhost:8081</kbd>.</p>
<p>The preceding command starts our frontend server. We only need to run the Node.js server with the following command:</p>
<pre><strong>$ nodemon server.js</strong></pre>
<p>Since we now only have one port, 8081, we do not need to add the prefix <kbd>/api</kbd> in every backend API like we did earlier, we can get rid of those as well. So, let's update the <kbd>controllers</kbd> and <kbd>vue</kbd> files as well:</p>
<p>Replace the contents in <kbd>controllers/movies.js</kbd>, as follows:</p>
<pre>var Movie = require("../models/Movie");<br/><br/>module.exports.controller = (app) =&gt; {<br/>  // fetch all movies<br/><strong>  app.get("/movies", function(req, res) {</strong><br/>    Movie.find({}, 'name description release_year genre', function <br/>    (error, movies) {<br/>      if (error) { console.log(error); }<br/>       res.send({<br/>        movies: movies<br/>      })<br/>    })<br/>  })<br/><br/>  // add a new movie<br/><strong>  app.post('/movies', (req, res) =&gt; {</strong><br/>    const movie = new Movie({<br/>      name: req.body.name,<br/>      description: req.body.description,<br/>      release_year: req.body.release_year,<br/>      genre: req.body.genre<br/>    })<br/><br/>    movie.save(function (error, movie) {<br/>      if (error) { console.log(error); }<br/>      res.send(movie)<br/>    })<br/>  })<br/>}</pre>
<p>Replace the contents in <kbd>controllers/users.js</kbd>, as follows:</p>
<pre>const User = require("../models/User");<br/>const config = require('./../config/Config');<br/>const passport = require('passport');<br/><br/>module.exports.controller = (app) =&gt; {<br/>  // local strategy<br/>  const LocalStrategy = require('passport-local').Strategy;<br/>  passport.use(new LocalStrategy({<br/>      usernameField: 'email',<br/>      passwordField: 'password'<br/>    },<br/>    function(email, password, done) {<br/>      User.getUserByEmail(email, function(err, user){<br/>        if (err) { return done(err); }<br/>        if (!user) { return done(null, false); }<br/>        User.comparePassword(password, user.password, function(err, <br/>        isMatch){<br/>          if(isMatch) {<br/>            return done(null, user);<br/>          } else {<br/>            return done(null, false);<br/>          }<br/>        })<br/>      });<br/>    }<br/>  ));<br/><br/><strong>  app.post('/users/login',</strong><br/>    passport.authenticate('local', { failureRedirect: '/users/login' }),<br/>    function(req, res) {<br/>      res.redirect('/');<br/>    });<br/><br/>  passport.serializeUser(function(user, done) {<br/>    done(null, user.id);<br/>  });<br/><br/>  passport.deserializeUser(function(id, done) {<br/>    User.findById(id, function(err, user){<br/>      done(err, user)<br/>    })<br/>  });<br/><br/>  // register a user<br/><strong>  app.post('/users/register', (req, res) =&gt; {</strong><br/>    const email = req.body.email;<br/>    const fullname = req.body.fullname;<br/>    const password = req.body.password;<br/>    const role = req.body.role || 'user';<br/>    const newUser = new User({<br/>      email: email,<br/>      fullname: fullname,<br/>      role: role,<br/>      password: password<br/>    })<br/>    User.createUser(newUser, function(error, user) {<br/>      if (error) {<br/>        res.status(422).json({<br/>          message: "Something went wrong. Please try again after some <br/>          time!"<br/>        });<br/>      }<br/>      res.send({ user: user })<br/>    })<br/>  })<br/>}</pre>
<p>Replace the contents of the <kbd>script</kbd> tag of <kbd>AddMovie.vue</kbd> with the following code:</p>
<pre>&lt;script&gt;<br/>import axios from 'axios';<br/><br/>export default {<br/>  data: () =&gt; ({<br/>    valid: true,<br/>    name: '',<br/>    description: '',<br/>    genre: '',<br/>    release_year: '',<br/>    nameRules: [<br/>      v =&gt; !!v || 'Movie name is required',<br/>    ],<br/>    genreRules: [<br/>      v =&gt; !!v || 'Movie genre year is required',<br/>      v =&gt; (v &amp;&amp; v.length &lt;= 80) || 'Genre must be less than equal to <br/>      80 characters.',<br/>    ],<br/>    releaseRules: [<br/>      v =&gt; !!v || 'Movie release year is required',<br/>    ],<br/>    select: null,<br/>    years: [<br/>      '2018',<br/>      '2017',<br/>      '2016',<br/>      '2015',<br/>    ],<br/>  }),<br/>  methods: {<br/>    submit() {<br/>      if (this.$refs.form.validate()) {<br/>        return axios({<br/>          method: 'post',<br/>          data: {<br/>            name: this.name,<br/>            description: this.description,<br/>            release_year: this.release_year,<br/>            genre: this.genre,<br/>          },<br/><strong>          url: '/movies',</strong><br/>          headers: {<br/>            'Content-Type': 'application/json',<br/>          },<br/>        })<br/>          .then(() =&gt; {<br/>            this.$swal(<br/>              'Great!',<br/>              'Movie added successfully!',<br/>              'success',<br/>            );<br/>            this.$router.push({ name: 'Home' });<br/>            this.$refs.form.reset();<br/>          })<br/>          .catch(() =&gt; {<br/>            this.$swal(<br/>              'Oh oo!',<br/>              'Could not add the movie!',<br/>              'error',<br/>            );<br/>          });<br/>      }<br/>      return true;<br/>    },<br/>    clear() {<br/>      this.$refs.form.reset();<br/>    },<br/>  },<br/>};<br/>&lt;/script&gt;</pre>
<p>Replace the contents of the <kbd>script</kbd> tag of <kbd>Home.vue</kbd> with the following code:</p>
<pre>&lt;script&gt;<br/>import axios from 'axios';<br/><br/>export default {<br/>  name: 'Movies',<br/>  data() {<br/>    return {<br/>      movies: [],<br/>    };<br/>  },<br/>  mounted() {<br/>    this.fetchMovies();<br/>  },<br/>  methods: {<br/>    async fetchMovies() {<br/>      return axios({<br/>        method: 'get',<br/><strong>        url: '/movies',</strong><br/>      })<br/>        .then((response) =&gt; {<br/>          this.movies = response.data.movies;<br/>        })<br/>        .catch(() =&gt; {<br/>        });<br/>    },<br/>  },<br/>};<br/>&lt;/script&gt;</pre>
<p>Replace the contents of the <kbd>script</kbd> tag of <kbd>Login.vue</kbd> with the following code:</p>
<pre>&lt;script&gt;<br/>  import axios from 'axios';<br/>  import bus from "./../bus.js";<br/><br/>  export default {<br/>    data: () =&gt; ({<br/>      valid: true,<br/>      email: '',<br/>      password: '',<br/>      emailRules: [<br/>        (v) =&gt; !!v || 'E-mail is required',<br/>        (v) =&gt; /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(v) <br/>        || 'E-mail must be valid'<br/>      ],<br/>      passwordRules: [<br/>        (v) =&gt; !!v || 'Password is required',<br/>      ]<br/>    }),<br/>    methods: {<br/>      async submit () {<br/>        if (this.$refs.form.validate()) {<br/>          return axios({<br/>            method: 'post',<br/>            data: {<br/>              email: this.email,<br/>              password: this.password<br/>            },<br/><strong>            url: '/users/login',</strong><br/>            headers: {<br/>              'Content-Type': 'application/json'<br/>            }<br/>          })<br/>          .then((response) =&gt; {<br/>            localStorage.setItem('jwtToken', response.data.token)<br/>            this.$swal("Good job!", "You are ready to start!", <br/>            "success");<br/>            bus.$emit("refreshUser");<br/>            this.$router.push({ name: 'Home' });<br/>          })<br/>          .catch((error) =&gt; {<br/>            const message = error.response.data.message;<br/>            this.$swal("Oh oo!", `${message}`, "error")<br/>          });<br/>        }<br/>      },<br/>      clear () {<br/>        this.$refs.form.reset()<br/>      }<br/>    }<br/>  }<br/>&lt;/script&gt;</pre>
<p>Replace the contents of the <kbd>script</kbd> tag of <kbd>Register.vue</kbd> with the following code:</p>
<pre>&lt;script&gt;<br/>  import axios from 'axios';<br/>  export default {<br/>    data: () =&gt; ({<br/>      e1: false,<br/>      valid: true,<br/>      fullname: '',<br/>      email: '',<br/>      password: '',<br/>      confirm_password: '',<br/>      fullnameRules: [<br/>        (v) =&gt; !!v || 'Fullname is required'<br/>      ],<br/>      emailRules: [<br/>        (v) =&gt; !!v || 'E-mail is required',<br/>        (v) =&gt; /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(v) <br/>        || 'E-mail must be valid'<br/>      ],<br/>      passwordRules: [<br/>        (v) =&gt; !!v || 'Password is required'<br/>      ]<br/>    }),<br/>    methods: {<br/>      async submit () {<br/>        if (this.$refs.form.validate()) {<br/>          return axios({<br/>            method: 'post',<br/>            data: {<br/>              fullname: this.fullname,<br/>              email: this.email,<br/>              password: this.password<br/>            },<br/><strong>            url: '/users/register',</strong><br/>            headers: {<br/>              'Content-Type': 'application/json'<br/>            }<br/>          })<br/>          .then((response) =&gt; {<br/>            this.$swal(<br/>              'Great!',<br/>              `You have been successfully registered!`,<br/>              'success'<br/>            )<br/>            this.$router.push({ name: 'Home' })<br/>          })<br/>          .catch((error) =&gt; {<br/>            const message = error.response.data.message;<br/>            this.$swal("Oh oo!", `${message}`, "error")<br/>          });<br/>        }<br/>      },<br/>      clear () {<br/>        this.$refs.form.reset()<br/>      }<br/>    }<br/>  }<br/>&lt;/script&gt;</pre>
<p>Finally, we don't need to use the proxy anymore, so we can remove the proxy we set up earlier from <kbd>webpack.dev.conf.js</kbd>.</p>
<p>Replace the contents inside <kbd>devServer</kbd> with the following code:</p>
<pre>devServer: {<br/>    clientLogLevel: 'warning',<br/>    historyApiFallback: {<br/>      rewrites: [<br/>        { from: /.*/, to: path.posix.join(config.dev.assetsPublicPath, <br/>        'index.html') },<br/>      ],<br/>    },<br/>    hot: true,<br/>    contentBase: false, // since we use CopyWebpackPlugin.<br/>    compress: true,<br/>    host: HOST || config.dev.host,<br/>    port: PORT || config.dev.port,<br/>    open: config.dev.autoOpenBrowser,<br/>    overlay: config.dev.errorOverlay<br/>      ? { warnings: false, errors: true }<br/>      : false,<br/>    publicPath: config.dev.assetsPublicPath,<br/>    quiet: true, // necessary for FriendlyErrorsPlugin<br/>    watchOptions: {<br/>      poll: config.dev.poll,<br/>    }<br/>  },</pre>
<p>With these updated, let's build our application once more with the following command:</p>
<pre><strong>$ npm run build</strong></pre>
<p>Our application should work as expected.</p>
<p>Since our application is a <strong>Single Page Application </strong>(<strong>SPA</strong>), when we browse through the nested routes and reload the page, we will get an error. For example, if we browse the <kbd>http://localhost:8081/contact</kbd> page by clicking the link in the home page, it will work. However, if we try to navigate to the <kbd>http://localhost:8081/contact</kbd> page directly, we will get an error because this is an SPA, which means that the browser only renders the static <kbd>index.html</kbd> file. When we try to access the <kbd>/contact</kbd> page, it will look for the page called <kbd>contact</kbd>, which does not exist.</p>
<p>For this, we will need to add a middleware, which acts as a fallback and renders the same <kbd>index.html</kbd> file when we try to reload the page directly or try to access the pages with dynamic IDs.</p>
<p>There is a middleware provided by <kbd>npm</kbd> to serve our purpose. Let's go ahead and install the following package:</p>
<pre><strong>$ npm install connect-history-api-fallback --save</strong></pre>
<p>After the installation, let's modify our <kbd>server.js</kbd> file to use the middleware:</p>
<pre>...<br/>const passport = require('passport');<br/>const serveStatic = require('serve-static');<br/><strong>const history = require('connect-history-api-fallback');</strong><br/>const app = express();<br/>const router = express.Router();<br/><br/>...<br/><br/>// Include controllers<br/>fs.readdirSync("controllers").forEach(function (file) {<br/>  if(file.substr(-3) == ".js") {<br/>    const route = require("./controllers/" + file)<br/>    route.controller(app)<br/>  }<br/>})<br/><strong>app.use(history());</strong><br/>app.use(serveStatic(__dirname + "/dist"));<br/>...</pre>
<p>With these in place, we should now be able to access all the routes directly. We can also reload the pages now.</p>
<p>Since we are building our Vue.js components and running our app solely on the Node.js server, whenever we make a change to the Vue.js components, we will need to build the application again with the <kbd>npm run build</kbd> command.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Passport's Local Strategy</h1>
                
            
            
                
<p>Passport's Local Strategy is easy to integrate. As always, let's start with the installation of this strategy as follows.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Installing Passport's Local Strategy</h1>
                
            
            
                
<p>We can install passport's Local Strategy by running the following command:</p>
<pre><strong>$ npm install passport-local --save</strong></pre>
<p class="mce-root">The following code should add the package to your package.json file:</p>
<pre>...<br/>"node-sass": "^4.7.2",<br/>"nodemon": "^1.14.10",<br/>"passport": "^0.4.0",<br/><strong>"passport-local": "^1.0.0",</strong><br/>...</pre>


            

            
        
    

        

                            
                    <h1 class="header-title">Configuring Passport's Local Strategy</h1>
                
            
            
                
<p class="mce-root">There are a few steps to configure the Passport's Local Strategy. We will discuss each step in detail:</p>
<ol>
<li>Add necessary routes for Local authentication.</li>
<li>Add a middleware method to check whether authentication is successful.</li>
</ol>
<p class="mce-root">Let's dive into the details for each of the preceding steps.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Adding necessary routes for Local Authentication</h1>
                
            
            
                
<p class="mce-root">Let's go ahead and add the necessary routes when we click on the login button. Replace the contents of <kbd>controllers/users.js</kbd> with the following code:</p>
<pre>const User = require('../models/User.js');<br/>const passport = require('passport');<br/><strong>const LocalStrategy = require('passport-local').Strategy;</strong><br/><br/>module.exports.controller = (app) =&gt; {<br/><strong>// local strategy</strong><br/><strong>  passport.use(new LocalStrategy({</strong><br/><strong>    usernameField: 'email',</strong><br/><strong>    passwordField: 'password',</strong><br/><strong>  }, (email, password, done) =&gt; {</strong><br/><strong>    User.getUserByEmail(email, (err, user) =&gt; {</strong><br/><strong>      if (err) { return done(err); }</strong><br/><strong>      if (!user) { return done(null, false); }</strong><br/><strong>      User.comparePassword(password, user.password, (error, isMatch) =&gt; {</strong><br/><strong>        if (isMatch) {</strong><br/><strong>          return done(null, user);</strong><br/><strong>        }</strong><br/><strong>        return done(null, false);</strong><br/><strong>      });</strong><br/><strong>      return true;</strong><br/><strong>    });</strong><br/><strong>  }));</strong><br/><br/><strong>// user login</strong><br/><strong>  app.post('/users/login',</strong><br/><strong>    passport.authenticate('local', { failureRedirect: '/users/login' }),</strong><br/><strong>    (req, res) =&gt; {</strong><br/><strong>      res.redirect('/');</strong><br/><strong>    });</strong><br/><br/><strong>  passport.serializeUser((user, done) =&gt; {</strong><br/><strong>    done(null, user.id);</strong><br/><strong>  });</strong><br/><br/><strong>  passport.deserializeUser((id, done) =&gt; {</strong><br/><strong>    User.findById(id, (err, user) =&gt; {</strong><br/><strong>      done(err, user);</strong><br/><strong>    });</strong><br/><strong>  });</strong><br/><br/>  // register a user<br/>  app.post('/users/register', (req, res) =&gt; {<br/>    const name = req.body.name;<br/>    const email = req.body.email;<br/>    const password = req.body.password;<br/>    const newUser = new User({<br/>      name,<br/>      email,<br/>      password,<br/>    });<br/>    User.createUser(newUser, (error, user) =&gt; {<br/>      if (error) {<br/>        res.status(422).json({<br/>          message: 'Something went wrong. Please try again after some time!',<br/>        });<br/>      }<br/>      res.send({ user });<br/>    });<br/>  });<br/>};</pre>
<p>Here, we have added a route for users login as <kbd>/users/login</kbd> which then uses <kbd>passport.js</kbd> local authentication mechanism to log in the user to the app.</p>
<p class="mce-root">Also, we configured <kbd>passport.js</kbd> to use LocalStrategy when user logs in which takes the <kbd>username</kbd> and <kbd>password</kbd> of the user.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Installing express-session</h1>
                
            
            
                
<p class="mce-root">The next thing we need to do is setup a <kbd>session</kbd> so that when a user successfully logs in, the <kbd>user</kbd> data can be stored in the <kbd>session</kbd> and can be retrieved easily when we make other requests. For this, we need to add a package called <kbd>express-session</kbd>. Let's go ahead and install the package with the following command:</p>
<pre><strong>$ npm install express-session --save</strong></pre>


            

            
        
    

        

                            
                    <h1 class="header-title">Configuring express-session</h1>
                
            
            
                
<p class="mce-root">Now, that we have the package, let's configure this package to fulfill our needs to save the user in the <kbd>session</kbd>.  Add the following lines of code in it.</p>
<p>If <kbd>username</kbd> and <kbd>password</kbd> matches, the user object is saved in the session in the server and can be access via <kbd>req.user</kbd> in every request.</p>
<p>Also, let's updated our vue files as well since we do not need the passport JWT strategy now.</p>
<p>Update the contents in <kbd>server.js</kbd> with the following code:</p>
<pre>const express = require('express');<br/>const bodyParser = require('body-parser');<br/>const mongoose = require('mongoose');<br/>const cors = require('cors');<br/>const morgan = require('morgan');<br/>const fs = require('fs');<br/><strong>const session = require('express-session');</strong><br/>const config = require('./config/Config');<br/>const passport = require('passport');<br/>const serveStatic = require('serve-static');<br/>const history = require('connect-history-api-fallback');<br/><br/>const app = express();<br/>const router = express.Router();<br/>app.use(morgan('combined'));<br/>app.use(bodyParser.json());<br/>app.use(cors());<br/><br/><strong>app.use(session({</strong><br/><strong>  secret: config.SECRET,</strong><br/><strong>  resave: true,</strong><br/><strong>  saveUninitialized: true,</strong><br/><strong>  cookie: { httpOnly: false }</strong><br/><strong>}))</strong><br/>app.use(passport.initialize());<br/><strong>app.use(passport.session());</strong><br/><br/>//connect to mongodb<br/>mongoose.connect(<strong>config.DB</strong>, function() {<br/>  console.log('Connection has been made');<br/>})<br/>.catch(err =&gt; {<br/>  console.error('App starting error:', err.stack);<br/>  process.exit(1);<br/>});<br/><br/>// Include controllers<br/>fs.readdirSync("controllers").forEach(function (file) {<br/>  if(file.substr(-3) == '.js') {<br/>    const route = require('./controllers/' + file);<br/>    route.controller(app);<br/>  }<br/>})<br/>app.use(history());<br/>app.use(serveStatic(__dirname + "/dist"));<br/><br/><strong>router.get('/api/current_user', isLoggedIn, function(req, res) {</strong><br/><strong>  if(req.user) {</strong><br/><strong>    res.send({ current_user: req.user })</strong><br/><strong>  } else {</strong><br/><strong>    res.status(403).send({ success: false, msg: 'Unauthorized.' });</strong><br/><strong>  }</strong><br/><strong>})</strong><br/><br/><strong>function isLoggedIn(req, res, next) {</strong><br/><strong>  if (req.isAuthenticated())</strong><br/><strong>    return next();</strong><br/><br/><strong>  res.redirect('/');</strong><br/><strong>  console.log('error! auth failed')</strong><br/><strong>}</strong><br/><br/><strong>router.get('/api/logout', function(req, res){</strong><br/><strong>  req.logout();</strong><br/><strong>  res.send();</strong><br/><strong>});</strong><br/><br/>router.get('/', function(req, res) {<br/>  res.json({ message: 'API Initialized!'});<br/>});<br/><br/>const port = process.env.API_PORT || 8081;<br/>app.use('/', router);<br/>var server = app.listen(port, function() {<br/>  console.log(`api running on port ${port}`);<br/>});<br/><br/>module.exports = server</pre>
<p>Here, we added the configuration for express-session with the following code block:</p>
<pre><strong>app.use(session({</strong><br/><strong>  secret: config.SECRET,</strong><br/><strong>  resave: true,</strong><br/><strong>  saveUninitialized: true,</strong><br/><strong>  cookie: { httpOnly: false }</strong><br/><strong>}))</strong><br/>app.use(passport.initialize());<br/><strong>app.use(passport.session());</strong></pre>
<p>The above code blocks uses a secret token required to save the user details. We will be defining the token in a separate file so that all of our configuration token reside in a single place.</p>
<p>So, let's go ahead and create a file called <kbd>Config.js</kbd> inside the <kbd>config</kbd> directory and the following lines of code:</p>
<pre><strong>module.exports = {</strong><br/><strong>  DB: 'mongodb://localhost/movie_rating_app',</strong><br/><strong>  SECRET: 'movieratingappsecretkey'</strong><br/><strong>}</strong></pre>
<p>We also added a <kbd>GET</kbd> route called <kbd>/api/current_user</kbd> to fetch the current logged in user details. This api uses a middleware method called <kbd>isLoggedIn</kbd> which checks if the user's data is on the session or not. And if the user's data exists in the session, the current user details is sent back as the response.</p>
<p>Another endpoint which we added is the <kbd>/logout</kbd> which simply logs out the user and destroys the session.</p>
<p>Hence, with this configuration, now we should be able to log in successfully using the <kbd>passport.js</kbd> Local Strategy.</p>
<p>The only problem that we have now is  there is no way to know if the user successfully logged in or not. For that we need to display some user's information such as <kbd>email</kbd> to indicate the logged in user.</p>
<p>For this, we need to pass the user's information from <kbd>Login.vue</kbd> to <kbd>App.vue</kbd> so that we can display the user's email in the top bar. We can use a method called <kbd>emit</kbd> provided by <kbd>Vue</kbd> which is used to pass the information between the <kbd>Vue</kbd> components. Let's go ahead and configure that.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Configuring emit method</h1>
                
            
            
                
<p>Let's first create a transmitter which can communicate between the different Vue components. Create a file called <kbd>bus.js</kbd> inside <kbd>src</kbd> directory and add the following contents:</p>
<pre><strong>import Vue from 'vue';</strong><br/><br/><strong>const bus = new Vue();</strong><br/><br/><strong>export default bus;</strong></pre>
<p>Now, replace the contents inside <kbd>script</kbd> tag of <kbd>Login.vue</kbd> with the following code:</p>
<pre>...<br/>&lt;script&gt;<br/>import axios from 'axios';<br/>import bus from './../bus';<br/><br/>export default {<br/>  data: () =&gt; ({<br/>    valid: true,<br/>    email: '',<br/>    password: '',<br/>    emailRules: [<br/>      v =&gt; !!v || 'E-mail is required',<br/>      v =&gt; /\S+@\S+\.\S+/.test(v) || 'E-mail must be valid',<br/>    ],<br/>  }),<br/>  methods: {<br/>    async submit() {<br/>      return axios({<br/>        method: 'post',<br/>        data: {<br/>          email: this.email,<br/>          password: this.password,<br/>        },<br/>        url: 'http://localhost:8081/users/login',<br/>        headers: {<br/>          'Content-Type': 'application/json',<br/>        },<br/>      })<br/>        .then(() =&gt; {<br/>          this.$swal('Great!', 'You are ready to start!', 'success');<br/>          <strong>bus.$emit('refreshUser');</strong><br/>          this.$router.push({ name: 'Home' });<br/>        })<br/>        .catch((error) =&gt; {<br/>          const message = error.response.data.message;<br/>          this.$swal('Oh oo!', `${message}`, 'error');<br/>          this.$router.push({ name: 'Login' });<br/>        });<br/>    },<br/>    clear() {<br/>      this.$refs.form.reset();<br/>    },<br/>  },<br/>};<br/>&lt;/script&gt;</pre>
<p>Here we are emitting a method called <kbd>refreshUser</kbd> which will be defined in the App.vue. Replace the contents inside <kbd>App.vue</kbd> with the following code:</p>
<pre>&lt;template&gt;<br/>  &lt;v-app id="inspire"&gt;<br/>    &lt;v-navigation-drawer<br/>      fixed<br/>      v-model="drawer"<br/>      app<br/>    &gt;<br/>      &lt;v-list dense&gt;<br/>        &lt;router-link v-bind:to="{ name: 'Home' }" class="side_bar_link"&gt;<br/>          &lt;v-list-tile&gt;<br/>            &lt;v-list-tile-action&gt;<br/>              &lt;v-icon&gt;home&lt;/v-icon&gt;<br/>            &lt;/v-list-tile-action&gt;<br/>            &lt;v-list-tile-content&gt;Home&lt;/v-list-tile-content&gt;<br/>          &lt;/v-list-tile&gt;<br/>        &lt;/router-link&gt;<br/>        &lt;router-link v-bind:to="{ name: 'Contact' }" class="side_bar_link"&gt;<br/>          &lt;v-list-tile&gt;<br/>            &lt;v-list-tile-action&gt;<br/>              &lt;v-icon&gt;contact_mail&lt;/v-icon&gt;<br/>            &lt;/v-list-tile-action&gt;<br/>            &lt;v-list-tile-content&gt;Contact&lt;/v-list-tile-content&gt;<br/>          &lt;/v-list-tile&gt;<br/>        &lt;/router-link&gt;<br/>      &lt;/v-list&gt;<br/>    &lt;/v-navigation-drawer&gt;<br/>    &lt;v-toolbar color="indigo" dark fixed app&gt;<br/>      &lt;v-toolbar-side-icon @click.stop="drawer = !drawer"&gt;&lt;/v-toolbar-side-icon&gt;<br/>      &lt;v-toolbar-title&gt;Home&lt;/v-toolbar-title&gt;<br/>      &lt;v-spacer&gt;&lt;/v-spacer&gt;<br/>      <strong>&lt;v-toolbar-items class="hidden-sm-and-down"&gt;</strong><br/><strong>        &lt;v-btn id="add_movie_link" flat v-bind:to="{ name: 'AddMovie' }"</strong><br/><strong>          v-if="current_user"&gt;</strong><br/><strong>          Add Movie</strong><br/><strong>        &lt;/v-btn&gt;</strong><br/><strong>        &lt;v-btn id="user_email" flat v-if="current_user"&gt;{{ current_user.email }}&lt;/v-btn&gt;</strong><br/><strong>        &lt;v-btn flat v-bind:to="{ name: 'Register' }" v-if="!current_user" id="register_btn"&gt;</strong><br/><strong>          Register</strong><br/><strong>        &lt;/v-btn&gt;</strong><br/><strong>        &lt;v-btn flat v-bind:to="{ name: 'Login' }" v-if="!current_user" id="login_btn"&gt;Login&lt;/v-btn&gt;</strong><br/><strong>        &lt;v-btn id="logout_btn" flat v-if="current_user" @click="logout"&gt;Logout&lt;/v-btn&gt;</strong><br/><strong>      &lt;/v-toolbar-items&gt;</strong><br/>    &lt;/v-toolbar&gt;<br/>    &lt;v-content&gt;<br/>      &lt;v-container fluid&gt;<br/>        &lt;div id="app"&gt;<br/>          &lt;router-view/&gt;<br/>        &lt;/div&gt;<br/>      &lt;/v-container&gt;<br/>    &lt;/v-content&gt;<br/>    &lt;v-footer color="indigo" app&gt;<br/>      &lt;span class="white--text"&gt;&amp;copy; 2018&lt;/span&gt;<br/>    &lt;/v-footer&gt;<br/>  &lt;/v-app&gt;<br/>&lt;/template&gt;<br/><br/>&lt;script&gt;<br/>import axios from 'axios';<br/><br/>import './assets/stylesheets/main.css';<br/><strong>import bus from './bus';</strong><br/><br/>export default {<br/>  data: () =&gt; ({<br/>    drawer: null,<br/>    <strong>current_user: null,</strong><br/>  }),<br/>  props: {<br/>    source: String,<br/>  },<br/>  <strong>mounted() {</strong><br/><strong>    this.fetchUser();</strong><br/><strong>    this.listenToEvents();</strong><br/><strong>  },</strong><br/>  methods: {<br/>    <strong>listenToEvents() {</strong><br/><strong>      bus.$on('refreshUser', () =&gt; {</strong><br/><strong>        this.fetchUser();</strong><br/><strong>      });</strong><br/><strong>    },</strong><br/><strong>    async fetchUser() {</strong><br/><strong>      return axios({</strong><br/><strong>        method: 'get',</strong><br/><strong>        url: '/api/current_user',</strong><br/><strong>      })</strong><br/><strong>        .then((response) =&gt; {</strong><br/><strong>          this.current_user = response.data.current_user;</strong><br/><strong>        })</strong><br/><strong>        .catch(() =&gt; {</strong><br/><strong>        });</strong><br/><strong>    },</strong><br/>    <strong>logout() {</strong><br/><strong>      return axios({</strong><br/><strong>        method: 'get',</strong><br/><strong>        url: '/api/logout',</strong><br/><strong>      })</strong><br/><strong>        .then(() =&gt; {</strong><br/><strong>          bus.$emit('refreshUser');</strong><br/><strong>          this.$router.push({ name: 'Home' });</strong><br/><strong>        })</strong><br/><strong>        .catch(() =&gt; {</strong><br/><strong>        });</strong><br/><strong>    },</strong><br/>  },<br/>};<br/>&lt;/script&gt;</pre>
<p>Here we have added the method called <kbd>refreshUser</kbd> which is being listened by <kbd>App.vue</kbd> in the mounted method. Whenever a user logs in to the app, the method called <kbd>refreshUser</kbd> in <kbd>App.vue</kbd> gets called and fetches the logged in user's information.</p>
<p>Also, we are displaying the user's email in the top bar so that we can know if the user is logged in or not.</p>
<p>Also, let's remove the JWT authentication from movies controller as well. Replace the contents in <kbd>controllers/movies.js</kbd> with the following code:</p>
<pre>const MovieSchema = require('../models/Movie.js');<br/>const Rating = require('../models/Rating.js');<br/><br/>module.exports.controller = (app) =&gt; {<br/>  // fetch all movies<br/>  <strong>app.get('/movies', (req, res) =&gt; {</strong><br/>    MovieSchema.find({}, 'name description release_year genre', (error, movies) =&gt; {<br/>      if (error) { console.log(error); }<br/>      res.send({<br/>        movies,<br/>      });<br/>    });<br/>  });<br/><br/>  // fetch a single movie<br/>  <strong>app.get('/api/movies/:id', (req, res) =&gt; {</strong><br/>    MovieSchema.findById(req.params.id, 'name description release_year genre', (error, movie) =&gt; {<br/>      if (error) { console.error(error); }<br/>      res.send(movie);<br/>    });<br/>  });<br/><br/>  // rate a movie<br/>  app.post('/movies/rate/:id', (req, res) =&gt; {<br/>    const newRating = new Rating({<br/>      movie_id: req.params.id,<br/>      user_id: req.body.user_id,<br/>      rate: req.body.rate,<br/>    });<br/><br/>    newRating.save((error, rating) =&gt; {<br/>      if (error) { console.log(error); }<br/>      res.send({<br/>        movie_id: rating.movie_id,<br/>        user_id: rating.user_id,<br/>        rate: rating.rate,<br/>      });<br/>    });<br/>  });<br/><br/>  // add a new movie<br/>  app.post('/movies', (req, res) =&gt; {<br/>    const newMovie = new MovieSchema({<br/>      name: req.body.name,<br/>      description: req.body.description,<br/>      release_year: req.body.release_year,<br/>      genre: req.body.genre,<br/>    });<br/><br/>    newMovie.save((error, movie) =&gt; {<br/>      if (error) { console.log(error); }<br/>      res.send(movie);<br/>    });<br/>  });<br/>};</pre>
<p>With this, we should be able to view the following screen when a user logs in to the app:</p>
<div><img src="img/2a7fa817-15de-4d8c-acf8-5d78928920ff.png"/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Summary</h1>
                
            
            
                
<p>In this chapter, we covered <kbd>passport.js</kbd> and how it works. We also covered how to use a simple JWT strategy with a MEVN application and handle register and login for users.</p>
<p>In the next chapter, we will dig into different <kbd>passport.js</kbd> strategies, such as the Facebook strategy, the Google strategy, and the Twitter strategy.</p>


            

            
        
    </body></html>