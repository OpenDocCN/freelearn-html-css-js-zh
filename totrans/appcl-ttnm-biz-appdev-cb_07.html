<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Threads, Queues, and Message Passing</h1></div></div></div><p>In this chapter we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Queuing multiple downloads</li><li class="listitem" style="list-style-type: disc">Launching one app from another</li><li class="listitem" style="list-style-type: disc">Cross-platform URL schemes</li><li class="listitem" style="list-style-type: disc">Opening your Android app on BOOT_COMPLETED</li><li class="listitem" style="list-style-type: disc">iOS multithreading using Web Workers</li></ul></div><div><div><div><div><h1 class="title"><a id="ch07lvl1sec47"/>Introduction</h1></div></div></div><p>Size, complexity, and volume are common issues encountered in developing and maintaining enterprise apps. Titanium provides support for several common patterns used to separate operational responsibility patterns.</p><p>This chapter discusses how to use message passing, queuing, and multithreaded capabilities in Titanium. These step-by-step recipes can then be used to incorporate these design principles into your existing Titanium enterprise application.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec48"/>Queuing multiple downloads</h1></div></div></div><p>It is commonplace for <a id="id623" class="indexterm"/>enterprise apps to require the need to download documents and content from your organization's file servers. Use of queuing is helpful in this scenario to ensure order and delivery while avoiding pitfalls often associated with spawning multiple asynchronous requests. This recipe uses <a id="id624" class="indexterm"/>the <code class="literal">Ti.Queue</code> CommonJS module to create a persistent, named queue to perform file downloads.</p><p>To demonstrate how to implement a persistent queue, this recipe will download to your device 5 MB sample files from Github. The following screenshots illustrate what this recipe looks like while running on both the iPhone and Android devices.</p><div><img src="img/5343_07_01.jpg" alt="Queuing multiple downloads"/></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec101"/>Getting ready</h2></div></div></div><p>This recipe <a id="id625" class="indexterm"/>uses the <code class="literal">Ti.Queue</code> CommonJS module. This module and other code assets can be downloaded from the source provided by the book, or individually through the links provided in the <em>See also</em> section at the end of this recipe. Installing these in your project is straightforward. Simply copy the <code class="literal">Ti.Queue.js</code> file<a id="id626" class="indexterm"/> into your project as shown in the following screenshot:</p><div><img src="img/5343_07_02.jpg" alt="Getting ready"/></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec183"/>Network connection</h3></div></div></div><p>This recipe requires a network connection<a id="id627" class="indexterm"/> to download files from Github. Please make sure the device or simulator has proper network connectivity.</p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec102"/>How to do it...</h2></div></div></div><p>Once you have added the <code class="literal">Ti.Queue</code> module to your project, you need to create your application namespace in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the module into your code as the following code snippet demonstrates:</p><div><pre class="programlisting">//Create our application namespace
var my = {
  qMod : require('Ti.Queue'),
  jobInfo:{total:0,completed:0}
};</pre></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec184"/>Creating the recipe's UI</h3></div></div></div><p>The following steps <a id="id628" class="indexterm"/>outline how to create the UI used in this recipe:</p><div><ol class="orderedlist arabic"><li class="listitem">First, a <code class="literal">Ti.UI.Window</code> is created to attach all UI elements.<div><pre class="programlisting">var win = Ti.UI.createWindow({
  backgroundColor: '#fff', title: 'Download Queue', 
  barColor:'#000',layout:'vertical',fullscreen:false
});</pre></div></li><li class="listitem">Next, a <code class="literal">Ti.UI.ProgressBar</code> is added to the <code class="literal">Ti.UI.Window</code>. This will be used to display the status of the queue.<div><pre class="programlisting">var progress = Ti.UI.createProgressBar({
  top:30, height:50,min:0,max:3, value:0, left:10, 
  right:10, message:'Tap button to start download'
});
win.add(progress);</pre></div></li><li class="listitem">The <code class="literal">show</code> method is called immediately on our <code class="literal">Ti.UI.ProgressBar</code> so that it will be displayed on the <code class="literal">Ti.UI.Window</code> correctly.<div><pre class="programlisting">progress.show();</pre></div></li><li class="listitem">Next, <a id="id629" class="indexterm"/>a <code class="literal">Ti.UI.Button</code> is added to the <code class="literal">Ti.UI.Window</code>. This control will be used to trigger the queue download logic.<div><pre class="programlisting">var downloadButton = Ti.UI.createButton({
  title:'Run Download Queue', top:40,
  left:10, right:10, height:50, 
});
win.add(downloadButton);</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec185"/>Creating a queue</h3></div></div></div><p>The next step in the<a id="id630" class="indexterm"/> recipe is to create a named queue as demonstrated in the following code snippet. By default, any named queue is persistent and will store all jobs between sessions.</p><div><pre class="programlisting">//Create a new version of the queue
var queue = new my.qMod("demo");</pre></div><div><div><h3 class="title"><a id="note12"/>Note</h3><p>If a name is not provided when creating a new queue, the queue will not save jobs between app restarts.</p></div></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec186"/>Adding jobs to the queue</h3></div></div></div><p>After the queue has been <a id="id631" class="indexterm"/>created, the next step is to create a series of jobs for the queue to manage. The following code block creates three download jobs for the queue to manage.</p><div><ol class="orderedlist arabic"><li class="listitem">The first job is created to download a ZIP file from Github. A timestamp is used to provide a unique name.<div><pre class="programlisting">var sample1Name = new Date().getTime();
queue.enqueue({
  title:'Sample ' + sample1Name,
  url:"https://github.com/benbahrenburg/
  Ti.Queue/blob/master/5MB.zip",
  downloadPath:Ti.Filesystem.applicationDataDirectory + 
  sample1Name + '.zip',
  attempts:0
});</pre></div></li><li class="listitem">Again, a second job is created to download a ZIP file from Github. A timestamp is used to provide a unique name.<div><pre class="programlisting">var sample2Name = new Date().getTime();
queue.enqueue({
  title:'Sample ' + sample2Name,
  url:"https://github.com/benbahrenburg/
  Ti.Queue/blob/master/5MB.zip",
  downloadPath:Ti.Filesystem.applicationDataDirectory + 
  sample2Name + '.zip',
  attempts:0
});</pre></div></li><li class="listitem">Again, a third job is created to download a ZIP file from Github. A timestamp is used to provide a unique name.<div><pre class="programlisting">var sample3Name = new Date().getTime();
queue.enqueue({
  title:'Sample ' + sample3Name,
  url:"https://github.com/benbahrenburg/
  Ti.Queue/blob/master/5MB.zip",
  downloadPath:Ti.Filesystem.applicationDataDirectory + 
  sample3Name + '.zip',
  attempts:0
});</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec187"/>Recipe's assistant functions</h3></div></div></div><p>The <code class="literal">assist</code> object is<a id="id632" class="indexterm"/> used to manage the download process. The following is a discussion on how the <code class="literal">assist</code> object works and can be leveraged within your app:</p><div><pre class="programlisting">var assist = {</pre></div><div><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">progressSetup</code> method<a id="id633" class="indexterm"/> is used to restart the progress bar when a new download system has been initialized.<div><pre class="programlisting">  progressSetup : function(min,max){
    progress.min = min;
    progress.max = max;
    progress.value = 0;
    progress.message = 'Starting download';
    downloadButton.title = "Downloading... please wait";
  },</pre></div></li><li class="listitem">The <code class="literal">updateProcess</code> method<a id="id634" class="indexterm"/> is used to update the progress bar information and alert the user to the status of the overall download job.<div><pre class="programlisting">  updateProgress : function(value,text){
    progress.value = value;
    progress.message = text;
  },</pre></div></li><li class="listitem">The <code class="literal">whenFinished</code> method<a id="id635" class="indexterm"/> is called after all <code class="literal">Ti.Queue</code> jobs have finished or generated errors. This method is used to update UI to alert the user about the queued job which has been processed.<div><pre class="programlisting">  whenFinish : function(){
    downloadButton.text = "Tap button to start download";
    alert('Finished Download');
    downloadButton.enabled = true;
  },</pre></div></li><li class="listitem">The <code class="literal">next</code> method<a id="id636" class="indexterm"/> is used to process the next job in the <code class="literal">Ti.Queue</code>.<div><pre class="programlisting">  next : function(){</pre></div></li><li class="listitem">This step in the <code class="literal">next</code> method is to check if there are any jobs available. This is done by calling the <code class="literal">getLength</code> method<a id="id637" class="indexterm"/> on the queue to retrieve the number of jobs currently stored in the queue.<div><pre class="programlisting">    if(queue.getLength() == 0){</pre></div></li><li class="listitem">If there are no jobs remaining in the queue, the <code class="literal">whenFinish</code> method<a id="id638" class="indexterm"/> is called and the download process is exited.<div><pre class="programlisting">      assist.updateProgress(my.jobInfo.total,
      'Download Completed');
      assist.whenFinish();
      return;
    }</pre></div></li><li class="listitem">If a job is <a id="id639" class="indexterm"/>available in the queue, the next step is to update the <code class="literal">progressValue</code> to show the current processing status as shown in the following code snippet.<div><pre class="programlisting">    var progressValue = 
    (my.jobInfo.total - queue.getLength());</pre></div></li><li class="listitem">The next step is to call the <code class="literal">peek</code> method<a id="id640" class="indexterm"/> on the queue. This allows us to fetch the next item in the queue without popping it from the queue itself. This is used to write the information to the Titanium Studio console for debugging purposes.<div><pre class="programlisting">    var pkItem = queue.peek();
    Ti.API.info('Peek value: ' + JSON.stringify(pkItem));</pre></div></li><li class="listitem">The next step is to call the <code class="literal">dequeue</code> method on the queue. This function pops the next item from the queue and returns the item. In the following code snippet, the <code class="literal">dequeue</code> method<a id="id641" class="indexterm"/> is called to provide the next queue job to the <code class="literal">item</code> variable.<div><pre class="programlisting">    var item = queue.dequeue();</pre></div></li><li class="listitem">The <code class="literal">updateProgress</code> method<a id="id642" class="indexterm"/> is then called to alert the user to the download progress.<div><pre class="programlisting">    assist.updateProgress(progressValue,'Downloading ' +
    item.title);</pre></div></li><li class="listitem">Next the <code class="literal">download</code> method<a id="id643" class="indexterm"/> is called to start the download process. To create a recursive function, the <code class="literal">next</code> method is provided as a callback argument to the <code class="literal">download</code> method. <div><pre class="programlisting">    assist.download(item,assist.next);

  },</pre></div></li><li class="listitem">The <code class="literal">download</code> method contains all logic needed to download the queued job from Github.<div><pre class="programlisting">  download :function(item,callback){</pre></div></li><li class="listitem">The first step in downloading the file from Github is to create <code class="literal">Ti.Network.HTTPClient</code>.<div><pre class="programlisting">    var done = false;
    var xhr = Ti.Network.createHTTPClient();
    xhr.setTimeout(10000);</pre></div></li><li class="listitem">The <code class="literal">onload</code> callback is fired when the <code class="literal">Ti.Network.HTTPClient</code> receives a successful response.<div><pre class="programlisting">    xhr.onload = function(e){
      if (this.readyState == 4 &amp;&amp; !done) {
        done=true;</pre></div></li><li class="listitem">If the <a id="id644" class="indexterm"/>response does not provide a <code class="literal">200</code> status code, an error is generated.<div><pre class="programlisting">        if(this.status!==200){
          throw('Invalid http reply status code:' + 
          this.status);
          return;
        }</pre></div></li><li class="listitem">If the proper status code is returned, a <code class="literal">Ti.Filesytem</code> object is then created and the <code class="literal">responseData</code> is saved to the provided output path.<div><pre class="programlisting">        var saveToFile =
        Ti.Filesystem.getFile(item.downloadPath);
        if(saveToFile.exists()){
          saveToFile.deleteFile();
        }
        saveToFile.write(this.responseData);
        saveToFile = null;</pre></div></li><li class="listitem">After the <code class="literal">responseData</code> has been persisted to the filesystem, the callback method is triggered. This allows for the recipe to recursively loop through the queue.<div><pre class="programlisting">        callback();
      }
    };</pre></div></li><li class="listitem">The <code class="literal">onerror</code> callback is triggered when the <code class="literal">Ti.Network.HTTPClient</code> receives an error.<div><pre class="programlisting">    xhr.onerror = function(e){</pre></div></li><li class="listitem">When an error is received, the provided job is requeued for another attempt, by calling the <code class="literal">requeue</code> method<a id="id645" class="indexterm"/> on the <code class="literal">assist</code> object.<div><pre class="programlisting">      assist.requeue(item,callback)
    };</pre></div></li><li class="listitem">The download progress is started by calling the <code class="literal">open</code> and <code class="literal">send</code> methods on the <code class="literal">Ti.Network.HTTPClient</code> using the queue item's <code class="literal">url</code> details as demonstrated in the following code snippet:<div><pre class="programlisting">    xhr.open('GET', item.url);
    xhr.send();
  },</pre></div></li><li class="listitem">The <code class="literal">requeue</code> method is used to add an item back into the queue. The recipe is designed to provide three attempts at downloading before the job is considered a permanent error.<div><pre class="programlisting">  requeue :function(item,callback){
    Ti.API.info('requeue is called on download fail.'); 
    Ti.API.info('Allowed to retry 3 times');</pre></div></li><li class="listitem">The item's <code class="literal">attempt</code> property is checked to determine if the job has been attempted more than three times.<div><pre class="programlisting">    if(item.attempts &gt; 3){</pre></div></li><li class="listitem">If the <a id="id646" class="indexterm"/>job has been attempted more than three times, the item is not readded to the queue.<div><pre class="programlisting">      Ti.API.info('Max removed from queue.')
    }else{</pre></div></li><li class="listitem">If the job has errored, less than three times, the <code class="literal">attempts</code> property is incremented and the item is added to the queue again.<div><pre class="programlisting">      item.attempts++; 
      queue.enqueue(item);
    }</pre></div></li><li class="listitem">Finally the <code class="literal">callback</code> method<a id="id647" class="indexterm"/> is fired, moving the download process to the next step in its lifecycle.<div><pre class="programlisting">    callback();
  }
};</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec188"/>Start downloading</h3></div></div></div><p>When the <code class="literal">downloadButton</code> is pressed<a id="id648" class="indexterm"/> the recipe begins to process the queued jobs.</p><div><pre class="programlisting">downloadButton.addEventListener('click',function(e){</pre></div><div><ol class="orderedlist arabic"><li class="listitem">The first step in the download process is to check if the recipe has a network connection. If the network is not available, the recipe will alert the user to exit the process.<div><pre class="programlisting">  if(!Ti.Network.online){
    alert('This recipe requires a network');
    return;
  }</pre></div></li><li class="listitem">The next step in the download process is to disable the <code class="literal">downloadButton</code>. This avoids the user from processing the button again, once the job has started.<div><pre class="programlisting">  downloadButton.enabled = false;</pre></div></li><li class="listitem">The <code class="literal">my.jobInfo</code> object is then updated with the current count and status information. This will be used to track the overall download status.<div><pre class="programlisting">  my.jobInfo.total = queue.getLength();
  my.jobInfo.completed = 0;</pre></div></li><li class="listitem">Next the <code class="literal">processSetup</code> method is called to initialize the <code class="literal">Ti.UI.ProgressBar</code> with the correct <code class="literal">min</code> and <code class="literal">max</code> values.<div><pre class="programlisting">  assist.progressSetup(my.jobInfo.completed,
  my.jobInfo.total);</pre></div></li><li class="listitem">Finally, the <code class="literal">next</code> method is called on the <code class="literal">assist</code> object. This begins the download process and creates a recursive loop that will run until the queue is empty.<div><pre class="programlisting">  assist.next();

});</pre></div></li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec103"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To learn more about the <code class="literal">Ti.Queue</code> module<a id="id649" class="indexterm"/> used in this recipe, please visit <a class="ulink" href="https://github.com/benbahrenburg/Ti.Queue">https://github.com/benbahrenburg/Ti.Queue</a>.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec49"/>Launching one app from another</h1></div></div></div><p>A majority of mobile enterprise apps are designed around a specific task such as time reporting<a id="id650" class="indexterm"/>. Through the use of URL schemes or Android intent filters you can open and communicate between different apps on the user's device. For example, you can provide an option for your organization's time-reporting app to open the expense app when an employee is traveling and needs to record additional information.</p><p>This recipe <a id="id651" class="indexterm"/>demonstrates how to launch different apps using the native platform's integration pattern. The following screenshot illustrates this recipe running on both an iOS and Android device:</p><p>.</p><div><img src="img/5343_07_03.jpg" alt="Launching one app from another"/></div><p>
</p><div><div><h3 class="title"><a id="note13"/>Note</h3><p>This recipe must be run on a device to fully experience all features. A device is required as the simulator or emulator do not allow apps from the different app stores to be run.</p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec104"/>Getting ready</h2></div></div></div><p>This recipe uses the<a id="id652" class="indexterm"/> <code class="literal">schemeList</code> CommonJS module. This module and other code assets can be downloaded from the source provided by the book. Installing these in your project is straightforward. Simply copy the <code class="literal">schemeList.js</code> file<a id="id653" class="indexterm"/> into your project as shown in the following screenshot:</p><div><img src="img/5343_07_04.jpg" alt="Getting ready"/></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec189"/>Network connection</h3></div></div></div><p>This recipe requires<a id="id654" class="indexterm"/> that the following apps are installed on your device:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">LinkedIn</li><li class="listitem" style="list-style-type: disc">Evernote</li><li class="listitem" style="list-style-type: disc">Google Maps (on iOS and Android)</li><li class="listitem" style="list-style-type: disc">The URL Scheme example recipe discussed later in this chapter</li></ul></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec105"/>How to do it...</h2></div></div></div><p>After adding the <code class="literal">schemaList</code> module, you will need to create your application namespace in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the module into your code as the following code snippet demonstrates:</p><div><pre class="programlisting">//Create our application namespace
var my = {
  schemes : require('schemeList'),
  isAndroid : Ti.Platform.osname === 'android'
};</pre></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec190"/>iOS updating tiapp.xml</h3></div></div></div><p>Adding the ability to<a id="id655" class="indexterm"/> allow other iOS apps to launch your apps is straightforward. The following code snippet demonstrates how to add a custom scheme named, <code class="literal">bencoding-linkLauncher</code> to this recipe. This allows any iOS app to launch this sample in a similar fashion as discussed later in this recipe.</p><div><pre class="programlisting">&lt;ios&gt;
  &lt;plist&gt;
    &lt;dict&gt;</pre></div><p>The <code class="literal">CFBundleURLlTypes</code> node is an array of dictionaries describing the URL schemes supported by the bundle. Under this node, you will list all of the URL and scheme names your app will respond to.</p><div><pre class="programlisting">    &lt;key&gt;CFBundleURLTypes &lt;/key&gt;
    &lt;array&gt;
      &lt;dict&gt;</pre></div><p>The <code class="literal">CFBundleURLName</code> is the key that contains the abstract name for this URL type. This is the main way to refer to a particular type. To ensure uniqueness, it is recommended that you use a Java-package style identifier.</p><div><pre class="programlisting">        &lt;key&gt;CFBundleURLName &lt;/key&gt;
        &lt;string&gt;bencoding-linkLauncher&lt;/string&gt;</pre></div><p>The <code class="literal">CFBundleURLSchemes</code> is the key that contains an array of strings, each of which identifies a URL scheme handled by this type.</p><div><pre class="programlisting">        &lt;key&gt;CFBundleURLSchemes&lt;/key&gt;
        &lt;array&gt;
          &lt;string&gt;bencoding-linkLauncher&lt;/string&gt;
        &lt;/array&gt;
      &lt;/dict&gt;
     &lt;/array&gt;
   &lt;/dict&gt;
  /plist&gt;
&lt;/ios&gt;</pre></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec191"/>Creating an app launch list</h3></div></div></div><p>The <code class="literal">schemeList</code> CommonJS module, added to<a id="id656" class="indexterm"/> the <code class="literal">my.scheme</code> property provides a list of iOS and Android scheme examples. The following sections describe how <a id="id657" class="indexterm"/>schemes are created on both platforms.</p><div><div><div><div><h4 class="title"><a id="ch07lvl4sec13"/>iOS scheme list</h4></div></div></div><p>On iOS, a URL <a id="id658" class="indexterm"/>scheme works just like a URL on the web. The only difference is the app's registered URL scheme is used as the protocol. The following steps provide detailed examples of the specific URL formats available.</p><div><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">getiOSList</code> provides an array of objects designed to be bound to a <code class="literal">Ti.UI.TableView</code> and later used to launch other apps.<div><pre class="programlisting">exports.getiOSList = function(){
  var apps =[];</pre></div></li><li class="listitem">The most basic type of URL scheme is simply the <code class="literal">CFBundleURLName</code> of the app. This is shown in the following examples for Evernote and LinkedIn.<div><pre class="programlisting">  apps.push({
    title:'Evernote',
    url:'evernote://',
    errorMessage:'Check Evernote is installed'
  });

  apps.push({
    title:'LinkedIn',
    url:'linkedin://',
    errorMessage:'Check Linkedin is installed'
  });</pre></div></li><li class="listitem">More complex URL schemes can be used, such as the following example showing a URL scheme including the <code class="literal">about</code> route.<div><pre class="programlisting">  apps.push({
    title:'Recipe Example 1',
    url:'bencoding-linkrecipe://about',
    errorMessage:'Check Link Receiver Recipe is installed'
  });</pre></div></li><li class="listitem">URL schemes can also include query parameters similar to a web page, as demonstrated<a id="id659" class="indexterm"/> in the following code snippet:<div><pre class="programlisting">  apps.push({
    title:'Recipe Example 2',    
      url:'bencodinglinkrecipe: //'+'login?user=chris&amp;token=12345',
    errorMessage:'Check Link Receiver Recipe is installed'
  });

  return apps;
};</pre></div></li></ol></div></div><div><div><div><div><h4 class="title"><a id="ch07lvl4sec14"/>Android scheme list</h4></div></div></div><p>Android has the ability to launch<a id="id660" class="indexterm"/> applications in a variety of ways.  This recipe focuses on how to use a URL scheme similar to iOS and intents for app integration.</p><p>The <code class="literal">getAndroidList</code> provides an array of objects designed to be bound to a <code class="literal">Ti.UI.TableView</code> and later used to launch other apps.</p><div><pre class="programlisting">exports.getAndroidList = function(){
  var apps =[];</pre></div><div><ol class="orderedlist arabic"><li class="listitem">Similar to iOS apps, you can use a route base URL to launch a third-party app. The following code snippet shows how to construct a URL with an <code class="literal">about</code> route.<div><pre class="programlisting">  apps.push({
    title:'Recipe Example 1',
    type:'url',
    color:'#000',
    url:'bencoding-linkrecipe://com.bencoding/about',
    errorMessage:'Check Link Receiver Recipe is installed'
  });</pre></div></li><li class="listitem">Just as with web pages, you can build more complex URLs with query string parameters. The following snippet demonstrates how to call a login screen while passing query string information.<div><pre class="programlisting">  apps.push({
    title:'Recipe Example 2',
    type:'url',
    color:'#000',
    url:'bencoding-linkrecipe://'+'login?user=chris&amp;token=12345',
    errorMessage:'Check Link Receiver Recipe is installed'
  });</pre></div></li><li class="listitem">A more preferred way to launch apps on Android is to use intents. The following example shows how to create an intent to launch the LinkedIn app.<div><pre class="programlisting">  var linkedInIntent = Ti.Android.createIntent({
    action: Ti.Android.ACTION_SEND,
<strong>    packageName :'com.linkedin.android',</strong>
<strong>    className:</strong>
<strong>    'com.linkedin.android.home.UpdateStatusActivity'</strong>
  });</pre></div></li><li class="listitem">Once the LinkedIn intent has been created, it is added to the app's array with a type of intent. This will later be used to launch the LinkedIn app.<div><pre class="programlisting">  apps.push({
    title:'LinkedIn',
    type:'intent',
    color:'#000',
    intentObject :linkedInIntent
  });</pre></div><div><div><h3 class="title"><a id="note14"/>Note</h3><p>The LinkedIn app must be installed on the user's device in order to have the intent launch the app. If the app is not installed, an exception will be generated.</p></div></div></li><li class="listitem">A more <a id="id661" class="indexterm"/>preferred way to launch apps on Android is to use intents. The following example shows how to create an intent to launch the Evernote app.<div><pre class="programlisting">  var everNoteIntent = Ti.Android.createIntent({
<strong>    action: "com.evernote.action.CREATE_NEW_NOTE"</strong>
  });</pre></div><div><div><h3 class="title"><a id="note15"/>Note</h3><p>The Evernote app must be installed on the user's device in order to have the intent launch the app. If the app is not installed, an exception will be generated.</p></div></div></li><li class="listitem">Once the Evernote intent has been created, it is added to the app's array with a type of intent. This will later be used to launch the Evernote app.<div><pre class="programlisting">  apps.push({
    title:'Evernote',
    type:'intent',
    color:'#000',
    intentObject :everNoteIntent
  });

  return apps;	
};</pre></div></li></ol></div></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec192"/>The recipe's UI</h3></div></div></div><p>This section of the recipe <a id="id662" class="indexterm"/>is the UI used to launch the third-party apps.</p><div><ol class="orderedlist arabic"><li class="listitem">First, a <code class="literal">Ti.UI.Window</code> is created to attach all UI elements.<div><pre class="programlisting">var win = Ti.UI.createWindow({
  backgroundColor: '#fff', title: 'App Launcher', 
  barColor:'#000',layout:'vertical',fullscreen:false
});</pre></div></li><li class="listitem">Next the <code class="literal">schemeList</code> CommonJS module is called to return a list of the applications to launch.<div><pre class="programlisting">var schemeData = ((my.isAndroid) ? 
my.schemes.getAndroidList() : my.schemes.getiOSList())</pre></div></li><li class="listitem">The <code class="literal">schemaData</code> object is then formatted and bound to a <code class="literal">Ti.UI.TableView</code> for display.<div><pre class="programlisting">var tableView = Ti.UI.createTableView({
  data : my.schemes.format(schemeData),
  top:10, bottom:0, width:Ti.UI.FILL
});
win.add(tableView);</pre></div></li></ol></div><p>The final section of this recipe demonstrates how to launch third-party apps using the list displayed in the <code class="literal">Ti.UI.TableView</code>.</p><div><ol class="orderedlist arabic"><li class="listitem">A <code class="literal">click</code> event is added to the <code class="literal">Ti.UI.TableView</code>. This event will be fired when the user taps on a row in the <code class="literal">Ti.UI.TableView</code>.<div><pre class="programlisting">tableView.addEventListener('click',function(e){</pre></div></li><li class="listitem">Once the event is fired, the first step is to check the platform on which the recipe is running.<div><pre class="programlisting">  if(my.isAndroid){

    try{</pre></div></li><li class="listitem">If running under Android, a check must be performed to determine if the launch type is an intent or URL.<div><pre class="programlisting">      if(e.rowData.type == "intent"){</pre></div></li><li class="listitem">If the launch type is an intent, <code class="literal">Ti.Android.currentActivity.startActivity</code> is called using the provided intent as shown in the following snippet. This will launch the third-party app if it is installed on the user's device.<div><pre class="programlisting">        Ti.Android.currentActivity.startActivity(
        e.rowData.intentObject);
      }else{</pre></div></li><li class="listitem">If the launch type is a URL, the <code class="literal">Ti.Platform.openURL</code> method is used to open the app using the provided <code class="literal">url</code> property as shown in the following snippet. This will launch the third-party app if it is installed on the user's device.<div><pre class="programlisting">        Ti.Platform.openURL(e.rowData.url);
      }
    }catch(err){
      alert(e.rowData.errorMessage);
    }

  }else{</pre></div><div><div><h3 class="title"><a id="note16"/>Note</h3><p>If the app is not installed, an exception will be generated.</p></div></div></li><li class="listitem">The iOS <a id="id663" class="indexterm"/>platform launches third-party apps using a URL scheme similar to how web pages are loaded using the <code class="literal">Ti.Platform.openURL</code> method. The following snippet demonstrates how to launch a third-party app using the <code class="literal">url</code> property provided by the <code class="literal">schemeList</code> CommonJS module:<div><pre class="programlisting">    if(Ti.Platform.canOpenURL(e.rowData.url)){
      Ti.Platform.openURL(e.rowData.url);
    }else{
      alert(e.rowData.errorMessage);
    }
  }
});
win.open({modal:true});</pre></div></li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec106"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To learn more about using Android intents in Titanium, visit <em>Forging Titanium Episode 9</em> at <a class="ulink" href="http://developer.appcelerator.com/blog/2011/10/forging-titanium-episode-9-android-intent-cookbook.html">http://developer.appcelerator.com/blog/2011/10/forging-titanium-episode-9-android-intent-cookbook.html</a>.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec50"/>Cross-platform URL schemes</h1></div></div></div><p>URL schemes on iOS and<a id="id664" class="indexterm"/> intent filters on Android provide an open integration point for you to expose functionality in your apps to others. This is particularly helpful if you are building a suite of enterprise apps such as a separate mileage and expense app and want to allow for integration points between them.</p><p>This recipe demonstrates how to create a cross-platform URL scheme within your Titanium Enterprise app. We will illustrate how to use this open integration point to access functionality within your Titanium app.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec107"/>Getting ready</h2></div></div></div><p>This recipe uses the<a id="id665" class="indexterm"/> <code class="literal">demoUI</code> and <code class="literal">Ti.SchemeTools</code> CommonJS libraries <a id="id666" class="indexterm"/>to help manage and demonstrate how to create cross-platform URL schemes. This module and other code assets can be downloaded from the source provided by the book. To install these modules, simply copy them to the <code class="literal">Resources</code> folder of your Titanium project as demonstrated in the following screenshot:</p><div><img src="img/5343_07_05.jpg" alt="Getting ready"/></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec193"/>AppLauncher requirement</h3></div></div></div><p>Another requirement<a id="id667" class="indexterm"/> of this recipe is the AppLauncher app, which was created in the <em>Launching one app from another</em> recipe discussed earlier in this chapter. This app will be used to launch the different URL examples contained within this recipe.</p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec108"/>How to do it...</h2></div></div></div><p>After adding the <code class="literal">demoUI</code> and <code class="literal">Ti.SchemeTools</code> modules, you will need to create your application namespaces and use <code class="literal">require</code> to import the module into your <code class="literal">app.js</code> as the following code snippet demonstrates:</p><div><pre class="programlisting">//Create our application namespace
var my = {
  isAndroid : Ti.Platform.osname === 'android',
  scheme : require('Ti.SchemeTools'),
  ui : require('demoUI')
};</pre></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec194"/>iOS updating tiapp.xml</h3></div></div></div><p>To add the ability for<a id="id668" class="indexterm"/> other apps to launch this recipe, you must make a few updates to the <code class="literal">tiapp.xml</code> file. The following steps discuss how to create the <code class="literal">bencoding-linkrecipe</code> custom URL scheme:</p><div><ol class="orderedlist arabic"><li class="listitem">First, open your project's <code class="literal">tiapp.xml</code> file and make the following changes to the <code class="literal">ios</code> node:<div><pre class="programlisting">&lt;ios&gt;
  &lt;plist&gt;
    &lt;dict&gt;</pre></div></li><li class="listitem">Next, add the <code class="literal">CFBundleURLTypes</code> node. This is an array of dictionaries describing the URL schemes supported by the bundle. Under this node, you will list all of the URL and scheme names your app will respond to.<div><pre class="programlisting">    &lt;key&gt;CFBundleURLTypes&lt;/key&gt;
      &lt;array&gt;
        &lt;dict&gt;</pre></div></li><li class="listitem">Then add the <code class="literal">CFBundleURLName</code> key. This key contains the abstract name for this URL type. This is the main way to refer to a particular app. To ensure uniqueness, it is recommended that you use a Java-package style identifier.<div><pre class="programlisting">          &lt;key&gt;CFBundleURLName &lt;/key&gt;
          &lt;string&gt;bencoding-linkrecipe&lt;/string&gt;</pre></div></li><li class="listitem">Finally, add the <code class="literal">CFBundleURLSchemes</code> keys. These keys contain an array of strings, each of which identifies a URL scheme handled by this type. The following snippet shows URLs for the login, about, and root activities of the app:<div><pre class="programlisting">
<strong>          &lt;key&gt;CFBundleURLSchemes&lt;/key&gt;</strong>
<strong>          &lt;array&gt;</strong>
<strong>            &lt;string&gt;bencoding-linkrecipe&lt;/string&gt;</strong>
<strong>            &lt;string&gt;bencoding-linkrecipe://about&lt;/string&gt;</strong>
<strong>            &lt;string&gt;bencoding-linkrecipe://login&lt;/string&gt;</strong>
<strong>          &lt;/array&gt;</strong>
        &lt;/dict&gt;
      &lt;/array&gt;                
    &lt;/dict&gt;
  &lt;/plist&gt;
&lt;/ios&gt;</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec195"/>Android updating tiapp.xml</h3></div></div></div><p>To create a custom URL <a id="id669" class="indexterm"/>scheme on Android, you will need to edit the <code class="literal">tiapp.xml</code> file to add an intent filter to listen for the specific <code class="literal">android:scheme</code> and <code class="literal">android:host</code> to be initialized.</p><div><ol class="orderedlist arabic"><li class="listitem">First open the <code class="literal">tiapp.xml</code> file and edit the android configuration node.<div><pre class="programlisting">&lt;android &gt;</pre></div></li><li class="listitem">Next, add the <code class="literal">manifest</code> node.<div><pre class="programlisting">  &lt;manifest&gt;</pre></div></li><li class="listitem">Add the <code class="literal">application</code> node. This node will later be used to generate your project's <code class="literal">AndroidManifest.xml</code> file, so make sure the attributes correctly match your project.<div><pre class="programlisting">    &lt;application 
    android:debuggable="false" android:icon=
    "@drawable/appicon" android:label=
    "XUrlScheme" android:name="XurlschemeApplication"&gt;</pre></div></li><li class="listitem">Next add the application's root activity.<div><pre class="programlisting">      &lt;activity 
      android:configChanges="keyboardHidden|orientation" 
      android:label="XUrlScheme" 
      android:name=".XurlschemeActivity" 
      android:theme="@style/Theme.Titanium"&gt;</pre></div></li><li class="listitem">Then add the app's main intent filter. This will be used to launch your app.<div><pre class="programlisting">        &lt;intent-filter&gt;
          &lt;action android:name=
          "android.intent.action.MAIN"/&gt;
          &lt;category android:name=
          "android.intent.category.LAUNCHER"/&gt;
        &lt;/intent-filter&gt;</pre></div></li><li class="listitem">Next <a id="id670" class="indexterm"/>add a second intent filter with your custom URL information.<div><pre class="programlisting">        &lt;intent-filter&gt;</pre></div></li><li class="listitem">Then add the data node with your <code class="literal">android:scheme</code> and <code class="literal">android:host</code> information. These values act as the protocol used when <code class="literal">Ti.Platform.openURL</code> is used to launch the URL scheme. The following highlighted code allows you to launch the app using a URL such as <code class="literal">bencoding-linkrecipe://com.bencoding</code>.<div><pre class="programlisting">          &lt;data android:scheme="bencoding-linkrecipe" 
          android:host="com.bencoding"/&gt;</pre></div></li><li class="listitem">Next a category must be added to the intent filter so that the app will be exposed correctly to third-party launchers and will open the app when the URL scheme is called. The following highlighted snippet shows the category <a id="id671" class="indexterm"/>information needed to correctly implement the custom URL scheme.<div><pre class="programlisting">          &lt;category android:name=
          "android.intent.category.DEFAULT" /&gt;
          &lt;category android:name=
          "android.intent.category.BROWSABLE" /&gt;
          &lt;action android:name=
          "android.intent.action.VIEW" /&gt;

        &lt;/intent-filter&gt;

      &lt;/activity&gt;
    &lt;/application&gt; 
  &lt;/manifest&gt;
&lt;/android&gt;</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec196"/>Creating the recipe UI</h3></div></div></div><p>This recipe has a <a id="id672" class="indexterm"/>simple UI designed to demonstrate how different URL scheme features can be implemented.</p><div><ol class="orderedlist arabic"><li class="listitem">First, a <code class="literal">Ti.UI.Window</code> is created; this window is the root <code class="literal">Ti.UI.Window</code> of the app.<div><pre class="programlisting">var win = Ti.UI.createWindow({
  backgroundColor: '#fff', title: 'Url Receiver', 
  barColor:'#000',layout:'vertical',fullscreen:false
});</pre></div></li><li class="listitem">Next if the recipe is running on an iOS device, a <code class="literal">Ti.UI.Button</code> is added to allow the URL Receiver app to launch the App Launcher app created in the <em>Launching one app from another</em> recipe discussed earlier in this chapter.<div><pre class="programlisting">if(!my.isAndroid){
  var launcherButton = Ti.UI.createButton({
    title:'Press to open AppLauncher Sample', 
    top:30, left:10, right:10, height:45
  });
  win.add(launcherButton);</pre></div></li><li class="listitem">When the <code class="literal">launcherButton</code> is tapped, the app will try to open the App Launcher if the app is available on the device. The highlighted code demonstrates how to use the <code class="literal">Ti.Platform.openURL</code> method to launch the <a id="id673" class="indexterm"/>app.<div><pre class="programlisting">  launcherButton.addEventListener('click',function(e){
    if(Ti.Platform.canOpenURL(
    "bencoding-linkLauncher://")
    ){
      Ti.Platform.openURL(
      "bencoding-linkLauncher://");
    }else{
      alert("Please install the AppLauncher Recipe");
    }
  });
}</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec197"/>Launching helper functions</h3></div></div></div><p>This recipe<a id="id674" class="indexterm"/> uses the <code class="literal">assist object</code> to help launch a different URL.</p><div><pre class="programlisting">var assist = {</pre></div><div><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">openWindow</code> method<a id="id675" class="indexterm"/> opens a specific window based on the URL and parameter values provided.<div><pre class="programlisting">  openWindow : function(url,params){
    if(url == 'about'){
      my.ui.openAboutWindow();
    }
    if (url =='login'){
      my.ui.openLoginWindow(params);
    }
  },</pre></div></li><li class="listitem">The <code class="literal">openPageFromUrl</code> method<a id="id676" class="indexterm"/> is called when an app is opened or resumed to determine if the app has been opened from a third-party app and if so, what routing information has been provided.<div><pre class="programlisting">  openPageFromUrl : function(){</pre></div></li><li class="listitem">The first step is to determine if the app has been opened from a third-party app. This is done by checking the<a id="id677" class="indexterm"/> <code class="literal">hasLaunchUrl</code> method.<div><pre class="programlisting">    if(!my.scheme.hasLaunchUrl()){</pre></div></li><li class="listitem">If the app has not been launched from another app, the main page of the recipe will be displayed and any session variables will be reset.<div><pre class="programlisting">      my.scheme.session.reset();
      return;
    }</pre></div></li><li class="listitem">If the app was launched by another app, we first need to check if the launching <a id="id678" class="indexterm"/>URL has changed. This avoids reloading the app if the same window has been requested. This can be done by calling the <code class="literal">hasChanged</code> method<a id="id679" class="indexterm"/> as highlighted in the following code snippet:<div><pre class="programlisting">
<strong>    if(!my.scheme.session.hasChanged()){</strong>
      return;
    }</pre></div></li><li class="listitem">Next the URL to be launched is obtained by calling the <code class="literal">getLaunchUrl</code> method<a id="id680" class="indexterm"/> as the following code snippet shows. This URL is then loaded into a <code class="literal">session</code> variable for later use.<div><pre class="programlisting">    my.scheme.session.launchUrl = 
    my.scheme.getLaunchUrl();</pre></div></li><li class="listitem">Then the requested page is obtained using the<a id="id681" class="indexterm"/> <code class="literal">getCurrentPage</code> function. This will be used in determining which page to load using the <code class="literal">openWindow</code> method.<div><pre class="programlisting">    var requestedPage = my.scheme.getCurrentPage();</pre></div></li><li class="listitem">Next, any launch parameters are obtained. The following code block demonstrates how to check if launch parameters have been provided and parses them into a formatted object.<div><pre class="programlisting">    my.scheme.session.launchParams = null;
    if(my.scheme.hasParams()){
      my.scheme.session.launchParams = 
      my.scheme.getParams();
    }</pre></div></li><li class="listitem">Finally, the <code class="literal">openWindow</code> method<a id="id682" class="indexterm"/> is called using the <code class="literal">requestedPage</code> and <code class="literal">launchParams</code> created in the preceding steps. The <code class="literal">openWindow</code> method will then open the requested window in the app.<div><pre class="programlisting">    assist.openWindow(requestedPage,
    my.scheme.session.launchParams);
  }
};</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec198"/>When launched from another app</h3></div></div></div><p>In<a id="id683" class="indexterm"/> order to have the recipe launch the requested window, listeners must be added to the resumed and open events. The following steps detail how to add the proper event listeners to your app:</p><div><ol class="orderedlist arabic"><li class="listitem">If the recipe is running on iOS, the resumed event listener is added. Please note this must be added to your <code class="literal">app.js</code> when implementing in your own app.<div><pre class="programlisting">if(!my.isAndroid){

  Ti.App.addEventListener( 'resumed', function(e) {</pre></div></li><li class="listitem">The <code class="literal">assist.openPageFromUrl</code> method will be called each time the app is resumed. If no URL information is provided, the main window will be displayed.<div><pre class="programlisting">    assist.openPageFromUrl();
  });

}</pre></div></li><li class="listitem">A listener is added to the open event on the main window. This event will be fired when the app is first launched.<div><pre class="programlisting">win.addEventListener('open',function(e){</pre></div></li><li class="listitem">On the first launch, the <code class="literal">assist.openPageFromUrl</code> method is called to determine if the app has been opened by a third-party app.<div><pre class="programlisting">  assist.openPageFromUrl();</pre></div></li><li class="listitem">If the recipe is running on Android, a listener is added to the <code class="literal">resume</code> event on the main window. This allows the recipe to detect if a third-party app tries to open the recipe while the app is running in the background.<div><pre class="programlisting">  if(my.isAndroid){
    win.activity.addEventListener('resume', function(){
      assist.openPageFromUrl();
    });
  }

});

win.open();</pre></div></li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec109"/>How it works...</h2></div></div></div><p>Cross-platform custom URL <a id="id684" class="indexterm"/>schemes are a great low-cost way to provide integration points with third parties. The following section details the end-to-end process for using the <em>Launching one app from another</em> recipe to access different app routes without this recipe's sample app.</p><div><div><div><div><h3 class="title"><a id="ch07lvl3sec199"/>Launching the About window</h3></div></div></div><p>This section provides a<a id="id685" class="indexterm"/> step-by-step description on how you can launch the <strong>About</strong> window in the URL Receiver recipe when launched from the App Launcher recipe.</p><div><ol class="orderedlist arabic"><li class="listitem">Open the App Launcher application and tap on the <strong>Recipe Example 1</strong> row in the table view as shown with the red boxes in the following screenshot.<div><img src="img/5343_07_06.jpg" alt="Launching the About window"/></div></li><li class="listitem">The App Launcher app runs the following code block.<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>On iOS</strong>:<div><pre class="programlisting">Ti.Platform.openURL('bencoding-linkrecipe://about');</pre></div></li><li class="listitem" style="list-style-type: disc"><strong>On Android</strong>:<div><pre class="programlisting">Ti.Platform.openURL('bencoding-linkrecipe://com.bencoding/about');</pre></div></li></ul></div></li><li class="listitem">The URL Receiver recipe will then be launched on your device.</li><li class="listitem">The resumed or open event handlers will then parse the provided URL information. When the <code class="literal">getCurrentPage</code> method is called, the <code class="literal">requestedPage</code> value will be set to a string with the value of <code class="literal">about</code>.<div><pre class="programlisting">var requestedPage = my.scheme.getCurrentPage();</pre></div></li><li class="listitem">Next, <code class="literal">my.scheme.hasParams</code> method is called to determine if any parameters have been <a id="id686" class="indexterm"/>passed as part of the provided URL. In this case, no additional parameters have been provided, so the <code class="literal">session</code> parameter object remains <code class="literal">null</code>.</li><li class="listitem">The <code class="literal">openWindow</code> method is then called and the following <strong>About</strong> window is then opened:<div><img src="img/5343_07_07.jpg" alt="Launching the About window"/></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec200"/>Launching the Login window</h3></div></div></div><p>This section provides a<a id="id687" class="indexterm"/> step-by-step description of launching the <strong>Login</strong> window in the URL Receiver recipe when launched from the App Launcher recipe. As part of the launch process, the user and token parameters are provided by the App Launcher recipe then used to complete the form within the URL Receiver recipe app.</p><div><ol class="orderedlist arabic"><li class="listitem">Open the App Launcher application and tap on the <strong>Recipe Example 2</strong> row in the table view as shown with the red boxes in the following screenshot:<div><img src="img/5343_07_08.jpg" alt="Launching the Login window"/></div></li><li class="listitem">The App<a id="id688" class="indexterm"/> Launcher application runs the following code block.<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>On iOS</strong>:<div><pre class="programlisting">Ti.Platform.openURL('bencoding-linkrecipe://login?user=chris&amp;token=12345');</pre></div></li><li class="listitem" style="list-style-type: disc"><strong>On Android</strong>:<div><pre class="programlisting">Ti.Platform.openURL(
'bencoding-linkrecipe://com.bencoding/'+
login?user=chris&amp;token=12345');</pre></div></li></ul></div></li><li class="listitem">The URL Receiver recipe will then be launched on your device.</li><li class="listitem">The resumed or open event handlers will then parse the provided URL information. When the <code class="literal">getCurrentPage</code> method is called, the <code class="literal">requestedPage</code> value will be set to a string with the value of <code class="literal">login</code>.<div><pre class="programlisting">var requestedPage = my.scheme.getCurrentPage();</pre></div></li><li class="listitem">Next, <code class="literal">my.scheme.hasParams</code> method is called to determine if any parameters have been passed as part of the provide URL.</li><li class="listitem">The following parameter object is created using the query string parameters included with the calling URL.<div><pre class="programlisting">{ user:"chris",
 token:12345 }</pre></div></li><li class="listitem">The <code class="literal">openWindow</code> method is <a id="id689" class="indexterm"/>then called providing the <code class="literal">requestedPage</code> and <code class="literal">parameter</code> objects. This will then open the <strong>Login</strong> page with the parameter used to complete the form as shown in the following screenshot:<div><img src="img/5343_07_09.jpg" alt="Launching the Login window"/></div></li></ol></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec51"/>Opening your Android app with BOOT_COMPLETED</h1></div></div></div><p>Many enterprise apps have <a id="id690" class="indexterm"/>the requirement of always<a id="id691" class="indexterm"/> running in the <a id="id692" class="indexterm"/>background. The most common categories of these apps would be for route management, item tracking, or customer scheduling apps. In your Android Titanium app, you can use an intent filter for the <code class="literal">BOOT_COMPLETED</code> action<a id="id693" class="indexterm"/> to notify your app that the device has been restarted. The event lifecycle for the <code class="literal">BOOT_COMPLETED</code> action is<a id="id694" class="indexterm"/> shown in the following diagram:</p><div><img src="img/5343_07_10.jpg" alt="Opening your Android app with BOOT_COMPLETED"/></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec110"/>Getting ready</h2></div></div></div><p>This recipe uses the <code class="literal">bencoding.android.tools</code> <a id="id695" class="indexterm"/>native <a id="id696" class="indexterm"/>module to help <a id="id697" class="indexterm"/>with the subscription of the <code class="literal">BOOT_COMPLETED</code> broadcast. This module and other code assets can be downloaded<a id="id698" class="indexterm"/> from the source provided by the book, or individually through the links provided in the See also section at the end of this recipe. To install this module, simply copy the <code class="literal">modules</code> folder shown in the following screenshot into your project.</p><p>Also included with the sample recipe is a series of example <code class="literal">tiapp.xml</code> and <code class="literal">app.js</code> files demonstrating different options in handling the receipt of the <code class="literal">BOOT_COMPLETED</code> broadcast. You will need to copy the files highlighted in the following screenshot into your project as they will be used to demonstrate the different available options.</p><div><img src="img/5343_07_11.jpg" alt="Getting ready"/></div><p>After copying<a id="id699" class="indexterm"/> the mentioned files, you will<a id="id700" class="indexterm"/> need to click on your <strong>tiapp.xml</strong> <a id="id701" class="indexterm"/>file in Titanium Studio and add a reference to the <code class="literal">bencoding.android.tools</code> module as shown in the following screenshot:</p><div><img src="img/5343_07_12.jpg" alt="Getting ready"/></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec111"/>How to do it...</h2></div></div></div><p>This recipe <a id="id702" class="indexterm"/>demonstrates how to implement <a id="id703" class="indexterm"/>the following scenarios:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Auto restarting your app upon receiving the <code class="literal">BOOT_COMPLETED</code> broadcast</li><li class="listitem" style="list-style-type: disc">Sending a notification to the user receiving the <code class="literal">BOOT_COMPLETED</code> broadcast</li><li class="listitem" style="list-style-type: disc">Using Titanium properties to configure how your app handles the <code class="literal">BOOT_COMPLETED</code> broadcast</li></ul></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec201"/>Required tiapp.xml updates</h3></div></div></div><p>When a Titanium <a id="id704" class="indexterm"/>Android app is launched, the Titanium framework first must be initialized before your app can run. When the app is launched by another service such as the <code class="literal">BOOT_COMPLETED</code> broadcast, you will receive a message that the app needs to restart.  To avoid this issue, you must add the following properties into your <code class="literal">tiapp.xml</code> file:</p><div><pre class="programlisting">&lt;property name="ti.android.bug2373.finishfalseroot" type="bool"&gt;true&lt;/property&gt;
&lt;property name="ti.android.bug2373.disableDetection" type="bool"&gt;true&lt;/property&gt;
&lt;property name="ti.android.bug2373.restartDelay" type="int"&gt;500&lt;/property&gt;
&lt;property name="ti.android.bug2373.finishDelay" type="int"&gt;0&lt;/property&gt;
&lt;property name="ti.android.bug2373.skipAlert" type="bool"&gt;true&lt;/property&gt;
&lt;property name="ti.android.bug2373.message"&gt;Initializing&lt;/property&gt;
&lt;property name="ti.android.bug2373.title"&gt;Restart Required&lt;/property&gt;
&lt;property name="ti.android.bug2373.buttonText"&gt;Continue&lt;/property&gt;</pre></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec202"/>Scenario A – auto restart</h3></div></div></div><p>The first <code class="literal">BOOT_COMPLETED</code> option provided by the <code class="literal">Android.Tools.Receiver</code> module<a id="id705" class="indexterm"/> is the ability to restart your app. The typical use case would be to restart your Titanium app <a id="id706" class="indexterm"/>when the user restarts his/her device.</p><div><div><h3 class="title"><a id="tip35"/>Tip</h3><p>To deploy this scenario to your device using the recipe source, rename the <code class="literal">1.auto_start_tiapp.xml</code> file to <code class="literal">tiapp.xml</code> and the <code class="literal">1.app.js</code> to <code class="literal">app.js</code>. This will switch the recipe app to use the following scenario details.</p></div></div><div><div><div><div><h4 class="title"><a id="ch07lvl4sec15"/>Auto restart step 1: adding the receiver to tiapp.xml</h4></div></div></div><p>The first step in enabling this scenario is to add the receiver entry into the Android configuration node in our project's <code class="literal">tiapp.xml</code> file located in the root of your Titanium Project.</p><div><pre class="programlisting">&lt;receiver android:exported="true" android:name="bencoding.android.receivers.BootReceiver"&gt;</pre></div><div><ol class="orderedlist arabic"><li class="listitem">First an intent filter must be added to our receiver, this will subscribe our app to the <code class="literal">BOOT_COMPLETED</code> broadcast.<div><pre class="programlisting">  &lt;intent-filter&gt;
    &lt;action android:name=
    "android.intent.action.BOOT_COMPLETED"/&gt;
  &lt;/intent-filter&gt;</pre></div></li><li class="listitem">Next a <a id="id707" class="indexterm"/>metadata node is added with the name <code class="literal">bootType</code>. This node is used by the <code class="literal">Android.Tools</code> module to determine what boot action should be taken. The following snippet demonstrates how to configure the module to restart the app.<div><pre class="programlisting">  &lt;meta-data android:name=
  "bootType" android:value="restart"/&gt;</pre></div></li><li class="listitem">Then a metadata node is added with the name <code class="literal">sendToBack</code>. This node is used by the <code class="literal">Android.Tools</code> module to determine if the app should be restarted in the background if set to <code class="literal">true</code>, or restarted in the foreground if set to <code class="literal">false</code>.<div><pre class="programlisting">  &lt;meta-data android:name=
  "sendToBack" android:value="true"/&gt;
&lt;/receiver&gt;</pre></div></li><li class="listitem">Finally the <code class="literal">RECEIVE_BOOT_COMPLETED</code> permission is added.<div><pre class="programlisting">&lt;uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/&gt;</pre></div></li></ol></div></div><div><div><div><div><h4 class="title"><a id="ch07lvl4sec16"/>Auto restart step 2: testing</h4></div></div></div><p>The following steps outline how to best test this recipe scenario:</p><div><ol class="orderedlist arabic"><li class="listitem">Clean your Titanium solution and push to device.</li><li class="listitem">Make sure the app is not running on your device. You can stop the app using the <strong>Force stop</strong> option under <strong>Settings</strong>.</li><li class="listitem">Restart your device.</li><li class="listitem">After <a id="id708" class="indexterm"/>the device has been restarted, confirm the date and time displayed on the recipe's main screen.</li></ol></div></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec203"/>Scenario B – notification on restart</h3></div></div></div><p>The second <code class="literal">BOOT_COMPLETED</code> option<a id="id709" class="indexterm"/> provided by the <code class="literal">Android.Tools.Receiver</code> module is the ability to create a notification message when a user restarts his/her device. This can be used to provide a reminder or instructions to the user.</p><div><div><h3 class="title"><a id="tip36"/>Tip</h3><p>To deploy this scenario to your device using the recipe source, rename the <code class="literal">2.auto_start_tiapp.xml</code> file to <code class="literal">tiapp.xml</code> and the <code class="literal">2.app.js</code> file to <code class="literal">app.js</code>. This will switch the recipe app to use the following scenario details.</p></div></div><div><div><div><div><h4 class="title"><a id="ch07lvl4sec17"/>Notification on restart step 1: adding receiver to tiapp.xml</h4></div></div></div><p>The first step in enabling this scenario is to add the receiver entry into the Android configuration node in our project's <code class="literal">tiapp.xml</code> file.</p><div><pre class="programlisting">&lt;receiver android:exported="true" android:name="bencoding.android.receivers.BootReceiver"&gt;</pre></div><div><ol class="orderedlist arabic"><li class="listitem">First, an intent filter must be added to our receiver, this will subscribe our app to the <code class="literal">BOOT_COMPLETED</code> broadcast.<div><pre class="programlisting">  &lt;intent-filter&gt;
    &lt;action android:name=
    "android.intent.action.BOOT_COMPLETED"/&gt;
  &lt;/intent-filter&gt;</pre></div></li><li class="listitem">Next, a metadata node is added with the name <code class="literal">bootType</code>. This node is used by the <code class="literal">Android.Tools</code> module to determine what boot action should be taken. The following snippet demonstrates how to configure the module to send a notification message on device restart.<div><pre class="programlisting">  &lt;meta-data android:name=
  "bootType" android:value="notify"/&gt;</pre></div></li><li class="listitem">Then a metadata node is added with the name <code class="literal">title</code>. This node contains the notification title that will be used.<div><pre class="programlisting">  &lt;meta-data android:name="title" 
  android:value="Title Sample from tiapp.xml"/&gt;</pre></div></li><li class="listitem">Then a metadata node is added with the name <code class="literal">message</code>. This node contains the notification message that will be used.<div><pre class="programlisting">  &lt;meta-data android:name="message" 
  android:value="Message Sample from 
  tiapp.xml"/&gt;&lt;/receiver&gt;</pre></div></li><li class="listitem">Finally the <code class="literal">RECEIVE_BOOT_COMPLETED</code> permission is added.<div><pre class="programlisting">&lt;uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/&gt;</pre></div></li></ol></div></div><div><div><div><div><h4 class="title"><a id="ch07lvl4sec18"/>Notification on restart step 2: testing</h4></div></div></div><p>The following steps<a id="id710" class="indexterm"/> outline the best method to test this recipe scenario:</p><div><ol class="orderedlist arabic"><li class="listitem">Clean your Titanium solution and push to device.</li><li class="listitem">Make sure the app is not running on your device. You can stop the app using the <strong>Force stop</strong> option under <strong>Settings</strong>.</li><li class="listitem">Restart your device.</li><li class="listitem">Within a few seconds of device reboot, you will see a new message in yournotification tray.</li></ol></div></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec204"/>Scenario C – property controlled</h3></div></div></div><p>The final <code class="literal">BOOT_COMPLETED</code> option <a id="id711" class="indexterm"/>provided by the <code class="literal">Android.Tools.Receiver</code> module is the ability to restart your app. The typical use case would be to restart your Titanium app when the user restarts his/her device.</p><div><div><h3 class="title"><a id="tip37"/>Tip</h3><p>To deploy this scenario to your device using the recipe source, rename the <code class="literal">3.auto_start_tiapp.xml</code> file to <code class="literal">tiapp.xml</code> and the <code class="literal">3.app.js</code> file to <code class="literal">app.js</code>. This will switch the recipe app to use the following scenario details.</p></div></div><div><div><div><div><h4 class="title"><a id="ch07lvl4sec19"/>Property controlled step 1: adding receiver to tiapp.xml</h4></div></div></div><p>The first step in enabling this scenario is to add the receiver entry into the Android configuration node in our project's <code class="literal">tiapp.xml</code> file.</p><div><pre class="programlisting">&lt;receiver android:exported="true" android:name="bencoding.android.receivers.BootReceiver"&gt;</pre></div><div><ol class="orderedlist arabic"><li class="listitem">An intent filter must be added to our receiver, this will subscribe our app to the <code class="literal">BOOT_COMPLETED</code> broadcast.<div><pre class="programlisting">  &lt;intent-filter&gt;
    &lt;action android:name=
    "android.intent.action.BOOT_COMPLETED"/&gt;
  &lt;/intent-filter&gt;</pre></div></li><li class="listitem">Next, a meta<a id="id712" class="indexterm"/>data node is added with the name <code class="literal">bootType</code>. This node is used by the <code class="literal">Android.Tools</code> module to determine what boot action should be taken. The following code snippet demonstrates how to configure the module to use Titanium properties to determine what action should be taken.<div><pre class="programlisting">    &lt;meta-data android:name="bootType" 
    android:value=" propertyBased"/&gt;</pre></div></li><li class="listitem">Metadata nodes are then added to configure the <code class="literal">BOOT_COMPLETED</code> receiver. Each node is used to map a Titanium property to a receiver configuration element. For example, the <code class="literal">bootType_property_to_reference</code> holds the name of the property to be used to determine the <code class="literal">bootType</code>.<div><pre class="programlisting">&lt;meta-data android:name="enabled_property_to_reference" android:value="my_enabled"/&gt;
&lt;meta-data android:name="bootType_property_to_reference" android:value="my_bootType"/&gt;
&lt;meta-data android:name="sendToBack_property_to_reference" android:value="my_sendtoback"/&gt;
&lt;meta-data android:name="icon_property_to_reference" android:value="my_notify_icon"/&gt;
&lt;meta-data android:name="title_property_to_reference" 
ndroid:value="my_notify_title"/&gt;
&lt;meta-data android:name="message_property_to_reference" android:value="my_notify_message"/&gt;&lt;/receiver&gt;</pre></div></li><li class="listitem">Finally, the <code class="literal">RECEIVE_BOOT_COMPLETED</code> permission is added.<div><pre class="programlisting">&lt;uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/&gt;</pre></div></li></ol></div></div><div><div><div><div><h4 class="title"><a id="ch07lvl4sec20"/>Property controlled step 2: create recipe app.js</h4></div></div></div><p>The <code class="literal">Android.Tools</code> module allows for the <code class="literal">BOOT_COMPLETED</code> receiver to be configured through Titanium properties. The following code snippet (<code class="literal">app.js</code>) demonstrates how to create two different configurations by simply updating the correct Titanium properties.</p><div><ol class="orderedlist arabic"><li class="listitem">First, a <code class="literal">Ti.UI.Window</code> is created to attach all UI elements.<div><pre class="programlisting">var win = Ti.UI.createWindow({
  backgroundColor: '#fff', title: 'BOOT_COMPLETED Example', 
  layout:'vertical',fullscreen:false, exitOnClose:true
});</pre></div></li><li class="listitem">Next, a <code class="literal">Ti.UI.Button</code> is created to demonstrate how to create a foreground restart.<div><pre class="programlisting">var button1 = Ti.UI.createButton({
  title:'Foreground Restart',
  top:25, height:45, left:5, right:5
});
win.add(button1);</pre></div></li><li class="listitem">On the <code class="literal">click</code> event of our first button, the properties used to configure our <code class="literal">BOOT_COMPLETED</code> receiver are updated.<div><pre class="programlisting">button1.addEventListener('click',function(e){</pre></div></li><li class="listitem">The first action performed in the <code class="literal">click</code> event is to set the <code class="literal">BOOT_COMPLETED</code> receiver as enabled.<div><pre class="programlisting">  Ti.App.Properties.setBool('my_enabled',true);</pre></div></li><li class="listitem">Next, the <code class="literal">bootType</code> is set to restart. This will restart our Titanium app on device reboot.<div><pre class="programlisting">  Ti.App.Properties.setString("my_bootType", "restart");</pre></div></li><li class="listitem">Then<a id="id713" class="indexterm"/> the <code class="literal">sendToBack</code> property is set to <code class="literal">false</code>. This will restart our Titanium app in the foreground when the user restarts his/her device.<div><pre class="programlisting">  Ti.App.Properties.setBool("my_sendtoback",false);
});</pre></div></li><li class="listitem">Next, a second button is created to demonstrate how to configure the notification.<div><pre class="programlisting">var button2 = Ti.UI.createButton({
  title:'Restart Notification',
  top:25, height:45, left:5, right:5
});
win.add(button2);</pre></div></li><li class="listitem">Next a second button is created to demonstrate how to configure notification to be generated when the device is restarted.<div><pre class="programlisting">button2.addEventListener('click',function(e){</pre></div></li><li class="listitem">An action performed in the <code class="literal">click</code> event is to set the <code class="literal">BOOT_COMPLETED</code> receiver to <code class="literal">enabled</code>.<div><pre class="programlisting">  Ti.App.Properties.setBool('my_enabled',true);</pre></div></li><li class="listitem">Next the <code class="literal">bootType</code> is set to <code class="literal">notify</code>. This will send a message after receiving the <code class="literal">BOOT_COMPLETED</code> broadcast.<div><pre class="programlisting">  Ti.App.Properties.setString("my_bootType", "notify");</pre></div></li><li class="listitem">Next, the notification icon resource identifier is created. This resource identifier will be used to create an icon when the notification is created. If no resource identifier is provided, a star icon will be used by default.<div><pre class="programlisting">  .App.Properties.setInt("my_notify_icon", 17301618);</pre></div></li><li class="listitem">Finally the properties linked to the notification title and message are set with new string values. These properties will be used in generating the notification when the device has been restarted.<div><pre class="programlisting">  Ti.App.Properties.setString(
  "my_notify_title", "Title from property");
  Ti.App.Properties.setString(
  "my_notify_message","Message from property");
});</pre></div></li></ol></div></div><div><div><div><div><h4 class="title"><a id="ch07lvl4sec21"/>Property controlled step 3: testing</h4></div></div></div><p>The following <a id="id714" class="indexterm"/>steps outline how to best test this recipe scenario:</p><div><ol class="orderedlist arabic"><li class="listitem">Clean your Titanium solution and push to device.</li><li class="listitem">Open the app, and press the first button (<code class="literal">button1</code>). This will update the properties to perform a foreground restart.</li><li class="listitem">Next stop the app; you can stop the app using the <strong>Force stop</strong> option under <strong>Settings</strong>.</li><li class="listitem">Restart your device.</li><li class="listitem">After the device is started, the recipe app will be launched in the foreground.</li><li class="listitem">Press the second button (<code class="literal">button2</code>). This will update the properties to send a notification on restart.</li><li class="listitem">Restart your device.</li><li class="listitem">Within a few seconds of device reboot, you will see a new message in your notification tray.</li></ol></div></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec112"/>See also</h2></div></div></div><p>The <code class="literal">Android.Tools</code> module<a id="id715" class="indexterm"/> was used in this recipe to provide the <code class="literal">BOOT_COMPLETED</code> functionality. For additional information about this module, please visit the project on Github at <a class="ulink" href="https://github.com/benbahrenburg/benCoding.Android.Tools">https://github.com/benbahrenburg/benCoding.Android.Tools</a>.</p><p>For full documentation on the <a id="id716" class="indexterm"/>BootReceiver, visit <a class="ulink" href="https://github.com/benbahrenburg/benCoding.Android.Tools/tree/master/documentation/bootreceiver.md">https://github.com/benbahrenburg/benCoding.Android.Tools/tree/master/documentation/bootreceiver.md</a>.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec52"/>iOS Multithreading using Web Workers</h1></div></div></div><p>Enterprise apps often require <a id="id717" class="indexterm"/>a large amount of processing to be performed. To provide the best user experience while fully leveraging the limited device resources, you must perform compute operations on a background thread.</p><p>In this recipe, we will discuss how to use the <code class="literal">Ti.WebWorkerWrapper</code> module<a id="id718" class="indexterm"/> to perform background compute operations. To simulate a compute job, a fibonacci sequence is calculated for random numbers and processed in parallel. The following screenshot shows the recipe running these Web Worker jobs on an iPhone.</p><div><img src="img/5343_07_13.jpg" alt="iOS Multithreading using Web Workers"/></div><div><div><h3 class="title"><a id="note17"/>Note</h3><p>This recipe is an iOS-only recipe as it requires Web Workers, which are not yet available for Titanium Android.</p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec113"/>Getting ready</h2></div></div></div><p>This recipe uses<a id="id719" class="indexterm"/> the <code class="literal">Ti.WebWorkerWrapper</code> CommonJS module and <code class="literal">fibonacci.js</code> Web Worker. These modules and other code assets can be downloaded from the source provided by the book, or individually through the links provided in the <em>See also</em> section at the end of this recipe. To install the <code class="literal">Ti.WebWorkerWrapper</code> module and Web Worker into your project, simply copy the <code class="literal">Ti.WebWorkerWrapper.js</code> and <code class="literal">fibonacci.js</code> files into the <code class="literal">Resources</code> folder of your Titanium project as highlighted in the following screenshot:</p><div><img src="img/5343_07_14.jpg" alt="Getting ready"/></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec114"/>How to do it...</h2></div></div></div><p>Once you have added the <code class="literal">Ti.WebWorkerWrapper</code> module and <code class="literal">fibonacci.js</code> file to your project, you next need to create your application namespace and use <code class="literal">require</code> to import the module into your <code class="literal">app.js</code> file as the following code snippet demonstrates:</p><div><pre class="programlisting">//Create our application namespace
var my = {
  workerMod : require('Ti.WebWorkerWrapper'),
  isAndroid : Ti.Platform.osname === 'android'
};</pre></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec205"/>Creating the recipe UI</h3></div></div></div><p>This recipe provides <a id="id720" class="indexterm"/>a basic UI to launch and track the execution of the Web Workers execution of the fibonacci sequence. The following steps detail how to create the main components illustrated in the earlier screenshot:</p><div><ol class="orderedlist arabic"><li class="listitem">First a <code class="literal">Ti.UI.Window</code> is created. This window will be used to attach and display all UI elements.<div><pre class="programlisting">var win = Ti.UI.createWindow({
  backgroundColor: '#fff', title: 'web Workers', 
  barColor:'#000',layout:'vertical',fullscreen:false
});</pre></div></li><li class="listitem">Next a series of <code class="literal">Ti.UI.Label</code> controls are added to the <code class="literal">Ti.UI.Window</code>. These controls will be used to display the progress and results of the Web Workers.<div><pre class="programlisting">var worker1 = Ti.UI.createLabel({
  top:20, height:25, left:5, right:5,color:'#000',
  textAlign:'left',text:'Not yet processed - Press Button', 
  font:{fontSize:14, fontWeight:'bold'}
});
win.add(worker1);</pre></div><div><div><h3 class="title"><a id="note18"/>Note</h3><p>Three additional Web Worker labels are added using the same template as the <code class="literal">worker1</code> label shown in the preceding code snippet.</p></div></div></li><li class="listitem">Finally a <code class="literal">Ti.UI.Button</code> is added to the <code class="literal">Ti.UI.Window</code>. This button is used to launch the four Web Worker processes used in this recipe.<div><pre class="programlisting">var runButton = Ti.UI.createButton({
  title:'Run Web Worker Test', top:40,
  left:10, right:10, height:50, 
});
win.add(runButton);</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec206"/>Testing functions</h3></div></div></div><p>This recipe uses a <code class="literal">tests</code> object to assist <a id="id721" class="indexterm"/>with timing and displaying the results of the Web Worker fibonacci sequence processing. The following section discusses functionality contained within the <code class="literal">tests</code> JavaScript object.</p><div><pre class="programlisting">var tests = {</pre></div><div><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">updateLabel</code> method is used to apply a formatting template to each label with the results of the fibonacci sequence callback results.<div><pre class="programlisting">  updateLabel : function(label,e){
    label.text = "Seed:" + e.seed + " result:" + 
    e.result + " elapsed:" + e.elapsed + "ms";
  },</pre></div></li><li class="listitem">The <code class="literal">worker1</code> through <code class="literal">worker4</code> methods are the callback methods provided to each Web Worker as it processes the fibonacci sequence. These callbacks receive the results from the calculation process.<div><pre class="programlisting">  worker1 : function(e){
    tests.updateLabel(worker1,e);
  },
  worker2 : function(e){
    tests.updateLabel(worker2,e);
  },
  worker3 : function(e){
    tests.updateLabel(worker3,e);
  },
  worker4 : function(e){
    tests.updateLabel(worker4,e);
  },</pre></div></li><li class="listitem">The <code class="literal">random</code> method is used to generate a random number within a given range. This method is used to generate the random number sent to the fibonacci sequence.<div><pre class="programlisting">  random : function(from,to){
    return Math.floor(Math.random()*(to-from+1)+from);
  }
};</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec207"/>Multithreading using Web Workers</h3></div></div></div><p>The multithreading <a id="id722" class="indexterm"/>example is run when the user taps on the <code class="literal">runButton</code> button. The following section demonstrates how four Web Workers are created in the background. Once each Web Worker has finished processing, the results are provided to the test's callback method discussed earlier in this recipe.</p><div><pre class="programlisting">runButton.addEventListener('click',function(e){</pre></div><div><ol class="orderedlist arabic"><li class="listitem">First a new worker object is created by initializing a new instance of the <code class="literal">Ti.WebWorkerWrapper</code> module.<div><pre class="programlisting">  var worker1 = new my.workerMod();</pre></div></li><li class="listitem">Next, the <code class="literal">start</code> method is called on the <code class="literal">worker</code> object. The <code class="literal">start</code> method requires the following arguments:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The path of the JavaScript file the Web Worker should execute</li><li class="listitem" style="list-style-type: disc">A random number passed as a Web Worker <code class="literal">postMessage</code> for the fibonacci sequence to use</li><li class="listitem" style="list-style-type: disc">The callback method to be used when the Web Worker has completed processing<div><pre class="programlisting">  worker1.start('fibonacci.js',tests.random(1,50),
  tests.worker1);</pre></div></li></ul></div></li><li class="listitem">Three additional Web Workers are created using the same pattern demonstrated in the creation of <code class="literal">worker1</code>.<div><pre class="programlisting">  var worker2 = new my.workerMod();
  worker2.start('fibonacci.js',tests.random(1,50),
  tests.worker2);

  var worker3 = new my.workerMod();
  worker3.start('fibonacci.js',tests.random(1,50),
  tests.worker3);

  var worker4 = new my.workerMod();
  worker4.start('fibonacci.js',tests.random(1,50),
  tests.worker4);

});</pre></div></li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec115"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">Ti.WebWorkerWrapper</code> <a id="id723" class="indexterm"/>CommonJS module is used in this recipe to provide multithreading support for the <code class="literal">fibonacci.js</code> computation. For additional details, please visit the module on <a id="id724" class="indexterm"/>Github at <a class="ulink" href="https://github.com/benbahrenburg/Ti.WebWorkerWrapper">https://github.com/benbahrenburg/Ti.WebWorkerWrapper</a>.</li></ul></div></div></div></body></html>