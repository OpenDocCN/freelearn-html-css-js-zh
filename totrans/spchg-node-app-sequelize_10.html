<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer060">
<h1 class="chapter-number" id="_idParaDest-175"><a id="_idTextAnchor184"/>10</h1>
<h1 id="_idParaDest-176"><a id="_idTextAnchor185"/>Deploying a Sequelize Application</h1>
<p>After installing an admin dashboard, configuring our web application to book flights, and having built a backend server, we are now ready to start developing the frontend interface along with deploying the application. Just in time too, because our board members want to see some progress, and they would like to see a working prototype for purchasing a ticket.</p>
<p>Throughout this chapter, and to meet the requirements of our board members, we will need to do the following:</p>
<ul>
<li>Refactor some of our current routes and add another route for listing flight schedules</li>
<li>Integrate Express’ static middleware and secure the admin interface</li>
<li>Create a page to list and book flights</li>
<li>Deploy the application to a service such as Fly.io</li>
</ul>
<h1 id="_idParaDest-177"><a id="_idTextAnchor186"/>Technical requirements</h1>
<p>For the tasks in this chapter, we will be installing the following additional software:</p>
<ul>
<li>A version control manager called Git</li>
<li>The Fly.io CLI for deploying to a cloud application platform</li>
</ul>
<p>You can find the code files for this chapter on GitHub at <a href="https://github.com/PacktPublishing/Supercharging-Node.js-Applications-with-Sequelize/tree/main/ch10">https://github.com/PacktPublishing/Supercharging-Node.js-Applications-with-Sequelize/tree/main/ch10</a>.</p>
<h1 id="_idParaDest-178"><a id="_idTextAnchor187"/>Refactoring and adding flight schedule routes</h1>
<p>Before we <a id="_idIndexMarker761"/>start creating the customer interface for purchasing a <a id="_idIndexMarker762"/>boarding ticket, we will need to make several adjustments to our code base. Let us begin by creating a new file located at <strong class="source-inline">routes/airplanes.js</strong> and moving the <strong class="source-inline">app.post('/airplanes', …)</strong> and <strong class="source-inline">app.get('/airplanes/:id', …)</strong> blocks into that file as follows:</p>
<pre class="source-code">
async function getAirplane(req, res) {
    const airplane = await models.Airplane.findByPk
     (req.params.id);
    if (!airplane) {
        return res.sendStatus(404);
    }
    res.json(airplane);
}
exports.getAirplane = getAirplane;</pre>
<p>This route will return an <strong class="source-inline">Airplane</strong> model record based on the primary key, which is defined in Express’ Request object (indicated by the <strong class="source-inline">:id</strong> symbol). If there were no records to be found, then we will return a <strong class="source-inline">404</strong> (not found) status.</p>
<p>Next, we will take the <strong class="source-inline">createAirplane</strong> code block from <strong class="source-inline">routes/flights.js</strong> and move it into the <strong class="source-inline">routes/airplanes.js</strong> file:</p>
<pre class="source-code">
async function createAirplane(req, res) {
    const { name, seats } = req.body;
    try {
        const airplane = await models.Airplane.create({
            planeModel: name,
            totalSeats: seats,
        });
        return res.json(airplane);
    } catch (error) {
        res.status(500).send(error);
    }
}
exports.createAirplane = createAirplane;</pre>
<p>Within <strong class="source-inline">routes/flights.js</strong>, we <a id="_idIndexMarker763"/>will want to add a <a id="_idIndexMarker764"/>new handler called <strong class="source-inline">flightSchedules</strong>:</p>
<pre class="source-code">
async function flightSchedules(req, res) {
    const records = await models.FlightSchedule.findAll({
       include: [models.Airplane]
    });
    res.json(records);
}
exports.flightSchedules = flightSchedules;</pre>
<p>After that, within the <strong class="source-inline">index.js</strong> file, in the project’s root directory, we can remove the <strong class="source-inline">app.get('/', …)</strong> block and modify the route requiring blocks (just above the block that we removed) to match the new method paths as follows:</p>
<pre class="source-code">
const { bookTicket } = require("./routes/tickets")
const { createSchedule, flightSchedules } = 
require("./routes/flights");
const { getAirplane, createAirplane } = 
require("./routes/airplanes");</pre>
<p>The <strong class="source-inline">app.get('/airplanes/:id', …)</strong> block should now look as follows:</p>
<pre class="source-code">
app.get('/airplanes/:id', getAirplane);</pre>
<p>And below <a id="_idIndexMarker765"/>that, we can add the flight schedule route:</p>
<pre class="source-code">
app.get('/flights', flightSchedules);</pre>
<p>Next, we will <a id="_idIndexMarker766"/>want to adjust the error returned from the customers model. Within <strong class="source-inline">models/customers.js</strong>, replace the existing attributes with the following code:</p>
<pre class="source-code">
    name: {
      type: DataTypes.STRING,
      validate: {
        notEmpty: {
            msg: "A name is required for the customer",
        }
      }
    },
    email: {
      type: DataTypes.STRING,
      validate: {
        isEmail: {
            msg: "Invalid email format for the customer",
        }
      }
    }</pre>
<p>The last modification for flights and booking a ticket involves making some adjustments to the <strong class="source-inline">routes/tickets.js</strong> file. First, we will want to add Sequelize’s <strong class="source-inline">ValidationError</strong> at the top of the file:</p>
<pre class="source-code">
const { ValidationError } = require("@sequelize/core");</pre>
<p>Since we <a id="_idIndexMarker767"/>will be finding, or creating, a customer throughout <a id="_idIndexMarker768"/>the booking process, we will want to change the <strong class="source-inline">req.body</strong> line to this:</p>
<pre class="source-code">
const { scheduleId, seat, name, email } = req.body;</pre>
<p>And below that line, we will add the following:</p>
<pre class="source-code">
const [customer] = await models.Customer.findOrCreate({
    where: {
        email,
    },
    defaults: {
        name,
    }
});</pre>
<p>This will tell Sequelize to find or create a customer record using the email as a key and will hydrate the record with the name (if the record is new) from the <strong class="source-inline">POST</strong> request.</p>
<p>Just above the <strong class="source-inline">await schedule.addBoardingTicket(…)</strong> block, we will want to add a method that defines the customer association for the newly created boarding ticket:</p>
<pre class="source-code">
await boardingTicket.setCustomer(
 customer,
 { transaction: tx }
);</pre>
<p>The remaining modification for this file is replacing the <strong class="source-inline">catch</strong> block with the following code:</p>
<pre class="source-code">
    } catch (error) {
        if (error instanceof ValidationError) {
            let errObj = {};
            error.errors.map(err =&gt; {
               errObj[err.path] = err.message;
            });
            return res.status(400).json(errObj);
        }
        if (error instanceof Error) {
            return res.status(400).send(error.message);
        }
        return res.status(400).send(error.toString());
    }</pre>
<p>This error <a id="_idIndexMarker769"/>block will check whether the incoming error is <a id="_idIndexMarker770"/>a Sequelize <strong class="source-inline">ValidationError</strong> type and if so, will map out the errors to <strong class="source-inline">errorObj</strong> with the column (<strong class="source-inline">err.path</strong>) as a key and the error message (<strong class="source-inline">err.message</strong>) as the value – then, it will return the <strong class="source-inline">error</strong> object. The next <strong class="source-inline">if</strong> block will check whether the error is a generic <strong class="source-inline">Error</strong> type, and if so, return the <strong class="source-inline">error.message</strong> value – otherwise, it will return the <strong class="source-inline">error</strong> variable as a string. This will provide a more ergonomic way of handling errors for a quick prototype website.</p>
<p>Those are all of the modifications that are necessary for managing flights and creating flight tickets. The next step is to set the foundation for our static assets and secure our admin dashboard.</p>
<h1 id="_idParaDest-179"><a id="_idTextAnchor188"/>Integrating Express’ static middleware and securing the admin interface</h1>
<p>Before exposing <a id="_idIndexMarker771"/>our application to the general public, we will need <a id="_idIndexMarker772"/>to secure the admin dashboard routes, along with exposing the static assets for frontend development. First, we will want to create a new directory with an empty file located at <strong class="source-inline">public/index.xhtml</strong>. After that, we can start making modifications to the <strong class="source-inline">index.js</strong> file (within the project’s root directory). At the top, we will need Node.js’ path module:</p>
<pre class="source-code">
const path = require("path");</pre>
<p>Just below the <strong class="source-inline">app.use('/graphql', server)</strong> block, we will want to tell Express to serve static assets that are found within the public directory:</p>
<pre class="source-code">
app.use(express.static(path.join(__dirname, "public")));</pre>
<p>Express will try to find a matching file with the associated route in the public directory before cascading down to our API routes (for example, <strong class="source-inline">/airplanes</strong> or <strong class="source-inline">/flights</strong>). The reason why we use <strong class="source-inline">path.join</strong> here is to avoid mismatches from relative paths, which allows us to run the application from any directory.</p>
<p>Next, we will want to secure our admin dashboard – in the name of brevity, we will use the HTTP authentication method. This will require us to install the <strong class="source-inline">express-basic-auth</strong> package:</p>
<p class="source-code">npm i --save express-basic-auth</p>
<p>Add the requirement at the top of <strong class="source-inline">index.js</strong>:</p>
<pre class="source-code">
const basicAuth = require("express-basic-auth");</pre>
<p>Replace the <strong class="source-inline">app.use(adminJs.options.rootPath, router)</strong> block with the following:</p>
<pre class="source-code">
app.use(adminJs.options.rootPath, basicAuth({
        users: { 'admin': 'supersecret' }, challenge: true,
        }), router);</pre>
<p>This will tell Express to ask for a username and password combination (<strong class="source-inline">admin</strong> and <strong class="source-inline">supersecret</strong> respectively) when accessing the AdminJS root path. Now, when we start our application and head over to <strong class="source-inline">http://localhost:3000/admin</strong>, we should be greeted by a login dialog similar to that in <em class="italic">Figure 10.1</em>:</p>
<div>
<div class="IMG---Figure" id="_idContainer053">
<img alt="Figure 10.1 – Admin login " height="322" src="image/Figure_10.01_B17841.jpg" width="882"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.1 – Admin login</p>
<p>Now that <a id="_idIndexMarker773"/>our AdminJS routes are secure, we can <a id="_idIndexMarker774"/>start creating the frontend page that our customers will see when they visit the application.</p>
<p class="callout-heading">Note</p>
<p class="callout">In a real-world scenario application, instead of using basic authentication, we would use another form of authentication such as JSON Web Tokens or a Single Sign-On Service.</p>
<h1 id="_idParaDest-180"><a id="_idTextAnchor189"/>Creating a page to list and book flights</h1>
<p>For this <a id="_idIndexMarker775"/>application, we will be requiring two external libraries to help build <a id="_idIndexMarker776"/>the frontend components for the application. The first <a id="_idIndexMarker777"/>library is <strong class="bold">Bulma</strong>, which is a CSS framework designed for quick prototyping and doesn’t require its own JavaScript library. For more information on Bulma, you can <a id="_idIndexMarker778"/>visit its website, located at <a href="https://bulma.io/">https://bulma.io/</a>. The next library is <strong class="bold">AlpineJS</strong>, which <a id="_idIndexMarker779"/>is a framework that helps us avoid writing JavaScript to modify states or behaviors by using HTML tags <a id="_idIndexMarker780"/>and markup. More information can be found at <a href="https://alpinejs.dev/">https://alpinejs.dev/</a>.</p>
<p class="callout-heading">Note</p>
<p class="callout">Other fantastic frontend frameworks that can be used instead of AlpineJS include VueJS, React, or Deepkit. AlpineJS was chosen for this book due to its minimal setup and requirements.</p>
<p>Let us start <a id="_idIndexMarker781"/>with the bare necessities, the HTML for a simple header <a id="_idIndexMarker782"/>section of the website:</p>
<ol>
<li>Within <strong class="source-inline">public/index.xhtml</strong>, add the following code:<p class="source-code">&lt;!DOCTYPE html&gt;</p><p class="source-code">&lt;html&gt;</p><p class="source-code">&lt;head&gt;</p><p class="source-code">  &lt;meta charset="utf-8"&gt;</p><p class="source-code">  &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;</p><p class="source-code">  &lt;title&gt;Welcome to Avalon Airlines!&lt;/title&gt;</p><p class="source-code">  &lt;link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"&gt;</p><p class="source-code">  &lt;script src="https://unpkg.com/alpinejs@3.10.3/dist/cdn.min.js" defer&gt;&lt;/script&gt;</p><p class="source-code">&lt;/head&gt;</p><p class="source-code">&lt;body&gt;</p><p class="source-code">  &lt;section class="section"&gt;</p><p class="source-code">    &lt;div class="container"&gt;</p><p class="source-code">      &lt;h1 class="title"&gt;</p><p class="source-code">        Welcome to Avalon Airlines!</p><p class="source-code">      &lt;/h1&gt;</p><p class="source-code">      &lt;p class="subtitle"&gt;</p><p class="source-code">        Where would you like to go </p><p class="source-code">         &lt;strong&gt;today&lt;/strong&gt;?</p><p class="source-code">      &lt;/p&gt;</p><p class="source-code">    &lt;/div&gt;</p><p class="source-code">  &lt;/section&gt;</p><p class="source-code">&lt;/body&gt;</p><p class="source-code">&lt;/html&gt;</p></li>
<li>After <a id="_idIndexMarker783"/>the first <strong class="source-inline">&lt;section&gt;</strong>, we will want to add another <a id="_idIndexMarker784"/>with a container separated by two columns as follows:<p class="source-code">  &lt;section class="section"&gt;</p><p class="source-code">    &lt;div class="container"&gt;</p><p class="source-code">      &lt;div class="columns" x-data="{</p><p class="source-code">                    flights: [],</p><p class="source-code">                    selected: {}</p><p class="source-code">                  }" x-init="fetch('/flights')</p><p class="source-code">                      .then(res =&gt; res.json())</p><p class="source-code">                      .then(res =&gt; flights = res)"&gt;</p><p class="source-code">        &lt;div class="column"&gt;</p><p class="source-code">        &lt;/div&gt;</p><p class="source-code">        &lt;div class="column"&gt;</p><p class="source-code">      &lt;/div&gt;</p><p class="source-code">    &lt;/div&gt;</p><p class="source-code">  &lt;/section&gt;</p></li>
</ol>
<p>The <strong class="source-inline">x-data</strong> attribute will tell AlpineJS what kind of shape our model and data will hold. This <a id="_idIndexMarker785"/>data will be propagated down to children elements. The <strong class="source-inline">x-init</strong> attribute will run upon initialization of the element and will <a id="_idIndexMarker786"/>fetch from our API calling <strong class="source-inline">/flights</strong>. Afterward, we take the results and convert them into a JSON object and then we assign the JSON response to the <strong class="source-inline">flights</strong> array within our <strong class="source-inline">x-data</strong> attribute.</p>
<ol>
<li value="3">In the first column, from the section that we just created, we will want to create a table that renders all of the available flights:<p class="source-code">&lt;table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth"&gt;</p><p class="source-code">    &lt;thead&gt;</p><p class="source-code">      &lt;tr&gt;</p><p class="source-code">        &lt;th&gt;Origin&lt;/th&gt;</p><p class="source-code">        &lt;th&gt;Departure&lt;/th&gt;</p><p class="source-code">        &lt;th&gt;Departure Time&lt;/th&gt;</p><p class="source-code">        &lt;th&gt;Model&lt;/th&gt;</p><p class="source-code">        &lt;th&gt;&lt;/th&gt;</p><p class="source-code">      &lt;/tr&gt;</p><p class="source-code">    &lt;/thead&gt;</p><p class="source-code">    &lt;tbody&gt;</p><p class="source-code">      &lt;template x-for="flight in flights"&gt;</p><p class="source-code">        &lt;tr&gt;</p><p class="source-code">          &lt;td x-text="flight.originAirport"&gt;&lt;/td&gt;</p><p class="source-code">          &lt;td x-text="flight.destinationAirport"&gt;&lt;/td&gt;</p><p class="source-code">          &lt;td x-text="flight.departureTime"&gt;&lt;/td&gt;</p><p class="source-code">          &lt;td x-text=</p><p class="source-code">           "flight.Airplane.planeModel"&gt;&lt;/td&gt;</p><p class="source-code">          &lt;td&gt;&lt;button x-on:click="selected = flight" </p><p class="source-code">           class="button is-primary is-light is-</p><p class="source-code">           small"&gt;Book</p><p class="source-code">              Flight&lt;/button&gt;&lt;/td&gt;</p><p class="source-code">        &lt;/tr&gt;</p><p class="source-code">      &lt;/template&gt;</p><p class="source-code">    &lt;/tbody&gt;</p><p class="source-code">  &lt;/table&gt;</p></li>
</ol>
<p>AlpineJS <a id="_idIndexMarker787"/>will recognize the <strong class="source-inline">x-for</strong> attribute, which operates <a id="_idIndexMarker788"/>similarly to <strong class="source-inline">for</strong> loops in other languages – anything inside of that block will be rendered for each iteration. If the <strong class="source-inline">flights</strong> array is empty, then the <strong class="source-inline">template</strong> block will not be rendered. The <strong class="source-inline">x-on:click</strong> attribute will add a click event listener to the <strong class="source-inline">button</strong> element, which will assign the selected variable (part of our <strong class="source-inline">x-data</strong> model from the parent element) to the associated flight entry.</p>
<ol>
<li value="4">Next, we will want to create the logic for handling our form submission. Just above the closing body tag (<strong class="source-inline">&lt;/body&gt;</strong>), we will want to add the following:<p class="source-code">&lt;script&gt;</p><p class="source-code">  function flightForm() {</p><p class="source-code">    return {</p><p class="source-code">      data: {</p><p class="source-code">        email: "",</p><p class="source-code">        name: "",</p><p class="source-code">        seat: "",</p><p class="source-code">        success: false,</p><p class="source-code">      },</p><p class="source-code">      formMessages: [],</p><p class="source-code">      loading: false,</p></li>
</ol>
<p>The <strong class="source-inline">data</strong>, <strong class="source-inline">formMessages</strong>, and <strong class="source-inline">loading</strong> variables are all states for AlpineJS. We can choose whatever names we want, as it does not matter for AlpineJS. </p>
<ol>
<li value="5">Now, for the <a id="_idIndexMarker789"/>submission event handling part, just below <a id="_idIndexMarker790"/>the <strong class="source-inline">loading: false</strong> block, add the following:<p class="source-code">      submit(e) {</p><p class="source-code">        this.loading = true;</p><p class="source-code">        fetch("/book-flight", {</p><p class="source-code">          method: "POST",</p><p class="source-code">          headers: {</p><p class="source-code">            "Content-Type": "application/json",</p><p class="source-code">            "Accept": "application/json",</p><p class="source-code">          },</p><p class="source-code">          body: JSON.stringify({</p><p class="source-code">            ...this.data,</p><p class="source-code">            scheduleId: this.selected.id,</p><p class="source-code">          }),</p><p class="source-code">        })</p></li>
</ol>
<p>Once the submit event has been invoked, a <strong class="source-inline">POST</strong> <strong class="source-inline">/book-flight</strong> request is made with the necessary JSON headers and body parameters. The <strong class="source-inline">this.selected.id</strong> variable will reference our parent’s element’s <strong class="source-inline">x-data</strong> model. </p>
<ol>
<li value="6">After the fetch, we <a id="_idIndexMarker791"/>will need to handle the appropriate responses. Let <a id="_idIndexMarker792"/>us start with a successful path and add the following code just after the fetch block:<p class="source-code">          .then(async (response) =&gt; {</p><p class="source-code">            const { headers, ok, message, body } = </p><p class="source-code">             response;</p><p class="source-code">            const isJson = headers.get('content-</p><p class="source-code">             type')?.includes('application/json');</p><p class="source-code">            const data = isJson ? await </p><p class="source-code">             response.json() : await response.text();</p><p class="source-code">            if (!ok) {</p><p class="source-code">              return Promise.reject(isJson ? </p><p class="source-code">              Object.values(data) : data);</p><p class="source-code">            }</p><p class="source-code">           // boarding ticket was successfully created</p><p class="source-code">            this.formMessages = [];</p><p class="source-code">            this.data = {</p><p class="source-code">              email: "",</p><p class="source-code">              name: "",</p><p class="source-code">              seat: this.data.seat,</p><p class="source-code">              success: true,</p><p class="source-code">            }</p><p class="source-code">          })</p></li>
</ol>
<p>This method <a id="_idIndexMarker793"/>will check whether the data is JSON or plain text. Then, it will <a id="_idIndexMarker794"/>check whether the response is OK (and return a rejected promise if it returned errors). If the ticket was successfully created, we will reset the email, name, and seat to their initial values and set <strong class="source-inline">success</strong> to <strong class="source-inline">true</strong>.</p>
<p class="callout-heading">Note</p>
<p class="callout">We are setting the name and email to empty strings in the previous example to clear out the current form’s data. If we were to omit these explicit values, then AlpineJS would show the name and email inputs with their previous values when the <strong class="source-inline">flightForm</strong> appears on the screen.</p>
<ol>
<li value="7">After that, we can add the <strong class="source-inline">catch</strong> and <strong class="source-inline">finally</strong> blocks and close the remaining script:<p class="source-code">          .catch((err) =&gt; {</p><p class="source-code">            this.formMessages = Array.isArray(err) ? </p><p class="source-code">             err : [err];</p><p class="source-code">          })</p><p class="source-code">          .finally(() =&gt; {</p><p class="source-code">            this.loading = false;</p><p class="source-code">          });</p><p class="source-code">      },</p><p class="source-code">    };</p><p class="source-code">  }</p><p class="source-code">&lt;/script&gt;</p></li>
</ol>
<p>The caught error will propagate itself to <strong class="source-inline">formMessages</strong> as an array and regardless of success or failure, we will want to use the <strong class="source-inline">finally</strong> block to set the loading state to <strong class="source-inline">false</strong>.</p>
<ol>
<li value="8">Let’s return <a id="_idIndexMarker795"/>to the section with the two columns that we created <a id="_idIndexMarker796"/>earlier – in the second column, we will want to add a success message as well as the form itself. We will start with a section that displays information about the currently selected flight for our form:<p class="source-code">&lt;div x-show="!!selected.id"&gt;</p><p class="source-code">  &lt;section class="hero is-info"&gt;</p><p class="source-code">    &lt;div class="hero-body"&gt;</p><p class="source-code">      &lt;p class="title"&gt;</p><p class="source-code">        &lt;span x-text="selected.originAirport"&gt;&lt;/span&gt; &amp;#8594; &lt;span x-text="selected.destinationAirport"&gt;</p><p class="source-code">        &lt;/span&gt;</p><p class="source-code">      &lt;/p&gt;</p><p class="source-code">      &lt;p class="subtitle"&gt;</p><p class="source-code">        Departs at &lt;span x-text="selected.</p><p class="source-code">        departureTime"&gt;&lt;/span&gt;</p><p class="source-code">      &lt;/p&gt;</p><p class="source-code">    &lt;/div&gt;</p><p class="source-code">  &lt;/section&gt;</p></li>
</ol>
<p>The <strong class="source-inline">x-show</strong> attribute will hide an element if the value yields as <strong class="source-inline">true</strong>. The next few elements <a id="_idIndexMarker797"/>will use the data from our selected object property <a id="_idIndexMarker798"/>from the parent element’s <strong class="source-inline">x-data</strong> model. This element should be hidden until we select a flight. The <strong class="source-inline">x-text</strong> attribute will tell AlpineJS to render the element’s <strong class="source-inline">innerText</strong> to the value associated with the attribute (for example, <strong class="source-inline">selected.originAirport</strong>, or <strong class="source-inline">selected.departureTime</strong>).</p>
<ol>
<li value="9">Once the <strong class="source-inline">hero</strong> section is setup, we will add a form for the success message when a flight is successfully booked:<p class="source-code">&lt;form x-data="flightForm()" @submit.prevent="submit"&gt;</p><p class="source-code">  &lt;div x-show="!!data.success"&gt;</p><p class="source-code">    &lt;section class="hero is-primary"&gt;</p><p class="source-code">      &lt;div class="hero-body"&gt;</p><p class="source-code">        &lt;p class="title"&gt;</p><p class="source-code">          Your boarding ticket has been created!</p><p class="source-code">        &lt;/p&gt;</p><p class="source-code">        &lt;p class="subtitle"&gt;</p><p class="source-code">          Your seat for this flight is &lt;span </p><p class="source-code">           x-text="data.seat"&gt;&lt;/span&gt;</p><p class="source-code">        &lt;/p&gt;</p><p class="source-code">      &lt;/div&gt;</p><p class="source-code">    &lt;/section&gt;</p><p class="source-code">    &lt;div class="mt-4 field is-grouped is-grouped-  </p><p class="source-code">     centered"&gt;</p><p class="source-code">      &lt;p class="control"&gt;</p><p class="source-code">        &lt;a class="button is-light" </p><p class="source-code">          x-on:click="selected = {}; data.success =     </p><p class="source-code">          false; data.seat = ''"&gt;</p><p class="source-code">          OK</p><p class="source-code">        &lt;/a&gt;</p><p class="source-code">      &lt;/p&gt;</p><p class="source-code">    &lt;/div&gt;</p><p class="source-code">  &lt;/div&gt;</p></li>
</ol>
<p>We encapsulated <a id="_idIndexMarker799"/>the states of <strong class="source-inline">flightForm</strong> and the events <a id="_idIndexMarker800"/>within the <strong class="source-inline">&lt;form&gt;</strong> tag. The <strong class="source-inline">@submit.prevent="submit"</strong> attribute will tell AlpineJS to prevent bubble propagation when submitting the event and to use our <strong class="source-inline">submit</strong> function inside of the <strong class="source-inline">flightForm</strong> method. </p>
<p>Next, we will check to see whether <strong class="source-inline">success</strong> is <strong class="source-inline">true</strong> and if so, show the order confirmation section. We will want some way to reset the state once a client has purchased a ticket (in case they want to purchase another ticket), which is what the <strong class="source-inline">x-on:click</strong> event does when we click the <strong class="bold">OK</strong> button.</p>
<ol>
<li value="10">Now, for the actual form, we will check to see whether <strong class="source-inline">data.success</strong> is <strong class="source-inline">false</strong> and if so, show the form with some basic fields. Inside the same <strong class="source-inline">form</strong> attribute, add the following:<p class="source-code">&lt;div x-show="!data.success"&gt;</p><p class="source-code">  &lt;div class="field pt-4"&gt;</p><p class="source-code">    &lt;label class="label"&gt;Full Name&lt;/label&gt;</p><p class="source-code">    &lt;div class="control"&gt;</p><p class="source-code">      &lt;input class="input" type="text" x-model=</p><p class="source-code">       "data.name" placeholder="e.g Alex Smith"&gt;</p><p class="source-code">    &lt;/div&gt;</p><p class="source-code">  &lt;/div&gt;</p><p class="source-code">  &lt;div class="field"&gt;</p><p class="source-code">    &lt;label class="label"&gt;Your Email&lt;/label&gt;</p><p class="source-code">    &lt;div class="control"&gt;</p><p class="source-code">      &lt;input class="input" type="email" </p><p class="source-code">        x-model="data.email"</p><p class="source-code">        placeholder="e.g. alexsmith@avalon-</p><p class="source-code">        airlines.com"&gt;</p><p class="source-code">    &lt;/div&gt;</p><p class="source-code">  &lt;/div&gt;</p><p class="source-code">  &lt;div class="field"&gt;</p><p class="source-code">    &lt;label class="label"&gt;Seat Selection&lt;/label&gt;</p><p class="source-code">    &lt;div class="control"&gt;</p><p class="source-code">      &lt;input class="input" type="text" </p><p class="source-code">        x-model="data.seat" placeholder="e.g. 1A"&gt;</p><p class="source-code">    &lt;/div&gt;</p><p class="source-code">  &lt;/div&gt;</p></li>
</ol>
<p>The <strong class="source-inline">x-model</strong> attribute <a id="_idIndexMarker801"/>will bind the input’s value with <a id="_idIndexMarker802"/>the <strong class="source-inline">x-data</strong> object (for example, <strong class="source-inline">x-model="data.email"</strong> will associate itself with the <strong class="source-inline">data.email</strong> attribute of <strong class="source-inline">flightForm</strong>). </p>
<ol>
<li value="11">Just below this code, we can add the call-to-action buttons for purchasing a ticket or canceling the order:<p class="source-code">&lt;div class="field is-grouped is-grouped-centered"&gt;</p><p class="source-code">  &lt;p class="control"&gt;</p><p class="source-code">    &lt;button type="submit" :disabled="loading" </p><p class="source-code">    class="button is-primary"&gt;</p><p class="source-code">      Purchase Ticket</p><p class="source-code">    &lt;/button&gt;</p><p class="source-code">  &lt;/p&gt;</p><p class="source-code">  &lt;p class="control"&gt;</p><p class="source-code">    &lt;a class="button is-light" x-on:click="selected = {}; </p><p class="source-code">    data.success = false; formMessages = []"&gt;</p><p class="source-code">      Cancel</p><p class="source-code">    &lt;/a&gt;</p><p class="source-code">  &lt;/p&gt;</p><p class="source-code">&lt;/div&gt;</p></li>
</ol>
<p>The <strong class="source-inline">:disabled</strong> attribute is an AlpineJS shorthand code for disabling a particular element <a id="_idIndexMarker803"/>under a specific condition (in our case, this would <a id="_idIndexMarker804"/>be the loading variable). Clicking on the <strong class="bold">Cancel</strong> button will reset the selected data, set the <strong class="source-inline">data.success</strong> variable to <strong class="source-inline">false</strong>, and make <strong class="source-inline">formMessages</strong> into an empty array.</p>
<ol>
<li value="12">Finally, we can add a template for handling our <strong class="source-inline">formMessages</strong> variable and close the remaining HTML tags:<p class="source-code">                &lt;template x-for="message in </p><p class="source-code">                 formMessages"&gt;</p><p class="source-code">                  &lt;article class="message is-warning"&gt;</p><p class="source-code">                    &lt;div class="message-header"&gt;</p><p class="source-code">                      &lt;p&gt;A correction is required&lt;/p&gt;</p><p class="source-code">                    &lt;/div&gt;</p><p class="source-code">                    &lt;div x-text="message" class=</p><p class="source-code">                     "message-body"&gt;&lt;/div&gt;</p><p class="source-code">                  &lt;/article&gt;</p><p class="source-code">                &lt;/template&gt;</p><p class="source-code">              &lt;/div&gt;</p><p class="source-code">            &lt;/form&gt;</p></li>
</ol>
<p>Our frontend <a id="_idIndexMarker805"/>application should now be complete. If we visit <strong class="source-inline">http://localhost:3000/</strong>, it should <a id="_idIndexMarker806"/>look similar to <em class="italic">Figure 10.2</em>. Clicking on the <strong class="bold">Book Flight</strong> button should generate something similar to <em class="italic">Figure 10.3</em>:</p>
<div>
<div class="IMG---Figure" id="_idContainer054">
<img alt="Figure 10.2 – Welcome to Avalon Airlines! " height="374" src="image/Figure_10.02_B17841.jpg" width="867"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.2 – Welcome to Avalon Airlines!</p>
<div>
<div class="IMG---Figure" id="_idContainer055">
<img alt="Figure 10.3 – Booking a flight " height="775" src="image/Figure_10.03_B17841.jpg" width="1255"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.3 – Booking a flight</p>
<p>When <a id="_idIndexMarker807"/>we click on <strong class="bold">Purchase Ticket</strong> without entering any information, we <a id="_idIndexMarker808"/>should be greeted with a few warnings, as shown in <em class="italic">Figure 10.4</em>:</p>
<div>
<div class="IMG---Figure" id="_idContainer056">
<img alt="Figure 10.4 – Warnings from Sequelize " height="1115" src="image/Figure_10.04_B17841.jpg" width="1366"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.4 – Warnings from Sequelize</p>
<p>When we <a id="_idIndexMarker809"/>enter in the appropriate information, the application will <a id="_idIndexMarker810"/>create a new customer and boarding ticket along with a success message, as shown in <em class="italic">Figure 10.5</em>:</p>
<div>
<div class="IMG---Figure" id="_idContainer057">
<img alt="Figure 10.5 – The success message " height="681" src="image/Figure_10.05_B17841.jpg" width="1484"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.5 – The success message</p>
<p>Visiting the <a id="_idIndexMarker811"/>admin dashboard will confirm that our ticket and customer <a id="_idIndexMarker812"/>account were created successfully. We can see the boarding tickets at <strong class="source-inline">http://localhost:3000/admin/resources/BoardingTickets</strong> (remember to log in with appropriate credentials), similar to <em class="italic">Figure 10.6</em>:</p>
<div>
<div class="IMG---Figure" id="_idContainer058">
<img alt="Figure 10.6 – The admin dashboard showing the boarding tickets " height="553" src="image/Figure_10.06_B17841.jpg" width="1067"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.6 – The admin dashboard showing the boarding tickets</p>
<p>It looks as <a id="_idIndexMarker813"/>though our application is ready to be deployed. In the next <a id="_idIndexMarker814"/>section, we will go over the requirements for setting up an environment on a cloud application platform such as Fly.io.</p>
<h1 id="_idParaDest-181"><a id="_idTextAnchor190"/>Deploying the application</h1>
<p>Before we begin, we will want to make sure our project is initialized as a git repository, if your machine <a id="_idTextAnchor191"/><a id="_idIndexMarker815"/>does not have git installed you may find instruction <a id="_idIndexMarker816"/>on how to install the binary here <a href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git">https://git-scm.com/book/en/v2/Getting-Started-Installing-Git</a>. If you’ve been following along, and haven’t yet initialized your project as a git repository, you can do so by running the following command in your project’s root directory:</p>
<p class="source-code">git init</p>
<p>For the deployment process, we will use a cloud hosting service <a id="_idIndexMarker817"/>called <strong class="bold">Fly.io</strong> (<a href="https://fly.io/">https://fly.io/</a>). Fly.io offers a useful command line tool to help us register and authenticate into an account in addition to making application deployments easier. Detailed <a id="_idIndexMarker818"/>instructions on getting started with Fly.io’s CLI can be found at <a href="https://fly.io/docs/hands-on/install-flyctl/">https://fly.io/docs/hands-on/install-flyctl/</a>.</p>
<p>For MacOS users, with Homebrew, we can install the binary with this command:</p>
<p class="source-code">brew install flyctl</p>
<p>Linux users can install the binary with this command:</p>
<p class="source-code">curl -L https://fly.io/install.sh | sh</p>
<p>For Window users, Fly.io recommends using the PowerShell for downloading the binary:</p>
<p class="source-code">iwr https://fly.io/install.ps1 -useb | iex</p>
<p>Once the binary installation has been completed, we will need to login, or register a new account, and then create a new application. If you have not created your free Fly.io account previously, we can use the following command to get started</p>
<p class="source-code">flyctl auth signup</p>
<p>Alternatively, we can authenticate ourselves if we had registered an account previously:</p>
<p class="source-code">flyctl auth login</p>
<p>After we have authenticated, we can now deploy our application:</p>
<p class="source-code">flyctl launch</p>
<p>This command will ask us for an application name and region which we can leave these values as blank or its default value. We will also be asked if we want to create a Postgres database and deploy the application right away which we should decline by entering in the “n” key as a response. The following should look similar to your screen:</p>
<p class="source-code">Creating app in /Users/daniel/Documents/Book/code/ch10</p>
<p class="source-code">Scanning source code</p>
<p class="source-code">Detected a NodeJS app</p>
<p class="source-code">Using the following build configuration:</p>
<p class="source-code">	Builder: heroku/buildpacks:20</p>
<p class="source-code">? App Name (leave blank to use an auto-generated name):</p>
<p class="source-code">Automatically selected personal organization: Daniel Durante</p>
<p class="source-code">? Select region: iad (Ashburn, Virginia (US))</p>
<p class="source-code">Created app nameless-shape-3908 in organization personal</p>
<p class="source-code">Wrote config file fly.toml</p>
<p class="source-code">? Would you like to set up a Postgresql database now? No</p>
<p class="source-code">? Would you like to deploy now? No</p>
<p class="source-code">Your app is ready. Deploy with `flyctl deploy`</p>
<p>Don’t deploy <a id="_idIndexMarker819"/>the application just yet. We will need to enable MySQL with our Fly.io application first. At the moment, Fly.io does not offer a way to sidecar a MySQL database within the same application as our web application. The solution for this is to create a separate a Fly.io application with MySQL only.</p>
<p>In the project’s root directory, we will want to create a new folder called, “fly-mysql” and run the following command within that folder:</p>
<p class="source-code">fly launch</p>
<p>Respond to the questions the same way we originally did in the previous <strong class="source-inline">fly launch</strong> command. Now, our database will need to be stored somewhere, so let us begin by creating a volume on Fly.io and choosing the same region as the previous step. Within the <em class="italic">fly-mysql</em> directory run the following command to create a new volume:</p>
<p class="source-code">fly volumes create mysqldata --size 1</p>
<p class="callout-heading">Note</p>
<p class="callout">The “--size” parameter for <strong class="source-inline">fly volumes create &lt;name&gt;</strong> references the number of gigabytes as its unit. For more information about the <strong class="source-inline">volumes</strong> Fly.io subcommand more information <a id="_idIndexMarker820"/>can be found at <a href="https://fly.io/docs/reference/volumes/">https://fly.io/docs/reference/volumes/</a>.</p>
<p>Now, we can <a id="_idIndexMarker821"/>set our passwords for the MySQL instance (replace “password” with something more appropriate):</p>
<p class="source-code">fly secrets set MYSQL_PASSWORD=password MYSQL_ROOT_PASSWORD=root_password</p>
<p>Throughout this process, Fly.io has created a <strong class="source-inline">fly.toml</strong> file for its applications (one for our web application in the project’s root directory and another for MySQL in the <strong class="source-inline">fly-mysql</strong> directory). This is similar to Heroku’s <strong class="source-inline">Procfile</strong> or CloudFlare’s <strong class="source-inline">wrangler.toml</strong> file. Within the fly.toml file we will want to replace its contents, after the first line (the application’s name) or starting from the <strong class="source-inline">kill_signal</strong> line, with the following:</p>
<pre class="source-code">
kill_signal = “SIGINT”
kill_timeout = 5
[mounts]
  source=”mysqldata”
  destination=”/data”
[env]
  MYSQL_DATABASE = “avalon_airlines”
  MYSQL_USER = “avalon_airlines”
[build]
  image = “mysql:5.7”
[experimental]
  cmd = [
    “--default-authentication-plugin”,
    “mysql_native_password”,
    “--datadir”,
    “/data/mysql”
  ]</pre>
<p>After modifying <a id="_idIndexMarker822"/>the file’s contents, we can scale our MySQL application to have 256 MB of RAM and deploy the MySQL instance:</p>
<p class="source-code">fly scale memory 256</p>
<p class="source-code">fly deploy</p>
<p>Now, going back to the project’s root directory, we can add a <strong class="source-inline">DATABSE_URL</strong> environment secret to our web application’s Fly.io configuration by running the following command:</p>
<p class="source-code">flyctl secrets set DATABASE_URL=mysql://avalon_airlines:&lt;YOUR PASSWORD&gt;@&lt;YOUR MYSQL’S APPLICATION NAME&gt;.internal/avalon_airlines</p>
<p>Replace <strong class="source-inline">YOUR_PASSWORD</strong> with the password that was previously set for the MySQL’s application’s <strong class="source-inline">MYSQL_PASSWORD</strong> secret. Your MySQL’s application name should be available in the <strong class="source-inline">fly-mysql/fly.toml</strong> file marked with the <strong class="source-inline">app</strong> key.</p>
<p class="callout-heading">Note</p>
<p class="callout">If you lose track of your application’s names, the Fly.io CLI provides a way to list all of your account’s application using the <strong class="source-inline">flyctl apps list</strong> command.</p>
<p>We will need to make some modifications to the <strong class="source-inline">package.json</strong> file. Since the application’s builder is using Heroku’s buildpacks, the application will be built with whatever the latest <strong class="bold">Long-Term Supported</strong> (<strong class="bold">LTS</strong>) Node.js version exist. The builder will also run the <strong class="source-inline">start</strong> script by <a id="_idIndexMarker823"/>default which currently uses nodemon. We can ensure the application is <a id="_idIndexMarker824"/>built with the proper Node.js version, and removing the nodemon dependency by replacing the <strong class="source-inline">start</strong> script within <strong class="source-inline">package.json</strong> to look like the following:</p>
<pre class="source-code">
  “scripts”: {
    “start”: “node index.js”,
    “dev”: “nodemon index.js”
  },
  “engines”: {
    “node”: “16.x”
  },</pre>
<p>Now, for when we are developing the application locally, we will want to execute <strong class="source-inline">npm run dev</strong> instead of <strong class="source-inline">npm run start</strong>. </p>
<p class="callout-heading">Note</p>
<p class="callout">More information, and caveats, for <a id="_idIndexMarker825"/>Heroku’s Node.js buildpack can be found at <a href="https://devcenter.heroku.com/articles/nodejs-support">https://devcenter.heroku.com/articles/nodejs-support</a>.</p>
<p>From the Avalon Airlines project, we would need to open and modify the <strong class="source-inline">config/index.js</strong> file and replace the production object with the appropriate database connection values:</p>
<pre class="source-code">
    “production”: {
        “use_env_variable”: “DATABASE_URL”,
        “dialect”: “mysql”
    }</pre>
<p>Fly.io will deploy within a container cluster that exposes ports from a dynamic range. Due to this stipulation, we are required to modify the <strong class="source-inline">app.listen(3000, …)</strong> at the bottom of <strong class="source-inline">index.js</strong>:</p>
<pre class="source-code">
app.listen(process.env.PORT || 3000, function () {
    console.log(“&gt; express server has started”);
});</pre>
<p>This will use the <strong class="source-inline">PORT</strong> environment variable, and default to a value of 3000 if the environment variable is not found, exposing our Express application properly on Fly.io’s ecosystem. There is <a id="_idIndexMarker826"/>one more change on the project root directory within the <strong class="source-inline">fly.toml</strong> file we will need to replace the <strong class="source-inline">[env]</strong> block with the following:</p>
<pre class="source-code">
[env]
  PORT = “8080”
  NODE_ENV = “production”</pre>
<p>Everything else should remain the same, and now, we can deploy and open our application:</p>
<p class="source-code">flyctl deploy</p>
<p class="source-code">flyctl open</p>
<p class="callout-heading">Note</p>
<p class="callout">You may receive a similar error as, “Cannot find module 'sequelize',” this can be from a third-party application dependency such as Admin.js. As a temporarily solution we can manually install, and save, the original Sequelize library by entering <strong class="source-inline">npm i sequelize</strong> into your terminal within the projects directory and re-deploy your application.</p>
<p>You may notice that the website looks a little bare, we can head over to the <strong class="source-inline">/admin</strong> dashboard route and start populating our airplane inventory and flight schedules. Once that is done, we can start processing and booking tickets for Avalon Airlines!</p>
<div>
<div class="IMG---Figure" id="_idContainer059">
<img alt="Figure 10.7 – The Avalon Airlines homepage with a flight scheduled! " height="555" src="image/Figure_10.7_B17841.jpg" width="1216"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.7 – The Avalon Airlines homepage with a flight scheduled!</p>
<h1 id="_idParaDest-182"><a id="_idTextAnchor192"/>Summary</h1>
<p>In this chapter, we went through the process of adding a frontend page with the ability to generate a list of flight schedules and create boarding tickets. We also learned how to deploy our application to a cloud application environment.</p>
<p>Congratulations! We have completed the process of becoming familiar with Sequelize to deploying a Sequelize-based web application. In a real-world scenario, we would want to make a few more adjustments, such as securely storing database credentials, setting up transactional emails, adding more pages, processing credit cards, and having an actual seating inventory management system. At this point, the rest is up to you and only the sky is the limit! Hopefully, this will be a satisfying start for you! It certainly should be, because the Avalon Airlines board members are pleased so far, and they’ve decided to fund our next round.</p>
</div>
</div></body></html>