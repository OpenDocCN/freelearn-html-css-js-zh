<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Saving the Game's Progress</h1></div></div></div><p>
<em>Local storage<a id="id610" class="indexterm"/> is a new specification from HTML5. It allows a website to store information in the browser locally and access the stored data later. This is a useful feature in game development because we can use it as a memory slot to save any game data locally in a web browser.</em>
</p><p>We are going to add the feature of storing game data in the CSS3 card matching game we built in <a class="link" href="ch03.html" title="Chapter 3. Building a Card-matching Game in CSS3">Chapter 3</a>, <em>Building a Card-matching Game in CSS3</em>. Besides storing and loading the game data, we will also notify the player when they break a record with a nice 3D ribbon using pure CSS3 styling.</p><p>In this chapter, we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Storing data by using HTML5 local storage</li><li class="listitem" style="list-style-type: disc">Saving the object in the local storage</li><li class="listitem" style="list-style-type: disc">Notifying players when they break a new record with a nice ribbon effect</li><li class="listitem" style="list-style-type: disc">Saving the entire game's progress</li></ul></div><p>You may try the<a id="id611" class="indexterm"/> final game at: <a class="ulink" href="http://makzan.net/html5-games/card-matching/">http://makzan.net/html5-games/card-matching/</a>.</p><p>The following screenshot shows the final result we will create in this chapter:</p><div><img src="img/B04290_07_01.jpg" alt="Saving the Game's Progress"/></div><p>So, let's get on with it.</p><div><div><div><div><h1 class="title"><a id="ch07lvl1sec84"/>Storing data using HTML5 local storage</h1></div></div></div><p>Remember the CSS3 card <a id="id612" class="indexterm"/>matching game we made in <a class="link" href="ch03.html" title="Chapter 3. Building a Card-matching Game in CSS3">Chapter 3</a>, <em>Building a Card-matching Game in CSS3</em>? Imagine now that we have published our <a id="id613" class="indexterm"/>game and players are trying their best to perform well in the game.</p><p>We want to show the players whether they played better or worse than the last time. We will save the latest score and inform players whether they are better or not this time, by comparing the scores.</p><p>The reasons we might want to do this are because it gives the player a sense of pride when they perform better, and they may become addicted to our game to try to get higher scores, which is good for us.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec180"/>Creating a game over dialog</h2></div></div></div><p>Before actually saving <a id="id614" class="indexterm"/>anything in the local storage, we need a game over screen. We made a few games in previous chapters. We made a Ping Pong game, the card matching game, the Untangle puzzle game, and a music game. In these games, we did not create any game over screen. Imagine now that we are playing the CSS3 card matching game that we built in <a class="link" href="ch03.html" title="Chapter 3. Building a Card-matching Game in CSS3">Chapter 3</a>, <em>Building a Card-matching Game in CSS3</em>. We successfully match and remove all cards. Once we finish a game a screen pops up and shows the time we took to complete the game.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec85"/>Time for action – creating a game over dialog with the elapsed played time</h1></div></div></div><p>We will continue with the code <a id="id615" class="indexterm"/>from the card matching game <a id="id616" class="indexterm"/>we made in <a class="link" href="ch03.html" title="Chapter 3. Building a Card-matching Game in CSS3">Chapter 3</a>, <em>Building a Card-matching Game in CSS3</em>. Carry out the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the CSS3 matching game folder as our working directory.</li><li class="listitem">Download a background image from the following URL (we will use it as the background of the popup): <a class="ulink" href="http://mak.la/book-assets">http://mak.la/book-assets</a></li><li class="listitem">Place the image in the <code class="literal">images</code> folder.</li><li class="listitem">Open <code class="literal">index.html</code> in any text editor.</li><li class="listitem">We will need a font for the game over popup. Add the following font embedding CSS into the <code class="literal">head</code> section:<div><pre class="programlisting">&lt;link href="http://fonts.googleapis.com/css?family=Orbitron:400,700" rel="stylesheet" type="text/css"&gt;</pre></div></li><li class="listitem">Before the <code class="literal">game</code> section, we add a <code class="literal">div</code> named <code class="literal">timer</code> to show the elapsed playing time. In addition, we add a new <code class="literal">popup</code> section containing the HTML markup of the pop-up dialog:<div><pre class="programlisting">
<strong>&lt;div id="timer"&gt;</strong>
<strong>   Elapsed time: &lt;span id="elapsed-time"&gt;00:00&lt;/span&gt;</strong>
<strong>&lt;/div</strong>&gt;
&lt;section id="game"&gt;
   &lt;div id="cards"&gt;
      &lt;div class="card"&gt;
         &lt;div class="face front"&gt;&lt;/div&gt;
         &lt;div class="face back"&gt;&lt;/div&gt;
      &lt;/div&gt; &lt;!-- .card --&gt;
   &lt;/div&gt; &lt;!-- #cards --&gt;
&lt;/section&gt; &lt;!-- #game --&gt;

<strong>&lt;section id="popup" class="hide"&gt;</strong>
<strong>   &lt;div id="popup-bg"&gt;</strong>
<strong>   &lt;/div&gt;</strong>
<strong>   &lt;div id="popup-box"&gt;</strong>
<strong>      &lt;div id="popup-box-content"&gt;</strong>
<strong>         &lt;h1&gt;You Won!&lt;/h1&gt;</strong>
<strong>         &lt;p&gt;Your Score:&lt;/p&gt;</strong>
<strong>         &lt;p&gt;&lt;span class='score'&gt;13&lt;/span&gt;&lt;/p&gt;</strong>
<strong>      &lt;/div&gt;</strong>
<strong>   &lt;/div&gt;</strong>
<strong>&lt;/section&gt;</strong>
</pre></div></li><li class="listitem">We will now move on to the style sheet. As it is just for styling and not related to our logic yet, we can simply copy the <code class="literal">matchgame.css</code> file from <code class="literal">01-gameover-dialog</code> in the code example bundle.</li><li class="listitem">It is time to edit the<a id="id617" class="indexterm"/> game's logic part. Open the<code class="literal"> matchgame.js</code> file in an editor.</li><li class="listitem">In the jQuery <code class="literal">ready</code> function, we need a variable to store the elapsed time of the game. Then, we <a id="id618" class="indexterm"/>create a timer to count the game every second as follows:<div><pre class="programlisting">$(document).ready(function(){
   ...
  // reset the elapsed time to 0.
  matchingGame.elapsedTime = 0;

  // start the timer
  matchingGame.timer = setInterval(countTimer, 1000);
}</pre></div></li><li class="listitem">Next, we add a <code class="literal">countTimer</code> function that will be executed every second. It displays the elapsed seconds in the minutes and seconds format:<div><pre class="programlisting">function countTimer() {
  matchingGame.elapsedTime++;

  // calculate the minutes and seconds from elapsed time
  var minute = Math.floor(matchingGame.elapsedTime / 60);
  var second = matchingGame.elapsedTime % 60;

  // add padding 0 if minute and second is less than 10
  if (minute &lt; 10) minute = "0" + minute;
  if (second &lt; 10) second = "0" + second;

  // display the elapsed time
  $("#elapsed-time").html(minute+":"+second);
}</pre></div></li><li class="listitem">In the <code class="literal">removeTookCards</code> function that we wrote earlier, add the following highlighted code that executes the game over logic after removing all cards:<div><pre class="programlisting">function removeTookCards() {
  $(".card-removed").remove();

  // check whether all cards are removed and show game over
  if ($(".card").length === 0) {
    gameover();
  }
}</pre></div></li><li class="listitem">And last, we <a id="id619" class="indexterm"/>create the<a id="id620" class="indexterm"/> following <code class="literal">gameover</code> function. It stops the counting timer, displays the elapsed time in the game over popup, and finally shows the popup:<div><pre class="programlisting">function gameover() {
  // stop the timer
  clearInterval(matchingGame.timer);

  // set the score in the game over popup
  $(".score").html($("#elapsed-time").html());

  // show the game over popup
  $("#popup").removeClass("hide");
}</pre></div></li><li class="listitem">Now, save all files and open the game in a browser. Try finishing the card matching game and the game over screen will popup, as shown in the following screenshot:<div><img src="img/B04290_07_02.jpg" alt="Time for action – creating a game over dialog with the elapsed played time"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec181"/>
<em>What just happened?</em>
</h2></div></div></div><p>We used the CSS3<a id="id621" class="indexterm"/> transition animation to<a id="id622" class="indexterm"/> show the game over popup. We benchmark the score by using the time the player utilized to finish the game.</p><div><div><div><div><h3 class="title"><a id="ch07lvl3sec01"/>Counting time</h3></div></div></div><p>We used the time interval to calculate <a id="id623" class="indexterm"/>elapsed time. We provide an interval, for instance, 1 second, and the browser executes our logic at the provided interval. Inside the logic, we count the elapsed seconds. We need to keep in mind that <code class="literal">setInterval</code> does not guarantee the execution of the logic precisely at the given time interval. It's an approximate value. If you need a more precise elapsed time, you may get the time stamp and subtract it from the start time.</p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec182"/>Saving scores in the browser</h2></div></div></div><p>Imagine now that we are going to display how well the player played last time. The game over screen includes the elapsed time as the last score alongside the current game score. Players can then see how well they do this time compared to last time.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec86"/>Time for action – saving the game score</h1></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">First, we need to add <a id="id624" class="indexterm"/>a few markups in the <code class="literal">popup</code> section to<a id="id625" class="indexterm"/> display the last score. Add the following HTML in <code class="literal">popup-box</code> in <code class="literal">index.html</code>. The changed code is highlighted:<div><pre class="programlisting">&lt;section id="popup" class="hide"&gt;
  &lt;div id="popup-bg"&gt;
  &lt;/div&gt;
  &lt;div id="popup-box"&gt;
    &lt;div id="popup-box-content"&gt;
      &lt;h1&gt;You Won!&lt;/h1&gt;
      &lt;p&gt;Your Score:&lt;/p&gt;
      &lt;p&gt;&lt;span class='score'&gt;13&lt;/span&gt;&lt;/p&gt;
      <strong>&lt;p&gt;</strong>
<strong>        &lt;small&gt;Last Score: &lt;span class='last-score'&gt;20&lt;/span&gt;</strong>
<strong>        &lt;/small&gt;</strong>
<strong>      &lt;/p&gt;</strong>
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/section&gt;</pre></div></li><li class="listitem">Then, we open the<code class="literal"> matchgame.js</code> to modify some game logic in the <code class="literal">gameover</code> function.</li><li class="listitem">Add the following highlighted code in the <code class="literal">gameover</code> function. It loads the saved score from the local storage and displays it as the score last time. Then, we save the current score in the local storage:<div><pre class="programlisting">function gameover() {
  // stop the timer
  clearInterval(matchingGame.timer);

  // display the elapsed time in the game over popup
  $(".score").html($("#elapsed-time").html());

  <strong>// load the saved last score from local storage</strong>
<strong>  var lastElapsedTime = localStorage.getItem("last-elapsed-time");</strong>

<strong>  // convert the elapsed seconds</strong>
<strong>  //into minute:second format</strong>
<strong>  // calculate the minutes and seconds</strong>
<strong>  // from elapsed time</strong>
<strong>  var minute = Math.floor(lastElapsedTime / 60);</strong>
<strong>  var second = lastElapsedTime % 60;</strong>

<strong>  // add padding 0</strong>
<strong>  if (minute &lt; 10) minute = "0" + minute;</strong>
<strong>  if (second &lt; 10) second = "0" + second;</strong>

<strong>  // display the last elapsed time in game over popup</strong>
<strong>  $(".last-score").html(minute+":"+second);</strong>

<strong>  // save the score in local storage</strong>
<strong>  localStorage.setItem("last-elapsed-time", matchingGame.elapsedTime);</strong>

  // show the game over popup
  $("#popup").removeClass("hide");
}</pre></div></li><li class="listitem">It is now time to<a id="id626" class="indexterm"/> save all the files and test the game <a id="id627" class="indexterm"/>in the browser. When you finish the game for the first time, the last score should be <code class="literal">00:00</code>. Then, try to finish the game for the second time. The game over popup will show the elapsed time when you played the last time. The following screenshot shows the game over screen with the current and last score:<div><img src="img/B04290_07_03.jpg" alt="Time for action – saving the game score"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec183"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just built a basic scoring system that compares a player's score with their last score.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec184"/>Storing and loading data with local storage</h2></div></div></div><p>We can store data by <a id="id628" class="indexterm"/>using the <code class="literal">setItem</code> function from <a id="id629" class="indexterm"/>the <code class="literal">localStorage</code> object <a id="id630" class="indexterm"/>as <a id="id631" class="indexterm"/>follows:</p><div><pre class="programlisting">localStorage.setItem(key, value);</pre></div><p>The following table shows the <a id="id632" class="indexterm"/>usage of the function:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Argument</p>
</th><th style="text-align: left" valign="bottom">
<p>Definition</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">key</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id633" class="indexterm"/>key is the name of the record that we used to identify an entry</p>
</td><td style="text-align: left" valign="top">
<p>The key is a string and each record has a unique key. Writing a new value to an existing key overwrites the old value.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">value</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id634" class="indexterm"/>value is any data that will be stored</p>
</td><td style="text-align: left" valign="top">
<p>This can be any data, but the final storage is in a string. We will discuss this shortly.</p>
</td></tr></tbody></table></div><p>In our example, we save the game elapsed time as the score with the following code by using the key <code class="literal">last-elapsed-item</code>:</p><div><pre class="programlisting">localStorage.setItem("last-elapsed-time", matchingGame.elapsedTime);</pre></div><p>Complementary to <code class="literal">setItem</code>, we get the stored data by using the <code class="literal">getItem</code> function in the following way:</p><div><pre class="programlisting">localStorage.getItem(key);</pre></div><p>The function returns the stored value of the given key. It returns <code class="literal">null</code> when trying to get a non-existent key. This can be used to check whether we have stored any data for a specific key.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec185"/>The local storage saves the string value</h2></div></div></div><p>The<a id="id635" class="indexterm"/> local storage stores data in a key-value pair. The key and value are both strings. If we save numbers, Boolean, or any type other than a string, then the browser will convert the value into a string while saving. For objects and arrays, we will do our conversion using JSON in a later section.</p><p>Usually, problems occur when we load a saved value from the local storage. The loaded value is a string regardless of the type we are saving. We need to explicitly parse the value into the correct type before using it.</p><p>For example, if we save a floating number into the local storage, we need to use the <code class="literal">parseFloat</code> function when loading it. The following code snippet shows how we can use <code class="literal">parseFloat</code> to retrieve a stored floating number:</p><div><pre class="programlisting">var score = 13.234;

localStorage.setItem("game-score",score);
// result: stored "13.234".

var gameScore = localStorage.getItem("game-score");
// result: get "13.234" into gameScore;

gameScore = parseFloat(gameScore);
// result: 13.234 floating value</pre></div><p>In the preceding <a id="id636" class="indexterm"/>code snippet, the manipulation may be incorrect if we forget to convert <code class="literal">gameScore</code> from a string to a float. For instance, if we increase <code class="literal">gameScore</code> by 1 without the <code class="literal">parseFloat</code> function, the result will be <strong>13.2341</strong> instead of <strong>14.234</strong>. So, be sure to convert the value from the local storage to its correct type.</p><div><div><h3 class="title"><a id="tip09"/>Tip</h3><p>
<strong>Size limitations on local storage</strong>
</p><p>There is a size <a id="id637" class="indexterm"/>limitation on the data stored through <code class="literal">localStorage</code> for each domain. This size limitation may be slightly different in different browsers. Normally, the size limitation is 5 MB. If the limit is exceeded, then the browser throws a <code class="literal">QUOTA_EXCEEDED_ERR</code> exception when setting a key-value into <code class="literal">localStorage</code>.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec186"/>Treating the local storage object as an associative array</h2></div></div></div><p>Besides <a id="id638" class="indexterm"/>using the <code class="literal">setItem</code> and <code class="literal">getItem</code> functions, we <a id="id639" class="indexterm"/>can treat the <code class="literal">localStorage</code> object as an associated array and access the stored entries by using square brackets. For instance, consider the following lines of code:</p><div><pre class="programlisting">localStorage.setItem("last-elapsed-time", elapsedTime);
var lastElapsedTime = localStorage.getItem("last-elapsed-time");</pre></div><p>We can replace the preceding <a id="id640" class="indexterm"/>block of code with the following one and access <code class="literal">localStorage</code> as an<a id="id641" class="indexterm"/> array:</p><div><pre class="programlisting">localStorage["last-elapsed-time"] = elapsedTime;
var lastElapsedTime = localStorage["last-elapsed-time"];</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec87"/>Saving objects in the local storage</h1></div></div></div><p>Now, imagine that we<a id="id642" class="indexterm"/> are saving not only the score, but also the date and<a id="id643" class="indexterm"/> time when the ranking is created. We can either save two separate keys for the score and date time of playing, or pack the two values into one object and store it in the local storage.</p><p>We will pack all the game data into one object and store it.</p></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec88"/>Time for action – saving the time alongside the score</h1></div></div></div><p>Carry out the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">First, open the <code class="literal">index.html</code> file from our CSS3 card matching game.</li><li class="listitem">Replace the HTML markup with the last score, with the following HTML (it shows both scores and the date time in the game over popup):<div><pre class="programlisting">&lt;p&gt;
  &lt;small&gt;Last Score: &lt;span class='last-score'&gt;0&lt;/span&gt;&lt;br&gt;
    Saved on: &lt;span class='saved-time'&gt;&lt;/span&gt;
  &lt;/small&gt;
&lt;/p&gt;</pre></div></li><li class="listitem">The HTML markup is now ready. We will move on to the game logic. Open the <code class="literal">html5games.matchgame.js</code> file in a text editor.</li><li class="listitem">We will modify the <code class="literal">gameover</code> function. Add the following highlighted code to the <code class="literal">gameover</code> function. It gets the current date and time when the game ends and packs a formatted date and time with elapsed time together in the local storage:<div><pre class="programlisting">function gameover() {
   // stop the timer
   clearInterval(matchingGame.timer);

   // display the elapsed time in the game over popup
   $(".score").html($("#elapsed-time"));

   <strong>// load the saved last score and save time from local storage</strong>
<strong>   var lastScore = localStorage.getItem("last-score");</strong>

<strong>   // check if there is no saved record</strong>
<strong>   lastScoreObj = JSON.parse(lastScore);</strong>
<strong>   if (lastScoreObj === null) {</strong>
<strong>      // create an empty record if there is no saved record</strong>
<strong>      lastScoreObj = {"savedTime": "no record", "score": 0};</strong>
<strong>   }</strong>
<strong>   var lastElapsedTime = lastScoreObj.score;</strong>

   // convert the elapsed seconds into minute:second format
   // calculate the minutes and seconds from elapsed time
   var minute = Math.floor(lastElapsedTime / 60);
   var second = lastElapsedTime % 60;

   // add padding 0 if minute and second is less than 10
   if (minute &lt; 10) minute = "0" + minute;
   if (second &lt; 10) second = "0" + second;

   // display the last elapsed time in game over popup
   $(".last-score").html(minute+":"+second);

   <strong>// display the saved time of last score</strong>
<strong>   var savedTime = lastScoreObj.savedTime;</strong>
<strong>   $(".saved-time").html(savedTime);</strong>

<strong>   // get the current datetime</strong>
<strong>   var currentTime = new Date();</strong>

<strong>   // convert date time to string</strong>
<strong>   var now = currentTime.toLocaleString();</strong>

<strong>   //construct the object of datetime and game score</strong>
<strong>   var obj = { "savedTime": now, "score": matchingGame.elapsedTime};</strong>

<strong>   // save the score into local storage</strong>
<strong>   localStorage.setItem("last-score", JSON.stringify(obj));</strong>
   // show the game over popup
   $("#popup").removeClass("hide");
}</pre></div></li><li class="listitem">We will save the<a id="id644" class="indexterm"/> files and open the game in a web <a id="id645" class="indexterm"/>browser.</li><li class="listitem">When we finish the game for the first time, we will get a screen similar to the following screenshot, which will show our game score and state that there are no previous records:<div><img src="img/B04290_07_04.jpg" alt="Time for action – saving the time alongside the score"/></div></li><li class="listitem">Now try<a id="id646" class="indexterm"/> reloading the page and play the game again. When<a id="id647" class="indexterm"/> we finish the game for the second time, the game over dialog will show our saved record. The following screenshot shows how it should look:<div><img src="img/B04290_07_05.jpg" alt="Time for action – saving the time alongside the score"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec187"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just used a <code class="literal">Date</code> object<a id="id648" class="indexterm"/> in JavaScript to get the current date and time when<a id="id649" class="indexterm"/> the game is over. In addition, we packed the game over date and time and the game elapsed time in one object and saved it in the local storage. The saved object is encoded in a JSON string. It will also load the last saved date and time and the game elapsed time from the storage and parse it back to the JavaScript object from a string.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec188"/>Getting the current date and time in JavaScript</h2></div></div></div><p>The <code class="literal">Date</code> object in JavaScript is <a id="id650" class="indexterm"/>used to work with the date and <a id="id651" class="indexterm"/>time. When we create an instance from the <code class="literal">Date</code> object, by default it stores the current date and time. We can get the string representation by using the <code class="literal">toLocaleString</code> method.</p><p>In addition to the string representation, we can manipulate each component in the date object. The following table lists some useful functions in the <code class="literal">Date</code> object<a id="id652" class="indexterm"/> to get the date and time:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Function</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getFullYear</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Returns the<a id="id653" class="indexterm"/> year in four digits</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getMonth</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Returns <a id="id654" class="indexterm"/>the month in an integer, starting from 0 (Jan is 0 and Dec is 11)</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getDate</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Returns<a id="id655" class="indexterm"/> the day of the month, starting from 1</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getDay</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Returns <a id="id656" class="indexterm"/>the day of the week, starting from 0 (Sunday is 0 and Saturday is 6)</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getHours</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Returns<a id="id657" class="indexterm"/> the hour, starting from 0 to 23</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getMinutes</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Returns <a id="id658" class="indexterm"/>the minutes</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getSeconds</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Returns<a id="id659" class="indexterm"/> the seconds</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getMilliseconds</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Returns<a id="id660" class="indexterm"/> the milliseconds in 3 digits</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getTime</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Returns <a id="id661" class="indexterm"/>the number of <a id="id662" class="indexterm"/>milliseconds<a id="id663" class="indexterm"/> since 1 January, 1970, 00:00</p>
</td></tr></tbody></table></div><div><div><h3 class="title"><a id="note27"/>Note</h3><p>The Mozilla Developer Network provides a detailed reference on using the <code class="literal">Date</code> object<a id="id664" class="indexterm"/> at: <a class="ulink" href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date">https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date</a>.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec189"/>Using the native JSON to encode an object into a string</h2></div></div></div><p>We used JSON to represent the game level data in <a class="link" href="ch04.html" title="Chapter 4. Building the Untangle Game with Canvas and the Drawing API">Chapter 4</a>, <em>Building the Untangle Game with Canvas and the Drawing API</em>.</p><p>JSON<a id="id665" class="indexterm"/> is an<a id="id666" class="indexterm"/> object notation format that is friendly for <a id="id667" class="indexterm"/>machines to parse and generate. In this example, we <a id="id668" class="indexterm"/>packed the final elapsed time and the date and time into an object. Then, we encoded the object into JSON. Modern web browsers come with native JSON support. We can easily encode any JavaScript object into JSON by using the <code class="literal">stringify</code> function as follows:</p><div><pre class="programlisting">JSON.stringify(anyObject);</pre></div><p>Normally, we only use the first parameter for the <code class="literal">stringify</code> function. This is the object that we are going to encode as a string. The following code snippet demonstrates the result of an encoded JavaScript object:</p><div><pre class="programlisting">var jsObj = {};
jsObj.testArray = [1,2,3,4,5];
jsObj.name = 'CSS3 Matching Game';
jsObj.date = '8 May, 2011';
JSON.stringify(jsObj);
// result: {"testArray":[1,2,3,4,5],"name":"CSS3 Matching Game","date":"8 May, 2011"}</pre></div><div><div><h3 class="title"><a id="note28"/>Note</h3><p>The <code class="literal">stringify</code> method can parse objects with data structure into a string well. However, it cannot convert anything from an object into a string. For instance, it will return an error if we try to pass a DOM element into it. It will return the string representing the date if we pass a <code class="literal">Date</code> object. Alternatively, it will drop all method definitions of the parsing object.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec190"/>Loading a stored object from a JSON string</h2></div></div></div><p>The complete<a id="id669" class="indexterm"/> form of <strong>JSON</strong>
<a id="id670" class="indexterm"/> is <strong>JavaScript</strong> <strong>Object</strong> <strong>Notation</strong>. From <a id="id671" class="indexterm"/>the name, we know that it uses the syntax from JavaScript to represent an object. Therefore, it is very easy to parse a JSON formatted string back to a JavaScript object.</p><p>The following code snippet shows how we can use the parse function in the JSON object:</p><div><pre class="programlisting">JSON.parse(jsonFormattedString);</pre></div><p>We can open the console in <strong>Web Inspector</strong> to test the JSON JavaScript functions. The following screenshot shows the result of running the code snippets we just discussed when encoding an object and parsing them:</p><div><img src="img/B04290_07_06.jpg" alt="Loading a stored object from a JSON string"/></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec191"/>Inspecting the local storage in a console window</h2></div></div></div><p>After we have saved <a id="id672" class="indexterm"/>something in the local storage, we may <a id="id673" class="indexterm"/>want to know what exactly is saved, before we write the loading part. We can inspect what we have saved by using the storage panel in the <strong>Web Inspector</strong>. It lists all the saved key-value pairs under the same domain. The following screenshot shows that we have the <strong>last-score</strong> key saved with value <strong>{"savedTime":"23/2/2011 19:27:02","score":23}</strong>.</p><p>The value is the result of the <code class="literal">JSON.stringify</code> function we used to encode the object into JSON. You may also try saving an object directly in the local storage:</p><div><img src="img/B04290_07_07.jpg" alt="Inspecting the local storage in a console window"/></div><div><div><h3 class="title"><a id="note29"/>Note</h3><p>Besides <code class="literal">localStorage</code>, there are other storage approaches that were not discussed. <strong>IndexedDB</strong>
<a id="id674" class="indexterm"/> is another option. Check the following URL to see <a id="id675" class="indexterm"/>more details on this: <a class="ulink" href="https://developer.mozilla.org/en/IndexedDB">https://developer.mozilla.org/en/IndexedDB</a>.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec89"/>Notifying players when they break a new record with a nice ribbon effect</h1></div></div></div><p>Imagine that we want to<a id="id676" class="indexterm"/> encourage players by informing them that they <a id="id677" class="indexterm"/>broke a new record compared to the last score. We want to show a ribbon with <code class="literal">New</code> <code class="literal">Record</code> text on it. Thanks to the new CSS3 properties, we can create a ribbon effect completely in CSS.</p></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec90"/>Time for action – creating a ribbon in CSS3</h1></div></div></div><p>We will create a new record <a id="id678" class="indexterm"/>ribbon and display it when a player breaks their last <a id="id679" class="indexterm"/>score. So, carry out the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">First, open <code class="literal">index.html</code> where we will add the ribbon HTML markup.</li><li class="listitem">Add the following highlighted HTML right after <code class="literal">popup-box</code> and before <code class="literal">popup-box-content</code>:<div><pre class="programlisting">&lt;div id="popup-box"&gt;
  &lt;div class="ribbon hide"&gt;
    &lt;div class="ribbon-body"&gt;
      &lt;span&gt;New Record&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class="triangle"&gt;&lt;/div&gt;
  &lt;/div&gt;
  &lt;div id="popup-box-content"&gt;
  ...</pre></div></li><li class="listitem">Next, we need to focus on the style sheet. The entire ribbon effect is done in CSS. Open the <code class="literal">matchgame.css</code> file in a text editor.</li><li class="listitem">In the <code class="literal">popup-box</code> styling, we need to add a relative position to it. We do this as follows:<div><pre class="programlisting">#popup-box {
  position: relative;
}</pre></div></li><li class="listitem">Then, we need to add the following styles that create the ribbon effect in the CSS file:<div><pre class="programlisting">.ribbon.hide {
  display: none;
}
.ribbon {
  float: left;
  position: absolute;
  left: -7px;
  top: 165px;
  z-index: 0;

  font-size: .5em;
  text-transform: uppercase;
  text-align: right;
}

.ribbon-body {
  height: 14px;
  background: #ca3d33;
  padding: 6px;
  z-index: 100;
  box-shadow: 2px 2px 0 rgba(150,120,70,.4);
  border-radius: 0 5px 5px 0;

  color: #fff;
  text-shadow: 0px 1px 1px rgba(0,0,0,.3);
}

.triangle {
  position: relative;
  height: 0px;
  width: 0;
  left: -5px;
  top: -32px;
  border-style: solid;
  border-width: 6px;
  border-color: transparent #882011 transparent transparent;
  z-index: -1;
}</pre></div></li><li class="listitem">Lastly, we need to<a id="id680" class="indexterm"/> modify the game over logic a little bit. Open <a id="id681" class="indexterm"/>the <code class="literal">html5games.matchgame.js</code> file and locate the <code class="literal">gameover</code> function.</li><li class="listitem">Add the following code to the <code class="literal">gameover</code> function, which compares the current score with the last score to determine the new record:<div><pre class="programlisting">if (lastElapsedTime === 0 || matchingGame.elapsedTime &lt; lastElapsedTime) {
   $(".ribbon").removeClass("hide");
}</pre></div></li><li class="listitem">We will test the game in a web browser. Try finishing a game slowly and then finish another game fast. When you break the last score, the game over popup shows a nice <strong>NEW</strong> <strong>RECORD</strong> ribbon, as shown in the following screenshot:<div><img src="img/B04290_07_08.jpg" alt="Time for action – creating a ribbon in CSS3"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec192"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just created <a id="id682" class="indexterm"/>a ribbon effect in a pure CSS3 style with some help<a id="id683" class="indexterm"/> from JavaScript to show and hide it. The ribbon is composed of a little triangle overlaid by a rectangle, as shown in the following screenshot:</p><div><img src="img/B04290_07_09.jpg" alt="What just happened?"/></div><p>Now, how can we create a triangle in CSS? We can create a triangle by setting both the width and height to <code class="literal">0</code> and drawing only one border. The size of the triangle is then decided by the border width. The following is the code for the triangle CSS we used in our new record ribbon:</p><div><pre class="programlisting">.triangle {
   position: relative;
   height: 0px;
   width: 0;
   left: -5px;
   top: -32px;
   border-style: solid;
   border-width: 6px;
   border-color: transparent #882011 transparent transparent;
   z-index: -1;
}</pre></div><div><div><h3 class="title"><a id="note30"/>Note</h3><p>The following PVM Garage<a id="id684" class="indexterm"/> website provides a detailed explanation on pure CSS3 ribbon usage:</p><p>
<a class="ulink" href="http://www.pvmgarage.com/2010/01/how-to-create-depth-and-nice-3d-ribbons-only-using-css3/">http://www.pvmgarage.com/2010/01/how-to-create-depth-and-nice-3d-ribbons-only-using-css3/</a>
</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec193"/>Have a go hero – saving and comparing only to the fastest time</h2></div></div></div><p>Each time the game finishes, it compares the last score with the current score. Then, it saves the current score. How about changing the code to save the highest score and show the new record ribbon when breaking the highest score?</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec91"/>Saving the entire game progress</h1></div></div></div><p>We have enhanced our CSS3<a id="id685" class="indexterm"/> card matching game by adding a game <a id="id686" class="indexterm"/>over screen and storing the last game record. Imagine now that a player is mid-game and accidentally closes the web browser. Once the player opens the game again, the game starts from the beginning and the game that the player was playing is lost. With the local storage, we can encode the entire game's data into JSON and store it. In this way, players can resume their game later.</p><p>We are going to pack the game data into one object and save it into the local storage every second.</p></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec92"/>Time for action – saving all essential game data in the local storage</h1></div></div></div><p>We will continue work with our CSS3 card matching game:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the<code class="literal"> matchgame.js</code> JavaScript file.</li><li class="listitem">Add the following code at the top of the JavaScript file after declaring the <code class="literal">matchingGame</code> variable. This code creates an object named <code class="literal">savingObject</code> to save the array of the deck, the removed cards and the current elapsed time:<div><pre class="programlisting">matchingGame.savingObject = {};

matchingGame.savingObject.deck = [];

// array to store which card is removed by their index.
matchingGame.savingObject.removedCards = [];

// store the counting elapsed time.
matchingGame.savingObject.currentElapsedTime = 0;</pre></div></li><li class="listitem">In the jQuery <a id="id687" class="indexterm"/><code class="literal">ready</code> function, add the <a id="id688" class="indexterm"/>following highlighted code. It clones the order of the deck to the <code class="literal">savingObject</code>. In addition, it assigns an index to each card in the DOM data attribute:<div><pre class="programlisting">$(document).ready(function(){
   // existing code goes here.

   // shuffling the deck
   matchingGame.deck.sort(shuffle);

   <strong>// copying the deck into saving object.</strong>
<strong>   matchingGame.savingObject.deck = matchingGame.deck.slice()</strong>;

   // clone 12 copies of the card DOM
   for(var i=0;i&lt;11;i++){
      $(".card:first-child").clone().appendTo("#cards");
   }

   // existing code goes here.

// embed the pattern data into the DOM element.
$(this).attr("data-pattern",pattern);

// save the index into the DOM element,
<strong>//so we know which is the next card.</strong>
<strong>$(this).attr("data-card-index",index);</strong>
...</pre></div></li><li class="listitem">We have a <code class="literal">countTimer</code> function that executes every second. We add the following highlighted code in the <code class="literal">countTimer</code> function. It saves the current elapsed time in <code class="literal">savingObject</code> and also saves the object in the local storage:<div><pre class="programlisting">function countTimer() {
   matchingGame.elapsedTime++;

   <strong>// save the current elapsed time in savingObject.</strong>
<strong>   matchingGame.savingObject.currentElapsedTime = matchingGame.elapsedTime;</strong>
   ...
   <strong>// save the game progress</strong>
<strong>   saveSavingObject();</strong>
}</pre></div></li><li class="listitem">The game removes cards when the player finds a matching pair. We replace the original <code class="literal">$(".card-removed").remove();</code> code with the following highlighted code in the <code class="literal">removeTookCards</code> function. It remembers which cards are removed in <code class="literal">savingObject</code>:<div><pre class="programlisting">function removeTookCards() {
   <strong>// add each removed card into the array</strong>
<strong>  // which stores the removed cards</strong>
<strong>   $(".card-removed").each(function(){</strong>
<strong>      matchingGame.savingObject.removedCards.push($(this).data("card-index"));</strong>
<strong>      $(this).remove();</strong>
<strong>   });</strong>

   // check whether all cards are removed and show game over
   if ($(".card").length === 0) {
      gameover();
   }
}</pre></div></li><li class="listitem">We have to remove <a id="id689" class="indexterm"/>the saved game data in<a id="id690" class="indexterm"/> the local storage when the game is over. Add the following code at the end of the <code class="literal">gameover</code> function:<div><pre class="programlisting">function gameover() {
   // existing code goes here.

   //at last, we clear the saved savingObject
   localStorage.removeItem("savingObject");
}</pre></div></li><li class="listitem">And last, we use a function to save <code class="literal">savingObject</code> in the local storage:<div><pre class="programlisting">function saveSavingObject() {
    // save the encoded saving object in local storage
    localStorage["savingObject"] = JSON.stringify(matchingGame.savingObject);
}</pre></div></li><li class="listitem">We have modified the code a lot and it is now time to test the game in a web browser. After the game runs, try clearing several matching cards. Then, open the storage panel in the <strong>Web Inspector</strong>. The local storage should contain an entry similar to the one shown in the following screenshot:<div><img src="img/B04290_07_10.jpg" alt="Time for action – saving all essential game data in the local storage"/></div><p>It is a record with a key <code class="literal">savingObject</code> and a value with a long string in a JSON format. The JSON string contains the shuffled deck, removed cards, and the current elapsed time</p></li></ol></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec194"/>
<em>What just happened?</em>
</h2></div></div></div><p>We have just entered <a id="id691" class="indexterm"/>all essential game data into an object <a id="id692" class="indexterm"/>named <code class="literal">savingObject</code>. This <code class="literal">savingObject</code> contains all the information that we need to recreate the game later. It includes the order of cards, removed cards, and the current elapsed time. We will implement the game resuming logic in the next section.</p><p>Lastly, we saved <code class="literal">savingObject</code> in <code class="literal">localStorage</code> each second. The object is encoded in JSON using the <code class="literal">stringify</code> function we used earlier in this chapter.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec195"/>Removing a record from the local storage</h2></div></div></div><p>We need to remove the<a id="id693" class="indexterm"/> saved record when the game is over. Otherwise, the<a id="id694" class="indexterm"/> new game will not start. The local storage provides a <code class="literal">removeItem</code> function to remove a specific record. Here is how we use the function to remove the record with the given key:</p><div><pre class="programlisting">localStorage.removeItem(key);</pre></div><div><div><h3 class="title"><a id="tip10"/>Tip</h3><p>If you want to remove all stored records, then you can use the <code class="literal">localStorage.clear()</code> function.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec196"/>Cloning an array in JavaScript</h2></div></div></div><p>We cloned the shuffled<a id="id695" class="indexterm"/> deck in <code class="literal">savingObject</code>, so that we could use the order of <a id="id696" class="indexterm"/>the deck to recreate the cards when we resumed the game. However, we cannot copy an array by assigning the array to another variable. The following code fails to copy array <code class="literal">a</code> to array <code class="literal">b</code>:</p><div><pre class="programlisting">var a = [1,2,3,4,5];
var b = a;
a.pop();
// result:
// a: [1,2,3,4]
// b: [1,2,3,4]</pre></div><p>The <code class="literal">slice</code> function provides an easy way to clone an array with only primitive types of elements, for example, an array of integers or an array of strings. We can clone an array with the <code class="literal">slice</code> function as long as it does not contain another array or object as an element. The following code successfully clones array <code class="literal">a</code> to <code class="literal">b</code>:</p><div><pre class="programlisting">var a = [1,2,3,4,5];
var b = a.slice();
a.pop();
// result:
// a: [1,2,3,4]
// b: [1,2,3,4,5]</pre></div><p>The <code class="literal">slice</code> function is<a id="id697" class="indexterm"/> normally used to create a new array by selecting a<a id="id698" class="indexterm"/> range of elements from an existing array. When using the <code class="literal">slice</code> function without any arguments, it clones the entire array. The Mozilla Developer Network provides details on the <code class="literal">slice</code> function<a id="id699" class="indexterm"/> at: <a class="ulink" href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/slice">https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/slice</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec197"/>Resuming the game progress</h2></div></div></div><p>We have saved the game progress, but we have not yet written the logic to resume the game. So, let's move on to the resuming part.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec93"/>Time for action – resuming a game from the local storage</h1></div></div></div><p>Carry out the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the<code class="literal"> matchgame.js</code> JavaScript file.</li><li class="listitem">In the jQuery document <code class="literal">ready</code> function, we used the saved order of the deck in the previous game instead of shuffling a new deck. Add the following highlighted code in the jQuery <code class="literal">ready</code> function:<div><pre class="programlisting">$(document).ready(function(){
  // reset the elapsed time to 0.
  matchingGame.elapsedTime = 0;

  // start the timer
  matchingGame.timer = setInterval(countTimer, 1000);

// shuffling the deck
  matchingGame.deck.sort(shuffle);

  <strong>// re-create the saved deck</strong>
<strong>  var savedObject = savedSavingObject();</strong>
<strong>  if (savedObject !== undefined) {</strong>
<strong>    matchingGame.deck = savedObject.deck;</strong>
<strong>  }</strong>

<strong>  </strong>// copying the deck into saving object.
  matchingGame.savingObject.deck = matchingGame.deck.slice();
});</pre></div></li><li class="listitem">Still in the jQuery <a id="id700" class="indexterm"/>document <code class="literal">ready</code> function, we append the following highlighted code to the end of the function. It <a id="id701" class="indexterm"/>removes any card that was marked as removed in the saved data. We also restore the saved elapsed time from the saved value:<div><pre class="programlisting">$(document).ready(function(){
// existing card creation code goes here.

<strong>  // removed cards that were removed in savedObject.</strong>
<strong>  if (savedObject !== undefined) {</strong>
<strong>    matchingGame.savingObject.removedCards = savedObject.removedCards;</strong>
<strong>    // find those cards and remove them.</strong>
<strong>    for(var i in matchingGame.savingObject.removedCards) {</strong>
<strong>      $(".card[data-card-index="+matchingGame.savingObject.removedCards[i]+"]").remove();</strong>
<strong>    }</strong>
<strong>  }</strong>

<strong>  // reset the elapsed time to 0.</strong>
<strong>  matchingGame.elapsedTime = 0;</strong>

<strong>  // restore the saved elapsed time</strong>
<strong>  if (savedObject !== undefined) {</strong>
<strong>     matchingGame.elapsedTime = savedObject.currentElapsedTime;</strong>
<strong>     matchingGame.savingObject.currentElapsedTime = savedObject.currentElapsedTime;</strong>
<strong>  }</strong>
});</pre></div></li><li class="listitem">Finally, we create the following function to retrieve <code class="literal">savingObject</code> from the local storage:<div><pre class="programlisting">// Returns the saved savingObject from the local storage.
function savedSavingObject() {
   // returns the saved saving object from local storage
   var savingObject = localStorage["savingObject"];
   if (savingObject !== undefined) {
      savingObject = JSON.parse(savingObject);
   }
   return savingObject;
}</pre></div></li><li class="listitem">Save all the files <a id="id702" class="indexterm"/>and open the game in a web <a id="id703" class="indexterm"/>browser. Try playing the game by removing several matching cards. Then, close the browser window and open the game again. The game should resume from the state where we closed the window, as shown in the following screenshot:<div><img src="img/B04290_07_11.jpg" alt="Time for action – resuming a game from the local storage"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec198"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just finished the <a id="id704" class="indexterm"/>loading part of the game by parsing the <a id="id705" class="indexterm"/>saved JSON string of the entire game status.</p><p>Then, we restored the elapsed time and the order of the deck from the loaded object, <code class="literal">savingObject</code>. Restoring these two properties is simply a case of variable assigning. The tricky part is recreating removing the card. In the game saving section, we assigned an index to each card's DOM using a <a id="id706" class="indexterm"/>
<strong>custom</strong> <strong>data</strong> <strong>attribute</strong> <code class="literal">data-card-index</code>. We stored the index of each removed card when saving the game, so we can know which cards are removed when loading the game. Then, we can remove these cards when the game sets up. The following code removes the cards in the jQuery game <code class="literal">ready</code> function:</p><div><pre class="programlisting">if (savedObject !== undefined) {
   matchingGame.savingObject.removedCards = savedObject.removedCards;
   // find those cards and remove them.
   for(var i in matchingGame.savingObject.removedCards) {
      $(".card[data-card-index="+matchingGame.savingObject.removedCards[i]+"]").remove();
   }
}</pre></div><div><div><h3 class="title"><a id="tip11"/>Tip</h3><p>
<strong>Tracking the storage changes with the storage event</strong>
</p><p>Sometimes, we may<a id="id707" class="indexterm"/> want to listen to the changes<a id="id708" class="indexterm"/> in <code class="literal">localStorage</code>. We can do that by listening to the <code class="literal">storage</code> event. It is fired when anything is changed in <code class="literal">localStorage</code>. The following link from <strong>Dive into HTML5</strong> provides a detailed discussion on how we can use the event: <a class="ulink" href="http://diveintohtml5.org/storage.html#storage-event">http://diveintohtml5.org/storage.html#storage-event</a>.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec199"/>Pop quiz – using local storage</h2></div></div></div><p>Q1. Consider whether each of the following statements is true or not:</p><div><ol class="orderedlist arabic"><li class="listitem">We can save and restore object data directly in the local storage.</li><li class="listitem">We can save the data of an object in the local storage by encoding it into a string.</li><li class="listitem">We can use <code class="literal">localStorage["hello"] = "world"</code> to save the value "world" with key "hello" in the local storage.</li></ol></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec94"/>Caching the game for offline access</h1></div></div></div><p>We can enable an offline <a id="id709" class="indexterm"/>cache by using the AppCache Manifest document. After<a id="id710" class="indexterm"/> the page first loads from the Internet, its related files are cached in the device and the user can load the page and play the game even if the device is in offline mode, such as airplane mode.</p></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec95"/>Time for action – adding the AppCache Manifest</h1></div></div></div><p>Perform the following set of steps to take the game offline:</p><div><ol class="orderedlist arabic"><li class="listitem">In the <code class="literal">index.html</code> file, we add a <code class="literal">manifest</code> attribute:<div><pre class="programlisting">&lt;html lang="en" manifest="game.appcache"&gt;</pre></div></li><li class="listitem">Then we create a file named <code class="literal">game.appcache</code> with the following content:<div><pre class="programlisting">CACHE MANIFEST
# 2015-03-01:v3

CACHE:
index.html
css/matchgame.css
images/bg.jpg
images/deck.png
images/popup_bg.jpg
images/table.jpg
js/jquery-1.11.2.min.js
js/html5games.matchgame.js

# Resources that require the user to be online.
NETWORK:
*</pre></div></li><li class="listitem">In order to test the <a id="id711" class="indexterm"/>caching, we need to host the game <a id="id712" class="indexterm"/>online. Upload the project folder to a web server, then open the game and inspect the console, we should see messages about the browser downloading or using the AppCache resources, as shown in the following screenshot:<div><img src="img/B04290_07_12.jpg" alt="Time for action – adding the AppCache Manifest"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec200"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just added an AppCache Manifest file to our <code class="literal">index.html</code> file. Now once the game is loaded, it works in offline and airplane mode.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec201"/>The AppCache file</h2></div></div></div><p>The AppCache file<a id="id713" class="indexterm"/> is a plain text file. It starts with <code class="literal">CACHE MANIFEST</code>. There are two sections: cache and network. We specify them by using a line with <code class="literal">CACHE:</code> and <code class="literal">NETWORK:</code> in the AppCache file. An optional fallback section can be provided for fallback assets for files that are not cached.</p><p>In the cache section, we specify the file we want to cache, line by line. We need to specify each file explicitly. In the network section, we specify the file that should access the network if it is not listed in the cache section. If we don't specify files, the browser won't fetch non-cached files even if there is an Internet connection. Most of the time, a wildcard (<code class="literal">*</code>) fits and works perfectly.</p><p>Any line that begins <a id="id714" class="indexterm"/>with <code class="literal">#</code> is a comment. We usually use one line of comment to specify the version of the cache file. The reason is that once the browser cached the assets, it won't update the cached files until the manifest file itself is changed. So the comment line can force the browser to update the cached resources.</p><div><div><h3 class="title"><a id="note31"/>Note</h3><p>HTML5Rocks<a id="id715" class="indexterm"/> has the following article that provides more details on using the AppCache file, including handling the cached events with JavaScript. Check it out at: <a class="ulink" href="http://www.html5rocks.com/en/tutorials/appcache/beginner/">http://www.html5rocks.com/en/tutorials/appcache/beginner/</a>.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec96"/>Summary</h1></div></div></div><p>You learned a lot in this chapter about using the local storage to save the game data in a web browser. Specifically, we saved and retrieved basic data in the key-value pair local storage. We encoded an object into the JSON formatted string and parsed the string back to a JavaScript object. We saved the entire game progress, so the game can resume even if left mid-way. We also take the game offline by using AppCache. Visually, we created a nice 3D ribbon as a new record badge in pure CSS3 styling.</p><p>Now that you have learned about improving our previous games by using the local storage, you are ready to move on to the next chapter where you'll learn about an advanced feature named <strong>WebSockets</strong> that we can use to connect players together in a real-time interaction.</p></div></body></html>