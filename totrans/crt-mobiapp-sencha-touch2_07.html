<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch07"/>Chapter 7. The Decider: External APIs</h1></div></div></div><p>One of the key aspects of mobile technology is the ability to tie different systems together into a meaningful application. More and more companies are allowing access to their programs and data through an <strong>Application Programming Interface</strong> or <strong>API</strong>. These APIs include things such as:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Maps via Google, Yahoo, and other providers</li><li class="listitem" style="list-style-type: disc">Music applications such as Rdio and Spotify</li><li class="listitem" style="list-style-type: disc">Location aware data providers such as Foursquare</li><li class="listitem" style="list-style-type: disc">Social networks such as Facebook and Google Plus</li><li class="listitem" style="list-style-type: disc">Photo services such as Flickr and Picassa<div><div><h3 class="title"><a id="note40"/>Note</h3><p>You can get a rough idea of what is available, at <a class="ulink" href="http://www.programmableweb.com/apis">http://www.programmableweb.com/apis</a>.</p></div></div></li></ul></div><p>This is just a small sampling of the data available to make your application more useful. The trick is how to get the data and how to use it. In this chapter we will be using the Foursquare API to explore the use of these types of APIs and how to get started. We will talk about:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">An overview of external APIs</li><li class="listitem" style="list-style-type: disc">Getting started with the Foursquare API</li><li class="listitem" style="list-style-type: disc">Building the basic application</li><li class="listitem" style="list-style-type: disc">Loading a data store with information from Foursquare</li><li class="listitem" style="list-style-type: disc">Displaying the data to the user</li></ul></div><p>We will start with a general look at how external APIs generally work and what you need to get started with one.</p><div><div><div><div><h1 class="title"><a id="ch07lvl1sec44"/>Using an external API</h1></div></div></div><p>APIs are provided as a<a id="id678" class="indexterm"/> service from many different companies. This is not an entirely altruistic move on the part of the company. The expectation is that by providing the information and access to the company's data, the company gets more usage for their service and more customers.</p><p>With this in mind, most (if not all) companies will require you to have an account on their system in order to access their API. This allows you to access their systems and information from within your application, but more importantly from the company's perspective, it allows them to maintain control over how their data can be used. If you violate the company's usage policies, they can shut off your application's access to the data, so play nice.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec76"/>The API key</h2></div></div></div><p>Most APIs require a key in order to use them. An API key<a id="id679" class="indexterm"/> is a long string of text that gets sent as an extra parameter on any request you send to the API. The key is often composed of two separate pieces and it uniquely identifies your application to the system much like a username and a password would for a regular user account. As such it's also a good idea to keep this key hidden in your application so that your users can't easily get it.</p><p>While each company is different, an API key is typically a matter of filling out a web form and getting the key. Most companies do not charge for this service. However, some do limit the usage available to outside applications, so it's a good idea to look at any restrictions the company sets on their service.</p><p>Once you have an API key you should take a look at the available functions for the API.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec77"/>API functions</h2></div></div></div><p>API functions<a id="id680" class="indexterm"/> typically come in two types – public and protected:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The public functions can simply be requested with the API key</li><li class="listitem" style="list-style-type: disc">The protected functions will also require that a user be logged into the system in order to make the request</li></ul></div><p>If the API function is protected, your application will also need to know how to log in correctly with the remote system. The login functions will usually be a part of the API or a web standard such as Facebook and Google's OAuth.</p><div><div><h3 class="title"><a id="note41"/>Note</h3><p>It should be noted that while OAuth is a standard, its implementation will vary depending on the service. You will need to consult the documentation for the service you are using to make sure that the features and functions you need are supported.</p></div></div><p>Be sure to read through the service's API documentation to understand which functions you will need and if they require a login.</p><p>Another thing <a id="id681" class="indexterm"/>to understand about APIs is that they don't always do exactly what you need them to do. You may find that you need to do a little more work than you expect to get the data you need. In this case, it's always good to do a little bit of testing.</p><p>Many APIs offer a console interface where you can type commands directly into the system and examine the results:<a id="id682" class="indexterm"/>
</p><div><img src="img/8901OS_07_01.jpg" alt="API functions"/></div><p>This can be really helpful for digging into the data, but consoles are not always available for every API service. Another option is to send the commands in your application (along with your API credentials) and examine the data returned in the Safari console.</p><p>The drawback of this method is that the data is often returned as a single-line string that is very difficult to read as shown in the screenshot:<a id="id683" class="indexterm"/>
</p><div><img src="img/8901OS_07_02.jpg" alt="API functions"/></div><p>This is where <a id="id684" class="indexterm"/>a tool like JSONLint<a id="id685" class="indexterm"/> comes in handy. You can copy and paste the single-line string from your Safari console into the page at <a class="ulink" href="http://jsonlint.com">http://jsonlint.com</a> <a id="id686" class="indexterm"/>and have the string formatted so that it is much easier to read and validate the string as JSON at the same time:</p><div><img src="img/8901OS_07_03.jpg" alt="API functions"/></div><p>Once you get a hold of <a id="id687" class="indexterm"/>what data is being sent and received, you will need to set it all up in Sencha Touch.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec78"/>External APIs and Sencha Touch</h2></div></div></div><p>As we have talked<a id="id688" class="indexterm"/> about earlier in the book, you cannot use a standard AJAX request to get data from another domain. You will need to use a JSONP proxy and store to request data from an external API.</p><p>Using the API or the <a id="id689" class="indexterm"/>Safari console, you can get a good idea of the data that is coming back to you and use it to set up your model. For this example, let's use a simple model called <code class="literal">Category</code>.</p><div><pre class="programlisting">Ext.define('MyApp.model.Category', {
    extend: 'Ext.data.Model',
    config: {
        fields: ['id', 'name', 'icon']
    }
});</pre></div><p>We can then set up a store to load data from the API:</p><div><pre class="programlisting">var store = Ext.create('Ext.data.Store', {
    model: 'Category',
    proxy: {
        type: 'jsonp',
        url : 'http://foursquare.com/vendors/categories' ,
        extraParams: {
          apiKey: 'XXXXXXXXXXXXXXXXXXXXXXXXX',
          appSecret: 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXX'
        },
        reader: {
            type: 'json',
            rootProperty: 'categories'
        }
    }
});</pre></div><p>This will set up a store with our <code class="literal">Category</code> model and call the <code class="literal">url</code> property for our external API. Remember that we have to send our credentials along with the request so we set these as <code class="literal">extraParams</code> on the <code class="literal">proxy</code> section.</p><div><div><h3 class="title"><a id="note42"/>Note</h3><p>The <code class="literal">apiKey</code> and <code class="literal">appSecret</code> properties shown here are examples. You will need your own API key information to use an API.</p></div></div><p>We also need to set a property<a id="id690" class="indexterm"/> called <code class="literal">rootProperty</code> in the <code class="literal">reader</code> section. Most API's send back a ton of detailed information along with the request and the store needs some idea of where to start loading in the category records.</p><p>We can also add additional parameters later by calling the <code class="literal">setExtraParam()</code> function<a id="id691" class="indexterm"/> on our store proxy. This will let us add additional parameters to be sent to our external API URL.</p><div><div><h3 class="title"><a id="note43"/>Note</h3><p>Please note that <code class="literal">setExtraParam()</code> will add an additional parameter but <code class="literal">setExtraParams()</code> <a id="id692" class="indexterm"/>will replace all of our <code class="literal">extraParams</code> with the new values.</p></div></div><p>Let's take a look at our application for this chapter to see how this all fits together.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec45"/>The basic application</h1></div></div></div><p>The Decider application<a id="id693" class="indexterm"/> is designed to use a combination of local storage, Google's Map API, and the <a id="id694" class="indexterm"/>Foursquare API. The application will take a list of people and their food preferences, and then use Foursquare and Google Maps to find nearby places to eat that will match everyone's food preferences.</p><p>This screenshot provides a pictorial representation of the preceding explanation:</p><div><img src="img/8901OS_07_04.jpg" alt="The basic application"/></div><p>Our contacts and categories will be stored using local storage. External APIs from Google and Foursquare will generate our maps and restaurant listings respectively. We will start with a quick overview of the basic application structure and forms, before diving into the store setup and API integration.</p><p>Our main container is a simple card layout:</p><div><pre class="programlisting">Ext.define('MyApp.view.ViewPortContainer', {
    extend: 'Ext.Container',

    config: {
        id: 'viewport',
        layout: {
            type: 'card'
        },
        items: [ ]
    }

});</pre></div><p>In this viewport <a id="id695" class="indexterm"/>we will add two cards: a navigation view and a form panel. Our <code class="literal">navigationvew</code> will serve as our main window for display. We will add additional containers to it via our controller:</p><div><pre class="programlisting">{
    xtype: 'navigationview',
    id: 'mainView',
    navigationBar: {
        items: [
            {
                xtype: 'button',
                handler: function(button, event) {
                    Ext.getCmp('viewport').setActiveItem(1);
                },
                id: 'addContactButton',
                ui: 'action',
                iconCls: 'add',
                iconMask: true,
                align: 'right'
            }
        ]
    },
    items: [
        {
            xtype: 'container',
            id: 'homeScreen',
            layout: {
                type: 'hbox'
            },
            items: [
                {
                    xtype: 'button',
                    action: 'go',
                    margin: 75,
                    text: 'Get Started!',
                    flex: 1
                }
            ]
        }
    ]
}</pre></div><p>This <code class="literal">mainView</code> <a id="id696" class="indexterm"/>contains our <code class="literal">navigationBar</code> and our <code class="literal">homeScreen</code> container with the big <code class="literal">Get Started</code> button. This button will add new containers to the navigation view (we will look at this later in the controller).</p><div><div><h3 class="title"><a id="note44"/>Note</h3><p>Remember that Sencha Touch automatically creates a back button for each container that is added to the navigation view. This means that we don't have to write an extra code for it.</p></div></div><p>The second item that is added to our viewport is our form panel. This will contain text fields for first and last name, as well as a selectable list for our different food categories:</p><div><pre class="programlisting">{
    xtype: 'formpanel',
    id: 'editContact',
    layout: {
        type: 'vbox'
    },
    items: [
        {
            xtype: 'textfield',
            label: 'First Name',
            labelWidth: '40%',
            name: 'firstname'
        },
        {
            xtype: 'textfield',
            label: 'Last Name',
            labelWidth: '40%',
            name: 'lastname'
        },
        {
            xtype: 'label',
            html: 'Choose what kind of food they like:'
        },
        {
            xtype: 'list',
            id: 'categoryList',
            itemTpl: [
                '&lt;div&gt;&lt;span class="icon"&gt;&lt;img src="img/{imgURL}" /&gt;&lt;/span&gt; {shortName}&lt;/div&gt;'
            ],
            store: 'Categories',
            mode: 'MULTI',
            flex: 1
        },
        {
            xtype: 'segmentedbutton',
            margin: '0 0 10 0',
            layout: {
                pack: 'center',
                type: 'hbox'
            },
            items: [
                {
                    xtype: 'button',
                    text: 'Cancel'
                },
                {
                    xtype: 'button',
                    text: 'Save'
                }
            ]
        },
        {
            xtype: 'titlebar',
            docked: 'top',
            title: 'Add Contact'
        }
    ]
}</pre></div><p>We close out the form with a <code class="literal">segmentedbutton</code> property, which has options for <code class="literal">Save</code> and <code class="literal">Cancel</code>. We will add the handler functions for these buttons later on in our controller.</p><p>We also include a<a id="id697" class="indexterm"/> title bar at the top of the form to give the user some idea of what they are doing.</p><p>One of the key pieces of this form is the categories list, so let's take a closer look at how it works.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec79"/>Creating the categories list</h2></div></div></div><p>Since we will be <a id="id698" class="indexterm"/>
<a id="id699" class="indexterm"/>getting our list of potential restaurants from the Foursquare API, we need to use their categories as well so that we can match things up with some degree of accuracy.</p><div><div><h3 class="title"><a id="note45"/>Note</h3><p>The Foursquare API<a id="id700" class="indexterm"/> can be found at <a class="ulink" href="https://developer.foursquare.com/">https://developer.foursquare.com/</a>. As mentioned before, you will need a Foursquare account to access the API. You will also need an API key in order to integrate Foursquare with your application.</p></div></div><p>We can use the Foursquare's API to get a list of categories, however the API returns a list of a few hundred categories including Airports, Trains, Taxis, Museums, and Restaurants. Additionally, each of these has its own subcategories. All we really want is the subcategories for Restaurants.</p><p>To make things more complicated, Foursquare's API also returns the data like this:</p><div><pre class="programlisting">categories: [
  {category 1},
  {category 2},
  {category 3},
  {category 4}…

]</pre></div><p>This means we can only get at a specific category by its order in the array of categories. For example, if Restaurants is the twenty-third category in the array, we can get to it as: <code class="literal">categories[23]</code>, but we cannot get to it by calling <code class="literal">categories['Restaurants']</code>. Unfortunately, if we use <code class="literal">categories[23]</code> and Foursquare adds a new category or changes the order, our application will break.</p><p>This is a <a id="id701" class="indexterm"/>
<a id="id702" class="indexterm"/>situation where it pays to be adaptable. Foursquare's API includes a console where we can try out our API requests. We can use this console to request the data for all of our categories and then pull the data we need into a flat file for our application. Check this URL to see the output:</p><p>
<a class="ulink" href="https://developer.foursquare.com/docs/explore#req=venues/categories">https://developer.foursquare.com/docs/explore#req=venues/categories</a>
</p><p>We can copy just the Restaurant information that we need from categories and save this as a file called <code class="literal">categories.json</code> and call it from our store.</p><div><div><h3 class="title"><a id="note46"/>Note</h3><p>A better solution to this conundrum would be to write some server code that would request the full category list from Foursquare and then pull out just the information we are interested in. But for the sake of brevity, we will just use a flat <code class="literal">json</code> file.</p></div></div><p>Each of our categories are laid out like this:</p><div><pre class="programlisting">{
    id: "4bf58dd8d48988d107941735",
    name: "Argentinian Restaurant",
    pluralName: "Argentinian Restaurants",
    shortName: "Argentinian",
    icon: {
        prefix: "https://foursquare.com/img/categories_v2/food/argentinian_",
        mapPrefix: "https://foursquare.com/img/categories_map/food/argentinian",
        suffix: ".png",
    },
    categories: [ ]
}</pre></div><p>The main pieces we care about are the <code class="literal">id</code>, <code class="literal">name</code>, <code class="literal">shortname</code> and <code class="literal">icon</code> values. This gives us a data model that looks like this:</p><div><pre class="programlisting">Ext.define('MyApp.model.Category', {
    extend: 'Ext.data.Model',
    config: {
        fields: [
            {
                name: 'id'
            },
            {
                name: 'name'
            },
            {
                name: 'shortName'
            },
            {
                name: 'icon'
            },
            {
                convert: function(v, rec) {
                    return rec.data.icon.prefix+ '32' + rec.data.icon.suffix;
                },
                name: 'imgURL'
            }
        ],
        proxy: {
            type: 'ajax',
            url: '/categories.json',
            reader: {
                type: 'json',
                rootProperty: 'categories'
            }
        }
    }
});</pre></div><p>Notice that we<a id="id703" class="indexterm"/>
<a id="id704" class="indexterm"/> also add a function to create an image URL for the icons we need. We do this with the <code class="literal">convert</code> configuration, which lets us assemble the data for image URL based on the other data in the record:</p><div><pre class="programlisting">{
 convert: function(v, rec) {
  return rec.data.icon.prefix+ '32' + rec.data.icon.suffix;
 },
 name: 'imgURL'
}</pre></div><p>The <code class="literal">convert</code> function is automatically passed both the data value (<code class="literal">v</code>), which we ignore in this case, and the record (<code class="literal">rec</code>), which lets us create a valid Foursquare URL by combining the <code class="literal">icon.prefix</code> value, a number, and the <code class="literal">icon.suffix</code> value in our record. If you take a look at our previous category data example, this would yield a URL of:</p><p>
<a class="ulink" href="https://foursquare.com/img/categories_v2/food/argentinian_32.png">https://foursquare.com/img/categories_v2/food/argentinian_32.png</a>
</p><p>By changing the <a id="id705" class="indexterm"/>
<a id="id706" class="indexterm"/>number we can control the size of the icon (this is part of the Foursquare API as well).</p><p>We combine this with our XTemplate:</p><div><pre class="programlisting">'&lt;div&gt;&lt;span class="icon"&gt;&lt;img src="img/{imgURL}" /&gt;&lt;/span&gt; {shortName}&lt;/div&gt;'</pre></div><p>This gives us a very attractive list for choosing our categories:</p><div><img src="img/8901OS_07_05.jpg" alt="Creating the categories list"/></div><p>Next we need to take a look at the controller for the contact form.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec80"/>Creating the contact controller</h2></div></div></div><p>The contact controller <a id="id707" class="indexterm"/>
<a id="id708" class="indexterm"/>handles saving the contact and canceling the action. We start out the controller by declaring our references and controls:</p><div><pre class="programlisting">Ext.define('MyApp.controller.Contact', {
    extend: 'Ext.app.Controller',
    config: {
        refs: {
            contactEditor: '#editContact',
            categoryList: '#editContact list',
            cancelButton: '#editContact button[text="Cancel"]',
            saveButton: '#editContact button[text="Save"]',
            viewContainer: '#viewport'
        },
        control: {
            cancelButton: {
                tap: 'doCancel'
            },
            saveButton: {
                tap: 'doSave'
            }
        }
    }
});</pre></div><p>Remember that our <code class="literal">refs</code> (references) provide a handy shortcut we can use anywhere in the controller to get to the pieces we need. Our <code class="literal">control</code> section attaches <code class="literal">tap</code> listeners to our cancel and save buttons.</p><p>Next we need to add our two functions after the controls section. The <code class="literal">doCancel</code> function is really simple:</p><div><pre class="programlisting">doCancel: function() {
    this.getContactEditor().reset();
    this.getCategoryList().deselectAll();
    this.getViewContainer().setActiveItem(0);
}</pre></div><p>We just use our references to clear the contact editor, deselect all the items in our category list, and switch back to our main view.</p><p>The <code class="literal">save</code> function is a little more complex, but similar to the functions we have covered elsewhere in this book:</p><div><pre class="programlisting">doSave: function() {

    var contact = Ext.create('MyApp.model.Contact', this.getContactEditor().getValues());
    var categories = this.getCategoryList().getSelection();
    var categoryIDs = [];
    Ext.each(categories, function(category) {
        categoryIDs.push(category.get('id'));
    });
    contact.set('categories', categoryIDs.join(','));

    contact.save(function() {
        console.log('Contact: ',contact);
    });

    this.doCancel();
}</pre></div><p>As with our previous save functions, we create a new <code class="literal">MyApp.model.Contact</code> and add the values from our form. However, since our list isn't really a standard form component we need to grab its selections separately and add them to the contact data as a comma-separated list.</p><p>We do this by creating <a id="id709" class="indexterm"/>
<a id="id710" class="indexterm"/>an empty array and using <code class="literal">Ext.each()</code> to loop through and run a function on all our categories. We then use <code class="literal">join</code> to implode the array into a comma-separated list.</p><p>Finally, we save the contact and run our <code class="literal">doCancel</code> function<a id="id711" class="indexterm"/> to clean up and return to our main view.</p><p>Now that we can add contacts we need to create a controller to handle our requests to the Foursquare and Google APIs, and get the data back to our users.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec46"/>Integrating with Google Maps and Foursquare</h1></div></div></div><p>Our application still has a <a id="id712" class="indexterm"/>
<a id="id713" class="indexterm"/>couple of tasks to accomplish. It needs to:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Handle the click of the <strong>Get Started</strong> button</li><li class="listitem" style="list-style-type: disc">Add our maps panel and offer to adjust the current location via Google Maps API</li><li class="listitem" style="list-style-type: disc">Display a list of friends to include in our search</li><li class="listitem" style="list-style-type: disc">Display the search results in a list</li><li class="listitem" style="list-style-type: disc">Display the details for a selected result</li></ul></div><p>We will start out with the basic skeleton of the controller, create the views and stores, and then finish up the controller to complete the application.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec81"/>Starting the mainView.js controller</h2></div></div></div><p>We will start the<a id="id714" class="indexterm"/> <code class="literal">mainView.js</code> controller file with some placeholders for the stores. We will add views later on and some references for those components.</p><div><div><h3 class="title"><a id="note47"/>Note</h3><p>Keep in mind that when working with placeholders in this fashion the application will not be testable until all the files are actually in place.</p></div></div><p>We create the<a id="id715" class="indexterm"/> <code class="literal">mainView.js</code> file in our <code class="literal">controllers</code> folder:</p><div><pre class="programlisting">Ext.define('MyApp.controller.mainView', {
    extend: 'Ext.app.Controller',
    requires: 'Ext.DateExtras',
    config: {
        views: [ 'confirmLocation', 'restaurantList', 'ViewPortContainer', 'friendChooser', 'restaurantDetails'],
        stores: [ 'ContactStore', 'RestaurantStore'],
        refs: {
            viewContainer: '#viewport',
            mainView: '#mainView',
            startButton: '#homeScreen button[action="go"]',
            cancelButton: 'button[action="cancel"]',
            finishButton: 'button[action="finish"]',
            locationButton: 'button[action="newlocation"]',
            nextButton: 'button[action="choosefriends"]',
            map: 'confirmlocation map',
            restaurantList: 'restaurantlist',
            friendList: 'friendchooser list'
        }
    }
});</pre></div><p>At the top of this configuration we require <code class="literal">Ext.DateExtras</code>. This file provides us with formatting options for date objects. If this file is not included, only the <code class="literal">now()</code> method for date objects will be available in your application.</p><p>In our <code class="literal">views</code> section we have added placeholders for <code class="literal">confirmLocation</code>, <code class="literal">restaurantList</code>, <code class="literal">friendChooser</code>,and <code class="literal">restaurantDetails</code>. We will add these files later on, along with the <code class="literal">RestaurantStore</code> file listed in our <code class="literal">stores</code> section.</p><p>We also have a <a id="id716" class="indexterm"/>number of references for these views, stores, and some of their sub-components. We will need to create these views before getting to the rest of our controller. We will take these views in the order the user will see them, starting with the <code class="literal">confirmLocation</code> view.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec82"/>Creating the confirmLocation view</h2></div></div></div><p>The <code class="literal">confirmLocation</code> view<a id="id717" class="indexterm"/> first appears when the user clicks on the <strong>Get Started</strong> button. This view will present the user with a map showing their current location and offer an option to switch to a different location if the user desires.</p><p>The following screenshot gives a pictorial representation of the preceding code:</p><div><img src="img/8901OS_07_06.jpg" alt="Creating the confirmLocation view"/></div><p>In order to give <a id="id718" class="indexterm"/>ourselves a bit more flexibility, we will be using the Google Maps Tracker plugin as part of this view. You can find this plugin in your Sencha Touch 2 folder in <code class="literal">examples/map/lib/plugin/google/Tracker.js</code>. Copy the file into a <code class="literal">lib/google</code> folder in your main application folder and be sure to add it into the <code class="literal">requires</code> section of your <code class="literal">app.js</code> file:</p><div><pre class="programlisting">requires: [
 'Ext.plugin.google.Tracker'
]</pre></div><p>You should also set the path that corresponds to the <code class="literal">Ext.plugin</code> namespace, just above where you enable <code class="literal">Ext.Loader</code> in <code class="literal">app.js</code> file:</p><div><pre class="programlisting">Ext.Loader.setPath({
    'Ext.plugin': 'lib/plugin'
});</pre></div><p>This plugin will let us easily drop markers on the map.</p><p>Once the Google <a id="id719" class="indexterm"/>Tracker plugin file is included in the application, we can set up our <code class="literal">confirmLocation.js</code> view like so:</p><div><pre class="programlisting">Ext.define('MyApp.view.confirmLocation', {
 extend: 'Ext.Container',
 alias: 'widget.confirmlocation',
 config: {
  layout: {
   type: 'vbox'
  },
  items: [
   {
    xtype: 'container',
    height: 25,
    html: 'Please confirm your location:'
   },
   {
    xtype: 'map',
    useCurrentLocation: true,
    flex: 1,
    plugins: [
     new Ext.plugin.google.Tracker({
      trackSuspended: false,   //suspend tracking initially
      allowHighAccuracy: false,
      marker: new google.maps.Marker({
      position: new google.maps.LatLng(37.44885, -122.158592), 
      title: 'My Current Location',
      animation: google.maps.Animation.DROP
      })
     })
    ]
   }
  ]
 }
});</pre></div><p>The view itself is a simple container with some HTML at the top asking the user to confirm their location. Next we have a map container that uses our Google Tracker plugin to configure the map and animate the location marker to drop from the top of the screen to the current location of the user. The <code class="literal">position</code> configuration is a default location, which is used when the user denies the application access to their current location. This one is set to the Sencha Headquarters.</p><p>Next we need a few options for the user to choose from: <strong>Cancel</strong>, <strong>New Location</strong>, and <strong>Next</strong>. We will add these as a segmented button under our map container. We add the code to the end of <a id="id720" class="indexterm"/>our <code class="literal">items</code> container (after the <code class="literal">map</code> container):</p><div><pre class="programlisting">{
 xtype: 'segmentedbutton',
 height: 40,
 margin: '10 0 10 0',
 layout: {
  pack: 'center',
  type: 'hbox'
 },
 items: [
  {
   xtype: 'button',
   text: 'Cancel',
   action: 'cancel'
  },
  {
   xtype: 'button',
   text: 'New Location',
   action: 'newlocation'
  },
  {
   xtype: 'button',
   text: 'Next',
   action: 'choosefriends'
  }
 ]
}</pre></div><p>Each of our buttons has an associated action. This allows us to assign functions to each button within the <code class="literal">mainView.js</code> controller. By creating buttons in this fashion, we maintain separation between the display of the application and the functionality of the application. This is really helpful when you want to re-use a view component.</p><p>The next view the user encounters is the Friends Chooser.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec83"/>Creating the Friends Chooser view</h2></div></div></div><p>The <code class="literal">friendsChooser.js</code> file<a id="id721" class="indexterm"/> uses a <a id="id722" class="indexterm"/>similar list to our previous category chooser. This lets our users select multiple people to include in the restaurant search:</p><div><img src="img/8901OS_07_07.jpg" alt="Creating the Friends Chooser view"/></div><p>Our <code class="literal">friendChooser</code> extends the <code class="literal">Ext.Container</code> component and allows the user to select from a list of friends:</p><div><pre class="programlisting">Ext.define('MyApp.view.friendChooser', {
 extend: 'Ext.Container',
 alias: 'widget.friendchooser',
 config: {
  id: 'friendChooser',
  layout: {
   type: 'vbox'
  },
  items: [
   {
    xtype: 'container',
    height: 20,
    html: 'Please Choose Friends from the list...',
    styleHtmlContent: true
   },
   {
    xtype: 'list',
    margin: 25,
    store: 'Contacts',
    itemTpl: [
     '&lt;div&gt;{firstname} {lastname}&lt;/div&gt;'
    ],
    mode: 'MULTI',
    flex: 1,
    grouped: true,
    emptyText: 'No Contacts to display.&lt;br /&gt;Please add some by clicking the plus icon.'
   }
  ]
 }
});</pre></div><p>As with our <a id="id723" class="indexterm"/>previous panel, we have a container with HTML at the top to provide some instructions to the user. Below that is our <code class="literal">list</code> container, which, like our category list, allows for selection of multiple items via the <code class="literal">mode: 'MULTI'</code> configuration. We also set <code class="literal">grouped</code> to <code class="literal">true</code>. This allows our store to group the contacts together by last name.</p><p>If you take a look at the <code class="literal">ContactStore.js</code> file, you can see where we do:</p><div><pre class="programlisting">grouper: {
 groupFn: function(record) {
  return record.get('lastname')[0];
 }
}</pre></div><p>This configuration returns the first letter of the last name for grouping.</p><p>The last thing we need to do with our <code class="literal">friendChooser.js</code> file is add the buttons at the bottom to <strong>Cancel</strong> or <strong>Finish</strong> the search. The buttons go out in the <code class="literal">items</code> section, just below the list:</p><div><pre class="programlisting">{
  xtype: 'segmentedbutton',
  height: 40,
  margin: '10 0 10 0',
  layout: {
   pack: 'center',
   type: 'hbox'
  },
  items: [
   {
    xtype: 'button',
    text: 'Cancel',
    action: 'cancel'
   },
   {
    xtype: 'button',
    text: 'Finish',
    action: 'finish'
   }
  ]
 }</pre></div><p>As in our previous <a id="id724" class="indexterm"/>view, we use a <code class="literal">segmentedbutton</code> property with actions assigned to each of our individual buttons.</p><p>Once the user clicks on <strong>Finish</strong>, we will need to return a list of restaurants they can select from.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec84"/>Creating the restaurant list, store, and details</h2></div></div></div><p>Our restaurant list<a id="id725" class="indexterm"/>
<a id="id726" class="indexterm"/> will use a store and the Foursquare API to return a list of restaurants based on the shared preferences of everyone the user selected.</p><p>The following screenshot exemplifies the preceding explanation:</p><div><img src="img/8901OS_07_08.jpg" alt="Creating the restaurant list, store, and details"/></div><p>This <a id="id727" class="indexterm"/>
<a id="id728" class="indexterm"/>component is pretty basic:</p><div><pre class="programlisting">Ext.define('MyApp.view.restaurantList', {
    extend: 'Ext.dataview.List',
    alias: 'widget.restaurantlist',
    config: {
        store: 'Restaurants',
        itemTpl: [
            '&lt;div&gt;{name}&lt;/div&gt;'
        ],
        onItemDisclosure: true,
        grouped: true
    }
});</pre></div><p>This component uses a simple list with a configuration option for <code class="literal">onItemDisclosure: true</code>. This places an arrow next to the restaurant name in the list. The user will be able to click on the arrow and see the details for that restaurant (which we will create after the store).</p><p>We also <a id="id729" class="indexterm"/>
<a id="id730" class="indexterm"/>set <code class="literal">grouped</code> to <code class="literal">true</code>, only this time our store will use a function to calculate and sort by distance.</p><div><div><div><div><h3 class="title"><a id="ch07lvl3sec14"/>Creating the restaurant store and model</h3></div></div></div><p>The restaurant store is where we set <a id="id731" class="indexterm"/>
<a id="id732" class="indexterm"/>up our request to the Foursquare API:</p><div><pre class="programlisting">Ext.define('MyApp.store.RestaurantStore', {
 extend: 'Ext.data.Store',
 requires: [
  'MyApp.model.Restaurant'
 ],
 config: {
  model: 'MyApp.model.Restaurant',
  storeId: 'Restaurants',
  proxy: {
   type: 'jsonp',
   url: 'https://api.foursquare.com/v2/venues/search',
   reader: {
    type: 'json',
    rootProperty: 'response.venues'
   }
  },
  grouper: {
   groupFn: function(record) {
    var distM = record.raw.location.distance;
    var distMiles = Math.round(distM * 0.000621371); //give or take.
    return (distMiles == 1)?"1 Mile":distMiles+' Miles';
   }
  },
  sorters: [
   { property: 'name', direction: 'ASC' }
  ]
 }
});</pre></div><p>The <code class="literal">RestaurantStore.js</code> file sets a <code class="literal">model</code> and <code class="literal">storeId</code> field for our store and then defines our proxy. The <code class="literal">proxy</code> section is where we set up our request to Foursquare.</p><p>As we mentioned at the start of the chapter, this needs to be a <code class="literal">jsonp</code> request since it is going to another domain. We make our request to <a class="ulink" href="https://api.foursquare.com/v2/venues/search">https://api.foursquare.com/v2/venues/search</a> and we are looking for the <code class="literal">responses.venues</code> section of the <code class="literal">JSON</code> array that gets returned.</p><p>You will <a id="id733" class="indexterm"/>
<a id="id734" class="indexterm"/>note that this store currently has no other parameters to send to Foursquare. We will add these later on in the controller before we load the store.</p><p>For the model, we can consult the Foursquare API documentation to see the information that is returned for a restaurant (called a venue in Foursquare terms) at <a class="ulink" href="https://developer.foursquare.com/docs/responses/venue">https://developer.foursquare.com/docs/responses/venue</a>
</p><p>You can include any of the fields listed on the page. For this app, we have chosen to include the following code in our model:</p><div><pre class="programlisting">Ext.define('MyApp.model.Restaurant', {
    extend: 'Ext.data.Model',
    config: {
        fields: [
            {
                name: 'id'
            },
            {
                name: 'name'
            },
            {
                name: 'categories'
            },
            {
                name: 'location'
            },
            {
                name: 'contact'
            },
            {
                name: 'menu'
            },
            {
                name: 'specials'
            }
        ]
    }
});</pre></div><p>You can add more fields if you want to display more information in the details view.</p></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec15"/>Creating the details view</h3></div></div></div><p>The details view is a<a id="id735" class="indexterm"/> simple panel and XTemplate combination. Using our controller, the panel will receive the data record when a user clicks on a restaurant in the list:</p><div><pre class="programlisting">Ext.define('MyApp.view.restaurantDetails', {
 extend: 'Ext.Panel',
 alias: 'widget.restaurantdetails',
 title: 'Details',
 config: {
  tpl: [
   '&lt;div class="restaurant"&gt;&lt;span class="name"&gt;{name}&lt;/span&gt;',
   '&lt;tpl for="contact"&gt;',
     '&lt;span class="phone"&gt;- {formattedPhone}&lt;/span&gt;',
   '&lt;/tpl&gt;',
   '&lt;div class="icons"&gt;&lt;tpl for="categories"&gt;',
     '&lt;span&gt;&lt;img src="img/{icon.prefix}32{icon.suffix}" /&gt;&lt;/span&gt;',
   '&lt;/tpl&gt;&lt;/div&gt;',
   '&lt;div class="address"&gt;Address:&lt;br /&gt;',
   '&lt;tpl for="location"&gt;',
     '{address}&lt;br /&gt;',
     '{city}, {state} {postalCode}',
   '&lt;/tpl&gt;&lt;/div&gt;',
   '&lt;tpl for="menu"&gt;',
     '&lt;a class="menu" href="{mobileUrl}"&gt;Menu&lt;/a&gt;',
   '&lt;/tpl&gt;',
   '&lt;tpl for="specials"&gt;',
     '&lt;tpl if="count &amp;gt; 0"&gt;',
       '&lt;div class="specials"&gt;Specials:&lt;dl&gt;&lt;tpl for="items"&gt;',
         '&lt;dt&gt;{title}&lt;/dt&gt;',
         '&lt;dd&gt;{description}&lt;br&gt;{message}&lt;/dd&gt;',
       '&lt;/tpl&gt;&lt;/dl&gt;&lt;/div&gt;',
     '&lt;/tpl&gt;',
   '&lt;/tpl&gt;',
   '&lt;/div&gt;'
  ]
 }
});</pre></div><p>Since the <code class="literal">tpl</code> tag is basically HTML, you can use any CSS styling you like here. Keep in mind that certain fields such as <code class="literal">contact</code>, <code class="literal">location</code>, and <code class="literal">categories</code> can have more than one entry. You will need to use <code class="literal">&lt;tpl for="fieldname"&gt;</code> to loop through these values.</p><p>Now that the views are complete, we need to head back to our controller and add the functions to put <a id="id736" class="indexterm"/>everything together.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec47"/>Finishing the main view controller</h1></div></div></div><p>When we started out with our <a id="id737" class="indexterm"/>main controller, we added all of our views, stores, and references. Now it's time to add the functionality for the application. We start by adding a <code class="literal">control</code> section to the end of our <code class="literal">config</code>:</p><div><pre class="programlisting">control: {
 startButton: {
   tap: 'doStart'
 },
 cancelButton: {
   tap: 'doCancel'
 },
 locationButton: {
   tap: 'doNewLocation'
 },
 nextButton: {
   tap: 'doChooseFriends'
 },
 finishButton: {
   tap: 'doShowRestaurants'
 },
 restaurantList: {
   disclose: 'doShowRestaurantDetails'
 }
}</pre></div><p>The controls are based on the references in the controller and they add functions to specific listeners on the component. These are each in the format of:</p><div><pre class="programlisting">reference: {
 eventName: 'functionName'
}</pre></div><p>Once these controls are in place, we can add our functions after the <code class="literal">config</code> section of our controller.</p><p>Our first function is <code class="literal">doStart</code>. This function loads our <code class="literal">Contacts</code> store and checks to see if we have any existing contacts. If not, we alert the user and offer to let them add some. If they have contacts we create a new instance of our <code class="literal">confirmLocation</code> container and <code class="literal">push</code> it onto the main navigation view:</p><div><pre class="programlisting">doStart: function() {
 var contactStore = Ext.getStore('Contacts');
 contactStore.load();
 if(contactStore.getCount() &gt; 0) {
     this.getMainView().push({ xtype: 'confirmlocation' });
 } else {
     Ext.Msg.confirm('No Contacts', 'You will need to add some contacts before we can search for restaurants. Would you like to add contacts now?', function(btn){
    if(btn == 'yes') {
      Ext.getCmp('viewport').setActiveItem(1);
    }
  }, this);
 }
}</pre></div><p>Remember that<a id="id738" class="indexterm"/> since the <code class="literal">mainView</code> is a navigation view, a <strong>Back</strong> button will automatically be created in the top toolbar. This function will show the user our initial map panel with the users current location.</p><p>This panel needs four functions: one to cancel the request, one to pop up a new location window, one to set the new location, and one to move on to the next step:</p><div><pre class="programlisting">doCancel: function() {
 var count = this.getMainView().items.length - 1;
 this.getMainView().pop(count);
}</pre></div><p>We actually want to be able to use the <code class="literal">doCancel</code> function from anywhere in the process. As we add new panels to our <code class="literal">mainView</code> navigation, these panels simply pile up in a stack. This means we need to get the number of panels currently on the <code class="literal">mainView</code> stack. We use <code class="literal">length-1</code> to always leave the initial panel (the one with our big <strong>Get Started</strong> button) on the stack. We use <code class="literal">pop</code> to remove all but the first panel from the stack. This way the <strong>Cancel</strong> button will take us all the way back to the beginning of our stack, while the <strong>Back</strong> button will take us back just to the previous step.</p><p>The next function is <code class="literal">doNewLocation()</code>, which uses <code class="literal">Ext.Msg.prompt</code> to ask the user to enter a new location:</p><div><pre class="programlisting">doNewLocation: function() {
 Ext.Msg.prompt(
     '',
     'Please enter the address you want to search from:',
     this.setNewLocation,
     this,
     100
 );
} </pre></div><p>If the user enters a new location, we call <code class="literal">setNewLocation</code> to process the text the user entered in the prompt textbox:</p><div><pre class="programlisting">setNewLocation: function(buttonID, address) {
 var geocoder = new google.maps.Geocoder();
 var map = this.getMap();
 geocoder.geocode({'address': address}, function(results, status) {
  if (status == google.maps.GeocoderStatus.OK) {
   map.getGeo().suspendUpdates();
   map.getMap().setCenter(results[0].geometry.location);
   var marker = new google.maps.Marker({
    map: map.getMap(),
    position: results[0].geometry.location,
    title: 'My Current Location',
    animation: google.maps.Animation.DROP
   });
   map.getGeo().setLatitude(results[0].geometry.location.lat());
   map.getGeo().setLongitude(results[0].geometry.location.lng());
  } else {
   Ext.Msg.alert('Error', 'Unable to find address.');
  }
 }); 
}</pre></div><p>This code <a id="id739" class="indexterm"/>gets our map and encodes the text the user passed us as a geocode location. If Google returns a valid address, we center the map on the location and drop a marker to show the exact location. We also set the latitude and longitude so that we can reference them later.</p><p>If we fail to get a valid address, we alert the user so they can fix it and try again.</p><p>Once the user is happy with the location they can click on the <strong>Next</strong> button, which fires our <code class="literal">doChooseFriends</code> function:</p><div><pre class="programlisting">doChooseFriends: function() {
 this.getMainView().push({ xtype: 'friendchooser' });
}</pre></div><p>This function pushes our <code class="literal">friendchooser</code> view onto the stack for display. The <code class="literal">friendchooser</code> view allows the user to select multiple friends and click on <strong>Cancel</strong> or <strong>Finish</strong>.</p><p>Since we have already taken care of our <strong>Cancel</strong> button with our <code class="literal">doCancel</code> function, we just need to write the <code class="literal">doShowRestaurants</code> function.</p><p>This function starts by looping through the selected friends. For the first one in the list, we grab the restaurant categories we have stored for the friend and convert it from a comma-separated list (which is how we stored it) into an array.</p><p>This lets us grab every subsequent selection and run <code class="literal">Ext.Array.intersect()</code> to find the common categories between all of the selected friends:</p><div><pre class="programlisting">doShowRestaurants: function() {
 var location = this.getMap().getGeo();
 var friends = this.getFriendList().getSelection();
 var store = Ext.getStore('Restaurants');
 var categories = [];
 var dt = new Date();
 var first = true;
 Ext.each(friends, function(friend) {
  if (first) {
   categories = friend.get('categories').split(',');
   first = false;
  } else {
   categories = Ext.Array.intersect(categories, friend.get('categories').split(','));
  }
 });
 store.load({
  params: {
   ll: location.getLatitude()+','+location.getLongitude(),
   client_id: FourSquare.clientID,
   client_secret: FourSquare.clientSecret,
   radius: 2000,
   categoryId: categories.join(','),
   v: Ext.Date.format(dt, 'Ymd')
 }
 });
 this.getMainView().push({xtype: 'restaurantlist', store: store});
}</pre></div><p>Next, we <a id="id740" class="indexterm"/>load the store based on the common categories by <code class="literal">categoryID</code>, the location data we have stored in our map, <code class="literal">client_id</code>, and <code class="literal">client_secret</code> that comprise our API key for Foursquare and a <code class="literal">radius</code> value (in meters).</p><p>We also send a required field called <code class="literal">v</code> that is set to the current date.</p><p>Finally, we push our restaurant list component onto the stack of containers. This will display our list of results and allow the user to click on for details.</p><p>This brings us to our <code class="literal">doShowRestaurantDetails</code> function:</p><div><pre class="programlisting">doShowRestaurantDetails: function(list, record) {
 this.getMainView().push({xtype: 'restaurantdetails', data: record.data});
}</pre></div><p>When the user taps one of the disclosure icons in our list of restaurants, we push a <code class="literal">restaurantdetails</code> view onto the stack of containers and set its data to the record that was tapped. This <a id="id741" class="indexterm"/>displays the details for the restaurant in our details XTemplate.</p></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec48"/>Homework</h1></div></div></div><p>There are a number of additional features that can be added to this type of application, including:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Editing for contacts (or automatically pulling friends from Facebook)</li><li class="listitem" style="list-style-type: disc">Setting up a live feed for the categories menu</li><li class="listitem" style="list-style-type: disc">Adding additional venues other than restaurants</li><li class="listitem" style="list-style-type: disc">Combining the application with additional APIs such as Yelp for reviews</li></ul></div><p>Just remember the key requirements of using additional APIs: the API key(s), studying the API documentation, and using the JSONP store for grabbing the data.</p></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec49"/>Summary</h1></div></div></div><p>In this chapter we talked about using external APIs to enhance your Sencha Touch applications. This included:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">An overview of API basics</li><li class="listitem" style="list-style-type: disc">Putting together the basic application</li><li class="listitem" style="list-style-type: disc">Interaction with Google Maps and Foursquare</li><li class="listitem" style="list-style-type: disc">Building the views, models, and stores</li><li class="listitem" style="list-style-type: disc">Building the application controller</li></ul></div><p>In the next chapter we will talk about the use of progressive enhancement to target sites to a specific device or screen size.</p></div></body></html>