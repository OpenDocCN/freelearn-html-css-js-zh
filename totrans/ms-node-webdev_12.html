<html><head></head><body>
<div class="calibre1" id="_idContainer160">
<h1 class="chapternumber"><span class="kobospan" id="kobo.1.1">11</span></h1>
<h1 class="chaptertitle" id="_idParaDest-190"><span class="kobospan" id="kobo.2.1">Handling Form Data</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.3.1">In this chapter, I demonstrate the ways that Node.js applications can receive form data and explain the differences, including supporting uploading files. </span><span class="kobospan" id="kobo.3.2">This chapter also explains how to sanitize form data so that it can be safely included in HTML documents, and how to validate data before it is used. </span><em class="italic"><span class="kobospan" id="kobo.4.1">Table 11.1</span></em><span class="kobospan" id="kobo.5.1"> puts this chapter in context.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.6.1">Table 11.1: Putting HTML forms in context</span></p>
<table class="table-container" id="table001-8">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.7.1">Question</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.8.1">Answer</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.9.1">What are they?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.10.1">HTML forms allow users to provide data by entering values into form fields.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.11.1">Why are they useful?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.12.1">Forms are the only ways in which data values can be collected from users in a structured way.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.13.1">How are they used?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.14.1">HTML documents contain a </span><code class="inlinecode"><span class="kobospan2" id="kobo.15.1">form</span></code><span class="kobospan" id="kobo.16.1"> element that contains one or more elements that allow data to be entered, such as an </span><code class="inlinecode"><span class="kobospan2" id="kobo.17.1">input</span></code><span class="kobospan4" id="kobo.18.1"> element.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.19.1">Are there any pitfalls or limitations?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.20.1">The data that’s entered into a form must be sanitized before inclusion in HTML output and validated before it is used by the applications.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.21.1">Are there any alternatives?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.22.1">Forms are the only way to efficiently solicit data from users. </span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.23.1">Table 11.2</span></em><span class="kobospan" id="kobo.24.1"> summarizes the chapter.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.25.1">Table 11.2: Chapter summary</span></p>
<table class="table-container" id="table002-8">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.26.1">Problem</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.27.1">Solution</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.28.1">Listing</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.29.1">Receive data from the user.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.30.1">Use an HTML form configured to send data to the server.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.31.1">1-10</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.32.1">Receive data used for non-idempotent operations.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.33.1">Configure the form to use HTTP </span><code class="inlinecode"><span class="kobospan2" id="kobo.34.1">POST</span></code><span class="kobospan4" id="kobo.35.1"> requests.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.36.1">11, 12</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.37.1">Receive complex data, including the contents of files.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.38.1">Use multipart form encoding.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.39.1">13-16</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.40.1">Prevent user data from being interpreted as HTML elements.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.41.1">Sanitize the data received from the user.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.42.1">17-21</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.43.1">Ensure the application receives useful data.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.44.1">Validate the data received from the user.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.45.1">22-27, 30-32</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.46.1">Provide immediate validation feedback to the user.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.47.1">Validate the data in the browser before the form is submitted. </span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.48.1">28-29</span></em></p>
</td>
</tr>
</tbody>
</table>
<h1 class="heading" id="_idParaDest-191"><span class="kobospan" id="kobo.49.1">Preparing for this chapter</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.50.1">This chapter uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.51.1">part2app</span></code><span class="kobospan" id="kobo.52.1"> project from </span><em class="italic"><span class="kobospan" id="kobo.53.1">Chapter 10</span></em><span class="kobospan" id="kobo.54.1">. </span><span class="kobospan" id="kobo.54.2">Run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.55.1">Listing 11.1</span></em><span class="kobospan" id="kobo.56.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.57.1">part2app</span></code><span class="kobospan" id="kobo.58.1"> folder to remove files that are no longer required.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.59.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.60.1">You can download the example project for this chapter – and for all the other chapters in this book – from </span><a href="https://github.com/PacktPublishing/Mastering-Node.js-Web-Development" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.61.1">https://github.com/PacktPublishing/Mastering-Node.js-Web-Development</span></span></a><span class="kobospan" id="kobo.62.1">. </span><span class="kobospan" id="kobo.62.2">See </span><em class="italic"><span class="kobospan" id="kobo.63.1">Chapter 1</span></em><span class="kobospan" id="kobo.64.1"> for how to get help if you have problems running the examples.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.65.1">Listing 11.1: Removing files</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.66.1">rm ./templates/**/*.handlebars
rm ./templates/**/*.custom
rm ./src/client/*_custom.js
rm ./src/server/*custom*.ts
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.67.1">Next, replace the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.68.1">client.js</span></code><span class="kobospan" id="kobo.69.1"> file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.70.1">src/client</span></code><span class="kobospan" id="kobo.71.1"> folder with the contents shown in </span><em class="italic"><span class="kobospan" id="kobo.72.1">Listing 11.2</span></em><span class="kobospan" id="kobo.73.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.74.1">Listing 11.2: The contents of the client.js file in the src/client folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.75.1">document.addEventListener('DOMContentLoaded', () =&gt; {
    // do nothing
});
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.76.1">This is a placeholder until later in the chapter when client-side code will be needed again. </span><span class="kobospan" id="kobo.76.2">Replace the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.77.1">index.html</span></code><span class="kobospan" id="kobo.78.1"> file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.79.1">static</span></code><span class="kobospan" id="kobo.80.1"> folder with the elements shown in </span><em class="italic"><span class="kobospan" id="kobo.81.1">Listing 11.3</span></em><span class="kobospan" id="kobo.82.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.83.1">Listing 11.3: The contents of the index.html file in the static folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.84.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;script src="/bundle.js"&gt;&lt;/script&gt;
        &lt;link href="css/bootstrap.min.css" rel="stylesheet" /&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;form&gt;
            &lt;div class="m-2"&gt;
                &lt;label class="form-label"&gt;Name&lt;/label&gt;
                &lt;input name="name" class="form-control" /&gt;
            &lt;/div&gt;
            &lt;div class="m-2"&gt;
                &lt;label class="form-label"&gt;City&lt;/label&gt;
                &lt;input name="city" class="form-control" /&gt;
            &lt;/div&gt;
        &lt;/form&gt;
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.85.1">The HTML document contains a simple HTML form that asks the user for their name and city. </span><span class="kobospan" id="kobo.85.2">To keep the code that handles forms separate from the rest of the application, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.86.1">forms.ts</span></code><span class="kobospan" id="kobo.87.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.88.1">src/server</span></code><span class="kobospan" id="kobo.89.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.90.1">Listing 11.4</span></em><span class="kobospan" id="kobo.91.1">. </span><span class="kobospan" id="kobo.91.2">You don’t need to keep the forms code separate; I have only done so to make the examples easier to follow.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.92.1">Listing 11.4: The contents of the forms.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.93.1">import { Express } from "express";
export const registerFormMiddleware = (app: Express) =&gt; {
    // no middleware yet
}
export const registerFormRoutes = (app: Express) =&gt; {
    // no routes yet
}
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.94.1">Listing 11.5</span></em><span class="kobospan" id="kobo.95.1"> updates the server to use the functions defined in </span><em class="italic"><span class="kobospan" id="kobo.96.1">Listing 11.4</span></em><span class="kobospan" id="kobo.97.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.98.1">Listing 11.5: Configuring the server in the server.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.99.1">import { createServer } from "http";
import express, {Express } from "express";
import { testHandler } from "./testHandler";
import httpProxy from "http-proxy";
import helmet from "helmet";
import { engine } from "express-handlebars";
import * as helpers from "./template_helpers";
</span><strong class="screentext"><span class="kobospan" id="kobo.100.1">import { registerFormMiddleware, registerFormRoutes } from "./forms";</span></strong><span class="kobospan" id="kobo.101.1">
const port = 5000;
const expressApp: Express = express();
const proxy = httpProxy.createProxyServer({
    target: "http://localhost:5100", ws: true
});
expressApp.set("views", "templates/server");
expressApp.engine("handlebars", engine());
expressApp.set("view engine", "handlebars");
expressApp.use(helmet());
expressApp.use(express.json());
</span><strong class="screentext"><span class="kobospan" id="kobo.102.1">registerFormMiddleware(expressApp);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.103.1">registerFormRoutes(expressApp);</span></strong><span class="kobospan" id="kobo.104.1">
expressApp.get("/dynamic/:file", (req, resp) =&gt; {
    resp.render(`${req.params.file}.handlebars`,
        { message: "Hello template", req, helpers: { ...helpers } });
});
expressApp.post("/test", testHandler);
expressApp.use(express.static("static"));
expressApp.use(express.static("node_modules/bootstrap/dist"));
expressApp.use((req, resp) =&gt; proxy.web(req, resp));
const server = createServer(expressApp);
server.on('upgrade', (req, socket, head) =&gt; proxy.ws(req, socket, head));
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.105.1">Listing 11.6</span></em><span class="kobospan" id="kobo.106.1"> removes a helper from the layout used by the server-side templates and adds a </span><code class="inlinecode"><span class="kobospan" id="kobo.107.1">script</span></code><span class="kobospan" id="kobo.108.1"> element for the JavaScript bundle created by webpack. </span><span class="kobospan" id="kobo.108.2">Some examples in this chapter rely on templates, and removing the helper simplifies the template rendering, while adding the </span><code class="inlinecode"><span class="kobospan" id="kobo.109.1">script</span></code><span class="kobospan" id="kobo.110.1"> element will allow client-side code to be used in content generated from templates.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.111.1">Listing 11.6: Changing elements in the main.handlebars file in the templates/server/layouts folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.112.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        </span><strong class="screentext"><span class="kobospan" id="kobo.113.1">&lt;script src="</span></strong><strong class="screentext"><span class="kobospan" id="kobo.114.1">/bundle.js"&gt;&lt;/script&gt;       </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.115.1">        &lt;link href="css/bootstrap.min.css" rel="stylesheet" /&gt;</span></strong><span class="kobospan" id="kobo.116.1">
    &lt;/head&gt;
    &lt;body&gt;
        {{{ body }}}
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.117.1">Finally, create a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.118.1">data.json</span></code><span class="kobospan" id="kobo.119.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.120.1">part2app</span></code><span class="kobospan" id="kobo.121.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.122.1">Listing 11.7</span></em><span class="kobospan" id="kobo.123.1">. </span><span class="kobospan" id="kobo.123.2">This file will be used to demonstrate how forms can be used to send files to the server.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.124.1">Listing 11.7: The contents of the data.json file in the part2app folder</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.125.1">[
    { "city": "London", "population": 8982000 },
    { "city": "Paris", "population": 2161000 },
    { "city": "Beijing", "population": 21540000 }
]
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.126.1">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.127.1">Listing 11.8</span></em><span class="kobospan" id="kobo.128.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.129.1">part2app</span></code><span class="kobospan" id="kobo.130.1"> folder to start the development tools and begin listening for HTTP requests.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.131.1">Listing 11.8: Starting the development tools</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.132.1">npm start
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.133.1">Open a web browser and request </span><code class="inlinecode"><span class="kobospan" id="kobo.134.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.135.1">. </span><span class="kobospan" id="kobo.135.2">You will see the form elements defined in </span><em class="italic"><span class="kobospan" id="kobo.136.1">Listing 11.3</span></em><span class="kobospan" id="kobo.137.1">, whose appearance has been styled using the Bootstrap CSS package, as shown in </span><em class="italic"><span class="kobospan" id="kobo.138.1">Figure 11.1</span></em><span class="kobospan" id="kobo.139.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.140.1"><img alt="" src="../Images/B21959_11_01.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.141.1">Figure 11.1: Running the example application</span></p>
<h1 class="heading" id="_idParaDest-192"><span class="kobospan" id="kobo.142.1">Receiving form data</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.143.1">Form data</span><a id="_idIndexMarker520" class="calibre3"/><span class="kobospan" id="kobo.144.1"> can be sent using HTTP </span><code class="inlinecode"><span class="kobospan" id="kobo.145.1">GET</span></code><span class="kobospan" id="kobo.146.1"> or </span><code class="inlinecode"><span class="kobospan" id="kobo.147.1">POST</span></code><span class="kobospan" id="kobo.148.1"> requests and the choice of method determines how the data contained in the form is presented. </span><em class="italic"><span class="kobospan" id="kobo.149.1">Listing 11.9</span></em><span class="kobospan" id="kobo.150.1"> completes the form to specify the URL to which the form data will be sent and adds buttons that submit the form data with different HTTP methods. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.151.1">Listing 11.9: Completing the form in the index.html file in the static folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.152.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;script src="/bundle.js"&gt;&lt;/script&gt;
        &lt;link href="css/bootstrap.min.css" rel="stylesheet" /&gt;
    &lt;/head&gt;
    &lt;body&gt;
       </span><strong class="screentext"><span class="kobospan" id="kobo.153.1"> &lt;form action="/form"&gt;</span></strong><span class="kobospan" id="kobo.154.1">
            &lt;div class="m-2"&gt;
                &lt;label class="form-label"&gt;Name&lt;/label&gt;
                &lt;input name="name" class="form-control" /&gt;
            &lt;/div&gt;
            &lt;div class="m-2"&gt;
                &lt;label class="form-label"&gt;City&lt;/label&gt;
                &lt;input name="city" class="form-control" /&gt;
            &lt;/div&gt;                                    
            </span><strong class="screentext"><span class="kobospan" id="kobo.155.1">&lt;div class="m-2"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.156.1">                &lt;button class="</span></strong><strong class="screentext"><span class="kobospan" id="kobo.157.1">btn btn-primary" formmethod="get"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.158.1">                    Submit (GET)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.159.1">                &lt;/button&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.160.1">                &lt;button class="btn btn-primary" </span></strong><strong class="screentext"><span class="kobospan" id="kobo.161.1">formmethod="post"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.162.1">                    Submit (POST)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.163.1">                &lt;/button&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.164.1">            &lt;/div&gt;</span></strong><span class="kobospan" id="kobo.165.1">
        &lt;/form&gt;
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.166.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.167.1">action</span></code><span class="kobospan" id="kobo.168.1"> attribute element on the </span><code class="inlinecode"><span class="kobospan" id="kobo.169.1">form</span></code><span class="kobospan" id="kobo.170.1"> element tells the browser to send the form data to the </span><code class="inlinecode"><span class="kobospan" id="kobo.171.1">/form</span></code><span class="kobospan" id="kobo.172.1"> URL. </span><span class="kobospan" id="kobo.172.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.173.1">button</span></code><span class="kobospan" id="kobo.174.1"> elements are configured with the </span><code class="inlinecode"><span class="kobospan" id="kobo.175.1">formmethod</span></code><span class="kobospan" id="kobo.176.1"> attribute, which </span><a id="_idIndexMarker521" class="calibre3"/><span class="kobospan" id="kobo.177.1">specifies which HTTP method the browser should use.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.178.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.179.1">I am using attributes applied to </span><code class="inlinecode"><span class="kobospan" id="kobo.180.1">button</span></code><span class="kobospan" id="kobo.181.1"> elements so that the same form data will be processed in different ways. </span><span class="kobospan" id="kobo.181.2">In later examples, I take a more conventional approach and use attributes applied to the </span><code class="inlinecode"><span class="kobospan" id="kobo.182.1">form</span></code><span class="kobospan" id="kobo.183.1"> element instead.</span></p>
</div>
<h2 class="heading1" id="_idParaDest-193"><span class="kobospan" id="kobo.184.1">Receiving form data from GET requests</span></h2>
<p class="normal1"><code class="inlinecode"><span class="kobospan" id="kobo.185.1">GET</span></code><span class="kobospan" id="kobo.186.1"> requests</span><a id="_idIndexMarker522" class="calibre3"/><span class="kobospan" id="kobo.187.1"> are the simplest way to receive form data because the browser includes the form field names and values in the URL query string. </span><em class="italic"><span class="kobospan" id="kobo.188.1">Listing 11.10</span></em><span class="kobospan" id="kobo.189.1"> defines a handler for form </span><code class="inlinecode"><span class="kobospan" id="kobo.190.1">GET</span></code><span class="kobospan" id="kobo.191.1"> requests. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.192.1">Listing 11.10: Handling </span><code class="inlinecode2"><span class="kobospan" id="kobo.193.1">GET</span></code><span class="kobospan" id="kobo.194.1"> requests in the forms.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.195.1">import { Express } from "express";
export const registerFormMiddleware = (app: Express) =&gt; {
    // no middleware yet
}
export const registerFormRoutes = (app: Express) =&gt; {
  </span><strong class="screentext"><span class="kobospan" id="kobo.196.1">  app.get("</span></strong><strong class="screentext"><span class="kobospan" id="kobo.197.1">/form", (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.198.1">        for (const key in req.query) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.199.1">            resp.write(`${key}</span></strong><strong class="screentext"><span class="kobospan" id="kobo.200.1">: ${req.query[key]}\n`);           </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.201.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.202.1">        resp.end();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.203.1">    });</span></strong><span class="kobospan" id="kobo.204.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.205.1">The route uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.206.1">get</span></code><span class="kobospan" id="kobo.207.1"> method to match </span><code class="inlinecode"><span class="kobospan" id="kobo.208.1">GET</span></code><span class="kobospan" id="kobo.209.1"> requests sent to the </span><code class="inlinecode"><span class="kobospan" id="kobo.210.1">/form</span></code><span class="kobospan" id="kobo.211.1"> URL. </span><span class="kobospan" id="kobo.211.2">Express decodes URL query strings and presents them through the </span><code class="inlinecode"><span class="kobospan" id="kobo.212.1">Request.query</span></code><span class="kobospan" id="kobo.213.1"> property. </span><span class="kobospan" id="kobo.213.2">In </span><em class="italic"><span class="kobospan" id="kobo.214.1">Listing 11.10</span></em><span class="kobospan" id="kobo.215.1">, the query string parameters and values are used to generate</span><a id="_idIndexMarker523" class="calibre3"/><span class="kobospan" id="kobo.216.1"> the response. </span><span class="kobospan" id="kobo.216.2">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.217.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.218.1">, fill out the form using </span><code class="inlinecode"><span class="kobospan" id="kobo.219.1">Alice Smith</span></code><span class="kobospan" id="kobo.220.1"> as the name and </span><code class="inlinecode"><span class="kobospan" id="kobo.221.1">London</span></code><span class="kobospan" id="kobo.222.1"> as the city, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.223.1">Submit </span></strong><span class="kobospan" id="kobo.224.1">(</span><strong class="screentext"><span class="kobospan" id="kobo.225.1">GET</span></strong><span class="kobospan" id="kobo.226.1">) button.</span></p>
<p class="normal"><span class="kobospan" id="kobo.227.1">The browser will send a </span><code class="inlinecode"><span class="kobospan" id="kobo.228.1">GET</span></code><span class="kobospan" id="kobo.229.1"> request to the </span><code class="inlinecode"><span class="kobospan" id="kobo.230.1">/form</span></code><span class="kobospan" id="kobo.231.1"> URL and include the values that were entered into the form, like this: </span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.232.1">http://localhost:5000/form?name=Alice+Smith&amp;city=London
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.233.1">The data will be received by the server, the query string will be parsed, and the form data will be used in the response, as shown in </span><em class="italic"><span class="kobospan" id="kobo.234.1">Figure 11.2</span></em><span class="kobospan" id="kobo.235.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.236.1"><img alt="" src="../Images/B21959_11_02.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.237.1">Figure 11.2: Handling form data from a </span><code class="inlinecode2"><span class="kobospan" id="kobo.238.1">GET</span></code><span class="kobospan" id="kobo.239.1"> request</span></p>
<p class="normal"><span class="kobospan" id="kobo.240.1">The limitation of </span><code class="inlinecode"><span class="kobospan" id="kobo.241.1">GET</span></code><span class="kobospan" id="kobo.242.1"> requests is they must be </span><em class="italic"><span class="kobospan" id="kobo.243.1">idempotent</span></em><span class="kobospan" id="kobo.244.1">, meaning that every request for a given URL should always have the same effect and always return the same result. </span><span class="kobospan" id="kobo.244.2">Put another way, form data sent with a </span><code class="inlinecode"><span class="kobospan" id="kobo.245.1">GET</span></code><span class="kobospan" id="kobo.246.1"> request is effectively a request to read data that isn’t expected to change with every request.</span></p>
<p class="normal"><span class="kobospan" id="kobo.247.1">This is important because HTTP caches are allowed to store the responses to </span><code class="inlinecode"><span class="kobospan" id="kobo.248.1">GET</span></code><span class="kobospan" id="kobo.249.1"> requests and use them to respond to requests for the same URL, which means that some requests may not be received by the backend server. </span><span class="kobospan" id="kobo.249.2">For this reason, most form data is sent using </span><code class="inlinecode"><span class="kobospan" id="kobo.250.1">POST</span></code><span class="kobospan" id="kobo.251.1"> requests, which won’t be cached but which can be more complex to process.</span></p>
<h2 class="heading1" id="_idParaDest-194"><span class="kobospan" id="kobo.252.1">Receiving form data from POST requests</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.253.1">HTTP </span><code class="inlinecode"><span class="kobospan" id="kobo.254.1">POST</span></code><span class="kobospan" id="kobo.255.1"> requests</span><a id="_idIndexMarker524" class="calibre3"/><span class="kobospan" id="kobo.256.1"> include the form data in the request body, which must be read and decoded before it can be used. </span><em class="italic"><span class="kobospan" id="kobo.257.1">Listing 11.11</span></em><span class="kobospan" id="kobo.258.1"> adds a route that handles </span><code class="inlinecode"><span class="kobospan" id="kobo.259.1">POST</span></code><span class="kobospan" id="kobo.260.1"> requests, reads the body, and uses it as the response. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.261.1">Listing 11.11: Adding a handler to the form.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.262.1">import { Express } from "express";
export const registerFormMiddleware = (app: Express) =&gt; {
    // no middleware yet
}
export const registerFormRoutes = (app: Express) =&gt; {
    app.get("/form", (req, resp) =&gt; {
        for (const key in req.query) {
            resp.write(`${key}: ${req.query[key]}\n`);           
        }
        resp.end();
    });
   </span><strong class="screentext"><span class="kobospan" id="kobo.263.1"> app.post("/form", (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.264.1">        resp.write</span></strong><strong class="screentext"><span class="kobospan" id="kobo.265.1">(`Content-Type: ${req.headers["content-type"]}\n`)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.266.1">        req.pipe(resp);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.267.1">    });</span></strong><span class="kobospan" id="kobo.268.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.269.1">Node.js and Express read the headers from the HTTP request and leave the body so that it can be read as a stream. </span><span class="kobospan" id="kobo.269.2">The new route in </span><em class="italic"><span class="kobospan" id="kobo.270.1">Listing 11.11</span></em><span class="kobospan" id="kobo.271.1"> matches </span><code class="inlinecode"><span class="kobospan" id="kobo.272.1">POST</span></code><span class="kobospan" id="kobo.273.1"> requests sent to </span><code class="inlinecode"><span class="kobospan" id="kobo.274.1">/form</span></code><span class="kobospan" id="kobo.275.1"> and creates a response containing the request’s </span><code class="inlinecode"><span class="kobospan" id="kobo.276.1">Content-Type</span></code><span class="kobospan" id="kobo.277.1"> header and the request body.</span></p>
<p class="normal"><span class="kobospan" id="kobo.278.1">Use a</span><a id="_idIndexMarker525" class="calibre3"/><span class="kobospan" id="kobo.279.1"> browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.280.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.281.1">, fill out the form with the same details as in the previous section, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.282.1">Submit</span></strong><span class="kobospan" id="kobo.283.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.284.1">POST</span></strong><span class="kobospan" id="kobo.285.1">) button. </span><span class="kobospan" id="kobo.285.2">The browser will send a </span><code class="inlinecode"><span class="kobospan" id="kobo.286.1">POST</span></code><span class="kobospan" id="kobo.287.1"> request to the server with the form data in the request body, producing the response shown in </span><em class="italic"><span class="kobospan" id="kobo.288.1">Figure 11.3</span></em><span class="kobospan" id="kobo.289.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.290.1"><img alt="" src="../Images/B21959_11_03.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.291.1">Figure 11.3: Handling form data from a POST request</span></p>
<p class="normal"><span class="kobospan" id="kobo.292.1">The browser has set the </span><code class="inlinecode"><span class="kobospan" id="kobo.293.1">Content-Type</span></code><span class="kobospan" id="kobo.294.1"> header to </span><code class="inlinecode"><span class="kobospan" id="kobo.295.1">application/x-www-form-urlencoded</span></code><span class="kobospan" id="kobo.296.1">, which indicates that the form data values are encoded in the same way as when the data is included in the query string, with name-value pairs separated by </span><code class="inlinecode"><span class="kobospan" id="kobo.297.1">=</span></code><span class="kobospan" id="kobo.298.1"> characters and combined with </span><code class="inlinecode"><span class="kobospan" id="kobo.299.1">&amp;</span></code><span class="kobospan" id="kobo.300.1"> characters, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.301.1">...
</span><span class="kobospan" id="kobo.301.2">name=Alice+Smith&amp;city=London
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.302.1">You can decode the form data yourself, but Express includes middleware that detects the </span><code class="inlinecode"><span class="kobospan" id="kobo.303.1">Content-Type</span></code><span class="kobospan" id="kobo.304.1"> header and decodes the form data into a key/value map. </span><em class="italic"><span class="kobospan" id="kobo.305.1">Listing 11.12</span></em><span class="kobospan" id="kobo.306.1"> enables the middleware and uses the data it produces in the response.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.307.1">Listing 11.12: Using Express middleware in the forms.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.308.1">import express, { Express } from "express";
export const registerFormMiddleware = (app: Express) =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.309.1">app.use(express.urlencoded({extended: true}))</span></strong><span class="kobospan" id="kobo.310.1">
}
export const registerFormRoutes = (app: Express) =&gt; {
    app.get("/form", (req, resp) =&gt; {
        for (const key in req.query) {
            resp.write(`${key}: ${req.query[key]}\n`);           
        }
        resp.end();
    });
    app.post("/form", (req, resp) =&gt; {
        resp.write(`Content-Type: ${req.headers["content-type"]}\n`)
        </span><strong class="screentext"><span class="kobospan" id="kobo.311.1">for (const key in req.body) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.312.1">            resp.write(`</span></strong><strong class="screentext"><span class="kobospan" id="kobo.313.1">${key}: ${req.body[key]}\n`);           </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.314.1">        }       </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.315.1">        resp.end();</span></strong><span class="kobospan" id="kobo.316.1">
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.317.1">The </span><a id="_idIndexMarker526" class="calibre3"/><span class="kobospan" id="kobo.318.1">middleware component is created using the </span><code class="inlinecode"><span class="kobospan" id="kobo.319.1">Express.urlencoded</span></code><span class="kobospan" id="kobo.320.1"> method and the required </span><code class="inlinecode"><span class="kobospan" id="kobo.321.1">extended</span></code><span class="kobospan" id="kobo.322.1"> configuration option is used to specify whether request bodies are processed using the same library that parses query strings or, as here, a more sophisticated option that allows more complex data types to be processed.</span></p>
<p class="normal"><span class="kobospan" id="kobo.323.1">To see the decoded data, request </span><code class="inlinecode"><span class="kobospan" id="kobo.324.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.325.1">, fill in the form, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.326.1">Submit</span></strong><span class="kobospan" id="kobo.327.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.328.1">POST</span></strong><span class="kobospan" id="kobo.329.1">) button. </span><span class="kobospan" id="kobo.329.2">The individual form element names and values will be displayed in the response, instead of the URL-encoded string, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.330.1">...
</span><span class="kobospan" id="kobo.330.2">Content-Type: application/x-www-form-urlencoded
</span><strong class="screentext"><span class="kobospan" id="kobo.331.1">name: Alice Smith</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.332.1">city: London</span></strong><span class="kobospan" id="kobo.333.1">
...
</span></code></pre>
<h3 class="heading2" id="_idParaDest-195"><span class="kobospan" id="kobo.334.1">Receiving multipart data</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.335.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.336.1">application/x-www-form-urlencoded</span></code><span class="kobospan" id="kobo.337.1"> format is the default and works well for gathering</span><a id="_idIndexMarker527" class="calibre3"/><span class="kobospan" id="kobo.338.1"> basic data values from a user. </span><span class="kobospan" id="kobo.338.2">For forms where the user submits files, the </span><code class="inlinecode"><span class="kobospan" id="kobo.339.1">multipart/form-data</span></code><span class="kobospan" id="kobo.340.1"> format is used, which is more complex but allows for a mix of data types to be sent in the HTTP request body. </span><em class="italic"><span class="kobospan" id="kobo.341.1">Listing 11.13</span></em><span class="kobospan" id="kobo.342.1"> adds an </span><code class="inlinecode"><span class="kobospan" id="kobo.343.1">input</span></code><span class="kobospan" id="kobo.344.1"> element that allows the user to select a file and a button to the HTML form that submits the data using the </span><code class="inlinecode"><span class="kobospan" id="kobo.345.1">multipart/form-data</span></code><span class="kobospan" id="kobo.346.1"> format. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.347.1">Listing 11.13: Adding elements in the index.html file in the static folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.348.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;script src="/bundle.js"&gt;&lt;/script&gt;
        &lt;link href="css/bootstrap.min.css" rel="stylesheet" /&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;form action="/form"&gt;
            &lt;div class="m-2"&gt;
                &lt;label class="form-label"&gt;Name&lt;/label&gt;
                &lt;input name="name" class="form-control" /&gt;
            &lt;/div&gt;
           </span><strong class="screentext"><span class="kobospan" id="kobo.349.1"> &lt;div class="m-2"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.350.1">                &lt;label class</span></strong><strong class="screentext"><span class="kobospan" id="kobo.351.1">="form-label"&gt;City&lt;/label&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.352.1">                &lt;input name="city" class="form-control" /&gt;</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.353.1">&lt;/div&gt; </span></strong><span class="kobospan" id="kobo.354.1">                 
            &lt;div class="m-2"&gt;
                &lt;label class="form-label"&gt;File&lt;/label&gt;
                &lt;input name="datafile" type="file" class="form-control" /&gt;
            &lt;/div&gt;
            &lt;div class="m-2"&gt;
                &lt;button class="btn btn-primary" formmethod="get"&gt;
                    Submit (GET)
                &lt;/button&gt;
                &lt;button class="btn btn-primary" formmethod="post"&gt;
                    Submit (POST)
                &lt;/button&gt;
                </span><strong class="screentext"><span class="kobospan" id="kobo.355.1">&lt;button class="btn btn-primary" formmethod="post"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.356.1">                        formenctype="multipart/form-data"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.357.1">&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.358.1">                    Submit (POST/MIME)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.359.1">                &lt;/button&gt;</span></strong><span class="kobospan" id="kobo.360.1">
            &lt;/div&gt;
        &lt;/form&gt;
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.361.1">The </span><a id="_idIndexMarker528" class="calibre3"/><span class="kobospan" id="kobo.362.1">new </span><code class="inlinecode"><span class="kobospan" id="kobo.363.1">input</span></code><span class="kobospan" id="kobo.364.1"> element has a </span><code class="inlinecode"><span class="kobospan" id="kobo.365.1">type</span></code><span class="kobospan" id="kobo.366.1"> attribute set to </span><code class="inlinecode"><span class="kobospan" id="kobo.367.1">file</span></code><span class="kobospan" id="kobo.368.1">, which tells the browser that it should present the user with an element to choose a file.</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.369.1">Listing 11.14</span></em><span class="kobospan" id="kobo.370.1"> updates the form handler so that </span><code class="inlinecode"><span class="kobospan" id="kobo.371.1">application/x-www-form-urlencoded</span></code><span class="kobospan" id="kobo.372.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.373.1">multipart/form-data</span></code><span class="kobospan" id="kobo.374.1"> requests are handled differently, which is important because it affects the way that browsers deal with files.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.375.1">Listing 11.14: Selecting content type in the forms.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.376.1">import express, { Express } from "express";
export const registerFormMiddleware = (app: Express) =&gt; {
    app.use(express.urlencoded({extended: true}))
}
export const registerFormRoutes = (app: Express) =&gt; {
    app.get("/form", (req, resp) =&gt; {
        for (const key in req.query) {
            resp.write(`${key}: ${req.query[key]}\n`);           
        }
        resp.end();
    });
    app.post("/form", (req, resp) =&gt; {
        resp.write(`Content-Type: ${req.headers["content-type"]}\n`)
        </span><strong class="screentext"><span class="kobospan" id="kobo.377.1">if (req.headers["content-type"]?.startsWith("multipart/form-data"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.378.1">)) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.379.1">            req.pipe(resp);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.380.1">        } else {</span></strong><span class="kobospan" id="kobo.381.1">
            for (const key in req.body) {
                resp.write(`${key}: ${req.body[key]}\n`);           
            }       
            resp.end();
        }
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.382.1">Use a </span><a id="_idIndexMarker529" class="calibre3"/><span class="kobospan" id="kobo.383.1">browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.384.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.385.1"> and fill out the form, choosing the </span><code class="inlinecode"><span class="kobospan" id="kobo.386.1">data.json</span></code><span class="kobospan" id="kobo.387.1"> file created at the start of the chapter for the </span><code class="inlinecode"><span class="kobospan" id="kobo.388.1">File</span></code><span class="kobospan" id="kobo.389.1"> field. </span><span class="kobospan" id="kobo.389.2">The form encoding determines how the browser deals with files. </span><span class="kobospan" id="kobo.389.3">Click </span><strong class="screentext"><span class="kobospan" id="kobo.390.1">Submit</span></strong><span class="kobospan" id="kobo.391.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.392.1">POST</span></strong><span class="kobospan" id="kobo.393.1">) to send the form with a </span><code class="inlinecode"><span class="kobospan" id="kobo.394.1">POST</span></code><span class="kobospan" id="kobo.395.1"> request in the </span><code class="inlinecode"><span class="kobospan" id="kobo.396.1">application/x-www-form-urlencoded</span></code><span class="kobospan" id="kobo.397.1"> encoding, and the </span><strong class="screentext"><span class="kobospan" id="kobo.398.1">Submit (POST/MIME)</span></strong><span class="kobospan" id="kobo.399.1"> button to send the form with a </span><code class="inlinecode"><span class="kobospan" id="kobo.400.1">POST</span></code><span class="kobospan" id="kobo.401.1"> request using the </span><code class="inlinecode"><span class="kobospan" id="kobo.402.1">multipart/form-data</span></code><span class="kobospan" id="kobo.403.1"> encoding. </span><span class="kobospan" id="kobo.403.2">Both outcomes are shown in </span><em class="italic"><span class="kobospan" id="kobo.404.1">Figure 11.4</span></em><span class="kobospan" id="kobo.405.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.406.1"><img alt="" src="../Images/B21959_11_04.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.407.1">Figure 11.4: Sending form data in different encodings</span></p>
<p class="normal"><span class="kobospan" id="kobo.408.1">For the </span><code class="inlinecode"><span class="kobospan" id="kobo.409.1">application/x-www-form-urlencoded</span></code><span class="kobospan" id="kobo.410.1"> encoding, the browser includes just the name of the file, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.411.1">...
</span><span class="kobospan" id="kobo.411.2">Content-Type: application/x-www-form-urlencoded
name: Alice
city: London
</span><strong class="screentext"><span class="kobospan" id="kobo.412.1">datafile: data.json</span></strong><span class="kobospan" id="kobo.413.1">
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.414.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.415.1">multipart/form-data</span></code><span class="kobospan" id="kobo.416.1"> encoding does include the file contents, but to do so, the structure</span><a id="_idIndexMarker530" class="calibre3"/><span class="kobospan" id="kobo.417.1"> of the request body becomes more complex, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.418.1">...
</span><span class="kobospan" id="kobo.418.2">Content-Type: multipart/form-data; boundary=----WebKitFormBoundary41AOY4gvNpCTJzUy
------WebKitFormBoundary41AOY4gvNpCTJzUy
Content-Disposition: form-data; name="name"
Alice
------WebKitFormBoundary41AOY4gvNpCTJzUy
Content-Disposition: form-data; name="city"
London
------WebKitFormBoundary41AOY4gvNpCTJzUy
Content-Disposition: form-data; name="datafile"; filename="data.json"
Content-Type: application/json
[
    { "city": "London", "population": 8982000 },
    { "city": "Paris", "population": 2161000 },
    { "city": "Beijing", "population": 21540000 }
]
------WebKitFormBoundary41AOY4gvNpCTJzUy--
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.419.1">The request body contains multiple parts, each of which is separated by a boundary string, which is included in the </span><code class="inlinecode"><span class="kobospan" id="kobo.420.1">Content-Type</span></code><span class="kobospan" id="kobo.421.1"> header:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.422.1">...
</span><span class="kobospan" id="kobo.422.2">Content-Type: multipart/form-data; b</span><strong class="screentext"><span class="kobospan" id="kobo.423.1">oundary=----WebKitFormBoundary41AOY4gvNpCTJzUy</span></strong><span class="kobospan" id="kobo.424.1">
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.425.1">Each body part can contain a different type of data and comes complete with headers that describe the contents. </span><span class="kobospan" id="kobo.425.2">In the case of the body part for the file, the headers provide the name given to the form field, the name of the file that has been chosen, and the type of content in the file:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.426.1">...
</span><span class="kobospan" id="kobo.426.2">Content-Disposition: form-data; name="datafile"; filename="data.json"
Content-Type: application/json
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.427.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.428.1">multipart/form-data</span></code><span class="kobospan" id="kobo.429.1"> encoding can be decoded manually, but it isn’t a good idea </span><a id="_idIndexMarker531" class="calibre3"/><span class="kobospan" id="kobo.430.1">because there have been so many non-compliant implementations over the years that require special handling or workarounds. </span><span class="kobospan" id="kobo.430.2">Express doesn’t include built-in support for processing </span><code class="inlinecode"><span class="kobospan" id="kobo.431.1">multipart/form-data</span></code><span class="kobospan" id="kobo.432.1"> requests but several JavaScript packages can do so. </span><span class="kobospan" id="kobo.432.2">One option is Multer (</span><a href="https://github.com/expressjs/multer" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.433.1">https://github.com/expressjs/multer</span></span></a><span class="kobospan" id="kobo.434.1"> which works well with Express. </span><span class="kobospan" id="kobo.434.2">Run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.435.1">Listing 11.15</span></em><span class="kobospan" id="kobo.436.1"> to install the Multer package and the type definitions that describe the API it provides to TypeScript.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.437.1">Listing 11.15: Installing a package</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.438.1">npm install multer@1.4.5-lts.1
npm install --save-dev @types/multer@1.4.11
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.439.1">Listing 11.16</span></em><span class="kobospan" id="kobo.440.1"> configures the Multer package and applies it to the form handler.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.441.1">Listing 11.16: Processing multipart requests in the forms.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.442.1">import express, { Express } from "express";
</span><strong class="screentext"><span class="kobospan" id="kobo.443.1">import multer from "multer";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.444.1">const fileMiddleware = multer({storage: multer.memoryStorage()});</span></strong><span class="kobospan" id="kobo.445.1">
export const registerFormMiddleware = (app: Express) =&gt; {
    app.use(express.urlencoded({extended: true}))
}
export const registerFormRoutes = (app: Express) =&gt; {
    app.get("/form", (req, resp) =&gt; {
        for (const key in req.query) {
            resp.write(`${key}: ${req.query[key]}\n`);
        }
        resp.end();
    });
 </span><strong class="screentext"><span class="kobospan" id="kobo.446.1">   app.post("/form", fileMiddleware.single("datafile"), (req, resp) =&gt; {</span></strong><span class="kobospan" id="kobo.447.1">
        resp.write(`Content-Type: ${req.headers["content-type"]}\n`)
        for (const key in req.body) {
            resp.write(`${key}: ${req.body[key]}\n`);
        }
       </span><strong class="screentext"><span class="kobospan" id="kobo.448.1"> if (req.file) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.449.1">            resp.write(`---\nFile: ${req.file.originalname}\n`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.450.1">            resp.write(req.file.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.451.1">buffer.toString());           </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.452.1">        }</span></strong><span class="kobospan" id="kobo.453.1">
       
        resp.end();
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.454.1">Before Multer</span><a id="_idIndexMarker532" class="calibre3"/><span class="kobospan" id="kobo.455.1"> can be used, it has to be told where it can store the files it receives. </span><span class="kobospan" id="kobo.455.2">The package comes with two storage options, which are to write the files to a disk folder or to store the file data in memory. </span><span class="kobospan" id="kobo.455.3">As mentioned in </span><em class="italic"><span class="kobospan" id="kobo.456.1">Part 1</span></em><span class="kobospan" id="kobo.457.1">, care must be taken when writing to the file system and it should be avoided as much as possible. </span><span class="kobospan" id="kobo.457.2">If you do need to store data from users, then my advice is to use a database, as described in </span><em class="italic"><span class="kobospan" id="kobo.458.1">Chapter 12</span></em><span class="kobospan" id="kobo.459.1">.</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.460.1">Listing 11.16</span></em><span class="kobospan" id="kobo.461.1"> uses the memory-based storage option to create a middleware component that will process </span><code class="inlinecode"><span class="kobospan" id="kobo.462.1">multipart/form-data</span></code><span class="kobospan" id="kobo.463.1"> requests. </span><span class="kobospan" id="kobo.463.2">Unlike most other middleware, the Multer package is applied to specific routes to prevent malicious users from uploading files on routes where they are not expected:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.464.1">...
</span><span class="kobospan" id="kobo.464.2">app.post("/form", </span><strong class="screentext"><span class="kobospan" id="kobo.465.1">fileMiddleware.single("datafile")</span></strong><span class="kobospan" id="kobo.466.1">, (req, resp) =&gt; {
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.467.1">This statement applies the Multer middleware to just one route and looks for files in a field named </span><code class="inlinecode"><span class="kobospan" id="kobo.468.1">datafile</span></code><span class="kobospan" id="kobo.469.1">, matching the name attribute of the file </span><code class="inlinecode"><span class="kobospan" id="kobo.470.1">input</span></code><span class="kobospan" id="kobo.471.1"> element in the HTML form.</span></p>
<p class="normal"><span class="kobospan" id="kobo.472.1">The</span><a id="_idIndexMarker533" class="calibre3"/><span class="kobospan" id="kobo.473.1"> middleware reads the request body and creates a </span><code class="inlinecode"><span class="kobospan" id="kobo.474.1">file</span></code><span class="kobospan" id="kobo.475.1"> property through which details of the uploaded file can be read, with the most useful properties described in </span><em class="italic"><span class="kobospan" id="kobo.476.1">Table 11.3</span></em><span class="kobospan" id="kobo.477.1">. </span><span class="kobospan" id="kobo.477.2">Body parts that are not files will be presented through the </span><code class="inlinecode"><span class="kobospan" id="kobo.478.1">body</span></code><span class="kobospan" id="kobo.479.1"> property.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.480.1">Table 11.3: Useful file description properties </span></p>
<table class="table-container" id="table003-8">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.481.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.482.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.483.1">originalname</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.484.1">This property returns the name of the file on the user’s system.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.485.1">size</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.486.1">This property returns the size of the file in bytes.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.487.1">mimetype</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.488.1">This property returns the MIME type of the file.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.489.1">buffer</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.490.1">This property returns a Buffer that contains the entire file. </span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.491.1">To see the effect of the middleware, request </span><code class="inlinecode"><span class="kobospan" id="kobo.492.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.493.1">, fill out the </span><code class="inlinecode"><span class="kobospan" id="kobo.494.1">name</span></code><span class="kobospan" id="kobo.495.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.496.1">city</span></code><span class="kobospan" id="kobo.497.1"> form fields, select the </span><code class="inlinecode"><span class="kobospan" id="kobo.498.1">data.json</span></code><span class="kobospan" id="kobo.499.1"> file, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.500.1">Submit</span></strong><span class="kobospan" id="kobo.501.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.502.1">POST/MIME</span></strong><span class="kobospan" id="kobo.503.1">) button. </span><span class="kobospan" id="kobo.503.2">The response includes the values from the body and file properties, as shown in </span><em class="italic"><span class="kobospan" id="kobo.504.1">Figure 11.5</span></em><span class="kobospan" id="kobo.505.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.506.1"><img alt="" src="../Images/B21959_11_05.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.507.1">Figure 11.5: Uploading files</span></p>
<h1 class="heading" id="_idParaDest-196"><span class="kobospan" id="kobo.508.1">Sanitizing form data</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.509.1">It isn’t </span><a id="_idIndexMarker534" class="calibre3"/><span class="kobospan" id="kobo.510.1">just files that you should be cautious about receiving from users: any data has the potential to cause problems. </span><span class="kobospan" id="kobo.510.2">The most common problem is a </span><strong class="screentext"><span class="kobospan" id="kobo.511.1">cross-site scripting</span></strong><span class="kobospan" id="kobo.512.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.513.1">XSS</span></strong><span class="kobospan" id="kobo.514.1">) attack where a data value is crafted so that it is interpreted by the browser as HTML elements or JavaScript code. </span><span class="kobospan" id="kobo.514.2">In </span><em class="italic"><span class="kobospan" id="kobo.515.1">Chapter 7</span></em><span class="kobospan" id="kobo.516.1">, I demonstrated how a content security policy can be used to help prevent XSS by telling the browser how the application is expected to behave, but another good measure is to sanitize data that is received from one user so that it doesn’t contain characters that browsers will interpret unexpectedly when it is displayed to another user. </span><span class="kobospan" id="kobo.516.2">To prepare, </span><em class="italic"><span class="kobospan" id="kobo.517.1">Listing 11.17</span></em><span class="kobospan" id="kobo.518.1"> changes the form handler so it returns an HTML response. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.519.1">Listing 11.17: Returning an HTML response in the forms.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.520.1">import express, { Express } from "express";
import multer from "multer";
const fileMiddleware = multer({storage: multer.memoryStorage()});
export const registerFormMiddleware = (app: Express) =&gt; {
    app.use(express.urlencoded({extended: true}))
}
export const registerFormRoutes = (app: Express) =&gt; {
    app.get("/form", (req, resp) =&gt; {
        for (const key in req.query) {
            resp.write(`${key}: ${req.query[key]}\n`);           
        }
        resp.end();
    });
    app.post("/form", fileMiddleware.single("datafile"), (req, resp) =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.521.1">    resp.setHeader("Content-Type", "text/html");</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.522.1">for (const key in req.body) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.523.1">            resp.write(`&lt;div&gt;${key}: ${req.body[key]}&lt;/div&gt;`);           </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.524.1">        }       </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.525.1">        if (req.file) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.526.1">            resp.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.527.1">write(`&lt;div&gt;File: ${req.file.originalname}&lt;/div&gt;`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.528.1">            resp.write(`&lt;div&gt;${req.file.buffer.toString()}&lt;/div&gt;`);           </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.529.1">        }</span></strong>
<strong class="screentext"> </strong>
<strong class="screentext"><span class="kobospan" id="kobo.530.1">        resp.end();</span></strong><span class="kobospan" id="kobo.531.1">
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.532.1">The </span><a id="_idIndexMarker535" class="calibre3"/><span class="kobospan" id="kobo.533.1">HTML output is simple and unstyled, which you can see by requesting </span><code class="inlinecode"><span class="kobospan" id="kobo.534.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.535.1">, filling out the form with the same details as for previous examples, and clicking the </span><strong class="screentext"><span class="kobospan" id="kobo.536.1">Submit (POST/MIME)</span></strong><span class="kobospan" id="kobo.537.1"> button, as shown in </span><em class="italic"><span class="kobospan" id="kobo.538.1">Figure 11.6</span></em><span class="kobospan" id="kobo.539.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.540.1"><img alt="" src="../Images/B21959_11_06.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.541.1">Figure 11.6: Producing an HTML response</span></p>
<p class="normal"><span class="kobospan" id="kobo.542.1">To see the effect of unsafe content, go back to </span><code class="inlinecode"><span class="kobospan" id="kobo.543.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.544.1"> and fill out the form using the values in </span><em class="italic"><span class="kobospan" id="kobo.545.1">Table 11.4</span></em></p>
<p class="packt_figref"><span class="kobospan" id="kobo.546.1">Table 11.4: Unsafe content values</span></p>
<table class="table-container" id="table004-5">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.547.1">Field</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.548.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.549.1">Name</span></code></p>
</td>
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.550.1">&lt;link href="css/bootstrap.min.css" rel="stylesheet" /&gt;</span></code>
</code></pre>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.551.1">City</span></code></p>
</td>
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.552.1">&lt;a class="btn btn-primary" href="http://packt.com"&gt;Click Me!&lt;/a&gt;</span></code>
</code></pre>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.553.1">Click </span><strong class="screentext"><span class="kobospan" id="kobo.554.1">Submit (POST/MIME)</span></strong><span class="kobospan" id="kobo.555.1"> and the values that were entered into the form will be</span><a id="_idIndexMarker536" class="calibre3"/><span class="kobospan" id="kobo.556.1"> included in the response, which the browser interprets as a </span><code class="inlinecode"><span class="kobospan" id="kobo.557.1">link</span></code><span class="kobospan" id="kobo.558.1"> element for the Bootstrap CSS stylesheet and an anchor element that is styled to look like a button, and which will request a URL that is not part of the application, as shown in </span><em class="italic"><span class="kobospan" id="kobo.559.1">Figure 11.7</span></em><span class="kobospan" id="kobo.560.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.561.1"><img alt="" src="../Images/B21959_11_07.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.562.1">Figure 11.7: The effect of displaying unsafe content</span></p>
<p class="normal"><span class="kobospan" id="kobo.563.1">The sanitization process involves replacing characters that denote HTML content with escape sequences that display the same character. </span><em class="italic"><span class="kobospan" id="kobo.564.1">Table 11.5</span></em><span class="kobospan" id="kobo.565.1"> lists the characters that are usually sanitized and the escape sequences that replace them.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.566.1">Table 11.5: Unsafe characters and escape sequences</span></p>
<table class="table-container" id="table005-4">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.567.1">Unsafe Character</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.568.1">Escape Sequence</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.569.1">&amp;</span></code>
</code></pre>
</td>
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.570.1">&amp;amp;</span></code>
</code></pre>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.571.1">&lt;</span></code>
</code></pre>
</td>
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.572.1">&amp;lt;</span></code>
</code></pre>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.573.1">&gt;</span></code>
</code></pre>
</td>
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.574.1">&amp;gt;</span></code>
</code></pre>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.575.1">=</span></code>
</code></pre>
</td>
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.576.1">&amp;#x3D;</span></code>
</code></pre>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.577.1">" (double quotes)</span></code>
</code></pre>
</td>
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.578.1">&amp;quot;</span></code>
</code></pre>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.579.1">' (single quote)</span></code>
</code></pre>
</td>
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.580.1">&amp;#x27;</span></code>
</code></pre>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.581.1">` (back tick)</span></code>
</code></pre>
</td>
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.582.1">&amp;#x60;</span></code>
</code></pre>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.583.1">Add a </span><a id="_idIndexMarker537" class="calibre3"/><span class="kobospan" id="kobo.584.1">file named </span><code class="inlinecode"><span class="kobospan" id="kobo.585.1">sanitize.ts</span></code><span class="kobospan" id="kobo.586.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.587.1">src/server</span></code><span class="kobospan" id="kobo.588.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.589.1">Listing 11.18</span></em><span class="kobospan" id="kobo.590.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.591.1">Listing 11.18: The contents of the sanitize.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="hljs-keyword"><span class="kobospan" id="kobo.592.1">const</span></span><span class="kobospan" id="kobo.593.1"> matchPattern = </span><span class="hljs-string"><span class="kobospan" id="kobo.594.1">/[&amp;&lt;&gt;="'`]/g</span></span><span class="kobospan" id="kobo.595.1">;
const characterMappings: Record&lt;string, string&gt; = {
    "&amp;": "&amp;amp;",
    "&lt;": "&amp;lt;",
    "&gt;": "&amp;gt;",
    "\"": "&amp;quot;",
    "=": "&amp;#x3D;",   
    "'": "&amp;#x27;",
    "`": "&amp;#x60;"
};
export const santizeValue = (value: string) =&gt;
    value?.replace(matchPattern, match =&gt; characterMappings[match]);
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.596.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.597.1">sanitizeValue</span></code><span class="kobospan" id="kobo.598.1"> function applies a pattern to a string to find dangerous characters and replace them with safe escape sequences. </span><span class="kobospan" id="kobo.598.2">Data values are sanitized as</span><a id="_idIndexMarker538" class="calibre3"/><span class="kobospan" id="kobo.599.1"> they are included in an HTML response. </span><span class="kobospan" id="kobo.599.2">This is usually done as part of the template process – as I demonstrate shortly – but </span><em class="italic"><span class="kobospan" id="kobo.600.1">Listing 11.19</span></em><span class="kobospan" id="kobo.601.1"> applies the </span><code class="inlinecode"><span class="kobospan" id="kobo.602.1">santizeValue</span></code><span class="kobospan" id="kobo.603.1"> function to the values included in the HTML response.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.604.1">Listing 11.19: Sanitizing output values in the forms.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.605.1">import express, { Express } from "express";
import multer from "multer";
</span><strong class="screentext"><span class="kobospan" id="kobo.606.1">import { santizeValue } from "./sanitize";</span></strong><span class="kobospan" id="kobo.607.1">
const fileMiddleware = multer({storage: multer.memoryStorage()});
export const registerFormMiddleware = (app: Express) =&gt; {
    app.use(express.urlencoded({extended: true}))
}
export const registerFormRoutes = (app: Express) =&gt; {
    app.get("/form", (req, resp) =&gt; {
        for (const key in req.query) {
           </span><strong class="screentext"><span class="kobospan" id="kobo.608.1"> resp.write(`${key}: ${req.query[key]}\n`); </span></strong><span class="kobospan" id="kobo.609.1">          
        }
        resp.end();
    });
    app.post("/form", fileMiddleware.single("datafile"), (req, resp) =&gt; {
        resp.setHeader("Content-Type", "text/html");
        for (const key in req.body) {
            </span><strong class="screentext"><span class="kobospan" id="kobo.610.1">resp.write</span></strong><strong class="screentext"><span class="kobospan" id="kobo.611.1">(`&lt;div&gt;${key}: ${ santizeValue( req.body[key])}&lt;/div&gt;`);</span></strong><span class="kobospan" id="kobo.612.1">
        }       
        if (req.file) {
            resp.write(`&lt;div&gt;File: ${req.file.originalname}&lt;/div&gt;`);
            </span><strong class="screentext"><span class="kobospan" id="kobo.613.1">resp.write</span></strong><strong class="screentext"><span class="kobospan" id="kobo.614.1">(`&lt;div&gt;${santizeValue(req.file.buffer.toString())}&lt;/div&gt;`);</span></strong><span class="kobospan" id="kobo.615.1">
        }
   
        resp.end();
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.616.1">Use a </span><a id="_idIndexMarker539" class="calibre3"/><span class="kobospan" id="kobo.617.1">browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.618.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.619.1">, fill out the form with the details in </span><em class="italic"><span class="kobospan" id="kobo.620.1">Table 11.5</span></em><span class="kobospan" id="kobo.621.1">, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.622.1">Submit (POST/MIME)</span></strong><span class="kobospan" id="kobo.623.1"> button. </span><span class="kobospan" id="kobo.623.2">The values received from the user are sanitized as they are included in the HTML response so that the browser can display the strings without interpreting them as valid elements, as shown in </span><em class="italic"><span class="kobospan" id="kobo.624.1">Figure 11.8</span></em><span class="kobospan" id="kobo.625.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.626.1"><img alt="" src="../Images/B21959_11_08.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.627.1">Figure 11.8: Sanitizing data values</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.628.1">Repeatedly Sanitizing data</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.629.1">You must ensure that data is sanitized, but you should only sanitize it once. </span><span class="kobospan" id="kobo.629.2">If data is repeatedly sanitized, then the </span><code class="inlinecode"><span class="kobospan" id="kobo.630.1">&amp;</span></code><span class="kobospan" id="kobo.631.1"> character will be escaped repeatedly. </span><span class="kobospan" id="kobo.631.2">If you start with this unsafe string, for example:</span></p>
<pre class="programlisting2"><code class="hljs-code"><code class="inlinecode2"><span class="kobospan" id="kobo.632.1">&lt;link href="css/bootstrap.min.css" rel="stylesheet" /&gt;</span></code>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.633.1">and sanitize it, the result will be as follows:</span></p>
<pre class="programlisting2"><code class="hljs-code"><code class="inlinecode2"><span class="kobospan" id="kobo.634.1">&amp;lt;link href&amp;#x3D;&amp;quot;css/bootstrap.min.css&amp;quot; rel&amp;#x3D;&amp;quot;stylesheet&amp;quot; /&amp;gt;</span></code>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.635.1">The dangerous characters are escaped but the browser will interpret the escape sequences so that the string looks like the original but won’t be interpreted as an HTML element. </span><span class="kobospan" id="kobo.635.2">If the string is sanitized again, the </span><code class="inlinecode"><span class="kobospan" id="kobo.636.1">&amp;</span></code><span class="kobospan" id="kobo.637.1"> characters, which are already part of escape sequences, will be replaced with </span><code class="inlinecode"><span class="kobospan" id="kobo.638.1">&amp;amp;</span></code><span class="kobospan" id="kobo.639.1">, producing this result:</span></p>
<pre class="programlisting2"><code class="hljs-code"><code class="inlinecode2"><span class="kobospan" id="kobo.640.1">&amp;amp;lt;link href&amp;amp;#x3D;&amp;amp;quot;css/bootstrap.min.css&amp;amp;quot; rel&amp;amp;#x3D;&amp;amp;quot;stylesheet&amp;amp;quot; /&amp;amp;gt;</span></code>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.641.1">The browser won’t be able to interpret the escape sequences properly and will display a mangled string.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.642.1">Most</span><a id="_idIndexMarker540" class="calibre3"/><span class="kobospan" id="kobo.643.1"> template packages will automatically sanitize data values when a template is rendered, and this includes the Handlebars package added to the project in </span><em class="italic"><span class="kobospan" id="kobo.644.1">Chapter 10</span></em><span class="kobospan" id="kobo.645.1">. </span><span class="kobospan" id="kobo.645.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.646.1">formData.handlebars</span></code><span class="kobospan" id="kobo.647.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.648.1">templates/server</span></code><span class="kobospan" id="kobo.649.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.650.1">Listing 11.20</span></em><span class="kobospan" id="kobo.651.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.652.1">Listing 11.20: The contents of the formData.handlebars file in the templates/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.653.1">&lt;table class="table table-sm table-striped"&gt;
    &lt;thead&gt;
        &lt;tr&gt;&lt;th&gt;Field&lt;/th&gt;&lt;th&gt;Value&lt;/th&gt;&lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        &lt;tr&gt;&lt;td&gt;Name:&lt;/td&gt;&lt;td&gt;{{ name }} &lt;/td&gt;&lt;/tr&gt;
        &lt;tr&gt;&lt;td&gt;City:&lt;/td&gt;&lt;td&gt;{{ city }} &lt;/td&gt;&lt;/tr&gt;
        &lt;tr&gt;&lt;td&gt;File:&lt;/td&gt;&lt;td&gt;{{ fileData }} &lt;/td&gt;&lt;/tr&gt;
    &lt;/tbody&gt;
&lt;/table&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.654.1">Handlebars automatically sanitizes data values in </span><code class="inlinecode"><span class="kobospan" id="kobo.655.1">{{</span></code><span class="kobospan" id="kobo.656.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.657.1">}}</span></code><span class="kobospan" id="kobo.658.1"> expressions, making it safe to include in HTML responses. </span><em class="italic"><span class="kobospan" id="kobo.659.1">Listing 11.21</span></em><span class="kobospan" id="kobo.660.1"> updates the form request handler to use the new template.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.661.1">Listing 11.21: Using a template in the forms.ts file in the server/src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.662.1">import express, { Express } from "express";
import multer from "multer";
import { santizeValue } from "./sanitize";
const fileMiddleware = multer({storage: multer.memoryStorage()});
export const registerFormMiddleware = (app: Express) =&gt; {
    app.use(express.urlencoded({extended: true}))
}
export const registerFormRoutes = (app: Express) =&gt; {
    app.get("/form", (req, resp) =&gt; {
        for (const key in req.query) {
            resp.write(`${key}: ${req.query[key]}\n`);           
        }
        resp.end();
    });
    app.post("/form", fileMiddleware.single("datafile"), (req, resp) =&gt; {
        </span><strong class="screentext"><span class="kobospan" id="kobo.663.1">resp.render</span></strong><strong class="screentext"><span class="kobospan" id="kobo.664.1">("formData", {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.665.1">            ...req.body, file: req.file,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.666.1">            fileData: req.file?.buffer.toString()</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.667.1">        });</span></strong><span class="kobospan" id="kobo.668.1">
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.669.1">The </span><a id="_idIndexMarker541" class="calibre3"/><span class="kobospan" id="kobo.670.1">context object passed to the template contains the properties from the </span><code class="inlinecode"><span class="kobospan" id="kobo.671.1">body</span></code><span class="kobospan" id="kobo.672.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.673.1">file</span></code><span class="kobospan" id="kobo.674.1"> objects and a </span><code class="inlinecode"><span class="kobospan" id="kobo.675.1">fileData</span></code><span class="kobospan" id="kobo.676.1"> property that provides direct access to the file data, since Handlebars won’t evaluate code fragments in templates. </span><span class="kobospan" id="kobo.676.2">Request </span><code class="inlinecode"><span class="kobospan" id="kobo.677.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.678.1">, fill out the form using the details in </span><em class="italic"><span class="kobospan" id="kobo.679.1">Table 11.21</span></em><span class="kobospan" id="kobo.680.1">, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.681.1">Submit (POST/MIME)</span></strong><span class="kobospan" id="kobo.682.1"> button and you will see that the template contains safe values, as shown in </span><em class="italic"><span class="kobospan" id="kobo.683.1">Figure 11.9</span></em><span class="kobospan" id="kobo.684.1">.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.685.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.686.1">Handlebars will always sanitize data values in </span><code class="inlinecode"><span class="kobospan" id="kobo.687.1">{{ }}</span></code><span class="kobospan" id="kobo.688.1"> expressions. </span><span class="kobospan" id="kobo.688.2">If you want to include data without sanitization, use the </span><code class="inlinecode"><span class="kobospan" id="kobo.689.1">{{{</span></code><span class="kobospan" id="kobo.690.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.691.1">}}}</span></code><span class="kobospan" id="kobo.692.1"> character sequences instead, as demonstrated in </span><em class="italic"><span class="kobospan" id="kobo.693.1">Chapter 10</span></em><span class="kobospan" id="kobo.694.1">.</span></p>
</div>
<figure class="mediaobject"><span class="kobospan" id="kobo.695.1"><img alt="" src="../Images/B21959_11_09.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.696.1">Figure 11.9: Using a template to sanitize data values</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.697.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.698.1">When combined with a content security policy, sanitizing data in HTML templates is a good basic defense against XSS attacks. </span><span class="kobospan" id="kobo.698.2">But it isn’t comprehensive and potential problems can remain, such as when inserting user data values into JavaScript code that will be executed by the browser. </span><span class="kobospan" id="kobo.698.3">A good checklist for avoiding such problems can be found at </span><a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.699.1">https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html</span></span></a><span class="kobospan" id="kobo.700.1">.</span></p>
</div>
<h1 class="heading" id="_idParaDest-197"><span class="kobospan" id="kobo.701.1">Validating form data</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.702.1">Sanitizing</span><a id="_idIndexMarker542" class="calibre3"/><span class="kobospan" id="kobo.703.1"> data can help prevent malicious values from being displayed to users, but that doesn’t mean that the data you receive will be useful. </span><span class="kobospan" id="kobo.703.2">Users will enter just about anything into a form, sometimes through genuine error, but mostly because forms are an unwelcome obstacle between the user and their goal, whatever that might be.</span></p>
<p class="normal"><span class="kobospan" id="kobo.704.1">The result </span><a id="_idIndexMarker543" class="calibre3"/><span class="kobospan" id="kobo.705.1">is that the data received from forms must be </span><em class="italic"><span class="kobospan" id="kobo.706.1">validated</span></em><span class="kobospan" id="kobo.707.1">, which is the process of ensuring that data can be used by the application and telling the user when invalid data is received. </span><span class="kobospan" id="kobo.707.2">Form validation is most easily done with a template because it makes it easy to give the user feedback when a problem arises. </span><span class="kobospan" id="kobo.707.3">To prepare for validation, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.708.1">age.handlebars</span></code><span class="kobospan" id="kobo.709.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.710.1">templates/server</span></code><span class="kobospan" id="kobo.711.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.712.1">Listing 11.22</span></em><span class="kobospan" id="kobo.713.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.714.1">Listing 11.22: The contents of the age.handlebars file in the templates/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.715.1">&lt;div class="m-2"&gt;
    {{#if nextage }}
        &lt;h4&gt;Hello {{name}}. </span><span class="kobospan" id="kobo.715.2">You will be {{nextage}} next year.&lt;/h4&gt;
    {{/if }}
&lt;/div&gt;
&lt;div&gt;
    &lt;form action="/form" method="post"&gt;
        &lt;div class="m-2"&gt;
            &lt;label class="form-label"&gt;Name&lt;/label&gt;
            &lt;input name="name" class="form-control" value="{{name}}"/&gt;
        &lt;/div&gt;
        &lt;div class="m-2"&gt;
            &lt;label class="form-label"&gt;Current Age&lt;/label&gt;
            &lt;input name="age" class="form-control" value="{{age}}" /&gt;
        &lt;/div&gt;                  
        &lt;div class="m-2"&gt;
            &lt;button class="btn btn-primary"&gt;Submit&lt;/button&gt;                               
        &lt;/div&gt;
    &lt;/form&gt;
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.716.1">This template contains a form that asks the user for their name and age so that the server can calculate their age next year. </span><span class="kobospan" id="kobo.716.2">This is a trivially simple application, but it contains just enough functionality to require validation. </span><em class="italic"><span class="kobospan" id="kobo.717.1">Listing 11.23</span></em><span class="kobospan" id="kobo.718.1"> updates the routes for the </span><code class="inlinecode"><span class="kobospan" id="kobo.719.1">/form</span></code><span class="kobospan" id="kobo.720.1"> URL to use the new template.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.721.1">Listing 11.23: Updating routes in the forms.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.722.1">import express, { Express } from "express";
</span><strong class="screentext"><span class="kobospan" id="kobo.723.1">// import multer from "multer";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.724.1">// import { santizeValue } from "./sanitize";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.725.1">//const fileMiddleware = multer({storage: multer.memoryStorage()});</span></strong><span class="kobospan" id="kobo.726.1">
export const registerFormMiddleware = (app: Express) =&gt; {
    app.use(express.urlencoded({extended: true}))
}
export const registerFormRoutes = (app: Express) =&gt; {
</span><strong class="screentext"><span class="kobospan" id="kobo.727.1">    app.get("/form", (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.728.1">        resp.render("age");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.729.1">    });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.730.1">    app.post("</span></strong><strong class="screentext"><span class="kobospan" id="kobo.731.1">/form", (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.732.1">        resp.render("age", {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.733.1">            ...req.body,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.734.1">            nextage: Number.parseInt(req.body.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.735.1">age) + 1</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.736.1">        });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.737.1">    });</span></strong><span class="kobospan" id="kobo.738.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.739.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.740.1">get</span></code><span class="kobospan" id="kobo.741.1"> route</span><a id="_idIndexMarker544" class="calibre3"/><span class="kobospan" id="kobo.742.1"> renders the age template with no context data. </span><span class="kobospan" id="kobo.742.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.743.1">post</span></code><span class="kobospan" id="kobo.744.1"> route renders the template with the form data received in the body and a </span><code class="inlinecode"><span class="kobospan" id="kobo.745.1">nextage</span></code><span class="kobospan" id="kobo.746.1"> property, which is created by parsing the </span><code class="inlinecode"><span class="kobospan" id="kobo.747.1">age</span></code><span class="kobospan" id="kobo.748.1"> value received from the form into a </span><code class="inlinecode"><span class="kobospan" id="kobo.749.1">Number</span></code><span class="kobospan" id="kobo.750.1"> and adding one. </span><span class="kobospan" id="kobo.750.2">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.751.1">http://localhost:5000/form</span></code><span class="kobospan" id="kobo.752.1">, enter a name and age into the form, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.753.1">Submit</span></strong><span class="kobospan" id="kobo.754.1"> button. </span><span class="kobospan" id="kobo.754.2">If you repeat the process but provide a non-numerical age, the application won’t be able to parse the form data and won’t produce a result. </span><span class="kobospan" id="kobo.754.3">Both outcomes are shown in </span><em class="italic"><span class="kobospan" id="kobo.755.1">Figure 11.10</span></em><span class="kobospan" id="kobo.756.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.757.1"><img alt="" src="../Images/B21959_11_10.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.758.1">Figure 11.10: An application that uses form data to produce a result</span></p>
<p class="normal"><span class="kobospan" id="kobo.759.1">The application</span><a id="_idIndexMarker545" class="calibre3"/><span class="kobospan" id="kobo.760.1"> has expectations for the data that it receives, and validation is the process of ensuring those expectations are met.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.761.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.762.1">Validation is a way of making the user fill out the form, but you should take a moment to ask whether the form should exist at all. </span><span class="kobospan" id="kobo.762.2">If you want increased user satisfaction with your application, then keep forms simple and clear, and ask for only the bare minimum needed to get the job done. </span><span class="kobospan" id="kobo.762.3">Be flexible about the formats you will accept for complex data values, like credit card numbers or dates, and make validation error messages as clear as you can.</span></p>
</div>
<h2 class="heading1" id="_idParaDest-198"><span class="kobospan" id="kobo.763.1">Creating a custom validator</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.764.1">Validation</span><a id="_idIndexMarker546" class="calibre3"/><span class="kobospan" id="kobo.765.1"> requires a set of tests that can be applied to form data as it is received. </span><span class="kobospan" id="kobo.765.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.766.1">validation.ts</span></code><span class="kobospan" id="kobo.767.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.768.1">src/server</span></code><span class="kobospan" id="kobo.769.1"> folder, with the contents shown in </span><em class="italic"><span class="kobospan" id="kobo.770.1">Listing 11.24</span></em><span class="kobospan" id="kobo.771.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.772.1">Listing 11.24: The contents of the validation.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.773.1">import { NextFunction, Request, Response } from "express";
type ValidatedRequest = Request &amp; {
    validation: {
        results:  { [key: string]: {
            [key: string]: boolean, valid: boolean
        } },
        valid: boolean
    }
}
export const validate = (propName: string) =&gt; {
    const tests: Record&lt;string, (val: string) =&gt; boolean&gt; = {};
    const handler = (req: Request, resp: Response, next: NextFunction ) =&gt; {
        // TODO - perform validation checks
        next();
    }
    handler.required = () =&gt; {
        tests.required = (val: string) =&gt; val?.trim().length &gt; 0;
        return handler;
    };
    handler.minLength = (min: number) =&gt; {
        tests.minLength = (val:string) =&gt; val?.trim().length &gt;= min;
        return handler;
    };
    handler.isInteger = () =&gt; {
        tests.isInteger = (val: string) =&gt; /^[0-9]+$/.test(val);
        return handler;
    }
    return handler;
}
export const getValidationResults = (req: Request) =&gt; {
    return (req as ValidatedRequest).validation || { valid : true }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.774.1">There are lots of</span><a id="_idIndexMarker547" class="calibre3"/><span class="kobospan" id="kobo.775.1"> ways to implement a validation system, but the approach taken in </span><em class="italic"><span class="kobospan" id="kobo.776.1">Listing 11.24</span></em><span class="kobospan" id="kobo.777.1"> is to follow the pattern introduced by other packages used in this part of the book and create Express middleware that adds a property to the </span><code class="inlinecode"><span class="kobospan" id="kobo.778.1">Request</span></code><span class="kobospan" id="kobo.779.1"> object. </span><span class="kobospan" id="kobo.779.2">The code isn’t yet complete because it doesn’t apply validation checks. </span><span class="kobospan" id="kobo.779.3">But it does allow validation requirements to be defined, and that’s a good place to start because the code required to easily perform validation can be convoluted. </span></p>
<p class="normal"><span class="kobospan" id="kobo.780.1">The initial </span><a id="_idIndexMarker548" class="calibre3"/><span class="kobospan" id="kobo.781.1">code defines three validation rules: </span><code class="inlinecode"><span class="kobospan" id="kobo.782.1">required</span></code><span class="kobospan" id="kobo.783.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.784.1">minLength</span></code><span class="kobospan" id="kobo.785.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.786.1">isInteger</span></code><span class="kobospan" id="kobo.787.1">. </span><span class="kobospan" id="kobo.787.2">Real validation packages, such as the one I introduce later in this chapter, have dozens of different rules, but three is enough to demonstrate how form data validation works. </span><span class="kobospan" id="kobo.787.3">The </span><code class="inlinecode"><span class="kobospan" id="kobo.788.1">required</span></code><span class="kobospan" id="kobo.789.1"> rule ensures the user has supplied a value, the </span><code class="inlinecode"><span class="kobospan" id="kobo.790.1">minLength</span></code><span class="kobospan" id="kobo.791.1"> rule enforces a minimum number of characters, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.792.1">isInteger</span></code><span class="kobospan" id="kobo.793.1"> rule ensures that the value is an integer.</span></p>
<p class="normal"><span class="kobospan" id="kobo.794.1">The starting point is to give TypeScript a description of the property that will be added to the </span><code class="inlinecode"><span class="kobospan" id="kobo.795.1">Request</span></code><span class="kobospan" id="kobo.796.1"> object, which is how the validation results will be presented to the request handler function:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.797.1">...
</span><span class="kobospan" id="kobo.797.2">type ValidatedRequest = Request &amp; {
    validation: {
        results:  { [key: string]: {
            [key: string]: boolean, valid: boolean
        } },
        valid: boolean
    }
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.798.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.799.1">ValidatedRequest</span></code><span class="kobospan" id="kobo.800.1"> type has all of the features defined by </span><code class="inlinecode"><span class="kobospan" id="kobo.801.1">Request</span></code><span class="kobospan" id="kobo.802.1">, plus a property named </span><code class="inlinecode"><span class="kobospan" id="kobo.803.1">validation</span></code><span class="kobospan" id="kobo.804.1"> that returns an object with </span><code class="inlinecode"><span class="kobospan" id="kobo.805.1">results</span></code><span class="kobospan" id="kobo.806.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.807.1">valid</span></code><span class="kobospan" id="kobo.808.1"> properties. </span><span class="kobospan" id="kobo.808.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.809.1">valid</span></code><span class="kobospan" id="kobo.810.1"> property returns a </span><code class="inlinecode"><span class="kobospan" id="kobo.811.1">boolean</span></code><span class="kobospan" id="kobo.812.1"> value that gives an overall indication of the form data validation outcome. </span><span class="kobospan" id="kobo.812.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.813.1">results</span></code><span class="kobospan" id="kobo.814.1"> property provides detailed information about the form data fields that have been validated. </span><span class="kobospan" id="kobo.814.2">The goal is to produce an object that looks like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.815.1">...
</span><span class="kobospan" id="kobo.815.2">{
  results: {
    name: { valid: false, required: true, minLength: false },
    age: { valid: true, isNumber: true }
  },
  valid: false
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.816.1">This object represents validation checks performed on </span><code class="inlinecode"><span class="kobospan" id="kobo.817.1">name</span></code><span class="kobospan" id="kobo.818.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.819.1">age</span></code><span class="kobospan" id="kobo.820.1"> properties. </span><span class="kobospan" id="kobo.820.2">Overall, the form data is invalid, and inspecting the detail, you can see that this is because the </span><code class="inlinecode"><span class="kobospan" id="kobo.821.1">name</span></code><span class="kobospan" id="kobo.822.1"> property has failed its validation checks, specifically because the name value hasn’t passed the </span><code class="inlinecode"><span class="kobospan" id="kobo.823.1">minLength</span></code><span class="kobospan" id="kobo.824.1"> rule.</span></p>
<p class="normal"><span class="kobospan" id="kobo.825.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.826.1">validate</span></code><span class="kobospan" id="kobo.827.1"> function</span><a id="_idIndexMarker549" class="calibre3"/><span class="kobospan" id="kobo.828.1"> returns an Express middleware function that also has methods, allowing validation to be defined by chaining together the validation rules for a property. </span><span class="kobospan" id="kobo.828.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.829.1">getValidationResults</span></code><span class="kobospan" id="kobo.830.1"> reads the </span><code class="inlinecode"><span class="kobospan" id="kobo.831.1">validation</span></code><span class="kobospan" id="kobo.832.1"> property added to the request, making it easy to access the validation data in the request handler.</span></p>
<h2 class="heading1" id="_idParaDest-199"><span class="kobospan" id="kobo.833.1">Applying validation rules</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.834.1">Creating a </span><a id="_idIndexMarker550" class="calibre3"/><span class="kobospan" id="kobo.835.1">function that also has methods takes advantage of JavaScript’s flexibility, so that validation rules can be specified by calling the </span><code class="inlinecode"><span class="kobospan" id="kobo.836.1">validate</span></code><span class="kobospan" id="kobo.837.1"> method to select a form field and then methods can be called on the result to specify validation rules. </span><span class="kobospan" id="kobo.837.2">This isn’t essential, but it does allow validation requirements to be expressed concisely, as shown in </span><em class="italic"><span class="kobospan" id="kobo.838.1">Listing 11.25</span></em><span class="kobospan" id="kobo.839.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.840.1">Listing 11.25: Defining validation rules in the forms.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.841.1">import express, { Express } from "express";
</span><strong class="screentext"><span class="kobospan" id="kobo.842.1">import { getValidationResults, validate } from "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.843.1">./validation";</span></strong><span class="kobospan" id="kobo.844.1">
export const registerFormMiddleware = (app: Express) =&gt; {
    app.use(express.urlencoded({extended: true}))
}
export const registerFormRoutes = (app: Express) =&gt; {
    app.get("/form", (req, resp) =&gt; {
       </span><strong class="screentext"><span class="kobospan" id="kobo.845.1"> resp.render("age", { </span></strong><strong class="screentext"><span class="kobospan" id="kobo.846.1">helpers: { pass }});</span></strong><span class="kobospan" id="kobo.847.1">
    });
    app.post("/form",
           </span><strong class="screentext"><span class="kobospan" id="kobo.848.1"> validate("name").required().minLength(5),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.849.1">            validate("age").</span></strong><strong class="screentext"><span class="kobospan" id="kobo.850.1">isInteger(),</span></strong><span class="kobospan" id="kobo.851.1">
        (req, resp) =&gt; {
            </span><strong class="screentext"><span class="kobospan" id="kobo.852.1">const validation = getValidationResults(req);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.853.1">            const context = { ...req.body, validation,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.854.1">                helpers: { pass }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.855.1">            };</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.856.1">            if (validation.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.857.1">valid) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.858.1">                context.nextage = Number.parseInt(req.body.age) + 1;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.859.1">            }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.860.1">            resp.render("age", context);  </span></strong><span class="kobospan" id="kobo.861.1">
        });
}
</span><strong class="screentext"><span class="kobospan" id="kobo.862.1">const </span></strong><strong class="screentext"><span class="kobospan" id="kobo.863.1">pass = (valid: any, propname: string, test: string ) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.864.1">    let propResult = valid?.results?.[propname];</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.865.1">    return `display:${!propResult || propResult[test] ? </span><span class="kobospan" id="kobo.865.2">"none" : "block" }`;</span></strong><span class="kobospan" id="kobo.866.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.867.1">The </span><a id="_idIndexMarker551" class="calibre3"/><span class="kobospan" id="kobo.868.1">result of calling a rule method is the handler function that defines it, which means that multiple rules can be selected by chaining together method calls. </span><em class="italic"><span class="kobospan" id="kobo.869.1">Listing 11.25</span></em><span class="kobospan" id="kobo.870.1"> applies the </span><code class="inlinecode"><span class="kobospan" id="kobo.871.1">required</span></code><span class="kobospan" id="kobo.872.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.873.1">minLength</span></code><span class="kobospan" id="kobo.874.1"> rules to the </span><code class="inlinecode"><span class="kobospan" id="kobo.875.1">name</span></code><span class="kobospan" id="kobo.876.1"> field and the </span><code class="inlinecode"><span class="kobospan" id="kobo.877.1">isInteger</span></code><span class="kobospan" id="kobo.878.1"> rule to the </span><code class="inlinecode"><span class="kobospan" id="kobo.879.1">age</span></code><span class="kobospan" id="kobo.880.1"> field.</span></p>
<p class="normal"><span class="kobospan" id="kobo.881.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.882.1">getValidationResults</span></code><span class="kobospan" id="kobo.883.1"> function is called within the handler function to get the validation results, which are used to alter the context object used to render the view so that the (simple) calculation is only performed when valid data has been received from the user.</span></p>
<p class="normal"><span class="kobospan" id="kobo.884.1">The validation results are included in the template context object, which allows a template helper to inspect the results and control the visibility of validation error elements. </span><span class="kobospan" id="kobo.884.2">The elements that display errors to the users will always be present in the template, and </span><em class="italic"><span class="kobospan" id="kobo.885.1">Listing 11.25</span></em><span class="kobospan" id="kobo.886.1"> defines a template helper named </span><code class="inlinecode"><span class="kobospan" id="kobo.887.1">pass</span></code><span class="kobospan" id="kobo.888.1"> that will be used to</span><a id="_idIndexMarker552" class="calibre3"/><span class="kobospan" id="kobo.889.1"> control visibility.</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.890.1">Listing 11.26</span></em><span class="kobospan" id="kobo.891.1"> updates the template to include the error message elements.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.892.1">Listing 11.26: Adding validation messages in the age.handlebars file in the templates/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.893.1">&lt;div class="m-2"&gt;
   </span><strong class="screentext"><span class="kobospan" id="kobo.894.1"> {{#if validation.valid }}</span></strong><span class="kobospan" id="kobo.895.1">
        &lt;h4&gt;Hello {{name}}. </span><span class="kobospan" id="kobo.895.2">You will be {{nextage}} next year.&lt;/h4&gt;
    {{/if }}
&lt;/div&gt;
&lt;div&gt;
   </span><strong class="screentext"><span class="kobospan" id="kobo.896.1"> &lt;form id="age_form" action="/form" method="post"&gt;</span></strong><span class="kobospan" id="kobo.897.1">
        &lt;div class="m-2"&gt;
            &lt;label class="form-label"&gt;Name&lt;/label&gt;
            &lt;input name="name" class="form-control" value="{{name}}"/&gt;
            </span><strong class="screentext"><span class="kobospan" id="kobo.898.1">&lt;div class="</span></strong><strong class="screentext"><span class="kobospan" id="kobo.899.1">text-danger" id="err_name_required"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.900.1">                    style="{{ pass validation 'name' 'required' }}"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.901.1">                Please enter your name</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.902.1">            &lt;/div&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.903.1">            &lt;div class="</span></strong><strong class="screentext"><span class="kobospan" id="kobo.904.1">text-danger" id="err_name_minLength"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.905.1">                    style="{{ pass validation 'name' 'minLength' }}"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.906.1">                Enter at least 5 characters</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.907.1">            &lt;/div&gt;</span></strong><span class="kobospan" id="kobo.908.1">
        &lt;/div&gt;
        &lt;div class="m-2"&gt;
            &lt;label class="form-label"&gt;Current Age&lt;/label&gt;
            &lt;input name="age" class="form-control" value="{{age}}" /&gt;
            </span><strong class="screentext"><span class="kobospan" id="kobo.909.1">&lt;div class</span></strong><strong class="screentext"><span class="kobospan" id="kobo.910.1">="text-danger" id="err_age_isInteger"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.911.1">                    style="{{ pass validation 'age' 'isInteger' }}"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.912.1">                Please enter your age in whole years</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.913.1">            &lt;/div&gt;</span></strong><span class="kobospan" id="kobo.914.1">
        &lt;/div&gt;
        &lt;div class="m-2"&gt;
            &lt;button class="btn btn-primary"&gt;Submit&lt;/button&gt;
        &lt;/div&gt;
    &lt;/form&gt;
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.915.1">The new additions ensure that the results are only displayed if the form data is valid, and </span><a id="_idIndexMarker553" class="calibre3"/><span class="kobospan" id="kobo.916.1">display validation errors when there is a problem. </span><span class="kobospan" id="kobo.916.2">Including the error elements in the template will be helpful for client-side validation, which is demonstrated later in this chapter.</span></p>
<h2 class="heading1" id="_idParaDest-200"><span class="kobospan" id="kobo.917.1">Validating data</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.918.1">The</span><a id="_idIndexMarker554" class="calibre3"/><span class="kobospan" id="kobo.919.1"> final step is to complete the custom validator by applying the tests to a value, as shown in </span><em class="italic"><span class="kobospan" id="kobo.920.1">Listing 11.27</span></em><span class="kobospan" id="kobo.921.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.922.1">Listing 11.27: Completing the validator in the validation.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.923.1">...
</span><span class="kobospan" id="kobo.923.2">export const validate = (propName: string) =&gt; {
    const tests: Record&lt;string, (val: string) =&gt; boolean&gt; = {};
    const handler = (req: Request, resp: Response, next: NextFunction ) =&gt; {
        </span><strong class="screentext"><span class="kobospan" id="kobo.924.1">const vreq = req as ValidatedRequest;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.925.1">        if (!vreq.validation) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.926.1">            vreq.validation = { results: {}, valid: true };</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.927.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.928.1">        vreq.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.929.1">validation.results[propName] = { valid: true };</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.930.1">        Object.keys(tests).forEach(k =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.931.1">            let valid = vreq.validation</span></strong><strong class="screentext"><span class="kobospan" id="kobo.932.1">.results[propName][k]</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.933.1">                = tests[k](req.body?.[propName]);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.934.1">            if (!valid) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.935.1">                vreq.validation.results[propName].valid = false;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.936.1">                vreq.validation.valid = false</span></strong><strong class="screentext"><span class="kobospan" id="kobo.937.1">;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.938.1">            }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.939.1">        });</span></strong><span class="kobospan" id="kobo.940.1">
        next();
    }
    handler.required = () =&gt; {
        tests.required = (val: string) =&gt; val?.trim().length &gt; 0;
        return handler;
    };
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.941.1">I left this step until the end to make the other parts of the validation system easier to understand. </span><span class="kobospan" id="kobo.941.2">Each time one of the validation rule methods is called, such as </span><code class="inlinecode"><span class="kobospan" id="kobo.942.1">required</span></code><span class="kobospan" id="kobo.943.1">, a new property is added to the object assigned to the constant named </span><code class="inlinecode"><span class="kobospan" id="kobo.944.1">tests</span></code><span class="kobospan" id="kobo.945.1">. </span><span class="kobospan" id="kobo.945.2">To perform validation, the </span><code class="inlinecode"><span class="kobospan" id="kobo.946.1">tests</span></code><span class="kobospan" id="kobo.947.1"> properties are enumerated, each test is performed, and the outcome is used to build up the validation results. </span><span class="kobospan" id="kobo.947.2">If any validation test fails, then the overall validation outcome and the outcome for the current field value are set to </span><code class="inlinecode"><span class="kobospan" id="kobo.948.1">false</span></code><span class="kobospan" id="kobo.949.1">.</span></p>
<p class="normal"><span class="kobospan" id="kobo.950.1">Use a </span><a id="_idIndexMarker555" class="calibre3"/><span class="kobospan" id="kobo.951.1">browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.952.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.953.1"> and click the </span><code class="inlinecode"><span class="kobospan" id="kobo.954.1">Submit</span></code><span class="kobospan" id="kobo.955.1"> button without entering values into the form fields. </span><span class="kobospan" id="kobo.955.2">Validation will fail and error messages will be displayed to the user, as shown in </span><em class="italic"><span class="kobospan" id="kobo.956.1">Figure 11.11</span></em><span class="kobospan" id="kobo.957.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.958.1"><img alt="" src="../Images/B21959_11_11.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.959.1">Figure 11.11: Displaying validation errors</span></p>
<p class="normal"><span class="kobospan" id="kobo.960.1">An error message is displayed for each validation rule that fails, and the backend server won’t generate a normal response until validation succeeds.</span></p>
<h1 class="heading" id="_idParaDest-201"><span class="kobospan" id="kobo.961.1">Performing client-side validation</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.962.1">Client-side validation </span><a id="_idIndexMarker556" class="calibre3"/><span class="kobospan" id="kobo.963.1">checks form values before the form is submitted, which can provide </span><a id="_idIndexMarker557" class="calibre3"/><span class="kobospan" id="kobo.964.1">immediate feedback to the user. </span><span class="kobospan" id="kobo.964.2">Client-side validation is used in addition to server-side validation, which is still required because users may disable the client-side JavaScript code or manually submit form data. </span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.965.1">Understanding the Built-in HTML Client validation features</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.966.1">HTML supports validation attributes on input elements, along with a JavaScript API that allows validation events to be received, both of which are described at </span><a href="https://developer.mozilla.org/en-US/docs/Learn/Forms/Form_validation" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.967.1">https://developer.mozilla.org/en-US/docs/Learn/Forms/Form_validation</span></span></a><span class="kobospan" id="kobo.968.1">. </span><span class="kobospan" id="kobo.968.2">These features can be useful, but they are not always implemented consistently and provide only basic validation checks. </span><span class="kobospan" id="kobo.968.3">It requires only a little more work to create a more comprehensive validation system, which is why they are not used in this chapter.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.969.1">The key to client-side development is consistency. </span><span class="kobospan" id="kobo.969.2">This can be achieved by using the same package for both client- and server-side validation, which is the approach I take in the next section. </span><span class="kobospan" id="kobo.969.3">Otherwise, it is important to ensure that fields are validated in the same way and produce the same error messages. </span><span class="kobospan" id="kobo.969.4">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.970.1">client_validation.js</span></code><span class="kobospan" id="kobo.971.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.972.1">src/client</span></code><span class="kobospan" id="kobo.973.1"> folder with the code shown in </span><em class="italic"><span class="kobospan" id="kobo.974.1">Listing 11.28</span></em><span class="kobospan" id="kobo.975.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.976.1">Listing 11.28: The contents of the client_validation.js file in the src/client folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.977.1">export const validate = (propName, formdata) =&gt; {
    const val = formdata.get(propName);
    const results = { };
   
    const validationChain = {
        get propertyName() { return propName},
        get results () { return results }
    };
    validationChain.required = () =&gt; {
        results.required = val?.trim().length &gt; 0;
        return validationChain;
    }
    validationChain.minLength = (min) =&gt; {
        results.minLength = val?.trim().length &gt;= min;
        return validationChain;
    };
    validationChain.isInteger = () =&gt; {
        results.isInteger = /^[0-9]+$/.test(val);
        return validationChain;
    }
    return validationChain;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.978.1">This</span><a id="_idIndexMarker558" class="calibre3"/><span class="kobospan" id="kobo.979.1"> JavaScript code follows a similar pattern to the TypeScript code used to set up chains of validation tests in </span><em class="italic"><span class="kobospan" id="kobo.980.1">Listing 11.24</span></em><span class="kobospan" id="kobo.981.1">, albeit without integration into Express. </span><em class="italic"><span class="kobospan" id="kobo.982.1">Listing 11.29</span></em><span class="kobospan" id="kobo.983.1"> updates the client-side code to</span><a id="_idIndexMarker559" class="calibre3"/><span class="kobospan" id="kobo.984.1"> validate the form data.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.985.1">Listing 11.29: Validating form data in the client.js file in the src/client folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.986.1">import { validate } from "./client_validation";
document.addEventListener('DOMContentLoaded', () =&gt; {
    document.getElementById("age_form").onsubmit = (ev =&gt; {
        const data = new FormData(ev.target);
        const nameValid = validate("name", data)
            .required()
            .minLength(5);
        const ageValid = validate("age", data)
            .isInteger();
        const allValid = [nameValid, ageValid].flatMap(v_result =&gt;
            Object.entries(v_result.results).map(([test, valid]) =&gt; {
                const e = document.getElementById(
                        `err_${v_result.propertyName}_${test}`);
                e.classList.add("bg-dark-subtle");
                e.style.display = valid ? </span><span class="kobospan" id="kobo.986.2">"none" : "block";                      
                return valid
            })).every(v =&gt; v === true);
        if (!allValid) {
            ev.preventDefault();
        }
    });
});
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.987.1">This code locates the form element in the HTML document and registers a handler for the </span><code class="inlinecode"><span class="kobospan" id="kobo.988.1">submit</span></code><span class="kobospan" id="kobo.989.1"> event, which is emitted when the user clicks the </span><strong class="screentext"><span class="kobospan" id="kobo.990.1">Submit</span></strong><span class="kobospan" id="kobo.991.1"> button. </span><span class="kobospan" id="kobo.991.2">The browser’s </span><code class="inlinecode"><span class="kobospan" id="kobo.992.1">FormData</span></code><span class="kobospan" id="kobo.993.1"> API is used to obtain the data in the form, which is tested using </span><a id="_idIndexMarker560" class="calibre3"/><span class="kobospan" id="kobo.994.1">the validation functions defined in </span><em class="italic"><span class="kobospan" id="kobo.995.1">Listing 11.28</span></em><span class="kobospan" id="kobo.996.1">. </span><span class="kobospan" id="kobo.996.2">The validation results are used to change the visibility of the error message elements in the template. </span><span class="kobospan" id="kobo.996.3">If there are any validation errors, the </span><code class="inlinecode"><span class="kobospan" id="kobo.997.1">preventDefault</span></code><span class="kobospan" id="kobo.998.1"> method is called on the submit event, which tells the browser not to send the data to the server. </span><em class="italic"><span class="kobospan" id="kobo.999.1">Listing 11.29</span></em><span class="kobospan" id="kobo.1000.1"> preserves the same style for expressing validation requirements, which leads to some dense code for processing the results, finding the elements that correspond to each test that has been performed, and setting the element visibility.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1001.1">For this </span><a id="_idIndexMarker561" class="calibre3"/><span class="kobospan" id="kobo.1002.1">example, error message elements are added to a Bootstrap CSS class when they are processed by the client-side JavaScript code, just to emphasize when an error has been displayed by the client and not the server.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1003.1">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.1004.1">http://localhost:5000/form</span></code><span class="kobospan" id="kobo.1005.1"> and click the </span><strong class="screentext"><span class="kobospan" id="kobo.1006.1">Submit</span></strong><span class="kobospan" id="kobo.1007.1"> button without filling out the form. </span><span class="kobospan" id="kobo.1007.2">The error message elements will be displayed, but with a solid background color that indicates they were shown by the client-side code, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1008.1">Figure 11.12</span></em><span class="kobospan" id="kobo.1009.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.1010.1"><img alt="" src="../Images/B21959_11_12.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.1011.1">Figure 11.12: Using client-side validation</span></p>
<h1 class="heading" id="_idParaDest-202"><span class="kobospan" id="kobo.1012.1">Using a package for validation</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.1013.1">Having</span><a id="_idIndexMarker562" class="calibre3"/><span class="kobospan" id="kobo.1014.1"> demonstrated how server-side and client-side form validation works, it is time to replace the custom checks with those provided by a well-tested and comprehensive validation library. </span></p>
<p class="normal"><span class="kobospan" id="kobo.1015.1">As with most areas of JavaScript functionality, there are many libraries available, and the one I have chosen for this chapter, </span><code class="inlinecode"><span class="kobospan" id="kobo.1016.1">validator.js</span></code><span class="kobospan" id="kobo.1017.1">, is simple and effective and can be used for both client- and server-side validation. </span><span class="kobospan" id="kobo.1017.2">Run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.1018.1">Listing 11.30</span></em><span class="kobospan" id="kobo.1019.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.1020.1">part2app</span></code><span class="kobospan" id="kobo.1021.1"> folder to install the packages.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1022.1">Listing 11.30: Installing a validation package</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.1023.1">npm install validator@13.11.0
npm install --save-dev @types/validator@13.11.5
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.1024.1">Listing 11.31</span></em><span class="kobospan" id="kobo.1025.1"> updates the client-side validation code to use the tests provided by the </span><code class="inlinecode"><span class="kobospan" id="kobo.1026.1">validator.js</span></code><span class="kobospan" id="kobo.1027.1"> package.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1028.1">Listing 11.31: Using a validation package in the client_validation.js file in the src/client folder</span></p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext"><span class="kobospan" id="kobo.1029.1">import validator from "validator";</span></strong><span class="kobospan" id="kobo.1030.1">
export const validate = (propName, formdata) =&gt; {
    const val = formdata.get(propName);
    const results = { };
   
    const validationChain = {
        get propertyName() { return propName},
        get results () { return results }
    };
    validationChain.required = () =&gt; {
        </span><strong class="screentext"><span class="kobospan" id="kobo.1031.1">results.required = !validator.isEmpty(val, { ignore_whitespace: true});</span></strong><span class="kobospan" id="kobo.1032.1">
        return validationChain;
    }
    validationChain.minLength = (min) =&gt; {
        </span><strong class="screentext"><span class="kobospan" id="kobo.1033.1">results.minLength = validator.isLength(val, { min});</span></strong><span class="kobospan" id="kobo.1034.1">
        return validationChain;
    };
    validationChain.isInteger = () =&gt; {
        </span><strong class="screentext"><span class="kobospan" id="kobo.1035.1">results.isInteger = validator.isInt(val);</span></strong>
<strong class="screentext"> </strong><span class="kobospan" id="kobo.1036.1"> return validationChain;
    }
    return validationChain;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1037.1">The </span><a id="_idIndexMarker563" class="calibre3"/><span class="kobospan" id="kobo.1038.1">full set of tests provided by the </span><code class="inlinecode"><span class="kobospan" id="kobo.1039.1">validator.js</span></code><span class="kobospan" id="kobo.1040.1"> package can be found at </span><a href="https://github.com/validatorjs/validator.js" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.1041.1">https://github.com/validatorjs/validator.js</span></span></a><span class="kobospan" id="kobo.1042.1"> and </span><em class="italic"><span class="kobospan" id="kobo.1043.1">Listing 11.31</span></em><span class="kobospan" id="kobo.1044.1"> uses three of these tests to replace the custom logic while the rest of the code remains the same.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1045.1">The same set of changes can be applied to the server, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1046.1">Listing 11.32</span></em><span class="kobospan" id="kobo.1047.1">, ensuring consistent validation.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1048.1">Listing 11.32: Using a validation package in the validation.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1049.1">import { NextFunction, Request, Response } from "express";
</span><strong class="screentext"><span class="kobospan" id="kobo.1050.1">import validator from "validator";</span></strong><span class="kobospan" id="kobo.1051.1">
type ValidatedRequest = Request &amp; {
    validation: {
        results:  { [key: string]: {
            [key: string]: boolean, valid: boolean
        } },
        valid: boolean
    }
}
export const validate = (propName: string) =&gt; {
    const tests: Record&lt;string, (val: string) =&gt; boolean&gt; = {};
    const handler = (req: Request, resp: Response, next: NextFunction ) =&gt; {
        const vreq = req as ValidatedRequest;
        if (!vreq.validation) {
            vreq.validation = { results: {}, valid: true };
        }
        vreq.validation.results[propName] = { valid: true };
        Object.keys(tests).forEach(k =&gt; {
            let valid = vreq.validation.results[propName][k]
                = tests[k](req.body?.[propName]);
            if (!valid) {
                vreq.validation.results[propName].valid = false;
                vreq.validation.valid = false;
            }
        });
        next();
    }
    handler.required = () =&gt; {
        </span><strong class="screentext"><span class="kobospan" id="kobo.1052.1">tests.required = (val: string) =&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1053.1">            !validator.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1054.1">isEmpty(val, { ignore_whitespace: true});</span></strong><span class="kobospan" id="kobo.1055.1">
        return handler;
    };
    handler.minLength = (min: number) =&gt; {
        </span><strong class="screentext"><span class="kobospan" id="kobo.1056.1">tests.minLength = (val:string) =&gt; validator.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1057.1">isLength(val, { min});</span></strong><span class="kobospan" id="kobo.1058.1">
        return handler;
    };
    handler.isInteger = () =&gt; {
       </span><strong class="screentext"><span class="kobospan" id="kobo.1059.1"> tests.isInteger = (val: string) =&gt; validator.isInt(val);</span></strong><span class="kobospan" id="kobo.1060.1">
        return handler;
    }
    return handler;
}
export const getValidationResults = (req: Request) =&gt; {
    return (req as ValidatedRequest).validation || { valid : true }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1061.1">Request </span><code class="inlinecode"><span class="kobospan" id="kobo.1062.1">http://localhost:5000/form</span></code><span class="kobospan" id="kobo.1063.1"> and submit the form and you will see the validation </span><a id="_idIndexMarker564" class="calibre3"/><span class="kobospan" id="kobo.1064.1">messages shown in </span><em class="italic"><span class="kobospan" id="kobo.1065.1">Figure 11.13</span></em><span class="kobospan" id="kobo.1066.1">. </span><span class="kobospan" id="kobo.1066.2">Disable JavaScript in the browser and repeat the process, and you will see the same validation messages, but this time displayed by the server, also shown in </span><em class="italic"><span class="kobospan" id="kobo.1067.1">Figure 11.13</span></em><span class="kobospan" id="kobo.1068.1">.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.1069.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.1070.1">For Google Chrome, you can disable JavaScript in the </span><em class="italic"><span class="kobospan" id="kobo.1071.1">F12</span></em><span class="kobospan" id="kobo.1072.1"> developer windows by selecting </span><strong class="screentext"><span class="kobospan" id="kobo.1073.1">Run Command</span></strong><span class="kobospan" id="kobo.1074.1"> from the menu with three vertical dots and entering </span><code class="inlinecode"><span class="kobospan" id="kobo.1075.1">java</span></code><span class="kobospan" id="kobo.1076.1"> into the text box. </span><span class="kobospan" id="kobo.1076.2">The browser will present the </span><strong class="screentext"><span class="kobospan" id="kobo.1077.1">Disable JavaScript</span></strong><span class="kobospan" id="kobo.1078.1"> or </span><strong class="screentext"><span class="kobospan" id="kobo.1079.1">Enable JavaScript</span></strong><span class="kobospan" id="kobo.1080.1"> commands.</span></p>
</div>
<figure class="mediaobject"><span class="kobospan" id="kobo.1081.1"><img alt="" src="../Images/B21959_11_13.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.1082.1">Figure 11.13: Using a validation package</span></p>
<p class="normal"><span class="kobospan" id="kobo.1083.1">There is no change in the way validation appears to the user, but the use of a validation</span><a id="_idIndexMarker565" class="calibre3"/><span class="kobospan" id="kobo.1084.1"> package increases confidence that validation will be performed accurately and provides access to a much wider range of validation tests.</span></p>
<h1 class="heading" id="_idParaDest-203"><span class="kobospan" id="kobo.1085.1">Summary</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.1086.1">In this chapter, I described the different ways that applications can receive form data, make it safe to handle, and check that it is the data that the application requires:</span></p>
<ul class="calibre4">
<li class="bulletlist"><span class="kobospan" id="kobo.1087.1">Form data can be sent using </span><code class="inlinecode"><span class="kobospan" id="kobo.1088.1">GET</span></code><span class="kobospan" id="kobo.1089.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1090.1">POST</span></code><span class="kobospan" id="kobo.1091.1"> requests, which affects how the data is encoded.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1092.1">Caution is required when sending data with </span><code class="inlinecode"><span class="kobospan" id="kobo.1093.1">GET</span></code><span class="kobospan" id="kobo.1094.1"> requests because the results may be cached.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1095.1">Different encodings are available for forms sent over </span><code class="inlinecode"><span class="kobospan" id="kobo.1096.1">POST</span></code><span class="kobospan" id="kobo.1097.1"> requests, including an encoding that allows file data to be sent.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1098.1">Form data should be sanitized before it is included in HTML output or used in any operation where the values may be evaluated as trusted content.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1099.1">Form data should be validated before it is used to ensure the values sent by the user can be safely used by the application.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1100.1">Validation can be done by the server or the client. </span><span class="kobospan" id="kobo.1100.2">Client-side validation does not replace server-side validation.</span></li>
</ul>
<p class="normal"><span class="kobospan" id="kobo.1101.1">In the next chapter, I will explain how databases are used in Node.js applications, and how data can be included in the HTML content sent to the client.</span></p>
</div>
</body></html>