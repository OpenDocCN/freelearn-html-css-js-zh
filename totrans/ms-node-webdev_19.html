<html><head></head><body>
<div><h1 class="chapternumber">17</h1>
<h1 class="chaptertitle" id="_idParaDest-294">SportsStore: Navigation and Cart</h1>
<p class="normal1">In this chapter, we will continue to build the SportsStore application by completing the catalog and adding a cart with which the user can make product selections.</p>
<h1 class="heading" id="_idParaDest-295">Preparing for this chapter</h1>
<p class="normal1">This chapter uses the <code class="inlinecode">sportsstore</code> project created in <em class="italic">Chapter 16</em>. No changes are required for this chapter. Open a new command prompt, navigate to the <code class="inlinecode">sportsstore</code> folder, and run the command shown in <em class="italic">Listing 17.1</em> to start the development tools.</p>
<div><p class="normal"><strong class="screentext">Tip</strong></p>
<p class="normal">You can download the example project for this chapter – and for all the other chapters in this book – from <a href="https://github.com/PacktPublishing/Mastering-Node.js-Web-Development" class="calibre3">https://github.com/PacktPublishing/Mastering-Node.js-Web-Development</a>. See <em class="italic">Chapter 1</em> to get help if you have problems running the examples.</p>
</div>
<p class="packt_figref">Listing 17.1: Starting the development fools</p>
<pre class="programlisting1"><code class="hljs-con">npm start
</code></pre>
<p class="normal">Open a new browser window, navigate to <code class="inlinecode">http://localhost:5000</code>, and you will see the data read from the database presented in a simple table format, as shown in <em class="italic">Figure 17.1</em>.</p>
<figure class="mediaobject"><img alt="" src="img/B21959_17_01.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 17.1: Running the application</p>
<h1 class="heading" id="_idParaDest-296">Navigating the catalog</h1>
<p class="normal1">Real online stores have <a id="_idIndexMarker909" class="calibre3"/>too many<a id="_idIndexMarker910" class="calibre3"/> products to sensibly display them all to the user at the same time and typically provide tools to help the user find and select what they want. In the sections that follow, I will add features to SportsStore that will allow the user to navigate through the catalog by choosing the data that is displayed. </p>
<h2 class="heading1" id="_idParaDest-297">Paginating catalog data</h2>
<p class="normal1">Pagination<a id="_idIndexMarker911" class="calibre3"/> presents the user with manageable blocks of data, along with controls to move from one page to the next. The pagination controls give the user a sense of how much data is available, and individual pages require the server to send smaller amounts of data in each response, which can reduce the amount of time the user has to wait for data to be displayed. The drawback of pagination is that it requires the server to handle a lot of HTTP requests and make a lot of database queries as the user navigates through the data.</p>
<p class="normal">When processing a request for a page of data, the server needs to know how many items are displayed on a page, and which page the user wants to get the right data. To generate pagination controls, the server also needs to know how many items there are in total. <em class="italic">Listing 17.2</em> defines new types that describe the query details and the response. </p>
<p class="packt_figref">Listing 17.2: Adding pagination types in the catalog_models.ts file in the src/data folder</p>
<pre class="programlisting"><code class="hljs-code">export interface  Product {
    id?: number;
    name: string;
    description: string;
    price: number;
   
    category?: Category;
    supplier?: Supplier;
}
export interface Category {
    id?: number;
    name: string;
    products?: Product[];
}
export interface Supplier {
    id?: number;
    name: string;
   
    products?: Product[];
}
<strong class="screentext">export interface ProductQueryParameters {</strong>
<strong class="screentext">    pageSize?: number;</strong>
<strong class="screentext">    page?: number;</strong>
<strong class="screentext">}</strong>
<strong class="screentext">export interface ProductQueryResult {</strong>
<strong class="screentext">    products: Product[];</strong>
<strong class="screentext">    totalCount: number;</strong>
<strong class="screentext">}</strong>
</code></pre>
<p class="normal">The <code class="inlinecode">ProductQueryParameters</code> interface allows the pagination requirements associated <a id="_idIndexMarker912" class="calibre3"/>with a query to be provided to the repository. The <code class="inlinecode">ProductQueryResult</code> interface describes the response the repository will produce, which contains the page of data and the total number of stored items. These types will be expanded as other data navigation features are added. <em class="italic">Listing 17.3</em> revises the product query method in the repository interface to support the new types.</p>
<p class="packt_figref">Listing 17.3: Changing a method in the catalog_repository.ts file in the src/data folder</p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext">import</strong><strong class="screentext"> { Category, Product, Supplier, ProductQueryParameters,</strong>
<strong class="screentext">    ProductQueryResult } from "./catalog_models";</strong>
export interface CatalogRepository {
    <strong class="screentext">getProducts(params?: ProductQueryParameters): Promise&lt;ProductQueryResult&gt;;</strong>
    storeProduct(p: Product): Promise&lt;Product&gt;;
    getCategories() : Promise&lt;Category[]&gt;;
    storeCategory(c: Category): Promise&lt;Category&gt;;
    getSuppliers(): Promise&lt;Supplier[]&gt;;
    storeSupplier(s: Supplier): Promise&lt;Supplier&gt;;
}
</code></pre>
<p class="normal">The <code class="inlinecode">getProducts</code> method now accepts an optional <code class="inlinecode">ProductQueryParameters</code> parameter<a id="_idIndexMarker913" class="calibre3"/> and returns a <code class="inlinecode">ProductQueryResult</code> result. <em class="italic">Listing 17.4</em> updates the implementation of the repository to reflect the change in the interface.</p>
<p class="packt_figref">Listing 17.4: Using new types in the queries.ts file in the src/data/orm folder</p>
<pre class="programlisting"><code class="hljs-code">import { CategoryModel, ProductModel, SupplierModel } from "./models";
import { BaseRepo, Constructor } from "./core"
<strong class="screentext">import { ProductQueryParameters } from "../catalog_models";</strong>
export function AddQueries&lt;TBase extends Constructor&lt;BaseRepo&gt;&gt;(Base: TBase) {
    return class extends Base {
   
       <strong class="screentext"> async</strong><strong class="screentext"> getProducts(params?: ProductQueryParameters) {</strong>
<strong class="screentext">            const opts: any = {};</strong>
<strong class="screentext">            if (params?.page &amp;&amp; params.pageSize) {</strong>
<strong class="screentext">                opts.limit = params?.pageSize,</strong>
<strong class="screentext">                opts.offset</strong><strong class="screentext"> = (params.page -1) * params.pageSize               </strong>
<strong class="screentext">            }</strong>
<strong class="screentext">            const result = await ProductModel.findAndCountAll({               </strong>
                include: [
                    {model: SupplierModel, as: "supplier" },
                    {model: CategoryModel, as: "category"}],
                raw: true, nest: true,
                ..<strong class="screentext">.opts</strong>
<strong class="screentext">            });              </strong>
<strong class="screentext">            return { products: result.rows, totalCount: result.count };</strong>
        }
        getCategories() {
            return CategoryModel.findAll({raw: true, nest: true})
        }
   
        getSuppliers() {
            return SupplierModel.findAll({raw: true, nest: true});
        }       
    }
}
</code></pre>
<p class="normal">If a <code class="inlinecode">ProductQueryParameters</code> parameter is received by the <code class="inlinecode">getProducts</code> method, then the Sequelize query is configured with the <code class="inlinecode">limit</code> and <code class="inlinecode">offset</code> properties, which specify the maximum number of results that should be read from the database, and the number of results that should be skipped before starting to read the results. This combination of properties will read a specified page of data.</p>
<p class="normal">The <a id="_idIndexMarker914" class="calibre3"/>query is performed using the <code class="inlinecode">findAndCountAll</code> method, which finds data and includes the total number of items in the database that match the query, regardless of how many of those items are included in the results. The combination of the data returned by the query and the total number of matching items is used to create the <code class="inlinecode">ProductQueryParameters</code> result. <em class="italic">Listing 17.5</em> updates the HTTP handler so that pagination details are read from the query string and included in the call to the repository. If the query string doesn’t include pagination information, then defaults are used to select page 1 with four items per page.</p>
<p class="packt_figref">Listing 17.5: Using page data in the catalog.ts file in the src/routes folder</p>
<pre class="programlisting"><code class="hljs-code">import { Express } from "express";
import { catalog_repository } from "../data";
export const createCatalogRoutes = (app: Express) =&gt; {
    app.get("/", async (req, resp) =&gt; {
        const page = Number.parseInt(req.query.page?.toString() ?? "1");
       <strong class="screentext"> const pageSize =Number.parseInt(req.query.pageSize?.toString() ?? "3");</strong>
<strong class="screentext">        const res = await catalog_repository.</strong><strong class="screentext">getProducts({ page, pageSize});</strong>
<strong class="screentext">        resp.render("index", { ...res, page, pageSize,</strong>
<strong class="screentext">            pageCount: Math.ceil(res.totalCount / (pageSize ?? 1))});</strong>
    });
}
</code></pre>
<p class="normal">You can<a id="_idIndexMarker915" class="calibre3"/> check that data is being paged by using a browser to request <code class="inlinecode">http://localhost:5000/?pageSize=3&amp;page=2</code>. The URL specifies a page size of three items and asks for page 2, producing the result shown in <em class="italic">Figure 17.2</em>.</p>
<figure class="mediaobject"><img alt="" src="img/B21959_17_02.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 17.2: Displaying a page of data</p>
<h3 class="heading2" id="_idParaDest-298">Adding pagination controls</h3>
<p class="normal1">Now<a id="_idIndexMarker916" class="calibre3"/> that the data can be paged, the next step is to provide the user with the ability to select the page they want. Add a file named <code class="inlinecode">page_controls.handlebars</code> to the <code class="inlinecode">templates</code> folder with the content shown in <em class="italic">Listing 17.6</em>. </p>
<p class="packt_figref">Listing 17.6: The contents of the page_controls.handlebars file in the templates folder</p>
<pre class="programlisting"><code class="hljs-code">&lt;div class="col"&gt;
    {{#pageButtons }}
        {{#if selected}}
            &lt;button class="btn btn-sm btn-light active mr-1 p-2"&gt;
                {{index}}
            &lt;/button&gt;
        {{else}}
        &lt;a class="btn btn-sm btn-light mr-1 p-2"
            href="{{navigationUrl page=index }}"&gt;{{index}}&lt;/a&gt;
        {{/if}}
    {{/pageButtons}}
&lt;/div&gt;
</code></pre>
<p class="normal">This <a id="_idIndexMarker917" class="calibre3"/>template relies on two helpers, which will be defined shortly. The <code class="inlinecode">pageButtons</code> helper will repeatedly generate a section of content for each page of content, using the pagination data provided to the template:</p>
<pre class="programlisting"><code class="hljs-code">...
{{#pageButtons }}
   // ...template content omitted for brevity...
{{/pageButtons}}
...
</code></pre>
<p class="normal">The content contained between the helper tags will be duplicated for each available page of data. Each block of content is provided with an <code class="inlinecode">index</code> value that indicates the page for which a control is being generated and a <code class="inlinecode">selected</code> value that indicates whether the current page is the one the user is viewing. When the selected value is <code class="inlinecode">true</code>, a button that does nothing is displayed, formatted in an active state to indicate the current page. For the other pages, an anchor element (with the <code class="inlinecode">a</code> tag) is displayed, formatted as an inactive button. The <code class="inlinecode">href</code> attribute of the anchor element is defined using a helper named <code class="inlinecode">navigationUrl</code> that generates a URL that will navigate to the selected page. To define template helpers for the catalog, add a file named <code class="inlinecode">catalog_helpers.ts</code> to the <code class="inlinecode">src/helpers</code> folder with the content shown in <em class="italic">Listing 17.7</em>.</p>
<p class="packt_figref">Listing 17.7: The contents of the catalog_helpers.ts file in the src/helpers folder</p>
<pre class="programlisting"><code class="hljs-code">import { HelperOptions }  from "handlebars";
import { stringify } from "querystring";
import { escape } from "querystring";
const getData = (options:HelperOptions) =&gt; {
     return {...options.data.root, ...options.hash}
};
export const navigationUrl = (options: HelperOptions) =&gt; {
    const { page, pageSize } = getData(options);
    return "/?" + stringify({ page, pageSize });
}
export const escapeUrl = (url: string) =&gt; escape(url);
export const pageButtons = (options: HelperOptions) =&gt; {
    const { page, pageCount } = getData(options);
    let output = "";
    for (let i = 1; i &lt;= pageCount; i++) {
        output += options.fn({
            page, pageCount, index: i, selected: i === page
        });
    }
    return output;
}
</code></pre>
<p class="normal">Helper<a id="_idIndexMarker918" class="calibre3"/> functions receive a <code class="inlinecode">HelperOptions</code> parameter that provides useful context features. The <code class="inlinecode">HelperOptions.hash</code> property is used to receive data in name/value pairs and is a useful way to provide structured data to a helper, like this:</p>
<pre class="programlisting"><code class="hljs-code">...
href="{{navigationUrl page=index }}"&gt;{{index}}&lt;/a&gt;
...
</code></pre>
<p class="normal">The <code class="inlinecode">HelperOptions.data</code> property provides access to context data, and its <code class="inlinecode">root</code> property contains the data from the template that invoked the helper. The <code class="inlinecode">getData</code> method merges the values from the hash data with the root data.</p>
<div><p class="normal"><strong class="screentext">Caution</strong></p>
<p class="normal">The Handlebars package is excellent but not all of the features provided by the <code class="inlinecode">HelperOptions</code> interface are documented, including the use of the <code class="inlinecode">data.root</code> property. Future versions of the package may change the way this property is defined, so you must either take care to use the version specified in <em class="italic">Chapter 16</em> or check the documentation and source code to see what’s changed.</p>
</div>
<p class="normal">The <code class="inlinecode">navigationUrl</code> helper function accepts a <code class="inlinecode">HelperOptions</code> argument and uses it to generate<a id="_idIndexMarker919" class="calibre3"/> a relative URL path that will select a specific page, which is done using the <code class="inlinecode">stringify</code> function from the <code class="inlinecode">querystring</code> module that Node.js provides for creating and parsing query strings:</p>
<pre class="programlisting"><code class="hljs-code">...
return "/?" + <strong class="screentext">stringify</strong>({ page, pageSize });
...
</code></pre>
<p class="normal">The <code class="inlinecode">pageButtons</code> function is more complex because it needs to generate blocks of content, which is done using the function assigned to the <code class="inlinecode">HelperOptions.fn</code> property, which generates content using the elements contained between the helper tags. The <code class="inlinecode">escapeUrl</code> helper encodes a value so that it can be included in a query string.</p>
<p class="normal">The <code class="inlinecode">pageButtons</code> helper uses a <code class="inlinecode">for</code> loop and the <code class="inlinecode">fn</code> function to create content for each data page, supplementing the shared pagination data with <code class="inlinecode">index</code> and <code class="inlinecode">selected</code> values that are specific to each page. <em class="italic">Listing 17.8</em> adds the new helpers to the template engine configuration.</p>
<p class="packt_figref">Listing 17.8: Adding helpers to the index.ts file in the src/helpers folder</p>
<pre class="programlisting"><code class="hljs-code">import { Express } from "express";
import { getConfig } from "../config";
import { engine } from "express-handlebars";
import * as env_helpers from "./env";
<strong class="screentext">import</strong><strong class="screentext"> * as catalog_helpers from "./catalog_helpers";</strong>
const location = getConfig("templates:location");
const config = getConfig("templates:config");
export const createTemplates = (app: Express) =&gt; {
    app.set("views", location);
    app.engine("handlebars", engine({
        ...<strong class="screentext">config, helpers</strong><strong class="screentext">: {...env_helpers, ...catalog_helpers}</strong>
    }));
    app.set("view engine", "handlebars");
}
</code></pre>
<p class="normal">The <a id="_idIndexMarker920" class="calibre3"/>final step is to include the partial template defined in <em class="italic">Listing 17.7</em> into the content generated by the application, as shown in <em class="italic">Listing 17.9</em>.</p>
<p class="packt_figref">Listing 17.9: Using the pagination partial view in the index.handlebars file in the templates folder</p>
<pre class="programlisting"><code class="hljs-code">&lt;table class="table table-sm table-striped"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Description&lt;/th&gt;
            &lt;th&gt;Price&lt;/th&gt;&lt;th&gt;Category&lt;/th&gt;&lt;th&gt;Supplier&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        {{#each products }}
            &lt;tr&gt;
                &lt;td&gt;{{id}}&lt;/td&gt;&lt;td&gt;{{name}}&lt;/td&gt;
                &lt;td&gt;{{description}}&lt;/td&gt;&lt;td&gt;{{price}}&lt;/td&gt;
                &lt;td&gt;{{category.name}}&lt;/td&gt;&lt;td&gt;{{supplier.name}}&lt;/td&gt;
            &lt;/tr&gt;
        {{/each}}
    &lt;/tbody&gt;
&lt;/table&gt;
<strong class="screentext">{{&gt; page_controls }}</strong>
</code></pre>
<p class="normal">Use a browser to request <code class="inlinecode">http://localhost:5000/?pageSize=3</code>. The <code class="inlinecode">pageSize</code> value specifies three data items to a page, and omitting the <code class="inlinecode">page</code> value from the query string will default to the first page of data, as shown in <em class="italic">Figure 17.3</em>. A button will be displayed <a id="_idIndexMarker921" class="calibre3"/>for each available page, and clicking an inactive button will select a different page.</p>
<figure class="mediaobject"><img alt="" src="img/B21959_17_03.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 17.3: Paging through data</p>
<h3 class="heading2" id="_idParaDest-299">Changing the page size</h3>
<p class="normal1">To allow<a id="_idIndexMarker922" class="calibre3"/> the user to change the number of items per page, <em class="italic">Listing 17.10</em> creates a grid that contains the existing page buttons, plus a <strong class="screentext">select</strong> button that is populated with different page sizes. </p>
<p class="packt_figref">Listing 17.10: Adding a select button to the page_controls.handlebars file in the templates folder</p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext">&lt;div</strong><strong class="screentext"> class="container-fluid"&gt;</strong>
<strong class="screentext">    &lt;div class="row"&gt;</strong>
        &lt;div class="col"&gt;
            {{#pageButtons }}
                {{#if selected}}
                    &lt;button class="btn btn-sm btn-light active mr-1 p-2"&gt;
                        {{index}}
                    &lt;/button&gt;
                {{else}}
                &lt;a class="btn btn-sm btn-light mr-1 p-2"
                    href="{{navigationUrl page=index }}"&gt;{{index}}&lt;/a&gt;
                {{/if}}
            {{/pageButtons}}
        &lt;/div&gt;
        &lt;div class="col-auto text-end"&gt;        
        <strong class="screentext">    &lt;form id="pageSizeForm" method="get"&gt;</strong>
<strong class="screentext">                &lt;select class="form-select"</strong><strong class="screentext"> name="pageSize"&gt;</strong>
<strong class="screentext">                    {{#pageSizeOptions }}</strong>
<strong class="screentext">                        &lt;option value="{{size}}" {{selected}}&gt;</strong>
<strong class="screentext">                            {{size}} per page</strong>
<strong class="screentext">                        &lt;/option&gt;</strong>
<strong class="screentext">                    {{/pageSizeOptions }}</strong>
<strong class="screentext"> </strong><strong class="screentext">&lt;/select&gt;</strong>
<strong class="screentext">            &lt;/form&gt;      </strong>
<strong class="screentext">        &lt;/div&gt;</strong>
<strong class="screentext">        &lt;div class="col-auto"&gt;</strong>
<strong class="screentext"> </strong><strong class="screentext">&lt;button class="btn btn-light mr-2" type="submit"</strong>
<strong class="screentext">                form="pageSizeForm"&gt;Go&lt;/button&gt;</strong>
<strong class="screentext"> </strong><strong class="screentext">&lt;/div&gt;</strong>
<strong class="screentext">    &lt;/div&gt;</strong>
<strong class="screentext">&lt;/div&gt;</strong>
</code></pre>
<p class="normal">The<a id="_idIndexMarker923" class="calibre3"/> form is submitted by a <code class="inlinecode">button</code> element, which is configured with the <code class="inlinecode">form</code> attribute, allowing it to be positioned in the grid without needing to be a descendant of the <code class="inlinecode">form</code> element. The option elements are created by a template helper named <code class="inlinecode">pageSizeOptions</code>, which is defined in <em class="italic">Listing 17.11</em>.</p>
<p class="packt_figref">Listing 17.11: Defining a helper in the catalog_helpers.ts file in the src/helpers folder</p>
<pre class="programlisting"><code class="hljs-code">import { HelperOptions }  from "handlebars";
import { stringify } from "querystring";
import { escape } from "querystring";
// ...other helpers omitted for brevity...
<strong class="screentext">export const pageSizeOptions = (options: HelperOptions) =&gt; {</strong>
<strong class="screentext">    const { pageSize } = getData(options);</strong>
<strong class="screentext">    let output = ""</strong><strong class="screentext">;</strong>
<strong class="screentext">    [3, 6, 9].forEach(size =&gt; {</strong>
<strong class="screentext">        output += options.fn({ size,</strong>
<strong class="screentext">            selected: pageSize === size ? "selected": ""})</strong>
<strong class="screentext">    })</strong>
<strong class="screentext"> </strong><strong class="screentext">return output;</strong>
<strong class="screentext">}</strong>
</code></pre>
<p class="normal">The<a id="_idIndexMarker924" class="calibre3"/> helper generates options that allow the user to choose <strong class="screentext">3</strong>, <strong class="screentext">6</strong>, or <strong class="screentext">9</strong> items per page, and the <code class="inlinecode">selected</code> attribute is applied to the <code class="inlinecode">option</code> element that matches the current page size. Use a browser to request <code class="inlinecode">http://localhost:5000</code>, select <strong class="screentext">6 per page</strong> from the select options, and click the <strong class="screentext">Go</strong> button. The form will submit a GET request that specifies the new page size, as shown in <em class="italic">Figure 17.4</em>.</p>
<figure class="mediaobject"><img alt="" src="img/B21959_17_04.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 17.4: Changing the page size</p>
<h2 class="heading1" id="_idParaDest-300">Filtering catalog data</h2>
<p class="normal1">The <a id="_idIndexMarker925" class="calibre3"/>next navigation feature will allow the user to filter the catalog by selecting a category or providing a search term. <em class="italic">Listing 17.12</em> adds new properties to the <code class="inlinecode">ProductQueryParameters</code> interface to support filtering, and adds a <code class="inlinecode">categories</code> property to the <code class="inlinecode">ProductQueryResult</code> interface so that the user can be presented with a list of categories. </p>
<p class="packt_figref">Listing 17.12: Adding support for filtering to the catalog_models.ts file in the src/data folder</p>
<pre class="programlisting"><code class="hljs-code">...
export interface ProductQueryParameters {
    pageSize?: number;
    page?: number;
  <strong class="screentext">  category?: number;</strong>
<strong class="screentext">    searchTerm?: string;</strong>
}
export interface ProductQueryResult {
    products: Product[];
    totalCount: number;
  <strong class="screentext">  categories: Category[];</strong>
}
...
</code></pre>
<p class="normal"><em class="italic">Listing 17.13</em> uses the new properties to query the database, filtering the data based on the search term and selected category.</p>
<p class="packt_figref">Listing 17.13: Filtering data in the queries.ts file in the src/data/orm folder</p>
<pre class="programlisting"><code class="hljs-code">import { CategoryModel, ProductModel, SupplierModel } from "./models";
import { BaseRepo, Constructor } from "./core"
import { ProductQueryParameters } from "../catalog_models";
<strong class="screentext">import { Op } from "sequelize";</strong>
export function AddQueries&lt;TBase extends Constructor&lt;BaseRepo&gt;&gt;(Base: TBase) {
    return class extends Base {
   
        async getProducts(params?: ProductQueryParameters) {
            const opts: any = {};
            if (params?.page &amp;&amp; params.pageSize) {
                opts.limit = params?.pageSize,
                opts.offset = (params.page -1) * params.pageSize               
            }
            <strong class="screentext">if(params?.searchTerm) {</strong>
<strong class="screentext">      const</strong><strong class="screentext"> searchOp = { [Op.like]: "%" + params.searchTerm + "%"};</strong>
<strong class="screentext">                opts.where = {</strong>
<strong class="screentext">                    [Op.or]: { name: searchOp, description</strong><strong class="screentext">: searchOp }</strong>
<strong class="screentext">                }</strong>
<strong class="screentext">            }</strong>
<strong class="screentext">            if (params?.category) {</strong>
<strong class="screentext">                opts.where = {</strong>
<strong class="screentext">                    ...opts.where,  categoryId: params.category</strong>
<strong class="screentext">                }</strong>
<strong class="screentext">            }</strong>
            const result = await ProductModel.findAndCountAll({               
                include: [
                    {model: SupplierModel, as: "supplier" },
                    {model: CategoryModel, as: "category"}],
                raw: true, nest: true,
                ...opts
            });              
          <strong class="screentext">  const categories = await this.getCategories();</strong>
<strong class="screentext">            return { products: result.rows</strong><strong class="screentext">, totalCount: result.count, categories };</strong>
        }
        getCategories() {
            return CategoryModel.findAll({raw: true, nest: true})
        }
   
        getSuppliers() {
            return SupplierModel.findAll({raw: true, nest: true});
        }       
    }
}
</code></pre>
<p class="normal">The<a id="_idIndexMarker926" class="calibre3"/> changes in <em class="italic">Listing 17.13</em> inspect the <code class="inlinecode">ProductQueryParameters</code> object and introduce a <code class="inlinecode">where</code> clause to restrict the database query. Filtering for a category is done by requiring a specific <code class="inlinecode">categoryId</code> value. Searches are more complex. Some database servers have support for performing full-text searches on data, but this isn’t supported by Sequelize, which is why the <code class="inlinecode">like </code>operation is used. When the user provides a search term, the <code class="inlinecode">where</code> clause is used to match data using either the <a id="_idIndexMarker927" class="calibre3"/>name or description values. Like most ORMs, Sequelize concentrates on features that are widely and consistently supported, which means that not every capability of a database server is available. That said, you can execute raw SQL queries to access any feature, as demonstrated in <em class="italic">Chapter 12</em>.</p>
<p class="normal"><em class="italic">Listing 17.14</em> updates the HTTP request handler so that the category and search term are read from the query string passed on to the repository and included in the data passed to the template engine.</p>
<p class="packt_figref">Listing 17.14: Supporting filtering in the catalog.ts file in the src/routes folder</p>
<pre class="programlisting"><code class="hljs-code">import { Express } from "express";
import { catalog_repository } from "../data";
export const createCatalogRoutes = (app: Express) =&gt; {
    app.get("/", async (req, resp) =&gt; {
        const page = Number.parseInt(req.query.page?.toString() ?? "1");
        const pageSize =Number.parseInt(req.query.pageSize?.toString() ?? "3")
       <strong class="screentext"> const searchTerm = req.query.searchTerm?.toString();</strong>
<strong class="screentext"> </strong><strong class="screentext">const category = Number.parseInt(req.query.category?.toString() ?? "")</strong>
<strong class="screentext">        const res = await catalog_repository.getProducts({ page, pageSize,</strong>
<strong class="screentext">            searchTerm, category});</strong>
<strong class="screentext">        resp.</strong><strong class="screentext">render("index", { ...res, page, pageSize,</strong>
<strong class="screentext">            pageCount: Math.ceil(res.totalCount / (pageSize ?? 1)),</strong>
<strong class="screentext">            searchTerm, category</strong>
<strong class="screentext">        });</strong>
    });
}
</code></pre>
<p class="normal">To confirm that the filtering features work, use a browser to request <code class="inlinecode">http://localhost:5000/?searchTerm=pro</code>, which should filter the data to products whose name or description contains the term <code class="inlinecode">pro</code>. To include a category filter, request <code class="inlinecode">http://localhost:5000/?searchTerm=pro&amp;category=2</code>, which will further restrict<a id="_idIndexMarker928" class="calibre3"/> the data to products in the <code class="inlinecode">Soccer</code> category. Both sets of results are shown in <em class="italic">Figure 17.5</em>.</p>
<figure class="mediaobject"><img alt="" src="img/B21959_17_05.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 17.5: Filtering data using the query string parameters</p>
<h3 class="heading2" id="_idParaDest-301">Adding filtering controls</h3>
<p class="normal1">Providing <a id="_idIndexMarker929" class="calibre3"/>the user with the controls for filtering means presenting a list of category buttons and an input element for entering a search term. Add a file named <code class="inlinecode">category_controls.handlebars</code> to the <code class="inlinecode">templates</code> folder with the content shown in <em class="italic">Listing 17.15</em>.</p>
<p class="packt_figref">Listing 17.15: The contents of the category_controls.handlebars file in the templates folder</p>
<pre class="programlisting"><code class="hljs-code">&lt;div class="d-grid gap-2 py-2"&gt;
    &lt;a class="btn btn-outline-secondary"
        href="{{navigationUrl category="" page=1 searchTerm="" }}"&gt;
            Home
    &lt;/a&gt;
    {{#categoryButtons  }}
        {{#if selected }}
            &lt;a class="btn btn-secondary"&gt;{{ name }}&lt;/a&gt;
        {{else }}
            &lt;a class="btn btn-outline-secondary"
                href="{{navigationUrl category=id page=1}}"&gt;
                {{ name }}
            &lt;/a&gt;
        {{/if }}
    {{/categoryButtons }}
&lt;/div&gt;
</code></pre>
<p class="normal">This<a id="_idIndexMarker930" class="calibre3"/> template relies on a helper named <code class="inlinecode">categoryButtons</code> to generate buttons for category navigation. The helper will provide a <code class="inlinecode">selected</code> value, which is used to decide whether to generate an inactive placeholder (for the selected category) or an anchor element that will select a category, using an <code class="inlinecode">href</code> attribute created by the <code class="inlinecode">navigationUrl</code>. There is also a <code class="inlinecode">Home</code> button that is always present, and which selects all categories.</p>
<p class="normal">When generating the URLs for the <code class="inlinecode">href</code> attribute, this template sets navigation values other than <code class="inlinecode">category</code> to ensure the user is presented with useful content. For the <code class="inlinecode">Home</code> button, this means clearing the <code class="inlinecode">searchTerm</code> value and selecting the first page of content:</p>
<pre class="programlisting"><code class="hljs-code">...
&lt;a class="btn btn-outline-secondary"
    href="{{navigationUrl category="" page=1 searchTerm="" }}"&gt;
...
</code></pre>
<p class="normal">Setting these values gives the user a reset option, leaving only the <code class="inlinecode">pageSize</code> option unchanged. For the buttons that select a category, the <code class="inlinecode">page</code> value is reset:</p>
<pre class="programlisting"><code class="hljs-code">...
&lt;a class="btn btn-outline-secondary"
    href="{{navigationUrl category=id page=1}}"&gt;
...
</code></pre>
<p class="normal">This ensures that the user is always presented with products when moving from a category with many products to one with fewer and prevents presenting an empty <a id="_idIndexMarker931" class="calibre3"/>page. <em class="italic">Listing 17.16</em> defines the <code class="inlinecode">categoryButtons</code> helper and updates the <code class="inlinecode">navigationUrl</code> helper so that it includes the category and search term selections in the URLs it creates.</p>
<p class="packt_figref">Listing 17.16: Supporting filtering in the catalog_helpers.ts file in the src/helpers folder</p>
<pre class="programlisting"><code class="hljs-code">import { HelperOptions }  from "handlebars";
import { stringify } from "querystring";
import { escape } from "querystring";
const getData = (options:HelperOptions) =&gt; {
     return {...options.data.root, ...options.hash}
};
export const navigationUrl = (options: HelperOptions) =&gt; {
    <strong class="screentext">const { page, pageSize, category, searchTerm } = getData(options);</strong>
<strong class="screentext">    return "/?" + stringify({ page, pageSize, category, searchTerm  });</strong>
}
export const escapeUrl = (url: string) =&gt; escape(url);
export const pageButtons = (options: HelperOptions) =&gt; {
    const { page, pageCount } = getData(options);
    let output = "";
    for (let i = 1; i &lt;= pageCount; i++) {
        output += options.fn({
            page, pageCount, index: i, selected: i === page
        });
    }
    return output;
}
export const pageSizeOptions = (options: HelperOptions) =&gt; {
    const { pageSize } = getData(options);
    let output = "";
    [3, 6, 9].forEach(size =&gt; {
        output += options.fn({ size,
            selected: pageSize === size ? "selected": ""})
    })
    return output;
}
<strong class="screentext">export const categoryButtons = (options: HelperOptions) =&gt; {</strong>
<strong class="screentext">    const { category, categories } = getData</strong><strong class="screentext">(options);</strong>
<strong class="screentext">    let output = "";</strong>
<strong class="screentext">    for (let i = 0; i &lt; categories.length; i++) {</strong>
<strong class="screentext">        output += options.fn({</strong>
<strong class="screentext">            id: categories[i].id</strong><strong class="screentext">,</strong>
<strong class="screentext">            name: categories[i].name,</strong>
<strong class="screentext">            selected: category === categories[i].id</strong>
<strong class="screentext">        })</strong>
<strong class="screentext">    }</strong>
<strong class="screentext">    return output;</strong>
}
</code></pre>
<p class="normal">To add <a id="_idIndexMarker932" class="calibre3"/>support for entering a search term, add a file named <code class="inlinecode">search_controls.handlebars</code> to the <code class="inlinecode">templates</code> folder with the content shown in <em class="italic">Listing 17.17</em>.</p>
<p class="packt_figref">Listing 17.17: The contents of the search_controls.handlebars file in the templates folder</p>
<pre class="programlisting"><code class="hljs-code">&lt;form class="row row-cols my-2" method="get"&gt;
    &lt;div class="col"&gt;
        &lt;input type="hidden" name="pageSize" value="{{pageSize}}"&gt;
        &lt;input type="hidden" name="category" value="{{category}}"&gt;
        &lt;input class="form-control" name="searchTerm"
            placeholder="Product Search" value="{{searchTerm}}"&gt;
    &lt;/div&gt;
    &lt;div class="col-auto"&gt;
        &lt;button class="btn btn-small btn-secondary" type="submit"&gt;
            Search
        &lt;/button&gt;
    &lt;/div&gt;
&lt;/form&gt;
</code></pre>
<p class="normal">This template contains a form with an <code class="inlinecode">input</code> element into which a search term is entered and a button that submits the form. The form is submitted using a <code class="inlinecode">GET</code> request, and<a id="_idIndexMarker933" class="calibre3"/> there are hidden <code class="inlinecode">input</code> elements to ensure that the <code class="inlinecode">pageSize</code> and <code class="inlinecode">category</code> values are included alongside the search term in the query string sent to the server. <em class="italic">Listing 17.18</em> integrates the new templates into the content presented to the user.</p>
<p class="packt_figref">Listing 17.18: Integrating filtering in the index.handlebars file in the templates folder</p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext">&lt;div</strong><strong class="screentext"> class="container-fluid"&gt;</strong>
<strong class="screentext">    &lt;div class="row"&gt;</strong>
<strong class="screentext">        &lt;div class="col-2"</strong><strong class="screentext">&gt;</strong>
<strong class="screentext">            {{&gt; category_controls }}</strong>
<strong class="screentext">        &lt;/div&gt;</strong>
<strong class="screentext">        &lt;div class="col"&gt;</strong>
<strong class="screentext">            {{&gt; search_controls }}</strong>
            &lt;table class="table table-sm table-striped"&gt;
                &lt;thead&gt;
                    &lt;tr&gt;
                        &lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Description&lt;/th&gt;
                        &lt;th&gt;Price&lt;/th&gt;&lt;th&gt;Category&lt;/th&gt;&lt;th&gt;Supplier&lt;/th&gt;
                    &lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody&gt;
                    {{#each products }}
                        &lt;tr&gt;
                            &lt;td&gt;{{id}}&lt;/td&gt;&lt;td&gt;{{name}}&lt;/td&gt;
                            &lt;td&gt;{{description}}&lt;/td&gt;&lt;td&gt;{{price}}&lt;/td&gt;
                            &lt;td&gt;{{category.name}}&lt;/td&gt;
                            &lt;td&gt;{{supplier.name}}&lt;/td&gt;
                        &lt;/tr&gt;
                    {{/each}}
                &lt;/tbody&gt;
            &lt;/table&gt;
            {{&gt; page_controls }}
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p class="normal">Use a browser to request <code class="inlinecode">http://localhost:5000</code>, enter <code class="inlinecode">pro</code> into the search field and click the <strong class="screentext">Search</strong> button to filter for matches. Click the <strong class="screentext">Soccer</strong> button to further filter<a id="_idIndexMarker934" class="calibre3"/> to one category. Both results are shown in <em class="italic">Figure 17.6</em>.</p>
<figure class="mediaobject"><img alt="" src="img/B21959_17_06.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 17.6: Using the data filtering controls</p>
<h2 class="heading1" id="_idParaDest-302">Updating the product display</h2>
<p class="normal1">The<a id="_idIndexMarker935" class="calibre3"/> final step to complete the catalog is to improve the way that products are displayed to lay the foundation for subsequent features. Create a file named <code class="inlinecode">product.handlebars</code> in the <code class="inlinecode">templates</code> folder with the content shown in <em class="italic">Listing 17.19</em>.</p>
<p class="packt_figref">Listing 17.19: The contents of the product.handlebars file in the templates folder</p>
<pre class="programlisting"><code class="hljs-code">&lt;div class="card card-outline-primary m-1 p-1"&gt;
    &lt;div class="bg-faded p-1"&gt;
        &lt;h4&gt;
            {{ highlight name }}
            &lt;span class="badge rounded-pill bg-primary text-white"
                   style="float:right"&gt;
                &lt;small&gt;{{ currency price }}&lt;/small&gt;
            &lt;/span&gt;
        &lt;/h4&gt;
    &lt;/div&gt;
    &lt;div class="card-text p-1"&gt;{{ highlight description }}&lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p class="normal">This<a id="_idIndexMarker936" class="calibre3"/> template displays a card for a single product, laid out using styles from the Bootstrap CSS package. The template depends on two helpers: the <code class="inlinecode">highlight</code> helper will emphasize the search term, and the <code class="inlinecode">currency</code> helper will format the price, as shown in <em class="italic">Listing 17.20</em>.</p>
<p class="packt_figref">Listing 17.20: Adding helpers in the catalog_helpers.ts file in the src/helpers folder</p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext">import Handlebars, { HelperOptions }  from "handlebars";</strong>
import { stringify } from "querystring";
import { escape } from "querystring";
// ...other helpers omitted for brevity...
<strong class="screentext">export const highlight = (value: string, options: HelperOptions</strong><strong class="screentext">) =&gt; {</strong>
<strong class="screentext">    const { searchTerm } = getData(options);</strong>
<strong class="screentext">    if (searchTerm &amp;&amp; searchTerm !== "") {</strong>
<strong class="screentext">        const regexp = new RegExp(searchTerm, "ig");</strong>
<strong class="screentext">        const mod = value.replaceAll</strong><strong class="screentext">(regexp, "&lt;strong&gt;$&amp;&lt;/strong&gt;");</strong>
<strong class="screentext">        return new Handlebars.SafeString(mod);      </strong>
<strong class="screentext">    }</strong>
<strong class="screentext">    return value;</strong>
<strong class="screentext">}</strong>
<strong class="screentext">const formatter = new Intl.</strong><strong class="screentext">NumberFormat("en-us", {</strong>
<strong class="screentext">    style: "currency", currency: "USD"</strong>
<strong class="screentext">})</strong>
<strong class="screentext">export const currency = (value: number</strong><strong class="screentext">) =&gt; {</strong>
<strong class="screentext">    return formatter.format(value);</strong>
<strong class="screentext">}</strong>
</code></pre>
<p class="normal">The <code class="inlinecode">highlight</code> helper uses JavaScript regular expressions to wrap the search term with <code class="inlinecode">strong</code> elements, which tell the browser to use a bold font. The template engine <a id="_idIndexMarker937" class="calibre3"/>automatically sanitizes the results from helpers, and so the <code class="inlinecode">HandleBars.SafeString</code> function must be used so that the HTML elements generated by the helper are left untouched. The <code class="inlinecode">currency</code> helper formats number values as US dollar amounts, using the built-in internationalization API.</p>
<div><p class="normal"><strong class="screentext">Understanding the impact of lazy localization</strong></p>
<p class="normal">Localizing a product takes time, effort, and resources, and it needs to be done by someone who understands the linguistic, cultural, and monetary conventions of the target country or region. If you don’t localize properly, then the result can be worse than not localizing at all.</p>
<p class="normal">It is for this reason that I don’t describe localization features in detail in this book – or any of my books – and why the currency values in the SportsStore application are hardcoded to <code class="inlinecode">USD</code>. At least if a product isn’t localized, the user knows where they stand and doesn’t have to try to figure out whether you just forgot to change the currency code or whether those prices are really in US dollars. (This is an issue that I see all the time living in the United Kingdom.)</p>
<p class="normal">You should localize your products. Your users should be able to do business or perform other operations in a way that makes sense to them. But you must take it seriously and allocate the time and effort required to do it properly. And if you can’t commit the resources, then the next best thing is to do nothing at all.</p>
</div>
<p class="normal"><em class="italic">Listing 17.21</em> replaces the placeholder table with which we started the chapter with the new template.</p>
<p class="packt_figref">Listing 17.21: Using the product template in the index.handlebars file in the templates folder</p>
<pre class="programlisting"><code class="hljs-code">&lt;div class="container-fluid"&gt;
    &lt;div class="row"&gt;
        &lt;div class="col-2"&gt;
            {{&gt; category_controls }}
        &lt;/div&gt;
        &lt;div class="col"&gt;
            {{&gt; search_controls }}   
            <strong class="screentext">{{#unless products}}&lt;h4&gt;</strong><strong class="screentext">No products&lt;/h4&gt;{{/unless}}</strong>
<strong class="screentext">            {{#each products }}</strong>
<strong class="screentext">                {{&gt; product this }}</strong>
<strong class="screentext">            {{/each}}</strong>
            {{&gt; page_controls }}
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p class="normal">Use a <a id="_idIndexMarker938" class="calibre3"/>browser to request <code class="inlinecode">http://localhost:5000</code> and you will see the new product layout. Perform a search and you will see the matches highlighted in the product list, as shown in <em class="italic">Figure 17.7</em>.</p>
<figure class="mediaobject"><img alt="" src="img/B21959_17_07.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 17.7: Updating the product display</p>
<h1 class="heading" id="_idParaDest-303">Creating the shopping cart</h1>
<p class="normal1">Now <a id="_idIndexMarker939" class="calibre3"/>that the user can see and navigate the products for sale, the next step is to add a cart that allows them to make <a id="_idIndexMarker940" class="calibre3"/>selections before checking out. For the SportsStore application, cart data will be handled using sessions, so that product selections are discarded when the session expires. </p>
<h2 class="heading1" id="_idParaDest-304">Adding configuration support for secrets</h2>
<p class="normal1">The <code class="inlinecode">SportsStore</code> application <a id="_idIndexMarker941" class="calibre3"/>will use cookies to associate requests with a session, and those cookies will be signed to prevent them from being altered. The signing and validation process requires a secret key, known only to the application.</p>
<p class="normal">Secret keys and, more broadly, any secret information, can be difficult to manage. The basic rule is that secrets should not be hard-coded into the application because that makes them impossible to change without releasing a new version of the application into production.</p>
<p class="normal">But, aside<a id="_idIndexMarker942" class="calibre3"/> from not hard-coding, the details of how secrets are managed depend on the application, the development organization, and the production platform. Most cloud hosting platforms, for example, provide a vault for storing secrets. </p>
<p class="normal">The vault is populated with secrets, which the application requests when they are needed, which means that the developers, testers, and operations staff can do their jobs without needing access to the secrets.</p>
<p class="normal">Vaults work well in large organizations where secrets are managed by security staff outside of the development organization, but they can be complicated to use and must be replicated in the development environment.</p>
<p class="normal">Secrets can be stored in a configuration file, along with the rest of the application’s settings. This works, but it does mean that the secrets will be visible to the developers, and it requires that care is taken not to publish the secrets by committing the configuration file to a publicly accessible source code repository or to store private repositories on cloud storage that can be accessed outside the organization.</p>
<p class="normal">Secrets are often defined using environment variables. The idea is that environment variables are not persistent and so cannot be accidentally included in a source code commit. The reality is that setting up environment variables can be fiddly, especially when dealing with secrets that are long sequences of random characters, and so they are often defined using script files, which present the same problems as a regular configuration file.</p>
<p class="normal">Every approach has its drawbacks, and there is no single best solution. My preferred approach is to isolate the provision of secrets from the rest of the application by extending the configuration system. This makes it easy to change the way <a id="_idIndexMarker943" class="calibre3"/>secrets are stored, which can happen as the project evolves. Behind the scenes, I am going to use environment variables to store secrets, but this won’t be apparent to the rest of the application. The easiest and most consistent way to define environment variables is to use an <em class="italic">env file</em>, which is a simple text file containing key/value pairs. To add support for reading env files, run the command shown in <em class="italic">Listing 17.22</em> in the <code class="inlinecode">sportsstore</code> folder to install a new package.</p>
<div><p class="normal"><strong class="screentext">Tip</strong></p>
<p class="normal">Node.js does have built-in support for reading env files (with the <code class="inlinecode">--env-file</code> argument, but the package offers more control over when the files are read and how the contents are processed).</p>
</div>
<p class="packt_figref">Listing 17.22: Installing a package</p>
<pre class="programlisting1"><code class="hljs-con">npm install dotenv@16.4.4
</code></pre>
<p class="normal"><em class="italic">Table 17.1</em> describes this package for quick reference.</p>
<p class="packt_figref">Table 17.1: The env file package</p>
<table class="table-container" id="table001-14">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal">Name</p>
</td>
<td class="table-cell">
<p class="normal">Description</p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1">dotenv</code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal">This package reads <code class="inlinecode">.env</code> files and presents their contents as environment variables. </p>
</td>
</tr>
</tbody>
</table>
<p class="normal">Add a file named <code class="inlinecode">development.env</code> (a period followed by <code class="inlinecode">env</code>) to the <code class="inlinecode">sportstore</code> folder, with the content shown in <em class="italic">Listing 17.23</em>.</p>
<p class="packt_figref">Listing 17.23: The contents of the development.env file in the sportsstore folder</p>
<pre class="programlisting"><code class="hljs-code"># secret used to sign session cookies
COOKIE_SECRET="sportsstoresecret"
</code></pre>
<p class="normal">The env file contains a single entry, named <code class="inlinecode">COOKIE_SECRET</code>. <em class="italic">Listing 17.24</em> uses the <code class="inlinecode">dotenv</code> package<a id="_idIndexMarker944" class="calibre3"/> to read the env file and adds a function for obtaining a secret.</p>
<p class="packt_figref">Listing 17.24: Supporting secrets in the index.ts file in the src/config folder</p>
<pre class="programlisting"><code class="hljs-code">import { readFileSync } from "fs";
import { getEnvironment, Env } from "./environment";
import { merge } from "./merge";
import { config as dotenvconfig } from "dotenv";
const file = process.env.SERVER_CONFIG ?? "server.config.json"
const data = JSON.parse(readFileSync(file).toString());
<strong class="screentext">dotenvconfig({</strong>
<strong class="screentext">    path: getEnvironment().toString() + ".env"</strong>
<strong class="screentext">})</strong>
try {
    const envFile = getEnvironment().toString() + "." + file;
    const envData = JSON.parse(readFileSync(envFile).toString());
    merge(data, envData);
} catch {
    // do nothing - file doesn't exist or isn't readable
}
export const getConfig = (path: string, defaultVal: any = undefined) =&gt; {
    const paths = path.split(":");
    let val = data;
    paths.forEach(p =&gt; val = val[p]);
    return val ?? defaultVal;
}
<strong class="screentext">export const getSecret = (name: string) =&gt; {</strong>
<strong class="screentext">    const secret = process.env[name];</strong>
<strong class="screentext">    if (secret === undefined) {</strong>
<strong class="screentext"> </strong><strong class="screentext">throw new Error(`Undefined secret: ${name}`);</strong>
<strong class="screentext">    }</strong>
<strong class="screentext">    return secret;</strong>
<strong class="screentext">}</strong>
export { getEnvironment, Env };
</code></pre>
<p class="normal">The <code class="inlinecode">config</code> function<a id="_idIndexMarker945" class="calibre3"/> defined by the <code class="inlinecode">dotenv</code> module is imported using the name <code class="inlinecode">dotenvconfig</code> and is used to load an env file. To support env files for different parts of the process, the <code class="inlinecode">getEnvirionment</code> method is used to formulate the name of the file that will be read, so that the <code class="inlinecode">development.env</code> file is read during development and <code class="inlinecode">production.env</code> will be read when the application is deployed. This means that a “real” environment variable is used to decide which file containing additional environment variables is loaded. This can be slightly confusing, but it works well in practice.</p>
<p class="normal">The <code class="inlinecode">getSecret</code> function is exported for use by the rest of the application and allows secrets to be requested without needing to know how they are provisioned. There are no sensible fallback values to use for undefined secrets, so the <code class="inlinecode">getSecret</code> function throws an error if it cannot provide a value.</p>
<h2 class="heading1" id="_idParaDest-305">Creating session middleware</h2>
<p class="normal1">The<a id="_idIndexMarker946" class="calibre3"/> next step is to enable sessions, which will allow product selections to be persisted between HTTP requests. Run the commands shown in <em class="italic">Listing 17.25</em> in the <code class="inlinecode">sportsstore</code> folder to install packages to support sessions. </p>
<p class="packt_figref">Listing 17.25: Installing the session packages</p>
<pre class="programlisting1"><code class="hljs-con">npm install express-session@1.17.3
npm install connect-session-sequelize@7.1.7
npm install --save-dev @types/cookie-parser@1.4.6
npm install --save-dev @types/express-session@1.17.10
</code></pre>
<p class="normal">The packages add support for processing cookies, managing sessions, and storing session data in a SQL database using the Sequelize ORM package. <em class="italic">Table 17.2</em> describes these packages for quick reference.</p>
<p class="packt_figref">Table 17.2: The cookie and session packages</p>
<table class="table-container" id="table002-14">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal">Name</p>
</td>
<td class="table-cell">
<p class="normal">Description</p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1">express-session</code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal">This package adds cookie-based sessions to Express.</p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1">connect-session-sequelize</code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal">This package stores session data using <code class="inlinecode">Sequelize</code>.</p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1">@types/cookie-parser</code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal">This package contains type descriptions.</p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1">@types/express-session</code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal">This package contains type descriptions.</p>
</td>
</tr>
</tbody>
</table>
<p class="normal">To enable <a id="_idIndexMarker947" class="calibre3"/>sessions, add a file named <code class="inlinecode">sessions.ts</code> to the <code class="inlinecode">src</code> folder with the content shown in <em class="italic">Listing 17.26</em>.</p>
<p class="packt_figref">Listing 17.26: The contents of the sessions.ts file in the src folder</p>
<pre class="programlisting"><code class="hljs-code">import { Express } from "express";
import { Sequelize } from "sequelize";
import { getConfig, getSecret } from "./config";
import session from "express-session";
import sessionStore from "connect-session-sequelize";
const config = getConfig("sessions");
const secret = getSecret("COOKIE_SECRET");
const logging = config.orm.logging
        ? { logging: console.log, logQueryParameters: true}
        : { logging: false };
export const createSessions = (app: Express) =&gt; {
    const sequelize = new Sequelize({
        ...config.orm.settings, ...logging
    });
    const store = new (sessionStore(session.Store))({
        db: sequelize
    });
    if (config.reset_db === true) {
        sequelize.drop().then(() =&gt; store.sync());
    } else {
        store.sync();
    }
    app.use(session({
        secret, store,
        resave: true, saveUninitialized: false,
        cookie: { maxAge: config.maxAgeHrs * 60 * 60 * 1000,
            sameSite: "strict" }
    }));
}
</code></pre>
<p class="normal">The <code class="inlinecode">createSessions</code> function reads configuration data and uses it to configure <code class="inlinecode">Sequelize</code> and set<a id="_idIndexMarker948" class="calibre3"/> up session middleware using signed cookies. Add the configuration settings shown in <em class="italic">Listing 17.27</em> to define the values used to specify the database and session age.</p>
<div><p class="normal"><strong class="screentext">Note</strong></p>
<p class="normal">The sessions database is reset every time the application starts. The development tools restart the application when a file change is detected, which means that any code or configuration change will drop all of the stored sessions.</p>
</div>
<p class="packt_figref">Listing 17.27: Adding settings to the server.config.json file in the sportsstore folder</p>
<pre class="programlisting"><code class="hljs-code">{
    "http": {
        "port": 5000
    },
    "templates": {
        // ...settings omitted for brevity...
    },
    "errors": {
        "400": "not_found",
        "500": "error"
    },
    "catalog": {
        // ...settings omitted for brevity...
    },
   <strong class="screentext"> "sessions": {</strong>
<strong class="screentext">        "</strong><strong class="screentext">maxAgeHrs": 2,</strong>
<strong class="screentext">        "reset_db": true,</strong>
<strong class="screentext">        "orm": {</strong>
<strong class="screentext">            "settings": {</strong>
<strong class="screentext">                "dialect": "sqlite",</strong>
<strong class="screentext">                "storage": "sessions.db"</strong>
<strong class="screentext">            },</strong>
<strong class="screentext">            "logging": </strong><strong class="screentext">true</strong>
<strong class="screentext">        }</strong>
<strong class="screentext">    }</strong>
}
</code></pre>
<p class="normal"><em class="italic">Listing 17.28</em> enables<a id="_idIndexMarker949" class="calibre3"/> the session middleware when the application starts.</p>
<p class="packt_figref">Listing 17.28: Enabling middleware in the server.ts file in the sportsstore folder</p>
<pre class="programlisting"><code class="hljs-code">import { createServer } from "http";
import express, { Express } from "express";
import helmet from "helmet";
import { getConfig } from "./config";
import { createRoutes } from "./routes";
import { createTemplates } from "./helpers";
import { createErrorHandlers } from "./errors";
<strong class="screentext">import { createSessions } from "./sessions";</strong>
const port = getConfig("http:port", 5000);
const expressApp: Express = express();
expressApp.use(helmet());
expressApp.use(express.json());
expressApp.use(express.urlencoded({extended: true}))
expressApp.use(express.static("node_modules/bootstrap/dist"));
createTemplates(expressApp);
<strong class="screentext">createSessions(expressApp);</strong>
createRoutes(expressApp);
createErrorHandlers(expressApp);
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</code></pre>
<p class="normal">Enabling<a id="_idIndexMarker950" class="calibre3"/> sessions doesn’t change the way the application behaves but does set the foundation for the shopping cart, which is defined in the next section.</p>
<h2 class="heading1" id="_idParaDest-306">Defining the cart data model</h2>
<p class="normal1">To<a id="_idIndexMarker951" class="calibre3"/> describe a shopping cart, add a file named <code class="inlinecode">cart_models.ts</code> to the <code class="inlinecode">src/data</code> folder with the content shown in <em class="italic">Listing 17.29</em>.</p>
<p class="packt_figref">Listing 17.29: The contents of the cart_models.ts file in the src/data folder</p>
<pre class="programlisting"><code class="hljs-code">export interface CartLine {
    productId: number;
    quantity: number;
}
export interface Cart {
    lines: CartLine[];
}
export const createCart = () : Cart =&gt; ({ lines: [] });
export const addLine = (cart: Cart, productId: number, quantity: number) =&gt; {
    const line = cart.lines.find(l =&gt; l.productId == productId);
    if (line !== undefined) {
        line.quantity += quantity;
    } else {
        cart.lines.push({ productId, quantity })
    }
}
export const removeLine = (cart: Cart, productId: number) =&gt; {
    cart.lines = cart.lines.filter(l =&gt; l.productId !== productId);
}
</code></pre>
<p class="normal">The <code class="inlinecode">Cart</code> interface <a id="_idIndexMarker952" class="calibre3"/>represents a shopping cart, with each product selection represented by a <code class="inlinecode">CartLine</code> object, identifying the selected product and the quantity the customer requires. Cart data will be stored in the session database as JSON data, which is why the <code class="inlinecode">createCart</code>, <code class="inlinecode">addLine</code>, and <code class="inlinecode">removeLine</code> functions are not defined in a class since JSON data is deserialized into a plain JavaScript object.</p>
<h2 class="heading1" id="_idParaDest-307">Extending the catalog repository</h2>
<p class="normal1">A new query<a id="_idIndexMarker953" class="calibre3"/> is required to be able to display a summary of the user’s cart, as shown in <em class="italic">Listing 17.30</em>.</p>
<p class="packt_figref">Listing 17.30: Adding a method to the catalog_repository.ts file in the src/data folder</p>
<pre class="programlisting"><code class="hljs-code">import { Category, Product, Supplier, ProductQueryParameters,
    ProductQueryResult } from "./catalog_models";
export interface CatalogRepository {
    getProducts(params?: ProductQueryParameters): Promise&lt;ProductQueryResult&gt;;
  <strong class="screentext">  getProductDetails(ids: number[]): Promise&lt;Product[]&gt;;</strong>
    storeProduct(p: Product): Promise&lt;Product&gt;;
    getCategories() : Promise&lt;Category[]&gt;;
    storeCategory(c: Category): Promise&lt;Category&gt;;
    getSuppliers(): Promise&lt;Supplier[]&gt;;
    storeSupplier(s: Supplier): Promise&lt;Supplier&gt;;
}
</code></pre>
<p class="normal">The <code class="inlinecode">CartLine</code> objects that represent a selection contain just a product ID and a quantity. The <code class="inlinecode">getProductDetails</code> method accepts an array of IDs and returns the corresponding <code class="inlinecode"><a id="_idIndexMarker954" class="calibre3"/></code><code class="inlinecode">Product</code> objects from the catalog. <em class="italic">Listing 17.31</em> implements the new repository method using Sequelize.</p>
<p class="packt_figref">Listing 17.31: Implementing a method in the queries.ts file in the src/data/orm folder</p>
<pre class="programlisting"><code class="hljs-code">import { CategoryModel, ProductModel, SupplierModel } from "./models";
import { BaseRepo, Constructor } from "./core"
import { ProductQueryParameters } from "../catalog_models";
import { Op } from "sequelize";
export function AddQueries&lt;TBase extends Constructor&lt;BaseRepo&gt;&gt;(Base: TBase) {
    return class extends Base {
   
        // ...methods omitted for brevity...
   
        getSuppliers() {
            return SupplierModel.findAll({raw: true, nest: true});
        }       
       <strong class="screentext"> getProductDetails(ids: number[]) {</strong>
<strong class="screentext">            return ProductModel.findAll</strong><strong class="screentext">({</strong>
<strong class="screentext">                where: { id: { [Op.in]: ids }}, raw: true, nest: true,</strong>
<strong class="screentext">            });</strong>
<strong class="screentext">        }</strong>
    }
}
</code></pre>
<p class="normal">The implementation of the <code class="inlinecode">getProductDetails</code> method uses the Sequelize <code class="inlinecode">in</code> operation to select products whose <code class="inlinecode">id</code> property is contained in the array received as the method parameter. The result is a <code class="inlinecode">Promise</code> that resolves to produce an array of <code class="inlinecode">ProductModel</code> objects.</p>
<p class="normal">I kept the <code class="inlinecode">Cart</code> type <a id="_idIndexMarker955" class="calibre3"/>simple because that’s the data that will be stored in the session, which will be read for most of the requests received from the user because the responses will contain a summary of the cart (which is created in the <em class="italic">Creating the cart summary</em> section). To fully populate the cart with product details, which will be required to show the cart to the user, add a file named <code class="inlinecode">cart_helpers.ts</code> to the <code class="inlinecode">src/data</code> folder with the content shown in <em class="italic">Listing 17.32</em>.</p>
<p class="packt_figref">Listing 17.32: The contents of the cart_helpers.ts file in the src/data folder</p>
<pre class="programlisting"><code class="hljs-code">import { catalog_repository } from ".";
import { Cart } from "./cart_models";
import { Product } from "./catalog_models"
export interface CartDetail {
    lines: {
        product: Product,
        quantity: number,
        subtotal: number
    }[],
    total: number;
}
export const getCartDetail = async (cart: Cart) : Promise&lt;CartDetail&gt; =&gt; {
    const ids = cart.lines.map(l =&gt; l.productId);
    const db_data = await catalog_repository.getProductDetails(ids);
    const products = Object.fromEntries(db_data.map(p =&gt; [p.id, p]));
    const lines = cart.lines.map(line =&gt; ({
        product: products[line.productId],
        quantity: line.quantity,
        subtotal: products[line.productId].price * line.quantity
    }));
    const total = lines.reduce((total, line) =&gt; total + line.subtotal, 0);
    return { lines, total }
}
</code></pre>
<p class="normal">The <code class="inlinecode">getCartDetail</code> function accepts a <code class="inlinecode">Cart</code> object and returns a <code class="inlinecode">CartDetail</code>, which contains all the <a id="_idIndexMarker956" class="calibre3"/>additional information required to provide a detailed view of the cart, including subtotals for each product selection, and an overall total.</p>
<div><p class="normal"><strong class="screentext">Note</strong></p>
<p class="normal">Some of the operations required to gather the detailed data are asynchronous, which means they cannot be performed by a template helper, which must be synchronous.</p>
</div>
<h2 class="heading1" id="_idParaDest-308">Creating the HTTP routes and middleware</h2>
<p class="normal1">The next step is to<a id="_idIndexMarker957" class="calibre3"/> define the routes and handlers for the HTTP requests so that products can be added and removed from a cart, and the contents of a cart can be displayed. Add a file named <code class="inlinecode">cart.ts</code> to the <code class="inlinecode">src/routes</code> folder, with the content shown in <em class="italic">Listing 17.33</em>.</p>
<p class="packt_figref">Listing 17.33: The contents of the cart.ts file in the src/routes folder</p>
<pre class="programlisting"><code class="hljs-code">import { Express } from "express";
import { escape, unescape } from "querystring";
import { Cart, addLine, createCart, removeLine } from "../data/cart_models";
import * as cart_helpers from "../data/cart_helpers";
declare module "express-session" {
    interface SessionData {
       cart?: Cart;
    }
}
export const createCartMiddleware = (app: Express) =&gt; {
    app.use((req, resp, next) =&gt; {
        resp.locals.cart = req.session.cart = req.session.cart ?? createCart()
        next();
    })
}
export const createCartRoutes = (app: Express) =&gt; {
   
    app.post("/cart", (req, resp) =&gt; {
        const productId = Number.parseInt(req.body.productId);
        if (isNaN(productId)) {
            throw new Error("ID  must be an integer");
        }
        addLine(req.session.cart as Cart, productId, 1);
        resp.redirect(`/cart?returnUrl=${escape(req.body.returnUrl ?? "/")}`);
    });
    app.get("/cart", async (req, resp) =&gt; {
        const cart = req.session.cart as Cart;
        resp.render("cart", {
            cart: await cart_helpers.getCartDetail(cart),
            returnUrl: unescape(req.query.returnUrl?.toString() ?? "/")
        });
    });
    app.post("/cart/remove", (req, resp) =&gt; {
        const id = Number.parseInt(req.body.id);
        if (!isNaN(id)) {
            removeLine(req.session.cart as Cart, id);
        }
        resp.redirect(`/cart?returnUrl=${escape(req.body.returnUrl ?? "/")}`);
    });
}
</code></pre>
<p class="normal">The <code class="inlinecode">declare</code> statement is used to define a <code class="inlinecode">cart</code> property on the <code class="inlinecode">SessionData</code> interface so that the TypeScript compiler will understand that the cart is part of the session data.</p>
<p class="normal">The <code class="inlinecode">createCartMiddleware</code> function creates a middleware component that gets the cart<a id="_idIndexMarker958" class="calibre3"/> from the session, creates a cart if there isn’t one, and sets the cart as local data for use by the template engine. The <code class="inlinecode">createCartRoutes</code> function defines three routes. <code class="inlinecode">HTTP</code> <code class="inlinecode">POST</code> requests sent to the <code class="inlinecode">/cart</code> URL will add a product to the user’s cart, and a <code class="inlinecode">POST</code> request to the <code class="inlinecode">/cart/remove</code> URL will remove a product. </p>
<p class="normal">(Most browsers allow HTML forms to send only <code class="inlinecode">GET</code> and <code class="inlinecode">POST</code> requests, which is why both adding and removing products are done with <code class="inlinecode">POST</code> requests). Requests to these handlers can include a <code class="inlinecode">returnUrl</code> value, to which the browser is redirected after the cart has been modified. The value is processed using the <code class="inlinecode">encode</code> and <code class="inlinecode">decode</code> functions provided by Node.js in the <code class="inlinecode">querystring</code> module, which allows the value to be passed around safely until it is needed to perform a redirection.</p>
<p class="normal">The third route handles <code class="inlinecode">GET</code> requests sent to the <code class="inlinecode">/cart</code> URL and displays the contents of the cart. The data contained in the <code class="inlinecode">Cart</code> object has to be supplemented with data obtained using the <code class="inlinecode">getProductDetails</code> repository method. <em class="italic">Listing 17.34</em> enables the new middleware and routes.</p>
<p class="packt_figref">Listing 17.34: Enabling routes in the index.ts file in the src/routes folder</p>
<pre class="programlisting"><code class="hljs-code">import { Express } from "express";
import { createCatalogRoutes } from "./catalog";
import { createCartMiddleware, createCartRoutes } from "./cart";
export const createRoutes = (app: Express) =&gt; {
<strong class="screentext">    createCartMiddleware(app);</strong>
    createCatalogRoutes(app);
   <strong class="screentext"> createCartRoutes(app);</strong>
}
</code></pre>
<p class="normal">These routes are enabled after those that handle the requests for the catalog and the middleware is configured before all of the routes.</p>
<h2 class="heading1" id="_idParaDest-309">Creating the templates</h2>
<p class="normal1">The cart<a id="_idIndexMarker959" class="calibre3"/> display will be a table that shows the selected products and buttons that allow items to be removed from the cart. To define a template for the table rows, add a file named <code class="inlinecode">cart_line.handlebars</code> to the <code class="inlinecode">templates</code> folder with the content shown in <em class="italic">Listing 17.35</em>.</p>
<p class="packt_figref">Listing 17.35: The contents of the cart_line.handlebars file in the templates folder</p>
<pre class="programlisting"><code class="hljs-code">&lt;tr&gt;
    &lt;td class="text-end"&gt;{{ quantity }} &lt;/td&gt;   
    &lt;td class="text-left"&gt;{{ product.name }}&lt;/td&gt;
    &lt;td class="text-end"&gt;{{ currency product.price }}&lt;/td&gt;
    &lt;td class="text-end"&gt;{{ currency subtotal }}&lt;/td&gt;
    &lt;td class="text-center"&gt;
        &lt;form method="post" action="/cart/remove"&gt;
            &lt;input type="hidden" name="id" value="{{ product.id }}"&gt;
            &lt;input type="hidden" name="returnUrl" value="{{ returnUrl }}"&gt;
            &lt;button type="submit" class="btn btn-sm btn-danger"&gt;
                Remove
            &lt;/button&gt;
        &lt;/form&gt;
    &lt;/td&gt;
&lt;/tr&gt;
</code></pre>
<p class="normal">This template defines table cells that contain details for a single product: the quantity chosen, the product name, the price per unit, and the subtotal. The price and subtotal are formatted using the <code class="inlinecode">currency</code> helper. The final table cell contains an HTML form that presents a <strong class="screentext">Remove</strong> button that sends an HTTP POST request to the <code class="inlinecode">/cart/remove</code> URL, which will remove a product from the cart. To define the template for the overall table, add a file named <code class="inlinecode">cart.handlebars</code> to the <code class="inlinecode">templates</code> folder with the content shown in <em class="italic">Listing 17.36</em>.</p>
<p class="packt_figref">Listing 17.36: The contents of the cart.handlebars file in the templates folder</p>
<pre class="programlisting"><code class="hljs-code">&lt;h2&gt;Your cart&lt;/h2&gt;
&lt;table class="table table-bordered table-striped"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th class="text-end"&gt;Quantity&lt;/th&gt;&lt;th&gt;Item&lt;/th&gt;
            &lt;th class="text-end"&gt;Price&lt;/th&gt;&lt;th class="text-end"&gt;Subtotal&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        {{#unless cart.lines}}
            &lt;tr&gt;&lt;td colspan="5" class="text-center"&gt;Cart is empty&lt;/td&gt;&lt;/tr&gt;
        {{/unless}}
        {{#each cart.lines}}
            {{&gt; cart_line returnUrl=../returnUrl }}       
        {{/each }}
    &lt;/tbody&gt;
    &lt;tfoot&gt;
        &lt;tr&gt;
            &lt;td colspan="3" class="text-end"&gt;Total:&lt;/td&gt;
            &lt;td class="text-end"&gt;{{ currency cart.total }}&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/tfoot&gt;
&lt;/table&gt;
&lt;div class="text-center"&gt;
    &lt;a class="btn btn-primary" href="{{ returnUrl }}"&gt;Continue Shopping&lt;/a&gt;
    {{#if cart.lines}}
        &lt;a class="btn btn-primary" href="/checkout"&gt;Checkout&lt;/a&gt;
    {{else}}
        &lt;button class="btn btn-primary" disabled&gt;Checkout&lt;/button&gt;
    {{/if}}
&lt;/div&gt;
</code></pre>
<p class="normal">A useful feature <a id="_idIndexMarker960" class="calibre3"/>provided by the Handlebars template engine is providing partials with parameters. In this case, the <code class="inlinecode">cart_line</code> partial is provided with a <code class="inlinecode">returnUrl</code> parameter:</p>
<pre class="programlisting"><code class="hljs-code">...
{{#each cart.lines}}
    {{&gt; cart_line <strong class="screentext">returnUrl</strong>=../returnUrl }}       
{{/each }}    
...
</code></pre>
<p class="normal">This parameter can be referred to by name and is combined with the data that would normally be available to the partial. The <code class="inlinecode">each</code> helper changes the context used to resolve template expressions, which makes it easy to generate content for each item<a id="_idIndexMarker961" class="calibre3"/> in a sequence, and within the <code class="inlinecode">each</code> block, expressions are evaluated against the current item. The <code class="inlinecode">../</code> prefix allows a template expression to access the original context from which the <code class="inlinecode">each</code> helper is obtaining its values, and is used to provide the partial template with the value for the <code class="inlinecode">returnUrl</code> parameter.</p>
<p class="normal">The final step is to add a button to the product template so the user can select a product, as shown in <em class="italic">Listing 17.37</em>.</p>
<p class="packt_figref">Listing 17.37: Adding product selection in the product.handlebars file in the templates folder</p>
<pre class="programlisting"><code class="hljs-code">&lt;div class="card card-outline-primary m-1 p-1"&gt;
    &lt;div class="bg-faded p-1"&gt;
        &lt;h4&gt;
            {{ highlight name }}
            &lt;span class="badge rounded-pill bg-primary text-white"
                   style="float:right"&gt;
                &lt;small&gt;{{ currency price }}&lt;/small&gt;
            &lt;/span&gt;
        &lt;/h4&gt;
    &lt;/div&gt;
    &lt;div class="card-text p-1"&gt;
        <strong class="screentext">&lt;span class="float-start"&gt;{{ highlight description }}&lt;/span&gt;</strong>
<strong class="screentext">        &lt;</strong><strong class="screentext">form method="post" action="/cart"&gt;</strong>
<strong class="screentext">            &lt;input type="hidden" name="</strong><strong class="screentext">returnUrl" value="{{navigationUrl}}"&gt;</strong>
<strong class="screentext">            &lt;input type="hidden" name="productId" value="</strong><strong class="screentext">{{id}}"&gt;</strong>
<strong class="screentext">            &lt;button type="submit" class="btn btn-sm btn-success float-end"&gt;</strong>
<strong class="screentext">                Add To Cart</strong>
<strong class="screentext">            &lt;/button&gt;</strong>
<strong class="screentext">        &lt;/</strong><strong class="screentext">form&gt;</strong>
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p class="normal">Use a <a id="_idIndexMarker962" class="calibre3"/>browser to request <code class="inlinecode">http://localhost:5000</code> and click the <strong class="screentext">Add To Cart</strong> button for one of the products. The product will be added to the cart, and the cart details will be displayed, as shown in <em class="italic">Figure 17.8</em>. Clicking the <strong class="screentext">Remove</strong> button will remove the product from the cart and clicking the <strong class="screentext">Continue Shopping</strong> button will return to the catalog. (Clicking the <strong class="screentext">Checkout</strong> button will produce an error until the checkout process is implemented.)</p>
<figure class="mediaobject"><img alt="" src="img/B21959_17_08.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 17.8: Using the cart</p>
<h1 class="heading" id="_idParaDest-310">Creating the cart summary</h1>
<p class="normal1">To finish <a id="_idIndexMarker963" class="calibre3"/>this chapter, I am going to add a summary of the cart to the catalog page, so the user can see how many products they have selected and easily navigate to the cart details. Run the command shown in <em class="italic">Listing 17.38</em> in the <code class="inlinecode">sportsstore</code> folder to add a package to the project that will be used by the cart summary. </p>
<p class="packt_figref">Listing 17.38: Adding a package</p>
<pre class="programlisting1"><code class="hljs-con">npm install bootstrap-icons@1.11.3
</code></pre>
<p class="normal">The Bootstrap Icons package is a set of icons that can be easily used in HTML content. <em class="italic">Table 17.3</em> describes this package for quick reference.</p>
<p class="packt_figref">Table 17.3: The Bootstrap Icons package</p>
<table class="table-container" id="table003-14">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal">Name</p>
</td>
<td class="table-cell">
<p class="normal">Description</p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1">bootstrap-icons</code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal">This package contains a library of icons that can be applied to HTML content.</p>
</td>
</tr>
</tbody>
</table>
<p class="normal">The cart summary will display the total number of products in the cart, which will require a template helper. Add a file named <code class="inlinecode">cart_helpers.ts</code> to the <code class="inlinecode">src/helpers</code> folder with the content shown in <em class="italic">Listing 17.39</em>.</p>
<p class="packt_figref">Listing 17.39: The contents of the cart_helpers.ts file in the src/helpers folder</p>
<pre class="programlisting"><code class="hljs-code">import { Cart } from "../data/cart_models";
export const countCartItems = (cart: Cart) : number =&gt;
    cart.lines.reduce((total, line) =&gt; total + line.quantity, 0);
</code></pre>
<p class="normal"><em class="italic">Listing 17.40</em> adds the new helper to the template engine configuration.</p>
<p class="packt_figref">Listing 17.40: Adding helpers to the index.ts file in the src/helpers folder</p>
<pre class="programlisting"><code class="hljs-code">import { Express } from "express";
import { getConfig } from "../config";
import { engine } from "express-handlebars";
import * as env_helpers from "./env";
import * as catalog_helpers from "./catalog_helpers";
<strong class="screentext">import</strong><strong class="screentext"> * as cart_helpers from "./cart_helpers";</strong>
const location = getConfig("templates:location");
const config = getConfig("templates:config");
export const createTemplates = (app: Express) =&gt; {
    app.set("views", location);
    app.engine("handlebars", engine({
        ...config,
        <strong class="screentext">helpers</strong><strong class="screentext">: {...env_helpers, ...catalog_helpers, ...cart_helpers}</strong>
    }));
    app.set("view engine", "handlebars");
}
</code></pre>
<p class="normal">Add a file named <code class="inlinecode">cart_summary.handlebars</code> to the <code class="inlinecode">templates</code> folder, with the content shown in <em class="italic">Listing 17.41</em>.</p>
<p class="packt_figref">Listing 17.41: The contents of the cart_summary.handlebars file in the templates folder</p>
<pre class="programlisting"><code class="hljs-code">{{#if cart.lines}}
    &lt;small class="navbar-text"&gt;{{ countCartItems cart }} item(s)&lt;/small&gt;
{{else}}
    &lt;small class="navbar-text"&gt;(Empty)&lt;/small&gt;
{{/if}}
&lt;a class="btn btn-sm btn-secondary navbar-btn" 
    href="/cart?returnUrl={{ escapeUrl ( navigationUrl ) }}"&gt;
    &lt;i class="bi-cart"&gt;&lt;/i&gt;
&lt;/a&gt;
</code></pre>
<p class="normal">The new <a id="_idIndexMarker964" class="calibre3"/>template displays a small message that indicates the contents of the cart, along with a button that allows navigation to see the contents of the cart. The button is an anchor element whose content is an <code class="inlinecode">i</code> element, which is how icons from the Bootstrap Icons package are displayed:</p>
<pre class="programlisting"><code class="hljs-code">...
&lt;a class="btn btn-sm btn-secondary navbar-btn"  href="/cart{{returnUrl}}"&gt;
   <strong class="screentext"> &lt;i class="bi-cart"&gt;&lt;/i&gt;</strong>
&lt;/a&gt;
...
</code></pre>
<p class="normal">This element displays the cart icon, and you can look up the class required for each icon at <a href="https://icons.getbootstrap.com" class="calibre3">https://icons.getbootstrap.com</a>. <em class="italic">Listing 17.42</em> integrates the new partial template into the main layout.</p>
<p class="packt_figref">Listing 17.42: Adding the summary to the main_layout.handlebars file in the templates folder</p>
<pre class="programlisting"><code class="hljs-code">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;link href="/css/bootstrap.min.css" rel="stylesheet" /&gt;
        <strong class="screentext">&lt;link href="/font/bootstrap-icons.min.css" rel="stylesheet"&gt;</strong>
    &lt;/head&gt;
    &lt;body&gt;
        <strong class="screentext">&lt;div class="bg-dark text-white py-2 px-1"&gt;</strong>
<strong class="screentext">    &lt;div class="container-fluid"</strong><strong class="screentext">&gt;</strong>
<strong class="screentext">                &lt;div class="row"&gt;</strong>
<strong class="screentext">                    &lt;div class="col align-baseline pt-1"&gt;SPORTS STORE&lt;/div</strong><strong class="screentext">&gt;</strong>
<strong class="screentext">                    &lt;div class="col-auto text-end"&gt;</strong>
<strong class="screentext">                        {{#if show_cart}}</strong>
<strong class="screentext">                            {{&gt; cart_summary }}</strong>
<strong class="screentext">                        {{/if}}</strong>
<strong class="screentext">                    &lt;/div&gt;</strong>
<strong class="screentext">                &lt;/div&gt;</strong>
<strong class="screentext">            &lt;/div</strong><strong class="screentext">&gt;</strong>
<strong class="screentext">        &lt;/div&gt;</strong>
        {{{ body }}}
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p class="normal">The<a id="_idIndexMarker965" class="calibre3"/> cart summary will only be shown when there is a <code class="inlinecode">show_cart</code> value, which will allow route handlers to opt into displaying the cart summary in the header, such as in <em class="italic">Listing 17.43</em>.</p>
<p class="packt_figref">Listing 17.43: Enabling the cart summary in the catalog.ts file in the src/routes folder</p>
<pre class="programlisting"><code class="hljs-code">import { Express } from "express";
import { catalog_repository } from "../data";
export const createCatalogRoutes = (app: Express) =&gt; {
    app.get("/", async (req, resp) =&gt; {
        const page = Number.parseInt(req.query.page?.toString() ?? "1");
        const pageSize =Number.parseInt(req.query.pageSize?.toString() ?? "3")
        const searchTerm = req.query.searchTerm?.toString();
        const category = Number.parseInt(req.query.category?.toString() ?? "")
        const res = await catalog_repository.getProducts({ page, pageSize,
            searchTerm, category});
        resp.render("index", { ...res, page, pageSize,
            pageCount: Math.ceil(res.totalCount / (pageSize ?? 1)),
            searchTerm, category, show_cart: true
        });
    });
}
</code></pre>
<p class="normal">The <a id="_idIndexMarker966" class="calibre3"/>changes in <em class="italic">Listing 17.42</em> include a <code class="inlinecode">link</code> element for the CSS stylesheet that contains the icons. <em class="italic">Listing 17.44</em> uses the Express <code class="inlinecode">static</code> middleware to provide access to the contents of this package.</p>
<p class="packt_figref">Listing 17.44: Adding static content to the server.ts file in the src folder</p>
<pre class="programlisting"><code class="hljs-code">import { createServer } from "http";
import express, { Express } from "express";
import helmet from "helmet";
import { getConfig } from "./config";
import { createRoutes } from "./routes";
import { createTemplates } from "./helpers";
import { createErrorHandlers } from "./errors";
import { createSessions } from "./sessions";
const port = getConfig("http:port", 5000);
const expressApp: Express = express();
expressApp.use(helmet());
expressApp.use(express.json());
expressApp.use(express.urlencoded({extended: true}))
expressApp.use(express.static("node_modules/bootstrap/dist"));
<strong class="screentext">expressApp.use(express.static("node_modules/bootstrap-icons"));</strong>
createTemplates(expressApp);
createSessions(expressApp);
createRoutes(expressApp);
createErrorHandlers(expressApp);
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</code></pre>
<p class="normal">Use a <a id="_idIndexMarker967" class="calibre3"/>browser to request <code class="inlinecode">http://localhost:5000</code> and you will see the cart summary, which will reflect any earlier product selections. As the contents of the cart change, the summary will be updated to show the number of products that have been chosen, as shown in <em class="italic">Figure 17.9</em>.</p>
<figure class="mediaobject"><img alt="" src="img/B21959_17_09.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 17.9: Displaying a cart summary</p>
<h1 class="heading" id="_idParaDest-311">Summary</h1>
<p class="normal1">In this chapter, I continued working on the <code class="inlinecode">SportsStore</code> project to complete the product catalog and add a shopping cart:</p>
<ul class="calibre4">
<li class="bulletlist">Requests for products can include query string parameters that paginate data, specify page size, and filter the product data.</li>
<li class="bulletlist1">The query string values are preserved in the URLs contained in the HTML responses so that the user has a consistent experience.</li>
<li class="bulletlist1">The shopping cart uses sessions to store product selections. The session data is stored in a database and sessions are identified using HTTP cookies.</li>
<li class="bulletlist1">The session cookies are signed to prevent tampering, and the signing secret is stored in an env file, which is read by the configuration system.</li>
<li class="bulletlist1">A summary of the shopping cart is displayed as part of the catalog, styled using an icon package.</li>
</ul>
<p class="normal">I will continue working on <code class="inlinecode">SportsStore</code> in the next chapter, adding support for accepting and validating orders.</p>
</div>
</body></html>