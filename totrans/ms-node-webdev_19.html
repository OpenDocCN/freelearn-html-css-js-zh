<html><head></head><body>
<div class="calibre1" id="_idContainer240">
<h1 class="chapternumber"><span class="kobospan" id="kobo.1.1">17</span></h1>
<h1 class="chaptertitle" id="_idParaDest-294"><span class="kobospan" id="kobo.2.1">SportsStore: Navigation and Cart</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.3.1">In this chapter, we will continue to build the SportsStore application by completing the catalog and adding a cart with which the user can make product selections.</span></p>
<h1 class="heading" id="_idParaDest-295"><span class="kobospan" id="kobo.4.1">Preparing for this chapter</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.5.1">This chapter uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.6.1">sportsstore</span></code><span class="kobospan" id="kobo.7.1"> project created in </span><em class="italic"><span class="kobospan" id="kobo.8.1">Chapter 16</span></em><span class="kobospan" id="kobo.9.1">. </span><span class="kobospan" id="kobo.9.2">No changes are required for this chapter. </span><span class="kobospan" id="kobo.9.3">Open a new command prompt, navigate to the </span><code class="inlinecode"><span class="kobospan" id="kobo.10.1">sportsstore</span></code><span class="kobospan" id="kobo.11.1"> folder, and run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.12.1">Listing 17.1</span></em><span class="kobospan" id="kobo.13.1"> to start the development tools.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.14.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.15.1">You can download the example project for this chapter – and for all the other chapters in this book – from </span><a href="https://github.com/PacktPublishing/Mastering-Node.js-Web-Development" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.16.1">https://github.com/PacktPublishing/Mastering-Node.js-Web-Development</span></span></a><span class="kobospan" id="kobo.17.1">. </span><span class="kobospan" id="kobo.17.2">See </span><em class="italic"><span class="kobospan" id="kobo.18.1">Chapter 1</span></em><span class="kobospan" id="kobo.19.1"> to get help if you have problems running the examples.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.20.1">Listing 17.1: Starting the development fools</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.21.1">npm start
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.22.1">Open a new browser window, navigate to </span><code class="inlinecode"><span class="kobospan" id="kobo.23.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.24.1">, and you will see the data read from the database presented in a simple table format, as shown in </span><em class="italic"><span class="kobospan" id="kobo.25.1">Figure 17.1</span></em><span class="kobospan" id="kobo.26.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.27.1"><img alt="" src="../Images/B21959_17_01.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.28.1">Figure 17.1: Running the application</span></p>
<h1 class="heading" id="_idParaDest-296"><span class="kobospan" id="kobo.29.1">Navigating the catalog</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.30.1">Real online stores have </span><a id="_idIndexMarker909" class="calibre3"/><span class="kobospan" id="kobo.31.1">too many</span><a id="_idIndexMarker910" class="calibre3"/><span class="kobospan" id="kobo.32.1"> products to sensibly display them all to the user at the same time and typically provide tools to help the user find and select what they want. </span><span class="kobospan" id="kobo.32.2">In the sections that follow, I will add features to SportsStore that will allow the user to navigate through the catalog by choosing the data that is displayed.</span><span> </span></p>
<h2 class="heading1" id="_idParaDest-297"><span class="kobospan" id="kobo.33.1">Paginating catalog data</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.34.1">Pagination</span><a id="_idIndexMarker911" class="calibre3"/><span class="kobospan" id="kobo.35.1"> presents the user with manageable blocks of data, along with controls to move from one page to the next. </span><span class="kobospan" id="kobo.35.2">The pagination controls give the user a sense of how much data is available, and individual pages require the server to send smaller amounts of data in each response, which can reduce the amount of time the user has to wait for data to be displayed. </span><span class="kobospan" id="kobo.35.3">The drawback of pagination is that it requires the server to handle a lot of HTTP requests and make a lot of database queries as the user navigates through the data.</span></p>
<p class="normal"><span class="kobospan" id="kobo.36.1">When processing a request for a page of data, the server needs to know how many items are displayed on a page, and which page the user wants to get the right data. </span><span class="kobospan" id="kobo.36.2">To generate pagination controls, the server also needs to know how many items there are in total. </span><em class="italic"><span class="kobospan" id="kobo.37.1">Listing 17.2</span></em><span class="kobospan" id="kobo.38.1"> defines new types that describe the query details and the response. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.39.1">Listing 17.2: Adding pagination types in the catalog_models.ts file in the src/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.40.1">export interface  Product {
    id?: number;
    name: string;
    description: string;
    price: number;
   
    category?: Category;
    supplier?: Supplier;
}
export interface Category {
    id?: number;
    name: string;
    products?: Product[];
}
export interface Supplier {
    id?: number;
    name: string;
   
    products?: Product[];
}
</span><strong class="screentext"><span class="kobospan" id="kobo.41.1">export interface ProductQueryParameters {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.42.1">    pageSize?: number;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.43.1">    page?: number;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.44.1">}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.45.1">export interface ProductQueryResult {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.46.1">    products: Product[];</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.47.1">    totalCount: number;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.48.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.49.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.50.1">ProductQueryParameters</span></code><span class="kobospan" id="kobo.51.1"> interface allows the pagination requirements associated </span><a id="_idIndexMarker912" class="calibre3"/><span class="kobospan" id="kobo.52.1">with a query to be provided to the repository. </span><span class="kobospan" id="kobo.52.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.53.1">ProductQueryResult</span></code><span class="kobospan" id="kobo.54.1"> interface describes the response the repository will produce, which contains the page of data and the total number of stored items. </span><span class="kobospan" id="kobo.54.2">These types will be expanded as other data navigation features are added. </span><em class="italic"><span class="kobospan" id="kobo.55.1">Listing 17.3</span></em><span class="kobospan" id="kobo.56.1"> revises the product query method in the repository interface to support the new types.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.57.1">Listing 17.3: Changing a method in the catalog_repository.ts file in the src/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext"><span class="kobospan" id="kobo.58.1">import</span></strong><strong class="screentext"><span class="kobospan" id="kobo.59.1"> { Category, Product, Supplier, ProductQueryParameters,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.60.1">    ProductQueryResult } from "./catalog_models";</span></strong><span class="kobospan" id="kobo.61.1">
export interface CatalogRepository {
    </span><strong class="screentext"><span class="kobospan" id="kobo.62.1">getProducts(params?: ProductQueryParameters): Promise&lt;ProductQueryResult&gt;;</span></strong><span class="kobospan" id="kobo.63.1">
    storeProduct(p: Product): Promise&lt;Product&gt;;
    getCategories() : Promise&lt;Category[]&gt;;
    storeCategory(c: Category): Promise&lt;Category&gt;;
    getSuppliers(): Promise&lt;Supplier[]&gt;;
    storeSupplier(s: Supplier): Promise&lt;Supplier&gt;;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.64.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.65.1">getProducts</span></code><span class="kobospan" id="kobo.66.1"> method now accepts an optional </span><code class="inlinecode"><span class="kobospan" id="kobo.67.1">ProductQueryParameters</span></code><span class="kobospan" id="kobo.68.1"> parameter</span><a id="_idIndexMarker913" class="calibre3"/><span class="kobospan" id="kobo.69.1"> and returns a </span><code class="inlinecode"><span class="kobospan" id="kobo.70.1">ProductQueryResult</span></code><span class="kobospan" id="kobo.71.1"> result. </span><em class="italic"><span class="kobospan" id="kobo.72.1">Listing 17.4</span></em><span class="kobospan" id="kobo.73.1"> updates the implementation of the repository to reflect the change in the interface.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.74.1">Listing 17.4: Using new types in the queries.ts file in the src/data/orm folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.75.1">import { CategoryModel, ProductModel, SupplierModel } from "./models";
import { BaseRepo, Constructor } from "./core"
</span><strong class="screentext"><span class="kobospan" id="kobo.76.1">import { ProductQueryParameters } from "../catalog_models";</span></strong><span class="kobospan" id="kobo.77.1">
export function AddQueries&lt;TBase extends Constructor&lt;BaseRepo&gt;&gt;(Base: TBase) {
    return class extends Base {
   
       </span><strong class="screentext"><span class="kobospan" id="kobo.78.1"> async</span></strong><strong class="screentext"><span class="kobospan" id="kobo.79.1"> getProducts(params?: ProductQueryParameters) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.80.1">            const opts: any = {};</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.81.1">            if (params?.page &amp;&amp; params.pageSize) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.82.1">                opts.limit = params?.pageSize,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.83.1">                opts.offset</span></strong><strong class="screentext"><span class="kobospan" id="kobo.84.1"> = (params.page -1) * params.pageSize               </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.85.1">            }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.86.1">            const result = await ProductModel.findAndCountAll({               </span></strong><span class="kobospan" id="kobo.87.1">
                include: [
                    {model: SupplierModel, as: "supplier" },
                    {model: CategoryModel, as: "category"}],
                raw: true, nest: true,
                ..</span><strong class="screentext"><span class="kobospan" id="kobo.88.1">.opts</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.89.1">            });              </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.90.1">            return { products: result.rows, totalCount: result.count };</span></strong><span class="kobospan" id="kobo.91.1">
        }
        getCategories() {
            return CategoryModel.findAll({raw: true, nest: true})
        }
   
        getSuppliers() {
            return SupplierModel.findAll({raw: true, nest: true});
        }       
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.92.1">If a </span><code class="inlinecode"><span class="kobospan" id="kobo.93.1">ProductQueryParameters</span></code><span class="kobospan" id="kobo.94.1"> parameter is received by the </span><code class="inlinecode"><span class="kobospan" id="kobo.95.1">getProducts</span></code><span class="kobospan" id="kobo.96.1"> method, then the Sequelize query is configured with the </span><code class="inlinecode"><span class="kobospan" id="kobo.97.1">limit</span></code><span class="kobospan" id="kobo.98.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.99.1">offset</span></code><span class="kobospan" id="kobo.100.1"> properties, which specify the maximum number of results that should be read from the database, and the number of results that should be skipped before starting to read the results. </span><span class="kobospan" id="kobo.100.2">This combination of properties will read a specified page of data.</span></p>
<p class="normal"><span class="kobospan" id="kobo.101.1">The </span><a id="_idIndexMarker914" class="calibre3"/><span class="kobospan" id="kobo.102.1">query is performed using the </span><code class="inlinecode"><span class="kobospan" id="kobo.103.1">findAndCountAll</span></code><span class="kobospan" id="kobo.104.1"> method, which finds data and includes the total number of items in the database that match the query, regardless of how many of those items are included in the results. </span><span class="kobospan" id="kobo.104.2">The combination of the data returned by the query and the total number of matching items is used to create the </span><code class="inlinecode"><span class="kobospan" id="kobo.105.1">ProductQueryParameters</span></code><span class="kobospan" id="kobo.106.1"> result. </span><em class="italic"><span class="kobospan" id="kobo.107.1">Listing 17.5</span></em><span class="kobospan" id="kobo.108.1"> updates the HTTP handler so that pagination details are read from the query string and included in the call to the repository. </span><span class="kobospan" id="kobo.108.2">If the query string doesn’t include pagination information, then defaults are used to select page 1 with four items per page.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.109.1">Listing 17.5: Using page data in the catalog.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.110.1">import { Express } from "express";
import { catalog_repository } from "../data";
export const createCatalogRoutes = (app: Express) =&gt; {
    app.get("/", async (req, resp) =&gt; {
        const page = Number.parseInt(req.query.page?.toString() ?? </span><span class="kobospan" id="kobo.110.2">"1");
       </span><strong class="screentext"><span class="kobospan" id="kobo.111.1"> const pageSize =Number.parseInt(req.query.pageSize?.toString() ?? </span><span class="kobospan" id="kobo.111.2">"3");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.112.1">        const res = await catalog_repository.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.113.1">getProducts({ page, pageSize});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.114.1">        resp.render("index", { ...res, page, pageSize,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.115.1">            pageCount: Math.ceil(res.totalCount / (pageSize ?? </span><span class="kobospan" id="kobo.115.2">1))});</span></strong><span class="kobospan" id="kobo.116.1">
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.117.1">You can</span><a id="_idIndexMarker915" class="calibre3"/><span class="kobospan" id="kobo.118.1"> check that data is being paged by using a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.119.1">http://localhost:5000/?pageSize=3&amp;page=2</span></code><span class="kobospan" id="kobo.120.1">. </span><span class="kobospan" id="kobo.120.2">The URL specifies a page size of three items and asks for page 2, producing the result shown in </span><em class="italic"><span class="kobospan" id="kobo.121.1">Figure 17.2</span></em><span class="kobospan" id="kobo.122.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.123.1"><img alt="" src="../Images/B21959_17_02.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.124.1">Figure 17.2: Displaying a page of data</span></p>
<h3 class="heading2" id="_idParaDest-298"><span class="kobospan" id="kobo.125.1">Adding pagination controls</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.126.1">Now</span><a id="_idIndexMarker916" class="calibre3"/><span class="kobospan" id="kobo.127.1"> that the data can be paged, the next step is to provide the user with the ability to select the page they want. </span><span class="kobospan" id="kobo.127.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.128.1">page_controls.handlebars</span></code><span class="kobospan" id="kobo.129.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.130.1">templates</span></code><span class="kobospan" id="kobo.131.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.132.1">Listing 17.6</span></em><span class="kobospan" id="kobo.133.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.134.1">Listing 17.6: The contents of the page_controls.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.135.1">&lt;div class="col"&gt;
    {{#pageButtons }}
        {{#if selected}}
            &lt;button class="btn btn-sm btn-light active mr-1 p-2"&gt;
                {{index}}
            &lt;/button&gt;
        {{else}}
        &lt;a class="btn btn-sm btn-light mr-1 p-2"
            href="{{navigationUrl page=index }}"&gt;{{index}}&lt;/a&gt;
        {{/if}}
    {{/pageButtons}}
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.136.1">This </span><a id="_idIndexMarker917" class="calibre3"/><span class="kobospan" id="kobo.137.1">template relies on two helpers, which will be defined shortly. </span><span class="kobospan" id="kobo.137.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.138.1">pageButtons</span></code><span class="kobospan" id="kobo.139.1"> helper will repeatedly generate a section of content for each page of content, using the pagination data provided to the template:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.140.1">...
</span><span class="kobospan" id="kobo.140.2">{{#pageButtons }}
   // ...template content omitted for brevity...
</span><span class="kobospan" id="kobo.140.3">{{/pageButtons}}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.141.1">The content contained between the helper tags will be duplicated for each available page of data. </span><span class="kobospan" id="kobo.141.2">Each block of content is provided with an </span><code class="inlinecode"><span class="kobospan" id="kobo.142.1">index</span></code><span class="kobospan" id="kobo.143.1"> value that indicates the page for which a control is being generated and a </span><code class="inlinecode"><span class="kobospan" id="kobo.144.1">selected</span></code><span class="kobospan" id="kobo.145.1"> value that indicates whether the current page is the one the user is viewing. </span><span class="kobospan" id="kobo.145.2">When the selected value is </span><code class="inlinecode"><span class="kobospan" id="kobo.146.1">true</span></code><span class="kobospan" id="kobo.147.1">, a button that does nothing is displayed, formatted in an active state to indicate the current page. </span><span class="kobospan" id="kobo.147.2">For the other pages, an anchor element (with the </span><code class="inlinecode"><span class="kobospan" id="kobo.148.1">a</span></code><span class="kobospan" id="kobo.149.1"> tag) is displayed, formatted as an inactive button. </span><span class="kobospan" id="kobo.149.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.150.1">href</span></code><span class="kobospan" id="kobo.151.1"> attribute of the anchor element is defined using a helper named </span><code class="inlinecode"><span class="kobospan" id="kobo.152.1">navigationUrl</span></code><span class="kobospan" id="kobo.153.1"> that generates a URL that will navigate to the selected page. </span><span class="kobospan" id="kobo.153.2">To define template helpers for the catalog, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.154.1">catalog_helpers.ts</span></code><span class="kobospan" id="kobo.155.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.156.1">src/helpers</span></code><span class="kobospan" id="kobo.157.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.158.1">Listing 17.7</span></em><span class="kobospan" id="kobo.159.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.160.1">Listing 17.7: The contents of the catalog_helpers.ts file in the src/helpers folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.161.1">import { HelperOptions }  from "handlebars";
import { stringify } from "querystring";
import { escape } from "querystring";
const getData = (options:HelperOptions) =&gt; {
     return {...options.data.root, ...options.hash}
};
export const navigationUrl = (options: HelperOptions) =&gt; {
    const { page, pageSize } = getData(options);
    return "/?" </span><span class="kobospan" id="kobo.161.2">+ stringify({ page, pageSize });
}
export const escapeUrl = (url: string) =&gt; escape(url);
export const pageButtons = (options: HelperOptions) =&gt; {
    const { page, pageCount } = getData(options);
    let output = "";
    for (let i = 1; i &lt;= pageCount; i++) {
        output += options.fn({
            page, pageCount, index: i, selected: i === page
        });
    }
    return output;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.162.1">Helper</span><a id="_idIndexMarker918" class="calibre3"/><span class="kobospan" id="kobo.163.1"> functions receive a </span><code class="inlinecode"><span class="kobospan" id="kobo.164.1">HelperOptions</span></code><span class="kobospan" id="kobo.165.1"> parameter that provides useful context features. </span><span class="kobospan" id="kobo.165.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.166.1">HelperOptions.hash</span></code><span class="kobospan" id="kobo.167.1"> property is used to receive data in name/value pairs and is a useful way to provide structured data to a helper, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.168.1">...
</span><span class="kobospan" id="kobo.168.2">href="{{navigationUrl page=index }}"&gt;{{index}}&lt;/a&gt;
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.169.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.170.1">HelperOptions.data</span></code><span class="kobospan" id="kobo.171.1"> property provides access to context data, and its </span><code class="inlinecode"><span class="kobospan" id="kobo.172.1">root</span></code><span class="kobospan" id="kobo.173.1"> property contains the data from the template that invoked the helper. </span><span class="kobospan" id="kobo.173.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.174.1">getData</span></code><span class="kobospan" id="kobo.175.1"> method merges the values from the hash data with the root data.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.176.1">Caution</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.177.1">The Handlebars package is excellent but not all of the features provided by the </span><code class="inlinecode"><span class="kobospan" id="kobo.178.1">HelperOptions</span></code><span class="kobospan" id="kobo.179.1"> interface are documented, including the use of the </span><code class="inlinecode"><span class="kobospan" id="kobo.180.1">data.root</span></code><span class="kobospan" id="kobo.181.1"> property. </span><span class="kobospan" id="kobo.181.2">Future versions of the package may change the way this property is defined, so you must either take care to use the version specified in </span><em class="italic"><span class="kobospan" id="kobo.182.1">Chapter 16</span></em><span class="kobospan" id="kobo.183.1"> or check the documentation and source code to see what’s changed.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.184.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.185.1">navigationUrl</span></code><span class="kobospan" id="kobo.186.1"> helper function accepts a </span><code class="inlinecode"><span class="kobospan" id="kobo.187.1">HelperOptions</span></code><span class="kobospan" id="kobo.188.1"> argument and uses it to generate</span><a id="_idIndexMarker919" class="calibre3"/><span class="kobospan" id="kobo.189.1"> a relative URL path that will select a specific page, which is done using the </span><code class="inlinecode"><span class="kobospan" id="kobo.190.1">stringify</span></code><span class="kobospan" id="kobo.191.1"> function from the </span><code class="inlinecode"><span class="kobospan" id="kobo.192.1">querystring</span></code><span class="kobospan" id="kobo.193.1"> module that Node.js provides for creating and parsing query strings:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.194.1">...
</span><span class="kobospan" id="kobo.194.2">return "/?" </span><span class="kobospan" id="kobo.194.3">+ </span><strong class="screentext"><span class="kobospan" id="kobo.195.1">stringify</span></strong><span class="kobospan" id="kobo.196.1">({ page, pageSize });
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.197.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.198.1">pageButtons</span></code><span class="kobospan" id="kobo.199.1"> function is more complex because it needs to generate blocks of content, which is done using the function assigned to the </span><code class="inlinecode"><span class="kobospan" id="kobo.200.1">HelperOptions.fn</span></code><span class="kobospan" id="kobo.201.1"> property, which generates content using the elements contained between the helper tags. </span><span class="kobospan" id="kobo.201.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.202.1">escapeUrl</span></code><span class="kobospan" id="kobo.203.1"> helper encodes a value so that it can be included in a query string.</span></p>
<p class="normal"><span class="kobospan" id="kobo.204.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.205.1">pageButtons</span></code><span class="kobospan" id="kobo.206.1"> helper uses a </span><code class="inlinecode"><span class="kobospan" id="kobo.207.1">for</span></code><span class="kobospan" id="kobo.208.1"> loop and the </span><code class="inlinecode"><span class="kobospan" id="kobo.209.1">fn</span></code><span class="kobospan" id="kobo.210.1"> function to create content for each data page, supplementing the shared pagination data with </span><code class="inlinecode"><span class="kobospan" id="kobo.211.1">index</span></code><span class="kobospan" id="kobo.212.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.213.1">selected</span></code><span class="kobospan" id="kobo.214.1"> values that are specific to each page. </span><em class="italic"><span class="kobospan" id="kobo.215.1">Listing 17.8</span></em><span class="kobospan" id="kobo.216.1"> adds the new helpers to the template engine configuration.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.217.1">Listing 17.8: Adding helpers to the index.ts file in the src/helpers folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.218.1">import { Express } from "express";
import { getConfig } from "../config";
import { engine } from "express-handlebars";
import * as env_helpers from "./env";
</span><strong class="screentext"><span class="kobospan" id="kobo.219.1">import</span></strong><strong class="screentext"><span class="kobospan" id="kobo.220.1"> * as catalog_helpers from "./catalog_helpers";</span></strong><span class="kobospan" id="kobo.221.1">
const location = getConfig("templates:location");
const config = getConfig("templates:config");
export const createTemplates = (app: Express) =&gt; {
    app.set("views", location);
    app.engine("handlebars", engine({
        ...</span><strong class="screentext"><span class="kobospan" id="kobo.222.1">config, helpers</span></strong><strong class="screentext"><span class="kobospan" id="kobo.223.1">: {...env_helpers, ...catalog_helpers}</span></strong><span class="kobospan" id="kobo.224.1">
    }));
    app.set("view engine", "handlebars");
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.225.1">The </span><a id="_idIndexMarker920" class="calibre3"/><span class="kobospan" id="kobo.226.1">final step is to include the partial template defined in </span><em class="italic"><span class="kobospan" id="kobo.227.1">Listing 17.7</span></em><span class="kobospan" id="kobo.228.1"> into the content generated by the application, as shown in </span><em class="italic"><span class="kobospan" id="kobo.229.1">Listing 17.9</span></em><span class="kobospan" id="kobo.230.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.231.1">Listing 17.9: Using the pagination partial view in the index.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.232.1">&lt;table class="table table-sm table-striped"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Description&lt;/th&gt;
            &lt;th&gt;Price&lt;/th&gt;&lt;th&gt;Category&lt;/th&gt;&lt;th&gt;Supplier&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        {{#each products }}
            &lt;tr&gt;
                &lt;td&gt;{{id}}&lt;/td&gt;&lt;td&gt;{{name}}&lt;/td&gt;
                &lt;td&gt;{{description}}&lt;/td&gt;&lt;td&gt;{{price}}&lt;/td&gt;
                &lt;td&gt;{{category.name}}&lt;/td&gt;&lt;td&gt;{{supplier.name}}&lt;/td&gt;
            &lt;/tr&gt;
        {{/each}}
    &lt;/tbody&gt;
&lt;/table&gt;
</span><strong class="screentext"><span class="kobospan" id="kobo.233.1">{{&gt; page_controls }}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.234.1">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.235.1">http://localhost:5000/?pageSize=3</span></code><span class="kobospan" id="kobo.236.1">. </span><span class="kobospan" id="kobo.236.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.237.1">pageSize</span></code><span class="kobospan" id="kobo.238.1"> value specifies three data items to a page, and omitting the </span><code class="inlinecode"><span class="kobospan" id="kobo.239.1">page</span></code><span class="kobospan" id="kobo.240.1"> value from the query string will default to the first page of data, as shown in </span><em class="italic"><span class="kobospan" id="kobo.241.1">Figure 17.3</span></em><span class="kobospan" id="kobo.242.1">. </span><span class="kobospan" id="kobo.242.2">A button will be displayed </span><a id="_idIndexMarker921" class="calibre3"/><span class="kobospan" id="kobo.243.1">for each available page, and clicking an inactive button will select a different page.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.244.1"><img alt="" src="../Images/B21959_17_03.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.245.1">Figure 17.3: Paging through data</span></p>
<h3 class="heading2" id="_idParaDest-299"><span class="kobospan" id="kobo.246.1">Changing the page size</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.247.1">To allow</span><a id="_idIndexMarker922" class="calibre3"/><span class="kobospan" id="kobo.248.1"> the user to change the number of items per page, </span><em class="italic"><span class="kobospan" id="kobo.249.1">Listing 17.10</span></em><span class="kobospan" id="kobo.250.1"> creates a grid that contains the existing page buttons, plus a </span><strong class="screentext"><span class="kobospan" id="kobo.251.1">select</span></strong><span class="kobospan" id="kobo.252.1"> button that is populated with different page sizes. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.253.1">Listing 17.10: Adding a select button to the page_controls.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext"><span class="kobospan" id="kobo.254.1">&lt;div</span></strong><strong class="screentext"><span class="kobospan" id="kobo.255.1"> class="container-fluid"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.256.1">    &lt;div class="row"&gt;</span></strong><span class="kobospan" id="kobo.257.1">
        &lt;div class="col"&gt;
            {{#pageButtons }}
                {{#if selected}}
                    &lt;button class="btn btn-sm btn-light active mr-1 p-2"&gt;
                        {{index}}
                    &lt;/button&gt;
                {{else}}
                &lt;a class="btn btn-sm btn-light mr-1 p-2"
                    href="{{navigationUrl page=index }}"&gt;{{index}}&lt;/a&gt;
                {{/if}}
            {{/pageButtons}}
        &lt;/div&gt;
        &lt;div class="col-auto text-end"&gt;        
        </span><strong class="screentext"><span class="kobospan" id="kobo.258.1">    &lt;form id="pageSizeForm" method="get"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.259.1">                &lt;select class="form-select"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.260.1"> name="pageSize"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.261.1">                    {{#pageSizeOptions }}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.262.1">                        &lt;option value="{{size}}" {{selected}}&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.263.1">                            {{size}} per page</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.264.1">                        &lt;/option&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.265.1">                    {{/pageSizeOptions }}</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.266.1">&lt;/select&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.267.1">            &lt;/form&gt;      </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.268.1">        &lt;/div&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.269.1">        &lt;div class="col-auto"&gt;</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.270.1">&lt;button class="btn btn-light mr-2" type="submit"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.271.1">                form="pageSizeForm"&gt;Go&lt;/button&gt;</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.272.1">&lt;/div&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.273.1">    &lt;/div&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.274.1">&lt;/div&gt;</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.275.1">The</span><a id="_idIndexMarker923" class="calibre3"/><span class="kobospan" id="kobo.276.1"> form is submitted by a </span><code class="inlinecode"><span class="kobospan" id="kobo.277.1">button</span></code><span class="kobospan" id="kobo.278.1"> element, which is configured with the </span><code class="inlinecode"><span class="kobospan" id="kobo.279.1">form</span></code><span class="kobospan" id="kobo.280.1"> attribute, allowing it to be positioned in the grid without needing to be a descendant of the </span><code class="inlinecode"><span class="kobospan" id="kobo.281.1">form</span></code><span class="kobospan" id="kobo.282.1"> element. </span><span class="kobospan" id="kobo.282.2">The option elements are created by a template helper named </span><code class="inlinecode"><span class="kobospan" id="kobo.283.1">pageSizeOptions</span></code><span class="kobospan" id="kobo.284.1">, which is defined in </span><em class="italic"><span class="kobospan" id="kobo.285.1">Listing 17.11</span></em><span class="kobospan" id="kobo.286.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.287.1">Listing 17.11: Defining a helper in the catalog_helpers.ts file in the src/helpers folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.288.1">import { HelperOptions }  from "handlebars";
import { stringify } from "querystring";
import { escape } from "querystring";
// ...other helpers omitted for brevity...
</span><strong class="screentext"><span class="kobospan" id="kobo.289.1">export const pageSizeOptions = (options: HelperOptions) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.290.1">    const { pageSize } = getData(options);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.291.1">    let output = ""</span></strong><strong class="screentext"><span class="kobospan" id="kobo.292.1">;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.293.1">    [3, 6, 9].forEach(size =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.294.1">        output += options.fn({ size,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.295.1">            selected: pageSize === size ? </span><span class="kobospan" id="kobo.295.2">"selected": ""})</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.296.1">    })</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.297.1">return output;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.298.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.299.1">The</span><a id="_idIndexMarker924" class="calibre3"/><span class="kobospan" id="kobo.300.1"> helper generates options that allow the user to choose </span><strong class="screentext"><span class="kobospan" id="kobo.301.1">3</span></strong><span class="kobospan" id="kobo.302.1">, </span><strong class="screentext"><span class="kobospan" id="kobo.303.1">6</span></strong><span class="kobospan" id="kobo.304.1">, or </span><strong class="screentext"><span class="kobospan" id="kobo.305.1">9</span></strong><span class="kobospan" id="kobo.306.1"> items per page, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.307.1">selected</span></code><span class="kobospan" id="kobo.308.1"> attribute is applied to the </span><code class="inlinecode"><span class="kobospan" id="kobo.309.1">option</span></code><span class="kobospan" id="kobo.310.1"> element that matches the current page size. </span><span class="kobospan" id="kobo.310.2">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.311.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.312.1">, select </span><strong class="screentext"><span class="kobospan" id="kobo.313.1">6 per page</span></strong><span class="kobospan" id="kobo.314.1"> from the select options, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.315.1">Go</span></strong><span class="kobospan" id="kobo.316.1"> button. </span><span class="kobospan" id="kobo.316.2">The form will submit a GET request that specifies the new page size, as shown in </span><em class="italic"><span class="kobospan" id="kobo.317.1">Figure 17.4</span></em><span class="kobospan" id="kobo.318.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.319.1"><img alt="" src="../Images/B21959_17_04.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.320.1">Figure 17.4: Changing the page size</span></p>
<h2 class="heading1" id="_idParaDest-300"><span class="kobospan" id="kobo.321.1">Filtering catalog data</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.322.1">The </span><a id="_idIndexMarker925" class="calibre3"/><span class="kobospan" id="kobo.323.1">next navigation feature will allow the user to filter the catalog by selecting a category or providing a search term. </span><em class="italic"><span class="kobospan" id="kobo.324.1">Listing 17.12</span></em><span class="kobospan" id="kobo.325.1"> adds new properties to the </span><code class="inlinecode"><span class="kobospan" id="kobo.326.1">ProductQueryParameters</span></code><span class="kobospan" id="kobo.327.1"> interface to support filtering, and adds a </span><code class="inlinecode"><span class="kobospan" id="kobo.328.1">categories</span></code><span class="kobospan" id="kobo.329.1"> property to the </span><code class="inlinecode"><span class="kobospan" id="kobo.330.1">ProductQueryResult</span></code><span class="kobospan" id="kobo.331.1"> interface so that the user can be presented with a list of categories.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.332.1">Listing 17.12: Adding support for filtering to the catalog_models.ts file in the src/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.333.1">...
</span><span class="kobospan" id="kobo.333.2">export interface ProductQueryParameters {
    pageSize?: number;
    page?: number;
  </span><strong class="screentext"><span class="kobospan" id="kobo.334.1">  category?: number;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.335.1">    searchTerm?: string;</span></strong><span class="kobospan" id="kobo.336.1">
}
export interface ProductQueryResult {
    products: Product[];
    totalCount: number;
  </span><strong class="screentext"><span class="kobospan" id="kobo.337.1">  categories: Category[];</span></strong><span class="kobospan" id="kobo.338.1">
}
...
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.339.1">Listing 17.13</span></em><span class="kobospan" id="kobo.340.1"> uses the new properties to query the database, filtering the data based on the search term and selected category.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.341.1">Listing 17.13: Filtering data in the queries.ts file in the src/data/orm folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.342.1">import { CategoryModel, ProductModel, SupplierModel } from "./models";
import { BaseRepo, Constructor } from "./core"
import { ProductQueryParameters } from "../catalog_models";
</span><strong class="screentext"><span class="kobospan" id="kobo.343.1">import { Op } from "sequelize";</span></strong><span class="kobospan" id="kobo.344.1">
export function AddQueries&lt;TBase extends Constructor&lt;BaseRepo&gt;&gt;(Base: TBase) {
    return class extends Base {
   
        async getProducts(params?: ProductQueryParameters) {
            const opts: any = {};
            if (params?.page &amp;&amp; params.pageSize) {
                opts.limit = params?.pageSize,
                opts.offset = (params.page -1) * params.pageSize               
            }
            </span><strong class="screentext"><span class="kobospan" id="kobo.345.1">if(params?.searchTerm) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.346.1">      const</span></strong><strong class="screentext"><span class="kobospan" id="kobo.347.1"> searchOp = { [Op.like]: "%" + params.searchTerm + "%"};</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.348.1">                opts.where = {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.349.1">                    [Op.or]: { name: searchOp, description</span></strong><strong class="screentext"><span class="kobospan" id="kobo.350.1">: searchOp }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.351.1">                }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.352.1">            }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.353.1">            if (params?.category) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.354.1">                opts.where = {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.355.1">                    ...opts.where,  categoryId: params.category</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.356.1">                }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.357.1">            }</span></strong><span class="kobospan" id="kobo.358.1">
            const result = await ProductModel.findAndCountAll({               
                include: [
                    {model: SupplierModel, as: "supplier" },
                    {model: CategoryModel, as: "category"}],
                raw: true, nest: true,
                ...opts
            });              
          </span><strong class="screentext"><span class="kobospan" id="kobo.359.1">  const categories = await this.getCategories();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.360.1">            return { products: result.rows</span></strong><strong class="screentext"><span class="kobospan" id="kobo.361.1">, totalCount: result.count, categories };</span></strong><span class="kobospan" id="kobo.362.1">
        }
        getCategories() {
            return CategoryModel.findAll({raw: true, nest: true})
        }
   
        getSuppliers() {
            return SupplierModel.findAll({raw: true, nest: true});
        }       
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.363.1">The</span><a id="_idIndexMarker926" class="calibre3"/><span class="kobospan" id="kobo.364.1"> changes in </span><em class="italic"><span class="kobospan" id="kobo.365.1">Listing 17.13</span></em><span class="kobospan" id="kobo.366.1"> inspect the </span><code class="inlinecode"><span class="kobospan" id="kobo.367.1">ProductQueryParameters</span></code><span class="kobospan" id="kobo.368.1"> object and introduce a </span><code class="inlinecode"><span class="kobospan" id="kobo.369.1">where</span></code><span class="kobospan" id="kobo.370.1"> clause to restrict the database query. </span><span class="kobospan" id="kobo.370.2">Filtering for a category is done by requiring a specific </span><code class="inlinecode"><span class="kobospan" id="kobo.371.1">categoryId</span></code><span class="kobospan" id="kobo.372.1"> value. </span><span class="kobospan" id="kobo.372.2">Searches are more complex. </span><span class="kobospan" id="kobo.372.3">Some database servers have support for performing full-text searches on data, but this isn’t supported by Sequelize, which is why the </span><code class="inlinecode"><span class="kobospan" id="kobo.373.1">like </span></code><span class="kobospan" id="kobo.374.1">operation is used. </span><span class="kobospan" id="kobo.374.2">When the user provides a search term, the </span><code class="inlinecode"><span class="kobospan" id="kobo.375.1">where</span></code><span class="kobospan" id="kobo.376.1"> clause is used to match data using either the </span><a id="_idIndexMarker927" class="calibre3"/><span class="kobospan" id="kobo.377.1">name or description values. </span><span class="kobospan" id="kobo.377.2">Like most ORMs, Sequelize concentrates on features that are widely and consistently supported, which means that not every capability of a database server is available. </span><span class="kobospan" id="kobo.377.3">That said, you can execute raw SQL queries to access any feature, as demonstrated in </span><em class="italic"><span class="kobospan" id="kobo.378.1">Chapter 12</span></em><span class="kobospan" id="kobo.379.1">.</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.380.1">Listing 17.14</span></em><span class="kobospan" id="kobo.381.1"> updates the HTTP request handler so that the category and search term are read from the query string passed on to the repository and included in the data passed to the template engine.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.382.1">Listing 17.14: Supporting filtering in the catalog.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.383.1">import { Express } from "express";
import { catalog_repository } from "../data";
export const createCatalogRoutes = (app: Express) =&gt; {
    app.get("/", async (req, resp) =&gt; {
        const page = Number.parseInt(req.query.page?.toString() ?? </span><span class="kobospan" id="kobo.383.2">"1");
        const pageSize =Number.parseInt(req.query.pageSize?.toString() ?? </span><span class="kobospan" id="kobo.383.3">"3")
       </span><strong class="screentext"><span class="kobospan" id="kobo.384.1"> const searchTerm = req.query.searchTerm?.toString();</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.385.1">const category = Number.parseInt(req.query.category?.toString() ?? </span><span class="kobospan" id="kobo.385.2">"")</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.386.1">        const res = await catalog_repository.getProducts({ page, pageSize,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.387.1">            searchTerm, category});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.388.1">        resp.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.389.1">render("index", { ...res, page, pageSize,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.390.1">            pageCount: Math.ceil(res.totalCount / (pageSize ?? </span><span class="kobospan" id="kobo.390.2">1)),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.391.1">            searchTerm, category</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.392.1">        });</span></strong><span class="kobospan" id="kobo.393.1">
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.394.1">To confirm that the filtering features work, use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.395.1">http://localhost:5000/?searchTerm=pro</span></code><span class="kobospan" id="kobo.396.1">, which should filter the data to products whose name or description contains the term </span><code class="inlinecode"><span class="kobospan" id="kobo.397.1">pro</span></code><span class="kobospan" id="kobo.398.1">. </span><span class="kobospan" id="kobo.398.2">To include a category filter, request </span><code class="inlinecode"><span class="kobospan" id="kobo.399.1">http://localhost:5000/?searchTerm=pro&amp;category=2</span></code><span class="kobospan" id="kobo.400.1">, which will further restrict</span><a id="_idIndexMarker928" class="calibre3"/><span class="kobospan" id="kobo.401.1"> the data to products in the </span><code class="inlinecode"><span class="kobospan" id="kobo.402.1">Soccer</span></code><span class="kobospan" id="kobo.403.1"> category. </span><span class="kobospan" id="kobo.403.2">Both sets of results are shown in </span><em class="italic"><span class="kobospan" id="kobo.404.1">Figure 17.5</span></em><span class="kobospan" id="kobo.405.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.406.1"><img alt="" src="../Images/B21959_17_05.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.407.1">Figure 17.5: Filtering data using the query string parameters</span></p>
<h3 class="heading2" id="_idParaDest-301"><span class="kobospan" id="kobo.408.1">Adding filtering controls</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.409.1">Providing </span><a id="_idIndexMarker929" class="calibre3"/><span class="kobospan" id="kobo.410.1">the user with the controls for filtering means presenting a list of category buttons and an input element for entering a search term. </span><span class="kobospan" id="kobo.410.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.411.1">category_controls.handlebars</span></code><span class="kobospan" id="kobo.412.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.413.1">templates</span></code><span class="kobospan" id="kobo.414.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.415.1">Listing 17.15</span></em><span class="kobospan" id="kobo.416.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.417.1">Listing 17.15: The contents of the category_controls.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.418.1">&lt;div class="d-grid gap-2 py-2"&gt;
    &lt;a class="btn btn-outline-secondary"
        href="{{navigationUrl category="" page=1 searchTerm="" }}"&gt;
            Home
    &lt;/a&gt;
    {{#categoryButtons  }}
        {{#if selected }}
            &lt;a class="btn btn-secondary"&gt;{{ name }}&lt;/a&gt;
        {{else }}
            &lt;a class="btn btn-outline-secondary"
                href="{{navigationUrl category=id page=1}}"&gt;
                {{ name }}
            &lt;/a&gt;
        {{/if }}
    {{/categoryButtons }}
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.419.1">This</span><a id="_idIndexMarker930" class="calibre3"/><span class="kobospan" id="kobo.420.1"> template relies on a helper named </span><code class="inlinecode"><span class="kobospan" id="kobo.421.1">categoryButtons</span></code><span class="kobospan" id="kobo.422.1"> to generate buttons for category navigation. </span><span class="kobospan" id="kobo.422.2">The helper will provide a </span><code class="inlinecode"><span class="kobospan" id="kobo.423.1">selected</span></code><span class="kobospan" id="kobo.424.1"> value, which is used to decide whether to generate an inactive placeholder (for the selected category) or an anchor element that will select a category, using an </span><code class="inlinecode"><span class="kobospan" id="kobo.425.1">href</span></code><span class="kobospan" id="kobo.426.1"> attribute created by the </span><code class="inlinecode"><span class="kobospan" id="kobo.427.1">navigationUrl</span></code><span class="kobospan" id="kobo.428.1">. </span><span class="kobospan" id="kobo.428.2">There is also a </span><code class="inlinecode"><span class="kobospan" id="kobo.429.1">Home</span></code><span class="kobospan" id="kobo.430.1"> button that is always present, and which selects all categories.</span></p>
<p class="normal"><span class="kobospan" id="kobo.431.1">When generating the URLs for the </span><code class="inlinecode"><span class="kobospan" id="kobo.432.1">href</span></code><span class="kobospan" id="kobo.433.1"> attribute, this template sets navigation values other than </span><code class="inlinecode"><span class="kobospan" id="kobo.434.1">category</span></code><span class="kobospan" id="kobo.435.1"> to ensure the user is presented with useful content. </span><span class="kobospan" id="kobo.435.2">For the </span><code class="inlinecode"><span class="kobospan" id="kobo.436.1">Home</span></code><span class="kobospan" id="kobo.437.1"> button, this means clearing the </span><code class="inlinecode"><span class="kobospan" id="kobo.438.1">searchTerm</span></code><span class="kobospan" id="kobo.439.1"> value and selecting the first page of content:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.440.1">...
</span><span class="kobospan" id="kobo.440.2">&lt;a class="btn btn-outline-secondary"
    href="{{navigationUrl category="" page=1 searchTerm="" }}"&gt;
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.441.1">Setting these values gives the user a reset option, leaving only the </span><code class="inlinecode"><span class="kobospan" id="kobo.442.1">pageSize</span></code><span class="kobospan" id="kobo.443.1"> option unchanged. </span><span class="kobospan" id="kobo.443.2">For the buttons that select a category, the </span><code class="inlinecode"><span class="kobospan" id="kobo.444.1">page</span></code><span class="kobospan" id="kobo.445.1"> value is reset:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.446.1">...
</span><span class="kobospan" id="kobo.446.2">&lt;a class="btn btn-outline-secondary"
    href="{{navigationUrl category=id page=1}}"&gt;
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.447.1">This ensures that the user is always presented with products when moving from a category with many products to one with fewer and prevents presenting an empty </span><a id="_idIndexMarker931" class="calibre3"/><span class="kobospan" id="kobo.448.1">page. </span><em class="italic"><span class="kobospan" id="kobo.449.1">Listing 17.16</span></em><span class="kobospan" id="kobo.450.1"> defines the </span><code class="inlinecode"><span class="kobospan" id="kobo.451.1">categoryButtons</span></code><span class="kobospan" id="kobo.452.1"> helper and updates the </span><code class="inlinecode"><span class="kobospan" id="kobo.453.1">navigationUrl</span></code><span class="kobospan" id="kobo.454.1"> helper so that it includes the category and search term selections in the URLs it creates.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.455.1">Listing 17.16: Supporting filtering in the catalog_helpers.ts file in the src/helpers folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.456.1">import { HelperOptions }  from "handlebars";
import { stringify } from "querystring";
import { escape } from "querystring";
const getData = (options:HelperOptions) =&gt; {
     return {...options.data.root, ...options.hash}
};
export const navigationUrl = (options: HelperOptions) =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.457.1">const { page, pageSize, category, searchTerm } = getData(options);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.458.1">    return "/?" </span><span class="kobospan" id="kobo.458.2">+ stringify({ page, pageSize, category, searchTerm  });</span></strong><span class="kobospan" id="kobo.459.1">
}
export const escapeUrl = (url: string) =&gt; escape(url);
export const pageButtons = (options: HelperOptions) =&gt; {
    const { page, pageCount } = getData(options);
    let output = "";
    for (let i = 1; i &lt;= pageCount; i++) {
        output += options.fn({
            page, pageCount, index: i, selected: i === page
        });
    }
    return output;
}
export const pageSizeOptions = (options: HelperOptions) =&gt; {
    const { pageSize } = getData(options);
    let output = "";
    [3, 6, 9].forEach(size =&gt; {
        output += options.fn({ size,
            selected: pageSize === size ? </span><span class="kobospan" id="kobo.459.2">"selected": ""})
    })
    return output;
}
</span><strong class="screentext"><span class="kobospan" id="kobo.460.1">export const categoryButtons = (options: HelperOptions) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.461.1">    const { category, categories } = getData</span></strong><strong class="screentext"><span class="kobospan" id="kobo.462.1">(options);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.463.1">    let output = "";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.464.1">    for (let i = 0; i &lt; categories.length; i++) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.465.1">        output += options.fn({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.466.1">            id: categories[i].id</span></strong><strong class="screentext"><span class="kobospan" id="kobo.467.1">,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.468.1">            name: categories[i].name,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.469.1">            selected: category === categories[i].id</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.470.1">        })</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.471.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.472.1">    return output;</span></strong><span class="kobospan" id="kobo.473.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.474.1">To add </span><a id="_idIndexMarker932" class="calibre3"/><span class="kobospan" id="kobo.475.1">support for entering a search term, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.476.1">search_controls.handlebars</span></code><span class="kobospan" id="kobo.477.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.478.1">templates</span></code><span class="kobospan" id="kobo.479.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.480.1">Listing 17.17</span></em><span class="kobospan" id="kobo.481.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.482.1">Listing 17.17: The contents of the search_controls.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.483.1">&lt;form class="row row-cols my-2" method="get"&gt;
    &lt;div class="col"&gt;
        &lt;input type="hidden" name="pageSize" value="{{pageSize}}"&gt;
        &lt;input type="hidden" name="category" value="{{category}}"&gt;
        &lt;input class="form-control" name="searchTerm"
            placeholder="Product Search" value="{{searchTerm}}"&gt;
    &lt;/div&gt;
    &lt;div class="col-auto"&gt;
        &lt;button class="btn btn-small btn-secondary" type="submit"&gt;
            Search
        &lt;/button&gt;
    &lt;/div&gt;
&lt;/form&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.484.1">This template contains a form with an </span><code class="inlinecode"><span class="kobospan" id="kobo.485.1">input</span></code><span class="kobospan" id="kobo.486.1"> element into which a search term is entered and a button that submits the form. </span><span class="kobospan" id="kobo.486.2">The form is submitted using a </span><code class="inlinecode"><span class="kobospan" id="kobo.487.1">GET</span></code><span class="kobospan" id="kobo.488.1"> request, and</span><a id="_idIndexMarker933" class="calibre3"/><span class="kobospan" id="kobo.489.1"> there are hidden </span><code class="inlinecode"><span class="kobospan" id="kobo.490.1">input</span></code><span class="kobospan" id="kobo.491.1"> elements to ensure that the </span><code class="inlinecode"><span class="kobospan" id="kobo.492.1">pageSize</span></code><span class="kobospan" id="kobo.493.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.494.1">category</span></code><span class="kobospan" id="kobo.495.1"> values are included alongside the search term in the query string sent to the server. </span><em class="italic"><span class="kobospan" id="kobo.496.1">Listing 17.18</span></em><span class="kobospan" id="kobo.497.1"> integrates the new templates into the content presented to the user.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.498.1">Listing 17.18: Integrating filtering in the index.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext"><span class="kobospan" id="kobo.499.1">&lt;div</span></strong><strong class="screentext"><span class="kobospan" id="kobo.500.1"> class="container-fluid"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.501.1">    &lt;div class="row"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.502.1">        &lt;div class="col-2"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.503.1">&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.504.1">            {{&gt; category_controls }}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.505.1">        &lt;/div&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.506.1">        &lt;div class="col"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.507.1">            {{&gt; search_controls }}</span></strong><span class="kobospan" id="kobo.508.1">
            &lt;table class="table table-sm table-striped"&gt;
                &lt;thead&gt;
                    &lt;tr&gt;
                        &lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Description&lt;/th&gt;
                        &lt;th&gt;Price&lt;/th&gt;&lt;th&gt;Category&lt;/th&gt;&lt;th&gt;Supplier&lt;/th&gt;
                    &lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody&gt;
                    {{#each products }}
                        &lt;tr&gt;
                            &lt;td&gt;{{id}}&lt;/td&gt;&lt;td&gt;{{name}}&lt;/td&gt;
                            &lt;td&gt;{{description}}&lt;/td&gt;&lt;td&gt;{{price}}&lt;/td&gt;
                            &lt;td&gt;{{category.name}}&lt;/td&gt;
                            &lt;td&gt;{{supplier.name}}&lt;/td&gt;
                        &lt;/tr&gt;
                    {{/each}}
                &lt;/tbody&gt;
            &lt;/table&gt;
            {{&gt; page_controls }}
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.509.1">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.510.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.511.1">, enter </span><code class="inlinecode"><span class="kobospan" id="kobo.512.1">pro</span></code><span class="kobospan" id="kobo.513.1"> into the search field and click the </span><strong class="screentext"><span class="kobospan" id="kobo.514.1">Search</span></strong><span class="kobospan" id="kobo.515.1"> button to filter for matches. </span><span class="kobospan" id="kobo.515.2">Click the </span><strong class="screentext"><span class="kobospan" id="kobo.516.1">Soccer</span></strong><span class="kobospan" id="kobo.517.1"> button to further filter</span><a id="_idIndexMarker934" class="calibre3"/><span class="kobospan" id="kobo.518.1"> to one category. </span><span class="kobospan" id="kobo.518.2">Both results are shown in </span><em class="italic"><span class="kobospan" id="kobo.519.1">Figure 17.6</span></em><span class="kobospan" id="kobo.520.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.521.1"><img alt="" src="../Images/B21959_17_06.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.522.1">Figure 17.6: Using the data filtering controls</span></p>
<h2 class="heading1" id="_idParaDest-302"><span class="kobospan" id="kobo.523.1">Updating the product display</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.524.1">The</span><a id="_idIndexMarker935" class="calibre3"/><span class="kobospan" id="kobo.525.1"> final step to complete the catalog is to improve the way that products are displayed to lay the foundation for subsequent features. </span><span class="kobospan" id="kobo.525.2">Create a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.526.1">product.handlebars</span></code><span class="kobospan" id="kobo.527.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.528.1">templates</span></code><span class="kobospan" id="kobo.529.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.530.1">Listing 17.19</span></em><span class="kobospan" id="kobo.531.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.532.1">Listing 17.19: The contents of the product.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.533.1">&lt;div class="card card-outline-primary m-1 p-1"&gt;
    &lt;div class="bg-faded p-1"&gt;
        &lt;h4&gt;
            {{ highlight name }}
            &lt;span class="badge rounded-pill bg-primary text-white"
                   style="float:right"&gt;
                &lt;small&gt;{{ currency price }}&lt;/small&gt;
            &lt;/span&gt;
        &lt;/h4&gt;
    &lt;/div&gt;
    &lt;div class="card-text p-1"&gt;{{ highlight description }}&lt;/div&gt;
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.534.1">This</span><a id="_idIndexMarker936" class="calibre3"/><span class="kobospan" id="kobo.535.1"> template displays a card for a single product, laid out using styles from the Bootstrap CSS package. </span><span class="kobospan" id="kobo.535.2">The template depends on two helpers: the </span><code class="inlinecode"><span class="kobospan" id="kobo.536.1">highlight</span></code><span class="kobospan" id="kobo.537.1"> helper will emphasize the search term, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.538.1">currency</span></code><span class="kobospan" id="kobo.539.1"> helper will format the price, as shown in </span><em class="italic"><span class="kobospan" id="kobo.540.1">Listing 17.20</span></em><span class="kobospan" id="kobo.541.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.542.1">Listing 17.20: Adding helpers in the catalog_helpers.ts file in the src/helpers folder</span></p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext"><span class="kobospan" id="kobo.543.1">import Handlebars, { HelperOptions }  from "handlebars";</span></strong><span class="kobospan" id="kobo.544.1">
import { stringify } from "querystring";
import { escape } from "querystring";
// ...other helpers omitted for brevity...
</span><strong class="screentext"><span class="kobospan" id="kobo.545.1">export const highlight = (value: string, options: HelperOptions</span></strong><strong class="screentext"><span class="kobospan" id="kobo.546.1">) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.547.1">    const { searchTerm } = getData(options);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.548.1">    if (searchTerm &amp;&amp; searchTerm !== "") {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.549.1">        const regexp = new RegExp(searchTerm, "ig");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.550.1">        const mod = value.replaceAll</span></strong><strong class="screentext"><span class="kobospan" id="kobo.551.1">(regexp, "&lt;strong&gt;$&amp;&lt;/strong&gt;");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.552.1">        return new Handlebars.SafeString(mod);      </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.553.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.554.1">    return value;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.555.1">}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.556.1">const formatter = new Intl.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.557.1">NumberFormat("en-us", {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.558.1">    style: "currency", currency: "USD"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.559.1">})</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.560.1">export const currency = (value: number</span></strong><strong class="screentext"><span class="kobospan" id="kobo.561.1">) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.562.1">    return formatter.format(value);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.563.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.564.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.565.1">highlight</span></code><span class="kobospan" id="kobo.566.1"> helper uses JavaScript regular expressions to wrap the search term with </span><code class="inlinecode"><span class="kobospan" id="kobo.567.1">strong</span></code><span class="kobospan" id="kobo.568.1"> elements, which tell the browser to use a bold font. </span><span class="kobospan" id="kobo.568.2">The template engine </span><a id="_idIndexMarker937" class="calibre3"/><span class="kobospan" id="kobo.569.1">automatically sanitizes the results from helpers, and so the </span><code class="inlinecode"><span class="kobospan" id="kobo.570.1">HandleBars.SafeString</span></code><span class="kobospan" id="kobo.571.1"> function must be used so that the HTML elements generated by the helper are left untouched. </span><span class="kobospan" id="kobo.571.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.572.1">currency</span></code><span class="kobospan" id="kobo.573.1"> helper formats number values as US dollar amounts, using the built-in internationalization API.</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.574.1">Understanding the impact of lazy localization</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.575.1">Localizing a product takes time, effort, and resources, and it needs to be done by someone who understands the linguistic, cultural, and monetary conventions of the target country or region. </span><span class="kobospan" id="kobo.575.2">If you don’t localize properly, then the result can be worse than not localizing at all.</span></p>
<p class="normal"><span class="kobospan" id="kobo.576.1">It is for this reason that I don’t describe localization features in detail in this book – or any of my books – and why the currency values in the SportsStore application are hardcoded to </span><code class="inlinecode"><span class="kobospan" id="kobo.577.1">USD</span></code><span class="kobospan" id="kobo.578.1">. </span><span class="kobospan" id="kobo.578.2">At least if a product isn’t localized, the user knows where they stand and doesn’t have to try to figure out whether you just forgot to change the currency code or whether those prices are really in US dollars. </span><span class="kobospan" id="kobo.578.3">(This is an issue that I see all the time living in the United Kingdom.)</span></p>
<p class="normal"><span class="kobospan" id="kobo.579.1">You should localize your products. </span><span class="kobospan" id="kobo.579.2">Your users should be able to do business or perform other operations in a way that makes sense to them. </span><span class="kobospan" id="kobo.579.3">But you must take it seriously and allocate the time and effort required to do it properly. </span><span class="kobospan" id="kobo.579.4">And if you can’t commit the resources, then the next best thing is to do nothing at all.</span></p>
</div>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.580.1">Listing 17.21</span></em><span class="kobospan" id="kobo.581.1"> replaces the placeholder table with which we started the chapter with the new template.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.582.1">Listing 17.21: Using the product template in the index.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.583.1">&lt;div class="container-fluid"&gt;
    &lt;div class="row"&gt;
        &lt;div class="col-2"&gt;
            {{&gt; category_controls }}
        &lt;/div&gt;
        &lt;div class="col"&gt;
            {{&gt; search_controls }}   
            </span><strong class="screentext"><span class="kobospan" id="kobo.584.1">{{#unless products}}&lt;h4&gt;</span></strong><strong class="screentext"><span class="kobospan" id="kobo.585.1">No products&lt;/h4&gt;{{/unless}}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.586.1">            {{#each products }}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.587.1">                {{&gt; product this }}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.588.1">            {{/each}}</span></strong><span class="kobospan" id="kobo.589.1">
            {{&gt; page_controls }}
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.590.1">Use a </span><a id="_idIndexMarker938" class="calibre3"/><span class="kobospan" id="kobo.591.1">browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.592.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.593.1"> and you will see the new product layout. </span><span class="kobospan" id="kobo.593.2">Perform a search and you will see the matches highlighted in the product list, as shown in </span><em class="italic"><span class="kobospan" id="kobo.594.1">Figure 17.7</span></em><span class="kobospan" id="kobo.595.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.596.1"><img alt="" src="../Images/B21959_17_07.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.597.1">Figure 17.7: Updating the product display</span></p>
<h1 class="heading" id="_idParaDest-303"><span class="kobospan" id="kobo.598.1">Creating the shopping cart</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.599.1">Now </span><a id="_idIndexMarker939" class="calibre3"/><span class="kobospan" id="kobo.600.1">that the user can see and navigate the products for sale, the next step is to add a cart that allows them to make </span><a id="_idIndexMarker940" class="calibre3"/><span class="kobospan" id="kobo.601.1">selections before checking out. </span><span class="kobospan" id="kobo.601.2">For the SportsStore application, cart data will be handled using sessions, so that product selections are discarded when the session expires.</span><span> </span></p>
<h2 class="heading1" id="_idParaDest-304"><span class="kobospan" id="kobo.602.1">Adding configuration support for secrets</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.603.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.604.1">SportsStore</span></code><span class="kobospan" id="kobo.605.1"> application </span><a id="_idIndexMarker941" class="calibre3"/><span class="kobospan" id="kobo.606.1">will use cookies to associate requests with a session, and those cookies will be signed to prevent them from being altered. </span><span class="kobospan" id="kobo.606.2">The signing and validation process requires a secret key, known only to the application.</span></p>
<p class="normal"><span class="kobospan" id="kobo.607.1">Secret keys and, more broadly, any secret information, can be difficult to manage. </span><span class="kobospan" id="kobo.607.2">The basic rule is that secrets should not be hard-coded into the application because that makes them impossible to change without releasing a new version of the application into production.</span></p>
<p class="normal"><span class="kobospan" id="kobo.608.1">But, aside</span><a id="_idIndexMarker942" class="calibre3"/><span class="kobospan" id="kobo.609.1"> from not hard-coding, the details of how secrets are managed depend on the application, the development organization, and the production platform. </span><span class="kobospan" id="kobo.609.2">Most cloud hosting platforms, for example, provide a vault for storing secrets. </span></p>
<p class="normal"><span class="kobospan" id="kobo.610.1">The vault is populated with secrets, which the application requests when they are needed, which means that the developers, testers, and operations staff can do their jobs without needing access to the secrets.</span></p>
<p class="normal"><span class="kobospan" id="kobo.611.1">Vaults work well in large organizations where secrets are managed by security staff outside of the development organization, but they can be complicated to use and must be replicated in the development environment.</span></p>
<p class="normal"><span class="kobospan" id="kobo.612.1">Secrets can be stored in a configuration file, along with the rest of the application’s settings. </span><span class="kobospan" id="kobo.612.2">This works, but it does mean that the secrets will be visible to the developers, and it requires that care is taken not to publish the secrets by committing the configuration file to a publicly accessible source code repository or to store private repositories on cloud storage that can be accessed outside the organization.</span></p>
<p class="normal"><span class="kobospan" id="kobo.613.1">Secrets are often defined using environment variables. </span><span class="kobospan" id="kobo.613.2">The idea is that environment variables are not persistent and so cannot be accidentally included in a source code commit. </span><span class="kobospan" id="kobo.613.3">The reality is that setting up environment variables can be fiddly, especially when dealing with secrets that are long sequences of random characters, and so they are often defined using script files, which present the same problems as a regular configuration file.</span></p>
<p class="normal"><span class="kobospan" id="kobo.614.1">Every approach has its drawbacks, and there is no single best solution. </span><span class="kobospan" id="kobo.614.2">My preferred approach is to isolate the provision of secrets from the rest of the application by extending the configuration system. </span><span class="kobospan" id="kobo.614.3">This makes it easy to change the way </span><a id="_idIndexMarker943" class="calibre3"/><span class="kobospan" id="kobo.615.1">secrets are stored, which can happen as the project evolves. </span><span class="kobospan" id="kobo.615.2">Behind the scenes, I am going to use environment variables to store secrets, but this won’t be apparent to the rest of the application. </span><span class="kobospan" id="kobo.615.3">The easiest and most consistent way to define environment variables is to use an </span><em class="italic"><span class="kobospan" id="kobo.616.1">env file</span></em><span class="kobospan" id="kobo.617.1">, which is a simple text file containing key/value pairs. </span><span class="kobospan" id="kobo.617.2">To add support for reading env files, run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.618.1">Listing 17.22</span></em><span class="kobospan" id="kobo.619.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.620.1">sportsstore</span></code><span class="kobospan" id="kobo.621.1"> folder to install a new package.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.622.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.623.1">Node.js does have built-in support for reading env files (with the </span><code class="inlinecode"><span class="kobospan" id="kobo.624.1">--env-file</span></code><span class="kobospan" id="kobo.625.1"> argument, but the package offers more control over when the files are read and how the contents are processed).</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.626.1">Listing 17.22: Installing a package</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.627.1">npm install dotenv@16.4.4
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.628.1">Table 17.1</span></em><span class="kobospan" id="kobo.629.1"> describes this package for quick reference.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.630.1">Table 17.1: The env file package</span></p>
<table class="table-container" id="table001-14">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.631.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.632.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.633.1">dotenv</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.634.1">This package reads </span><code class="inlinecode"><span class="kobospan2" id="kobo.635.1">.env</span></code><span class="kobospan4" id="kobo.636.1"> files and presents their contents as environment variables. </span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.637.1">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.638.1">development.env</span></code><span class="kobospan" id="kobo.639.1"> (a period followed by </span><code class="inlinecode"><span class="kobospan" id="kobo.640.1">env</span></code><span class="kobospan" id="kobo.641.1">) to the </span><code class="inlinecode"><span class="kobospan" id="kobo.642.1">sportstore</span></code><span class="kobospan" id="kobo.643.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.644.1">Listing 17.23</span></em><span class="kobospan" id="kobo.645.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.646.1">Listing 17.23: The contents of the development.env file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.647.1"># secret used to sign session cookies
COOKIE_SECRET="sportsstoresecret"
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.648.1">The env file contains a single entry, named </span><code class="inlinecode"><span class="kobospan" id="kobo.649.1">COOKIE_SECRET</span></code><span class="kobospan" id="kobo.650.1">. </span><em class="italic"><span class="kobospan" id="kobo.651.1">Listing 17.24</span></em><span class="kobospan" id="kobo.652.1"> uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.653.1">dotenv</span></code><span class="kobospan" id="kobo.654.1"> package</span><a id="_idIndexMarker944" class="calibre3"/><span class="kobospan" id="kobo.655.1"> to read the env file and adds a function for obtaining a secret.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.656.1">Listing 17.24: Supporting secrets in the index.ts file in the src/config folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.657.1">import { readFileSync } from "fs";
import { getEnvironment, Env } from "./environment";
import { merge } from "./merge";
import { config as dotenvconfig } from "dotenv";
const file = process.env.SERVER_CONFIG ?? </span><span class="kobospan" id="kobo.657.2">"server.config.json"
const data = JSON.parse(readFileSync(file).toString());
</span><strong class="screentext"><span class="kobospan" id="kobo.658.1">dotenvconfig({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.659.1">    path: getEnvironment().toString() + ".env"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.660.1">})</span></strong><span class="kobospan" id="kobo.661.1">
try {
    const envFile = getEnvironment().toString() + "." </span><span class="kobospan" id="kobo.661.2">+ file;
    const envData = JSON.parse(readFileSync(envFile).toString());
    merge(data, envData);
} catch {
    // do nothing - file doesn't exist or isn't readable
}
export const getConfig = (path: string, defaultVal: any = undefined) =&gt; {
    const paths = path.split(":");
    let val = data;
    paths.forEach(p =&gt; val = val[p]);
    return val ?? </span><span class="kobospan" id="kobo.661.3">defaultVal;
}
</span><strong class="screentext"><span class="kobospan" id="kobo.662.1">export const getSecret = (name: string) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.663.1">    const secret = process.env[name];</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.664.1">    if (secret === undefined) {</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.665.1">throw new Error(`Undefined secret: ${name}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.666.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.667.1">    return secret;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.668.1">}</span></strong><span class="kobospan" id="kobo.669.1">
export { getEnvironment, Env };
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.670.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.671.1">config</span></code><span class="kobospan" id="kobo.672.1"> function</span><a id="_idIndexMarker945" class="calibre3"/><span class="kobospan" id="kobo.673.1"> defined by the </span><code class="inlinecode"><span class="kobospan" id="kobo.674.1">dotenv</span></code><span class="kobospan" id="kobo.675.1"> module is imported using the name </span><code class="inlinecode"><span class="kobospan" id="kobo.676.1">dotenvconfig</span></code><span class="kobospan" id="kobo.677.1"> and is used to load an env file. </span><span class="kobospan" id="kobo.677.2">To support env files for different parts of the process, the </span><code class="inlinecode"><span class="kobospan" id="kobo.678.1">getEnvirionment</span></code><span class="kobospan" id="kobo.679.1"> method is used to formulate the name of the file that will be read, so that the </span><code class="inlinecode"><span class="kobospan" id="kobo.680.1">development.env</span></code><span class="kobospan" id="kobo.681.1"> file is read during development and </span><code class="inlinecode"><span class="kobospan" id="kobo.682.1">production.env</span></code><span class="kobospan" id="kobo.683.1"> will be read when the application is deployed. </span><span class="kobospan" id="kobo.683.2">This means that a “real” environment variable is used to decide which file containing additional environment variables is loaded. </span><span class="kobospan" id="kobo.683.3">This can be slightly confusing, but it works well in practice.</span></p>
<p class="normal"><span class="kobospan" id="kobo.684.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.685.1">getSecret</span></code><span class="kobospan" id="kobo.686.1"> function is exported for use by the rest of the application and allows secrets to be requested without needing to know how they are provisioned. </span><span class="kobospan" id="kobo.686.2">There are no sensible fallback values to use for undefined secrets, so the </span><code class="inlinecode"><span class="kobospan" id="kobo.687.1">getSecret</span></code><span class="kobospan" id="kobo.688.1"> function throws an error if it cannot provide a value.</span></p>
<h2 class="heading1" id="_idParaDest-305"><span class="kobospan" id="kobo.689.1">Creating session middleware</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.690.1">The</span><a id="_idIndexMarker946" class="calibre3"/><span class="kobospan" id="kobo.691.1"> next step is to enable sessions, which will allow product selections to be persisted between HTTP requests. </span><span class="kobospan" id="kobo.691.2">Run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.692.1">Listing 17.25</span></em><span class="kobospan" id="kobo.693.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.694.1">sportsstore</span></code><span class="kobospan" id="kobo.695.1"> folder to install packages to support sessions.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.696.1">Listing 17.25: Installing the session packages</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.697.1">npm install express-session@1.17.3
npm install connect-session-sequelize@7.1.7
npm install --save-dev @types/cookie-parser@1.4.6
npm install --save-dev @types/express-session@1.17.10
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.698.1">The packages add support for processing cookies, managing sessions, and storing session data in a SQL database using the Sequelize ORM package. </span><em class="italic"><span class="kobospan" id="kobo.699.1">Table 17.2</span></em><span class="kobospan" id="kobo.700.1"> describes these packages for quick reference.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.701.1">Table 17.2: The cookie and session packages</span></p>
<table class="table-container" id="table002-14">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.702.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.703.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.704.1">express-session</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.705.1">This package adds cookie-based sessions to Express.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.706.1">connect-session-sequelize</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.707.1">This package stores session data using </span><code class="inlinecode"><span class="kobospan2" id="kobo.708.1">Sequelize</span></code><span class="kobospan4" id="kobo.709.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.710.1">@types/cookie-parser</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.711.1">This package contains type descriptions.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.712.1">@types/express-session</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.713.1">This package contains type descriptions.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.714.1">To enable </span><a id="_idIndexMarker947" class="calibre3"/><span class="kobospan" id="kobo.715.1">sessions, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.716.1">sessions.ts</span></code><span class="kobospan" id="kobo.717.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.718.1">src</span></code><span class="kobospan" id="kobo.719.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.720.1">Listing 17.26</span></em><span class="kobospan" id="kobo.721.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.722.1">Listing 17.26: The contents of the sessions.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.723.1">import { Express } from "express";
import { Sequelize } from "sequelize";
import { getConfig, getSecret } from "./config";
import session from "express-session";
import sessionStore from "connect-session-sequelize";
const config = getConfig("sessions");
const secret = getSecret("COOKIE_SECRET");
const logging = config.orm.logging
        ? </span><span class="kobospan" id="kobo.723.2">{ logging: console.log, logQueryParameters: true}
        : { logging: false };
export const createSessions = (app: Express) =&gt; {
    const sequelize = new Sequelize({
        ...config.orm.settings, ...logging
    });
    const store = new (sessionStore(session.Store))({
        db: sequelize
    });
    if (config.reset_db === true) {
        sequelize.drop().then(() =&gt; store.sync());
    } else {
        store.sync();
    }
    app.use(session({
        secret, store,
        resave: true, saveUninitialized: false,
        cookie: { maxAge: config.maxAgeHrs * 60 * 60 * 1000,
            sameSite: "strict" }
    }));
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.724.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.725.1">createSessions</span></code><span class="kobospan" id="kobo.726.1"> function reads configuration data and uses it to configure </span><code class="inlinecode"><span class="kobospan" id="kobo.727.1">Sequelize</span></code><span class="kobospan" id="kobo.728.1"> and set</span><a id="_idIndexMarker948" class="calibre3"/><span class="kobospan" id="kobo.729.1"> up session middleware using signed cookies. </span><span class="kobospan" id="kobo.729.2">Add the configuration settings shown in </span><em class="italic"><span class="kobospan" id="kobo.730.1">Listing 17.27</span></em><span class="kobospan" id="kobo.731.1"> to define the values used to specify the database and session age.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.732.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.733.1">The sessions database is reset every time the application starts. </span><span class="kobospan" id="kobo.733.2">The development tools restart the application when a file change is detected, which means that any code or configuration change will drop all of the stored sessions.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.734.1">Listing 17.27: Adding settings to the server.config.json file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.735.1">{
    "http": {
        "port": 5000
    },
    "templates": {
        // ...settings omitted for brevity...
    </span><span class="kobospan" id="kobo.735.2">},
    "errors": {
        "400": "not_found",
        "500": "error"
    },
    "catalog": {
        // ...settings omitted for brevity...
    </span><span class="kobospan" id="kobo.735.3">},
   </span><strong class="screentext"><span class="kobospan" id="kobo.736.1"> "sessions": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.737.1">        "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.738.1">maxAgeHrs": 2,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.739.1">        "reset_db": true,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.740.1">        "orm": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.741.1">            "settings": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.742.1">                "dialect": "sqlite",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.743.1">                "storage": "sessions.db"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.744.1">            },</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.745.1">            "logging": </span></strong><strong class="screentext"><span class="kobospan" id="kobo.746.1">true</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.747.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.748.1">    }</span></strong><span class="kobospan" id="kobo.749.1">
}
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.750.1">Listing 17.28</span></em><span class="kobospan" id="kobo.751.1"> enables</span><a id="_idIndexMarker949" class="calibre3"/><span class="kobospan" id="kobo.752.1"> the session middleware when the application starts.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.753.1">Listing 17.28: Enabling middleware in the server.ts file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.754.1">import { createServer } from "http";
import express, { Express } from "express";
import helmet from "helmet";
import { getConfig } from "./config";
import { createRoutes } from "./routes";
import { createTemplates } from "./helpers";
import { createErrorHandlers } from "./errors";
</span><strong class="screentext"><span class="kobospan" id="kobo.755.1">import { createSessions } from "./sessions";</span></strong><span class="kobospan" id="kobo.756.1">
const port = getConfig("http:port", 5000);
const expressApp: Express = express();
expressApp.use(helmet());
expressApp.use(express.json());
expressApp.use(express.urlencoded({extended: true}))
expressApp.use(express.static("node_modules/bootstrap/dist"));
createTemplates(expressApp);
</span><strong class="screentext"><span class="kobospan" id="kobo.757.1">createSessions(expressApp);</span></strong><span class="kobospan" id="kobo.758.1">
createRoutes(expressApp);
createErrorHandlers(expressApp);
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.759.1">Enabling</span><a id="_idIndexMarker950" class="calibre3"/><span class="kobospan" id="kobo.760.1"> sessions doesn’t change the way the application behaves but does set the foundation for the shopping cart, which is defined in the next section.</span></p>
<h2 class="heading1" id="_idParaDest-306"><span class="kobospan" id="kobo.761.1">Defining the cart data model</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.762.1">To</span><a id="_idIndexMarker951" class="calibre3"/><span class="kobospan" id="kobo.763.1"> describe a shopping cart, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.764.1">cart_models.ts</span></code><span class="kobospan" id="kobo.765.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.766.1">src/data</span></code><span class="kobospan" id="kobo.767.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.768.1">Listing 17.29</span></em><span class="kobospan" id="kobo.769.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.770.1">Listing 17.29: The contents of the cart_models.ts file in the src/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.771.1">export interface CartLine {
    productId: number;
    quantity: number;
}
export interface Cart {
    lines: CartLine[];
}
export const createCart = () : Cart =&gt; ({ lines: [] });
export const addLine = (cart: Cart, productId: number, quantity: number) =&gt; {
    const line = cart.lines.find(l =&gt; l.productId == productId);
    if (line !== undefined) {
        line.quantity += quantity;
    } else {
        cart.lines.push({ productId, quantity })
    }
}
export const removeLine = (cart: Cart, productId: number) =&gt; {
    cart.lines = cart.lines.filter(l =&gt; l.productId !== productId);
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.772.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.773.1">Cart</span></code><span class="kobospan" id="kobo.774.1"> interface </span><a id="_idIndexMarker952" class="calibre3"/><span class="kobospan" id="kobo.775.1">represents a shopping cart, with each product selection represented by a </span><code class="inlinecode"><span class="kobospan" id="kobo.776.1">CartLine</span></code><span class="kobospan" id="kobo.777.1"> object, identifying the selected product and the quantity the customer requires. </span><span class="kobospan" id="kobo.777.2">Cart data will be stored in the session database as JSON data, which is why the </span><code class="inlinecode"><span class="kobospan" id="kobo.778.1">createCart</span></code><span class="kobospan" id="kobo.779.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.780.1">addLine</span></code><span class="kobospan" id="kobo.781.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.782.1">removeLine</span></code><span class="kobospan" id="kobo.783.1"> functions are not defined in a class since JSON data is deserialized into a plain JavaScript object.</span></p>
<h2 class="heading1" id="_idParaDest-307"><span class="kobospan" id="kobo.784.1">Extending the catalog repository</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.785.1">A new query</span><a id="_idIndexMarker953" class="calibre3"/><span class="kobospan" id="kobo.786.1"> is required to be able to display a summary of the user’s cart, as shown in </span><em class="italic"><span class="kobospan" id="kobo.787.1">Listing 17.30</span></em><span class="kobospan" id="kobo.788.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.789.1">Listing 17.30: Adding a method to the catalog_repository.ts file in the src/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.790.1">import { Category, Product, Supplier, ProductQueryParameters,
    ProductQueryResult } from "./catalog_models";
export interface CatalogRepository {
    getProducts(params?: ProductQueryParameters): Promise&lt;ProductQueryResult&gt;;
  </span><strong class="screentext"><span class="kobospan" id="kobo.791.1">  getProductDetails(ids: number[]): Promise&lt;Product[]&gt;;</span></strong><span class="kobospan" id="kobo.792.1">
    storeProduct(p: Product): Promise&lt;Product&gt;;
    getCategories() : Promise&lt;Category[]&gt;;
    storeCategory(c: Category): Promise&lt;Category&gt;;
    getSuppliers(): Promise&lt;Supplier[]&gt;;
    storeSupplier(s: Supplier): Promise&lt;Supplier&gt;;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.793.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.794.1">CartLine</span></code><span class="kobospan" id="kobo.795.1"> objects that represent a selection contain just a product ID and a quantity. </span><span class="kobospan" id="kobo.795.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.796.1">getProductDetails</span></code><span class="kobospan" id="kobo.797.1"> method accepts an array of IDs and returns the corresponding </span><code class="inlinecode"><a id="_idIndexMarker954" class="calibre3"/></code><code class="inlinecode"><span class="kobospan" id="kobo.798.1">Product</span></code><span class="kobospan" id="kobo.799.1"> objects from the catalog. </span><em class="italic"><span class="kobospan" id="kobo.800.1">Listing 17.31</span></em><span class="kobospan" id="kobo.801.1"> implements the new repository method using Sequelize.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.802.1">Listing 17.31: Implementing a method in the queries.ts file in the src/data/orm folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.803.1">import { CategoryModel, ProductModel, SupplierModel } from "./models";
import { BaseRepo, Constructor } from "./core"
import { ProductQueryParameters } from "../catalog_models";
import { Op } from "sequelize";
export function AddQueries&lt;TBase extends Constructor&lt;BaseRepo&gt;&gt;(Base: TBase) {
    return class extends Base {
   
        // ...methods omitted for brevity...
   
        </span><span class="kobospan" id="kobo.803.2">getSuppliers() {
            return SupplierModel.findAll({raw: true, nest: true});
        }       
       </span><strong class="screentext"><span class="kobospan" id="kobo.804.1"> getProductDetails(ids: number[]) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.805.1">            return ProductModel.findAll</span></strong><strong class="screentext"><span class="kobospan" id="kobo.806.1">({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.807.1">                where: { id: { [Op.in]: ids }}, raw: true, nest: true,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.808.1">            });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.809.1">        }</span></strong><span class="kobospan" id="kobo.810.1">
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.811.1">The implementation of the </span><code class="inlinecode"><span class="kobospan" id="kobo.812.1">getProductDetails</span></code><span class="kobospan" id="kobo.813.1"> method uses the Sequelize </span><code class="inlinecode"><span class="kobospan" id="kobo.814.1">in</span></code><span class="kobospan" id="kobo.815.1"> operation to select products whose </span><code class="inlinecode"><span class="kobospan" id="kobo.816.1">id</span></code><span class="kobospan" id="kobo.817.1"> property is contained in the array received as the method parameter. </span><span class="kobospan" id="kobo.817.2">The result is a </span><code class="inlinecode"><span class="kobospan" id="kobo.818.1">Promise</span></code><span class="kobospan" id="kobo.819.1"> that resolves to produce an array of </span><code class="inlinecode"><span class="kobospan" id="kobo.820.1">ProductModel</span></code><span class="kobospan" id="kobo.821.1"> objects.</span></p>
<p class="normal"><span class="kobospan" id="kobo.822.1">I kept the </span><code class="inlinecode"><span class="kobospan" id="kobo.823.1">Cart</span></code><span class="kobospan" id="kobo.824.1"> type </span><a id="_idIndexMarker955" class="calibre3"/><span class="kobospan" id="kobo.825.1">simple because that’s the data that will be stored in the session, which will be read for most of the requests received from the user because the responses will contain a summary of the cart (which is created in the </span><em class="italic"><span class="kobospan" id="kobo.826.1">Creating the cart summary</span></em><span class="kobospan" id="kobo.827.1"> section). </span><span class="kobospan" id="kobo.827.2">To fully populate the cart with product details, which will be required to show the cart to the user, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.828.1">cart_helpers.ts</span></code><span class="kobospan" id="kobo.829.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.830.1">src/data</span></code><span class="kobospan" id="kobo.831.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.832.1">Listing 17.32</span></em><span class="kobospan" id="kobo.833.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.834.1">Listing 17.32: The contents of the cart_helpers.ts file in the src/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.835.1">import { catalog_repository } from ".";
import { Cart } from "./cart_models";
import { Product } from "./catalog_models"
export interface CartDetail {
    lines: {
        product: Product,
        quantity: number,
        subtotal: number
    }[],
    total: number;
}
export const getCartDetail = async (cart: Cart) : Promise&lt;CartDetail&gt; =&gt; {
    const ids = cart.lines.map(l =&gt; l.productId);
    const db_data = await catalog_repository.getProductDetails(ids);
    const products = Object.fromEntries(db_data.map(p =&gt; [p.id, p]));
    const lines = cart.lines.map(line =&gt; ({
        product: products[line.productId],
        quantity: line.quantity,
        subtotal: products[line.productId].price * line.quantity
    }));
    const total = lines.reduce((total, line) =&gt; total + line.subtotal, 0);
    return { lines, total }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.836.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.837.1">getCartDetail</span></code><span class="kobospan" id="kobo.838.1"> function accepts a </span><code class="inlinecode"><span class="kobospan" id="kobo.839.1">Cart</span></code><span class="kobospan" id="kobo.840.1"> object and returns a </span><code class="inlinecode"><span class="kobospan" id="kobo.841.1">CartDetail</span></code><span class="kobospan" id="kobo.842.1">, which contains all the </span><a id="_idIndexMarker956" class="calibre3"/><span class="kobospan" id="kobo.843.1">additional information required to provide a detailed view of the cart, including subtotals for each product selection, and an overall total.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.844.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.845.1">Some of the operations required to gather the detailed data are asynchronous, which means they cannot be performed by a template helper, which must be synchronous.</span></p>
</div>
<h2 class="heading1" id="_idParaDest-308"><span class="kobospan" id="kobo.846.1">Creating the HTTP routes and middleware</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.847.1">The next step is to</span><a id="_idIndexMarker957" class="calibre3"/><span class="kobospan" id="kobo.848.1"> define the routes and handlers for the HTTP requests so that products can be added and removed from a cart, and the contents of a cart can be displayed. </span><span class="kobospan" id="kobo.848.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.849.1">cart.ts</span></code><span class="kobospan" id="kobo.850.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.851.1">src/routes</span></code><span class="kobospan" id="kobo.852.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.853.1">Listing 17.33</span></em><span class="kobospan" id="kobo.854.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.855.1">Listing 17.33: The contents of the cart.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.856.1">import { Express } from "express";
import { escape, unescape } from "querystring";
import { Cart, addLine, createCart, removeLine } from "../data/cart_models";
import * as cart_helpers from "../data/cart_helpers";
declare module "express-session" {
    interface SessionData {
       cart?: Cart;
    }
}
export const createCartMiddleware = (app: Express) =&gt; {
    app.use((req, resp, next) =&gt; {
        resp.locals.cart = req.session.cart = req.session.cart ?? </span><span class="kobospan" id="kobo.856.2">createCart()
        next();
    })
}
export const createCartRoutes = (app: Express) =&gt; {
   
    app.post("/cart", (req, resp) =&gt; {
        const productId = Number.parseInt(req.body.productId);
        if (isNaN(productId)) {
            throw new Error("ID  must be an integer");
        }
        addLine(req.session.cart as Cart, productId, 1);
        resp.redirect(`/cart?returnUrl=${escape(req.body.returnUrl ?? </span><span class="kobospan" id="kobo.856.3">"/")}`);
    });
    app.get("/cart", async (req, resp) =&gt; {
        const cart = req.session.cart as Cart;
        resp.render("cart", {
            cart: await cart_helpers.getCartDetail(cart),
            returnUrl: unescape(req.query.returnUrl?.toString() ?? </span><span class="kobospan" id="kobo.856.4">"/")
        });
    });
    app.post("/cart/remove", (req, resp) =&gt; {
        const id = Number.parseInt(req.body.id);
        if (!isNaN(id)) {
            removeLine(req.session.cart as Cart, id);
        }
        resp.redirect(`/cart?returnUrl=${escape(req.body.returnUrl ?? </span><span class="kobospan" id="kobo.856.5">"/")}`);
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.857.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.858.1">declare</span></code><span class="kobospan" id="kobo.859.1"> statement is used to define a </span><code class="inlinecode"><span class="kobospan" id="kobo.860.1">cart</span></code><span class="kobospan" id="kobo.861.1"> property on the </span><code class="inlinecode"><span class="kobospan" id="kobo.862.1">SessionData</span></code><span class="kobospan" id="kobo.863.1"> interface so that the TypeScript compiler will understand that the cart is part of the session data.</span></p>
<p class="normal"><span class="kobospan" id="kobo.864.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.865.1">createCartMiddleware</span></code><span class="kobospan" id="kobo.866.1"> function creates a middleware component that gets the cart</span><a id="_idIndexMarker958" class="calibre3"/><span class="kobospan" id="kobo.867.1"> from the session, creates a cart if there isn’t one, and sets the cart as local data for use by the template engine. </span><span class="kobospan" id="kobo.867.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.868.1">createCartRoutes</span></code><span class="kobospan" id="kobo.869.1"> function defines three routes. </span><code class="inlinecode"><span class="kobospan" id="kobo.870.1">HTTP</span></code> <code class="inlinecode"><span class="kobospan" id="kobo.871.1">POST</span></code><span class="kobospan" id="kobo.872.1"> requests sent to the </span><code class="inlinecode"><span class="kobospan" id="kobo.873.1">/cart</span></code><span class="kobospan" id="kobo.874.1"> URL will add a product to the user’s cart, and a </span><code class="inlinecode"><span class="kobospan" id="kobo.875.1">POST</span></code><span class="kobospan" id="kobo.876.1"> request to the </span><code class="inlinecode"><span class="kobospan" id="kobo.877.1">/cart/remove</span></code><span class="kobospan" id="kobo.878.1"> URL will remove a product. </span></p>
<p class="normal"><span class="kobospan" id="kobo.879.1">(Most browsers allow HTML forms to send only </span><code class="inlinecode"><span class="kobospan" id="kobo.880.1">GET</span></code><span class="kobospan" id="kobo.881.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.882.1">POST</span></code><span class="kobospan" id="kobo.883.1"> requests, which is why both adding and removing products are done with </span><code class="inlinecode"><span class="kobospan" id="kobo.884.1">POST</span></code><span class="kobospan" id="kobo.885.1"> requests). </span><span class="kobospan" id="kobo.885.2">Requests to these handlers can include a </span><code class="inlinecode"><span class="kobospan" id="kobo.886.1">returnUrl</span></code><span class="kobospan" id="kobo.887.1"> value, to which the browser is redirected after the cart has been modified. </span><span class="kobospan" id="kobo.887.2">The value is processed using the </span><code class="inlinecode"><span class="kobospan" id="kobo.888.1">encode</span></code><span class="kobospan" id="kobo.889.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.890.1">decode</span></code><span class="kobospan" id="kobo.891.1"> functions provided by Node.js in the </span><code class="inlinecode"><span class="kobospan" id="kobo.892.1">querystring</span></code><span class="kobospan" id="kobo.893.1"> module, which allows the value to be passed around safely until it is needed to perform a redirection.</span></p>
<p class="normal"><span class="kobospan" id="kobo.894.1">The third route handles </span><code class="inlinecode"><span class="kobospan" id="kobo.895.1">GET</span></code><span class="kobospan" id="kobo.896.1"> requests sent to the </span><code class="inlinecode"><span class="kobospan" id="kobo.897.1">/cart</span></code><span class="kobospan" id="kobo.898.1"> URL and displays the contents of the cart. </span><span class="kobospan" id="kobo.898.2">The data contained in the </span><code class="inlinecode"><span class="kobospan" id="kobo.899.1">Cart</span></code><span class="kobospan" id="kobo.900.1"> object has to be supplemented with data obtained using the </span><code class="inlinecode"><span class="kobospan" id="kobo.901.1">getProductDetails</span></code><span class="kobospan" id="kobo.902.1"> repository method. </span><em class="italic"><span class="kobospan" id="kobo.903.1">Listing 17.34</span></em><span class="kobospan" id="kobo.904.1"> enables the new middleware and routes.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.905.1">Listing 17.34: Enabling routes in the index.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.906.1">import { Express } from "express";
import { createCatalogRoutes } from "./catalog";
import { createCartMiddleware, createCartRoutes } from "./cart";
export const createRoutes = (app: Express) =&gt; {
</span><strong class="screentext"><span class="kobospan" id="kobo.907.1">    createCartMiddleware(app);</span></strong><span class="kobospan" id="kobo.908.1">
    createCatalogRoutes(app);
   </span><strong class="screentext"><span class="kobospan" id="kobo.909.1"> createCartRoutes(app);</span></strong><span class="kobospan" id="kobo.910.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.911.1">These routes are enabled after those that handle the requests for the catalog and the middleware is configured before all of the routes.</span></p>
<h2 class="heading1" id="_idParaDest-309"><span class="kobospan" id="kobo.912.1">Creating the templates</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.913.1">The cart</span><a id="_idIndexMarker959" class="calibre3"/><span class="kobospan" id="kobo.914.1"> display will be a table that shows the selected products and buttons that allow items to be removed from the cart. </span><span class="kobospan" id="kobo.914.2">To define a template for the table rows, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.915.1">cart_line.handlebars</span></code><span class="kobospan" id="kobo.916.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.917.1">templates</span></code><span class="kobospan" id="kobo.918.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.919.1">Listing 17.35</span></em><span class="kobospan" id="kobo.920.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.921.1">Listing 17.35: The contents of the cart_line.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.922.1">&lt;tr&gt;
    &lt;td class="text-end"&gt;{{ quantity }} &lt;/td&gt;   
    &lt;td class="text-left"&gt;{{ product.name }}&lt;/td&gt;
    &lt;td class="text-end"&gt;{{ currency product.price }}&lt;/td&gt;
    &lt;td class="text-end"&gt;{{ currency subtotal }}&lt;/td&gt;
    &lt;td class="text-center"&gt;
        &lt;form method="post" action="/cart/remove"&gt;
            &lt;input type="hidden" name="id" value="{{ product.id }}"&gt;
            &lt;input type="hidden" name="returnUrl" value="{{ returnUrl }}"&gt;
            &lt;button type="submit" class="btn btn-sm btn-danger"&gt;
                Remove
            &lt;/button&gt;
        &lt;/form&gt;
    &lt;/td&gt;
&lt;/tr&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.923.1">This template defines table cells that contain details for a single product: the quantity chosen, the product name, the price per unit, and the subtotal. </span><span class="kobospan" id="kobo.923.2">The price and subtotal are formatted using the </span><code class="inlinecode"><span class="kobospan" id="kobo.924.1">currency</span></code><span class="kobospan" id="kobo.925.1"> helper. </span><span class="kobospan" id="kobo.925.2">The final table cell contains an HTML form that presents a </span><strong class="screentext"><span class="kobospan" id="kobo.926.1">Remove</span></strong><span class="kobospan" id="kobo.927.1"> button that sends an HTTP POST request to the </span><code class="inlinecode"><span class="kobospan" id="kobo.928.1">/cart/remove</span></code><span class="kobospan" id="kobo.929.1"> URL, which will remove a product from the cart. </span><span class="kobospan" id="kobo.929.2">To define the template for the overall table, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.930.1">cart.handlebars</span></code><span class="kobospan" id="kobo.931.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.932.1">templates</span></code><span class="kobospan" id="kobo.933.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.934.1">Listing 17.36</span></em><span class="kobospan" id="kobo.935.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.936.1">Listing 17.36: The contents of the cart.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.937.1">&lt;h2&gt;Your cart&lt;/h2&gt;
&lt;table class="table table-bordered table-striped"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th class="text-end"&gt;Quantity&lt;/th&gt;&lt;th&gt;Item&lt;/th&gt;
            &lt;th class="text-end"&gt;Price&lt;/th&gt;&lt;th class="text-end"&gt;Subtotal&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        {{#unless cart.lines}}
            &lt;tr&gt;&lt;td colspan="5" class="text-center"&gt;Cart is empty&lt;/td&gt;&lt;/tr&gt;
        {{/unless}}
        {{#each cart.lines}}
            {{&gt; cart_line returnUrl=../returnUrl }}       
        {{/each }}
    &lt;/tbody&gt;
    &lt;tfoot&gt;
        &lt;tr&gt;
            &lt;td colspan="3" class="text-end"&gt;Total:&lt;/td&gt;
            &lt;td class="text-end"&gt;{{ currency cart.total }}&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/tfoot&gt;
&lt;/table&gt;
&lt;div class="text-center"&gt;
    &lt;a class="btn btn-primary" href="{{ returnUrl }}"&gt;Continue Shopping&lt;/a&gt;
    {{#if cart.lines}}
        &lt;a class="btn btn-primary" href="/checkout"&gt;Checkout&lt;/a&gt;
    {{else}}
        &lt;button class="btn btn-primary" disabled&gt;Checkout&lt;/button&gt;
    {{/if}}
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.938.1">A useful feature </span><a id="_idIndexMarker960" class="calibre3"/><span class="kobospan" id="kobo.939.1">provided by the Handlebars template engine is providing partials with parameters. </span><span class="kobospan" id="kobo.939.2">In this case, the </span><code class="inlinecode"><span class="kobospan" id="kobo.940.1">cart_line</span></code><span class="kobospan" id="kobo.941.1"> partial is provided with a </span><code class="inlinecode"><span class="kobospan" id="kobo.942.1">returnUrl</span></code><span class="kobospan" id="kobo.943.1"> parameter:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.944.1">...
</span><span class="kobospan" id="kobo.944.2">{{#each cart.lines}}
    {{&gt; cart_line </span><strong class="screentext"><span class="kobospan" id="kobo.945.1">returnUrl</span></strong><span class="kobospan" id="kobo.946.1">=../returnUrl }}       
{{/each }}    
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.947.1">This parameter can be referred to by name and is combined with the data that would normally be available to the partial. </span><span class="kobospan" id="kobo.947.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.948.1">each</span></code><span class="kobospan" id="kobo.949.1"> helper changes the context used to resolve template expressions, which makes it easy to generate content for each item</span><a id="_idIndexMarker961" class="calibre3"/><span class="kobospan" id="kobo.950.1"> in a sequence, and within the </span><code class="inlinecode"><span class="kobospan" id="kobo.951.1">each</span></code><span class="kobospan" id="kobo.952.1"> block, expressions are evaluated against the current item. </span><span class="kobospan" id="kobo.952.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.953.1">../</span></code><span class="kobospan" id="kobo.954.1"> prefix allows a template expression to access the original context from which the </span><code class="inlinecode"><span class="kobospan" id="kobo.955.1">each</span></code><span class="kobospan" id="kobo.956.1"> helper is obtaining its values, and is used to provide the partial template with the value for the </span><code class="inlinecode"><span class="kobospan" id="kobo.957.1">returnUrl</span></code><span class="kobospan" id="kobo.958.1"> parameter.</span></p>
<p class="normal"><span class="kobospan" id="kobo.959.1">The final step is to add a button to the product template so the user can select a product, as shown in </span><em class="italic"><span class="kobospan" id="kobo.960.1">Listing 17.37</span></em><span class="kobospan" id="kobo.961.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.962.1">Listing 17.37: Adding product selection in the product.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.963.1">&lt;div class="card card-outline-primary m-1 p-1"&gt;
    &lt;div class="bg-faded p-1"&gt;
        &lt;h4&gt;
            {{ highlight name }}
            &lt;span class="badge rounded-pill bg-primary text-white"
                   style="float:right"&gt;
                &lt;small&gt;{{ currency price }}&lt;/small&gt;
            &lt;/span&gt;
        &lt;/h4&gt;
    &lt;/div&gt;
    &lt;div class="card-text p-1"&gt;
        </span><strong class="screentext"><span class="kobospan" id="kobo.964.1">&lt;span class="float-start"&gt;{{ highlight description }}&lt;/span&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.965.1">        &lt;</span></strong><strong class="screentext"><span class="kobospan" id="kobo.966.1">form method="post" action="/cart"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.967.1">            &lt;input type="hidden" name="</span></strong><strong class="screentext"><span class="kobospan" id="kobo.968.1">returnUrl" value="{{navigationUrl}}"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.969.1">            &lt;input type="hidden" name="productId" value="</span></strong><strong class="screentext"><span class="kobospan" id="kobo.970.1">{{id}}"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.971.1">            &lt;button type="submit" class="btn btn-sm btn-success float-end"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.972.1">                Add To Cart</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.973.1">            &lt;/button&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.974.1">        &lt;/</span></strong><strong class="screentext"><span class="kobospan" id="kobo.975.1">form&gt;</span></strong><span class="kobospan" id="kobo.976.1">
    &lt;/div&gt;
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.977.1">Use a </span><a id="_idIndexMarker962" class="calibre3"/><span class="kobospan" id="kobo.978.1">browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.979.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.980.1"> and click the </span><strong class="screentext"><span class="kobospan" id="kobo.981.1">Add To Cart</span></strong><span class="kobospan" id="kobo.982.1"> button for one of the products. </span><span class="kobospan" id="kobo.982.2">The product will be added to the cart, and the cart details will be displayed, as shown in </span><em class="italic"><span class="kobospan" id="kobo.983.1">Figure 17.8</span></em><span class="kobospan" id="kobo.984.1">. </span><span class="kobospan" id="kobo.984.2">Clicking the </span><strong class="screentext"><span class="kobospan" id="kobo.985.1">Remove</span></strong><span class="kobospan" id="kobo.986.1"> button will remove the product from the cart and clicking the </span><strong class="screentext"><span class="kobospan" id="kobo.987.1">Continue Shopping</span></strong><span class="kobospan" id="kobo.988.1"> button will return to the catalog. </span><span class="kobospan" id="kobo.988.2">(Clicking the </span><strong class="screentext"><span class="kobospan" id="kobo.989.1">Checkout</span></strong><span class="kobospan" id="kobo.990.1"> button will produce an error until the checkout process is implemented.)</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.991.1"><img alt="" src="../Images/B21959_17_08.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.992.1">Figure 17.8: Using the cart</span></p>
<h1 class="heading" id="_idParaDest-310"><span class="kobospan" id="kobo.993.1">Creating the cart summary</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.994.1">To finish </span><a id="_idIndexMarker963" class="calibre3"/><span class="kobospan" id="kobo.995.1">this chapter, I am going to add a summary of the cart to the catalog page, so the user can see how many products they have selected and easily navigate to the cart details. </span><span class="kobospan" id="kobo.995.2">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.996.1">Listing 17.38</span></em><span class="kobospan" id="kobo.997.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.998.1">sportsstore</span></code><span class="kobospan" id="kobo.999.1"> folder to add a package to the project that will be used by the cart summary.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1000.1">Listing 17.38: Adding a package</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.1001.1">npm install bootstrap-icons@1.11.3
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1002.1">The Bootstrap Icons package is a set of icons that can be easily used in HTML content. </span><em class="italic"><span class="kobospan" id="kobo.1003.1">Table 17.3</span></em><span class="kobospan" id="kobo.1004.1"> describes this package for quick reference.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1005.1">Table 17.3: The Bootstrap Icons package</span></p>
<table class="table-container" id="table003-14">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1006.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1007.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.1008.1">bootstrap-icons</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1009.1">This package contains a library of icons that can be applied to HTML content.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.1010.1">The cart summary will display the total number of products in the cart, which will require a template helper. </span><span class="kobospan" id="kobo.1010.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.1011.1">cart_helpers.ts</span></code><span class="kobospan" id="kobo.1012.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1013.1">src/helpers</span></code><span class="kobospan" id="kobo.1014.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.1015.1">Listing 17.39</span></em><span class="kobospan" id="kobo.1016.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1017.1">Listing 17.39: The contents of the cart_helpers.ts file in the src/helpers folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1018.1">import { Cart } from "../data/cart_models";
export const countCartItems = (cart: Cart) : number =&gt;
    cart.lines.reduce((total, line) =&gt; total + line.quantity, 0);
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.1019.1">Listing 17.40</span></em><span class="kobospan" id="kobo.1020.1"> adds the new helper to the template engine configuration.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1021.1">Listing 17.40: Adding helpers to the index.ts file in the src/helpers folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1022.1">import { Express } from "express";
import { getConfig } from "../config";
import { engine } from "express-handlebars";
import * as env_helpers from "./env";
import * as catalog_helpers from "./catalog_helpers";
</span><strong class="screentext"><span class="kobospan" id="kobo.1023.1">import</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1024.1"> * as cart_helpers from "./cart_helpers";</span></strong><span class="kobospan" id="kobo.1025.1">
const location = getConfig("templates:location");
const config = getConfig("templates:config");
export const createTemplates = (app: Express) =&gt; {
    app.set("views", location);
    app.engine("handlebars", engine({
        ...config,
        </span><strong class="screentext"><span class="kobospan" id="kobo.1026.1">helpers</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1027.1">: {...env_helpers, ...catalog_helpers, ...cart_helpers}</span></strong><span class="kobospan" id="kobo.1028.1">
    }));
    app.set("view engine", "handlebars");
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1029.1">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.1030.1">cart_summary.handlebars</span></code><span class="kobospan" id="kobo.1031.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1032.1">templates</span></code><span class="kobospan" id="kobo.1033.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.1034.1">Listing 17.41</span></em><span class="kobospan" id="kobo.1035.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1036.1">Listing 17.41: The contents of the cart_summary.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1037.1">{{#if cart.lines}}
    &lt;small class="navbar-text"&gt;{{ countCartItems cart }} item(s)&lt;/small&gt;
{{else}}
    &lt;small class="navbar-text"&gt;(Empty)&lt;/small&gt;
{{/if}}
&lt;a class="btn btn-sm btn-secondary navbar-btn" 
    href="/cart?returnUrl={{ escapeUrl ( navigationUrl ) }}"&gt;
    &lt;i class="bi-cart"&gt;&lt;/i&gt;
&lt;/a&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1038.1">The new </span><a id="_idIndexMarker964" class="calibre3"/><span class="kobospan" id="kobo.1039.1">template displays a small message that indicates the contents of the cart, along with a button that allows navigation to see the contents of the cart. </span><span class="kobospan" id="kobo.1039.2">The button is an anchor element whose content is an </span><code class="inlinecode"><span class="kobospan" id="kobo.1040.1">i</span></code><span class="kobospan" id="kobo.1041.1"> element, which is how icons from the Bootstrap Icons package are displayed:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1042.1">...
</span><span class="kobospan" id="kobo.1042.2">&lt;a class="btn btn-sm btn-secondary navbar-btn"  href="/cart{{returnUrl}}"&gt;
   </span><strong class="screentext"><span class="kobospan" id="kobo.1043.1"> &lt;i class="bi-cart"&gt;&lt;/i&gt;</span></strong><span class="kobospan" id="kobo.1044.1">
&lt;/a&gt;
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1045.1">This element displays the cart icon, and you can look up the class required for each icon at </span><a href="https://icons.getbootstrap.com" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.1046.1">https://icons.getbootstrap.com</span></span></a><span class="kobospan" id="kobo.1047.1">. </span><em class="italic"><span class="kobospan" id="kobo.1048.1">Listing 17.42</span></em><span class="kobospan" id="kobo.1049.1"> integrates the new partial template into the main layout.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1050.1">Listing 17.42: Adding the summary to the main_layout.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1051.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;link href="/css/bootstrap.min.css" rel="stylesheet" /&gt;
        </span><strong class="screentext"><span class="kobospan" id="kobo.1052.1">&lt;link href="/font/bootstrap-icons.min.css" rel="stylesheet"&gt;</span></strong><span class="kobospan" id="kobo.1053.1">
    &lt;/head&gt;
    &lt;body&gt;
        </span><strong class="screentext"><span class="kobospan" id="kobo.1054.1">&lt;div class="bg-dark text-white py-2 px-1"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1055.1">    &lt;div class="container-fluid"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1056.1">&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1057.1">                &lt;div class="row"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1058.1">                    &lt;div class="col align-baseline pt-1"&gt;SPORTS STORE&lt;/div</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1059.1">&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1060.1">                    &lt;div class="col-auto text-end"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1061.1">                        {{#if show_cart}}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1062.1">                            {{&gt; cart_summary }}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1063.1">                        {{/if}}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1064.1">                    &lt;/div&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1065.1">                &lt;/div&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1066.1">            &lt;/div</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1067.1">&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1068.1">        &lt;/div&gt;</span></strong><span class="kobospan" id="kobo.1069.1">
        {{{ body }}}
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1070.1">The</span><a id="_idIndexMarker965" class="calibre3"/><span class="kobospan" id="kobo.1071.1"> cart summary will only be shown when there is a </span><code class="inlinecode"><span class="kobospan" id="kobo.1072.1">show_cart</span></code><span class="kobospan" id="kobo.1073.1"> value, which will allow route handlers to opt into displaying the cart summary in the header, such as in </span><em class="italic"><span class="kobospan" id="kobo.1074.1">Listing 17.43</span></em><span class="kobospan" id="kobo.1075.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1076.1">Listing 17.43: Enabling the cart summary in the catalog.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1077.1">import { Express } from "express";
import { catalog_repository } from "../data";
export const createCatalogRoutes = (app: Express) =&gt; {
    app.get("/", async (req, resp) =&gt; {
        const page = Number.parseInt(req.query.page?.toString() ?? </span><span class="kobospan" id="kobo.1077.2">"1");
        const pageSize =Number.parseInt(req.query.pageSize?.toString() ?? </span><span class="kobospan" id="kobo.1077.3">"3")
        const searchTerm = req.query.searchTerm?.toString();
        const category = Number.parseInt(req.query.category?.toString() ?? </span><span class="kobospan" id="kobo.1077.4">"")
        const res = await catalog_repository.getProducts({ page, pageSize,
            searchTerm, category});
        resp.render("index", { ...res, page, pageSize,
            pageCount: Math.ceil(res.totalCount / (pageSize ?? </span><span class="kobospan" id="kobo.1077.5">1)),
            searchTerm, category, show_cart: true
        });
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1078.1">The </span><a id="_idIndexMarker966" class="calibre3"/><span class="kobospan" id="kobo.1079.1">changes in </span><em class="italic"><span class="kobospan" id="kobo.1080.1">Listing 17.42</span></em><span class="kobospan" id="kobo.1081.1"> include a </span><code class="inlinecode"><span class="kobospan" id="kobo.1082.1">link</span></code><span class="kobospan" id="kobo.1083.1"> element for the CSS stylesheet that contains the icons. </span><em class="italic"><span class="kobospan" id="kobo.1084.1">Listing 17.44</span></em><span class="kobospan" id="kobo.1085.1"> uses the Express </span><code class="inlinecode"><span class="kobospan" id="kobo.1086.1">static</span></code><span class="kobospan" id="kobo.1087.1"> middleware to provide access to the contents of this package.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1088.1">Listing 17.44: Adding static content to the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1089.1">import { createServer } from "http";
import express, { Express } from "express";
import helmet from "helmet";
import { getConfig } from "./config";
import { createRoutes } from "./routes";
import { createTemplates } from "./helpers";
import { createErrorHandlers } from "./errors";
import { createSessions } from "./sessions";
const port = getConfig("http:port", 5000);
const expressApp: Express = express();
expressApp.use(helmet());
expressApp.use(express.json());
expressApp.use(express.urlencoded({extended: true}))
expressApp.use(express.static("node_modules/bootstrap/dist"));
</span><strong class="screentext"><span class="kobospan" id="kobo.1090.1">expressApp.use(express.static("node_modules/bootstrap-icons"));</span></strong><span class="kobospan" id="kobo.1091.1">
createTemplates(expressApp);
createSessions(expressApp);
createRoutes(expressApp);
createErrorHandlers(expressApp);
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1092.1">Use a </span><a id="_idIndexMarker967" class="calibre3"/><span class="kobospan" id="kobo.1093.1">browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.1094.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.1095.1"> and you will see the cart summary, which will reflect any earlier product selections. </span><span class="kobospan" id="kobo.1095.2">As the contents of the cart change, the summary will be updated to show the number of products that have been chosen, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1096.1">Figure 17.9</span></em><span class="kobospan" id="kobo.1097.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.1098.1"><img alt="" src="../Images/B21959_17_09.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.1099.1">Figure 17.9: Displaying a cart summary</span></p>
<h1 class="heading" id="_idParaDest-311"><span class="kobospan" id="kobo.1100.1">Summary</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.1101.1">In this chapter, I continued working on the </span><code class="inlinecode"><span class="kobospan" id="kobo.1102.1">SportsStore</span></code><span class="kobospan" id="kobo.1103.1"> project to complete the product catalog and add a shopping cart:</span></p>
<ul class="calibre4">
<li class="bulletlist"><span class="kobospan" id="kobo.1104.1">Requests for products can include query string parameters that paginate data, specify page size, and filter the product data.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1105.1">The query string values are preserved in the URLs contained in the HTML responses so that the user has a consistent experience.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1106.1">The shopping cart uses sessions to store product selections. </span><span class="kobospan" id="kobo.1106.2">The session data is stored in a database and sessions are identified using HTTP cookies.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1107.1">The session cookies are signed to prevent tampering, and the signing secret is stored in an env file, which is read by the configuration system.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1108.1">A summary of the shopping cart is displayed as part of the catalog, styled using an icon package.</span></li>
</ul>
<p class="normal"><span class="kobospan" id="kobo.1109.1">I will continue working on </span><code class="inlinecode"><span class="kobospan" id="kobo.1110.1">SportsStore</span></code><span class="kobospan" id="kobo.1111.1"> in the next chapter, adding support for accepting and validating orders.</span></p>
</div>
</body></html>