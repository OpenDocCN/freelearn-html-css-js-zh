<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch04"/>Chapter 4. List and Search</h1></div></div></div><p>In previous chapters we looked at preparing the data structure and the basic Ext JS architecture, and in <a class="link" href="ch03.html" title="Chapter 3. Data Input">Chapter 3</a>, <em>Data Input</em>, we looked at inputting data. However, we couldn't implement the writing of the data from the <code class="literal">Quotation</code> form. This was because we couldn't judge whether it was a new addition or an editing process due to listing being non-existent.</p><p>When you actually construct an application, it is probably most common to build the list first and then create the form. However, this time we learned to read the form first and then save it. So, just choose whichever way you find easier to build with.</p><p>This chapter is mainly about displaying data that was read in the previous chapter. However, users will no doubt want to search for data, so we will also learn about data searches.</p><p>In this chapter you will learn how to:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Get data from the database</li><li class="listitem" style="list-style-type: disc">Apply the acquired data to the store</li><li class="listitem" style="list-style-type: disc">Connect the store and the grid</li><li class="listitem" style="list-style-type: disc">Read data to fields</li><li class="listitem" style="list-style-type: disc">Search the list</li></ul></div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec34"/>Creating the Quotation list</h1></div></div></div><p>So, let's straightaway <a id="id161" class="indexterm"/>start with preparing the CT to create the <code class="literal">Quotation</code> list. We will create <code class="literal">view_list.htm</code> and <code class="literal">view_list.js</code> (source file: <code class="literal">01_creating_quotation_list/ct/quotation/view_list.html</code>).</p><p>The <code class="literal">view_list.html</code> file is a reproduction of other <code class="literal">view</code> files, and so inside the internal reading, change the <code class="literal">.js</code> file in the view that's being read to <code class="literal">view_list.js</code> (source file: <code class="literal">01_creating_quotation_list/ct/quotation/view_list.js</code>).</p><p>The <code class="literal">view_list.js</code> file is also almost similar. It's only a little bit different.</p><div><pre class="programlisting">Ext.onReady(function() {
    Ext.create('MyApp.store.Customer');
    Ext.create('MyApp.store.QuotationItem');
    Ext.create('MyApp.store.Quotation');
    Ext.create('MyApp.view.quotation.Quotation', {
        activeItem: 0,
     ...</pre></div><p>By now, preparing the CT should have become a straightforward process.</p><p>Unlike edit, <a id="id162" class="indexterm"/>set the <code class="literal">activeItem</code> in the list to <code class="literal">0</code>. If you check how it looks in a browser, only the <code class="literal">Quotation</code> panel will be displayed.</p><p>Let's begin to build the inside.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec35"/>Creating the Quotation model</h1></div></div></div><p>First, you<a id="id163" class="indexterm"/> want to build a store, but let's build a model before that (source file: <code class="literal">02_creating_quotation_model/app/model/Quotation.js</code>).</p><p>Let's implement the <code class="literal">Quotation</code> model class that has a newly acquired <code class="literal">id</code>, <code class="literal">customer</code>, <code class="literal">modified</code> and <code class="literal">created</code>.</p><p>Define the <code class="literal">id</code>, <code class="literal">customer</code>
<code class="literal"> name</code>, <code class="literal">modified date/time</code>, and <code class="literal">created date/time</code> parameters. Then, we'll implement the store that was used in the model in the previous step (source file: <code class="literal">02_creating_quotation_model/app/store/Quotation.js</code>).</p><div><pre class="programlisting">Ext.define('MyApp.store.Quotation', {
    extend: 'Ext.data.Store',
    storeId: 'QuotationList',
    model: 'MyApp.model.Quotation',
    remoteSort: true,
    pageSize: 100,
    proxy: {
        type: 'direct',
        directFn: 'MyAppQuotation.getGrid',
        reader: {
            type: 'json',
            root: 'items',
            totalProperty: 'total'
        }
    }
});</pre></div><p>Specify <code class="literal">MyAppQuotation.getGrid</code> in <code class="literal">directFn</code>. This is the method name where the store is going to acquire the data. Of course, this is a new construction. In other words, add a method to the PHP class and with what you have experienced so far, you should easily be able to imagine whether it's necessary to add <code class="literal">config.php</code>.</p><p>So, first implement<a id="id164" class="indexterm"/> the method even though it is empty (source file: <code class="literal">02_creating_quotation_model/php/classes/MyAppQuotation.php</code>).</p><p>There is one argument and for this a search condition will be sent from the store (source file: <code class="literal">02_creating_quotation_model/php/config.php</code>).</p><div><pre class="programlisting">&lt;?php
$API = array(
    ....
    'MyAppQuotation'=&gt;array(
        'methods'=&gt;array(
            ....
            'getGrid'=&gt;array(
                'len'=&gt;1
            )
        )
    ),
    ....
);</pre></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec36"/>Updating the Quotation view</h1></div></div></div><p>You've prepared everything for the grid to be displayed, so let's implement the view (source file: <code class="literal">03_update_the_quotation_view/app/view/quotation/List.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.view.quotation.List', {
  ...
    initComponent: function() {
        var me = this;
        Ext.apply(me, {
            columns: [{
                text: 'Customer',
                dataIndex: 'customer',
                flex: 1
            }, {
                text: 'Modified',
                dataIndex: 'modified',
                width: 120
            }, {
                text: 'Created',
                dataIndex: 'created',
                width: 120
            }]
        });
        me.callParent(arguments);
    }
});</pre></div><p>Here you<a id="id165" class="indexterm"/> are only specifying columns. In order to abstract the grid panel, we are creating the <code class="literal">MyApp.grid.Panel</code> class. (source file: <code class="literal">03_update_the_quotation_view/app/grid/Panel.js</code>).</p><p>We will create the <code class="literal">MyApp.grid.Panel</code> class that is purely inherited from the <code class="literal">Ext.grid.Panel</code> class.</p><p>We have just simply succeeded the <code class="literal">Ext.grid.Panel</code> class. That's pretty much what abstraction is. Now, it should look like the following if you display it:</p><div><img src="img/5446OS_04_01.jpg" alt="Updating the Quotation view"/></div><p>It has been a while since we saw an image, so we've displayed a column for now; however, let's start to create the necessary objects for this list.</p><p>The next thing to add is the toolbar with buttons. Let's go ahead and add the following buttons (source file: <code class="literal">03_update_the_quotation_view/app/view/quotation/List.js</code>):</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Add</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Edit</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Delete</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Update</code></li></ul></div><p>This can be implemented using the following code:</p><div><pre class="programlisting">Ext.define('MyApp.view.quotation.List', {
    ....
    initComponent: function() {
        var me = this;
        Ext.apply(me, {
            tbar: [{
                text: 'Add',
                disabled: true,
                action: 'add'
            }, {
                text     : 'Edit',
                disabled : true,
                action   : 'edit'
            }, {
                text     : 'Remove',
                disabled : true,
                action   : 'remove'
            }, '-', {
                text     : 'Refresh',
                disabled : true,
                action   : 'refresh'
            }]
        });
    ....</pre></div><p>We have<a id="id166" class="indexterm"/> installed the buttons, so now describe the event handler that deals with this to the controller (source file: <code class="literal">03_update_the_quotation_view/app/controller/quotation/List.js</code>).</p><p>In the control for the <code class="literal">MyApp.controller.quotation.List</code> class, use the following selectors and register each handler with the <code class="literal">click</code> event (at the same time we'll implement each empty handler):</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For <code class="literal">selector: 'myapp-quotation-list button[action=add]'</code> use <code class="literal">handler: onItemAdd</code></li><li class="listitem" style="list-style-type: disc">For <code class="literal">selector: 'myapp-quotation-list button[action=edit]'</code> use <code class="literal">handler: onItemEdit</code></li><li class="listitem" style="list-style-type: disc">For <code class="literal">selector: 'myapp-quotation-list button[action=remove]'</code> use <code class="literal">handler: onItemRemove</code></li><li class="listitem" style="list-style-type: disc">For <code class="literal">selector: 'myapp-quotation-list button[action=refresh]'</code> use <code class="literal">handler: onStoreRefresh</code></li></ul></div><p>If you want to check whether the event responds or not, you can set <code class="literal">disabled</code> to <code class="literal">false</code>, or reset it and then check the performance. We'll create an implementation later so that the status of the disable button changes according to whether the list has been selected or not.</p><p>Next, let's <a id="id167" class="indexterm"/>implement <code class="literal">SearchField</code> for searches. We'll place this in the top toolbar we created earlier. But before you can do that, you'll need to implement <code class="literal">SearchField</code>. The <code class="literal">SearchField</code> is distributed from the beginning as <code class="literal">ux</code>, but this time we'll use this as a reference to construct anew (source file: <code class="literal">03_update_the_quotation_view/app/form/SearchField.js</code>).</p><div><pre class="programlisting">Ext.define('MyApp.form.SearchField', {
    extend: 'Ext.form.field.Trigger',
    alias: 'widget.myapp-searchfield',
    trigger1Cls: Ext.baseCSSPrefix + 'form-clear-trigger',
    trigger2Cls: Ext.baseCSSPrefix + 'form-search-trigger',
    hasSearch : false,
    paramName : 'query',
    initComponent: function() {
        var me = this;
        me.callParent(arguments);
        me.on('specialkey', function(f, e){
            if(e.getKey() == e.ENTER) {
                me.onTrigger2Click();
            }
        });
    },
    afterRender: function() {
        this.callParent();
        this.triggerCell.item(0).setDisplayed(false);
    },
    onTrigger1Click : function() {
        var me = this;
        if(me.hasSearch) {
            me.setValue('');
            me.hasSearch = false;
            me.triggerCell.item(0).setDisplayed(false);
            location.href = me.urlRoot;
        }
    },
    onTrigger2Click : function() {
        var me = this,
            value = me.getValue();
        if(value.length &gt; 0) {
            me.triggerCell.item(0).setDisplayed(true);
            location.href = Ext.String.format('{0}q={1}', me.urlRoot, 
            value);
        }
    }
});</pre></div><p>Next, add<a id="id168" class="indexterm"/> the paging toolbar. Install it along with <code class="literal">SearchField</code>. Displaying 100 to 1,000 items at a time would be optimal. In order to declare the use of <code class="literal">SearchField</code>, set <code class="literal">MyApp.form.SearchField</code> in <code class="literal">requires</code> (source file: <code class="literal">03_update_the_quotation_view/app/view/quotation/List.js</code>).</p><div><pre class="programlisting">       ....
    initComponent: function() {
        var me = this;
        Ext.apply(me, {
            tbar: [{
                ....
            }, '-&gt;', {
                xtype    : 'myapp-searchfield',
                disabled : true,
                width    : 150
            }],
            bbar: {
                xtype       : 'pagingtoolbar',
                displayInfo : true 
            }
    ....</pre></div><p>Finally, let's slightly customize the grid. Modify the <code class="literal">SelectionModel</code> and then make the selection possible with a checkbox. We'll install this so it offers a user interface that lets you delete items collectively. To do this, you'll use <code class="literal">Ext.selection.CheckboxModel</code> (source file: <code class="literal">03_update_the_quotation_view/app/view/quotation/List.js</code>).</p><div><pre class="programlisting">Ext.define('MyApp.view.quotation.List', {
    ....
    requires: [
        'MyApp.form.SearchField',
        'Ext.selection.CheckboxModel'
    ],
    initComponent: function() {
        var me = this;
        Ext.apply(me, {
            selModel: Ext.create('Ext.selection.CheckboxModel')
        });
        Ext.apply(me, {
            tbar: [{
                text: 'Add',
                ....</pre></div><p>In the same <a id="id169" class="indexterm"/>way as with <code class="literal">SearchField</code>, define the reading of <code class="literal">Ext.selection.CheckboxModel</code> in <code class="literal">requires</code>. Again, regarding the <code class="literal">selModel</code>, set the <code class="literal">Ext.selection.CheckboxModel</code> instance. If you finish configuring it all, it should look like this:</p><div><img src="img/5446OS_04_02.jpg" alt="Updating the Quotation view"/></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec37"/>Implementing the Quotation controller</h1></div></div></div><p>It's starting to<a id="id170" class="indexterm"/> look like the real thing! So, now let's implement the part that will actually read and display the data. First, as usual, start with the implementation of the CT (source file: <code class="literal">04_implement_quotation_controller/ct/quotation/view_list.html</code>).</p><p>Reproduce <code class="literal">app_edit.html</code> and change the <code class="literal">.js</code> file that is being read to <code class="literal">app_list.js</code>. Again, be careful because we'll read the <code class="literal">api.php</code> file together (source file: <code class="literal">04_implement_quotation_controller/ct/quotation/view_list.js</code>).</p><div><pre class="programlisting">...
Ext.application({
  ...
    controllers: [
        'quotation.Quotation',
        'quotation.Edit',
        'quotation.List'
    ],
    launch: function() {
        var panel = Ext.create('MyApp.view.quotation.Quotation', {
           width: 800,
           height: 600,
           activeItem: 0,
           renderTo: Ext.getBody()
        });
        Ext.util.Observable.capture(panel, function() {
            console.log(arguments);
        });
        Ext.widget('button', {
            text: 'fire myapp-show',
            renderTo: Ext.getBody(),
            scope: this,
            handler: function() {
                this.getController('quotation.Quotation').loadIndex('#!/quotation');
            }
        });
    }
});</pre></div><p>Be aware that the <code class="literal">direct</code> setup is also underway.</p><p>Now prepare <a id="id171" class="indexterm"/>the button that mock fires the <code class="literal">myapp-show</code> event. Of course we will also add the <code class="literal">List</code> controller (source file: <code class="literal">04_implement_quotation_controller/app/controller/quotation/List.js</code>).</p><p>Here, we'll add the <code class="literal">myapp-show</code> event to <code class="literal">stores</code>, <code class="literal">refs</code>, <code class="literal">myapp-quotationlist</code>, and finally we'll implement the <code class="literal">onShow</code> method:</p><div><pre class="programlisting">Ext.define('MyApp.controller.quotation.List', {
    extend: 'MyApp.controller.Abstract',
    stores: [
        'Quotation'
    ],
    refs: [{
        ref: 'listView', selector: 'myapp-quotation-list' 
    }],
    init: function() {
        var me = this;
        me.control({
            'myapp-quotation-list': {
                'myapp-show': me.onShow
            },
    ...
    },
    onShow: function(p, owner, params) {
        var me          = this,
            listView    = me.getListView(),
            btnAdd      = listView.down('button[action=add]'),
            btnEdit     = listView.down('button[action=edit]'),
            btnRemove   = listView.down('button[action=remove]'),
            btnRefresh  = listView.down('button[action=refresh]'),
            fieldSearch = listView.down('myapp-searchfield'),
            query       = params.q;
        btnAdd.disable();
        btnEdit.disable();
        btnRemove.disable();
        btnRefresh.disable();
        if(query) {
            fieldSearch.setValue(query);
            fieldSearch.triggerCell.item(0).setDisplayed(true);
            fieldSearch.hasSearch = true;
        }
        fieldSearch.urlRoot = '#!/quotation/';
        fieldSearch.disable();
        listView.getStore().load({
            params: {
                query: query
            },
            callback: function(records, operation, success) {
                btnAdd.enable();
                btnRefresh.enable();
                fieldSearch.enable();
            }
        });
    },
  ...
});</pre></div><p>Add the event<a id="id172" class="indexterm"/> handler and then implement the <code class="literal">onShow</code> event. Acquire the list view from the store and call the <code class="literal">load</code> method.</p><p>In order to acquire the <code class="literal">list</code> view and store, make sure that <code class="literal">stores</code> and <code class="literal">refs</code> are configured. This time, we will also amend the component side, that is, the view side (source File: <code class="literal">04_implement_quotation_controller/app/view/quotation/List.js</code>).</p><div><pre class="programlisting">Ext.define('MyApp.view.quotation.List', {
    ....
    initComponent: function() {
        var me = this,
            store = me.getStore();
        if(!store) {
            store = Ext.create('MyApp.store.Quotation');
            me.store = store;
        }
        Ext.apply(me, {
        ....</pre></div><p>Set up the <code class="literal">store</code> object<a id="id173" class="indexterm"/> in the <code class="literal">initComponent</code> method. Run the CT and if you press the button, the store will use the <code class="literal">DirectFn</code> method that was set up and transmissions will occur. Of course the server-side implementation has not happened, so nothing will be displayed in the list.</p></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec38"/>Loading the grid and implementing toolbar buttons</h1></div></div></div><p>Generally speaking, <a id="id174" class="indexterm"/>a grid is not a grid if it can't read data. For the time being, let's just read <a id="id175" class="indexterm"/>the data from the database and display it in the grid (source file: <code class="literal">05_loading_the_grid_and_implementing_toolbar_buttons/php/classes/MyAppQuotation.php</code>).</p><p>Here we'll implement the <code class="literal">getGrid</code> method<a id="id176" class="indexterm"/> for <code class="literal">MyAppQuotation.php</code> that was returning empty data.</p><div><div><h3 class="title"><a id="note02"/>Note</h3><p>The code for this is a little bit long, so please refer to the source file to see the code.</p></div></div><p>If we put any old data in the database it will be displayed. But, because the items we want to display have increased slightly, we need to amend the JavaScript source code. Add the two files <code class="literal">addr</code> and <code class="literal">note</code> to the <code class="literal">Quotation</code> model (source file: <code class="literal">05_loading_the_grid_and_implementing_toolbar_buttons/app/model/Quotation.js</code>).</p><p>Now let's add the two files we added in the previous step to the <code class="literal">columns</code> property in <code class="literal">MyApp.view.quotation.List</code> (source file: <code class="literal">05_loading_the_grid_and_implementing_toolbar_buttons/app/view/quotation/List.js</code>):</p><div><pre class="programlisting">  ...
            }, {
                text: 'Address',
                dataIndex: 'addr',
                flex: 1
            }, {
                text: 'Note',
                dataIndex: 'note',
                flex: 1
            }, {
    ...</pre></div><p>We have<a id="id177" class="indexterm"/> added the <code class="literal">addr</code>, <code class="literal">modified</code>, and <code class="literal">created</code> files. The data is random but columns are displayed, and the data is read as in the following screenshot:</p><div><img src="img/5446OS_04_03.jpg" alt="Loading the grid and implementing toolbar buttons"/></div><p>Next comes the building of registration processes, something we left undone in <a class="link" href="ch03.html" title="Chapter 3. Data Input">Chapter 3</a>, <em>Data Input</em>. In order to do that, first implement the event handler for the toolbar buttons and then display the <strong>Add New</strong> and <strong>Editing</strong> screens (source file: <code class="literal">05_loading_the_grid_and_implementing_toolbar_buttons/app/controller/quotation/List.js</code>).</p><div><pre class="programlisting">Ext.define('MyApp.controller.quotation.List', {
    ....
    onItemAdd: function() {
        var me          = this,
            listView    = me.getListView();
        listView.fireEvent('myapp-add');
    },</pre></div><p>Fire the <code class="literal">myapp-add</code> event in <a id="id178" class="indexterm"/>the list view component (source file: <code class="literal">05_loading_the_grid_and_implementing_toolbar_buttons/app/controller/quotation/Quotation.js</code>).</p><div><pre class="programlisting">Ext.define('MyApp.controller.quotation.Quotation', {
    ....
    init: function() {
        var me = this,
            format = Ext.String.format;
        me.control({
            'myapp-quotation-list': {
                'myapp-add': function() {
                    location.href = format('#!/{0}/new', 
                    me.screenName);
                }
            },
    ....</pre></div><p>Then describe the <code class="literal">myapp-add</code> event handler<a id="id179" class="indexterm"/> in the <code class="literal">MyApp.controller.quotation.Quotation</code> class. Here, specify the URL in <code class="literal">location.href</code> and then move the screen. Not in a CT, but if you display the whole application in <code class="literal">index.php</code>, you should be able to check the way the screen changes when you click on the <strong>Add</strong> button.</p><div><img src="img/5446OS_04_04.jpg" alt="Loading the grid and implementing toolbar buttons"/></div><p>After clicking on the <strong>Add</strong> button, you'll see the following screenshot:</p><div><img src="img/5446OS_04_05.jpg" alt="Loading the grid and implementing toolbar buttons"/></div><p>Let's implement the <code class="literal">add new</code> function<a id="id180" class="indexterm"/>. CT is the place to develop it. It will happen with <code class="literal">ct/quotation/app_edit.htm</code>.</p><p>First implement <a id="id181" class="indexterm"/>the <strong>Save</strong> button. Acquire the <strong>Save</strong> button with the component query as <code class="literal">'myapp-quotation-edit button[action=save]'</code> and set up the <code class="literal">click</code> event. The handler name is <code class="literal">onSave</code>.</p><p>Let's create it in a way that when the <strong>Save</strong> button is pressed, the event handler is registered in the <code class="literal">MyApp.controller.quotation.Edit</code> class (source file: <code class="literal">05_loading_the_grid_and_implementing_toolbar_buttons/app/controller/quotation/Edit.js</code>).</p><div><pre class="programlisting">        me.control({
            ....
            'myapp-quotation-edit button[action=save]': {
                'click': me.onSave
            }
        });</pre></div><p>We'll also implement the inside of the handler.</p><div><pre class="programlisting">    ...
 onSave: function() {
        var me      = this,
            p       = me.getEditView(),
            form    = p.getForm(),
            format  = Ext.String.format,
            id;
        p.setLoading();
        form.submit({
            success: function(form, action) {
                if(action.result.newid) {
                    p.fireEvent('myapp-list-reload');
                    location.href = format('#!/quotation/id={0}', 
                    action.result.newid);
                    return;
                }
                p.setLoading(false);
                form.load({
                    params: {
                        id: form.getValues()['id']
                    },
                    success: function(form, ret) {
                        p.fireEvent('myapp-loadform', p, ret);
                        p.fireEvent('myapp-undirty');
                        p.setLoading(false);
                    },
                    failure: function() {
                        p.setLoading(false);
                    }
                });
            },
            failure: function(form, action) {
                p.setLoading(false);
            }
        });
    },</pre></div><p>Call the <code class="literal">submit</code> method for the form in <code class="literal">onSave</code> and transmit the position to the server side. Next comes server-side implementation.</p><p>The Ext Direct module<a id="id182" class="indexterm"/> has already been prepared, and the processing will be implemented there. You probably remember the method is called <code class="literal">writeForm</code>.</p><p>Here we'll<a id="id183" class="indexterm"/> implement the <code class="literal">writeForm</code> method. The code is very long, so again please refer to the source file (source file: <code class="literal">05_loading_the_grid_and_implementing_toolbar_buttons/php/classes/MyAppQuotation.php</code>).</p><p>With this method the received position is being stored in the <code class="literal">Quotation</code> table. We are already storing certain data in quotations, so write the data in a different table as well.</p><p>In order to guarantee that correct data is written, you need to use <code class="literal">Transaction</code>, so use <code class="literal">begin</code>, <code class="literal">rollback</code>, and <code class="literal">commit</code>. In MySQL, if we use <code class="literal">last_insert_id()</code>, we can acquire the previous ID that we wrote.</p><p>Use this and set up the parent for quotations. In CT, even if we perform the screen transfer process, it will remain as it is when it loads. It should look like the following URL.</p><p><code class="literal">&lt;hostname&gt;/ct/quotation/app_edit.html#!/quotation/id=XX</code></p><p>Now, if we run it in the application, the URL will change in the following way:</p><p><code class="literal">&lt;hostname&gt;/#!/quotation/id=XX</code></p><p>With that present status, start reading again. The specific data you used has disappeared and just one item is being displayed. This is the reason why we stopped at creating mock data in <a class="link" href="ch03.html" title="Chapter 3. Data Input">Chapter 3</a>, <em>Data Input</em>.</p><p>We need to expand the <code class="literal">readForm</code> method<a id="id184" class="indexterm"/>, which is at the root of all of this. However, before that, in order to have the ID cross over for the <code class="literal">readForm</code> argument, first amend the <code class="literal">config.php</code> file.</p><p>We will change the argument in the <code class="literal">readForm</code> method of the <code class="literal">MyAppQuotation</code> class from <code class="literal">0</code> to <code class="literal">1</code> (source file: <code class="literal">05_loading_the_grid_and_implementing_toolbar_buttons/php/config.php</code>).</p><p>Once we have <a id="id185" class="indexterm"/>amended the <code class="literal">config.php</code> file, we will amend the <code class="literal">readForm</code> method so it can actually receive arguments (source file: <code class="literal">05_loading_the_grid_and_implementing_toolbar_buttons/php/classes/MyAppQuotation.php</code>).</p><div><pre class="programlisting">&lt;?php
class MyAppQuotation {
  public function readForm($id) {</pre></div><p>Set the <code class="literal">$id</code> argument in the <code class="literal">readForm</code> method to identify the target. Now, this time, do the same at the JavaScript side (source file: <code class="literal">05_loading_the_grid_and_implementing_toolbar_buttons/app/view/quotation/Edit.js</code>).</p><div><pre class="programlisting">Ext.define('MyApp.view.quotation.Edit', {
    ....
    paramOrder: ['id'],
    ....</pre></div><p>With this, the ID can transmit to the server side. Now let's implement the main <code class="literal">readForm</code> method.</p><p>This is the implementation of the inside of the <code class="literal">readForm</code> method that we amended the arguments to earlier. Because the source code is very long, please refer to the source file for the code (source file: <code class="literal">05_loading_the_grid_and_implementing_toolbar_buttons/php/classes/MyAppQuotation.php</code>).</p><p>After you have read the data from the <code class="literal">Quotation</code> table with the ID that you set up, acquire the data from the <code class="literal">Quotations</code> table, convert the array into JSON, and save it.</p><p>Customer names are dependent on the <code class="literal">MyApp.store.Customer</code> data. If you want to match it with the customer table in the database, please customize it to read the data via <code class="literal">direct</code> to the store. Pretty simple!</p></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec39"/>Managing toolbar buttons depending on the grid selection's status</h1></div></div></div><p>Now<a id="id186" class="indexterm"/> reading and writing of the data is complete. There's only the <code class="literal">Add</code> function in the list, so at present we can only add new information. Let's create it so we can click on the <strong>Edit</strong> and <strong>Remove</strong> buttons. After this we can implement the various functions. This implementation happens in <code class="literal">ct/quotation/app_list.html</code>.</p><p>Let's control the events when items are selected and deselected in the list. Also, we'll implement it so when you double-click on an item, it will perform in the same way as when you click on the <strong>Edit</strong> button.</p><p>We'll add the following event handler to the process occurring in the control of the <code class="literal">init</code> method of the <code class="literal">MyApp.controller.quotation.List</code> class (source file: <code class="literal">06_management_toolbar_buttons_depend_on_grid_selection_status/app/controller/quotation/List.js</code>).</p><div><pre class="programlisting">            ....
            'myapp-quotation-list': {
                'myapp-show': me.onShow,
                'select': me.onSelect,
                'itemdblclick': me.onItemDblClick,
                'deselect': me.onDeselect
            },
            ....</pre></div><p>The following three are event handlers that will listen to specific events:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">select</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">itemdblclick</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">deselect</code></li></ul></div><p>Let's go ahead and<a id="id187" class="indexterm"/> implement the various event handlers that will listen to the preceding three events. Next, we'll implement a handler to the previous step (source file: <code class="literal">06_management_toolbar_buttons_depend_on_grid_selection_status/app/controller/quotation/List.js</code>).</p><div><pre class="programlisting">
<strong>onSelect</strong>
onSelect: function() {
    var me = this,
        listView = me.getListView(),
        btnEdit = listView.down('button[action=edit]'),
        btnRemove = listView.down('button[action=remove]'),
        sm = listView.getSelectionModel(),
        cnt = sm.getCount();
    if(cnt === 1) {
        btnEdit.enable();
    } else {
        btnEdit.disable();
    }
    if(cnt &gt; 0) {
        btnRemove.enable();
    } else {
        btnRemove.disable();
    }
},

<strong>onDeselect</strong>
onDeselect: function() {
    var me = this,
        listView = me.getListView(),
        btnEdit = listView.down('button[action=edit]'),
        btnRemove = listView.down('button[action=remove]'),
        sm = listView.getSelectionModel(),
        cnt = sm.getCount();
    if(cnt === 1) {
        btnEdit.enable();
    } else {
        btnEdit.disable();
    }
    if(cnt &gt; 0) {
        btnRemove.enable();
    } else {
        btnRemove.disable();
    }
}</pre></div><p>Regarding selections, <a id="id188" class="indexterm"/>we'll only have the <strong>Edit</strong> button available when one item is selected. We'll make <strong>Remove</strong> available even when multiple items are selected. Both the <strong>Edit</strong> and <strong>Remove</strong> buttons will be unavailable when no items are selected.</p><div><pre class="programlisting">
<strong>onItemDblClick</strong>
onItemDblClick: function(p, record, item, index, e, eOpts) {
    var me          = this,
        listView    = me.getListView();
    listView.fireEvent('myapp-edit', record.data.id);
},</pre></div><p>When double-clicked, the <code class="literal">myapp-edit</code> event<a id="id189" class="indexterm"/> will fire, and the selected item ID will be added to the argument.</p><p>Now all that remains is to implement the process for when the <strong>Edit</strong> and <strong>Remove</strong> buttons are pressed. The implementation of the <strong>Edit</strong> button happens in the following way:</p><div><pre class="programlisting">
<strong>onItemEdit</strong>
onItemEdit: function() {
    var me = this,
        listView = me.getListView(),
        sm = listView.getSelectionModel(),
        record = sm.getLastSelected();
    listView.fireEvent('myapp-edit', record.data.id);
},</pre></div><p>The process is mostly the same as for <code class="literal">onItemDblClick</code>; however, the <code class="literal">record</code> object is not passed across by the argument, so acquire the <code class="literal">record</code> object that has been selected from <code class="literal">SelectionModel</code>.</p><p>So, if you implement the <code class="literal">myapp-edit</code> event handler, it's going to start to feel like the end. The <code class="literal">myapp-edit</code> event handler will be implemented by the <code class="literal">MyApp.controller.quotation.Quotation</code> controller (source file: <code class="literal">06_management_toolbar_buttons_depend_on_grid_selection_status/app/controller/quotation/Quotation.js</code>).</p><div><pre class="programlisting">Ext.define('MyApp.controller.quotation.Quotation', {
    ....
    init: function() {
        var me = this,
            format = Ext.String.format;
        me.control({
            'myapp-quotation-list': {
                'myapp-add': function() {
                    location.href = format('#!/{0}/new', 
                    me.screenName);
                },
                'myapp-edit': function(itemid) {
                    var query = this.requestParams.q;
                    if(query) {
                        location.href = format('#!/{0}/id={1}/q={2}', 
                        me.screenName, itemid, query);
                    } else {
                        location.href = format('#!/{0}/id={1}', 
                        me.screenName, itemid);
                    }
                }
            }
        });</pre></div><p>Looking at<a id="id190" class="indexterm"/> the <code class="literal">requestParams</code> property, we're trying to decide whether or not there is a query. However, this will be configured in the <code class="literal">SearchField</code>, which will be implemented later.</p><p>Change one line of the <code class="literal">onShow</code> method implementation<a id="id191" class="indexterm"/> in the following way:</p><div><pre class="programlisting">me.requestParams = params = o;</pre></div><p>With this, if you double-click or if you click on the <strong>Edit</strong> button, the URL will change. If you check the whole application, when you click on the <strong>Edit</strong> button, you can check the particular screen where data is being read.</p><p>Next, implement the <strong>Delete</strong> button (source file: <code class="literal">06_management_toolbar_buttons_depend_on_grid_selection_status/app/controller/quotation/List.js</code>).</p><div><pre class="programlisting">onItemRemove: function() {
    var me          = this,
        listView    = me.getListView(),
        sm          = listView.getSelectionModel(),
        records     = sm.getSelection();
    Ext.MessageBox.confirm(
        'Remove Confirm',
        'May I delete that?',
        function(ret) {
            if(ret === 'yes') {
                listView.fireEvent('myapp-remove', records);
            }
        }
    );
},</pre></div><p>In terms of structure, it's the same as the <strong>Edit</strong> button. It fires the <code class="literal">myapp-remove</code> event. In the same way, <code class="literal">myapp-remove</code> implements the event handler in <code class="literal">MyApp.controller.quotation.Quotation</code> (source file: <code class="literal">06_management_toolbar_buttons_depend_on_grid_selection_status/app/controller/quotation/Quotation.js</code>).</p><div><pre class="programlisting">onRemove: function(records) {
    var me = this,
        format = Ext.String.format,
        listView = me.getListView(),
        ids = [];
    if(!Ext.isArray(records)) {
        records = [records];
    }
    Ext.iterate(records, function(r) {
        if(r.get) {
            ids.push(r.get('id'));
        } else {
            ids.push(r);
        }
    });
    listView.mask();
    MyAppQuotation.removeItems(ids, function() {
        me.getController(
            format(
                '{0}.List',
                me.screenName.split('-').join('.')
            )
        ).onStoreRefresh();
    listView.unmask();
    });
}</pre></div><p>We are<a id="id192" class="indexterm"/> calling the <code class="literal">direct</code> function called <code class="literal">MyAppQuotation.removeItems</code>. We haven't implemented this method yet. It's for deleting items, so let's do it quickly.</p><p>We're going to add a new <code class="literal">removeItems (len:1)</code> method to the <code class="literal">MyAppQuotation</code> class (source file: <code class="literal">06_management_toolbar_buttons_depend_on_grid_selection_status/php/config.php</code>).</p><p>Let's implement the method we added previously. The code is very long, so please refer to the source files (source file: <code class="literal">06_management_toolbar_buttons_depend_on_grid_selection_status/php/classes/MyAppQuotation.php</code>).</p><p>This method is not for physical deletion but for logic deletion after renewing the status of the <code class="literal">UPDATE</code> text. After you have finished with this process, we would call <code class="literal">onStoreRefresh</code> from the client side; however, it still hasn't been implemented so let's implement it (source file: <code class="literal">06_management_toolbar_buttons_depend_on_grid_selection_status/app/controller/quotation/List.js</code>).</p><div><pre class="programlisting">Ext.define('MyApp.controller.quotation.List', {
    ....
    onStoreRefresh: function() {    },
    ....</pre></div><p>This is actually only executing the toolbar renewal process, but it won't run without the store being configured on the toolbar. So for a final touch, let's set up the store in the toolbar (source file: <code class="literal">06_management_toolbar_buttons_depend_on_grid_selection_status/app/view/quotation/List.js</code>).</p><div><pre class="programlisting">Ext.define('MyApp.view.quotation.List', {
    ....
    initComponent: function() {
        ....
        Ext.apply(me, {
            ....
            bbar: {
                xtype       : 'pagingtoolbar',
                store       : store,
                displayInfo : true 
            }
        ....</pre></div><p>Now, it will automatically execute the reload process after the deletion process. With this we have <a id="id193" class="indexterm"/>implemented the process from start to finish. It was a rather complicated and long journey! For <code class="literal">Bill</code>, please implement it in the same way as with <code class="literal">Quotation</code>, as the process to set it up is mostly the same.</p></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec40"/>Using a search trigger field and a relation URL hash</h1></div></div></div><p>Finally, let's<a id="id194" class="indexterm"/> implement the <code class="literal">SearchField</code> in the top-right corner of the screen. Actually, it is already implemented on the client side.</p><p>When we are calling <code class="literal">getGrid</code> with the <code class="literal">cond</code> argument, the search criteria is being transmitted. That is to say, we just need to implement on the server side. Let's amend this quickly.</p><p>This just shows a section that has been amended. To see the whole section of the source code, please refer to the source files (source file: <code class="literal">07_using_search_trigger_field_and_relation_url_hash/php/classes/MyAppQuotation.php</code>).</p><div><pre class="programlisting">        ....
            'ON',
            '    customers.id = quotation.customer',
            'WHERE',
            '    quotation.status = 1'
        ));
        $query = explode(' ', @$cond-&gt;query);
        foreach($query as $q) {
            if($q != '') {
                $sql .= ' ' . implode(" \n ", array(
                    'AND (',
                    '    customers.name like \'%' . $q . '%\'',
                    '    OR',
                    '    customers.addr1 like \'%' . $q . '%\'',
                    '    OR',
                    '    customers.`addr2` like \'%' . $q . '%\'',
                    '    OR',
                    '    quotation.`note` like \'%' . $q . '%\'',
                    ')'
                ));
            }
        }
        ....</pre></div><p>With <code class="literal">$cond</code>, the following parameters are sent:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">query</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">page</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">start</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">limit</code></li></ul></div><p>The character string<a id="id195" class="indexterm"/> you inputted in the <code class="literal">SearchField</code> is being stored in the query. Afterwards, you just need to take that character string and add new conditions to SQL.</p><p>We won't implement it here, but by applying <code class="literal">page</code>, <code class="literal">start</code>, and <code class="literal">limit</code> to SQL, the paging process will start.</p><p>Again, to set the display order when you click on the column, the sort functionality is added and sent. Using that data, if we add ORDER BY, you can adjust the order.</p><p>So in order to get closer to the real application, have a go at the implementation.</p></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec41"/>Summary</h1></div></div></div><p>Until now we created the data structure, the application architecture, and implemented data sending and data receiving methods. But currently we can only see the data in a grid.</p><p>It's not hard to imagine a situation where a manager in a company wants to see this data in a chart for a report or a presentation. So in the next chapter we'll learn how to design various types of visual charts.</p></div></body></html>