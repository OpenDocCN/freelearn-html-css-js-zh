<html><head></head><body>
<div class="calibre1" id="_idContainer061">
<h1 class="chapternumber"><span class="kobospan" id="kobo.1.1">5</span></h1>
<h1 class="chaptertitle" id="_idParaDest-97"><span class="kobospan" id="kobo.2.1">Handling HTTP Requests</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.3.1">The foundation of server-side web development is the ability to receive HTTP requests from clients and generate responses. </span><span class="kobospan" id="kobo.3.2">In this chapter, I introduce the Node.js API for creating HTTP servers and explain how it can be used to receive and respond to requests. </span><em class="italic"><span class="kobospan" id="kobo.4.1">Table 5.1</span></em><span class="kobospan" id="kobo.5.1"> puts the Node.js HTTP API in context.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.6.1">Table 5.1: Putting the Node.js API in context</span></p>
<table class="table-container" id="table001-2">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.7.1">Question</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.8.1">Answer</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.9.1">What is it?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.10.1">The </span><code class="inlinecode"><span class="kobospan2" id="kobo.11.1">http</span></code><span class="kobospan" id="kobo.12.1"> and </span><code class="inlinecode"><span class="kobospan2" id="kobo.13.1">https</span></code><span class="kobospan4" id="kobo.14.1"> modules contain the functions and classes required to create HTTP and HTTPS servers, receive requests, and generate responses. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.15.1">Why is it useful?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.16.1">Receiving and responding to HTTP requests is the core feature of server-side web application development. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.17.1">How is it used?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.18.1">Servers are created with the </span><code class="inlinecode"><span class="kobospan2" id="kobo.19.1">createServer</span></code><span class="kobospan" id="kobo.20.1"> function, which emits events when requests are received. </span><span class="kobospan4" id="kobo.20.2">Callback functions are invoked to handle the request and generate a response. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.21.1">Are there any pitfalls or limitations?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.22.1">Handler functions can become complex and mix the statements that match requests with the statements that generate responses. </span><span class="kobospan4" id="kobo.22.2">Third-party packages, such as the Express package introduced in this chapter, build on the Node.js API to streamline request handling.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.23.1">Are there any alternatives?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.24.1">No. </span><span class="kobospan" id="kobo.24.2">The Node.js HTTP and HTTPS APIs are integral to server-side web application development. </span><span class="kobospan4" id="kobo.24.3">Third-party packages can make the API easier to use but are built on the same features. </span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.25.1">Table 5.2</span></em><span class="kobospan" id="kobo.26.1"> summarizes the chapter.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.27.1">Table 5.2: Chapter summary</span></p>
<table class="table-container" id="table002-2">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.28.1">Problem</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.29.1">Solution</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.30.1">Listing</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.31.1">Listing for HTTP requests</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.32.1">Use the </span><code class="inlinecode"><span class="kobospan2" id="kobo.33.1">createServer</span></code><span class="kobospan" id="kobo.34.1"> function to create a </span><code class="inlinecode"><span class="kobospan2" id="kobo.35.1">Server</span></code><span class="kobospan" id="kobo.36.1"> object and use the </span><code class="inlinecode"><span class="kobospan2" id="kobo.37.1">listen</span></code><span class="kobospan4" id="kobo.38.1"> method to start listening for requests.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.39.1">4</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.40.1">Inspect an HTTP request</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.41.1">Use the features provided by the </span><code class="inlinecode"><span class="kobospan2" id="kobo.42.1">IncomingRequest</span></code><span class="kobospan4" id="kobo.43.1"> class.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.44.1">5</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.45.1">Parse a request URL</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.46.1">Use the </span><code class="inlinecode"><span class="kobospan2" id="kobo.47.1">URL</span></code><span class="kobospan" id="kobo.48.1"> class in the </span><code class="inlinecode"><span class="kobospan2" id="kobo.49.1">url</span></code><span class="kobospan4" id="kobo.50.1"> module.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.51.1">6</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.52.1">Create an HTTP response</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.53.1">Use the features provided by the </span><code class="inlinecode"><span class="kobospan2" id="kobo.54.1">ServerResponse</span></code><span class="kobospan4" id="kobo.55.1"> class.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.56.1">7</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.57.1">Listen for HTTPS requests</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.58.1">Use the features provided by the </span><code class="inlinecode"><span class="kobospan2" id="kobo.59.1">https</span></code><span class="kobospan4" id="kobo.60.1"> module.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.61.1">8, 9</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.62.1">Detect HTTPS requests </span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.63.1">Check the value of the </span><code class="inlinecode"><span class="kobospan2" id="kobo.64.1">socket.encrypted</span></code><span class="kobospan" id="kobo.65.1"> property on the </span><code class="inlinecode"><span class="kobospan2" id="kobo.66.1">IncomingRequest</span></code><span class="kobospan4" id="kobo.67.1"> object.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.68.1">10</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.69.1">Redirect insecure requests</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.70.1">Send a 302 header to the HTTPS port.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.71.1">11, 12</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.72.1">Simplify request processing</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.73.1">Use a third-party router and enhanced request and response classes.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.74.1">13-19</span></em></p>
</td>
</tr>
</tbody>
</table>
<h1 class="heading" id="_idParaDest-98"><span class="kobospan" id="kobo.75.1">Preparing for this chapter</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.76.1">In this chapter, I continue to use the </span><code class="inlinecode"><span class="kobospan" id="kobo.77.1">webapp</span></code><span class="kobospan" id="kobo.78.1"> project created in </span><em class="italic"><span class="kobospan" id="kobo.79.1">Chapter 4</span></em><span class="kobospan" id="kobo.80.1">. </span><span class="kobospan" id="kobo.80.2">To prepare for this chapter, replace the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.81.1">handler.ts</span></code><span class="kobospan" id="kobo.82.1"> file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.83.1">src</span></code><span class="kobospan" id="kobo.84.1"> folder with the code shown in </span><em class="italic"><span class="kobospan" id="kobo.85.1">Listing 5.1</span></em><span class="kobospan" id="kobo.86.1">.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.87.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.88.1">You can download the example project for this chapter – and for all the other chapters in this book – from </span><a href="https://github.com/PacktPublishing/Mastering-Node.js-Web-Development" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.89.1">https://github.com/PacktPublishing/Mastering-Node.js-Web-Development</span></span></a><span class="kobospan" id="kobo.90.1">. </span><span class="kobospan" id="kobo.90.2">See </span><em class="italic"><span class="kobospan" id="kobo.91.1">Chapter 1</span></em><span class="kobospan" id="kobo.92.1"> to get help if you have problems running the examples.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.93.1">Listing 5.1: Replacing the contents of the handler.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.94.1">import { IncomingMessage, ServerResponse } from "http";
export const handler = async (req: IncomingMessage, resp: ServerResponse) =&gt; {
    resp.end("Hello, World");
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.95.1">Replace the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.96.1">server.ts</span></code><span class="kobospan" id="kobo.97.1"> file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.98.1">src</span></code><span class="kobospan" id="kobo.99.1"> folder with the code shown in </span><em class="italic"><span class="kobospan" id="kobo.100.1">Listing 5.2</span></em><span class="kobospan" id="kobo.101.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.102.1">Listing 5.2: Replacing the contents of the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.103.1">import { createServer } from "http";
import { handler } from "./handler";
const port = 5000;
const server = createServer();
server.on("request", handler);
server.listen(port);
server.on("listening", () =&gt; {
    console.log(`(Event) Server listening on port ${port}`);
});
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.104.1">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.105.1">Listing 5.3</span></em><span class="kobospan" id="kobo.106.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.107.1">webapp</span></code><span class="kobospan" id="kobo.108.1"> folder to start the watcher that compiles TypeScript files and executes the JavaScript that is produced.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.109.1">Listing 5.3: Starting the project</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.110.1">npm start
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.111.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.112.1">server.ts</span></code><span class="kobospan" id="kobo.113.1"> file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.114.1">src</span></code><span class="kobospan" id="kobo.115.1"> folder will be compiled to produce a pure JavaScript file named </span><code class="inlinecode"><span class="kobospan" id="kobo.116.1">server.js</span></code><span class="kobospan" id="kobo.117.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.118.1">dist</span></code><span class="kobospan" id="kobo.119.1"> folder. </span><span class="kobospan" id="kobo.119.2">The JavaScript code will be executed by the Node.js runtime, which will start listening for HTTP requests. </span><span class="kobospan" id="kobo.119.3">Open a web browser and request </span><code class="inlinecode"><span class="kobospan" id="kobo.120.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.121.1"> and you will see the response shown in </span><em class="italic"><span class="kobospan" id="kobo.122.1">Figure 5.1</span></em><span class="kobospan" id="kobo.123.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.124.1"><img alt="" src="../Images/B21959_05_01.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.125.1">Figure 5.1: Running the example project</span></p>
<h1 class="heading" id="_idParaDest-99"><span class="kobospan" id="kobo.126.1">Listening for HTTP requests</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.127.1">In </span><em class="italic"><span class="kobospan" id="kobo.128.1">Chapter 4</span></em><span class="kobospan" id="kobo.129.1">, I created a simple web server so that I could demonstrate the way that JavaScript code is</span><a id="_idIndexMarker245" class="calibre3"/><span class="kobospan" id="kobo.130.1"> executed. </span><span class="kobospan" id="kobo.130.2">In doing so, I skipped over the details of how the code worked, but now it is time to go back and dig into the details.</span></p>
<p class="normal"><span class="kobospan" id="kobo.131.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.132.1">createServer</span></code><span class="kobospan" id="kobo.133.1"> function in the </span><code class="inlinecode"><span class="kobospan" id="kobo.134.1">http</span></code><span class="kobospan" id="kobo.135.1"> module is used to create </span><code class="inlinecode"><span class="kobospan" id="kobo.136.1">Server</span></code><span class="kobospan" id="kobo.137.1"> objects that can be used to listen for and process HTTP requests. </span><span class="kobospan" id="kobo.137.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.138.1">Server</span></code><span class="kobospan" id="kobo.139.1"> object requires configuration before it starts listening for requests and the most useful methods and properties defined by the </span><code class="inlinecode"><span class="kobospan" id="kobo.140.1">Server</span></code><span class="kobospan" id="kobo.141.1"> class are described in </span><em class="italic"><span class="kobospan" id="kobo.142.1">Table 5.3</span></em><span class="kobospan" id="kobo.143.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.144.1">Table 5.3: Useful server methods and properties</span></p>
<table class="table-container" id="table003-2">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.145.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.146.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.147.1">listen(port)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.148.1">This method starts listening for requests on a specified port.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.149.1">close()</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.150.1">This method stops listening for requests. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.151.1">requestTimeout</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.152.1">This property gets or sets the request timeout period, which can also be used using the configuration object passed to the </span><code class="inlinecode"><span class="kobospan2" id="kobo.153.1">createServer</span></code><span class="kobospan4" id="kobo.154.1"> function.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.155.1">Once the </span><code class="inlinecode"><span class="kobospan" id="kobo.156.1">Server</span></code><span class="kobospan" id="kobo.157.1"> object has been configured, it emits events that denote important changes in state. </span><span class="kobospan" id="kobo.157.2">The</span><a id="_idIndexMarker246" class="calibre3"/><span class="kobospan" id="kobo.158.1"> most useful events are </span><a id="_idIndexMarker247" class="calibre3"/><span class="kobospan" id="kobo.159.1">described in </span><em class="italic"><span class="kobospan" id="kobo.160.1">Table 5.4</span></em><span class="kobospan" id="kobo.161.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.162.1">Table 5.4: Useful server events</span></p>
<table class="table-container" id="table004-1">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.163.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.164.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.165.1">listening</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.166.1">This event is triggered when the server starts listening for requests. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.167.1">request</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.168.1">This event is triggered when a new request is received. </span><span class="kobospan4" id="kobo.168.2">The callback function that handles this event is invoked with arguments that represent the HTTP request and response.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.169.1">error</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.170.1">This event is triggered when there is a network error.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.171.1">The use of events to invoke callback functions is typical of the JavaScript code execution model described in </span><em class="italic"><span class="kobospan" id="kobo.172.1">Chapter 4</span></em><span class="kobospan" id="kobo.173.1">. </span><span class="kobospan" id="kobo.173.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.174.1">request</span></code><span class="kobospan" id="kobo.175.1"> event will be triggered each time an HTTP request is received, and the JavaScript execution model means that only one HTTP request will be handled at a time.</span></p>
<p class="normal"><span class="kobospan" id="kobo.176.1">The Node.js API often allows event handlers to be specified through other methods. </span><span class="kobospan" id="kobo.176.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.177.1">createServer</span></code><span class="kobospan" id="kobo.178.1"> function used to create a </span><code class="inlinecode"><span class="kobospan" id="kobo.179.1">Server</span></code><span class="kobospan" id="kobo.180.1"> object accepts an optional function argument that is registered as a handler for the </span><code class="inlinecode"><span class="kobospan" id="kobo.181.1">request</span></code><span class="kobospan" id="kobo.182.1"> event, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.183.1">Server.listen</span></code><span class="kobospan" id="kobo.184.1"> method accepts an optional function argument that is used to handle the </span><code class="inlinecode"><span class="kobospan" id="kobo.185.1">listening</span></code><span class="kobospan" id="kobo.186.1"> event. </span></p>
<p class="normal"><span class="kobospan" id="kobo.187.1">These convenience features can be used to combine the statements that create and configure the HTTP server with the callback functions that handle the events, as shown in </span><em class="italic"><span class="kobospan" id="kobo.188.1">Listing 5.4</span></em><span class="kobospan" id="kobo.189.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.190.1">Listing 5.4: Using the event convenience features in the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="hljs-keyword"><span class="kobospan" id="kobo.191.1">import</span></span><span class="kobospan" id="kobo.192.1"> { createServer } </span><span class="hljs-keyword"><span class="kobospan" id="kobo.193.1">from</span></span> <span class="hljs-string"><span class="kobospan" id="kobo.194.1">"http"</span></span><span class="kobospan" id="kobo.195.1">;
import { handler } from "./handler";
const port = 5000;
</span><strong class="screentext"><span class="kobospan" id="kobo.196.1">const server = createServer(handler);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.197.1">//server.on("request", handler);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.198.1">server.listen(port,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.199.1">    () =&gt; console</span></strong><strong class="screentext"><span class="kobospan" id="kobo.200.1">.log(`(Event) Server listening on port ${port}`));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.201.1">// server.on("listening", () =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.202.1">//     console.log(`(Event) Server listening on port ${port}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.203.1">// });</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.204.1">This code has the </span><a id="_idIndexMarker248" class="calibre3"/><span class="kobospan" id="kobo.205.1">same effect as </span><em class="italic"><span class="kobospan" id="kobo.206.1">Listing 5.2</span></em><span class="kobospan" id="kobo.207.1"> but is more concise and easier to read.</span></p>
<h2 class="heading1" id="_idParaDest-100"><span class="kobospan" id="kobo.208.1">Understanding the Server configuration object</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.209.1">The arguments for the </span><code class="inlinecode"><span class="kobospan" id="kobo.210.1">createServer</span></code><span class="kobospan" id="kobo.211.1"> function are a configuration object and a request-handling function. </span><span class="kobospan" id="kobo.211.2">The </span><a id="_idIndexMarker249" class="calibre3"/><span class="kobospan" id="kobo.212.1">configuration object is used to change the way that requests are received, and the most useful settings are described in </span><em class="italic"><span class="kobospan" id="kobo.213.1">Table 5.5</span></em><span class="kobospan" id="kobo.214.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.215.1">Table 5.5: Useful createServer configuration object settings</span></p>
<table class="table-container" id="table005-1">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.216.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.217.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.218.1">IncomingMessage</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.219.1">This property specifies the class used to represent requests. </span><span class="kobospan" id="kobo.219.2">The default is the </span><code class="inlinecode"><span class="kobospan2" id="kobo.220.1">IncomingMessage</span></code><span class="kobospan" id="kobo.221.1"> class, defined in the </span><code class="inlinecode"><span class="kobospan2" id="kobo.222.1">http</span></code><span class="kobospan4" id="kobo.223.1"> module.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.224.1">ServerResponse</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.225.1">This property specifies the class used to represent responses. </span><span class="kobospan" id="kobo.225.2">The default is the </span><code class="inlinecode"><span class="kobospan2" id="kobo.226.1">ServerResponse</span></code><span class="kobospan" id="kobo.227.1"> class, defined in the </span><code class="inlinecode"><span class="kobospan2" id="kobo.228.1">http</span></code><span class="kobospan4" id="kobo.229.1"> module.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.230.1">requestTimeout</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.231.1">This property specifies the amount of time, in milliseconds, allowed for a client to send requests, after which the request times out. </span><span class="kobospan4" id="kobo.231.2">The default value is 300,000 milliseconds.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.232.1">The configuration object can be omitted if the default values are required. </span><span class="kobospan" id="kobo.232.2">The handler function is invoked when an HTTP request has been received and its parameters are objects whose types are those specified by the </span><code class="inlinecode"><span class="kobospan" id="kobo.233.1">IncomingMessage</span></code><span class="kobospan" id="kobo.234.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.235.1">ServerResponse</span></code><span class="kobospan" id="kobo.236.1"> properties, or the default types if the configuration hasn’t been changed. </span><span class="kobospan" id="kobo.236.2">The code in </span><em class="italic"><span class="kobospan" id="kobo.237.1">Listing 5.4</span></em><span class="kobospan" id="kobo.238.1"> omits the configuration object, which means that the default types will be used to represent the HTTP request </span><a id="_idIndexMarker250" class="calibre3"/><span class="kobospan" id="kobo.239.1">and response when the handler function for the request event is invoked, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.240.1">...
</span><span class="kobospan" id="kobo.240.2">export const handler = async (</span><strong class="screentext"><span class="kobospan" id="kobo.241.1">req: IncomingMessage, resp: ServerResponse</span></strong><span class="kobospan" id="kobo.242.1">) =&gt; {
    resp.end("Hello, World");
};
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.243.1">Later examples in this chapter demonstrate using different types, but the default representations of the HTTP request and response provide all the features needed to process HTTP, as explained in the following sections.</span></p>
<h1 class="heading" id="_idParaDest-101"><span class="kobospan" id="kobo.244.1">Understanding HTTP requests</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.245.1">Node.js represents HTTP requests using the </span><code class="inlinecode"><span class="kobospan" id="kobo.246.1">IncomingMessage</span></code><span class="kobospan" id="kobo.247.1"> class, which is defined in the </span><code class="inlinecode"><span class="kobospan" id="kobo.248.1">http</span></code><span class="kobospan" id="kobo.249.1"> module. </span><span class="kobospan" id="kobo.249.2">The</span><a id="_idIndexMarker251" class="calibre3"/><span class="kobospan" id="kobo.250.1"> four main building blocks of an HTTP request are: </span></p>
<ul class="calibre4">
<li class="bulletlist"><span class="kobospan" id="kobo.251.1">The HTTP method, which describes the operation the client wants to perform.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.252.1">The URL, which identifies the resource the request should be applied to.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.253.1">The headers, which provide additional information about the request and the capabilities of the client.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.254.1">The request body, which provides the data required for the requested operation.</span></li>
</ul>
<p class="normal"><span class="kobospan" id="kobo.255.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.256.1">IncomingMessage</span></code><span class="kobospan" id="kobo.257.1"> class provides </span><a id="_idIndexMarker252" class="calibre3"/><span class="kobospan" id="kobo.258.1">access to all of these building blocks, allowing them to be inspected so the server can generate a suitable response. </span><em class="italic"><span class="kobospan" id="kobo.259.1">Table 5.6</span></em><span class="kobospan" id="kobo.260.1"> lists the properties provided for the first three request building blocks, and I explain how to deal with the request body in </span><em class="italic"><span class="kobospan" id="kobo.261.1">Chapter 6</span></em><span class="kobospan" id="kobo.262.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.263.1">Table 5.6: Useful IncomingMessage properties </span></p>
<table class="table-container" id="table006-1">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.264.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.265.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.266.1">headers</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.267.1">This property returns an </span><code class="inlinecode"><span class="kobospan2" id="kobo.268.1">IncomingHttpHeaders</span></code><span class="kobospan" id="kobo.269.1"> object, which defines properties for common headers and can also be used as a key/value object that maps the names of the headers in the request to the header values. </span><span class="kobospan4" id="kobo.269.2">The headers are normalized, as described below.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.270.1">headersDistinct</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.271.1">This property returns a key/value object that maps the names of the headers in the request to the header values. </span><span class="kobospan4" id="kobo.271.2">The values are normalized, as described below this table.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.272.1">httpVersion</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.273.1">This property returns a </span><code class="inlinecode"><span class="kobospan2" id="kobo.274.1">string</span></code><span class="kobospan4" id="kobo.275.1"> value containing the version of HTTP used in the request. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.276.1">method</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.277.1">This property returns a </span><code class="inlinecode"><span class="kobospan2" id="kobo.278.1">string</span></code><span class="kobospan" id="kobo.279.1"> value containing the HTTP method specified by the request. </span><span class="kobospan" id="kobo.279.2">This value may be </span><code class="inlinecode5"><span class="kobospan2" id="kobo.280.1">undefined.</span></code></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.281.1">url</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.282.1">This property returns a </span><code class="inlinecode"><span class="kobospan2" id="kobo.283.1">string</span></code><span class="kobospan" id="kobo.284.1"> value containing the request URL. </span><span class="kobospan" id="kobo.284.2">This value may be </span><code class="inlinecode"><span class="kobospan2" id="kobo.285.1">undefined</span></code><span class="kobospan4" id="kobo.286.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.287.1">socket</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.288.1">This property returns an object that represents the network socket used to receive the connection, which is useful when detecting HTTPS requests, as demonstrated in the </span><em class="italic"><span class="kobospan2" id="kobo.289.1">Detecting HTTPS requests</span></em><span class="kobospan4" id="kobo.290.1"> section.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.291.1">HTTP headers can be difficult to work </span><a id="_idIndexMarker253" class="calibre3"/><span class="kobospan" id="kobo.292.1">with and the </span><code class="inlinecode"><span class="kobospan" id="kobo.293.1">headers</span></code><span class="kobospan" id="kobo.294.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.295.1">headersDistinct</span></code><span class="kobospan" id="kobo.296.1"> properties normalize headers so that they are easier to use. </span><span class="kobospan" id="kobo.296.2">Some HTTP headers should only appear once in a request, so Node.js removes</span><a id="_idIndexMarker254" class="calibre3"/><span class="kobospan" id="kobo.297.1"> duplicate values. </span><span class="kobospan" id="kobo.297.2">Other headers can have multiple values, and these are concatenated into a single </span><code class="inlinecode"><span class="kobospan" id="kobo.298.1">string</span></code><span class="kobospan" id="kobo.299.1"> value by the </span><code class="inlinecode"><span class="kobospan" id="kobo.300.1">headers</span></code><span class="kobospan" id="kobo.301.1"> property and into an array of strings by the </span><code class="inlinecode"><span class="kobospan" id="kobo.302.1">headersDistinct</span></code><span class="kobospan" id="kobo.303.1"> property. </span><span class="kobospan" id="kobo.303.2">The exception is the </span><code class="inlinecode"><span class="kobospan" id="kobo.304.1">set-cookie</span></code><span class="kobospan" id="kobo.305.1"> header, which is always presented as a </span><code class="inlinecode"><span class="kobospan" id="kobo.306.1">string</span></code><span class="kobospan" id="kobo.307.1"> array. </span><span class="kobospan" id="kobo.307.2">(I describe how cookies are used in detail in </span><em class="italic"><span class="kobospan" id="kobo.308.1">Part 2</span></em><span class="kobospan" id="kobo.309.1">.)</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.310.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.311.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.312.1">IncomingRequest</span></code><span class="kobospan" id="kobo.313.1"> class also defines the </span><code class="inlinecode"><span class="kobospan" id="kobo.314.1">rawHeaders</span></code><span class="kobospan" id="kobo.315.1"> property, which provides access to the headers as they were received, with no normalization. </span><span class="kobospan" id="kobo.315.2">This property can be useful if you need to perform custom normalization, but the </span><code class="inlinecode"><span class="kobospan" id="kobo.316.1">headers</span></code><span class="kobospan" id="kobo.317.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.318.1">headersDistinct</span></code><span class="kobospan" id="kobo.319.1"> properties are more useful for mainstream development projects.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.320.1">As a rule of thumb, the </span><code class="inlinecode"><span class="kobospan" id="kobo.321.1">headers</span></code><span class="kobospan" id="kobo.322.1"> property is more useful for displaying or logging headers, while the </span><code class="inlinecode"><span class="kobospan" id="kobo.323.1">headersDistinct</span></code><span class="kobospan" id="kobo.324.1"> property is more useful when using headers to decide what kind of response to produce. </span><em class="italic"><span class="kobospan" id="kobo.325.1">Listing 5.5</span></em><span class="kobospan" id="kobo.326.1"> updates the example to</span><a id="_idIndexMarker255" class="calibre3"/><span class="kobospan" id="kobo.327.1"> log the details of the request to the Node.js console.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.328.1">Listing 5.5: Logging request details in the handler.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.329.1">import { IncomingMessage, ServerResponse } from "http";
export const handler = async (req: IncomingMessage, resp: ServerResponse) =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.330.1">console.log(`---- HTTP Method: ${req.method}, URL: ${req.url}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.331.1">    console.log(`host: ${req.headers.host}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.332.1">    console</span></strong><strong class="screentext"><span class="kobospan" id="kobo.333.1">.log(`accept: ${req.headers.accept}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.334.1">    console.log(`user-agent: ${req.headers["user-agent"]}`)</span></strong><span class="kobospan" id="kobo.335.1">
    resp.end("Hello, World");
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.336.1">This example writes out the HTTP method, the request URL, and three headers: the </span><code class="inlinecode"><span class="kobospan" id="kobo.337.1">host</span></code><span class="kobospan" id="kobo.338.1"> header, which specifies the hostname and port to which the request was sent; the </span><code class="inlinecode"><span class="kobospan" id="kobo.339.1">accept</span></code><span class="kobospan" id="kobo.340.1"> header, which specifies the formats the client is willing to accept in the response; and the </span><code class="inlinecode"><span class="kobospan" id="kobo.341.1">user-agent</span></code><span class="kobospan" id="kobo.342.1"> header, which identifies the client.</span></p>
<p class="normal"><span class="kobospan" id="kobo.343.1">I used the </span><code class="inlinecode"><span class="kobospan" id="kobo.344.1">headers</span></code><span class="kobospan" id="kobo.345.1"> property in </span><em class="italic"><span class="kobospan" id="kobo.346.1">Listing 5.5</span></em><span class="kobospan" id="kobo.347.1">, which allows me to access headers using properties that correspond to the header name, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.348.1">...
</span><span class="kobospan" id="kobo.348.2">console.log(`host: ${</span><strong class="screentext"><span class="kobospan" id="kobo.349.1">req.headers.host</span></strong><span class="kobospan" id="kobo.350.1">}`);
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.351.1">Not all HTTP header names can be used as JavaScript property names, and there is no property for the </span><code class="inlinecode"><span class="kobospan" id="kobo.352.1">user-agent</span></code><span class="kobospan" id="kobo.353.1"> header because JavaScript property names cannot contain hyphens. </span><span class="kobospan" id="kobo.353.2">Instead, I have to access the </span><code class="inlinecode"><span class="kobospan" id="kobo.354.1">user-agent</span></code><span class="kobospan" id="kobo.355.1"> header by specifying the property name as a string, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.356.1">...
</span><span class="kobospan" id="kobo.356.2">console.log(`user-agent: ${</span><strong class="screentext"><span class="kobospan" id="kobo.357.1">req.headers["user-agent"]</span></strong><span class="kobospan" id="kobo.358.1">}`)
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.359.1">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.360.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.361.1"> and you will see output similar to the following, although you may see different values for the headers (and I have elided </span><a id="_idIndexMarker256" class="calibre3"/><span class="kobospan" id="kobo.362.1">the header values for brevity):</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.363.1">...
</span><span class="kobospan" id="kobo.363.2">---- HTTP Method: GET, URL: /
host: localhost:5000
accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,...
</span><span class="kobospan" id="kobo.363.3">user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (...
</span><span class="kobospan" id="kobo.363.4">---- HTTP Method: GET, URL: /favicon.ico
host: localhost:5000
accept: image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8
user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (...
</span><span class="kobospan" id="kobo.363.5">...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.364.1">This output shows two requests because browsers will often request </span><code class="inlinecode"><span class="kobospan" id="kobo.365.1">/favicon.ico</span></code><span class="kobospan" id="kobo.366.1">, which is used as the icon for the tab. </span><span class="kobospan" id="kobo.366.2">You may not see the </span><code class="inlinecode"><span class="kobospan" id="kobo.367.1">favicon.ico</span></code><span class="kobospan" id="kobo.368.1"> request if you recently used your browser for the examples in the previous chapter, where a </span><code class="inlinecode"><span class="kobospan" id="kobo.369.1">404 Not Found</span></code><span class="kobospan" id="kobo.370.1"> response was produced. </span><span class="kobospan" id="kobo.370.2">You can clear your browser’s cache if you want to see both requests, but it isn’t important for the examples that follow.</span></p>
<h2 class="heading1" id="_idParaDest-102"><span class="kobospan" id="kobo.371.1">Parsing URLs</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.372.1">Node.js provides the </span><code class="inlinecode"><span class="kobospan" id="kobo.373.1">URL</span></code><span class="kobospan" id="kobo.374.1"> class in the </span><code class="inlinecode"><span class="kobospan" id="kobo.375.1">url</span></code><span class="kobospan" id="kobo.376.1"> module to parse URLs into their parts, making it easier to inspect </span><a id="_idIndexMarker257" class="calibre3"/><span class="kobospan" id="kobo.377.1">URLs to make decisions about what kind of response will be sent. </span><span class="kobospan" id="kobo.377.2">URLs are parsed by creating a new </span><code class="inlinecode"><span class="kobospan" id="kobo.378.1">URL</span></code><span class="kobospan" id="kobo.379.1"> object and reading the properties described in </span><em class="italic"><span class="kobospan" id="kobo.380.1">Table 5.7</span></em><span class="kobospan" id="kobo.381.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.382.1">Table 5.7: Useful URL properties</span></p>
<table class="table-container" id="table007">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.383.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.384.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.385.1">hostname</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.386.1">This property returns a </span><code class="inlinecode"><span class="kobospan2" id="kobo.387.1">string</span></code><span class="kobospan4" id="kobo.388.1"> containing the URL hostname component.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.389.1">pathname</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.390.1">This property returns a </span><code class="inlinecode"><span class="kobospan2" id="kobo.391.1">string</span></code><span class="kobospan4" id="kobo.392.1"> containing the URL pathname component.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.393.1">port</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.394.1">This property returns a </span><code class="inlinecode"><span class="kobospan2" id="kobo.395.1">string</span></code><span class="kobospan" id="kobo.396.1"> containing the URL port component. </span><span class="kobospan" id="kobo.396.2">The value will be an empty string if the request has been made to the default port for the URL’s protocol (such as port </span><code class="inlinecode"><span class="kobospan2" id="kobo.397.1">80</span></code><span class="kobospan4" id="kobo.398.1"> for unsecured HTTP requests).</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.399.1">protocol</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.400.1">This property returns a </span><code class="inlinecode"><span class="kobospan2" id="kobo.401.1">string</span></code><span class="kobospan4" id="kobo.402.1"> containing the URL protocol component.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.403.1">search</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.404.1">This property returns a </span><code class="inlinecode"><span class="kobospan2" id="kobo.405.1">string</span></code><span class="kobospan4" id="kobo.406.1"> containing the entire query portion of the URL.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.407.1">searchParams</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.408.1">This property returns a </span><code class="inlinecode"><span class="kobospan2" id="kobo.409.1">URLSeachParams</span></code><span class="kobospan4" id="kobo.410.1"> object that provides key/value access to the query portion of the URL.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.411.1">Listing 5.6</span></em><span class="kobospan" id="kobo.412.1"> creates a new URL object to parse the request URL.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.413.1">Listing 5.6: Parsing a URL in the handler.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.414.1">import { IncomingMessage, ServerResponse } from "http";
import { URL } from "url";
export const handler = async (req: IncomingMessage, resp: ServerResponse) =&gt; {
    console.log(`---- HTTP Method: ${req.method}, URL: ${req.url}`);
    </span><strong class="screentext"><span class="kobospan" id="kobo.415.1">// console.log(`host: ${req.headers.host}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.416.1">    // console.log(`accept: ${req.headers.accept}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.417.1">    // console.log(`user-agent: ${req.headers["user-agent"]}`)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.418.1">    const parsedURL = new </span></strong><strong class="screentext"><span class="kobospan" id="kobo.419.1">URL(req.url ?? </span><span class="kobospan" id="kobo.419.2">"", `http://${req.headers.host}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.420.1">    console.log(`protocol: ${parsedURL.protocol}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.421.1">    console.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.422.1">log(`hostname: ${parsedURL.hostname}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.423.1">    console.log(`port: ${parsedURL.port}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.424.1">    console.log(`pathname: ${parsedURL.pathname}</span></strong><strong class="screentext"><span class="kobospan" id="kobo.425.1">`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.426.1">    parsedURL.searchParams.forEach((val, key) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.427.1">        console.log(`Search param: ${key}: ${val}`)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.428.1">    });</span></strong><span class="kobospan" id="kobo.429.1">
   
    resp.end("Hello, World");
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.430.1">Creating a </span><code class="inlinecode"><span class="kobospan" id="kobo.431.1">URL</span></code><span class="kobospan" id="kobo.432.1"> object to parse a URL requires a little work. </span><span class="kobospan" id="kobo.432.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.433.1">IncomingMessage.url</span></code><span class="kobospan" id="kobo.434.1"> property returns a relative URL, which the </span><code class="inlinecode"><span class="kobospan" id="kobo.435.1">URL</span></code><span class="kobospan" id="kobo.436.1"> class constructor will accept as an</span><a id="_idIndexMarker258" class="calibre3"/><span class="kobospan" id="kobo.437.1"> argument, but only if the base part of the URL (the protocol, hostname, and port) is specified as a second argument. </span><span class="kobospan" id="kobo.437.2">The hostname and port can be obtained from the </span><code class="inlinecode"><span class="kobospan" id="kobo.438.1">host</span></code><span class="kobospan" id="kobo.439.1"> request header, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.440.1">...
</span><span class="kobospan" id="kobo.440.2">const parsedURL = new URL(req.url ?? </span><span class="kobospan" id="kobo.440.3">"", `http://${</span><strong class="screentext"><span class="kobospan" id="kobo.441.1">req.headers.host</span></strong><span class="kobospan" id="kobo.442.1">}`);
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.443.1">The missing piece is the protocol. </span><span class="kobospan" id="kobo.443.2">The example only accepts regular unsecured HTTP requests so I can specify </span><code class="inlinecode"><span class="kobospan" id="kobo.444.1">http</span></code><span class="kobospan" id="kobo.445.1"> as the protocol, safe in the knowledge that it will be correct. </span><span class="kobospan" id="kobo.445.2">I will demonstrate how to determine the protocol properly when I demonstrate the use of HTTPS later in the chapter.</span></p>
<p class="normal"><span class="kobospan" id="kobo.446.1">The properties described in </span><em class="italic"><span class="kobospan" id="kobo.447.1">Table 5.7</span></em><span class="kobospan" id="kobo.448.1"> can be used to inspect the individual parts of the URL once the </span><code class="inlinecode"><span class="kobospan" id="kobo.449.1">URL</span></code><span class="kobospan" id="kobo.450.1"> object has been created, and the example writes out the </span><code class="inlinecode"><span class="kobospan" id="kobo.451.1">protocol</span></code><span class="kobospan" id="kobo.452.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.453.1">hostname</span></code><span class="kobospan" id="kobo.454.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.455.1">port</span></code><span class="kobospan" id="kobo.456.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.457.1">pathname</span></code><span class="kobospan" id="kobo.458.1"> values. </span></p>
<p class="normal"><span class="kobospan" id="kobo.459.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.460.1">URL</span></code><span class="kobospan" id="kobo.461.1"> class parses the query section of the URL and presents it as a set of key/value pairs and these are also written out. </span><span class="kobospan" id="kobo.461.2">Use a browser to request the following URL: </span><code class="inlinecode"><span class="kobospan" id="kobo.462.1">http://localhost:5000/myrequest?first=Bob&amp;last=Smith</span></code></p>
<p class="normal"><span class="kobospan" id="kobo.463.1">This URL has a path and a query, and you will see output similar to the following when the URL is parsed:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.464.1">---- HTTP Method: GET, URL: /myrequest?first=Bob&amp;last=Smith
protocol: http:
hostname: localhost
port: 5000
pathname: /myrequest
Search param: first: Bob
Search param: last: Smith
---- HTTP Method: GET, URL: /favicon.ico
protocol: http:
hostname: localhost
port: 5000
pathname: /favicon.ico
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.465.1">The output shows that the browser has sent a second request, for </span><code class="inlinecode"><span class="kobospan" id="kobo.466.1">/favicon.ico</span></code><span class="kobospan" id="kobo.467.1">, in addition to </span><a id="_idIndexMarker259" class="calibre3"/><span class="kobospan" id="kobo.468.1">the URL that was explicitly requested.</span></p>
<h1 class="heading" id="_idParaDest-103"><span class="kobospan" id="kobo.469.1">Understanding HTTP responses</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.470.1">The purpose of inspecting an</span><a id="_idIndexMarker260" class="calibre3"/><span class="kobospan" id="kobo.471.1"> HTTP request is to determine what kind of response is required. </span><span class="kobospan" id="kobo.471.2">Responses are produced using the features provided by the </span><code class="inlinecode"><span class="kobospan" id="kobo.472.1">ServerResponse</span></code><span class="kobospan" id="kobo.473.1"> class, the most useful of which are described in </span><em class="italic"><span class="kobospan" id="kobo.474.1">Table 5.8</span></em><span class="kobospan" id="kobo.475.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.476.1">Table 5.8: Useful ServerResponse members </span></p>
<table class="table-container" id="table008">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.477.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.478.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.479.1">sendDate</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.480.1">This </span><code class="inlinecode"><span class="kobospan2" id="kobo.481.1">boolean</span></code><span class="kobospan" id="kobo.482.1"> property determines whether Node.js automatically generates the </span><code class="inlinecode"><span class="kobospan2" id="kobo.483.1">Date</span></code><span class="kobospan" id="kobo.484.1"> header and adds it to the response. </span><span class="kobospan" id="kobo.484.2">The default is </span><code class="inlinecode"><span class="kobospan2" id="kobo.485.1">true</span></code><span class="kobospan4" id="kobo.486.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.487.1">setHeader(name, value)</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.488.1">This method sets a response header using the specified name and value.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.489.1">statusCode</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.490.1">This </span><code class="inlinecode"><span class="kobospan2" id="kobo.491.1">number</span></code><span class="kobospan4" id="kobo.492.1"> property is used to set the response status code.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.493.1">statusMessage</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.494.1">This </span><code class="inlinecode"><span class="kobospan2" id="kobo.495.1">string</span></code><span class="kobospan4" id="kobo.496.1"> property is used to set the response status message.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.497.1">writeHead(code, msg, headers)</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.498.1">This method is used to set the status code and, optionally, the status message and response headers. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.499.1">write(data)</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.500.1">This method writes data to the response body, which is expressed as a </span><code class="inlinecode"><span class="kobospan2" id="kobo.501.1">string</span></code><span class="kobospan" id="kobo.502.1"> or a </span><code class="inlinecode"><span class="kobospan2" id="kobo.503.1">Buffer</span></code><span class="kobospan" id="kobo.504.1">. </span><span class="kobospan4" id="kobo.504.2">This method accepts optional arguments that specify the encoding for the data and a callback function that is invoked when the operation is complete.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.505.1">end()</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.506.1">This method tells Node.js that the response is complete and can be sent to the client. </span><span class="kobospan" id="kobo.506.2">The method can be invoked with an optional </span><code class="inlinecode"><span class="kobospan2" id="kobo.507.1">data</span></code><span class="kobospan4" id="kobo.508.1"> argument, which will be added to the response body, an encoding for the data, and a callback function that will be invoked when the response has been sent.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.509.1">The basic approach to generating a response is to set the status code and status message, define any headers that will help the client process the response, write the data</span><a id="_idIndexMarker261" class="calibre3"/><span class="kobospan" id="kobo.510.1"> for the body – if there is one – and then send the response to the client.</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.511.1">Listing 5.7</span></em><span class="kobospan" id="kobo.512.1"> inspects the requests that are received to determine how the features provided by the </span><code class="inlinecode"><span class="kobospan" id="kobo.513.1">ServerResponse</span></code><span class="kobospan" id="kobo.514.1"> class are used to create a response.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.515.1">Listing 5.7: Generating HTTP responses in the handler.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.516.1">import { IncomingMessage, ServerResponse } from "http";
import { URL } from "url";
export const handler = async (req: IncomingMessage, resp: ServerResponse) =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.517.1">const</span></strong><strong class="screentext"><span class="kobospan" id="kobo.518.1"> parsedURL = new URL(req.url ?? </span><span class="kobospan" id="kobo.518.2">"", `http://${req.headers.host}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.519.1">    if (req.method !== "GET" || parsedURL.pathname</span></strong><strong class="screentext"><span class="kobospan" id="kobo.520.1"> == "/favicon.ico") {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.521.1">        resp.writeHead(404, "Not Found");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.522.1">        resp.end();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.523.1">        return;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.524.1">    } else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.525.1">        resp.writeHead(200, "OK"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.526.1">);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.527.1">        if (!parsedURL.searchParams.has("keyword")) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.528.1">            resp.write("Hello, HTTP");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.529.1">        } else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.530.1">            resp.write(`Hello, ${parsedURL.searchParams.get("keyword"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.531.1">)}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.532.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.533.1">        resp.end();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.534.1">        return;       </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.535.1">    }</span></strong><span class="kobospan" id="kobo.536.1">
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.537.1">This example generates three different responses. </span><span class="kobospan" id="kobo.537.2">For requests that don’t specify the HTTP GET method or request </span><code class="inlinecode"><span class="kobospan" id="kobo.538.1">/favicon.ico</span></code><span class="kobospan" id="kobo.539.1">, the status code is set to 404, which tells the browser the requested resource doesn’t exist, the human-readable status message is set to </span><code class="inlinecode"><span class="kobospan" id="kobo.540.1">Not Found</span></code><span class="kobospan" id="kobo.541.1">, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.542.1">end</span></code><span class="kobospan" id="kobo.543.1"> method is called to complete the request.</span></p>
<p class="normal"><span class="kobospan" id="kobo.544.1">For all other requests, the status code is set to 200, indicating a successful response and the status message is set to </span><code class="inlinecode"><span class="kobospan" id="kobo.545.1">OK</span></code><span class="kobospan" id="kobo.546.1">. </span><span class="kobospan" id="kobo.546.2">The query component of the request URL is checked to see if there is a </span><code class="inlinecode"><span class="kobospan" id="kobo.547.1">keyword</span></code><span class="kobospan" id="kobo.548.1"> parameter and, if there is, the value is included in the response body.</span></p>
<p class="normal"><span class="kobospan" id="kobo.549.1">Notice that I use the </span><code class="inlinecode"><span class="kobospan" id="kobo.550.1">return</span></code><span class="kobospan" id="kobo.551.1"> keyword after calling the </span><code class="inlinecode"><span class="kobospan" id="kobo.552.1">end</span></code><span class="kobospan" id="kobo.553.1"> method. </span><span class="kobospan" id="kobo.553.2">This is not a requirement, but it is an error to set headers or write data after the </span><code class="inlinecode"><span class="kobospan" id="kobo.554.1">end</span></code><span class="kobospan" id="kobo.555.1"> method has been called, and</span><a id="_idIndexMarker262" class="calibre3"/><span class="kobospan" id="kobo.556.1"> explicitly returning from the function avoids this problem.</span></p>
<p class="normal"><span class="kobospan" id="kobo.557.1">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.558.1">http://localhost:5000/favicon.ico</span></code><span class="kobospan" id="kobo.559.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.560.1">http://localhost:5000?keyword=World</span></code><span class="kobospan" id="kobo.561.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.562.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.563.1"> and you will see the responses shown in </span><em class="italic"><span class="kobospan" id="kobo.564.1">Figure 5.2</span></em><span class="kobospan" id="kobo.565.1">. </span><span class="kobospan" id="kobo.565.2">(The browser usually requests the </span><code class="inlinecode"><span class="kobospan" id="kobo.566.1">favicon.ico</span></code><span class="kobospan" id="kobo.567.1"> file behind the scenes, but requesting it explicitly makes it easier to see the </span><code class="inlinecode"><span class="kobospan" id="kobo.568.1">HTTP 404</span></code><span class="kobospan" id="kobo.569.1"> response.)</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.570.1"><img alt="" src="../Images/B21959_05_02.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.571.1">Figure 5.2: Generating HTTP responses</span></p>
<h1 class="heading" id="_idParaDest-104"><span class="kobospan" id="kobo.572.1">Supporting HTTPS requests</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.573.1">Most web applications use HTTPS, where HTTP requests are sent over an encrypted network connection using the TLS/SSL protocol. </span><span class="kobospan" id="kobo.573.2">Using HTTPS ensures that the request and response cannot be inspected as they traverse public networks.</span></p>
<p class="normal"><span class="kobospan" id="kobo.574.1">Supporting SSL requires a </span><a id="_idIndexMarker263" class="calibre3"/><span class="kobospan" id="kobo.575.1">certificate that establishes the identity of the server and is used as the basis for the encryption that secures HTTPS requests. </span><span class="kobospan" id="kobo.575.2">For this chapter, I am going to use a self-signed certificate, which is sufficient for development and testing, but should not be used for deployment. </span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.576.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.577.1">See </span><a href="https://letsencrypt.org" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.578.1">https://letsencrypt.org</span></span></a><span class="kobospan" id="kobo.579.1"> if you want a certificate for deployment. </span><span class="kobospan" id="kobo.579.2">The Let’s Encrypt service is supported by a non-profit organization and offers free certificates suitable for use with HTTPS.</span></p>
</div>
<h2 class="heading1" id="_idParaDest-105"><span class="kobospan" id="kobo.580.1">Creating the self-signed certificate</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.581.1">The easiest way to</span><a id="_idIndexMarker264" class="calibre3"/><span class="kobospan" id="kobo.582.1"> create a self-signed certificate is to use the OpenSSL package, which is an open-source </span><a id="_idIndexMarker265" class="calibre3"/><span class="kobospan" id="kobo.583.1">toolkit for security-related tasks. </span><span class="kobospan" id="kobo.583.2">The OpenSSL project can be found at </span><a href="https://www.openssl.org" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.584.1">https://www.openssl.org</span></span></a><span class="kobospan" id="kobo.585.1"> and OpenSSL is part of many popular Linux distributions. </span><span class="kobospan" id="kobo.585.2">A list of binaries and installers, including installers for Windows, can be found at </span><a href="https://wiki.openssl.org/index.php/binaries" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.586.1">https://wiki.openssl.org/index.php/binaries</span></span></a><span class="kobospan" id="kobo.587.1">. </span></p>
<p class="normal"><span class="kobospan" id="kobo.588.1">Alternatively, the Git client includes OpenSSL in the </span><code class="inlinecode"><span class="kobospan" id="kobo.589.1">usr/bin</span></code><span class="kobospan" id="kobo.590.1"> folder (</span><code class="inlinecode"><span class="kobospan" id="kobo.591.1">C:\Program Files\Git\usr\bin</span></code><span class="kobospan" id="kobo.592.1"> on Windows), which can be used to create self-signed certificates without needing to install the OpenSSL package.</span></p>
<p class="normal"><span class="kobospan" id="kobo.593.1">Ensure that the OpenSSL executable is in your command prompt path and run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.594.1">Listing 5.8</span></em><span class="kobospan" id="kobo.595.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.596.1">webapp</span></code><span class="kobospan" id="kobo.597.1"> folder, entering the entire command on one line.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.598.1">Listing 5.8: Generating a self-signed certificate</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.599.1">openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -sha256 -days 3650 -nodes
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.600.1">This command </span><a id="_idIndexMarker266" class="calibre3"/><span class="kobospan" id="kobo.601.1">prompts for the details that will be included in the certificate. </span><span class="kobospan" id="kobo.601.2">Press the </span><em class="italic"><span class="kobospan" id="kobo.602.1">Enter</span></em><span class="kobospan" id="kobo.603.1"> key to select</span><a id="_idIndexMarker267" class="calibre3"/><span class="kobospan" id="kobo.604.1"> the default value for each option:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.605.1">...
</span><span class="kobospan" id="kobo.605.2">Country Name (2 letter code) [AU]:
State or Province Name (full name) [Some-State]:
Locality Name (eg, city) []:
Organization Name (eg, company) [Internet Widgits Pty Ltd]:
Organizational Unit Name (eg, section) []:
Common Name (e.g. </span><span class="kobospan" id="kobo.605.3">server FQDN or YOUR name) []:
Email Address []:
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.606.1">The details don’t matter because the certificate will be used only for development. </span><span class="kobospan" id="kobo.606.2">When the command completes, there will be two new files in the </span><code class="inlinecode"><span class="kobospan" id="kobo.607.1">webapp</span></code><span class="kobospan" id="kobo.608.1"> folder: the </span><code class="inlinecode"><span class="kobospan" id="kobo.609.1">cert.pem</span></code><span class="kobospan" id="kobo.610.1"> file (which contains the self-signed certificate) and the </span><code class="inlinecode"><span class="kobospan" id="kobo.611.1">key.pem</span></code><span class="kobospan" id="kobo.612.1"> file (which contains the private key for the certificate).</span></p>
<h2 class="heading1" id="_idParaDest-106"><span class="kobospan" id="kobo.613.1">Handling HTTPS requests</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.614.1">The next step is to use the </span><a id="_idIndexMarker268" class="calibre3"/><span class="kobospan" id="kobo.615.1">API provided by Node.js to receive HTTPS requests, as shown in </span><em class="italic"><span class="kobospan" id="kobo.616.1">Listing 5.9</span></em><span class="kobospan" id="kobo.617.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.618.1">Listing 5.9: Handling HTTPS requests in the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.619.1">import { createServer } from "http";
import { handler } from "./handler";
</span><strong class="screentext"><span class="kobospan" id="kobo.620.1">import { createServer as createHttpsServer } from "https";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.621.1">import { readFileSync } from</span></strong><strong class="screentext"><span class="kobospan" id="kobo.622.1"> "fs";</span></strong><span class="kobospan" id="kobo.623.1">
const port = 5000;
</span><strong class="screentext"><span class="kobospan" id="kobo.624.1">const https_port = 5500;</span></strong><span class="kobospan" id="kobo.625.1">
const server = createServer(handler);
server.listen(port,
    () =&gt; console.log(`(Event) Server listening on port ${port}`));
</span><strong class="screentext"><span class="kobospan" id="kobo.626.1">const httpsConfig = {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.627.1">    key: readFileSync("key.pem"),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.628.1">    cert: readFileSync</span></strong><strong class="screentext"><span class="kobospan" id="kobo.629.1">("cert.pem")</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.630.1">};   </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.631.1">const httpsServer = createHttpsServer(httpsConfig, handler);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.632.1">httpsServer.listen(https_port,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.633.1">    () =&gt; console.log(`HTTPS Server listening on port ${https_port}</span></strong><strong class="screentext"><span class="kobospan" id="kobo.634.1">`));</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.635.1">The process for receiving </span><a id="_idIndexMarker269" class="calibre3"/><span class="kobospan" id="kobo.636.1">HTTPS requests is similar to regular HTTP, to the extent that the function for creating an HTTPS server is named </span><code class="inlinecode"><span class="kobospan" id="kobo.637.1">createServer</span></code><span class="kobospan" id="kobo.638.1">, which is the same name used for HTTP. </span><span class="kobospan" id="kobo.638.2">To use both versions of the </span><code class="inlinecode"><span class="kobospan" id="kobo.639.1">createServer</span></code><span class="kobospan" id="kobo.640.1"> function in the same code file, I have used an alias in the </span><code class="inlinecode"><span class="kobospan" id="kobo.641.1">import</span></code><span class="kobospan" id="kobo.642.1"> statement, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.643.1">...
</span><span class="kobospan" id="kobo.643.2">import { createServer </span><strong class="screentext"><span class="kobospan" id="kobo.644.1">as createHttpsServer</span></strong><span class="kobospan" id="kobo.645.1"> } from "https";
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.646.1">This statement imports the </span><code class="inlinecode"><span class="kobospan" id="kobo.647.1">createServer</span></code><span class="kobospan" id="kobo.648.1"> function from the </span><code class="inlinecode"><span class="kobospan" id="kobo.649.1">https</span></code><span class="kobospan" id="kobo.650.1"> module and the </span><code class="inlinecode"><span class="kobospan" id="kobo.651.1">as</span></code><span class="kobospan" id="kobo.652.1"> keyword is used to assign a name that doesn’t conflict with other imports. </span><span class="kobospan" id="kobo.652.2">In this case, the name I have chosen is </span><code class="inlinecode"><span class="kobospan" id="kobo.653.1">createHttpsServer</span></code><span class="kobospan" id="kobo.654.1">.</span></p>
<p class="normal"><span class="kobospan" id="kobo.655.1">A configuration object is required to specify the certificate files that were created in the previous section with properties named </span><code class="inlinecode"><span class="kobospan" id="kobo.656.1">key</span></code><span class="kobospan" id="kobo.657.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.658.1">cert</span></code><span class="kobospan" id="kobo.659.1">: </span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.660.1">...
</span><span class="kobospan" id="kobo.660.2">const httpsConfig = {
    </span><strong class="screentext"><span class="kobospan" id="kobo.661.1">key</span></strong><span class="kobospan" id="kobo.662.1">: readFileSync("key.pem"),
    </span><strong class="screentext"><span class="kobospan" id="kobo.663.1">cert</span></strong><span class="kobospan" id="kobo.664.1">: readFileSync("cert.pem")
};
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.665.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.666.1">key</span></code><span class="kobospan" id="kobo.667.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.668.1">cert</span></code><span class="kobospan" id="kobo.669.1"> properties can be assigned </span><code class="inlinecode"><span class="kobospan" id="kobo.670.1">string</span></code><span class="kobospan" id="kobo.671.1"> or </span><code class="inlinecode"><span class="kobospan" id="kobo.672.1">Buffer</span></code><span class="kobospan" id="kobo.673.1"> values. </span><span class="kobospan" id="kobo.673.2">I use the </span><code class="inlinecode"><span class="kobospan" id="kobo.674.1">readFileSync</span></code><span class="kobospan" id="kobo.675.1"> functions from the </span><code class="inlinecode"><span class="kobospan" id="kobo.676.1">fs</span></code><span class="kobospan" id="kobo.677.1"> module to read the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.678.1">key.pem</span></code><span class="kobospan" id="kobo.679.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.680.1">cert.pem</span></code><span class="kobospan" id="kobo.681.1"> files, which produces </span><code class="inlinecode"><span class="kobospan" id="kobo.682.1">Buffer</span></code><span class="kobospan" id="kobo.683.1"> values that contain byte arrays.</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.684.1">Understanding synchronous file reads</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.685.1">In </span><em class="italic"><span class="kobospan" id="kobo.686.1">Chapter 4</span></em><span class="kobospan" id="kobo.687.1">, I explained that it can make sense to use blocking operations when you know that there is no other work to be performed by the main thread. </span><span class="kobospan" id="kobo.687.2">In this case, I need to read the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.688.1">key.pem</span></code><span class="kobospan" id="kobo.689.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.690.1">cert.pem</span></code><span class="kobospan" id="kobo.691.1"> files as part of the application startup. </span><span class="kobospan" id="kobo.691.2">There is little benefit to using a callback or a promise because I need the contents of those files to configure Node.js to listen for HTTPS requests and using non-blocking operations produces code like this:</span></p>
<pre class="programlisting2"><code class="hljs-code"><code class="inlinecode2"><span class="kobospan" id="kobo.692.1">...</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.693.1">readFile("key.pem", (err, keyBuffer) =&gt; {</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.694.1">    readFile("cert.pem", (err, certBuffer) =&gt; {</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.695.1">        const server = createServer(handler);</span></code>
<code class="inlinecode2"> </code>
<code class="inlinecode2"><span class="kobospan" id="kobo.696.1">        server.listen(port,</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.697.1">            () =&gt; console.log(`HTTP Server listening on port ${port}`));</span></code>
<code class="inlinecode2"> </code>
<code class="inlinecode2"><span class="kobospan" id="kobo.698.1">        const httpsServer = createHttpsServer({</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.699.1">            key: keyBuffer, cert: certBuffer           </span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.700.1">        }, handler);</span></code>
<code class="inlinecode2"> </code>
<code class="inlinecode2"><span class="kobospan" id="kobo.701.1">        httpsServer.listen(https_port,</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.702.1">            () =&gt; console.log(</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.703.1">                `HTTPS Server listening on port ${https_port}`));       </span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.704.1">    });</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.705.1">});</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.706.1">...</span></code>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.707.1">This code shows you </span><em class="italic"><span class="kobospan" id="kobo.708.1">can</span></em><span class="kobospan" id="kobo.709.1"> read the files using the non-blocking </span><code class="inlinecode"><span class="kobospan" id="kobo.710.1">readFile</span></code><span class="kobospan" id="kobo.711.1"> function, but the nested callbacks are harder to make sense of. </span><span class="kobospan" id="kobo.711.2">Promises don’t help either because the </span><code class="inlinecode"><span class="kobospan" id="kobo.712.1">await</span></code><span class="kobospan" id="kobo.713.1"> keyword can only be used within functions, which means the </span><code class="inlinecode"><span class="kobospan" id="kobo.714.1">then</span></code><span class="kobospan" id="kobo.715.1"> syntax demonstrated in </span><em class="italic"><span class="kobospan" id="kobo.716.1">Chapter 4</span></em><span class="kobospan" id="kobo.717.1"> must be used.</span></p>
<p class="normal"><span class="kobospan" id="kobo.718.1">It is important to avoid blocking the main thread in almost every situation, but there are a few occasions when it doesn’t matter, and non-blocking features are less useful.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.719.1">There are many </span><a id="_idIndexMarker270" class="calibre3"/><span class="kobospan" id="kobo.720.1">configuration options available, described at </span><a href="https://nodejs.org/dist/latest-v20.x/docs/api/https.html#httpscreateserveroptions-requestlistener" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.721.1">https://nodejs.org/dist/latest-v20.x/docs/api/https.html#httpscreateserveroptions-requestlistener</span></span></a><span class="kobospan" id="kobo.722.1">, but the </span><code class="inlinecode"><span class="kobospan" id="kobo.723.1">key</span></code><span class="kobospan" id="kobo.724.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.725.1">cert</span></code><span class="kobospan" id="kobo.726.1"> options are enough to get started. </span><span class="kobospan" id="kobo.726.2">The configuration object is passed to the </span><code class="inlinecode"><span class="kobospan" id="kobo.727.1">createServer</span></code><span class="kobospan" id="kobo.728.1"> function, which I have aliased as </span><code class="inlinecode"><span class="kobospan" id="kobo.729.1">createHttpsServer</span></code><span class="kobospan" id="kobo.730.1"> in this example, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.731.1">listen</span></code><span class="kobospan" id="kobo.732.1"> method is called on the result to start listening for HTTPS requests:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.733.1">...
</span><span class="kobospan" id="kobo.733.2">const httpsServer = </span><strong class="screentext"><span class="kobospan" id="kobo.734.1">createHttpsServer</span></strong><span class="kobospan" id="kobo.735.1">(httpsConfig, handler);
httpsServer.</span><strong class="screentext"><span class="kobospan" id="kobo.736.1">listen</span></strong><span class="kobospan" id="kobo.737.1">(https_port,
    () =&gt; console.log(`HTTPS Server listening on port ${https_port}`));
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.738.1">Open a web browser and request </span><code class="inlinecode"><span class="kobospan" id="kobo.739.1">https://localhost:5500</span></code><span class="kobospan" id="kobo.740.1">, which will send an HTTPS request to the port on which Node.js has been configured to listen. </span><span class="kobospan" id="kobo.740.2">Browsers will display warnings for self-signed certificates, and you will typically have to confirm you want to proceed, as shown in </span><em class="italic"><span class="kobospan" id="kobo.741.1">Figure 5.3</span></em><span class="kobospan" id="kobo.742.1">, which shows the warning presented by Chrome.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.743.1"><img alt="" src="../Images/B21959_05_03.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.744.1">Figure 5.3: Accepting a self-signed certificate</span></p>
<p class="normal"><span class="kobospan" id="kobo.745.1">Node.js is still listening for regular HTTP requests on port </span><code class="inlinecode"><span class="kobospan" id="kobo.746.1">5000</span></code><span class="kobospan" id="kobo.747.1">, which you can confirm by requesting </span><code class="inlinecode"><span class="kobospan" id="kobo.748.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.749.1">.</span></p>
<h2 class="heading1" id="_idParaDest-107"><span class="kobospan" id="kobo.750.1">Detecting HTTPS requests</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.751.1">The Node.js API uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.752.1">IncomingMessage</span></code><span class="kobospan" id="kobo.753.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.754.1">ServerResponse</span></code><span class="kobospan" id="kobo.755.1"> classes for both HTTP and HTTPS requests, which means that the same handler function can be used for both request types. </span><span class="kobospan" id="kobo.755.2">However, it can </span><a id="_idIndexMarker271" class="calibre3"/><span class="kobospan" id="kobo.756.1">be useful to know which kind of request is being processed so that different responses can be generated, as shown in </span><em class="italic"><span class="kobospan" id="kobo.757.1">Listing 5.10</span></em><span class="kobospan" id="kobo.758.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.759.1">Listing 5.10: Detecting HTTPS requests in the handler.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.760.1">import { IncomingMessage, ServerResponse } from "http";
</span><strong class="screentext"><span class="kobospan" id="kobo.761.1">import { TLSSocket } from "tls";</span></strong><span class="kobospan" id="kobo.762.1">
import { URL } from "url";
</span><strong class="screentext"><span class="kobospan" id="kobo.763.1">export const isHttps = (req: IncomingMessage) : boolean =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.764.1">    return req.socket instanceof TLSSocket</span></strong><strong class="screentext"><span class="kobospan" id="kobo.765.1"> &amp;&amp; req.socket.encrypted;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.766.1">}</span></strong><span class="kobospan" id="kobo.767.1">
export const handler = (req: IncomingMessage, resp: ServerResponse) =&gt; {
</span><strong class="screentext"><span class="kobospan" id="kobo.768.1">    const protocol = isHttps(req) ? </span><span class="kobospan" id="kobo.768.2">"https" : "http"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.769.1">;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.770.1">    const parsedURL =</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.771.1">        new URL(req.url ?? </span><span class="kobospan" id="kobo.771.2">"", `${protocol}://${req.headers.host}`);</span></strong><span class="kobospan" id="kobo.772.1">
    if (req.method !== "GET" || parsedURL.pathname == "/favicon.ico") {
        resp.writeHead(404, "Not Found");
        resp.end();
        return;
    } else {
        resp.writeHead(200, "OK");
        if (!parsedURL.searchParams.has("keyword")) {
            </span><strong class="screentext"><span class="kobospan" id="kobo.773.1">resp.write(`Hello, ${protocol.toUpperCase()}`);</span></strong><span class="kobospan" id="kobo.774.1">
        } else {
            resp.write(`Hello, ${parsedURL.searchParams.get("keyword")}`);           
        }
        resp.end();
        return;       
    }
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.775.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.776.1">socket</span></code><span class="kobospan" id="kobo.777.1"> property defined by the </span><code class="inlinecode"><span class="kobospan" id="kobo.778.1">IncomingMessage</span></code><span class="kobospan" id="kobo.779.1"> class will return an instance of the </span><code class="inlinecode"><span class="kobospan" id="kobo.780.1">TLSSocket</span></code><span class="kobospan" id="kobo.781.1"> class for secure requests and this class defines an </span><code class="inlinecode"><span class="kobospan" id="kobo.782.1">encrypted</span></code><span class="kobospan" id="kobo.783.1"> property that always returns </span><code class="inlinecode"><span class="kobospan" id="kobo.784.1">true</span></code><span class="kobospan" id="kobo.785.1">. </span><span class="kobospan" id="kobo.785.2">Checking if this property exists allows HTTPS and HTTP </span><a id="_idIndexMarker272" class="calibre3"/><span class="kobospan" id="kobo.786.1">connections to be identified so that different responses can be produced.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.787.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.788.1">A common deployment pattern for Node.js is to use a proxy that receives HTTPS requests from clients and fans them out to Node.js servers using plain HTTP. </span><span class="kobospan" id="kobo.788.2">In this situation, you can usually check the </span><code class="inlinecode"><span class="kobospan" id="kobo.789.1">X-Forwarded-Proto</span></code><span class="kobospan" id="kobo.790.1"> request header, which proxies use to pass on details of the encryption used by the client. </span><span class="kobospan" id="kobo.790.2">See </span><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Proto" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.791.1">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Proto</span></span></a><span class="kobospan" id="kobo.792.1"> for details.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.793.1">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.794.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.795.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.796.1">https://localhost:5500</span></code><span class="kobospan" id="kobo.797.1"> and you will see the responses shown in </span><em class="italic"><span class="kobospan" id="kobo.798.1">Figure 5.4</span></em><span class="kobospan" id="kobo.799.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.800.1"><img alt="" src="../Images/B21959_05_04.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.801.1">Figure 5.4: Identifying HTTPS requests</span></p>
<h2 class="heading1" id="_idParaDest-108"><span class="kobospan" id="kobo.802.1">Redirecting insecure requests</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.803.1">HTTPS has become the preferred </span><a id="_idIndexMarker273" class="calibre3"/><span class="kobospan" id="kobo.804.1">way to offer web functionality and it is common practice to respond to regular HTTP requests with a response that directs the client to use HTTPS instead, as shown in </span><em class="italic"><span class="kobospan" id="kobo.805.1">Listing 5.11</span></em><span class="kobospan" id="kobo.806.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.807.1">Listing 5.11: Redirecting HTTP requests in the handler.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.808.1">import { IncomingMessage, ServerResponse } from "http";
import { TLSSocket } from "tls";
import { URL } from "url";
</span><strong class="screentext"><span class="kobospan" id="kobo.809.1">export const isHttps = (req: IncomingMessage) : boolean</span></strong><strong class="screentext"><span class="kobospan" id="kobo.810.1"> =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.811.1">    return req.socket instanceof TLSSocket &amp;&amp; req.socket.encrypted;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.812.1">}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.813.1">export const redirectionHandler</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.814.1">        = (</span></strong><strong class="screentext"><span class="kobospan" id="kobo.815.1">req: IncomingMessage, resp: ServerResponse) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.816.1">    resp.writeHead(302, {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.817.1">        "Location": "https://localhost:5500"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.818.1">    });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.819.1">    resp.end();</span></strong><span class="kobospan" id="kobo.820.1">
}
export const handler = (req: IncomingMessage, resp: ServerResponse) =&gt; {
    // ...statements omitted for brevity...
</span><span class="kobospan" id="kobo.820.2">};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.821.1">The new handler uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.822.1">writeHead</span></code><span class="kobospan" id="kobo.823.1"> method to set the status code to </span><code class="inlinecode"><span class="kobospan" id="kobo.824.1">302</span></code><span class="kobospan" id="kobo.825.1">, which denotes a</span><a id="_idIndexMarker274" class="calibre3"/><span class="kobospan" id="kobo.826.1"> redirection, and sets the </span><code class="inlinecode"><span class="kobospan" id="kobo.827.1">Location</span></code><span class="kobospan" id="kobo.828.1"> header, which specifies the URL the browser should request instead. </span><em class="italic"><span class="kobospan" id="kobo.829.1">Listing 5.12</span></em><span class="kobospan" id="kobo.830.1"> applies the new handler so that it is used to generate responses for all HTTP requests.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.831.1">Listing 5.12: Applying a handler in the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.832.1">import { createServer } from "http";
</span><strong class="screentext"><span class="kobospan" id="kobo.833.1">import { handler, redirectionHandler } from</span></strong><strong class="screentext"><span class="kobospan" id="kobo.834.1"> "./handler";</span></strong><span class="kobospan" id="kobo.835.1">
import { createServer as createHttpsServer } from "https";
import { readFileSync } from "fs";
const port = 5000;
const https_port = 5500;
</span><strong class="screentext"><span class="kobospan" id="kobo.836.1">const server = createServer(redirectionHandler);</span></strong><span class="kobospan" id="kobo.837.1">
server.listen(port,
    () =&gt; console.log(`(Event) Server listening on port ${port}`));
const httpsConfig = {
    key: readFileSync("key.pem"),
    cert: readFileSync("cert.pem")
};   
const httpsServer = createHttpsServer(httpsConfig, handler);
httpsServer.listen(https_port,
    () =&gt; console.log(`HTTPS Server listening on port ${https_port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.838.1">If you use the browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.839.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.840.1">, the response sent by the new handler will cause the browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.841.1">https://localhost:5500</span></code><span class="kobospan" id="kobo.842.1">. </span><span class="kobospan" id="kobo.842.2">If you examine the network connections made by the browser in the </span><em class="italic"><span class="kobospan" id="kobo.843.1">F12</span></em><span class="kobospan" id="kobo.844.1"> developer tools window, you will see the redirection response and the </span><a id="_idIndexMarker275" class="calibre3"/><span class="kobospan" id="kobo.845.1">subsequent </span><a id="_idIndexMarker276" class="calibre3"/><span class="kobospan" id="kobo.846.1">HTTPS request, as shown in </span><em class="italic"><span class="kobospan" id="kobo.847.1">Figure 5.5</span></em><span class="kobospan" id="kobo.848.1">.</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.849.1">Using HTTP Strict Transport Security (HSTS)</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.850.1">Redirecting HTTP requests to an HTTPS URL means that the initial communication between the client and server is unencrypted, which presents the potential for the HTTP request to be hijacked by a man-in-the-middle attack that redirects clients to a malicious URL instead. </span><span class="kobospan" id="kobo.850.2">The </span><strong class="screentext"><span class="kobospan" id="kobo.851.1">HTTP Strict Transport Security</span></strong><span class="kobospan" id="kobo.852.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.853.1">HSTS</span></strong><span class="kobospan" id="kobo.854.1">) header can be used to tell browsers not to only use HTTPS requests for a domain. </span><span class="kobospan" id="kobo.854.2">See </span><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.855.1">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security</span></span></a><span class="kobospan" id="kobo.856.1"> for details. </span></p>
</div>
<figure class="mediaobject"><span class="kobospan" id="kobo.857.1"><img alt="" src="../Images/B21959_05_05.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.858.1">Figure 5.5: Redirecting HTTP requests</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.859.1">Understanding HTTP/2</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.860.1">All the examples in this chapter use HTTP/1.1, which tends to be the default for Node.js web application development. </span></p>
<p class="normal"><span class="kobospan" id="kobo.861.1">HTTP/2 is an update to the HTTP protocol that is intended to improve performance. </span><span class="kobospan" id="kobo.861.2">HTTP/2 uses a single network connection to interleave multiple requests from the client, sends headers in a compact binary format, and allows the server to “push” content to the client before it is requested. </span><span class="kobospan" id="kobo.861.3">Node.js provides support for HTTP/2 in the </span><code class="inlinecode"><span class="kobospan" id="kobo.862.1">http2</span></code><span class="kobospan" id="kobo.863.1"> module and even includes a compatibility API that uses the approach shown in this chapter to handle HTTP/1.1 and HTTP/2 requests with the same code. </span><span class="kobospan" id="kobo.863.2">(See </span><a href="https://nodejs.org/dist/latest-v20.x/docs/api/http2.html" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.864.1">https://nodejs.org/dist/latest-v20.x/docs/api/http2.html</span></span></a><span class="kobospan" id="kobo.865.1"> for details.)</span></p>
</div>
<div class="note">
<p class="normal"><span class="kobospan" id="kobo.866.1">But HTTP/2 isn’t an automatic choice for Node.js projects, even though it is more efficient. </span><span class="kobospan" id="kobo.866.2">That’s because HTTP/2 benefits applications that have a large volume of requests, and applications of that size use a proxy to receive requests and fan them out to multiple Node.js servers. </span><span class="kobospan" id="kobo.866.3">The proxy receives HTTP/2 requests from clients but communicates with Node.js using HTTP/1.1 requests because the HTTP/2 features don’t have much impact inside the data center. </span><span class="kobospan" id="kobo.866.4">You can see an example of this type of deployment in </span><em class="italic"><span class="kobospan" id="kobo.867.1">Part 3</span></em><span class="kobospan" id="kobo.868.1"> of this book.</span></p>
<p class="normal"><span class="kobospan" id="kobo.869.1">For applications that don’t use a proxy, the volume of requests is small enough that the efficiencies of HTTP/2 don’t justify the additional complexity that HTTP/2 adds to development, such as requiring encryption for all requests.</span></p>
<p class="normal"><span class="kobospan" id="kobo.870.1">Most Node.js applications still use HTTP/1.1 and you can see this reflected in the way that open-source packages for Node.js, such as the Express package I use in the next section, remain hugely popular even though they don’t support HTTP/2.</span></p>
</div>
<h1 class="heading" id="_idParaDest-109"><span class="kobospan" id="kobo.871.1">Using third-party enhancements</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.872.1">The API that Node.js provides</span><a id="_idIndexMarker277" class="calibre3"/><span class="kobospan" id="kobo.873.1"> for HTTP and HTTPS is comprehensive but can produce verbose code that is difficult to read and maintain. </span><span class="kobospan" id="kobo.873.2">One of the joys of JavaScript development is the huge range of open-source packages that are available and there are many packages that are built on the Node.js API to simplify request handling.</span></p>
<p class="normal"><span class="kobospan" id="kobo.874.1">The most popular of these packages is Express. </span><span class="kobospan" id="kobo.874.2">Run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.875.1">Listing 5.13</span></em><span class="kobospan" id="kobo.876.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.877.1">webapp</span></code><span class="kobospan" id="kobo.878.1"> folder to install the Express package and the TypeScript types for Express in the example project. </span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.879.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.880.1">Don’t worry if you don’t like the way that Express works because there are plenty of other packages available that do similar things. </span><span class="kobospan" id="kobo.880.2">A quick web search for Express alternatives will give you several options to consider. </span><span class="kobospan" id="kobo.880.3">Bear in mind when choosing a package that, as I noted in </span><em class="italic"><span class="kobospan" id="kobo.881.1">Chapter 2</span></em><span class="kobospan" id="kobo.882.1">, not all JavaScript packages receive long-term support from their creators, and it is worth considering how widely a package has been adopted before using it in a project.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.883.1">Listing 5.13: Installing the Express package</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.884.1">npm install express@4.18.2
npm install --save-dev @types/express@4.17.20
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.885.1">Express has many features, which are described in detail at </span><a href="https://expressjs.com" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.886.1">https://expressjs.com</span></span></a><span class="kobospan" id="kobo.887.1">, but the two that are most useful are the request router and the enhanced request/response types, both of which are described in the sections that follow.</span></p>
<h2 class="heading1" id="_idParaDest-110"><span class="kobospan" id="kobo.888.1">Using the Express router</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.889.1">Request handler functions that use the Node.js API mix the statements that inspect requests with the code</span><a id="_idIndexMarker278" class="calibre3"/><span class="kobospan" id="kobo.890.1"> that generates</span><a id="_idIndexMarker279" class="calibre3"/><span class="kobospan" id="kobo.891.1"> responses. </span><span class="kobospan" id="kobo.891.2">A new branch of code is required every time a new URL is supported by the application, as shown in </span><em class="italic"><span class="kobospan" id="kobo.892.1">Listing 5.14</span></em><span class="kobospan" id="kobo.893.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.894.1">Listing 5.14: Supporting a new URL in the handler.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.895.1">import { IncomingMessage, ServerResponse } from "http";
import { TLSSocket } from "tls";
import { URL } from "url";
export const isHttps = (req: IncomingMessage) : boolean =&gt; {
    return req.socket instanceof TLSSocket &amp;&amp; req.socket.encrypted;
}
export const redirectionHandler
        = (req: IncomingMessage, resp: ServerResponse) =&gt; {
    resp.writeHead(302, {
        "Location": "https://localhost:5500"
    });
    resp.end();
}
export const handler = (req: IncomingMessage, resp: ServerResponse) =&gt; {
    const protocol = isHttps(req) ? </span><span class="kobospan" id="kobo.895.2">"https" : "http";
    const parsedURL
        = new URL(req.url ?? </span><span class="kobospan" id="kobo.895.3">"", `${protocol}://${req.headers.host}`);
    if (req.method !== "GET" || parsedURL.pathname == "/favicon.ico") {
        resp.writeHead(404, "Not Found");
        resp.end();
        return;
    } else {
        resp.writeHead(200, "OK");
        </span><strong class="screentext"><span class="kobospan" id="kobo.896.1">if (parsedURL.pathname == "/newurl") {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.897.1">            resp.write("Hello, New URL");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.898.1">        } else if (!parsedURL.searchParams.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.899.1">has("keyword")) {</span></strong><span class="kobospan" id="kobo.900.1">
            resp.write(`Hello, ${protocol.toUpperCase()}`);
        } else {
            resp.write(`Hello, ${parsedURL.searchParams.get("keyword")}`);           
        }
        resp.end();
        return;       
    }
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.901.1">Each new addition makes the code more complex and increases the chances of a coding error that </span><a id="_idIndexMarker280" class="calibre3"/><span class="kobospan" id="kobo.902.1">either doesn’t match the right requests or generates the wrong response.</span></p>
<p class="normal"><span class="kobospan" id="kobo.903.1">The Express </span><em class="italic"><span class="kobospan" id="kobo.904.1">router</span></em><span class="kobospan" id="kobo.905.1"> solves this </span><a id="_idIndexMarker281" class="calibre3"/><span class="kobospan" id="kobo.906.1">problem by separating request matching from generating responses. </span><span class="kobospan" id="kobo.906.2">The first step towards using the Express router is to refactor the existing request handler code into separate functions that generate responses without the statements that inspect requests, as shown in </span><em class="italic"><span class="kobospan" id="kobo.907.1">Listing 5.15</span></em><span class="kobospan" id="kobo.908.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.909.1">Listing 5.15: Refactoring in the handler.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.910.1">import { IncomingMessage, ServerResponse } from "http";
import { TLSSocket } from "tls";
import { URL } from "url";
export const isHttps = (req: IncomingMessage) : boolean =&gt; {
    return req.socket instanceof TLSSocket &amp;&amp; req.socket.encrypted;
}
export const redirectionHandler
        = (req: IncomingMessage, resp: ServerResponse) =&gt; {
    resp.writeHead(302, {
        "Location": "https://localhost:5500"
    });
    resp.end();
}
</span><strong class="screentext"><span class="kobospan" id="kobo.911.1">export const</span></strong><strong class="screentext"><span class="kobospan" id="kobo.912.1"> notFoundHandler</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.913.1">        = (req: IncomingMessage, resp: ServerResponse) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.914.1">    resp.writeHead(404, "Not Found");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.915.1">    resp.end();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.916.1">}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.917.1">export const newUrlHandler</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.918.1">        = (</span></strong><strong class="screentext"><span class="kobospan" id="kobo.919.1">req: IncomingMessage, resp: ServerResponse) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.920.1">    resp.writeHead(200, "OK");   </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.921.1">    resp.write("Hello, New URL");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.922.1">    resp.end();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.923.1">}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.924.1">export const defaultHandler</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.925.1">        = (req: IncomingMessage, resp: ServerResponse) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.926.1">    resp.writeHead(200, "OK");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.927.1">    const protocol = isHttps(req) ? </span><span class="kobospan" id="kobo.927.2">"https" : "http";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.928.1">    const parsedURL = new</span></strong><strong class="screentext"><span class="kobospan" id="kobo.929.1"> URL(req.url ?? </span><span class="kobospan" id="kobo.929.2">"",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.930.1">        `${protocol}://${req.headers.host}`);   </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.931.1">    if (!parsedURL.searchParams.has("keyword"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.932.1">)) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.933.1">        resp.write(`Hello, ${protocol.toUpperCase()}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.934.1">    } else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.935.1">        resp.write(`Hello, ${parsedURL.searchParams.get("keyword")}`);           </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.936.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.937.1">    resp.end();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.938.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.939.1">The responses are generated in the same way as earlier examples, but each response is created by</span><a id="_idIndexMarker282" class="calibre3"/><span class="kobospan" id="kobo.940.1"> a separate handler function, without the code that matches requests. </span><span class="kobospan" id="kobo.940.2">The next step is to use the Express</span><a id="_idIndexMarker283" class="calibre3"/><span class="kobospan" id="kobo.941.1"> router to match requests and select one of the handlers from </span><em class="italic"><span class="kobospan" id="kobo.942.1">Listing 5.15</span></em><span class="kobospan" id="kobo.943.1"> to produce a result, as shown in </span><em class="italic"><span class="kobospan" id="kobo.944.1">Listing 5.16</span></em><span class="kobospan" id="kobo.945.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.946.1">Listing 5.16: Using the Express router in the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.947.1">import { createServer } from "http";
</span><strong class="screentext"><span class="kobospan" id="kobo.948.1">import { redirectionHandler, newUrlHandler, defaultHandler,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.949.1">            notFoundHandler } from "./handler";</span></strong><span class="kobospan" id="kobo.950.1">
import { createServer as createHttpsServer } from "https";
import { readFileSync } from "fs";
</span><strong class="screentext"><span class="kobospan" id="kobo.951.1">import express, { Express } from "express";</span></strong><span class="kobospan" id="kobo.952.1">
const port = 5000;
const https_port = 5500;
const server = createServer(redirectionHandler);
server.listen(port,
    () =&gt; console.log(`(Event) Server listening on port ${port}`));
const httpsConfig = {
    key: readFileSync("key.pem"),
    cert: readFileSync("cert.pem")
};   
</span><strong class="screentext"><span class="kobospan" id="kobo.953.1">const </span></strong><strong class="screentext"><span class="kobospan" id="kobo.954.1">expressApp: Express = express();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.955.1">expressApp.get("/favicon.ico", notFoundHandler);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.956.1">expressApp.get("/newurl", newUrlHandler);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.957.1">expressApp.get("*", defaultHandler);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.958.1">const</span></strong><strong class="screentext"><span class="kobospan" id="kobo.959.1"> httpsServer = createHttpsServer(httpsConfig, expressApp);</span></strong><span class="kobospan" id="kobo.960.1">
httpsServer.listen(https_port,
    () =&gt; console.log(`HTTPS Server listening on port ${https_port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.961.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.962.1">Express</span></code><span class="kobospan" id="kobo.963.1"> package </span><a id="_idIndexMarker284" class="calibre3"/><span class="kobospan" id="kobo.964.1">contains a default export, which is</span><a id="_idIndexMarker285" class="calibre3"/><span class="kobospan" id="kobo.965.1"> a function named </span><code class="inlinecode"><span class="kobospan" id="kobo.966.1">express</span></code><span class="kobospan" id="kobo.967.1">, and this is why the new </span><code class="inlinecode"><span class="kobospan" id="kobo.968.1">import</span></code><span class="kobospan" id="kobo.969.1"> statement looks different:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.970.1">...
</span><span class="kobospan" id="kobo.970.2">import </span><strong class="screentext"><span class="kobospan" id="kobo.971.1">express</span></strong><span class="kobospan" id="kobo.972.1">, { Express } from "express";
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.973.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.974.1">express</span></code><span class="kobospan" id="kobo.975.1"> function is invoked to create an </span><code class="inlinecode"><span class="kobospan" id="kobo.976.1">Express</span></code><span class="kobospan" id="kobo.977.1"> object, which provides methods for mapping requests to handler functions. </span><em class="italic"><span class="kobospan" id="kobo.978.1">Table 5.9</span></em><span class="kobospan" id="kobo.979.1"> describes the most useful methods, most of which incorporate the HTTP method into the matching process. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.980.1">Table 5.9: Useful Express methods</span></p>
<table class="table-container" id="table009">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.981.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.982.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.983.1">get(path, handler)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.984.1">This method routes HTTP GET requests that match the path to the specified handler function.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.985.1">post(path, handler)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.986.1">This method routes HTTP POST requests that match the path to the specified handler function.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.987.1">put(path, handler)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.988.1">This method routes HTTP PUT requests that match the path to the specified handler function.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.989.1">delete(path, handler)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.990.1">This method routes HTTP DELETE requests that match the path to the specified handler function.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.991.1">all(path, handler)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.992.1">This method routes all requests that match the path to the specified handler function.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.993.1">use(handler)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.994.1">This method adds a middleware component, which is able to inspect and intercept all requests. </span><span class="kobospan4" id="kobo.994.2">Later chapters contain examples that use middleware. </span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.995.1">I am only interested in GET requests in this chapter, and so I used the </span><code class="inlinecode"><span class="kobospan" id="kobo.996.1">get</span></code><span class="kobospan" id="kobo.997.1"> method to specify URL paths and</span><a id="_idIndexMarker286" class="calibre3"/><span class="kobospan" id="kobo.998.1"> the functions</span><a id="_idIndexMarker287" class="calibre3"/><span class="kobospan" id="kobo.999.1"> that will generate responses:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1000.1">...
</span><span class="kobospan" id="kobo.1000.2">expressApp.</span><strong class="screentext"><span class="kobospan" id="kobo.1001.1">get</span></strong><span class="kobospan" id="kobo.1002.1">("/favicon.ico", notFoundHandler);
expressApp.</span><strong class="screentext"><span class="kobospan" id="kobo.1003.1">get</span></strong><span class="kobospan" id="kobo.1004.1">("/newurl", newUrlHandler);
expressApp.</span><strong class="screentext"><span class="kobospan" id="kobo.1005.1">get</span></strong><span class="kobospan" id="kobo.1006.1">("*", defaultHandler);
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1007.1">These statements are </span><em class="italic"><span class="kobospan" id="kobo.1008.1">routes</span></em><span class="kobospan" id="kobo.1009.1">, and the URLs are specified as patterns that allow wildcards, such as the </span><code class="inlinecode"><span class="kobospan" id="kobo.1010.1">*</span></code><span class="kobospan" id="kobo.1011.1"> character in this route:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1012.1">...
</span><span class="kobospan" id="kobo.1012.2">expressApp.get(</span><strong class="screentext"><span class="kobospan" id="kobo.1013.1">"*"</span></strong><span class="kobospan" id="kobo.1014.1">, defaultHandler);
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1015.1">This matches any GET request and routes it to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1016.1">defaultHandler</span></code><span class="kobospan" id="kobo.1017.1"> function. </span><span class="kobospan" id="kobo.1017.2">Express matches requests to routes in the order in which they are defined, and so this is a catch-all route that will be applied if requests are not matched by the other routes.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1018.1">In addition to the methods described in </span><em class="italic"><span class="kobospan" id="kobo.1019.1">Table 5.9</span></em><span class="kobospan" id="kobo.1020.1">, the </span><code class="inlinecode"><span class="kobospan" id="kobo.1021.1">Express</span></code><span class="kobospan" id="kobo.1022.1"> object is also a handler function that can be used with the Node.js </span><code class="inlinecode"><span class="kobospan" id="kobo.1023.1">createServer</span></code><span class="kobospan" id="kobo.1024.1"> functions defined in the </span><code class="inlinecode"><span class="kobospan" id="kobo.1025.1">http</span></code><span class="kobospan" id="kobo.1026.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1027.1">https</span></code><span class="kobospan" id="kobo.1028.1"> modules:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1029.1">...
</span><span class="kobospan" id="kobo.1029.2">const httpsServer = createHttpsServer(httpsConfig, </span><strong class="screentext"><span class="kobospan" id="kobo.1030.1">expressApp</span></strong><span class="kobospan" id="kobo.1031.1">);
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1032.1">Express processes all the HTTP requests that Node.js receives and routes them to the appropriate </span><a id="_idIndexMarker288" class="calibre3"/><span class="kobospan" id="kobo.1033.1">handler.</span></p>
<h2 class="heading1" id="_idParaDest-111"><span class="kobospan" id="kobo.1034.1">Using the request and response enhancements</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.1035.1">In addition to routing, Express provides enhancements to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1036.1">IncomingRequest</span></code><span class="kobospan" id="kobo.1037.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1038.1">ServerResponse</span></code><span class="kobospan" id="kobo.1039.1"> objects that </span><a id="_idIndexMarker289" class="calibre3"/><span class="kobospan" id="kobo.1040.1">are passed to handler functions. </span><span class="kobospan" id="kobo.1040.2">The object that represents the HTTP request is </span><a id="_idIndexMarker290" class="calibre3"/><span class="kobospan" id="kobo.1041.1">named </span><code class="inlinecode"><span class="kobospan" id="kobo.1042.1">Request</span></code><span class="kobospan" id="kobo.1043.1"> and it extends the </span><code class="inlinecode"><span class="kobospan" id="kobo.1044.1">IncomingRequest</span></code><span class="kobospan" id="kobo.1045.1"> type. </span><span class="kobospan" id="kobo.1045.2">The most useful </span><code class="inlinecode"><span class="kobospan" id="kobo.1046.1">Request</span></code><span class="kobospan" id="kobo.1047.1"> enhancements are described in </span><em class="italic"><span class="kobospan" id="kobo.1048.1">Table 5.10</span></em><span class="kobospan" id="kobo.1049.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1050.1">Table 5.10: Useful Express request enhancements</span></p>
<table class="table-container" id="table010">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1051.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1052.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.1053.1">hostname</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.1054.1">This property provides convenient access to the value of the </span><code class="inlinecode"><span class="kobospan2" id="kobo.1055.1">hostname</span></code><span class="kobospan4" id="kobo.1056.1"> header.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.1057.1">params</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.1058.1">This property provides access to the route parameters, which are described in the </span><em class="italic"><span class="kobospan2" id="kobo.1059.1">Using Express route parameters</span></em><span class="kobospan4" id="kobo.1060.1"> section of this chapter.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.1061.1">path</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1062.1">This property returns the path component of the request URL.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.1063.1">protocol</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.1064.1">This property returns the protocol used to make the request, which will be either </span><code class="inlinecode"><span class="kobospan2" id="kobo.1065.1">http</span></code><span class="kobospan" id="kobo.1066.1"> or </span><code class="inlinecode"><span class="kobospan2" id="kobo.1067.1">https</span></code><span class="kobospan4" id="kobo.1068.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.1069.1">query</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1070.1">This property returns an object whose properties correspond to the query string parameters. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.1071.1">secure</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.1072.1">This property returns </span><code class="inlinecode"><span class="kobospan2" id="kobo.1073.1">true</span></code><span class="kobospan4" id="kobo.1074.1"> if the request has been made using HTTPS.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.1075.1">body</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.1076.1">This property is assigned the parsed contents of the request body, as demonstrated in </span><em class="italic"><span class="kobospan2" id="kobo.1077.1">Chapter 6</span></em><span class="kobospan4" id="kobo.1078.1">.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.1079.1">The object that Express uses to represent the HTTP response is named </span><code class="inlinecode"><span class="kobospan" id="kobo.1080.1">Response</span></code><span class="kobospan" id="kobo.1081.1"> and it extends the </span><code class="inlinecode"><span class="kobospan" id="kobo.1082.1">ServerResponse</span></code><span class="kobospan" id="kobo.1083.1"> type. </span><span class="kobospan" id="kobo.1083.2">The most useful basic </span><code class="inlinecode"><span class="kobospan" id="kobo.1084.1">Response</span></code><span class="kobospan" id="kobo.1085.1"> enhancements are described in </span><em class="italic"><span class="kobospan" id="kobo.1086.1">Table 5.11</span></em><span class="kobospan" id="kobo.1087.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1088.1">Table 5.11: Useful basic Express response enhancements</span></p>
<table class="table-container" id="table011">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1089.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1090.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.1091.1">redirect(code, path)</span></code></p>
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.1092.1">redirect(path)</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.1093.1">This method sends a redirection response. </span><span class="kobospan" id="kobo.1093.2">The </span><code class="inlinecode"><span class="kobospan2" id="kobo.1094.1">code</span></code><span class="kobospan" id="kobo.1095.1"> argument is used to set the response status code and message. </span><span class="kobospan" id="kobo.1095.2">The </span><code class="inlinecode"><span class="kobospan2" id="kobo.1096.1">path</span></code><span class="kobospan" id="kobo.1097.1"> argument is used to set the value of the </span><code class="inlinecode"><span class="kobospan2" id="kobo.1098.1">Location</span></code><span class="kobospan" id="kobo.1099.1"> header. </span><span class="kobospan" id="kobo.1099.2">If the </span><code class="inlinecode"><span class="kobospan2" id="kobo.1100.1">code</span></code><span class="kobospan" id="kobo.1101.1"> argument is omitted, then a temporary redirection, with status code </span><code class="inlinecode"><span class="kobospan2" id="kobo.1102.1">302</span></code><span class="kobospan4" id="kobo.1103.1">, is sent.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.1104.1">send(data)</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.1105.1">This method is used to send a response to the server. </span><span class="kobospan" id="kobo.1105.2">The status code is set to </span><code class="inlinecode"><span class="kobospan2" id="kobo.1106.1">200</span></code><span class="kobospan" id="kobo.1107.1">. </span><span class="kobospan" id="kobo.1107.2">This method sets response headers to describe the content, including the </span><code class="inlinecode"><span class="kobospan2" id="kobo.1108.1">Content-Length</span></code><span class="kobospan" id="kobo.1109.1"> and </span><code class="inlinecode"><span class="kobospan2" id="kobo.1110.1">Content-Type</span></code><span class="kobospan4" id="kobo.1111.1"> headers. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.1112.1">sendStatus(code)</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.1113.1">This method is used to send a status code response and will automatically set the status message for well-known status codes, so that a status code of </span><code class="inlinecode"><span class="kobospan2" id="kobo.1114.1">200</span></code><span class="kobospan" id="kobo.1115.1"> will lead to the </span><strong class="screentext"><span class="kobospan2" id="kobo.1116.1">OK</span></strong><span class="kobospan4" id="kobo.1117.1"> message being used, for example.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.1118.1">Other Express enhancements </span><a id="_idIndexMarker291" class="calibre3"/><span class="kobospan" id="kobo.1119.1">relate to features described in later chapters, but the basic additions described in </span><em class="italic"><span class="kobospan" id="kobo.1120.1">Table 5.10</span></em><span class="kobospan" id="kobo.1121.1"> and </span><em class="italic"><span class="kobospan" id="kobo.1122.1">Table 5.11</span></em><span class="kobospan" id="kobo.1123.1"> are enough to simplify the</span><a id="_idIndexMarker292" class="calibre3"/><span class="kobospan" id="kobo.1124.1"> way that responses are generated by the example application, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1125.1">Listing 5.17</span></em><span class="kobospan" id="kobo.1126.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1127.1">Listing 5.17: Using the Express enhancements in the handler.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1128.1">import { IncomingMessage, ServerResponse } from "http";
</span><strong class="screentext"><span class="kobospan" id="kobo.1129.1">//import { TLSSocket } from "tls";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1130.1">//import { URL } from "url";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1131.1">import</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1132.1"> { Request, Response } from "express";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1133.1">// export const isHttps = (req: IncomingMessage) : boolean =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1134.1">//     return req.socket instanceof TLSSocket &amp;&amp; req.socket.encrypted;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1135.1">// }</span></strong><span class="kobospan" id="kobo.1136.1">
export const redirectionHandler
        = (req: IncomingMessage, resp: ServerResponse) =&gt; {
    resp.writeHead(302, {
        "Location": "https://localhost:5500"
    });
    resp.end();
}
</span><strong class="screentext"><span class="kobospan" id="kobo.1137.1">export const notFoundHandler = (req: Request, resp: Response) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1138.1">    resp.sendStatus(</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1139.1">404);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1140.1">}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1141.1">export const newUrlHandler = (req: Request, resp: Response) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1142.1">    resp.send("Hello, New URL");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1143.1">}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1144.1">export const </span></strong><strong class="screentext"><span class="kobospan" id="kobo.1145.1">defaultHandler = (req: Request, resp: Response) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1146.1">    if (req.query.keyword) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1147.1">        resp.send(`Hello, ${req.query.keyword}`);                   </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1148.1">    } else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1149.1">        resp.send(</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1150.1">`Hello, ${req.protocol.toUpperCase()}`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1151.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1152.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.1153.1">Express automatically</span><a id="_idIndexMarker293" class="calibre3"/><span class="kobospan" id="kobo.1154.1"> parses the request URL and makes its parts accessible through the </span><code class="inlinecode"><span class="kobospan" id="kobo.1155.1">Response</span></code><span class="kobospan" id="kobo.1156.1"> properties described in </span><em class="italic"><span class="kobospan" id="kobo.1157.1">Table 5.10</span></em><span class="kobospan" id="kobo.1158.1">, which means I don’t have to parse the URL explicitly. </span><span class="kobospan" id="kobo.1158.2">The convenient </span><code class="inlinecode"><span class="kobospan" id="kobo.1159.1">secure</span></code><span class="kobospan" id="kobo.1160.1"> property means that I can </span><a id="_idIndexMarker294" class="calibre3"/><span class="kobospan" id="kobo.1161.1">remove the </span><code class="inlinecode"><span class="kobospan" id="kobo.1162.1">isHttps</span></code><span class="kobospan" id="kobo.1163.1"> function.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1164.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1165.1">Response</span></code><span class="kobospan" id="kobo.1166.1"> methods described in </span><em class="italic"><span class="kobospan" id="kobo.1167.1">Table 5.11</span></em><span class="kobospan" id="kobo.1168.1"> reduce the number of statements required to produce responses. </span><span class="kobospan" id="kobo.1168.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1169.1">send</span></code><span class="kobospan" id="kobo.1170.1"> method, for example, takes care of setting the response status code, sets some useful headers, and calls the </span><code class="inlinecode"><span class="kobospan" id="kobo.1171.1">end</span></code><span class="kobospan" id="kobo.1172.1"> method to tell Node.js that the response is complete.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1173.1">If you request </span><code class="inlinecode"><span class="kobospan" id="kobo.1174.1">https://localhost:5500/newurl</span></code><span class="kobospan" id="kobo.1175.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1176.1">https://localhost:5500?keyword=Express</span></code><span class="kobospan" id="kobo.1177.1">, you will see the responses shown in </span><em class="italic"><span class="kobospan" id="kobo.1178.1">Figure 5.6</span></em><span class="kobospan" id="kobo.1179.1">.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.1180.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.1181.1">Your browser may use a different font to display these responses, which happens because the </span><code class="inlinecode"><span class="kobospan" id="kobo.1182.1">Response</span></code><span class="kobospan" id="kobo.1183.1"> methods used to generate responses in </span><em class="italic"><span class="kobospan" id="kobo.1184.1">Listing 5.17</span></em><span class="kobospan" id="kobo.1185.1"> set the </span><code class="inlinecode"><span class="kobospan" id="kobo.1186.1">Content-Type</span></code><span class="kobospan" id="kobo.1187.1"> header in the response to </span><code class="inlinecode"><span class="kobospan" id="kobo.1188.1">text/html</span></code><span class="kobospan" id="kobo.1189.1">. </span><span class="kobospan" id="kobo.1189.2">This header was not set in previous examples, and it alters the way that most browsers display the content.</span></p>
</div>
<figure class="mediaobject"><span class="kobospan" id="kobo.1190.1"><img alt="" src="../Images/B21959_05_06.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.1191.1">Figure 5.6: Generating responses using Express</span></p>
<h2 class="heading1" id="_idParaDest-112"><span class="kobospan" id="kobo.1192.1">Using Express route parameters</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.1193.1">It is important to understand that Express doesn’t do anything magical and its features are built on those provided by Node.js described earlier in the chapter. </span><span class="kobospan" id="kobo.1193.2">The value of Express is that</span><a id="_idIndexMarker295" class="calibre3"/><span class="kobospan" id="kobo.1194.1"> it makes the Node.js API easier to consume, with the result that the code is easier to understand and maintain. </span></p>
<p class="normal"><span class="kobospan" id="kobo.1195.1">One especially useful feature that Express provides is specifying </span><em class="italic"><span class="kobospan" id="kobo.1196.1">route parameters</span></em><span class="kobospan" id="kobo.1197.1">, which extract values from URL paths when matching requests and make them easily accessible through the </span><code class="inlinecode"><span class="kobospan" id="kobo.1198.1">Response.params</span></code><span class="kobospan" id="kobo.1199.1"> property, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1200.1">Listing 5.18</span></em><span class="kobospan" id="kobo.1201.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1202.1">Listing 5.18: Using route parameters in the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1203.1">...
</span><span class="kobospan" id="kobo.1203.2">const expressApp: Express = express();
expressApp.get("/favicon.ico", notFoundHandler);
</span><strong class="screentext"><span class="kobospan" id="kobo.1204.1">expressApp.get("/newurl/:message?", newUrlHandler);</span></strong><span class="kobospan" id="kobo.1205.1">
expressApp.get("*", defaultHandler);
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1206.1">The modified route matches requests when the path begins with </span><code class="inlinecode"><span class="kobospan" id="kobo.1207.1">/newurl</span></code><span class="kobospan" id="kobo.1208.1">. </span><span class="kobospan" id="kobo.1208.2">The second segment in the URL path is assigned to a route parameter named </span><code class="inlinecode"><span class="kobospan" id="kobo.1209.1">message</span></code><span class="kobospan" id="kobo.1210.1">. </span><span class="kobospan" id="kobo.1210.2">The parameter is denoted by the colon (the </span><code class="inlinecode"><span class="kobospan" id="kobo.1211.1">:</span></code><span class="kobospan" id="kobo.1212.1"> character). </span><span class="kobospan" id="kobo.1212.2">For the URL path </span><code class="inlinecode"><span class="kobospan" id="kobo.1213.1">/newurl/London</span></code><span class="kobospan" id="kobo.1214.1">, for example, the </span><code class="inlinecode"><span class="kobospan" id="kobo.1215.1">message</span></code><span class="kobospan" id="kobo.1216.1"> parameter will be assigned the value </span><code class="inlinecode"><span class="kobospan" id="kobo.1217.1">London</span></code><span class="kobospan" id="kobo.1218.1">. </span><span class="kobospan" id="kobo.1218.2">The question mark (the </span><code class="inlinecode"><span class="kobospan" id="kobo.1219.1">?</span></code><span class="kobospan" id="kobo.1220.1"> character) denotes this is an optional parameter, which means the route will match requests even if there is no second URL segment.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1221.1">Route parameters are an effective way to increase the range of URLs that a route can match. </span><em class="italic"><span class="kobospan" id="kobo.1222.1">Listing 5.19</span></em><span class="kobospan" id="kobo.1223.1"> uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.1224.1">Response.params</span></code><span class="kobospan" id="kobo.1225.1"> property to get the value of the </span><code class="inlinecode"><span class="kobospan" id="kobo.1226.1">message</span></code><span class="kobospan" id="kobo.1227.1"> parameter</span><a id="_idIndexMarker296" class="calibre3"/><span class="kobospan" id="kobo.1228.1"> and incorporate it into the response.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1229.1">Listing 5.19: Consuming a route parameter in the handler.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1230.1">...
</span><span class="kobospan" id="kobo.1230.2">export const newUrlHandler = (req: Request, resp: Response) =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.1231.1">const msg = req.params.message ?? </span><span class="kobospan" id="kobo.1231.2">"(No Message)";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1232.1">    resp.send(`Hello, ${msg}`);</span></strong><span class="kobospan" id="kobo.1233.1">
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1234.1">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.1235.1">https://localhost:5500/newurl/London</span></code><span class="kobospan" id="kobo.1236.1"> and you will see the response shown in </span><em class="italic"><span class="kobospan" id="kobo.1237.1">Figure 5.7</span></em><span class="kobospan" id="kobo.1238.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.1239.1"><img alt="" src="../Images/B21959_05_07.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.1240.1">Figure 5.7: Using a route parameter</span></p>
<h1 class="heading" id="_idParaDest-113"><span class="kobospan" id="kobo.1241.1">Summary</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.1242.1">In this chapter, I described the API features that Node.js provides for receiving HTTP requests and producing responses, which is the backbone of server-side web application development:</span></p>
<ul class="calibre4">
<li class="bulletlist"><span class="kobospan" id="kobo.1243.1">The Node.js API provides support for receiving HTTP and HTTPS requests.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1244.1">Node.js emits events when requests are received and invokes callback functions to handle those requests.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1245.1">Some additional work, such as parsing URLs, is generally required when using the Node.js API.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1246.1">Third-party packages, such as Express, build on the Node.js APIs to streamline request processing and simplify the code that generates responses.</span></li>
</ul>
<p class="normal"><span class="kobospan" id="kobo.1247.1">In the next chapter, I describe the features Node.js provides for reading and writing data.</span></p>
</div>
</body></html>