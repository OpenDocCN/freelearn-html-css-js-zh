<html><head></head><body>
        

                            
                    <h1 class="header-title">Using a Light Sensor to Create a Night-Light</h1>
                
            
            
                
<p>In this chapter, we will look at the ways we can still use analog sensors with Johnny-Five and the Raspberry Pi, even without the Pi having built-in analog input pins. We'll use that knowledge to build a night-light that turns on and off an LED based on the ambient light in the room.</p>
<p>The following topics will be covered in this chapter:</p>
<ul>
<li>Using an analog sensor with the Pi</li>
<li>The ambient light sensor</li>
<li>Creating our night-light</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Technical requirements</h1>
                
            
            
                
<p>For this project, you will need a regular LED of any color, and a TSL2561 light sensor, available on Adafruit (<a href="https://www.adafruit.com/product/439">https://www.adafruit.com/product/439</a>) and through many other providers.</p>
<p>The code for this chapter is available at <a href="https://github.com/PacktPublishing/Hands-On-Robotics-with-JavaScript/tree/master/Chapter05">https://github.com/PacktPublishing/Hands-On-Robotics-with-JavaScript/tree/master/Chapter05</a>.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Using an analog sensor with the Pi</h1>
                
            
            
                
<p class="mce-root">We talked about the lack of multiple PWM output pins on the Pi in <a href="c7b761b9-d526-4998-8ec4-375debe53806.xhtml" target="_blank">Chapter 3</a>,<em> Building </em><em>Interactive Projects with RGB LED</em>, but an issue we haven't entirely addressed yet is with inputs. Digital inputs, such as buttons and switches, anything that is either on or off, are easy with the Pi, any digital output pin can also be used as a digital input pin. But what about things that require more than two states, such as sensors that detect light, temperature, moisture, distances, or anything else we'd like to measure in quantity? The answer lies in using specialized communication protocols developed over the years that allow digital pins to communicate analog information.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Finding the right sensors for your Pi project</h1>
                
            
            
                
<p>When you're looking at sensors for a Raspberry Pi project, you need to be sure that any analog sensor you use has a digital interface. The two most common are I<sup>2</sup>C and SPI, and we'll talk about how to tell which your sensor has (or hasn't!) and whether that device can be used with Johnny-Five.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">I2C devices</h1>
                
            
            
                
<p>I<sup>2</sup>C devices require two more pins to work along with power and a ground pin—an SDA (data) and SCL (clock) pin. The details of how these are used is beyond the scope of this book (see the <em>Further reading</em> section for more information), but do know that you can hook multiple devices to the same SDA and SCL pins, so long as the devices have different I<sup>2</sup>C addresses. The address is a two-digit hex number, that is easy to find for nearly all I<sup>2</sup>C devices, and in some cases the address can be configured physically on the device.</p>
<p>For this chapter's project, we will be using the TSL2561, which can have two different addresses configured to it. We'll stick with the default, 0x39 (on the Adafruit model) for now.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">SPI </h1>
                
            
            
                
<p>SPI devices get tricky quickly, you need five pins: power, ground, microcontroller to sensor data (MOSI), sensor to microcontroller data (MISO), and a chip select line. While multiple devices on a set of SPI pins can share MISO and MOSI pins, they each need their own chip select pin, so the microcontroller can signal the device it wishes to communicate with. </p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">How to determine if your sensor will work with Johnny-Five</h1>
                
            
            
                
<p>The best way to see if there already are drivers for the sensor you are eyeing in Johnny-Five is to check the documentation at the Johnny-Five website. Find the sensor type, and find out what chip the sensor is using (for example, our light sensor uses the TSL2561). Then, on the API page for the sensor, at the top, is nearly always a list of supported controllers and chips. If the chip number on your sensor matches one in that list, it is already compatible with Johnny-Five: just remember that even though analog sensors are compatible with Johnny-Five, they will not work with the Pi, because it has no analog input pins of its own.</p>
<p>As an example, here's the list of supported light-sensor controllers and chips, and you can see the <strong>TSL2561</strong> in the list, so we're good to start building out our project:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-578 image-border" src="img/5063ccb7-d5df-43c7-aee8-c4aef9c0f966.png" style="width:15.33em;height:17.75em;"/></p>


            

            
        
    

        

                            
                    <h1 class="header-title">The ambient light sensor</h1>
                
            
            
                
<p>To get started with our night-light project, we'll start by wiring up our TSL2561 I<sup>2</sup>C light sensor and making sure we get good data reads by having it print out to the command line.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Wiring up the sensor</h1>
                
            
            
                
<p>In order to wire up our light sensor, we'll need to know which are the SDA and SCL pins of the Pi. For the Pi 3 and 3 B+, SDA is P1-P3 and SCL is P1-P5; these are also usually labelled on the cobblers as <strong>SDA</strong> and <strong>SCL</strong>. In order to get the sensor working, we'll need the power pin; this sensor is not 5V tolerant, so we'll need to use a 3.3V power pin. We can attach GND on the sensor to any ground pin.</p>
<p class="mce-root">The SDA and SCL pins on the sensor need to be connected to the SDA and SCL pins on the Pi, respectively. In the end, your light sensor should be wired up like the following diagram:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-579 image-border" src="img/08e749e2-e6d3-47a9-a742-966da27ca45e.png" style="width:25.50em;height:39.92em;"/></p>
<p>Now that we've wired up our sensor, it's time to figure out how to print that data using Johnny-Five and other Node.js modules so we can make sure it's up and running.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Writing a program to get readings and print them to the command line</h1>
                
            
            
                
<p>Sensor object events in Johnny-Five are different from button events, because, well, sensors are different to buttons! Let's take a look at the differences and how to get the data we need from our light sensor.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">The Johnny-Five sensor events</h1>
                
            
            
                
<p>The two main events we'll see from sensors are <kbd>data</kbd> and <kbd>change</kbd>. The only real difference is in the name: <kbd>data</kbd> events are fired every time data is retrieved, while <kbd>change</kbd> is fired when the data changes. I tend to use <kbd>change</kbd> when building sensor-based projects unless I'm distinctly logging data over time.</p>
<p>You can configure the time between data collection in the construction of the sensor object, as well as the threshold that the change in data must pass in order to fire the <kbd>change</kbd> event.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Handling sensor data in the event handler</h1>
                
            
            
                
<p>When you receive data from a sensor, it will be attached to the JavaScript <kbd>this</kbd> object, so when you create a callback for the event handler, do not use the arrow syntax, as you will lose the bindings Johnny-Five places on the <kbd>this</kbd> object in JavaScript.</p>
<p>Here's an example of a generic data handler for a <kbd>change</kbd> event on a Johnny-Five sensor:</p>
<pre>let mySensor = new five.Sensor('PIN_NUMBER')<br/><br/>mySensor.on('change', function() {<br/>  console.log(this.value) // logs a value between 0-255 to the console<br/>})</pre>
<p>Now that we've established how we'll get the data, let's talk about what the data will look like and how we can manipulate it.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Using and formatting Johnny-Five sensor data</h1>
                
            
            
                
<p>There are many ways to receive the data sent from a sensor in Johnny-Five, as you can see by the documentation shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-580 image-border" src="img/19c05048-c270-424c-aad9-680bcd6674fa.png" style="width:78.83em;height:44.42em;"/></p>
<p class="CDPAlignCenter CDPAlign"> </p>
<p>Boolean, raw, analog, constrained, and value can leave you with a lot to process. What each one means is shown in the preceding diagram, however take note that there is a good reason the default value is the same as analog: a scaled reading between <kbd>0</kbd> and <kbd>255</kbd>. It has a lot to do with the variety of sensors available, the varying granularities of data, and using scaling to make sure you only have to keep one number range in mind, regardless of how many sensors you are using. </p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Using .scaleTo() and .fscaleTo() to fine-tune measurements</h1>
                
            
            
                
<p>If you'd like to impose an arbitrary scale on your sensor (say <kbd>0</kbd> – <kbd>100</kbd> for percentage), you have some options built into the Johnny-Five API: <kbd>.scaleTo()</kbd> and <kbd>.fscaleTo()</kbd>. These will scale the raw value from the sensor to match the min and max values you pass in:</p>
<pre>sensor.on('change', function(){<br/>  // this.value will reflect a scaling from 0-1023 to 0-100   console.log(this.scaleTo([0, 100])); // prints an integer<br/>  console.log(this.fscaleTo([0, 100])); // prints a float<br/>})</pre>
<p>Now that we know how to handle the data, let's start on our night-light by creating code to print the light-sensor values to the command line. This will also allow us to tweak the change threshold setting and determine what value of the light sensor we should use as an indicator to turn our LED off and on.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Printing sensor data to the command line</h1>
                
            
            
                
<p>To print data from our sensor to the command line, we'll use the code in <kbd>print-light-sensor.js</kbd>:</p>
<pre>const five = require('johnny-five')<br/>const RaspiIO = require('raspi-io')<br/><br/>let board = new five.Board({<br/>  io: new RaspiIO()<br/>})<br/><br/>board.on('ready', () =&gt; {<br/>  let lightSensor = new five.Light({<br/>    controller: 'TSL2561'<br/>  })<br/>  <br/>  lightSensor.on('change', function() {<br/>    console.log(this.value)<br/>  })<br/>})</pre>
<p class="mce-root"/>
<p>Your output on run should look something like this, with the numbers varying when you cover or shine light onto the sensor:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-730 image-border" src="img/e2e2b978-5c46-402b-94b2-c68616aec74e.png" style="width:28.00em;height:22.50em;"/></p>
<p>This is nice, but a little hard to comprehend. What we'll do next is add in the <kbd>npm</kbd> module <kbd>barcli</kbd> to show a nice bar graph that allows us to comprehend in real time the data we're seeing.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Using barcli to make the data easier to see</h1>
                
            
            
                
<p>That data stream can be hard to process! Let's take a look at leveraging the power of Node.js to make this easier to see. </p>
<p>In your <kbd>project</kbd> folder, run:</p>
<pre><strong>npm i --save barcli</strong></pre>
<p>To install <kbd>barcli</kbd>, a library that creates bar graphs in the Terminal. </p>
<p>Reading the <kbd>barcli</kbd> documentation (see <em>Further reading</em>), we'll need to import <kbd>barcli</kbd>, construct a <kbd>barcli</kbd> object with the settings we need, then tell when to update and with what data.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Importing barcli and constructing our barcli graph</h1>
                
            
            
                
<p>To import <kbd>barcli</kbd>, at the top of your <kbd>print-light-sensor.js</kbd> file, following the other <kbd>require()</kbd> statements, add:</p>
<pre>const Barcli = require('barcli')</pre>
<p>Then, in the <kbd>board.on('ready')</kbd> handler, we'll add the bar graph constructor:</p>
<pre>let lightGraph = new Barcli({<br/>  label: 'Light Sensor',<br/>  range: [0, 255]<br/>})</pre>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting the bar graph to update</h1>
                
            
            
                
<p>Remove the <kbd>console.log()</kbd> line from the <kbd>lightSensor.on('change')</kbd> handler and replace it with:</p>
<pre>lightGraph.update(this.value)</pre>
<p>Then you're ready to roll! Move the <kbd>project</kbd> folder over to the Pi, navigate to the folder in your Pi SSH session, and run:</p>
<pre><strong>npm i</strong></pre>
<p>To make sure that <kbd>barcli</kbd> is properly installed on the Pi, run the command:</p>
<pre><strong>sudo node light-sensor-barcli.js</strong></pre>
<p>You should see a bar graph now, shown as follows, that changes when you shine light on or cover the sensor:</p>
<p class="CDPAlignCenter CDPAlign"><img src="img/7b680808-4d11-4c56-b112-81b666c9bfda.png"/></p>
<p>Now, for our night-light project, you'll want to find a value for the light sensor that we will use to turn the LED on and off; <kbd>barcli</kbd> makes this much easier by making that value much easier to see.</p>
<p>Once you've got the value that works for you (I settled on <kbd>25</kbd>), we're ready to build our night-light.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Creating our night-light</h1>
                
            
            
                
<p>Now that we know our light sensor works, we can add an LED and create our night-light.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Wiring up the LED</h1>
                
            
            
                
<p>Connect the short leg of your LED to a ground rail using a 330K ohm resistor, and wire the long leg to GPIO #5, also known as P1-29:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-581 image-border" src="img/419275ca-1a2e-46dc-8099-bdfd3405f453.png" style="width:19.58em;height:33.50em;"/></p>


            

            
        
    

        

                            
                    <h1 class="header-title">Coding this project</h1>
                
            
            
                
<p>Create a file in the same folder as the other files from this chapter, and copy the contents of <kbd>print-light-sensor-readings.js</kbd> into it.</p>
<p>In the start of the <kbd>board.on('ready')</kbd> handler, add a constructor for our LED:</p>
<pre>let light = new five.Led('P1-29')</pre>
<p>And in the <kbd>lightSensor.on('change')</kbd> function, replace the <kbd>console.log</kbd> statement with the logic that will turn the LED on and off:</p>
<pre>if(this.value &lt;= 25) {<br/>  light.on()<br/>} else {<br/>  light.off()<br/>}</pre>
<p>And we're ready to run! Load the folder onto your Pi, navigate to the folder in your Pi's SSH session, and run:</p>
<pre><strong>sudo node night-light.js</strong></pre>
<p>When you cover the light sensor with your thumb, the LED should light up, as shown in the following image:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-731 image-border" src="img/1a0b501d-17db-4c6c-92c7-6c77f6a3a8af.png" style="width:22.00em;height:16.50em;"/></p>
<p class="mce-root"/>
<p class="CDPAlignLeft CDPAlign"> And when you remove your thumb (in a well-lit room), the LED will turn off, as shown in the following image:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-732 image-border" src="img/ba983d0e-e9c4-41e4-8477-b24f5d9feb18.png" style="width:20.75em;height:15.58em;"/></p>
<p class="CDPAlignLeft CDPAlign"> And with that, you have successfully coded and built your night-light!</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Summary</h1>
                
            
            
                
<p>In this chapter, we learned about analog sensors and the limitations of the Pi for analog input. We learned about digital interfaces that allow us to collect analog data in Pi projects. We used this knowledge to set up a light sensor, with bar graphs from <kbd>barcli</kbd> to find a good threshold for an LED to turn on and off. Finally, we used all of this together to build a night light that illuminates in the dark and turns off in the light.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Questions</h1>
                
            
            
                
<ol>
<li>What is an analog input sensor?</li>
<li>Why can't analog input sensors directly interface with the Raspberry Pi?</li>
<li>Name two digital interfaces we can use with the Pi to collect analog data.</li>
<li>What two pins (besides power and ground) do I<sup>2</sup>C sensors need to operate?</li>
<li>Name the events that a sensor object can fire.</li>
<li>Why is <kbd>barcli</kbd> helpful in processing changing sensor data?</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">Further reading</h1>
                
            
            
                
<ul>
<li><strong>More information on analog inputs</strong>: <a href="https://learn.sparkfun.com/tutorials/analog-to-digital-conversion">https://learn.sparkfun.com/tutorials/analog-to-digital-conversion</a></li>
<li><strong>More information on SPI</strong>: <a href="https://learn.sparkfun.com/tutorials/serial-peripheral-interface-spi">https://learn.sparkfun.com/tutorials/serial-peripheral-interface-spi</a></li>
<li><strong>More information on I<sup>2</sup>C</strong>: <a href="https://learn.sparkfun.com/tutorials/i2c">https://learn.sparkfun.com/tutorials/i2c</a></li>
<li><strong>More information on using SPI and I<sup>2</sup>C with the Pi</strong>: <a href="https://learn.sparkfun.com/tutorials/raspberry-pi-spi-and-i2c-tutorial">https://learn.sparkfun.com/tutorials/raspberry-pi-spi-and-i2c-tutorial</a></li>
</ul>


            

            
        
    </body></html>