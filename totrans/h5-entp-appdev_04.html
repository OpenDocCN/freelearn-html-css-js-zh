<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;The App: Getting Movies Via Geolocation"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. The App: Getting Movies Via Geolocation</h1></div></div></div><p>HTML5 introduced a built-in ability to determine where the user is. The geolocation API defines a specification for using JavaScript to access location-based data for use in your enterprise application. Understanding where the user is can be useful for displaying news and services relevant to the user's locale.</p><p>The first major feature of our MovieNow application is the ability to find a list of movies nearest to the user based on geolocation data. We will cover how the geolocation API works as well as walk through the implementation of this feature. Since this is our first feature, we will also walk through making requests using <span class="strong"><strong>Asynchronous JavaScript and XML</strong></span> (<span class="strong"><strong>AJAX</strong></span>).</p><p>We will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">How it works</li><li class="listitem" style="list-style-type: disc">The API</li><li class="listitem" style="list-style-type: disc">A simple request</li><li class="listitem" style="list-style-type: disc">Movies near you</li></ul></div><div class="section" title="How it works"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec40"/>How it works</h1></div></div></div><p>The W3C Geolocation API specification merely defines an interface by which we can obtain data. Where and how geolocation data arrives is rather an implementation detail. On most mobile devices, GPS is usually built in and is gathered through a combination of satellite data, WiFi, and GSM/CDMA cell tower location. On desktop devices, Wi-Fi and geolocation based on IP address can be used. Lastly, Google offers a geolocation service fueled by its StreetView data. Needless to say, what goes on under the hood need not worry us, but it is good to understand how the magic really happens <a id="id209" class="indexterm"/>
</p><p>The following are the supported browser: <a id="id210" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Firefox 3.5+</li><li class="listitem" style="list-style-type: disc">Chrome 5.0+</li><li class="listitem" style="list-style-type: disc">Safari 5.0+</li><li class="listitem" style="list-style-type: disc">Opera 10.60+</li><li class="listitem" style="list-style-type: disc">Internet Explorer 9.0+</li></ul></div><p>Support is rendered on the following mobile devices: <a id="id211" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Android 2.0+</li><li class="listitem" style="list-style-type: disc">iPhone 3.0+</li><li class="listitem" style="list-style-type: disc">Opera Mobile 10.1+</li><li class="listitem" style="list-style-type: disc">Blackberry OS 6</li></ul></div></div></div>
<div class="section" title="The API"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec41"/>The API</h1></div></div></div><p>The geolocation API<a id="id212" class="indexterm"/> is fairly simple providing only two methods: <code class="literal">getCurrentPosition()</code>
<a id="id213" class="indexterm"/> and <code class="literal">watchPosition()</code>.<a id="id214" class="indexterm"/> Available under the <code class="literal">navigator.geolocation</code> namespace, these methods are very similar but provide data about the device's location in distinct ways. While <code class="literal">getCurrentPosition</code> is a one-time call to get geolocation data, <code class="literal">watchPosition</code> returns geolocation data and continues to re-invoke its callback when the device's position changes until the <code class="literal">clearWatch</code> method is invoked.</p><p>Both methods take the same three arguments: a <code class="literal">successCallback</code> function, an <code class="literal">errorCallback</code> function, and a <code class="literal">PositionOptions</code> function<a id="id215" class="indexterm"/> consisting of the following attributes: <a id="id216" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">boolean enableHighAccuracy</code>: This indicates that the most accurate data should be retrieved, which may result in slower response times.</li><li class="listitem" style="list-style-type: disc"><code class="literal">long timeout</code>: This indicates the maximum number of milliseconds before the request should time out.</li><li class="listitem" style="list-style-type: disc"><code class="literal">long maximumAge</code>: This indicates that cached content that does not exceed the specified age in milliseconds should be returned. If set to <code class="literal">0</code>, the new position data will always be returned. <a id="id217" class="indexterm"/></li></ul></div><p>Both methods also return a <code class="literal">Position</code> object to the <code class="literal">successCallback</code> function, which consists of the following poperties: <a id="id218" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">coords.latitude</code>: This holds the latitude in decimal degrees</li><li class="listitem" style="list-style-type: disc"><code class="literal">coords.longitude</code>: This holds the longitude in decimal degrees</li><li class="listitem" style="list-style-type: disc"><code class="literal">coords.altitude</code>: This holds the height in meters relative to the reference ellipsoid</li><li class="listitem" style="list-style-type: disc"><code class="literal">coords.accuracy</code>: This holds the accuracy of the latitude and longitude in meters</li><li class="listitem" style="list-style-type: disc"><code class="literal">coords.altitudeAccuracy</code>: This holds the accuracy of the altitude in meters</li><li class="listitem" style="list-style-type: disc"><code class="literal">coords.heading</code>: This holds the travel direction of the device in degrees clockwise relative to true north</li><li class="listitem" style="list-style-type: disc"><code class="literal">coords.speed</code>: This holds the current ground speed in meters per second</li><li class="listitem" style="list-style-type: disc"><code class="literal">timestamp</code>: This holds the date and time of when the position was acquired</li></ul></div><p>Finally, the <code class="literal">errorCallback</code> argument receives a <code class="literal">PositionError</code> object when invoked, which includes the following properties:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">code</code>: This indicates the error type. This can be any of the following values: <code class="literal">PERMISSION_DENIED</code> (<code class="literal">1</code>), <code class="literal">POSITION_UNAVAILABLE</code> (<code class="literal">2</code>), and <code class="literal">TIMEOUT</code> (<code class="literal">3</code>).</li><li class="listitem" style="list-style-type: disc"><code class="literal">message</code>: This shows the details of the error.</li></ul></div></div>
<div class="section" title="A simple request"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec42"/>A simple request</h1></div></div></div><p>Now that we understand the mechanics of the geolocation API, let us go over dissent an actual request. Take a look at the following code snippet: <a id="id219" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(successCallback);
}</pre></div><p>This is the most basic call we can make. First of all, since geolocation is not supported on all devices, we must take care to avoid unexpected errors by checking whether it is supported, which is where the <code class="literal">if</code> statement comes in. Secondly, we invoke the <code class="literal">getCurrentPosition</code> method passing in a <code class="literal">successCallback</code> function. <code class="literal">successCallback</code> can be any function we want to invoke when the position is returned. Notice the missing <code class="literal">errorCallback</code> function<a id="id220" class="indexterm"/> and options arguments. These are strictly optional although it is good practice to implement them to account for unexpected error conditions. <a id="id221" class="indexterm"/>
</p></div>
<div class="section" title="Movies near you"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec43"/>Movies near you</h1></div></div></div><a id="id222" class="indexterm"/><p>To begin adding geolocation to our MovieNow enterprise application, we will first make some adjustments to our page, which we set up in <a class="link" href="ch03.html" title="Chapter 3. The App: Structure and Semantics">Chapter 3</a>, <span class="emphasis"><em>The App: Structure and Semantics</em></span>. In the <code class="literal">article</code> tag, we will add a <code class="literal">button</code> tag and a <code class="literal">div</code> tag:</p><div class="informalexample"><pre class="programlisting">&lt;article&gt;
    &lt;h1&gt;Home Title&lt;/h1&gt;
    &lt;p&gt;Home content&lt;/p&gt;
    <span class="strong"><strong>&lt;button id="find-movies"&gt;Find Movies&lt;/button&gt;</strong></span>
<span class="strong"><strong>    &lt;div id="movies-near-me"&gt;</strong></span>
<span class="strong"><strong>    &lt;/div&gt;</strong></span>
&lt;/article&gt;</pre></div><p>The <code class="literal">button</code> tag will be used to invoke the action to get movie data while the <code class="literal">div</code> tag is where the data will land. If all goes well, your screen should display a button labeled <span class="strong"><strong>Find Movies</strong></span>, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5689_04_01.jpg" alt="Movies near you"/></div><a id="id223" class="indexterm"/><p>Next, you may recall some JavaScript references that were included at the bottom of <code class="literal">index.html</code>. Let us add three more JavaScript references. See the following code snippet:</p><div class="informalexample"><pre class="programlisting">    &lt;footer&gt;Copyright &amp;copy; 2012 MovieNow. All rights reserved.&lt;/footer&gt;
    &lt;script src="js/ios-orientationchange-fix.js"&gt;&lt;/script&gt;
    &lt;script src="js/jquery-1.8.0.min.js"&gt;&lt;/script&gt;
    <span class="strong"><strong>&lt;script src="js/jquery.xdomainajax.js"&gt;&lt;/script&gt;</strong></span>
<span class="strong"><strong>    &lt;script src="js/movienow.js"&gt;&lt;/script&gt;</strong></span>
<span class="strong"><strong>    &lt;script src="js/movienow.geolocation.js"&gt;&lt;/script&gt;</strong></span>
&lt;/body&gt;</pre></div><p>You may have noticed the inclusion of <code class="literal">jquery.xdomainajax.js</code>. This is an extension to the jQuery library that allows for cross-domain AJAX GET requests. Going back to Netscape Navigator 2.0, browsers have implemented the same origin policy, which is a security precaution that restricts pages on one site from being able to access properties and methods of pages on another site. This made sense at the time, but now with an increasingly fluid World Wide Web, where content from many sites can be "mashed up" into a unified experience, the borders have by necessity been circumvented. There are many workarounds including <span class="strong"><strong>JavaScript Object Notation with Padding</strong></span> (<span class="strong"><strong>JSONP</strong></span>
<a id="id224" class="indexterm"/>), that allows cross-domain AJAX requests passing a callback parameter, so the service called can wrap the resulting JSON object in the function passed as a callback.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip22"/>Tip</h3><p>The cross-domain-ajax library can be found at <a class="ulink" href="https://github.com/padolsey/jQuery-Plugins/tree/master/cross-domain-ajax/">https://github.com/padolsey/jQuery-Plugins/tree/master/cross-domain-ajax/</a>. All credit goes to James Padolsey for this library.</p></div></div><a id="id225" class="indexterm"/><p>Next, we will add the cross-domain-ajax library to the <code class="literal">js</code> folder, and then create two new files in the <code class="literal">js</code> folder: <code class="literal">movienow.js</code> and <code class="literal">movienow.geolocation.js</code>. In <code class="literal">movienow.js</code>, we will establish our root namespace <code class="literal">movienow</code>. This will be in the <code class="literal">global</code> or <code class="literal">window</code> scope meaning that it can be accessed anywhere. This is where we can add core functionality to our enterprise application as we see fit. For starters, the only line we need here is the following, which sets the root namespace:</p><div class="informalexample"><pre class="programlisting">var movienow = {};</pre></div><p>In <code class="literal">movienow.geolocation.js</code>, we will add our geolocation-specific functionality. The reason we do this is to make sure we are following a modular approach in our enterprise application development. Modularity forces us to break up functionality into discrete, highly cohesive, loosely coupled pieces. Modularity allows us to vary parts of our enterprise application without affecting the whole. It is akin to the difference between a mobile phone with a removable battery and one where the battery is welded in. If the battery goes bad, modularity means the difference between replacing a broken part to replacing an entire device.</p><div class="section" title="Self-invoking"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec50"/>Self-invoking</h2></div></div></div><a id="id226" class="indexterm"/><p>We will begin by getting a reference to our established namespace. This is good defensive practice in case anything happens to your core namespace JavaScript file.</p><div class="informalexample"><pre class="programlisting">var movienow = movienow || {};</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip23"/>Tip</h3><p>Notice that having this declaration is not necessary to include the <code class="literal">movienow.js</code> file with the initial definition of our namespace.</p></div></div><p>Next, we will establish our geolocation namespace:</p><div class="informalexample"><pre class="programlisting">movienow.geolocation = (function(){})();</pre></div><p>Notice the second set of parentheses. This construct is known as an <span class="strong"><strong>immediately invoked function expression</strong></span> (<span class="strong"><strong>IIFE</strong></span>). This is a nifty shorthand for registering and immediately invoking JavaScript code in a modular way. All the properties and methods for geolocation will be wrapped in the <code class="literal">movienow.geolocation</code> namespace, which makes for a smaller footprint in the global namespace and cleaner,more modular code. <a id="id227" class="indexterm"/>
</p></div><div class="section" title="That becomes this"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec51"/>That becomes this</h2></div></div></div><p>Within our newly established namespace declaration, we will do a couple of things. First, we need to capture a reference to the object itself. We will do this by adding the following line:</p><div class="informalexample"><pre class="programlisting">var that = this;</pre></div><p>This may seem like an amusing line, but its importance will become clear. The <code class="literal">this</code> keyword in JavaScript is a handy function for referring to the owner of the executing function or to the object of which the function is a method. Without it, we would be required to prefix all of our properties and methods within our namespace with the namespace itself, which gets thorny when you want to change your namespace.</p><p>The following illustrates the value of the <code class="literal">this</code> keyword:</p><div class="informalexample"><pre class="programlisting">var myNamespace = {
  firstFunction: function() {
    document.write('firstFunction invoked.');
    <span class="strong"><strong>myNamespace</strong></span>.secondFunction();
  },
  secondFunction: function() {
    document.write('secondFunction invoked.');
  }
};
myNamespace.firstFunction();</pre></div><p>Notice the use of <code class="literal">myNamespace</code> to refer to other methods within the object. We can replace it with <code class="literal">this</code> in order to have a more agnostic way of referring to other members within the object:</p><div class="informalexample"><pre class="programlisting">var myNamespace = {
  firstFunction: function() {
    document.write('firstFunction invoked.');
    <span class="strong"><strong>this</strong></span>.secondFunction();
  },
  secondFunction: function() {
    document.write('secondFunction invoked.');
  }
};
myNamespace.firstFunction();</pre></div><a id="id228" class="indexterm"/><p>Unfortunately, when the context changes, so does <code class="literal">this</code>. When we add a function inside another function, the context will be that of the outer function:</p><div class="informalexample"><pre class="programlisting">var myNamespace = {
  firstFunction: function() {
    document.write('firstFunction invoked.');
    <span class="strong"><strong>var innerFunction = (function() {</strong></span>
<span class="strong"><strong>      this.secondFunction();</strong></span>
<span class="strong"><strong>    })();</strong></span>
  },
  secondFunction: function() {
    document.write('secondFunction invoked.');
  }
};
myNamespace.firstFunction();</pre></div><p>Here we have added <code class="literal">innerFunction</code> that invokes <code class="literal">secondFunction</code> (notice the immediately invoked function expression). However, <code class="literal">secondFunction</code> is never invoked. This is because the context for <code class="literal">this</code> has changed to that of <code class="literal">firstFunction</code>. To maintain our reference to the <code class="literal">myNamespace</code> context, we simply declare a variable and hold onto it:</p><div class="informalexample"><pre class="programlisting">var myNamespace = {
  firstFunction: function() {
    document.write('firstFunction invoked.');
    <span class="strong"><strong>var that = this;</strong></span>
    var innerFunction = (function() {
      <span class="strong"><strong>that</strong></span>.secondFunction();
    })();
  },
  secondFunction: function() {
    document.write('secondFunction invoked.');
  }
};
myNamespace.firstFunction();</pre></div><p>And this is where <code class="literal">that</code> becomes <code class="literal">this</code>.</p></div><div class="section" title="Getting location"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec52"/>Getting location</h2></div></div></div><a id="id229" class="indexterm"/><p>Until now the <span class="strong"><strong>Find Movies</strong></span> button we placed on the page was non-functional. Click on it and nothing happens. We will add an event handler for that button so that something does happen when you click on it. Add the following inside the <code class="literal">movienow.geolocation</code> object:</p><div class="informalexample"><pre class="programlisting">jQuery(document).ready(function(){  
    jQuery('#find-movies').click(function(){
       alert('Button clicked!');
    });
});</pre></div><p>The <code class="literal">movienow.geolocation.js</code> file should now look like the following code:</p><div class="informalexample"><pre class="programlisting">var movienow = movienow || {};
movienow.geolocation = (function(){
    var that = this;
    jQuery(document).ready(function(){  
        jQuery('#find-movies').click(function(){alert('Button clicked!');});
    });
})();</pre></div><p>Now click on <span class="strong"><strong>Find Movie</strong></span>. You should get the following alert box:</p><div class="mediaobject"><img src="graphics/5689_04_02.jpg" alt="Getting location"/></div><a id="id230" class="indexterm"/><p>That may be all well and good, but our goals are much loftier. We want to get some location data. We do this by adding a couple of methods: <code class="literal">getLocation</code> and <code class="literal">locationCallback</code>:</p><div class="informalexample"><pre class="programlisting">this.getLocation = function(){
  if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(this.locationCallback);
  }
};
this.locationCallback = function(loc){ 
  jQuery('#movies-near-me').html('Lat:' + loc.coords.latitude + ', Long: ' + loc.coords.longitude);
};</pre></div><p>The first function is of course where we invoke the <code class="literal">getCurrentPosition</code> method already discussed. The second function is <code class="literal">successCallback</code>. We can now remove the alert in the event handler for the <span class="strong"><strong>Find Movies</strong></span> button and replace it with the following:</p><div class="informalexample"><pre class="programlisting">that.getLocation();</pre></div><p>The <code class="literal">movienow.geolocation.js</code> file should now look like the following code:</p><div class="informalexample"><pre class="programlisting">var movienow = movienow || {};
movienow.geolocation = (function(){
    var that = this;
    jQuery(document).ready(function(){  
        jQuery('#find-movies').click(function(){that.getLocation();});
    });
    this.getLocation = function(){
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(this.locationCallback);
        }
    };
    this.locationCallback = function(loc){
      jQuery('#movies-near-me').html('Lat:' + loc.coords.latitude + ', Long: ' + loc.coords.longitude);
    };
})();</pre></div><p>Now when you click on the <span class="strong"><strong>Find Movies</strong></span> button<a id="id231" class="indexterm"/>, a request is made through the geolocation API for location data.</p><p>The web browser will typically prompt you for permission to track your physical location. The following screenshot shows examples for Safari, Chrome, ad Firefox respectively. <a id="id232" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/5689_04_03.jpg" alt="Getting location"/></div><p>This will happen only once. When you click on <span class="strong"><strong>Allow</strong></span>, the browser will save this setting for the specified domain.</p><div class="mediaobject"><img src="graphics/5689_04_04.jpg" alt="Getting location"/></div><a id="id233" class="indexterm"/><p>You should now see latitude and longitude displayed on the page. Congratulations! Your enterprise application is now aware of where you are.</p></div><div class="section" title="Getting postal codes"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec53"/>Getting postal codes</h2></div></div></div><a id="id234" class="indexterm"/><p>Now that we have geographic coordinates, the next step is to map them to postal codes. Once we have postal codes, we can get movie listings. In order to get postal codes, we will need to make an AJAX request to a web service, sending the latitude and longitude and in turn receiving postal codes. There are a number of web services that provide this data. For our MovieNow enterprise application, we will employ a service from <a class="ulink" href="http://geonames.org">geonames.org</a>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note15"/>Note</h3><p>The GeoNames geographical database covers all countries and contains over eight million placenames that are available for download free of charge. It is licensed under Creative Commons Attribution 3.0.</p></div></div><p>
<a class="ulink" href="http://Geonames.org">Geonames.org</a> provides a convenient web service called <code class="literal">findNearbyPostalCodesJSON</code> for obtaining postal code data. This service takes the following parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">lat</code>: This specifies the latitude in decimal degrees</li><li class="listitem" style="list-style-type: disc"><code class="literal">lng</code>: This specifies the longitude in decimal degrees</li><li class="listitem" style="list-style-type: disc"><code class="literal">radius</code>: This specifies the radius in kilometers</li><li class="listitem" style="list-style-type: disc"><code class="literal">maxRows</code>: This specifies the maximum number of rows to return</li><li class="listitem" style="list-style-type: disc"><code class="literal">style</code>: This specifies the verbosity of the response (<code class="literal">SHORT</code>, <code class="literal">MEDIUM</code>, <code class="literal">LONG</code>, <code class="literal">FULL</code>)</li><li class="listitem" style="list-style-type: disc"><code class="literal">country</code>: This specifies the country to look in</li><li class="listitem" style="list-style-type: disc"><code class="literal">localCountry</code>: This parameter, when set to <code class="literal">true</code>, returns only codes within the country <a id="id235" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">username</code>: The account for which you are accessing the data</li></ul></div><p>The following is an example service call:</p><p>
<a class="ulink" href="http://api.geonames.org/findNearbyPostalCodesJSON?lat=45&amp;lng=-66.7&amp;username=demo">http://api.geonames.org/findNearbyPostalCodesJSON?lat=45&amp;lng=-66.7&amp;username=demo</a>
</p><p>It returns the following JSON output:</p><div class="informalexample"><pre class="programlisting">{
  "postalCodes": [
    {
      "distance": "10.13582",
      "adminCode1": "NB",
      "postalCode": "E5H",
      "countryCode": "CA",
      "lng": -66.769962,
      "placeName": "Pennfield",
      "lat": 45.076588,
      "adminName1": "New Brunswick"
    }
  ]
}</pre></div><p>You can copy/paste this URL into a web browser and see for yourself.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip24"/>Tip</h3><p>The web services are throttled meaning that only a certain number of requests per day are serviced for a given username. That is why you should register your own account with <a class="ulink" href="http://geonames.org">geonames.org</a> before proceeding. Once you do so, swap in <code class="literal">demo</code> with your username.</p></div></div><p>Now that we have the ability to map coordinates to postal codes, we will need to make an AJAX request to make the call and retrieve the data. We will be using jQuery to assist us in making the request<a id="id236" class="indexterm"/>.</p></div><div class="section" title="AJAX ain't just a cleaning product"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec54"/>AJAX ain't just a cleaning product</h2></div></div></div><p>Standing for Asynchronous JavaScript and XML, AJAX is a technique whereby the <code class="literal">XMLHttpRequest</code> object is used to make a call to the server for additional content, save state, poll for resources, and so on. It is a useful way of extending your page with additional functionality without a page refresh.<a id="id237" class="indexterm"/>
</p><p>The jQuery library<a id="id238" class="indexterm"/> (<a class="ulink" href="http://jquery.com">http://jquery.com</a>) makes it fairly easy and straightforward to make AJAX requests in a cross-browser compatible way. Take a look at the following code:</p><div class="informalexample"><pre class="programlisting">jQuery.ajax({
  url: 'http://some-domain.com/some-web-service',
  data: 'q=something'
  success: function(payload){
    alert(payload);
  },
  error: function(error){
    alert(error.responseText);
  }
});</pre></div><p>You simply need to set the URL and arguments. You can define a success event handler and an error event handler. The success handler will be invoked when the AJAX request successfully completes passing the payload as an argument. The error handler will be invoked when the AJAX request returns anything other than a 200 status code. </p><p>Add the following code snippet to your <code class="literal">movienow.geolocation</code> object:</p><div class="informalexample"><pre class="programlisting">this.reverseGeocode = function(loc){
  jQuery.ajax({
    url: 'http://api.geonames.org/findNearbyPostalCodesJSON',
    data: 'lat=' + loc.coords.latitude + '&amp;lng=' + loc.coords.longitude + '&amp;username=demo', //Swap in with your geonames.org username
    success: function(payload){
      var data = that.objectifyJSON(payload);
      var postalCodes = [];
      for (var i=0; i&lt;data.postalCodes.length; ++i) {
        postalCodes.push(data.postalCodes[i].postalCode);
      }
      jQuery('#movies-near-me').html(postalCodes.join(','));
    }
  });
};
this.objectifyJSON = function(json) {
  if (typeof(json) == "object") {
    return json;
  }
  else {
    return jQuery.parseJSON(json);
  }
};</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip25"/>Tip</h3><p>We are showing our errors using an <code class="literal">alert</code> popup, but for a final application we should define a CSS styled DOM to show notifications and errors.</p></div></div><a id="id239" class="indexterm"/><p>Replace the contents of <code class="literal">locationCallback</code> with the following:</p><div class="informalexample"><pre class="programlisting">that.reverseGeocode(loc);</pre></div><p>Upon invocation of the <code class="literal">successCallback</code> function, we are going to take the <code class="literal">Positon</code> object and pass it along to our <code class="literal">reverseGeocode</code> method<a id="id240" class="indexterm"/>, which makes an AJAX request to the <code class="literal">geonames.org</code> web service to retrieve the postal codes for the location of the device. In the success handler for the AJAX request, we extract the postal codes from the JSON object and put them into an array. We then display the array on the page. Note the <code class="literal">objectifyJSON</code> method. We do this because some browsers will automatically marshal the payload data into an object while others treat it as a string.</p><p>The <code class="literal">movienow.geolocation.js</code> file should now look like the following code:</p><div class="informalexample"><pre class="programlisting">var movienow = movienow || {};
movienow.geolocation = (function(){
    var that = this;
    jQuery(document).ready(function(){  
        jQuery('#find-movies').click(function(){that.getLocation();});
    });
    this.getLocation = function(){
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(this.locationCallback);
        }
    };
    this.locationCallback = function(loc){
        that.reverseGeocode(loc);
    };
    this.reverseGeocode = function(loc){
        jQuery.ajax({
            url: 'http://api.geonames.org/findNearbyPostalCodesJSON',
            data: 'lat=' + loc.coords.latitude + '&amp;lng=' + loc.coords.longitude + '&amp;username=demo', //Swap in with your geonames.org username
            success: function(payload){
                var data = that.objectifyJSON(payload);
                var postalCodes = [];
                for (var i=0; i&lt;data.postalCodes.length; ++i) {
                    postalCodes.push(data.postalCodes[i].postalCode);
                }
                jQuery('#movies-near-me').html(postalCodes.join(','));
            },
            error: function(error){
                alert(error.responseText);
            }
        });
    };
    this.objectifyJSON = function(json) {
        if (typeof(json) == "object") {
            return json;
        }
        else {
            return jQuery.parseJSON(json);
        }
    };
})();</pre></div><a id="id241" class="indexterm"/><p>When you click on <span class="strong"><strong>Find Movies</strong></span>, you should see the following as shown in the screenshot:</p><div class="mediaobject"><img src="graphics/5689_04_05.jpg" alt="AJAX ain't just a cleaning product"/></div></div><div class="section" title="From postal codes to showtimes"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec55"/>From postal codes to showtimes</h2></div></div></div><a id="id242" class="indexterm"/><p>Now that we have postal codes, we can map those to movie showtimes. Unfortunately, there is no free web service from which we can get this kind of data. All is not lost however. <a class="ulink" href="http://Moviefone.com">Moviefone.com</a> does offer feeds based on postal codes. One wrinkle however is that we cannot easily get feed data via JavaScript because of cross-domain limitations. The cross-domain Ajax library only works for services that return JSON. To work around this, we can create a proxy.</p><p>Create a file called <code class="literal">movielistings.php</code>. Add the following to your newly created file:</p><div class="informalexample"><pre class="programlisting">&lt;?php 
   $zips = $_GET['zip'];
   $zips = explode(',', $zips);
   $listings = array();
   for ($i=0; $i&lt;count($zips); $i++) {
        $listings[$i] = file_get_contents('http://gateway.moviefone.com/movies/pox/closesttheaters.xml?zip=' . $zips[$i]); 
       $listings[$i] = simplexml_load_string($listings[$i]);
   }
    echo json_encode($listings);
?&gt;</pre></div><p>This is a simple PHP file that makes requests to Moviefone.com's closest theaters feed based on a string of postal codes passed in the query string, and converts the output into JSON. To run this, you will need to make sure you have PHP installed on your machine. Otherwise, we could easily write something similar using JSP, ASP.NET, or Node.js for example. <a id="id243" class="indexterm"/>
</p><p>Once we have our movie listings proxy service, we can add the following to <code class="literal">movienow.geolocation</code>:</p><div class="informalexample"><pre class="programlisting">this.getShowtimes = function(postalCodes) {
    jQuery.ajax({
        url: 'movielistings.php',
        data: 'zip=' + postalCodes.join(','),
        success: function(payload){
            var data = that.objectifyJSON(payload);
            that.displayShowtimes(that.constructMoviesArray(data));
        },
        error: function(error){
            alert(error.responseText);
        }
    });
};
this.constructMoviesArray = function(data) {
    var key, movie, theater = null;
    var movies = {};
    movies.items = {};
    movies.length = 0;
    for (var j=0; j&lt;data.length; ++j) {
        if (data[j].movie) {
            theater = data[j].theater;
            for (var i=0; i&lt;data[j].movie.length; ++i) {
                movie = data[j].movie[i];
                key = movie.movieId + '|'+ theater.theaterId;
                if (!movies.items[key]) {
                    movie.theater = theater;
                    movies.items[key] = movie;
                    movies.length++;
                }
            }
        }
    }
    return movies;
};
this.displayShowtimes = function(movies) {
    var movie = null;
    var html = '';
    for (var item in movies.items) {
        movie = movies.items[item];
        html += '&lt;p&gt;&lt;strong&gt;' + movie.title + '&lt;/strong&gt;&lt;br /&gt;' + movie.showtime.join(',') + '&lt;/p&gt;'; 
    }
    jQuery('#movies-near-me').html(html);
};</pre></div><a id="id244" class="indexterm"/><p>Once done, replace the line in the <code class="literal">reverseGeocode</code> method where we are populating <code class="literal">#movies-near-me</code> with the following line of code:</p><div class="informalexample"><pre class="programlisting">that.getShowtimes(postalCodes);</pre></div><p>We have thus added three more methods: <code class="literal">getShowtimes</code>, <code class="literal">constructMoviesArray</code>, and <code class="literal">displayShowtimes</code>. The <code class="literal">getShowtimes</code> method makes an AJAX request to the movie listings proxy, grabs the JSON data returned and calls <code class="literal">constructMoviesArray</code> to extract the relevant data and remove duplicates, and then calls <code class="literal">displayShowtimes</code> to display the data.</p><p>The final <code class="literal">movienow.geolocation.js</code> file should now look like the following code:</p><div class="informalexample"><pre class="programlisting">var movienow = movienow || {};
movienow.geolocation = (function(){
    var that = this;
    jQuery(document).ready(function(){  
        jQuery('#find-movies').click(function(){that.getLocation();});
    });
    this.getLocation = function(){
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(this.locationCallback);
        }
    };
    this.locationCallback = function(loc){
        that.reverseGeocode(loc);
    };
    this.reverseGeocode = function(loc){
        jQuery.ajax({
            url: 'http://api.geonames.org/findNearbyPostalCodesJSON',
            data: 'lat=' + loc.coords.latitude + '&amp;lng=' + loc.coords.longitude + '&amp;username=demo',
            success: function(payload){
                var data = that.objectifyJSON(payload);
                var postalCodes = [];
                for (var i=0; i&lt;data.postalCodes.length; ++i) {
                    postalCodes.push(data.postalCodes[i].postalCode);
                }
                that.getShowtimes(postalCodes);
            },
            error: function(error){
                alert(error.responseText);
            }
        });
    };
    this.objectifyJSON = function(json) {
        if (typeof(json) == "object") {
            return json;
        }
        else {
            return jQuery.parseJSON(json);
        }
    };
    this.getShowtimes = function(postalCodes) {
        jQuery.ajax({
            url: 'movielistings.php',
            data: 'zip=' + postalCodes.join(','),
            success: function(payload){
                var data = that.objectifyJSON(payload);
                that.displayShowtimes(that.constructMoviesArray(data));
            }
        });
    };
    this.constructMoviesArray = function(data) {
        var key, movie, theater = null;
        var movies = {};
        movies.items = {};
        movies.length = 0;
        for (var j=0; j&lt;data.length; ++j) {
            if (data[j].movie) {
                theater = data[j].theater;
                for (var i=0; i&lt;data[j].movie.length; ++i) {
                    movie = data[j].movie[i];
                    key = movie.movieId + '|'+ theater.theaterId;
                    if (!movies.items[key]) {
                        movie.theater = theater;
                        movies.items[key] = movie;
                        movies.length++;
                    }
                }
            }
        }
        return movies;
    };
    this.displayShowtimes = function(movies) {
        var movie = null;
        var html = '';
        for (var item in movies.items) {
            movie = movies.items[item];
            html += '&lt;p&gt;&lt;strong&gt;' + movie.title + '&lt;/strong&gt;&lt;br /&gt;' + movie.showtime.join(',') + '&lt;/p&gt;'; 
        }
        jQuery('#movies-near-me').html(html);
    };
})();</pre></div><a id="id245" class="indexterm"/><p>When you click on the <span class="strong"><strong>Find Movies</strong></span> button, you should see the following screenshot:</p><div class="mediaobject"><img src="graphics/5689_04_06.jpg" alt="From postal codes to showtimes"/></div><a id="id246" class="indexterm"/><p>Of course, we have much more data to show, but we will get to that in later chapters.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec44"/>Summary</h1></div></div></div><p>In this chapter, we walked through how the geolocation API works and how to use it. We added a button to our enterprise application and wired it to make a request to the geolocation API. We used the coordinates from the <code class="literal">Position</code> object returned to make an AJAX request to a web service to get postal codes for those coordinates. Using the postal codes, we made a request to a feed to get movie showtimes data and we displayed that data on the page.</p><p>In the next chapter, we will go over displaying the wealth of data we made available to ourselves in this chapter. We will cover CSS in more depth and talk about what's new in CSS3. We will even build some nifty CSS3 effects to make our enterprise application look interesting and inviting.</p></div></body></html>