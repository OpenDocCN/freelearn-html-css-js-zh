<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Using Location Services</h1></div></div></div><p>In this chapter we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Native geolocation using basicGeo</li><li class="listitem" style="list-style-type: disc">Using the Ti.GeoProviders framework for geolocation</li><li class="listitem" style="list-style-type: disc">Multitenant geolocation</li><li class="listitem" style="list-style-type: disc">Calculating distance between addresses</li><li class="listitem" style="list-style-type: disc">Background geolocation management</li></ul></div><div><div><div><div><h1 class="title"><a id="ch06lvl1sec40"/>Introduction</h1></div></div></div><p>Until the proliferation of mobiles, it was often challenging to tell the location of your users, making it difficult to provide location-based services. Now, almost every app developer has access to real-time geolocation information directly from the user's device.</p><p>With the globally mobile nature of today's employees, providing location-aware apps to your enterprise is just as important, if not more so as in the consumer market. Geolocation<a id="id509" class="indexterm"/> is playing a large role in enterprise organizations across a variety of domains including, fleet management, shipment tracking, sales routing, or simply providing real-time relevant information on resources available to mobile employees.</p><p>Through a series of location service examples, this chapter outlines a variety of different approaches you can leverage in your Enterprise Titanium app.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec41"/>Native geolocation using basicGeo</h1></div></div></div><p>Android and iOS both <a id="id510" class="indexterm"/>provide powerful geolocation platform APIs<a id="id511" class="indexterm"/> to find the geographical latitude and longitude of a given address. You can use the <code class="literal">basicGeo</code> module to access these platform APIs in your Titanium module.</p><p>This recipe discusses how to leverage this module in your Titanium app to perform forward and reverse geolocation operations. The following screenshots illustrate this recipe running on both an iPhone and an Android device:</p><div><img src="img/5343OT_06_01.jpg" alt="Native geolocation using basicGeo"/></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec88"/>Getting ready</h2></div></div></div><p>This recipe uses the <code class="literal">benCode.basicGeo</code> native module. This module can be downloaded from the source <a id="id512" class="indexterm"/>code provided by the book, or individually through the links provided in the <em>See also</em> section at the end of this recipe. Installing these in your project is straightforward. Simply copy the <code class="literal">modules</code> folder into your project as highlighted in the following screenshot:</p><div><img src="img/5343OT_06_02.jpg" alt="Getting ready"/></div><p>After copying the <code class="literal">modules</code> folder, you will need to click on your <strong>tiapp.xml</strong> file in Titanium Studio <a id="id513" class="indexterm"/>and add a reference to the <code class="literal">bencoding.basicgeo</code> module as shown in the following screenshot:</p><div><img src="img/5343OT_06_03.jpg" alt="Getting ready"/></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec89"/>How to do it...</h2></div></div></div><p>Once you <a id="id514" class="indexterm"/>have added the <code class="literal">bencoding.basicgeo</code> module to your project, you next need to create your application namespaces in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the module into your code as the following code snippet demonstrates:</p><div><pre class="programlisting">//Create our application namespace
var my = {
  basicGeo : require('bencoding.basicgeo'),
  isAndroid : Ti.Platform.osname === 'android'
};</pre></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec154"/>Adding availability helpers</h3></div></div></div><p>With an <a id="id515" class="indexterm"/>ever-increasing number of devices each having different capabilities, it is a common requirement to provide progressive enhancements based on the ability of sensors. The availability feature in the <code class="literal">basicGeo</code> module<a id="id516" class="indexterm"/> provides a series of properties that can be used to determine the capabilities of the devices. The following snippet shows how to create the <code class="literal">Availability</code> proxy, for later use in this recipe:</p><div><pre class="programlisting">my.available = my.basicGeo.createAvailability();</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec155"/>Adding the location services purpose</h3></div></div></div><p>To use<a id="id517" class="indexterm"/> location services on iOS, Apple requires a purpose or reason for the app to access the GPS. On first request, this message will be used in the message presented to the user for approval to use their device's location services. The following snippet demonstrates how to add this purpose to the <code class="literal">basicGeo</code> module.</p><div><pre class="programlisting">my.basicGeo.purpose = 'Demo of basicGeo';</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec156"/>Building the recipe UI</h3></div></div></div><p>This following <a id="id518" class="indexterm"/>code snippet describes how to create the UI shown in this recipe's earlier screenshots:</p><div><ol class="orderedlist arabic"><li class="listitem">The first step is to create the <code class="literal">Ti.UI.Window</code> to which all visual elements will be attached.<div><pre class="programlisting">var win = Ti.UI.createWindow({
  backgroundColor: '#fff', title: 'benCoding Geo Recipe', 
  barColor:'#000',fullscreen:false
});</pre></div></li><li class="listitem">Next a <code class="literal">Ti.UI.TextField</code> is added to the recipe's <code class="literal">Ti.UI.Window</code>. The contents of this <code class="literal">Ti.UI.TextField</code> will be used during the forward geolocation lookup detailed later in this recipe.<div><pre class="programlisting">var txtAddress = Ti.UI.createTextField({
  hintText:'enter address', height:40, 
  left:5, right:60, top:55
});
win.add(txtAddress);</pre></div></li><li class="listitem">The<a id="id519" class="indexterm"/> next step in this recipe is to add a <code class="literal">Ti.Map.View</code> to the recipe's <code class="literal">Ti.UI.Window</code>. This UI component will be used to display the address entered in the <code class="literal">txtAddress Ti.UI.TextField</code>.<div><pre class="programlisting">var mapView = Ti.Map.createView({
  top:160, bottom:0, left:5, right:5, 
  userLocation:false
});
win.add(mapView);</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec157"/>Working with place objects</h3></div></div></div><p>When<a id="id520" class="indexterm"/> performing geolocation lookups, the <code class="literal">basicGeo</code> module returns a collection of places that match the address provided. The <code class="literal">placeHelpers</code> object provides convenient functions for working with the results returned from the <code class="literal">basicGeo</code> module.</p><div><pre class="programlisting">var placeHelpers = {</pre></div><div><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">address</code> function provides a formatted address from a <code class="literal">basicGeo</code> place object. This is used by the "find current location" feature in this recipe.<div><pre class="programlisting">  address :function(place){
    if(my.isAndroid){</pre></div></li><li class="listitem">The Android reverse geolocation API provides an <code class="literal">address</code> field already formatted.<div><pre class="programlisting">      return place.address;
    }else{</pre></div></li><li class="listitem">In iOS, the address information is provided as an array of lines. The following method converts these address lines into a formatted string:<div><pre class="programlisting">      var lines = place.addressDictionary
      .FormattedAddressLines;
      var iLength = lines.length, address = '';
      for (iLoop=0;iLoop &lt; iLength;iLoop++){
        if(address.length&gt;0){
          address += ' ' + lines[iLoop];
        }else{
          address = lines[iLoop];
        }
      }
      return address;
    }
  },</pre></div></li><li class="listitem">The <a id="id521" class="indexterm"/><code class="literal">addToMap</code> methods<a id="id522" class="indexterm"/> add the place information provided by the <code class="literal">basicGeo</code> reverse geolocation to the <code class="literal">Ti.Map.View</code> created earlier in this recipe.<div><pre class="programlisting">  addToMap: function(place){
    var lat = place.latitude, 
    lng = place.longitude, 
    title = placeHelpers.address(place);
    var pin = Ti.Map.createAnnotation({
      latitude:lat,longitude:lng,
      title:title
    });
    mapView.addAnnotation(pin);</pre></div></li><li class="listitem">A region is created using the latitude and longitude information from the <code class="literal">basicGeo</code> module. The <code class="literal">setLocation</code> method<a id="id523" class="indexterm"/> is then called to zoom the <code class="literal">Ti.Map.View</code> to the pin's coordinates.<div><pre class="programlisting">    var region = {latitude:lat,
     longitude:lng,animate:true,
     latitudeDelta:0.04, longitudeDelta:0.04};
     mapView.setLocation(region);
  }
};</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec158"/>Finding current location</h3></div></div></div><p>Perform the <a id="id524" class="indexterm"/>following steps to find the current location:</p><div><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">findButton</code> demonstrates how to perform a reverse geolocation lookup using the device's current coordinates. These coordinates are then used to find the current address of the user.<div><pre class="programlisting">var findButton = Ti.UI.createButton({
  right:5, top:55, height:40, width:50, title:'Find'
});
win.add(findButton);</pre></div></li><li class="listitem">On the <a id="id525" class="indexterm"/>click event of the <code class="literal">findButton</code>, the <code class="literal">getCurrentPlace</code> method<a id="id526" class="indexterm"/> is called on the <code class="literal">basicGeo</code> module's <code class="literal">currentGeoLocation</code> proxy.<div><pre class="programlisting">findButton.addEventListener('click',function(e){</pre></div></li><li class="listitem">The <code class="literal">resultsCallback</code> method<a id="id527" class="indexterm"/> is created to handle the results returned by the <code class="literal">getCurrentPlace</code> method<a id="id528" class="indexterm"/>. The result from the <code class="literal">getCurrentPlace</code> method is provided to the <code class="literal">e</code> argument.<div><pre class="programlisting">  function resultsCallback(e){</pre></div></li><li class="listitem">The <code class="literal">e.success</code> property provides a flag to determine if the geolocation operation has encountered an error.<div><pre class="programlisting">    if(!e.success){
      alert('Sorry we encountered an error.');
      return;
    }</pre></div></li><li class="listitem">The <code class="literal">e.placeCount</code> property provides the number of place objects returned. Generally, this is a number between <code class="literal">0</code> and <code class="literal">12</code> depending on the accuracy. If no places are returned, alert the user that the address was not found.<div><pre class="programlisting">    if(e.placeCount === 0){
      alert('Unable to find your address.');
      return;
    }</pre></div></li><li class="listitem">The first place in the places collection is provided to the <code class="literal">placeHelpers</code>.address method<a id="id529" class="indexterm"/>. This method provides a formatted address string that is then presented to the user in the <code class="literal">Ti.UI.TextField txtAddress</code>.<div><pre class="programlisting">    txtAddress.value = 
    placeHelpers.address(e.places[0]);
  };</pre></div></li><li class="listitem">A new instance of the <code class="literal">CurrentGeoLocation</code> proxy is created. This proxy contains methods to perform geolocation operations using the device's current coordinates.<div><pre class="programlisting">  var currentGeo = my.basicGeo.createCurrentGeolocation();</pre></div></li><li class="listitem">If the recipe is running on an Android device, the <code class="literal">setCache</code> method can be called. This enables the <code class="literal">basicGeo</code> module to use the last best location cached by the device. This provides faster lookup speeds, but can result in less accurate location information.<div><pre class="programlisting">  if(my.isAndroid){
    currentGeo.setCache(true);
  }</pre></div></li><li class="listitem">The<a id="id530" class="indexterm"/> final step in returning the device's current address is to call the <code class="literal">getCurrentPlace</code> method. This method performs a reverse geolocation lookup using the device's coordinates and provides a collection of places to the <code class="literal">provide</code> callback method. The following snippet demonstrates how to call this method using the <code class="literal">resultsCallback</code> as the callback argument.<div><pre class="programlisting">  currentGeo.getCurrentPlace(resultsCallback);
});</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec159"/>Forward location lookup</h3></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">searchTextAddressButton Ti.UI.Button</code> performs<a id="id531" class="indexterm"/> a forward geolocation lookup using the native device API.<div><pre class="programlisting">var addressOnMapButton = Ti.UI.createButton({
  right:5, left:5, height:40, 
  title:'Show address on Map',top:110
});
win.add(searchTextAddressButton);</pre></div></li><li class="listitem">The <code class="literal">searchTextAddressButton Ti.UI.Button</code> on click event performs a forward geolocation lookup using the address entered in the <code class="literal">txtAddress Ti.UI.TextField</code>.<div><pre class="programlisting">searchTextAddressButton.addEventListener('click',function(e){</pre></div></li><li class="listitem">The first step in the forward geolocation lookup is to verify that the user entered an address in the <code class="literal">txtAddress Ti.UI.TextField</code>.<div><pre class="programlisting">  if(txtAddress.value.length==0){
    alert('Please enter an address to display');
  }</pre></div></li><li class="listitem">The <code class="literal">forwardGeoCallback</code> method is created to handle the results returned by the <code class="literal">forwardGeocoder</code> method. The result from the <code class="literal">forwardGeocoder</code> method is provided to the <code class="literal">e</code> argument.<div><pre class="programlisting">  function forwardGeoCallback(e){
    if(!e.success){
      alert('Sorry we encountered an error.');
      return;
    }
    if(e.placeCount === 0){
      alert('Unable to find address entered.');
      return;
    }</pre></div></li><li class="listitem">The <code class="literal">addToMap</code> method is creating a call using the first place in the places collection. This<a id="id532" class="indexterm"/> method will create a pin on the <code class="literal">Ti.Map.View</code> with the place object details.<div><pre class="programlisting">    placeHelpers.addToMap(e.places[0]);
  };</pre></div></li><li class="listitem">The next step in performing a forward geolocation lookup, is to call the <code class="literal">forwardGeocoder</code> method<a id="id533" class="indexterm"/> and provide a callback method as shown in the following line:<div><pre class="programlisting">  var geoCoder = my.basicGeo.createGeocoder();</pre></div></li><li class="listitem">In the sample, the <code class="literal">txtAddress.value</code> and <code class="literal">forwardGeoCallback</code> are provided to the <code class="literal">forwardGeocoder</code> method. The results of the forward geolocation lookup will be provided to the <code class="literal">forwardGeoCallback</code> function<a id="id534" class="indexterm"/> as discussed earlier in this recipe.<div><pre class="programlisting">  geoCoder.forwardGeocoder(txtAddress.value,
  forwardGeoCallback);
});</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec160"/>Device capability check</h3></div></div></div><p>Follow these steps to perform a <a id="id535" class="indexterm"/>device capability check:</p><div><ol class="orderedlist arabic"><li class="listitem">This recipe requires that the device supports reverse and forward geolocation operations. On load of the main recipe's <code class="literal">Ti.UI.Window</code>, the <code class="literal">Availability</code> object created earlier in this recipe is used to alert the user if his/her device can support running this recipe.<div><pre class="programlisting">win.addEventListener('open',function(e){</pre></div></li><li class="listitem">The <code class="literal">reverseGeoSupported</code> property is checked to determine if the device running the recipe can support running the recipe.<div><pre class="programlisting">  if(!my.available.reverseGeoSupported){</pre></div></li><li class="listitem">If the<a id="id536" class="indexterm"/> device does not support reverse geolocation, the user is alerted of the possible issues.<div><pre class="programlisting">    if(my.isAndroid){
      alert("Configuration isn't supported.");
    }else{
      alert('iOS 5 or greater is required');
    }
  }	
});	
win.open({modal:true});</pre></div><div><div><h3 class="title"><a id="tip33"/>Tip</h3><p>This recipe requires Android 4.0 or greater when running in the emulator due to an Android emulator defect.</p></div></div></li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec90"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">This recipe uses the <code class="literal">basicGeo</code> module to perform native geolocation. For licensing, source code, and to learn more about this project, please visit <a class="ulink" href="https://github.com/benbahrenburg/benCoding.BasicGeo">https://github.com/benbahrenburg/benCoding.BasicGeo</a>.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec42"/>Using the Ti.GeoProviders framework for geolocation</h1></div></div></div><p>The<a id="id537" class="indexterm"/> <code class="literal">Ti.GeoProviders</code>
<a id="id538" class="indexterm"/> framework provides a multiprovider approach to reverse geolocation. With a variety of providers, the <code class="literal">Ti.GeoProviders</code> framework provides a common API for handling GeoNames.org, Google, and basicGeo geolocation operations. </p><p>The following <a id="id539" class="indexterm"/>recipe demonstrates how to use the <code class="literal">Ti.GeoProviders</code> framework and its associated providers. The following screenshots illustrate this recipe running on both an iPhone and an Android device:</p><div><img src="img/5343OT_06_04.jpg" alt="Using the Ti.GeoProviders framework for geolocation"/></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec91"/>Getting ready</h2></div></div></div><p>This recipe <a id="id540" class="indexterm"/>uses both CommonJS and native modules. These can be downloaded from the source code provided by the book, or individually through the links provided in the <em>See also</em> section at the end of this recipe. Simply copy the <code class="literal">Ti.GeoProviders</code> folder into the <code class="literal">Resources</code> folder of your project and then copy the <code class="literal">modules</code> folder into your project as shown in the following screenshot. Finally, copy the <code class="literal">provider_picker.js</code> file into the <code class="literal">Resources</code> folder of your Titanium project as also highlighted in the following screenshot:</p><div><img src="img/5343OT_06_05.jpg" alt="Getting ready"/></div><p>After copying the file and folder mentioned here, you will need to click on your <strong>tiapp.xml</strong> file <a id="id541" class="indexterm"/>in Titanium Studio and add a reference to the <a id="id542" class="indexterm"/>
<code class="literal">bencoding.basicgeo</code> module as shown in the following screenshot:</p><div><img src="img/5343OT_06_06.jpg" alt="Getting ready"/></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec92"/>How to do it...</h2></div></div></div><p>Once you have <a id="id543" class="indexterm"/>added native and CommonJS modules to your project, you need to create your application namespaces in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the module into your code as the following code snippet demonstrates:</p><div><pre class="programlisting">//Create our application namespace
var my = {
  picker : require('provider_picker'),
  currentProvider:null,
  providers:[
    require('./GeoProviders/geonames_geoprovider'),
    require('./GeoProviders/bencoding_geoprovider'),
    require('./GeoProviders/google_geoprovider')
  ]
};</pre></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec161"/>Adding your API key</h3></div></div></div><p>Many <a id="id544" class="indexterm"/>of the Geo Providers require an API key. The <code class="literal">Ti.GeoProvider</code> includes the <code class="literal">addKey</code> method to allow you to associate your API key before making a service call. The following snippet demonstrates how to add the API key <code class="literal">demo</code> to your service calls.</p><div><pre class="programlisting">my.currentProvider.addKey('demo');</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec162"/>Adding your purpose</h3></div></div></div><p>To use location services in iOS <a id="id545" class="indexterm"/>requires a purpose or reason for the app to access the GPS. On the first request, this message will be presented to the user. The following code demonstrates how to add this purpose to the <code class="literal">Ti.GeoProviders</code> using the <a id="id546" class="indexterm"/>
<code class="literal">addPurpose</code> method:</p><div><pre class="programlisting">my.currentProvider.addPurpose('Demo of Geo Provider');</pre></div><div><div><h3 class="title"><a id="note10"/>Note</h3><p>Android does not require the purpose be provided; in this case the purpose defined is not used when accessing the GPS.</p></div></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec163"/>Building the recipe UI</h3></div></div></div><p>The following<a id="id547" class="indexterm"/> code snippet describes how to create the UI shown in this recipe's earlier screenshots:</p><div><ol class="orderedlist arabic"><li class="listitem">The first step is to create the <code class="literal">Ti.UI.Window</code> to which all visual elements will be attached.<div><pre class="programlisting">var win = Ti.UI.createWindow({
  backgroundColor: '#fff', title: 'Ti.GeoProviders', 
  barColor:'#000',fullscreen:false
});</pre></div></li><li class="listitem">Next a <code class="literal">Ti.Map.View</code> is added to the <code class="literal">Ti.UI.Window</code>. This  is used to plot the location information provided by the GeoProvider.<div><pre class="programlisting">var mapView = Ti.Map.createView({
  top:140, bottom:0, width:Ti.UI.FILL,
  userLocation:false	
});
win.add(mapView);</pre></div></li><li class="listitem">A <code class="literal">picker</code> control is then added to the <code class="literal">Ti.UI.Window</code>. This control contains a list of providers and a callback method to switch between them. When the user updates the selected picker, the<a id="id548" class="indexterm"/> <code class="literal">lookup.updateProvider</code> method is called to switch the active <code class="literal">Ti.GeoProvider</code>. See the <em>Lookup functions</em> section in this recipe for more details.<div><pre class="programlisting">var picker = my.picker.createPicker({
  top:30, height:40},lookup.updateProvider
});
win.add(picker);</pre></div></li><li class="listitem">The <code class="literal">findButton</code> button is the final UI component added to the recipe's <code class="literal">Ti.UI.Window</code>. This <code class="literal">Ti.UI.Button</code> is used to run the recipe's reverse geolocation lookup.<div><pre class="programlisting">var findButton = Ti.UI.createButton({
  title:'Find Current Location', 
  left:10, right:10,top:30,height:40
});
win.add(findButton);</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec164"/>Running the reverse geolocation</h3></div></div></div><p>For running the<a id="id549" class="indexterm"/> reverse geolocation, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">When the user presses the <code class="literal">findButton</code>, the click event is fired and the following snippet is run:<div><pre class="programlisting">findButton.addEventListener('click',function(e){</pre></div></li><li class="listitem">The <a id="id550" class="indexterm"/>first step in this section of the recipe is to check that a network connection is available. A network connection is needed to contact the <code class="literal">Ti.GeoProvider</code> web service to perform the reverse geolocation lookup.<div><pre class="programlisting">  if(!Ti.Network.online){</pre></div></li><li class="listitem">If no network connection is available, the user is alerted to this requirement and the lookup process is stopped.<div><pre class="programlisting">    alert("You must be online to run this recipe");
    return;
  }</pre></div></li><li class="listitem">The final step in this section of the recipe is to call the <code class="literal">getCurrentAddress</code> method of <code class="literal">Ti.GeoProviders</code>. The method will use the <code class="literal">Ti.Geolocation</code> API to obtain the device's coordinates, and then use the specific logic of <code class="literal">Ti.GeoProviders</code> to return an address object to the <code class="literal">onSuccess</code> callback method<a id="id551" class="indexterm"/> provided. If an error occurs during the geolocation process the <code class="literal">onError</code> callback method<a id="id552" class="indexterm"/> will be called and provide the error details. The following snippet demonstrates how to call the <a id="id553" class="indexterm"/><code class="literal">getCurrentAddress</code> method:<div><pre class="programlisting">  my.currentProvider.getCurrentAddress(
  lookup.onSuccess,lookup.onError);
});</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec165"/>Lookup functions</h3></div></div></div><p>Now<a id="id554" class="indexterm"/> perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">lookup</code> object is used in this recipe to display the results returned by the GeoProvider.<div><pre class="programlisting">var lookup = {</pre></div></li><li class="listitem">Using the <code class="literal">picker</code> control discussed earlier, the user can change the recipe's <code class="literal">Ti.GeoProvider</code>. When the provider is changed, the <code class="literal">updateProvider</code> method is called with the new provider details to be loaded.<div><pre class="programlisting">  updateProvider : function(providerKey){</pre></div></li><li class="listitem">Based on the <code class="literal">providerKey</code> given, the <code class="literal">updateProvider</code><a id="id555" class="indexterm"/> method will switch the <code class="literal">my.currentProvider</code> object reference. Provider-specific details such as API key details will also be handled as part of this method. The geo names provider snippet demonstrates how provider switching is performed in this recipe.<div><pre class="programlisting">    my.currentProvider = my.providers[providerKey];

    if(my.currentProvider.providerName == 'geonames'){
      my.currentProvider.provider.addKey('demo');
    }</pre></div></li><li class="listitem">Cross-provider methods<a id="id556" class="indexterm"/> such as <code class="literal">addPurpose</code> are performed at the end of the <code class="literal">updateProvider</code> method as they are leveraged by all <code class="literal">Ti.GeoProviders</code>.<div><pre class="programlisting">    my.currentProvider.addPurpose('Geo Demo');
  },</pre></div></li><li class="listitem">The <code class="literal">addToMap</code> method<a id="id557" class="indexterm"/> is used to create a map pin using the latitude, longitude, and address information provided by the <code class="literal">GeoNames Ti.GeoProvider</code>.<div><pre class="programlisting">  addToMap: function(lat,lng,title){
    var pin = Ti.Map.createAnnotation({
      latitude:lat,longitude:lng,
      title:title
    });
    mapView.addAnnotation(pin);</pre></div></li><li class="listitem">A region is created using the latitude and longitude information from the <code class="literal">Ti.GeoProvider</code>. The <code class="literal">setLocation</code> method<a id="id558" class="indexterm"/> is then called to zoom the <code class="literal">Ti.Map.View</code> to the pin's coordinates.<div><pre class="programlisting">    var region = {latitude:lat,
    longitude:lng,animate:true,
    latitudeDelta:0.04,
    longitudeDelta:0.04};
    mapView.setLocation(region);
  },</pre></div></li><li class="listitem">The <code class="literal">onSuccess</code> method<a id="id559" class="indexterm"/> is used to handle the successful return from the <code class="literal">Ti.GeoProviders</code>. This method is used to orchestrate all user interactions after the successful return from the <code class="literal">Ti.GeoProviders</code>.<div><pre class="programlisting">  onSuccess : function(e){
    if(!e.found){
      alert("Unable to find your location");
      return;
    }</pre></div></li><li class="listitem">The <code class="literal">generateAddress</code> method<a id="id560" class="indexterm"/> is used to create a value for the <code class="literal">title</code> variable. The <code class="literal">title</code> variable is then used in the creation of the map pin. As <code class="literal">Ti.GeoProviders</code> can contain different formats, the <code class="literal">generateAddress</code> function is used to create a formatted address to be used for display purposes.<div><pre class="programlisting">    var title = my.currentProvider.generateAddress(e);
    lookup.addToMap(e.latitude,e.longitude,title);
  },</pre></div></li><li class="listitem">The <a id="id561" class="indexterm"/><code class="literal">onError</code> method is <a id="id562" class="indexterm"/>used by the <code class="literal">Ti.GeoProviders</code> to return error information if an issue occurred during the reverse geolocation process. All error details are accessible in the <code class="literal">e</code> argument.<div><pre class="programlisting">  onError: function(e){
    alert("Error Details:" JSON.stringify(e));
  }
};</pre></div></li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec93"/>See also</h2></div></div></div><p>To learn more about the <code class="literal">basicGeo</code> Titanium module used in this recipe, you can review the following links:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Ti.GeoProvider Framework</strong>: For licensing,<a id="id563" class="indexterm"/> source code, and to learn more about this project please visit <a class="ulink" href="https://github.com/benbahrenburg/Ti.GeoProviders">https://github.com/benbahrenburg/Ti.GeoProviders</a>.</li><li class="listitem" style="list-style-type: disc"><strong>basicGeo Module</strong>: For <a id="id564" class="indexterm"/>licensing, source code, and to learn more about this project please visit <a class="ulink" href="https://github.com/benbahrenburg/benCoding.BasicGeo">https://github.com/benbahrenburg/benCoding.BasicGeo</a>.</li><li class="listitem" style="list-style-type: disc"><strong>GeoNames GeoProvider</strong>: The GeoNames <a id="id565" class="indexterm"/>provider uses the <code class="literal">GeoNames.org</code> web service. For licensing, usage, rates, and documentation please visit <a class="ulink" href="http://www.geonames.org/">http://www.geonames.org/</a>.</li><li class="listitem" style="list-style-type: disc"><strong>Google GeoProvider</strong>: The <a id="id566" class="indexterm"/>Google provider uses the Google Geocoding API. For licensing, usage, rates, and documentation please visit <a class="ulink" href="https://developers.google.com/maps/documentation/geocoding/">https://developers.google.com/maps/documentation/geocoding/</a>.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec43"/>Multitenant geolocation</h1></div></div></div><p>As discussed earlier in this chapter, the <code class="literal">Ti.GeoProviders</code> framework provides a multiprovider approach to reverse geolocation. The multitenant component includes the ability for the <code class="literal">Ti.GeoProviders</code> framework to fail over, if a provider is unable to find a suitable location. This multitenant approach helps to ensure your geolocation functionality works for your globally mobile employees.</p><p>The <a id="id567" class="indexterm"/>following <a id="id568" class="indexterm"/>recipe demonstrates how to use the multitenant <code class="literal">Ti.GeoProviders</code> framework to perform reverse location lookups using a failover approach. The following screenshots illustrate this recipe running on both an iPhone and an Android device:</p><div><img src="img/5343OT_06_07.jpg" alt="Multitenant geolocation"/></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec94"/>Getting ready</h2></div></div></div><p>This recipe uses<a id="id569" class="indexterm"/> both CommonJS and native modules. These can be downloaded from the source code provided by the book, or individually through the links provided in the <em>See also</em> section at the end of this recipe. Simply copy the <code class="literal">GeoProviders</code> folder into the <code class="literal">Resources</code> folder of your project and then copy the <code class="literal">modules</code> folder into your project as highlighted in the following screenshot:</p><div><img src="img/5343OT_06_08.jpg" alt="Getting ready"/></div><p>After copying the mentioned folders, you will need to click on your <code class="literal">tiapp.xml</code> file in Titanium Studio and add a reference to the <code class="literal">bencoding.basicgeo</code> module as shown in the following screenshot:</p><div><img src="img/5343OT_06_09.jpg" alt="Getting ready"/></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec95"/>How to do it...</h2></div></div></div><p>Once you have <a id="id570" class="indexterm"/>added native and CommonJS modules to your project, you next need to create your application namespaces in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the module into your code as the following code snippet demonstrates:</p><div><pre class="programlisting">//Create our application namespace
var my = {
  multiProvider : 
  require('./GeoProviders/reverse_multi_geoprovider')
};</pre></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec166"/>Adding providers</h3></div></div></div><p>The following <a id="id571" class="indexterm"/>code snippet demonstrates how to add different GeoProviders to the <code class="literal">multiProvider</code> module by calling the <code class="literal">addProvider</code> method<a id="id572" class="indexterm"/>. It is advised to add the GeoProviders that you feel will best meet your requirements first since the <code class="literal">multiProvider</code> will execute them in the order they are added.</p><div><pre class="programlisting">my.multiProvider.addProvider({
  key : 'demo',
  providerString:'GeoProviders/geonames_geoprovider'
});

my.multiProvider.addProvider({
  providerString:'GeoProviders/bencoding_geoprovider'
});
my.multiProvider.addProvider({
  providerString:'GeoProviders/google_geoprovider'
});</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec167"/>Adding your purpose</h3></div></div></div><p>Using <a id="id573" class="indexterm"/>location services on iOS requires a purpose or reason for the app to access the GPS. On the first request, this message will be presented to the user. The following code demonstrates how to add this purpose to the multitenant provider using the <code class="literal">addPurpose</code> method:</p><div><pre class="programlisting">my.multiProvider.addPurpose('Demo of Geo Provider');</pre></div><div><div><h3 class="title"><a id="note11"/>Note</h3><p>Android does not require the purpose be provided; in this case the purpose defined is not used when accessing the GPS.</p></div></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec168"/>Building the recipe UI</h3></div></div></div><p>The<a id="id574" class="indexterm"/> following code snippet describes how to create the UI shown in this recipe's earlier screenshots. The first step is to create the <code class="literal">Ti.UI.Window</code> to which all visual elements will be attached.</p><div><pre class="programlisting">var win = Ti.UI.createWindow({
  backgroundColor: '#fff', title: 'Multi-Tenant Geo', 
  barColor:'#000',fullscreen:false
});</pre></div><p>Next, a <code class="literal">Ti.Map.View</code> is added to the <code class="literal">Ti.UI.Window</code>; this will be used to display a map pin with the device's current location and address details.</p><div><pre class="programlisting">var mapView = Ti.Map.createView({
  top:120, bottom:0,width:Ti.UI.FILL,
  userLocation:false	
});
win.add(mapView);</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec169"/>Lookup helper methods</h3></div></div></div><p>Now<a id="id575" class="indexterm"/> perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">lookup</code> object is designed to help format the results of the multitenant reverse geolocation component and present the address information in a graphical way to the recipe user.<div><pre class="programlisting">var lookup = {</pre></div></li><li class="listitem">The <code class="literal">addToMap</code> method creates <a id="id576" class="indexterm"/>a map pin and adds the information to <code class="literal">Ti.Map.View</code>.<div><pre class="programlisting">  addToMap: function(lat,lng,title){
    var pin = Ti.Map.createAnnotation({
    latitude:lat,longitude:lng,
    title:title	
  });
  mapView.addAnnotation(pin);</pre></div></li><li class="listitem">A region is created using the map pin coordinates and the <code class="literal">setLocation</code> function of <code class="literal">Ti.Map.View</code> is then called. This will zoom the map to the coordinates of the recently added pin.<div><pre class="programlisting">  var region = {latitude:lat,longitude:lng,
    latitudeDelta:0.04,   
    longitudeDelta:0.04};
    mapView.setLocation(region);
  },</pre></div></li><li class="listitem">The <code class="literal">onSuccess</code> method is provided as the success callback when the <code class="literal">getCurrentAddress</code> method<a id="id577" class="indexterm"/> is called. The result of the <code class="literal">getCurrentAddress</code> method is provided to the <code class="literal">e</code> parameter.<div><pre class="programlisting">  onSuccess : function(e){
    if(!e.found){
      alert("Unable to find your location");
      return;
    }</pre></div></li><li class="listitem">The <code class="literal">getProvider</code> method<a id="id578" class="indexterm"/> is called to create a reference to the provider used to return the location results. This allows for the provider-specific<a id="id579" class="indexterm"/> <code class="literal">generateAddress</code> method to be used.<div><pre class="programlisting">    var provider = my.multiProvider.getProvider(
    e.provider.name);
    var title = provider.generateAddress(e);
    lookup.addToMap(e.latitude,e.longitude,title);
  },</pre></div></li><li class="listitem">The <code class="literal">onError</code> method is provided as the error callback when the <code class="literal">getCurrentAddress</code> method is<a id="id580" class="indexterm"/> called. Error details are provided to the <code class="literal">e</code> parameter.<div><pre class="programlisting">  onError: function(e){
    alert("Error finding your location");
  }
};</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec170"/>Performing a multitenant reverse geolocation lookup</h3></div></div></div><p>Now<a id="id581" class="indexterm"/> perform <a id="id582" class="indexterm"/>the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">The final section of this recipe is to perform the multitenant lookup using the <code class="literal">getCurrentAddress</code> method of the <code class="literal">multiProvider</code> module.<div><pre class="programlisting">var findButton = Ti.UI.createButton({
  title:'Find Current Location', 
  left:10, right:10,top:70,height:40
});
win.add(findButton);</pre></div></li><li class="listitem">The <code class="literal">multiProvider</code> lookup is performed on the click event of <code class="literal">findButton</code>.<div><pre class="programlisting">findButton.addEventListener('click',function(e){</pre></div></li><li class="listitem">As a network connection is required for the reverse geolocation, the first step in the reverse geolocation process is to validate the network connection.<div><pre class="programlisting">  if(!Ti.Network.online){
    alert("You must be online to run this recipe");
    return;
  }	</pre></div></li><li class="listitem">Next, the <code class="literal">getCurrentAddress</code> method is called, and a success and error callback method is provided. The following code snippet demonstrates calling this method with the <code class="literal">lookup.onSuccess</code> and <code class="literal">lookup.OnError</code> callback methods discussed earlier in this recipe.<div><pre class="programlisting">  my.multiProvider.getCurrentAddress(
  lookup.onSuccess,lookup.onError);
});	</pre></div></li></ol></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec44"/>Calculating distance between addresses</h1></div></div></div><p>The use of <a id="id583" class="indexterm"/>geolocation services in enterprise apps is common. One of the most common geolocation requirements is to calculate the distance <a id="id584" class="indexterm"/>between two points. This is helpful in planning routes, determining mileage, forecasting delivery schedules, and more.</p><p>The following recipe demonstrates how to calculate the distance between two addresses. This distance measurement is done using a direct distance, not a routing calculation such as those used for walking or driving. The following screenshots illustrate this recipe running on both an iPhone and an Android device.</p><div><img src="img/5343OT_06_10.jpg" alt="Calculating distance between addresses"/></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec96"/>Getting ready</h2></div></div></div><p>This recipe uses both CommonJS and native modules. These can be downloaded from the source code provided by the book, or individually through the links provided in the <em>See also</em> section at the end of this recipe. Simply copy the <code class="literal">forwardGeo.js</code> file into the <code class="literal">Resources</code> folder of your project and then copy the <code class="literal">modules</code> folder into your project as shown in the following screenshot:</p><div><img src="img/5343OT_06_11.jpg" alt="Getting ready"/></div><p>After copying the file and folder mentioned here, you will need to click on your <strong>tiapp.xml</strong> file in <a id="id585" class="indexterm"/>Titanium Studio and add a reference to the <code class="literal">bencoding.basicgeo</code> module as shown in the following screenshot:</p><div><img src="img/5343OT_06_12.jpg" alt="Getting ready"/></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec97"/>How to do it...</h2></div></div></div><p>Once you have<a id="id586" class="indexterm"/> added native and CommonJS modules to your project, you next need to create your application namespaces in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the module into your code as the following code snippet demonstrates:</p><div><pre class="programlisting">//Create our application namespace
var my = {
  forward : require('forwardGeo')
};</pre></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec171"/>Adding address information</h3></div></div></div><p>The <a id="id587" class="indexterm"/>following <code class="literal">startAddress</code> and <code class="literal">endAddress</code> objects are added to the app namespace. These objects will be used to create the address information and coordinate state for this recipe.</p><div><pre class="programlisting">my.startAddress  = {
  needRefresh:true,lat:40.748433, lng:-73.985656,
  address:'350 5th Ave  New York, NY 10118'
};

my.endAddress = {
  needRefresh:false, lat:40.75773, lng:-73.985708,
  address:'1560 Broadway, New York, NY 10036'
};</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec172"/>Building the recipe UI</h3></div></div></div><p>The<a id="id588" class="indexterm"/> following code snippet describes how to create the UI shown in this recipe's earlier screenshots:</p><div><ol class="orderedlist arabic"><li class="listitem">The first step is to create the <code class="literal">Ti.UI.Window</code> to which all visual elements will be attached.<div><pre class="programlisting">var win = Ti.UI.createWindow({
  backgroundColor: '#fff', title: 'Geo Distance Recipe', 
  barColor:'#000',fullscreen:false
});</pre></div></li><li class="listitem">Next the <code class="literal">txtStartAddress Ti.UI.TextField</code> is created to allow the user to enter a starting address.<div><pre class="programlisting">var txtStartAddress = Ti.UI.createTextField({
  hintText:'enter starting address', 
  value: my.startAddress.address,
  height:40, left:5, right:5, top:55,
  borderStyle:Ti.UI.INPUT_BORDERSTYLE_ROUNDED
});
win.add(txtStartAddress);</pre></div></li><li class="listitem">Next<a id="id589" class="indexterm"/> the <code class="literal">txtEndAddress Ti.UI.TextField</code> is created to allow the user to enter a destination address.<div><pre class="programlisting">var txtEndAddress = Ti.UI.createTextField({
  hintText:'enter destination address', 
  value: my.endAddress.address,
  height:40, left:5, right:5, top:125,
  borderStyle:Ti.UI.INPUT_BORDERSTYLE_ROUNDED
});
win.add(txtEndAddress);</pre></div></li><li class="listitem">The <code class="literal">findButton Ti.UI.Button</code> is then added to the <code class="literal">Ti.UI.Window</code> later in this recipe. This button will be used to perform the distance calculation.<div><pre class="programlisting">var findButton = Ti.UI.createButton({
  title:'Calculate Distance between', height:40,
  left:5, right:5, top:180
});
win.add(findButton);</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec173"/>Distance and address methods</h3></div></div></div><p>This recipe <a id="id590" class="indexterm"/>uses the <code class="literal">geo</code> object to perform distance and address lookup operations.</p><div><pre class="programlisting">var geo ={</pre></div><div><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">distanceInUnits</code> uses the Haversine formula and computes the direct distance in kilometers or meters between two sets of coordinates.<div><pre class="programlisting">distanceInUnits: function(lat1, lng1, lat2, lng2){
  var rOfEarth = 6371; 
  var dLat = (lat2-lat1)*Math.PI/180;  
  var dLon = (lng2-lng1)*Math.PI/180;   
  var a = Math.sin(dLat/2) * Math.sin(dLat/2) +  
  Math.cos(lat1*Math.PI/180) *
  Math.cos(lat2*Math.PI/180) *   
  Math.sin(dLon/2) * Math.sin(dLon/2);   
  var c = 2 * Math.asin(Math.sqrt(a));   
  var distance = rOfEarth * c;</pre></div></li><li class="listitem">If the distance is less than 1 kilometer, the unit returned is converted to meters.<div><pre class="programlisting">  return {
    distance: ((distance &lt; 1) ? 
    (distance * 1000) : distance),
    unit: ((distance &lt; 1) ? 'm' : 'km')
  };
},</pre></div></li><li class="listitem">The <code class="literal">findLocations</code> method<a id="id591" class="indexterm"/> <a id="id592" class="indexterm"/>is used to obtain the coordinates for the addresses provided.<div><pre class="programlisting">findLocations : function(callback){</pre></div></li><li class="listitem">The <code class="literal">onFinish</code> function<a id="id593" class="indexterm"/> is the callback method provided to the <code class="literal">forwardGeo</code> function. The <code class="literal">e</code> parameter provides the starting and ending address coordinates.<div><pre class="programlisting">  function onFinish(e){
    if(!e.success){
      alert(e.message);
      return;
    }</pre></div><p>The <code class="literal">forwardGeo e.start</code> and <code class="literal">e.end</code> results are assigned to the <code class="literal">my.startAddress</code> and <code class="literal">my.endAddress</code> properties. The callback method is then executed, so the distance calculation can be performed.</p><div><pre class="programlisting">    my.startAddress = e.start;
    my.endAddress = e.end;
    callback();
  };</pre></div></li><li class="listitem">The <code class="literal">forwardGeo</code> method<a id="id594" class="indexterm"/> is called to obtain the coordinates for the my.<code class="literal">startAddress</code> and my.<code class="literal">endAddress</code> objects. As discussed earlier, the geolocation results are provided to the <code class="literal">onFinish</code> callback method as the following code snippet demonstrates:<div><pre class="programlisting">    my.forward.forwardGeo(my.startAddress,
    my.endAddress,onFinish);
  }	
};</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec174"/>Finding the distance between the two addresses</h3></div></div></div><p>When the user <a id="id595" class="indexterm"/>presses the <code class="literal">findButton</code> and the click event is fired, the recipe will perform a distance calculation between the two addresses entered.</p><div><pre class="programlisting">findButton.addEventListener('click',function(e){</pre></div><div><ol class="orderedlist arabic"><li class="listitem">The first step in this process is to determine if forward geolocation is supported. The coordinates for each address is required for the distance calculation. A forward geolocation lookup is performed to obtain this information.<div><pre class="programlisting">  if(!my.forward.isSupported()){
    alert('Forward Geocoding is not supported');
    return;
  }	</pre></div></li><li class="listitem">The <code class="literal">findDistance</code> method<a id="id596" class="indexterm"/> is used to make the distance calculation method call and format the provided results.<div><pre class="programlisting">  function findDistance(){</pre></div></li><li class="listitem">The first step in this section of the recipe is to call the <code class="literal">distanceInUnits</code> method<a id="id597" class="indexterm"/> using the latitude and longitude information for each address.<div><pre class="programlisting">    var result = geo.distanceInUnits(
    my.startAddress.lat,my.startAddress.lng,
    my.endAddress.lat,my.endAddress.lng);</pre></div></li><li class="listitem">Next the distance calculation results need to be formatted. If the results are in kilometres, the <code class="literal">distance</code> variable is rounded to the first three decimal places. If it is in meters, the full value will be displayed.<div><pre class="programlisting">    if(result.unit=='km'){
      result.distance = 	
      result.distance.toFixed(3);
    }
    distanceLabel.text = result.distance + " " + 
    result.unit + " between addresses";
  };</pre></div></li><li class="listitem">If either of the address information objects needs to be refreshed, the <code class="literal">geo.findLocation</code> method<a id="id598" class="indexterm"/> is called. The <code class="literal">findDistance</code> method<a id="id599" class="indexterm"/> is provided as the callback method to the <code class="literal">findLocations</code> function<a id="id600" class="indexterm"/> so that the distance calculation can be performed after the coordinates are obtained.<div><pre class="programlisting">  if(my.startAddress.needRefresh || 
  my.endAddress.needRefresh){
    geo.findLocations(findDistance);
  }else{</pre></div></li><li class="listitem">If the address<a id="id601" class="indexterm"/> information objects do not need to be refreshed, the <code class="literal">findDistance</code> method<a id="id602" class="indexterm"/> is called directly to perform the distance calculation.<div><pre class="programlisting">    findDistance();
  }	
});</pre></div></li></ol></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec45"/>Background geolocation management</h1></div></div></div><p>Background geolocation is an important feature of many enterprise applications. The ability to <a id="id603" class="indexterm"/>monitor the device's whereabouts while in the background is a powerful feature that can be used <a id="id604" class="indexterm"/>for a wide range of activities from personal security to mileage tracking.</p><p>The following recipe demonstrates how to use the <code class="literal">Ti.Geo.Background</code> framework to enable background geolocation monitoring. The following screenshots illustrate this recipe running on both an iPhone and an Android device.</p><div><img src="img/5343OT_06_13.jpg" alt="Background geolocation management"/></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec98"/>Getting ready</h2></div></div></div><p>This recipe uses <a id="id605" class="indexterm"/>a series of CommonJS modules. These modules can be downloaded from the source code provided by the book, or individually through the links provided in the <em>See also</em> section at the end of this recipe. Simply copy the <code class="literal">bGeo</code> folder into the <code class="literal">Resources</code> folder of your project as shown in the following screenshot:</p><div><img src="img/5343OT_06_14.jpg" alt="Getting ready"/></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec175"/>Updating your tiapp.xml file</h3></div></div></div><p>This recipe<a id="id606" class="indexterm"/> requires a few updates<a id="id607" class="indexterm"/> to your project's <code class="literal">tiapp.xml</code> file. The first update is to provide background geolocation support for iOS devices. The following highlighted <code class="literal">UIBackgroundModes</code> section illustrates the entry required by this recipe:</p><div><pre class="programlisting">&lt;ios&gt;
  &lt;min-ios-ver&gt;5.0&lt;/min-ios-ver&gt;
  &lt;plist&gt;
    &lt;dict&gt;
<strong>      &lt;key&gt;UIBackgroundModes&lt;/key&gt;</strong>
<strong>      &lt;array&gt;</strong>
<strong>        &lt;string&gt;location&lt;/string&gt;</strong>
<strong>      &lt;/array&gt;</strong>
      &lt;key&gt;NSLocationUsageDescription&lt;/key&gt;
      &lt;string&gt;Demo Geo App&lt;/string&gt;
    &lt;/dict&gt;
  &lt;/plist&gt;
&lt;/ios&gt;</pre></div><p>This recipe uses an Android service as a keep alive. The following highlighted section is required for the recipe to create an internal service:</p><div><pre class="programlisting">&lt;android xmlns:android=
"http://schemas.android.com/apk/res/android"&gt;
<strong>  &lt;services&gt;</strong>
<strong>    &lt;service url="bGeo/Ti.Geo.Timer.js" type="interval"/&gt;</strong>
<strong>    &lt;/services&gt;</strong>
&lt;/android&gt;</pre></div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec99"/>How to do it...</h2></div></div></div><p>The <code class="literal">Ti.Geo.Background</code> CommonJS module<a id="id608" class="indexterm"/> utilizes both location manager distance filtering and a keep-alive geo timer. <a id="id609" class="indexterm"/>This ensures that a location is recorded both when the device travels a specific distance, or a specified period of time elapses. The <code class="literal">Ti.Geo.Background</code> module manages all geolocation operations and maintains a distance filter so that coordinates are recorded when the device moves pass a specific threshold distance.</p><p>The <code class="literal">Ti.Geo.Timer</code> performs two activities. First provides a keep-alive loop required to keep an iOS application active, and second, on a scheduled interval the service records the device's current coordinates. This ensures that coordinates are recorded even if the individual hasn't moved.</p><p>The following diagram illustrates the interaction between the different <code class="literal">Ti.Geo.Background</code> components:</p><div><img src="img/5343OT_06_15.jpg" alt="How to do it..."/></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec176"/>Namespace and app setup</h3></div></div></div><p>Once you have added native and CommonJS modules to your project, you need to create your application namespaces<a id="id610" class="indexterm"/> in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the modules into your code as the following code snippet demonstrates:</p><div><pre class="programlisting">var my = {
  bGeo : require('bGeo/Ti.Geo.Background'),
  isAndroid : Ti.Platform.osname === 'android',
  session:{started:false}
};</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec177"/>Background location options</h3></div></div></div><p>The <code class="literal">Ti.Geo.Background</code> module<a id="id611" class="indexterm"/> provides a series of optional configuration parameters that allow you to tailor the module to your needs. The first configuration parameter is <code class="literal">purpose</code>. This is used by iOS when presenting the location services access prompt to your users.</p><div><pre class="programlisting">my.bGeo.purpose = "Demo Background Recipe";</pre></div><div><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">distanceFilter</code> is a value in meters on how often you wish to have the location manager fire an alert that the location has changed. The following sample is set to <code class="literal">100</code> and will fire a location-changed event every time the user travels more than 100 meters.<div><pre class="programlisting">my.bGeo.distanceFilter = 100;</pre></div></li><li class="listitem">The <code class="literal">trackSignificantLocationChange</code> setting indicates that the significant location-change tracking should be used on iOS. This method of geolocation reduces battery impact by only firing events when a network change such as a cell tower switch is performed.<div><pre class="programlisting">my.bGeo.trackSignificantLocationChange = true; </pre></div></li><li class="listitem">The <code class="literal">minAge</code> configuration is a threshold of the minimum frequency, in minutes; you wish to receive location updates. In the following example, you will not receive updates any more frequently than every 3 minutes, no matter the distance the individual is moving.<div><pre class="programlisting">my.bGeo.minAge = 3;</pre></div></li><li class="listitem">The <code class="literal">maxAge</code> configuration is a threshold of the maximum amount of time in minutes you wish to go without receiving an update. This is also the threshold used by the <code class="literal">Ti.Geo.Timer</code> to perform a coordinate lookup.<div><pre class="programlisting">my.bGeo.maxAge = 30;</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec178"/>Building the recipe's UI</h3></div></div></div><p>The following <a id="id612" class="indexterm"/>code snippet describes how to create the UI shown in this recipe's earlier screenshots:</p><div><ol class="orderedlist arabic"><li class="listitem">The first step is to create the <code class="literal">Ti.UI.Window</code> upon which all visual elements will be attached.<div><pre class="programlisting">var win = Ti.UI.createWindow({
  backgroundColor: '#fff', title: 'Background Geo Recipe', 
  barColor:'#000',fullscreen:false
});</pre></div></li><li class="listitem">The next step is to add a <code class="literal">Ti.Map.View</code> to the recipe's <code class="literal">Ti.UI.Window</code>. This will be used to display the coordinates collected while <code class="literal">Ti.Geo.Background</code> is running.<div><pre class="programlisting">var mapView = Ti.Map.createView({
  top:80, bottom:0, left:5, right:5, userLocation:false
});
win.add(mapView);</pre></div></li><li class="listitem">The <code class="literal">startStopButton</code> is then added to the <code class="literal">Ti.UI.Window</code>. This button will be used to start and stop the <code class="literal">Ti.Geo.Background</code> process.<div><pre class="programlisting">var startStopButton = Ti.UI.createButton({
  title:((my.bGeo.active()) ? 'stop' :'start'),
  top:30, height:40,left:5, width:75
});
win.add(startStopButton);</pre></div></li><li class="listitem">The <code class="literal">clearButton</code> is then added to the <code class="literal">Ti.UI.Window</code>. This button will be used to remove all coordinate information recorded by the <code class="literal">Ti.Geo.Background</code> process.<div><pre class="programlisting">var clearButton = Ti.UI.createButton({
  title:'Clear', top:30, height:40,left:85, width:75
});
win.add(clearButton);</pre></div></li><li class="listitem">The <code class="literal">refreshButton</code> is then added to the <code class="literal">Ti.UI.Window</code>. This button will be used to refresh the <code class="literal">Ti.Map.View</code> with the coordinates recorded by the <code class="literal">Ti.Geo.Background</code> process.<div><pre class="programlisting">var refreshButton = Ti.UI.createButton({
  title:'Refresh', top:30, height:40,left:165, width:75
});
win.add(refreshButton);</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec179"/>The recipe's assistant methods</h3></div></div></div><p>This recipe<a id="id613" class="indexterm"/> implements an <code class="literal">assistant</code> object, which contains helper functions to work with and display coordinates collected by the <code class="literal">Ti.Geo.Background</code> module.</p><div><pre class="programlisting">var assistant = {</pre></div><div><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">addToMap</code> is the first method in the <code class="literal">assistant</code> object. This method adds a map pin for each of the coordinate points collected by the <code class="literal">Ti.Geo.Background</code> module.<div><pre class="programlisting">  addToMap : function(e){
    var pin = Ti.Map.createAnnotation({
      latitude:e.latitude,
      longitude:e.longitude	
    });
    mapView.addAnnotation(pin);
    var region = {latitude:e.latitude,
    longitude:e.longitude,
    latitudeDelta:0.04, longitudeDelta:0.04};
    mapView.setLocation(region);
  },</pre></div></li><li class="listitem">The next method in the <code class="literal">assistant</code> object is the <code class="literal">locationChangeCallback</code> method<a id="id614" class="indexterm"/>. This method is provided as the callback method for the <code class="literal">Ti.Geo.Background</code> module's <code class="literal">change</code> event. The change coordinates are provided to the method's <code class="literal">e</code> parameter. The <code class="literal">locationChangeCallback</code> method then calls the <code class="literal">addToMap</code> method to display the newly gathered coordinate information.<div><pre class="programlisting">  locationChangeCallback : function(e){
    assistant.addToMap(e);
  },</pre></div></li><li class="listitem">The final method in the <code class="literal">assistant</code> object is the <code class="literal">locationErrorCallback</code> method<a id="id615" class="indexterm"/>. This method is provided as the callback method for the <code class="literal">Ti.Geo.Background</code> module's <code class="literal">error</code> event. Error information is provided to the method's <code class="literal">e</code> parameter.<div><pre class="programlisting">  locationErrorCallBack : function(e){
    alert('Error due to ' + e.message);
  }
};</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec180"/>Geolocation events</h3></div></div></div><p>The <code class="literal">Ti.Geo.Background</code> module<a id="id616" class="indexterm"/> <a id="id617" class="indexterm"/>has several events. The events used in this recipe are detailed in this section. The <code class="literal">change</code> event is the primary method used in this recipe. This event is fired whenever a location change is generated. The following example demonstrates how to subscribe to this <code class="literal">change</code> event providing the callback method <code class="literal">assistant.locationChangeCallback</code>:</p><div><pre class="programlisting">my.bGeo.addEventListener('change',
assistant.locationChangeCallback);</pre></div><p>The <code class="literal">error</code> event is also used in this recipe to provide an alert to the user when an error has occurred in the module. The following example demonstrates how to subscribe to the <code class="literal">error</code> event providing the callback method <code class="literal">assistant.locationErrorCallback</code>:</p><div><pre class="programlisting">my.bGeo.addEventListener('error',
assistant.locationErrorCallBack);</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec181"/>Background button events</h3></div></div></div><p>This recipe <a id="id618" class="indexterm"/>uses a series of buttons to demonstrate how to call the <code class="literal">Ti.Geo.Background</code> module's methods. The <code class="literal">startStopButton</code> click event demonstrates how to start and stop the <code class="literal">Ti.Geo.Background</code> process.</p><div><pre class="programlisting">startStopButton.addEventListener('click',function(e){</pre></div><div><ol class="orderedlist arabic"><li class="listitem">If the module is already active, the recipe will toggle the status to <code class="literal">off</code> and stop the module for recording coordinates.<div><pre class="programlisting">  if(my.bGeo.active(){
    my.bGeo.stop();
  }else{</pre></div></li><li class="listitem">If the module is off, the recipe will toggle the status to <code class="literal">on</code> and start the module for recording coordinates.<div><pre class="programlisting">    my.bGeo.start();
  }</pre></div></li><li class="listitem">The <code class="literal">startStopButton</code> title is updated to refresh the current status of the module.<div><pre class="programlisting">  startStopButton.title=((my.bGeo.active()) ? 
  'stop' :'start');
});</pre></div></li><li class="listitem">The <code class="literal">click</code> event of <code class="literal">refreshButton</code> is used to reload the recorded coordinates to display in the <code class="literal">Ti.Map.View</code>.<div><pre class="programlisting">refreshButton.addEventListener('click',function(e){</pre></div></li><li class="listitem">First <a id="id619" class="indexterm"/>all map annotations are removed.<div><pre class="programlisting">  mapView.removeAllAnnotations();</pre></div></li><li class="listitem">The <code class="literal">readCache</code> method<a id="id620" class="indexterm"/> is then called to return an array containing all of the recorded coordinates.<div><pre class="programlisting">  var results = my.bGeo.readCache();</pre></div></li><li class="listitem">The snippet then loops through the coordinate array using the <code class="literal">assistant.addToMap</code> method to create map pins on the recipe's <code class="literal">Ti.Map.View</code>.<div><pre class="programlisting">  for (iLoop=0;iLoop &lt; results.length;iLoop++){
    assistant.addToMap(results[iLoop]);
  }
});</pre></div></li><li class="listitem">The <code class="literal">click</code> event of <code class="literal">clearButton</code> is used to remove all recorded coordinate information and clear the <code class="literal">Ti.Map.View</code> of all annotations as the following code snippet demonstrates:<div><pre class="programlisting">clearButton.addEventListener('click',function(e){
  my.bGeo.clearCache();
  mapView.removeAllAnnotations();
});</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec182"/>iOS app-level events</h3></div></div></div><p>The iOS platform <a id="id621" class="indexterm"/>does not allow for background services to run while the app is in the foreground. The following block of code demonstrates how to handle this iOS specific scenario:</p><div><ol class="orderedlist arabic"><li class="listitem">First check to ensure the recipe is running on an iOS device.<div><pre class="programlisting">if(!my.isAndroid){</pre></div></li><li class="listitem">Next an application-level listener is created on the resumed event. This will be fired when the app is placed in the foreground.<div><pre class="programlisting">  Ti.App.addEventListener('resumed',function(e){</pre></div></li><li class="listitem">When the app is moved into the foreground, the recipe checks if the <code class="literal">Ti.Geo.Background</code> module is active. If active, the module's <code class="literal">paused</code> method must be called to disable the <code class="literal">Ti.App.iOS.BackgroundService</code>, while leaving the location manager active.<div><pre class="programlisting">    if(my.bGeo.active()){
      my.bGeo.paused();
    }
  });</pre></div></li><li class="listitem">The <a id="id622" class="indexterm"/>next step in managing background services on iOS is to add an application-level event listener to the <code class="literal">paused</code> event. The <code class="literal">paused</code> event will be fired when the app is placed in the background.<div><pre class="programlisting">  Ti.App.addEventListener('paused',function(e){</pre></div></li><li class="listitem">The next snippet demonstrates how to restart the background service, if the <code class="literal">Ti.Geo.Background</code> module is active.<div><pre class="programlisting">    if(my.bGeo.active()){
      my.bGeo.restart();
    }
  });</pre></div><div><div><h3 class="title"><a id="tip34"/>Tip</h3><p>The restart method must be called when the app is paused, if you wish to continue collecting coordinates in the background.</p></div></div></li><li class="listitem">The following code snippet demonstrates how to stop the <code class="literal">Ti.Geo.Background</code> module when the application is closed. This also provides a clean shutdown to the background processes and avoids iOS terminating them after approximately 10 minutes.<div><pre class="programlisting">  Ti.App.addEventListener('close',function(e){
    my.bGeo.stop();
  });
}</pre></div></li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec100"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">Ti.Geo.Background</code> module was used in this recipe to provide cross-platform background location services. For licensing, source code, and to learn more about this project please visit <a class="ulink" href="https://github.com/benbahrenburg/Ti.Geo.Background">https://github.com/benbahrenburg/Ti.Geo.Background</a>.</li></ul></div></div></div></body></html>