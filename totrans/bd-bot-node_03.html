<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Twitter as a Flight Information Agent</h1></div></div></div><p>
<strong>Twitter</strong> is an online social networking service that enables users to send and read short 140 character messages called <em>tweets</em>, and has become one of the most prominent ways for people to exchange news and information all over the world.</p><p>Twitter's popularity has exploded since its creation, and now it is used for all sorts of things, such as customer service, marketing, news coverage, and many others. It is one of the most popular websites that exist, and it is considered to be the <em>SMS gateway</em> of the Internet.</p><p>One of Twitter's main uses is for companies to communicate information to their followers. For example, airlines usually tweet about events that are related to the company, as well as those that could affect passengers or their plans.</p><p>In this chapter, we'll focus our attention on creating a Twitter bot that is able to provide flight information to passengers, acting like an automated flight information agent.</p><p>The examples should be a lot of fun, as well as easy to follow, so let's not wait any longer and get started!</p><div><div><div><div><h1 class="title"><a id="ch03lvl1sec16"/>How a Twitter bot works</h1></div></div></div><p>Just like any other bot, a Twitter bot is, in essence, just another Twitter user account-the difference is that, instead of being manned by another person, the account is controlled by an automated process that knows how to reply to the input you provide. This is possible because Twitter provides an API that allows you to interact programmatically with the service through code.</p><p>In essence, anything that can be turned into a service could be converted into an automated conversation by using a bot, and Twitter is no different. Bots can have interactive conversations on nearly every platform, at any time, and from anywhere.</p><p>A Twitter bot is typically an application that you write that listens for something to happen on Twitter and then does something in response. In our case, we'll be listening for someone to tweet with a certain hashtag and then tweeting something when that happens. That hashtag will be a flight number, and the bot will be able to provide some feedback based on it.</p><p>So, let's get our feet on the ground and get started in building our Twitter bot.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec17"/> Creating a Twitter app</h1></div></div></div><p>The first and foremost step in creating a Twitter bot is to actually create a Twitter application. The bot is just a designation we'll be using, but in reality it's really a Twitter application behind the scenes that is able to interact with the Twitter API.</p><p>In order to be able to interact with the Twitter API, it is necessary to have a registered Twitter account. Go to the Twitter web page and sign up if you don't have an account. If you have one, sign in.</p><p>Once you are signed in, navigate to <a class="ulink" href="https://apps.twitter.com/">
https://apps.twitter.com/
</a>. This is where we will register our Twitter application. You'll then see the Twitter <strong>Application Management</strong> welcome page which has a button to create a new application.</p><p>To create the Twitter bot, click on the <strong>Create New App</strong> button. Refer to the following screenshot:</p><p>
</p><div><img src="img/image00213.jpeg" alt=" Creating a Twitter app"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Having done that, the following screen will appear:</p><p>
</p><div><img src="img/image00214.jpeg" alt=" Creating a Twitter app"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Fill in the required information. Give the application a distinctive name and a description. You are also required to enter a website that will be used as the bot's publicly accessible home page. Once you have entered this data, scroll down and accept the Twitter <strong>Developer Agreement</strong>:</p><p>
</p><div><img src="img/image00215.jpeg" alt=" Creating a Twitter app"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Once you've read the developer agreement, you can click on the <strong>Create your Twitter application</strong> in order to proceed. This will allow Twitter to create your application, and you'll be presented with the following screen once the creation process has finalized:</p><p>
</p><div><img src="img/image00216.jpeg" alt=" Creating a Twitter app"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>If you scroll a bit, there are also application settings provided that will be needed as soon as we start coding. With the Twitter app created, let's focus on writing some code. So far throughout this book we've been using the Atom editor; however, you are free to use any other editor that you might be comfortable with.</p><p>Open the editor and create a new <code class="literal">app.js</code> file inside a <code class="literal">FlightBot</code> folder anywhere on your drive. For now, simply add this instruction:</p><pre class="programlisting">console.log('Hi, this is FlightBot');&#13;
</pre><p>Assuming we have Node.js and npm installed (if not, please refer to the steps in <a class="link" title="Chapter 1. The Rise of Bots – Getting the Message Across" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>The Rise of Bots – Getting the Message Across</em>), let's get some necessary dependencies installed.</p><p>Now let's copy the <code class="literal">package.json</code> (that we used in the previous chapter) and place it in the <code class="literal">FlightBot</code> folder. Then let's modify it as follows:</p><p>
</p><div><img src="img/image00217.jpeg" alt=" Creating a Twitter app"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Now let's get the dependencies installed, so we can start coding within the <code class="literal">app.js</code> file: </p><pre class="programlisting">
<strong>npm install twitter --save</strong>
</pre><p>This will install the Twitter Node.js SDK, which we will be using to write our app. This will be installed on the <code class="literal">FlightBot</code> folder as shown in the following screenshot:</p><p>
</p><div><img src="img/image00218.jpeg" alt=" Creating a Twitter app"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>You'll see the updated <code class="literal">package.json</code> file in your project folder:</p><p>
</p><div><img src="img/image00219.jpeg" alt=" Creating a Twitter app"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>We are now ready to start adding some code in our <code class="literal">app.js</code> file:</p><pre class="programlisting">var TwitterPackage = require('twitter'); &#13;
</pre><p>What we've done here is to load and import the Twitter package. First, let's get these consumer keys and tokens from the Twitter <strong>Application Management</strong> screen:</p><p>
</p><div><img src="img/image00220.jpeg" alt=" Creating a Twitter app"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Note how the <strong>Consumer Key</strong> and <strong>Consumer Secret</strong> are available by default, but not the <strong>Your Access Tokens</strong>.</p><p>In order to get the <strong>Your Access Tokens</strong>, click on the <strong>Create my access token</strong> button at the bottom of the screen. Once you've done that, you'll see the following screen:</p><p>
</p><div><img src="img/image00221.jpeg" alt=" Creating a Twitter app"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>With this done, you can now add the consumer and access tokens to the secret object variable in the code.</p><p>We can do this by defining an object variable that will contain the consumer key and secret object, along with the access tokens, as shown in the following code snippet:</p><pre class="programlisting">var secret = { &#13;
  consumer_key: 'PUT YOURS', &#13;
  consumer_secret: 'PUT YOURS', &#13;
  access_token_key: 'PUT YOURS', &#13;
  access_token_secret: 'PUT YOURS' &#13;
} &#13;
 &#13;
var Twitter = new TwitterPackage(secret); &#13;
</pre><p>Later, we'll store these in a separate <code class="literal">.json</code> file, but for now let's keep them within our <code class="literal">app.js</code> file. These will be required in order to authenticate to Twitter.</p><p>So at this point, we've pretty much created the app on Twitter and have a very basic structure with tokens and access codes that we can use to authenticate to the Twitter service and start using the API.</p><p>With this out of the way, let's move on and start adding some logic to our application.</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec18"/>Posting to Twitter</h1></div></div></div><p>In order to add our own custom logic, we'll need to make use of Twitter's <code class="literal">REST</code> API, which will allow us to do several things. One of the things it can do is allow us to post a tweet.</p><p>This can be achieved as follows:</p><pre class="programlisting">Twitter.post('statuses/update', {status: 'This is a sample automated Tweet'},  function(error, tweet, response){ 
  if(error){ 
    console.log(error); 
  } 
  console.log(tweet);  // Tweet body. 
  console.log(response);  // Raw response object. 
}); 
</pre><p>So let's take a moment to examine this. <code class="literal">Twitter.post</code> means that we are calling the <code class="literal">post</code> function in the Twitter object. We pass the <code class="literal">post</code> function several things-<code class="literal">'statuses/update'</code> means we want to post a status update (a tweet).</p><p>
<code class="literal">{status: 'This is a sample automated Tweet'}</code> is a JavaScript object that we are passing in to this function where we set the status of the tweet being sent out.</p><p>Although this contains just the text of the tweet we want to send, there are a whole bunch of other options to set depending on what we want to post to Twitter (such as images, location, and so on). In this case, we are just interested in posting a simple status just so we are familiar with setting the status property.</p><p>The last thing we pass in is a function. In JavaScript, you can actually pass functions in to other functions; it is one of the things that makes JavaScript a functional programming language.
</p><p>In the <code class="literal">Twitter.post</code> function, you're expected to pass a function in that will be executed after Twitter tries to post the tweet. This is what is known as a callback function. In that function, you'll notice three parameters:</p><div><ul class="itemizedlist"><li class="listitem"><code class="literal">error</code>: This indicates whether there's an error in the process of posting the tweet, in which case this variable will contain an object with information about the error that occurred</li><li class="listitem"><code class="literal">tweet</code>: An object that contains all the tweet data</li><li class="listitem"><code class="literal">response</code>: An object of the actual response Twitter sends back when you post a tweet</li></ul></div><p>In our code, we'll just post our tweet and then print it out in the console. Now go ahead and remove the <code class="literal">'Hi, this is FlightBot'</code> line. We don't need it any longer.</p><p>Now, save the modified <code class="literal">app.js</code> file. It should look like this:</p><pre class="programlisting">var TwitterPackage = require('twitter'); 
 
var secret = { 
  consumer_key: 'PUT YOURS', 
  consumer_secret: 'PUT YOURS', 
  access_token_key: 'PUT YOURS', 
  access_token_secret: 'PUT YOURS' 
} 
 
var Twitter = new TwitterPackage(secret); 
 
Twitter.post('statuses/update', {status: 'This is a sample automated Tweet'},  function(error, tweet, response){ 
  if(error){ 
    console.log(error); 
  } 
  console.log(tweet);  // Tweet body. 
  console.log(response);  // Raw response object. 
}); 
</pre><p>Now let's go and run the app:</p><pre class="programlisting">
<strong>node app.js</strong>
</pre><p>This will produce the following result on the command line console:</p><p>
</p><div><img src="img/image00222.jpeg" alt="Posting to Twitter"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>If we then inspect Twitter itself, we can see the following:</p><p>
</p><div><img src="img/image00223.jpeg" alt="Posting to Twitter"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Really cool! We now have a way to send automatic tweets. However, we don't have a full blown bot yet. Let's explore how we can achieve that.</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec19"/>Listening to tweets</h1></div></div></div><p>In order to create a functional Twitter bot, it is not enough to be able to simply post something to Twitter. We also need to be able to listen to what gets posted on Twitter.</p><p>Twitter has a very useful API called <code class="literal">Streaming</code> which gives us information about tweets in real time. In other words, when someone tweets something that we care about, we get all the data about that tweet. This is both really useful and really awesome.</p><p>So let's re-implement a bit of our code as follows:</p><pre class="programlisting">Twitter.stream('statuses/filter', {track: '#FlightBot'}, function(stream) { 
  stream.on('data', function(tweet) { 
    console.log(tweet.text); 
  }); 
 
  stream.on('error', function(error) { 
    console.log(error); 
  }); 
}); 
</pre><p>Let's analyze this. The <code class="literal">Twitter.stream</code> function takes in three parameters:</p><div><ul class="itemizedlist"><li class="listitem">The first parameter is a string that tells Twitter that we want to listen for statuses with a certain filter. In this case, we are filtering by using a hashtag.</li><li class="listitem">The second parameter is where we define that filter with an object. That object contains the property <code class="literal">track</code> which lets us define a word, hashtag, or phrase that we care to listen for. For this, we will be tracking when someone tweets with the hashtag <code class="literal">'#FlightBot'</code>.</li><li class="listitem">The last parameter is a function that gets called when Twitter is done setting up our stream. When it's done setting up our stream, it then passes that stream object in to the function. Within this function, we can set up what happens when we receive a tweet, along with other things, such as error handling, and so on.</li></ul></div><p>Now let's take a closer look at what happens when we receive data:</p><pre class="programlisting">stream.on('data', function(tweet) { 
  console.log(tweet.text); 
}); 
</pre><p>So, using the <code class="literal">stream</code> object, it calls the <code class="literal">on</code> function. Now, with the <code class="literal">on</code> function, you pass in a string and a function. This means that when a tweet occurs, we call this function with that data. At the moment, we just print out <code class="literal">tweet.text</code>, which is how you access the actual text of the tweet that was received that used the hashtag <code class="literal">'#FlightBot'</code>.</p><p>Let's now go ahead and comment the <code class="literal">Twitter.post</code> code so we don't post the same tweet twice. Then, if we save the <code class="literal">app.js</code> file and then call <code class="literal">node app.js</code> in the command line, you'll notice that the command line no longer shows you a prompt.</p><p>This is because it's running and listening for some sort of data to come in from that stream. If you need to stop it, press <em>
<strong>Ctrl</strong>
</em> + <em>
<strong>C</strong>
</em> a few times to return to the prompt.</p><p>In order to test this, go to Twitter and tweet something with <code class="literal">'#FlightBot'</code>, as shown in the following screenshot:</p><p>
</p><div><img src="img/image00224.jpeg" alt="Listening to tweets"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Now check your running command line. You should see the text of your tweet printed out:</p><p>
</p><div><img src="img/image00225.jpeg" alt="Listening to tweets"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Awesome! We've now implemented a mechanism that can listen to tweets.</p><p>The update <code class="literal">app.js</code> code now looks like this:</p><pre class="programlisting">var TwitterPackage = require('twitter'); 
 
var secret = { 
  consumer_key: 'PUT YOURS', 
  consumer_secret: 'PUT YOURS', 
  access_token_key: 'PUT YOURS', 
  access_token_secret: 'PUT YOURS' 
} 
 
var Twitter = new TwitterPackage(secret); 
 
Twitter.stream('statuses/filter', {track: '#FlightBot'}, function(stream) { 
  stream.on('data', function(tweet) { 
    console.log(tweet.text); 
  }); 
 
  stream.on('error', function(error) { 
    console.log(error); 
  }); 
}); 
</pre></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec20"/>Replying to who tweeted</h1></div></div></div><p>So far, we've managed to write some code that posts a tweet and we've also written code that acts on tweets that have been written. So what's next?</p><p>The next thing to do is to basically combine both parts together into a single code base, as this will be the basic layer of our bot.</p><p>One of the things you might want to do is to give the bot the ability to reply to the person who tweeted with your hashtag. To do this, the bot needs to mention them.</p><p>You can access the username of the person who tweeted with your hashtag by using  <code class="literal">tweet.user.screen_name</code>.</p><p>In order to mention them, concatenate a <code class="literal">'@'</code> symbol at the beginning by doing this:</p><pre class="programlisting">var mentionString = '@' + tweet.user.screen_name; &#13;
</pre><p>Then just concatenate that to the string you want to tweet out. We're now replying to the person who tweeted. Cool!</p><p>So, let's now look at the complete source code to get a full picture:</p><pre class="programlisting">var TwitterPackage = require('twitter'); &#13;
 &#13;
var secret = { &#13;
  consumer_key: 'PUT YOURS', &#13;
  consumer_secret: 'PUT YOURS', &#13;
  access_token_key: 'PUT YOURS', &#13;
  access_token_secret: 'PUT YOURS' &#13;
} &#13;
 &#13;
var Twitter = new TwitterPackage(secret); &#13;
 &#13;
Twitter.stream('statuses/filter', {track: '#FlightBot'}, function(stream) { &#13;
  stream.on('data', function(tweet) { &#13;
    console.log(tweet.text); &#13;
    var statusObj = {status: "Hi @" +  &#13;
    tweet.user.screen_name + ", Thanks for reaching out. How are you?"} &#13;
 &#13;
     &#13;
    Twitter.post('statuses/update', statusObj, function(error,  &#13;
    tweetReply, response){ &#13;
 &#13;
      if(error){ &#13;
        console.log(error); &#13;
      } &#13;
 &#13;
      console.log(tweetReply.text); &#13;
    }); &#13;
  }); &#13;
 &#13;
  stream.on('error', function(error) { &#13;
    //print out the error &#13;
    console.log(error); &#13;
  }); &#13;
}); &#13;
</pre><p>If we now execute the app with <code class="literal">node app.js</code>, we should be able to pick up any hashtags with the keyword <code class="literal">'#FlightBot'</code>. Let's have a look:</p><p>
</p><div><img src="img/image00226.jpeg" alt="Replying to who tweeted"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>We now get the following result:</p><p>
</p><div><img src="img/image00227.jpeg" alt="Replying to who tweeted"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>This is really awesome. With just a few lines of code we were able to create a simple Twitter bot. But we are still not done. We haven't added any logic on how to provide basic flight details or data yet .</p><p>But before we do that, let's put the <code class="literal">secret</code> variable object into a <code class="literal">secret.json</code> file, so we can avoid having the access codes and tokens within our code.</p><p>Create a new <code class="literal">secret.json</code> file and save it in the same folder as the <code class="literal">app.js</code> file. The <code class="literal">secret.json</code> file should now look like this:</p><pre class="programlisting">{ &#13;
  "consumer_key": "PUT YOURS", &#13;
  "consumer_secret": "PUT YOURS", &#13;
  "access_token_key": "PUT YOURS", &#13;
  "access_token_secret": "PUT YOURS" &#13;
} &#13;
</pre><p>This <code class="literal">secret.json</code> file is then referenced from the code, and it now looks as follows:</p><pre class="programlisting">var TwitterPackage = require('twitter'); &#13;
var secret = require("./secret"); &#13;
var Twitter = new TwitterPackage(secret); &#13;
 &#13;
Twitter.stream('statuses/filter', {track: '#FlightBot'}, function(stream) { &#13;
 &#13;
  stream.on('data', function(tweet) { &#13;
    console.log(tweet.text); &#13;
    var statusObj = {status: "Hi @" + tweet.user.screen_name +  &#13;
    ", Thanks for reaching out. How are you?"} &#13;
 &#13;
    Twitter.post('statuses/update', statusObj,   &#13;
      function(error, tweetReply, response){ &#13;
      if(error){ &#13;
        console.log(error); &#13;
      } &#13;
      console.log(tweetReply.text); &#13;
    }); &#13;
  }); &#13;
 &#13;
  stream.on('error', function(error) { &#13;
    console.log(error); &#13;
  }); &#13;
}); &#13;
</pre><p>Now that we have the updated code, let's add the necessary logic to send information about flights statuses and information.</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec21"/>Flight APIs</h1></div></div></div><p>In order to get some flight information, we'll have to rely on a flight API. One that is free and really useful is the one from <strong>Air France-KLM</strong>, which is available at <a class="ulink" href="https://developer.airfranceklm.com/">
https://developer.airfranceklm.com/
</a>.</p><p>
</p><div><img src="img/image00228.jpeg" alt="Flight APIs"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>So let's sign up and register an account. There are several APIs (found at <a class="ulink" href="https://developer.airfranceklm.com/Our_Apis">
https://developer.airfranceklm.com/Our_Apis
</a>) provided by Air France-KLM such as Reservations, Order, Flight Offer, Flight Status, Location, Contact Information, Ancillary Shop, and Check-in.</p><p>We are interested in using the <strong>Flight Status API</strong> (<a class="ulink" href="https://developer.airfranceklm.com/page/Flight_status_API">
https://developer.airfranceklm.com/page/Flight_status_API
</a>), which will provided up-to-date and accurate information about specific flight numbers. Let's explore this API a bit.</p><p>The Flight Status API provides flight status information-such as scheduled and actual arrival and departure times-of KLM-operated flights, or Delta and Air France-operated flights with a KLM codeshare, flying to and from the Air France-KLM hub in Amsterdam.</p><p>The API supports operational decision making, such as notification in case of exceptional situations, like extreme weather conditions.</p><p>The great thing about this API is that it doesn't require API keys, and it is available for free. The catch is that it only returns data from the day that you execute the query-that is, it only returns today's data and doesn't return any past flight status information.</p><p>There are two ways to search with this API. One is to search using a flight number and the other is to use a route.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec15"/>Flight status API</h2></div></div></div><p>When searching using a flight number, the <code class="literal">REST</code> endpoint will provide the flight status for a given flight, and you must specify the day's date; for example, flight KL1699 on  September 16, 2016. The request would look like this:</p><p>
<a class="ulink" href="http://fox.klm.com/fox/json/flightstatuses?flightNumber=KL1699&amp;departureDate=2016-09-16">
http://fox.klm.com/fox/json/flightstatuses?flightNumber=KL1699&amp;departureDate=2016-09-16
</a>
</p><p>This would return the following JSON response:</p><pre class="programlisting">{ "flights" : [ { "@type" : "OperatingFlight", &#13;
        "aircraft" : { "registrationCode" : "PH-BGT" }, &#13;
        "carrier" : { "code" : "KL" }, &#13;
        "flightNumber" : "1699", &#13;
        "marketingFlights" : [ { "carrier" : { "code" : "KQ" }, &#13;
              "flightNumber" : "1699" &#13;
            }, &#13;
            { "carrier" : { "code" : "DL" }, &#13;
              "flightNumber" : "9605" &#13;
            } &#13;
          ], &#13;
        "operatingFlightLeg" : { "arrivesOn" : { "@type" : "Airport", &#13;
                "IATACode" : "MAD" &#13;
              }, &#13;
            "departsFrom" : { "@type" : "Airport", &#13;
                "IATACode" : "AMS" &#13;
              }, &#13;
            "flightStatus" : "ARRIVED", &#13;
            "legs" : [ { "actualArrivalDateTime" : "2016-09-16T09:26+02:00", &#13;
                  "actualDepartureDateTime" : "2016-09-16T06:59+02:00", &#13;
                  "arrivesOn" : { "@type" : "Airport", &#13;
                      "IATACode" : "MAD" &#13;
                    }, &#13;
                  "departsFrom" : { "@type" : "Airport", &#13;
                      "IATACode" : "AMS" &#13;
                    }, &#13;
                  "scheduledArrivalDateTime" : "2016-09-16T09:35+02:00", &#13;
                  "scheduledDepartureDateTime" : "2016-09-16T07:00+02:00", &#13;
                  "status" : "ARRIVED" &#13;
                } ], &#13;
            "scheduledArrivalDateTime" : "2016-09-16T09:35+02:00", &#13;
            "scheduledDepartureDateTime" : "2016-09-16T07:00+02:00" &#13;
          }, &#13;
        "remainingFlyTime" : "PT0.000S" &#13;
      } ]  &#13;
} &#13;
</pre><p>That was easy and fun! Now let's explore the route search API.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec16"/>Route search API</h2></div></div></div><p>The Route Search REST endpoint provides a summary of flight statuses for all applicable flights in a given route, such as Amsterdam (AMS) and Paris Charles de Gaulle (CDG).</p><p>The request would look like this:</p><p>
<a class="ulink" href="http://fox.klm.com/fox/json/flightstatuses?originAirportCode=AMS&amp;destinationAirportCode=CDG">
http://fox.klm.com/fox/json/flightstatuses?originAirportCode=AMS&amp;destinationAirportCode=CDG
</a>
</p><p>The JSON result would be as follows.</p><pre class="programlisting">{ "flights" : [ { "@type" : "OperatingFlight", &#13;
        "_links" : { "detailedInfoLink" :     "http://fox.klm.com/fox/json/flightstatuses flightNumber=KL1223&amp;departureDate=2016-09-15&amp;originAirport=AMS&amp;destinationAirport=CDG" }, &#13;
        "carrier" : { "code" : "KL" }, &#13;
        "flightNumber" : "1223", &#13;
        "operatingFlightLeg" : { "arrivesOn" : { "@type" : "Airport", &#13;
                "IATACode" : "CDG" &#13;
              }, &#13;
            "departsFrom" : { "@type" : "Airport", &#13;
                "IATACode" : "AMS" &#13;
              }, &#13;
            "flightStatus" : "ARRIVED", &#13;
            "scheduledArrivalDateTime" : "2016-09-15T08:00+02:00", &#13;
            "scheduledDepartureDateTime" : "2016-09-15T06:45+02:00" &#13;
          } &#13;
      }, &#13;
      { "@type" : "OperatingFlight", &#13;
        "_links" : { "detailedInfoLink" : "http://fox.klm.com/fox/json/flightstatuses?flightNumber=KL1227&amp;departureDate=2016-09-16&amp;originAirport=AMS&amp;destinationAirport=CDG" }, &#13;
        "carrier" : { "code" : "KL" }, &#13;
        "flightNumber" : "1227", &#13;
        "operatingFlightLeg" : { "arrivesOn" : { "@type" : "Airport", &#13;
                "IATACode" : "CDG" &#13;
              }, &#13;
            "departsFrom" : { "@type" : "Airport", &#13;
                "IATACode" : "AMS" &#13;
              }, &#13;
            "flightStatus" : "ARRIVED", &#13;
            "scheduledArrivalDateTime" : "2016-09-16T08:40+02:00", &#13;
            "scheduledDepartureDateTime" : "2016-09-16T07:15+02:00" &#13;
          } &#13;
      }, &#13;
      { "@type" : "OperatingFlight", &#13;
        "_links" : { "detailedInfoLink" : "http://fox.klm.com/fox/json/flightstatuses?flightNumber=GA9240&amp;departureDate=2016-09-16&amp;originAirport=AMS&amp;destinationAirport=CDG" }, &#13;
        "carrier" : { "code" : "GA" }, &#13;
        "flightNumber" : "9240", &#13;
        "operatingFlightLeg" : { "arrivesOn" : { "@type" : "Airport", &#13;
                "IATACode" : "CDG" &#13;
              }, &#13;
            "departsFrom" : { "@type" : "Airport", &#13;
                "IATACode" : "AMS" &#13;
              }, &#13;
            "flightStatus" : "ARRIVED", &#13;
            "scheduledArrivalDateTime" : "2016-09-16T09:25+02:00", &#13;
            "scheduledDepartureDateTime" : "2016-09-16T07:55+02:00" &#13;
          } &#13;
      } &#13;
    ]  &#13;
} &#13;
</pre><p>The response includes the following information--Scheduled Departure Date Time, Scheduled Arrival Date Time, Flight Status, Marketing Flights, Remaining Fly Time, Arrival, and Departure information.</p><p>So now that we have an API to query, let's make our bot a bit smarter and allow it to retrieve flight status and route details.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec17"/>Adding a REST client library</h2></div></div></div><p>Using the code we already have, which is able to respond back to the person that actually tweeted the <code class="literal">'#FlightBot'</code> hashtag, let's make some modifications so that it can provide status details about flights and routes using the Air France-KLM APIs.</p><p>The first thing that we need to do in order to communicate to the Air France-KLM endpoints is to include a <code class="literal">REST</code> client library for Node.js in our app.</p><p>There are various Node.js REST client libraries out there, and you can choose whichever makes you feel more comfortable. For our example, however, we'll be using the library found at <a class="ulink" href="https://www.npmjs.com/package/request">
https://www.npmjs.com/package/request
</a>.</p><p>The first thing we need to do is to install it. We can do this from the command line by executing this instruction:</p><pre class="programlisting">
<strong>npm install request --save</strong>
</pre><p>After doing this, our <code class="literal">package.json</code> file will be updated as follows:</p><p>
</p><div><img src="img/image00229.jpeg" alt="Adding a REST client library"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Note how a reference to <code class="literal">request</code> has been added. This is because we have used the save option when executing the previous instruction.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec22"/>Making the bot a bit smarter</h1></div></div></div><p>Now that we have added a <code class="literal">REST</code> client library, it's time to add some logic to our application in order to interact with the Air France-KLM APIs.</p><p>Our bot should be able to provide feedback about flights and routes using the API endpoints previously described.</p><p>Let's make some changes to our code to accommodate this. In order to do that, let's add some logic to make sure that the bot is able to process not only the Twitter hashtag but also a flight number.</p><p>So we will essentially automate the call to this REST endpoint and parse the response associated with it, returning just some essential bits of that data, but not all of it. Sounds exciting, so let's get started.</p><p>We need to automate this endpoint through a <code class="literal">REST</code> call. We need to make sure that, besides the hashtag, a flight number is also passed as part of the message:</p><p>
<a class="ulink" href="http://fox.klm.com/fox/json/flightstatuses?flightNumber=KL1699&amp;departureDate=2016-09-16">
http://fox.klm.com/fox/json/flightstatuses?flightNumber=KL1699&amp;departureDate=2016-09-16
</a>
</p><p>Here's the full updated code. Let's have a complete look at it and then dissect it bit by bit to understand the changes that were made:</p><pre class="programlisting">var TwitterPackage = require('twitter'); 
var secret = require("./secret"); 
var Twitter = new TwitterPackage(secret); 
var request = require('request'); 
 
padLeft = function (str, paddingChar, length) { 
  var s = new String(str); 
 
  if ((str.length &lt; length) &amp;&amp; (paddingChar.toString().length &gt; 0)) 
  { 
      for (var i = 0; i &lt; (length - str.length) ; i++) 
        s = paddingChar.toString().charAt(0).concat(s); 
  } 
 
  return s; 
}; 
 
GetDate = function() { 
  var dateObj = new Date(); 
  var month = dateObj.getUTCMonth() + 1; //months from 1-12 
  var day = dateObj.getUTCDate(); 
  var year = dateObj.getUTCFullYear(); 
 
  return year + '-' + padLeft(month.toString(), '0', 2) + '-' +  
    padLeft(day.toString(), '0', 2); 
}; 
 
FlightNumberOk = function(str) { 
  var posi = str.indexOf('KL'); 
  var fn = str.substring(posi); 
  return (posi &gt;= 0 &amp;&amp; fn.length === 6) ? fn : ''; 
}; 
 
var fd = ''; 
 
GetFlightDetails = function(fn) { 
  var dt = GetDate(); 
  var rq = 'http://fox.klm.com/fox/json/flightstatuses?flightNumber=' + fn +  
    '&amp;departureDate=' + dt; 
 
  request(rq, function (error, response, body) { 
    if (!error &amp;&amp; response.statusCode == 200) { 
      fd = body; 
    } 
  }) 
}; 
 
Twitter.stream('statuses/filter', {track: '#FlightBot'}, function(stream) { 
 
  stream.on('data', function(tweet) { 
    var statusObj = {status: "Hi @" + tweet.user.screen_name +  
      ", Thanks for reaching out. We are missing the flight number."}; 
 
    var fn = FlightNumberOk(tweet.text); 
 
    if (fn !== '') { 
      GetFlightDetails(fn); 
    } 
 
    setTimeout(function() { 
      console.log ('fd: ' + fd); 
 
      if (fd !== undefined) { 
        var ff = JSON.parse(fd); 
        statusObj = {status: "scheduledArrivalDateTime: "  +  
          ff.flights[0].operatingFlightLeg.scheduledArrivalDateTime}; 
      } 
 
      Twitter.post('statuses/update', statusObj,  function(error, tweetReply,  
      response) { 
        if (error){ 
          console.log(error); 
        } 
        console.log(tweetReply.text); 
      }); 
    }, 1500); 
  }); 
 
  stream.on('error', function(error) { 
    console.log(error); 
  }); 
}); 
</pre><p>OK, so there are some changes. The first one is that we have added a reference to the <code class="literal">request</code> library which we will be using to make the requests to the REST API:</p><pre class="programlisting">var request = require('request'); 
</pre><p>Following that, we've added a <code class="literal">GetDate</code> function which will return today's date so it can be passed onto the <code class="literal">REST</code> endpoint as the <code class="literal">departureDate</code> parameter:</p><pre class="programlisting">GetDate = function() { 
  var dateObj = new Date(); 
  var month = dateObj.getUTCMonth() + 1; //months from 1-12 
  var day = dateObj.getUTCDate(); 
  var year = dateObj.getUTCFullYear(); 
 
  return year + '-' + padLeft(month.toString(), '0', 2) + '-' +  
    padLeft(day.toString(), '0', 2); 
}; 
</pre><p>This <code class="literal">GetDate</code> function uses a <code class="literal">padLeft</code> function that is responsible for correctly formatting each of the parts of the date as shown in the following code snippet:</p><pre class="programlisting">padLeft = function (str, paddingChar, length) { 
  var s = new String(str); 
 
  if ((str.length &lt; length) &amp;&amp; (paddingChar.toString().length &gt; 0)) 
  { 
      for (var i = 0; i &lt; (length - str.length) ; i++) 
        s = paddingChar.toString().charAt(0).concat(s); 
  } 
 
  return s; 
}; 
</pre><p>These two functions cover the <code class="literal">departureDate</code> part of the REST endpoint. So now let's focus on the <code class="literal">flightNumber</code> part.</p><p>For this, we've written a function called <code class="literal">FlightNumberOk</code>, which does a quick check to ensure that the flight number is correct:</p><pre class="programlisting">FlightNumberOk = function(str) { 
  var posi = str.indexOf('KL'); 
  var fn = str.substring(posi); 
  return (posi &gt;= 0 &amp;&amp; fn.length === 6) ? fn : ''; 
}; 
</pre><p>With the flight number correct, we can then use another function called <code class="literal">GetFlightDetails</code> to actually perform the call to the <code class="literal">REST</code> endpoint. The JSON response is represented by the variable <code class="literal">body</code>, which is then assigned to the <code class="literal">fd</code> variable, which is later used to tweet a response back to the user. Refer to the following code:</p><pre class="programlisting">GetFlightDetails = function(fn) { 
  var dt = GetDate(); 
  var rq = 'http://fox.klm.com/fox/json/flightstatuses?flightNumber=' + fn +  
    '&amp;departureDate=' + dt; 
 
  request(rq, function (error, response, body) { 
    if (!error &amp;&amp; response.statusCode == 200) { 
      fd = body; 
    } 
  }) 
}; 
</pre><p>Because the <code class="literal">GetFlightDetails</code> uses the request library to perform an asynchronous request to the <code class="literal">REST</code> endpoint, we cannot tweet the response until the JSON response is obtained, and to ensure that, the tweet response is executed within a <code class="literal">setTimeout</code> JavaScript function 1,500 milliseconds after the execution of the <code class="literal">GetFlightDetails</code> takes place.</p><p>So basically our <code class="literal">Twitter.stream</code> function now looks like this:</p><pre class="programlisting">Twitter.stream('statuses/filter', {track: '#FlightBot'}, function(stream) { 
   
  stream.on('data', function(tweet) { 
    var statusObj = {status: "Hi @" + tweet.user.screen_name + ", Thanks for  
      reaching out. We are missing the flight number."}; 
 
    var fn = FlightNumberOk(tweet.text); 
 
    if (fn !== '') { 
      GetFlightDetails(fn); 
    } 
 
    setTimeout(function() { 
      console.log ('fd: ' + fd); 
 
      if (fd !== undefined) { 
        var ff = JSON.parse(fd); 
        statusObj = {status: "scheduledArrivalDateTime: "  +  
          ff.flights[0].operatingFlightLeg.scheduledArrivalDateTime}; 
      } 
 
      Twitter.post('statuses/update', statusObj,  function(error, tweetReply,  
      response) { 
        if (error){ 
          console.log(error); 
        } 
        console.log(tweetReply.text); 
      }); 
    }, 1500); 
  }); 
 
  stream.on('error', function(error) { 
    console.log(error); 
  }); 
}); 
</pre><p>Note how <code class="literal">FlightNumberOk</code> and <code class="literal">GetFlightDetails</code> are called before the <code class="literal">Twitter.Post</code> is called by the <code class="literal">setTimeout</code> function. This is done to ensure that the flight number is OK, and that the JSON response containing the flight details exists, before sending out the tweet to the user.</p><p>The tweet response basically sends out <code class="literal">scheduledArrivalDateTime</code>, which is obtained by parsing the JSON response using <code class="literal">JSON.parse</code>. This is accessed as follows:</p><pre class="programlisting">ff.flights[0].operatingFlightLeg.scheduledArrivalDateTime 
</pre><p>If we execute the program now and tweet <code class="literal">#FlightBot KL1699</code>, we'll get the following:</p><p>
</p><div><img src="img/image00230.jpeg" alt="Making the bot a bit smarter"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>So that's cool, isn't it? Really cool!</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec23"/>Summary</h1></div></div></div><p>Throughout this chapter, we've seen how to interact with Twitter and also how to query the Air France-KLM API in order to retrieve flight details and respond to tweets.</p><p>We've barely scratched the surface of what can be done with these APIs; the possibilities are, frankly, quite endless. All you need is time and a good dose of imagination!</p><p>You are encouraged to keep exploring both the Twitter and also the Air France-KLM APIs, as well as other flight data APIs out there. It's definitely an interesting area, and one worth exploring further.</p><p>I hope you have enjoyed following these examples. The next chapters will look at other fascinating topics. Have fun!</p></div></body></html>