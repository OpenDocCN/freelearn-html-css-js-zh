<html><head></head><body><div class="appendix" title="Appendix&#xA0;A.&#xA0;Security Tips for Apex and Visualforce Development"><div class="titlepage"><div><div><h1 class="title"><a id="appA"/>Appendix A. Security Tips for Apex and Visualforce Development</h1></div></div></div><p>Security<a id="id319" class="indexterm"/> is an important part of web-based applications. This important part applies for the Force.com applications as well. We create custom pages with Visualforce markup and Apex, and this allows us to provide fully-customized functionality to the client. When we use these programming languages, we must be careful with the security aspects.</p><p>The Force.com platform has some in-built security assistance, such as user management, profile management, role hierarchy, <a id="id320" class="indexterm"/>
<span class="strong"><strong>organization wide defaults</strong></span> (<span class="strong"><strong>OWD</strong></span>), permission sets, public groups, sharing settings, field accessibility, password policies, session settings, network access, login access policies, certificate and key management, single sign-on Settings, Auth. Providers, Identity Provider, View Setup Audit Trail, Expire All Passwords, Delegated Administration, Remote Site Settings and HTML Documents and Attachments Settings. But when we create custom pages with Apex and Visualforce, we must be careful because there are many ways to bypass the in-built security defenses on the Force.com platform. There can be general security vulnerabilities as well as Apex and Visualforce specific vulnerabilities.</p><div class="section" title="Security scanning tools"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec51"/>Security scanning tools</h1></div></div></div><p>Before we add an <a id="id321" class="indexterm"/>application to AppExchange, we have to get the certification for the security aspects. A developer must be aware of these security concerns. There are some tools available to scan our code for security and quality for example, the Force.com Security Source Scanner.</p><div class="section" title="Force.com Security Source Scanner"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec32"/>Force.com Security Source Scanner</h2></div></div></div><p>The Force.com <a id="id322" class="indexterm"/>Security Source Scanner is a cloud-based code analysis<a id="id323" class="indexterm"/> tool for the Force.com platform. This is a free tool for Force.com developers and the code is scanned on a first-come-first-serves basis. The file size, queue size, and the complexity of the code directly affects the time for getting the scan results. For scanning a particular Salesforce.com user account, we must have the "Author Apex" permission and the particular code must not be contained within a package. We can submit the code for scanning at <a class="ulink" href="http://security.force.com/security/tools/forcecom/scanner">http://security.force.com/security/tools/forcecom/scanner</a>. This tool scans every possible code flow and checks for security vulnerabilities and quality of the Apex code. The Force.com Security Source Scanner can detect the following security vulnerabilities.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Cross-site scripting</li><li class="listitem" style="list-style-type: disc">SOQL injection</li><li class="listitem" style="list-style-type: disc">SOSL injection</li><li class="listitem" style="list-style-type: disc">Frame spoofing</li><li class="listitem" style="list-style-type: disc">Access control issues</li></ul></div><p>The Force.com <a id="id324" class="indexterm"/>Security Source Scanner can detect following code and <a id="id325" class="indexterm"/>design issues:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">DML statements inside loops</li><li class="listitem" style="list-style-type: disc">SOQL/SOSL inside loops</li><li class="listitem" style="list-style-type: disc">Not bulkifying Apex methods</li><li class="listitem" style="list-style-type: disc">Asynchronous (<code class="literal">@future</code>) methods inside loops</li><li class="listitem" style="list-style-type: disc">Hardcoding IDs</li><li class="listitem" style="list-style-type: disc">Hardcoding <code class="literal">Trigger.new[0]</code></li><li class="listitem" style="list-style-type: disc">Hardcoding <code class="literal">Trigger.old[0]</code></li><li class="listitem" style="list-style-type: disc">Referencing static resources</li><li class="listitem" style="list-style-type: disc">Queries with no <code class="literal">Where</code> clause or no <code class="literal">LIMIT</code> clause</li><li class="listitem" style="list-style-type: disc">Multiple triggers on the same object</li></ul></div></div></div></div>
<div class="section" title="Cross-site scripting (XSS)"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec52"/>Cross-site scripting (XSS)</h1></div></div></div><p>Cross-site scripting<a id="id326" class="indexterm"/> attacks web applications where there is malicious client-side scripting or HTML. If the web application includes a malicious script, then the attacker can use the web application as an intermediate layer and make the trusted user a victim of the attack. A cross-site scripting weakness occurs when dynamically-generated web pages display invalidated, unfiltered, and non-encoded user input, allowing an attacker to embed malicious scripts into the generated page. This can be leveraged to execute the scripting code as if it came from the site's server on to the computer of anyone who used the site.</p><p>The Force.com platform has several methods to protect from XSS attacks, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Unescaped output and formulas in Visualforce pages</strong></span>: There can be Visualforce pages <a id="id327" class="indexterm"/>which depend on the user input, and further functionality will proceed with that user input. There are some encoding functions to stop XSS vulnerabilities, which are as follows:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">HTMLENCODE</code>: This <a id="id328" class="indexterm"/>function encodes the text and the merged field values<a id="id329" class="indexterm"/> to reserved HTML characters. For example, the greater than sign(&gt;) into &amp;gt.</li><li class="listitem" style="list-style-type: disc"><code class="literal">JSENCODE</code>: This<a id="id330" class="indexterm"/> function<a id="id331" class="indexterm"/> encodes the text and merged field values by inserting escape characters.</li><li class="listitem" style="list-style-type: disc"><code class="literal">JSINHTMLENCODE</code>: This <a id="id332" class="indexterm"/>function does the tasks of both the<a id="id333" class="indexterm"/> <code class="literal">HTMLENCODE</code> and <code class="literal">JSENCODE</code> functions.</li><li class="listitem" style="list-style-type: disc"><code class="literal">URLENCODE</code>: This <a id="id334" class="indexterm"/>function encodes the text and merged field <a id="id335" class="indexterm"/>values by replacing illegal characters in URLs. For example, blank spaces are replaced by %20.</li></ul></div></li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip38"/>Tip</h3><p>All the standard Visualforce components (starting with <code class="literal">&lt;apex&gt;</code>) are anti-XSS. They have a filter to stop the XSS attacks. Optionally, we can disable the escape on Visualforce components by setting the value of the escape attribute to false.</p></div></div></div>
<div class="section" title="Cross-site request forgery (CSRF)"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec53"/>Cross-site request forgery (CSRF)</h1></div></div></div><p>The Web does not, and cannot, sufficiently verify whether a <a id="id336" class="indexterm"/>well-formed, valid, consistent request was intentionally provided by the user who submitted the request. In effect, when a server receives a request it has no ability to determine whether that was initiated by a valid user or an attacker, leading to potential escalation of the privilege or theft of data attacks.</p><p>The Force.com platform has implemented an anti-CSRF in standard controllers. Each page has random characters as a hidden field. When we load the next page, the validity will be checked and the command will be executed after the value matches with the expected value.</p><p>The following code has bypassed the anti-CSRF controls in a custom <a id="id337" class="indexterm"/>method called <code class="literal">AutoRun</code>. There aren't any in-built anti-CSRF controls for such scenarios in the Force.com platform. There are workarounds that will add an intermediate confirmation page before<a id="id338" class="indexterm"/> executing the action and shortening the idle session timeout for an organization:</p><div class="informalexample"><pre class="programlisting">&lt;apex:page controller="SecurityIssuesController" sidebar="false" action="{!AutoRun}"&gt; 

public class SecurityIssuesController{
public Pagereference AutoRun(){
  Id id = ApexPages.currentPage().getParameters().get('id');
  Item__c singleItem = [select id, Name FROM Item__c WHERE id = :id];
  delete singleItem;	
  return null;
}
}</pre></div></div>
<div class="section" title="SOQL injection"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec54"/>SOQL injection</h1></div></div></div><p>The most popular injection <a id="id339" class="indexterm"/>attacks occur when the user's input is directly involved with the query or command. Therefore, the attacker can pass an untrusted date to execute a particular functionality or command. Then the attacker will get the access to unauthorized data.</p><p>Apex uses SOQL as the query language and it has limited functionality than SQL. But the SOQL injection attacks are similar to SQL injection attacks. The Salesforce.com users are willing to put their sensitive data into Salesforce because Salesforce.com is a secure platform. Therefore, when we build custom pages and custom controllers, we must pay more attention to prevent such attacks. In Force.com, SOQL injections occur with dynamic SOQL queries.</p><p>Dynamic SOQL is used to create the SOQL query string at the runtime of Apex code and allows us to build more flexible functionality (for example, the search functionality which depends on the user's input). Using the <code class="literal">Database.query(queryString)</code> method, we can create dynamic queries that return a single <code class="literal">sObject</code> or a list of <code class="literal">sObjects</code>. The SOQL injection can be implemented in Apex if the application proceeds with the user's input to build a dynamic SOQL and we haven't handled the input properly.</p><p>The Force.com platform provides a method called<a id="id340" class="indexterm"/> <code class="literal">escapeSingleQuotes</code> to prevent SOQL injections. Using this method, we can handle the user's input by adding the escape character (<code class="literal">\</code>) to all single quotations in the user input string. Basically, this method considers all the single quotation as enclosing strings instead of database commands.</p><p>The following <a id="id341" class="indexterm"/>example illustrates the SOQL injection's vulnerability in Apex. This query returns order records which are not delivered and the customer's name (<code class="literal">cusName</code>) for the specific order is found according to the user input.</p><div class="informalexample"><pre class="programlisting">String queryString = 'SELECT Id FROM Order__c WHERE (Delivered__c = false and Customer__r.Name like \'%' + cusName + '%')';</pre></div><p>If the user input is <code class="literal">chamil</code>, the executing query string would be as follows:</p><div class="informalexample"><pre class="programlisting">queryString = SELECT Id FROM Order__c WHERE (Delivered__c = false and Customer__r.Name like '% chamil %')</pre></div><p>That's a<a id="id342" class="indexterm"/> clean input. But the problem is that users can enter malicious inputs, for example, <code class="literal">chamil%'</code> or <code class="literal">Customer__r.Name like '</code>. Then the query string would look as follows:</p><div class="informalexample"><pre class="programlisting">queryString = SELECT Id FROM Order__c WHERE (Delivered__c = false and Customer__r.Name like '%chamil%') or (Name like '%')</pre></div><p>In this case, the result of the query will not return selective orders but will deliver all the orders from the database This is the impact of SOQL injections. There is a way to protect from such SOQL injection attacks. We can use a string variable to assign the user input to, and add that particular variable to the dynamic query. The following is the fixed code snippet for the preceding vulnerability:</p><div class="informalexample"><pre class="programlisting">String userInput = '%' + cusName  + '%'; 
String queryString = 'SELECT Id FROM Order__c WHERE (Delivered__c = false and Customer__r.Name like: userInput)';</pre></div></div>
<div class="section" title="Data access control"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec55"/>Data access control</h1></div></div></div><p>The Force.com platform <a id="id343" class="indexterm"/>allows us to configure object permissions (read, create, edit, and delete) and create data sharing rules. We can implement security controls using those features. The standard controllers adhere to these security settings. But the custom controllers and controller extensions can access all the data during the execution. This is the default behavior, but we can control the data access from Apex classes using the <code class="literal">with sharing</code> keyword. The keyword is used as follows:</p><div class="informalexample"><pre class="programlisting">public with sharing class ExampleController {
  public void methodOne()
{
      List&lt;Item__c&gt; = [Select Id, Name FROM Item__c WHERE Id IN: itemIds];
}
}</pre></div><p>The <code class="literal">with sharing</code> keyword<a id="id344" class="indexterm"/> forces the Apex class to consider the security sharing permissions of the logged user.</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec56"/>Summary</h1></div></div></div><p>We have learned the importance of securing an application. We became familiar with the possible vulnerabilities, solution for those vulnerabilities, and security scanning tools.</p><p>Every start has an end, and thus we have reached the end of the book. We have covered the most important topics that will help you to improve the knowledge of Visualforce development. Further, you can use Force.com resources such as the Force.com discussion board (you can obtain help on technical issues), by using <code class="literal">#askforce</code> on Twitter and <a class="ulink" href="https://blogs.developerforce.com">https://blogs.developerforce.com</a>.</p><p>May the force be with you!</p></div></body></html>