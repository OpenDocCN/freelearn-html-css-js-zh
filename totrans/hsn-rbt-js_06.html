<html><head></head><body>
        

                            
                    <h1 class="header-title">Using Motors to Move Your Project</h1>
                
            
            
                
<p>We've explored using input to discover the world around our bots, and output to let our bots communicate, but there is another crucial skill any bot should have: the ability to move! In the next few chapters, we'll discuss various ways we get let our bots to move, and discuss how to control that movement. We'll start in this chapter with the simplest movement component: the motor.</p>
<p>The following topics will be covered in this chapter:</p>
<ul>
<li>More about motors</li>
<li>Preparing for a motor-driven project with the Raspberry Pi</li>
<li>The Johnny-Five motor object</li>
<li>Troubleshooting your motorized projects</li>
<li>Project – building a randomized motorized cat toy</li>
<li>Project – using a gearbox motor and the motors object</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Technical requirements</h1>
                
            
            
                
<p>You will need the Adafruit Pi motor hat kit (<a href="https://www.adafruit.com/product/2348">https://www.adafruit.com/product/2348</a>), a small 5V motor, which you can also get from Adafruit (<a href="https://www.adafruit.com/product/711">https://www.adafruit.com/product/711</a>), or many other suppliers, a 4-AA battery case with wire ends and an on/off switch, available from Adafruit (<a href="https://www.adafruit.com/product/830">https://www.adafruit.com/product/830</a>) and many other suppliers, 2 <em>gearbox</em> or <em>TT</em> motors, available from Adafruit (<a href="https://www.adafruit.com/product/3777">https://www.adafruit.com/product/3777</a>) and many other suppliers, and a sticky note (or a piece of paper, scissors, and tape).</p>
<p class="mce-root"/>
<p><strong>Note</strong>: If you cannot solder or are uncomfortable soldering, an alternative fully assembled hat can be found on Amazon (<a href="https://www.amazon.com/SB-Motorshield-Raspberry-expansion-ultrasonic/dp/B01MQ2MZDV/ref=sr_1_fkmr1_1?s=electronics&amp;ie=UTF8&amp;qid=1534705033&amp;sr=8-1-fkmr1&amp;keywords=raspberry+pi+motor+controller+TB6612">https://www.amazon.com/SB-Motorshield-Raspberry-expansion-ultrasonic/dp/B01MQ2MZDV/ref=sr_1_fkmr1_1?s=electronics&amp;ie=UTF8&amp;qid=1534705033&amp;sr=8-1-fkmr1&amp;keywords=raspberry+pi+motor+controller+TB6612</a>). I will note changes in the code where necessary—anytime this chapter references the L293D hat, that is in reference to this hat.</p>
<p>The code for this chapter is available at <a href="https://github.com/PacktPublishing/Hands-On-Robotics-with-JavaScript/tree/master/Chapter06">https://github.com/PacktPublishing/Hands-On-Robotics-with-JavaScript/tree/master/Chapter06</a>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">More about motors</h1>
                
            
            
                
<p>A motor is a component that can rotate a shaft in continuous circles at varying speeds. However, there are many different kinds of motors; let's take a look at a few:</p>
<ul>
<li><strong>DC motor</strong>: This kind of motor is the simplest: it can go in one direction, and the speed varies by the power you give it. These usually only have two wires: one for ground and one for power; we will combine the latter with the motor hat to control the speed. With the correct controller, we can move the motor in both directions.</li>
<li><strong>Motors with brakes</strong>: These motors have a third wire to control a brake that can stop the motor without the need to coast to a stop, as with DC motors. These motors are supported by the Johnny-Five library, but will not be covered in this book.</li>
<li><strong>Stepper motors</strong>: Stepper motors are used for precise movements, as they move in steps that vary based on the size of the motor. They are bi-directional by design and are great where you need the torque of a motor with precision. We'll talk more about these in the second project in this chapter. Just know that an easy way to spot a stepper motor is 5 wires as opposed to 2 or 3:</li>
</ul>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-585 image-border" src="img/d271020c-8429-4ba7-af95-2ef4583634d8.png" style="width:91.67em;height:54.08em;"/></p>
<p>Regular motor on the left, stepper motor on the right</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to control a motor with a microcontroller</h1>
                
            
            
                
<p>You can directly connect DC hobby motors to the PWM pin of a microcontroller to power them, but this is usually inadvisable: motors take up a lot of power and many microcontrollers limit the amount of current out of each pin. </p>
<p> A more advisable solution, which we will be using in this chapter, is to use an external motor controller; these usually contain the circuitry necessary to do more complex movement with your motors (such as allowing them to go backwards), and allow for an external power supply that provides the necessary power to your motors without drawing it from the microcontroller.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Preparing for a motor-driven project with Raspberry Pi</h1>
                
            
            
                
<p>In order to get started with motors using Johnny-Five and the Raspberry Pi, we'll need to add a hat (think Arduino shields, but for the Pi, or add-on boards that stack on the Pi if you're new to electronics) that allows us to:</p>
<ul>
<li>Provide external power to the motors</li>
<li>Control the motors better than the Pi can on its own (especially in the case of the stepper motor)</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Putting the hat together</h1>
                
            
            
                
<p>Wire the battery pack and the motor to the hat's screw terminals like so:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-440 image-border" src="img/4d9c3bad-3799-4ee9-9bbb-a5e56d3f410a.png" style="width:141.67em;height:99.42em;"/></p>
<p>The yellow wire in the diagram should be your ground wire (usually black) and the green should be your power wire (usually red).</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Putting the hat on the Pi</h1>
                
            
            
                
<p>Remove all power from the Pi, and make sure the battery pack is switched off. Also, remove the cobbler from the GPIO pins if it is still attached. Then, line up the sockets on the bottom of the hat with the pins on the top of the Pi, in the direction that makes it so the hat is situated over the Pi. Then, gently press down on the hat until it settles. <strong>Don't press hard— you may bend some of the Pi's pins</strong>. When all is said and done, it should look something like this:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-586 image-border" src="img/4434fd90-4e00-4061-88e1-0e2029248660.png" style="width:60.58em;height:27.92em;"/></p>
<p>And the motor should be plugged into the screw terminals, like so:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-587 image-border" src="img/4e538a40-bd6c-474b-86fc-47af5a316c01.png" style="width:40.50em;height:20.33em;"/></p>
<p>Re-apply power to the Pi, and we'll get started coding using the Johnny-Five motor object.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">The Johnny-Five motor object</h1>
                
            
            
                
<p>The motor object in Johnny-Five allows us to easily control our motors without having to worry about communicating with the hat via the Pi. Let's code a test setup with the REPL before coding our project, to make sure everything is working.</p>
<p>Create a new <kbd>project</kbd> folder and, inside it, run the following:</p>
<pre><strong>npm init -y</strong></pre>
<p>And, create a file in the folder named <kbd>motor-test.js</kbd>. Start by requiring in Johnny-Five and Raspi-IO, instantiating your board object, and creating a <kbd>board.on('ready')</kbd> handler, as we usually do:</p>
<div><pre>const Raspi = require('raspi-io')<br/>const five = require('johnny-five')<br/>const board = new five.Board({<br/>  io: new Raspi()<br/>})<br/><br/>board.on('ready', () =&gt; {<br/><br/>})</pre></div>
<p class="mce-root"/>
<p>Now, we're ready to set up our motor object, keeping in mind that we'll need to configure for our hat.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Constructors for our hat</h1>
                
            
            
                
<p>If you are using the Adafruit hat, your constructor is as follows:</p>
<pre>let motor = new five.Motor(five.Motor.SHIELD_CONFIGS.ADAFRUIT_V2.M1)</pre>
<p>And if you're using the L293D hat, your constructor is as follows:</p>
<pre>let motor = new five.Motor(five.Motor.SHIELD_CONFIGS.ADAFRUIT_V1.M1)</pre>
<p>Place whichever one applies inside the <kbd>board.on('ready')</kbd> function.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Functions that move the motor</h1>
                
            
            
                
<p>Referencing the Johnny-Five documentation, there are a few functions that will allow us to move the motor from the command line using the REPL:</p>
<pre>motor.forward(speed) // speed 0-255, starts the motor forward<br/>motor.stop() // the motor coasts to a stop<br/>motor.start(speed) // resumes the motor moving forward<br/>motor.reverse(speed) // moves the motor backward</pre>
<p>Now that we know how to control the motor, let's add the REPL functionality to test it</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Adding REPL control</h1>
                
            
            
                
<p>At the end of the <kbd>board.on('ready')</kbd> function, add the following:</p>
<pre>board.repl.inject({<br/>  motor<br/>})</pre>
<p>And now we have full control!</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Loading and running your motor</h1>
                
            
            
                
<p>Load the project onto the Pi, and navigate to the folder in the Pi ssh session. Then, run the following: </p>
<pre><strong>npm i --save johnny-five raspi-io</strong></pre>
<p>Once that's completed, turn on the battery pack and run the following:</p>
<pre><strong>sudo node motor-test.js</strong></pre>
<p>Once you see <em>Board Initialized</em>, you should try out some of the commands from before:</p>
<pre>motor.forward(speed) // speed 0-255<br/>motor.stop()<br/>motor.start(speed)<br/>motor.reverse(speed)</pre>
<p>Hopefully, your motor is happily spinning away!</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Troubleshooting your motorized projects</h1>
                
            
            
                
<p>But what if your motor doesn't turn? Here are a few things to check if your motor isn't spinning around:</p>
<ul>
<li>Is the battery pack for the motor hat turned on? Don't laugh, I've spent many a minute wondering why it wasn't working only to discover it lacked power. There's a power light on most motor hats that let you know it has power:</li>
</ul>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-588 image-border" src="img/7e266636-c583-4a97-9b65-6ad94a531823.png" style="width:27.92em;height:21.58em;"/></p>
<p>The power LED on the Adafruit hat is just above the screw terminals for the external power, and lights up red</p>
<ul>
<li>Are your batteries fresh? Motors take up a lot of power, and extended use can wear them down pretty fast.</li>
<li>As I mentioned in the first chapter: check your wiring. Then, check it again.</li>
<li>Make sure all of the wires are securely fastened in the correct screw terminals so that a light yank cannot dislodge them.</li>
<li>Are you using rechargeable batteries? If so, I admire your commitment to reuse, but you're going to want 6 rechargeable running your motor due to differences in voltages between rechargeable and non-rechargeable batteries.</li>
</ul>
<p>Hopefully, if your motor wasn't spinning before, it is now, and we can build our first project.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Project – cat toy</h1>
                
            
            
                
<p>In this project, we'll add a piece of paper to our motor, and then code some randomness to make it spin back and forth at varying speeds (cats get bored with a predictable toy, after all).</p>
<p>The wiring for this project is the same as the motor test; no need to change anything there.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Putting a piece of paper on the motor shaft</h1>
                
            
            
                
<p>Either roll the sticky end of a long sticky note around the motor shaft, or tape a long strip of paper to it. It should look something like this:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-589 image-border" src="img/876ec6d9-4a0e-4737-baea-3d53eaafcfa9.png" style="width:23.17em;height:30.83em;"/></p>
<p>After the relatively simple construction of our toy, let's code some randomness!</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Coding the randomness to start/stop the motor</h1>
                
            
            
                
<p>We want the motor to start at a random speed for anywhere from 1-10 seconds, then stop for 1-10 seconds, and repeat. We also want whether it goes forward or backward to be random. I limited the speed to 75—anything faster was too much for my cats!</p>
<p>In your <kbd>cat-toy.js</kbd> file, get rid of the <kbd>board.repl.inject</kbd> statement and add the following:</p>
<div><pre>startMovement()<br/><br/>function startMovement(){<br/>  let direction = Math.round(Math.random())<br/>  let speed = Math.round(Math.random() * 75)<br/>  let time = Math.round(Math.random() * 10)<br/><br/>  if(direction == 0){<br/>    motor.forward(speed)<br/>  } else {<br/>    motor.reverse(speed)<br/>  }<br/><br/>  setTimeout(stopMovement, time*1000) <br/>}<br/><br/>function stopMovement(){<br/>  let time = Math.round(Math.random() * 10)<br/>  motor.stop()<br/>  setTimeout(startMovement, time * 1000)<br/>}</pre></div>
<p>This will randomize the starting and stopping, the speed, and the direction. My cats were at least mildly entertained by it. If you have cats, give it a try!</p>
<p>Load the project onto the Pi, and navigate to the folder in the Pi SSH session. Then, run: </p>
<pre><strong>sudo node cat-toy.js</strong></pre>
<p>And watch it go!</p>
<p>We've got one motor going, but if you want to build a bot with wheels, we're gonna need two motors; let's take a look at that concept with our next project.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Project – using two gearbox motors and the motors object</h1>
                
            
            
                
<p>Now that we've explored the motor object, let's dig a little deeper and build a project using two TT motors while exploring the motors object.</p>
<p class="mce-root"/>
<p>If you want to take this a step further, you can get yourself a chassis like this one from Adafruit <a href="https://www.adafruit.com/product/3796">https://www.adafruit.com/product/3796</a> and a pair of wheels like these from Adafruit <a href="https://www.adafruit.com/product/3757">https://www.adafruit.com/product/3757</a> and build yourself a moving 2-wheel robot! Just remember you'll have to either power the Pi with a battery pack (those little USB packs for charging your phone work great) or stay within range of your Pi's power cord. If you go with the latter, I'd secure the power jack into the Pi and be very careful not to let the bot pull too hard on anything. Honestly, I'd really just recommend using a battery if you're going to let your Pi move about on its own.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Wiring up your TT motors</h1>
                
            
            
                
<p>For this diagram, pretend the normal DC motors are our TT motors—yellow will be the ground (usually black) wire, and the green will be the power (normally red) wire.</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-446 image-border" src="img/59a9dcca-4ac8-4a45-a754-0c0e61107275.png" style="width:144.67em;height:99.25em;"/></p>
<p class="mce-root"/>
<p>Now it's time to get started coding our motors to perform common wheeled-vehicle movements using Johnny-Five and the motors object.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">The motors Johnny-Five object</h1>
                
            
            
                
<p>Create a new file in your project folder called <kbd>driver-bot.js</kbd>. Start with the usual setup of the Johnny-Five and Raspi-IO libraries, your board object, and your <kbd>board.on('ready')</kbd> handler:</p>
<pre>const Raspi = require('raspi-io')<br/>const five = require('johnny-five')<br/>const board = new five.Board({<br/>  io: new Raspi()<br/>})<br/><br/>board.on('ready', () =&gt; {<br/><br/>})</pre>
<p>Next, inside the <kbd>board.on('ready')</kbd> handler, we'll add the constructors for our two TT motors:</p>
<p>If you are using the Adafruit hat, your constructors are:</p>
<pre>let leftMotor = new five.Motor(five.Motor.SHIELD_CONFIGS.ADAFRUIT_V2.M1)<br/>let rightMotor = new five.Motor(five.Motor.SHIELD_CONFIGS.ADAFRUIT_V2.M2)</pre>
<p>And if you're using the L293D hat, your constructors are:</p>
<pre>let leftMotor = new five.Motor(five.Motor.SHIELD_CONFIGS.ADAFRUIT_V1.M1)<br/>let rightMotor = new five.Motor(five.Motor.SHIELD_CONFIGS.ADAFRUIT_V1.M2)</pre>
<p>Now that our motors are constructed, we'll create our Motors object by passing it an array containing <kbd>leftMotor</kbd> and <kbd>rightMotor</kbd>:</p>
<pre>let motors = new Five.Motors([leftMotor, rightMotor])</pre>
<p>Before we start writing our driving functions, let's talk a little about the benefits of the Motors object. The main benefit to having your motors in a Motors object is to maintain control over each individual motor while also being able to control them all at once. For example:</p>
<pre>leftMotor.forward(255) // left motor full speed ahead!<br/>rightMotor.reverse(255) // right motor full speed reverse!<br/>motors.stop() // both motors coast to a stop</pre>
<p class="mce-root"/>
<p>The motors object allows you to call any Motor object function and it will perform it on all of the motors at once.</p>
<p>Let's use this knowledge to write some common driving functions that we can use with our motors.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Writing some functions</h1>
                
            
            
                
<p>First things first, we'll want to let our robot go forward. Inside the <kbd>board.on('ready')</kbd> handler of <kbd>driver-bot.js</kbd>, add:</p>
<pre>function goForward(speed) {<br/>  motors.forward(speed)<br/>}</pre>
<p>Here we see again the benefit of the <kbd>motors</kbd> object; we don't have to tell the right and left motor to move forward separately.</p>
<p>Let's add another function to let our motors coast to a stop:</p>
<pre>function stop() {<br/>  motors.stop()<br/>}</pre>
<p>And another to let our robot go backward:</p>
<pre>function goBackward(speed) {<br/>  motors.reverse(speed)<br/>}</pre>
<p>Now that those are done, how about we add some turns? Luckily, the <kbd>motors</kbd> object still lets us control each motor individually—so turns are no problem:</p>
<pre>function turnRight(speed) {<br/>  leftMotor.forward(speed)<br/>  rightMotor.stop()<br/>}<br/><br/>function turnLeft(speed) {<br/>  rightMotor.forward(speed)<br/>  leftMotor.stop()<br/>}</pre>
<p class="mce-root"/>
<p>Finally, let's add the ability to spin left or right in place:</p>
<pre>function spinRight(speed) {<br/>  leftMotor.forward(speed)<br/>  rightMotor.reverse(speed)<br/>}<br/><br/>function spinLeft(speed) {<br/>  rightMotor.forward(speed)<br/>  leftMotor.reverse(speed)<br/>}</pre>
<p>Now, our motors have everything they need to drive around! Let's give ourselves REPL access to these methods, the <kbd>motors</kbd> object, and the <kbd>motor</kbd> objects:</p>
<pre>board.repl.inject({<br/> leftMotor,<br/> rightMotor,<br/> motors,<br/> goForward,<br/> goBackward,<br/> stop,<br/> turnRight,<br/> turnLeft,<br/> spinRight,<br/> spinLeft<br/>})</pre>
<p>And now we're ready to load up our code and take our motors for a spin (both metaphorically and literally)!</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Running our motors project</h1>
                
            
            
                
<p>Load the project onto the Pi, and navigate to the folder in the Pi SSH session. Then, run: </p>
<pre><strong>sudo node driver-bot.js</strong></pre>
<p>Once you see <em>Board Initialized</em>, feel free to try out our new functions:</p>
<pre>goForward(100) // start moving both motors forward<br/>stop() // and stop<br/>goBackward(50) // go backward at half the previous speed<br/>stop()<br/>goForward(100)<br/>turnRight(100)<br/>turnLeft(200) // a faster left turn<br/>spinRight(255) // robots can't get dizzy, maximum fastness<br/>spinLeft(100)<br/>stop()</pre>
<p>And that's it—you've written all the code you need to drive a two-wheeled robot!</p>
<p>As a bonus project, think of a way you could drive the bot without having to type out the function names each time!</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Summary</h1>
                
            
            
                
<p>In this chapter, we learned about the first component that adds movement to our bots: the motor. We learned about the types of motors, and how to interface one with a microcontroller. Then, we wrote code to test our motor with the Pi hat and the REPL, and we built a small randomized cat toy using our knowledge of the Johnny-Five Motor object. Finally, we built a project that allowed us to explore hands-on the abilities of the Motors object and write code to drive a two-wheeled robot.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Questions</h1>
                
            
            
                
<ol>
<li>What is a motor?</li>
<li>What's the difference between a motor and a stepper motor?</li>
<li>Why should you use external power for motors?</li>
<li>Why do we need a hat to control our motor?</li>
<li>What are the benefits of the Motors object when using multiple motors?</li>
</ol>


            

            
        
    </body></html>