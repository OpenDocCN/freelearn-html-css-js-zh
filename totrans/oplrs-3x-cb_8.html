<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Beyond the Basics"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Beyond the Basics</h1></div></div></div><p>In this chapter we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Working with projections</li><li class="listitem" style="list-style-type: disc">Requesting remote data with<code class="literal"> OpenLayers.Request</code></li><li class="listitem" style="list-style-type: disc">Creating a custom control</li><li class="listitem" style="list-style-type: disc">Creating a custom renderer</li><li class="listitem" style="list-style-type: disc">Selecting features intersecting with a line</li><li class="listitem" style="list-style-type: disc">Making an animation with image layers</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec01"/>Introduction</h1></div></div></div><p>OpenLayers is a big and complex framework. There is no other option available for a framework that allows working with many GIS standards, reading from many different data sources, rendering on different browser technologies, and so on. This power comes with a price.<a class="indexterm" id="id346"/>
</p><p>The implementation of OpenLayers tries to have as less dependencies on external libraries as possible. This means, OpenLayers requires implementing many features that we can find in other projects: DOM elements' manipulation, AJAX requests, and so on.</p><p>This chapter shows some of these features, in addition to other possible common needs we can require in our day-to-day work that are not explained in other chapters, such as creation of layer animations or the implementation of custom controls. Because of this, the chapter is more suited for more experienced JavaScript programmers.</p></div></div>
<div class="section" title="Working with projections"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec02"/>Working with projections</h1></div></div></div><p>In contrast to other JavaScript mapping libraries, OpenLayers allows working with a great number of projections.<a class="indexterm" id="id347"/>
</p><p>Usually, we specify the desired projection for the map. Later when adding a vector layer to the map, we need to specify to the layer projection so that OpenLayers transforms features from the layer's projection to the map's projection.</p><p>But, by default, OpenLayers has a great limitation on projections: we can only use<span class="strong"><strong> EPSG:4326</strong></span> and<span class="strong"><strong> EPSG:900913</strong></span>. Why? Because transforming between projections is not a simple task and there are other great projects that can make it.</p><p>So, when we want to work with projections other than EPSG:4326 and EPSG:900913, OpenLayers uses<span class="strong"><strong> Proj4js Library</strong></span> (<a class="ulink" href="http://trac.osgeo.org/proj4js">http://trac.osgeo.org/proj4js</a>).<a class="indexterm" id="id348"/>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note61"/>Note</h3><p>Teaching about projections is out of the scope of this book. The EPSG codes are simply a standardized way to classify and identify the great amount of available projections. EPSG:4326 corresponds to the WGS84 (World Geodetic System) and EPSG:900913 is the Spherical Mercator projection popularized by their use in Google Maps.</p></div><p>Let's go to see how we can integrate Proj4js with OpenLayers and how easy it is to make use of it. The idea is to create an application that shows a map and a text area that will show the coordinates of the clicked location:</p><div class="mediaobject"><img alt="Working with projections" src="graphics/7843_08_01.jpg"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec01"/>Getting ready</h2></div></div></div><p>We must place some of the available Proj4js files at our web application directory. To do so, perform the following steps:<a class="indexterm" id="id349"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Go to the Proj4js project's web page and download the distribution ZIP file (for this recipe we have used<a class="ulink" href="http://download.osgeo.org/proj4js/proj4js-1.1.0.zip)"> http://download.osgeo.org/proj4js/proj4js-1.1.0.zip)</a></li><li class="listitem" style="list-style-type: disc">Uncompress the downloaded file and copy the<code class="literal"> proj4js-compressed.js</code> file and<code class="literal"> defs</code> folder within your web application folder</li></ul></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec02"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create an HTML file and add the OpenLayers dependencies. As a dependency, also include the<code class="literal"> Proj4js</code> library:<a class="indexterm" id="id350"/><div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript" src="./js/proj4js-1.1.0/proj4js-compressed.js"&gt;&lt;/script&gt;
</pre></div></li><li class="listitem">Now add the code for the text area and the map:<div class="informalexample"><pre class="programlisting">&lt;textarea id="textarea" name="textarea" data-dojo-type="dijit.form.SimpleTextarea" rows="4" cols="80"&gt;&lt;/textarea&gt;
&lt;br/&gt;&lt;br/&gt;
&lt;div id="ch08_projections" style="width: 100%; height: 85%;"&gt;&lt;/div&gt;
</pre></div></li><li class="listitem">In the JavaScript section, create a new control to manage the click event:<div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript"&gt;
    // Create the click control
    OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {    
    
        defaultHandlerOptions: {
            'single': true,
            'double': false,
            'pixelTolerance': 0,
            'stopSingle': false,
            'stopDouble': false
        },

        initialize: function(options) {
            this.handlerOptions = OpenLayers.Util.extend({}, this.defaultHandlerOptions);
            OpenLayers.Control.prototype.initialize.apply(this, arguments); 
            this.handler = new OpenLayers.Handler.Click(
            this, {
                'click': this.trigger
            }, 
            this.handlerOptions);
        }, 
</pre></div></li><li class="listitem">On the<code class="literal"> trigger</code> function, add the following code to transform and show the coordinates in the<code class="literal"> textarea</code> object:<a class="indexterm" id="id351"/><div class="informalexample"><pre class="programlisting">        trigger: function(e) {
            var lonlatS = map.getLonLatFromViewPortPx(e.xy);
            var lonlatT1 = lonlatS.clone().transform( map.getProjectionObject(), new OpenLayers.Projection("EPSG:41001") );
            var lonlatT2 = lonlatS.clone().transform( map.getProjectionObject(), new OpenLayers.Projection("EPSG:4326") );
            
            var message = "Click at: \n"+
                "Lon: " + lonlatS.lon + " , Lat: "+lonlatS.lat + " ("+map.getProjection()+")\n" +
                "Lon: " + lonlatT2.lon + " , Lat: "+lonlatT2.lat + " (EPSG:4326) \n" +
                "Lon: " + lonlatT1.lon + " , Lat: "+lonlatT1.lat + " (EPSG:41001) \n";
            
            dijit.byId("textarea").set('value', message);
        },
    
        CLASS_NAME: "OpenLayers.Control.Click"
    });
</pre></div></li><li class="listitem">Create the map instance, add a base layer, and center the viewport:<div class="informalexample"><pre class="programlisting">    var map = new OpenLayers.Map("ch08_projections");
    var osm = new OpenLayers.Layer.OSM();
    map.addLayer(osm);
    map.setCenter(new OpenLayers.LonLat(0,0), 2);
</pre></div></li><li class="listitem">Finally, create a new click control instance and add it to the map:<div class="informalexample"><pre class="programlisting">    var click = new OpenLayers.Control.Click();
    map.addControl(click);
    click.activate();
&lt;/script&gt;
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec03"/>How it works...</h3></div></div></div><p>OpenLayers makes use of the Proj4js code internally when available. So as OpenLayers developers we do not need to use the Proj4js API directly, the only requirement is to add the Proj4js dependency in our application:<a class="indexterm" id="id352"/>
</p><div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript" src="./js/proj4js-1.1.0/proj4js-compressed.js"&gt;&lt;/script&gt;
</pre></div><p>When the user clicks at some place on the map, the click control (that we will see later) executes the<code class="literal"> trigger</code> function. The<code class="literal"> e</code> variable contains all the click event's information that includes the pixel's xy position.</p><div class="informalexample"><pre class="programlisting">        trigger: function(e) {
            var lonlatS = map.getLonLatFromViewPortPx(e.xy);
            var lonlatT1 = lonlatS.clone().transform( map.getProjectionObject(), new OpenLayers.Projection("EPSG:41001") );
            var lonlatT2 = lonlatS.clone().transform( map.getProjectionObject(), new OpenLayers.Projection("EPSG:4326") );
            ...
            ...
</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note62"/>Note</h3><p>Ensure that the projection definition you are using, is defined within the<code class="literal"> defs</code> folder. Otherwise you will need to create a new file with the transformation expressed in the proj4 notation.</p></div><p>Given an<code class="literal"> OpenLayers.LonLat</code> instance, we can translate among projections using the<code class="literal"> tranform()</code> method.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note63"/>Note</h3><p>We always can make use of the<code class="literal"> transform()</code> method but without including the Proj4js dependencies, they will only translate between EPSG:4326 and EPSG:900913.</p></div><p>Thanks to the<code class="literal"> OpenLayers.Map.getLonLatFromViewPortPx()</code> method we can go from<code class="literal"> OpenLayers.Pixel</code> to the<code class="literal"> OpenLayers.LonLat</code> instance.</p><p>Because the transform method modifies the current instance, we create a new one using the<code class="literal"> clone()</code> method to avoid modifying the source variable.</p><p>At this point, the<code class="literal"> trigger</code> method can construct a message string and place it within the text area.</p><p>Finally, let's briefly describe the click control used in the recipe.</p><p>The first step is to define the new control as a subclass of the<code class="literal"> OpenLayers.Control</code> class:<a class="indexterm" id="id353"/>
</p><div class="informalexample"><pre class="programlisting">    OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {
</pre></div><p>The control will use an<code class="literal"> OpenLayers.Handler</code>, so here we will define some options:</p><div class="informalexample"><pre class="programlisting">        defaultHandlerOptions: {
            'single': true,
            'double': false,
            'pixelTolerance': 0,
            'stopSingle': false,
            'stopDouble': false
        },
</pre></div><p>The<code class="literal"> initialize</code> method is responsible to initialize the control instance. First, we create a set of options as a combination (using<code class="literal"> OpenLayers.Util.extend()</code> method) of the previously defined object and options passed by the user as arguments:</p><div class="informalexample"><pre class="programlisting">        initialize: function(options) {
            this.handlerOptions = OpenLayers.Util.extend({}, this.defaultHandlerOptions);
            OpenLayers.Control.prototype.initialize.apply(this, arguments); 
            this.handler = new OpenLayers.Handler.Click(
            this, {
                'click': this.trigger
            }, 
            this.handlerOptions);
        }, 
</pre></div><p>We have initialized an<code class="literal"> OpenLayers.Handler.Click</code> instance to execute the<code class="literal"> trigger</code> listener function every time it detects that the user has pressed the mouse button.</p><p>Finally, as a good practice we set the<code class="literal"> CLASS_NAME</code> attribute with a string identifying our new control class:</p><div class="informalexample"><pre class="programlisting">        CLASS_NAME: "OpenLayers.Control.Click"
    });
</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec04"/>See also</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Playing with the map's options</em></span> recipe in<a class="link" href="ch01.html" title="Chapter 1. Web Mapping Basics"> Chapter 1</a>, <span class="emphasis"><em> Web Mapping Basics</em></span></li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Creating features programmatically</em></span> recipe in<a class="link" href="ch03.html" title="Chapter 3. Working with Vector Layers"> Chapter 3</a>, <span class="emphasis"><em>Working with Vector Layers</em></span><a class="indexterm" id="id354"/></li></ul></div></div></div></div>
<div class="section" title="Retrieving remote data with OpenLayers.Request"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec03"/>Retrieving remote data with OpenLayers.Request</h1></div></div></div><p>Data is the basis for a web mapping application. We can add raster or vector layers to the map, which will load images or vector information.</p><p>In the case of vector layers, thanks to the<code class="literal"> OpenLayers.Protocol</code> and<code class="literal"> OpenLayers.Format</code> subclasses, we can configure the layer to load data from different sources and with different formats.</p><p>Anyway, there can be circumstances where we need to request data by ourselves, read the specific format, and add features. We are talking about making asynchronous JavaScript calls.<a class="indexterm" id="id355"/>
</p><p>This recipe shows how we can use the helper class<code class="literal"> OpenLayers.Request</code> to asynchronously request data from the remote servers.</p><p>Here, we are going to request a URL that returns random x and y values that we will process as point features on the map.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note64"/>Note</h3><p>OpenLayers is a framework for GIS web developers, so it is designed to be independent from other projects, such as jQuery and Dojo that offer facilities to request remote data and implement its own.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec05"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Once created the HTML file with OpenLayers library dependencies, add a<code class="literal"> div</code> element to hold the map:<a class="indexterm" id="id356"/><div class="informalexample"><pre class="programlisting">&lt;div id="ch08_requesting" style="width: 100%; height: 95%;"&gt;&lt;/div&gt;
</pre></div></li><li class="listitem">In the JavaScript section, create the map instance, add a base layer, and center the viewport:<div class="informalexample"><pre class="programlisting">    var map = new OpenLayers.Map("ch08_requesting");
    var osm = new OpenLayers.Layer.OSM();
    map.addLayer(osm);
    
    // Certer viewport
    map.setCenter(new OpenLayers.LonLat(0,0), 2);
</pre></div></li><li class="listitem">Create a vector layer and add to the map:<div class="informalexample"><pre class="programlisting">    var vectorLayer = new OpenLayers.Layer.Vector("Points");
    map.addLayer(vectorLayer);
</pre></div></li><li class="listitem">Finally, make a request to the<code class="literal"> points.php</code> utility code, which returns a set of random x and y values:<a class="indexterm" id="id357"/><div class="informalexample"><pre class="programlisting">    OpenLayers.Request.GET({
        url: "utils/points.php",
        params: {
            num: 100
        },
        success: function(response) {
            var format = new OpenLayers.Format.JSON();
            
            var points = format.read(response.responseText);
            for(var i=0; i&lt; points.length; i++) {
                var p = new OpenLayers.Geometry.Point(points[i].x, points[i].y);
                p.transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"));
                
                var f = new OpenLayers.Feature.Vector(p);
                vectorLayer.addFeatures([f]);
            }
        },
        failure: function(response) {
            alert("Sorry, there was an error requesting data !!!");
        }
    });
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec06"/>How it works...</h3></div></div></div><p>In JavaScript, the<code class="literal"> XMLHttpRequest</code> object allows us to communicate with the server side.<a class="indexterm" id="id358"/>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note65"/>Note</h3><p>More information about working with<code class="literal"> XMLHttpRequest</code> can be found on<a class="ulink" href="http://acuriousanimal.com/blog/2011/01/27/working-with-the-javascript-xmlhttprequest-object"> http://acuriousanimal.com/blog/2011/01/27/working-with-the-javascript-xmlhttprequest-object</a> and<a class="ulink" href="http://https://developer.mozilla.org/en/AJAX/Getting_Started"> https://developer.mozilla.org/en/AJAX/Getting_Started</a>.</p></div><p>Due to compatibility problems among browsers, OpenLayers uses a cross-browser W3C compliant version of the<code class="literal"> XMLHttpRequest</code> object and wrapping it has implemented the<code class="literal"> OpenLayers.Request</code> class.</p><p>
<code class="literal">OpenLayers.Request</code> class implements the HTTP methods:<code class="literal"> GET, POST, PUT, DELETE, HEAD</code>, and<code class="literal"> OPTIONS</code>, and is used by other OpenLayers classes to get/send data from/to remote servers (such as<code class="literal"> OpenLayers.Protocol.HTTP).</code>
<a class="indexterm" id="id359"/>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note66"/>Note</h3><p>An HTTP introduction can be found at:<a class="ulink" href="http://https://developer.mozilla.org/en/HTTP"> https://developer.mozilla.org/en/HTTP</a>
</p></div><p>In this recipe we have used the<code class="literal"> OpenLayers.Request.GET</code> method with the following parameters:<a class="indexterm" id="id360"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">url:</code> It is the URL we are going to request</li><li class="listitem" style="list-style-type: disc"><code class="literal">params:</code> It is a set of options parameters we can send in the<code class="literal"> GET</code> request</li><li class="listitem" style="list-style-type: disc"><code class="literal">success:</code> It is a callback function to be executed if the URL is successfully requested</li><li class="listitem" style="list-style-type: disc"><code class="literal">failure:</code> It is a callback function to be executed if any problem occurs</li></ul></div><p>In our code, we are requesting the<code class="literal"> utils/points.php</code> passing a<code class="literal"> num</code> parameter, this is the same as requesting the URL<code class="literal"> utils/points.php?num=100:</code>
</p><div class="informalexample"><pre class="programlisting">    OpenLayers.Request.GET({
        url: "utils/points.php",
        params: {
            num: 100
        },
        success: function(response) {
            ...
        },
        failure: function(response) {
            ...
        }
    });
</pre></div><p>If for some reason the request fails, the method<code class="literal"> failure</code> is executed and will show an alert message. On the other hand if the request succeeds we read the returned response and add point features to the map.</p><p>The<code class="literal"> points.php</code> script returns a random number of x and y values, depending on the<code class="literal"> num</code> parameter, encoded as JSON array. The response of the call is nothing more than a text that must be interpreted and we can find it in the<code class="literal"> responseText</code> of the response's property.<a class="indexterm" id="id361"/>
</p><p>To convert the JSON string into a JavaScript object we can use the class<code class="literal"> OpenLayers.Format.JSON:</code>
</p><div class="informalexample"><pre class="programlisting">            var format = new OpenLayers.Format.JSON();            
            var points = format.read(response.responseText);
</pre></div><p>Finally, for each object we read the x and y values and create a point feature:</p><div class="informalexample"><pre class="programlisting">            for(var i=0; i&lt; points.length; i++) {
                var p = new OpenLayers.Geometry.Point(points[i].x, points[i].y);
                p.transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"));
                
                var f = new OpenLayers.Feature.Vector(p);
                vectorLayer.addFeatures([f]);
            }
</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note67"/>Note</h3><p>The x and y values returned by the PHP scripts goes from -180 to180 for x and -80 to 80 for y. Because of this, we translate the coordinates from EPSG:4326 to EPSG:900913, which is the map's base layer projection.</p></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec07"/>There's more...</h3></div></div></div><p>
<code class="literal">OpenLayers.Request</code> is a powerful class allowing working with almost any HTTP method. For example, in addition to the<code class="literal"> GET</code> method we can also use the<code class="literal"> POST</code> method to send data to servers.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note68"/>Note</h3><p>If you are going to work extensively with AJAX in your application, be sure to understand the limitations of<span class="strong"><strong> Cross-Domain Requests (XDR)</strong></span>  and the<span class="strong"><strong> same origin policy</strong></span> (<a class="ulink" href="http://en.wikipedia.org/wiki/Same_origin_policy">http://en.wikipedia.org/wiki/Same_origin_policy</a>).</p></div><p>Finally, take a close look at<code class="literal"> OpenLayers.Request</code> class options. You can find options, such as<code class="literal"> async</code> to specify if the request must be made synchronously or asynchronously,<code class="literal"> user/password</code> to make requests against servers with basic authentication, or<code class="literal"> headers</code> to set the HTTP headers of the request.<a class="indexterm" id="id362"/>
</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec08"/>See also</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Reading features using Protocols directly</em></span> recipe in<a class="link" href="ch03.html" title="Chapter 3. Working with Vector Layers"> Chapter 3</a>, <span class="emphasis"><em> Working with Vector Layers</em></span></li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Reading and creating features from a WKT</em></span> recipe in<a class="link" href="ch03.html" title="Chapter 3. Working with Vector Layers"> Chapter 3</a>, <span class="emphasis"><em> Working with Vector Layers</em></span></li></ul></div></div></div></div>
<div class="section" title="Creating a custom control"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec04"/>Creating a custom control</h1></div></div></div><p>OpenLayers has plenty of controls that address a broad range of needs. Unfortunately, the requirements we could have for building a new web application can imply the creation of a new one, or the extension of a previous one:<a class="indexterm" id="id363"/>
</p><div class="mediaobject"><img alt="Creating a custom control" src="graphics/7843_08_02.jpg"/></div><p>In this recipe, we are going to create a new control named<span class="strong"><strong> Cross</strong></span>. The control will show a crosshair symbol, as shown in the previous screenshot, similar to the target selectors in the ancient war planes, which will show the location it is pointing to. In addition, the control will allow registering the click events that will return the current location too.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec09"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create an HTML file and add the OpenLayers dependencies, then include the code of our new control:<a class="indexterm" id="id364"/><div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript" src="./recipes/ch08/crossControl.js"&gt;&lt;/script&gt;
</pre></div></li><li class="listitem">Next, add the two CSS classes required for the control:<div class="informalexample"><pre class="programlisting">&lt;style&gt;
    .olControlCross {
        width: 48px;
        height: 48px;
        background: url('./recipes/data/target.png') no-repeat;
    }
    .olControlCrossText {
        position: relative;
        top: -10px;
        width: 200px;
        color: black;
    }
&lt;/style&gt;
</pre></div></li><li class="listitem">Now, add a<code class="literal"> div</code> element to hold the map:<div class="informalexample"><pre class="programlisting">&lt;div id="ch08_drawing_cross" style="width: 100%; height: 95%;"&gt;&lt;/div&gt;
</pre></div></li><li class="listitem">Within the JavaScript code, create the map instance and add a base layer:<div class="informalexample"><pre class="programlisting">    var map = new OpenLayers.Map("ch08_drawing_cross");
    var layer = new OpenLayers.Layer.WMS( "OpenLayers WMS",
    "http://vmap0.tiles.osgeo.org/wms/vmap0", {layers: 'basic'} );
    map.addLayer(layer);
    
    // Certer viewport
    map.setCenter(new OpenLayers.LonLat(0,0), 2);
</pre></div></li><li class="listitem">Create the cross control, add it to the map, and activate it:<div class="informalexample"><pre class="programlisting">    var crossControl = new OpenLayers.Control.Cross({
        eventListeners: {
            "crossClick": function(event) {
                var lonlat = event.lonlat;
                var message = "Clicked on: " + lonlat.lon + " / " + lonlat.lat;
                alert(message);
            }
        }
    });
    map.addControl(crossControl);
    crossControl.activate();
</pre></div></li><li class="listitem">Now, we are going to describe step by step the source code of the new control we have created. First, create a new<code class="literal"> crossControl.js</code> file and start applying the<span class="emphasis"><em> best</em></span> practice of writing a description about the control:<a class="indexterm" id="id365"/><div class="informalexample"><pre class="programlisting">/** 
 * Class: OpenLayers.Control.Cross 
 * The Cross control renders a cross in the middle of the map. 
 * 
 * Inherits from: 
 *  - &lt;OpenLayers.Control&gt; 
 */ 
</pre></div></li><li class="listitem">Next, create the new<code class="literal"> OpenLayers.Control.Cross</code> class as a subclass of<code class="literal"> OpenLayers.Control:</code><div class="informalexample"><pre class="programlisting">OpenLayers.Control.Cross = OpenLayers.Class(OpenLayers.Control, {
</pre></div></li><li class="listitem">Define the set of attributes and methods of the new control. The first step is to initialize an array with the set of events our control can emit:<div class="informalexample"><pre class="programlisting">    /** 
     * crossClick event is triggered when the cross is clicked by the mouse. 
     */ 
    EVENT_TYPES: ["crossClick"], 
</pre></div></li><li class="listitem">Next, there is a<code class="literal"> size</code> property, that is used to know the image control size and required to compute the exact control location:<div class="informalexample"><pre class="programlisting">    /** 
     * Parameter: size 
     * {OpenLayers.Size} with the desired dimension for the image 
     */ 
    size: null, 
</pre></div></li><li class="listitem">The last attribute is used to store a reference to the DOM element used as a label to show the current control target's location:<div class="informalexample"><pre class="programlisting">    /** 
     * Parameter: element 
     * {DOMElement} for the label shown by the control 
     */ 
    element: null, 
</pre></div></li><li class="listitem">Once we have defined all the required properties used in the class, we need to initialize the control. Again, it is a good practice to comment in the source code following the OpenLayers conventions:<a class="indexterm" id="id366"/><div class="informalexample"><pre class="programlisting">    /** 
     * Constructor: OpenLayers.Control.Cross 
     * Draw a cross in the middle of the map. 
     * 
     * Parameters: 
     * options - {Object} An optional object whose properties will be used 
     *     to extend the control. 
     */ 
    initialize: function(options) { 
        // Concatenate events specific to measure with those from the base 
        this.EVENT_TYPES = 
        OpenLayers.Control.Cross.prototype.EVENT_TYPES.concat( 
            OpenLayers.Control.prototype.EVENT_TYPES); 
            
        if(!options) { 
            options = {}; 
        }        
        if(!options.size) { 
            options.size = new OpenLayers.Size(48, 48); 
        } 
        OpenLayers.Control.prototype.initialize.apply(this, [options]); 
    }, 
</pre></div></li><li class="listitem">Next, we need to implement the<code class="literal"> draw</code> method, which is called when the control is ready to be displayed on the page and is responsible to set the required DOM elements to render the control. The first step involves computing the right position for the control, which is the middle of the map:<div class="informalexample"><pre class="programlisting">    /** 
     * Method: draw 
     * 
     * Returns: 
     * {DOMElement} 
     */    
    draw: function() { 
        
        // Compute center position 
        var position = new OpenLayers.Pixel( 
            (this.map.div.offsetWidth - this.size.w) / 2, 
            (this.map.div.offsetHeight - this.size.h) / 2 
            ); 
</pre></div></li><li class="listitem">Then, we can call the<code class="literal"> draw</code> method of the superclass to draw the control. This will initialize the<code class="literal"> this.div</code> property (inherited from<code class="literal"> OpenLayers.Control)</code> with the DOM element that will hold the control. By default a CSS class<code class="literal"> olControlCross</code> is added to the<code class="literal"> div</code> element, so we can style it easily:<a class="indexterm" id="id367"/><div class="informalexample"><pre class="programlisting">        OpenLayers.Control.prototype.draw.apply(this, [position]); 
</pre></div></li><li class="listitem">After this, we can create a new<code class="literal"> div</code> element for the label that will show the current target's location. This is done by using the method<code class="literal"> OpenLayers.Util.createDiv</code>. In addition, thanks to the<code class="literal"> OpenLayers.Element.addClass</code> method, we set the CSS class<code class="literal"> olControlCrossText</code> to the label so the user can style the label:<div class="informalexample"><pre class="programlisting">        // Create location label element 
        this.element = OpenLayers.Util.createDiv(null); 
        OpenLayers.Element.addClass(this.element, "olControlCrossText"); 
</pre></div></li><li class="listitem">Compute the current<code class="literal"> OpenLayers.LonLat</code> position and set the label text. We omit the code for the<code class="literal"> computeLonLat</code> function that can be found within the control class:<div class="informalexample"><pre class="programlisting">        var lonlat = this.computeLonLat();(); 
        this.element.innerHTML = lonlat.lon + " / " + lonlat.lat; 
</pre></div></li><li class="listitem">Add the label element to the main control element:<div class="informalexample"><pre class="programlisting">        this.div.appendChild(this.element);
</pre></div></li><li class="listitem">As a final step, we register two listeners. First, a listener for the<code class="literal"> this.div</code> element to detect when the mouse clicks the control:<div class="informalexample"><pre class="programlisting">        // Listen for event in the control's div 
        OpenLayers.Event.observe(this.div, 'click', OpenLayers.Function.bind(this.onClick, this));
</pre></div></li><li class="listitem">Second, a listener for the map's<code class="literal"> move</code> event, so we can update the control's location label:<div class="informalexample"><pre class="programlisting">        // Register event for map's move event. 
        this.map.events.register("move", this, this.onMove); 
</pre></div></li><li class="listitem">And finally, return a reference to the<code class="literal"> this.div</code> element:<a class="indexterm" id="id368"/><div class="informalexample"><pre class="programlisting">        return this.div; 
    }, 
</pre></div></li><li class="listitem">Next is the code for two listeners. The<code class="literal"> onMove</code> method updates the label's text (target's location) each time the map is moved:<div class="informalexample"><pre class="programlisting">    /** 
     * Updates the location text. 
     */ 
    onMove: function (event) { 
        var lonlat = this.computeLonLat(); 
        this.element.innerHTML = lonlat.lon + " / " + lonlat.lat; 
    }, 
</pre></div></li><li class="listitem">The<code class="literal"> onClick</code> function is executed when there is a mouse click on the control. Its responsibility is to trigger the<code class="literal"> crossClick</code> event so that any outside listener can by notified:<div class="informalexample"><pre class="programlisting">    /** 
     * Fires a crossClick event. 
     */ 
    onClick: function (event) { 
        var lonlat = this.computeLonLat(); 
        this.events.triggerEvent("crossClick", { 
            lonlat: lonlat 
        }); 
    }, 
</pre></div></li><li class="listitem">This is the code for the helper function that computes the<code class="literal"> OpenLayers.LonLat</code> from the current control's pixel position:<div class="informalexample"><pre class="programlisting">    /** 
     * Computes the control location. 
     * 
     * Returns: 
     * {&lt;OpenLayers.LonLat&gt;} 
     */ 
    computeLonLat: function() { 
        var pixel = this.position.clone(); 
        pixel.x += this.size.w/2; 
        pixel.y += this.size.h/2; 
        return this.map.getLonLatFromPixel(pixel); 
    }, 
</pre></div></li><li class="listitem">Last, but not the least, we have to set the property<code class="literal"> CLASS_NAME</code> with a string identifying the control name. By convention, it is the whole namespace of the control:<a class="indexterm" id="id369"/><div class="informalexample"><pre class="programlisting">    CLASS_NAME: "OpenLayers.Control.Cross" 
}); 
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec10"/>How it works...</h3></div></div></div><p>The program does not have much mystery, in addition to the base layer we have created a cross control:<a class="indexterm" id="id370"/>
</p><div class="informalexample"><pre class="programlisting">    var crossControl = new OpenLayers.Control.Cross({
        eventListeners: {
            "crossClick": function(event) {
                var lonlat = event.lonlat;
                var message = "Clicked on: " + lonlat.lon + " / " + lonlat.lat;
                alert(message);
            }
        }
    });
</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note69"/>Note</h3><p>We have initialized the cross control by registering a listener function on the<code class="literal"> crossClick</code> event, which is triggered each time there is a mouse click on the cross image.</p></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec11"/>There's more...</h3></div></div></div><p>Note how we can create the new control class:</p><div class="informalexample"><pre class="programlisting">OpenLayers.Control.Cross = OpenLayers.Class(OpenLayers.Control, { 
    ...
});
</pre></div><p>New classes or subclasses are easily created with<code class="literal"> OpenLayers.Class</code>. It requires two parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<span class="strong"><strong> source</strong></span> class</li><li class="listitem" style="list-style-type: disc">An<span class="strong"><strong> object</strong></span> with the class definition that will extend the source class</li></ul></div><p>In our code, we are extending the<code class="literal"> OpenLayers.Control</code> class with the properties and functions defined in the second parameter defined in the object literal notation.</p><p>In addition, any class must be initialized using the<code class="literal"> initialize</code> method. The usual order of actions to be done is:<a class="indexterm" id="id371"/>
</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Merge the array of<code class="literal"> EVENT_TYPES</code> controls with those defined in the base<code class="literal"> OpenLayers.Control</code> class. This means we are extending the base event types with the set defined in the new cross control:<div class="informalexample"><pre class="programlisting">    initialize: function(options) { 
        // Concatenate events specific to measure with those from the base 
        this.EVENT_TYPES = 
        OpenLayers.Control.Cross.prototype.EVENT_TYPES.concat( 
            OpenLayers.Control.prototype.EVENT_TYPES);
</pre></div></li><li class="listitem">Set a default value for the instance properties if they are not defined in the constructor:<div class="informalexample"><pre class="programlisting">        if(!options) { 
            options = {}; 
        }        
        if(!options.size) { 
            options.size = new OpenLayers.Size(48, 48); 
        } 
</pre></div></li><li class="listitem">Call the superclass constructor. Once we have the subclass initialized, we need to initialize the superclass. This is a bottom-top initialization:<div class="informalexample"><pre class="programlisting">        OpenLayers.Control.prototype.initialize.apply(this, [options]); 
    }, 
</pre></div></li></ol></div><div class="section" title="See also"><div class="titlepage"><div><div><h4 class="title"><a id="ch08lvl2sec12"/>See also</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Adding and removing controls</em></span> recipe in<a class="link" href="ch05.html" title="Chapter 5. Adding Controls"> Chapter 5</a>, <span class="emphasis"><em> Adding Controls</em></span></li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Listening for non OpenLayers events</em></span> recipe in<a class="link" href="ch04.html" title="Chapter 4. Working with Events"> Chapter 4</a>, <span class="emphasis"><em> Working with Events</em></span></li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Adding the WMS layer</em></span> recipe in<a class="link" href="ch02.html" title="Chapter 2. Adding Raster Layers"> Chapter 2</a>, <span class="emphasis"><em> Adding Raster Layers</em></span></li></ul></div></div></div></div></div>
<div class="section" title="Creating a custom renderer"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec05"/>Creating a custom renderer</h1></div></div></div><p>When working with vector layers, styling is a great feature which offers us a lot of possibilities: fill color and opacity, stroke color, labels and text colors, and so on. But, what if we need more?<a class="indexterm" id="id372"/>
</p><p>Every<code class="literal"> OpenLayers.Layer.Vector</code> instance contains a renderer that is responsible to render the layer's features (such as points, paths, and polygons) on the map using the best technologies available in the browser. These can be the HTML5 Canvas element (<a class="ulink" href="http://en.wikipedia.org/wiki/Canvas_element">http://en.wikipedia.org/wiki/Canvas_element</a>) available in many modern browsers (such as Firefox or Chrome), SVG (<a class="ulink" href="http://en.wikipedia.org/wiki/Scalable_Vector_Graphics">http://en.wikipedia.org/wiki/Scalable_Vector_Graphics</a>), or VML (<a class="ulink" href="http://en.wikipedia.org/wiki/Vector_Markup_Language">http://en.wikipedia.org/wiki/Vector_Markup_Language</a>).</p><p>When<code class="literal"> OpenLayers.Layer.Vector</code> is initialized, OpenLayers looks for the best available rendering engine and creates an instance of<code class="literal"> OpenLayers.Renderer</code> that will render the features on the map.</p><p>The goal of this recipe is to show how we can create a new renderer to improve the visualization of the features.</p><div class="mediaobject"><img alt="Creating a custom renderer" src="graphics/7843_08_03.jpg"/></div><p>The previous screenshot shows some styled point geometry features and was rendered using the default OpenLayers renderer.</p><p>The following screenshot shows the same features rendered with our new renderer implementation:</p><div class="mediaobject"><img alt="Creating a custom renderer" src="graphics/7843_08_04.jpg"/></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note70"/>Note</h3><p>We are going to extend<code class="literal"> OpenLayers.Renderer.Canvas</code>, to improve visualizations. This renderer works using the HTML5 Canvas element. This means the new renderer only will work on HTML5 compliant browsers. You can check if the canvas element is supported by your browser at:<a class="ulink" href="http://html5test.com"> http://html5test.com</a>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec13"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Once an HTML file is created with OpenLayers dependencies, the first step is to include the file with the new renderer class' implementation:<a class="indexterm" id="id373"/><div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript" src="./recipes/ch08/gradientRenderer.js"&gt;&lt;/script&gt;
</pre></div></li><li class="listitem">Now, as usual you can add the<code class="literal"> div</code> element that will hold the map:<div class="informalexample"><pre class="programlisting">&lt;div id="ch08_renderer" style="width: 100%; height: 95%;"&gt;&lt;/div&gt;
</pre></div></li><li class="listitem">In the JavaScript section, add the following code to initialize the map and add a base layer:<div class="informalexample"><pre class="programlisting">    var map = new OpenLayers.Map("ch08_renderer");    
    var osm = new OpenLayers.Layer.OSM();
    map.addLayer(osm);
</pre></div></li><li class="listitem">Center the map's viewport:<a class="indexterm" id="id374"/><div class="informalexample"><pre class="programlisting">    var center = new OpenLayers.LonLat(-80,40);
    center.transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"));
    map.setCenter(center, 5);
</pre></div></li><li class="listitem">Create a<code class="literal"> StyleMap</code> instance with a<span class="strong"><strong> unique value rule</strong></span> based on the<code class="literal"> POP_RANK</code> attribute of the features:<div class="informalexample"><pre class="programlisting">    var styles = {
        7: { pointRadius: 5, label: "${POP_RANK}", fillColor: "#FFF8DC", fillOpacity: 0.6},
        6: { pointRadius: 8, label: "${POP_RANK}", fillColor: "#FFE4C4", fillOpacity: 0.6},
        5: { pointRadius: 11, label: "${POP_RANK}", fillColor: "#DEB887", fillOpacity: 0.6},
        4: { pointRadius: 14, label: "${POP_RANK}", fillColor: "#DAA520", fillOpacity: 0.7},
        3: { pointRadius: 16, label: "${POP_RANK}", fillColor: "#CD853F", fillOpacity: 0.8},
        2: { pointRadius: 19, label: "${POP_RANK}", fillColor: "#A0522D", fillOpacity: 0.9},
        1: { pointRadius: 22, label: "${POP_RANK}", fillColor: "#B22222", fillOpacity: 1.0}
    };

    var styleMap = new OpenLayers.StyleMap();
    styleMap.addUniqueValueRules("default", "POP_RANK", styles);
</pre></div></li><li class="listitem">Create the vector layer and add it to the map:<div class="informalexample"><pre class="programlisting">    var vectorLayer = new OpenLayers.Layer.Vector("Cities", {
        styleMap: styleMap,
        renderers: ["Gradient"],
        protocol: new OpenLayers.Protocol.HTTP({
            url: "http://localhost:8080/openlayers-cookbook/recipes/data/world_cities.json",
            format: new OpenLayers.Format.GeoJSON()
        }),
        strategies: [new OpenLayers.Strategy.Fixed()]
    });
    map.addLayer(vectorLayer);
</pre></div></li><li class="listitem">Let's go to see the<code class="literal"> OpenLayers.Renderer.Gradient</code> implementation that beautifies our point's features that are rendered with a nice gradient style. Start creating a JavaScript file named<code class="literal"> gradientRenderer.js</code>, which we have included previously in the main program. Following good practices, we start the commenting in the file:<a class="indexterm" id="id375"/><div class="informalexample"><pre class="programlisting">/** 
 * Class: OpenLayers.Renderer.Gradient 
 * Improved canvas based rendered to draw points using gradient. 
 * 
 * Inherits: 
 *  - &lt;OpenLayers.Renderer.Canvas&gt; 
 */ 
</pre></div></li><li class="listitem">Now, create an<code class="literal"> OpenLayers.Renderer.Canvas</code> subclass named<code class="literal"> OpenLayers.Renderer.Gradient:</code><div class="informalexample"><pre class="programlisting">OpenLayers.Renderer.Gradient = OpenLayers.Class(OpenLayers.Renderer.Canvas, {
</pre></div></li><li class="listitem">The first method to implement in a new OpenLayers class must be the<code class="literal"> initialize()</code> method:<div class="informalexample"><pre class="programlisting">    /** 
     * Constructor: OpenLayers.Renderer.Gradient 
     * 
     * Parameters: 
     * containerID - {&lt;String&gt;} 
     * options - {Object} Optional properties to be set on the renderer. 
     */ 
    initialize: function(containerID, options) { 
        OpenLayers.Renderer.Canvas.prototype.initialize.apply(this, arguments); 
    }, 
</pre></div></li><li class="listitem">Next, we implement the<code class="literal"> drawPoint()</code> method, inherited from the<code class="literal"> OpenLayers.Renderer.Canvas</code> class, which is responsible to render the point geometry features of the layer. Now, the method receives three parameters: the geometry object, the style to apply, and the feature identifier attribute:<a class="indexterm" id="id376"/><div class="informalexample"><pre class="programlisting">    /** 
     * Method: drawPoint 
     * This method is only called by the renderer itself. 
     * 
     * Parameters: 
     * geometry - {&lt;OpenLayers.Geometry&gt;} 
     * style    - {Object} 
     * featureId - {String} 
     */ 
    drawPoint: function(geometry, style, featureId) { 
</pre></div></li><li class="listitem">From the<code class="literal"> geometry</code> parameter, compute the exact pixel position of the point. This can be done with the<code class="literal"> getLocalXY()</code> method inherited from the<code class="literal"> OpenLayers.Renderer.Canvas</code> class:<div class="informalexample"><pre class="programlisting">        var pt = this.getLocalXY(geometry); 
        var p0 = pt[0]; 
        var p1 = pt[1]; 
        
        if(!isNaN(p0) &amp;&amp; !isNaN(p1)) {  
            if(style.fill !== false) { 
                this.setCanvasStyle("fill", style); 
</pre></div></li><li class="listitem">Using the<code class="literal"> fillColor</code> and<code class="literal"> fillOpacity</code> properties create a string for the color to be applied for the gradient:<div class="informalexample"><pre class="programlisting">                // Create color from fillColor and fillOpacity properties. 
                var color = style.fillColor; 
                color += "ff"; 
                color = color.replace("#", "0x"); 
             
                var colorRGBA = 'rgba(' + 
                ((color &gt;&gt; 24) &amp; 0xFF) + ',' + 
                ((color &gt;&gt; 16) &amp; 0xFF) + ',' + 
                ((color &gt;&gt;  8) &amp; 0xFF) + ',' + 
                style.fillOpacity + ')'; 
</pre></div></li><li class="listitem">Then create a canvas gradient, centered in the feature's location and with the radius value specified in the feature's style:<div class="informalexample"><pre class="programlisting">                var gradient = this.canvas.createRadialGradient(p0, p1, 0, p0, p1, style.pointRadius); 
</pre></div></li><li class="listitem">Define the necessary steps so that the gradient goes from white to the previously created RGB color:<a class="indexterm" id="id377"/><div class="informalexample"><pre class="programlisting">                gradient.addColorStop(0, '#FFFFFF'); 
                gradient.addColorStop(0.9, colorRGBA); 
                gradient.addColorStop(1, 'rgba(1,255,0,0)'); 
            
                this.canvas.fillStyle = gradient;            
                this.canvas.fillRect(0, 0, this.root.width, this.root.height); 

                this.canvas.fill(); 
            } 
        } 
    }, 
</pre></div></li><li class="listitem">Finally, identify the new class by setting the<code class="literal"> CLASS_NAME</code> property:<div class="informalexample"><pre class="programlisting">    CLASS_NAME: "OpenLayers.Renderer.Gradient " 
});
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec14"/>How it works...</h3></div></div></div><p>The important point of this recipe resides in one of the properties we have specified for the vector layer, the<code class="literal"> renderers.</code>
<a class="indexterm" id="id378"/>
</p><p>The<code class="literal"> renderers</code> property allows us to specify the set of<code class="literal"> OpenLayers.Renderer</code> that the layer can make use of. Usually this property is never used and by default, its value is:<code class="literal"> renderers: ['SVG', 'VML', 'Canvas']</code>. This means the supported renderer instances the layer can use are<code class="literal"> OpenLayers.Renderer.SVG, OpenLayers.Renderer.VML</code>, and<code class="literal"> OpenLayers.Renderer.Canvas</code>.</p><p>For this recipe, we have created the class<code class="literal"> OpenLayers.Renderer.Gradient</code>, which we will describe later. The setting<code class="literal"> renderers: ["Gradient"]</code> means we only want to allow the layer to work with an<code class="literal"> OpenLayers.Renderer.Gradient</code> instance.</p><p>Let's describe in more detail how to initialize the vector layer:</p><div class="informalexample"><pre class="programlisting">  var vectorLayer = new OpenLayers.Layer.Vector("Cities", {
        styleMap: styleMap,
        renderers: ["Gradient"],
        protocol: new OpenLayers.Protocol.HTTP({
            url: "http://localhost:8080/openlayers-cookbook/recipes/data/world_cities.json",
            format: new OpenLayers.Format.GeoJSON()
        }),
        strategies: [new OpenLayers.Strategy.Fixed()]
    });
</pre></div><p>In addition to the renderers, we have used an<code class="literal"> OpenLayers.Protocol.HTTP</code> instance with an<code class="literal"> OpenLayers.Format.GeoJSON</code> instance, to load a GeoJSON file with some cities around the world. The features within the file have, among others, the<code class="literal"> POP_RANK</code> attribute.<a class="indexterm" id="id379"/>
</p><p>Thanks to the<code class="literal"> OpenLayers.Strategy.Fixed</code> strategy instance, the layer loads the data source, through the previous protocol, only once. We have no need to load the file each time the map is zoomed.</p><p>Last, but not the least, we have set the<code class="literal"> styleMap</code> property to a previously created<code class="literal"> OpenLayers.StyleMap</code> instance:</p><div class="informalexample"><pre class="programlisting">    var styleMap = new OpenLayers.StyleMap();
    styleMap.addUniqueValueRules("default", "POP_RANK", styles);
</pre></div><p>This style map is defined making use of the unique value rule feature based on the<code class="literal"> POP_RANK</code> attribute. This property takes values from<code class="literal"> 1</code> to<code class="literal"> 7</code>, so we define a symbolizer hash style for each possible value, playing with the radius and fill color properties:</p><div class="informalexample"><pre class="programlisting">    var styles = {
        7: { pointRadius: 5, label: "${POP_RANK}", fillColor: "#FFF8DC", fillOpacity: 0.6},
        6: { pointRadius: 8, label: "${POP_RANK}", fillColor: "#FFE4C4", fillOpacity: 0.6},
        5: { pointRadius: 11, label: "${POP_RANK}", fillColor: "#DEB887", fillOpacity: 0.6},
        4: { pointRadius: 14, label: "${POP_RANK}", fillColor: "#DAA520", fillOpacity: 0.7},
        3: { pointRadius: 16, label: "${POP_RANK}", fillColor: "#CD853F", fillOpacity: 0.8},
        2: { pointRadius: 19, label: "${POP_RANK}", fillColor: "#A0522D", fillOpacity: 0.9},
        1: { pointRadius: 22, label: "${POP_RANK}", fillColor: "#B22222", fillOpacity: 1.0}
    };
</pre></div><p>For the main program, there is nothing more to comment, except for the way we have centered the map's viewport.</p><p>Because the base layer is<code class="literal"> OpenStreetMap</code>, which by default uses an EPSG:900913 projection, and we have specified the center in the EPSG:4326 projection, we need to transform the coordinates to the appropriate map's projection.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec15"/>There's more...</h3></div></div></div><p>Usually, this<code class="literal"> initialize</code> method starts calling the<code class="literal"> initialize</code> method of its parent class and then sets the concrete properties of the instance.<a class="indexterm" id="id380"/>
</p><p>In this case, our class has no specific property to initialize, so it is not strictly necessary to implement this method, but as an example, (and as a good practice) we have written the call to the parent class:</p><div class="informalexample"><pre class="programlisting">    initialize: function(containerID, options) {
        OpenLayers.Renderer.Canvas.prototype.initialize.apply(this, arguments); 
    }, 
</pre></div><p>The process followed within the<code class="literal"> OpenLayers.Renderer.Canvas</code> class to render the features of a layer is a bit complex, but can be summarized as:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For each feature the class checks its geometry</li><li class="listitem" style="list-style-type: disc">Depending on the geometry type the class invokes a different method specially designed to render points, lines, or polygons</li></ul></div><p>Because our renderer is implemented to beautify points we only have rewritten the<code class="literal"> drawPoint</code> method, which is responsible to render point geometries.</p><p>The renderer we have defined here uses the HTML5 canvas element, because of this, the main part of the recipe is related to this technology.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note71"/>Note</h3><p>Lots of information about the HTML5 canvas element can be found on the Internet. We want to point to this tutorial from the Mozilla project:<a class="ulink" href="http://https://developer.mozilla.org/en/Canvas_tutorial"> https://developer.mozilla.org/en/Canvas_tutorial</a>.</p></div><p>A great exercise would be to create an SVG version of this renderer. This way, the possibility to render gradient points would be available in more browsers.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec16"/>See also</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Creating a custom control</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Styling features using symbolizers</em></span> recipe in<a class="link" href="ch07.html" title="Chapter 7. Styling Features"> Chapter 7</a>, <span class="emphasis"><em> Styling Features</em></span></li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Defining custom rules to style features</em></span> recipe in<a class="link" href="ch07.html" title="Chapter 7. Styling Features"> Chapter 7</a>, <span class="emphasis"><em> Styling Features</em></span></li></ul></div></div></div></div>
<div class="section" title="Selecting features intersecting with a line"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec06"/>Selecting features intersecting with a line</h1></div></div></div><p>One common action when working with features within a vector layer is its selection and, of course, OpenLayers has some feature selection controls.<a class="indexterm" id="id381"/>
</p><p>The<code class="literal"> OpenLayers.Control.SelectFeature</code> control is specially useful as a selection control because the selection is made on the client side, that is, the selection is made through the features loaded in the browser. There is no request to a WFS server.</p><p>The<code class="literal"> OpenLayers.Control.SelectFeature</code> control can work in different ways. We can select a feature just by clicking on it or we can draw a box to select all the contained features.</p><p>In contrast, it does not allow the possibility to select features that intersect with a path.</p><p>In this recipe, we are going to see how we can extend the<code class="literal"> OpenLayers.Control.SelectFeature</code> control to allow select features for drawing a path.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec17"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create an HTML5 file and add the OpenLayers library dependencies. Now, include the code for the new<code class="literal"> OpenLayers.Control.SelectFeature</code> control:<a class="indexterm" id="id382"/><div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript" src="./recipes/ch08/selectFeaturePath.js"&gt;&lt;/script&gt;
</pre></div></li><li class="listitem">Within the<code class="literal"> body</code> section, add a<code class="literal"> div</code> element to hold the map instance:<div class="informalexample"><pre class="programlisting">&lt;div id="ch08_selecting" style="width: 100%; height: 95%;"&gt;&lt;/div&gt;
</pre></div></li><li class="listitem">Next, place the JavaScript code within a<code class="literal"> script</code> element at the document's<code class="literal"> head</code> element:<div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript"&gt;
</pre></div></li><li class="listitem">Create the map instance, add a base layer, and center the viewport:<div class="informalexample"><pre class="programlisting">    var map = new OpenLayers.Map("ch08_selecting");
    var osm = new OpenLayers.Layer.OSM();
    map.addLayer(osm);
    
    // Certer viewport
    var center = new OpenLayers.LonLat(25,50);
    center.transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"));
    map.setCenter(center, 4);
</pre></div></li><li class="listitem">Now, create a vector layer that loads a GML file with the European countries:<div class="informalexample"><pre class="programlisting">    var vectorLayer = new OpenLayers.Layer.Vector("Europe", {
        protocol: new OpenLayers.Protocol.HTTP({
            url: "http://localhost:8080/openlayers-cookbook/recipes/data/europe.gml",
            format: new OpenLayers.Format.GML()
        }),
        strategies: [new OpenLayers.Strategy.Fixed()]
    });
    map.addLayer(vectorLayer);
</pre></div></li><li class="listitem">Then, create an instance of our new<code class="literal"> OpenLayers.Control.SelectFeaturePath</code> control, add it to the map and activate it:<div class="informalexample"><pre class="programlisting">    var sp = new OpenLayers.Control.SelectFeaturePath(vectorLayer);
    map.addControl(sp);
    sp.activate();  
&lt;/script&gt;
</pre></div></li><li class="listitem">Now, we are going to see the new<code class="literal"> SelectFeaturePath</code> control's implementation. Create a<code class="literal"> selectFeaturePath.js</code> file and add some control description:<a class="indexterm" id="id383"/><div class="informalexample"><pre class="programlisting">/**
 * Class: OpenLayers.Control.SelectFeaturePath
 * The SelectFeaturePath control selects vector features from a given layer 
 * that intersects with a path.
 *
 * Inherits from:
 *  - &lt;OpenLayers.Control.SelectFeature&gt;
 */
</pre></div></li><li class="listitem">Create the new class:<div class="informalexample"><pre class="programlisting">OpenLayers.Control.SelectFeaturePath = OpenLayers.Class(OpenLayers.Control.SelectFeature, {
</pre></div></li><li class="listitem">Implement the<code class="literal"> initialize</code> method responsible for initializing the control. Note how we call the super class's<code class="literal"> initialize</code> method also, to initialize the parent class:<div class="informalexample"><pre class="programlisting">    /**
     * Constructor: OpenLayers.Control.SelectFeaturePath
     * Create a new control for selecting features using 
     * an OpenLayers.Handler.Path handler.
     *
     * Parameters:
     * layers - {&lt;OpenLayers.Layer.Vector&gt;}, or an array of vector layers. The
     *     layer(s) this control will select features from.
     * options - {Object} 
     */
    initialize: function(layers, options) {
        OpenLayers.Control.SelectFeature.prototype.initialize.apply(this, arguments);
                    
        this.box = true;                    
        this.handlers.box = new OpenLayers.Handler.Path(this, {
            done: this.selectPath
        });
    },
</pre></div></li><li class="listitem">Implement the<code class="literal"> selectPath</code> method. This method selects those features which intersect with the created line:<a class="indexterm" id="id384"/><div class="informalexample"><pre class="programlisting">    /**
     * Method: selectPath
     * Callback from the handlers.box set up when &lt;path&gt; selection is done.
     * Select those features that intersect with the path.
     *
     * Parameters:
     * path - {&lt;OpenLayers.Geometry.LineString&gt;}  
     */
    selectPath: function(path) {
        // If multiple is false, first deselect currently selected features
        if (!this.multipleSelect()) {
            this.unselectAll();
        }
            
        // Consider we want multiple selection
        var prevMultiple = this.multiple;
        this.multiple = true;
        var layers = this.layers || [this.layer];
        var layer;
        for(var l=0; l&lt;layers.length; ++l) {
            layer = layers[l];
            for(var i=0, len = layer.features.length; i&lt;len; ++i) {
                var feature = layer.features[i];
                // Check if the feature is displayed
                if (!feature.getVisibility()) {
                    continue;
                }

                if (this.geometryTypes == null || OpenLayers.Util.indexOf(
                    this.geometryTypes, feature.geometry.CLASS_NAME) &gt; -1) {
                    if (path.intersects(feature.geometry)) {
                        if (OpenLayers.Util.indexOf(layer.selectedFeatures, feature) == -1) {
                            this.select(feature);
                        }
                    }
                }
            }
        }
        this.multiple = prevMultiple;        
    },
</pre></div></li><li class="listitem">Finally, create a unique identifier for the class:<div class="informalexample"><pre class="programlisting">    CLASS_NAME: "OpenLayers.Control.SelectFeaturePath"
});
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec18"/>How it works...</h3></div></div></div><p>The main program does not have much mystery. We have created a map, added a vector layer, and then added our custom<code class="literal"> SelectFeaturePath</code> control:<a class="indexterm" id="id385"/>
</p><div class="informalexample"><pre class="programlisting">    var sp = new OpenLayers.Control.SelectFeaturePath(vectorLayer);
    map.addControl(sp);
    sp.activate(); 
</pre></div><p>Note how we have transformed the coordinates to center the map's viewport. This is because we are specifying the location in EPSG:4326 and the map is using a base layer with EPSG:900913:</p><div class="informalexample"><pre class="programlisting">    var center = new OpenLayers.LonLat(25,50);
    center.transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"));
    map.setCenter(center, 4);
</pre></div><p>Because our control is an extension of the<code class="literal"> OpenLayers.Control.SelectFeature</code> control, it is important to describe it briefly before going into the code's description.</p><p>As we commented at the beginning of the recipe, this control works on the client side, that is, no request is made to the data source. The control iterates over all features in a layer (or layers) and selects those features that match the criteria.</p><p>By default, without specifying any options on its instantiation, the control allows us to select features by clicking on it. We can also set properties, such as the<code class="literal"> hover</code> property, which allows us to highlight the feature pointed by the mouse or, the important one here, the<code class="literal"> box</code> property, which allows the feature selection to draw a box.</p><p>This is done because the control internally uses an instance of an<code class="literal"> OpenLayers.Handler.Box</code> handler, which is responsible to draw a box and returns a bounding box's coordinates so the control can check which features are inside the box.</p><p>The idea to extend our control and allow selecting features just by drawing a path is simple, instead of using an<code class="literal"> OpenLayers.Handler.Box</code> handler we are going to use an<code class="literal"> OpenLayers.Handler.Path</code> handler.<a class="indexterm" id="id386"/>
</p><p>All right, we have background knowledge about what we need. Let's go to see how we have done.</p><p>We have created the new<code class="literal"> OpenLayers.Control.SelectFeaturePath</code> class using the<code class="literal"> OpenLayers.Class</code> method. This class allows merging the properties and methods of two objects:</p><div class="informalexample"><pre class="programlisting">OpenLayers.Control.SelectFeaturePath = OpenLayers.Class(OpenLayers.Control.SelectFeature, { 
    ...
    ...
});
</pre></div><p>In the previous line, we are merging the properties and methods of the<code class="literal"> OpenLayers.Control.SelectFeature</code> class with those defined in the second argument, which is an object in the literal notation.</p><p>Within the<code class="literal"> initialize()</code> method, it is important we set the<code class="literal"> box</code> and<code class="literal"> handlers.box</code> properties inherited from the superclass. Setting the<code class="literal"> handlers.box</code> to a new instance of<code class="literal"> OpenLayers.Handler.Path</code> makes the control use a path handler instead of a box handler to select the features.</p><p>The<code class="literal"> box</code> property set to<code class="literal"> true</code> indicates we want to select the features using a handler instead of simply clicking on them:</p><div class="informalexample"><pre class="programlisting">    initialize: function(layers, options) {
        OpenLayers.Control.SelectFeature.prototype.initialize.apply(this, arguments);
                    
        this.box = true;                    
        this.handlers.box = new OpenLayers.Handler.Path(this, {
            done: this.selectPath
        });
    },
</pre></div><p>Using a property called<code class="literal"> handlers.box</code> to specify a path handler is not the clearest way to do it, but in contrast, is the easiest one. The<code class="literal"> OpenLayers.Control.SelectFeature</code> class uses this property to get the appropriate handler to make the selection.</p><p>In the previous code, when the path handler is initialized, we have set a listener function for the<code class="literal"> done</code> event, which is triggered when the path handler finishes drawing the line.<a class="indexterm" id="id387"/>
</p><p>The<code class="literal"> selectPath</code> method, is responsible to find out which features of the layer intersect the path and change its renderer style to highlight them.</p><p>Note, the listener function receives an<code class="literal"> OpenLayers.Geometry.LineString</code> instance with the created path:</p><div class="informalexample"><pre class="programlisting">    selectPath: function(path) { 
        // If multiple is false, first deselect currently selected features 
        if (!this.multipleSelect()) { 
            this.unselectAll(); 
        } 
</pre></div><p>Because the control can work with more than one layer, we need to iterate over all the layers and all the features on each layer:</p><div class="informalexample"><pre class="programlisting">        // Consider we want multiple selection 
        var prevMultiple = this.multiple; 
        this.multiple = true; 
        var layers = this.layers || [this.layer]; 
        var layer; 
        for(var l=0; l&lt;layers.length; ++l) { 
            layer = layers[l]; 
            for(var i=0, len = layer.features.length; i&lt;len; ++i) { 
                var feature = layer.features[i]; 
                // Check if the feature is displayed 
                if (!feature.getVisibility()) { 
                    continue; 
                } 
</pre></div><p>After checking if the feature is visible we can check whether the feature intersects with the path, using the<code class="literal"> intersects</code> method:</p><div class="informalexample"><pre class="programlisting">                if (this.geometryTypes == null || OpenLayers.Util.indexOf( 
                    this.geometryTypes, feature.geometry.CLASS_NAME) &gt; -1) { 
                    if (path.intersects(feature.geometry)) { 
                        if (OpenLayers.Util.indexOf(layer.selectedFeatures, feature) == -1) { 
                            this.select(feature); 
                        } 
                    } 
                } 
            } 
        } 
        this.multiple = prevMultiple;        
    }, 
</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note72"/>Note</h3><p>The<code class="literal"> OpenLayers.Util.indexOf(array, object)</code> function returns the index at which an object is found within an array.</p></div><p>To change the rendering style of the feature, we simply call the method<code class="literal"> select</code> inherited from the<code class="literal"> OpenLayers.Control.SelectFeature</code> class.<a class="indexterm" id="id388"/>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note73"/>Note</h3><p>A vector layer can render the features using different styles, called render intents: default, select, or temporary are the default render intents we can use.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec19"/>See also</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Creating a custom renderer</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Playing with StyleMap and the render intents</em></span> recipe in<a class="link" href="ch07.html" title="Chapter 7. Styling Features"> Chapter 7</a>, <span class="emphasis"><em> Styling Features</em></span></li></ul></div></div></div></div>
<div class="section" title="Making an animation with image layers"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec07"/>Making an animation with image layers</h1></div></div></div><p>When working with geographic information, its geometrical representation within the space is not the only important thing. Day by day time is becoming a new and important dimension to take into account.<a class="indexterm" id="id389"/>
</p><p>This way, visualizations must show how data changes over time: city population, country frontiers, roads built, and so on.</p><p>There are many solutions to animate the data evolution through time but, as always, we work with web technologies, there are two groups: the solutions based on the server side and those based on the client side.</p><p>For server-side solutions, we can find the<code class="literal"> TIME</code> parameter in the WMS and WFS standards. It allows us to request for raster or vector data in a specific time or within a range.</p><p>Server solutions means the client must request the server every time we want to show the data for a different interval.</p><p>For the client side, a simple solution is to have in the memory all the data, and only show those that correspond to the interval we are interested in.<a class="indexterm" id="id390"/>
</p><p>In this recipe we are going to show how easily we can create an animation on the client side.</p><p>We are going to load some images from<span class="strong"><strong> NEXTRAD</strong></span> (<a class="ulink" href="http://en.wikipedia.org/wiki/NEXRAD">http://en.wikipedia.org/wiki/NEXRAD</a>), showing the rain evolution at different time instants (as shown in the following screenshot), and we will create an animation by simply showing or hiding images:</p><div class="mediaobject"><img alt="Making an animation with image layers" src="graphics/7843_08_05.jpg"/></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec20"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new HTML file and add the OpenLayers dependencies. In the<code class="literal"> body</code> section start adding the elements necessary for the play button and the slider:<a class="indexterm" id="id391"/><div class="informalexample"><pre class="programlisting">&lt;table&gt;
    &lt;tr&gt;
        &lt;td&gt;
            Animation:
        &lt;/td&gt;
        &lt;td&gt;
            &lt;div id="animSlider" dojoType="dijit.form.HorizontalSlider" value="0" minimum="0" maximum="100" intermediateChanges="true"
                 showButtons="false" style="width:300px;" onChange="animation"&gt;
                &lt;div dojoType="dijit.form.HorizontalRule" container="bottomDecoration" count=11 style="height:5px;"&gt;&lt;/div&gt;
            &lt;/div&gt; 
        &lt;/td&gt;
        &lt;td&gt;
            &lt;div dojoType="dijit.form.ToggleButton" iconClass="dijitCheckBoxIcon" onChange="animateAction"&gt;Play&lt;/div&gt;
        &lt;/td&gt;
    &lt;/tr&gt;
&lt;/table&gt;
</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title">Note</h3><p>In addition to OpenLayers, we are using the Dojo Toolkit framework (<a class="ulink" href="http://dojotoolkit.org">http://dojotoolkit.org</a>) to create more attractive user interfaces. Learning Dojo is out of the scope of this book and also, it is not necessary to know it to understand this recipe.</p></div></li><li class="listitem">Next, add the<code class="literal"> div</code> element to hold the map:<div class="informalexample"><pre class="programlisting">&lt;div id="ch08_animating_raster" style="width: 100%; height: 100%;"&gt;&lt;/div&gt;
</pre></div></li><li class="listitem">Now, in the header section add the next JavaScript code. Start initializing the map instance, add a base layer, and center the viewport:<div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript"&gt;
    var map = new OpenLayers.Map("ch08_animating_raster");
    var wms = new OpenLayers.Layer.WMS("OpenLayers WMS Basic", "http://labs.metacarta.com/wms/vmap0",
    {
        layers: 'basic'
    });
    map.addLayer(wms);
    
    // Center the view
    map.setCenter(new OpenLayers.LonLat(-85, 40), 4);
</pre></div></li><li class="listitem">Now, we are going to create some raster image layers, add them to the map, and also store them on an array to control their visibility:<a class="indexterm" id="id392"/><div class="informalexample"><pre class="programlisting">    var img_extent = new OpenLayers.Bounds(-131.0888671875, 30.5419921875, -78.3544921875, 53.7451171875);
    var img_size = new OpenLayers.Size(780, 480);
        
    var img_ulr = image = null;
    var imgArray = [];
    for(var i=1; i&lt;=32; i++) {
        index = (i&lt;10) ? "0"+i : i;
        img_url = "http://localhost:8080/openlayers-cookbook/recipes/data/radar/nexrad"+index+".png";        
        image = new OpenLayers.Layer.Image("Image Layer", img_url, img_extent, img_size, {
            isBaseLayer: false,
            alwaysInRange: true, // Necessary to always draw the image
            visibility: false
        });
        imgArray.push(image);
        map.addLayer(image);
    }
    imgArray[0].setVisibility(true);
</pre></div></li><li class="listitem">The following code controls the changes in the slider widget:<div class="informalexample"><pre class="programlisting">    var currentIndex = 0;
    function animation(value){
        imgArray[currentIndex].setVisibility(false);
        currentIndex = Math.floor(value * 31 / 100);
        imgArray[currentIndex].setVisibility(true);
    }
</pre></div></li><li class="listitem">Finally, the following code controls the automatic animation when the<span class="strong"><strong> Play</strong></span> button is clicked:<div class="informalexample"><pre class="programlisting">    var interval = null;
    function animateAction(checked) {
        if(checked) {
            interval = setInterval(function() {
                var v = dijit.byId('animSlider').get('value');
                v = (v&gt;=100) ? 0 : (v+1);
                dijit.byId('animSlider').set('value', v);
                animation(v);
            },50);
        } else {
            clearInterval(interval);
        }
    }
&lt;/script&gt;
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec21"/>How it works...</h3></div></div></div><p>As mentioned at the beginning of this recipe, the idea is to animate some weather radar on the client side. For this reason, we load a set of images from the server, creating a layer for each one.<a class="indexterm" id="id393"/>
</p><p>The<code class="literal"> OpenLayers.Layer.Image</code> class is used here to hold each image as a single layer. Its constructor requires five parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">name:</code> The name of the layer</li><li class="listitem" style="list-style-type: disc"><code class="literal">url:</code> The URL where the image must be taken</li><li class="listitem" style="list-style-type: disc"><code class="literal">extent:</code> The bounds of the image within the map</li><li class="listitem" style="list-style-type: disc"><code class="literal">size:</code> The size in pixels</li><li class="listitem" style="list-style-type: disc"><code class="literal">options:</code> A set of options to be passed to the layer</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note74"/>Note</h3><p>The<code class="literal"> extent</code> and the<code class="literal"> size</code> arguments are used to compute the resolution of the image.</p></div><p>In our case, all the image layers will have the same<code class="literal"> extent</code> and<code class="literal"> size:</code>
</p><div class="informalexample"><pre class="programlisting">    var img_extent = new OpenLayers.Bounds(-131.0888671875, 30.5419921875, -78.3544921875, 53.7451171875);
    var img_size = new OpenLayers.Size(780, 480);
</pre></div><p>Later, within the loop to create all the image layers, we are setting dynamically the value of the<code class="literal"> img_url</code> variable and passing some options to the<code class="literal"> OpenLayers.Layer.Image</code> constructor:</p><div class="informalexample"><pre class="programlisting">        image = new OpenLayers.Layer.Image("Image Layer", img_url, img_extent, img_size, {
            isBaseLayer: false,
            alwaysInRange: true, // Necessary to always draw the image
            visibility: false
        });
        imgArray.push(image);
</pre></div><p>By setting the<code class="literal"> isBaseLayer</code> property to<code class="literal"> false</code> we are specifying that our layer is not a base layer, it will act as an overlay. In addition, we set the<code class="literal"> visibility</code> property to<code class="literal"> false</code> to initially hide the layer. Later, we will set the first image layer as the visible one:<a class="indexterm" id="id394"/>
</p><div class="informalexample"><pre class="programlisting">    imgArray[0].setVisibility(true);
</pre></div><p>The<code class="literal"> alwaysInRange</code> property is inherited from the superclass<code class="literal"> OpenLayers.Layer</code> and specially useful in this case. We want our image layer to be visible at any zoom level. We do not want OpenLayers to compute the right resolution; given the image layer extent and size, the layer must be shown. So, setting<code class="literal"> alwaysInRange</code> to<code class="literal"> true</code> makes the layer always visible.</p><p>Next, we are going to see how to automatically automate the animation. The<code class="literal"> animateAction</code> is executed when the play button is pressed. It is a toggle button, so depending on its state, the boolean<code class="literal"> checked</code> parameter will be true if checked or false if not:</p><div class="informalexample"><pre class="programlisting">    function animateAction(checked) {
        if(checked) {
</pre></div><p>If the play button is checked, then we create an interval to execute the given anonymous function every 50 milliseconds which, in fact, increases the value of the slider and calls the<code class="literal"> animation</code> function:</p><div class="informalexample"><pre class="programlisting">            interval = setInterval(function() {
                var v = dijit.byId('animSlider').get('value');
                v = (v&gt;=100) ? 0 : (v+1);
                dijit.byId('animSlider').set('value', v);
                animation(v);
            },50);
        } else {
</pre></div><p>If the button is unchecked, then we remove the interval reference to stop the execution:</p><div class="informalexample"><pre class="programlisting">            clearInterval(interval);
        }
</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note75"/>Note</h3><p>
<span class="strong"><strong>Intervals</strong></span> and<span class="strong"><strong> timeouts</strong></span> are used in JavaScript to create animations and delays.</p><p>A good explanation of intervals in JavaScript can be found at<a class="ulink" href="http://www.w3schools.com/jsref/met_win_setinterval.asp"> http://www.w3schools.com/jsref/met_win_setinterval.asp</a>.</p></div><p>Finally, let's take a look at the<code class="literal"> animation</code> function, which is responsible to change the layer visibilities and create the animation effect.<a class="indexterm" id="id395"/>
</p><p>All the layers are added to the map and also stored in the<code class="literal"> imgArray</code>. The global<code class="literal"> currentIndex</code> variable is used to hold the current visible layer. The animation function does three things:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Hides the current visible layer</li><li class="listitem" style="list-style-type: disc">Given the numeric<code class="literal"> value</code>, that varies from 0 to 100, computes the layer array index, that goes from 0 to 31</li><li class="listitem" style="list-style-type: disc">Shows the new current layer</li></ul></div><div class="informalexample"><pre class="programlisting">    var currentIndex = 0;
    function animation(value){
        imgArray[currentIndex].setVisibility(false);
        currentIndex = Math.floor(value * 31 / 100);
        imgArray[currentIndex].setVisibility(true);
    }
</pre></div><p>That's all! Once the set of layers is loaded in the client side, using any modern browser, the performance of the animation is good enough.</p><p>This is only a sample, so there are tons of things to improve. For example, think on how to implement a situation where we have a remote server with hundreds of images to load sequentially. In this case we cannot load all images at once because that can cause an out-of-memory problem in the browser.</p><p>Supposing we have thousands of images to animate, we could implement some buffer strategy. Given a buffer of ten images, we can load the first ten images from the server, then animate them and when the animation arrives to the last loaded image, load the next ten images from the server.</p><p>As we can see, these situations are out of the scope of this book and not only related to OpenLayers but with software architecture and design.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec22"/>See also</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Creating an Image layer</em></span> recipe in<a class="link" href="ch02.html" title="Chapter 2. Adding Raster Layers"> Chapter 2</a>, <span class="emphasis"><em> Adding Raster Layers</em></span></li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Changing layer opacity</em></span> recipe in<a class="link" href="ch02.html" title="Chapter 2. Adding Raster Layers"> Chapter 2</a>, <span class="emphasis"><em> Adding Raster Layers</em></span></li></ul></div></div></div></div></body></html>