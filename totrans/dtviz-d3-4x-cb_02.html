<html><head></head><body><div><div><div><div><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Be Selective</h1></div></div></div><p>In this chapter we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Selecting a single element</li><li class="listitem" style="list-style-type: disc">Selecting multiple elements</li><li class="listitem" style="list-style-type: disc">Iterating through a selection</li><li class="listitem" style="list-style-type: disc">Performing subselection</li><li class="listitem" style="list-style-type: disc">Function chaining</li><li class="listitem" style="list-style-type: disc">Manipulating raw selection</li></ul></div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec12"/>Introduction</h1></div></div></div><p>One of the most fundamental tasks that you will need to perform with any data visualization project using D3 is selection. Selection helps you target certain visual elements on the page. If you are already familiar with the W3C-standardized CSS selector or other similar selector APIs provided by popular JavaScript libraries, such as jQuery and Zepto.js, then you will find yourself right at home with D3's selection API. Don't worry if you haven't used the selector API before; this chapter is designed to cover this topic in steps with the help of some very visual recipes. It will cover pretty much all common use cases for your data visualization needs.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec24"/>Introducing selection</h2></div></div></div><p>Selector support is standardized by W3C, so all modern web browsers have built-in support for the selector API. However, the basic W3C selector API has limitations when it comes to Web development, especially in the data visualization realm. The standard W3C selector API provides only the selector, but not the selection. What this means is that the selector API helps you to select element(s) in your document; however, to manipulate the selected element(s), you still need to loop through each element. Consider the following code snippet using the standard selector API:</p><pre class="programlisting">var selector = document.querySelectorAll("p"); 
selector.forEach(function(p){ 
    // do something with each element selected 
    console.log(p); 
}); 
</pre><p>The preceding code essentially selects all <code class="literal">&lt;p&gt;</code> elements in the document and then iterates through each element to perform some task. This can obviously get tedious quickly, especially when you have to manipulate many different elements on the page constantly, which is what we usually do in data visualization projects. This is why D3 introduced its own selection API, making development less of a chore. In the rest of this chapter, we will cover how D3's selection API works and some of its powerful features.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec25"/>CSS3 selector basics</h2></div></div></div><p>Before we dive into D3's selection API, some basic introduction on the W3C level-3 selector API is required. If you are already comfortable with CSS3 selectors, feel free to skip this section. D3's selection API is built based on the level-3 selector or is more commonly known as CSS3 selector support. In this section, we plan to go through some of the most common CSS3 selector syntaxes that are required to understand the D3 selection API. The following list contains some of the most common CSS3 selector conventions you will typically encounter in a data visualization project:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">#foo</code>: Selects elements with <code class="literal">foo</code> as the value of <code class="literal">id</code><pre class="programlisting">     &lt;div id="foo"&gt; 
</pre></li><li class="listitem" style="list-style-type: disc"><code class="literal">foo</code>: Selects element <code class="literal">foo</code><pre class="programlisting">     &lt;foo&gt; 
</pre></li><li class="listitem" style="list-style-type: disc"><code class="literal">.foo</code>: Selects elements with <code class="literal">foo</code> as the value of <code class="literal">class</code><pre class="programlisting">     &lt;div class="foo"&gt; 
</pre></li><li class="listitem" style="list-style-type: disc"><code class="literal">[foo=goo]</code>: Selects elements with the <code class="literal">foo</code> attribute value and sets it to <code class="literal">goo</code><pre class="programlisting">     &lt;div foo="goo"&gt; 
</pre></li><li class="listitem" style="list-style-type: disc"><code class="literal">foo goo</code>: Selects the <code class="literal">goo</code> element inside the <code class="literal">foo</code> element<pre class="programlisting">     &lt;foo&gt;&lt;goo&gt;&lt;/foo&gt; 
</pre></li><li class="listitem" style="list-style-type: disc"><code class="literal">foo#goo</code>: Selects the <code class="literal">foo</code> element with <code class="literal">goo</code> as the value of <code class="literal">id</code><pre class="programlisting">     &lt;foo id="goo"&gt; 
</pre></li><li class="listitem" style="list-style-type: disc"><code class="literal">foo.goo</code>: Selects the <code class="literal">foo</code> element with <code class="literal">goo</code> as the value of <code class="literal">class</code><pre class="programlisting">     &lt;foo class="goo"&gt; 
</pre></li><li class="listitem" style="list-style-type: disc"><code class="literal">foo:first-child</code>: Selects the first child of the <code class="literal">foo</code> elements<pre class="programlisting">     &lt;foo&gt; // &lt;-- this one 
     &lt;foo&gt; 
     &lt;foo&gt;  
</pre></li><li class="listitem" style="list-style-type: disc"><code class="literal">foo:nth-child(n)</code>: Selects the <code class="literal">n</code>th child of the <code class="literal">foo</code> elements (<code class="literal">n</code> is one-based, starting at 1 for the first child)<pre class="programlisting">     &lt;foo&gt; 
     &lt;foo&gt; // &lt;-- foo:nth-child(2) 
     &lt;foo&gt; // &lt;-- foo:nth-child(3) 
</pre></li></ul></div><p>CSS3 selector is a pretty complex topic. Here, we have only listed some of the most common selectors that you will need to understand and that you need to be effective when working with D3. For more information on this topic, please visit the W3C level-3 selector API document at <a class="ulink" href="http://www.w3.org/TR/css3-selectors/">http://www.w3.org/TR/css3-selectors/
</a>.</p><div><div><h3 class="title"><a id="note18"/>Note</h3><p>If you are targeting an older browser that does not support selector natively, you can include Sizzle before D3 for backward compatibility. You can find Sizzle at <a class="ulink" href="http://sizzlejs.com/">http://sizzlejs.com/
</a>.</p><p>
Currently, the next-generation selector API level-4 is in the draft stage with W3C. You can have a peek at what it has to offer and its current draft at <a class="ulink" href="https://drafts.csswg.org/selectors-4/">https://drafts.csswg.org/selectors-4/
</a>.</p><p>Major browser vendors have already started implementing some of the level-4 selectors; if you are interested to find out the level of support in your browser, try out this handy website: 
<a class="ulink" href="http://css4-selectors.com/browser-selector-test/">http://css4-selectors.com/browser-selector-test/
</a>.</p></div></div></div></div></div></div></div>
<div><div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec13"/>Selecting a single element</h1></div></div></div><p>It is very common that at times you will need to select a single element on a page to perform some visual manipulation. This recipe will show you how to perform a targeted single element selection in D3 using a CSS selector.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec26"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter2/single-selection.html">https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter2/single-selection.html
</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec27"/>How to do it...</h2></div></div></div><p>Let's select something (a <code class="literal">paragraph</code> element perhaps) and produce the classic <em>hello world</em> on screen.</p><pre class="programlisting">&lt;p id="target"&gt;&lt;/p&gt; &lt;!-- A --&gt; 
 
&lt;script type="text/javascript"&gt; 
    d3.select("p#target") // &lt;-- B 
    .text("Hello world!"); // &lt;-- C 
&lt;/script&gt; 
</pre><p>This recipe simply produces text <strong>Hello world!</strong> on your screen.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec28"/>How it works...</h2></div></div></div><p>The <code class="literal">d3.select</code> command is used to perform a single-element selection in D3. This method accepts a string that represents a valid CSS3 selector or an element object if you already have a reference to the element you want to select. The <code class="literal">d3.select</code> command returns a D3 selection object on which you can chain modifier functions to manipulate the attribute, content, or inner HTML of this element.</p><div><div><h3 class="title"><a id="note19"/>Note</h3><p>More than one element can be selected using the selector, provided only the first element is returned in the selection.</p></div></div><p>In this example, we simply select the paragraph element with <code class="literal">target</code> as the value of <code class="literal">id</code> at line <code class="literal">B</code>, and then set its textual content to <code class="literal">Hello world!</code> on line <code class="literal">C</code>. All D3 selections support a set of standard modifier functions. The <code class="literal">text</code> function we have shown in this particular example is one of them. The following are some of the most common modifier functions you will encounter throughout this book:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">selection.attr</code>: This function allows you to retrieve or modify a given attribute on the selected element(s):<pre class="programlisting">     // set foo attribute to goo on p element 
     d3.select("p").attr("foo", "goo");  
     // get foo attribute on p element 
     d3.select("p").attr("foo"); 
</pre></li><li class="listitem" style="list-style-type: disc"><code class="literal">selection.classed</code>: This function allows you to add or remove CSS classes on the selected element(s):<pre class="programlisting">     // test to see if p element has CSS class goo 
     d3.select("p").classed("goo"); 
     // add CSS class goo to p element 
     d3.select("p").classed("goo", true); 
     // remove CSS class goo from p element. classed function 
     // also accepts a function as the value so the decision  
     // of adding and removing can be made dynamically 
     d3.select("p").classed("goo", function(){return false;}); 
</pre></li><li class="listitem" style="list-style-type: disc"><code class="literal">selection.style</code>: This function lets you set the CSS style with a specific name to the specific value on the selected element(s):<pre class="programlisting">     // get p element's style for font-size 
     d3.select("p").style("font-size"); 
     // set font-size style for p to 10px 
     d3.select("p").style("font-size", "10px"); 
     // set font-size style for p to the result of some  
     // calculation. style function also accepts a function as  
     // the value can be produced dynamically 
     d3.select("p").style("font-size", function(){  
         return parseFloat(d3.select(this).style('font-size')) + 
             10 + 'px'; 
     }); 
</pre></li><li class="listitem" style="list-style-type: disc">Variable <code class="literal">this</code> in the preceding anonymous function is the DOM element object for the selected element <code class="literal">&lt;p&gt;</code>; therefore, it needs to be wrapped in <code class="literal">d3.select</code> again in order to access its <code class="literal">style</code> attribute.</li><li class="listitem" style="list-style-type: disc"><code class="literal">selection.text</code>: This function allows you to access and set the text content of the selected element(s) as follows:<pre class="programlisting">     // get p element's text content 
     d3.select("p").text(); 
     // set p element's text content to "Hello" 
     d3.select("p").text("Hello"); 
     // text function also accepts a function as the value,  
     // thus allowing setting text content to some dynamically  
     // produced content 
     d3.select("p").text(function(){ 
       return Date(); 
     }); 
</pre></li><li class="listitem" style="list-style-type: disc"><code class="literal">selection.html</code>: This function lets you modify the element's inner HTML content as shown in the following:<pre class="programlisting">     // get p element's inner html content 
     d3.select("p").html(); 
     // set p element's inner html content to "&lt;b&gt;Hello&lt;/b&gt;" 
     d3.select("p").html("&lt;b&gt;Hello&lt;/b&gt;"); 
     // html function also accepts a function as the value,  
     // thus allowing setting html content to some dynamically  
     // produced message 
     d3.select("p").html(function(){ 
       return d3.select(this).text() +  
         " &lt;span style='color: blue;'&gt;D3.js&lt;/span&gt;"; 
     }); 
</pre></li></ul></div><p>These modifier functions work on both single-element and multi-element selection results. When applied to multi-element selections, these modifications will be applied to each and every selected element. We will see them in action in other, more complex  recipes that will be covered later in this chapter.</p><p>When a function is used as a value in these modifier functions, there are actually some built-in parameters passed to these functions to enable data-driven calculation. This data-driven approach is what gives D3 its power and its name (<strong>Data-Driven Document</strong>) and will be discussed in detail in the next chapter.</p></div></div></div></div>
<div><div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec14"/>Selecting multiple elements</h1></div></div></div><p>Often selecting a single element is not good enough, but rather you want to apply a certain change to a set of elements on the page simultaneously. In this recipe, we will play with the D3 multi-element selector and its selection API.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec29"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter2/multiple-selection.html">https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter2/multiple-selection.html
</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec30"/>How to do it...</h2></div></div></div><p>This is what the <code class="literal">d3.selectAll</code> function is designed for. In the following code snippet, we will select three different <code class="literal">div</code> elements and enhance them with some CSS classes:</p><pre class="programlisting">&lt;div&gt;&lt;/div&gt; 
&lt;div&gt;&lt;/div&gt; 
&lt;div&gt;&lt;/div&gt; 
 
&lt;script type="text/javascript"&gt; 
    d3.selectAll("div") // &lt;-- A 
    .attr("class", "red box"); // &lt;-- B 
&lt;/script&gt; 
</pre><p>This code snippet produces the following visual:</p><p>
</p><div><img src="img/image_02_001.jpg" alt="How to do it..."/></div><p>
</p><p>Multi-element selection</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec31"/>How it works...</h2></div></div></div><p>First thing you probably will notice in this example is how similar the usage of D3 selection API is when compared to the single-element version. This is one of the powerful design choices of the D3 selection API. No matter how many elements you target and manipulate, whether one or many, the modifier functions are exactly the same. All the modifier functions we mentioned in the previous section can be applied directly to multi-element selection; in other words, D3 selection is set-based.</p><p>Now, with that being said, let's take a closer look at the code example shown in this section, though it is generally pretty simple and self-descriptive. At line <code class="literal">A</code>, the <code class="literal">d3.selectAll</code> function is used to select all the <code class="literal">div</code> elements on the page. The return of this function call is a D3 selection object that contains all the three <code class="literal">div</code> elements. Immediately after that, on line <code class="literal">B</code>, the <code class="literal">attr</code> function was called on this selection to set the <code class="literal">class</code> attribute to <code class="literal">red box</code> for all three <code class="literal">div</code> elements. As shown in this example, the selection and manipulation code are very generic, and will not change even if now we have more than three <code class="literal">div</code> elements on the page. This seems to be an insignificant convenience for now, but in later chapters, we will show how this convenience can make your visualization code simpler and easier to maintain.</p></div></div></div></div>
<div><div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec15"/>Iterating through a selection</h1></div></div></div><p>Sometimes it is handy to be able to iterate through each element within a selection and modify each element differently according to their position. In this recipe, we will show you how this can be achieved using D3 selection iteration API.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec32"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter2/selection-iteration.html">https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter2/selection-iteration.html
</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec33"/>How to do it...</h2></div></div></div><p>D3 selection object provides a simple iterator interface to perform iteration in a similar fashion to how you will iterate through a JavaScript array. In this example, we will iterate through the three selected <code class="literal">div</code> elements we worked with in the previous recipe and annotate them with an index number as follows:</p><pre class="programlisting">&lt;div&gt;&lt;/div&gt; 
&lt;div&gt;&lt;/div&gt; 
&lt;div&gt;&lt;/div&gt; 
 
&lt;script type="text/javascript"&gt; 
d3.selectAll("div") // &lt;-- A 
            .attr("class", "red box") // &lt;-- B 
            .each(function (d, i) { // &lt;-- C 
                d3.select(this).append("h1").text(i); // &lt;-- D 
            }); 
&lt;/script&gt; 
</pre><p>The preceding code snippet produces the following visual:</p><p>
</p><div><img src="img/image_02_002.jpg" alt="How to do it..."/></div><p>
</p><p>Selection iteration</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec34"/>How it works...</h2></div></div></div><p>This example is built on top of what we have already seen in the previous section. In addition to selecting all the <code class="literal">div</code> elements on the page at line <code class="literal">A</code> and setting their class attributes at line <code class="literal">B</code>, in this example, we will call the <code class="literal">each</code> function on the selection to demonstrate how we can iterate through a multi-element selection and process each element, respectively:</p><div><div><h3 class="title"><a id="note20"/>Note</h3><p>This form of calling a function on another function's return is called <strong>Function Chaining</strong>. If you are unfamiliar with this kind of invocation pattern, please refer to <a class="link" href="ch01.html" title="Chapter 1. Getting Started with D3.js">Chapter 1</a>, <em>Getting Started with D3.js</em>, where the topic was explained.</p></div></div><p>The following list explains the <code class="literal">select</code>
<code class="literal">each</code> and <code class="literal">append</code> functions:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">selection.each(function)</code>: The <code class="literal">each</code> function takes an iterator function as its parameter. The given iterator function can receive two optional parameters <code class="literal">d</code> and <code class="literal">i</code> with one more hidden parameter passed in as the <code class="literal">this</code> reference, which points to the current DOM element object. The first parameter <code class="literal">d</code> represents the datum bound to this particular element (if this sounds confusing to you, don't worry, we will cover data binding in depth in the next chapter). The second parameter <code class="literal">i</code> is the index number for the current element object being iterated through. This index is zero-based, meaning it starts from zero and increments each time a new element is encountered.</li><li class="listitem" style="list-style-type: disc"><code class="literal">selection.append(tagName)</code>: Another new function introduced in this example is the <code class="literal">append</code> function. This function creates a new element with the given element name and appends it as the last child of each element in the current selection. It returns a new selection containing the newly appended element. Now, with this knowledge, let's take a closer look at the code example in this recipe:</li></ul></div><pre class="programlisting">     d3.selectAll("div") // &lt;-- A 
         .attr("class", "red box") // &lt;-- B 
         .each(function (d, i) { // &lt;-- C 
             d3.select(this).append("h1").text(i); // &lt;-- D 
         }); 
</pre><p>The iterator function is defined on line <code class="literal">C</code> with both <code class="literal">d</code> and <code class="literal">i</code> parameters. Line <code class="literal">D</code> is a little bit more interesting. At the beginning of line <code class="literal">D</code>, the <code class="literal">this</code> reference is wrapped by the <code class="literal">d3.select</code> function. This wrapping essentially produces a single-element selection containing the current DOM element, which the <code class="literal">this</code> variable represents. Once wrapped, the standard D3 selection manipulation API becomes available on <code class="literal">d3.select(this)</code>. After that, the <code class="literal">append("h1")</code> function is called on the current element selection appending a newly created <code class="literal">h1</code> element to the current element. Afterward, it simply sets the textual content of this newly created <code class="literal">h1</code> element to the index number of the current element. This produces the visual of numbered boxes as shown in this recipe as illustrated in the screen capture. Again, you should notice that the index starts from 0 and increments 1 for each element.</p><div><div><h3 class="title"><a id="note21"/>Note</h3><p>The DOM element object itself has a very rich interface. If you are interested to know more about what it can do in an iterator function, please refer to the DOM element API at <a class="ulink" href="https://developer.mozilla.org/en-US/docs/Web/API/element">https://developer.mozilla.org/en-US/docs/Web/API/element
</a>.</p></div></div></div></div></div></div>
<div><div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec16"/>Performing subselection</h1></div></div></div><p>It is quite common that you will need to perform scoped selection when working on visualization. For example, selecting all <code class="literal">div</code> elements within a particular <code class="literal">section</code> element is one such use case of scoped selection. In this recipe, we will demonstrate how this can be achieved with different approaches and their advantages and disadvantages.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec35"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter2/sub-selection.html">https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter2/sub-selection.html
</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec36"/>How to do it...</h2></div></div></div><p>The following code example selects two different <code class="literal">div</code> elements using two different styles of subselection supported by D3:</p><pre class="programlisting">&lt;section id="section1"&gt; 
    &lt;div&gt; 
        &lt;p&gt;blue box&lt;/p&gt; 
    &lt;/div&gt; 
&lt;/section&gt; 
&lt;section id="section2"&gt; 
    &lt;div&gt; 
        &lt;p&gt;red box&lt;/p&gt; 
    &lt;/div&gt; 
&lt;/section&gt; 
 
&lt;script type="text/javascript"&gt; 
    d3.select("#section1 &gt; div") // &lt;-- A 
            .attr("class", "blue box"); 
 
    d3.select("#section2") // &lt;-- B 
            .select("div") // &lt;-- C 
            .attr("class", "red box");  
&lt;/script&gt; 
</pre><p>This code generates the following visual output:</p><p>
</p><div><img src="img/image_02_003.jpg" alt="How to do it..."/></div><p>
</p><p>Subselection</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec37"/>How it works...</h2></div></div></div><p>Though it produces the same visual effect, this example demonstrates two very different subselection techniques. We will discuss them separately here so you can understand their pros and cons as well as when to use one versus the other:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Selector level-3 combinators:</strong> On line <code class="literal">A</code>, <code class="literal">d3.select</code> is used with a special-looking string, which consists of one tag name connected with another one using a greater-than sign (U+003E, &gt;). This syntax is called <em>combinators</em> (the greater-than sign here indicates it is a child combinator). Level-3 selector supports a few different kinds of structural combinators. Here, we will give a quick introduction to the most common ones.</li><li class="listitem" style="list-style-type: disc"><strong>The descendant combinator</strong>: This combinator has the syntax just like <code class="literal">selector selector</code>. The descendant combinator, as suggested by its name, is used to describe a loose parent-child relationship between two selections. The reason why it is called a loose parent-child relationship is that the descendant combinatory does not care if the second selection is a child or a grandchild or a great-grandchild of the parent selection. Let's take a look at some examples to illustrate this loose relationship concept:<pre class="programlisting">     &lt;div&gt; 
     &lt;span&gt; 
     The quick &lt;em&gt;red&lt;/em&gt; fox jumps over the lazy brown dog 
        &lt;/span&gt; 
     &lt;/div&gt; 
</pre><p>If we use the following selector:</p><pre class="programlisting">        div em 
</pre><p>It will select the <code class="literal">em</code> element since <code class="literal">div</code> is the ancestor of the <code class="literal">em</code> element and <code class="literal">em</code> is a descendent of the <code class="literal">div</code> element.</p></li><li class="listitem" style="list-style-type: disc"><strong>Child combinator</strong>: This combinator has the syntax such as <code class="literal">selector &gt; selector</code>. The child combinator offers a more restrictive way to describe a parent-child relationship between two elements. A child combinator is defined using a greater-than sign (U+003E, &gt;) character separating the two selectors, as follows:<pre class="programlisting">         span &gt; em</pre><p>It will select the <code class="literal">em</code> element since <code class="literal">em</code> is a direct child of the <code class="literal">span</code> element in our example. The selector <code class="literal">div &gt; em</code> will not produce any valid selection since <code class="literal">em</code> is not a direct child of the <code class="literal">div</code> element.</p><div><div><h3 class="title"><a id="note22"/>Note</h3><p>The level-3 selector also supports sibling combinators; however, since it is less common, we will not cover it here; interested readers can refer to W3C level-3 selector documentation at <a class="ulink" href="http://www.w3.org/TR/css3-selectors/#sibling-combinators">http://www.w3.org/TR/css3-selectors/#sibling-combinators
</a>.
The W3C level-4 selector offers some interesting additional combinators, that is, following-sibling and reference combinators that can yield some very powerful target selection capability; refer to <a class="ulink" href="https://drafts.csswg.org/selectors-4/#combinators">https://drafts.csswg.org/selectors-4/#combinators
</a> for more details.</p></div></div></li><li class="listitem" style="list-style-type: disc"><strong>The D3 nested subselection</strong>: On lines <code class="literal">B</code> and <code class="literal">C</code>, a different kind of subselection technique was used. In this case, a simple D3 selection was made first on line <code class="literal">B</code> by selecting the <code class="literal">section #section2</code> element. Immediately afterward, another <code class="literal">select</code> was chained to select a <code class="literal">div</code> element on line <code class="literal">C</code>. This kind of nested selection defines a scoped selection. In plain English, this basically means to select a <code class="literal">div</code> element that is nested under <code class="literal">#section2</code>. In semantics, this is essentially the same as using a descendant combinator <code class="literal">#section2 div</code>. However, the advantage of this form of subselection is that since the parent element is separately selected, it allows you to handle the parent element before selecting the child element. To demonstrate this, let's take a look at the following code snippet:<pre class="programlisting">     d3.select("#section2") // &lt;-- B 
         .style("font-size", "2em") // &lt;-- B-1 
         .select("div") // &lt;-- C 
         .attr("class", "red box"); 
</pre><p>As shown in the preceding code snippet, you can see that before we select the <code class="literal">div</code> element, we can apply a modifier function to <code class="literal">#section2</code> on line <code class="literal">B-1</code>. This flexibility will be further explored in the next section.</p></li></ul></div></div></div></div></div>
<div><div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec17"/>Function chaining</h1></div></div></div><p>As we have seen so far, the D3 API is completely designed around the idea of function chaining. Therefore, it forms a DSL for building HTML/SVG elements dynamically. In this code example, we will take a look at how the entire body structure of the previous example can be constructed using D3 alone.</p><div><div><h3 class="title"><a id="note23"/>Note</h3><p>If DSL is a new concept for you, I highly recommend checking out this excellent explanation on DSL by <em>Martin Fowler</em> in the form of an excerpt from his book <em>Domain-Specific Languages</em>. The excerpt can be found at <a class="ulink" href="http://www.informit.com/articles/article.aspx?p=1592379">http://www.informit.com/articles/article.aspx?p=1592379
</a>.</p></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec38"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter2/function-chain.html">https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter2/function-chain.html
</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec39"/>How to do it...</h2></div></div></div><p>Let's take a look at how a function chain can be used to produce concise and readable code that produces dynamic visual content:</p><pre class="programlisting">&lt;script type="text/javascript"&gt; 
  var body = d3.select("body"); // &lt;-- A 
 
  body.append("section") // &lt;-- B 
      .attr("id", "section1") // &lt;-- C 
    .append("div") // &lt;-- D 
      .attr("class", "blue box") // &lt;-- E 
    .append("p") // &lt;-- F 
      .text("dynamic blue box"); // &lt;-- G 
 
  body.append("section") 
      .attr("id", "section2") 
    .append("div") 
      .attr("class", "red box") 
    .append("p") 
      .text("dynamic red box"); 
&lt;/script&gt; 
</pre><p>This code generates the following visual output (similar to what we saw in the previous chapter):</p><p>
</p><div><img src="img/image_02_004.jpg" alt="How to do it..."/></div><p>
</p><p>Function chain</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec40"/>How it works...</h2></div></div></div><p>Despite the visual similarity to the previous example, the construction process of the DOM elements is significantly different in this example. As demonstrated by the code example, there is no static HTML element on the page contrary to the previous recipe where both the <code class="literal">section</code> and <code class="literal">div</code> elements existed.</p><p>Let's examine closely how these elements were dynamically created. On line A, a general selection was made to the top-level <code class="literal">body</code> element. The <code class="literal">body</code> selection result was cached using a local variable called <code class="literal">body</code>. Then, at line <code class="literal">B</code>, a new element <code class="literal">section</code> was appended to the body. Remember that the <code class="literal">append</code> function returns a new selection that contains the newly appended element; therefore, on line <code class="literal">C</code>, the <code class="literal">id</code> attribute can then be set on a newly created section element to <code class="literal">section1</code>. Afterward, on line <code class="literal">D</code>, a new <code class="literal">div</code> element was created and appended to <code class="literal">#section1</code> with its CSS class set to <code class="literal">blue box</code> on line <code class="literal">E</code>. For the next step, similar to the previous line, on line <code class="literal">F</code>, a <code class="literal">paragraph</code> element was appended to the <code class="literal">div</code> element with its textual content set to <code class="literal">dynamic blue box</code> on line <code class="literal">G</code>.</p><p>As illustrated by this example, this chaining process can continue to create any structure of arbitrary complexity. In fact this is how a typical D3-based data visualization structure is created. Many visualization projects simply contain only a HTML skeleton and rely on D3 to create the rest. Getting comfortable with this way of function chaining is critical if you want to become efficient with the D3 library.</p><div><div><h3 class="title"><a id="note24"/>Note</h3><p>Some of D3's modifier functions return a new selection, such as the <code class="literal">select</code>, <code class="literal">append</code>, and <code class="literal">insert</code> functions. It is a good practice to use different levels of indentation to differentiate the selection your function chain is being applied on.</p></div></div></div></div></div></div>
<div><div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec18"/>Manipulating the raw selection</h1></div></div></div><p>Sometimes, having access to the D3 raw selection array might be beneficial in development whether it's for debugging purposes or for integrating with other JavaScript libraries, which require access to raw DOM elements; in this recipe, we will show you ways to do that. We will also see some, internal structure of a D3 selection object.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec41"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter2/raw-selection.html">https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter2/raw-selection.html
</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec42"/>How to do it...</h2></div></div></div><p>Of course, you can achieve this using the <code class="literal">nth-child</code> selector or the selection iterator function <code class="literal">each</code>, but there are cases where these options are just too cumbersome and inconvenient. This is when you might find dealing with the raw selection array a more convenient approach. In this example, we will see how the raw selection array can be accessed and leveraged:</p><pre class="programlisting">&lt;table class="table"&gt; 
    &lt;thead&gt; 
    &lt;tr&gt; 
        &lt;th&gt;Time&lt;/th&gt; 
        &lt;th&gt;Type&lt;/th&gt; 
        &lt;th&gt;Amount&lt;/th&gt; 
    &lt;/tr&gt; 
    &lt;/thead&gt; 
    &lt;tbody&gt; 
    &lt;tr&gt; 
        &lt;td&gt;10:22&lt;/td&gt; 
        &lt;td&gt;Purchase&lt;/td&gt; 
        &lt;td&gt;$10.00&lt;/td&gt; 
    &lt;/tr&gt; 
    &lt;tr&gt; 
        &lt;td&gt;12:12&lt;/td&gt; 
        &lt;td&gt;Purchase&lt;/td&gt; 
        &lt;td&gt;$12.50&lt;/td&gt; 
    &lt;/tr&gt; 
    &lt;tr&gt; 
        &lt;td&gt;14:11&lt;/td&gt; 
        &lt;td&gt;Expense&lt;/td&gt; 
        &lt;td&gt;$9.70&lt;/td&gt; 
    &lt;/tr&gt; 
    &lt;/tbody&gt; 
&lt;/table&gt; 
 
&lt;script type="text/javascript"&gt; 
    var trSelection = d3.selectAll("tr"); // &lt;-- A 
    var headerElement = trSelection.nodes()[0]; // &lt;-- B 
    d3.select(headerElement).attr("class", "table-header"); // &lt;-     
    - C 
    var rows = trSelection.nodes(); 
    d3.select(rows[1]).attr("class", "table-row-odd"); // &lt;-- D 
    d3.select(rows[2]).attr("class", "table-row-even"); // &lt;-- E 
    d3.select(rows[3]).attr("class", "table-row-odd"); // &lt;-- F 
&lt;/script&gt; 
</pre><p>This recipe generates the following visual output:</p><p>
</p><div><img src="img/image_02_005.jpg" alt="How to do it..."/></div><p>
</p><p>Raw selection manipulation</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec43"/>How it works...</h2></div></div></div><p>In this example, we went through an existing HTML table to color the table. This is not intended to be a good example of how you would color odd versus even rows in a table using D3. Instead, this example is designed to show how raw selection array can be accessed.</p><div><div><h3 class="title"><a id="note25"/>Note</h3><p>A much better way to color odd and even rows in a table would be using the <code class="literal">each</code> function and then relying on the index parameter <code class="literal">i</code> to do the job.</p></div></div><p>On line <code class="literal">A</code>, we select all rows and store the selection in the <code class="literal">trSelection</code> variable. D3 selection has a convenient <code class="literal">node()</code> function that returns an array containing the selected element nodes. Thus, in order to access the first selected element, you will need to use <code class="literal">d3.selectAll("tr").nodes()[0]</code>, the second element can be accessed with <code class="literal">d3.selectAll("tr").nodes()[1]</code>, and so on. As we can see on line <code class="literal">B</code>, the table header element can be accessed using <code class="literal">trSelection.nodes()[0]</code> and this will return a DOM element object. Again, as we have demonstrated in previous sections, any DOM element can then be selected directly using <code class="literal">d3.select</code> as shown on line <code class="literal">C</code>. Line <code class="literal">D</code>, <code class="literal">E</code>, and <code class="literal">F</code> demonstrate how each element in selection can be directly indexed and accessed.</p><p>Raw selection access could be handy in some cases especially when you need to use D3 in partnership with other JavaScript libraries since other libraries won't be able to work with D3 selection but only with raw DOM elements.</p><div><div><h3 class="title"><a id="note26"/>Note</h3><p>Additionally, this approach is typically very useful in a testing environment where knowing the absolute index for each element quickly and gaining a reference to them could be convenient. We will cover unit tests in a later chapter in more detail.</p></div></div><p>In this chapter we covered many different ways of how HTML elements can be selected and manipulated using D3's selection API. In the next chapter, we will explore how data can be bound to such selection to dynamically drive the visual appearance of selected elements which is the fundamental step of data visualization.</p></div></div></div></div></body></html>