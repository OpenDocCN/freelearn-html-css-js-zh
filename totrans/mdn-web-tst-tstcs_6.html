<html><head></head><body>
		<div><h1 id="_idParaDest-78"><em class="italic"><a id="_idTextAnchor132"/>Chapter 6:</em> Refactoring with PageObjects</h1>
			<p>The main learning goal here will be to get familiar with how to upgrade a set of end-to-end tests (test suite) with a TestCafe role and the <code>PageObject</code> pattern. We will use <code>Role</code> to speed up the tests and will utilize <code>PageObjects</code> to achieve reduced code duplication and enhanced maintainability. By the end of this chapter, we will have a structured and optimized set of tests and know how to apply roles and <code>PageObject</code> patterns to any future projects.</p>
			<p>In this chapter, we're going to cover the following main topics:</p>
			<ul>
				<li>Adding a <code>Role</code> for logging in.</li>
				<li>Refactoring tests with <code>PageObjects</code>.</li>
				<li>Improving <code>PageObjects</code> with functions.</li>
			</ul>
			<h1 id="_idParaDest-79"><a id="_idTextAnchor133"/>Technical requirements</h1>
			<p>All the code examples for this chapter can be found on GitHub: <a href="https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/tree/master/ch6">https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/tree/master/ch6</a>.</p>
			<h1 id="_idParaDest-80"><a id="_idTextAnchor134"/>Adding a Role for logging in</h1>
			<p>As we already learned from <a href="B16280_02_Final_JM_ePub.xhtml#_idTextAnchor027"><em class="italic">Chapter 2</em></a>, <em class="italic">Exploring TestCafe under the Hood</em>, TestCafe has a built-in user role <a id="_idIndexMarker230"/>mechanism that emulates user actions for logging in to a website. The role mechanism saves the logged-in state of each user in a separate role that can then be reused in any part of your tests to switch between user accounts.</p>
			<p>So, let's start by adding a <code>Role</code> to optimize and speed up the logging-in process that we perform in each test:</p>
			<pre>const { Selector, ClientFunction, Role } = require('testcafe');// ...const regularUser = Role('http://demo.redmine.org/', async (t) =&gt; {    await t.click('.login')        .typeText('#username', `test_user_testcafe_ poc${randomDigits1}@sharklasers.com`)        .typeText('#password', 'test_user_testcafe_poc')        .click('[name="login"]');});</pre>
			<p>As you can see, we are using the login steps inside the <code>Role</code>. These steps will be executed when the <code>regularUser</code> role is called for the first time. Once the login steps are executed, the final (logged-in) state of the authentication cookie and browser storage will be saved and reused in each further call of the <code>regularUser</code> role (login steps will not be <a id="_idIndexMarker231"/>executed again, as a saved logged-in state will be applied). Now, let's use the <code>regularUser</code> role in the <code>Log out</code> test:</p>
			<pre>test('Log out', async (t) =&gt; {    await t.useRole(regularUser)        .click('.logout')        .expect(Selector('#loggedas').exists).notOk()        .expect(Selector('.login').exists).ok();});</pre>
			<p>Let's also replace the login steps with the <code>regularUser</code> role in the <code>beforeEach</code> blocks of all other fixtures:</p>
			<pre>// ...fixture('Redmine entities creation tests')    .page('http://demo.redmine.org/')    .beforeEach(async (t) =&gt; {        await t.useRole(regularUser);    });// ...fixture('Redmine entities editing tests')    .page('http://demo.redmine.org/')    .beforeEach(async (t) =&gt; {        await t.useRole(regularUser);    });// ...fixture('Redmine entities deletion tests')    .page('http://demo.redmine.org/')    .beforeEach(async (t) =&gt; {        await t.useRole(regularUser);    });// ...</pre>
			<p class="callout-heading">Note</p>
			<p class="callout">You can also review and download this file on GitHub: <a href="https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests18.js">https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests18.js</a>.</p>
			<p>Utilizing roles speeds up execution of the test and our test project becomes more structured and granular, which is a good approach to follow.</p>
			<p>As we have built our set of <a id="_idIndexMarker232"/>tests, improved them with setup, teardown, and roles, let's now make them even more effective and maintainable by refactoring with <code>PageObjects</code>.</p>
			<p>Refactoring tests with PageObjects</p>
			<p><code>PageObject</code> is a test <a id="_idIndexMarker233"/>automation pattern that gives you the <a id="_idIndexMarker234"/>option to create a separate file with selectors and functions that represent an abstraction of the tested page. This separate file can then be included and used in test code to refer to page elements.</p>
			<p>Note that our tests contain excessive code. For example, the <code>#top-menu .projects</code> CSS selector (https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests18.js#L62) is used in 22 lines of code - basically each time the test clicks on the <code>PageObjects</code> allow you to keep all selectors in one place, so the next time the web page changes, you will only need to modify the <code>PageObject</code> file.</p>
			<p>So, let's create a simple <code>redmine-page.js</code> file inside our <code>tests</code> folder. Open any shell, go to the <code>test-project</code> folder, and execute the following command:</p>
			<pre>$ touch tests/redmine-page.js</pre>
			<p>Now, open the <code>redmine-page.js</code> file in a code editor of your choice, add the code to declare the <code>linkProjects</code> selector inside the <code>redminePage</code> object, and <a id="_idIndexMarker235"/>then export this object:</p>
			<pre>let redminePage = {    linkProjects: '#top-menu .projects'};module.exports = redminePage;</pre>
			<p class="callout-heading">Note</p>
			<p class="callout">You can also review and download this file on GitHub: <a href="https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/redmine-page1.js">https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/redmine-page1.js</a>.</p>
			<p>So, we created a <code>redminePage</code> object with a <code>linkProjects</code> property containing a selector for this element. Now we need to include this object in our tests:</p>
			<pre>const { Selector, ClientFunction, Role } = require('testcafe');const { stamp } = require('js-automation-tools');const redminePage = require('./redmine-page.js');// ...</pre>
			<p>In addition to that, we will need to replace all occurrences of <code>#top-menu .projects</code> with a corresponding <code>PageObject</code> element. So, here is how the updated <code>Create a new project</code> test will appear:</p>
			<pre>test('Create a new project', async (t) =&gt; {    await t.click(redminePage.linkProjects)        .click('.icon-add')        .typeText('#project_name', `test_project${randomDigits1}`)        .click('[value="Create"]')        .expect(Selector('#flash_notice').innerText).eql('Successful creation.')        .expect(getPageUrl()).contains(`/projects/test_project${randomDigits1}/settings`);});</pre>
			<p class="callout-heading">Note</p>
			<p class="callout">You can also review and download this file with all the tests updated to use <code>redminePage.linkProjects</code> on GitHub: <a href="https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests19.js">https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests19.js</a>.</p>
			<p>Let's now move all <a id="_idIndexMarker236"/>constants with random digit generation to <code>redmine-page.js</code>, as all the strings that are using random digits will be <a id="_idIndexMarker237"/>moved to <code>redmine-page.js</code> too:</p>
			<pre>const { stamp } = require('js-automation-tools');const randomDigits1 = stamp.getTimestamp();const randomDigits2 = stamp.resetTimestamp();const randomDigits3 = stamp.resetTimestamp();const randomDigits4 = stamp.resetTimestamp();const randomDigits5 = stamp.resetTimestamp();const randomDigits6 = stamp.resetTimestamp();const randomDigits7 = stamp.resetTimestamp();const randomDigits8 = stamp.resetTimestamp();const randomDigits9 = stamp.resetTimestamp();</pre>
			<p>Now, let's move all selectors to the <code>redminePage</code> object inside <code>redmine-page.js</code>. We will start from the login credenti<a id="_idTextAnchor135"/>als:</p>
			<pre>let redminePage = {    urlRedmine: 'http://demo.redmine.org/',    emailRegularUser: `test_user_testcafe_poc${randomDigits1}@sharklasers.com`,    passwordRegularUser: 'test_user_testcafe_poc',</pre>
			<p>Now, let's <a id="_idIndexMarker238"/>add selectors for <a id="_idIndexMarker239"/>the page elements:</p>
			<pre>    linkLogin: '.<a id="_idTextAnchor136"/>login',    inputUsername: '#username',    inputPassword: '#password',    buttonLogin: '[name="login"]',    linkRegister: '.register',    inputUserLogin: '#user_login',    inputUserPassword: '#user_password',    inputUserPasswordConfirmation: '#user_password_confirmation',    inputUserFirstName: '#user_firstname',    inputUserLastName: '#user_lastname',    inputUserMail: '#user_mail',    buttonSubmit: '[value="Submit"]',    blockNotification: '#flash_notice',    blockLoggedAs: '#loggedas',    linkLogout: '.logout',    linkProjects: '#top-menu .projects',    iconAdd: '.icon-add',    inputProjectName: '#project_name',    buttonCreate: '[value="Create"]',    urlProjectSettings: `/projects/test_project${randomDigits1}/settings`,    link2TestProject: `[href*="/projects/test_project${randomDig<a id="_idTextAnchor137"/>its2}"]`,// ...</pre>
			<p>And finally, let's enhance the <code>redminePage</code> object with properties containing the text:</p>
			<pre>    textFirstNameRegularUser: 'test_user',    textLastNameRegularUser: 'testcafe_poc',    textAccountActivated: 'Your account has been activated. You can now log in.',    text1ProjectName: `test_project${randomDigits1}`,    text2ProjectName: `test_project${randomDigits2}`,// ...};module.exports = redminePage;</pre>
			<p class="callout-heading">Note</p>
			<p class="callout">You can also review and download this file on GitHub: <a href="https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/redmine-page2.js">https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/redmine-page2.js</a>.</p>
			<p>As you <a id="_idIndexMarker240"/>can see, the URLs such as <code>http://demo.redmine.org/</code>, and the notification text strings such as <code>'Your account has been activated. You can now log in.'</code> can <a id="_idIndexMarker241"/>be easily refactored with <code>PageObjects</code> too. </p>
			<p>No<a id="_idTextAnchor138"/>w, let's use <code>PageObject</code> elements in each of our tests. So, the updated <code>Redmine log in tests</code> fixture will look like this:</p>
			<pre>const { Selector, ClientFunction, Role } = require('testcafe');const redminePage = require('./redmine-page.js');const getPageUrl = ClientFunction(() =&gt; {    return window.location.href;});const regularUser = Role(redminePage.urlRedmine, async (t) =&gt; {    await t.click(redminePage.linkLogin)        .typeText(redminePage.inputUsername, redminePage.emailRegularUser)        .typeText(redminePage.inputPassword, redminePage.passwordRegularUser)        .click(redminePage.buttonLogin);});fixture('Redmine log in tests').page(redminePage.urlRedmine);</pre>
			<p>The <code>Create a new user</code> test with <code>PageObject</code> elements will look like this:</p>
			<pre>test('Create a new user', async (t) =&gt; {    await t.click(redminePage.linkRegister)        .typeText(redminePage.inputUserLogin, redminePage.emailRegularUser)        .typeText(redminePage.inputUserPassword, redminePage.passwordRegularUser)        .typeText(redminePage.inputUserPasswordConfirmation, redminePage.passwordRegularUser)        .typeText(redminePage.inputUserFirstName, redminePage.textFirstNameRegularUser)        .typeText(redminePage.inputUserLastName, redminePage.textLastNameRegularUser)        .typeText(redminePage.inputUserMail, redminePage.emailRegularUser)        .click(redminePage.buttonSubmit)        .expect(Selector(redminePage.blockNotification).innerText).eql(redminePage.textAccountActivated);});</pre>
			<p>The <code>Log in</code> and <code>Log out</code> tests will look like this:</p>
			<pre>test('Log in', async (t) =&gt; {    await t.click(redminePage.linkLogin)        .typeText(redminePage.inputUsername, redminePage.emailRegularUser)        .typeText(redminePage.inputPassword, redminePage.passwordRegularUser)        .click(redminePage.buttonLogin)        .expect(Selector(redminePage.blockLoggedAs).exists).ok();});test('Log out', async (t) =&gt; {    await t.useRole(regularUser)        .click(redminePage.linkLogout)        .expect(Selector(redminePage.blockLoggedAs).exists).notOk()        .expect(Selector(redminePage.linkLogin).exists).ok();});</pre>
			<p>Here is what <a id="_idIndexMarker242"/>the updated <code>Redmine entities creation tests</code> fixture <a id="_idIndexMarker243"/>will look like:</p>
			<pre>fixture('Redmine entities creation tests')    .page(redminePage.urlRedmine)    .beforeEach(async (t) =&gt; {        await t.useRole(regularUser);    });</pre>
			<p>The <code>Create a new project</code> and <code>Create a new issue </code>tests will look like this:</p>
			<pre>test('Create a new project', async (t) =&gt; {    await t.click(redminePage.linkProjects)        .click(redminePage.iconAdd)        .typeText(redminePage.inputProjectName, redminePage.text1ProjectName)        .click(redminePage.buttonCreate)        .expect(Selector(redminePage.blockNotification).innerText).eql(redminePage.textSuccessfulCreation)        .expect(getPageUrl()).contains(redminePage.         urlProjectSettings);});test('Create a new issue', async (t) =&gt; {    await t.click(redminePage.linkProjects)        .click(redminePage.iconAdd)        .typeText(redminePage.inputProjectName, redminePage.text2ProjectName)        .click(redminePage.buttonCreate)        .click(redminePage.linkProjects)        .click(redminePage.link2TestProject)        .click(redminePage.linkNewIssue)        .typeText(redminePage.inputIssueSubject, redminePage.text2IssueName)        .typeText(redminePage.inputIssueDescription, redminePage.text2IssueDescription)        .click(redminePage.dropdownIssuePriority)        .click(Selector(redminePage.optionIssuePriority).withText(redminePage.textHigh))        .click(redminePage.buttonCreate)        .expect(Selector(redminePage.blockNotification).innerText).contains(redminePage.textCreated);});</pre>
			<p class="callout-heading">Note</p>
			<p class="callout">You can also review and download this file with all the tests updated to use <code>PageObjects</code> on GitHub: <a href="https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests20.js">https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests20.js</a>.</p>
			<p>In this section, we <a id="_idIndexMarker244"/>learned how to enhance tests with <code>PageObjects</code> and refactored <a id="_idIndexMarker245"/>our test project accordingly. Now, let's improve maintainability of the tests even further by adding functions to <code>PageObject</code>.</p>
			<p>Improving PageObjects with functions</p>
			<p>As we can observe in <code>redmine-page.js</code>, some of the properties inside <code>PageObject</code> still contain <a id="_idIndexMarker246"/>some repetitive code. Let's <a id="_idIndexMarker247"/>optimize our <code>PageObject</code> even more by moving such repetitive code into the separate functions:</p>
			<pre>// ...const createButtonSelector = (text) =&gt; {    return `[value="${text}"]`;};const createLinkTestProjectSelector = (randomDigits) =&gt; {    return `[href*="/projects/test_project${randomDigits}"]`;};const createProjectNameText = (randomDigits) =&gt; {    return `test_project${randomDigits}`;};const createIssueNameText = (randomDigits) =&gt; {    return `Test issue ${randomDigits}`;};const createIssueDescriptionText = (randomDigits) =&gt; {    return `Test issue description ${randomDigits}`;};const createIssueNameUpdatedText = (randomDigits) =&gt; {    return `Issue ${randomDigits} updated`;};redminePage.buttonLogin = createButtonSelector('Login »');redminePage.buttonSubmit = createButtonSelector('Submit');redminePage.buttonCreate = createButtonSelector('Create');redminePage.buttonAdd = createButtonSelector('Add');</pre>
			<p>Note that the <code>buttonLogin</code> selector was updated. Previously, it was <code>[name="login"]</code>, but now, the <code>createButtonSelector</code> function will return it as <code>[value="Login »"]</code>. This was done to generalize our selector's generation, so now the <code>buttonLogin</code> selector is created with the same <code>createButtonSelector</code> function as all the other button elements.</p>
			<p>Let's now generate a group of selectors for the test project links:</p>
			<pre>redminePage.link2TestProject = createLinkTestProjectSelector(randomDigits2);redminePage.link3TestProject = createLinkTestProjectSelector(randomDigits3);redminePage.link4TestProject = createLinkTestProjectSelector(randomDigits8);redminePage.link5TestProject = createLinkTestProjectSelector(randomDigits4);redminePage.link6TestProject = createLinkTestProjectSelector(randomDigits5);redminePage.link7TestProject = createLinkTestProjectSelector(randomDigits6);redminePage.link8TestProject = createLinkTestProjectSelector(randomDigits7);redminePage.link9TestProject = createLinkTestProjectSelector(randomDigits9);</pre>
			<p>Now, let's <a id="_idIndexMarker248"/>generate a group of texts for the test project <a id="_idIndexMarker249"/>name:</p>
			<pre>redminePage.text1ProjectName = createProjectNameText(randomDigits1);redminePage.text2ProjectName = createProjectNameText(randomDigits2);redminePage.text3ProjectName = createProjectNameText(randomDigits3);redminePage.text4ProjectName = createProjectNameText(randomDigits8);redminePage.text5ProjectName = createProjectNameText(randomDigits4);redminePage.text6ProjectName = createProjectNameText(randomDigits5);redminePage.text7ProjectName = createProjectNameText(randomDigits6);redminePage.text8ProjectName = createProjectNameText(randomDigits7);redminePage.text9ProjectName = createProjectNameText(randomDigits9);</pre>
			<p>Finally, let's <a id="_idIndexMarker250"/>generate a group of object properties that will contain texts for the issue name (for example, <code>Test issue 1598717241841</code>) and issue <a id="_idIndexMarker251"/>description (for example, <code>Test issue description 1598717241841</code>):</p>
			<pre>redminePage.text2IssueName = createIssueNameText(randomDigits2);redminePage.text3IssueName = createIssueNameText(randomDigits3);redminePage.text5IssueName = createIssueNameText(randomDigits4);redminePage.text6IssueName = createIssueNameText(randomDigits5);redminePage.text7IssueName = createIssueNameText(randomDigits6);redminePage.text8IssueName = createIssueNameText(randomDigits7);redminePage.text2IssueDescription = createIssueDescriptionText(randomDigits2);redminePage.text3IssueDescription = createIssueDescriptionText(randomDigits3);redminePage.text5IssueDescription = createIssueDescriptionText(randomDigits4);redminePage.text6IssueDescription = createIssueDescriptionText(randomDigits5);redminePage.text7IssueDescription = createIssueDescriptionText(randomDigits6);redminePage.text8IssueDescription = createIssueDescriptionText(randomDigits7);redminePage.text5IssueNameUpdated = createIssueNameUpdatedText(randomDigits4);redminePage.text6IssueNameUpdated = createIssueNameUpdatedText(randomDigits5);module.exports = redminePage;</pre>
			<p class="callout-heading">Note</p>
			<p class="callout">You can also review and download this file with <code>PageObject</code> functions: https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/redmine-page3.js, and the corresponding file with tests: https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests21.js.</p>
			<p>So, now <a id="_idIndexMarker252"/>we have functions to create groups of similar selectors and texts. This technique is ultimately <a id="_idIndexMarker253"/>useful as a group of similar elements can be edited in one place by changing the corresponding function that creates them.</p>
			<p>Summary</p>
			<p>In this chapter, we explored how to use <code>Role</code> when logging in to speed up test execution, refactored the tests with <code>PageObject</code>, and improved <code>PageObject</code> with functions. Now we have a fast set of tests that are easy to maintain and expand upon (should that be necessary in the future). This knowledge can be utilized to refactor the existing tests, or to build a new robust and easy-to-maintain set of automated tests.</p>
			<p>In the next chapter, we will wrap up the test project and have a quick peek int<a id="_idTextAnchor139"/>o the future of TestCafe.</p>
		</div>
	</body></html>