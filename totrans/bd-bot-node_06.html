<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;BotKit &#x2013; Document Manager Agent for Slack"><div class="titlepage" id="aid-164MG2"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. BotKit – Document Manager Agent for Slack</h1></div></div></div><p>In <a class="link" title="Chapter 4.  A Slack Quote Bot" href="part0032.xhtml#aid-UGI01">
Chapter 4
</a>, <span class="emphasis"><em>A Slack Quote Bot</em></span>, we saw how Slack is a great collaboration platform. While collaborating, teams can get the inspirational quotes from <span class="emphasis"><em>They Said So</em></span> services right in their Slack channels. In this chapter, we will see a use case for Slack that's a little more complex than just getting quotes. Here, we will be building a Slack bot called DocMan bot with the help of <span class="strong"><strong>Howdy BotKit</strong></span>. DocMan bot should be able to search document(s) and also provide a link to download them, based on team members' requests.</p><p>Our Slack bot, DocMan, will be built using MongoDB for data storage and Amazon S3 for research document or file storage. Details about MongoDB and Amazon S3 storage will be detailed in the following sections of this chapter.</p><p>Awesome!! Let's Slack now.</p><div class="section" title="Setting up a Slack for your team"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec32"/>Setting up a Slack for your team</h1></div></div></div><p>In this section, we will start setting up Slack for a team.</p><p>Open the browser window and enter the URL--<a class="ulink" href="https://slack.com">
https://slack.com
</a>. This will launch the Slack home page as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00278.jpeg" alt="Setting up a Slack for your team"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>For users who are accessing Slack for the first time, you will first have to create your Slack account and then you can create your team. Users who are already on Slack can click on the <span class="strong"><strong>Sign in</strong></span> link. Let's look at how to create our own account.</p><p>Provide your e-mail address at <span class="strong"><strong>Email address</strong></span>. Click on the <span class="strong"><strong>Create New Team</strong></span> link to launch the next step, as shown in the following screenshot. Slack will send a confirmation code to your e-mail id. Enter the received code.</p><p>
</p><div class="mediaobject"><img src="../Images/image00279.jpeg" alt="Setting up a Slack for your team"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Enter your confirmation code. The code will be verified by Slack and then the following screen will be launched:</p><p>
</p><div class="mediaobject"><img src="../Images/image00280.jpeg" alt="Setting up a Slack for your team"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Provide your name and username in the fields <span class="strong"><strong>Your name</strong></span> and <span class="strong"><strong>Username,</strong></span> and click on the <span class="strong"><strong>Continue to Password</strong></span> button to launch the following screen:</p><p>
</p><div class="mediaobject"><img src="../Images/image00281.jpeg" alt="Setting up a Slack for your team"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Provide your password at <span class="strong"><strong>Password</strong></span> and click on the <span class="strong"><strong>Continue to Team Info</strong></span> button to launch the following screen:</p><p>
</p><div class="mediaobject"><img src="../Images/image00282.jpeg" alt="Setting up a Slack for your team"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Choose the options that match your team's purposes and intentions in the <span class="strong"><strong>What will your team use Slack for?</strong></span> and <span class="strong"><strong>How big is your shared interest group?</strong></span> dropdowns. Click on the <span class="strong"><strong>Continue to Group Name</strong></span> button to launch the following screen:</p><p>
</p><div class="mediaobject"><img src="../Images/image00283.jpeg" alt="Setting up a Slack for your team"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>I wanted to name my team Bot Researchers, so I entered the name as <span class="strong"><strong>Bot Researchers</strong></span> in the <span class="strong"><strong>Group Name</strong></span> entry field and clicked on the <span class="strong"><strong>Continue to Team Domain</strong></span> button to launch the following screen:</p><p>
</p><div class="mediaobject"><img src="../Images/image00284.jpeg" alt="Setting up a Slack for your team"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Slack verifies the domain name availability for your team. If it is available, then it shows a message saying so, as shown in the preceding screenshot. Now click on the <span class="strong"><strong>Create Team</strong></span> button.</p><p>The next screen is <span class="strong"><strong>Send Invitations</strong></span>, which I will be skipping for now, going straight to the welcome screen for the Bot Researchers Slack team. The screen will appear as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00285.jpeg" alt="Setting up a Slack for your team"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>In the preceding screenshot, you might have noticed the name <span class="strong"><strong>slackbot</strong></span>. Slack uses a bot named slackbot to greet us and help us in case of any questions. This is a wonderful use of bots to educate users in the chatting window itself.</p><p>We have now signed up with Slack and created our own team. Now we will develop our bot for this team.</p><div class="section" title="Setting up a Slack bot"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec24"/>Setting up a Slack bot</h2></div></div></div><p>As a botresearcher group member, I would like my bot to provide information about all bot-related documents. This bot is called <span class="strong"><strong>DocMan</strong></span>. Now, to create a new bot in Slack, just visit the website found at <a class="ulink" href="https://botresearchers.slack.com/services/new/bot">
https://botresearchers.slack.com/services/new/bot
</a>.</p><p>Make sure you are already logged in to your Slack group. Here I have logged in to my group, <a class="ulink" href="https://botresearchers.slack.com">
https://botresearchers.slack.com
</a>. Since you are already logged in, this will navigate to the <span class="strong"><strong>Bots</strong></span> | <span class="strong"><strong>New Configuration</strong></span> screen, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00286.jpeg" alt="Setting up a Slack bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Let's enter the <span class="strong"><strong>Username</strong></span> as <code class="literal">@docman</code> and then click on the <span class="strong"><strong>Add bot integration</strong></span> button. Slack will ask for additional configuration information for this bot, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00287.jpeg" alt="Setting up a Slack bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Look at the <span class="strong"><strong>API Token</strong></span> section, under <span class="strong"><strong>Integration Settings</strong></span>. Our bot will use this token to communicate with APIs.</p><p>The bot user token can connect to real-time streaming APIs and can perform activities, such as posting messages, so the distribution of this token should be avoided in public code repositories.</p><p>Refer to the following screenshot. You can enter the parameters of this bot's behavior within Slack channels in the <span class="strong"><strong>What this bot does</strong></span> entry field:</p><p>
</p><div class="mediaobject"><img src="../Images/image00288.jpeg" alt="Setting up a Slack bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Here, I have entered <span class="strong"><strong>Provides Information and Documents about Bot Research</strong></span>.</p><p>Now click the <span class="strong"><strong>Save Integration</strong></span> button to save the configuration information of our bot. The information will be saved and the user will be notified at the top of the screen.</p><p>Now let's go back to our group by using the URL <a class="ulink" href="https://botresearchers.slack.com/messages">
https://botresearchers.slack.com/messages
</a>. You will see <span class="strong"><strong>docman</strong></span> under the <span class="strong"><strong>DIRECT MESSAGES</strong></span> section. Click on the name <span class="strong"><strong>docman</strong></span> to see a chat message screen, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00289.jpeg" alt="Setting up a Slack bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Now, our bot is showing its username as <span class="strong"><strong>@docman</strong></span> and the description as <span class="strong"><strong>Provides Information and Documents about Bot Research</strong></span>. We provided this information during its configuration. At the moment, this bot will not respond to any of our messages as it is not programmed yet. Also, the status of the bot is set to <span class="strong"><strong>away</strong></span>.</p><p>To summarize so far, we have created our own Slack group and created our own Slack bot. We also looked at how to configure this bot. In the next section, we will see how we can wire up some intelligence to our bare bones bot.</p></div><div class="section" title="Botkit and Slack"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec25"/>Botkit and Slack</h2></div></div></div><p>
<span class="strong"><strong>Botkit</strong></span> is a free to use, open source toolkit from <span class="strong"><strong>Howdy</strong></span> (<a class="ulink" href="https://howdy.ai/botkit">https://howdy.ai/botkit</a>) for integrating bots with messaging platforms such as Slack. Botkit comes with lots of features that help developers build both types of bot integrations, for individual teams as well as for other teams using <span class="emphasis"><em>Slack Button</em></span>.</p></div><div class="section" title="Creating our first Slack bot using Botkit and Node.js"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec26"/>Creating our first Slack bot using Botkit and Node.js</h2></div></div></div><p>Let's start wiring up our bot in Node.js by first installing Botkit.</p><p>Let's start by creating a folder in our local drive in order to store our Bot from the Command Prompt:</p><pre class="programlisting">
<span class="strong"><strong>mkdir slackbot</strong></span>
<span class="strong"><strong>cd slackbot</strong></span>
</pre><p>Assuming we have Node.js and NPM installed, let's create and initialize our <code class="literal">package.json</code>, which will store our Bot's dependencies and definitions:</p><pre class="programlisting">
<span class="strong"><strong>npm init</strong></span>
</pre><p>Once you go through the <code class="literal">npm init</code> options (which are very easy to follow), you'll see something similar to the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00290.jpeg" alt="Creating our first Slack bot using Botkit and Node.js"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>You'll see the result in your project folder; this is your <code class="literal">package.json</code> file:</p><p>
</p><div class="mediaobject"><img src="../Images/image00291.jpeg" alt="Creating our first Slack bot using Botkit and Node.js"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Let's install the <code class="literal">botkit</code> package from NPM. This can be located at <a class="ulink" href="https://www.npmjs.com/package/botkit">
https://www.npmjs.com/package/botkit
</a>.</p><p>In order to install it, run this <code class="literal">npm</code> command:</p><pre class="programlisting">
<span class="strong"><strong>npm install --save botkit</strong></span>
</pre><p>You should then see something similar to this:</p><p>
</p><div class="mediaobject"><img src="../Images/image00292.jpeg" alt="Creating our first Slack bot using Botkit and Node.js"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Having done this, the next thing to do is to update your <code class="literal">package.json</code> in order to include the <code class="literal">"engines"</code> attribute. Open the <code class="literal">package.json</code> file with a text editor and update it as follows:</p><pre class="programlisting">"engines": { &#13;
    "node": "&gt;=5.6.0" &#13;
} &#13;
</pre><p>Your <code class="literal">package.json</code> should then look like this:</p><p>
</p><div class="mediaobject"><img src="../Images/image00293.jpeg" alt="Creating our first Slack bot using Botkit and Node.js"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Let's create our <code class="literal">app.js</code> file, which will be the entry point for our bot, as mentioned while setting up our node package.</p><p>Our <code class="literal">app.js</code> should like the following code snippet:</p><pre class="programlisting">var Botkit = require('Botkit'); &#13;
var os = require('os'); &#13;
 &#13;
var controller = Botkit.slackbot({ &#13;
    debug: false, &#13;
}); &#13;
 &#13;
var bot = controller.spawn({ &#13;
    token: "&lt;SLACK_BOT_TOKEN&gt;" &#13;
}).startRTM(); &#13;
 &#13;
controller.hears('hello',['direct_message','direct_mention','mention'],function(bot,message) { &#13;
  bot.reply(message,'Hello there!'); &#13;
}); &#13;
</pre><p>Remember, our bot DocMan is still not active, and its status is away, which we have seen in our Slack group.</p><p>Now let's run our Node.js program to see how it looks in Slack, and start our basic conversations with our bot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00294.jpeg" alt="Creating our first Slack bot using Botkit and Node.js"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Now, if you look at the console, you will see, with the help of the token, that our bot has started communicating with Real-Time Messaging APIs through a websocket.</p><p>Let's look at our Slack group now. Our Slack group will now show our bot <span class="strong"><strong>@docman</strong></span> under <span class="strong"><strong>DIRECT MESSAGES</strong></span> with an active status, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00295.jpeg" alt="Creating our first Slack bot using Botkit and Node.js"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Now our bot is ready for conversation. Let's say <code class="literal">Hello</code> to our bot and see what it says:</p><p>
</p><div class="mediaobject"><img src="../Images/image00296.jpeg" alt="Creating our first Slack bot using Botkit and Node.js"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Our bot has responded to our message with <span class="strong"><strong>Hello there!</strong></span> So the wiring up of our bot within Node.js and Botkit with Real-Time Messaging APIs has worked.</p><p>Now I want my bot to be part of the #general channel, which is the default for our group. Enter the name <code class="literal">@docman</code> in the messaging box and hit enter. Immediately <span class="strong"><strong>slackbot</strong></span> will guide us to invite <code class="literal">@docman</code> in the #general channel, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00297.jpeg" alt="Creating our first Slack bot using Botkit and Node.js"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Click on the <span class="strong"><strong>invite them to join </strong></span>link to join our bot in this channel. On the popup, just click on the <span class="strong"><strong>Yes, invite </strong></span>them button. Refer to the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00298.jpeg" alt="Creating our first Slack bot using Botkit and Node.js"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>After inviting them, the Slack channel <span class="strong"><strong>#general</strong></span> will show a notification that our bot has joined the group, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00299.jpeg" alt="Creating our first Slack bot using Botkit and Node.js"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>This way you can invite our bot to any of the channels, and you can also start conversations with our bot in that channel just by mentioning the name of our bot. I mentioned the name of our bot with a message reading <span class="strong"><strong>@docman Hello</strong></span> in the <span class="strong"><strong>#general</strong></span> channel. Our bot's reply can be seen as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00300.jpeg" alt="Creating our first Slack bot using Botkit and Node.js"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></div><div class="section" title="Enhancing our DocMan bot"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec27"/>Enhancing our DocMan bot</h2></div></div></div><p>Having built a very basic Slack bot, let's enhance our <span class="strong"><strong>DocMan</strong></span> bot. Say that, following a team member's request, DocMan bot should be able to search a particular document and also be able to provide a link to download.</p><p>Let me explain how this will work. The Bot Researchers Slack team members will be communicating within their respective Slack channels. Now let's assume that one of them needs information about a research planning checklist document. The team member will enter some keywords like <code class="literal">Research Planning</code> or <code class="literal">Checklist</code> or <code class="literal">Template</code> by mentioning our bot's name. DocMan will do a keyword search within the MongoDB database and will present the searched documents. MongoDB will only have links to these documents and other metadata or attributes for the documents that will be searched. Actual documents will be stored in Amazon S3 storage.</p><p>Before going into the details, let me explain a little about MongoDB and Amazon S3 storage.</p><div class="section" title="What is MongoDB?"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec0"/>What is MongoDB?</h3></div></div></div><p>Day by day, the use of NoSQLs is skyrocketing. MongoDB is one such NoSQL. There are various NoSQL database types, such as <code class="literal">Document Store</code>, <code class="literal">Key-Value Store</code>, <code class="literal">Column Store</code>, and<code class="literal"> Graph Store</code>, to name but a few,.</p><p>MongoDB is of the Document Store type of NoSQLs, where data is stored in JSON documents. In short, MongoDB is an open source, highly scalable, high-performance NoSQL database.</p><p>The reason I am using MongoDB is because I wanted to show you how we can use a NoSQL database like MongoDB to search and store the document links using their metadata or attribute values. However, don't get confused between the documents or files that we are searching and the material that MongoDB is storing. What MongoDB is storing is just like a single record which is in JSON format. Just like our relational databases where data is stored in tables and records, MongoDB stores data in collections and JSON documents. Actual documents or files will be stored on Amazon S3, and only the link will be stored in MongoDB.</p><p>For our DocMan bot's enhancements, make sure you have installed MongoDB on your machine based on your machine's version (32 bit or 64 bit). Detailed installation steps can be obtained from <a class="ulink" href="https://docs.mongodb.com/manual/administration/install-community/">
https://docs.mongodb.com/manual/administration/install-community/
</a>.</p></div><div class="section" title="MongoDB database for our DocMan bot"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec1"/>MongoDB database for our DocMan bot</h3></div></div></div><p>Assuming you have MongoDB up and running on your machine, let's set up a database with sample data for our bot using the following steps.</p><div class="section" title="MongoDB shell"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl4sec0"/>MongoDB shell</h4></div></div></div><p>Locate the <code class="literal">bin</code> directory of your MongoDB installation using the Command Prompt and run the MongoDB shell using <code class="literal">mongo.exe</code>. If everything goes well, you will see the following screen:</p><p>
</p><div class="mediaobject"><img src="../Images/image00301.jpeg" alt="MongoDB shell"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></div><div class="section" title="Create a database"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl4sec1"/>Create a database</h4></div></div></div><p>Let's create a new database called <code class="literal">BotDB</code> using the command shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00302.jpeg" alt="Create a database"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Now, to verify whether or not the database has been created, use the <code class="literal">show dbs</code> command. You will see the name <code class="literal">BotDB</code> in the list, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00303.jpeg" alt="Create a database"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></div><div class="section" title="Create a reference documents collection"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl4sec2"/>Create a reference documents collection</h4></div></div></div><p>To store documents, metadata, and attributes, let's create a collection called <code class="literal">ReferenceDocuments</code> using the following command:</p><pre class="programlisting">
<span class="strong"><strong>db.createCollection("ReferenceDocuments")</strong></span>
</pre><p>You can verify a newly created collection with the help of the <code class="literal">show collections</code> command, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00304.jpeg" alt="Create a reference documents collection"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></div><div class="section" title="Create data for our DocMan bot"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl4sec3"/>Create data for our DocMan bot</h4></div></div></div><p>Our <code class="literal">BotResearcher</code> group needs some documents and templates for their day to day use. These documents can be seen in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00305.jpeg" alt="Create data for our DocMan bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>As a sample, I will use the <code class="literal">Research Planning Checklist</code> to show how we will store the metadata for this document in a MongoDB collection. Refer to the following JSON code for the metadata of this document:</p><pre class="programlisting">{ &#13;
   "title": "Research Planning Checklist", &#13;
   "description": "This excel sheet provides guidelines for better research plan...", &#13;
   "version": "1.1", &#13;
   "url": "&lt;Document URL goes here...&gt;", &#13;
   "keywords": ["Plan","Research Plan","Checklist","SWOT"] &#13;
} &#13;
</pre><p>We will be storing the <code class="literal">title</code>, <code class="literal">description</code>, <code class="literal">version</code>, <code class="literal">url</code>, and keywords in our <code class="literal">ReferenceDocuments</code> collection using the following command:</p><pre class="programlisting">
<span class="strong"><strong>&gt;db.ReferenceDocuments.insert({</strong></span>
<span class="strong"><strong>"title": "Research Planning Checklist","description": "This excel sheet provides guidelines for better research plan...","version": "1.1","url": "&lt;Document URL goes here...&gt;","keywords": ["Plan","Research Plan","Checklist","SWOT"] })</strong></span>
</pre><p>After inserting the preceding record, you will see the following message as <code class="literal">WriteResult({"nInserted":1})</code>:</p><p>
</p><div class="mediaobject"><img src="../Images/image00306.jpeg" alt="Create data for our DocMan bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>This way, we can create all the records in MongoDB for all our documents.</p></div><div class="section" title="Indexing for search"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl4sec4"/>Indexing for search</h4></div></div></div><p>Since a document can be searched using multiple keywords, we are storing keywords in an array for a document. When team members search documents, they will use keywords. We will apply an index to these keywords using the following command:</p><pre class="programlisting">
<span class="strong"><strong>&gt;db.ReferenceDocuments.createIndex({keywords:"text"})</strong></span>
</pre><p>After running a command, you will see the following output:</p><p>
</p><div class="mediaobject"><img src="../Images/image00307.jpeg" alt="Indexing for search"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></div><div class="section" title="Search query"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl4sec5"/>Search query</h4></div></div></div><p>Once our index has been created, let's verify whether or not our search is working based on the keywords we enter. Let's fire the following command on the MongoDB shell:</p><pre class="programlisting">
<span class="strong"><strong>db.ReferenceDocuments.find({$text:{$search:"template"}},{limit:3})</strong></span>
</pre><p>After executing the <code class="literal">search</code> query, you should see the following result:</p><p>
</p><div class="mediaobject"><img src="../Images/image00308.jpeg" alt="Search query"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>To summarize, we created a new database for our bot to store the metadata of the documents that it searches. We added a new collection and added some sample documents. We also applied a text index to the keywords column so as to enable a search using keywords.</p><p>Now let's look at how we can wire up our database with Node.js.</p></div></div><div class="section" title="What is MongoJS?"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec2"/>What is MongoJS?</h3></div></div></div><p>MongoJS is a Node.JS library used to connect to MongoDB APIs. Using this library, we will establish a connection with our MongoDB database and query documents based on input keywords.</p></div><div class="section" title="Wiring up DocMan bot with MongoDB"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec3"/>Wiring up DocMan bot with MongoDB</h3></div></div></div><p>Let's go back to our <code class="literal">Slackbot</code> directory and install the <code class="literal">mongojs</code> package from NPM. This can be located at <a class="ulink" href="https://www.npmjs.com/package/mongojs">
https://www.npmjs.com/package/mongojs
</a>.</p><p>In order to install it, run this <code class="literal">npm</code> command:</p><pre class="programlisting">
<span class="strong"><strong>npm install mongojs</strong></span>
</pre><p>You should then see something similar to this:</p><p>
</p><div class="mediaobject"><img src="../Images/image00309.jpeg" alt="Wiring up DocMan bot with MongoDB"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Let's modify our <code class="literal">app.js</code> file so that we can access MongoDB APIs through the <code class="literal">Mongojs</code> library.</p><p>Our <code class="literal">app.js</code> should be like this:</p><pre class="programlisting">var Botkit = require('Botkit'); &#13;
var os = require('os'); &#13;
 &#13;
var mongojs = require('mongojs'); &#13;
var db = mongojs('127.0.0.1:27017/BotDB',['ReferenceDocuments']); &#13;
 &#13;
var controller = Botkit.slackbot({ &#13;
    debug: false &#13;
}); &#13;
 &#13;
var bot = controller.spawn({ &#13;
    token: "&lt;SLACK_BOT_TOKEN&gt;" &#13;
}).startRTM(); &#13;
 &#13;
controller.hears('hello',['direct_message','direct_mention','mention'],function(bot,message) { &#13;
  bot.reply(message,'Hello there!'); &#13;
 &#13;
  db.ReferenceDocuments.find({title:"Newsletter Template"},function (err, docs) { &#13;
     bot.reply(message,'I have a document with title:'+ docs[0].title); &#13;
  }) &#13;
   &#13;
}); &#13;
</pre><p>Let's look at this basic code with <code class="literal">mongojs</code> wired up as shown in the preceding code snippet. We connect to the MongoDB database through <code class="literal">mongojs</code> using the following lines:</p><pre class="programlisting">var mongojs = require('mongojs'); &#13;
var db = mongojs('127.0.0.1:27017/BotDB',['ReferenceDocuments']); &#13;
</pre><p>Here, MongoDB is hosted locally on my machine, so the host used is named as <code class="literal">127.0.0.1</code> and it listens to port <code class="literal">27017</code>. This IP address and port can be different for your machine, so while implementing your bots, make sure you use your machine's IP address and port for MongoDB. Within MongoDB, we connect to the <code class="literal">BotDB</code> database and a collection called <code class="literal">ReferenceDocuments</code>.</p><p>To query one of the documents from <code class="literal">ReferenceDocuments</code>, the following code is used:</p><pre class="programlisting">db.ReferenceDocuments.find({title:"Newsletter Template"},function (err, docs) { &#13;
     bot.reply(message,'I have a document with title:'+ docs[0].title); &#13;
  }) &#13;
</pre><p>Let's run the modified code:</p><p>
</p><div class="mediaobject"><img src="../Images/image00310.jpeg" alt="Wiring up DocMan bot with MongoDB"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Go back to our Bot Researchers Slack group and say <code class="literal">hello</code> to our modified docman using direct messaging. You can also send mentions to docman as well, but this time I will use direct messaging.</p><p>When I messaged the <code class="literal">hello</code> directly to <span class="strong"><strong>docman</strong></span>, docman queried the <code class="literal">BotDB</code> database and returned the title of one of the documents from the <code class="literal">ReferenceDocuments</code> collection. Refer to the following screenshot for further details:</p><p>
</p><div class="mediaobject"><img src="../Images/image00311.jpeg" alt="Wiring up DocMan bot with MongoDB"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>This shows how we can establish a MongoDB connectivity and query the data using <code class="literal">mongojs</code>.</p></div><div class="section" title="Amazon S3 storage"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec4"/>Amazon S3 storage</h3></div></div></div><p>
<span class="strong"><strong>Amazon Simple Storage Service</strong></span> (<span class="strong"><strong>Amazon S3</strong></span>) is a cloud-based data storage system from <span class="strong"><strong>Amazon Web Services</strong></span> (<span class="strong"><strong>AWS</strong></span>). We can use Amazon S3 to store any amount of data. Amazon S3 stores data as objects within buckets. An object can be a document or a file. In our DocMan context, all the actual documents or files that are searched by Bot Researchers team members are stored in Amazon S3. In future, these files or documents can be of any types, such as media or office files of any size. Also, every bucket can have access control to decide who can access, delete, and create objects from the buckets. Given these requirements, Amazon S3 is suitable for our DocMan documents storage.</p><div class="section" title="Amazon S3 console"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl4sec6"/>Amazon S3 console</h4></div></div></div><p>I have my Amazon AWS account. Using that account, I have logged in to my Amazon S3 console. This console can be seen in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00312.jpeg" alt="Amazon S3 console"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Those who are new to AWS can refer to the information at <a class="ulink" href="https://aws.amazon.com/">
https://aws.amazon.com/
</a>.</p></div><div class="section" title="Create buckets"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl4sec7"/>Create buckets</h4></div></div></div><p>From the preceding Amazon S3 console, click on the <span class="strong"><strong>Create Bucket</strong></span> button to launch a <span class="strong"><strong>Create a Bucket</strong></span> screen, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00313.jpeg" alt="Create buckets"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>In creating my bucket, I have given the <span class="strong"><strong>Bucket Name</strong></span> as <span class="strong"><strong>botdocuments</strong></span> and selected the <span class="strong"><strong>Region</strong></span> as <span class="strong"><strong>Oregon</strong></span>. Make sure you are entering the <span class="strong"><strong>Bucket Name</strong></span> in lowercase letters. Click on the <span class="strong"><strong>Create</strong></span> button to create your bucket.</p><p>Your bucket will be shown under the <span class="strong"><strong>All Buckets</strong></span> table:</p><p>
</p><div class="mediaobject"><img src="../Images/image00314.jpeg" alt="Create buckets"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Now click on the bucket name shown under the <span class="strong"><strong>Name</strong></span> column so that we can display a bucket view to upload and manage documents inside this bucket.</p></div><div class="section" title="Store documents in the bucket"><div class="titlepage"><div><div><h4 class="title"><a id="ch06lvl4sec8"/>Store documents in the bucket</h4></div></div></div><p>Once you select the bucket name from the <span class="strong"><strong>All Buckets</strong></span> view, you will see the following screen:</p><p>
</p><div class="mediaobject"><img src="../Images/image00315.jpeg" alt="Store documents in the bucket"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Now, to upload documents in this bucket, click on the <span class="strong"><strong>Upload</strong></span> button and upload documents with the help of the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00316.jpeg" alt="Store documents in the bucket"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>I will use the drag and drop function to upload my files. Once you have dragged and dropped all the files that you want to upload, click on <span class="strong"><strong>Start Upload</strong></span> to upload your files. Once all the files are uploaded, the bucket will show all the files as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00317.jpeg" alt="Store documents in the bucket"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></div></div><div class="section" title="Mark documents as public"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec5"/>Mark documents as public</h3></div></div></div><p>Just for demonstration purposes, we will be marking these documents as public.</p><p>This way, our <code class="literal">BotResearchers</code> group can access and download these documents from Amazon S3 storage easily. Let's go through the following steps to mark one of these documents as public. .</p><p>Select a document and, from <span class="strong"><strong>Actions</strong></span>, select the <span class="strong"><strong>Make Public</strong></span> option in the menu:</p><p>
</p><div class="mediaobject"><img src="../Images/image00318.jpeg" alt="Mark documents as public"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>This option will mark the selected document as public. Now we need a public URL so that we can update this URL in our MongoDB database for this document. To get the public URL again, select a document and, from the <span class="strong"><strong>Actions</strong></span> menu, select the <span class="strong"><strong>Properties</strong></span> menu item.</p><p>This will bring up all the properties for the selected document, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00319.jpeg" alt="Mark documents as public"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>From the properties, refer to the <span class="strong"><strong>Link</strong></span> property. This is our public URL for the document.</p><p>In this way, mark all the documents as public and copy their URLs. Update these URLs to our MongoDB database.</p></div><div class="section" title="Update MongoDB data with Amazon S3 document links"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec6"/>Update MongoDB data with Amazon S3 document links</h3></div></div></div><p>Let's open up our Mongo shell again and select <code class="literal">BotDB</code> again using the following command:</p><pre class="programlisting">
<span class="strong"><strong>Use BotDB</strong></span>
<span class="strong"><strong>db.ReferenceDocuments.update(</strong></span>
<span class="strong"><strong>   { title: "Competitive analysis using SWOT"},</strong></span>
<span class="strong"><strong>   { $set:</strong></span>
<span class="strong"><strong>      {</strong></span>
<span class="strong"><strong>        url: "&lt;YOUR AMAZON S3 URL FOR THIS DOCUMENT&gt;"</strong></span>
<span class="strong"><strong>      }</strong></span>
<span class="strong"><strong>   }</strong></span>
<span class="strong"><strong>)</strong></span>
</pre><p>Once successfully updated, you will see the number of records updated on the mongo shell. Follow the same steps to update all the rest of your documents' URL columns for their Amazon S3 public URLs. With this, we are all set with our bot docman, from a backend data perspective.</p></div><div class="section" title="Wiring it all up together"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec7"/>Wiring it all up together</h3></div></div></div><p>To wire all the things up together, let's modify our earlier <code class="literal">app.js</code> as shown in the following code snippet:</p><pre class="programlisting">var Botkit = require('Botkit'); &#13;
var os = require('os'); &#13;
 &#13;
var mongojs = require('mongojs'); &#13;
var db = mongojs('127.0.0.1:27017/BotDB',['ReferenceDocuments']); &#13;
 &#13;
var controller = Botkit.slackbot({ &#13;
    debug: false &#13;
}); &#13;
 &#13;
var bot = controller.spawn({ &#13;
    token: "&lt;SLACK_BOT_TOKEN&gt;" &#13;
}).startRTM(); &#13;
 &#13;
 &#13;
controller.hears('hello',['direct_message','direct_mention','mention'],function(bot,message) { &#13;
  bot.reply(message,'Hello there!'); &#13;
}); &#13;
 &#13;
controller.hears(['docs','template','research documentation','documents'], &#13;
                 ['direct_message','direct_mention','mention'],function(bot,message) { &#13;
  bot.startConversation(message, askForKeywords); &#13;
}); &#13;
 &#13;
askForKeywords = function(response, convo) { &#13;
  convo.ask("Pl. type the word or keywords for document search.", function(response, convo) { &#13;
    convo.say("Awesome! Wait for a moment. Will search documents for word(s) *" + response.text +"*"); &#13;
    searchDocuments(response, convo); &#13;
    convo.next(); &#13;
  }); &#13;
} &#13;
 &#13;
searchDocuments = function(response, convo) { &#13;
var qtext ="""+response.text+""";     &#13;
    db.ReferenceDocuments.find({$text:{$search:qtext}},{},{limit:3},function (err, docs) { &#13;
         var attachments = [];   &#13;
         docs.forEach(function(d) {  &#13;
            var attachment= { &#13;
                "title": d.title, &#13;
                "title_link": d.url, &#13;
                "text": d.description, &#13;
                "color": '#3AA3E3', &#13;
                "footer": "From Amazon S3 | Version " +d.version                 &#13;
                };       &#13;
             attachments.push(attachment); &#13;
           }); &#13;
             &#13;
        convo.say({ &#13;
            text: '*Document(s):*', &#13;
            attachments: attachments, &#13;
        }) &#13;
    }); &#13;
} &#13;
   &#13;
db.on('error', function (err) { &#13;
    console.log('Database error', err) &#13;
}) &#13;
  &#13;
db.on('connect', function () { &#13;
    console.log('Database connected') &#13;
}) &#13;
</pre></div><div class="section" title="Code understanding"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec8"/>Code understanding</h3></div></div></div><p>I have already explained how we can connect to MongoDB using <code class="literal">mongojs.</code> Now let's focus on how we have implemented the conversational experience within docman:</p><pre class="programlisting">controller.hears(['docs','template','research documentation','documents'], &#13;
                 ['direct_message','direct_mention','mention'],function(bot,message) { &#13;
  bot.startConversation(message, askForKeywords); &#13;
}); &#13;
</pre><p>In the preceding code snippet, the user can start the conversations with docman using the keywords <code class="literal">'docs'</code>,<code class="literal">'template'</code>,<code class="literal">'research documentation'</code>, and <code class="literal">'documents'</code>.</p><p>Upon receiving a direct message or mention, the bot will start a conversation using <code class="literal">bot.startConversation()</code>. This function will call a related conversation sub-function <code class="literal">askForKeywords</code>
<code class="literal">()</code>.</p><p>The bot will ask us to provide keywords based on which documents need to be searched, and will also call the sub-function to actually search the document within MongoDB. The implementation for <code class="literal">askForKeywords</code>
<code class="literal">()</code> can be seen as shown in the following code snippet:</p><pre class="programlisting">askForKeywords = function(response, convo) { &#13;
  convo.ask("Pl. type the word or keywords for document search.", function(response, convo) { &#13;
    convo.say("Awesome! Wait for a moment. Will search documents for word(s) *" + response.text +"*"); &#13;
    searchDocuments(response, convo); &#13;
    convo.next(); &#13;
  }); &#13;
} &#13;
</pre><p>In the preceding code, the <code class="literal">convo.next()</code>function tells our called bot to continue the conversation. This step is required, or, our conversation will hang.</p><p>There is a final sub-function <code class="literal">searchDocuments()</code> that actually does the searching of documents within MongoDB and returns the top three documents as a part of the conversation.</p><p>Refer to the following code implementation for <code class="literal">searchDocuments()</code>:</p><pre class="programlisting">searchDocuments = function(response, convo) { &#13;
var qtext ="""+response.text+""";     &#13;
    db.ReferenceDocuments.find({$text:{$search:qtext}},{},{limit:3},function (err, docs) { &#13;
         var attachments = [];   &#13;
         docs.forEach(function(d) {  &#13;
            var attachment= { &#13;
                "title": d.title, &#13;
                "title_link": d.url, &#13;
                "text": d.description, &#13;
                "color": '#3AA3E3', &#13;
                "footer": "From Amazon S3 | Version " +d.version                 &#13;
                };       &#13;
             attachments.push(attachment); &#13;
           }); &#13;
             &#13;
        convo.say({ &#13;
            text: '*Document(s):*', &#13;
            attachments: attachments, &#13;
        }) &#13;
    }); &#13;
} &#13;
</pre><p>In the preceding code, once the search query returns data, there can be single or multiple documents, so we are iterating the results and then combining them into a JSON format. Once JSON formatting is done, the bot calls the <code class="literal">convo.say()</code> function to send the message along with the searched documents.</p><p>Slack has some guidelines concerning the composing of messages and attachments. These guidelines can be referred to at <a class="ulink" href="https://api.slack.com/docs/messages">
https://api.slack.com/docs/messages
</a>.</p><p>Now let's begin our great conversation experience with our enhanced Slack bot, docman.</p><p>Firstly, start a communication in the <span class="strong"><strong># general</strong></span> channel by mentioning <code class="literal">@docman</code>, and type the word <code class="literal">docs</code> as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00320.jpeg" alt="Code understanding"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Once we entered <code class="literal">docs</code>, docman asked to type the word or keywords for the document search.</p><p>Enter the word as <code class="literal">template</code> and see what <span class="strong"><strong>docman</strong></span> returns:</p><p>
</p><div class="mediaobject"><img src="../Images/image00321.jpeg" alt="Code understanding"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>When I entered the <code class="literal">template</code> keyword, <span class="strong"><strong>docman</strong></span> replied saying:</p><p>
</p><div class="mediaobject"><img src="../Images/image00322.jpeg" alt="Code understanding"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>It also replied with the searched documents in a nice elegant format using the Slack messaging guidelines shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00323.jpeg" alt="Code understanding"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Now, select one of the documents from the search results-I selected a document titled <span class="strong"><strong>Timeline Document</strong></span>, and <code class="literal">Timeline+Document.docx</code> was downloaded through our docman bot.</p><p>Refer to the following screenshot to see the downloaded document:</p><p>
</p><div class="mediaobject"><img src="../Images/image00324.jpeg" alt="Code understanding"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></div></div></div></div>
<div class="section" title="Summary" id="aid-173721"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec33"/>Summary</h1></div></div></div><p>So, with Slack, we built a bot and enhanced our team's collaborative experience by building intelligence into it.</p><p>To summarize, we saw how to create a Slack group from scratch. We also created a basic bot wired up in Node.js using Botkit, and had a basic conversation as a direct message as well as within a group by inviting the bot.</p><p>Finally, we made our bot search some of the documents based on keywords, and also provided a link to download the same document.</p><p>Our DocMan bot used MongoDB to store document attributes along with keywords with which the document can be searched. Also, DocMan retrieved actual documents from Amazon S3 storage upon a user's request to download them.</p><p>Hopefully this chapter has given you an end-to-end solution overview of how your bot searches and locates documents, as well as how it downloads them from storage locations or document repositories. You should now be aware of NoSQL technologies like MongoDB and how we can utilize them for keyword searches, and how we can wire up with storage locations like Amazon S3 in Node.js. Above all, you should now be fully aware of how we can bring everything together in messaging platforms like Slack.</p><p>Amazing!</p><p>In the next chapter, we will explore how to develop IRC bots and how we can wire up within Node.js and help our developers use it for bug tracking purposes.</p></div></body></html>