<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Parsing and Sending E-mails"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Parsing and Sending E-mails</h1></div></div></div><p>In the previous chapter, you learned how to create basic GAS elements such as custom menu, dialog, and toast. You also learned how to debug your script codes. In this chapter, you will learn many real-world Gmail and Contacts applications including a mail merger application.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note04"/>Note</h3><p>In this chapter, if you go through left and right square brackets inside code like <code class="literal">[[ value ]]</code>, then replace <code class="literal">value</code> with the actual value including the brackets.</p><p>For example, if the e-mail ID is <code class="literal">example@emample.com</code> and you go through <code class="literal">My email id [[emailid]]  \n</code>, then replace it with <code class="literal">My email id example@example.com \n</code>.</p></div></div><div class="section" title="Creating Gmail Contacts by script"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec28"/>Creating Gmail Contacts by script</h1></div></div></div><p>You can create <a class="indexterm" id="id88"/>Gmail Contacts by script using the<a class="indexterm" id="id89"/> <code class="literal">createContact</code> method of the <code class="literal">ContactsApp</code> class. For example, if the name is Anika Sumi and the e-mail ID is <code class="email">&lt;<a class="email" href="mailto:anika@example.com">anika@example.com</a>&gt;</code>, then the <code class="literal">ContactsApp.createContact("Anika", "Sumi", "anika@example.com")</code> code will create the expected contact. </p><p>To know more available methods of the <code class="literal">ContactsApp</code> class, in the code editor, type <code class="literal">ContactsApp</code> and <code class="literal">.</code> (a dot) next to it. Then, you can view all the available methods with parameter details in code hint as shown in the following screenshot:</p><div class="mediaobject"><img alt="Creating Gmail Contacts by script" src="graphics/B05010_03_09.jpg"/></div><p>You can see <a class="indexterm" id="id90"/>deprecated methods struck out in the preceding screenshot; you are advised not to use those methods.</p></div></div>
<div class="section" title="Accessing Sheet, cell, range, and offset"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec29"/>Accessing Sheet, cell, range, and offset</h1></div></div></div><p>A Google Sheet's spreadsheet <a class="indexterm" id="id91"/>has one or more Sheets or tabs in it. Sheets are indexed from left to right <a class="indexterm" id="id92"/>starting from 0. For example, the left-most Sheet is referred to by the index 0, the next one by 1, and so on. In GAS, we can refer to<a class="indexterm" id="id93"/> a Sheet by its index or by its<a class="indexterm" id="id94"/> name.</p><p>For example:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">getSheets()</code> method returns an <a class="indexterm" id="id95"/>array of Sheet objects. From the array, we can refer to an individual Sheet by its index.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">getSheetByName("Contacts")</code> function returns a Sheet object with the name <code class="literal">Contacts</code>.</li></ul></div><p>In Google Sheets, column label starts from the letter <span class="emphasis"><em>A</em></span>, and is counted in a programmatic point of view, from left to right starting with the number 1. For example, column <span class="emphasis"><em>A</em></span> is 1, <span class="emphasis"><em>B</em></span> is 2, and so on. Rows are identified by their respective label numbers. In GAS, we can reference a cell or a range of cells by <span class="emphasis"><em>A1</em></span> notation or by separate row and column numbers.</p><p>For example:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">getRange('D1:F10')</code> method returns a <code class="literal">Range</code> object referencing the cells from <span class="emphasis"><em>D1</em></span> to <span class="emphasis"><em>F10</em></span></li><li class="listitem" style="list-style-type: disc">The <code class="literal">getRange(1,4,10,3)</code> method returns a <code class="literal">Range</code> object referencing the same range <span class="emphasis"><em>D1:F10</em></span></li></ul></div><p>Offset is an<a class="indexterm" id="id96"/> indirect referencing method to refer to a cell/range from a base cell reference. An offset reference<a class="indexterm" id="id97"/> is determined by how many rows and columns it shifted <a class="indexterm" id="id98"/>from the base cell.</p><p>For example, if the base<a class="indexterm" id="id99"/> cell is <span class="emphasis"><em>D1</em></span>, then the <code class="literal">offset(10,3)</code> method returns the range <span class="emphasis"><em>D1:F10</em></span>.</p></div>
<div class="section" title="Reading and writing the Sheet data"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec30"/>Reading and writing the Sheet data</h1></div></div></div><p>Often you need to<a class="indexterm" id="id100"/> read and/or write data to/from the Sheet. Usually, use the <a class="indexterm" id="id101"/>
<code class="literal">getValue</code> method to read a value from a cell and the <code class="literal">getValues</code> <a class="indexterm" id="id102"/>method to read values<a class="indexterm" id="id103"/> from a range. The <code class="literal">getValue</code> method returns a single value and the <code class="literal">getValues</code> method returns<a class="indexterm" id="id104"/> a 2-dimensional array of values. To write single value and 2-dimensional array of values, use <code class="literal">setValue</code> and <code class="literal">setValues</code> methods<a class="indexterm" id="id105"/> respectively.</p></div>
<div class="section" title="Building a Gmail Contact search application"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec31"/>Building a Gmail Contact search application</h1></div></div></div><p>Now, we will <a class="indexterm" id="id106"/>create an application to search existing contacts. This application is able to search and list your Gmail Contacts in Sheets. Create a new Sheet and rename <code class="literal">Sheet1</code> to <code class="literal">Contacts</code> and set it up as shown in the following screenshot. Create a button and assign the function name <code class="literal">searchContacts</code> to it, as you learned in the previous chapter.</p><div class="mediaobject"><img alt="Building a Gmail Contact search application" src="graphics/B05010_03_01.jpg"/></div><p>Create the <code class="literal">searchContacts</code> function as listed here:</p><div class="informalexample"><pre class="programlisting">function searchContacts(){

  var SheetContacts = SpreadsheetApp.getActiveSpreadsheet()
      .getSheetByName("Contacts");

  // Read input from cell A3 
  var searchCriteria = SheetContacts.getRange("A3").getValue();

  //  First 10 contacts.
  //  [You can change this limit, but advised to keep small.]
  var numOfContacts = 10;

  // Clear existing sheet data
  SheetContacts.getRange(7,1,numOfContacts,4).clear();</pre></div><p>Here, <code class="literal">clear</code> is the <code class="literal">Range</code> object's method to clear everything including format and formula, in a range<a class="indexterm" id="id107"/> of cells. You can use the <code class="literal">clear</code> method of the <code class="literal">Sheet</code> object to clear the entire Sheet. Alternatively, you can use the <code class="literal">clearContent</code> method to clear content only.</p><div class="informalexample"><pre class="programlisting">  // Returns an array of contacts where
  // contacts name matches with search text.
  var contacts = ContactsApp.getContactsByName(searchCriteria);

  //  Limit number of contacts.
  if(contacts.length &gt; numOfContacts) contacts.length = numOfContacts;

  var cell = SheetContacts.getRange("A7");

  for(var i in contacts){
    var name = contacts[i].getFullName();
    var email = contacts[i].getEmails()[0];

    if(email) email = email.getAddress();
    else email = "";

    // For simplicity get the first phone number
    var phone = contacts[i].getPhones()[0];

    if (phone) phone = phone.getPhoneNumber();
    else phone = "";

    // For simplicity get the first address
    var address = contacts[i].getAddresses()[0];

    if(address) address = address.getAddress();
    else address = "";

    // cell.offset(rowOffset, columnOffset)
    cell.offset(i,0).setValue(name);
    cell.offset(i,1).setValue(email);
    cell.offset(i,2).setValue(phone);
    cell.offset(i,3).setValue(address);
  }
};</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip13"/>Tip</h3><p>Do not copy paste the preceding code, but edit it yourself. By doing so, you'll be aware of available method signatures (method names and parameters) of classes such as <code class="literal">SpreadsheetApp</code>, <code class="literal">ContactApp</code>, and <code class="literal">Contact</code> with the help of the script editor's code hint feature.</p></div></div><p>After you have<a class="indexterm" id="id108"/> edited and saved code without error, turn to the spreadsheet window. If you enter a search term in the <span class="emphasis"><em>A3</em></span> cell (search box) and click on <span class="strong"><strong>Search</strong></span>, then the first 10 contacts will be listed as shown in the following screenshot (the listed contacts details vary as per your Gmail username and contacts):</p><div class="mediaobject"><img alt="Building a Gmail Contact search application" src="graphics/B05010_03_02.jpg"/></div><p>What if you want to update the listed contacts by the <code class="literal">searchContacts</code> function? For example, you may want to update the phone number and/or address of a contact. To update contact fields, we will create another function called <code class="literal">updateContacts</code>. Before creating that, in the <code class="literal">Contacts</code> Sheet, add a button next to <span class="strong"><strong>Search</strong></span> named <span class="strong"><strong>Update</strong></span> and assign function name <code class="literal">updateContacts</code> as shown in the following screenshot:</p><div class="mediaobject"><img alt="Building a Gmail Contact search application" src="graphics/B05010_03_10.jpg"/></div><p>Update those field<a class="indexterm" id="id109"/> values you would like to update. Now create the function listed here:</p><div class="informalexample"><pre class="programlisting">function updateContacts(){
  var SheetContacts = SpreadsheetApp.getActiveSpreadsheet()
      .getSheetByName("Contacts");

  var cell = SheetContacts.getRange("A7");
  
  var numOfContacts = 10;
  
  for(var i = 0; i &lt; numOfContacts; i++){
    
    var email = cell.offset(0, 1).getValue();

    // Skip if email field is null
    if(!email) continue;
    
    var contact = ContactsApp.getContact(email);

    // Skip if contact is null or undefined
    if(!contact) continue;
    
    
    var name = cell.offset(i, 0).getValue();

    // Skip if name field is null
    if(!name) continue;
    contact.setFullName(name);
    
    
    var phone = cell.offset(i, 2).getValue().toString();
    
    // Returns phone numbers as an array
    var contPhone = contact.getPhones(ContactsApp.Field.MAIN_PHONE)[0];
    
    // Update main phone number if exist otherwise add.
    if(phone){

      if(contPhone){
        contPhone.setPhoneNumber(phone);
      } else {
        contact.addPhone(ContactsApp.Field.MAIN_PHONE, phone);
      }

    }
    
    
    var address = cell.offset(i, 3).getValue().toString();
    
    // Returns address as an array
    var contAddress = contact
        .getAddresses(ContactsApp.Field.HOME_ADDRESS)[0];
    
    // Update home address if exist otherwise add.
    if(address){

      if(contAddress) {
        contAddress.setAddress(address);
      } else {
        contact.addAddress(ContactsApp.Field.HOME_ADDRESS, address);
      }

    }

  }
};</pre></div><p>The preceding <a class="indexterm" id="id110"/>function retrieves contacts by the given e-mail ID; and, for each contact, it also retrieves field values and updates/adds those field values with the Sheet values. This function can update/add full name, phone, and address <a class="indexterm" id="id111"/>fields but not the e-mail ID.</p></div>
<div class="section" title="Building the Gmail parser application"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec32"/>Building the Gmail parser application</h1></div></div></div><p>The <code class="literal">parseEmail</code> function is <a class="indexterm" id="id112"/>able to check 10 latest inbox threads, extract the <span class="strong"><strong>from </strong></span>field and body text from unread messages, and put the gathered data in the left-most tab of the Sheet. Create the <code class="literal">parseEmail</code> function as listed here:</p><div class="informalexample"><pre class="programlisting">/** 
 *  Gets content of latest unread message in Gmail inbox
 *    and puts gathered data in left most tab of Sheets.
 *
 */
function parseEmail(){

  // Left most sheet/tab
  var emailSheet = SpreadsheetApp.getActiveSpreadsheet()
      .getSheets()[0];

  // Clear the entire sheet.
  emailSheet.clear();

  // Checks maximum 10 threads
  var thread = GmailApp.getInboxThreads(0,10);

  var row = 1;

  for(var thrd in thread){
    var messages = thread[thrd].getMessages();

    for (var msg in messages) {
      var message = messages[msg];

      if(message &amp;&amp; message.isUnread())
      emailSheet.getRange(row,1).setValue(message.getFrom());

      emailSheet.getRange(row++,2)
      .setValue(message.getPlainBody());
    }
  }

};</pre></div><p>You can use <code class="literal">RegExp</code> to extract only the required data from the message body text.</p></div>
<div class="section" title="Properties service"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec33"/>Properties service</h1></div></div></div><p>GAS provides the<a class="indexterm" id="id113"/> properties service to store and/or to retrieve project-related data. The data organized as key/value pairs, can be set manually or by script codes. The following screenshot shows how you can set properties manually. To see this dialog, click on the <span class="strong"><strong>File</strong></span> menu and select <span class="strong"><strong>Project properties</strong></span>:</p><div class="mediaobject"><img alt="Properties service" src="graphics/B05010_03_03.jpg"/></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note05"/>Note</h3><p>You can use manually created project properties in script codes, but the properties created by code sometimes may not be visible in the <span class="strong"><strong>Project properties</strong></span> dialog. You can create, update, or delete project properties in codes.</p></div></div><p>In the next task, we are going to use project properties.</p></div>
<div class="section" title="Downloading Gmail attachments to Drive"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec34"/>Downloading Gmail attachments to Drive</h1></div></div></div><p>The <code class="literal">saveEmailAttachmentsToDrive</code> function can download Gmail attachments to Drive. In this <a class="indexterm" id="id114"/>function <code class="literal">PropertiesService</code> is used to avoid repeated downloading of the same attachment. The <code class="literal">createFolder_</code> function is<a class="indexterm" id="id115"/> used to create folders, if not already exist, with the given name in Drive.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip14"/>Tip</h3><p>If any function name is appended with <code class="literal">_</code>, then it will not be listed under the <span class="strong"><strong>Run</strong></span> menu. You cannot run these functions directly, but they can be called from the other functions. These<a class="indexterm" id="id116"/> are called <span class="strong"><strong>private functions</strong></span>.</p></div></div><p>You can create the<a class="indexterm" id="id117"/> <code class="literal">createFolder_</code> function<a class="indexterm" id="id118"/> in the same script file along with the <code class="literal">saveEmailAttachmentsToDrive</code> function or in a separate script file such as <code class="literal">Library.gs</code>:</p><div class="informalexample"><pre class="programlisting">/**
 *  Checks latest 100 inbox threads,
 *    saves attachments in 'Gmail attachments' folder,
 *
 */
function saveEmailAttachmentsToDrive(){

  // Create 'Gmail Attachments' folder if not exists.
  createFolder_('Gmail attachments');

  // Get inbox threads starting from the latest one to 100.
  var threads = GmailApp.getInboxThreads(0, 100);

  var messages = GmailApp.getMessagesForThreads(threads);

  var folderID = PropertiesService.getUserProperties()
      .getProperty("FOLDER");

  var file, folder = DriveApp.getFolderById(folderID);

  for (var i = 0 ; i &lt; messages.length; i++) {
    for (var j = 0; j &lt; messages[i].length; j++) {
      if(!messages[i][j].isUnread()){

        var msgId = messages[i][j].getId();

        // Assign '' if MSG_ID is undefined.
        var oldMsgId = PropertiesService.getUserProperties()
            .getProperty('MSG_ID') || '';

        if(msgId &gt; oldMsgId){
          var attachments = messages[i][j].getAttachments();

          for (var k = 0; k &lt; attachments.length; k++) {
            PropertiesService.getUserProperties()
              .setProperty('MSG_ID', messages[i][j].getId());

            try {
              file = folder.createFile(attachments[k]);
              Utilities.sleep(1000);// Wait before next iteration.
            } catch (e) {
              Logger.log(e);
            }
          }

        }
        else return;

      }
    }
  }

};</pre></div><p>The preceding<a class="indexterm" id="id119"/> function calls the following <code class="literal">createFolder_</code> function with the folder name as an argument. The function<a class="indexterm" id="id120"/> <code class="literal">createFolder_</code> looks for the given folder, creates if it does not exist, and returns its unique ID:</p><div class="informalexample"><pre class="programlisting">function createFolder_(name) {
  var folder, folderID, found = false;

  /*
   * Returns collection of all user folders as an iterator.
   * That means it do not return all folder names at once, 
   * but you should get them one by one.
   *
   */
  var folders = DriveApp.getFolders();

  while (folders.hasNext()) {
    folder = folders.next();
    if (folder.getName() == name) {
      folderID = folder.getId();
      found = true;
      break;
    }
  };

  if (!found) {
    folder = DriveApp.createFolder(name);
    folderID = folder.getId();
  };

  PropertiesService.getUserProperties()
    .setProperty("FOLDER", folderID);

  return folderID;
}</pre></div><p>In the preceding function the <code class="literal">getFolders</code> method is an iterator method. An iterator does not return all the data in one go, but only the current data. To get successive data, you should call next <a class="indexterm" id="id121"/>method repeatedly <a class="indexterm" id="id122"/>until <code class="literal">hasNext</code> became <code class="literal">false</code>.</p></div>
<div class="section" title="Sending e-mails using the MailApp service"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec35"/>Sending e-mails using the MailApp service</h1></div></div></div><p>The <code class="literal">sendEmail</code> function is<a class="indexterm" id="id123"/> able to send e-mails with prefixed messages. Remember to replace e-mail ID and message text. This service is mainly<a class="indexterm" id="id124"/> used to send e-mails with limited methods (only <code class="literal">sendEmail</code> and <code class="literal">getRemainingDailyQuota</code>), and it cannot access your Gmail account. You can use the <code class="literal">GmailApp</code> class for more methods:</p><div class="informalexample"><pre class="programlisting">function sendEmail(){
  var to = "[[reciever email id]]";
  var message = "[[message]]\n";

  MailApp.sendEmail(to, "Chapter 3", message);
}</pre></div></div>
<div class="section" title="Sending an e-mail notification on Form submission"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec36"/>Sending an e-mail notification on Form submission</h1></div></div></div><p>Imagine if you created <a class="indexterm" id="id125"/>a Form and presented it to many users. It would be tedious to open the response Sheet every time to verify whether any<a class="indexterm" id="id126"/> user has submitted the Form or not. The problem would be worse if you created many Forms and sent them to many users. It will be helpful receiving a notification e-mail whenever there is a Form submission. </p><p>For this task, create a Form with three fields as shown in the following screenshot:</p><div class="mediaobject"><img alt="Sending an e-mail notification on Form submission" src="graphics/B05010_03_04.jpg"/></div><p>Submit the test <a class="indexterm" id="id127"/>data from a live form. Your submitted<a class="indexterm" id="id128"/> data will be saved in a response Sheet named something like <code class="literal">Form Responses 1</code>. The column headers will be as per your Form fields as shown in the following screenshot. Data may vary as per your input.</p><div class="mediaobject"><img alt="Sending an e-mail notification on Form submission" src="graphics/B05010_03_05.jpg"/></div><p>In the script file, you <a class="indexterm" id="id129"/>need to make the following changes:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Enter the <code class="literal">sendEmail</code> function mentioned from the following code.</li><li class="listitem">Replace the receiver's e-mail ID. If you run this function, then it will send an e-mail with the last submitted data (bottom-most row) in the response Sheet.</li><li class="listitem">Check the Sheet's actual name and the name used in the code; they should be exactly the same. If you are not sure, right-click on the Sheet name and select <span class="strong"><strong>Rename...</strong></span>.</li><li class="listitem">Copy the Sheet <a class="indexterm" id="id130"/>name from the <span class="strong"><strong>Rename</strong></span> dialog and paste it in the following code:<div class="informalexample"><pre class="programlisting">function sendEmail(){
  var sheet = SpreadsheetApp.getActiveSpreadsheet()
      .getSheetByName("Form Responses 1");

  var lastRow = sheet.getLastRow();
  var lastCol = sheet.getLastColumn();
  var data = sheet.getRange(lastRow,1,1,lastCol)
      .getValues()[0];

  var to = "[[ receiver email id]]";
  var message = "Name: " + data[1] + "\n";

  message += "Phone: " + data[2] + "\n";
  message += "Question: " + data[3] + "\n";

  // MailApp.sendEmail(recipient, subject, body);
  MailApp.sendEmail(to, "Chapter 3", message);
}</pre></div></li></ol></div><p>You created a Form and a function to send response data to an e-mail ID. Creating a trigger so as to run the <code class="literal">sendEmail</code> function as soon as a Form is submitted will complete this task.</p></div>
<div class="section" title="Creating triggers manually"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec37"/>Creating triggers manually</h1></div></div></div><p>To create a<a class="indexterm" id="id131"/> trigger, in the code editor click on <span class="strong"><strong>Resources</strong></span> and select <span class="strong"><strong>Current project's triggers</strong></span> then the <span class="strong"><strong>Current project's triggers</strong></span> dialog will open. Already created triggers will be listed in this dialog, otherwise a link to create a new trigger will appear. Click on the <span class="strong"><strong>No triggers set up. Click here to add one now</strong></span> link. Select the options from the dropdowns as shown in the following screenshot:</p><div class="mediaobject"><img alt="Creating triggers manually" src="graphics/B05010_03_06.jpg"/></div><p>Under the <span class="strong"><strong>Run</strong></span> heading, select the <code class="literal">sendEmail</code> function for which you want to create the trigger. Select <span class="strong"><strong>From spreadsheet</strong></span> and <span class="strong"><strong>On form submit</strong></span> under the <span class="strong"><strong>Events</strong></span> heading as shown in the preceding screenshot.</p><p>If a Form user submits data to the spreadsheet, the trigger will run the <code class="literal">sendEmail</code> function.</p><p>For more info on<a class="indexterm" id="id132"/> triggers, please go to <a class="ulink" href="https://developers.google.com/apps-script/guides/triggers/">https://developers.google.com/apps-script/guides/triggers/</a>.</p></div>
<div class="section" title="Creating and deleting triggers by script"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec38"/>Creating and deleting triggers by script</h1></div></div></div><p>You can<a class="indexterm" id="id133"/> create or delete triggers programmatically as shown in the following <a class="indexterm" id="id134"/>sample code:</p><div class="informalexample"><pre class="programlisting">/**
 * Deletes all the triggers.
 *
 */
function deleteTriggers(){
  var triggers = ScriptApp.getProjectTriggers();

  triggers.forEach(function(trigger){

    try{
      ScriptApp.deleteTrigger(trigger);
    } catch(e) {
      throw e.message;
    };

    Utilities.sleep(1000);

  });

};

function createTrigger(){
  var ss = SpreadsheetApp.getActiveSpreadsheet();

  // Create new trigger
  ScriptApp.newTrigger("sendEmail")
    .forSpreadsheet(ss).onFormSubmit().create();
};</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note06"/>Note</h3><p>In the <a class="indexterm" id="id135"/>
<code class="literal">deleteTriggers</code> function, the <code class="literal">Utilities</code> service's <code class="literal">sleep</code> <a class="indexterm" id="id136"/>method is used to pause the script temporarily for the specified milliseconds. Otherwise, you may experience the <code class="literal">Too many service invocation…</code> error.</p></div></div></div>
<div class="section" title="Forwarding e-mails if the specific keyword is found in the message body"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec39"/>Forwarding e-mails if the specific keyword is found in the message body</h1></div></div></div><p>The <code class="literal">forwardEmails</code> function is <a class="indexterm" id="id137"/>able to forward e-mail messages, if a specific keyword is found in the body text to a prefixed e-mail ID. Be cautious about the number of iterations of the <code class="literal">for</code> loop while testing your code so that you can avoid lot of messages forwarded in error:</p><div class="informalexample"><pre class="programlisting">/**
 *  1. Checks all unread inbox threads and messages.
 *
 *  2. If specific keyword found then forwards it to another
 *     recipient.
 *
 *  3. Marks that message as Read.
 *
 */
function forwardEmails() {
  var recipient = "[[forward email id]]";
  /*
   *  Use keywords separated by '|'.
   *  For example: "purchase | invoice"
   *
   */
  var words = "keywords list";
  var regExp = new RegExp(words,'g');

  var len = GmailApp.getInboxUnreadCount();

  for (var i = 0; i &lt; len; i++) {
    // get 'i'th thread in inbox
    var thread = GmailApp.getInboxThreads(i,1)[0];

    // get all messages in 'i'th thread
    var messages = thread.getMessages();
    var msgLen = messages.length;
    var isAllMarkedRead = true;

    // iterate over each message
    // CAUTION: limit loop iterations for initial testing.
    for (var j = 0; j &lt; 5 /* msgLen */; j++) {
      var message = messages[j];

      if(message.isUnread()){
        var bodyText = message.getPlainBody();
        var test = regExp.exec(bodyText);
        message.forward(recipient);
        isAllMarkedRead = false;
        message.markRead();
      }

    };

    if(isAllMarkedRead) len++;
    Utilities.sleep(1000);
  }

};</pre></div></div>
<div class="section" title="Sending e-mail with attachments"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec40"/>Sending e-mail with attachments</h1></div></div></div><p>You can attach any type of file to your e-mail message by setting options as shown in the following code. The<a class="indexterm" id="id138"/> following code attaches the active spreadsheet's left-most Sheet content as PDF.</p><div class="informalexample"><pre class="programlisting">function sendEmailWithAttachments(){
  var file = SpreadsheetApp.getActiveSpreadsheet()
      .getAs(MimeType.PDF);

  // MailApp.sendEmail(recipient, subject, body, options)
  MailApp.sendEmail(
    "[[ Recipient email id ]]",
    "Chapter 3",
    "",
    {
      attachments: [file],
      name: 'Chapter 3 test attachment'
    }
  );

}</pre></div></div>
<div class="section" title="Embedding inline images in an e-mail message"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec41"/>Embedding inline images in an e-mail message</h1></div></div></div><p>To embed<a class="indexterm" id="id139"/> images such as a logo in your e-mail message, you may use HTML code instead of plain text. Upload your image to Google Drive, retrieve, and <a class="indexterm" id="id140"/>use that file ID in code:</p><div class="informalexample"><pre class="programlisting">function sendEmail(){
  var sheet = SpreadsheetApp.getActiveSpreadsheet()
      .getSheetByName("Form Responses 1");

  var lastRow = sheet.getLastRow();
  var lastCol = sheet.getLastColumn();
  var data = sheet.getRange(lastRow,1,1,lastCol).getValues()[0];

  var image = DriveApp.getFileById("[[image file's id in Drive ]]").getBlob();

  var to = "[[Recipient email id ]]";
  var message = '&lt;img src="cid:logo" /&gt;';

  message += "&lt;p&gt;Name: " + data[1] + "&lt;/p&gt;";
  message += "&lt;p&gt;Phone: " + data[2] + "&lt;/p&gt;";
  message += "&lt;p&gt;Question: " + data[3] + "&lt;/p&gt;";

  MailApp.sendEmail(
    to,
    "Chapter 3 inline image example",
    "",
    {
      inlineImages:{ logo:image },
      htmlBody:message
    }
  );
}</pre></div></div>
<div class="section" title="Building an e-mail merger application"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec42"/>Building an e-mail merger application</h1></div></div></div><p>Sending personalized<a class="indexterm" id="id141"/> e-mails to hundreds of recipients at a time might be a time consuming task. Composing the draft and entering the subject and recipient's e-mail ID for each message might be tedious too. Using this mail merger application, you can send the same kind of information to all recipients, but customized to some extent. For example, greeting an individual.</p><p>The first step is creating a draft in your Gmail as shown in the following screenshot. The draft is used as a template. You can use any special character to enclose the text to be replaced. In the draft, the code shown in the following screenshot uses left (<code class="literal">&lt;&lt;</code>) and right (<code class="literal">&gt;&gt;</code>) angled brackets to replace the first name with the <span class="strong"><strong>First Name</strong></span> column data in an <code class="literal">EmailList</code> Sheet. You can include any other placeholder or field as per your requirement. Set up the draft, but don't send it now:</p><div class="mediaobject"><img alt="Building an e-mail merger application" src="graphics/B05010_03_07.jpg"/></div><p>Create a Sheet with<a class="indexterm" id="id142"/> the name as <code class="literal">EmailList</code> in a new Sheet or existing Sheet. Create the column headers as shown here:</p><div class="mediaobject"><img alt="Building an e-mail merger application" src="graphics/B05010_03_08.jpg"/></div><p>Create functions as shown in the following code, in the script editor. Replace the draft and sender name <a class="indexterm" id="id143"/>with actual values. Set <code class="literal">maxEmails</code> (this code uses <code class="literal">50</code>) by considering your daily e-mail sending quota:</p><div class="informalexample"><pre class="programlisting">// Returns your draft text.
function getDraftBody(draftName){
  var drafts = GmailApp.getDraftMessages();

  for(var i in drafts)
    if( drafts[i].getSubject() == draftName )
      return drafts[i].getPlainBody();
}


function sendEmails(){
  // EmailList sheet column numbers, 0 based.
  const FIRST_NAME_COL = 0;
  const EMAIL_IDS_COL = 1;
  const SUB_COL = 2;
  const DATE_COL = 3;

  var maxEmails = 50;
  var draftName = "Chapter 3";// Draft's subject name

  var draftBody = getDraftBody(draftName);
  var quotaLeft = MailApp.getRemainingDailyQuota();

  var ss = SpreadsheetApp.getActive();
  var sheet = ss.getSheetByName("EmailList");

  // Gets all sheet data as a 2-dimensional array.  
  var data = sheet.getDataRange().getValues();
  var header = data.shift();

  for(var i=0,count=0; count &lt; maxEmails &amp;&amp; count &lt; quotaLeft
      &amp;&amp; i &lt; data.length; ++i){
    var firstName = data[i][FIRST_NAME_COL];
    var recipient = data[i][EMAIL_IDS_COL];
    var subject = data[i][SUB_COL];
    var htmlBody = draftBody.replace("&lt;&lt;FirstName&gt;&gt;", firstName);

    if(recipient){
      GmailApp.sendEmail(
        recipient,
        subject,
        "",
        {
          name:"[[ Sender Name ]]",
          htmlBody:htmlBody
        }
      );

      data[i][DATE_COL] = new Date();

      ++count;
    }
  };

  // Inserts header at top of the array.
  data.unshift(header);

  // Stores values of array in sheet.
  sheet.getRange(1, 1, data.length, header.length)
    .setValues(data);
}</pre></div><p>Populate data in the <a class="indexterm" id="id144"/>
<code class="literal">EmailList</code> Sheet. To send e-mails, run the <code class="literal">sendEmails</code> function. The <code class="literal">&lt;&lt;FirstName&gt;&gt;</code> field in your draft will be replaced as per your <span class="strong"><strong>First Name</strong></span> column data in the <code class="literal">EmailList</code> Sheet. That's it!</p><p>Congratulations! You have created a working e-mail merger application.</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec43"/>Summary</h1></div></div></div><p>In this chapter, you learned about <code class="literal">ContactsApp</code>, <code class="literal">MailApp</code>, and <code class="literal">GmailApp</code> classes and their methods. Using these classes, you created many useful real-world applications including an e-mail merger application. In the next chapter, you will learn how to create Forms programmatically using <code class="literal">FormApp</code> and <code class="literal">HtmlService</code> classes. Also you will learn about <code class="literal">doGet</code> and <code class="literal">doPost</code> simple trigger functions.</p></div></body></html>