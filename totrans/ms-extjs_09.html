<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;Adding Extra Capabilities"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Adding Extra Capabilities</h1></div></div></div><p>We are almost on the final stage of our application. Ext JS provides great capabilities, but there are some capabilities that we need to code by ourselves with the help of other technologies. Despite possessing a GridPanel with paging, sorting, and filter capabilities, sometimes the user is going to expect more from the application. Adding features such as printing, the ability to export to Excel and PDF, and the ability to export charts to images and PDF can add great value to the application and please the final user.</p><p>So, in this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Printing records of a GridPanel</li><li class="listitem" style="list-style-type: disc">Exporting GridPanel information to PDF and Excel</li><li class="listitem" style="list-style-type: disc">Creating charts</li><li class="listitem" style="list-style-type: disc">Exporting charts to PDF and images</li><li class="listitem" style="list-style-type: disc">Using third-party plugins</li></ul></div><div class="section" title="Exporting a GridPanel to PDF and Excel"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec45"/>Exporting a GridPanel to PDF and Excel</h1></div></div></div><p>The first capability we<a id="id780" class="indexterm"/> are going to implement is exporting the contents of a GridPanel to PDF and Excel. We will implement these features for the <code class="literal">Films</code> GridPanel we implemented in the preceding chapter. However, the logic is the same for any GridPanel you might have in an Ext JS application.</p><p>The first thing <a id="id781" class="indexterm"/>we are going to do is add the export buttons to the GridPanel toolbar. We will add three buttons: one to <span class="strong"><strong>Print</strong></span> the contents of the GridPanel (we will develop this feature later, but let's add this button right now), one button for <span class="strong"><strong>Export to PDF</strong></span>, and one button for <span class="strong"><strong>Export to Excel</strong></span>:</p><div class="mediaobject"><img src="graphics/0457OT_09_01.jpg" alt="Exporting a GridPanel to PDF and Excel"/></div><p>Remember that<a id="id782" class="indexterm"/> in the <a id="id783" class="indexterm"/>preceding chapter, we created a toolbar, <code class="literal">Packt.view.base.TopToolBar</code>. We are going to add these three buttons on this toolbar:</p><div class="informalexample"><pre class="programlisting">items: [
    //Add Button
    {
        xtype: 'tbseparator'
    },
    {
        xtype: 'button',
        text: 'Print',
        glyph: Packt.util.Glyphs.getGlyph('print'),
        listeners: {
            click: 'onPrint'
        }
    },
    {
        xtype: 'button',
        text: 'Export to PDF',
        glyph: Packt.util.Glyphs.getGlyph('pdf'),
        listeners: {
            click: 'onExportPDF'
        }
    },
    {
        xtype: 'button',
        text: 'Export to Excel',
        glyph: Packt.util.Glyphs.getGlyph('excel'),
        listeners: {
            click: 'onExportExcel'
        }
    }
]</pre></div><p>All buttons have <code class="literal">listeners</code> that we will handle in the ViewController. In this case, buttons will be in the <code class="literal">FilmsController</code> class.</p><p>Inside the <code class="literal">Glyphs</code> class, we<a id="id784" class="indexterm"/> are also going to add the following attributes to represent the icons:</p><div class="informalexample"><pre class="programlisting">print: 'xf02f',
pdf: 'xf1c1',
excel: 'xf1c3'</pre></div><div class="section" title="Exporting to PDF"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec93"/>Exporting to PDF</h2></div></div></div><p>Now that the buttons are <a id="id785" class="indexterm"/>being displayed on the <code class="literal">Films</code> GridPanel, it is time to go back to <code class="literal">FilmsController</code> and add these capabilities.</p><p>The first button <a id="id786" class="indexterm"/>we are going to listen to is the <span class="strong"><strong>Export to PDF</strong></span> <code class="literal">click</code> event. When the user clicks on this button, we will execute the following method:</p><div class="informalexample"><pre class="programlisting">onExportPDF: function(button, e, options) {
    var mainPanel = Ext.ComponentQuery.query('mainpanel')[0]; //#1

    var newTab = mainPanel.add({
        xtype: 'panel',
        closable: true,
        glyph: Packt.util.Glyphs.getGlyph('pdf'),
        title: 'Films PDF',
        layout: 'fit',
        html: 'loading PDF...',
        items: [{
            xtype: 'uxiframe',                 //#2
            src: 'php/pdf/exportFilmsPdf.php' //#3
        }]
    });

    mainPanel.setActiveTab(newTab); //#4
}</pre></div><p>What we want to implement is that when the user clicks on the <span class="strong"><strong>Export to PDF</strong></span> button, a new tab (<code class="literal">#4</code>) will be opened with the PDF file in it. This means we need to get that <span class="strong"><strong>Main</strong></span> <span class="strong"><strong>Panel</strong></span> class<a id="id787" class="indexterm"/> (xtype <code class="literal">mainpanel</code>) we declared as the center item of the Viewport of the application (<code class="literal">#1</code>), add a new tab to it, and as the PDF file will be inside it, we can implement it as<a id="id788" class="indexterm"/> <span class="strong"><strong>iFrame</strong></span>. To implement iFrame in Ext JS, we can use the iFrame plugin (<code class="literal">#2</code>) that is distributed within the SDK.</p><p>Inside the ViewController, we have access to the <code class="literal">Films</code> View, but we need to access <code class="literal">mainpanel</code>. We can get the <code class="literal">Films</code> View using the <code class="literal">getView</code> method and then use the <code class="literal">up</code> method to get <code class="literal">mainpanel</code>, or we can use <code class="literal">Ext.ComponentQuery</code> to query <code class="literal">mainpanel</code>. Remember that <code class="literal">Ext.ComponentQuery</code> returns an array of all matching results, but as we know, there is only one <code class="literal">mainPanel</code> in the application, so we can retrieve the first position.</p><p>Now comes the<a id="id789" class="indexterm"/> most <a id="id790" class="indexterm"/>important part: Ext JS does not provide the <span class="strong"><strong>Export to PDF</strong></span> capability natively. If we want the application to have it, we need to implement it using a different technology. In this case, the PDF will be generated on the server side (<code class="literal">#3</code>), and we will only display its output inside the iFrame.</p><p>When we execute the code, we will get the following output:</p><div class="mediaobject"><img src="graphics/0457OT_09_02.jpg" alt="Exporting to PDF"/></div><div class="section" title="Generating the PDF file on the server – PHP"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec55"/>Generating the PDF file on the server – PHP</h3></div></div></div><p>As we need to<a id="id791" class="indexterm"/> generate the file on the server side, we can use any framework or library that is available for the language we are using on the server. We can use <a id="id792" class="indexterm"/>
<span class="emphasis"><em>TCPDF</em></span> (<a class="ulink" href="http://www.tcpdf.org/">http://www.tcpdf.org/</a>). There are other libraries as well, and you can use the one you are most familiar with.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip34"/>Tip</h3><p>If you are using Java, you can use <a id="id793" class="indexterm"/>
<span class="emphasis"><em>iText</em></span> (<a class="ulink" href="http://itextpdf.com/">http://itextpdf.com/</a>), and if you are using .NET, you can use <span class="emphasis"><em>excellibrary</em></span> (<a class="ulink" href="https://code.google.com/p/excellibrary/">https://code.google.com/p/excellibrary/</a>).</p></div></div></div><div class="section" title="Generating and viewing the PDF file with JavaScript – HTML5"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec56"/>Generating and viewing the PDF file with JavaScript – HTML5</h3></div></div></div><p>Thanks to<a id="id794" class="indexterm"/> HTML5, it is also possible to generate a PDF file using the<a id="id795" class="indexterm"/> HTML5 API. There are a few solutions that we can use to generate the file without using any server-side code and only using JavaScript. One of them is using <a id="id796" class="indexterm"/>jsPDF (<a class="ulink" href="https://github.com/MrRio/jsPDF">https://github.com/MrRio/jsPDF</a>).</p><p>By default, the <a id="id797" class="indexterm"/>browser is going to use whatever PDF viewer software the user has installed on the computer to view the PDF file. It is also possible to use a PDF viewer developed with JavaScript called <code class="literal">pdf.js</code>. This solution is implemented and maintained by <a id="id798" class="indexterm"/>Mozilla (<a class="ulink" href="https://github.com/mozilla/pdf.js/">https://github.com/mozilla/pdf.js/</a>). There is also an Ext JS plugin developed on <code class="literal">pdf.js</code> (<a class="ulink" href="https://market.sencha.com/extensions/pdf-panel-without-plugin-needed">https://market.sencha.com/extensions/pdf-panel-without-plugin-needed</a>).</p></div></div><div class="section" title="Exporting to Excel"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec94"/>Exporting to Excel</h2></div></div></div><p>To export the <a id="id799" class="indexterm"/>GridPanel to Excel, we will also use a server-side technology to help us.</p><p>On the<a id="id800" class="indexterm"/> Ext JS side, the only thing we need to do is to call the URL that will generate the Excel file as follows:</p><div class="informalexample"><pre class="programlisting">onExportExcel: function(button, e, options) {
    window.open('php/pdf/exportFilmsExcel.php');  
}</pre></div><p>On the server side, we will use the <a id="id801" class="indexterm"/>
<span class="emphasis"><em>PHPExcel</em></span> (<a class="ulink" href="http://phpexcel.codeplex.com/">http://phpexcel.codeplex.com/</a>) library to help us generate the Excel file.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip35"/>Tip</h3><p>If you are using Java, you can use the Apache POI library<a id="id802" class="indexterm"/> (<a class="ulink" href="http://poi.apache.org/">http://poi.apache.org/</a>), and if you are using .NET, you can use <span class="emphasis"><em>excellibrary</em></span> (<a class="ulink" href="https://code.google.com/p/excellibrary/">https://code.google.com/p/excellibrary/</a>).</p></div></div><p>If you want to export the GridPanel of any other content from an Ext JS component to Excel, PDF, .txt, or a Word document, you can use the same approach.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note82"/>Note</h3><p>There is also an Ext JS plugin that exports a grid to an Excel file: <a class="ulink" href="http://goo.gl/E7jif4">http://goo.gl/E7jif4</a>.</p></div></div></div></div></div>
<div class="section" title="Printing GridPanel content with the GridPrinter plugin"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec46"/>Printing GridPanel content with the GridPrinter plugin</h1></div></div></div><p>The <a id="id803" class="indexterm"/>next functionality we will implement is printing the contents of the GridPanel. When the user clicks on the <span class="strong"><strong>Print</strong></span> button, the application will open a new browser window and display the contents of the grid in this new window.</p><p>To do this, we will <a id="id804" class="indexterm"/>use a plugin named <code class="literal">Ext.ux.grid.Printer</code>, which receives the GridPanel reference to be printed, gets the information that is on the Store, generates HTML from this content, and displays the information in a new window.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note83"/>Note</h3><p>The GridPrinter plugin<a id="id805" class="indexterm"/> is a third-party plugin available <a id="id806" class="indexterm"/>at <a class="ulink" href="https://github.com/loiane/extjs4-ux-gridprinter">https://github.com/loiane/extjs4-ux-gridprinter</a>. This plugin will only print the information that is available on the GridPanel Store, meaning if you are using the PagingToolbar, the plugin will only generate the HTML of the current page. The plugin also supports the RowExpander plugin. Please feel free to contribute to this plugin (or any other Ext JS plugin), and this way, we can help in growing the Ext JS community! It works with Ext JS 4 and 5.</p></div></div><p>To install the plugin, we are going to get the contents of the <code class="literal">ux</code> folder and place it inside the <code class="literal">app/ux</code> folder. As Ext JS also ships some plugins within the native SDK with the namespace <code class="literal">Ext.ux</code>, we are going to rename the plugin from <code class="literal">Ext.ux.grid.Printer</code> to <code class="literal">Packt.ux.grid.Printer</code> to avoid conflict (you can search for the occurrences inside the <code class="literal">Printer.js</code> file and replace it). This way, the plugin will be part of the application. The following screenshot demonstrates how the project structure will look after installing the plugin:</p><div class="mediaobject"><img src="graphics/0457OT_09_03.jpg" alt="Printing GridPanel content with the GridPrinter plugin"/></div><p>After <a id="id807" class="indexterm"/>installing the plugin, we simply need to add it to the <code class="literal">requires</code> declaration of <code class="literal">FilmsController</code>:</p><div class="informalexample"><pre class="programlisting">requires: [
    // other requires here
    Packt.ux.grid.Printer'
]</pre></div><p>When the user<a id="id808" class="indexterm"/> clicks on the <span class="strong"><strong>Print</strong></span> button, the controller will execute the following method:</p><div class="informalexample"><pre class="programlisting">onPrint: function(button, e, options) {
    var printer = Packt.ux.grid.Printer;
    printer.printAutomatically = false;
    printer.print(this.lookupReference('filmsGrid'));
},</pre></div><p>The <code class="literal">printAutomatically</code> property means you want the print window to be displayed automatically. If set to <code class="literal">false</code>, the plugin will display the print window, and then, if the user wants to print it, they need to go to the browser's menu and select <span class="strong"><strong>Print</strong></span> (<span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>P</em></span>).</p><p>To make the plugin work, we need to pass the GridPanel reference to the <code class="literal">print</code> method. In this case, we can get the <code class="literal">Films</code> GridPanel reference.</p><p>When we execute the code, we will get the following output:</p><div class="mediaobject"><img src="graphics/0457OT_09_04.jpg" alt="Printing GridPanel content with the GridPrinter plugin"/></div></div>
<div class="section" title="Creating a Sales by Film Category chart"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec47"/>Creating a Sales by Film Category chart</h1></div></div></div><p>Ext JS <a id="id809" class="indexterm"/>provides a great set of visual charts we can implement, and users love things like this. For this reason, we will implement a chart using three different series (pie, column, and bar) where the user can see the <span class="strong"><strong>Sales by Film Category</strong></span>.</p><p>The following is a screenshot of the final result we will have at the end of this topic. As we can see in the following screenshot, we have the chart. Above it, we have a toolbar with two buttons: <span class="strong"><strong>Change Chart Type</strong></span>, where the user will be able to change the chart series from <span class="strong"><strong>Pie</strong></span> to <span class="strong"><strong>Column</strong></span> or <span class="strong"><strong>Bar</strong></span>, and the <span class="strong"><strong>Download Chart</strong></span> button, where the user will be able to download the chart in the following formats: <span class="strong"><strong>Download as Image</strong></span> or <span class="strong"><strong>Download as PDF</strong></span>. Here's the screenshot we are discussing:</p><div class="mediaobject"><img src="graphics/0457OT_09_05.jpg" alt="Creating a Sales by Film Category chart"/></div><div class="section" title="Ext JS 5 charts and terminology"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec95"/>Ext JS 5 charts and terminology</h2></div></div></div><p>Before we <a id="id810" class="indexterm"/>start coding, let's understand a little bit about how Ext JS charts work. Ext JS 4 introduced great charting capabilities by leveraging the HTML5 canvas and SVG features. However, in Ext JS 5, the charts introduced in Ext JS 4 became deprecated. Ext JS 5 introduces a new Sencha Charts package that comes from Sencha Touch, with built-in support for touch, which means we can use touch gestures to interact with the charts.</p><p>You might ask, but why am I interested in touch support in the charts? There are many companies that want to use the same application in tablets without developing a new application with the same capabilities for touch devices. Ext JS 5 offers this capability. We will discuss more about touch support later.</p><p>Sencha <a id="id811" class="indexterm"/>Charts<a id="id812" class="indexterm"/> supports three types of charts:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Cartesian chart</strong></span>: This represents a chart<a id="id813" class="indexterm"/> that uses cartesian coordinates. A cartesian chart<a id="id814" class="indexterm"/> has two directions, the <span class="emphasis"><em>x</em></span> direction and <span class="emphasis"><em>y</em></span> direction. The series and axes are coordinated along these directions. By default, the <span class="emphasis"><em>x</em></span> direction is horizontal and the <span class="emphasis"><em>y</em></span> direction is vertical (the directions can be flipped as well).</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Polar chart</strong></span>: This<a id="id815" class="indexterm"/> represents a<a id="id816" class="indexterm"/> chart that uses polar coordinates. A polar chart has two axes: an angular axis (which is a circle) and a radial axis (a straight line from the center to the edge of the circle). The angular axis is usually a category axis while the radial axis is typically numerical.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Space Filling chart</strong></span>: This<a id="id817" class="indexterm"/> creates a chart that fills the<a id="id818" class="indexterm"/> entire area of the chart, for example, a gauge or a treemap chart.</li></ul></div><p>A chart consists of a <span class="strong"><strong>Legend</strong></span>, <span class="strong"><strong>Axis</strong></span>, <span class="strong"><strong>Series</strong></span>, <span class="strong"><strong>Interaction</strong></span>, and <span class="strong"><strong>Theme</strong></span> and can load data from a Store as displayed in the following image:</p><div class="mediaobject"><img src="graphics/0457OT_09_12.jpg" alt="Ext JS 5 charts and terminology"/></div><p>The <span class="strong"><strong>Series</strong></span><a id="id819" class="indexterm"/> contains the logic about how the data will be rendered in the chart. The series can be <span class="strong"><strong>Pie</strong></span>, <span class="strong"><strong>Line</strong></span>, <span class="strong"><strong>Bar</strong></span>, <span class="strong"><strong>Column</strong></span>, and so on.</p><p>The <span class="strong"><strong>Axis</strong></span><a id="id820" class="indexterm"/> is responsible for rendering the chart axis based on the type of data. There are three types of axes: <code class="literal">numeric</code>, <code class="literal">category</code>, and <code class="literal">time</code>. The <code class="literal">numeric</code> type is used to render numeric values, <code class="literal">category</code> is used to render data that is a finite set (for example, the names of the months of the year), and <code class="literal">time</code> is used to render data that represents time.</p><p>The <span class="strong"><strong>Legend</strong></span><a id="id821" class="indexterm"/> is responsible for displaying the legend box of the chart.</p><p>Sencha Charts also supports interactions. The available<a id="id822" class="indexterm"/> interactions are presented as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Crosshair</strong></span>: This <a id="id823" class="indexterm"/>allows the user to get precise values for a specific point on the chart. The values are obtained by single-touch dragging on the chart.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>CrossZoom</strong></span>: This <a id="id824" class="indexterm"/>allows the user to zoom in on a selected area of the chart.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Item Highlight</strong></span>: This<a id="id825" class="indexterm"/> allows the user to highlight series items in the chart.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Item Info</strong></span>: This<a id="id826" class="indexterm"/> allows displaying detailed information about a series data point in a popup panel.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Pan/Zoom</strong></span>: This<a id="id827" class="indexterm"/> allows the user to navigate the data for one or more chart axes by panning or zooming.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Rotate</strong></span>: This<a id="id828" class="indexterm"/> allows the user to rotate a polar chart about its central point. There is also a special rotate interaction for 3D pie charts.</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note84"/>Note</h3><p>More information about charts can be obtained by diving into the <span class="emphasis"><em>Charts Kitchen Sink</em></span> <a id="id829" class="indexterm"/>example (<a class="ulink" href="http://dev.sencha.com/ext/5.1.0/examples/kitchensink/?charts=true">http://dev.sencha.com/ext/5.1.0/examples/kitchensink/?charts=true</a>) and also into the <code class="literal">charts</code> package (<a class="ulink" href="http://docs.sencha.com/extjs/5.0/5.0.0-apidocs/#!/api/Ext.chart.AbstractChart">http://docs.sencha.com/extjs/5.0/5.0.0-apidocs/#!/api/Ext.chart.AbstractChart</a>) in the documentation.</p></div></div></div><div class="section" title="Adding Sencha Charts to the project"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec96"/>Adding Sencha Charts to the project</h2></div></div></div><p>A very <a id="id830" class="indexterm"/>important<a id="id831" class="indexterm"/> detail: Sencha Charts is available for use in Ext JS 5 applications via a package, meaning the source code of the charts is not available automatically to an application like the grids, forms, and other components. Packages in Sencha applications have a similar concept as gems in Ruby or JARs in Java.</p><p>To <a id="id832" class="indexterm"/>add Sencha Charts to our project, we need to open the <code class="literal">app.json</code> file located in the root folder of the application. Around line 34, we <a id="id833" class="indexterm"/>should find the <code class="literal">requires</code> declaration. We need to add <code class="literal">sencha-charts</code> to <code class="literal">requires</code>. It is going to look like the following:</p><div class="informalexample"><pre class="programlisting">"requires": [
    "sencha-charts"
],</pre></div><p>After this change, if we start using charts in the project, our code should work.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note85"/>Note</h3><p>We cannot forget to have <code class="literal">sencha app watch</code> executed in a terminal application as well.</p></div></div><p>Also, here's the last update we are going to do in the <code class="literal">menu</code> table to be able to see the report option in the application menu:</p><div class="informalexample"><pre class="programlisting">UPDATE `sakila`.`menu` SET `className`='salesfilmcategory' WHERE `id`='13';</pre></div></div><div class="section" title="Creating the Store inside the ViewModel"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec97"/>Creating the Store inside the ViewModel</h2></div></div></div><p>Let's go <a id="id834" class="indexterm"/>back to our code and start implementing some charts. The Store is going to provide the charts with the data. No matter whether we want to create a pie chart or column chart or bar chart, we need a Store to provide the information we want to display.</p><p>As we are going to create charts, we need to create a Store that is going to hold the collection of data especially for the chart, which means it is not going to be used anywhere else in the application. For this reason, we can create it directly inside the ViewModel. So we are going to create a new package named <code class="literal">reports</code> inside the <code class="literal">app/view</code> folder, where we are going to place the files from this topic. We are going to start creating the ViewModel this time, as follows:</p><div class="informalexample"><pre class="programlisting">Ext.define('Packt.view.reports.SalesFilmCategoryModel', {
    extend: 'Ext.app.ViewModel',

    alias: 'viewmodel.sales-film-category',

    stores: {
        salesFilmCategory: {
            fields: [                  // #1
                {name: 'category'},
                {name: 'total_sales'}
            ],
            autoLoad: true,
            proxy: {                  // #2
                type: 'ajax',
                url: 'php/reports/salesFilmCategory.php',
                reader: {
                    type: 'json',
                    rootProperty: 'data'
                }
            }
        }
    }
});</pre></div><p>For this Store, we <a id="id835" class="indexterm"/>will not declare a Model; we are going to declare its <code class="literal">fields</code> (<code class="literal">#1</code>) directly on it. As this Store is going to be used exclusively by the chart, there is no need to create a specific Model for it, as we do not intend to reuse it later.</p><p>We are also going to declare <code class="literal">proxy</code> (<code class="literal">#2</code>) with the <code class="literal">ajax</code>, <code class="literal">url</code>, and <code class="literal">reader</code> details on it. Most of the models we created in the previous chapters were part of a <code class="literal">schema</code> that contained a <code class="literal">proxy</code>. This time, we do not have this information available, so we need to declare it.</p><p>On the server side, we can query the data that will feed the chart from the <code class="literal">sales_by_ film_category</code> view from the Sakila database as follows:</p><div class="informalexample"><pre class="programlisting">SELECT * FROM sales_by_film_category</pre></div></div><div class="section" title="Pie chart"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec98"/>Pie chart</h2></div></div></div><p>Now<a id="id836" class="indexterm"/> that <a id="id837" class="indexterm"/>we are able to retrieve the information we need from the server, let's work on the implementation of the chart. First, we will develop the pie chart, as follows:</p><div class="informalexample"><pre class="programlisting">Ext.define('Packt.view.reports.SalesFilmCategoryPie', {
    extend: 'Ext.chart.PolarChart',      //#1
    alias: 'widget.salesfilmcategorypie',

    legend: {
        docked: 'left'   //#2
    },
    interactions: ['rotate', 'itemhighlight'], //#3

    bind: '{salesFilmCategory}', //#4
    insetPadding: 40,          
    innerPadding: 20,
    series: {
        type: 'pie',       //#5
        highlight: true,
        donut: 20,         //#6
        distortion: 0.6,
        style: {           //#7
            strokeStyle: 'white',
            opacity: 0.90
        },
        label: {
            field: 'category',   //#8
            display: 'rotate'
        },
        tooltip: {               //#9
            trackMouse: true,
            renderer: function(storeItem, item) {
                this.setHtml(storeItem.get('category') + ': ' 
                    + storeItem.get('total_sales'));
            }
        },
        xField: 'total_sales'  //#10
    }
});</pre></div><p>Let's go <a id="id838" class="indexterm"/>through the most important parts <a id="id839" class="indexterm"/>of the preceding code; first, we need to extend the <code class="literal">PolarChart</code> class (<code class="literal">#1</code>) because we want to implement a chart with a <code class="literal">pie</code> series (<code class="literal">#5</code>).</p><p>Next, we are going to add <code class="literal">legend</code> to this chart, and we are going to dock it on the <code class="literal">left</code> (<code class="literal">#2</code>). We are also going to add some interactions to this chart (<code class="literal">#3</code>). The user is going to be able to rotate and highlight the slices of <code class="literal">pie</code>. We are going to bind the Store (<code class="literal">#4</code>) we declared in the ViewModel as well.</p><p>Next, there is the <code class="literal">series</code> configuration that defines what <code class="literal">type</code> of chart we are implementing (<code class="literal">#5</code>), which is the <code class="literal">pie</code> chart in this case. The <code class="literal">pie</code> chart needs a field that is going to be used to do the sum and then calculate the fraction of each piece. We only have two fields, and <code class="literal">total_sales</code> (<code class="literal">#10</code>) is the numeric one, so we will use this field. The <code class="literal">donut</code> configuration (<code class="literal">#6</code>) sets the radius of the donut. This chart is actually a donut chart (because of the hole in the middle of the pie).</p><p>We can also style our chart (<code class="literal">#7</code>). The style in this example will add some white lines separating each slice of the chart.</p><p>Inside each slice, we also want to display its film category so that we can easily identify it. We can do this by adding the <code class="literal">label</code> configuration (<code class="literal">#8</code>) to <code class="literal">series</code>.</p><p>On the <code class="literal">tooltip</code> <a id="id840" class="indexterm"/>configuration, we can define whether we want to display <a id="id841" class="indexterm"/>a quick tip or not (<code class="literal">#9</code>). In this case, we want Ext JS to track the movements of the mouse, and if the user does a mouseover over any item of the chart, Ext JS will display a tip with the name of <code class="literal">category</code> and the <code class="literal">total_sales</code> number.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note86"/>Note</h3><p>It is also possible to define <code class="literal">theme</code> in the chart. We can do so by adding the configuration <code class="literal">theme</code> in this class. The possible values we can set are: <code class="literal">'green'</code>, <code class="literal">'sky'</code>, <code class="literal">'red'</code>, <code class="literal">'purple'</code>, <code class="literal">'blue'</code>, <code class="literal">'yellow'</code>—<code class="literal">'category1'</code> to <code class="literal">'category6'</code>—and the mentioned theme names with the '<code class="literal">-gradients'</code> suffix (<code class="literal">'green-gradients'</code> and so on).</p></div></div></div><div class="section" title="3D column chart"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec99"/>3D column chart</h2></div></div></div><p>As we can<a id="id842" class="indexterm"/> change the chart <code class="literal">type</code>, we will <a id="id843" class="indexterm"/>also<a id="id844" class="indexterm"/> implement a column chart that looks like the following screenshot:</p><div class="mediaobject"><img src="graphics/0457OT_09_06.jpg" alt="3D column chart"/></div><p>So let's get our hands on the code, which is as follows:</p><div class="informalexample"><pre class="programlisting">Ext.define('Packt.view.reports.SalesFilmCategoryColumn', {
    extend: 'Ext.chart.CartesianChart',  //#1
    alias: 'widget.salesfilmcategorycol',

    bind: '{salesFilmCategory}', //#2

    insetPadding: {
        top: 40,
        bottom: 40,
        left: 20,
        right: 40
    },
    interactions: 'itemhighlight', //#3

    //axes
    //series
});</pre></div><p>The <a id="id845" class="indexterm"/>column chart <a id="id846" class="indexterm"/>extends from the <code class="literal">CartesianChart</code> class (<code class="literal">#1</code>) because we want to display a chart with <span class="emphasis"><em>x</em></span> and <span class="emphasis"><em>y</em></span> axes. We will also use the same Store we used in the pie chart (<code class="literal">#2</code>), and the user will also be able to highlight (<code class="literal">#3</code>) the columns in this chart.</p><p>Let's take a look at the <code class="literal">axes</code> declaration in the following code:</p><div class="informalexample"><pre class="programlisting">axes: [{
    type: 'numeric',   //#4
    position: 'left',
    fields: ['total_sales'],
    label: {
        renderer: Ext.util.Format.numberRenderer('0,0')
    },
    titleMargin: 20,
    title: {
        text: 'Total Sales',
        fontSize: 14
    },
    grid: true,
    minimum: 0
}, {
    type: 'category', //#5
    position: 'bottom',
    fields: ['category'],
    titleMargin: 20,
    title: {
        text: 'Film Category',
        fontSize: 14
    }
}],</pre></div><p>We have two <code class="literal">axes</code> <a id="id847" class="indexterm"/>in a column chart. The <span class="emphasis"><em>x</em></span> axis is going to display <code class="literal">category</code> (<code class="literal">#5</code>), which is going to be placed at the <code class="literal">bottom</code>, and the <span class="emphasis"><em>y</em></span> axis is going to display the <code class="literal">numeric</code> (#4) data that is going to be displayed in the <code class="literal">right</code> or <code class="literal">left</code> (in this example, we chose <code class="literal">left</code>). In the case of a bar chart, all we have to do is swap the axes. The <code class="literal">category</code> value becomes the <span class="emphasis"><em>y</em></span> axis and the <code class="literal">numeric</code> values become the <span class="emphasis"><em>x</em></span> axis.</p><p>Let's take a look at the <code class="literal">series</code> configuration to finish configuring our chart:</p><div class="informalexample"><pre class="programlisting">series: [{
    type: 'bar3d', //#6
    highlight: true,
    style: {
        minGapWidth: 20
    },
    label: {
        display: 'insideEnd',
        'text-anchor': 'middle',
        field: 'total_sales',     //#7
        renderer: Ext.util.Format.numberRenderer('0'),
        orientation: 'vertical',
        color: '#333'
    },
    xField: 'category',   //#8
    yField: 'total_sales' //#9
}]</pre></div><p>In this example, we <a id="id848" class="indexterm"/>are implementing a 3D column chart (<code class="literal">#6</code>) that can also be used as a 3D bar chart. If we want to implement the normal chart, the series type would be <code class="literal">'bar'</code>. As mentioned before, column and bar charts are very similar; only the configuration of the <span class="emphasis"><em>x</em></span> and <span class="emphasis"><em>y</em></span> axes are swapped. If we want to display a <code class="literal">label</code> (<code class="literal">#7</code>), we can also configure one.</p><p>It is important to note that <code class="literal">xField</code> (<code class="literal">#8</code>) matches the <code class="literal">Category</code> axis (<code class="literal">#5</code>), and <code class="literal">yField</code> (<code class="literal">#9</code>) matches the <code class="literal">Numeric</code> axis (vertical/<code class="literal">left</code> position—(<code class="literal">#4</code>)).</p><p>The bar chart code is exactly the same as the column chart code with a small change. We need to invert <code class="literal">Axis</code> (<code class="literal">Category</code> will be <code class="literal">left</code> and <code class="literal">Numeric</code> will be <code class="literal">bottom</code>), <code class="literal">xField</code> (which will be <code class="literal">total_sales</code> instead of <code class="literal">category</code>), and <code class="literal">yField</code> (which will be <code class="literal">category</code> instead of <code class="literal">total_sales</code>).</p><p>The bar chart<a id="id849" class="indexterm"/> is going to look as follows:</p><div class="mediaobject"><img src="graphics/0457OT_09_07.jpg" alt="3D column chart"/></div></div><div class="section" title="The Chart panel"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec100"/>The Chart panel</h2></div></div></div><p>As we<a id="id850" class="indexterm"/> want to display a panel and offer the user the possibility to change the chart type, we will create a panel and use the Card layout. To refresh our memory, the Card layout is mostly used for wizards and also when we have several items but want to display only one at a time. And the item that is currently being displayed uses the FitLayout.</p><p>So let's create<a id="id851" class="indexterm"/> a Chart panel, as follows:</p><div class="informalexample"><pre class="programlisting">Ext.define('Packt.view.reports.SalesFilmCategory', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.salesfilmcategory',

    requires: [
        'Packt.view.reports.SalesFilmCategoryModel',
        'Packt.view.reports.SalesFilmCategoryController',
        'Packt.view.reports.SalesFilmCategoryPie',
        'Packt.view.reports.SalesFilmCategoryColumn',
        'Packt.view.reports.SalesFilmCategoryBar',
        'Packt.util.Glyphs'
    ],

    controller: 'sales-film-category', //#1
    viewModel: {
        type: 'sales-film-category'   //#2
    },

    layout: 'card',
    activeItem: 0,

    items: [{
        xtype: 'salesfilmcategorypie' //#3
    },{
        xtype: 'salesfilmcategorycol' //#4
    },{
        xtype: 'salesfilmcategorybar' //#5
    }],

    dockedItems: [{
        xtype: 'toolbar',
        flex: 1,
        dock: 'top',
        items: [
            //items of toolbar here #6
        ]
    }]
});</pre></div><p>So we need to<a id="id852" class="indexterm"/> declare <code class="literal">panel</code> and declare<a id="id853" class="indexterm"/> each chart we created as an item. So we can declare the pie chart (<code class="literal">#3</code>), the column chart (<code class="literal">#4</code>), and the bar chart (<code class="literal">#5</code>) as items of a <span class="strong"><strong>Sales by Film Category</strong></span> panel. By default, the item <code class="literal">0</code> (which is the first item—pie chart) is going to be the default item to be displayed when the Chart panel is rendered.</p><p>We also cannot forget to declare the ViewModel (<code class="literal">#2</code>) and the ViewController (<code class="literal">#1</code>), which we are going to create next.</p><p>All the classes we mention are <code class="literal">xtype</code> of which(<code class="literal">#1</code> to <code class="literal">#5</code>) are inside <code class="literal">requires</code> declaration.</p><p>Next, we can declare the toolbar that will contain the button with the menu so that the user can choose <code class="literal">Chart Type</code> and <code class="literal">Download Type</code>. We will add the following code in the place where we have the comment in the preceding code (<code class="literal">#6</code>):</p><div class="informalexample"><pre class="programlisting">{
    text: 'Change Chart Type',
    glyph: Packt.util.Glyphs.getGlyph('menuReports'),
    menu: {
        xtype: 'menu',
        defaults: {
            listeners: {
                click: 'onChangeChart' //#7
            }
        },
        items: [
            {
                xtype: 'menuitem',
                text: 'Pie',
                itemId: 'pie',  //#8
                glyph: Packt.util.Glyphs.getGlyph('chartPie')
            },
            {
                xtype: 'menuitem',
                text: 'Column',
                itemId: 'column',  //#9
                glyph: Packt.util.Glyphs.getGlyph('chartBar')
            },
            {
                xtype: 'menuitem',
                text: 'Bar',
                itemId: 'bar',  //#10
                glyph: Packt.util.Glyphs.getGlyph('chartColumn')
            }
        ]
    }
},</pre></div><p>For the preceding<a id="id854" class="indexterm"/> menu, all menu items <a id="id855" class="indexterm"/>have the same <code class="literal">listener</code> declaration (<code class="literal">#7</code>). Instead of having the same code declare three times, we will have it declare only once in the ViewController. To help us identify which menu item fired the event, we are also going to declare <code class="literal">itemId</code> for each menu item on lines <code class="literal">#8</code>, <code class="literal">#9</code>, and <code class="literal">#10</code>. The output of the preceding code is displayed in the following screenshot:</p><div class="mediaobject"><img src="graphics/0457OT_09_08.jpg" alt="The Chart panel"/></div><p>As the<a id="id856" class="indexterm"/> second <code class="literal">item</code> of the toolbar, we have the <span class="strong"><strong>Download Chart</strong></span> button. Following the same behavior<a id="id857" class="indexterm"/> as the <span class="strong"><strong>Change Chart Type</strong></span> button, the <span class="strong"><strong>Download Chart</strong></span> button also has a menu with two menu items in it, one for each download type, as follows:</p><div class="informalexample"><pre class="programlisting">{
    text: 'Download Chart',
    glyph: Packt.util.Glyphs.getGlyph('download'),
    menu: {
        xtype: 'menu',
        defaults: {
            listeners: {
                click: 'onChartDownload' //#11
            }
        },
        items: [
            {
                xtype: 'menuitem',
                text: 'Download as Image',
                itemId: 'png',
                glyph: Packt.util.Glyphs.getGlyph('image')
            },
            {
                xtype: 'menuitem',
                text: 'Download as PDF',
                itemId: 'pdf',
                glyph: Packt.util.Glyphs.getGlyph('pdf')
            }
        ]
    }
}</pre></div><p>We will have <code class="literal">listener</code> (<code class="literal">#11</code>) for this menu in the ViewController. The output for the preceding code will be the following:</p><div class="mediaobject"><img src="graphics/0457OT_09_09.jpg" alt="The Chart panel"/></div></div><div class="section" title="The ViewController"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec101"/>The ViewController</h2></div></div></div><p>Before we <a id="id858" class="indexterm"/>develop the two methods we need to implement to close this chapter, let's declare the structure of the <code class="literal">ViewController</code> for the <code class="literal">reports</code> module:</p><div class="informalexample"><pre class="programlisting">Ext.define('Packt.view.reports.SalesFilmCategoryController', {
    extend: 'Ext.app.ViewController',

    alias: 'controller.sales-film-category',

    //methods here
});</pre></div><p>Next, we will see how to develop the <code class="literal">onChangeChart</code> and <code class="literal">onChartDownload</code> methods.</p><div class="section" title="Changing the chart type"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec57"/>Changing the chart type</h3></div></div></div><p>As the <a id="id859" class="indexterm"/>user has the capability to change the chart type by choosing an option from the menu, we will develop the following method:</p><div class="informalexample"><pre class="programlisting">onChangeChart: function(item, e, options) {
    var panel = this.getView(); // #1

    if (item.itemId == 'pie'){
        panel.getLayout().setActiveItem(0); // #2
    } else if (item.itemId == 'column'){
        panel.getLayout().setActiveItem(1); // #3
    } else if (item.itemId == 'bar'){
        panel.getLayout().setActiveItem(2); // #4
    }
}</pre></div><p>First, we need to get the Chart panel. We can simply retrieve it by calling the <code class="literal">getView</code> method from the ViewController (<code class="literal">#1</code>).</p><p>As the menu item that was clicked on fired the event click, the first parameter this method receives is the item itself. We can get its <code class="literal">itemId</code> property to compare which <code class="literal">itemId</code> the user clicked on, and we set <code class="literal">ActiveItem</code> accordingly (<code class="literal">#2</code>, <code class="literal">#3</code>, and <code class="literal">#4</code>) to the option the user chose.</p><p>The <code class="literal">setActiveItem</code> method is from the Card layout. From the View, we can get the layout, which will return an instance of the Card layout, and the method will be available.</p></div><div class="section" title="Exporting charts to images (PNG or JPEG)"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec58"/>Exporting charts to images (PNG or JPEG)</h3></div></div></div><p>On the <code class="literal">onChartDownload</code> method, we <a id="id860" class="indexterm"/>will follow the same logic as we did for the <span class="strong"><strong>Change Chart Type</strong></span> menu items. But in this case, we want to save the chart as an image (PNG) or PDF file. Here's how we go about the task:</p><div class="informalexample"><pre class="programlisting">onChartDownload: function(item, e, options) {
    var panel = this.getView();
    var chart = panel.getLayout().getActiveItem(); //#1

    if (item.itemId == 'png'){
        Ext.MessageBox.confirm('Confirm Download', 
            'Would you like to download the chart as Image?', function(choice){
            if(choice == 'yes'){
                chart.download({   //#2
                    format: 'png', 
                    filename: 'SalesXFilmCategory'
                });
            }
        });
    } else if (item.itemId == 'pdf'){
        Ext.MessageBox.confirm('Confirm Download', 
            'Would you like to download the chart as PDF?', function(choice){
            if(choice == 'yes'){
                chart.download({  //#3
                    format: 'pdf',
                    filename: 'SalesXFilmCategory',
                    pdf: {
                        format: 'A4',
                        orientation: 'landscape',
                        border: '1cm'
                    }
                });
            }
        });
    }
}</pre></div><p>The <code class="literal">Chart</code> class already has a method named <code class="literal">download</code>, which we can use to download the chart in different formats. This is a native feature from Ext JS.</p><p>So first, we need to get a reference of the <code class="literal">Chart</code> class, which we can get through <code class="literal">ActiveItem</code> of the Chart panel (<code class="literal">#1</code>).</p><p>Then, depending on the user's choice, we will first ask whether the user really wants to download the chart in the specific format, and if yes, we will ask Ext JS to generate the file. So, if the user chooses to download in PNG (<code class="literal">#2</code>) or PDF (<code class="literal">#3</code>), we simply need to call the method <code class="literal">download</code> from the chart reference, passing the specific type selected by the user. In this case, the application will send a request to <code class="literal">http://svg.sencha.io</code> and the download will start.</p><p>According to the<a id="id861" class="indexterm"/> documentation, we can pass an object configuration to the <code class="literal">download</code> method with some options:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">url</code>: This <a id="id862" class="indexterm"/>is the URL to post the data to. This defaults to the Sencha IO.</li><li class="listitem" style="list-style-type: disc"><code class="literal">format</code>: This<a id="id863" class="indexterm"/> is the format of the image to export. This defaults to <code class="literal">'png'</code>. The possible values are <code class="literal">png</code>, <code class="literal">pdf</code>, <code class="literal">jpeg</code>, and <code class="literal">gif</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">width</code>: This <a id="id864" class="indexterm"/>is a width value to send to the server to configure the image width. This defaults to the natural image width on the Sencha IO server.</li><li class="listitem" style="list-style-type: disc"><code class="literal">height</code>: This<a id="id865" class="indexterm"/> is a height value to send to the server to configure the image height. This defaults to the natural image height on the Sencha IO server.</li><li class="listitem" style="list-style-type: disc"><code class="literal">filename</code>: This<a id="id866" class="indexterm"/> is the filename of the downloaded image. This defaults to <code class="literal">'chart'</code> on the Sencha IO server. The <code class="literal">config.format</code> is used as a filename extension.</li><li class="listitem" style="list-style-type: disc"><code class="literal">pdf</code>: This<a id="id867" class="indexterm"/> is a PDF-specific option. This configuration is only used if <code class="literal">config.format</code> is set to <code class="literal">'pdf'</code>. Check the documentation for more details.</li><li class="listitem" style="list-style-type: disc"><code class="literal">jpeg</code>: This<a id="id868" class="indexterm"/> is a JPEG-specific option. This configuration is only used if <code class="literal">config.format</code> is set to <code class="literal">'jpeg'</code>. Check the documentation for more details.</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note87"/>Note</h3><p>If you are planning to have the application running in a device with touch support, it is recommended that you use the method <code class="literal">preview</code> instead of <code class="literal">download</code>. The <code class="literal">preview</code> method opens a popup with the chart image, and in this case, the user can use the native capability of the device to save the image.</p></div></div><p>The following screenshot is from an image that was generated by choosing to save the chart as PNG:</p><div class="mediaobject"><img src="graphics/0457OT_09_10.jpg" alt="Exporting charts to images (PNG or JPEG)"/></div><p>If you want to<a id="id869" class="indexterm"/> generate the image or the PDF in your own server, you can specify the <code class="literal">url</code> where the data is going to be posted. In the server, you can retrieve a POST variable named <code class="literal">data</code>. The variable has the following content (it is a <span class="emphasis"><em>Base64</em></span> image) that can be manipulated in the server to return an image or PDF or other required format:</p><div class="mediaobject"><img src="graphics/0457OT_09_11.jpg" alt="Exporting charts to images (PNG or JPEG)"/></div></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec48"/>Summary</h1></div></div></div><p>In this chapter, we learned how to export the content of a GridPanel to PDF, Excel, and also a page that is printer-friendly.</p><p>We have also learned how to create different types of charts, use only one component and change its active item, and export a chart to an image or PDF using Ext JS native features.</p><p>In the next chapter, we will learn how to test the application, how to enable touch support (so that we can execute the application from a tablet or smartphone), and also how to enable routing.</p></div></body></html>