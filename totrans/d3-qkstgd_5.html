<html><head></head><body>
        

                            
                    <h1 class="header-title">Creating a Bar Graph Using a Data File</h1>
                
            
            
                
<p><strong>AJAX</strong> stands for <strong>Asynchronous JavaScript And XML</strong>. Basically, what we can do is use JavaScript to load data into the page after it has loaded. This is a great way to generate a graph based on user interaction. In this chapter, we'll use AJAX to build a bar graph. By the end of the chapter, you should be able to do the following:</p>
<ul>
<li>Use AJAX to make an asynchronous call to an external data file</li>
<li>Create a bar graph</li>
</ul>
<p>The complete code for this section can be found here: <a href="https://github.com/PacktPublishing/D3.js-Quick-Start-Guide/tree/master/Chapter05" target="_blank">https://github.com/PacktPublishing/D3.js-Quick-Start-Guide/tree/master/Chapter05</a>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Setting up our application</h1>
                
            
            
                
<p>Let's create our standard setup in <kbd>index.html</kbd>:</p>
<div><pre>&lt;!DOCTYPE html&gt;
&lt;html lang="en" dir="ltr"&gt;
    &lt;head&gt;
        &lt;link rel="stylesheet" href="app.css"&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;svg&gt;&lt;/svg&gt;
        &lt;script src="img/d3.v5.min.js"&gt;&lt;/script&gt;
        &lt;script src="img/app.js" charset="utf-8"&gt;&lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre>
<p>Now add the following code to <kbd>app.js</kbd>:</p>
</div>
<div><pre>var WIDTH = 800;
var HEIGHT = 600;

d3.select('svg')
    .style('width', WIDTH)
    .style('height', HEIGHT);</pre>
<p>Now add the following code to <kbd>app.css</kbd>:</p>
</div>
<div><pre>svg {
    border:1px solid black;
}</pre></div>
<p>This is what we should have:</p>
<div><img class="aligncenter size-full wp-image-413 image-border" src="img/7dc454cf-35e3-4cc9-bda7-9bc5192a728e.png" style=""/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Creating an external file to hold our data</h1>
                
            
            
                
<p>Let's create a <kbd>data.json</kbd> file, which will hold fake data regarding how often job posts require certain skills. This should be the contents of the file:</p>
<div><pre>[
  {
    "name": "HTML",
    "count": 21
  },
  {
    "name": "CSS",
    "count": 17
  },
  {
    "name": "Responsive Web Design",
    "count": 17
  },
  {
    "name": "JavaScript",
    "count": 17
  },
  {
    "name": "Git",
    "count": 16
  },
  {
    "name": "Angular.js",
    "count": 9
  },
  {
    "name": "Node.js",
    "count": 9
  },
  {
    "name": "PostgreSQL",
    "count": 8
  },
  {
    "name": "Agile Project Management",
    "count": 8
  },
  {
    "name": "MongoDB",
    "count": 7
  },
  {
    "name": "Trello",
    "count": 7
  },
  {
    "name": "Testing / TDD",
    "count": 7
  },
  {
    "name": "jQuery",
    "count": 7
  },
  {
    "name": "User Testing",
    "count": 6
  },
  {
    "name": "MySQL",
    "count": 6
  },
  {
    "name": "PHP",
    "count": 6
  },
  {
    "name": "React.js",
    "count": 6
  },
  {
    "name": "AJAX",
    "count": 6
  },
  {
    "name": "Express.js",
    "count": 5
  },
  {
    "name": "Heroku",
    "count": 5
  },
  {
    "name": "Wireframing",
    "count": 5
  },
  {
    "name": "Sass/SCSS",
    "count": 5
  },
  {
    "name": "Mobile Web",
    "count": 4
  },
  {
    "name": "Rails",
    "count": 4
  },
  {
    "name": "WordPress",
    "count": 4
  },
  {
    "name": "Drupal",
    "count": 3
  },
  {
    "name": "Ruby",
    "count": 3
  },
  {
    "name": "Ember.js",
    "count": 3
  },
  {
    "name": "Python",
    "count": 3
  },
  {
    "name": "Amazon EC2",
    "count": 2
  },
  {
    "name": "Computer Science degree",
    "count": 1
  },
  {
    "name": "Backbone.js",
    "count": 1
  },
  {
    "name": "Less",
    "count": 1
  },
  {
    "name": "Prototyping",
    "count": 1
  },
  {
    "name": "Redis",
    "count": 1
  }
]</pre></div>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Making an AJAX request</h1>
                
            
            
                
<p>Now we're going to use JavaScript to make a request for some data.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Writing the basic code</h1>
                
            
            
                
<p>D3 has lots of different methods for making AJAX requests to files of different data types:</p>
<div><pre>d3.json('path').then(function(data){
    //do something with the json data here
});
d3.csv('path').then(function(data){
    //do something with the csv data here
});
d3.tsv('path').then(function(data){
    //do something with the tsv data here
});
d3.xml('path').then(function(data){
    //do something with the xml data here
});
d3.html('path').then(function(data){
    //do something with the html data here
});
d3.text('path').then(function(data){
    //do something with the text data here
});</pre></div>
<p>Since our data is in JSON format, we'll use the first kind of call. Add the following to the end of <kbd>app.js</kbd>:</p>
<div><pre>d3.json('data.json').then(function(data){ console.log(data); });</pre></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Handling file access</h1>
                
            
            
                
<p>If you opened the <kbd>index.html</kbd> file in Chrome directly, instead of serving it on a web server, you'll notice we've encountered an error. Check your developer console:</p>
<div><img class="aligncenter size-full wp-image-687 image-border" src="img/97d9f57d-79f0-4466-a747-686d85c3dbbd.png" style=""/></div>
<p class="CDPAlignLeft CDPAlign">The issue here is that web browsers are not supposed to make AJAX requests to files on your computer. If they could, this would be a huge security flaw because any website could access files on your computer. Let's create a basic file server. To do this, you'll need to <kbd>installNode.js</kbd> (<a href="https://nodejs.org/en/">https://nodejs.org/en/</a>). Once that's done, open your computer's Terminal:</p>
<ul>
<li>For Mac: command + <em>Space</em>, and then type <kbd>terminal</kbd> and hit Ent<em>er</em>.</li>
<li>For Windows: click Start, type <kbd>cmd</kbd>,and hit <em>Enter</em>.</li>
</ul>
<p>Next, type the following into your Terminal:</p>
<pre><strong>npm install -g http-server</strong></pre>
<p>If you get error messages, try this:</p>
<pre><strong>sudo npm install -g http-server</strong></pre>
<p>This installs a basic <kbd>http-server</kbd> that was built using <kbd>Node.js</kbd>. To run it, use the Terminal to navigate to the directory where you saved your code (type <kbd>cd</kbd> to change folders in the Terminal) and run the following:</p>
<pre><strong>http-server .</strong></pre>
<p>You should see something such as this:</p>
<div><img class="aligncenter size-full wp-image-415 image-border" src="img/313081e8-4b43-4e47-8f9c-728a3748404d.png" style=""/></div>
<p class="CDPAlignLeft CDPAlign">Now go to <kbd>http://localhost:8080/</kbd> in your browser. You should now see that your AJAX call is succeeding (if you have issues, hold down shift and hit the refresh button to force the browser to reload all files that may have been cached):</p>
<div><img class="aligncenter size-full wp-image-688 image-border" src="img/84654d3a-5564-42b0-bf0e-ba156a9be601.png" style=""/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Using AJAX data to create SVG elements</h1>
                
            
            
                
<p>Now that our AJAX calls are succeeding, let's start building our app. From here on out, it's all basic JavaScript and D3. Note that everything we'll write for the rest of this lesson is done within the success callback of our AJAX request. In production, we might want to move this code elsewhere, but for now this is easier for learning. Let's create some rectangles for our bar graph. The bottom of <kbd>app.js</kbd> (the callback to the AJAX request) should now look as follows:</p>
<div><pre>d3.json('data.json').then(function(data){
    d3.select('svg').selectAll('rect')
        .data(data)
        .enter()
        .append('rect');
});</pre></div>
<p class="mce-root"/>
<p>Our <strong>Elements</strong> tab in our dev tools should look something like this:</p>
<div><img class="aligncenter size-full wp-image-416 image-border" src="img/d312da58-cc1a-4bd8-ad7a-562469936047.png" style=""/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Adjusting the height and the width of the bars</h1>
                
            
            
                
<p>Let's create a scale that maps the <kbd>count</kbd> property of each element in <kbd>data</kbd> to a visual height for the corresponding bar. We'll use a linear scale. Remember to map <kbd>HEIGHT</kbd> of the graph to a very low data point and the top of the graph (<kbd>0</kbd> in the range) map to a very high data value. Add this code to the bottom of the AJAX callback:</p>
<div><pre>var yScale = d3.scaleLinear();
yScale.range([HEIGHT, 0]);
var yMin = d3.min(data, function(datum, index){
    return datum.count;
})
var yMax = d3.max(data, function(datum, index){
    return datum.count;
})
yScale.domain([yMin, yMax]);</pre></div>
<p>We could use <kbd>d3.extent</kbd>, but we're going to need the individual min values later on. Immediately after the previous code, let's tell D3 to adjust the height of the rectangles using the <kbd>yScale</kbd>. Remember that the <em>y</em> axis is flipped. A low data value produces a high range value. But even though the range is high, the bar itself should be small. We'll need to re-flip the values just for height so that a low data value produces a small bar and a high data value produces a large bar. To do this, let's subtract whatever the range point is from <kbd>HEIGHT</kbd> of the graph. This way, if <kbd>yScale(datum.count)</kbd> produces, say, 500, the height of the bar will be 100. We can use <kbd>yScale(datum.count)</kbd> normally when adjusting the position of the bars later. Add the following to the bottom of the AJAX callback:</p>
<div><pre>d3.selectAll('rect')
    .attr('height', function(datum, index){
        return HEIGHT-yScale(datum.count);
    });</pre></div>
<p>Now our rectangles have height, but no width:</p>
<div><img class="aligncenter size-full wp-image-417 image-border" src="img/da5dc03c-ca41-4b9a-8a39-1ce0511855c8.png" style=""/></div>
<p>At the bottom of <kbd>app.css</kbd>, let's give all our bars the same width:</p>
<div><pre>rect {
    width: 15px;
}</pre>
<p>Here's what we should see in Chrome now:</p>
<div><img class="aligncenter size-full wp-image-418 image-border" src="img/481f4a84-0d7f-4699-b9a3-51ade773989b.png" style=""/></div>
</div>


            

            
        
    

        

                            
                    <h1 class="header-title">Adjusting the horizontal and the vertical placement of the bars</h1>
                
            
            
                
<p>Our bars all overlap one another at the moment. Let's space them out by mapping <em>x</em>'s position to index in the data array. Add the following to the bottom of the AJAX callback:</p>
<div><pre>var xScale = d3.scaleLinear(); xScale.range([0, WIDTH]); xScale.domain([0, data.length]); d3.selectAll('rect') .attr('x', function(datum, index){ return xScale(index); });</pre></div>
<p>This maps indices in the array to horizontal range points. Chrome should look as follows:</p>
<div><img class="aligncenter size-full wp-image-419 image-border" src="img/36de3793-9513-4a33-bbdb-630de03aae7e.png" style=""/></div>
<p>Now let's move the bars so they grow from the bottom, as opposed to hanging from the top. Add the following to the end of the AJAX callback:</p>
<pre>d3.selectAll('rect')<br/>    .attr('y', function(datum, index){<br/>        return yScale(datum.count);<br/>    });</pre>
<p>Using our <kbd>yScale</kbd> function, a high data value produces a low range value, which doesn't push a large bar down much. A low data point produces a high range value, which pushes a small bar down a lot.</p>
<p>Our last few bars don't have any height, because we've mapped the minimum count property of our data to a visual range value of 0 in <kbd>yScale</kbd>. Let's adjust the last line of this code:</p>
<div><pre>var yScale = d3.scaleLinear();
yScale.range([HEIGHT, 0]);
var yMin = d3.min(data, function(datum, index){
    return datum.count;
})
var yMax = d3.max(data, function(datum, index){
    return datum.count;
})
yScale.domain([yMin, yMax]);</pre></div>
<p>We will change it to this code:</p>
<div><pre>var yScale = d3.scaleLinear();
yScale.range([HEIGHT, 0]);
var yMin = d3.min(data, function(datum, index){
    return datum.count;
})
var yMax = d3.max(data, function(datum, index){
    return datum.count;
})
yScale.domain([yMin-1, yMax]); //adjust this line</pre></div>
<p>Now the domain minimum is one less than what's actually in our data set. Domains with the original minimum are treated as higher values than what's expected for the minimum of the graph. We get this:</p>
<div><img class="aligncenter size-full wp-image-420 image-border" src="img/34cf9294-2787-496e-a9af-354d2f402d41.png" style=""/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Making the width of the bars dynamic</h1>
                
            
            
                
<p>Currently, our bars have a fixed width. No matter how many elements we have, they have a 15 px width. If we had more data elements, the bars could overlap. Let's change this. Since each <kbd>rect</kbd> will be the same width, no matter what the data is, we can just assign <kbd>width</kbd> a computed value. Add the following to the end of the AJAX callback:</p>
<div><pre>d3.selectAll('rect')
    .attr('width', WIDTH/data.length);</pre></div>
<p>Now let's adjust our <kbd>rect</kbd> CSS so our bars are more visible:</p>
<div><pre>rect {
    /*  remove the width rule that was here */
    stroke:white;
    stroke-width:1px;
}</pre>
<p>The output will be shown as follows:</p>
<div><img class="aligncenter size-full wp-image-421 image-border" src="img/fcf980d3-2e3e-486c-970f-3857c60f4bff.png" style=""/></div>
</div>


            

            
        
    

        

                            
                    <h1 class="header-title">Changing the color of the bar based on data</h1>
                
            
            
                
<p>Right now, the bars are black. A linear scale will interpolate between colors, just like a regular number. Add the following to the end of the AJAX callback:</p>
<div><pre>var yDomain = d3.extent(data, function(datum, index){
    return datum.count;
})
var colorScale = d3.scaleLinear();
colorScale.domain(yDomain)
colorScale.range(['#00cc00', 'blue'])
d3.selectAll('rect')
    .attr('fill', function(datum, index){
        return colorScale(datum.count)
    })</pre></div>
<p>Notice that we calculate they Domain using <kbd>d3.extent</kbd> so that the real minimum of the data set is used to map <kbd>#00cc00</kbd>:</p>
<div><img class="aligncenter size-full wp-image-422 image-border" src="img/df8c385d-d6d3-4b4e-ac5c-f5967e8fbcf9.png" style=""/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Adding axes</h1>
                
            
            
                
<p>The left axis is the same as shown in <a href="e503bfe5-4b90-47eb-bae0-d588a9b545d5.xhtml" target="_blank"/><a href="e503bfe5-4b90-47eb-bae0-d588a9b545d5.xhtml" target="_blank">Chapter 4</a>, <em>Making a Basic Scatter Plot Interactive</em>. Add this code to the bottom of the AJAX callback:</p>
<div><pre>var leftAxis = d3.axisLeft(yScale);
d3.select('svg')
    .append('g').attr('id', 'left-axis')
    .call(leftAxis);</pre></div>
<p>To create the bottom axis, we need to be able to map strings to points on a domain. We'll use a band scale for this, which just divides up the range into equal parts and maps it to an array of discrete values (values that can't be interpolated, for example, strings). Add this code to the bottom of the AJAX callback:</p>
<div><pre>var skillScale = d3.scaleBand();
var skillDomain = data.map(function(skill){
    return skill.name
});
skillScale.range([0, WIDTH]);
skillScale.domain(skillDomain);</pre></div>
<p>Notice we use <kbd>data.map()</kbd>. This is regular JavaScript that simply loops through an array and modifies each element based on the given function. It then returns the resulting array, leaving the original array in tact. In the previous example, <kbd>skillDomain</kbd> will be an array containing the various name properties of each of the data elements.</p>
<p>Once we have an array of each of the skills, we use this as the domain and map each skill to a point within the range. Remember the point in the range is created by dividing up the full range equally based on the number of elements in the domain.</p>
<p>Now that we have a scale that maps each skill text to a point in the <em>x</em> range, we can create the bottom axis as before. Add this code to the bottom of the AJAX callback:</p>
<div><pre>var bottomAxis = d3.axisBottom(skillScale);
d3.select('svg')
    .append('g').attr('id', 'bottom-axis')
    .call(bottomAxis)
    .attr('transform', 'translate(0,'+HEIGHT+')');</pre></div>
<p>We still need to stop the <kbd>&lt;svg&gt;</kbd> element from clipping the axes. Change the CSS for <kbd>svg</kbd> in <kbd>app.css</kbd>:</p>
<div><pre>svg {
    overflow: visible;
}</pre></div>
<p>The following is the result:</p>
<div><img class="aligncenter size-full wp-image-423 image-border" src="img/2108ac7d-1a29-4a59-9aa0-614fbd3f03b9.png" style=""/></div>
<p>The bottom axis text is all cluttered, though. Let's add some CSS to bottom of <kbd>app.css</kbd> to fix this:</p>
<div><pre>#bottom-axis text {
    transform:rotate(45deg);
}</pre>
<p>The output will be shown as follows:</p>
<div><img class="aligncenter size-full wp-image-424 image-border" src="img/39695da5-7beb-4dd5-b2bb-9e4abbf9c456.png" style=""/></div>
</div>
<p>It's rotated, but it's rotated around the center of the element. Let's add a line to what we just wrote, so it rotates around the start of the text:</p>
<pre>#bottom-axis text {
    transform:rotate(45deg);
    text-anchor: start; /* add this line */
}</pre>
<p class="highlight highlight-source-css">The output will be shown as follows:</p>
<div><img class="aligncenter size-full wp-image-425 image-border" src="img/335c2fa0-84ba-41bc-bce3-25f6f32c5d46.png" style=""/></div>
<p>Let's move the graph to the right, so we can see the values for the left axis. Adjust our <kbd>svg</kbd> css code so it looks as follows:</p>
<div><pre>svg {
    overflow: visible;
    margin-left: 20px; /* add this line */
}</pre></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Summary</h1>
                
            
            
                
<p>In this chapter, we learned how to use AJAX to make an asynchronous request that will populate a bar graph. In <a href="aacc693a-f51f-4d50-832c-db2cd3af3b7f.xhtml" target="_blank">Chapter 6</a>, <em>Animating SVG Elements to Create an Interactive Pie Chart</em>, we'll create a pie chart that animates when you remove sections from it.</p>


            

            
        
    </body></html>