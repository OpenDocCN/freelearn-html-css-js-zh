<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Looking at General Usage</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Taking immediate control of the page</li><li class="listitem" style="list-style-type: disc">Working with slow responses</li><li class="listitem" style="list-style-type: disc">Relaying messages</li><li class="listitem" style="list-style-type: disc">Using a service worker as a proxy middleware</li><li class="listitem" style="list-style-type: disc">Using a service worker with a live flowchart</li></ul></div><div><div><div><div><h1 class="title"><a id="ch09lvl1sec67"/>Introduction</h1></div></div></div><p>In this chapter, we will look into some of the scenarios where the service worker can become useful. These scenarios may fall into the general-use category. The examples we will look at here can be used as the foundation to build other service worker features.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec68"/>Taking immediate control of the page</h1></div></div></div><p>This simple recipe will <a id="id397" class="indexterm"/>demonstrate how to have the service worker immediately take control of the page<a id="id398" class="indexterm"/> without having to wait for a navigation event.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec181"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the <em>Setting up service workers</em> recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the <em>Setting up GitHub pages for SSL</em> recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec182"/>How to do it...</h2></div></div></div><p>Follow these<a id="id399" class="indexterm"/> instructions to set up your file structure:</p><div><ol class="orderedlist arabic"><li class="listitem">Copy the <a id="id400" class="indexterm"/><code class="literal">index.html</code>, <code class="literal">index.js</code>, <code class="literal">service-worker.js</code>, and <code class="literal">style.css</code> files from the following location:<p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/09/01/">https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/09/01/</a>
</p></li><li class="listitem">Open a browser and go to <code class="literal">index.html</code>.<div><img src="img/B05381_09_01.jpg" alt="How to do it..."/></div></li><li class="listitem">Refresh the page. The status of the service worker will be displayed on the screen.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec183"/>How it works...</h2></div></div></div><p>In our <code class="literal">index.html</code> file, we will add a section to display the service worker status.</p><div><pre class="programlisting">&lt;section&gt;
    &lt;h3&gt;Immediate Control&lt;/h3&gt;
    &lt;p&gt;Status: 
        &lt;strong&gt;&lt;span id="control-status"&gt;&lt;/span&gt;&lt;/strong&gt;
    &lt;/p&gt;
&lt;/section&gt;</pre></div><p>At the beginning of the <code class="literal">index.js</code> file, we will inspect the registration status and print it to the screen.</p><div><pre class="programlisting">if (registration.installing) {
    serviceWorker = registration.installing;
    document.querySelector('#control-status')
    .textContent = 'Installing';
} else if (registration.waiting) {
    serviceWorker = registration.waiting;
    document.querySelector('#control-status')
    .textContent = 'Waiting';
} else if (registration.active) {
    serviceWorker = registration.active;
    document.querySelector('#control-status')
    .textContent = 'Active';
}</pre></div><p>Next, in<a id="id401" class="indexterm"/> the <code class="literal">service-worker.js</code> file, we will <a id="id402" class="indexterm"/>call <code class="literal">skipWaiting()</code> to enable an updated service worker to be immediately active when there is an existing service worker that differs from the updated version.</p><div><pre class="programlisting">if (typeof self.skipWaiting === 'function') {
  console.log('self.skipWaiting()');
  self.addEventListener('install', function(evt) {
    evt.waitUntil(self.skipWaiting());
  });
} else {
  console.log('self.skipWaiting() is unsupported.');
}

if (self.clients &amp;&amp; (typeof self.clients.claim === 'function')) {
  console.log('self.clients.claim()');
  self.addEventListener('activate', function(evt) {
    evt.waitUntil(self.clients.claim());
  });
} else {
  console.log('self.clients.claim() is unsupported.');
}</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec69"/>Working with slow responses</h1></div></div></div><p>Slow <a id="id403" class="indexterm"/>updates from the service worker are a good way to mock slow response times from the servers. In this recipe, we are going to use a timeout to mock slow responses.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec184"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the first recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>: <em>Setting up service workers</em>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the following recipes in <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>: <em>Setting up GitHub pages for SSL</em>, <em>Setting up SSL for Windows</em>, and <em>Setting up SSL for Mac</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec185"/>How to do it...</h2></div></div></div><p>Follow<a id="id404" class="indexterm"/> these instructions to set up your file structure:</p><div><ol class="orderedlist arabic"><li class="listitem">Copy the <code class="literal">index.html</code>, <code class="literal">index.js</code>, <code class="literal">service-worker.js</code>, <code class="literal">manifest.json</code>, <code class="literal">server.js</code>, <code class="literal">package.json</code>, and <code class="literal">style.css</code> files from the following location:<p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/09/02/">https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/09/02/</a>
</p></li><li class="listitem">Open a browser and go to index.html.<div><img src="img/B05381_09_02.jpg" alt="How to do it..."/></div></li><li class="listitem">Open the Developer Toolbars (<em>Cmd</em> + <em>Alt</em> + <em>I</em> or <em>F12</em>). Now refresh the page and look at the messages in the console. You will see the service worker life cycle methods are logged out into the console.<div><img src="img/B05381_09_03.jpg" alt="How to do it..."/></div></li><li class="listitem">Refresh<a id="id405" class="indexterm"/> the page. A message from the service worker will be displayed on the screen.<div><img src="img/B05381_09_04.jpg" alt="How to do it..."/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec186"/>How it works...</h2></div></div></div><p>In the <code class="literal">index.js</code> file, we will append the console message to the screen at the point of service worker registration.</p><div><pre class="programlisting">function printStatus(status) {
    document.querySelector('#status').innerHTML = status;
    document.body.appendChild(document.createTextNode(Array.prototype.join.call(arguments, ", ") + '\n'));

    console.log.apply(console, arguments); 
}</pre></div><p>Next, in the <code class="literal">service-worker.js</code> file we will create a function to delay any new promise we receive.</p><div><pre class="programlisting">function wait(ms) {
  return new Promise(function(resolve) {
    setTimeout(resolve, ms);
  });
}</pre></div><p>The<a id="id406" class="indexterm"/> usual lifecycle methods will call the <code class="literal">wait</code> function in order to delay the <code class="literal">install</code>, <code class="literal">activate</code>, and <code class="literal">fetch</code> statuses.</p><div><pre class="programlisting">self.addEventListener('install', function(evt) {
  console.log('INSTALL: In progress ..');
  evt.waitUntil(
    wait(DELAY).then(function() {
      console.log('INSTALL: Complete');
    })
  );
});

self.addEventListener('activate', function(evt) {
  console.log('ACTIVATION: In progress ..');
  evt.waitUntil(
    wait(DELAY).then(function() {
      console.log('ACTIVATION: Complete');
    })
  );
});

self.addEventListener('fetch', function(evt) {
  evt.respondWith(new Response("Service workers says Hello!"));
});</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec70"/>Relaying messages</h1></div></div></div><p>Service <a id="id407" class="indexterm"/>workers can be used to build a small chat message feature into your browser. This recipe demonstrates how to communicate between a page and the service worker by relaying messages between pages we are going to use to build our little chat app.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec187"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the <em>Setting up service workers</em> recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the <em>Setting up GitHub pages for SSL</em> recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec188"/>How to do it...</h2></div></div></div><p>Follow these<a id="id408" class="indexterm"/> instructions to set up your file structure:</p><div><ol class="orderedlist arabic"><li class="listitem">Copy the <code class="literal">index.html</code>, <code class="literal">index.js</code>, <code class="literal">service-worker.js</code>, <code class="literal">manifest.json</code>, <code class="literal">package.json</code>, and <code class="literal">style.css</code> files from the following location:<p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/09/03/">https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/09/03/</a>
</p></li><li class="listitem">Open a browser and go to <code class="literal">index.html</code>.<div><img src="img/B05381_09_05.jpg" alt="How to do it..."/></div></li><li class="listitem">Now open another browser and go to <code class="literal">index.html</code>. Type something in the text area.<div><img src="img/B05381_09_06.jpg" alt="How to do it..."/></div></li><li class="listitem">Now open <a id="id409" class="indexterm"/>another browser and go to <code class="literal">index.html</code>. Type something in the text area.<div><img src="img/B05381_09_07.jpg" alt="How to do it..."/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec189"/>How it works...</h2></div></div></div><p>At the beginning of the <code class="literal">index.js</code> file, we query the DOM nodes for the UI.</p><div><pre class="programlisting">  if (navigator.serviceWorker) {
    var message = document.querySelector('#message');
    var received = document.querySelector('#received');
    var status = document.querySelector('#status');
    var inbox = {};</pre></div><p>We then<a id="id410" class="indexterm"/> listen to any service worker messages. When a message is received, we specify a DOM element to display it.</p><div><pre class="programlisting">navigator.serviceWorker.addEventListener('message', function(evt) {

      var userId = evt.data.client;
      var node;

      if (!inbox[userId]) {
        node = document.createElement('div');
        received.appendChild(node);
        inbox[userId] = node;
      }

      node = inbox[userId];
      node.textContent = 'User ' + userId + ' says: ' + evt.data.message;
});</pre></div><p>When a page is force-reloaded, for example, the service worker will not send any messages.</p><div><pre class="programlisting">message.addEventListener('input', function() {
      if (!navigator.serviceWorker.controller) {
        status.textContent = 'ERROR: no controller';
        return;
      }

      navigator.serviceWorker.controller.postMessage(message.value);
});</pre></div><p>The <code class="literal">service-worker.js</code> file has the event handler for the message.</p><div><pre class="programlisting">self.addEventListener('message', function(event) {

  var promise = self.clients.matchAll()
  .then(function(clientList) {
    var senderID = event.source ? event.source.id : 'unknown';

    if (!event.source) {
      console.log('Unsure about the sender');
    }

    clientList.forEach(function(client) {
      if (client.id === senderID) {
        return;
      }
      client.postMessage({
        client: senderID,
        message: event.data
      });
    });
  });

  if (event.waitUntil) {
    event.waitUntil(promise);
  }
});</pre></div><p>An immediate<a id="id411" class="indexterm"/> claim will make sure that the user doesn't have to refresh the page.</p><div><pre class="programlisting">self.addEventListener('activate', function(event) {
  event.waitUntil(self.clients.claim());
});</pre></div><p>In the <code class="literal">index.html</code> file, we add a div, a text area, and a paragraph tag for the messages.</p><div><pre class="programlisting">&lt;section class="message"&gt;
    &lt;div id="received"&gt;&lt;/div&gt;

    &lt;textarea id="message" style="width: 90%;padding: 10px;" rows="5"&gt;&lt;/textarea&gt;
    &lt;p&gt;Message&lt;/p&gt;
&lt;/section&gt;</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec71"/>Using a service worker as a proxy middleware</h1></div></div></div><p>A proxy is an<a id="id412" class="indexterm"/> intermediary between a web browser and the Internet. In this recipe, you will learn how to use a service worker as a proxy middleware.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec190"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the first recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>: <em>Setting up service workers</em>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the following recipes in <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>: <em>Setting up GitHub pages for SSL</em>, <em>Setting up SSL for Windows</em>, and <em>Setting up SSL for Mac</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec191"/>How to do it...</h2></div></div></div><p>Follow these<a id="id413" class="indexterm"/> instructions to set up your file structure:</p><div><ol class="orderedlist arabic"><li class="listitem">Download all the files from the following location:<p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/09/04/">https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/09/04/</a>
</p></li><li class="listitem">Open a browser and go to <code class="literal">index.html</code>.<div><img src="img/B05381_09_08.jpg" alt="How to do it..."/></div></li><li class="listitem">Now click on the first link to navigate to the <code class="literal">/hello</code> link.<div><img src="img/B05381_09_09.jpg" alt="How to do it..."/></div></li><li class="listitem">Now <a id="id414" class="indexterm"/>open DevTools (<em>Cmd</em> + <em>Alt</em> + <em>I</em> or <em>F12</em>) to see the log messages on the <strong>Console</strong> tab.<div><img src="img/B05381_09_10.jpg" alt="How to do it..."/></div></li><li class="listitem">Now click on the first link to navigate to the <code class="literal">/hello/world</code> link.<div><img src="img/B05381_09_11.jpg" alt="How to do it..."/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec192"/>How it works...</h2></div></div></div><p>We will <a id="id415" class="indexterm"/>add two links to the <code class="literal">index.html</code> file where we are planning to create a proxy.</p><div><pre class="programlisting">&lt;section &gt;
    &lt;h1&gt;Proxy&lt;/h1&gt;
    &lt;p&gt;Click the links below for navigating to fetch handlers:&lt;/p&gt;
    &lt;div class="links"&gt;
      &lt;a href="/service-workers/07/04/hello"&gt;/hello&lt;/a&gt;&lt;br /&gt;
      &lt;a href="/service-workers/07/04/hello/world"&gt;/hello/world&lt;/a&gt;
    &lt;/div&gt;
&lt;/section&gt;</pre></div><p>We will create a proxy for requests to the local URLs inside the <code class="literal">service-worker.js</code> file containing a <code class="literal">hello</code> string as well as <code class="literal">hello/world</code>. The client will recognize this as a local resource.</p><div><pre class="programlisting">var helloFetchHandler = function(event) {
  if (event.request.url.indexOf('/hello') !== -1) {
    console.log('DEBUG: Inside the /hello handler.');
    event.respondWith(new Response('Fetch handler for /hello'));
  }
};

var helloWorldFetchHandler = function(event) {
  if (event.request.url.endsWith('/hello/world')) {
    console.log('DEBUG: Inside the /hello/world handler.');
    event.respondWith(new Response('Fetch handler for /hello/world'));
  }
};</pre></div><p>We will pass these handlers into the fetch event listener as callbacks.</p><div><pre class="programlisting">var fetchHandlers = [helloWorldFetchHandler, helloFetchHandler];

fetchHandlers.forEach(function(fetchHandler) {
  self.addEventListener('fetch', fetchHandler);
}); </pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec72"/>Using a service worker with a live flowchart</h1></div></div></div><p>In this recipe, you will learn how to use a service worker<a id="id416" class="indexterm"/> by <a id="id417" class="indexterm"/>demonstrating the workflow and logging the steps so we can follow the flow.</p><p>The features we are going to implement are as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A button to register a service worker</li><li class="listitem" style="list-style-type: disc">A button to reload the document</li><li class="listitem" style="list-style-type: disc">A button to unregister the service worker</li></ul></div><p>The buttons can be pressed in any order. You can also specify the service worker script URL and scope to simulate different test cases.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec193"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the <em>Setting up service workers</em> recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the <em>Setting up GitHub pages for SSL</em> recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec194"/>How to do it...</h2></div></div></div><p>Follow these instructions to set up your file structure:</p><div><ol class="orderedlist arabic"><li class="listitem">Download files from the following location:<p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/08/05/">https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/08/05/</a>
</p></li><li class="listitem">Open a browser and go to <code class="literal">index.html</code>.<div><img src="img/B05381_09_12.jpg" alt="How to do it..."/></div></li><li class="listitem">Now open <a id="id418" class="indexterm"/>DevTools (<em>Cmd</em> + <em>Alt</em> + <em>I</em> or <em>F12</em>) to <a id="id419" class="indexterm"/>see the log messages on the <strong>Console</strong> tab.<div><img src="img/B05381_09_13.jpg" alt="How to do it..."/></div></li><li class="listitem">Now <a id="id420" class="indexterm"/>click on the <strong>REGISTER SPECIFIED SW</strong><a id="id421" class="indexterm"/> button.<div><img src="img/B05381_09_14.jpg" alt="How to do it..."/></div></li><li class="listitem">Now <a id="id422" class="indexterm"/>open DevTools (<em>Cmd</em> + <em>Alt</em> + <em>I</em> or <em>F12</em>) to <a id="id423" class="indexterm"/>see the log messages on the <strong>Console</strong> tab.<div><img src="img/B05381_09_15.jpg" alt="How to do it..."/></div></li><li class="listitem">Now <a id="id424" class="indexterm"/>click on the <strong>RELOAD DOCUMENT</strong> <a id="id425" class="indexterm"/>button.<div><img src="img/B05381_09_16.jpg" alt="How to do it..."/></div></li><li class="listitem">Now<a id="id426" class="indexterm"/> open up DevTools (<em>Cmd</em> + <em>Alt</em> + <em>I</em> or <em>F12</em>) to<a id="id427" class="indexterm"/> see the log messages on the <strong>Console</strong> tab.<div><img src="img/B05381_09_17.jpg" alt="How to do it..."/></div></li><li class="listitem">Now<a id="id428" class="indexterm"/> click on the <strong>UNREGISTER ACTIVE SW</strong> <a id="id429" class="indexterm"/>button.<div><img src="img/B05381_09_18.jpg" alt="How to do it..."/></div></li><li class="listitem">Now <a id="id430" class="indexterm"/>open up DevTools (<em>Cmd</em> + <em>Alt</em> + <em>I</em> or <em>F12</em>) to <a id="id431" class="indexterm"/>see the log messages on the <strong>Console</strong> tab.<div><img src="img/B05381_09_19.jpg" alt="How to do it..."/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec195"/>How it works...</h2></div></div></div><p>At the <a id="id432" class="indexterm"/>beginning of the <code class="literal">app.js</code> file, we<a id="id433" class="indexterm"/> initiate a helper for the service worker.</p><div><pre class="programlisting">this.serviceWorkerUtil = new ServiceWorkerUtil();</pre></div><p>To register a service worker, we perform the following steps:</p><div><pre class="programlisting">document.getElementById('reloadapp').addEventListener('click', function() {
    window.location.reload();
  });</pre></div><p>Then, we check if the service worker is supported.</p><div><pre class="programlisting">if (this.serviceWorkerUtil.isServiceWorkerSupported()) {
    document.getElementById('swinstall').addEventListener('click',
      function() {
        self.enableFeatures();
      }
    );

    document.getElementById('swuninstall').addEventListener('click',
      function() {
        self.disableFeatures();
      }
    );</pre></div><p>Next, we check if the service worker is in control.</p><div><pre class="programlisting">if (this.serviceWorkerUtil.isServiceWorkerControllingThisApp()) {
      Logger.info('App code run as expected');

      this.disableSWRegistration();
    } else {
      this.enableSWRegistration();
    }</pre></div><p>Now<a id="id434" class="indexterm"/> we try to register the service worker<a id="id435" class="indexterm"/> in order to enable features.</p><div><pre class="programlisting">App.prototype.enableFeatures = function enableFeatures() {
  var scriptURL;
  var scope;

  Logger.newSection();
  Logger.log('ENABLE: Features enabled.');

  scriptURL = document.getElementById('swscripturl');
  scope = document.getElementById('swscope');

  Logger.debug(
    'Configuring the following service worker ' + scriptURL.value +
    ' with scope ' + scope.value
  );

  if (scriptURL.value !== '') {
    Logger.debug('scriptURL: ' + scriptURL.value);
  } else {
    Logger.error('No SW scriptURL specified');
    return;
  }

  if (scope.value !== '') {
    Logger.debug('SCOPE: ' + scope.value);
  } else {
    Logger.warn('SCOPE: not specified');
  }

  this.serviceWorkerUtil.registerServiceWorker(scriptURL.value, scope.value).then(
      this.disableSWRegistration,
      this.enableSWRegistration
  );
};</pre></div><p>We will disable the possibility of the user unregistering the service worker.</p><div><pre class="programlisting">App.prototype.enableSWRegistration = function() {
  document.getElementById('swinstall').disabled = false;
  document.getElementById('swuninstall').disabled = true;
};

App.prototype.disableSWRegistration = function() {
  document.getElementById('swinstall').disabled = true;
  document.getElementById('swuninstall').disabled = false;
};</pre></div><p>So the application gets started.</p><div><pre class="programlisting">var app = new App();

console.debug(app);</pre></div><p>In the <code class="literal">service-worker.js</code> file, we<a id="id436" class="indexterm"/> receive the payload and add an event listener for <a id="id437" class="indexterm"/>registering the push event.</p><div><pre class="programlisting">'use strict';

self.addEventListener('push', function(event) {
  event.waitUntil(
    self.clients.matchAll().then(function(clients) {

      var focused = clients.some(function(client) {
        return client.focused;
      });

      var notificationMessage;

      if (focused) {
        notificationMessage = 'Same Page';
      } else if (clients.length &gt; 0) {
        notificationMessage = 'Diffrerent Page, ' +
                              'click here to gain focus';
      } else {
        notificationMessage = 'Page Closed, ' +
                              'click here to re-open it!';
      }

      return self.registration.showNotification('ServiceWorker Cookbook', {
        body: notificationMessage,
      });
    })
  );
});</pre></div><p>In the <code class="literal">index.html</code> file, we <a id="id438" class="indexterm"/>will add a section to display the buttons and<a id="id439" class="indexterm"/> the console.</p><div><pre class="programlisting">&lt;section class="playground"&gt;
    &lt;div class="inputs"&gt;
        &lt;span class="title"&gt;Service Worker&lt;/span&gt;
        &lt;input id="swscripturl" placeholder="SW path" value="./service-worker.js" /&gt;
        &lt;span class="title"&gt;Options &lt;/span&gt;
        &lt;input id="swscope" placeholder="scope (optional)" /&gt;
    &lt;/div&gt;
    &lt;div class="actions"&gt;
        &lt;button id="swinstall" disabled&gt;Register specified SW&lt;/button&gt;
        &lt;button id="reloadapp"&gt;Reload document&lt;/button&gt;
        &lt;button id="swuninstall" disabled&gt;Unregister active SW&lt;/button&gt;
    &lt;/div&gt;
    &lt;div id="log" class="log"&gt;&lt;/div&gt;
&lt;/section&gt;</pre></div></div></div></body></html>