<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Controllers and Extensions</h1></div></div></div><p>A set of instructions that can react on the user's interaction with Visualforce markup (for example, a button click or a link click) is called as a controller. A controller<a id="id41" class="indexterm"/> can control the behavior of a page and it can be used to access the data which should be displayed on the page.</p><p>This chapter will introduce you to a few types of controllers and extensions that can be used for Visualforce pages. We will learn the types of controllers with examples.</p><p>This chapter covers the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Standard controllers</li><li class="listitem" style="list-style-type: disc">Standard list controllers</li><li class="listitem" style="list-style-type: disc">Custom controllers and controller extensions</li><li class="listitem" style="list-style-type: disc">Working with large sets of data on a Visualforce page</li><li class="listitem" style="list-style-type: disc">Order of execution of a Visualforce page</li><li class="listitem" style="list-style-type: disc">Validation rules and standard controllers or custom controllers</li><li class="listitem" style="list-style-type: disc">Using the transient keyword</li><li class="listitem" style="list-style-type: disc">Considerations for creating custom controllers and controller extensions</li></ul></div><p>Let's look closer at controllers and extensions…</p><p>This chapter includes a set of examples to explain the important elements and features of Visualforce. Starting from this chapter we will build an order processing application. There are four custom objects (API names: <code class="literal">Customer__c</code>, <code class="literal">Item__c</code>, <code class="literal">Order__c</code>, <code class="literal">Order_Line__c</code>) in this application. The following is the E-R diagram of an order processing application which we will create on the Force.com platform:</p><div><img src="img/9818_02_01.jpg" alt="Controllers and Extensions"/><div><p>The E-R diagram of an order processing application</p></div></div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec14"/>Standard controllers</h1></div></div></div><p>The Force.com<a id="id42" class="indexterm"/> platform provides a few types of controllers. The first one is standard controller and every <strong>sObject</strong>
<a id="id43" class="indexterm"/> has a standard controller. They have the same logic and functionality as they are originally used in standard pages. Therefore we can use standard controllers with Visualforce pages. For example, if we use Contact standard controller for a Visualforce page, we can implement the standard <code class="literal">Save</code> method<a id="id44" class="indexterm"/> for Contact without writing any additional Apex code. This behavior is the same as implementing the <code class="literal">Save</code> method on the standard Contact edit page.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec06"/>How to use a standard controller with a Visualforce page</h2></div></div></div><p>The<code class="literal"> &lt;apex:page&gt;</code> tag<a id="id45" class="indexterm"/> has an<a id="id46" class="indexterm"/> attribute called <code class="literal">standardController</code> which <a id="id47" class="indexterm"/>is used to associate a standard controller with a Visualforce Page. The value of the <code class="literal">standardController</code> attribute would be the API name of an sObject:</p><div><pre class="programlisting">&lt;apex:page standardController="Customer__c"&gt;
&lt;/apex:page&gt;</pre></div><p>The preceding code shows the usage of the <code class="literal">standardController</code> attribute.</p><div><div><h3 class="title"><a id="tip02"/>Tip</h3><p>You cannot use the <code class="literal">standardController</code> and <code class="literal">controller</code> attributes at the same time.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec07"/>Standard controller actions</h2></div></div></div><p>In Visualforce pages, we can define the <code class="literal">action</code> attribute for the following standard Visualforce components:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;apex:commandButton&gt;</code>: This <a id="id48" class="indexterm"/>component creates a <a id="id49" class="indexterm"/>button that calls an action</li><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;apex:commandLink&gt;</code>: This <a id="id50" class="indexterm"/>component creates a link <a id="id51" class="indexterm"/>that calls an action</li><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;apex:actionPoller&gt;</code>: This <a id="id52" class="indexterm"/>component periodically <a id="id53" class="indexterm"/>calls an action</li><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;apex:actionSupport&gt;</code>: This<a id="id54" class="indexterm"/> component makes an event (such as <code class="literal">onclick</code>, <code class="literal">onmouseover</code>, and so on) on another named <a id="id55" class="indexterm"/>component and calls an action</li><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;apex:actionFunction&gt;</code>: This <a id="id56" class="indexterm"/>component defines a new JavaScript <a id="id57" class="indexterm"/>function that calls an action</li><li class="listitem" style="list-style-type: disc"><code class="literal">&lt;apex:page&gt;</code>: This<a id="id58" class="indexterm"/> component calls an action when the<a id="id59" class="indexterm"/> page is loaded</li></ul></div><p>An action method can be called from the page using the {<code class="literal">!</code>} notation. For example, if your action method's name is <code class="literal">MyFirstMethod</code>, then you can use the {<code class="literal">!MyFirstMethod</code>} notation for calling the action method from the page markup.</p><div><div><h3 class="title"><a id="tip03"/>Tip</h3><p>This action method can be from a standard controller or a custom controller or a controller extension.</p></div></div><p>A standard controller has a few standard action methods, as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">save</code>: This <a id="id60" class="indexterm"/>method inserts/updates a <a id="id61" class="indexterm"/>record. Upon successful completion it will be redirected to the standard detail page or a custom Visualforce page.</li><li class="listitem" style="list-style-type: disc"><code class="literal">quicksave</code>: This<a id="id62" class="indexterm"/> method inserts/updates a record. There are no redirections to a detail page or custom <a id="id63" class="indexterm"/>Visualforce page.</li><li class="listitem" style="list-style-type: disc"><code class="literal">edit</code>: This <a id="id64" class="indexterm"/>method navigates the user to the<a id="id65" class="indexterm"/> edit page for current record. Upon successful completion it will be returned to the page that invoked the action.</li><li class="listitem" style="list-style-type: disc"><code class="literal">delete</code>: This <a id="id66" class="indexterm"/>method deletes the<a id="id67" class="indexterm"/> current record. It redirects the user to the list view page by selecting the most recently viewed list filter.</li><li class="listitem" style="list-style-type: disc"><code class="literal">cancel</code>: This<a id="id68" class="indexterm"/> method cancels an edit <a id="id69" class="indexterm"/>operation. Upon successful completion it will be returned to the page that invoked the edit action.</li><li class="listitem" style="list-style-type: disc"><code class="literal">list</code>: This <a id="id70" class="indexterm"/>method redirects to the list view page <a id="id71" class="indexterm"/>by selecting the most recently-viewed list filter.</li></ul></div><p>For example, the following page allows us to insert a new customer or update an existing customer record. If we are going to use this page to update a customer record, then the URL must be specified with the ID query string parameter. Every standard controller has a getter method that returns the record specified by the ID query string parameter in the page URL. When we click on <strong>Save</strong>, the <code class="literal">save</code> action is triggered on the standard controller, and the details of the customer are updated. If we are going to use this page to insert a customer record, then the URL must not be specified as a parameter. In this scenario, when we click on <strong>Save</strong>, the <code class="literal">save</code> action is triggered on the standard controller, and a new customer record is inserted.</p><div><pre class="programlisting">&lt;apex:page standardController="Customer__c"&gt;
    &lt;apex:form &gt;
        &lt;apex:pageBlock title="New Customer" mode="edit"&gt;
            &lt;apex:pageBlockButtons &gt;
                &lt;apex:commandButton action="{!save}" value="Save"/&gt;
            &lt;/apex:pageBlockButtons&gt;            
            &lt;apex:pageBlockSection title="My Content Section" columns="2"&gt;
                &lt;apex:inputField value="{!Customer__c.Name}"/&gt;
                &lt;apex:inputField value="{!Customer__c.Email__c}"/&gt;
                &lt;apex:inputField value="{!Customer__c.Address__c}"/&gt;
                &lt;apex:inputField value="{!Customer__c.Telephone__c}"/&gt;
            &lt;/apex:pageBlockSection&gt;
        &lt;/apex:pageBlock&gt;
    &lt;/apex:form&gt;
&lt;/apex:page&gt;</pre></div><div><div><h3 class="title"><a id="tip04"/>Tip</h3><p>The page markup allows you to access fields of a particular sObject by using <code class="literal">{!sObjectAPIName.FieldAPIName}</code>. For example, if you want to access the <code class="literal">Email</code> field of the <code class="literal">Customer</code> object, the page that uses the <code class="literal">Customer__c</code> standard controller can use <code class="literal">{!Customer__c.Email__c}</code> to return the value of the <code class="literal">Email</code> field of the customer who is in the current context.</p></div></div><p>The following page <a id="id72" class="indexterm"/>allows us to view a customer record. In this page also, the URL must be specified in the ID query string parameter. The getter method of the <code class="literal">Customer__c</code> standard controller returns the record specified by the ID query string parameter in the page URL:</p><div><pre class="programlisting">&lt;apex:page standardController="Customer__c"&gt;
    &lt;apex:form &gt;
        &lt;apex:pageBlock title="Customer" mode="edit"&gt;
            &lt;apex:pageBlockButtons &gt;
                &lt;apex:commandButton action="{!save}" value="Save"/&gt;
            &lt;/apex:pageBlockButtons&gt;            
            &lt;apex:pageBlockSection title="Customer Details" columns="2"&gt;
                &lt;apex:outputField value="{!Customer__c.Name}"/&gt;
                &lt;apex:outputField value="{!Customer__c.Email__c}"/&gt;
                &lt;apex:outputField value="{!Customer__c.Address__c}"/&gt;
                &lt;apex:outputField value="{!Customer__c.Telephone__c}"/&gt;
            &lt;/apex:pageBlockSection&gt;
        &lt;/apex:pageBlock&gt;
    &lt;/apex:form&gt;
&lt;/apex:page&gt;</pre></div><div><div><h3 class="title"><a id="tip05"/>Tip</h3><p>To check the<a id="id73" class="indexterm"/> accessibility of a particular object for the logged user, you can use the <code class="literal">{!$ObjectType.objectname.accessible}</code> notation. This expression returns a Boolean value. For a example, if you want to check the accessibility of the <code class="literal">Customer</code> object, you can use <code class="literal">{!$ObjectType.Customer__c.accessible}</code>.</p></div></div><div><pre class="programlisting">&lt;apex:page standardController="Customer__c"&gt;
    &lt;apex:form &gt;
        &lt;apex:pageBlock title="New Customer" mode="edit"&gt;
            &lt;apex:pageBlockButtons &gt;
                &lt;apex:commandButton rendered="{!$ObjectType.Customer__c.accessible}" action="{!save}" value="Save"/&gt;
            &lt;/apex:pageBlockButtons&gt;            
            &lt;apex:pageBlockSection title="Customer Details" columns="2"&gt;
                &lt;apex:inputField value="{!Customer__c.Name}"/&gt;
                &lt;apex:inputField value="{!Customer__c.Email__c}"/&gt;
                &lt;apex:inputField value="{!Customer__c.Address__c}"/&gt;
                &lt;apex:inputField value="{!Customer__c.Telephone__c}"/&gt;
            &lt;/apex:pageBlockSection&gt;
        &lt;/apex:pageBlock&gt;
    &lt;/apex:form&gt;
&lt;/apex:page&gt;</pre></div><p>The preceding code explains the usage of object accessibility. According to the example, you can see the <strong>Save</strong> button, only if the particular user has security permission to access the customer record.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch02lvl1sec15"/>Standard list controllers</h1></div></div></div><p>The second controller <a id="id74" class="indexterm"/>type is the standard list controller which can be used for displaying or performing an action on a set of records (including related lists, list pages, and mass action pages). It allows us to filter records on a particular page. We can use standard list controllers for Account, Asset, Campaign, Case, Contact, Contract, Idea, Lead, Opportunity, Order, Product2, Solution, User, and all the custom objects.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec08"/>How to use a standard list controller with Visualforce</h2></div></div></div><p>Similar to the <a id="id75" class="indexterm"/>standard controller, we can<a id="id76" class="indexterm"/> specify the <code class="literal">standardController</code> attribute of the <code class="literal">&lt;apex:page&gt;</code> component. Additionally, we need to specify the <code class="literal">recordSetVar</code> attribute of the <code class="literal">&lt;apex:page&gt;</code> component.</p><div><div><h3 class="title"><a id="tip06"/>Tip</h3><p>The <code class="literal">standardController</code> attribute specifies the type of records that we want to access. The <code class="literal">recordSetVar</code> attribute indicates that the page uses a list controller and the variable name (used to access data in the record collection) of the record collection.</p></div></div><p>The following markup explains how the page can access a list of records when the page is associated with a list controller. In the following example, you can refer to a list of customer records.</p><div><pre class="programlisting">&lt;apex:page standardController="Customer__c" recordSetVar="customers" sidebar="false"&gt;
    &lt;apex:pageBlock &gt;
        &lt;apex:pageBlockTable value="{!customers}" var="a"&gt;
            &lt;apex:column value="{!a.name}"/&gt;
        &lt;/apex:pageBlockTable&gt;
    &lt;/apex:pageBlock&gt;
&lt;/apex:page&gt;</pre></div><p>The following screenshot illustrates the result of the preceding code:</p><div><img src="img/9818_02_02.jpg" alt="How to use a standard list controller with Visualforce"/><div><p>The result page of the customer list example</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec09"/>Standard list controller actions</h2></div></div></div><p>All the standard<a id="id77" class="indexterm"/> Visualforce components that have the <code class="literal">action</code> attribute can be used with a Visualforce page with a standard list controller. The usage of those components is same as for a standard controller. The following action methods are supported by all standard list controllers:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">save</code>: This <a id="id78" class="indexterm"/>action method <a id="id79" class="indexterm"/>inserts/updates a record. Upon successful completion it will be redirected to the standard detail page or custom Visualforce page.</li><li class="listitem" style="list-style-type: disc"><code class="literal">quicksave</code>: This <a id="id80" class="indexterm"/>method <a id="id81" class="indexterm"/>inserts/updates a record. There are no redirections to a detail page or a custom Visualforce page.</li><li class="listitem" style="list-style-type: disc"><code class="literal">List</code>: This<a id="id82" class="indexterm"/> method redirects to the <a id="id83" class="indexterm"/>list view page by selecting the most recently viewed list filter when the filter ID is not specified by the user.</li><li class="listitem" style="list-style-type: disc"><code class="literal">cancel</code>: This <a id="id84" class="indexterm"/>method cancels an edit<a id="id85" class="indexterm"/> operation. Upon successful completion it will be returned to the page which invoked the edit action.</li><li class="listitem" style="list-style-type: disc"><code class="literal">first</code>: This<a id="id86" class="indexterm"/> method displays the first page of <a id="id87" class="indexterm"/>records in the set.</li><li class="listitem" style="list-style-type: disc"><code class="literal">last</code>: This <a id="id88" class="indexterm"/>method displays the last page of <a id="id89" class="indexterm"/>records in the set.</li><li class="listitem" style="list-style-type: disc"><code class="literal">next</code>: This<a id="id90" class="indexterm"/> method displays the <a id="id91" class="indexterm"/>next page of records in the set.</li><li class="listitem" style="list-style-type: disc"><code class="literal">previous</code>: This <a id="id92" class="indexterm"/>method displays the <a id="id93" class="indexterm"/>previous page of records in the set.</li></ul></div><p>List views in Salesforce standard pages can be used for filtering records that are displayed on the page. For example, on the customer home page, you can select <strong>start with c view</strong> from the list view dropdown and view the customers whose name starts with the letter c. You can implement this functionality on a page associated with a list controller.</p><p>Pagination can be added to a page associated with a list controller. The pagination feature<a id="id94" class="indexterm"/> allows you to implement the next and previous actions.</p><p>For example, to create a simple list of customers with a list view and pagination, create a page with the <a id="id95" class="indexterm"/>following markup:</p><div><pre class="programlisting">&lt;apex:page standardController="Customer__c" recordSetvar="customers"&gt;
    &lt;apex:form id="theForm"&gt; 
        &lt;apex:pageBlock title="Viewing Customers"&gt;               
            &lt;apex:pageBlockSection &gt;
                &lt;apex:selectList value="{!filterid}" size="1"&gt;
                    &lt;apex:selectOptions value="{!listviewoptions}"/&gt;
                    &lt;apex:actionSupport event="onchange" rerender="list"/&gt;
                &lt;/apex:selectList&gt;
            &lt;/apex:pageBlockSection&gt;
             
            &lt;apex:pageBlockSection id="list"&gt;
                &lt;apex:dataList var="a" value="{!customers}" type="1"&gt;
                {!a.name}
                &lt;/apex:dataList&gt;
            &lt;/apex:pageBlockSection&gt;
            
            &lt;apex:panelGrid columns="2"&gt;
                &lt;apex:commandLink action="{!previous}" rerender="list"&gt;Previous&lt;/apex:commandlink&gt;
                &lt;apex:commandLink action="{!next}" rerender="list"&gt;Next&lt;/apex:commandlink&gt;
            &lt;/apex:panelGrid&gt;        
        &lt;/apex:pageBlock&gt;
    &lt;/apex:form&gt;
&lt;/apex:page&gt;</pre></div><p>The result of the preceding code is shown in the following screenshot:</p><div><img src="img/9818_02_03.jpg" alt="Standard list controller actions"/><div><p>Viewing customer list with pagination</p></div></div><div><div><h3 class="title"><a id="tip07"/>Tip</h3><p>By default, a list controller returns 20 records per page. To control the number of records displayed on each page, use a controller extension to set the <code class="literal">pageSize</code> attribute.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch02lvl1sec16"/>Custom controllers and controller extensions</h1></div></div></div><p>Custom controllers are used to implement the logic and functionality without using a standard controller and controller extensions are used to extend the logic and functionality of a standard controller or a custom controller. Custom controllers and Controller extension are written using Apex.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec10"/>Understanding custom controllers</h2></div></div></div><p>Custom controllers<a id="id96" class="indexterm"/> are used to implement logic and functionality without using <a id="id97" class="indexterm"/>a standard controller. Custom controllers are written using Apex. The following are the instances where you might want to use use a custom controller:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Implement a completely different functionality without relying on the standard controller's behavior</li><li class="listitem" style="list-style-type: disc">Override existing functionality</li><li class="listitem" style="list-style-type: disc">Make new actions for the page</li><li class="listitem" style="list-style-type: disc">Customize the navigation</li><li class="listitem" style="list-style-type: disc">Use HTTP callouts or web services</li><li class="listitem" style="list-style-type: disc">Use a wizard</li><li class="listitem" style="list-style-type: disc">Have a greater control over accessing information on a page</li><li class="listitem" style="list-style-type: disc">Run your <a id="id98" class="indexterm"/>page without applying <a id="id99" class="indexterm"/>permissions</li></ul></div><div><div><h3 class="title"><a id="tip08"/>Tip</h3><p>Only one controller can be used in a particular page.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec11"/>Building a custom controller</h2></div></div></div><p>You can build a<a id="id100" class="indexterm"/> custom controller via the <strong>Setup</strong> page and theVisualforce editor. All the administrator and developer functionality are included in the <strong>Setup</strong> page, and you can find the <strong>Setup</strong> page from the menu which appears after clicking on your name (at the top of the page).</p><p>The Visualforce editor allows us to edit the markup of a Visualforce page in the same window and we can see that the result of the page will also be displayed on the same page. This editor has important functionality such as autocompletion, syntax highlighting, quick fix features (developers can create components on the fly), and compile on save using the following methods:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Via the <strong>Setup</strong> page: This can be done by navigating to <strong>Your Name</strong> | <strong>Setup</strong> | <strong>Develop</strong> | <strong>Apex Classes</strong> | <strong>New</strong>.</li><li class="listitem" style="list-style-type: disc">Via the Visualforce editor: After creating the page you can specify the custom controller's name in the controller attribute of the <code class="literal">&lt;apex:page&gt;</code> tag and then click on the <strong>Save</strong> button. Then, if you are a developer, the page will be asking you to create the class with the name that you entered. Then, the newly-created controller will be shown on the Visualforce editor, as shown in the next screenshot.<div><div><h3 class="title"><a id="tip09"/>Tip</h3><p>You have the choice to write controller classes using the <code class="literal">sharing</code> or <code class="literal">without sharing</code> keyword, which is influenced to run the particular page in the system mode or user mode.</p></div></div><div><img src="img/9818_02_04.jpg" alt="Building a custom controller"/><div><p>Creating a custom controller via the Visualforce editor</p></div></div></li></ul></div><p>The following <a id="id101" class="indexterm"/>class is an example of custom controllers. This custom controller has the functionality for retrieving the existing item list from the <code class="literal">Item__c</code> custom object and adding a new item record. <code class="literal">insertNewItem</code> is the action method of <code class="literal">ItemController</code>. <code class="literal">ExistingITems</code> is a list of item properties which is used to retrieve the existing item records. The <code class="literal">ExistingITems</code> property has an overriden <code class="literal">get</code> method:</p><div><pre class="programlisting">public with sharing class ItemController {
  //public item property for new insertion
    public Item__c NewItem{get;set;}    
    public ItemController(){
        NewItem = new Item__c();
    }

    //get existing items to show in a table
    public List&lt;Item__c&gt; ExistingITems{
        get{
            ExistingITems = new List&lt;Item__c&gt;();
            ExistingITems = [SELECT Id, Name, Item_Name__c, Unit_Price__c FROM Item__c LIMIT 100];
            return ExistingITems;
        }
        set;
    }
        
    public PageReference insertNewItem() {
      try{
        insert NewItem;        
        //reset public property for new insert
        NewItem = new Item__c();
 }catch(DmlException ex){
            ApexPages.addMessages(ex);
        }
        return null;
    }
}</pre></div><div><div><h3 class="title"><a id="tip10"/>Tip</h3><p>A custom controller uses a nonparameterized constructor. You cannot create a constructor that includes parameters for a custom controller.</p></div></div><p>The <a id="id102" class="indexterm"/>preceding controller is associated with the following Visualforce page. This page has two <code class="literal">&lt;apex:pageBlock&gt;</code> components: one for displaying the existing item records table and other for inserting new items:</p><div><pre class="programlisting">&lt;apex:page controller="ItemController"&gt;
    &lt;apex:form &gt;
        &lt;apex:pageBlock title="Existing Items"&gt;
            &lt;apex:pageBlockTable value="{!ExistingITems}" var="oneItem" rendered="{!ExistingITems.size &gt; 0}"&gt;
                &lt;apex:column value="{!oneItem.Item_Name__c}"/&gt;
                &lt;apex:column value="{!oneItem.Unit_Price__c}"/&gt;
            &lt;/apex:pageBlockTable&gt; 
            &lt;apex:outputText value="No records to display" rendered="{!ExistingITems.size == 0}"&gt;&lt;/apex:outputText&gt;       
        &lt;/apex:pageBlock&gt;
        &lt;apex:pageBlock title="New Item"&gt;
&lt;apex:pageMessages &gt;&lt;/apex:pageMessages&gt;
            &lt;apex:pageBlockSection &gt;                
                &lt;apex:inputField value="{!NewItem.Item_Name__c}"/&gt;                
                &lt;apex:inputField value="{!NewItem.Unit_Price__c}"/&gt;               
            &lt;/apex:pageBlockSection&gt;            
            &lt;apex:pageBlockButtons &gt;
                &lt;apex:commandButton action="{!insertNewItem}" value="save"/&gt;
            &lt;/apex:pageBlockButtons&gt;            
        &lt;/apex:pageBlock&gt;
    &lt;/apex:form&gt;
&lt;/apex:page&gt;</pre></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec12"/>Understanding controller extension</h2></div></div></div><p>Controller extensions are <a id="id103" class="indexterm"/>used to extend the logic and functionality of a standard controller or a custom controller.  A controller extension cannot be on a page without a standard controller or a custom controller. Controller extensions are written using Apex. Use controller extensions when you want to:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Keep the majority of functionality of a standard or custom controller as it, is and add more functionality</li><li class="listitem" style="list-style-type: disc">Build a Visualforce page that should run according to the user's permissions</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec13"/>Building a controller extension</h2></div></div></div><p>We can build a<a id="id104" class="indexterm"/> controller extension in the same way as for building the custom controller.</p><div><div><h3 class="title"><a id="tip11"/>Tip</h3><p>Extensions cannot live by themselves on a page. They can be used on a Visualforce page with a custom controller or a standard controller.</p></div></div><p>The following class is a simple example of a controller extension. This controller extension is used to extend the logic and the functionality of the <code class="literal">Order__c</code> custom object's standard controller. In this extension, we have a one-parameterized constructor to fetch the order record from the standard controller. <code class="literal">getRecord()</code> is the method for fetching records from the standard controller. The <code class="literal">prepareFullOrder()</code> method is a custom method that is implemented for querying the order lines of a particular order:</p><div><pre class="programlisting">public with sharing class OrderViewExtension{   
    public Order__c CurrentOrder{get;set;}
    public List&lt;Order_Line__c&gt; OrderLines{get;set;}
    
    public OrderViewExtension(ApexPages.StandardController controller){
        CurrentOrder = new Order__c();
        this.CurrentOrder = (Order__c)controller.getRecord();
        prepareFullOrder();
    }
    
    public void prepareFullOrder(){
        OrderLines = new List&lt;Order_Line__c&gt;();
        OrderLines = [SELECT Id, Name, Price__c, Item__c, Item__r.Unit_Price__c,Item__r.Item_Name__c, Order__c, Quantity__c FROM Order_Line__c WHERE Order__c =: this.CurrentOrder.Id];
    }  
}</pre></div><div><div><h3 class="title"><a id="tip12"/>Tip</h3><p>A controller extension uses one-parameterized constructor with the <code class="literal">ApexPages.StandardController</code> type of argument or a custom controller type.</p></div></div><p>The following <a id="id105" class="indexterm"/>Visualforce page uses the preceding controller extension. On the page, we have a page block with two sections. The first section shows us the order header details. The second section is there to show the order lines of a particular order:</p><div><pre class="programlisting">&lt;apex:page standardController="Order__c" extensions="OrderViewExtension"&gt;
  &lt;apex:form &gt;
      &lt;apex:pageBlock &gt;
          &lt;apex:pageBlockSection title="Order Header"&gt;
              &lt;apex:outputField value="{!Order__c.Name}"/&gt;
              &lt;apex:outputField value="{!Order__c.Customer__c}"/&gt;
              &lt;apex:outputField value="{!Order__c.Planned_Delivery_Date__c}"/&gt;
          &lt;/apex:pageBlockSection&gt;
          &lt;apex:pageBlockSection title="Order Lines" columns="1"&gt;
              &lt;apex:pageBlockTable value="{!OrderLines}" var="line"&gt;
                  &lt;apex:column value="{!line.Name}"/&gt;                  
                  
                  &lt;apex:column headerValue="Item"&gt;
                      &lt;apex:outputLink value="/{!line.Item__c}" target="_blank"&gt;{!line.Item__r.Item_Name__c}&lt;/apex:outputLink&gt;
                  &lt;/apex:column&gt;
                  &lt;apex:column value="{!line.Item__r.Unit_Price__c}"/&gt;
                  &lt;apex:column value="{!line.Quantity__c}"/&gt;
                  &lt;apex:column value="{!line.Price__c}"/&gt;
              &lt;/apex:pageBlockTable&gt;
          &lt;/apex:pageBlockSection&gt;
      &lt;/apex:pageBlock&gt;
  &lt;/apex:form&gt;
&lt;/apex:page&gt;</pre></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec14"/>Controller methods</h2></div></div></div><p>There are three <a id="id106" class="indexterm"/>types of methods which can be used within a custom controller or a controller extension:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Getter methods</li><li class="listitem" style="list-style-type: disc">Setter methods</li><li class="listitem" style="list-style-type: disc">Action methods</li></ul></div><div><div><div><div><h3 class="title"><a id="ch02lvl3sec02"/>Getter methods</h3></div></div></div><p>Developers can use<a id="id107" class="indexterm"/> getter <a id="id108" class="indexterm"/>methods to display a database or other computed values in the Visualforce markup. This means that getter methods are used to pass data from Apex controllers to the Visualforce page. There are two ways to define getter methods.</p><p>Typically, getter methods are named as <code class="literal">getVariable</code>, where the variable is the name of the attribute that is returned by the getter method:</p><div><pre class="programlisting">public class GetterSetterExample{
    String GetterVariable;
   
    public String getGetterVariable() {
        return GetterVariable;
   }
    
}</pre></div><p>A getter method can define an attribute by using the default getter and setter methods:</p><div><pre class="programlisting">public class GetterSetterExample{
    public String GetterVariableDefault{get;set;}
}</pre></div><p>The variable can be accessed on the Visualforce page with the <code class="literal">{!}</code> expression.</p></div><div><div><div><div><h3 class="title"><a id="ch02lvl3sec03"/>Setter methods</h3></div></div></div><p>Setter methods are used to pass user-defined values to the Apex controller. Setter methods are defined in the same way as getter methods are defined. The following example uses default getter and setter methods to search for items that are already in the database:</p><div><pre class="programlisting">public with sharing class SearchItemController {

    public List&lt;Item__c&gt; ExistingItems{get;set;}
    public String Keyword{get;set;}
    
    public SearchItemController(){
        ExistingItems = new List&lt;Item__c&gt;();
    }
      public void SearchItems(){    
        ExistingItems = [SELECT Id, Name, Item_Name__c, Unit_Price__c FROM Item__c WHERE Item_Name__c LIKE: ('%'+Keyword+'%')];        
    }
}</pre></div><p>The following is the <a id="id109" class="indexterm"/>Visualforce page that uses the preceding controller. The <code class="literal">Keyword</code> attribute has the default getter and setter methods for the <code class="literal">&lt;apex:inputText&gt;</code> component, which is used to acquire the user's input. The <code class="literal">ExistingItems</code> list<a id="id110" class="indexterm"/> attribute also has the default getter and setter methods to search and display the search result. When the user enters a keyword to search for and clicks on the <strong>Search</strong> button, the <code class="literal">SearchItems()</code> action method will be executed and this will acquire the keyword search text and run the query to search for the items. Before the action method executes, the keyword setter method will be executed. Then the query result will be collected to the <code class="literal">ExistingItems</code> list attribute and then the <code class="literal">ExistingItems</code> getter method will be executed and the page will display the search result:</p><div><pre class="programlisting">&lt;apex:page controller="SearchItemController"&gt;
  &lt;apex:form &gt;
      &lt;apex:pageBlock &gt;
          &lt;apex:pageBlockSection &gt;
              &lt;apex:pageBlockSectionItem &gt;
                  &lt;apex:outputLabel value="Item Name Or keyword"&gt;&lt;/apex:outputLabel&gt;
                  &lt;apex:inputText value="{!Keyword}"/&gt;                 
              &lt;/apex:pageBlockSectionItem&gt;  
               &lt;apex:commandButton value="Search" action="{!SearchItems}"/&gt;            
          &lt;/apex:pageBlockSection&gt;
      &lt;/apex:pageBlock&gt;
      
       &lt;apex:pageBlock title="Search Result" id="searchResult"&gt;
            &lt;apex:pageBlockTable value="{!ExistingItems}" var="oneItem" rendered="{!ExistingItems.size &gt; 0}"&gt;
                &lt;apex:column value="{!oneItem.Item_Name__c}"/&gt;
                &lt;apex:column value="{!oneItem.Unit_Price__c}"/&gt;
            &lt;/apex:pageBlockTable&gt; 
            &lt;apex:outputText value="No records to display" rendered="{!ExistingItems.size == 0}"&gt;&lt;/apex:outputText&gt;       
        &lt;/apex:pageBlock&gt;
  &lt;/apex:form&gt;
&lt;/apex:page&gt;</pre></div></div><div><div><div><div><h3 class="title"><a id="ch02lvl3sec04"/>Action methods</h3></div></div></div><p>Action methods<a id="id111" class="indexterm"/> are used to implement our custom or extended logic <a id="id112" class="indexterm"/>and functionality in a custom controller or a controller extension. Action methods can be triggered on page events such as button clicks or JavaScript events. In Visualforce pages, we can define the action attribute in many standard Visualforce components. The components are <code class="literal">&lt;apex:commandButton&gt;</code>, <code class="literal">&lt;apex:commandLink&gt;</code>, <code class="literal">&lt;apex:actionPoller&gt;</code>, <code class="literal">&lt;apex:actionSupport&gt;</code>, <code class="literal">&lt;apex:actionFunction&gt;</code>, and <code class="literal">&lt;apex:page&gt;</code>. The preceding item search example has an action method called <code class="literal">SearchItems</code>. <code class="literal">SearchItems</code> is used to query items according to the user input given for item search.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch02lvl1sec17"/>Working with large sets of data on the Visualforce page</h1></div></div></div><p>On a <a id="id113" class="indexterm"/>Visualforce page, we have to work with a single record as well as large sets of data. When we work with large sets of data, we may use iteration components such as <code class="literal">&lt;apex:pageBlockTable&gt;</code>, <code class="literal">&lt;apex:repeat&gt;</code>, and <code class="literal">&lt;apex:dataTable&gt;</code>. These iteration components are limited to a maximum of 1000 items in a collection. Refer the search item example for the usage of the iteration component. We have used <code class="literal">&lt;apex:pageBlockTable&gt;</code> in the previous search item example.</p><div><div><h3 class="title"><a id="tip13"/>Tip</h3><p>Custom controllers and controller extensions adhere to the Apex governor limits.</p></div></div><p>Visualforce provides the "read-only mode" feature to overcome the limit on the number of rows that can be queried within one request and the limit on the number of collection items that can be iterated on the page. There are two ways to set up the Visualforce's read-only mode feature, which are as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Setting the read-only mode for controller methods</strong>: For this setting, we can define Visualforce controller methods with the <code class="literal">@ReadOnly</code> annotation. This read-only mode relaxes the number of records queried within one query from 50,000 to 1 million rows. The <code class="literal">@ReadOnly</code> annotation for the read-only mode is used in JavaScript remoting as the target of remote JavaScript call to load the data set for the <code class="literal">&lt;apex:chart&gt;</code> component and display some values in a component.</li><li class="listitem" style="list-style-type: disc"><strong>Setting the read-only mode for an entire page</strong>: This read-only mode can be enabled by adding a <code class="literal">true</code> value for the <code class="literal">readOnly</code> attribute, which is on <code class="literal">&lt;apex:page&gt;.</code> This <a id="id114" class="indexterm"/>read-only mode relaxes the number of records queried within one query from 50,000 to 1 million. It also increases the maximum number of items in a collection for an iteration component. Because this is a read-only mode, you have to note that the page cannot execute any DML operation.</li></ul></div></div>
<div><div><div><div><h1 class="title"><a id="ch02lvl1sec18"/>Order of execution of a Visualforce page</h1></div></div></div><p>A Visualforce page has a life cycle<a id="id115" class="indexterm"/> or life-time. This time is defined as the period between the creation of the page and its destruction during the user session. The life cycle is defined by the type of Visuaforce page request and the content of the page. There are two types of Visualforce page requests, which are as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Get request</li><li class="listitem" style="list-style-type: disc">Postback request</li></ul></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec15"/>Order of execution for a Visualforce page's get requests</h2></div></div></div><p>When we request a new page by entering a URL or by clicking on a button or a link, a get request is created. The following diagram illustrates how a Visualforce page interacts with a custom controller or a controller extension during a get request:</p><div><img src="img/9818_02_05.jpg" alt="Order of execution for a Visualforce page's get requests"/><div><p>Order of Execution for Visualforce page's get requests</p></div></div><p>The order of execution is as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Constructor <a id="id116" class="indexterm"/>methods are called by initiating the controller objects.</li><li class="listitem">If there are any custom components, they are created and constructor methods are called on their associated class. If any attribute is specified in a component using an expression, those expressions are also evaluated.</li><li class="listitem">Any <code class="literal">assignTo</code> attributes and expressions are evaluated. After that, the <code class="literal">action</code> attribute on the <code class="literal">&lt;apex:page&gt;</code> component is evaluated and all the getter or setter methods are called.</li><li class="listitem">If the page contains an <code class="literal">&lt;apex:form&gt;</code> tag, then all of the information representing the state of the database is encrypted and saved in the view state between page requests. Whenever the page is updated, that view state is also updated.</li><li class="listitem">Finally, the resultant HTML is sent to the browser. If there are any client-side technologies (such as JavaScript, and CSS), the browser executes them.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec16"/>Order of execution for a Visualforce page's postback requests</h2></div></div></div><p>Some user <a id="id117" class="indexterm"/>interactions (for example, a <code class="literal">save</code> action triggered by the user's button click) require page updates, typically those page updates are performed by postback requests. The following diagram illustrates how a Visualforce page interacts with a custom controller or a controller extension during a postback request:</p><div><img src="img/9818_02_06.jpg" alt="Order of execution for a Visualforce page's postback requests"/><div><p>Order of execution for a Visualforce page's postback requests</p></div></div><p>The order is as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">The view state is decoded and used as the basis for updating the values on the page during a postback request.</li><li class="listitem">Expressions are evaluated and setters are executed.</li><li class="listitem">The action is executed. On its successful completion, the data is updated. If the postback request redirects the user to the same page, the view state is updated.</li><li class="listitem">The results are sent to the browser.</li></ol></div><div><div><h3 class="title"><a id="tip14"/>Tip</h3><p>If we want to execute an action without performing validations on the input or data changes on the page, we can use an immediate attribute with the <code class="literal">true</code> value for a particular component.</p></div></div><p>The postback request <a id="id118" class="indexterm"/>can end with a page redirect and sometimes the custom controller or the controller extension may be shared on both the originating page and the redirected page. If the postback request contains an <code class="literal">&lt;apex:form&gt;</code> component, only the ID query parameter is returned.</p><div><div><h3 class="title"><a id="tip15"/>Tip</h3><p>The <code class="literal">action</code> attribute of the <code class="literal">&lt;apex:page&gt;</code> component is evaluated only during a get request. Once the user is redirected to another page, the view state and controller objects are deleted.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch02lvl1sec19"/>Validation rules and standard controllers/custom controllers</h1></div></div></div><p>Validation rules<a id="id119" class="indexterm"/> can be applied to custom or standard objects for validating data on insert and update operations. When we perform such operations on a Visualforce page, it uses a standard controller or a custom controller, and that record may cause a validation rule error, which we can display on the Visualforce page as we do on standard pages. A validation rule has two options to select the position for displaying the error for a particular field. If we choose <strong>top of the page</strong>, the error can be displayed by using the <code class="literal">&lt;apex:pageMessages&gt;</code> or <code class="literal">&lt;apex:messages&gt;</code> component within the <code class="literal">&lt;apex:page&gt;</code> component. If we choose the <strong>field</strong> option, the error will be shown in the associated field residing next to the <code class="literal">&lt;apex:inputField&gt;</code> component. For an example, you can see the sample page given in the <em>Building a custom controller</em> section.</p><p>You can try the example by entering a non-numeric character for the <strong>Unit Price</strong> field. An error message will be displayed near to the <code class="literal">Unit_Price__c</code> field, related to the <code class="literal">&lt;apex:inputField&gt;</code> component.</p></div>
<div><div><div><div><h1 class="title"><a id="ch02lvl1sec20"/>Using the transient keyword</h1></div></div></div><p>The <code class="literal">transient</code> keyword <a id="id120" class="indexterm"/>is used for declaring variables, and is used in Apex classes. Declaring a <a id="id121" class="indexterm"/>variable as transient reduces the view state size. Variables with the <code class="literal">transient</code> keyword cannot be saved and should not be transmitted as a part of the view state of the particular Visualforce page. Transient variables are needed only for the duration of a page request.</p><p>The <code class="literal">transient</code> keyword is used in a serializable Apex class, which means the classes that implement the <code class="literal">Batchable</code> or <code class="literal">Schedulable</code> interfaces. The following Apex objects are natively considered as <code class="literal">transient</code>:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">PageReference</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">XmlStreamClasses</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Collections</code> (only if the type of object that they hold is automatically marked as <code class="literal">transient</code>)</li><li class="listitem" style="list-style-type: disc">Most objects generated by system methods such as <code class="literal">Schema.getGlobalDescribe</code></li><li class="listitem" style="list-style-type: disc">Static variables</li><li class="listitem" style="list-style-type: disc">Instances of the <code class="literal">JSONParser</code> class</li></ul></div><p>The following <a id="id122" class="indexterm"/>example has a transient <code class="literal">datatime</code> variable and a non-transient <code class="literal">datatime</code> variable. This example shows the major feature of transient variables, which is that they cannot be saved and should not be a part of the view state. When we click on the <strong>Refresh</strong> button, the transient date will be recreated but the non-transient date will have its original value:</p><div><pre class="programlisting">&lt;apex:page controller="TransientExampleController"&gt;
    Non Transient Date: {!t1} &lt;br/&gt;
    Transient Date    : {!t2} &lt;br/&gt;
    &lt;apex:form &gt;
        &lt;apex:commandLink value="Refresh"/&gt;
    &lt;/apex:form&gt;
&lt;/apex:page&gt;

public with sharing class TransientExampleController {
    DateTime t1;
    transient DateTime t2;
    public String getT1() {
        if (t1 == null) t1 = System.now();
        return '' + t1;
    }
    
    public String getT2() {
        if (t2 == null) t2 = System.now();
        return '' + t2;
    }</pre></div></div>
<div><div><div><div><h1 class="title"><a id="ch02lvl1sec21"/>Considerations for creating custom controllers and controller extensions</h1></div></div></div><p>When you are creating <a id="id123" class="indexterm"/>custom controllers and controller <a id="id124" class="indexterm"/>extensions, keep the following consideration in mind:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The most important thing to keep in your mind is Apex governor limits.</li><li class="listitem" style="list-style-type: disc">Apex classes can be run in the system mode and user mode by using <code class="literal">without sharing</code> and <code class="literal">with sharing</code> respectively. Sensitive data can be exposed without sharing controllers.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">webservice</code> methods must be defined as global. All other methods are public.</li><li class="listitem" style="list-style-type: disc">Try to access the database in less time by using sets, maps, or lists. This will increase the efficiency of your code.</li><li class="listitem" style="list-style-type: disc">Apex methods and variables are not instantiated in a guaranteed order.</li><li class="listitem" style="list-style-type: disc">You cannot implement <strong>Data Manipulation Language</strong> (<strong>DML</strong>)<a id="id125" class="indexterm"/> in the constructor method of a controller.</li><li class="listitem" style="list-style-type: disc">You cannot define the <code class="literal">@future</code> annotation for any getter method, setter method, or constructor method of a controller.</li><li class="listitem" style="list-style-type: disc">Primitive data types (String, Integer, and so on) are passed by value and non-primitive Apex data types (list, maps, set, sObject, and so on) are passed by the reference to a component's controller.</li></ul></div></div>
<div><div><div><div><h1 class="title"><a id="ch02lvl1sec22"/>Summary</h1></div></div></div><p>In this chapter, we became familiar with types of controllers and extensions. We learned the differences and the usage of standard controller, standard list controller, custom controller, and controller extension. We learned how to handle the code in order work with a large set of data. Further, we have seen the order of execution of a Visualforce page, usage of the transient keyword, and the interconnection between validation rules and controllers.</p></div></body></html>