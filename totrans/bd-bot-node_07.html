<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Facebook Messenger Bot, Who's Off &#x2013; A Scheduler Bot for Teams"><div class="titlepage" id="aid-181NK2"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Facebook Messenger Bot, Who's Off – A Scheduler Bot for Teams</h1></div></div></div><p>Facebook has launched its own messaging platform (<a class="ulink" href="https://developers.facebook.com/docs/messenger-platform/product-overview">https://developers.facebook.com/docs/messenger-platform/product-overview</a>), which enables us to enrich our conversation experience with other users on a messengers. Companies, apart from just showing information, can now provide new ways of conversational experience using custom bots. These bots can be integrated with the company's Facebook Page. With this, customers or employees of that company can easily look for information on the page and also chat at the same time on Facebook Messenger itself.</p><p>The Facebook Messenger platform's APIs can be used not only to send messages, but also to send links, photos, videos, files, and images. Facebook Messenger has a feature called secret messages or conversations. These secret conversations are currently available only in the Messenger app, downloaded on iOS and Android devices. With these conversations, we can only send messages, pictures, and stickers. Group messages, videos, GIFs, video calling, and payments are not supported in secret conversations.</p><p>Recently, I read about Domino's pizzas getting ordered from Facebook Messenger! So just by chatting, you can now select your pizza, order it, and process the payment as well. Here, users are provided with a seamless experience during the chat itself.</p><p>In this chapter, we'll build a Facebook Messenger bot and enhance it to schedule off-hours. Our bot will also help us discover who and when a person will take off; this will all be done through an elegant calendar-based user interface.</p><p>Awesome! Let's start now.</p><div class="section" title="Setting up our Facebook Messenger bot"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec34"/>Setting up our Facebook Messenger bot</h1></div></div></div><p>Facebook has great documentation on how to set up a bot. You can also refer to the steps mentioned at <a class="ulink" href="https://developers.facebook.com/docs/messenger-platform/guides/quick-start">https://developers.facebook.com/docs/messenger-platform/guides/quick-start</a>.</p><p>We will be using the following steps to build a basic bot:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Create a Facebook Page for our bot</li><li class="listitem">Create an app within Facebook</li><li class="listitem">Create a basic Facebook Messenger bot in Node.js, specifically in Microsoft Azure</li><li class="listitem">Wire up the Facebook app and the basic bot</li></ul></div><p>Let's start working on these steps one by one.</p><div class="section" title="The Facebook Page for our basic bot"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec28"/>The Facebook Page for our basic bot</h2></div></div></div><p>First of all, log in to Facebook. You can use the existing pages or create a new page.</p><p>We will implement our bot in a way that it will tell users who would be off and when. Let's create a page called <span class="emphasis"><em>Who's Off</em></span> by navigating to <a class="ulink" href="https://www.facebook.com/pages/create/">https://www.facebook.com/pages/create/</a>.</p><p>Once you hit the URL, you will see the following screen:</p><p>
</p><div class="mediaobject"><img src="../Images/image00325.jpeg" alt="The Facebook Page for our basic bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Choose the page type as <span class="strong"><strong>Company, Organization or Institution</strong></span>. This will show the following input screen:</p><p>
</p><div class="mediaobject"><img src="../Images/image00326.jpeg" alt="The Facebook Page for our basic bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Provide information on this page, such as the type and name of the company.</p><p>Select <span class="strong"><strong>Internet Company</strong></span> and set the name as <code class="literal">Who's Off</code>. Then click on the <span class="strong"><strong>Get Started</strong></span> button. This will open up a wizard to set up all the other properties for your company, such as the profile information:</p><p>
</p><div class="mediaobject"><img src="../Images/image00327.jpeg" alt="The Facebook Page for our basic bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>You can skip this wizard or directly go to the last tab, <span class="strong"><strong>4. Preferred Page Audience</strong></span>, to save the information.</p><p>This creates a Facebook Page for our bot. This will appear as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00328.jpeg" alt="The Facebook Page for our basic bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></div><div class="section" title="Creating a Facebook app for our basic bot"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec29"/>Creating a Facebook app for our basic bot</h2></div></div></div><p>After creating a page, now let's create a Facebook app for our bot via <a class="ulink" href="https://developers.facebook.com/quickstarts/">https://developers.facebook.com/quickstarts/</a>. This will lead us to a screen where we can configure our app as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00329.jpeg" alt="Creating a Facebook app for our basic bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Click on <span class="strong"><strong>basic setup</strong></span> to open a popup and enter the following information:</p><p>
</p><div class="mediaobject"><img src="../Images/image00330.jpeg" alt="Creating a Facebook app for our basic bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>While creating the app ID, security check will be done as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00331.jpeg" alt="Creating a Facebook app for our basic bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Please respond to<span class="strong"><strong> Security Check</strong></span> and click on <span class="strong"><strong>Submit</strong></span> to set up your Facebook app by following the instructions on this screen:</p><p>
</p><div class="mediaobject"><img src="../Images/image00332.jpeg" alt="Creating a Facebook app for our basic bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Since we want to set up a messenger, click on the <span class="strong"><strong>Get Started</strong></span> button available in <span class="strong"><strong>Messenger</strong></span>. This will lead you to the following screen:</p><p>
</p><div class="mediaobject"><img src="../Images/image00333.jpeg" alt="Creating a Facebook app for our basic bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Now locate the section called <span class="strong"><strong>Token Generation</strong></span> in the page and select the Facebook Page created earlier. This will generate a token for the selected page, as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00334.jpeg" alt="Creating a Facebook app for our basic bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>This page token will be used while communicating with the APIs.</p><p>To receive messages from users, our Facebook app needs the Webhooks integration. Before we set up Webhooks, let's create a Node.js Facebook Messenger app. The Facebook Webhook integration needs our bot app to be accessible over HTTPs. So we will need to do this using Microsoft Azure.</p></div><div class="section" title="Setting up our bot server in Azure"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec30"/>Setting up our bot server in Azure</h2></div></div></div><p>As mentioned, we need an HTTPs-enabled bot server so that we can integrate it in Facebook. We will build our bot server in Microsoft Azure.</p><p>Let's log in to the Azure portal and locate <span class="strong"><strong>App Services</strong></span> to create a Node.js-based bot server. Refer to the following screen:</p><p>
</p><div class="mediaobject"><img src="../Images/image00335.jpeg" alt="Setting up our bot server in Azure"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Click on the <span class="strong"><strong>Add </strong></span>link to open the following screen. Then, select the <span class="strong"><strong>Web + Mobile</strong></span> option and search for an empty Node.js-based web app template, as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00336.jpeg" alt="Setting up our bot server in Azure"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>After selecting the template as <span class="strong"><strong>Node JS Empty Web App</strong></span>, click on the <span class="strong"><strong>Create</strong></span> button to create the Node.js-based site. The next screen will ask you to input the name of your site and resources:</p><p>
</p><div class="mediaobject"><img src="../Images/image00337.jpeg" alt="Setting up our bot server in Azure"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Provide the required information and click on the <span class="strong"><strong>Create</strong></span> button at the bottom to create a site called <code class="literal">whosoffchatbotsite.azurewebsites.net</code>.</p><p>Once created, you should see the following properties of the site using the <span class="strong"><strong>Overview</strong></span> menu option from the <span class="strong"><strong>App Services</strong></span> selected site:</p><p>
</p><div class="mediaobject"><img src="../Images/image00338.jpeg" alt="Setting up our bot server in Azure"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Click on <code class="literal">http://whosoffchatbotsite.azurewebsites.net</code> to check how our initial Node.js site looks or whether there are any issues:</p><p>
</p><div class="mediaobject"><img src="../Images/image00339.jpeg" alt="Setting up our bot server in Azure"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>With this, we were able to create and run Node.js from Microsoft Azure.</p><p>In <a class="link" title="Chapter 2. Getting Skype to Work for You" href="part0021.xhtml#aid-K0RQ2">
Chapter 2
</a>, <span class="emphasis"><em>Getting Skype to Work for You</em></span>, we looked at how to create a Node.js site using the Azure command-line interface. In this chapter, we have so far created a Node.js site in Azure itself; now, we will modify the basic Node.js site for our bot.</p><p>To modify the basic bot program, first we will clone the template on our local file system using git commands. Then, we will modify and deploy it to Microsoft Azure.</p><p>Let's start by creating a folder in our local drive in order to store our bot program from the Command Prompt:</p><pre class="programlisting">
<span class="strong"><strong>mkdir whosoffchatbot</strong></span>
<span class="strong"><strong>cd whosoffchatbot</strong></span>
</pre><p>Now go to the newly created directory and run the following command:</p><p>
</p><div class="mediaobject"><img src="../Images/image00340.jpeg" alt="Setting up our bot server in Azure"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>This command will clone our site from a remote URL to a local file system. Once the site is cloned, move to the <code class="literal">NodeJS-EmptySiteTemplate</code> directory and run <code class="literal">server.js</code> as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00341.jpeg" alt="Setting up our bot server in Azure"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Once the cloning is successful, you should see the bot program in Node.js running, as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00342.jpeg" alt="Setting up our bot server in Azure"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>So far, we have used a template from a remote git repository and cloned it to a local file system. Now we'll set our own git location for the bot program. The reason is that, whenever we make a change in <code class="literal">server.js</code>, which is our bot program, we would also like the changes to be deployed to Azure; we can do this using git commands. So we will be setting up a local git repository for our bot program in Azure itself.</p><div class="section" title="Setting up a local git repository for our bot server in Azure"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec9"/>Setting up a local git repository for our bot server in Azure</h3></div></div></div><p>First, disconnect the remote git library of our program using the <span class="strong"><strong>Disconnect</strong></span> menu option:</p><p>
</p><div class="mediaobject"><img src="../Images/image00343.jpeg" alt="Setting up a local git repository for our bot server in Azure"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Once disconnected, use the <span class="strong"><strong>Setup</strong></span> option to set up a code repository for our program, as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00344.jpeg" alt="Setting up a local git repository for our bot server in Azure"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Once you click on <span class="strong"><strong>Setup</strong></span>, the <span class="strong"><strong>Deployment Source</strong></span> screen will be launched, as shown in the following screenshot.</p><p>
</p><div class="mediaobject"><img src="../Images/image00345.jpeg" alt="Setting up a local git repository for our bot server in Azure"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Choose the <span class="strong"><strong>Local Git Repository</strong></span> option to set up a git-based repository for the site.</p><p>Now if you look at the website properties, you will see that a git URL as well as an FTP account has been set up. We can deploy our site to Azure using either git commands or FTP. Refer to the following screenshot for the newly updated properties:</p><p>
</p><div class="mediaobject"><img src="../Images/image00346.jpeg" alt="Setting up a local git repository for our bot server in Azure"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>So we have set up a git repository in Azure, but the site we cloned from a local file system earlier is still pointing to a remote URL. Let's point our local git configurations to the newly created Azure clone repository using the following command:</p><p>
</p><div class="mediaobject"><img src="../Images/image00347.jpeg" alt="Setting up a local git repository for our bot server in Azure"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></div><div class="section" title="Modifying our bot program for Facebook verification"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec10"/>Modifying our bot program for Facebook verification</h3></div></div></div><p>When we cloned bot program code within <code class="literal">server.js</code>, the following is auto-generated:</p><pre class="programlisting">var http = require('http'); &#13;
 &#13;
http.createServer(function (req, res) { &#13;
     &#13;
    res.writeHead(200, { 'Content-Type': 'text/html' }); &#13;
    res.end('Hello, world!'); &#13;
     &#13;
}).listen(process.env.PORT || 8080); &#13;
</pre><p>Now let's start modifying our code. But before that, we need to install some node modules; we can do this using the following command:</p><pre class="programlisting">
<span class="strong"><strong>npm install express body-parser request --save</strong></span>
</pre><p>The <code class="literal">body-parser</code> npm module helps in parsing the incoming requests available under <code class="literal">req.body</code>.</p><p>Now let's open our <code class="literal">server.js</code> and modify it as follows:</p><pre class="programlisting">var express = require('express'); &#13;
var bodyParser = require('body-parser'); &#13;
var request = require('request'); &#13;
var app = express(); &#13;
  &#13;
app.use(bodyParser.urlencoded({extended: false})); &#13;
app.use(bodyParser.json()); &#13;
  &#13;
app.get('/', function (req, res) { &#13;
    res.send('This is my Facebook Messenger Bot - Whos Off Bot Server'); &#13;
}); &#13;
  &#13;
app.get('/webhook', function (req, res) { &#13;
    if (req.query['hub.verify_token'] === 'whosoffbot_verify_token') {       &#13;
        res.status(200).send(req.query['hub.challenge']); &#13;
    } else { &#13;
        res.status(403).send('Invalid verify token'); &#13;
    } &#13;
}); &#13;
 &#13;
app.listen((process.env.PORT || 8080)); &#13;
</pre><p>Let's run our bot program using the following command:</p><p>
</p><div class="mediaobject"><img src="../Images/image00348.jpeg" alt="Modifying our bot program for Facebook verification"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Then open a browser window and hit <code class="literal">
http://localhost:8080
</code>:</p><p>
</p><div class="mediaobject"><img src="../Images/image00349.jpeg" alt="Modifying our bot program for Facebook verification"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>This will show us that our Node.js program is working fine. Now let's deploy this code to Azure using git commands. This time, all our node modules, which are marked as a dependent using <code class="literal">--save</code>, will also be pushed to Azure. Sometimes, you may encounter a timeout error while pushing the code. But again, try to push the code; it should get deployed.</p><p>The git commands that we need to execute are as follows:</p><pre class="programlisting">
<span class="strong"><strong>git add .</strong></span>
<span class="strong"><strong>git commit -m "First Change to server.js"</strong></span>
<span class="strong"><strong>git push origin master</strong></span>
</pre><p>Once the code is deployed to Azure, browse the site and check whether it reflects the latest changes, as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00350.jpeg" alt="Modifying our bot program for Facebook verification"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></div><div class="section" title="Setting up a Webhook and Facebook verification of our bot program"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec11"/>Setting up a Webhook and Facebook verification of our bot program</h3></div></div></div><p>Now let's go back to our Facebook app; we had stopped at token generation. Let's set up Webhooks in our Facebook app, as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00351.jpeg" alt="Setting up a Webhook and Facebook verification of our bot program"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>A few important things to note here:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>Callback URL</strong></span> has to be accessible from Facebook and should be on HTTPS.</li><li class="listitem"><span class="strong"><strong>Callback URL</strong></span> with Webhook should return a token, as mentioned at <span class="strong"><strong>Verify token</strong></span>. Verify that the token is the same as the one we referred to in <code class="literal">server.js</code>, as follows:</li></ul></div><pre class="programlisting">if (req.query['hub.verify_token'] === 'whosoffbot_verify_token') { &#13;
</pre><p>The token <code class="literal">'whosoffbot_verify_token</code>, provided in the code should match the token on Facebook.</p><p>Once your token is verified, you should see the following screen:</p><p>
</p><div class="mediaobject"><img src="../Images/image00352.jpeg" alt="Setting up a Webhook and Facebook verification of our bot program"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>So Webhook is verified and set, but we need a page to subscribe to this Webhook. Refer to the following screen and subscribe to the <span class="strong"><strong>Who's Off</strong></span> page, which we created at the beginning:</p><p>
</p><div class="mediaobject"><img src="../Images/image00353.jpeg" alt="Setting up a Webhook and Facebook verification of our bot program"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>This is how we linked our basic bot to a Facebook Page. Now let's open our <span class="strong"><strong>Who's Off </strong></span>page from Facebook and click on the <span class="strong"><strong>Message</strong></span> button to make our bot active. You should see a green dot before the bot name indicating it is active. Refer to the following screenshot for details:</p><p>
</p><div class="mediaobject"><img src="../Images/image00354.jpeg" alt="Setting up a Webhook and Facebook verification of our bot program"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>If you try to post anything to this bot, it will not do anything as we have not programmed Webhooks in relation to posting commands. Now let's ask our bot to echo what the user is saying in a chat window. To achieve this, let's include the following code snippet in our <code class="literal">server.js</code>:</p><pre class="programlisting">app.post('/webhook', function (req, res) { &#13;
   var events = req.body.entry[0].messaging; &#13;
    for (i = 0; i &lt; events.length; i++) { &#13;
        var event = events[i]; &#13;
        if (event.message &amp;&amp; event.message.text) { &#13;
            sendMessage(event.sender.id, {text: "Echo: " + event.message.text}); &#13;
        } &#13;
    } &#13;
    res.sendStatus(200); &#13;
}); &#13;
function sendMessage(recipientId, message) { &#13;
    request({ &#13;
        url: '<a class="ulink" href="https://graph.facebook.com/v2.6/me/messages">https://graph.facebook.com/v2.6/me/messages</a>', &#13;
        qs: {access_token: &lt;PAGE_ACCESS_TOKEN&gt;}, &#13;
        method: 'POST', &#13;
        json: { &#13;
            recipient: {id: recipientId}, &#13;
            message: message, &#13;
        } &#13;
    }, function(error, response, body) { &#13;
        if (error) { &#13;
            console.log('Error sending message: ', error); &#13;
        } else if (response.body.error) { &#13;
            console.log('Error: ', response.body.error); &#13;
        } &#13;
    }); &#13;
}; &#13;
</pre><p>Let me explain the code snippet here. When the data is posted from a page that is subscribing to the Webhook, <code class="literal">app.post('/webhook',function(req,res){})</code> will get called. This will parse the incoming messages, and bot will form an echo message and will call the <code class="literal">sendMessage()</code> function to send the message to the same recipient with the help of a page access token.</p></div><div class="section" title="Deploying a modified bot that returns an echo"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec12"/>Deploying a modified bot that returns an echo</h3></div></div></div><p>Let's use git commands to deploy the modified code and check whether the bot would echo what we say:</p><p>
</p><div class="mediaobject"><img src="../Images/image00355.jpeg" alt="Deploying a modified bot that returns an echo"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Once you deploy the updated code, hit the Facebook Page again, and the Messenger and post data as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00356.jpeg" alt="Deploying a modified bot that returns an echo"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>We have made multiple posts to our bot, but it is not yet doing anything. Let's see what's happening at the Azure end, that is, whether there are any errors at the application level.</p></div><div class="section" title="Troubleshooting our bot in Azure"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec13"/>Troubleshooting our bot in Azure</h3></div></div></div><p>To troubleshoot the problem of bot not echoing anything, let's turn to <span class="strong"><strong>Diagnostics logs</strong></span> for our site and also start <span class="strong"><strong>Log stream</strong></span>. Log stream will show us whether there are any errors in our program:</p><p>
</p><div class="mediaobject"><img src="../Images/image00357.jpeg" alt="Troubleshooting our bot in Azure"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Now let's enter or post anything to our bot from the Facebook Page and refer to the log streams. You will get to see the line number and the error we will get, as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00358.jpeg" alt="Troubleshooting our bot in Azure"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>So our code is failing to parse the input, resulting into an error. To fix this, let's make a small change while parsing. Use <code class="literal">bodyParser</code> before the <code class="literal">urlencoded</code> call, as follows:</p><pre class="programlisting">app.use(bodyParser.json()); &#13;
app.use(bodyParser.urlencoded({extended: false})); &#13;
</pre><p>Again, deploy the modified code to Azure using git commands and try to post something to our bot. The code will run successfully and echo out what a user would post in the chat window, as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00359.jpeg" alt="Troubleshooting our bot in Azure"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Wow! So far, we have been able to wire up our bot with the Facebook Page and Messenger as well. We have also looked at how to use Azure diagnostics for logging into our site if there are issues with our bot program; we also understood how to trace and fix the problem. Now let's look at the core functionality we are trying to build for our Who's Off bot.</p></div></div><div class="section" title="Enhancing our Who's Off bot"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec31"/>Enhancing our Who's Off bot</h2></div></div></div><p>Having built a very basic Facebook Messenger bot, let's enhance our Who's Off bot.</p><p>Assume our team members are collaborating over Facebook Messenger. Our bot should be able to help this team schedule a meeting and should also be able to show who is busy on a particular day before setting up the meeting.</p><p>Now let me show you, what we will be building in Facebook Messenger for our bot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00360.jpeg" alt="Enhancing our Who's Off bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Let's dive into the flow and then look into the code implementation one by one.</p><p>When a user starts a conversation with our bot with <code class="literal">hi</code>, as shown in the preceding screenshot, then the Who's Off bot will show the first three options: <span class="strong"><strong>Schedule a Meeting</strong></span>, <span class="strong"><strong>Whos Off When</strong></span>, and <span class="strong"><strong>My Schedule</strong></span>.</p><p>Depending upon the option the user chooses, the bot will prompt options for when they would like to carry out the mentioned operation, such as scheduling a meeting, seeing who is off when, or checking out their own meetings. Refer to the following screenshot for the operation's flow:</p><p>
</p><div class="mediaobject"><img src="../Images/image00361.jpeg" alt="Enhancing our Who's Off bot"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>These operations will be done using options such as <span class="strong"><strong>Today</strong></span> and <span class="strong"><strong>Tomorrow</strong></span>. Based on what you choose, the bot will display the meeting details or will ask for it to schedule the meeting. In the preceding screenshot, it shows the meeting for the <span class="strong"><strong>Whos Off When</strong></span> option selected in Facebook Messenger is scheduled today.</p><p>So at a higher level, we will be:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Enhancing our basic bot program for a better conversational experience within Facebook Messenger by leveraging message templates; for more information, refer to <a class="ulink" href="https://developers.facebook.com/docs/messenger-platform/send-api-reference/templates">
https://developers.facebook.com/docs/messenger-platform/send-api-reference/templates
</a></li><li class="listitem">Storing meeting's information in the NoSQL database-DocumentDB</li><li class="listitem">Wiring up DocumentDB APIs and Messenger platform APIs</li></ul></div><div class="section" title="Building a conversational experience with the Who's Off bot"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec14"/>Building a conversational experience with the Who's Off bot</h3></div></div></div><p>We have already seen how users will arrive at our bot's Facebook Page and then start a conversation with our bot.</p><div class="section" title="Setting up a Messenger greeting"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl4sec9"/>Setting up a Messenger greeting</h4></div></div></div><p>Let's enhance the conversational experience of this bot now. We'll begin by adding a greeting message whenever a user starts a conversation. Follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Locate your bot page on Facebook and click on the <span class="strong"><strong>Settings</strong></span> option:<p>
</p><div class="mediaobject"><img src="../Images/image00362.jpeg" alt="Setting up a Messenger greeting"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></li><li class="listitem">On the <span class="strong"><strong>Settings</strong></span> page, locate the <span class="strong"><strong>Messaging</strong></span> menu on the left-hand side, as follows:<p>
</p><div class="mediaobject"><img src="../Images/image00363.jpeg" alt="Setting up a Messenger greeting"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></li><li class="listitem">Choose the option <span class="strong"><strong>Yes</strong></span> for <span class="strong"><strong>Show a Messenger Greeting</strong></span>, as follows:<p>
</p><div class="mediaobject"><img src="../Images/image00364.jpeg" alt="Setting up a Messenger greeting"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></li><li class="listitem">Provide the greeting text and click on the <span class="strong"><strong>Save</strong></span> button to save the text:<p>
</p><div class="mediaobject"><img src="../Images/image00365.jpeg" alt="Setting up a Messenger greeting"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></li><li class="listitem">Go back to the bot's Facebook Page and start messaging. The first time you start a conversation, the Who's Off bot will greet you like this:<p>
</p><div class="mediaobject"><img src="../Images/image00366.jpeg" alt="Setting up a Messenger greeting"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="Showing the initial options of what a bot can do"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl4sec10"/>Showing the initial options of what a bot can do</h4></div></div></div><p>At the start of a conversation, our bot will display the tasks it can perform. The user can then choose which operation he or she wants to perform. To achieve this, let's modify <code class="literal">server.js</code> as follows:</p><pre class="programlisting">var express = require('express'); &#13;
var bodyParser = require('body-parser'); &#13;
var request = require('request'); &#13;
var app = express(); &#13;
 &#13;
app.use(bodyParser.json()); &#13;
app.use(bodyParser.urlencoded({ extended: true })); &#13;
 &#13;
app.get('/', function (req, res) { &#13;
    res.send('This is my Facebook Messenger Bot - Whos Off Bot Server'); &#13;
}); &#13;
 &#13;
// for facebook verification &#13;
app.get('/webhook', function (req, res) { &#13;
    if (req.query['hub.verify_token'] === 'whosoffbot_verify_token') { &#13;
        res.status(200).send(req.query['hub.challenge']); &#13;
    } else { &#13;
        res.status(403).send('Invalid verify token'); &#13;
    } &#13;
}); &#13;
 &#13;
app.post('/webhook', function (req, res) { &#13;
    &#13;
    var events = req.body.entry[0].messaging; &#13;
    for (i = 0; i &lt; events.length; i++) { &#13;
        var event = events[i]; &#13;
 &#13;
        if (event.message &amp;&amp; event.message.text) { &#13;
            if (event.message.text.indexOf('hi') &gt; -1) { &#13;
                sendMessageWithInitialOptions(event.sender.id);                 &#13;
            }  &#13;
        } &#13;
    }    &#13;
    res.sendStatus(200); &#13;
}); &#13;
 &#13;
function sendMessageWithInitialOptions(recipientId) { &#13;
    messageData = { &#13;
        'attachment': { &#13;
            'type': 'template', &#13;
            'payload': { &#13;
                'template_type': 'button', &#13;
                'text': 'Pl. Select your options', &#13;
                'buttons': [{ &#13;
                    'type': 'postback', &#13;
                    'title': 'Schedule a Meetting', &#13;
                    'payload': 'SCHEDULE A MEETING' &#13;
                }, { &#13;
                    'type': 'postback', &#13;
                    'title': 'Whos Off When', &#13;
                    'payload': 'WHOS OFF WHEN', &#13;
                }, { &#13;
                    'type': 'postback', &#13;
                    'title': 'My Schedule', &#13;
                    'payload': 'MY SCHEDULE' &#13;
                }] &#13;
            } &#13;
        } &#13;
    }; &#13;
    sendMessage(recipientId, messageData); &#13;
}; &#13;
 &#13;
function sendMessage(recipientId, message) { &#13;
    request({ &#13;
        url: 'https://graph.facebook.com/v2.6/me/messages', &#13;
        qs: { access_token: 'PAGE_ACCESS_TOKEN' }, &#13;
        method: 'POST', &#13;
        json: { &#13;
            recipient: { id: recipientId }, &#13;
            message: message, &#13;
        } &#13;
    }, function (error, response, body) { &#13;
        if (error) { &#13;
            console.log('Error sending message: ', error); &#13;
        } else if (response.body.error) { &#13;
            console.log('Error: ', response.body.error); &#13;
        } &#13;
    }); &#13;
}; &#13;
 &#13;
app.listen((process.env.PORT || 8080)); &#13;
</pre><p>Use git commands to push the preceding code changes to Azure. Once deployed successfully, start a conversation with the bot by saying <code class="literal">hi</code>. The Who's Off bot will respond with what it can do for you, as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00367.jpeg" alt="Showing the initial options of what a bot can do"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>After checking out how our bot will respond, let's look at the code now.</p><p>The <code class="literal">app.post('/webhook')</code> function captures all the messages that come to our bot. So when a user says <code class="literal">hi</code>, there is a pattern-matching done and bot responds with the initial options for operations that it can perform. This is done using the following lines of code:</p><pre class="programlisting">if (event.message.text.indexOf('hi') &gt; -1) { &#13;
   sendMessageWithInitialOptions(event.sender.id);                 &#13;
} &#13;
</pre><p>The <code class="literal">sendMessageWithInitialOptions()</code> function actually prepares a formatted message using structured messaging templates. Since we would like to display operations that the user can choose from, we use <code class="literal">template_type</code> as <code class="literal">button</code>. Every button is of the <code class="literal">postback</code> type, and when a user clicks on one of these buttons, we can capture what the user has selected and respond to the selection.</p><p>This structured message is then returned to a sender using the <code class="literal">sendMessage()</code> function.</p><p>Based on what a user selects, the bot will respond in a button-type display. This is done to avoid wasting the end user's time in typing messages or entering keywords.</p><p>So far, we have seen how a basic conversation can happen between an end user and a bot. This same pattern will be used to further enhance our bot.</p><p>I hope you now have a little idea about how to build and enhance a conversational experience. Now let's look at how to store meeting-related information. We will use DocumentDB to store this information. Let's quickly see how we can set this up on the Azure platform.</p></div></div><div class="section" title="What is DocumentDB?"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec15"/>What is DocumentDB?</h3></div></div></div><p>In <a class="link" title="Chapter 6. BotKit – Document Manager Agent for Slack" href="part0040.xhtml#aid-164MG2">
Chapter 6
</a>, <span class="emphasis"><em>BotKit - Document Manager Agent for Slack</em></span>, I explained NoSQLs. DocumentDB is also a NoSQL where data is stored in JSON documents and offered by the Microsoft Azure platform.</p><p>For further details on DocumentDB, refer to <a class="ulink" href="https://azure.microsoft.com/en-in/services/documentdb/">
https://azure.microsoft.com/en-in/services/documentdb/
</a>.</p></div><div class="section" title="Setting up a DocumentDB for our Who's Off bot"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec16"/>Setting up a DocumentDB for our Who's Off bot</h3></div></div></div><p>Assuming you already have a Microsoft Azure subscription, follow the ensuing steps to configure a DocumentDB for your bot.</p><div class="section" title="Creating an account ID for the DocumentDB"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl4sec11"/>Creating an account ID for the DocumentDB</h4></div></div></div><p>Let's create a new account called <code class="literal">botdb</code> using the following screen from the Azure portal. Select <span class="strong"><strong>DocumentDB</strong></span> as the NoSQL API. Select the appropriate subscription and resources. Let's use existing resources for this account. You can also create a new dedicated resource. Once you enter all of the required information, hit the <span class="strong"><strong>Create</strong></span> button at the bottom to create a new account for the DocumentDB:</p><p>
</p><div class="mediaobject"><img src="../Images/image00368.jpeg" alt="Creating an account ID for the DocumentDB"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>A newly created account called <code class="literal">botdb</code> will appear, as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00369.jpeg" alt="Creating an account ID for the DocumentDB"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></div><div class="section" title="Creating a collection and database"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl4sec12"/>Creating a collection and database</h4></div></div></div><p>Select a <code class="literal">botdb</code> account from the account list shown in the preceding screenshot. It will show various menu options, such as <span class="strong"><strong>Properties</strong></span>, <span class="strong"><strong>Settings</strong></span>, <span class="strong"><strong>Collections</strong></span>, and so on.</p><p>Under this account, we need to create a collection to store meetings or event data. To create a new collection, click on the <span class="strong"><strong>Add Collection</strong></span> option, as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00370.jpeg" alt="Creating a collection and database"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>
</p><div class="mediaobject"><img src="../Images/image00371.jpeg" alt="Creating a collection and database"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>As per the preceding screenshot, we are creating a new database along with our new collection called <code class="literal">Events</code>. This new database will be named <code class="literal">EventsDB</code>. Now we can integrate this storage using the DocumentDB APIs in our Node.js program.</p></div></div><div class="section" title="Wiring up DocumentDB, Moment.js, and Node.js"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec17"/>Wiring up DocumentDB, Moment.js, and Node.js</h3></div></div></div><p>Let's go back to our <code class="literal">whosoffchatbot</code> directory and install the <code class="literal">documentdb</code> package from npm. This is nothing but the Node.js SDK for Microsoft Azure's DocumentDB. It can be located at <a class="ulink" href="https://www.npmjs.com/package/documentdb">
https://www.npmjs.com/package/documentdb
</a>.</p><p>In order to install it, run this npm command:</p><pre class="programlisting">
<span class="strong"><strong>npm install documentdb -save</strong></span>
</pre><p>While storing the meetings, we will consider the following JSON:</p><pre class="programlisting">{ &#13;
  "id": "8eeeb00d-5ae8-b01f-4054-cc8c3dda67f2", &#13;
  "ownerid": "&lt;SenderId&gt;", &#13;
  "owner": "&lt;Facebook User Name&gt;", &#13;
  "startdatetime": 1479376800, &#13;
  "enddatetime": 1479380400, &#13;
  "title": "&lt;Meeting Title&gt;" &#13;
} &#13;
</pre><p>So when the meetings get added, it'll be great if you generate a unique ID for each meeting, and the meeting information should get stored in DocumentDB. To generate these unique IDs, we will use the <code class="literal">guid</code> package. This can be located at <a class="ulink" href="https://www.npmjs.com/package/guid">
https://www.npmjs.com/package/guid
</a>. Let's install the <code class="literal">guid</code> package by using the following command:</p><pre class="programlisting">
<span class="strong"><strong>npm install guid -save</strong></span>
</pre><p>Also, all the timings for the meetings will be stored in Unix epoch or Unix time. This is done to simplify our storing process as well as query a meeting or event data with DocumentDB. So, to enable the conversion of dates to Unix epoch, we will use the npm package <code class="literal">moment</code>:</p><pre class="programlisting">
<span class="strong"><strong>npm install moment -save</strong></span>
</pre><div class="section" title="Utility functions and Node.js"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl4sec13"/>Utility functions and Node.js</h4></div></div></div><p>Considering the functionalities to be developed for this bot, I have decided to move some of the functionalities to be helper functions. These functions can be grouped under <code class="literal">utils.js</code>. Later, these functions will be called in our main Node.js file.</p><p>Refer to the following code for <code class="literal">utils.js</code>:</p><pre class="programlisting">var moment = require('moment'); &#13;
var https = require('https'); &#13;
 &#13;
function isvalidateInput(str) { &#13;
    var pattern = /^\w+[a-z A-Z_]+?\@[0-9]{1,2}\:[0-9]{1,2}\w[to][0-9]{1,2}:[0-9]{1,2}$/; &#13;
    if (str.match(pattern) == null) { &#13;
        return false; &#13;
    } else { &#13;
        return true; &#13;
    } &#13;
 &#13;
}; &#13;
exports.isvalidateInput = isvalidateInput; &#13;
 &#13;
function getFormattedTime(tsfrom, tsto) { &#13;
    var timeString = moment.unix(tsfrom).format("HH:mm") + ' - ' + moment.unix(tsto).format("HH:mm") &#13;
    return timeString; &#13;
}; &#13;
exports.getFormattedTime =getFormattedTime; &#13;
 &#13;
function getFormattedDay(tsfrom) { &#13;
    var dateString = moment.unix(tsfrom).format("MMM, DD"); &#13;
    return dateString; &#13;
}; &#13;
exports.getFormattedDay =getFormattedDay; &#13;
 &#13;
function meeting(id,recipientId,ownername,strstartdatetime,strenddatetime,strtitle){     &#13;
     this.id=id; &#13;
     this.ownerid=recipientId; &#13;
     this.owner=ownername; &#13;
     this.startdatetime=strstartdatetime; &#13;
     this.enddatetime=strenddatetime; &#13;
     this.title=strtitle;              &#13;
}; &#13;
exports.meeting =meeting; &#13;
 &#13;
function getUserName(uid,callback){ &#13;
    https.get("https://graph.facebook.com/v2.6/" + uid + "?fields=first_name,last_name&amp;access_token=&lt;PAGE_ACCESS_TOKEN&gt; ", function(res) {   &#13;
        var d = '';   &#13;
        var i;   &#13;
        arr = [];   &#13;
        res.on('data', function(chunk) {   &#13;
            d += chunk;   &#13;
        });   &#13;
        res.on('end', function() {   &#13;
            var e = JSON.parse(d);   &#13;
            callback(e.first_name);            &#13;
        });   &#13;
    });   &#13;
}; &#13;
exports.getUserName =getUserName; &#13;
</pre><p>Looking at the preceding code, you may notice that the <code class="literal">isvalidateInput()</code> function mainly validates whether the user has entered the intended meeting information or not. If not, then the bot will help by providing sample meeting information while scheduling the meeting. This function mainly validates user input against the <code class="literal">Team Meeting@10:00to11:00</code> pattern.</p><p>The functions <code class="literal">getFormattedTime()</code> and <code class="literal">getFormattedDay()</code> convert Unix epoch to human-readable date formats.</p><p>The function <code class="literal">meeting()</code> is the constructor used during the creation of a new meeting based on the user's option.</p><p>The <code class="literal">getUserName()</code> function helps in getting the Facebook user's name, based on the recipient ID or the user ID passed to the function. When we store meetings, we will also store the recipient ID as well as the meeting owner's name with the help of this function and the <code class="literal">meeting()</code>function.</p></div><div class="section" title="Wiring it all up together"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl4sec14"/>Wiring it all up together</h4></div></div></div><p>Now that we have our utility or helper functions and the required Node.js packages in place, we are ready to finally integrate our bot in the right sense. Let's start with the breakdown of the code.</p><p>First, we will refer to all the npm modules and their instantiation for this bot implementation. This can be seen in the following code snippet:</p><pre class="programlisting">var express = require('express'); &#13;
var bodyParser = require('body-parser'); &#13;
var request = require('request'); &#13;
var moment = require('moment'); &#13;
var Guid = require('guid'); &#13;
var utils = require('./utils.js'); &#13;
 &#13;
var app = express(); &#13;
 &#13;
app.use(bodyParser.json()); &#13;
app.use(bodyParser.urlencoded({ extended: true })); &#13;
</pre><p>We will also establish a connection to the DocumentDB database from Azure using the following code snippet:</p><pre class="programlisting">var DocumentClient = require('documentdb').DocumentClient; &#13;
var host = "https://botdb.documents.azure.com:443/"; &#13;
var masterKey = "PRIMARY KEY" &#13;
var docclient = new DocumentClient(host, { masterKey: masterKey }); &#13;
</pre><p>We have a Webhook set up in Facebook, and upon receiving a call to our Webhook, our bot should capture and send us the initial options. This can be achieved using the <code class="literal">sendMessageWithInitialOptions()</code> function from the following code snippet:</p><pre class="programlisting">app.post('/webhook', function (req, res) { &#13;
    var tday; &#13;
    var events = req.body.entry[0].messaging; &#13;
    for (i = 0; i &lt; events.length; i++) { &#13;
        var event = events[i]; &#13;
 &#13;
        if (event.message &amp;&amp; event.message.text) { &#13;
             if (event.message.text.indexOf('hi') &gt; -1) { &#13;
                sendMessageWithInitialOptions(event.sender.id);                 &#13;
            } &#13;
</pre><p>So here, whenever a user posts <code class="literal">hi</code>, he or she will see the initial options to proceed further.</p><p>While scheduling a meeting as well, we expect the user to provide the meeting details in a specific format. Based on what the user has sent, we will validate the input and process it further with the help of the <code class="literal">processMeetingDetails()</code> function. This is achieved using the following code snippet:</p><pre class="programlisting">else if (event.message.text.indexOf('@') &gt; -1) { &#13;
                if (utils.isvalidateInput(event.message.text)) { &#13;
                    sendMessage(event.sender.id, { 'text': 'Sure! Let me set up your meeting for '+payloadm }); &#13;
                    if (payloadm=='Today'){ &#13;
                        tday = moment().format("MM/DD/YYYY"); &#13;
                    } &#13;
                    else if (payloadm=='Tomorrow'){ &#13;
                        tday = moment().add(1, 'day').format("MM/DD/YYYY"); &#13;
                    } &#13;
                    processMeetingDetails(event.message.text, tday + ' ', event.sender.id); &#13;
                } &#13;
                else { &#13;
                    console.log('Invalid format!'); &#13;
                    sendMessage(event.sender.id, { 'text': 'Pl. input meeting details e.g. Team Meeting@10:00to11:00' }); &#13;
                } &#13;
            } &#13;
</pre><p>Based on the options shown to the user, when they respond, the response is captured in <code class="literal">event.postback.payload</code>. Based on what the user has selected to proceed further, we'll execute the next options. This is done using the following code snippet:</p><pre class="programlisting">else if (event.postback &amp;&amp; event.postback.payload) { &#13;
            payload = event.postback.payload; &#13;
            // Handle a payload from this sender &#13;
            console.log(JSON.stringify(payload));           &#13;
            if (payload == 'SCHEDULE A MEETING') { &#13;
                sendMessageWithScheduleOptions(event.sender.id); &#13;
            } &#13;
            else if (payload == 'SCHEDULETODAY') { &#13;
                payloadm='Today'; &#13;
                sendMessage(event.sender.id, { 'text': 'Pl. provide meeting details e.g. Team Meeting@10:00to11:00' }); &#13;
            } &#13;
            else if (payload == 'SCHEDULETOMORROW') { &#13;
                 payloadm='Tomorrow'; &#13;
                 sendMessage(event.sender.id, { 'text': 'Pl. provide meeting details e.g. Team Meeting@10:00to11:00' }); &#13;
            }             &#13;
            else if (payload=='WHOS OFF WHEN'){                                &#13;
                sendMessageWithAllScheduleOptions(event.sender.id); &#13;
            } &#13;
            else if (payload == 'ALLSCHEDULETODAY') { &#13;
                sendMessage(event.sender.id, 'Meeting(s) Scheduled for Today as..'); &#13;
                var tilltonight = moment().add(1, 'day').startOf('day').unix(); &#13;
                var startnow = moment().unix();                &#13;
                showWhosIsBusyWhen(event.sender.id, startnow, tilltonight);                &#13;
            } &#13;
            else if (payload == 'ALLSCHEDULETOMORROW') { &#13;
                sendMessage(event.sender.id, 'Meeting(s) Scheduled for tomorrow as..'); &#13;
                var tilltomnight = moment().add(2, 'day').startOf('day').unix(); &#13;
                var starttonight = moment().endOf('day').unix();                 &#13;
                showWhosIsBusyWhen(event.sender.id, starttonight, tilltomnight);                 &#13;
            } &#13;
        } &#13;
</pre><p>If you look at the preceding code lines, you will see payloads captured as <code class="literal">SCHEDULE A MEETING</code>, <code class="literal">SCHEDULETODAY</code>, and so on. So when a user selects these options from the Messenger screen, a post back or a call goes to our Webhook and we get what the user has selected. The function <code class="literal">sendMessageWithScheduleOptions()</code> shows options   to the user for scheduling a meeting either today or tomorrow.</p><p>When a user responds to an option, Whos Off When, the Webhook is called and the function <code class="literal">sendMessageWithAllScheduleOptions()</code> gets executed to show the options to choose the day for which you would like to see who is busy and when. This again shows the options <code class="literal">Today</code> or <code class="literal">Tomorrow</code> to the end user on the screen. Based on the option selected by the user, the function <code class="literal">showWhosIsBusyWhen</code>() gets called with appropriate parameters to get the details of who is busy and when, meaning whose meetings are scheduled when.</p><p>While building this bot, we are not asking the user to key in or type in options; instead, we are showing options to choose from the screen. These options are nothing but structured message templates. We are using a button template and list template while showing the options and data to the end user.</p><p>One of the templates we are using in the function <code class="literal">sendMessageWithInitialOptions</code>() is as follows:</p><pre class="programlisting">function sendMessageWithInitialOptions(recipientId) { &#13;
    messageData = { &#13;
        'attachment': { &#13;
            'type': 'template', &#13;
            'payload': { &#13;
                'template_type': 'button', &#13;
                'text': 'Pl. Select your options', &#13;
                'buttons': [{ &#13;
                    'type': 'postback', &#13;
                    'title': 'Schedule a Meetting', &#13;
                    'payload': 'SCHEDULE A MEETING' &#13;
                }, { &#13;
                    'type': 'postback', &#13;
                    'title': 'Whos Off When', &#13;
                    'payload': 'WHOS OFF WHEN', &#13;
                }, { &#13;
                    'type': 'postback', &#13;
                    'title': 'My Schedule', &#13;
                    'payload': 'MY SCHEDULE' &#13;
                }] &#13;
            } &#13;
        } &#13;
    }; &#13;
    sendMessage(recipientId, messageData); &#13;
}; &#13;
</pre><p>The preceding function generates a structured message with the help of a button template and using function <code class="literal">sendMessage()</code>, message with initial options are shown to end user.</p><p>On similar lines, we have the function <code class="literal">sendMessageWithScheduleOptions()</code>. This generates a structured message to show the options <code class="literal">Today</code> and <code class="literal">Tomorrow</code> so as to select when to schedule a meeting:</p><pre class="programlisting">function sendMessageWithScheduleOptions(recipientId) { &#13;
    messageData = { &#13;
        'attachment': { &#13;
            'type': 'template', &#13;
            'payload': { &#13;
                'template_type': 'button', &#13;
                'text': 'Select day to schedule a meeting', &#13;
                'buttons': [{ &#13;
                    'type': 'postback', &#13;
                    'title': 'Today', &#13;
                    'payload': 'SCHEDULETODAY' &#13;
                }, { &#13;
                    'type': 'postback', &#13;
                    'title': 'Tomorrow', &#13;
                    'payload': 'SCHEDULETOMORROW', &#13;
                }] &#13;
            } &#13;
        } &#13;
    }; &#13;
    sendMessage(recipientId, messageData); &#13;
}; &#13;
</pre><p>To process meeting data and check whether there are any conflicts, the following function is used:</p><pre class="programlisting">function processMeetingDetails(str, todaysdate, recipientId) { &#13;
    var title, stime, etime, starttime, endtime, ownername &#13;
 &#13;
    //parsing input provided for extracting meeting information &#13;
    title = str.substring(0, str.indexOf('@')); &#13;
    stime = str.substring(title.length + 1, str.indexOf('to')) + ':00'; &#13;
    etime = str.substring(str.indexOf('to') + 2, str.length) + ':00'; &#13;
 &#13;
    starttime = moment(todaysdate + stime).unix(); &#13;
    endtime = moment(todaysdate + etime).unix(); &#13;
 &#13;
    console.log(starttime + ' to ' + endtime + ' title' + title); &#13;
    //function to get Fb User Name &#13;
    utils.getUserName(recipientId, function (d) { &#13;
        ownername = d; &#13;
        var objMeeting = new utils.meeting(Guid.raw(), recipientId, ownername, starttime, endtime, title) &#13;
        CheckMeetingsIfExistsOrInsert(objMeeting); &#13;
    }); &#13;
} &#13;
</pre><p>The preceding function extracts the meeting details and passes them to check whether there are any conflicts. This function uses the utility function from <code class="literal">Utils.js</code> to get the username of the current user and check whether there are any meeting conflicts in relation to the current user. If there are no conflicts, then the meeting is scheduled with the help of the <code class="literal">CheckMeetingsIfExistsOrInsert()</code> function:</p><pre class="programlisting">function CheckMeetingsIfExistsOrInsert(objMeeting) { &#13;
    var querySpec = { &#13;
        query: 'SELECT * FROM Events b WHERE  (b.ownerid= @id) and (@start between b.startdatetime and b.enddatetime)', &#13;
        parameters: [ &#13;
            { &#13;
                name: '@id', &#13;
                value: objMeeting.ownerid &#13;
            }, &#13;
            { &#13;
                name: '@start', &#13;
                value: objMeeting.startdatetime &#13;
            } &#13;
        ] &#13;
    }; &#13;
 &#13;
    docclient.queryDocuments('dbs/EventsDB/colls/Events', querySpec).toArray(function (err, results) { &#13;
        console.log(objMeeting.title); &#13;
        if (results.length === 0) { &#13;
            console.log('No data found' + objMeeting.title); &#13;
            var documentDefinition = { &#13;
                'id': objMeeting.id, &#13;
                'ownerid': objMeeting.ownerid, &#13;
                'owner': objMeeting.owner, &#13;
                'startdatetime': objMeeting.startdatetime, &#13;
                'enddatetime': objMeeting.enddatetime, &#13;
                'title': objMeeting.title &#13;
            }; &#13;
            docclient.createDocument('dbs/EventsDB/colls/Events', documentDefinition, function (err, document) { &#13;
                if (err) return console.log(err); &#13;
                console.log('Created A Meeting with id : ', document.id); &#13;
                sendMessage(objMeeting.ownerid, { 'text': 'Meeting has been scheduled.' }); &#13;
            }); &#13;
        } else { &#13;
            console.log('Data found'); &#13;
            sendMessage(objMeeting.ownerid, { 'text': 'Meeting exists for this schedule. Pl. schedule another time.' }); &#13;
        } &#13;
    }); &#13;
} &#13;
</pre><p>This function queries our DocumentDB-based database and checks whether any meeting is scheduled for that duration with the help of the <code class="literal">docclient.queryDocuments()</code> function.</p><p>If there are no meetings for the said duration, a new meeting is created using the <code class="literal">docclient.createDocument()</code> function. For a newly created meeting, the user who is scheduling a meeting is made the meeting owner by default.</p><p>When a user selects an option for <span class="strong"><strong>Whos Off When</strong></span>, the <code class="literal">showWhosIsBusyWhen()</code> function gets invoked and displays the information of all the meetings scheduled along with their owners and time slots:</p><pre class="programlisting">function showWhosIsBusyWhen(recipientId,start, end) { &#13;
    var querySpec = { &#13;
        query: 'SELECT * FROM Events b WHERE  b.startdatetime&lt;= @end and b.startdatetime&gt;= @start ORDER BY b.startdatetime', &#13;
        parameters: [             &#13;
            { &#13;
                name: '@end', &#13;
                value: end &#13;
            }, &#13;
            { &#13;
                name: '@start', &#13;
                value: start &#13;
            } &#13;
        ] &#13;
    }; &#13;
    docclient.queryDocuments('dbs/EventsDB/colls/Events', querySpec).toArray(function (err, results) { &#13;
        if (results.length &gt; 0) { &#13;
            sendMessageWithMeetingsOwnerInList(recipientId, results) &#13;
        } &#13;
    }); &#13;
} &#13;
</pre><p>Based on the passed dates, the scheduled meeting's details are shown in a list along with their owners using the <code class="literal">sendMessageWithMeetingsOwnerInList</code>() function:</p><pre class="programlisting">function sendMessageWithMeetingsOwnerInList(recipientId, results) { &#13;
    var card; &#13;
    var cards = []; &#13;
    var messageData; &#13;
 &#13;
    messageData = { &#13;
        attachment: { &#13;
            type: 'template', &#13;
            payload: { &#13;
                template_type: 'generic', &#13;
                elements: [] &#13;
            } &#13;
        } &#13;
    }; &#13;
 &#13;
    for (i = 0; i &lt; results.length; i++) { &#13;
        card = { &#13;
            title: results[i].title, &#13;
            item_url: 'https://myorgmeetings.com/' + results[i].id, &#13;
            image_url: '', &#13;
            subtitle: 'Your confirmed meeting.', &#13;
            buttons: [ &#13;
                { &#13;
                    type: 'web_url', &#13;
                    url: 'https://myorgmeetings.com/' + results[i].id, &#13;
                    title: utils.getFormattedDay(results[i].startdatetime) &#13;
                }, &#13;
                 { &#13;
                    type: 'web_url', &#13;
                    url: 'https://myorgmeetings.com/' + results[i].id, &#13;
                    title: results[i].owner &#13;
                }, &#13;
                { &#13;
                    type: 'web_url', &#13;
                    url: 'https://myorgmeetings.com/' + results[i].id, &#13;
                    title: utils.getFormattedTime(results[i].startdatetime, results[i].enddatetime) &#13;
                } &#13;
            ] &#13;
        }; &#13;
        cards.push(card); &#13;
    } &#13;
 &#13;
    messageData.attachment.payload.elements = cards; &#13;
    sendMessage(recipientId, messageData); &#13;
}; &#13;
</pre><p>The preceding function generates a list of meetings using a generic template and displays them as cards.</p><p>I hope you now have an overall understanding of the code implementations we have done for this bot. Our final <code class="literal">server.js</code> should look as follows:</p><pre class="programlisting">var express = require('express'); &#13;
var bodyParser = require('body-parser'); &#13;
var request = require('request'); &#13;
var moment = require('moment'); &#13;
var Guid = require('guid'); &#13;
var utils = require('./utils.js'); &#13;
 &#13;
var app = express(); &#13;
 &#13;
app.use(bodyParser.json()); &#13;
app.use(bodyParser.urlencoded({ extended: true })); &#13;
 &#13;
var DocumentClient = require('documentdb').DocumentClient; &#13;
var host = "https://botdb.documents.azure.com:443/"; &#13;
var masterKey = "PRIMARY KEY" &#13;
var docclient = new DocumentClient(host, { masterKey: masterKey }); &#13;
 &#13;
var payloadm; &#13;
 &#13;
app.get('/', function (req, res) { &#13;
    res.send('This is my Facebook Messenger Bot - Whos Off Bot Server'); &#13;
}); &#13;
 &#13;
// for facebook verification &#13;
app.get('/webhook', function (req, res) { &#13;
    if (req.query['hub.verify_token'] === 'whosoffbot_verify_token') { &#13;
        res.status(200).send(req.query['hub.challenge']); &#13;
    } else { &#13;
        res.status(403).send('Invalid verify token'); &#13;
    } &#13;
}); &#13;
 &#13;
app.post('/webhook', function (req, res) { &#13;
    var tday; &#13;
    var events = req.body.entry[0].messaging; &#13;
    for (i = 0; i &lt; events.length; i++) { &#13;
        var event = events[i]; &#13;
 &#13;
        if (event.message &amp;&amp; event.message.text) { &#13;
             if (event.message.text.indexOf('hi') &gt; -1) { &#13;
                sendMessageWithInitialOptions(event.sender.id);                 &#13;
            }  &#13;
            else if (event.message.text.indexOf('@') &gt; -1) { &#13;
                if (utils.isvalidateInput(event.message.text)) { &#13;
                    sendMessage(event.sender.id, { 'text': 'Sure! Let me set up your meeting for '+payloadm }); &#13;
                    if (payloadm=='Today'){ &#13;
                        tday = moment().format("MM/DD/YYYY"); &#13;
                    } &#13;
                    else if (payloadm=='Tomorrow'){ &#13;
                        tday = moment().add(1, 'day').format("MM/DD/YYYY"); &#13;
                    } &#13;
                    processMeetingDetails(event.message.text, tday + ' ', event.sender.id); &#13;
                } &#13;
                else { &#13;
                    console.log('Invalid format!'); &#13;
                    sendMessage(event.sender.id, { 'text': 'Pl. input meeting details e.g. Team Meeting@10:00to11:00' }); &#13;
                } &#13;
            } &#13;
        } &#13;
          else if (event.postback &amp;&amp; event.postback.payload) { &#13;
            payload = event.postback.payload; &#13;
            // Handle a payload from this sender &#13;
            console.log(JSON.stringify(payload));           &#13;
            if (payload == 'SCHEDULE A MEETING') { &#13;
                sendMessageWithScheduleOptions(event.sender.id); &#13;
            } &#13;
            else if (payload == 'SCHEDULETODAY') { &#13;
                payloadm='Today'; &#13;
                sendMessage(event.sender.id, { 'text': 'Pl. provide meeting details e.g. Team Meeting@10:00to11:00' }); &#13;
            } &#13;
            else if (payload == 'SCHEDULETOMORROW') { &#13;
                 payloadm='Tomorrow'; &#13;
                 sendMessage(event.sender.id, { 'text': 'Pl. provide meeting details e.g. Team Meeting@10:00to11:00' }); &#13;
            }             &#13;
            else if (payload=='WHOS OFF WHEN'){                                &#13;
                sendMessageWithAllScheduleOptions(event.sender.id); &#13;
            } &#13;
            else if (payload == 'ALLSCHEDULETODAY') { &#13;
                sendMessage(event.sender.id, 'Meeting(s) Scheduled for Today as..'); &#13;
                var tilltonight = moment().add(1, 'day').startOf('day').unix(); &#13;
                var startnow = moment().unix();                &#13;
                showWhosIsBusyWhen(event.sender.id, startnow, tilltonight);                &#13;
            } &#13;
            else if (payload == 'ALLSCHEDULETOMORROW') { &#13;
                sendMessage(event.sender.id, 'Meeting(s) Scheduled for tomorrow as..'); &#13;
                var tilltomnight = moment().add(2, 'day').startOf('day').unix(); &#13;
                var starttonight = moment().endOf('day').unix();                 &#13;
                showWhosIsBusyWhen(event.sender.id, starttonight, tilltomnight);                 &#13;
            } &#13;
        } &#13;
 &#13;
    }    &#13;
    res.sendStatus(200); &#13;
}); &#13;
 &#13;
function sendMessageWithInitialOptions(recipientId) { &#13;
    messageData = { &#13;
        'attachment': { &#13;
            'type': 'template', &#13;
            'payload': { &#13;
                'template_type': 'button', &#13;
                'text': 'Pl. Select your options', &#13;
                'buttons': [{ &#13;
                    'type': 'postback', &#13;
                    'title': 'Schedule a Meetting', &#13;
                    'payload': 'SCHEDULE A MEETING' &#13;
                }, { &#13;
                    'type': 'postback', &#13;
                    'title': 'Whos Off When', &#13;
                    'payload': 'WHOS OFF WHEN', &#13;
                }, { &#13;
                    'type': 'postback', &#13;
                    'title': 'My Schedule', &#13;
                    'payload': 'MY SCHEDULE' &#13;
                }] &#13;
            } &#13;
        } &#13;
    }; &#13;
    sendMessage(recipientId, messageData); &#13;
}; &#13;
 &#13;
function sendMessageWithScheduleOptions(recipientId) { &#13;
    messageData = { &#13;
        'attachment': { &#13;
            'type': 'template', &#13;
            'payload': { &#13;
                'template_type': 'button', &#13;
                'text': 'Select day to schedule a meeting', &#13;
                'buttons': [{ &#13;
                    'type': 'postback', &#13;
                    'title': 'Today', &#13;
                    'payload': 'SCHEDULETODAY' &#13;
                }, { &#13;
                    'type': 'postback', &#13;
                    'title': 'Tomorrow', &#13;
                    'payload': 'SCHEDULETOMORROW', &#13;
                }] &#13;
            } &#13;
        } &#13;
    }; &#13;
    sendMessage(recipientId, messageData); &#13;
}; &#13;
 &#13;
function processMeetingDetails(str, todaysdate, recipientId) { &#13;
    var title, stime, etime, starttime, endtime, ownername &#13;
 &#13;
    //parsing input provided for extracting meeting information &#13;
    title = str.substring(0, str.indexOf('@')); &#13;
    stime = str.substring(title.length + 1, str.indexOf('to')) + ':00'; &#13;
    etime = str.substring(str.indexOf('to') + 2, str.length) + ':00'; &#13;
 &#13;
    starttime = moment(todaysdate + stime).unix(); &#13;
    endtime = moment(todaysdate + etime).unix(); &#13;
 &#13;
    console.log(starttime + ' to ' + endtime + ' title' + title); &#13;
    //function to get Fb User Name &#13;
    utils.getUserName(recipientId, function (d) { &#13;
        ownername = d; &#13;
        var objMeeting = new utils.meeting(Guid.raw(), recipientId, ownername, starttime, endtime, title) &#13;
        CheckMeetingsIfExistsOrInsert(objMeeting); &#13;
    }); &#13;
} &#13;
 &#13;
function CheckMeetingsIfExistsOrInsert(objMeeting) { &#13;
    var querySpec = { &#13;
        query: 'SELECT * FROM Events b WHERE  (b.ownerid= @id) and (@start between b.startdatetime and b.enddatetime)', &#13;
        parameters: [ &#13;
            { &#13;
                name: '@id', &#13;
                value: objMeeting.ownerid &#13;
            }, &#13;
            { &#13;
                name: '@start', &#13;
                value: objMeeting.startdatetime &#13;
            } &#13;
        ] &#13;
    }; &#13;
 &#13;
    docclient.queryDocuments('dbs/EventsDB/colls/Events', querySpec).toArray(function (err, results) { &#13;
        console.log(objMeeting.title); &#13;
        if (results.length === 0) { &#13;
            console.log('No data found' + objMeeting.title); &#13;
            var documentDefinition = { &#13;
                'id': objMeeting.id, &#13;
                'ownerid': objMeeting.ownerid, &#13;
                'owner': objMeeting.owner, &#13;
                'startdatetime': objMeeting.startdatetime, &#13;
                'enddatetime': objMeeting.enddatetime, &#13;
                'title': objMeeting.title &#13;
            }; &#13;
            docclient.createDocument('dbs/EventsDB/colls/Events', documentDefinition, function (err, document) { &#13;
                if (err) return console.log(err); &#13;
                console.log('Created A Meeting with id : ', document.id); &#13;
                sendMessage(objMeeting.ownerid, { 'text': 'Meeting has been scheduled.' }); &#13;
            }); &#13;
        } else { &#13;
            console.log('Data found'); &#13;
            sendMessage(objMeeting.ownerid, { 'tex<span class="AmznBigTextBlock">t': 'Meeting exists for this schedule. Pl. schedule another time.' }); &#13;
        } &#13;
    }); &#13;
} &#13;
 &#13;
function sendMessageWithAllScheduleOptions(recipientId) { &#13;
    messageData = { &#13;
        'attachment': { &#13;
            'type': 'template', &#13;
            'payload': { &#13;
                'template_type': 'button', &#13;
                'text': 'Select your schedule for', &#13;
                'buttons': [{ &#13;
                    'type': 'postback', &#13;
                    'title': 'Today', &#13;
                    'payload': 'ALLSCHEDULETODAY' &#13;
                }, { &#13;
                    'type': 'postback', &#13;
                    'title': 'Tomorrow', &#13;
                    'payload': 'ALLSCHEDULETOMORROW',     &#13;
                }] &#13;
            } &#13;
        } &#13;
    }; &#13;
    sendMessage(recipientId, messageData); &#13;
}; &#13;
 &#13;
function showWhosIsBusyWhen(recipientId,start, end) { &#13;
    var querySpec = { &#13;
        query: 'SELECT * FROM Events b WHERE  b.startdatetime&lt;= @end and b.startdatetime&gt;= @start ORDER BY b.startdatetime', &#13;
        parameters: [             &#13;
            { &#13;
                name: '@end', &#13;
                value: end &#13;
            }, &#13;
            { &#13;
                name: '@start', &#13;
                value: start &#13;
            } &#13;
        ] &#13;
    }; &#13;
    docclient.queryDocuments('dbs/EventsDB/colls/Events', querySpec).toArray(function (err, results) { &#13;
        if (results.length &gt; 0) { &#13;
            sendMessageWithMeetingsOwnerInList(recipientId, results) &#13;
        } &#13;
    }); &#13;
} &#13;
 &#13;
function sendMessageWithMeetingsOwnerInList(recipientId, results) { &#13;
    var card; &#13;
    var cards = []; &#13;
    var messageData; &#13;
 &#13;
    messageData = { &#13;
        attachment: { &#13;
            type: 'template', &#13;
            payload: { &#13;
                template_type: 'generic', &#13;
                elements: [] &#13;
            } &#13;
        } &#13;
    }; &#13;
 &#13;
    for (i = 0; i &lt; results.length; i++) { &#13;
        card = { &#13;
            title: results[i].title, &#13;
            item_url: 'https://myorgmeetings.com/' + results[i].id, &#13;
            image_url: '', &#13;
            subtitle: 'Your confirmed meeting.', &#13;
            buttons: [ &#13;
                { &#13;
                    type: 'web_url', &#13;
                    url: 'https://myorgmeetings.com/' + results[i].id, &#13;
                    title: utils.getFormattedDay(results[i].startdatetime) &#13;
                }, &#13;
                 { &#13;
                    type: 'web_url', &#13;
                    url: 'https://myorgmeetings.com/' + results[i].id, &#13;
                    title: results[i].owner &#13;
                }, &#13;
                { &#13;
                    type: 'web_url', &#13;
                    url: 'https://myorgmeetings.com/' + results[i].id, &#13;
                    title: utils.getFormattedTime(results[i].startdatetime, results[i].enddatetime) &#13;
                } &#13;
            ] &#13;
        }; &#13;
        cards.push(card); &#13;
    } &#13;
 &#13;
    messageData.attachment.payload.elements = cards; &#13;
    sendMessage(recipientId, messageData); &#13;
}; &#13;
 &#13;
function sendMessage(recipientId, message) { &#13;
    request({ &#13;
        url: 'https://graph.facebook.com/v2.6/me/messages', &#13;
        qs: { access_token: 'PAGE_ACCESS_TOEKN' }, &#13;
        method: 'POST', &#13;
        json: { &#13;
            recipient: { id: recipientId }, &#13;
            message: message, &#13;
        } &#13;
    }, function (error, response, body) { &#13;
        if (error) { &#13;
            console.log('Error sending message: ', error); &#13;
        } else if (response.body.error) { &#13;
            console.log('Error: ', response.body.error); &#13;
        } &#13;
    }); &#13;
}; &#13;
 &#13;
app.listen((process.env.PORT || 8080));     &#13;
</span></pre></div></div><div class="section" title="Running our bot - the Who's Off bot"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec18"/>Running our bot - the Who's Off bot</h3></div></div></div><p>Having understood the code implementation and assuming our final code is up and running on Microsoft Azure, let's look at how our bot is executed from the end user's perspective.</p><div class="section" title="Initial options"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl4sec15"/>Initial options</h4></div></div></div><p>Here are some initial options as in the following screenshot:</p><p>
</p><div class="mediaobject"><img src="../Images/image00372.jpeg" alt="Initial options"/></div><p style="clear:both; height: 1em;"> </p><p>
</p></div><div class="section" title="Scheduling a meeting"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl4sec16"/>Scheduling a meeting</h4></div></div></div><p>When a user clicks on <span class="strong"><strong>Schedule a Meeting</strong></span>, two options are sent by our bot, as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00373.jpeg" alt="Scheduling a meeting"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>Now when the user clicks on <span class="strong"><strong>Tomorrow</strong></span>, our bot will respond with some guiding text to the end user as <span class="strong"><strong>Pl. provide meeting details e.g. Team Meeting@10:00to11:00</strong></span>:</p><p>
</p><div class="mediaobject"><img src="../Images/image00374.jpeg" alt="Scheduling a meeting"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>After receiving the guiding text, the user would enter the meeting details as <code class="literal">Team Meeting@10:00to11:00</code>:</p><p>
</p><div class="mediaobject"><img src="../Images/image00375.jpeg" alt="Scheduling a meeting"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>The bot checks for conflicts, and if no conflicts are found, the meeting is scheduled and the bot responds with the message <span class="strong"><strong>Meeting has been scheduled.</strong></span>, as shown in the preceding screenshot.</p></div><div class="section" title="Whos Off When"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl4sec17"/>Whos Off When</h4></div></div></div><p>When the user selects an option for <span class="strong"><strong>Whos Off When</strong></span>, the following screen shows the options from which days, <span class="strong"><strong>Today</strong></span> or <span class="strong"><strong>Tomorrow,</strong></span> you would like to see who is off when.</p><p>
</p><div class="mediaobject"><img src="../Images/image00376.jpeg" alt="Whos Off When"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>If the user selects the option <span class="strong"><strong>Today</strong></span>, the meetings for that day are shown as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00377.jpeg" alt="Whos Off When"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>The arrow on the right-hand side shows there are multiple meetings. Just scroll to the left to see the meetings, as follows:</p><p>
</p><div class="mediaobject"><img src="../Images/image00378.jpeg" alt="Whos Off When"/></div><p style="clear:both; height: 1em;"> </p><p>
</p><p>This way, we are showing who is busy when, based on the meetings scheduled by individual members.</p><p>So we have implemented our bot in a way that it can schedule our meetings and also show all our scheduled meetings in an elegant way within the Facebook Messenger interface. There is one more operation left: <span class="strong"><strong>My Schedule</strong></span>. I will leave the implementation of this operation to you now.</p></div></div></div></div></div>
<div class="section" title="Summary" id="aid-190861"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec35"/>Summary</h1></div></div></div><p>So with Facebook, we built a bot and enhanced our team's collaborative experience. With this bot, our team can just send the meeting details on a chat window to our bot, such as the name and start and end date, and the bot will take care of rest.</p><p>To summarize, we learned how to create a Facebook Page and app. We also created a basic bot wired up in Node.js and deployed this basic bot to Microsoft Azure. We did this as Facebook Messenger needs an HTTPS-based Webhooks integration. Then, we subscribed to a page within Webhooks so that the messages that come from our bot pages could be accepted by our Node.js bot.</p><p>Finally, we enhanced our bot to display information, such as who is off when, and displayed it within a Facebook Messenger interface.</p><p>We saw that the Who's Off bot with its little intelligence can check for a conflict and then scheduled a meeting accordingly. It can also present us with a team's schedule in a Facebook-compatible Messenger template format.</p><p>Further, if you would really like to develop intelligent bots, then it's worth taking a look at <a class="ulink" href="https://wit.ai/">
https://wit.ai/
</a> and <a class="ulink" href="https://api.ai/">https://api.ai/</a>. These platforms enable us to develop chat bots that can understand humans in a better way.</p><p>Hopefully, this chapter has given you an amazing experience of building Facebook Messenger bots!</p><p>In the next chapter, we will explore how to develop IRC bots and how we can wire them up within Node.js and help our developers use it for bug-tracking purposes.</p></div></body></html>