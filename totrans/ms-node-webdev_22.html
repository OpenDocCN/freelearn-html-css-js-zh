<html><head></head><body>
<div class="calibre1" id="_idContainer279">
<h1 class="chapternumber"><span class="kobospan" id="kobo.1.1">20</span></h1>
<h1 class="chaptertitle" id="_idParaDest-342"><span class="kobospan" id="kobo.2.1">SportsStore: Administration</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.3.1">In this chapter, I will create the </span><em class="italic"><span class="kobospan" id="kobo.4.1">SportsStore</span></em><span class="kobospan" id="kobo.5.1"> administration features, which will allow authorized users to edit the product catalog and change the shipping status of customer orders.</span></p>
<h1 class="heading" id="_idParaDest-343"><span class="kobospan" id="kobo.6.1">Preparing for this chapter</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.7.1">This chapter uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.8.1">sportsstore</span></code><span class="kobospan" id="kobo.9.1"> project from </span><em class="italic"><span class="kobospan" id="kobo.10.1">Chapter 19</span></em><span class="kobospan" id="kobo.11.1">. </span><span class="kobospan" id="kobo.11.2">Open a new command prompt, navigate to the </span><code class="inlinecode"><span class="kobospan" id="kobo.12.1">sportsstore</span></code><span class="kobospan" id="kobo.13.1"> folder, and run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.14.1">Listing 20.1</span></em><span class="kobospan" id="kobo.15.1"> to start the development tools.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.16.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.17.1">You can download the example project for this chapter – and for all the other chapters in this book – from </span><a href="https://github.com/PacktPublishing/Mastering-Node.js-Web-Development" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.18.1">https://github.com/PacktPublishing/Mastering-Node.js-Web-Development</span></span></a><span class="kobospan" id="kobo.19.1">. </span><span class="kobospan" id="kobo.19.2">See </span><em class="italic"><span class="kobospan" id="kobo.20.1">Chapter 1</span></em><span class="kobospan" id="kobo.21.1"> for how to get help if you have problems running the examples.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.22.1">Listing 20.1: Starting the development tools</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.23.1">npm start
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.24.1">Open a new browser window, navigate to </span><code class="inlinecode"><span class="kobospan" id="kobo.25.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.26.1">, and you will see the product catalog, as shown in </span><em class="italic"><span class="kobospan" id="kobo.27.1">Figure 20.1</span></em><span class="kobospan" id="kobo.28.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.29.1"><img alt="" src="../Images/B21959_20_01.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.30.1">Figure 20.1: Running the application</span></p>
<h1 class="heading" id="_idParaDest-344"><span class="kobospan" id="kobo.31.1">Understanding HTML RESTful web services</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.32.1">The web service</span><a id="_idIndexMarker1054" class="calibre3"/><span class="kobospan" id="kobo.33.1"> created in </span><em class="italic"><span class="kobospan" id="kobo.34.1">Chapter 14</span></em><span class="kobospan" id="kobo.35.1"> follows the most common approach, which is to return JSON data that the client can process and present to the user. </span><span class="kobospan" id="kobo.35.2">This is the most flexible approach because it doesn’t limit the way that the data is used, allowing clients to be created that use data in ways the developers of the web service did not envisage and without their involvement.</span></p>
<p class="normal"><span class="kobospan" id="kobo.36.1">For many projects, the developers of the web service are also responsible for the client, which leads to the strange situation where all of the state management features developed by the round-trip client are recreated, using a framework such as Angular or React to create a more responsive set of features.</span></p>
<p class="normal"><span class="kobospan" id="kobo.37.1">In this situation, an alternative is to create a web service that returns fragments of HTML content instead of JSON, and create a client that responds to user interaction by sending HTTP requests to the web service, displaying the results that are obtained. </span><span class="kobospan" id="kobo.37.2">The web service still relies on HTTP methods to identify the type of operation that will be performed, and the URL path to identify the resource that is affected, but the result is pre-formatted content that can be displayed to the user, which is produced using the same template, session, and data features that were created for the conventional HTML application.</span></p>
<p class="normal"><span class="kobospan" id="kobo.38.1">This isn’t suitable for every project, especially when you need to provide access to your application’s data to third parties, but if you find yourself using a framework like React or Angular to duplicate the functionality already created for the server, then this can be a good approach that avoids the complexity of using</span><a id="_idIndexMarker1055" class="calibre3"/><span class="kobospan" id="kobo.39.1"> a big client-side framework. </span></p>
<h1 class="heading" id="_idParaDest-345"><span class="kobospan" id="kobo.40.1">Preparing for client development</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.41.1">The package I am going</span><a id="_idIndexMarker1056" class="calibre3"/><span class="kobospan" id="kobo.42.1"> to use to send HTTP requests and process the HTML responses</span><a id="_idIndexMarker1057" class="calibre3"/><span class="kobospan" id="kobo.43.1"> is called </span><code class="inlinecode"><span class="kobospan" id="kobo.44.1">htmx</span></code><span class="kobospan" id="kobo.45.1"> (</span><a href="https://htmx.org" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.46.1">https://htmx.org</span></span></a><span class="kobospan" id="kobo.47.1">), which is a good choice when the server can provide all of the statement management and content generation that will be required to create the client, which is the case for the SportsStore application. </span><span class="kobospan" id="kobo.47.2">To install the </span><code class="inlinecode"><span class="kobospan" id="kobo.48.1">HTMX</span></code><span class="kobospan" id="kobo.49.1"> package, run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.50.1">Listing 20.2</span></em><span class="kobospan" id="kobo.51.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.52.1">sportsstore</span></code><span class="kobospan" id="kobo.53.1"> folder.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.54.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.55.1">Another good package</span><a id="_idIndexMarker1058" class="calibre3"/><span class="kobospan" id="kobo.56.1"> to consider is Alpine (</span><a href="https://alpinejs.dev" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.57.1">https://alpinejs.dev</span></span></a><span class="kobospan" id="kobo.58.1">), which is more complex, but it makes it easier to manage state data in the browser and can more easily be used with web services that return JSON data.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.59.1">Listing 20.2: Installing the htmx package</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.60.1">npm install htmx.org@1.9.10
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.61.1">Table 20.1</span></em><span class="kobospan" id="kobo.62.1"> describes the package for quick reference.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.63.1">Table 20.1: The client-side package</span></p>
<table class="table-container" id="table001-17">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.64.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.65.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><a href="http://htmx.org" class="url"><span class="url"><span class="kobospan2" id="kobo.66.1">htmx.org</span></span></a>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.67.1">The </span><code class="inlinecode"><span class="kobospan2" id="kobo.68.1">HTMX</span></code><span class="kobospan4" id="kobo.69.1"> package scans HTML elements for special attributes that configure asynchronous HTTP requests, which will be sent to a web service that returns a fragment of HTML.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.70.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.71.1">HTMX</span></code><span class="kobospan" id="kobo.72.1"> package works by applying attributes to HTML elements, which are processed by JavaScript code loaded using a </span><code class="inlinecode"><span class="kobospan" id="kobo.73.1">script</span></code><span class="kobospan" id="kobo.74.1"> element. </span><span class="kobospan" id="kobo.74.2">This approach means that no client-side development toolchain is required, and the developer can simply reload the browser to see the effect of changes during development. </span><span class="kobospan" id="kobo.74.3">I find that style of development frustrating because I often forget to reload the browser, which causes me momentary confusion when the content displayed by the browser doesn’t match up with the markup that I have just saved in the code editor. </span><span class="kobospan" id="kobo.74.4">To that end, I am going to set up the </span><strong class="screentext"><span class="kobospan" id="kobo.75.1">webpack</span></strong><span class="kobospan" id="kobo.76.1"> bundler so that I can take advantage of the development server </span><code class="inlinecode"><span class="kobospan" id="kobo.77.1">reload</span></code><span class="kobospan" id="kobo.78.1"> feature.</span></p>
<p class="normal"><span class="kobospan" id="kobo.79.1">Some packages just deal</span><a id="_idIndexMarker1059" class="calibre3"/><span class="kobospan" id="kobo.80.1"> with browser reloading, but using webpack is a form of insurance because the bundle that it creates means that I can easily add JavaScript code to the client side later, without needing to revise the project tooling. </span><span class="kobospan" id="kobo.80.2">There is no requirement to use a webpack bundler with an </span><code class="inlinecode"><span class="kobospan" id="kobo.81.1">HTMX</span></code><span class="kobospan" id="kobo.82.1"> project, but I consider it a worthwhile escape hatch that lets me fix awkward problems that would otherwise be hard to deal with.</span></p>
<p class="normal"><span class="kobospan" id="kobo.83.1">Run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.84.1">Listing 20.3</span></em><span class="kobospan" id="kobo.85.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.86.1">sportsstore</span></code><span class="kobospan" id="kobo.87.1"> folder to install the packages required to create the client-side bundles.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.88.1">Listing 20.3: Installing the packages required for the bundler</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.89.1">npm install --save-dev webpack@5.89.0
npm install --save-dev webpack-cli@5.1.4
npm install --save-dev webpack-dev-server@4.15.1
npm install --save-dev npm-run-all@4.1.5
npm install http-proxy@1.18.1
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.90.1">Table 20.2</span></em><span class="kobospan" id="kobo.91.1"> describes these packages for quick reference.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.92.1">Table 20.2: The client-side development tool packages</span></p>
<table class="table-container" id="table002-15">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.93.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.94.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.95.1">webpack</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.96.1">This package contains the webpack bundler.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.97.1">webpack-cli</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.98.1">This package contains the command line for webpack.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.99.1">webpack-dev-server</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.100.1">This package contains the webpack development HTTP server.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.101.1">npm-run-all</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.102.1">This package allows you to start multiple commands using </span><code class="inlinecode"><span class="kobospan2" id="kobo.103.1">npm</span></code><span class="kobospan4" id="kobo.104.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.105.1">http-proxy</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.106.1">This package contains an HTTP proxy, which will forward requests to the webpack server during development.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.107.1">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.108.1">webpack.config.mjs</span></code><span class="kobospan" id="kobo.109.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.110.1">sportsstore</span></code><span class="kobospan" id="kobo.111.1"> folder</span><a id="_idIndexMarker1060" class="calibre3"/><span class="kobospan" id="kobo.112.1"> with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.113.1">Listing 20.4</span></em><span class="kobospan" id="kobo.114.1">, which configures webpack and sets up its development server.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.115.1">Listing 20.4: The contents of the webpack.config.mjs file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.116.1">import path from "path";
import { fileURLToPath } from "url";
const __dirname = path.dirname(fileURLToPath(import.meta.url));
export default  {
    mode: "development",
    entry:   "./src/admin/client.js",
    devtool: "source-map",   
    output: {
        path: path.resolve(__dirname, "dist/admin"),
        filename: "bundle.js"
    },
    devServer: {
        watchFiles: ["templates/admin"],
        port: 5100,	
        client: { webSocketURL: "http://localhost:5000/ws" }
    }
};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.117.1">The configuration tells webpack to create a bundle using a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.118.1">client.js</span></code><span class="kobospan" id="kobo.119.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.120.1">src/admin</span></code><span class="kobospan" id="kobo.121.1"> folder, and also to trigger a browser update if the bundle changes or if a file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.122.1">templates/admin</span></code><span class="kobospan" id="kobo.123.1"> folder changes. </span><span class="kobospan" id="kobo.123.2">The bundle will be created in a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.124.1">bundle.js</span></code><span class="kobospan" id="kobo.125.1">, which will be written to the </span><code class="inlinecode"><span class="kobospan" id="kobo.126.1">dist/admin</span></code><span class="kobospan" id="kobo.127.1"> folder. </span><span class="kobospan" id="kobo.127.2">Create the </span><code class="inlinecode"><span class="kobospan" id="kobo.128.1">src/admin</span></code><span class="kobospan" id="kobo.129.1"> folder, and add to it a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.130.1">client.js</span></code><span class="kobospan" id="kobo.131.1"> with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.132.1">Listing 20.5</span></em><span class="kobospan" id="kobo.133.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.134.1">Listing 20.5: The contents of the client.js file in the src/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.135.1">document.addEventListener('DOMContentLoaded', () =&gt; {
    // do nothing
});
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.136.1">The code in this file does nothing</span><a id="_idIndexMarker1061" class="calibre3"/><span class="kobospan" id="kobo.137.1"> because the bundle is just a means to use the webpack development HTTP server. </span><span class="kobospan" id="kobo.137.2">The bundle will be omitted from the production build of the application.</span></p>
<h2 class="heading1" id="_idParaDest-346"><span class="kobospan" id="kobo.138.1">Creating the routes and templates</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.139.1">The next steps</span><a id="_idIndexMarker1062" class="calibre3"/><span class="kobospan" id="kobo.140.1"> are to configure</span><a id="_idIndexMarker1063" class="calibre3"/><span class="kobospan" id="kobo.141.1"> the route</span><a id="_idIndexMarker1064" class="calibre3"/><span class="kobospan" id="kobo.142.1"> that will be the entry point</span><a id="_idIndexMarker1065" class="calibre3"/><span class="kobospan" id="kobo.143.1"> into the administration features and define the template that will be used to generate the response. </span><span class="kobospan" id="kobo.143.2">Create the </span><code class="inlinecode"><span class="kobospan" id="kobo.144.1">src/routes/admin</span></code><span class="kobospan" id="kobo.145.1"> folder, and add to it a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.146.1">index.ts</span></code><span class="kobospan" id="kobo.147.1"> with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.148.1">Listing 20.6</span></em><span class="kobospan" id="kobo.149.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.150.1">Listing 20.6: The contents of the index.ts file in the src/routes/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.151.1">import { Express } from "express";
export const createAdminRoutes = (app: Express) =&gt; {
    app.use((req, resp, next) =&gt; {
        resp.locals.layout = false;
        next();
    })
    app.get("/admin", (req, resp) =&gt; resp.render("admin/admin_layout"));
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.152.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.153.1">createAdminRoutes</span></code><span class="kobospan" id="kobo.154.1"> function sets up the administration routes. </span><span class="kobospan" id="kobo.154.2">To get started, there is a middleware component that disables the default layout for the template engine, and a route that handles </span><code class="inlinecode"><span class="kobospan" id="kobo.155.1">GET</span></code><span class="kobospan" id="kobo.156.1"> requests to the </span><code class="inlinecode"><span class="kobospan" id="kobo.157.1">/admin</span></code><span class="kobospan" id="kobo.158.1"> URL by rendering a template named </span><code class="inlinecode"><span class="kobospan" id="kobo.159.1">admin/admin_layout</span></code><span class="kobospan" id="kobo.160.1">. </span><span class="kobospan" id="kobo.160.2">The name of the template includes the </span><code class="inlinecode"><span class="kobospan" id="kobo.161.1">admin</span></code><span class="kobospan" id="kobo.162.1"> folder so that I can keep the administration templates separate from the rest of the application content. </span><span class="kobospan" id="kobo.162.2">The drawback of this approach is that the folder name has to be included in all calls to the </span><code class="inlinecode"><span class="kobospan" id="kobo.163.1">render</span></code><span class="kobospan" id="kobo.164.1"> method.</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.165.1">Listing 20.7</span></em><span class="kobospan" id="kobo.166.1"> adds the </span><code class="inlinecode"><span class="kobospan" id="kobo.167.1">createAdminRoutes</span></code><span class="kobospan" id="kobo.168.1"> to the set of functions called to set up the application’s routes.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.169.1">Listing 20.7: Adding routes to the index.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.170.1">import { Express } from "express";
import { createCatalogRoutes } from "./catalog";
import { createCartMiddleware, createCartRoutes } from "./cart";
import { createOrderRoutes } from "./orders";
import { createAdminRoutes } from "./admin";
export const createRoutes = (app: Express) =&gt; {
    createCartMiddleware(app);
    createCatalogRoutes(app);
    createCartRoutes(app);
    createOrderRoutes(app);
    createAdminRoutes(app);
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.171.1">To create the initial</span><a id="_idIndexMarker1066" class="calibre3"/><span class="kobospan" id="kobo.172.1"> template, create the </span><code class="inlinecode"><span class="kobospan" id="kobo.173.1">sportsstore/templates/admin</span></code><span class="kobospan" id="kobo.174.1"> folder, and add</span><a id="_idIndexMarker1067" class="calibre3"/><span class="kobospan" id="kobo.175.1"> to it a file</span><a id="_idIndexMarker1068" class="calibre3"/><span class="kobospan" id="kobo.176.1"> named </span><code class="inlinecode"><span class="kobospan" id="kobo.177.1">admin_layout.handlebars</span></code><span class="kobospan" id="kobo.178.1"> with the content</span><a id="_idIndexMarker1069" class="calibre3"/><span class="kobospan" id="kobo.179.1"> shown in </span><em class="italic"><span class="kobospan" id="kobo.180.1">Listing 20.8</span></em><span class="kobospan" id="kobo.181.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.182.1">Listing 20.8: The contents of the admin_layout.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.183.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;link href="/css/bootstrap.min.css" rel="stylesheet" /&gt;
        &lt;link href="/font/bootstrap-icons.min.css" rel="stylesheet"&gt;
        {{#if (isDevelopment) }}
            &lt;script src="/admin/bundle.js"&gt;&lt;/script&gt;
        {{/if }}
        &lt;script src="/htmx.min.js"&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="container-fluid"&gt;
            &lt;div class="row bg-info text-white py-2 px-1"&gt;
                &lt;div class="col align-baseline pt-1"&gt;SPORTS STORE ADMIN&lt;/div&gt;
                &lt;div class="col-auto text-end"&gt;&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class="row p-2"&gt;
                &lt;div class="col-2" id="area_buttons"&gt;&lt;/div&gt;
                &lt;div class="col" id="content"&gt;
                    Content Goes Here...
                </span><span class="kobospan" id="kobo.183.2">&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.184.1">This template renders </span><a id="_idIndexMarker1070" class="calibre3"/><span class="kobospan" id="kobo.185.1">an HTML document, with </span><code class="inlinecode"><span class="kobospan" id="kobo.186.1">link</span></code><span class="kobospan" id="kobo.187.1"> elements</span><a id="_idIndexMarker1071" class="calibre3"/><span class="kobospan" id="kobo.188.1"> for the Bootstrap CSS and Icons</span><a id="_idIndexMarker1072" class="calibre3"/><span class="kobospan" id="kobo.189.1"> files, and </span><code class="inlinecode"><span class="kobospan" id="kobo.190.1">script</span></code><span class="kobospan" id="kobo.191.1"> elements for the webpack bundle</span><a id="_idIndexMarker1073" class="calibre3"/><span class="kobospan" id="kobo.192.1"> and the </span><code class="inlinecode"><span class="kobospan" id="kobo.193.1">HTMX</span></code><span class="kobospan" id="kobo.194.1"> JavaScript file.</span></p>
<h2 class="heading1" id="_idParaDest-347"><span class="kobospan" id="kobo.195.1">Configuring the application</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.196.1">To complete the</span><a id="_idIndexMarker1074" class="calibre3"/><span class="kobospan" id="kobo.197.1"> preparation, </span><em class="italic"><span class="kobospan" id="kobo.198.1">Listing 20.9</span></em><span class="kobospan" id="kobo.199.1"> sets up request forwarding</span><a id="_idIndexMarker1075" class="calibre3"/><span class="kobospan" id="kobo.200.1"> to the webpack dev server and adds the </span><code class="inlinecode"><span class="kobospan" id="kobo.201.1">HTMX</span></code><span class="kobospan" id="kobo.202.1"> package folder to the set of static file locations.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.203.1">Listing 20.9: Configuring the application in the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.204.1">import { createServer } from "http";
import express, { Express } from "express";
import helmet from "helmet";
import { getConfig, getEnvironment, Env } from "./config";
import { createRoutes } from "./routes";
import { createTemplates } from "./helpers";
import { createErrorHandlers } from "./errors";
import { createSessions } from "./sessions";
import { createAuthentication } from "./authentication";
</span><strong class="screentext"><span class="kobospan" id="kobo.205.1">import httpProxy from "http-proxy";</span></strong><span class="kobospan" id="kobo.206.1">
const port = getConfig("http:port", 5000);
const expressApp: Express = express();
expressApp.use(helmet());
expressApp.use(express.json());
expressApp.use(express.urlencoded({extended: true}))
expressApp.use(express.static("node_modules/bootstrap/dist"));
expressApp.use(express.static("node_modules/bootstrap-icons"));
expressApp.use(express.static("node_modules/htmx.org/dist"));
createTemplates(expressApp);
createSessions(expressApp);
createAuthentication(expressApp);
createRoutes(expressApp);
</span><strong class="screentext"><span class="kobospan" id="kobo.207.1">//createErrorHandlers(expressApp);</span></strong><span class="kobospan" id="kobo.208.1">
const server = createServer(expressApp);
</span><strong class="screentext"><span class="kobospan" id="kobo.209.1">if (getEnvironment</span></strong><strong class="screentext"><span class="kobospan" id="kobo.210.1">() === Env.Development) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.211.1">    const proxy = httpProxy.createProxyServer({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.212.1">        target: "http://localhost:5100", ws: true</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.213.1">    });   </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.214.1">    expressApp.use("/admin"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.215.1">, (req, resp) =&gt; proxy.web(req, resp));     </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.216.1">    server.on('upgrade', (req, socket, head) =&gt; proxy.ws(req, socket, head));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.217.1">}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.218.1">createErrorHandlers(expressApp);</span></strong><span class="kobospan" id="kobo.219.1">
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.220.1">If the application is configured</span><a id="_idIndexMarker1076" class="calibre3"/><span class="kobospan" id="kobo.221.1"> for the development</span><a id="_idIndexMarker1077" class="calibre3"/><span class="kobospan" id="kobo.222.1"> environment, then the </span><code class="inlinecode"><span class="kobospan" id="kobo.223.1">http-proxy</span></code><span class="kobospan" id="kobo.224.1"> package is used to forward requests to the webpack development HTTP server, which will enable automatic browser reloading. </span></p>
<p class="normal"><span class="kobospan" id="kobo.225.1">The error handlers have to be moved so that the </span><code class="inlinecode"><span class="kobospan" id="kobo.226.1">404</span></code> <code class="inlinecode"><span class="kobospan" id="kobo.227.1">-</span></code> <code class="inlinecode"><span class="kobospan" id="kobo.228.1">Not</span></code> <code class="inlinecode"><span class="kobospan" id="kobo.229.1">Found</span></code><span class="kobospan" id="kobo.230.1"> response isn’t generated until after the handler for webpack development server has had the chance to match the request.</span></p>
<p class="normal"><span class="kobospan" id="kobo.231.1">The final preparatory step is to configure the </span><code class="inlinecode"><span class="kobospan" id="kobo.232.1">npm</span></code><span class="kobospan" id="kobo.233.1"> commands to start both the server and webpack, and to prevent the server from being restarted when the templates in the </span><code class="inlinecode"><span class="kobospan" id="kobo.234.1">admin</span></code><span class="kobospan" id="kobo.235.1"> folder are changed, as shown in </span><em class="italic"><span class="kobospan" id="kobo.236.1">Listing 20.10</span></em><span class="kobospan" id="kobo.237.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.238.1">Listing 20.10: Configuring the application in the package.json file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.239.1">{
  "name": "sportsstore",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "watch": "tsc-watch --noClear --onsuccess \"node dist/server.js\"",
    </span><strong class="screentext"><span class="kobospan" id="kobo.240.1">"server": "nodemon --exec npm run watch",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.241.1">    "client": "webpack serve",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.242.1">    "start": "npm-run-all --parallel server client"</span></strong><span class="kobospan" id="kobo.243.1">
  },
  "nodemonConfig": {
    "ext": "js,handlebars,json",
    "ignore": [
      "dist/**",
      "node_modules/**",
     </span><strong class="screentext"><span class="kobospan" id="kobo.244.1"> "templates/admin/**"     </span></strong><span class="kobospan" id="kobo.245.1">
    ]
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "devDependencies": {
    // ...packages omitted for brevity...
  </span><span class="kobospan" id="kobo.245.2">},
  "dependencies": {
    // ...packages omitted for brevity...
  </span><span class="kobospan" id="kobo.245.3">}
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.246.1">Stop the server if it is running, and then run</span><a id="_idIndexMarker1078" class="calibre3"/><span class="kobospan" id="kobo.247.1"> the command</span><a id="_idIndexMarker1079" class="calibre3"/><span class="kobospan" id="kobo.248.1"> shown in </span><em class="italic"><span class="kobospan" id="kobo.249.1">Listing 20.11</span></em><span class="kobospan" id="kobo.250.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.251.1">sportsstore</span></code><span class="kobospan" id="kobo.252.1"> folder to start the client-side build tools and the server.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.253.1">Listing 20.11: Starting the client build tools and server</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.254.1">npm start
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.255.1">Open a browser and navigate to </span><code class="inlinecode"><span class="kobospan" id="kobo.256.1">http://localhost:5000/admin</span></code><span class="kobospan" id="kobo.257.1">. </span><span class="kobospan" id="kobo.257.2">The browser will display the administration</span><a id="_idIndexMarker1080" class="calibre3"/><span class="kobospan" id="kobo.258.1"> layout, with some placeholder</span><a id="_idIndexMarker1081" class="calibre3"/><span class="kobospan" id="kobo.259.1"> text, as shown in </span><em class="italic"><span class="kobospan" id="kobo.260.1">Figure 20.2</span></em><span class="kobospan" id="kobo.261.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.262.1"><img alt="" src="../Images/B21959_20_02.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.263.1">Figure 20.2: Preparing for the administration features</span></p>
<h1 class="heading" id="_idParaDest-348"><span class="kobospan" id="kobo.264.1">Administering the product catalog</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.265.1">Now that the basic structure</span><a id="_idIndexMarker1082" class="calibre3"/><span class="kobospan" id="kobo.266.1"> is in place, it is time to start adding features. </span><span class="kobospan" id="kobo.266.2">Create a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.267.1">area_buttons.handlebars</span></code><span class="kobospan" id="kobo.268.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.269.1">templates/admin</span></code><span class="kobospan" id="kobo.270.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.271.1">Listing 20.12</span></em><span class="kobospan" id="kobo.272.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.273.1">Listing 20.12: The contents of the area_buttons.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.274.1">&lt;swap_wrapper hx-swap-oob="innerHTML:#area_buttons"&gt;
    &lt;div class="d-grid gap-2" &gt;
        &lt;button id="products_btn" class="btn </span><strong class="screentext"><span class="kobospan" id="kobo.275.1">{{ buttonClass "products" mode }}</span></strong><span class="kobospan" id="kobo.276.1">"
            hx-get="/api/products/table" hx-target="#content"&gt;
            Products
        &lt;/button&gt;
        &lt;button id="orders_btn" class="btn {{ buttonClass "orders" mode }}"
            hx-get="/api/orders/table" hx-target="#content"&gt;
            Orders
        &lt;/button&gt;
    &lt;/div&gt;
&lt;/swap_wrapper&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.277.1">This template contains the buttons that will allow the user to select an area of functionality: managing the catalog or shipping orders. </span><span class="kobospan" id="kobo.277.2">The file is processed by the Handlebars template engine, which evaluates the </span><code class="inlinecode"><span class="kobospan" id="kobo.278.1">{{</span></code><span class="kobospan" id="kobo.279.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.280.1">}}</span></code><span class="kobospan" id="kobo.281.1"> sections to produce the HTML content that is included in the response to the client. </span><span class="kobospan" id="kobo.281.2">There are two template </span><a id="_idIndexMarker1083" class="calibre3"/><span class="kobospan" id="kobo.282.1">expressions in this file, which change the value of the class attribute applied to the </span><code class="inlinecode"><span class="kobospan" id="kobo.283.1">button</span></code><span class="kobospan" id="kobo.284.1"> elements: </span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.285.1">...
</span><span class="kobospan" id="kobo.285.2">&lt;swap_wrapper </span><strong class="screentext"><span class="kobospan" id="kobo.286.1">hx-swap-oob="innerHTML:#area_buttons"</span></strong><span class="kobospan" id="kobo.287.1">&gt;
    &lt;div class="d-grid gap-2" &gt;
        &lt;button id="products_btn" class="btn {{ buttonClass "products" mode }}"
           </span><strong class="screentext"><span class="kobospan" id="kobo.288.1"> hx-get="</span></strong><strong class="screentext"><span class="kobospan" id="kobo.289.1">/api/products/table" hx-target="#content"&gt;</span></strong><span class="kobospan" id="kobo.290.1">
            Products
        &lt;/button&gt;
        &lt;button id="orders_btn" class="btn {{ buttonClass "orders" mode }}"
           </span><strong class="screentext"><span class="kobospan" id="kobo.291.1"> hx-get="/api/orders/table" hx-target="#content"&gt;</span></strong><span class="kobospan" id="kobo.292.1">
            Orders
        &lt;/button&gt;
    &lt;/div&gt;
&lt;/swap_wrapper&gt;
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.293.1">The classes applied to the elements will show the user which part of the application is active and rely on a template helper named </span><code class="inlinecode"><span class="kobospan" id="kobo.294.1">buttonClass</span></code><span class="kobospan" id="kobo.295.1">, which I’ll create shortly.</span></p>
<p class="normal"><span class="kobospan" id="kobo.296.1">Once the HTML content is received by the browser, it will be processed a second time, by the </span><code class="inlinecode"><span class="kobospan" id="kobo.297.1">HTMX</span></code><span class="kobospan" id="kobo.298.1"> package, which looks for attributes whose name begins with </span><code class="inlinecode"><span class="kobospan" id="kobo.299.1">hx</span></code><span class="kobospan" id="kobo.300.1">:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.301.1">...
</span><span class="kobospan" id="kobo.301.2">&lt;swap_wrapper hx-swap-oob="innerHTML:#area_buttons"&gt;
    &lt;div class="d-grid gap-2" &gt;
        &lt;button id="products_btn" class="btn {{ buttonClass "products" mode }}"
            hx-get="/api/products/table" hx-target="#content"&gt;
            Products
        &lt;/button&gt;
        &lt;button id="orders_btn" class="btn {{ buttonClass "orders" mode }}"
            hx-get="/api/orders/table" hx-target="#content"&gt;
            Orders
        &lt;/button&gt;
    &lt;/div&gt;
&lt;/swap_wrapper&gt;
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.302.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.303.1">hx-get</span></code><span class="kobospan" id="kobo.304.1"> attributes tell </span><code class="inlinecode"><span class="kobospan" id="kobo.305.1">HTMX</span></code><span class="kobospan" id="kobo.306.1"> to send a </span><code class="inlinecode"><span class="kobospan" id="kobo.307.1">GET</span></code><span class="kobospan" id="kobo.308.1"> request to a specific URL. </span><span class="kobospan" id="kobo.308.2">By default, </span><code class="inlinecode"><span class="kobospan" id="kobo.309.1">HTMX</span></code><span class="kobospan" id="kobo.310.1"> uses the HTML in the response to replace the element that triggered the requests, but this can be changed with the </span><code class="inlinecode"><span class="kobospan" id="kobo.311.1">hx-target</span></code><span class="kobospan" id="kobo.312.1"> attribute, which means that the </span><code class="inlinecode"><span class="kobospan" id="kobo.313.1">button</span></code><span class="kobospan" id="kobo.314.1"> elements will request </span><code class="inlinecode"><span class="kobospan" id="kobo.315.1">/api/products/table</span></code><span class="kobospan" id="kobo.316.1"> or </span><code class="inlinecode"><span class="kobospan" id="kobo.317.1">/api/orders/table</span></code><span class="kobospan" id="kobo.318.1">, and the response will be displayed using the element whose ID is </span><code class="inlinecode"><span class="kobospan" id="kobo.319.1">content</span></code><span class="kobospan" id="kobo.320.1">. </span><span class="kobospan" id="kobo.320.2">(The value of the </span><code class="inlinecode"><span class="kobospan" id="kobo.321.1">hx-target</span></code><span class="kobospan" id="kobo.322.1"> attribute is a CSS selector, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.323.1">#</span></code><span class="kobospan" id="kobo.324.1"> prefix denotes an element’s ID.)</span></p>
<p class="normal"><span class="kobospan" id="kobo.325.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.326.1">hx-swap-oob</span></code><span class="kobospan" id="kobo.327.1"> attribute allows a fragment of content to specify where it will be displayed. </span><span class="kobospan" id="kobo.327.2">The attribute applied to the </span><code class="inlinecode"><span class="kobospan" id="kobo.328.1">swap_wrapper</span></code><span class="kobospan" id="kobo.329.1"> element tells </span><code class="inlinecode"><span class="kobospan" id="kobo.330.1">HTMX</span></code><span class="kobospan" id="kobo.331.1"> that the content it contains should be used to replace the content of the element whose name is </span><code class="inlinecode"><span class="kobospan" id="kobo.332.1">area_buttons</span></code><span class="kobospan" id="kobo.333.1">. </span><span class="kobospan" id="kobo.333.2">(The </span><code class="inlinecode"><span class="kobospan" id="kobo.334.1">swap_wrapper</span></code><span class="kobospan" id="kobo.335.1"> element name is entirely made up and was chosen so that it won’t be mistaken for the actual application HTML content. </span><span class="kobospan" id="kobo.335.2">You can use any element name in your projects.)</span></p>
<p class="normal"><span class="kobospan" id="kobo.336.1">To define the </span><code class="inlinecode"><span class="kobospan" id="kobo.337.1">buttonClass</span></code><span class="kobospan" id="kobo.338.1"> helper </span><a id="_idIndexMarker1084" class="calibre3"/><span class="kobospan" id="kobo.339.1">that is used in </span><em class="italic"><span class="kobospan" id="kobo.340.1">Listing 20.12</span></em><span class="kobospan" id="kobo.341.1">, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.342.1">admin_helpers.ts</span></code><span class="kobospan" id="kobo.343.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.344.1">src/helpers</span></code><span class="kobospan" id="kobo.345.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.346.1">Listing 20.13</span></em><span class="kobospan" id="kobo.347.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.348.1">Listing 20.13: The contents of the admin_helpers.ts file in the src/helpers folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.349.1">export const buttonClass = (btn: string, mode: string) =&gt;
    btn == mode ? </span><span class="kobospan" id="kobo.349.2">"btn-secondary" : "btn-outline-secondary";
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.350.1">Listing 20.14</span></em><span class="kobospan" id="kobo.351.1"> includes the new helper in the template engine configuration when the application starts.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.352.1">Listing 20.14: Adding helpers to the index.ts file in the src/helpers folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.353.1">import { Express } from "express";
import { getConfig } from "../config";
import { engine } from "express-handlebars";
import * as env_helpers from "./env";
import * as catalog_helpers from "./catalog_helpers";
import * as cart_helpers from "./cart_helpers";
import * as order_helpers from "./order_helpers";
</span><strong class="screentext"><span class="kobospan" id="kobo.354.1">import * as admin_helpers from "./admin_helpers";</span></strong><span class="kobospan" id="kobo.355.1">
const location = getConfig("templates:location");
const config = getConfig("templates:config");
export const createTemplates = (app: Express) =&gt; {
    app.set("views", location);
    app.engine("handlebars", engine({
        ...config,
       </span><strong class="screentext"><span class="kobospan" id="kobo.356.1"> helpers: {...env_helpers, ...catalog_helpers, ...cart_helpers,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.357.1">                    ...order_helpers, ...admin_helpers}</span></strong><span class="kobospan" id="kobo.358.1">
    }));
    app.set("view engine", "handlebars");
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.359.1">The content in </span><em class="italic"><span class="kobospan" id="kobo.360.1">Listing 20.12</span></em><span class="kobospan" id="kobo.361.1"> is a partial</span><a id="_idIndexMarker1085" class="calibre3"/><span class="kobospan" id="kobo.362.1"> template, which will be combined with other content to produce an HTML response, using the features provided by the template engine, and the template also allows small files to be defined and managed. </span><span class="kobospan" id="kobo.362.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.363.1">product_table.handlebars</span></code><span class="kobospan" id="kobo.364.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.365.1">templates/admin</span></code><span class="kobospan" id="kobo.366.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.367.1">Listing 20.15</span></em><span class="kobospan" id="kobo.368.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.369.1">Listing 20.15: The contents of the product_table.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.370.1">{{&gt; admin/area_buttons mode="products"}}
&lt;table class="table table-sm"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Name&lt;/th&gt;
            &lt;th&gt;Category&lt;/th&gt;&lt;th&gt;Supplier&lt;/th&gt;
            &lt;th class="text-end"&gt;Price&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        {{#each products }}   
            &lt;tr&gt;&lt;td colspan="6"&gt;{{name}}&lt;/td&gt;&lt;/tr&gt;
        {{/each }}
    &lt;/tbody&gt;
&lt;/table&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.371.1">This template presents the table of products in the catalog to the user and incorporates the </span><code class="inlinecode"><span class="kobospan" id="kobo.372.1">area_buttons</span></code><span class="kobospan" id="kobo.373.1"> partial template. </span><span class="kobospan" id="kobo.373.2">The template receives a </span><code class="inlinecode"><span class="kobospan" id="kobo.374.1">product</span></code><span class="kobospan" id="kobo.375.1"> data property that is used to populate</span><a id="_idIndexMarker1086" class="calibre3"/><span class="kobospan" id="kobo.376.1"> the contents of a table, using the </span><code class="inlinecode"><span class="kobospan" id="kobo.377.1">each</span></code><span class="kobospan" id="kobo.378.1"> helper.</span></p>
<h2 class="heading1" id="_idParaDest-349"><span class="kobospan" id="kobo.379.1">Starting the web service routes</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.380.1">I like to get the basic template</span><a id="_idIndexMarker1087" class="calibre3"/><span class="kobospan" id="kobo.381.1"> features in place</span><a id="_idIndexMarker1088" class="calibre3"/><span class="kobospan" id="kobo.382.1"> and switch between the routes and data management as I work, returning to the templates to refine the data presentation as features fall into place. </span><span class="kobospan" id="kobo.382.2">To define the route that will provide the initial view of the catalog, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.383.1">admin_catalog_routes.ts</span></code><span class="kobospan" id="kobo.384.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.385.1">src/routes/admin</span></code><span class="kobospan" id="kobo.386.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.387.1">Listing 20.16</span></em><span class="kobospan" id="kobo.388.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.389.1">Listing 20.16: The contents of the admin_catalog_routes.ts file in the src/routes/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.390.1">import { Router } from "express";
import { CategoryModel, ProductModel, SupplierModel }
    from "../../data/orm/models";
   
export const createAdminCatalogRoutes = (router: Router) =&gt; {
    router.get("/table", async (req, resp) =&gt; {
        const products = await ProductModel.findAll({
                include: [
                    {model: SupplierModel, as: "supplier" },
                    {model: CategoryModel, as: "category" }],
                raw: true, nest: true
        });
        resp.render("admin/product_table", { products });
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.391.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.392.1">createAdminCatalogRoutes</span></code><span class="kobospan" id="kobo.393.1"> function receives a </span><code class="inlinecode"><span class="kobospan" id="kobo.394.1">Router</span></code><span class="kobospan" id="kobo.395.1"> object, which allows requests to be handled relative to a base URL that is defined elsewhere in the application. </span><span class="kobospan" id="kobo.395.2">There is one route that handles the </span><code class="inlinecode"><span class="kobospan" id="kobo.396.1">/table</span></code><span class="kobospan" id="kobo.397.1"> URL and responds by rendering the </span><code class="inlinecode"><span class="kobospan" id="kobo.398.1">admin/product_table</span></code><span class="kobospan" id="kobo.399.1"> template, which is provided by data read from the database.</span></p>
<p class="normal"><span class="kobospan" id="kobo.400.1">In earlier chapters, I accessed the database through the repository, which is my preferred way of isolating details of data access from the rest of the application. </span><span class="kobospan" id="kobo.400.2">Not everyone likes using a repository and the additional complexity it introduces, so for the administration features, I am going to access the database directly through the Sequelize model classes to demonstrate both techniques, showing that they can coexist in the same project. </span><span class="kobospan" id="kobo.400.3">To get the data for the template, the request handler queries for all </span><code class="inlinecode"><span class="kobospan" id="kobo.401.1">ProductModel</span></code><span class="kobospan" id="kobo.402.1"> objects and includes the associated </span><code class="inlinecode"><span class="kobospan" id="kobo.403.1">SupplierModel</span></code><span class="kobospan" id="kobo.404.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.405.1">CategoryModel</span></code><span class="kobospan" id="kobo.406.1"> objects. </span><span class="kobospan" id="kobo.406.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.407.1">raw</span></code><span class="kobospan" id="kobo.408.1"> property is used to prevent Sequelize from transforming the response, which is a useful option when the data</span><a id="_idIndexMarker1089" class="calibre3"/><span class="kobospan" id="kobo.409.1"> that is read from the database</span><a id="_idIndexMarker1090" class="calibre3"/><span class="kobospan" id="kobo.410.1"> can be used without modification.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.411.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.412.1">I still recommend using a repository because doing so ensures that data is accessed consistently, and it makes it easier to swap out the data access package. </span><span class="kobospan" id="kobo.412.2">If you do choose to work directly with the data access package in your project, remember that you will have to go through the initialization process. </span><span class="kobospan" id="kobo.412.3">For the </span><em class="italic"><span class="kobospan" id="kobo.413.1">SportsStore</span></em><span class="kobospan" id="kobo.414.1"> application, this is done in the </span><code class="inlinecode"><span class="kobospan" id="kobo.415.1">core.ts</span></code><span class="kobospan" id="kobo.416.1"> file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.417.1">src/data/orm</span></code><span class="kobospan" id="kobo.418.1"> folder.</span></p>
</div>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.419.1">Listing 20.17</span></em><span class="kobospan" id="kobo.420.1"> calls the </span><code class="inlinecode"><span class="kobospan" id="kobo.421.1">createAdminCatalogRoutes</span></code><span class="kobospan" id="kobo.422.1"> function when the application starts.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.423.1">Listing 20.17: Adding routes to the index.ts file in the src/routes/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext"><span class="kobospan" id="kobo.424.1">import { Express, Router } from "express"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.425.1">;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.426.1">import { createAdminCatalogRoutes } from "./admin_catalog_routes";</span></strong><span class="kobospan" id="kobo.427.1">
export const createAdminRoutes = (app: Express) =&gt; {
    app.use((req, resp, next) =&gt; {
        resp.locals.layout = false;
        next();
    })
   </span><strong class="screentext"><span class="kobospan" id="kobo.428.1"> const cat_router = Router();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.429.1">    createAdminCatalogRoutes(cat_router);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.430.1">    app.use("/api/products"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.431.1">, cat_router);</span></strong><span class="kobospan" id="kobo.432.1">
    app.get("/admin", (req, resp) =&gt; resp.render("admin/admin_layout"));
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.433.1">A new </span><code class="inlinecode"><span class="kobospan" id="kobo.434.1">Router</span></code><span class="kobospan" id="kobo.435.1"> object</span><a id="_idIndexMarker1091" class="calibre3"/><span class="kobospan" id="kobo.436.1"> is created and passed</span><a id="_idIndexMarker1092" class="calibre3"/><span class="kobospan" id="kobo.437.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.438.1">createAdminCatalogRoutes</span></code><span class="kobospan" id="kobo.439.1"> function so that the relative routes can be defined, and it is then added to the request pipeline with the </span><code class="inlinecode"><span class="kobospan" id="kobo.440.1">use</span></code><span class="kobospan" id="kobo.441.1"> method. </span><code class="inlinecode"><span class="kobospan" id="kobo.442.1">Router</span></code><span class="kobospan" id="kobo.443.1"> is a middleware component that tries to match requests with its routes; otherwise, it will pass on requests. </span><span class="kobospan" id="kobo.443.2">In this case, the </span><code class="inlinecode"><span class="kobospan" id="kobo.444.1">Router</span></code><span class="kobospan" id="kobo.445.1"> object passed to the </span><code class="inlinecode"><span class="kobospan" id="kobo.446.1">createAdminCatalogRoutes</span></code><span class="kobospan" id="kobo.447.1"> function is configured to try and match requests with the </span><code class="inlinecode"><span class="kobospan" id="kobo.448.1">/api/products</span></code><span class="kobospan" id="kobo.449.1"> path, using the routes defined in </span><em class="italic"><span class="kobospan" id="kobo.450.1">Listing 20.16</span></em><span class="kobospan" id="kobo.451.1">, which means that the </span><code class="inlinecode"><span class="kobospan" id="kobo.452.1">/api/products/table</span></code><span class="kobospan" id="kobo.453.1"> URL will be received by the handler defined in </span><em class="italic"><span class="kobospan" id="kobo.454.1">Listing 20.16</span></em><span class="kobospan" id="kobo.455.1">, responding with the rendered output from the </span><code class="inlinecode"><span class="kobospan" id="kobo.456.1">admin/product_table</span></code><span class="kobospan" id="kobo.457.1"> template.</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.458.1">Listing 20.18</span></em><span class="kobospan" id="kobo.459.1"> updates the top-level template so that </span><code class="inlinecode"><span class="kobospan" id="kobo.460.1">HTMX</span></code><span class="kobospan" id="kobo.461.1"> will send a request that will be processed by the handler defined in </span><em class="italic"><span class="kobospan" id="kobo.462.1">Listing 20.16</span></em><span class="kobospan" id="kobo.463.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.464.1">Listing 20.18: Loading data into the admin_layout.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.465.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;link href="/css/bootstrap.min.css" rel="stylesheet" /&gt;
        &lt;link href="/font/bootstrap-icons.min.css" rel="stylesheet"&gt;
        {{#if (isDevelopment) }}
            &lt;script src="/admin/bundle.js"&gt;&lt;/script&gt;
        {{/if }}
        &lt;script src="/htmx.min.js"&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="container-fluid"&gt;
            &lt;div class="row bg-info text-white py-2 px-1"&gt;
                &lt;div class="col align-baseline pt-1"&gt;SPORTS STORE ADMIN&lt;/div&gt;
                &lt;div class="col-auto text-end"&gt;&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class="row p-2"&gt;
                &lt;div class="col-2" id="area_buttons"&gt;&lt;/div&gt;
               </span><strong class="screentext"><span class="kobospan" id="kobo.466.1"> &lt;div class="col" id="</span></strong><strong class="screentext"><span class="kobospan" id="kobo.467.1">content" hx-get="/api/products/table"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.468.1">                    hx-trigger="load"&gt;&lt;/div&gt;</span></strong><span class="kobospan" id="kobo.469.1">
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.470.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.471.1">hx-get</span></code><span class="kobospan" id="kobo.472.1"> attribute tells </span><code class="inlinecode"><span class="kobospan" id="kobo.473.1">HTMX</span></code><span class="kobospan" id="kobo.474.1"> to request the </span><code class="inlinecode"><span class="kobospan" id="kobo.475.1">/api/product/table</span></code><span class="kobospan" id="kobo.476.1"> URL. </span><span class="kobospan" id="kobo.476.2">By default, requests are sent when the user interacts with an element, but the </span><code class="inlinecode"><span class="kobospan" id="kobo.477.1">hx-trigger</span></code><span class="kobospan" id="kobo.478.1"> attribute overrides this behavior and tells </span><code class="inlinecode"><span class="kobospan" id="kobo.479.1">HTMX</span></code><span class="kobospan" id="kobo.480.1"> to send the HTTP request when the element</span><a id="_idIndexMarker1093" class="calibre3"/><span class="kobospan" id="kobo.481.1"> is loaded. </span><span class="kobospan" id="kobo.481.2">Use a browser</span><a id="_idIndexMarker1094" class="calibre3"/><span class="kobospan" id="kobo.482.1"> to request </span><code class="inlinecode"><span class="kobospan" id="kobo.483.1">http://localhost:5000/admin</span></code><span class="kobospan" id="kobo.484.1">, and you will see the content shown in </span><em class="italic"><span class="kobospan" id="kobo.485.1">Figure 20.3</span></em><span class="kobospan" id="kobo.486.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.487.1"><img alt="" src="../Images/B21959_20_03.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.488.1">Figure 20.3: Starting the development of the administration features</span></p>
<p class="normal"><span class="kobospan" id="kobo.489.1">Before moving on, it is worth recapping the process that produces the content shown in the figure:</span></p>
<ol class="calibre6">
<li class="bulletlist1" value="1"><span class="kobospan" id="kobo.490.1">The user requests </span><code class="inlinecode"><span class="kobospan" id="kobo.491.1">http://localhost:5000/admin</span></code><span class="kobospan" id="kobo.492.1">.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.493.1">The request is handled by rendering the </span><code class="inlinecode"><span class="kobospan" id="kobo.494.1">admin_layout</span></code><span class="kobospan" id="kobo.495.1"> template, which contains an element whose attributes tell </span><code class="inlinecode"><span class="kobospan" id="kobo.496.1">HTMX</span></code><span class="kobospan" id="kobo.497.1"> to send an HTTP request to </span><code class="inlinecode"><span class="kobospan" id="kobo.498.1">http://localhost:5000/api/products/table</span></code><span class="kobospan" id="kobo.499.1"> once the HTML content has been loaded.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.500.1">The second request is handled by rendering the </span><code class="inlinecode"><span class="kobospan" id="kobo.501.1">product_table</span></code><span class="kobospan" id="kobo.502.1"> template, and the content that is produced is used as the contents of the element that triggered the HTTP request, except for the content in the </span><code class="inlinecode"><span class="kobospan" id="kobo.503.1">area_buttons</span></code><span class="kobospan" id="kobo.504.1"> partial template, which is used to replace the contents of the element with the same name.</span></li>
</ol>
<p class="normal"><span class="kobospan" id="kobo.505.1">This initial presentation</span><a id="_idIndexMarker1095" class="calibre3"/><span class="kobospan" id="kobo.506.1"> of content may seem like the existing</span><a id="_idIndexMarker1096" class="calibre3"/><span class="kobospan" id="kobo.507.1"> round-trip functionality, but the key difference is that some of the content was obtained using the web service, whose importance will become more obvious as features are added.</span></p>
<h2 class="heading1" id="_idParaDest-350"><span class="kobospan" id="kobo.508.1">Displaying product data and deleting products</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.509.1">Now that the basic structure</span><a id="_idIndexMarker1097" class="calibre3"/><span class="kobospan" id="kobo.510.1"> is in place, I am going</span><a id="_idIndexMarker1098" class="calibre3"/><span class="kobospan" id="kobo.511.1"> to pick up the pace and build out the rest of the product management features, pausing periodically to check that everything works as it should. </span><span class="kobospan" id="kobo.511.2">To display the product details correctly, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.512.1">product_row.handlebars</span></code><span class="kobospan" id="kobo.513.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.514.1">templates/admin</span></code><span class="kobospan" id="kobo.515.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.516.1">Listing 20.19</span></em><span class="kobospan" id="kobo.517.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.518.1">Listing 20.19: The contents of the product_row.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.519.1">&lt;tr id="row{{ id }}"&gt;
    &lt;td&gt;{{ id }}&lt;/td&gt;
    &lt;td&gt;{{ name }}&lt;/td&gt;
    &lt;td&gt;{{ category.name }}&lt;/td&gt;
    &lt;td&gt;{{ supplier.name }}&lt;/td&gt;
    &lt;td class="text-end"&gt;{{ currency price}}&lt;/td&gt;
    &lt;td class="ps-3"&gt;       
        &lt;button class="btn btn-sm btn-warning"
            hx-get="/api/products/edit/{{id}}" hx-target="#content"&gt;
                Edit
            &lt;/button&gt;
        &lt;button class="btn btn-sm btn-danger"
            hx-delete="/api/products/{{id}}" hx-target="#row{{id}}"
                    hx-swap="delete"&gt;
                Delete
        &lt;/button&gt;           
    &lt;/td&gt;
&lt;/tr&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.520.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.521.1">button</span></code><span class="kobospan" id="kobo.522.1"> elements will allow the user to edit or delete products. </span><span class="kobospan" id="kobo.522.2">The </span><strong class="screentext"><span class="kobospan" id="kobo.523.1">Edit</span></strong> <code class="inlinecode"><span class="kobospan" id="kobo.524.1">button</span></code><span class="kobospan" id="kobo.525.1"> element has an </span><code class="inlinecode"><span class="kobospan" id="kobo.526.1">hx-get</span></code><span class="kobospan" id="kobo.527.1"> attribute that sends a request when the button is clicked, including the </span><code class="inlinecode"><span class="kobospan" id="kobo.528.1">id</span></code><span class="kobospan" id="kobo.529.1"> value in the requested URL, so that clicking on the </span><strong class="screentext"><span class="kobospan" id="kobo.530.1">Edit</span></strong><span class="kobospan" id="kobo.531.1"> button for the product with </span><code class="inlinecode"><span class="kobospan" id="kobo.532.1">ID</span></code><span class="kobospan" id="kobo.533.1"> 2, for example, will send an HTTP request to </span><code class="inlinecode"><span class="kobospan" id="kobo.534.1">/api/products/edit/2</span></code><span class="kobospan" id="kobo.535.1">.</span></p>
<p class="normal"><span class="kobospan" id="kobo.536.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.537.1">Delete</span></code><span class="kobospan" id="kobo.538.1"> button element</span><a id="_idIndexMarker1099" class="calibre3"/><span class="kobospan" id="kobo.539.1"> has the </span><code class="inlinecode"><span class="kobospan" id="kobo.540.1">hx-delete</span></code><span class="kobospan" id="kobo.541.1"> attribute, which tells </span><code class="inlinecode"><span class="kobospan" id="kobo.542.1">HTMX</span></code><span class="kobospan" id="kobo.543.1"> to send</span><a id="_idIndexMarker1100" class="calibre3"/><span class="kobospan" id="kobo.544.1"> an HTTP </span><code class="inlinecode"><span class="kobospan" id="kobo.545.1">DELETE</span></code><span class="kobospan" id="kobo.546.1"> request when the button is clicked. </span><span class="kobospan" id="kobo.546.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.547.1">hx-swap</span></code><span class="kobospan" id="kobo.548.1"> attribute is set to </span><code class="inlinecode"><span class="kobospan" id="kobo.549.1">delete</span></code><span class="kobospan" id="kobo.550.1">, which tells </span><code class="inlinecode"><span class="kobospan" id="kobo.551.1">HTMX</span></code><span class="kobospan" id="kobo.552.1"> to remove the element specified by the </span><code class="inlinecode"><span class="kobospan" id="kobo.553.1">hx-target</span></code><span class="kobospan" id="kobo.554.1"> attribute. </span><span class="kobospan" id="kobo.554.2">The effect is that the table row for the product will be removed when the </span><strong class="screentext"><span class="kobospan" id="kobo.555.1">Delete</span></strong><span class="kobospan" id="kobo.556.1"> button is clicked, and the server confirms that the product has been removed from the database.</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.557.1">Listing 20.20</span></em><span class="kobospan" id="kobo.558.1"> applies the new template to format the product data.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.559.1">Listing 20.20: Applying a template to the product_table.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.560.1">{{&gt; admin/area_buttons mode="products"}}
&lt;table class="table table-sm"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Name&lt;/th&gt;
            &lt;th&gt;Category&lt;/th&gt;&lt;th&gt;Supplier&lt;/th&gt;
            &lt;th class="text-end"&gt;Price&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        {{#each products }}   
           </span><strong class="screentext"><span class="kobospan" id="kobo.561.1"> {{&gt; admin/product_row }}</span></strong><span class="kobospan" id="kobo.562.1">
        {{/each }}
    &lt;/tbody&gt;
&lt;/table&gt;
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.563.1">Listing 20.21</span></em><span class="kobospan" id="kobo.564.1"> adds a route that handles </span><code class="inlinecode"><span class="kobospan" id="kobo.565.1">DELETE</span></code><span class="kobospan" id="kobo.566.1"> requests, receiving the ID of the product to delete it as a URL parameter.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.567.1">Listing 20.21: Adding a route to the admin_catalog_routes.ts file in the src/routes/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.568.1">import { Router } from "express";
import { CategoryModel, ProductModel, SupplierModel }
    from "../../data/orm/models";
export const createAdminCatalogRoutes = (router: Router) =&gt; {
    router.get("/table", async (req, resp) =&gt; {
        const products = await ProductModel.findAll({
                include: [
                    {model: SupplierModel, as: "supplier" },
                    {model: CategoryModel, as: "category" }],
                raw: true, nest: true
        });
        resp.render("admin/product_table", { products });
    });
   </span><strong class="screentext"><span class="kobospan" id="kobo.569.1"> router.delete("/:id", async (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.570.1">        const</span></strong><strong class="screentext"><span class="kobospan" id="kobo.571.1"> id = req.params.id;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.572.1">        const count = await ProductModel.destroy({ where: { id }});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.573.1">        if (count == 1) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.574.1">            resp.end</span></strong><strong class="screentext"><span class="kobospan" id="kobo.575.1">();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.576.1">        } else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.577.1">            throw Error(`Unexpected deletion count result: ${count}`)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.578.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.579.1">    });</span></strong><span class="kobospan" id="kobo.580.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.581.1">Request </span><code class="inlinecode"><span class="kobospan" id="kobo.582.1">http://localhost:5000/admin</span></code><span class="kobospan" id="kobo.583.1">, and you will see a more detailed</span><a id="_idIndexMarker1101" class="calibre3"/><span class="kobospan" id="kobo.584.1"> presentation of the product</span><a id="_idIndexMarker1102" class="calibre3"/><span class="kobospan" id="kobo.585.1"> data. </span><span class="kobospan" id="kobo.585.2">Clicking the </span><strong class="screentext"><span class="kobospan" id="kobo.586.1">Delete</span></strong><span class="kobospan" id="kobo.587.1"> button removes a product from the database, as shown in </span><em class="italic"><span class="kobospan" id="kobo.588.1">Figure 20.4</span></em><span class="kobospan" id="kobo.589.1">. </span><span class="kobospan" id="kobo.589.2">(The application is configured to reset the database, which means that the deleted products will be restored the next time you change one of the project files.)</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.590.1"><img alt="" src="../Images/B21959_20_04.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.591.1">Figure 20.4: Product details and deleting a product</span></p>
<h2 class="heading1" id="_idParaDest-351"><span class="kobospan" id="kobo.592.1">Editing products</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.593.1">The </span><strong class="screentext"><span class="kobospan" id="kobo.594.1">Edit</span></strong><span class="kobospan" id="kobo.595.1"> feature will present</span><a id="_idIndexMarker1103" class="calibre3"/><span class="kobospan" id="kobo.596.1"> the user with an HTML form that is populated with the details of a product, presenting validation messages when the form is submitted with unusual values. </span><span class="kobospan" id="kobo.596.2">I am going to build up the form using a series of smaller, more manageable templates, which will be combined to produce an HTML response and ensure that each data property is handled consistently. </span><span class="kobospan" id="kobo.596.3">Starting with a template to display validation messages, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.597.1">validation_messages.handlebars</span></code><span class="kobospan" id="kobo.598.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.599.1">templates/admin</span></code><span class="kobospan" id="kobo.600.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.601.1">Listing 20.22</span></em><span class="kobospan" id="kobo.602.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.603.1">Listing 20.22: The contents of the validation_messages.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.604.1">{{#if invalid }}
    {{#each messages }}
        &lt;div class="text-danger"&gt;{{ this }}&lt;/div&gt;
    {{/each }}
{{/if }}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.605.1">I am going to use the existing validation features, which means that the </span><code class="inlinecode"><span class="kobospan" id="kobo.606.1">invalid</span></code><span class="kobospan" id="kobo.607.1"> property will be </span><code class="inlinecode"><span class="kobospan" id="kobo.608.1">true</span></code><span class="kobospan" id="kobo.609.1"> when there is a validation issue and the </span><code class="inlinecode"><span class="kobospan" id="kobo.610.1">messages</span></code><span class="kobospan" id="kobo.611.1"> property contains the content to be displayed to the user.</span></p>
<p class="normal"><span class="kobospan" id="kobo.612.1">Some of the product details will be displayed using </span><code class="inlinecode"><span class="kobospan" id="kobo.613.1">input</span></code><span class="kobospan" id="kobo.614.1"> elements, allowing the user to freely enter a value. </span><span class="kobospan" id="kobo.614.2">To create a template for </span><code class="inlinecode"><span class="kobospan" id="kobo.615.1">input</span></code><span class="kobospan" id="kobo.616.1"> elements, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.617.1">product_input.handlebars</span></code><span class="kobospan" id="kobo.618.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.619.1">templates/admin</span></code><span class="kobospan" id="kobo.620.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.621.1">Listing 20.23</span></em><span class="kobospan" id="kobo.622.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.623.1">Listing 20.23: The contents of the product_input.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.624.1">&lt;div class="mb-2"&gt;
    &lt;label&gt;{{label}}&lt;/label&gt;
    &lt;input {{ disabled label }} name="{{ name }}" class="form-control"
        value="{{ data.value }}" /&gt;
    {{&gt; admin/validation_messages data }}
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.625.1">The template creates </span><code class="inlinecode"><span class="kobospan" id="kobo.626.1">label</span></code><span class="kobospan" id="kobo.627.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.628.1">input</span></code><span class="kobospan" id="kobo.629.1"> elements, formatted</span><a id="_idIndexMarker1104" class="calibre3"/><span class="kobospan" id="kobo.630.1"> using the Bootstrap CSS styles, and incorporates the </span><code class="inlinecode"><span class="kobospan" id="kobo.631.1">validation messages</span></code><span class="kobospan" id="kobo.632.1"> template. </span><span class="kobospan" id="kobo.632.2">To simplify data management, users won’t be allowed to change the </span><code class="inlinecode"><span class="kobospan" id="kobo.633.1">ID</span></code><span class="kobospan" id="kobo.634.1"> property of a product, and so a </span><code class="inlinecode"><span class="kobospan" id="kobo.635.1">disabled</span></code><span class="kobospan" id="kobo.636.1"> helper is used to add the </span><code class="inlinecode"><span class="kobospan" id="kobo.637.1">disabled</span></code><span class="kobospan" id="kobo.638.1"> attribute to the </span><code class="inlinecode"><span class="kobospan" id="kobo.639.1">input</span></code><span class="kobospan" id="kobo.640.1"> element when that element is used for the </span><code class="inlinecode"><span class="kobospan" id="kobo.641.1">ID</span></code><span class="kobospan" id="kobo.642.1"> property, as shown in </span><em class="italic"><span class="kobospan" id="kobo.643.1">Listing 20.24</span></em><span class="kobospan" id="kobo.644.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.645.1">Listing 20.24: Adding a helper to the admin_helpers.ts file in the src/helpers folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.646.1">export const buttonClass = (btn: string, mode: string) =&gt;
    btn == mode ? </span><span class="kobospan" id="kobo.646.2">"btn-secondary" : "btn-outline-secondary";
</span><strong class="screentext"><span class="kobospan" id="kobo.647.1">export const disabled = (val: any) =&gt; val == "ID"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.648.1"> ? </span><span class="kobospan" id="kobo.648.2">"disabled" : "";</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.649.1">Some product properties will be edited by picking from a list of values. </span><span class="kobospan" id="kobo.649.2">To create a template that will produce a </span><code class="inlinecode"><span class="kobospan" id="kobo.650.1">select</span></code><span class="kobospan" id="kobo.651.1"> element, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.652.1">product_select.handlebars</span></code><span class="kobospan" id="kobo.653.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.654.1">templates/admin</span></code><span class="kobospan" id="kobo.655.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.656.1">Listing 20.25</span></em><span class="kobospan" id="kobo.657.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.658.1">Listing 20.25: The contents of the product_select.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.659.1">&lt;div class="mb-2"&gt;
    &lt;label&gt;{{ label }}&lt;/label&gt;
    &lt;select name="{{name}}" class="form-select " &gt;
        &lt;option value="" disabled selected&gt;Choose Category&lt;/option&gt;
        {{#each list }}
            &lt;option {{ selected id ../data.value }}
                value="{{id}}"&gt;{{ name }}
            &lt;/option&gt;
        {{/each}}
    &lt;/select&gt;
    {{&gt; admin/validation_messages data }}
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.660.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.661.1">select</span></code><span class="kobospan" id="kobo.662.1"> element is populated with a set of </span><code class="inlinecode"><span class="kobospan" id="kobo.663.1">option</span></code><span class="kobospan" id="kobo.664.1"> elements from which the user can choose, along with a fallback element that will be useful later when adding support to create new products. </span><span class="kobospan" id="kobo.664.2">A helper is required to determine whether an </span><code class="inlinecode"><span class="kobospan" id="kobo.665.1">option</span></code><span class="kobospan" id="kobo.666.1"> element is decorated with the </span><code class="inlinecode"><span class="kobospan" id="kobo.667.1">selected</span></code><span class="kobospan" id="kobo.668.1"> attribute, as shown in </span><em class="italic"><span class="kobospan" id="kobo.669.1">Listing 20.26</span></em><span class="kobospan" id="kobo.670.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.671.1">Listing 20.26: Adding a helper to the admin_helpers.ts file in the src/helpers folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.672.1">export const buttonClass = (btn: string, mode: string) =&gt;
    btn == mode ? </span><span class="kobospan" id="kobo.672.2">"btn-secondary" : "btn-outline-secondary";
export const disabled = (val: any) =&gt; val == "ID" ? </span><span class="kobospan" id="kobo.672.3">"disabled" : "";
</span><strong class="screentext"><span class="kobospan" id="kobo.673.1">export const selected = (val1: any, val2: any) =&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.674.1">    val1 == val2 ? </span><span class="kobospan" id="kobo.674.2">"selected" : "";</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.675.1">To create the template</span><a id="_idIndexMarker1105" class="calibre3"/><span class="kobospan" id="kobo.676.1"> that combines the </span><code class="inlinecode"><span class="kobospan" id="kobo.677.1">input</span></code><span class="kobospan" id="kobo.678.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.679.1">select</span></code><span class="kobospan" id="kobo.680.1"> elements to present the user with a complete HTML form, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.681.1">product_editor.handlebars</span></code><span class="kobospan" id="kobo.682.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.683.1">templates/admin</span></code><span class="kobospan" id="kobo.684.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.685.1">Listing 20.27</span></em><span class="kobospan" id="kobo.686.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.687.1">Listing 20.27: The contents of the product_editor.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.688.1">{{&gt; admin/area_buttons mode="products"}}
&lt;form hx-put="/api/products/{{product.id.value}}"&gt;
    {{&gt; admin/product_input label="ID" name="id" data=product.id }}
    {{&gt; admin/product_input label="Name" name="name" data=product.name }}
    &lt;div class="mb-2"&gt;
        &lt;label&gt;Description&lt;/label&gt;
        &lt;textarea name="description"
            class="form-control"&gt;{{ product.description.value }}&lt;/textarea&gt;
        {{&gt; admin/validation_messages product.description }}           
    &lt;/div&gt;
    {{&gt; admin/product_select label="Category" name="categoryId"
            data=product.categoryId list=categories}}
    {{&gt; admin/product_select label="Supplier" name="supplierId"
            data=product.supplierId list=suppliers}}
    {{&gt; admin/product_input label="Price" name="price" data=product.price }}
    &lt;div&gt;
        &lt;button type="submit" class="btn btn-secondary text-white"&gt;Save&lt;/button&gt;
        &lt;button class="btn btn-outline-secondary"
            hx-get="/api/products/table" hx-target="#content"&gt;Cancel&lt;/button&gt;
    &lt;/div&gt;
&lt;/form&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.689.1">This template contains a </span><code class="inlinecode"><span class="kobospan" id="kobo.690.1">form</span></code><span class="kobospan" id="kobo.691.1"> element that is decorated with the </span><code class="inlinecode"><span class="kobospan" id="kobo.692.1">hx-put</span></code><span class="kobospan" id="kobo.693.1"> attribute, which tells </span><code class="inlinecode"><span class="kobospan" id="kobo.694.1">HTMX</span></code><span class="kobospan" id="kobo.695.1"> to submit the form using an HTTP </span><code class="inlinecode"><span class="kobospan" id="kobo.696.1">PUT</span></code><span class="kobospan" id="kobo.697.1"> request to a URL that combines </span><code class="inlinecode"><span class="kobospan" id="kobo.698.1">/api/products</span></code><span class="kobospan" id="kobo.699.1"> with the product </span><code class="inlinecode"><span class="kobospan" id="kobo.700.1">ID</span></code><span class="kobospan" id="kobo.701.1"> (such as </span><code class="inlinecode"><span class="kobospan" id="kobo.702.1">/api/products/1</span></code><span class="kobospan" id="kobo.703.1"> for the product whose </span><code class="inlinecode"><span class="kobospan" id="kobo.704.1">ID</span></code><span class="kobospan" id="kobo.705.1"> value is </span><code class="inlinecode"><span class="kobospan" id="kobo.706.1">1</span></code><span class="kobospan" id="kobo.707.1">).</span></p>
<p class="normal"><span class="kobospan" id="kobo.708.1">The contents of the form are created using the templates for </span><code class="inlinecode"><span class="kobospan" id="kobo.709.1">input</span></code><span class="kobospan" id="kobo.710.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.711.1">select</span></code><span class="kobospan" id="kobo.712.1"> elements, along with a </span><code class="inlinecode"><span class="kobospan" id="kobo.713.1">textarea</span></code><span class="kobospan" id="kobo.714.1"> element that will allow the user to enter multiple lines of text for the description. </span><span class="kobospan" id="kobo.714.2">There is also a button that will trigger the </span><code class="inlinecode"><span class="kobospan" id="kobo.715.1">PUT</span></code><span class="kobospan" id="kobo.716.1"> request, as well as a </span><code class="inlinecode"><span class="kobospan" id="kobo.717.1">Cancel</span></code><span class="kobospan" id="kobo.718.1"> button that instructs </span><code class="inlinecode"><span class="kobospan" id="kobo.719.1">HTMX</span></code><span class="kobospan" id="kobo.720.1"> to send a </span><code class="inlinecode"><span class="kobospan" id="kobo.721.1">get</span></code><span class="kobospan" id="kobo.722.1"> request to </span><code class="inlinecode"><span class="kobospan" id="kobo.723.1">/api/products/table</span></code><span class="kobospan" id="kobo.724.1"> and display</span><a id="_idIndexMarker1106" class="calibre3"/><span class="kobospan" id="kobo.725.1"> the results in the </span><code class="inlinecode"><span class="kobospan" id="kobo.726.1">content</span></code><span class="kobospan" id="kobo.727.1"> element.</span></p>
<h3 class="heading2" id="_idParaDest-352"><span class="kobospan" id="kobo.728.1">Adding product data validation</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.729.1">The data that is received</span><a id="_idIndexMarker1107" class="calibre3"/><span class="kobospan" id="kobo.730.1"> from the product editing form must be validated before it is stored in the database. </span><span class="kobospan" id="kobo.730.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.731.1">product_dto_rules.ts</span></code><span class="kobospan" id="kobo.732.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.733.1">src/data/validation</span></code><span class="kobospan" id="kobo.734.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.735.1">Listing 20.28</span></em><span class="kobospan" id="kobo.736.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.737.1">Listing 20.28: The contents of the product_dto_rules.ts file in the src/data/validation folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.738.1">import { Validator } from "./validator";
import { required, minLength } from "./basic_rules";
import { ValidationStatus } from ".";
import { CategoryModel, SupplierModel } from "../orm/models";
type ProductDTO = {
    name: string, description: string, categoryId: number,
    supplierId: number, price: number
}
const supplierExists = async (status: ValidationStatus) =&gt; {
    const count = await SupplierModel.count({ where: { id: status.value } });
    if (count !== 1) {
        status.setInvalid(true);
        status.messages.push("A valid supplier is required");       
    }
}
const categoryExists = async (status: ValidationStatus) =&gt; {
    const count = await CategoryModel.count({ where: { id: status.value } });
    if (count !== 1) {
        status.setInvalid(true);
        status.messages.push("A valid category is required");       
    }
}
export const ProductDTOValidator = new Validator&lt;ProductDTO&gt;({   
    name: [required, minLength(3)],
    description: required,
    categoryId : categoryExists,
    supplierId: supplierExists,
    price: required,
});
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.739.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.740.1">ProductDTO</span></code><span class="kobospan" id="kobo.741.1"> type represents</span><a id="_idIndexMarker1108" class="calibre3"/><span class="kobospan" id="kobo.742.1"> the data that will be received when the user edits</span><a id="_idIndexMarker1109" class="calibre3"/><span class="kobospan" id="kobo.743.1"> a product and submits the form (the term </span><strong class="screentext"><span class="kobospan" id="kobo.744.1">DTO</span></strong><span class="kobospan" id="kobo.745.1"> means </span><strong class="screentext"><span class="kobospan" id="kobo.746.1">data transfer object</span></strong><span class="kobospan" id="kobo.747.1"> and is used to describe types that represent data when it is transferred). </span><span class="kobospan" id="kobo.747.2">The validation rules for the </span><code class="inlinecode"><span class="kobospan" id="kobo.748.1">ProductDTO</span></code><span class="kobospan" id="kobo.749.1"> type are exported as a constant, named </span><code class="inlinecode"><span class="kobospan" id="kobo.750.1">ProductDTOValidator</span></code><span class="kobospan" id="kobo.751.1">. </span><span class="kobospan" id="kobo.751.2">Two custom rules are required to ensure that a value corresponds to an existing supplier or category in the database. </span><em class="italic"><span class="kobospan" id="kobo.752.1">Listing 20.29</span></em><span class="kobospan" id="kobo.753.1"> incorporates the new validator.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.754.1">Listing 20.29: Adding a validator to the index.ts file in the src/data/validation folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.755.1">export * from "./validation_types";
export * from "./validator";
export * from "./basic_rules";
export * from "./order_rules";
</span><strong class="screentext"><span class="kobospan" id="kobo.756.1">export * from "./product_dto_rules";</span></strong>
</code></pre>
<h3 class="heading2" id="_idParaDest-353"><span class="kobospan" id="kobo.757.1">Adding the routes for editing</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.758.1">Two new routes are required</span><a id="_idIndexMarker1110" class="calibre3"/><span class="kobospan" id="kobo.759.1"> to support editing: the first route</span><a id="_idIndexMarker1111" class="calibre3"/><span class="kobospan" id="kobo.760.1"> receives an HTTP </span><code class="inlinecode"><span class="kobospan" id="kobo.761.1">GET</span></code><span class="kobospan" id="kobo.762.1"> request and responds with a populated HTML form. </span><span class="kobospan" id="kobo.762.2">The second route receives the HTTP </span><code class="inlinecode"><span class="kobospan" id="kobo.763.1">PUT</span></code><span class="kobospan" id="kobo.764.1"> request and is responsible for validating the data and storing it. </span><span class="kobospan" id="kobo.764.2">Both routes are defined in </span><em class="italic"><span class="kobospan" id="kobo.765.1">Listing 20.30</span></em><span class="kobospan" id="kobo.766.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.767.1">Listing 20.30: Adding editing routes to the admin_catalog_routes.ts file in the src/routes/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.768.1">import { Router } from "express";
import { CategoryModel, ProductModel, SupplierModel }
    from "../../data/orm/models";
</span><strong class="screentext"><span class="kobospan" id="kobo.769.1">import { ProductDTOValidator, getData, isValid } from "../../data/validation";</span></strong><span class="kobospan" id="kobo.770.1">
export const createAdminCatalogRoutes = (router: Router) =&gt; {
    // ...existing routes omitted for brevity...
    </span><strong class="screentext"><span class="kobospan" id="kobo.771.1">router.get("/edit/:id", async (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.772.1">        const id = req.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.773.1">params.id;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.774.1">        const data = {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.775.1">            product: { id: { value: id },</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.776.1">                ...await ProductDTOValidator.validate(</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.777.1">                await </span></strong><strong class="screentext"><span class="kobospan" id="kobo.778.1">ProductModel.findByPk(id, { raw: true}))},</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.779.1">            suppliers: await SupplierModel.findAll({raw: true}),</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.780.1">categories: await CategoryModel.findAll({raw: true})</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.781.1">        };</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.782.1">        resp.render("admin/product_editor", data);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.783.1">    });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.784.1">    router.put("/:id", </span></strong><strong class="screentext"><span class="kobospan" id="kobo.785.1">async (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.786.1">        const validation = await ProductDTOValidator.validate(req.body);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.787.1">        if (isValid(validation)) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.788.1">            await ProductModel.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.789.1">update(</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.790.1">                getData(validation), { where: { id: req.params.id}}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.791.1">            );</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.792.1">            resp.redirect(303, "/api/products/table");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.793.1">        } else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.794.1">            resp.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.795.1">render("admin/product_editor", {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.796.1">                product: { id: { value: req.params.id} , ...validation },</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.797.1">                suppliers: await SupplierModel.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.798.1">findAll({raw: true}),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.799.1">                categories: await CategoryModel.findAll({raw: true})</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.800.1">            })</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.801.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.802.1">    });   </span></strong><span class="kobospan" id="kobo.803.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.804.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.805.1">GET</span></code><span class="kobospan" id="kobo.806.1"> route receives the </span><code class="inlinecode"><span class="kobospan" id="kobo.807.1">ID</span></code><span class="kobospan" id="kobo.808.1"> of the product that the user wants to edit through the URL and queries the database to get the data, which is fed through the validator so that the same template can be used when editing starts and invalid data is received.</span></p>
<p class="normal"><span class="kobospan" id="kobo.809.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.810.1">PUT</span></code><span class="kobospan" id="kobo.811.1"> route receives</span><a id="_idIndexMarker1112" class="calibre3"/><span class="kobospan" id="kobo.812.1"> data that the user wants to store, with the </span><code class="inlinecode"><span class="kobospan" id="kobo.813.1">ID</span></code><span class="kobospan" id="kobo.814.1"> received</span><a id="_idIndexMarker1113" class="calibre3"/><span class="kobospan" id="kobo.815.1"> from the URL. </span><span class="kobospan" id="kobo.815.2">The data is validated, and if it is invalid, the </span><code class="inlinecode"><span class="kobospan" id="kobo.816.1">admin/product_editor</span></code><span class="kobospan" id="kobo.817.1"> template is rendered, which will display the validation messages to the user.</span></p>
<p class="normal"><span class="kobospan" id="kobo.818.1">If the data is valid, the database is updated and the browser is redirected, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.819.1">...
</span><span class="kobospan" id="kobo.819.2">resp.redirect(303, "/api/products/table");
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.820.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.821.1">303</span></code><span class="kobospan" id="kobo.822.1"> status code causes the browser to request the specified URL, using an HTTP </span><code class="inlinecode"><span class="kobospan" id="kobo.823.1">GET</span></code><span class="kobospan" id="kobo.824.1"> request, and effectively ends the editing session by displaying the product data, which will include the edited data.</span></p>
<p class="normal"><span class="kobospan" id="kobo.825.1">One problem with the </span><code class="inlinecode"><span class="kobospan" id="kobo.826.1">303</span></code><span class="kobospan" id="kobo.827.1"> redirection is that it will fail during development because the default security configuration applied by the Helmet package tells the browser to upgrade insecure requests. </span><span class="kobospan" id="kobo.827.2">This means that the </span><code class="inlinecode"><span class="kobospan" id="kobo.828.1">303</span></code><span class="kobospan" id="kobo.829.1"> redirection tells the browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.830.1">http://localhost:5000/api/products/table</span></code><span class="kobospan" id="kobo.831.1">; however, due to the security policy, the browser will make an HTTPS request instead. </span><em class="italic"><span class="kobospan" id="kobo.832.1">Listing 20.31</span></em><span class="kobospan" id="kobo.833.1"> adds a new section to the configuration file that will be used to configure the Helmet package.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.834.1">Listing 20.31: Adding a section to the server.config.json file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.835.1">{
    "http": {
        "port": 5000,
        </span><strong class="screentext"><span class="kobospan" id="kobo.836.1">"content_security": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.837.1">            "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.838.1">contentSecurityPolicy": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.839.1">                "directives": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.840.1">                    "upgradeInsecureRequests": null</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.841.1">                }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.842.1">            }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.843.1">        }</span></strong><span class="kobospan" id="kobo.844.1">
    },
    // ...other configuration sections omitted for brevity...
</span><span class="kobospan" id="kobo.844.2">}
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.845.1">Listing 20.32</span></em><span class="kobospan" id="kobo.846.1"> updates the application</span><a id="_idIndexMarker1114" class="calibre3"/><span class="kobospan" id="kobo.847.1"> configuration to disable insecure</span><a id="_idIndexMarker1115" class="calibre3"/><span class="kobospan" id="kobo.848.1"> upgrades when the application is in the development environment.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.849.1">Listing 20.32: Disabling insecure upgrades in the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.850.1">import { createServer } from "http";
import express, { Express } from "express";
import helmet from "helmet";
import { getConfig, getEnvironment, Env } from "./config";
import { createRoutes } from "./routes";
import { createTemplates } from "./helpers";
import { createErrorHandlers } from "./errors";
import { createSessions } from "./sessions";
import { createAuthentication } from "./authentication";
import httpProxy from "http-proxy";
const port = getConfig("http:port", 5000);
const expressApp: Express = express();
</span><strong class="screentext"><span class="kobospan" id="kobo.851.1">expressApp.use(helmet(</span></strong><strong class="screentext"><span class="kobospan" id="kobo.852.1">getConfig("http:content_security", {})));</span></strong><span class="kobospan" id="kobo.853.1">
expressApp.use(express.json());
expressApp.use(express.urlencoded({extended: true}))
expressApp.use(express.static("node_modules/bootstrap/dist"));
expressApp.use(express.static("node_modules/bootstrap-icons"));
expressApp.use(express.static("node_modules/htmx.org/dist"));
createTemplates(expressApp);
createSessions(expressApp);
createAuthentication(expressApp);
createRoutes(expressApp);
const server = createServer(expressApp);
if (getEnvironment() === Env.Development) {
    const proxy = httpProxy.createProxyServer({
        target: "http://localhost:5100", ws: true
    });   
    expressApp.use("/admin", (req, resp) =&gt; proxy.web(req, resp));
    server.on('upgrade', (req, socket, head) =&gt; proxy.ws(req, socket, head));
}
createErrorHandlers(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.854.1">Let the browser reload</span><a id="_idIndexMarker1116" class="calibre3"/><span class="kobospan" id="kobo.855.1"> automatically or navigate to </span><code class="inlinecode"><span class="kobospan" id="kobo.856.1">http://localhost:5000/admin</span></code><span class="kobospan" id="kobo.857.1">, and click </span><a id="_idIndexMarker1117" class="calibre3"/><span class="kobospan" id="kobo.858.1">the </span><strong class="screentext"><span class="kobospan" id="kobo.859.1">Edit</span></strong><span class="kobospan" id="kobo.860.1"> button for one of the products. </span><span class="kobospan" id="kobo.860.2">Clear the </span><strong class="screentext"><span class="kobospan" id="kobo.861.1">Name</span></strong><span class="kobospan" id="kobo.862.1"> field and click the </span><strong class="screentext"><span class="kobospan" id="kobo.863.1">Save</span></strong><span class="kobospan" id="kobo.864.1"> button to see a validation error. </span><span class="kobospan" id="kobo.864.2">Enter a new name and click the </span><strong class="screentext"><span class="kobospan" id="kobo.865.1">Save</span></strong><span class="kobospan" id="kobo.866.1"> button again, and you will see the modified data displayed in the overview table, as shown in </span><em class="italic"><span class="kobospan" id="kobo.867.1">Figure 20.5</span></em><span class="kobospan" id="kobo.868.1">.</span></p>
<p class="normal"><span class="kobospan" id="kobo.869.1">You may need to clear your browser cache for the change in the security policy to take effect. </span><span class="kobospan" id="kobo.869.2">Some browsers, including Chrome, will keep trying to upgrade to HTTPS connections until the cache is cleared.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.870.1"><img alt="" src="../Images/B21959_20_05.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.871.1">Figure 20.5: Validating and editing data</span></p>
<p class="normal"><span class="kobospan" id="kobo.872.1">Bear in mind that the application</span><a id="_idIndexMarker1118" class="calibre3"/><span class="kobospan" id="kobo.873.1"> is configured to reset the database</span><a id="_idIndexMarker1119" class="calibre3"/><span class="kobospan" id="kobo.874.1"> every time there is a change, which means that the changes you make will be lost as soon as a file change is detected.</span></p>
<h3 class="heading2" id="_idParaDest-354"><span class="kobospan" id="kobo.875.1">Creating new products</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.876.1">The final feature</span><a id="_idIndexMarker1120" class="calibre3"/><span class="kobospan" id="kobo.877.1"> is to create new products. </span><em class="italic"><span class="kobospan" id="kobo.878.1">Listing 20.33</span></em><span class="kobospan" id="kobo.879.1"> adds a new </span><code class="inlinecode"><span class="kobospan" id="kobo.880.1">button</span></code><span class="kobospan" id="kobo.881.1"> element that will send an </span><code class="inlinecode"><span class="kobospan" id="kobo.882.1">HTTP</span></code> <code class="inlinecode"><span class="kobospan" id="kobo.883.1">GET</span></code><span class="kobospan" id="kobo.884.1"> request to start the editing process. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.885.1">Listing 20.33: Adding an element to the product_table.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.886.1">{{&gt; admin/area_buttons mode="products"}}
&lt;table class="table table-sm"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Name&lt;/th&gt;
            &lt;th&gt;Category&lt;/th&gt;&lt;th&gt;Supplier&lt;/th&gt;
            &lt;th class="text-end"&gt;Price&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        {{#each products }}   
            {{&gt; admin/product_row }}
        {{/each }}
    &lt;/tbody&gt;
&lt;/table&gt;
</span><strong class="screentext"><span class="kobospan" id="kobo.887.1">&lt;button class="btn btn-secondary" hx-get="/api/products/create"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.888.1">        hx-target="#content"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.889.1">    Create</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.890.1">&lt;/button&gt;</span></strong>
</code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.891.1">Listing 20.34</span></em><span class="kobospan" id="kobo.892.1"> updates the editor template</span><a id="_idIndexMarker1121" class="calibre3"/><span class="kobospan" id="kobo.893.1"> so that a different </span><code class="inlinecode"><span class="kobospan" id="kobo.894.1">form</span></code><span class="kobospan" id="kobo.895.1"> element is included in the HTML output, based on the value of a property named </span><code class="inlinecode"><span class="kobospan" id="kobo.896.1">create</span></code><span class="kobospan" id="kobo.897.1">, so </span><code class="inlinecode"><span class="kobospan" id="kobo.898.1">POST</span></code><span class="kobospan" id="kobo.899.1"> requests are used when creating new products while </span><code class="inlinecode"><span class="kobospan" id="kobo.900.1">PUT</span></code><span class="kobospan" id="kobo.901.1"> requests are used to modify existing data.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.902.1">Listing 20.34: Changing the form in the product_editor.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.903.1">{{&gt; admin/area_buttons mode="products"}}
</span><strong class="screentext"><span class="kobospan" id="kobo.904.1">{{#if create}}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.905.1">&lt;form hx-post="/api/products/create"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.906.1">{{else}}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.907.1">&lt;form hx-put="/api/products/{{product.id.value}}"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.908.1">{{/if}}</span></strong><span class="kobospan" id="kobo.909.1">
    {{&gt; admin/product_input label="ID" name="id" data=product.id }}
    {{&gt; admin/product_input label="Name" name="name" data=product.name }}
    &lt;div class="mb-2"&gt;
        &lt;label&gt;Description&lt;/label&gt;
        &lt;textarea name="description"
            class="form-control"&gt;{{ product.description.value }}&lt;/textarea&gt;
        {{&gt; admin/validation_messages product.description }}           
    &lt;/div&gt;
    {{&gt; admin/product_select label="Category" name="categoryId"
            data=product.categoryId list=categories}}
    {{&gt; admin/product_select label="Supplier" name="supplierId"
            data=product.supplierId list=suppliers}}
    {{&gt; admin/product_input label="Price" name="price" data=product.price }}
    &lt;div&gt;
        &lt;button type="submit" class="btn btn-secondary text-white"&gt;Save&lt;/button&gt;
        &lt;button class="btn btn-outline-secondary"
            hx-get="/api/products/table" hx-target="#content"&gt;Cancel&lt;/button&gt;
    &lt;/div&gt;
&lt;/form&gt;
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.910.1">Listing 20.35</span></em><span class="kobospan" id="kobo.911.1"> adds two new routes, which handle</span><a id="_idIndexMarker1122" class="calibre3"/><span class="kobospan" id="kobo.912.1"> the </span><code class="inlinecode"><span class="kobospan" id="kobo.913.1">GET</span></code><span class="kobospan" id="kobo.914.1"> request that starts the creation process and the </span><code class="inlinecode"><span class="kobospan" id="kobo.915.1">POST</span></code><span class="kobospan" id="kobo.916.1"> request that is sent when the user submits the form.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.917.1">Listing 20.35: Adding routes to the admin_catalog_routes.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.918.1">import { Router } from "express";
import { CategoryModel, ProductModel, SupplierModel }
    from "../../data/orm/models";
import { ProductDTOValidator, getData, isValid } from "../../data/validation";
export const createAdminCatalogRoutes = (router: Router) =&gt; {
    // ...other routes omitted for brevity...
    </span><strong class="screentext"><span class="kobospan" id="kobo.919.1">router.get("/create", async (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.920.1">        const data = {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.921.1">            product: {},</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.922.1">            suppliers: await </span></strong><strong class="screentext"><span class="kobospan" id="kobo.923.1">SupplierModel.findAll({raw: true}),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.924.1">            categories: await CategoryModel.findAll({raw: true}),</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.925.1">create: true</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.926.1">        };</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.927.1">        resp.render("admin/product_editor", data);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.928.1">    });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.929.1">    router.post("/create", async (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.930.1">        const validation = await </span></strong><strong class="screentext"><span class="kobospan" id="kobo.931.1">ProductDTOValidator.validate(req.body);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.932.1">        if (isValid(validation)) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.933.1">            await ProductModel.create(getData(validation));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.934.1">            resp.redirect(</span></strong><strong class="screentext"><span class="kobospan" id="kobo.935.1">303, "/api/products/table");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.936.1">        } else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.937.1">            resp.render("admin/product_editor", {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.938.1">                product: validation,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.939.1">                suppliers: await SupplierModel.findAll({</span></strong><strong class="screentext"><span class="kobospan" id="kobo.940.1">raw: true}),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.941.1">                categories: await CategoryModel.findAll({raw: true}),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.942.1">                create: true</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.943.1">            })</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.944.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.945.1">    });  </span></strong><span class="kobospan" id="kobo.946.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.947.1">Let the browser reload</span><a id="_idIndexMarker1123" class="calibre3"/><span class="kobospan" id="kobo.948.1"> or request </span><code class="inlinecode"><span class="kobospan" id="kobo.949.1">http://localhost:5000/admin</span></code><span class="kobospan" id="kobo.950.1">, and then click the </span><strong class="screentext"><span class="kobospan" id="kobo.951.1">Create</span></strong><span class="kobospan" id="kobo.952.1"> button. </span><span class="kobospan" id="kobo.952.2">Fill out the form and click the </span><strong class="screentext"><span class="kobospan" id="kobo.953.1">Save</span></strong><span class="kobospan" id="kobo.954.1"> button to create a new product, as shown in </span><em class="italic"><span class="kobospan" id="kobo.955.1">Figure 20.6</span></em><span class="kobospan" id="kobo.956.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.957.1"><img alt="" src="../Images/B21959_20_06.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.958.1">Figure 20.6: Creating a new product</span></p>
<h1 class="heading" id="_idParaDest-355"><span class="kobospan" id="kobo.959.1">Administering orders</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.960.1">Now that the product</span><a id="_idIndexMarker1124" class="calibre3"/><span class="kobospan" id="kobo.961.1"> features are in place, it is time to turn to the order data. </span><span class="kobospan" id="kobo.961.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.962.1">admin_order_routes.ts</span></code><span class="kobospan" id="kobo.963.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.964.1">src/routes/admin</span></code><span class="kobospan" id="kobo.965.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.966.1">Listing 20.36</span></em><span class="kobospan" id="kobo.967.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.968.1">Listing 20.36: The contents of the admin_order_routes.ts file in the src/routes/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.969.1">import { Router } from "express";
import { AddressModel, OrderModel, ProductSelectionModel }
    from "../../data/orm/models/order_models";
import { CustomerModel } from "../../data/orm/models/customer_models";
import { ProductModel } from "../../data/orm/models";
export const createAdminOrderRoutes = (router: Router) =&gt; {
    router.get("/table", async (req, resp) =&gt; {
        const orders = (await OrderModel.findAll({
            include: [
                { model: CustomerModel, as: "customer"},
                { model: AddressModel, as: "address"},
                { model: ProductSelectionModel, as: "selections",
                    include: [{ model: ProductModel, as: "product"}]
                }
            ],
            order: ["shipped", "id"]
        })).map(o =&gt; o.toJSON())
        resp.render("admin/order_table", { orders });
    });
    router.post("/ship", async (req, resp) =&gt; {
        const { id, shipped } = req.body;
        const [rows] = await  OrderModel.update({ shipped },{ where: { id }});
        if (rows === 1) {
            resp.redirect(303, "/api/orders/table");
        } else {
            throw new Error(`Expected 1 row updated, but got ${rows}`);
        }
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.970.1">The route that handles </span><code class="inlinecode"><span class="kobospan" id="kobo.971.1">GET</span></code><span class="kobospan" id="kobo.972.1"> requests renders</span><a id="_idIndexMarker1125" class="calibre3"/><span class="kobospan" id="kobo.973.1"> a template named </span><code class="inlinecode"><span class="kobospan" id="kobo.974.1">admin/order_table</span></code><span class="kobospan" id="kobo.975.1">, which is provided with the orders from the database. </span><span class="kobospan" id="kobo.975.2">Earlier queries used the </span><code class="inlinecode"><span class="kobospan" id="kobo.976.1">raw</span></code><span class="kobospan" id="kobo.977.1"> setting, which tells Sequelize to pass on the data as it is read from the database, which is a good technique when the data is naturally in a structure that suits the template that consumes it. </span><span class="kobospan" id="kobo.977.2">In this case, the nested </span><code class="inlinecode"><span class="kobospan" id="kobo.978.1">include</span></code><span class="kobospan" id="kobo.979.1"> properties lead to queries that are not readily used without additional processing. </span><span class="kobospan" id="kobo.979.2">Instead of using the </span><code class="inlinecode"><span class="kobospan" id="kobo.980.1">raw</span></code><span class="kobospan" id="kobo.981.1"> setting, </span><code class="inlinecode"><span class="kobospan" id="kobo.982.1">Sequelize</span></code><span class="kobospan" id="kobo.983.1"> processes the data, which is then converted</span><a id="_idIndexMarker1126" class="calibre3"/><span class="kobospan" id="kobo.984.1"> to a simple object format using the </span><code class="inlinecode"><span class="kobospan" id="kobo.985.1">toJSON</span></code><span class="kobospan" id="kobo.986.1"> method:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.987.1">...
</span><span class="kobospan" id="kobo.987.2">const orders = (await OrderModel.findAll({
    include: [{ model: CustomerModel, as: "customer"},
              { model: AddressModel, as: "address"},
              { model: ProductSelectionModel, as: "selections",
                    include: [{ model: ProductModel, as: "product"}]
               }],
            order: ["shipped", "id"]
        })).map(o =&gt; o.</span><strong class="screentext"><span class="kobospan" id="kobo.988.1">toJSON</span></strong><span class="kobospan" id="kobo.989.1">())
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.990.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.991.1">toJSON</span></code><span class="kobospan" id="kobo.992.1"> method is required because Sequelize usually creates objects that track changes so they can be written to a database, but this confuses the template engine. </span><span class="kobospan" id="kobo.992.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.993.1">toJSON</span></code><span class="kobospan" id="kobo.994.1"> method creates objects without the tracking functionality and which are suitable for template use.</span></p>
<p class="normal"><span class="kobospan" id="kobo.995.1">The handler for </span><code class="inlinecode"><span class="kobospan" id="kobo.996.1">POST</span></code><span class="kobospan" id="kobo.997.1"> requests is used to change the shipping status of orders. </span><span class="kobospan" id="kobo.997.2">If a request is received that corresponds to an order in the database, then the database is updated and a redirection is performed using the </span><code class="inlinecode"><span class="kobospan" id="kobo.998.1">HTTP 303</span></code><span class="kobospan" id="kobo.999.1"> status code.</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.1000.1">Listing 20.37</span></em><span class="kobospan" id="kobo.1001.1"> enables the order routes so that they are reached through the </span><code class="inlinecode"><span class="kobospan" id="kobo.1002.1">/api/orders</span></code><span class="kobospan" id="kobo.1003.1"> prefix.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1004.1">Listing 20.37: Configuring routes in the index.ts file in the src/routes/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1005.1">import { Express, Router } from "express";
import { createAdminCatalogRoutes } from "./admin_catalog_routes";
</span><strong class="screentext"><span class="kobospan" id="kobo.1006.1">import</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1007.1"> { createAdminOrderRoutes } from "./admin_order_routes";</span></strong><span class="kobospan" id="kobo.1008.1">
export const createAdminRoutes = (app: Express) =&gt; {
    app.use((req, resp, next) =&gt; {
        resp.locals.layout = false;
        next();
    })
    const cat_router = Router();
    createAdminCatalogRoutes(cat_router);
    app.use("/api/products", cat_router);
    </span><strong class="screentext"><span class="kobospan" id="kobo.1009.1">const</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1010.1"> order_router = Router();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1011.1">    createAdminOrderRoutes(order_router);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1012.1">    app.use("/api/orders", order_router);</span></strong><span class="kobospan" id="kobo.1013.1">
    app.get("/admin", (req, resp) =&gt; resp.render("admin/admin_layout"));
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1014.1">To create the template</span><a id="_idIndexMarker1127" class="calibre3"/><span class="kobospan" id="kobo.1015.1"> that will present the order data, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.1016.1">order_table.handlebars</span></code><span class="kobospan" id="kobo.1017.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1018.1">templates/admin</span></code><span class="kobospan" id="kobo.1019.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.1020.1">Listing 20.38</span></em><span class="kobospan" id="kobo.1021.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1022.1">Listing 20.38: The contents of the order_table.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1023.1">{{&gt; admin/area_buttons mode="orders"}}
&lt;table class="table table-sm table-bordered"&gt;
    &lt;thead&gt;&lt;tr&gt;&lt;th colspan="7" class="text-center"&gt;Orders&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;
    &lt;tbody&gt;
        {{#unless orders}}
          &lt;tr&gt;&lt;td colspan="7" class="text-center"&gt;No Orders&lt;/td&gt;&lt;/tr&gt;
        {{/unless}}
        {{#each orders}}
            &lt;tr class="table-active"&gt;
                &lt;th&gt;#&lt;/th&gt;&lt;th&gt;Customer&lt;/th&gt;&lt;th&gt;ZIP&lt;/th&gt;
                &lt;th&gt;Product&lt;/th&gt;&lt;th&gt;Quantity&lt;/th&gt;&lt;th&gt;Price&lt;/th&gt;&lt;th&gt;&lt;/th&gt;
            &lt;/tr&gt;
            {{#each selections}}
            &lt;tr&gt;
                {{#if (first @index)}}
                    &lt;td&gt;{{ ../id }}&lt;/td&gt;
                    &lt;td&gt;{{ ../customer.name }}&lt;/td&gt;
                    &lt;td&gt;{{ ../address.zip }}&lt;/td&gt;
                {{else }}
                    &lt;th colspan="3"&gt;&lt;/th&gt;
                {{/if}}
                &lt;td&gt;{{product.name}}&lt;/td&gt;
                &lt;td&gt;{{ quantity }}&lt;/td&gt;
                &lt;td&gt;{{currency product.price}}&lt;/td&gt;
                {{#if (first @index)}}
                    {{&gt; admin/order_button id=../id shipped=../shipped}}
                {{else}}
                    &lt;td&gt;&lt;/td&gt;
                {{/if}}
                &lt;/tr&gt;
            {{/each }}
            &lt;tr&gt;
                &lt;th colspan="5" class="text-end"&gt;Total:&lt;/th&gt;
                &lt;td&gt;{{currency (total selections)}}&lt;/td&gt;
                &lt;td&gt;&lt;/td&gt;
            &lt;/tr&gt;
        {{/each}}
    &lt;/tbody&gt;
&lt;/table&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1024.1">The complexity in this template</span><a id="_idIndexMarker1128" class="calibre3"/><span class="kobospan" id="kobo.1025.1"> is the structure of the table, in which order details are presented using summary and detail rows. </span><span class="kobospan" id="kobo.1025.2">To create a template that will present the user with a button to change the shipping status, create a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.1026.1">order_button.handlebars</span></code><span class="kobospan" id="kobo.1027.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.1028.1">templates/admin</span></code><span class="kobospan" id="kobo.1029.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.1030.1">Listing 20.39</span></em><span class="kobospan" id="kobo.1031.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1032.1">Listing 20.39: The contents of the order_button.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1033.1">&lt;td&gt;
    &lt;form hx-post="/api/orders/ship" hx-target="#content"&gt;
        &lt;input type="hidden" name="id" value="{{id}}"&gt;
        {{#if shipped }}
            &lt;input type="hidden" name="shipped" value="false"&gt;
            &lt;button class="btn btn-sm btn-warning"&gt;Mark Unshipped&lt;/button&gt;
        {{else }}
            &lt;input type="hidden" name="shipped" value="true"&gt;
            &lt;button class="btn btn-sm btn-danger"&gt;Ship Order&lt;/button&gt;
        {{/if}}
    &lt;/form&gt;
&lt;/td&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1034.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1035.1">hx-post</span></code><span class="kobospan" id="kobo.1036.1"> attribute tells </span><code class="inlinecode"><span class="kobospan" id="kobo.1037.1">HTMX</span></code><span class="kobospan" id="kobo.1038.1"> to send a </span><code class="inlinecode"><span class="kobospan" id="kobo.1039.1">POST</span></code><span class="kobospan" id="kobo.1040.1"> request when the user clicks the button. </span><em class="italic"><span class="kobospan" id="kobo.1041.1">Listing 20.40</span></em><span class="kobospan" id="kobo.1042.1"> defines the helpers that are required for the orders template.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1043.1">Listing 20.40: Adding a helper to the admin_helpers.ts file in the src/helpers folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1044.1">export const buttonClass = (btn: string, mode: string) =&gt;
    btn == mode ? </span><span class="kobospan" id="kobo.1044.2">"btn-secondary" : "btn-outline-secondary";
export const disabled = (val: any) =&gt; val == "ID" ? </span><span class="kobospan" id="kobo.1044.3">"disabled" : "";
export const selected = (val1: any, val2: any) =&gt;
    val1 == val2 ? </span><span class="kobospan" id="kobo.1044.4">"selected" : "";
</span><strong class="screentext"><span class="kobospan" id="kobo.1045.1">export const first = (index: number) =&gt; index == 0;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1046.1">export const total = (sels: any[]) =&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1047.1">    sels.reduce((total, s) =&gt; total += (s.quantity * s.product.price), 0);</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.1048.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1049.1">first</span></code><span class="kobospan" id="kobo.1050.1"> helper is used to determine whether a value is the first element in an array and to work out where to insert the customer details and the status change buttons. </span><span class="kobospan" id="kobo.1050.2">This relies on the Handlebars </span><code class="inlinecode"><span class="kobospan" id="kobo.1051.1">each</span></code><span class="kobospan" id="kobo.1052.1"> helper, which provides an </span><code class="inlinecode"><span class="kobospan" id="kobo.1053.1">@index</span></code><span class="kobospan" id="kobo.1054.1"> value that reports the index of the element being processed:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1055.1">...
</span><span class="kobospan" id="kobo.1055.2">{{#if (first </span><strong class="screentext"><span class="kobospan" id="kobo.1056.1">@index</span></strong><span class="kobospan" id="kobo.1057.1">)}}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1058.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1059.1">total</span></code><span class="kobospan" id="kobo.1060.1"> helper calculates the total value of the product selections in the order and is combined with the existing </span><code class="inlinecode"><span class="kobospan" id="kobo.1061.1">currency</span></code><span class="kobospan" id="kobo.1062.1"> helper to create a formatted total price for the order:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1063.1">...
</span><span class="kobospan" id="kobo.1063.2">&lt;td&gt;{{currency (</span><strong class="screentext"><span class="kobospan" id="kobo.1064.1">total</span></strong><span class="kobospan" id="kobo.1065.1"> selections)}}&lt;/td&gt;
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1066.1">There are no orders in the seed data, so the first step in checking the administration features is to create some orders. </span><span class="kobospan" id="kobo.1066.2">Navigate to </span><code class="inlinecode"><span class="kobospan" id="kobo.1067.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.1068.1">, add products to the cart, and check out to create an order. </span><span class="kobospan" id="kobo.1068.2">Navigate to </span><code class="inlinecode"><span class="kobospan" id="kobo.1069.1">http://localhost:5000/admin</span></code><span class="kobospan" id="kobo.1070.1">, click the </span><strong class="screentext"><span class="kobospan" id="kobo.1071.1">Orders</span></strong><span class="kobospan" id="kobo.1072.1"> button, and use the buttons to toggle</span><a id="_idIndexMarker1129" class="calibre3"/><span class="kobospan" id="kobo.1073.1"> the shipment status of orders, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1074.1">Figure 20.7</span></em><span class="kobospan" id="kobo.1075.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.1076.1"><img alt="" src="../Images/B21959_20_07.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.1077.1">Figure 20.7: Changing the order shipping status</span></p>
<h1 class="heading" id="_idParaDest-356"><span class="kobospan" id="kobo.1078.1">Fixing the URLs</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.1079.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1080.1">HTMX</span></code><span class="kobospan" id="kobo.1081.1"> package</span><a id="_idIndexMarker1130" class="calibre3"/><span class="kobospan" id="kobo.1082.1"> makes asynchronous HTTP requests to the web service and displays the results, which is an effective way to create a responsible application, but the result doesn’t behave correctly. </span><span class="kobospan" id="kobo.1082.2">To see the problem, navigate to </span><code class="inlinecode"><span class="kobospan" id="kobo.1083.1">http://localhost:5000/admin</span></code><span class="kobospan" id="kobo.1084.1">, click the </span><strong class="screentext"><span class="kobospan" id="kobo.1085.1">Orders</span></strong><span class="kobospan" id="kobo.1086.1"> button, and then click the browser’s reload button. </span><span class="kobospan" id="kobo.1086.2">Instead of reloading the </span><strong class="screentext"><span class="kobospan" id="kobo.1087.1">Orders</span></strong><span class="kobospan" id="kobo.1088.1"> table, the products are displayed, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1089.1">Figure 20.8</span></em><span class="kobospan" id="kobo.1090.1">. </span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.1091.1"><img alt="" src="../Images/B21959_20_08.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.1092.1">Figure 20.8: Reloading the browser</span></p>
<p class="normal"><span class="kobospan" id="kobo.1093.1">The browser isn’t aware of the effect of user interaction, and reloading effectively resets the client, which displays the product table. </span><span class="kobospan" id="kobo.1093.2">To fix this means defining a set of routes that allow direct navigation to specific application features, as well as configuring </span><code class="inlinecode"><span class="kobospan" id="kobo.1094.1">HTMX</span></code><span class="kobospan" id="kobo.1095.1"> to add URLs that will target those routes following user interaction. </span><em class="italic"><span class="kobospan" id="kobo.1096.1">Listing 20.41</span></em><span class="kobospan" id="kobo.1097.1"> defines the routes required to navigate directly</span><a id="_idIndexMarker1131" class="calibre3"/><span class="kobospan" id="kobo.1098.1"> to the products table, the orders table, and the editor for a specific product.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1099.1">Listing 20.41: Adding direct routes to the index.ts file in the src/routes/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1100.1">import { Express, Router } from "express";
import { createAdminCatalogRoutes } from "./admin_catalog_routes";
import { createAdminOrderRoutes } from "./admin_order_routes";
export const createAdminRoutes = (app: Express) =&gt; {
    app.use((req, resp, next) =&gt; {
        resp.locals.layout = false;
        next();
    })
    const cat_router = Router();
    createAdminCatalogRoutes(cat_router);
    app.use("/api/products", cat_router);
    const order_router = Router();
    createAdminOrderRoutes(order_router);
    app.use("/api/orders", order_router);
    app.get("/admin", (req, resp) =&gt; resp.redirect("/admin/products"));
</span><strong class="screentext"><span class="kobospan" id="kobo.1101.1">    app.get("/admin/products", (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1102.1">        resp.locals.content = "/api/products/table";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1103.1">        resp.render("admin/admin_layout"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1104.1">);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1105.1">    });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1106.1">    app.get("/admin/products/edit/:id", (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1107.1">        resp.locals.content = `/api/products/edit/${req.params.id}`;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1108.1">        resp.render("admin/admin_layout"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1109.1">);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1110.1">    });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1111.1">    app.get("/admin/orders", (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1112.1">        resp.locals.content = "/api/orders/table";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1113.1">        resp.render("admin/admin_layout");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1114.1">    });</span></strong><span class="kobospan" id="kobo.1115.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1116.1">The new routes render</span><a id="_idIndexMarker1132" class="calibre3"/><span class="kobospan" id="kobo.1117.1"> the </span><code class="inlinecode"><span class="kobospan" id="kobo.1118.1">admin_layout</span></code><span class="kobospan" id="kobo.1119.1"> template with a </span><code class="inlinecode"><span class="kobospan" id="kobo.1120.1">content</span></code><span class="kobospan" id="kobo.1121.1"> value that specifies the URL that </span><code class="inlinecode"><span class="kobospan" id="kobo.1122.1">HTMX</span></code><span class="kobospan" id="kobo.1123.1"> should use to request content. </span><span class="kobospan" id="kobo.1123.2">For consistency, the </span><code class="inlinecode"><span class="kobospan" id="kobo.1124.1">/admin</span></code><span class="kobospan" id="kobo.1125.1"> route sends a redirection to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1126.1">/admin/products</span></code><span class="kobospan" id="kobo.1127.1"> URL. </span><em class="italic"><span class="kobospan" id="kobo.1128.1">Listing 20.42</span></em><span class="kobospan" id="kobo.1129.1"> updates the template to use the </span><code class="inlinecode"><span class="kobospan" id="kobo.1130.1">content</span></code><span class="kobospan" id="kobo.1131.1"> value that is provided by the new routes.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1132.1">Listing 20.42: Loading a URL into the admin_layout.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1133.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;link href="/css/bootstrap.min.css" rel="stylesheet" /&gt;
        &lt;link href="/font/bootstrap-icons.min.css" rel="stylesheet"&gt;
        &lt;script src="/admin/bundle.js" defer&gt;&lt;/script&gt;
        &lt;script src="/htmx.min.js"&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="container-fluid"&gt;
            &lt;div class="row bg-info text-white py-2 px-1"&gt;
                &lt;div class="col align-baseline pt-1"&gt;SPORTS STORE ADMIN&lt;/div&gt;
                &lt;div class="col-auto text-end"&gt;&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class="row p-2"&gt;
                &lt;div class="col-2" id="area_buttons"&gt;&lt;/div&gt;
                </span><strong class="screentext"><span class="kobospan" id="kobo.1134.1">&lt;div class="col" id="content" hx-get="{{content}}"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1135.1">                    hx-trigger</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1136.1">="load"&gt;&lt;/div&gt;</span></strong><span class="kobospan" id="kobo.1137.1">
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1138.1">The web service URLs that provide fragments of HTML content are of no use for direct navigation because they do not provide a complete HTML document. </span><span class="kobospan" id="kobo.1138.2">Fortunately, </span><code class="inlinecode"><span class="kobospan" id="kobo.1139.1">HTMX</span></code><span class="kobospan" id="kobo.1140.1"> supports the </span><code class="inlinecode"><span class="kobospan" id="kobo.1141.1">hx-push-url</span></code><span class="kobospan" id="kobo.1142.1"> attribute, which adds a URL to the browser’s history, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1143.1">Listing 20.43</span></em><span class="kobospan" id="kobo.1144.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1145.1">Listing 20.43: Pushing URLs into the area_buttons.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1146.1">&lt;swap_wrapper hx-swap-oob="innerHTML:#area_buttons"&gt;
    &lt;div class="d-grid gap-2" &gt;
        </span><strong class="screentext"><span class="kobospan" id="kobo.1147.1">&lt;button</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1148.1"> id="products_btn" class="btn {{ buttonClass "products" mode }}"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1149.1">            hx-get="/api/products/table" hx-target="#content"</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.1150.1">hx-push-url="/admin/products"&gt;</span></strong><span class="kobospan" id="kobo.1151.1">
            Products
        &lt;/button&gt;
        </span><strong class="screentext"><span class="kobospan" id="kobo.1152.1">&lt;button id="orders_btn" class="btn {{ buttonClass "orders"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1153.1"> mode }}"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1154.1">            hx-get="/api/orders/table" hx-target="#content"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1155.1">            hx-push-url="/admin/orders"&gt;</span></strong><span class="kobospan" id="kobo.1156.1">
            Orders
        &lt;/button&gt;
    &lt;/div&gt;
&lt;/swap_wrapper&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1157.1">When the user clicks</span><a id="_idIndexMarker1133" class="calibre3"/><span class="kobospan" id="kobo.1158.1"> on one of the buttons, the </span><code class="inlinecode"><span class="kobospan" id="kobo.1159.1">HTMX</span></code><span class="kobospan" id="kobo.1160.1"> package will request a fragment of HTML from the web service but will add one of the direct navigation URLs to the browser’s history. </span><em class="italic"><span class="kobospan" id="kobo.1161.1">Listing 20.44</span></em><span class="kobospan" id="kobo.1162.1"> applies the same attribute to the button that starts the editing process for a product.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1163.1">Listing 20.44: Pushing a URL into the product_row.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1164.1">&lt;tr id="row{{ id }}"&gt;
    &lt;td&gt;{{ id }}&lt;/td&gt;
    &lt;td&gt;{{ name }}&lt;/td&gt;
    &lt;td&gt;{{ category.name  }}&lt;/td&gt;
    &lt;td&gt;{{ supplier.name  }}&lt;/td&gt;
    &lt;td class="text-end"&gt;{{ currency price}}&lt;/td&gt;
    &lt;td class="ps-3"&gt;       
       </span><strong class="screentext"><span class="kobospan" id="kobo.1165.1"> &lt;button class="btn btn-sm btn-warning"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1166.1">hx-get="</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1167.1">/api/products/edit/{{id}}" hx-target="#content"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1168.1">                hx-push-url="/admin/products/edit/{{id}}"&gt;</span></strong><span class="kobospan" id="kobo.1169.1">
                Edit
            &lt;/button&gt;
        &lt;button class="btn btn-sm btn-danger"
            hx-delete="/api/products/{{id}}" hx-target="#row{{id}}"
                    hx-swap="delete"&gt;
                Delete
        &lt;/button&gt;           
    &lt;/td&gt;
&lt;/tr&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1170.1">Navigate to </span><code class="inlinecode"><span class="kobospan" id="kobo.1171.1">http://localhost:5000/admin</span></code><span class="kobospan" id="kobo.1172.1">, and your browser will be redirected to </span><code class="inlinecode"><span class="kobospan" id="kobo.1173.1">http://localhost:5000/admin/products</span></code><span class="kobospan" id="kobo.1174.1">. </span><span class="kobospan" id="kobo.1174.2">Click the </span><strong class="screentext"><span class="kobospan" id="kobo.1175.1">Orders</span></strong><span class="kobospan" id="kobo.1176.1"> button, and the URL bar will display </span><code class="inlinecode"><span class="kobospan" id="kobo.1177.1">http://localhost:5000/admin/orders</span></code><span class="kobospan" id="kobo.1178.1">, even though </span><code class="inlinecode"><span class="kobospan" id="kobo.1179.1">HTMX</span></code><span class="kobospan" id="kobo.1180.1"> sent an HTTP request to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1181.1">/api/orders/table</span></code><span class="kobospan" id="kobo.1182.1"> URL.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1183.1">Click the reload button, and the browser</span><a id="_idIndexMarker1134" class="calibre3"/><span class="kobospan" id="kobo.1184.1"> will display the </span><strong class="screentext"><span class="kobospan" id="kobo.1185.1">Orders</span></strong><span class="kobospan" id="kobo.1186.1"> list. </span><span class="kobospan" id="kobo.1186.2">(The database will have been reset when the files changed and will not contain any orders.) Request </span><code class="inlinecode"><span class="kobospan" id="kobo.1187.1">http://localhost:5000/admin/products/edit/2</span></code><span class="kobospan" id="kobo.1188.1">, and you will see the editor for the </span><code class="inlinecode"><span class="kobospan" id="kobo.1189.1">Lifejacket</span></code><span class="kobospan" id="kobo.1190.1"> product, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1191.1">Figure 20.9</span></em><span class="kobospan" id="kobo.1192.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.1193.1"><img alt="" src="../Images/B21959_20_09.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.1194.1">Figure 20.9: Navigating directly to an application feature</span></p>
<h1 class="heading" id="_idParaDest-357"><span class="kobospan" id="kobo.1195.1">Restricting access to administration features</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.1196.1">Access to the administration features</span><a id="_idIndexMarker1135" class="calibre3"/><span class="kobospan" id="kobo.1197.1"> should be restricted to approved users, which means implementing authentication and authorization. </span><span class="kobospan" id="kobo.1197.2">The application already has support to identify users, using Google accounts, and the quickest way to restrict access is to configure the application to restrict access to a predefined list of accounts. </span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.1198.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.1199.1">Using OAuth to authenticate administrators is a useful way to identify users, but care should be taken in real projects to ensure some form of administration access if the OAuth service is unavailable.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.1200.1">To start, navigate to </span><a href="https://console.developers.google.com" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.1201.1">https://console.developers.google.com</span></span></a><span class="kobospan" id="kobo.1202.1">, click </span><strong class="screentext"><span class="kobospan" id="kobo.1203.1">Credentials</span></strong><span class="kobospan" id="kobo.1204.1">, and select the </span><strong class="screentext"><span class="kobospan" id="kobo.1205.1">Edit OAuth Client</span></strong><span class="kobospan" id="kobo.1206.1"> action, which is represented</span><a id="_idIndexMarker1136" class="calibre3"/><span class="kobospan" id="kobo.1207.1"> by the pencil icon, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1208.1">Figure 20.10</span></em><span class="kobospan" id="kobo.1209.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.1210.1"><img alt="" src="../Images/B21959_20_10.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.1211.1">Figure 20.10: Editing the OAuth client</span></p>
<p class="normal"><span class="kobospan" id="kobo.1212.1">Add the following URLs to the </span><strong class="screentext"><span class="kobospan" id="kobo.1213.1">Authorized redirect URIs</span></strong><span class="kobospan" id="kobo.1214.1"> section:</span></p>
<ul class="calibre4">
<li class="bulletlist"><code class="inlinecode"><span class="kobospan" id="kobo.1215.1">http://localhost:5000/auth-signin-google</span></code></li>
<li class="bulletlist1"><code class="inlinecode"><span class="kobospan" id="kobo.1216.1">https://localhost/auth-signin-google</span></code></li>
</ul>
<p class="normal"><span class="kobospan" id="kobo.1217.1">There should now be four URIs in this section, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1218.1">Figure 20.11</span></em><span class="kobospan" id="kobo.1219.1">. </span><span class="kobospan" id="kobo.1219.2">Click </span><strong class="screentext"><span class="kobospan" id="kobo.1220.1">Save</span></strong><span class="kobospan" id="kobo.1221.1"> to update the OAuth configuration.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.1222.1"><img alt="" src="../Images/B21959_20_11.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.1223.1">Figure 20.11: The authorized redirection URLs</span></p>
<p class="normal"><span class="kobospan" id="kobo.1224.1">Returning to the code</span><a id="_idIndexMarker1137" class="calibre3"/><span class="kobospan" id="kobo.1225.1"> editor, add a new </span><code class="inlinecode"><span class="kobospan" id="kobo.1226.1">configuration</span></code><span class="kobospan" id="kobo.1227.1"> section that provides the application with the OAuth redirection and a list of approved administration users, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1228.1">Listing 20.45</span></em><span class="kobospan" id="kobo.1229.1">. </span><span class="kobospan" id="kobo.1229.2">(You must enter the email address for a Google account for which you have the credentials to be able to authenticate yourself.)</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1230.1">Listing 20.45: Adding a configuration section to the server.config.json file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1231.1">{
    "http": {
        "port": 5000,
        "content_security": {
            "contentSecurityPolicy": {
                "directives": {
                    "upgradeInsecureRequests": null
                }
            }           
        }       
    },
   
    // ...configuration settings omitted for brevity...
    </span><span class="kobospan" id="kobo.1231.2">"auth": {
        "openauth": {
            "redirectionUrl": "http://localhost:5000/signin-google"
        }
    },
    </span><strong class="screentext"><span class="kobospan" id="kobo.1232.1">"admin": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1233.1">        "openauth": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1234.1">            "redirectionUrl": "http://localhost:5000/auth-signin-google"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1235.1">        },</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1236.1">        "users": ["alice@example.com", "your_account@google.com"]</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1237.1">    }</span></strong><span class="kobospan" id="kobo.1238.1">
}
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.1239.1">Listing 20.46</span></em><span class="kobospan" id="kobo.1240.1"> creates a new authentication</span><a id="_idIndexMarker1138" class="calibre3"/><span class="kobospan" id="kobo.1241.1"> strategy and adds a new property to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1242.1">User</span></code><span class="kobospan" id="kobo.1243.1"> interface that differentiates between authentication for administration and authentication for placing orders.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1244.1">Listing 20.46: Creating a strategy in the authentication.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1245.1">import { Express } from "express";
import { getConfig, getSecret } from "./config";
import passport from "passport";
import { Strategy as GoogleStrategy, Profile, VerifyCallback }
    from "passport-google-oauth20";
import { customer_repository } from "./data";
import { Customer } from "./data/customer_models";
const callbackURL: string = getConfig("auth:openauth:redirectionUrl");
const clientID = getSecret("GOOGLE_CLIENT_ID");
const clientSecret = getSecret("GOOGLE_CLIENT_SECRET");
</span><strong class="screentext"><span class="kobospan" id="kobo.1246.1">const authCallbackURL: string = getConfig("</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1247.1">admin:openauth:redirectionUrl")</span></strong><span class="kobospan" id="kobo.1248.1">
declare global {
    namespace Express {
        interface User extends Customer {
           </span><strong class="screentext"><span class="kobospan" id="kobo.1249.1"> adminUser?: boolean;</span></strong><span class="kobospan" id="kobo.1250.1">
        }
    }
}
export const createAuthentication = (app:Express) =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.1251.1">passport.use("admin-auth", new GoogleStrategy({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1252.1">        clientID, clientSecret, callbackURL: authCallbackURL,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1253.1">        scope: ["email", "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1254.1">profile"],</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1255.1">        state: true       </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1256.1">    }, (accessToken: string, refreshToken: string,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1257.1">            profile: Profile, callback: VerifyCallback) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1258.1">        return callback(null, {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1259.1">            name: profile.displayName,</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.1260.1">email: profile.emails?.[0].value ?? </span><span class="kobospan" id="kobo.1260.2">"",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1261.1">            federatedId: profile.id,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1262.1">            adminUser: true</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1263.1">        })   </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1264.1">    }));</span></strong><span class="kobospan" id="kobo.1265.1">
    passport.use(new GoogleStrategy({
        clientID, clientSecret, callbackURL,
        scope: ["email", "profile"],
        state: true
    } , async (accessToken: string, refreshToken: string,
            profile: Profile, callback: VerifyCallback) =&gt; {
        const emailAddr = profile.emails?.[0].value ?? </span><span class="kobospan" id="kobo.1265.2">"";           
        const customer = await customer_repository.storeCustomer({
            name: profile.displayName, email: emailAddr,
            federatedId: profile.id
        });
        const { id, name, email } = customer;
        return callback(null, { id, name, email });
    }));
    passport.serializeUser((user, callback) =&gt; {
        </span><strong class="screentext"><span class="kobospan" id="kobo.1266.1">callback(null, user.adminUser ? </span><span class="kobospan" id="kobo.1266.2">JSON.stringify(user) : user.id);</span></strong><span class="kobospan" id="kobo.1267.1">
    });
    </span><strong class="screentext"><span class="kobospan" id="kobo.1268.1">passport.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1269.1">deserializeUser((id: number | string , callbackFunc) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1270.1">        if (typeof id == "string") {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1271.1">            callbackFunc(null, JSON.parse(id));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1272.1">        } </span></strong><strong class="screentext"><span class="kobospan" id="kobo.1273.1">else {</span></strong><span class="kobospan" id="kobo.1274.1">
            customer_repository.getCustomer(id).then(user =&gt;
                callbackFunc(null, user));
        }
    });
    app.use(passport.session());
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1275.1">The new strategy is created</span><a id="_idIndexMarker1139" class="calibre3"/><span class="kobospan" id="kobo.1276.1"> with the name </span><code class="inlinecode"><span class="kobospan" id="kobo.1277.1">admin-auth</span></code><span class="kobospan" id="kobo.1278.1"> to differentiate it from the existing OAuth strategy. </span><span class="kobospan" id="kobo.1278.2">The new callback URL is read from the configuration file and used to create the strategy, and the callback function creates a USER with the </span><code class="inlinecode"><span class="kobospan" id="kobo.1279.1">adminUser</span></code><span class="kobospan" id="kobo.1280.1"> property set to </span><code class="inlinecode"><span class="kobospan" id="kobo.1281.1">true</span></code><span class="kobospan" id="kobo.1282.1">.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1283.1">There is no persistent data store for administration user details, so the </span><code class="inlinecode"><span class="kobospan" id="kobo.1284.1">serializeUser</span></code><span class="kobospan" id="kobo.1285.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1286.1">deserializeUser</span></code><span class="kobospan" id="kobo.1287.1"> functions have been modified to serialize the entire </span><code class="inlinecode"><span class="kobospan" id="kobo.1288.1">User</span></code><span class="kobospan" id="kobo.1289.1"> object in the session, but only when the </span><code class="inlinecode"><span class="kobospan" id="kobo.1290.1">adminUser</span></code><span class="kobospan" id="kobo.1291.1"> property is </span><code class="inlinecode"><span class="kobospan" id="kobo.1292.1">true</span></code><span class="kobospan" id="kobo.1293.1">.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1294.1">A new set of routes is required to handle administration authentication, along with middleware components to authorize requests, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1295.1">Listing 20.47</span></em><span class="kobospan" id="kobo.1296.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1297.1">Listing 20.47: Adding routes and middleware to the index.ts file in the src/routes/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1298.1">import { Express, NextFunction, Request, Response, Router } from "express";
import { createAdminCatalogRoutes } from "./admin_catalog_routes";
import { createAdminOrderRoutes } from "./admin_order_routes";
</span><strong class="screentext"><span class="kobospan" id="kobo.1299.1">import passport from "passport";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1300.1">import { getConfig} from "../../config";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1301.1">const users: string[] = getConfig("admin:users", []);</span></strong><span class="kobospan" id="kobo.1302.1">
export const createAdminRoutes = (app: Express) =&gt; {
    app.use((req, resp, next) =&gt; {
        resp.locals.layout = false;
        </span><strong class="screentext"><span class="kobospan" id="kobo.1303.1">resp.locals.user = req.user;</span></strong><span class="kobospan" id="kobo.1304.1">
        next();
    });
    </span><strong class="screentext"><span class="kobospan" id="kobo.1305.1">app.get("</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1306.1">/admin/signin", (req, resp) =&gt; resp.render("admin/signin"));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1307.1">    app.post("/admin/signout", (req, resp) =&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1308.1">        req.logOut(</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1309.1">() =&gt; { resp.redirect("/admin/signin") }));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1310.1">    app.get("/admin/google", passport.authenticate("admin-auth"));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1311.1">    app.get("/auth-signin-google", passport.authenticate("</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1312.1">admin-auth", {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1313.1">        successRedirect: "/admin/products", keepSessionInfo: true</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1314.1">    }));   </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1315.1">    const authCheck = (r: Request) =&gt; users.find(u =&gt;</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1316.1"> r.user?.email === u);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1317.1">    const apiAuth = (req: Request, resp: Response, next: NextFunction) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1318.1">        if (!authCheck(req)) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1319.1">            return resp.sendStatus(401</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1320.1">)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1321.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1322.1">        next();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1323.1">    };</span></strong><span class="kobospan" id="kobo.1324.1">
    const cat_router = Router();
    createAdminCatalogRoutes(cat_router);
  </span><strong class="screentext"><span class="kobospan" id="kobo.1325.1">  app.use("/api/products", apiAuth, cat_router);</span></strong><span class="kobospan" id="kobo.1326.1">
    const order_router = Router();
    createAdminOrderRoutes(order_router);
    </span><strong class="screentext"><span class="kobospan" id="kobo.1327.1">app.use</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1328.1">("/api/orders", apiAuth, order_router);</span></strong><span class="kobospan" id="kobo.1329.1">
    c</span><strong class="screentext"><span class="kobospan" id="kobo.1330.1">onst userAuth = (req: Request, resp: Response, next: NextFunction) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1331.1">        if (!authCheck(req)) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1332.1">            return resp.redirect("/admin/signin");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1333.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1334.1">        next</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1335.1">();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1336.1">    };</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1337.1">    app.get("/admin", userAuth, (req, resp) =&gt;</span></strong><span class="kobospan" id="kobo.1338.1">
        resp.redirect("/admin/products"));
    </span><strong class="screentext"><span class="kobospan" id="kobo.1339.1">app.get("/admin/products", userAuth, (req, resp) =&gt;</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1340.1"> {</span></strong><span class="kobospan" id="kobo.1341.1">
        resp.locals.content = "/api/products/table";
        resp.render("admin/admin_layout");
    })
   </span><strong class="screentext"><span class="kobospan" id="kobo.1342.1"> app.get("/admin/products/edit/:id", userAuth, (req, resp) =&gt; {</span></strong><span class="kobospan" id="kobo.1343.1">
        resp.locals.content = `/api/products/edit/${req.params.id}`;
        resp.render("admin/admin_layout");
    })
   </span><strong class="screentext"><span class="kobospan" id="kobo.1344.1"> app.get("/admin/orders", userAuth, (req, resp) =&gt; {</span></strong><span class="kobospan" id="kobo.1345.1">
        resp.locals.content = "/api/orders/table";
        resp.render("admin/admin_layout");
    })
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1346.1">The new routes are used to prompt</span><a id="_idIndexMarker1140" class="calibre3"/><span class="kobospan" id="kobo.1347.1"> the user to sign in, allow users to sign out again, and handle the Google OAuth redirections. </span><span class="kobospan" id="kobo.1347.2">The middleware components check that the signed-in user is one of the approved users from the configuration file, with redirection responses for the direct navigation routes and </span><code class="inlinecode"><span class="kobospan" id="kobo.1348.1">401</span></code><span class="kobospan" id="kobo.1349.1"> responses for the web service routes.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1350.1">To define the template that will be rendered when the user needs to sign in, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.1351.1">signin.handlebars</span></code><span class="kobospan" id="kobo.1352.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1353.1">templates/admin</span></code><span class="kobospan" id="kobo.1354.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.1355.1">Listing 20.48</span></em><span class="kobospan" id="kobo.1356.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1357.1">Listing 20.48: The contents of the signin.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1358.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;link href="/css/bootstrap.min.css" rel="stylesheet" /&gt;
        &lt;link href="/font/bootstrap-icons.min.css" rel="stylesheet"&gt;
        {{#if (isDevelopment) }}
            &lt;script src="/admin/bundle.js"&gt;&lt;/script&gt;
        {{/if }}
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="container-fluid"&gt;
            &lt;div class="row bg-info text-white py-2 px-1"&gt;
                &lt;div class="col align-baseline pt-1"&gt;SPORTS STORE ADMIN&lt;/div&gt;
                &lt;div class="col-auto text-end"&gt;&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class="row p-2"&gt;
                &lt;div class="col"&gt;&lt;/div&gt;
                &lt;div class="col-auto"&gt;
                    &lt;a class="btn btn-primary" href="/admin/google"&gt;
                        &lt;i class="bi bi-google"&gt;&lt;/i&gt;
                        Sign in with Google Account
                    &lt;/a&gt;                 
                &lt;/div&gt; 
                &lt;div class="col"&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1359.1">The final step is to show the signed-in user’s name and provide a </span><strong class="screentext"><span class="kobospan" id="kobo.1360.1">Sign out</span></strong><span class="kobospan" id="kobo.1361.1"> button, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1362.1">Listing 20.49</span></em><span class="kobospan" id="kobo.1363.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1364.1">Listing 20.49: Adding user details to the admin_layout.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1365.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;link href="/css/bootstrap.min.css" rel="stylesheet" /&gt;
        &lt;link href="/font/bootstrap-icons.min.css" rel="stylesheet"&gt;
        {{#if (isDevelopment) }}
            &lt;script src="/admin/bundle.js"&gt;&lt;/script&gt;
        {{/if }}
        &lt;script src="/htmx.min.js"&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="container-fluid"&gt;
            &lt;div class="row bg-info text-white py-2 px-1"&gt;
                &lt;div class="col align-baseline pt-1"&gt;SPORTS STORE ADMIN&lt;/div&gt;
                &lt;div class="col-auto text-end"&gt;
                    </span><strong class="screentext"><span class="kobospan" id="kobo.1366.1">{{#if user }}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1367.1">                        ({{user.name}})</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1368.1">                        &lt;button class</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1369.1">="btn btn-secondary"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1370.1">                                hx-post="/admin/signout" hx-target="body"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1371.1">                                hx-push-url="/admin/signin"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1372.1">                            &lt;i class</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1373.1">="bi bi-box-arrow-right"&gt;&lt;/i&gt;                               </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1374.1">                        &lt;/button&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1375.1">                    {{/if}}</span></strong><span class="kobospan" id="kobo.1376.1">
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class="row p-2"&gt;
                &lt;div class="col-2" id="area_buttons"&gt;&lt;/div&gt;
                &lt;div class="col" id="content" hx-get="{{content}}"
                    hx-trigger="load"&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1377.1">Navigate to </span><code class="inlinecode"><span class="kobospan" id="kobo.1378.1">http://localhost:5000/admin</span></code><span class="kobospan" id="kobo.1379.1">, and you will be prompted</span><a id="_idIndexMarker1141" class="calibre3"/><span class="kobospan" id="kobo.1380.1"> to </span><strong class="screentext"><span class="kobospan" id="kobo.1381.1">Sign in with a Google account</span></strong><span class="kobospan" id="kobo.1382.1">, as shown in </span><em class="italic"><span class="kobospan" id="kobo.1383.1">Figure 20.12</span></em><span class="kobospan" id="kobo.1384.1">. </span><span class="kobospan" id="kobo.1384.2">If the account matches the approved list, then you will be redirected to the administration features once the authentication process is complete. </span><span class="kobospan" id="kobo.1384.3">Clicking on the button at the top of the window will sign the user out of the application.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.1385.1"><img alt="" src="../Images/B21959_20_12.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.1386.1">Figure 20.12: Signing in to the administration features</span></p>
<h1 class="heading" id="_idParaDest-358"><span class="kobospan" id="kobo.1387.1">Summary</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.1388.1">In this chapter, I created administration tools to manage the catalog and set the order shipping status:</span></p>
<ul class="calibre4">
<li class="bulletlist"><span class="kobospan" id="kobo.1389.1">The administration features use a RESTful web service that returns fragments of HTML, which are displayed using the </span><code class="inlinecode"><span class="kobospan" id="kobo.1390.1">HTMX</span></code><span class="kobospan" id="kobo.1391.1"> package.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1392.1">The state is managed by the server, which renders templates to produce the HTML fragments that are returned by the web service.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1393.1">URLs are added to the browser’s history so that the reload and back buttons work as expected.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1394.1">Access to the administration feature is restricted to authorized users who authenticate with their Google account.</span></li>
</ul>
<p class="normal"><span class="kobospan" id="kobo.1395.1">In the next chapter, I will prepare the </span><em class="italic"><span class="kobospan" id="kobo.1396.1">SportsStore</span></em><span class="kobospan" id="kobo.1397.1"> application for deployment.</span></p>
</div>
</body></html>