<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Creating Interactive Webpages</h1></div></div></div><p>In the previous chapter, you learned to create an RSS/Atom feed reader, stock quote ticker, language translator, and to create a document reviewing and commenting application.</p><p>In this chapter, you will learn:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To create web applications that return Sheet data as HTML, JSON, and PDF</li><li class="listitem" style="list-style-type: disc">To send HTTP/HTTPS request with the query string</li><li class="listitem" style="list-style-type: disc">To create an RSS feed</li><li class="listitem" style="list-style-type: disc">To create a file upload application</li><li class="listitem" style="list-style-type: disc">To create a timesheet application</li></ul></div><div><div><div><div><h1 class="title"><a id="ch07lvl1sec62"/>Creating a web app to render Sheet data as HTML</h1></div></div></div><p>We will create an<a class="indexterm" id="id297"/> application to return <a class="indexterm" id="id298"/>Sheet data as HTML in the browser. Create a Sheet, rename it as <code class="literal">Data</code>, and populate it with some test data as shown in the next screenshot. You can populate the Sheet with any random data with the three columns named <code class="literal">First Name</code>, <code class="literal">Last Name</code>, and <code class="literal">Full Name</code>:</p><div><img alt="Creating a web app to render Sheet data as HTML" src="img/B05010_07_03.jpg"/></div><p>In the <code class="literal">Code.gs</code> file, create<a class="indexterm" id="id299"/> the <code class="literal">doGet</code> function<a class="indexterm" id="id300"/> as shown here:</p><div><pre class="programlisting">function doGet() {
  /*
   *  This spreadsheet may not be active while this function
   *  executes, so you cannot get access to active spreadsheet,
   *  use open by id.
   *
   */
  var ss = SpreadsheetApp
      .openById("Replace with this spreadsheet id");

  var SheetData = ss.getSheetByName("Data");
  
  var data = SheetData.getDataRange().getValues();
  
  var html = '&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;body&gt;&lt;table border=1&gt;';
  
  // Each row data passed as argument to the anonymous function.
  data.forEach(function(row){
    html += '&lt;tr&gt;';
    html += '&lt;td&gt;' + row[0] + '&lt;/td&gt;';
    html += '&lt;td&gt;' + row[1] + '&lt;/td&gt;';
    html += '&lt;td&gt;' + row[2] + '&lt;/td&gt;';
    html += '&lt;/tr&gt;';
  });
  
  // Let's close table, body and html tags.
  html += '&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;';
  
  // Return as HTML document.
  Return HtmlService.createHtmlOutput(html);
  
}</pre></div><p>The <code class="literal">HtmlService</code> function can be used to create any HTML content. The preceding <code class="literal">doGet</code> function returns HTML content created by <code class="literal">HtmlService</code> to the browser. Publish the script as explained <a class="indexterm" id="id301"/>earlier, and enter the URL in the browser's address bar. You can see the result as shown in the following<a class="indexterm" id="id302"/> screenshot. The data shown may vary as per your input data.</p><div><img alt="Creating a web app to render Sheet data as HTML" src="img/B05010_07_04.jpg"/></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec63"/>Creating a web app to return JSON</h1></div></div></div><p>Now, we will see how<a class="indexterm" id="id303"/> to return JSON string instead of HTML <a class="indexterm" id="id304"/>content. In the <code class="literal">Data</code> Sheet, add another column named <code class="literal">DOB</code> as shown here:</p><div><img alt="Creating a web app to return JSON" src="img/B05010_07_05.jpg"/></div><p>Create the <code class="literal">doGet</code>
<a class="indexterm" id="id305"/> function as<a class="indexterm" id="id306"/> shown here:</p><div><pre class="programlisting">function doGet(){
  /*
   *  This spreadsheet may not be active while this function 
   *  executes, so you cannot get access to active spreadsheet, 
   *  use open by id.
   *
   */
  var ss = SpreadsheetApp
      .openById("Replace with this spreadsheet id");

  var SheetData = ss.getSheetByName("Data");
  
  var data = SheetData.getDataRange().getValues();
  
  // Remove header
  data.shift();
  
  var date = new Date();
  var currYear = date.getFullYear();
  
  var output = {};
  
  data.forEach(function(row){
    var dob = new Date(row[3]);
    var dobYear = dob.getFullYear();
    
    /*
     * Create full name property within output object.
     * Again the full name property is an object.
     *
     */
    output[row[2]] = {};

    /*
     * Assign DOB property to full name object.
     * Change time zone and date format as per your preference.
     *
     */
    output[row[2]].dob = Utilities
      .formatDate(row[3], "UTC", "MM/dd/yyyy");

    // Let's calculate age.
    output[row[2]].age = currYear - dobYear;
  });
  
  // We can return only string to browser, so convert to string.
  var json = JSON.stringify(output);

  return ContentService.createTextOutput(json);
}</pre></div><p>The output in the <a class="indexterm" id="id307"/>browser will be JSON string as<a class="indexterm" id="id308"/> follows:</p><div><img alt="Creating a web app to return JSON" src="img/B05010_07_06.jpg"/></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec64"/>Converting Sheet data as a PDF file</h1></div></div></div><p>You can create an<a class="indexterm" id="id309"/> application to convert Sheet data into<a class="indexterm" id="id310"/> a PDF file and store it in Drive, and return the PDF file's URL to the user:</p><p>In the <code class="literal">Code.gs</code> file, create the <code class="literal">doGet</code> function as listed here:</p><div><pre class="programlisting">function doGet() {
  /*
   *  This spreadsheet may not be active while this function 
   *  executes, so you cannot get access to active spreadsheet, 
   *  use open by id.
   *
   */
  var ss = SpreadsheetApp.openById("[[ this spreadsheet id ]]");

  var SheetData = ss.getSheetByName("Data");
  
  var template = HtmlService
      .createTemplateFromFile("Template.html");

  // Assign 'data' to the template object
  template.data = SheetData.getDataRange().getValues();
  
  // Evaluate template object as html content
  var html = template.evaluate();

  // Convert html content to pdf
  // var pdf = html.getAs("application/pdf")
  //    .setName("Test_Data.pdf");

  // Or use this code
  var pdf = html.getAs(MimeType.PDF).setName("Test_Data.pdf");
  
  // Create pdf file in the "My Drive" folder and share it with //public.
  var file = DriveApp.createFile(pdf);

  // Let's set sharing access as anyone can view the pdf.
  file.setSharing(
    DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW
  );
  
  // Create and return html content with link to the pdf file.
  return HtmlService.createHtmlOutput(
    'Click &lt;a target="_top" href="'
    + file.getUrl()
    +'"&gt;here&lt;/a&gt; to view pdf file.'
  );
}</pre></div><p>Create a new HTML file, <code class="literal">Template.html</code>, and enter the following HTML code. In this code, the <code class="literal">data</code> array is a<a class="indexterm" id="id311"/> 2-dimensional array<a class="indexterm" id="id312"/> already assigned to the <code class="literal">template</code> object in the <code class="literal">doGet</code> function:</p><div><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;body&gt;
    &lt;table&gt;
      &lt;? for(var i in data) {?&gt;
        &lt;tr&gt;
          &lt;? for(var j in data[i]) { ?&gt;
            &lt;td&gt;&lt;?= data[i][j] ?&gt;&lt;/td&gt;
          &lt;? } ?&gt;
        &lt;/tr&gt;
      &lt;? } ?&gt;
    &lt;/table&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div><p>In the mentioned code, the template markers <code class="literal">&lt;?</code> and <code class="literal">?&gt;</code> enclose the script code, which is identical to the <code class="literal">script</code> tag in the normal HTML code. The enclosed code executes, but does not return anything. The markers <code class="literal">&lt;?=</code> and <code class="literal">?&gt;</code> return the result of the enclosed code. For example, <code class="literal">&lt;?= data[i][j] ?&gt;</code> returns the <em>i</em>th row <em>j</em>th column value of a 2-dimensional <code class="literal">data</code> array.</p><p>For your understanding the server script without template markup in the previous code is reproduced here:</p><div><pre class="programlisting">for(var i in data) {
  for(var j in data[i]) {
    data[i][j] 
  }
}</pre></div><p>Publish and enter<a class="indexterm" id="id313"/> the published URL in a browser's address bar. The<a class="indexterm" id="id314"/> result will be as shown in the following screenshot. Click on the hyperlink to open the PDF file in Drive:</p><div><img alt="Converting Sheet data as a PDF file" src="img/B05010_07_07.jpg"/></div><p>A sample output of the created PDF as per the Sheet data is shown in the following screenshot. The output may vary as per your input data:</p><div><img alt="Converting Sheet data as a PDF file" src="img/B05010_07_08.jpg"/></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec65"/>Sending an HTTP/HTTPS request with query string</h1></div></div></div><p>You can send an HTTP/HTTPS request along with the query string. To do this, append the published URL with<a class="indexterm" id="id315"/> your query<a class="indexterm" id="id316"/> string.</p><p>For example: <code class="literal">https://script.google.com/macros/s/AKfycbxa4ErKHiX_0gQ0JUU-Q1qMhvRrOsrx3HXuVZp7pzX8UVxMu4w/exec?</code><strong>fname=John</strong>
</p><div><pre class="programlisting">function doGet(e){
  Logger.log(e);
}</pre></div><p>A sample of the logged HTTP/HTTPS request's <code class="literal">event</code> object is shown here:</p><div><img alt="Sending an HTTP/HTTPS request with query string" src="img/B05010_07_09.jpg"/></div><p>The <code class="literal">doGet</code> function listed in the following code snippet shows how you can use the <code class="literal">event</code> object to get<a class="indexterm" id="id317"/> the required parameters for<a class="indexterm" id="id318"/> further processing:</p><div><pre class="programlisting">function doGet(e){
  
  // Get the fname value from the query string.
  var firstName = e.parameter.fname;
  
  /*
   *  There is no active spreadsheet, so you should open by id.
   *  Use the id of the spreadsheet in which your script resides.
   *
   */
  var ss = SpreadsheetApp.openById("Replace spreadsheet id");

  var SheetData = ss.getSheetByName("Data");
  
  var data = SheetData.getDataRange().getValues();
  
  // Remove header
  data.shift();
  
  var date = new Date();

  // Let's get the year in 4 digits.
  var currYear = date.getFullYear();
  
  var output = {};
  
  // Let's populate output with dob and age properties.
  data.forEach(function(row){
    
    // Skip if first name not match.
    if(firstName !== row[0]) return;
    
    var dob = new Date(row[3]);
    var dobYear = dob.getFullYear();
    
    output[row[2]] = {};
    output[row[2]].dob = Utilities
      .formatDate(row[3], "UTC", "MM/dd/yyyy");

    output[row[2]].age = currYear - dobYear;
  });
  
  var json = JSON.stringify(output);
  
  return ContentService.createTextOutput(json);
}</pre></div><p>The mentioned<a class="indexterm" id="id319"/> <code class="literal">doGet</code> function gets the <code class="literal">fname</code> parameter<a class="indexterm" id="id320"/> from the query string and returns the calculated <code class="literal">age</code> value along with <code class="literal">dob</code> for matching <code class="literal">fname</code>.</p><div><img alt="Sending an HTTP/HTTPS request with query string" src="img/B05010_07_10.jpg"/></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec66"/>Creating RSS feed using ContentService</h1></div></div></div><p>You created an RSS<a class="indexterm" id="id321"/> reader application in <a class="link" href="ch06.html" title="Chapter 6. Creating Feed Reader and Translator Applications">Chapter 6</a>, <em>Creating Feed Reader and Translator Applications</em>. Now, you can create an application to publish an<a class="indexterm" id="id322"/> RSS feed. Put the RSS data in a Sheet as shown here:</p><div><img alt="Creating RSS feed using ContentService" src="img/B05010_07_11.jpg"/></div><p>Also, edit/enter the<a class="indexterm" id="id323"/> following <code class="literal">doGet</code> function:</p><div><pre class="programlisting">function doGet() {
  /*
   *  There is no active spreadsheet, so you should open by id.
   *  Use the id of the spreadsheet in which your script resides.
   *
   */
  var ss = SpreadsheetApp.openById([[ this spreadsheet id ]]);
  
  var SheetRss = ss.getSheetByName("RSS Data");

  var rssData = SheetRss.getDataRange().getValues();
  
  // Remove header.
  rssData.shift();
  
  var strRss = '&lt;?xml version="1.0" encoding="UTF-8"?&gt;';
  
  // Root element.
  strRss += '&lt;rss&gt;';
  
  // Open channel element.
  strRss += '&lt;channel&gt;';
  
  // Add description and language elements.
  strRss += '&lt;description&gt;A brief description of the channel&lt;/description&gt;';
  strRss += '&lt;language&gt;en-US&lt;/language&gt;';
  
  // Each row data is passed as an argument to the anonymous
  //function.
  rssData.forEach(function(row){
    strRss += '&lt;item&gt;';
    strRss += '&lt;title&gt;' + row[0] + '&lt;/title&gt;';
    strRss += '&lt;link&gt;' + row[1] + '&lt;/link&gt;';
    strRss += '&lt;creator&gt;' + row[2] + '&lt;/creator&gt;';
    strRss += '&lt;/item&gt;';
  });
  
  // Close channel and root (rss) elements.
  strRss += '&lt;/channel&gt;&lt;/rss&gt;';
  
  // Return as RSS xml document.
  return ContentService
    .createTextOutput(strRss)
    .setMimeType(ContentService.MimeType.RSS);
}</pre></div><p>Publish the script <a class="indexterm" id="id324"/>as you did before. You can use the published URL as the RSS URL in your RSS reader application built in the previous chapter.</p></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec67"/>Creating a file upload application</h1></div></div></div><p>You can create an <a class="indexterm" id="id325"/>application to upload any file to Drive from the browser. Create the <code class="literal">doGet</code> and <code class="literal">uploadFiles</code> functions in the <code class="literal">Code.gs</code> file as listed here:</p><p>In the <code class="literal">Code.gs</code> file, add this code:</p><div><pre class="programlisting">function doGet() {
  // Let's return html page created from the Form.html file.
  return HtmlService.createHtmlOutputFromFile('Form.html')
    .setTitle("File Upload");
};

function uploadFiles(form) {
  // You can change the folder name as you like.
  var folderName = "Uploaded Files";

  var folder, folders = DriveApp.getFoldersByName(folderName);
  
  // folders is an iterator.
  if (folders.hasNext()) folder = folders.next();
  // Let's create a folder if it does not exist.
  else folder = DriveApp.createFolder(folderName);
  
  // Let's create the file, got from the form, within the folder.
  var file = folder.createFile(form.file);

  // Let's return the file's url
  return file.getUrl();
}</pre></div><p>The <code class="literal">uploadFiles</code> function looks for an existing folder with the name <code class="literal">Uploaded Files</code>. If not found, then<a class="indexterm" id="id326"/> it creates the same within root, <code class="literal">My Drive,</code> folder. Subsequently, it creates the file passed with the argument and returns the created file's URL.</p><p>Update the code in the <code class="literal">Form.html</code> file:</p><div><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;base target="_top"&gt;

    &lt;link rel="stylesheet" href="//ssl.gstatic.com/docs/script/css/add-ons1.css"/&gt;
    &lt;script src="img/jquery.min.js"&gt;&lt;/script&gt;
  &lt;/head&gt;

  &lt;body&gt;
    &lt;div class="sidebar"&gt;
      &lt;form&gt;
        &lt;input type="file" name="file"&gt;
        &lt;br /&gt;&lt;br /&gt;
        &lt;input type="button" id="upload" class="submit" value="Upload"&gt;
      &lt;/form&gt;
    &lt;/div&gt;
    
    &lt;script&gt;
      $(function(){
        $("#upload").click(fileUpload);
      });
      
      function fileUpload(){
        this.disabled = true;
        google.script.run
          .withSuccessHandler(function(msg, element){
             element.disabled = false;
             showSucces(msg);
           })
          .withFailureHandler(function(msg, element) {
             element.disabled = false;
             showError(msg, element);
           })
          .withUserObject(this)
          .uploadFiles(this.parentNode);
      }

      function showSucces(msg) {
        alert("File uploaded successfully.\n The file url is: " + msg);
      }
      
      function showError(msg, element) {
        var div = $('&lt;div id="error" class="error"&gt;' + msg + '&lt;/div&gt;');

        $(element).after(div);
      }

    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div><p>The preceding code<a class="indexterm" id="id327"/> renders the upload form controls, and if <strong>Upload</strong> is clicked, then it calls the <code class="literal">uploadFiles</code> server function.</p><p>A sample of the file upload form's controls is shown here:</p><div><img alt="Creating a file upload application" src="img/B05010_07_12.jpg"/></div><p>Click on the <strong>Browse…</strong> button to select any file stored locally. Then, click on the <strong>Upload</strong> button to upload to Drive. The selected file will be uploaded to the <code class="literal">Uploaded Files</code> folder within the <code class="literal">My Drive</code> folder.</p><p>After a successful <a class="indexterm" id="id328"/>upload, an alert box with the uploaded file's URL will be displayed as shown in the following screenshot. You can use the URL to verify the successful file upload.</p><div><img alt="Creating a file upload application" src="img/B05010_07_13.jpg"/></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec68"/>Creating an employee timesheet application</h1></div></div></div><p>From the knowledge<a class="indexterm" id="id329"/> and experience gathered by creating the preceding applications, you can create this full blown timesheet application. This application can be used in an organization or company to log employees, worked hours in a day or shift. The daily attendance data will be backed in the <code class="literal">Backup</code> Sheet for future reference.</p><p>Create a new spreadsheet with a Sheet named <code class="literal">EmployeesList</code> and populate it with employee names. All these names will be listed as a dropdown automatically in the user interface.</p><div><img alt="Creating an employee timesheet application" src="img/B05010_07_14.jpg"/></div><p>Create another Sheet named <code class="literal">TimeSheet</code> and arrange the column headers as shown in the following screenshot. Ensure columns <em>C</em>, <em>D</em>, <em>E</em>, and <em>F</em> are formatted as <code class="literal">date</code>, otherwise date may be shown as<a class="indexterm" id="id330"/> epoch number. Leave column <em>A</em> blank as it will be used by the script to mark the status of a shift such as <code class="literal">sb</code> (shift begin), <code class="literal">bb</code> (break begin), <code class="literal">be</code> (break end), and <code class="literal">se</code> (shift end).</p><div><img alt="Creating an employee timesheet application" src="img/B05010_07_15.jpg"/></div><p>Create another Sheet<a class="indexterm" id="id331"/> with the name <code class="literal">Backup</code>, which is used to back up every day's shift data from the <code class="literal">TimeSheet</code> Sheet. Arrange the columns as shown here. Remember to format columns <em>B</em>, <em>C</em>, <em>D</em>, and <em>E</em> as <code class="literal">date</code>.</p><div><img alt="Creating an employee timesheet application" src="img/B05010_07_16.jpg"/></div><p>Create another new Sheet and name it as <code class="literal">Message</code>, which will be used to pass a message, if any, to employees:</p><div><img alt="Creating an employee timesheet application" src="img/B05010_07_17.jpg"/></div><p>In the <code class="literal">Code.gs</code> file, create the global variables as well as the <code class="literal">doGet</code> and <code class="literal">getEmpNames</code> functions. Replace <code class="literal">[[ this spreadsheet id ]]</code> with the actual ID/key (as a string) of the spreadsheet in which you are editing the code:</p><div><pre class="programlisting">var ssid = "[[ this spreadsheet id ]]";

// Change date format as per your preference.
var DF = "MM/dd/yyyy HH:mm:ss";
var TZ = Session.getScriptTimeZone();

var ss = SpreadsheetApp.openById(ssid);
var TimeSheet = ss.getSheetByName("TimeSheet");
var EmpSheet = ss.getSheetByName("EmployeesList");
var BackupSheet = ss.getSheetByName("Backup");
var MessageSheet = ss.getSheetByName("Message");</pre></div><p>This <code class="literal">getEmpList</code> function<a class="indexterm" id="id332"/> creates and returns employee names as an array:</p><div><pre class="programlisting">/**
 *  Get employee names from the EmployeesList sheet,
 *  construct the data as an array and return.
 *
 */
function getEmpList(){
  var emp = [];
  var data = EmpSheet.getDataRange().getValues();
  
  for(var i in data) if(data[i][0]) emp.push(data[i][0]);
  
  return emp;
}</pre></div><p>In the <code class="literal">doGet</code> function, the message and employee list are assigned to the <code class="literal">template</code> object and returns evaluated HTML content:</p><div><pre class="programlisting">function doGet(){
  var template = HtmlService.createTemplateFromFile("Timesheet");
  template.message = MessageSheet.getRange("A2").getValue();
  template.empList = getEmpList();
  
  var html = template.evaluate();
  return html;
}</pre></div><p>This <code class="literal">getEmpStatus</code> function<a class="indexterm" id="id333"/> returns employee shift status as an array:</p><div><pre class="programlisting">// Returns employee shift status as an array [status, name].
function getEmpStatus(emp){
  var empData = EmpSheet.getDataRange().getValues();
  var timeData = TimeSheet.getDataRange().getValues();
  
  // Remove header
  timeData.shift();
  
  for(var i in timeData){
    if(timeData[i][1] == emp) 
      return [timeData[i][0],empData[j][1]];
  }
  
  // Return null if employee not in shift
  return ["",""];
}</pre></div><p>The <code class="literal">fmtDate_</code> function is a helper function that returns the formatted date string:</p><div><pre class="programlisting">function fmtDate_(d, format){
  // Set the default date format, if 'format' not passed.
  var fmt = format || DF;

  return Utilities.formatDate(d, TZ, fmt);
}</pre></div><p>The <code class="literal">postTime</code> function populates timesheet with respect to the employee name and what button he/she has clicked and these values are supplied as an argument (<code class="literal">name</code> and <code class="literal">val</code>). This function also throws errors, if any.</p><div><div><h3 class="title"><a id="note19"/>Note</h3><p>The keyword<a class="indexterm" id="id334"/> throw returns an error <a class="indexterm" id="id335"/>object and terminates the execution.</p></div></div><div><pre class="programlisting">function postTime(name, val){
  var time = fmtDate_(new Date());
  var data = TimeSheet.getDataRange().getValues();
  
  // If 'shift start' clicked
  if(val == "sb"){
    // Update start time if clicked again.
    for(var i in data){
      if(data[i][1] == name &amp;&amp; data[i][0] == "sb" ){
        data[i][2] = time;
        TimeSheet.getRange(1, 1, data.length, data[0].length)
          .setValues(data);
        return [val,name];
      }
    };
    
    // Else insert new name and update start time.
    TimeSheet.appendRow([val,name,time]);
    
    return [val,name];
  }

  // If 'break start' clicked.
  if(val == "bb"){
    for(var i in data){
      // Update break start time only if employee is in shift.
      if(data[i][0] == "sb" &amp;&amp; data[i][1] == name ){
        data[i][0] = val;
        data[i][3] = time;

        TimeSheet.getRange(1, 1, data.length, data[0].length)
          .setValues(data);

        return [val,name];
      }
    };
    
    // If 'break start' clicked before 'shift start'.
    throw "Please start your shift.";
  }

  // If 'break end' clicked
  if(val == "be"){
    for(var i in data){
      if(data[i][0] == "bb" &amp;&amp; data[i][1] == name ){
        data[i][0] = val;
        data[i][4] = time;
        TimeSheet.getRange(1, 1, data.length, data[0].length)
          .setValues(data);
        return [val,name];
      }
    };
    
    // If 'break end' clicked before 'break start'.
    throw "Please start your break.";
  }

  // If shift end clicked
  if(val == "se"){
    for(var i in data){
      if(data[i][1] == name 
           &amp;&amp; (data[i][0] == "sb"|| data[i][0] == "be") ){
        var backup = [];
        backup.push(
          data[i][1],    // Name
          data[i][2],    // Shift Start
          data[i][3],    // Break Start
          data[i][4],    // Break End
          time,          // Shift end
          '=(E2-B2)*24', // Col F formula,
          '=(D2-C2)*24', // Col G formula
          '=F2-G2'       // Col H formula
        );
        
        /*
         * Copy Timesheet data to Backup sheet.
         * Insert a new row before row 2,
         * so that the inserted formulas ever work.
         *
         */
        BackupSheet.insertRowBefore(2);

        BackupSheet.getRange(2, 1, 1, backup.length)
          .setValues([backup]);
        
        /*
         * Tidy timesheet.
         * Ensure at least one data row before deleting,
         *  to avoid error.
         *
         */
        if(i&lt;2) TimeSheet.appendRow(['']);
        
        // Delete copied row
        TimeSheet.deleteRow(Number(i)+1);
        
        return [val,name];
      }
    };
    
    // If 'shift end' clicked before 'break end'.
    if(data[i][0] == "bb")
      throw "Please end your break.";
    
    // If 'shift end' clicked without starting shift.
    throw "Please start your shift.";
  }
}</pre></div><p>The preceding <code class="literal">postTime</code> function populates data to the <code class="literal">TimeSheet</code> Sheet as per the button clicked by the user. Also, it throws errors if there are any conflicts in the shift time. For example, a user cannot click on <strong>Break End</strong> before <strong>Break Start</strong> and cannot click on <strong>Shift Start</strong> without<a class="indexterm" id="id336"/> ending the previous shift, and so on.</p><p>Create a new HTML file named as <code class="literal">Timesheet</code> and enter the following code in it:</p><div><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;base target="_top"&gt;
    &lt;link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons.css" /&gt;
    &lt;script src="img/jquery.min.js"&gt;&lt;/script&gt;
  &lt;/head&gt;
  
  &lt;body&gt;
    &lt;div&gt;
      &lt;fieldset style="padding-bottom:25px;"&gt;
        &lt;legend&gt;Timesheet&lt;/legend&gt;
        &lt;select id="employee" name="employee"&gt;
          &lt;? for(var i in empList){ ?&gt;
              &lt;option value="&lt;?= empList[i] ?&gt;" &gt; &lt;?= empList[i] ?&gt;&lt;/option&gt;
          &lt;? } ?&gt;
        &lt;/select&gt;
        &lt;br /&gt;&lt;br /&gt;
        &lt;button id="sb" value="sb"&gt;&lt;span&gt;Shift Start&lt;/span&gt;&lt;/button&gt;

        &lt;button id="bb" value="bb"&gt;&lt;span&gt;Break Start&lt;/span&gt;&lt;/button&gt;

        &lt;button id="be" value="be"&gt;&lt;span&gt;Break End&lt;/span&gt;&lt;/button&gt;
        &lt;button id="se" value="se"&gt;&lt;span&gt;Shift End&lt;/span&gt;&lt;/button&gt;
      &lt;/fieldset&gt;

      &lt;fieldset&gt;
        &lt;div id="message"&gt;&lt;?!= message ?&gt;&lt;/div&gt;
      &lt;/fieldset&gt;
    &lt;/div&gt;

    &lt;script&gt;
      $(function() {
        // Disable all buttons.
        $('#sb,#bb,#be,#se').prop("disabled", true);
        
        // Set drop-down change event.
        $('#employee').change(getStatus);
        
        // Set buttons click event.
        $('#sb,#bb,#be,#se').click(postTime);
        
        getStatus();
      });

      function getStatus(){
        // Remove all previous error messages.
        $('#error,#success').remove();
        
        // Disable all buttons.
        $('#sb,#bb,#be,#se').prop("disabled", true);
        
        // Get employee shift status.
        google.script.run
          .withSuccessHandler(function(status){
            updateStatus(status);
           })
          .getEmpStatus($("#employee").val());
      }
      
      
      function postTime(){
        // Remove all previous error messages.
        $('#error,#success').remove();
        
        // Disable all buttons.
        $('#sb,#bb,#be,#se').prop("disabled", true);
        
        // Post shift time to sheet.
        google.script.run
          .withSuccessHandler(function(msg){
             updateStatus(msg[0]);
           })
          .withFailureHandler(function(msg, elm){
             showError(msg, elm);
           })
          .withUserObject(this)
          .postTime($("#employee").val(),$(this).val());
      }
      
      
      function updateStatus(status){
        // Enable appropriate buttons only.
        switch(status){
          case "sb": $('#bb,#se').prop("disabled", false); break;
          case "bb": $('#be').prop("disabled", false); break;
          case "be": $('#se').prop("disabled", false); break;
          default: $('#sb').prop("disabled", false);
        }      
      }
      
      
      function showError(msg, elm) {
        var span = $('&lt;span id="error" class="error"&gt;' + msg + '&lt;/span&gt;');
        $(elm).after(span);
      }
      
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div><p>Publish the script and enter the published URL in the browser's address bar, then you will get the timesheet application loaded as shown in the screenshot. Experiment by selecting employee names from the<a class="indexterm" id="id337"/> dropdown and by clicking on buttons next to it. For every user action, the <code class="literal">Timesheet</code> and/or <code class="literal">Backup</code> Sheet data will be updated.</p><div><img alt="Creating an employee timesheet application" src="img/B05010_07_18.jpg"/></div><p>A sample output of the <code class="literal">Timesheet</code> data is shown here:</p><div><img alt="Creating an employee timesheet application" src="img/B05010_07_19.jpg"/></div><p>As soon as the user clicks on <strong>Shift End</strong>, then the corresponding data from the <code class="literal">TimeSheet</code> Sheet will<a class="indexterm" id="id338"/> be transferred to the <code class="literal">Backup</code> Sheet and formulas will be created for the <code class="literal">Shift Hours</code>, <code class="literal">Break Time</code>, and <code class="literal">Worked Hours</code> columns. These formulas calculate the date difference and multiply it by 24 to show it as an hour value. A sample output of the <code class="literal">Backup</code> Sheet is shown here:</p><div><img alt="Creating an employee timesheet application" src="img/B05010_07_20.jpg"/></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec69"/>Summary</h1></div></div></div><p>In this chapter, you learned and created many useful real-life applications including RSS publisher and a full-blown timesheet application. In the next chapter, you will create an order processing workflow application.</p></div></body></html>