<html><head></head><body>
        

                            
                    <h1 class="header-title">Finding and Working with Geographic Data</h1>
                
            
            
                
<p>We have spent a significant amount of time creating and interacting with maps in our previous chapters. In all our examples, the geographic data was included. In this chapter, we will explain how to find geographic data about any country in the world.</p>
<p>There are typically two sets of data that we will need to create a map in D3:</p>
<ul>
<li>A dataset that represents the geographic shape of our map (geodata)</li>
<li>Some meaningful data that we want to visualize on the map (for example, population density by US countries, or unemployment rate by countries in the world)</li>
</ul>
<p>This chapter is focused on understanding, manipulating, and optimizing geodata for map visualizations. We will accomplish these goals by:</p>
<ul>
<li>Explaining three important formats that contain geospatial vector data</li>
<li>Finding, downloading, and working with large amounts of map data</li>
<li>Using techniques to build the right geodata file for your map</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Geodata file types</h1>
                
            
            
                
<p>There are dozens of file formats that represent geographic information. In this section, we will focus on three file types: shapefiles, GeoJSON, and TopoJSON.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">What are shapefiles and how do I get them?</h1>
                
            
            
                
<p>Shapefiles are the most popular vector-based file format. They contain polygons and lines that represent geographic boundaries. The shapefile format was developed by the company Esri as an open standard to work with <strong>geographic information systems</strong> (<strong>GIS</strong>). This vector information can also describe other geographic entities (rivers, lakes, and railroads). In addition, the file format has the ability to store data attributes that are useful when working with visualizations (for example, the name of the geographic object, the type, and some relationships). Most importantly for us, there is a large repository of free shapefiles located at <a href="http://diva-gis.org">http://diva-gis.org</a>. This repository contains a tremendous wealth of data at different levels of specificity and granularity.</p>
<p>Unfortunately for us, shapefiles are in binary format and can be very large. This makes them very difficult, if not impossible, to use in standard web development. Thankfully, there are some tools to help us leverage the large repository of shapefiles and convert them to GeoJSON and TopoJSON. GeoJSON and TopoJSON are JavaScript-friendly, much smaller, and easier to use in our web development context. In the previous chapters, all of the geographic data was provided in TopoJSON.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Acquiring shapefiles for a specific country</h1>
                
            
            
                
<p>Let's start with a map of Spain and go through the process of getting our first shapefile:</p>
<ol>
<li>
<p>Go to <a href="http://www.diva-gis.org/gdata">http://www.diva-gis.org/gdata</a> and select Spain from the drop-down list, as shown in the following screenshot:</p>
<div><img height="252" width="314" src="img/4f3a34fa-cee1-4148-8c70-7e6898af70ba.png"/></div>
</li>
</ol>
<ol>
<li>
<p>Once Spain is selected, you will see a large selection of geographic data to choose from (Roads, Railroads, and so on). Select the Administrative areas option to draw the primary boundaries of the country and regions. Click on OK; it will take you to the download page.</p>
</li>
<li>
<p>Once it's downloaded, you will have an <kbd>ESP_adm.zip</kbd> file containing the shapefile data for the administrative areas of Spain.</p>
</li>
<li>
<p>After unzipping the file, you will see that the files are organized into progressively increasing numbers, <kbd>ESP_adm0</kbd> to <kbd>ESP_adm4</kbd>. ESP represents the abbreviation of the country and each number represents the increasing amount of detail found in each data file. For example, <kbd>ESP_adm0</kbd> will draw just the outline of Spain, while <kbd>ESP_adm3</kbd> will include the provinces of the country.</p>
</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">GeoJSON</h1>
                
            
            
                
<p>GeoJSON is a specific JSON format for describing geographic data structures. It is important to know that GeoJSON does the following:</p>
<ul>
<li>Contains all the information required to draw geographic data.</li>
<li>Is a standard JSON format and can be used instantly in JavaScript when building for the web.</li>
<li>Is required by D3 when defining our <kbd>d3.geo.path</kbd> function, as seen in the previous chapters.</li>
<li>Discretely defines each geographic shape. For example, if two countries share a border, the GeoJSON file will completely define both countries, therefore defining the border twice. It does not provide any mechanisms to optimize the data file.</li>
</ul>
<p>Because D3 relies on GeoJSON, we will explain some of the highlights of the specification. For a complete explanation, please see <a href="http://geojson.org">http://geojson.org</a>.</p>
<p>Typically, you will not incorporate the GeoJSON file directly in your D3 work. TopoJSON, explained in the next section, offers a more compact solution. However, it is still important to understand the specification, so let's walk through the GeoJSON of Spain:</p>
<pre>{ 
    "type": "FeatureCollection", 
    "features": [ 
        { 
            "type": "Feature", 
            "properties": { 
                "GADMID": 70, 
                "ISO": "ESP", 
                "NAME_ENGLI": "Spain", 
                "NAME_ISO": "SPAIN", 
                "NAME_FAO": "Spain", 
                "NAME_LOCAL": "España", 
                ... 
            }, 
            "geometry": { 
                "type": "MultiPolygon", 
                "coordinates": [ 
                    [ 
                        [ 
                            [ 
                                0.518472, 
                                40.53236 
                            ], 
                            [ 
                                0.518194, 
                                40.53236 
                            ], 
                            ... 
                        ] 
                    ] 
                ] 
            } 
        } 
    ] 
} </pre>
<p>The first property of the JSON object identifies the GeoJSON file as a collection of features (<kbd>FeatureCollection</kbd>). Each member of the collection (the array in the preceding <kbd>features</kbd> property) holds a specially formatted JSON object called a <kbd>feature</kbd>. The <kbd>d3.geo.path</kbd> function that we used in the previous chapters knows how to convert the <kbd>feature</kbd> object into a polygon using an SVG path. By iterating over an array of these features and drawing each polygon one by one, we create a D3 map.</p>
<p>The <kbd>feature</kbd> object must adhere to the following properties in order for D3 to convert the object into a polygon:</p>
<ul>
<li>
<p><kbd>geometry</kbd>: This is another GeoJSON specification that contains types and coordinates that indicate exactly how to draw the shape. We will not spend a lot of time explaining exactly how the specification draws the object. D3 will do all the hard work for us. Leveraging the enter/update/exit pattern, we pass a special <kbd>d3.geo.path</kbd> function to each feature. This function will take the geometry information about the feature and create the shape for us automatically.</p>
</li>
<li>
<p class="CDPAlignLeft CDPAlign"><kbd>properties</kbd>: This is any additional data to be attached to the feature. This is a typical name/value pair JSON object. In the preceding example, the <kbd>properties</kbd> attribute is leveraged to store the name of the country. This is very helpful when we need to find the country later to bind additional data to the visualization. See the following screenshot for examples of properties that can be bound to a feature object:</p>
<div><img height="285" width="409" src="img/1f1de33e-82ab-4547-9695-b1c01d9306b6.png"/></div>
</li>
<li><kbd>id</kbd>: This is a placeholder that can be leveraged to store a unique identifier to the particular feature in the collection.</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">A quick map in D3 with only GeoJSON</h1>
                
            
            
                
<p>For a moment, let's pretend that TopoJSON does not exist and illustrate how only GeoJSON can be used to create a map. This will help illustrate the need for TopoJSON in the next section. The following code snippet is a quick example to tie everything together; you can also open <kbd>example-1.html</kbd> from the <kbd>chapter-6</kbd> folder (<kbd>http://localhost:8080/chapter-6/example-1.html</kbd>) to see the map in your browser of the following code:</p>
<pre>  d3.json('geojson/spain-geo.json', function(data) { 
    var b, s, t; 
    projection.scale(1).translate([0, 0]); 
    var b = path.bounds(data); 
    var s = .9 / Math.max((b[1][0] - b[0][0]) / width, <br/>     (b[1][1] - b[0][1]) / height);    <br/>     var t = [(width - s * (b[1][0] +<br/>     b[0][0])) / 2, <br/>     (height - s * (b[1][1] + b[0][1])) / 2]; 
    projection.scale(s).translate(t); 
 
    map = svg.append('g').attr('class', 'boundary'); 
    spain = map.selectAll('path').data(data.features); </pre>
<p>Notice that the code is almost identical to the examples in the previous chapters. The only exception is that we are not calling the <kbd>topojson</kbd> function (we will cover why <kbd>topojson</kbd> is important next). Instead, we are passing the data from the AJAX call directly into the <em>data join</em> for the following <kbd>enter()</kbd> call:</p>
<pre>    spain.enter() 
       .append('path') 
       .attr('d', path); 
 
 }); </pre>
<p>As predicted, we have our map of Spain:</p>
<div><img src="img/a1aec861-0596-499a-83e0-6a6e706191fd.png"/></div>
<p>While using GeoJSON directly may seem like the best approach, there are some problems. Primarily, a one-to-one conversion of an Esri shapefile to the GeoJSON format contains a lot of detail that is probably unnecessary and will create a huge GeoJSON file. The larger the file, the more time it will take to download. For example, <kbd>spain-geo.json</kbd> produced an almost 7 MB GeoJSON file.</p>
<p>Next, we will explore how TopoJSON can help by modifying several optimization levers while still maintaining significant details.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">TopoJSON basics</h1>
                
            
            
                
<p>TopoJSON is another JSON-based format that encodes geographic data. If you remember, GeoJSON describes geographic data discretely. This means GeoJSON borders can be described twice. The TopoJSON format removes this duplicate behavior, often creating files that are 80 percent smaller. This format is extremely helpful when building for the web, where data transfer size plays an important role.</p>
<p>The term TopoJSON can be confusing. Let's break it down into its three dimensions:</p>
<ul>
<li><strong>TopoJSON, the serialized format</strong>: The actual serialized JSON format that describes how to draw geographic shapes.</li>
<li><strong>topojson, the command-line utility</strong>: This is a program that a user can run to create TopoJSON files from shapefiles. The utility contains many levers to further reduce the size of the file.</li>
<li><strong>topojson.js, the JavaScript library</strong>: The library used in your D3 map to convert the TopoJSON-serialized format back to GeoJSON, so that the <kbd>d3.geo.path</kbd> functions work correctly.</li>
</ul>
<p>To illustrate to what extent TopoJSON can reduce the file size, let's execute the command-line utility against the shapefiles we downloaded earlier. Open the command line and execute the following in the same directory where you downloaded and unzipped the <kbd>ESP_adm.zip</kbd> file:</p>
<pre>topojson -o spain-topo.json -p -- ESP_adm0.shp
  </pre>
<p>This command creates a new TopoJSON-formatted file named <kbd>spain-topo.json</kbd><br/>
and preserves all the data properties (the <kbd>-p</kbd> flag) from the <kbd>ESP_adm0</kbd> shapefile<br/>
(note that the shapefile needs to come after the <kbd>--</kbd> in the command-line syntax).<br/>
The <kbd>-o</kbd> parameter defines the name of the resulting TopoJSON file.</p>
<p>First, let's compare file sizes with GeoJSON versus TopoJSON for the exact same geographic region:</p>
<ul>
<li>GeoJSON: 6.4 MB</li>
<li>TopoJSON: 379 KB</li>
</ul>
<p>This is an incredible compression rate, and we just used the defaults!</p>
<p>In order to incorporate TopoJSON into our map, we need to use the <kbd>topojson.js</kbd> JavaScript library and alter a few lines of code. We will start with <kbd>example-1.html</kbd>. The final version can be viewed in <kbd>example-2.html</kbd> (<kbd>http://localhost:8080/chapter-6/example-2.html</kbd>):</p>
<pre>&lt;script src="img/topojson.v1.min.js"&gt;&lt;/script&gt; </pre>
<p>First, we add the JavaScript library as a <kbd>&lt;script&gt;</kbd> tag to our file. Now you know why we have been using this library all along:</p>
<pre>d3.json('topojson/spain-topo.json', function(data) { </pre>
<p>Next, we inject our <kbd>topojson</kbd> file that we just created via AJAX:</p>
<pre>var country = topojson.feature(data, data.objects.ESP_adm0); </pre>
<p>We add an additional line of code to convert the TopoJSON format to the GeoJSON feature format:</p>
<pre>var b = path.bounds(country); </pre>
<p>We need to remember to create our bounding box using the interpolated features:</p>
<pre>spain = map.selectAll('path').data(country.features); </pre>
<p>Now, we use the <em>data join</em> on our new data. As expected, we will see our map of Spain. Let's show them side by side in the following screenshot to compare GeoJSON and TopoJSON (with GeoJSON on the left and TopoJSON on the right):</p>
<div><img src="img/7206aacb-4946-41b4-a5ff-beb72e30b230.png"/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">TopoJSON command-line tips</h1>
                
            
            
                
<p>The TopoJSON command-line documentation is very complete (<a href="https://github.com/mbostock/topojson/wiki/Command-Line-Reference">https://github.com/mbostock/topojson/wiki/Command-Line-Reference</a>). However, here are a couple of quick and easy tips to get you started.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Preserving specific attributes</h1>
                
            
            
                
<p>In the GeoJSON section, we illustrated that data properties are often part of the geographic data. The <kbd>topojson</kbd> command gives you the ability to filter out the ones you are not interested in, as well as provide a better naming convention to the ones you do want to keep. These capabilities are in the <kbd>-p</kbd> flag and passed to the command. For example:</p>
<pre><strong>topojson -o spain-topo.json -p name=ISO -- ESP_adm0.shp  </strong></pre>
<p>We will create the TopoJSON file, remove all properties except ISO, and rename the ISO property to something easy to recognize. You can address multiple properties by comma-separating the list:</p>
<pre><strong>-p target=source,target=source,target=source </strong> </pre>


            

            
        
    

        

                            
                    <h1 class="header-title">Simplification</h1>
                
            
            
                
<p>Mike Bostock provides an excellent tutorial on simplification, and how it works, at <a href="http://bost.ocks.org/mike/simplify/">http://bost.ocks.org/mike/simplify/</a>.</p>
<p>Basically, it is a way to reduce geometric complexity through line-simplification algorithms. For example, if you do not need much detail in a very jagged coast of a country, you can apply line-simplification algorithms to smooth out the jaggedness and significantly reduce the size of the TopoJSON file. The command-line parameter you use is <kbd>-s</kbd> to adjust the simplification in the TopoJSON conversion:</p>
<pre><strong>-p  name=ISO -s 7e-7 -- ESP_adm0.shp</strong></pre>
<p>We typically realize that when dealing with shapefiles from DIVA-GIS, the best range is around 7e-7 to keep within the per-pixel threshold, which is less than the area of the map. At this range, the size compression is very significant and the map quality is still very acceptable for web development. Consider the following:</p>
<ul>
<li><strong>Original</strong>: 378 KB, great detail and quality:
<div><img src="img/b0f255d9-ee89-48e3-a11c-1bc58c048241.png"/></div>
</li>
<li><strong>Simplified at -s 7e-7</strong>: 3.6 KB and acceptable quality:
<div><img src="img/ed1bd98f-f84b-4c79-b5fd-649d03080af1.png"/></div>
</li>
<li><strong>Very simple at -s 7e-5</strong>: 568 bytes but the map is unrecognizable:
<div><img src="img/e2fea97e-d050-43dd-a42c-64796c5c982f.png"/></div>
</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Merging files</h1>
                
            
            
                
<p>The final tip involves merging multiple shapefiles into a single TopoJSON file. This is extremely useful if you need separate geographic information but want to fetch it in a single AJAX request. To append additional files, you add them after the <kbd>-</kbd> in the command line. Consider this command:</p>
<pre><strong>topojson -o ../topojson/spain-topo-simple.json -p  name=ISO -s 7e-7 -</strong><br/><strong>- ESP_adm0.shp ESP_adm1.shp </strong> </pre>
<p>It will produce the following object structure, where the data for <kbd>ESP_adm0</kbd> is the data for the country, and <kbd>ESP_adm1</kbd> is the data for the regions:</p>
<div><img src="img/03f298b1-106d-4f6c-8008-ab18f2922c15.png"/></div>
<p>There is also the opportunity to rename the object they will map to in the resulting TopoJSON file. Again, this can help create readable code. The renaming follows the same convention as renaming specific properties. For example, type in this command:</p>
<pre><strong>topojson -o ../topojson/spain-topo-simple.json -p  name=ISO -s 7e-7 -</strong><br/><strong>- country=ESP_adm0.shp regions=ESP_adm1.shp </strong> </pre>
<p>The preceding command will create the following:</p>
<div><img src="img/ae3f9b56-eb2b-465d-b93f-707363a7eed0.png"/></div>
<p>In this case, you would change your original code, which is as follows:</p>
<pre>var country = topojson.feature(data, data.objects.ESP_adm0); </pre>
<p>You have to change it to the following code:</p>
<pre>var country = topojson.feature(data, data.objects.country); </pre>
<p>This is much nicer to look at! Please look at <kbd>example-3.html</kbd> (<kbd>http://localhost:8080/chapter-6/example-3.html</kbd>) to see how all of this information can be tied together.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Summary</h1>
                
            
            
                
<p>At this point, you should feel confident that you can find and modify datasets to your needs. We've covered common locations from where you can acquire data, and we've touched on the different types of flags TopoJSON offers. With these skills, it is up to you to make sure your data is trimmed and is acquired to your visualization needs. This closes the circle of developing maps with D3. In the next chapter, we will refine your craft by focusing on testing your visualizations.</p>


            

            
        
    </body></html>