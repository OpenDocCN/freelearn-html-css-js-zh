<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Finding and Working with Geographic Data</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">We have spent a significant amount of time creating and interacting with maps in our previous chapters. </span><span class="koboSpan" id="kobo.2.2">In all our examples, the geographic data was included. </span><span class="koboSpan" id="kobo.2.3">In this chapter, we will explain how to find geographic data about any country in the world.</span></p>
<p><span class="koboSpan" id="kobo.3.1">There are typically two sets of data that we will need to create a map in D3:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.4.1">A dataset that represents the geographic shape of our map (geodata)</span></li>
<li><span class="koboSpan" id="kobo.5.1">Some meaningful data that we want to visualize on the map (for example, population density by US countries, or unemployment rate by countries in the world)</span></li>
</ul>
<p><span class="koboSpan" id="kobo.6.1">This chapter is focused on understanding, manipulating, and optimizing geodata for map visualizations. </span><span class="koboSpan" id="kobo.6.2">We will accomplish these goals by:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.7.1">Explaining three important formats that contain geospatial vector data</span></li>
<li><span class="koboSpan" id="kobo.8.1">Finding, downloading, and working with large amounts of map data</span></li>
<li><span class="koboSpan" id="kobo.9.1">Using techniques to build the right geodata file for your map</span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Geodata file types</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">There are dozens of file formats that represent geographic information. </span><span class="koboSpan" id="kobo.2.2">In this section, we will focus on three file types: shapefiles, GeoJSON, and TopoJSON.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">What are shapefiles and how do I get them?</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Shapefiles are the most popular vector-based file format. </span><span class="koboSpan" id="kobo.2.2">They contain polygons and lines that represent geographic boundaries. </span><span class="koboSpan" id="kobo.2.3">The shapefile format was developed by the company Esri as an open standard to work with </span><strong><span class="koboSpan" id="kobo.3.1">geographic information systems</span></strong><span class="koboSpan" id="kobo.4.1"> (</span><strong><span class="koboSpan" id="kobo.5.1">GIS</span></strong><span class="koboSpan" id="kobo.6.1">). </span><span class="koboSpan" id="kobo.6.2">This vector information can also describe other geographic entities (rivers, lakes, and railroads). </span><span class="koboSpan" id="kobo.6.3">In addition, the file format has the ability to store data attributes that are useful when working with visualizations (for example, the name of the geographic object, the type, and some relationships). </span><span class="koboSpan" id="kobo.6.4">Most importantly for us, there is a large repository of free shapefiles located at </span><a href="http://diva-gis.org"><span class="URLPACKT"><span class="koboSpan" id="kobo.7.1">http://diva-gis.org</span></span></a><span class="koboSpan" id="kobo.8.1">. </span><span class="koboSpan" id="kobo.8.2">This repository contains a tremendous wealth of data at different levels of specificity and granularity.</span></p>
<p><span class="koboSpan" id="kobo.9.1">Unfortunately for us, shapefiles are in binary format and can be very large. </span><span class="koboSpan" id="kobo.9.2">This makes them very difficult, if not impossible, to use in standard web development. </span><span class="koboSpan" id="kobo.9.3">Thankfully, there are some tools to help us leverage the large repository of shapefiles and convert them to GeoJSON and TopoJSON. </span><span class="koboSpan" id="kobo.9.4">GeoJSON and TopoJSON are JavaScript-friendly, much smaller, and easier to use in our web development context. </span><span class="koboSpan" id="kobo.9.5">In the previous chapters, all of the geographic data was provided in TopoJSON.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Acquiring shapefiles for a specific country</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Let's start with a map of Spain and go through the process of getting our first shapefile:</span></p>
<ol>
<li>
<p><span class="koboSpan" id="kobo.3.1">Go to </span><a href="http://www.diva-gis.org/gdata"><span class="URLPACKT"><span class="koboSpan" id="kobo.4.1">http://www.diva-gis.org/gdata</span></span></a><span class="koboSpan" id="kobo.5.1"> and select </span><span class="packt_screen"><span class="koboSpan" id="kobo.6.1">Spain</span></span><span class="koboSpan" id="kobo.7.1"> from the drop-down list, as shown in the following screenshot:</span></p>
<div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.8.1"><img height="252" width="314" src="assets/4f3a34fa-cee1-4148-8c70-7e6898af70ba.png"/></span></div>
</li>
</ol>
<ol>
<li>
<p><span class="koboSpan" id="kobo.9.1">Once </span><span class="packt_screen"><span class="koboSpan" id="kobo.10.1">Spain</span></span><span class="koboSpan" id="kobo.11.1"> is selected, you will see a large selection of geographic data to choose from (</span><span class="packt_screen"><span class="koboSpan" id="kobo.12.1">Roads</span></span><span class="koboSpan" id="kobo.13.1">, </span><span class="packt_screen"><span class="koboSpan" id="kobo.14.1">Railroads</span></span><span class="koboSpan" id="kobo.15.1">, and so on). </span><span class="koboSpan" id="kobo.15.2">Select the </span><span class="packt_screen"><span class="koboSpan" id="kobo.16.1">Administrative areas</span></span><span class="koboSpan" id="kobo.17.1"> option to draw the primary boundaries of the country and regions. </span><span class="koboSpan" id="kobo.17.2">Click on </span><span class="packt_screen"><span class="koboSpan" id="kobo.18.1">OK</span></span><span class="koboSpan" id="kobo.19.1">; it will take you to the download page.</span></p>
</li>
<li>
<p><span class="koboSpan" id="kobo.20.1">Once it's downloaded, you will have an </span><kbd><span class="koboSpan" id="kobo.21.1">ESP_adm.zip</span></kbd><span class="koboSpan" id="kobo.22.1"> file containing the shapefile data for the administrative areas of Spain.</span></p>
</li>
<li>
<p><span class="koboSpan" id="kobo.23.1">After unzipping the file, you will see that the files are organized into progressively increasing numbers, </span><kbd><span class="koboSpan" id="kobo.24.1">ESP_adm0</span></kbd><span class="koboSpan" id="kobo.25.1"> to </span><kbd><span class="koboSpan" id="kobo.26.1">ESP_adm4</span></kbd><span class="koboSpan" id="kobo.27.1">. </span><span class="koboSpan" id="kobo.27.2">ESP represents the abbreviation of the country and each number represents the increasing amount of detail found in each data file. </span><span class="koboSpan" id="kobo.27.3">For example, </span><kbd><span class="koboSpan" id="kobo.28.1">ESP_adm0</span></kbd><span class="koboSpan" id="kobo.29.1"> will draw just the outline of Spain, while </span><kbd><span class="koboSpan" id="kobo.30.1">ESP_adm3</span></kbd><span class="koboSpan" id="kobo.31.1"> will include the provinces of the country.</span></p>
</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">GeoJSON</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">GeoJSON is a specific JSON format for describing geographic data structures. </span><span class="koboSpan" id="kobo.2.2">It is important to know that GeoJSON does the following:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.3.1">Contains all the information required to draw geographic data.</span></li>
<li><span class="koboSpan" id="kobo.4.1">Is a standard JSON format and can be used instantly in JavaScript when building for the web.</span></li>
<li><span class="koboSpan" id="kobo.5.1">Is required by D3 when defining our </span><kbd><span class="koboSpan" id="kobo.6.1">d3.geo.path</span></kbd><span class="koboSpan" id="kobo.7.1"> function, as seen in the previous chapters.</span></li>
<li><span class="koboSpan" id="kobo.8.1">Discretely defines each geographic shape. </span><span class="koboSpan" id="kobo.8.2">For example, if two countries share a border, the GeoJSON file will completely define both countries, therefore defining the border twice. </span><span class="koboSpan" id="kobo.8.3">It does not provide any mechanisms to optimize the data file.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.9.1">Because D3 relies on GeoJSON, we will explain some of the highlights of the specification. </span><span class="koboSpan" id="kobo.9.2">For a complete explanation, please see </span><a href="http://geojson.org"><span class="URLPACKT"><span class="koboSpan" id="kobo.10.1">http://geojson.org</span></span></a><span class="koboSpan" id="kobo.11.1">.</span></p>
<p><span class="koboSpan" id="kobo.12.1">Typically, you will not incorporate the GeoJSON file directly in your D3 work. </span><span class="koboSpan" id="kobo.12.2">TopoJSON, explained in the next section, offers a more compact solution. </span><span class="koboSpan" id="kobo.12.3">However, it is still important to understand the specification, so let's walk through the GeoJSON of Spain:</span></p>
<pre><span class="koboSpan" id="kobo.13.1">{ 
    "type": "FeatureCollection", 
    "features": [ 
        { 
            "type": "Feature", 
            "properties": { 
                "GADMID": 70, 
                "ISO": "ESP", 
                "NAME_ENGLI": "Spain", 
                "NAME_ISO": "SPAIN", 
                "NAME_FAO": "Spain", 
                "NAME_LOCAL": "España", 
                ... 
            </span><span class="koboSpan" id="kobo.13.2">}, 
            "geometry": { 
                "type": "MultiPolygon", 
                "coordinates": [ 
                    [ 
                        [ 
                            [ 
                                0.518472, 
                                40.53236 
                            ], 
                            [ 
                                0.518194, 
                                40.53236 
                            ], 
                            ... 
                        </span><span class="koboSpan" id="kobo.13.3">] 
                    ] 
                ] 
            } 
        } 
    ] 
} </span></pre>
<p><span class="koboSpan" id="kobo.14.1">The first property of the JSON object identifies the GeoJSON file as a collection of features (</span><kbd><span class="koboSpan" id="kobo.15.1">FeatureCollection</span></kbd><span class="koboSpan" id="kobo.16.1">). </span><span class="koboSpan" id="kobo.16.2">Each member of the collection (the array in the preceding </span><kbd><span class="koboSpan" id="kobo.17.1">features</span></kbd><span class="koboSpan" id="kobo.18.1"> property) holds a specially formatted JSON object called a </span><kbd><span class="koboSpan" id="kobo.19.1">feature</span></kbd><span class="koboSpan" id="kobo.20.1">. </span><span class="koboSpan" id="kobo.20.2">The </span><kbd><span class="koboSpan" id="kobo.21.1">d3.geo.path</span></kbd><span class="koboSpan" id="kobo.22.1"> function that we used in the previous chapters knows how to convert the </span><kbd><span class="koboSpan" id="kobo.23.1">feature</span></kbd><span class="koboSpan" id="kobo.24.1"> object into a polygon using an SVG path. </span><span class="koboSpan" id="kobo.24.2">By iterating over an array of these features and drawing each polygon one by one, we create a D3 map.</span></p>
<p><span class="koboSpan" id="kobo.25.1">The </span><kbd><span class="koboSpan" id="kobo.26.1">feature</span></kbd><span class="koboSpan" id="kobo.27.1"> object must adhere to the following properties in order for D3 to convert the object into a polygon:</span></p>
<ul>
<li>
<p><kbd><span class="koboSpan" id="kobo.28.1">geometry</span></kbd><span class="koboSpan" id="kobo.29.1">: This is another GeoJSON specification that contains types and coordinates that indicate exactly how to draw the shape. </span><span class="koboSpan" id="kobo.29.2">We will not spend </span><span><span class="koboSpan" id="kobo.30.1">a lot of time explaining exactly how the specification draws the object. </span><span class="koboSpan" id="kobo.30.2">D3 will do all the hard work for us. </span><span class="koboSpan" id="kobo.30.3">Leveraging the enter/update/exit pattern, we pass a special</span></span> <kbd><span class="koboSpan" id="kobo.31.1">d3.geo.path</span></kbd> <span><span class="koboSpan" id="kobo.32.1">function to each feature. </span><span class="koboSpan" id="kobo.32.2">This function will take the geometry information about the feature and create the shape for </span></span><span><span class="koboSpan" id="kobo.33.1">us automatically.</span></span></p>
</li>
<li>
<p class="CDPAlignLeft CDPAlign"><kbd><span class="koboSpan" id="kobo.34.1">properties</span></kbd><span class="koboSpan" id="kobo.35.1">: This is any additional data to be attached to the feature. </span><span class="koboSpan" id="kobo.35.2">This is a typical name/value pair JSON object. </span><span class="koboSpan" id="kobo.35.3">In the preceding example, the </span><kbd><span class="koboSpan" id="kobo.36.1">properties</span></kbd><span class="koboSpan" id="kobo.37.1"> attribute is leveraged to store the name of the country. </span><span class="koboSpan" id="kobo.37.2">This is very helpful when we need to find the country later to bind additional data to the visualization. </span><span class="koboSpan" id="kobo.37.3">See the following screenshot for examples of properties that can be bound to a feature object:</span></p>
<div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.38.1"><img height="285" width="409" src="assets/1f1de33e-82ab-4547-9695-b1c01d9306b6.png"/></span></div>
</li>
<li><kbd><span class="koboSpan" id="kobo.39.1">id</span></kbd><span class="koboSpan" id="kobo.40.1">: This is a placeholder that can be leveraged to store a unique identifier to the particular feature in the collection.</span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">A quick map in D3 with only GeoJSON</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">For a moment, let's pretend that TopoJSON does not exist and illustrate how only GeoJSON can be used to create a map. </span><span class="koboSpan" id="kobo.2.2">This will help illustrate the need for TopoJSON in the next section. </span><span class="koboSpan" id="kobo.2.3">The following code snippet is a quick example to tie everything together; you can also open </span><kbd><span class="koboSpan" id="kobo.3.1">example-1.html</span></kbd><span class="koboSpan" id="kobo.4.1"> from the </span><kbd><span class="koboSpan" id="kobo.5.1">chapter-6</span></kbd><span class="koboSpan" id="kobo.6.1"> folder (</span><kbd><span class="koboSpan" id="kobo.7.1">http://localhost:8080/chapter-6/example-1.html</span></kbd><span class="koboSpan" id="kobo.8.1">) to see the map in your browser of the following code:</span></p>
<pre><span class="koboSpan" id="kobo.9.1">  d3.json('geojson/spain-geo.json', function(data) { 
    var b, s, t; 
    projection.scale(1).translate([0, 0]); 
    var b = path.bounds(data); 
    var s = .9 / Math.max((b[1][0] - b[0][0]) / width, </span><br/><span class="koboSpan" id="kobo.10.1">     (b[1][1] - b[0][1]) / height);    </span><br/><span class="koboSpan" id="kobo.11.1">     var t = [(width - s * (b[1][0] +</span><br/><span class="koboSpan" id="kobo.12.1">     b[0][0])) / 2, </span><br/><span class="koboSpan" id="kobo.13.1">     (height - s * (b[1][1] + b[0][1])) / 2]; 
    projection.scale(s).translate(t); 
 
    map = svg.append('g').attr('class', 'boundary'); 
    spain = map.selectAll('path').data(data.features); </span></pre>
<p><span class="koboSpan" id="kobo.14.1">Notice that the code is almost identical to the examples in the previous chapters. </span><span class="koboSpan" id="kobo.14.2">The only exception is that we are not calling the </span><kbd><span class="koboSpan" id="kobo.15.1">topojson</span></kbd><span class="koboSpan" id="kobo.16.1"> function (we will cover why </span><kbd><span class="koboSpan" id="kobo.17.1">topojson</span></kbd><span class="koboSpan" id="kobo.18.1"> is important next). </span><span class="koboSpan" id="kobo.18.2">Instead, we are passing the data from the AJAX call directly into the </span><em><span class="koboSpan" id="kobo.19.1">data join</span></em><span class="koboSpan" id="kobo.20.1"> for the following </span><kbd><span class="koboSpan" id="kobo.21.1">enter()</span></kbd><span class="koboSpan" id="kobo.22.1"> call:</span></p>
<pre><span class="koboSpan" id="kobo.23.1">    spain.enter() 
       .append('path') 
       .attr('d', path); 
 
 }); </span></pre>
<p><span class="koboSpan" id="kobo.24.1">As predicted, we have our map of Spain:</span></p>
<div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.25.1"><img src="assets/a1aec861-0596-499a-83e0-6a6e706191fd.png"/></span></div>
<p><span class="koboSpan" id="kobo.26.1">While using GeoJSON directly may seem like the best approach, there are some problems. </span><span class="koboSpan" id="kobo.26.2">Primarily, a one-to-one conversion of an Esri shapefile to the GeoJSON format contains a lot of detail that is probably unnecessary and will create a huge GeoJSON file. </span><span class="koboSpan" id="kobo.26.3">The larger the file, the more time it will take to download. </span><span class="koboSpan" id="kobo.26.4">For example, </span><kbd><span class="koboSpan" id="kobo.27.1">spain-geo.json</span></kbd><span class="koboSpan" id="kobo.28.1"> produced an almost 7 MB GeoJSON file.</span></p>
<p><span class="koboSpan" id="kobo.29.1">Next, we will explore how TopoJSON can help by modifying several optimization levers while still maintaining significant details.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">TopoJSON basics</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">TopoJSON is another JSON-based format that encodes geographic data. </span><span class="koboSpan" id="kobo.2.2">If you remember, GeoJSON describes geographic data discretely. </span><span class="koboSpan" id="kobo.2.3">This means GeoJSON borders can be described twice. </span><span class="koboSpan" id="kobo.2.4">The TopoJSON format removes this duplicate behavior, often creating files that are 80 percent smaller. </span><span class="koboSpan" id="kobo.2.5">This format is extremely helpful when building for the web, where data transfer size plays an important role.</span></p>
<p><span class="koboSpan" id="kobo.3.1">The term TopoJSON can be confusing. </span><span class="koboSpan" id="kobo.3.2">Let's break it down into its three dimensions:</span></p>
<ul>
<li><strong><span class="koboSpan" id="kobo.4.1">TopoJSON, the serialized format</span></strong><span class="koboSpan" id="kobo.5.1">: The actual serialized JSON format that describes how to draw geographic shapes.</span></li>
<li><strong><span class="koboSpan" id="kobo.6.1">topojson, the command-line utility</span></strong><span class="koboSpan" id="kobo.7.1">: This is a program that a user can run to create TopoJSON files from shapefiles. </span><span class="koboSpan" id="kobo.7.2">The utility contains many levers to further reduce the size of the file.</span></li>
<li><strong><span class="koboSpan" id="kobo.8.1">topojson.js, the JavaScript library</span></strong><span class="koboSpan" id="kobo.9.1">: The library used in your D3 map to convert the TopoJSON-serialized format back to GeoJSON, so that the </span><kbd><span class="koboSpan" id="kobo.10.1">d3.geo.path</span></kbd><span class="koboSpan" id="kobo.11.1"> functions work correctly.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.12.1">To illustrate to what extent TopoJSON can reduce the file size, let's execute the command-line utility against the shapefiles we downloaded earlier. </span><span class="koboSpan" id="kobo.12.2">Open the command line and execute the following in the same directory where you downloaded and unzipped the </span><kbd><span class="koboSpan" id="kobo.13.1">ESP_adm.zip</span></kbd><span class="koboSpan" id="kobo.14.1"> file:</span></p>
<pre><span class="koboSpan" id="kobo.15.1">topojson -o spain-topo.json -p -- ESP_adm0.shp
  </span></pre>
<p><span class="koboSpan" id="kobo.16.1">This command creates a new TopoJSON-formatted file named </span><kbd><span class="koboSpan" id="kobo.17.1">spain-topo.json</span></kbd><br/><span class="koboSpan" id="kobo.18.1">
and preserves all the data properties (the </span><kbd><span class="koboSpan" id="kobo.19.1">-p</span></kbd><span class="koboSpan" id="kobo.20.1"> flag) from the </span><kbd><span class="koboSpan" id="kobo.21.1">ESP_adm0</span></kbd><span class="koboSpan" id="kobo.22.1"> shapefile</span><br/><span class="koboSpan" id="kobo.23.1">
(note that the shapefile needs to come after the </span><kbd><span class="koboSpan" id="kobo.24.1">--</span></kbd><span class="koboSpan" id="kobo.25.1"> in the command-line syntax).</span><br/><span class="koboSpan" id="kobo.26.1">
The </span><kbd><span class="koboSpan" id="kobo.27.1">-o</span></kbd><span class="koboSpan" id="kobo.28.1"> parameter defines the name of the resulting TopoJSON file.</span></p>
<p><span class="koboSpan" id="kobo.29.1">First, let's compare file sizes with GeoJSON versus TopoJSON for the exact same geographic region:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.30.1">GeoJSON: 6.4 MB</span></li>
<li><span class="koboSpan" id="kobo.31.1">TopoJSON: 379 KB</span></li>
</ul>
<p><span class="koboSpan" id="kobo.32.1">This is an incredible compression rate, and we just used the defaults!</span></p>
<p><span class="koboSpan" id="kobo.33.1">In order to incorporate TopoJSON into our map, we need to use the </span><kbd><span class="koboSpan" id="kobo.34.1">topojson.js</span></kbd><span class="koboSpan" id="kobo.35.1"> JavaScript library and alter a few lines of code. </span><span class="koboSpan" id="kobo.35.2">We will start with </span><kbd><span class="koboSpan" id="kobo.36.1">example-1.html</span></kbd><span class="koboSpan" id="kobo.37.1">. </span><span class="koboSpan" id="kobo.37.2">The final version can be viewed in </span><kbd><span class="koboSpan" id="kobo.38.1">example-2.html</span></kbd><span class="koboSpan" id="kobo.39.1"> (</span><kbd><span class="koboSpan" id="kobo.40.1">http://localhost:8080/chapter-6/example-2.html</span></kbd><span class="koboSpan" id="kobo.41.1">):</span></p>
<pre><span class="koboSpan" id="kobo.42.1">&lt;script src="http://d3js.org/topojson.v1.min.js"&gt;&lt;/script&gt; </span></pre>
<p><span class="koboSpan" id="kobo.43.1">First, we add the JavaScript library as a </span><kbd><span class="koboSpan" id="kobo.44.1">&lt;script&gt;</span></kbd><span class="koboSpan" id="kobo.45.1"> tag to our file. </span><span class="koboSpan" id="kobo.45.2">Now you know why we have been using this library all along:</span></p>
<pre><span class="koboSpan" id="kobo.46.1">d3.json('topojson/spain-topo.json', function(data) { </span></pre>
<p><span class="koboSpan" id="kobo.47.1">Next, we inject our </span><kbd><span class="koboSpan" id="kobo.48.1">topojson</span></kbd><span class="koboSpan" id="kobo.49.1"> file that we just created via AJAX:</span></p>
<pre><span class="koboSpan" id="kobo.50.1">var country = topojson.feature(data, data.objects.ESP_adm0); </span></pre>
<p><span class="koboSpan" id="kobo.51.1">We add an additional line of code to convert the TopoJSON format to the GeoJSON feature format:</span></p>
<pre><span class="koboSpan" id="kobo.52.1">var b = path.bounds(country); </span></pre>
<p><span class="koboSpan" id="kobo.53.1">We need to remember to create our bounding box using the interpolated features:</span></p>
<pre><span class="koboSpan" id="kobo.54.1">spain = map.selectAll('path').data(country.features); </span></pre>
<p><span class="koboSpan" id="kobo.55.1">Now, we use the </span><em><span class="koboSpan" id="kobo.56.1">data join</span></em><span class="koboSpan" id="kobo.57.1"> on our new data. </span><span class="koboSpan" id="kobo.57.2">As expected, we will see our map of Spain. </span><span class="koboSpan" id="kobo.57.3">Let's show them side by side in the following screenshot to compare GeoJSON and TopoJSON (with GeoJSON on the left and TopoJSON on the right):</span></p>
<div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.58.1"><img src="assets/7206aacb-4946-41b4-a5ff-beb72e30b230.png"/></span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">TopoJSON command-line tips</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">The TopoJSON command-line documentation is very complete (</span><a href="https://github.com/mbostock/topojson/wiki/Command-Line-Reference"><span class="URLPACKT"><span class="koboSpan" id="kobo.3.1">https://github.com/mbostock/topojson/wiki/Command-Line-Reference</span></span></a><span class="koboSpan" id="kobo.4.1">). </span><span class="koboSpan" id="kobo.4.2">However, here are a couple of quick and easy tips to get you started.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Preserving specific attributes</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">In the GeoJSON section, we illustrated that data properties are often part of the geographic data. </span><span class="koboSpan" id="kobo.2.2">The </span><kbd><span class="koboSpan" id="kobo.3.1">topojson</span></kbd><span class="koboSpan" id="kobo.4.1"> command gives you the ability to filter out the ones you are not interested in, as well as provide a better naming convention to the ones you do want to keep. </span><span class="koboSpan" id="kobo.4.2">These capabilities are in the </span><kbd><span class="koboSpan" id="kobo.5.1">-p</span></kbd><span class="koboSpan" id="kobo.6.1"> flag and passed to the command. </span><span class="koboSpan" id="kobo.6.2">For example:</span></p>
<pre><strong><span class="koboSpan" id="kobo.7.1">topojson -o spain-topo.json -p name=ISO -- ESP_adm0.shp  </span></strong></pre>
<p><span class="koboSpan" id="kobo.8.1">We will create the TopoJSON file, remove all properties except ISO, and rename the ISO property to something easy to recognize. </span><span class="koboSpan" id="kobo.8.2">You can address multiple properties by comma-separating the list:</span></p>
<pre><strong><span class="koboSpan" id="kobo.9.1">-p target=source,target=source,target=source </span></strong> </pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Simplification</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Mike Bostock provides an excellent tutorial on simplification, and how it works, at </span><a href="http://bost.ocks.org/mike/simplify/"><span class="URLPACKT"><span class="koboSpan" id="kobo.3.1">http://bost.ocks.org/mike/simplify/</span></span></a><span class="koboSpan" id="kobo.4.1">.</span></p>
<p><span class="koboSpan" id="kobo.5.1">Basically, it is a way to reduce geometric complexity through line-simplification algorithms. </span><span class="koboSpan" id="kobo.5.2">For example, if you do not need much detail in a very jagged coast of a country, you can apply line-simplification algorithms to smooth out the jaggedness and significantly reduce the size of the TopoJSON file. </span><span class="koboSpan" id="kobo.5.3">The command-line parameter you use is </span><kbd><span class="koboSpan" id="kobo.6.1">-s</span></kbd><span class="koboSpan" id="kobo.7.1"> to adjust the simplification in the TopoJSON conversion:</span></p>
<pre><strong><span class="koboSpan" id="kobo.8.1">-p  name=ISO -s 7e-7 -- ESP_adm0.shp</span></strong></pre>
<p><span class="koboSpan" id="kobo.9.1">We typically realize that when dealing with shapefiles from DIVA-GIS, the best range is around 7e-7 to keep within the per-pixel threshold, which is less than the area of the map. </span><span class="koboSpan" id="kobo.9.2">At this range, the size compression is very significant and the map quality is still very acceptable for web development. </span><span class="koboSpan" id="kobo.9.3">Consider the following:</span></p>
<ul>
<li><strong><span class="koboSpan" id="kobo.10.1">Original</span></strong><span class="koboSpan" id="kobo.11.1">: 378 KB, great detail and quality:
</span><div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.12.1"><img src="assets/b0f255d9-ee89-48e3-a11c-1bc58c048241.png"/></span></div>
</li>
<li><strong><span class="koboSpan" id="kobo.13.1">Simplified at -s 7e-7</span></strong><span class="koboSpan" id="kobo.14.1">: 3.6 KB and acceptable quality:
</span><div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.15.1"><img src="assets/ed1bd98f-f84b-4c79-b5fd-649d03080af1.png"/></span></div>
</li>
<li><strong><span class="koboSpan" id="kobo.16.1">Very simple at -s 7e-5</span></strong><span class="koboSpan" id="kobo.17.1">: 568 bytes but the map is unrecognizable:
</span><div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.18.1"><img src="assets/e2fea97e-d050-43dd-a42c-64796c5c982f.png"/></span></div>
</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Merging files</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">The final tip involves merging multiple shapefiles into a single TopoJSON file. </span><span class="koboSpan" id="kobo.2.2">This is extremely useful if you need separate geographic information but want to fetch it in a single AJAX request. </span><span class="koboSpan" id="kobo.2.3">To append additional files, you add them after the </span><kbd><span class="koboSpan" id="kobo.3.1">-</span></kbd><span class="koboSpan" id="kobo.4.1"> in the command line. </span><span class="koboSpan" id="kobo.4.2">Consider this command:</span></p>
<pre><strong><span class="koboSpan" id="kobo.5.1">topojson -o ../topojson/spain-topo-simple.json -p  name=ISO -s 7e-7 -</span></strong><br/><strong><span class="koboSpan" id="kobo.6.1">- ESP_adm0.shp ESP_adm1.shp </span></strong> </pre>
<p><span class="koboSpan" id="kobo.7.1">It will produce the following object structure, where the data for </span><kbd><span class="koboSpan" id="kobo.8.1">ESP_adm0</span></kbd><span class="koboSpan" id="kobo.9.1"> is the data for the country, and </span><kbd><span class="koboSpan" id="kobo.10.1">ESP_adm1</span></kbd><span class="koboSpan" id="kobo.11.1"> is the data for the regions:</span></p>
<div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.12.1"><img src="assets/03f298b1-106d-4f6c-8008-ab18f2922c15.png"/></span></div>
<p><span class="koboSpan" id="kobo.13.1">There is also the opportunity to rename the object they will map to in the resulting TopoJSON file. </span><span class="koboSpan" id="kobo.13.2">Again, this can help create readable code. </span><span class="koboSpan" id="kobo.13.3">The renaming follows the same convention as renaming specific properties. </span><span class="koboSpan" id="kobo.13.4">For example, type in this command:</span></p>
<pre><strong><span class="koboSpan" id="kobo.14.1">topojson -o ../topojson/spain-topo-simple.json -p  name=ISO -s 7e-7 -</span></strong><br/><strong><span class="koboSpan" id="kobo.15.1">- country=ESP_adm0.shp regions=ESP_adm1.shp </span></strong> </pre>
<p><span class="koboSpan" id="kobo.16.1">The preceding command will create the following:</span></p>
<div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.17.1"><img src="assets/ae3f9b56-eb2b-465d-b93f-707363a7eed0.png"/></span></div>
<p><span class="koboSpan" id="kobo.18.1">In this case, you would change your original code, which is as follows:</span></p>
<pre><span class="koboSpan" id="kobo.19.1">var country = topojson.feature(data, data.objects.ESP_adm0); </span></pre>
<p><span class="koboSpan" id="kobo.20.1">You have to change it to the following code:</span></p>
<pre><span class="koboSpan" id="kobo.21.1">var country = topojson.feature(data, data.objects.country); </span></pre>
<p><span class="koboSpan" id="kobo.22.1">This is much nicer to look at! </span><span class="koboSpan" id="kobo.22.2">Please look at </span><kbd><span class="koboSpan" id="kobo.23.1">example-3.html</span></kbd><span class="koboSpan" id="kobo.24.1"> (</span><kbd><span class="koboSpan" id="kobo.25.1">http://localhost:8080/chapter-6/example-3.html</span></kbd><span class="koboSpan" id="kobo.26.1">) to see how all of this information can be tied together.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Summary</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">At this point, you should feel confident that you can find and modify datasets to your needs. </span><span class="koboSpan" id="kobo.2.2">We've covered common locations from where you can acquire data, and we've touched on the different types of flags TopoJSON offers. </span><span class="koboSpan" id="kobo.2.3">With these skills, it is up to you to make sure your data is trimmed and is acquired to your visualization needs. </span><span class="koboSpan" id="kobo.2.4">This closes the circle of developing maps with D3. </span><span class="koboSpan" id="kobo.2.5">In the next chapter, we will refine your craft by focusing on testing your visualizations.</span></p>


            </article>

            
        </section>
    </body></html>