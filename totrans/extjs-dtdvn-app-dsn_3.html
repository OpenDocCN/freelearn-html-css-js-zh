<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Data Input</h1></div></div></div><p>Welcome back. So, in the previous two chapters we worked on data structures and we made tables in SQL and MySQL. Then we created the development environment while getting to grips with Sencha Cmd.</p><p>In this chapter, we will:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Learn to make a form to input data</li><li class="listitem" style="list-style-type: disc">Transmit that data to a server via Ext Direct</li><li class="listitem" style="list-style-type: disc">Learn about monitoring the state of the input</li><li class="listitem" style="list-style-type: disc">Learn how to use Ext Direct to validate the <code class="literal">MyAccount</code> form on the server side</li></ul></div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec23"/>Creating the login page</h1></div></div></div><p>Let's <a id="id90" class="indexterm"/>start by <a id="id91" class="indexterm"/>creating the login page for this application. Here we will perform a simple implementation using PHP. We will create <code class="literal">login.php</code> and <code class="literal">logout.php</code>. However, we will not go into too much detail about the login logic here because this book is focused on Ext JS and not PHP.</p><p>Create the variable you will input in SQL and then just pull the user information from the database.</p><p>The source code is very long, so please go to the source file to view the <code class="literal">login.php</code> file from the <code class="literal">01_making_the_login</code> folder and <code class="literal">logout.php</code> from <code class="literal">01_making_the_login</code>.</p><p>Store the user data for the session with the key <code class="literal">USERINFO</code>. Again, to be able to perform a login check, change <code class="literal">index.html</code> to <code class="literal">index.php</code> and run the login check. Apart from the PHP code at the beginning, it's the same as <code class="literal">index.html</code> (source file: <code class="literal">01_making_the_login/index.php</code>):</p><div><pre class="programlisting">&lt;?php
session_start();
if(!isset($_SESSION['USERINFO'])) {
  header("Location: ./login.php");
}
?&gt;
&lt;!DOCTYPE HTML&gt;
...
&lt;/html&gt;</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec24"/>Creating the MyAccount form</h1></div></div></div><p>Now, <a id="id92" class="indexterm"/>let's <a id="id93" class="indexterm"/>build the forms that will deploy to various screens. First comes <code class="literal">MyAccount</code>.</p><p>Add the form panel to the temporary panel you built. Don't install the form directly onto the <code class="literal">Screen</code> panel—there is a reason to this. You will make relationships between the list and the details, so there are times when there are numerous panels existing inside the screen.</p><p>It just so happens that <code class="literal">MyAccount</code> only needs one screen. If the number of methods increases, there is a chance that you will need multiple panels. You might need a panel to run the input verification. But it's difficult to say for sure at this point. So, it is necessary to make the<a id="id94" class="indexterm"/> <strong>screen layout</strong> into a <strong>card layout</strong> which will make it easier to handle multiple screens.</p><p>First, let's specify the screen layout to be a card layout. In the <code class="literal">MyAccount.js</code> script at the bottom of the <code class="literal">view</code> directory you made before, create a <code class="literal">MyAccount</code> directory and move into it. The hierarchy of the directory will change, so let's modify the class name as well (source file: <code class="literal">02_making_the_account_form/app/view/myaccount/MyAccount.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.view.myaccount.MyAccount', {
extend: 'MyApp.panel.Screen',
    ....</pre></div><p>Let's modify the class name as follows (Source file: <code class="literal">02_making_the_account_form/app/controller/myaccount/MyAccount.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.controller.myaccount.MyAccount', {
extend: 'MyApp.controller.Abstract',
    ....</pre></div><p>In the same way, edit the controllers of <code class="literal">Quotation</code>, <code class="literal">Bill</code>, and <code class="literal">Dashboard</code> and views. By doing this, the application should now be working.</p><p>Because the package name has changed, let's modify the <code class="literal">Application.js</code> controller settings accordingly (source file: <code class="literal">02_making_the_account_form/app/Application.js</code>):</p><div><pre class="programlisting">Ext.application({
    ....
    controllers: [
        'Main',
        'Header',
        'Navigation',
        'dashboard.Dashboard',
        'myaccount.MyAccount',
        'quotation.Quotation',
        'bill.Bill'
    ],
    ....</pre></div><p>Also, the <a id="id95" class="indexterm"/>view name has changed, so we have to modify that as well (source file: <code class="literal">02_making_the_account_form/app/view/Viewport.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.view.Viewport', {
    ....
    requires:[
        'Ext.panel.Panel',
        'Ext.layout.container.Border',
        'MyApp.view.Header',
        'MyApp.view.Navigation',
        'MyApp.view.dashboard.Dashboard',
        'MyApp.view.myaccount.MyAccount',
        'MyApp.view.quotation.Quotation',
        'MyApp.view.bill.Bill'
    ],
    ....</pre></div><p>Now with this,<a id="id96" class="indexterm"/> we're free to make the form. To begin with, we want to create the form panel and put it into <code class="literal">MyAccount</code>, but we want to perform a data abstraction of the form panel. So, at the beginning let's do just that and create a simple inheritance.</p><p>In the same way as we created the class for <code class="literal">app/panel/Screen.js</code>, we'll create a class that's inherited from <code class="literal">Ext.form.Panel</code> (refer to the source file: <code class="literal">02_making_the_account_form/app/form/Panel.js</code>).</p><p>We have created the inheritance. Let's make the <code class="literal">edit</code> panel (source file: <code class="literal">02_making_the_account_form/app/view/myaccount/Edit.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.view.myaccount.MyAccount', {
    extend: 'MyApp.form.Panel',
    alias : 'widget.myapp-myaccount-edit',
    itemId: 'screen-myaccount-edit',
    initComponent: function() {
        var me = this;
        Ext.apply(me, {
        });
        me.callParent(arguments);
    }
});</pre></div><p>Let's perform <a id="id97" class="indexterm"/>the implementation inside the form a little later. First, let's embed this panel (source file: <code class="literal">02_making_the_account_form/app/view/myaccount/MyAccount.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.view.myaccount.MyAccount', {
  ...
    requires: [
        'MyApp.view.myaccount.Edit'
    ],
    itemId: 'screen-myaccount',
    title: 'MyAccount',
    layout: 'card',
    items: [{
        xtype: 'myapp-myaccount-edit',
        border: false
    }]
});</pre></div><p>Make sure <a id="id98" class="indexterm"/>that there are no errors coming from the browser. The appearance does not change, so it might not be so interesting presently.</p><p>At the moment, it looks good on the display, but you might have noticed that a <strong>CT</strong> error has arisen. This is because we changed the name earlier. Let's fix this now.</p><p>The <code class="literal">MyAccount</code> class (<code class="literal">view</code> and <code class="literal">controller</code>) package name has changed, so go ahead and amend the following class names (check the source file for reference):</p><p><code class="literal">02_making_the_account_form/ct/myaccount/view.js</code></p><p><code class="literal">02_making_the_account_form/ct/myaccount/app.js</code></p><p>Along with this, you should also fix the other CT error.</p><p>Now, let's start to build the main form. When you define the classes, you can define them using the configuration options, but let's set it up using <code class="literal">Ext.apply</code> inside <code class="literal">initComponent</code>. If we set up the configuration with <code class="literal">initComponent</code>, we can set a more flexible variety of behaviors to the component when we create it.</p><p>The following code is really similar to the code that comes out of <a id="id99" class="indexterm"/>
<strong>Sencha Architect</strong> (source file: <code class="literal">02_making_the_account_form/app/view/myaccount/Edit.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.view.myaccount.Edit', {
  ...
    initComponent: function() {
        var me = this;
        // Fields
        Ext.apply(me, {
            bodyPadding: 20,
            defaultType: 'textfield',
            items: [{
                fieldLabel: 'email'
           }, {
                fieldLabel: 'firstname'
           }, {
                fieldLabel: 'lastname'
           }]
        });
        // TopToolbar
    Ext.apply(me, {
        tbar: [{
text: 'Save',
action: 'save'
           }, {
            text: 'Reset',
            action: 'reset'
           }]
        });
    me.callParent(arguments);
    }
});</pre></div><p>If you run the preceding <a id="id100" class="indexterm"/>code, it will look like the following screenshot:</p><div><img src="img/5446OS_03_01.jpg" alt="Creating the MyAccount form"/></div><p>We make forms<a id="id101" class="indexterm"/> in this manner. Try adjusting it for yourself if you think up a more complex or attractive form. You can find more complex layouts published on <em>Sencha Ext samples</em>: <a class="ulink" href="http://dev.sencha.com/deploy/ext-4.0.0/examples/#sample-13">http://dev.sencha.com/deploy/ext-4.0.0/examples/#sample-13</a>.</p><p>At the moment, we see just three fields: <strong>email:</strong>, <strong>firstname,</strong> and <strong>lastname:</strong>. These are not usually modified often, but as we develop the application, other fields that require more modification might need to be added. In such occasions, you can add new fields in <code class="literal">myaccount.Edit</code>.</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec25"/>Creating the Quotation form</h1></div></div></div><p>Let's<a id="id102" class="indexterm"/> continue <a id="id103" class="indexterm"/>and create forms for <code class="literal">Quotation</code> and <code class="literal">Bill</code>. In the same way as before, first set up the card layout in the <code class="literal">Screen</code> panel.</p><p>In the same way as with <code class="literal">view/myaccount/MyAccount.js</code>, in the <code class="literal">Quotation</code> class we will add the <code class="literal">Edit</code> and <code class="literal">List</code> screens (source file: <code class="literal">03_making_the_quotation_form/app/view/quotation/Quotation.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.view.quotation.Quotation', {
  ...
  requires: [
        'MyApp.view.quotation.List',
        'MyApp.view.quotation.Edit'
    ],
  ...
items: [{           xtype: 'myapp-quotation-list',
          border: false
    }, {
          xtype: 'myapp-quotation-edit',
          border: false
    }]
});</pre></div><p>Unlike the <a id="id104" class="indexterm"/>previous occasion, now two cards exist. These are <code class="literal">List</code> and <code class="literal">Edit</code>. You will implement <code class="literal">List</code> in a later chapter. Here, let's implement <code class="literal">Edit</code>.</p><p>The only thing is, if you don't create a class, then <code class="literal">requires</code> won't be able to read it. So, make a <code class="literal">List</code> class in the following way (source file: <code class="literal">03_making_the_quotation_form/app/view/quotation/List.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.view.quotation.List', {
    extend: 'MyApp.form.Panel',
    alias : 'widget.myapp-quotation-list',
    itemId: 'screen-quotation-list',
    initComponent: function() {
      var me = this;
      Ext.apply(me, {
        });
    me.callParent(arguments);
    }
});</pre></div><p>Next, let's create <code class="literal">Edit</code>. It is a bit of a long process, so let's break it up into sections and go through each part (source file: <code class="literal">03_making_the_quotation_form/app/view/quotation/Edit.js)</code>:</p><div><pre class="programlisting">Ext.define('MyApp.view.quotation.Edit', {
    extend: 'MyApp.form.Panel',
    alias : 'widget.myapp-quotation-edit',
    itemId: 'screen-quotation-edit',
    initComponent: function() {
    ...
    }
});</pre></div><p>We have made<a id="id105" class="indexterm"/> an empty <code class="literal">MyApp.view.quotation.Edit</code> component and from now, we'll begin to implement the inside of the <code class="literal">initComponent</code> method. As we saw before, this will make the component more flexible.</p><p>Let's break this up into <code class="literal">Store</code>, <code class="literal">field</code> and <code class="literal">grid</code>, and <code class="literal">TopToolbar</code>. The following sections give the <a id="id106" class="indexterm"/>code that should be inserted into their specific points.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec45"/>Store</h2></div></div></div><p>The <code class="literal">Store</code> component<a id="id107" class="indexterm"/> is where the data will be stored locally in the browser.</p><p>Let's create the <code class="literal">Store</code> component now. Implement the following code into the <code class="literal">initComponent</code> method inside the <code class="literal">MyApp.view.quotation.Edit</code> class (source file: <code class="literal">03_making_the_quotation_form/app/view/quotation/Edit.js</code>):</p><div><pre class="programlisting">Ext.applyIf(me, {
    customerStore: Ext.create('Ext.data.Store', {
        fields: ['id', 'name'],
        data : [
            {"id": 0, "name": "Sencha"},
            {"id": 1, "name": "Xenophy"}
        ]
    }),
    itemStore: Ext.create('Ext.data.Store', {
        storeId:'billItemStore',
        fields:['desc', 'qty', 'price', 'sum'],
        data:{'items':[
            { 'desc': 'Sencha Complete', "qty":"5", "price":"995", 
             "sum": 4975 },
            { 'desc': 'Sencha Ext JS + Standard Support', "qty":"5", 
             "price":"595", "sum": 2975 }
        ]},
proxy: {
type: 'memory',
reader: {
type: 'json',
root: 'items'
            }
        }
    })
});</pre></div><p>Generate <code class="literal">customerStore</code> and <code class="literal">itemStore</code>. <code class="literal">customerStore</code> is made for the combobox and <code class="literal">itemStore</code> is made for the <code class="literal">grid</code> panel. Both stores are temporarily installed. That is why we're using <code class="literal">Ext.applyIf</code>. Let's modify this, so at a later stage you can acquire the data via Ext Direct.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec46"/>The field and grid components</h2></div></div></div><p>In this section, we will build the <code class="literal">field</code> components<a id="id108" class="indexterm"/> (in this case, it means the combobox along the top of the screen), and the <code class="literal">grid</code> panel<a id="id109" class="indexterm"/> that will appear below it.</p><p>It's a little bit long, but write the following after the previous step when we defined the <code class="literal">Store</code> component (source file: <code class="literal">03_making_the_quotation_form/app/view/quotation/Edit.js</code>):</p><div><pre class="programlisting">Ext.apply(me, {
    bodyPadding: 20,
    items: [{
        padding: '0 0 20 0',
        width: 500,
        xtype: 'combo',
        fieldLabel: 'customer',
        store: me.customerStore,
        editable: false,
        displayField: 'name',
        valueField: 'id'
    }, {
        // Grid Panel
        height: 400,
        padding: '0 0 20 0',
        xtype: 'grid',
        store: me.itemStore,
        plugins: [Ext.create('Ext.grid.plugin.CellEditing')],
        columns: [{
            text: 'Description',
            dataIndex: 'desc',
            flex: 1,
            editor: true
        }, {
            text: 'Qty',
            dataIndex: 'qty',
            editor: {
                xtype: 'numberfield',
                allowBlank: false,
                minValue: 0,
                maxValue: 10000
            }
        }, {
            text: 'Price',
            dataIndex: 'price',
            renderer: Ext.util.Format.usMoney,
            editor: {
                xtype: 'numberfield',
                allowBlank: false,
                minValue: 0,
                maxValue: 10000
            }
        }, {
            text: 'Sum',
            dataIndex: 'sum',
            renderer: Ext.util.Format.usMoney
        }],
        tbar: [{
            text: 'Add Item',
            action: 'add-item'
        }, '-', {
            text: 'Remove Item',
            action: 'remove-item'
        }]
   }, {
        fieldLabel: 'note',
        xtype: 'textarea',
        width: 500j
   }]
});</pre></div><p>If you lay out the field,<a id="id110" class="indexterm"/> you are laying out the <code class="literal">grid</code> panel. The point to remember here is that the <code class="literal">grid</code> panel is set up with the plugin <code class="literal">Ext.grid.plugin.CellEditing</code>. In order to open various cells to edit, we have set up the editor key in the column settings. The <code class="literal">textfield</code> form field is used by default, but you want just numerical inputs in <code class="literal">qty</code> and <code class="literal">price</code>, so we are using <code class="literal">numberfield</code> for those.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec47"/>TopToolbar</h2></div></div></div><p>In this<a id="id111" class="indexterm"/> section we will create the <code class="literal">Save</code> button that will go on the top toolbar in our application.</p><p>To do this, write the following code after the code we wrote in the previous step to display the <code class="literal">Save</code> button (source file: <code class="literal">03_making_the_quotation_form/app/view/quotation/Edit.js</code>):</p><div><pre class="programlisting">Ext.apply(me, {
    tbar: [{
        text: 'Save',
        action: 'save'
   }]
});</pre></div><p>We will install the <code class="literal">Save</code> button. Now, we want to display this button as quickly as possible, but at the moment nothing is being displayed. This is because in the card layout, in the <code class="literal">Quotation</code> view's active item, <code class="literal">0</code> will display the <code class="literal">List</code> screen and <code class="literal">1</code> will display <code class="literal">Edit</code>.</p><p>In this state, <a id="id112" class="indexterm"/>we can't perform a component test, so first, let's begin by preparing <code class="literal">view_edit.html</code> for the CT (source file: <code class="literal">03_making_the_quotation_form/ct/quotation/view_edit.html</code>).</p><p>Basically, this does not change much in <code class="literal">view.html</code>, we're just changing <code class="literal">view.js</code> being read by <code class="literal">&lt;script&gt;</code> in <code class="literal">view_edit.js</code>.</p><p>Now, the <code class="literal">Quotation</code> view's package name has not been amended, so you can correct this now. For the source code, please see the source file: <code class="literal">03_making_the_quotation_form/ct/quotation/view_edit.js</code>.</p><p>When you generate <code class="literal">MyApp.view.quotation.Quotation</code>, in the configuration options add <code class="literal">activeItem: 1</code>. By doing this, <code class="literal">Edit</code> will be displayed from the start. Of course the functions have not been implemented, so items will not be added or automatically calculated.</p><p>Here we are adding a new component, so in order to apply the mapping for the new component to <code class="literal">bootstrap.js</code>, let's execute <code class="literal">sencha app build</code>. After executing Sencha app build and the mapping has successfully been applied to <code class="literal">bootstrap.js</code>, the following screen should appear:</p><div><img src="img/5446OS_03_02.jpg" alt="TopToolbar"/></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec26"/>Creating the Bill form</h1></div></div></div><p>Following <a id="id113" class="indexterm"/>on, <a id="id114" class="indexterm"/>let's make the form for invoices. The contents of the <code class="literal">Bill</code> and <code class="literal">Quotation</code> forms are mostly the same.</p><p>This will also need to describe finer details such as payment date. So, regarding the structure of the database, the ID can be linked so that a quotation can raise an event for the bill.</p><p>Now, let's quickly begin by making the card layout in the same way as for <code class="literal">Quotation</code> (source file: <code class="literal">04_making_the_bill_form/app/view/bill/Bill.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.view.bill.Bill', {
  ...
    title: 'Bill',
    layout: 'card',
    items: [{
        xtype: 'myapp-bill-list',
        border: false
    }, {
        xtype: 'myapp-bill-edit',
        border: false
    }]
});</pre></div><p>Next, let's <a id="id115" class="indexterm"/>make a temporary empty <code class="literal">List</code> component to compensate for what we wrote previously and avoid receiving an error.</p><p>The next class we are going to make is really similar to the <code class="literal">dashboard.Dashboard</code> class. So, please use that as reference while you code and watch out for the following point (source file: <code class="literal">04_making_the_bill_form/app/view/bill/List.js</code>):</p><div><pre class="programlisting">className: MyApp.view.bill.List
extend: MyApp.form.Panel
alias: widget.myapp-bill-list
itemId: screen-bill-list</pre></div><p>Also, let's<a id="id116" class="indexterm"/> implement the empty <code class="literal">initComponent</code> for the same reason as before for the <code class="literal">List</code> component.</p><p>Then, at the end, make <code class="literal">Edit</code> in the same way as <code class="literal">Quotation</code> (source file: <code class="literal">04_making_the_bill_form/app/view/bill/Edit.js</code>).</p><p>Again, this class is very similar to the <code class="literal">MyApp.view.quotation.Edit</code> class, which we previously made.</p><p>Watch out for the following points and build this class in the same way:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">className: MyApp.view.bill.Edit</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">aliasName: widget.myapp-quotation-edit</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">itemId: screen-quotation-edit</code></li></ul></div><p>You have created the view, so now it's time to implement the various controllers. Instead of having one controller to manage <code class="literal">Quotation</code> and <code class="literal">Bill</code> that are separated into <code class="literal">List</code> and <code class="literal">Edit</code>, it's better to prepare controllers for each one (source file: <code class="literal">04_making_the_bill_form/app/controller/quotation/List.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.controller.quotation.List', {
    extend: 'MyApp.controller.Abstract',
    init: function() {
        var me = this;
        me.control({
        });
    }
});</pre></div><p>Let's create the<a id="id117" class="indexterm"/> rest of the controllers listed as follows in exactly the same way (only the class names are different).</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">(Source file: <code class="literal">04_making_the_bill_form/app/controller/quotation/Edit.js</code>)</li><li class="listitem" style="list-style-type: disc">(Source file: <code class="literal">04_making_the_bill_form/app/controller/bill/List.js</code>)</li><li class="listitem" style="list-style-type: disc">(Source file: <code class="literal">04_making_the_bill_form/app/controller/bill/Edit.js</code>)</li></ul></div><p>In order for the preceding controllers to be read, add a postscript into <code class="literal">app/Application.js</code> (source file: <code class="literal">04_making_the_bill_form/app/Application.js</code>).</p><p>It's worth checking now that no errors are being displayed by accessing <code class="literal">index.php</code>.</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec27"/>Managing dirty and undirty apps</h1></div></div></div><p>Naturally,<a id="id118" class="indexterm"/> it's good if the saving process happens every time you press the <strong>Save</strong> button.</p><p>However, if <a id="id119" class="indexterm"/>possible, wouldn't you prefer to have the <strong>Save</strong> button available only when changes have been made?</p><p>Here, we will implement the logic into the controller that will judge whether or not changes have been made after an input.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec48"/>MyAccount</h2></div></div></div><p>First, we will implement a simple form from <code class="literal">MyAccount</code><a id="id120" class="indexterm"/>. But, before that, <code class="literal">Quotation</code> and <code class="literal">Bill</code> separated the controller, but we didn't make the change in <code class="literal">MyAccount</code>! Let's separate it quickly and add it to <code class="literal">app/Application.js</code>.</p><p>Using the <code class="literal">MyApp.controller.bill.Edit</code> class as reference, let's go ahead and make the <code class="literal">MyApp.controller.myaccount.Edit</code> class.</p><p>Apart from the class name, it's exactly the same process (source file: <code class="literal">05_management_of_dirty_and_undirty_myaccount/app/controller/myaccount/Edit.js</code>).</p><p>After you have finished building the previous class, let's add the <code class="literal">myaccount.Edit</code> controller to the controller property of <code class="literal">app/Application.js</code>.</p><p>Now add it to <code class="literal">app.js</code> in the CT directory in the same way (source file: <code class="literal">05_management_of_dirty_and_undirty_myaccount/ct/myaccount/app.js</code>).</p><p>Now, it should be <a id="id121" class="indexterm"/>able to run with a controller in CT. First, set up the following event list to fire during the component test:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">myapp-show</code> (displays the component)</li><li class="listitem" style="list-style-type: disc"><code class="literal">myapp-hide</code> (hides the component)</li><li class="listitem" style="list-style-type: disc"><code class="literal">myapp-dirty</code> (fires when information inside the form has been changed)</li><li class="listitem" style="list-style-type: disc"><code class="literal">myapp-undirty</code> (fires when changed information has been recorded or information has been reverted back to the previous state)</li></ul></div><p>Before anything else, in relation to <code class="literal">myapp-show</code> and <code class="literal">myapp-hide</code>, we need to pass the event to the <code class="literal">List</code> and <code class="literal">Edit</code> classes with <code class="literal">MyApp.controller.myaccount.MyAccount</code> (source file: <code class="literal">05_management_of_dirty_and_undirty_myaccount/app/controller/myaccount/MyAccount.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.controller.myaccount.MyAccount', {
    extend: 'MyApp.controller.Abstract',
    screenName: 'myaccount',
    refs: [{
        ref: 'editView', selector: 'myapp-myaccount-edit' 
    }],
    init: function() {
        var me = this;
        me.control({
            'myapp-myaccount': {
                'myapp-show': me.onShow,
                'myapp-hide': me.onHide
            }
        });
    },
    onShow: function() {
        var me = this,
        editView = me.getEditView();
        editView.fireEvent('myapp-show', editView);
    },
    onHide: function() {
        var me = this,
        editView = me.getEditView();
        editView.fireEvent('myapp-hide', editView);
    }
});</pre></div><p>The main point is to set up <code class="literal">refs</code> and capture the <code class="literal">editView</code>. Next, define the controller for <code class="literal">Edit</code> (source file: <code class="literal">05_management_of_dirty_and_undirty_myaccount/app/controller/myaccount/Edit.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.controller.myaccount.Edit', {
extend: 'MyApp.controller.Abstract',
init: function() {
var me = this;
me.control({
            'myapp-myaccount-edit': {
                'myapp-show': me.onShow,
                'myapp-hide': me.onHide,
                'myapp-dirty': me.onDirty,
                'myapp-undirty': me.onUndirty
            }
        });
    },
    onShow: function() {
    },
    onHide: function() {
    },
    onDirty: function() {
    },
    onUndirty: function() {
    }
});</pre></div><p>Next, we need to<a id="id122" class="indexterm"/> acquire the <code class="literal">field</code> event. Acquire the field with component query and then set up the event listener (source file: <code class="literal">05_management_of_dirty_and_undirty_myaccount/app/controller/myaccount/Edit.js</code>):</p><div><pre class="programlisting">init: function() {
        ....
        Ext.iterate([
            {name: 'email', xtype: 'textfield', fn: me.onChangeField},
            {name: 'firstname', xtype: 'textfield', fn: 
             me.onChangeField},
            {name: 'lastname', xtype: 'textfield', fn: 
             me.onChangeField}
        ], function(f) {
            var scope = me, o = {},
            format = Ext.String.format,
            key = format('{0} {1}[name="{2}"]', 'myapp-myaccount-edit', f.xtype, f.name);
            o[key] = {
change  : { fn: f.fn, scope: scope }
            };
        me.control(o);
        });
    },
    onChangeField: function(field) {
        console.log(field);
    },
    onShow: function() {
    ....</pre></div><p>Add each name <a id="id123" class="indexterm"/>property to the <code class="literal">View</code> field (source file: <code class="literal">05_management_of_dirty_and_undirty_myaccount/app/view/myaccount/Edit.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.view.myaccount.Edit', {
    ....
    initComponent: function() {
        var me = this;
        // Fields
        Ext.apply(me, {
            ....
            items: [{
                fieldLabel: 'email',
                name: 'email'
            }, {
                fieldLabel: 'firstname',
                name: 'firstname'
            }, {
                fieldLabel: 'lastname',
                name: 'lastname'
            }]
        });
        ....</pre></div><p>If we input something in text, it is output as a log in the console. We want to define the similar processing to the other classes, so move the following logic into the <code class="literal">Abstract</code> class and modify it so that it can be called (source file: <code class="literal">05_management_of_dirty_and_undirty_myaccount/app/controller/Abstract.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.controller.Abstract', {
    ....
setChangeFieldEvents: function(fields, xtype, fn, scope) {
var me = this,
format = Ext.String.format;
Ext.iterate(fields, function(type, fs) {
if(Ext.isString(fs)) {
fs = [fs];
            }
if(Ext.isArray(fs)) {
Ext.iterate(fs, function(fname) {
var o = {}, key;
key = format('{0} {1}[name="{2}"]', xtype, type, fname);
o[key] = {
change  : { fn: fn, scope: scope }
                    };
me.control(o);
                });
            }
        });
    },
    ....</pre></div><p>And let's implement<a id="id124" class="indexterm"/> in the same way for <code class="literal">Edit.js</code> (source file: <code class="literal">05_management_of_dirty_and_undirty_myaccount/app/controller/myaccount/Edit.js</code>):</p><div><pre class="programlisting">    ....
init: function() {
        ....
        me.setChangeFieldEvents({
            textfield: [
                'email',
                'firstname',
                'lastname'
            ]
        },
        'myapp-myaccount-edit',
         me.onChangeField,
         me);
    },
    onChangeField: function(field) {
        console.log(field);
    },
    ....</pre></div><p><code class="literal">setChangeFieldEvents</code> is made so that we can set up other events besides <code class="literal">textfield</code>. <code class="literal">setChangeFieldEvents</code> can also support the times when you want to use it for other fields such as <code class="literal">combobox</code>. The fact that the details of the text were modified means you could handle it with the implementations made so far.</p><p>So next, let's check if the content really did change. This means implementation inside the method <code class="literal">onChangeField</code> is successful.</p><p>If the content <a id="id125" class="indexterm"/>of the component recorded by the <code class="literal">MyApp.controller.myaccount.Edit</code> controller's <code class="literal">init</code> method is modified, the <code class="literal">onChangeField</code> method is implemented (source file: <code class="literal">05_management_of_dirty_and_undirty_myaccount/app/controller/myaccount/Edit.js</code>).</p><p>Use <code class="literal">getFieldValues</code> in order to judge whether there were changes to the field. <code class="literal">Ext.Object.getKeys</code> will send back an array. Consequently, with this single line you can judge whether changes have been made to the content.</p><p>If there is a change, <code class="literal">myapp-dirty</code> will be fired and if it reverts to its original state, the <code class="literal">myapp-undirty</code> event will be fired.</p><p>So, let's add the logic to make the toolbar button available for <code class="literal">onDirty</code> and unavailable for <code class="literal">onUndirty</code> to finish the implementation of <code class="literal">MyAccount</code> (source file: <code class="literal">05_management_of_dirty_and_undirty_myaccount/app/controller/myaccount/Edit.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.controller.myaccount.Edit', {
    ....
    onDirty: function() {
        var me = this,
        editView = me.getEditView(),
        btnSave = editView.down('button[action=save]')
        btnSave.enable();
    },
    onUndirty: function() {
        var me = this,
        editView = me.getEditView(),
        btnSave = editView.down('button[action=save]')
        btnSave.disable();
    }
});</pre></div><p>Let's add <code class="literal">disabled</code> to the <code class="literal">Save</code> button settings. During the CT error, <code class="literal">onShow</code> does not work. Also, you should conduct the button's initialization when it is <code class="literal">onHide</code> (source file: <code class="literal">05_management_of_dirty_and_undirty_myaccount/app/view/myaccount/Edit.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.view.myaccount.Edit', {
    ....
    tbar: [{
        text: 'Save',
        action: 'save',
        disabled: true
    ....</pre></div><p>Finally, if you can <a id="id126" class="indexterm"/>muster enough energy, implement it so that when the reset button is pressed, the reset method is called from <code class="literal">Ext.form.Basic</code>.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec28"/>The Quotation form</h1></div></div></div><p>The<a id="id127" class="indexterm"/> <code class="literal">Quotation</code> form is mostly the same as <code class="literal">Bill</code> and <code class="literal">MyAccount</code>, but there is one big difference—there is a grid inside the form panel.</p><p>At first glance, <a id="id128" class="indexterm"/>the store that is configured to the <code class="literal">grid</code> panel looks as though it will communicate directly with the server, but this is not the case. To the very end, this form panel handles fields, so it doesn't handle the grid directly and there is no need to separate form data sending and grid data sending.</p><p>Then how do we solve this? The answer is to hand it a hidden field and make it save the grid data in the form of JSON. So, the grid store is fine to be left as a <strong>MemoryStore</strong>.</p><p>First, implement it to the same point as <code class="literal">MyAccount</code>. Because <code class="literal">Quotation</code> will hold a list, add to it so that <code class="literal">refs</code> can also acquire a list view.</p><p>This source code is very similar to the implementation from the previous step of the following classes:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">MyApp.controller.myaccount.MyAccount</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">MyApp.controller.myaccount.Edit</code></li></ul></div><p>Try implementing for <code class="literal">Quotation</code> remembering what we did with the source code from the previous classes. Use the following source files for reference if you get stuck:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">06_management_of_dirty_and_undirty_quotation/app/controller/quotation/Quotation.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">06_management_of_dirty_and_undirty_quotation/app/controller/quotation/Edit.js</code></li></ul></div><p>In order to check the application you have implemented so far, add a CT to check <code class="literal">Edit</code> (source file: <code class="literal">06_management_of_dirty_and_undirty_quotation/ct/quotation/app_edit.html</code>).</p><p>We'll make this anew in the CT directory subsidiary. The content is mostly the same as for <code class="literal">app.html</code>, but we will change what will be read from <code class="literal">app.js</code> to <code class="literal">app_edit.js</code> (source file: <code class="literal">06_management_of_dirty_and_undirty_quotation/ct/quotation/app_edit.js</code>).</p><p>This is also almost the same as <code class="literal">app.js</code> on the same tier, but we'll add an <code class="literal">Edit</code> controller to controllers and <code class="literal">activeItem:1</code> to <code class="literal">QuotationView</code> controller's configuration option.</p><p>The main points <a id="id129" class="indexterm"/>to remember are to add <code class="literal">quotation.Edit</code> to the controller and set <code class="literal">activeItem</code> to <code class="literal">1</code> and display the <code class="literal">Edit</code> panel from the beginning. So, like we touched on initially, take the store data that's configured in <code class="literal">grid</code> and make it into JSON, then create the logic to be stored in the <code class="literal">Hidden</code> field. First, we need to lay out the <code class="literal">Hidden</code> field in <code class="literal">view</code> (source file: <code class="literal">06_management_of_dirty_and_undirty_quotation/app/view/quotation/Edit.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.view.quotation.Edit', {
            ....
            }, {
            name: 'items',
            xtype: 'hidden'
            }, {
            fieldLabel: 'note',
            name: 'note',
            xtype: 'textarea',
            width: 500
            }]
        });
        // TopToolbar</pre></div><p>In this state, the data is fixed and cannot obtain an event that has specifically changed. Before this, let's implement the addition and deletion of items and event editing. There are various things we need to do to achieve that.</p><p>First is to change the <code class="literal">Store</code> component into a class. You just need to take what is already generated inside <code class="literal">view</code> and make it into an external class (source file: <code class="literal">06_management_of_dirty_and_undirty_quotation/app/store/Customer.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.store.Customer',{
    extend: 'Ext.data.Store',
    storeId:'Customer',
    fields: ['id', 'name'],
    data:{'items':[
        {"id": 0, "name": "Sencha"},
        {"id": 1, "name": "Xenophy"}
    ]},
proxy: {
    type: 'memory',
    reader: {
        type: 'json',
        root: 'items'
        }
    }
});</pre></div><p>Also, change the following (source file: <code class="literal">06_management_of_dirty_and_undirty_quotation/app/store/QuotationItem.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.store.QuotationItem',{
    extend: 'Ext.data.Store',
    storeId:'QuotationItem',
    fields:['desc', 'qty', 'price', 'sum'],
    data:{'items':[
    ]},
proxy: {
    ... // Customer Store
    }
});</pre></div><p>In order to<a id="id130" class="indexterm"/> use this store class, add the setting to the <code class="literal">MyApp.controller.quotation.Edit</code> class.</p><p>We'll add <code class="literal">Customer</code> and <code class="literal">QuotationItem</code> to the <code class="literal">MyApp.controller.quotation.Edit</code> class's <code class="literal">stores</code> property (source file: <code class="literal">06_management_of_dirty_and_undirty_quotation/app/controller/quotation/Edit.js</code>).</p><p>Because we have created <code class="literal">MyApp.store.Customer</code> and <code class="literal">MyApp.store.QuotationItem</code> outside of <code class="literal">view</code>, we need to adjust the code in <code class="literal">view</code> (source file: <code class="literal">06_management_of_dirty_and_undirty_quotation/app/view/quotation/Edit.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.view.quotation.Edit', {
        ....
        (remove store defines!!)
        ....
        // Fields &amp; Grid
Ext.apply(me, {
    bodyPadding: 20,
    items: [{
                ....
    store: '<code class="literal">Customer</code>',
                ....
            }, {
                // Grid Panel
                ....
            store: 'QuotationItem',
                ....</pre></div><p>There is a <a id="id131" class="indexterm"/>reason why we externalized <code class="literal">store</code>. This is because if we configure the <code class="literal">store</code> class in stores with <strong>Ext JS MVC architecture</strong>, the <code class="literal">getXXXXStore</code> method is generated and we're then able to access the <code class="literal">store</code> component from the controller. <code class="literal">XXXX</code> is the <code class="literal">store</code> class name.</p><p>Next, we will make modifications to monitor changes to <code class="literal">hidden</code> from the controller and change the initial values to <code class="literal">hidden</code> (source file: <code class="literal">06_management_of_dirty_and_undirty_quotation/app/view/quotation/Edit.js</code>):</p><div><pre class="programlisting">name: 'items',
xtype: 'hidden',
value: '[]'</pre></div><p>Also, change the following code (source file: <code class="literal">06_management_of_dirty_and_undirty_quotation/app/controller/quotation/Edit.js</code>):</p><div><pre class="programlisting">me.setChangeFieldEvents({
combo: [
        'customer'
    ],
hidden: [
        'items'
    ],
textarea: [
        'note'
    ]
},</pre></div><p>Finally, we can implement what operates the grid. First define the event handler for the button (source file: <code class="literal">06_management_of_dirty_and_undirty_quotation/app/controller/quotation/Edit.js</code>).</p><p>Implement <code class="literal">onAddItem</code> and <code class="literal">onRemoveItem</code>. Here it will become possible to add items and delete items on the grid (source file: <code class="literal">06_management_of_dirty_and_undirty_quotation/app/controller/quotation/Edit.js</code>):</p><div><pre class="programlisting">onAddItem: function() {
    var me = this,
    store = me.getQuotationItemStore();
    store.add({ desc: 'New Item', qty: 0, price: 0, sum: 0 });
},
onRemoveItem: function() {
    var me = this,
    store = me.getQuotationItemStore();
    editView = me.getEditView(),
    grid = editView.down('grid'),
    sm = grid.getSelectionModel();
    if(sm.getCount()) {
            var next = false;
            Ext.iterate(sm.getSelection(), function(item) {
        var flg = false;
        store.data.each(function(model) {
                if(flg) {
                next = model;
                flg = false;
                }
            if(model.id === item.id) {
                flg = true;
                }
            });
            store.remove(item);
        });
        if(next) {
            sm.select(next);
        } else {
            next = store.getAt(store.data.getCount() - 1);
            if(next) {
                sm.select(next);
            }
        }
    }
},</pre></div><p>The adding <a id="id132" class="indexterm"/>process is extremely simple, it's just using the <code class="literal">Add</code> method from the store and adding records. However, the deletion process is not just simply deleting.</p><p>It has been set so that when deletion occurs, the next item from the one that was selected comes into being, and that item is selected. By doing this, you can keep deleting just by continuing to click on the <strong>Delete</strong> button. You should think of this as a little bonus feature!</p><p>So, now you can add and delete records on the grid. Next, we will implement the essential part that<a id="id133" class="indexterm"/> turns the store data into JSON and stores it in <code class="literal">hidden</code> (source file: <code class="literal">06_management_of_dirty_and_undirty_quotation/app/controller/quotation/Edit.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.controller.quotation.Edit', {
    ....
    init: function() {
        ....
        var store = me.getQuotationItemStore(),
        updateGridData;
        updateGridData = function(store) {
          var f = me.getEditView().query('hidden[name=items]')[0],
          out = [];
          store.data.each(function(r) {
              out.push(Ext.clone(r.data));
            });
          f.setValue(Ext.encode(out));
        };
        store.on('update', function(store, r) {
          r.set('sum', r.get('qty')*r.get('price'));
          updateGridData(store);
        });
        store.on('add', function(store, r) {
          updateGridData(store);
        });
        store.on('remove', function(store, r) {
          updateGridData(store);
        });
    },</pre></div><p>When the grid data is altered, <code class="literal">update</code>, <code class="literal">add</code>, and <code class="literal">remove</code> occur as a separate events. You need to define these event handlers. The process is common, so first store the function object in <code class="literal">updateGridData</code> and then use it.</p><p>Again implement a bonus function for the update event. When the content is modified, multiply <code class="literal">qty</code> and <code class="literal">price</code> and then it will place the value automatically inside <code class="literal">sum</code>. This time it's made so you can't edit <code class="literal">sum</code>, it's set to input after calculating automatically. You can check that it works at <code class="literal">ct/quotation/app_edit.html</code>.</p><p>Until now we have been defining stores in View. However, because we changed the stores into class files, you might have noticed that <code class="literal">ct/ quotation/view_edit.html</code> isn't working properly. At the end of <code class="literal">Quotation</code>, let's make modifications so that the CT will work normally (source file: <code class="literal">06_management_of_dirty_and_undirty_quotation/ct/quotation/view_edit.js</code>):</p><div><pre class="programlisting">Ext.onReady(function() {
    Ext.create('MyApp.store.Customer');
    Ext.create('MyApp.store.QuotationItem');
    Ext.create('MyApp.view.quotation.Quotation', {
      activeItem: 1,
      width: 800,
      height: 600,
      renderTo: Ext.getBody()
    });
});</pre></div><p>Because there is<a id="id134" class="indexterm"/> no controller, the creation of the <code class="literal">store</code> component will not occur. Due to this, if you define and generate it yourself, it will be linked with <code class="literal">storeId</code> and then displayed. Of course, nothing will happen if you press any of the buttons displayed because there is no controller.</p><p>The implementation of <code class="literal">Quotation</code> has been longer and more complicated than anything preceding it. Next is <code class="literal">Bill</code>, which is more or less the same implementation. Please double-check the complex parts as you go.</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec29"/>The Bill form</h1></div></div></div><p>As <a id="id135" class="indexterm"/>we know, <code class="literal">Bill</code> is pretty much the same as <code class="literal">Quotation</code>, but let's continue and implement <code class="literal">Bill</code>. First let's make the <code class="literal">BillItem</code> store class.</p><p>For <code class="literal">Bill</code>, it's <a id="id136" class="indexterm"/>only the class name and <code class="literal">StoreId</code> that differs from <code class="literal">QuotationItem</code>. The rest is the same, so let's try and code this by ourselves. You can check out the following source file if you want something to refer to:</p><p><code class="literal">07_management_of_dirty_and_undirty_bill/app/store/BillItem.js</code></p><p>Next comes the controller setting. Again, the following implementations are extremely similar to what came before in <code class="literal">Quotation</code>, so think back to <code class="literal">MyApp.controller.quotation.Quotation</code> and <code class="literal">MyApp.controller.quotation.Edit</code> and try it for yourself. If you need help, you can find the source files at the following:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">07_management_of_dirty_and_undirty_bill/app/controller/bill/Bill.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">07_management_of_dirty_and_undirty_bill/app/controller/bill/Edit.js</code></li></ul></div><p>Finally, lets modifying <code class="literal">view</code>. In the same way, this is very similar to <code class="literal">EditView</code>, so think back to <code class="literal">MyApp.view.quotation.Edit</code> and try it for yourself. The following is the source file if you need some help:</p><p><code class="literal">07_management_of_dirty_and_undirty_bill/app/view/bill/Edit.js</code></p><p>Let's modify and add the CT. In the same way as the previous step, in order to validate the <code class="literal">EditView</code>, we will build <code class="literal">app.html</code> and <code class="literal">view.html</code> afresh for <code class="literal">Edit</code>.</p><p>What is happening internally is mostly the same, so please refer to the following source files:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">07_management_of_dirty_and_undirty_bill/ct/bill/app_edit.html</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">07_management_of_dirty_and_undirty_bill/ct/bill/app_edit.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">07_management_of_dirty_and_undirty_bill/ct/bill/view_edit.html</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">07_management_of_dirty_and_undirty_bill/ct/bill/view_edit.js</code></li></ul></div><p>Regarding <code class="literal">app_edit.js</code>, in <a id="id137" class="indexterm"/>order for mutual validation to occur with the controller, we install a button on the screen and make an event fire.</p><p>If no errors come up with CT or in the whole application, move to the next section.</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec30"/>Implementing the read and write processes using Ext Direct</h1></div></div></div><p>From here, <a id="id138" class="indexterm"/>we will start to<a id="id139" class="indexterm"/> implement the processing of data being written and read concerning the form that we have made <a id="id140" class="indexterm"/>this far. We'll be using Ext Direct for this as well. Before we continue with the following implementation, there are a few points that you should amend. One of those is to add an <strong>ID</strong> to a session when you log in. Let's amend this now (source file: <code class="literal">08_implement_read_and_write_by_ext_direct/index.php</code>):</p><div><pre class="programlisting">....
"SELECT",
"    COUNT(id) as auth,",
"    users.id,", // &lt;- add
"    users.email,",
....</pre></div><p>Then, store the session ID:</p><div><pre class="programlisting">....
$_SESSION["USERINFO"] = array(
    "id" =&gt; $row["id"], // &lt;- add
    "email" =&gt; $row["email"],
    ....</pre></div><p>Next, add <code class="literal">session_start</code> to the beginning of the router being used by Ext Direct. By doing this, you should be able to access the session with the method from each class (source file: <code class="literal">08_implement_read_and_write_by_ext_direct/php/router.php</code>).</p><div><pre class="programlisting">&lt;?php
session_start(); // &lt;-- add
require('config.php');</pre></div><p>You have prepared <a id="id141" class="indexterm"/>the way, so now let's go ahead and implement the read process for <code class="literal">MyAccount</code>, <code class="literal">Quotation</code>, and <code class="literal">Bill</code>.</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec31"/>Reading data</h1></div></div></div><p>Here, we will<a id="id142" class="indexterm"/> start to learn about how the various sections of our application will read data.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec49"/>MyAccount</h2></div></div></div><p>To begin<a id="id143" class="indexterm"/> with, let's start working on <code class="literal">MyAccount</code>. Let's create a class for Ext Direct. Here we will add the source code for a new PHP.</p><p>Because the source code is going to be a little long to be added to this text, please refer to your source file at: <code class="literal">09_reading_data_myaccount/php/classes/MyAppMyAccount.php</code>.</p><p>Implement the <code class="literal">readForm</code> method. When a person logs in, it acquires the account information from the database by using the saved ID as a reference.</p><p>I'll hold back from explaining the PHP processing that happens around here. The main point is the returned associative array key.</p><p>The access key is a flag that gives the value <code class="literal">true</code> or <code class="literal">false</code> indicating whether the form's acquisition was successful or not. The data for each field is configured as an associative array in the data key. In order to use this <code class="literal">readForm</code> in Ext Direct, update the <code class="literal">REMOTING_API</code> output configurations.</p><p>We will add a new class for Direct (source file: <code class="literal">09_reading_data_myaccount/php/config.php</code>):</p><div><pre class="programlisting">    'MyAppMyAccount' =&gt;array(
        'methods' =&gt; array(
            'readForm' =&gt; array(
                'len' =&gt; 0
            )
        )
    )</pre></div><p>Now there is just a bit more preparation to be done. The CT of <code class="literal">MyAccount</code> is not preset to use Ext Direct, <a id="id144" class="indexterm"/>so we should amend this. First, add <code class="literal">api.php</code> to the HTML. In order to make our database read <code class="literal">api.php</code> just before reading <code class="literal">app.js</code>, we need to add the following code (source file: <code class="literal">09_reading_data_myaccount/ct/myaccount/app.html</code>):</p><div><pre class="programlisting">&lt;script src="img/api.php"&gt;&lt;/script&gt;</pre></div><p>Next, add the Ext Direct <a id="id145" class="indexterm"/>setting to <code class="literal">app.js</code>. Let's add the following code after <code class="literal">Ext.Loader.setConfig</code> (source file: <code class="literal">09_reading_data_myaccount/ct/myaccount/app.js</code>):</p><div><pre class="programlisting">Ext.app.REMOTING_API.url = "../../php/router.php";
Ext.direct.Manager.addProvider(Ext.app.REMOTING_API);</pre></div><p>The <code class="literal">Ext.app.REMOTING_API.url</code> file is being created by <code class="literal">api.php</code> that is being read by <code class="literal">app.html</code>. At this point, the URL path is different for the CT, so you should override this. Now we've finally prepared everything, so let's go on and set up Ext Direct in the <code class="literal">MyAccount</code> form (<code class="literal">view</code>).</p><p>We'll add an <code class="literal">api</code> property to <code class="literal">MyApp.ciew.myaccount.Edit</code> (source file: <code class="literal">09_reading_data_myaccount/app/view/myaccount/Edit.js</code>):</p><div><pre class="programlisting">Ext.define('MyApp.view.myaccount.Edit', {
    ....
    api: {
      load    : 'MyAppMyAccount.readForm',
      submit  : 'MyAppMyAccount.writeForm'</pre></div><p>Set up the object in the <code class="literal">config.php</code> file named <code class="literal">API</code>. Specify <code class="literal">load</code> and <code class="literal">submit</code> inside that key. Set up the character string for the <code class="literal">Ext.Direct</code> function in the same way in which both <code class="literal">load</code> and <code class="literal">submit</code> methods specified their class name in the character string in <code class="literal">Ext.create</code> and <code class="literal">Ext.define</code>.</p><p>Now, because <code class="literal">MyAccount</code> wants to read when it is <code class="literal">onShow</code> (when it's displayed), the <code class="literal">myapp-show</code> event in the CT doesn't fire. So, let's install this button that will cause a pseudo-fire event.</p><p>In the CT subsidiary directory, because we will add a button that's necessary for the fake reproduction of <code class="literal">myapp-show</code>, we need to add the following code inside the <code class="literal">launch</code> method (source file: <code class="literal">09_reading_data_myaccount/ct/myaccount/app.js</code>):</p><div><pre class="programlisting">Ext.widget('button', {
text: 'fire myapp-show',
renderTo: Ext.getBody(),
scope: this,
handler: function() {
            this.getController('myaccount.MyAccount').loadIndex('#!/myaccount');
            }
        });</pre></div><p>We can make<a id="id146" class="indexterm"/> the <code class="literal">myapp-show</code> event mock fire by forcefully implementing a structure that automatically calls the <code class="literal">loadIndex</code> method<a id="id147" class="indexterm"/> that we made a while back. So if you press the button, you can make the event fire. Now, implement the read logic for the form data in the <code class="literal">onShow</code> method.</p><p>Finally, we will implement the controller behavior after <code class="literal">myapp-show</code> fires (source file: <code class="literal">09_reading_data_myaccount/app/controller/myaccount/Edit.js</code>):</p><div><pre class="programlisting">onShow: function(p, owner, params) {
    var me = this,
    editView = me.getEditView(),
    form = editView.getForm();

    p.setLoading();
    form.trackResetOnLoad = true;
    form.isLoading = true;
    form.load({
      success: function(form, ret) {
        p.setLoading(false);
        p.fireEvent('myapp-undirty');
        form.isLoading = false;
        }
    });
},</pre></div><p>It was a fairly short code. The main point is to acquire the <code class="literal">BasicForm</code> object with <code class="literal">getForm</code> and to set <code class="literal">trackResetOnLoad</code> to <code class="literal">true</code>.</p><p>We can use <code class="literal">isLoading</code> to judge a situation when other processing happens while it is asynchronously reading. If we call the <code class="literal">load</code> method, the object we configured before in the <code class="literal">API</code> key is executed and the request is sent to the server. PHP acquires the data from the database and sends it back, and the variable is inserted automatically in the field. We don't need to go through the process of setting the data we receive into the field ourselves.</p><p>After the <code class="literal">MyAccount</code> controller has finished reading the login information, as it's the latest user information, the <code class="literal">myapp-undirty</code> event fires. From then on, the <strong>Save</strong> button can now be pressed if there is a modification. Later, we'll implement a part that will send the data in reverse when the <strong>Save</strong> button is pressed.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec50"/>The Quotation form</h2></div></div></div><p>Now let's implement<a id="id148" class="indexterm"/> the read action in for the <code class="literal">Quotation</code> form. First, set up the Ext Direct in the CT.</p><p>In the same way as we added to <code class="literal">MyAccount</code>, we will add the following code to <code class="literal">app_edit.js</code> (source file: <code class="literal">10_reading_data_quotation/ct/quotation/app_edit.js</code>):</p><div><pre class="programlisting">Ext.app.REMOTING_API.url = "../../php/router.php";
Ext.direct.Manager.addProvider(Ext.app.REMOTING_API);</pre></div><p>Don't forget to read the <code class="literal">API</code> key, so let's set this up now.</p><p>In the same way as we did on the HTML side, make it read the <code class="literal">api.php</code> file to make use of Direct. If you need a reminder, see the source file at <code class="literal">10_reading_data_quotation/ct/quotation/app_edit.html</code>.</p><p>Next, we'll do the preparations on the server side. Like you understood up until now, the process is mostly the same as with <code class="literal">MyAccount</code>.</p><p>We will add a new <code class="literal">API</code> key for <code class="literal">Quotation</code> to <code class="literal">config.php</code> (source file: <code class="literal">10_reading_data_quotation/ct/quotation/app_edit.js</code>):</p><div><pre class="programlisting">    'MyAppQuotation'=&gt;array(
        'methods'=&gt;array(
            'readForm'=&gt;array(
                'len'=&gt;0
            ),
            'writeForm'=&gt;array(
                'len'=&gt;1,
                'formHandler'=&gt;true
            )
        )
    ),
    'MyAppMyAccount'=&gt;array(
        ....
    )</pre></div><p>Next, implement the class you defined with <code class="literal">config.php</code>. We are going to implement the <code class="literal">API</code> key we added to <code class="literal">config.php</code>.</p><p>For the content, please see the following source file for reference:</p><p><code class="literal">10_reading_data_quotation/php/classes/MyAppQuotation.php</code></p><p>Implement the <code class="literal">readForm</code> method<a id="id149" class="indexterm"/>. With the <code class="literal">writeForm</code> method<a id="id150" class="indexterm"/>, in the case of <code class="literal">Quotation</code>, if the complex process to judge whether it is an update or a new addition becomes necessary, in order to judge whether it has an ID or not from the transition that's listed, it can't be implemented in this chapter, so implement it in the next chapter. This is the same with <code class="literal">Bill</code>.</p><p>So, in order to <a id="id151" class="indexterm"/>communicate by using the class on the server side, define the setting in the config <code class="literal">API</code> in the form panel.</p><p>We will define the <code class="literal">API</code> property in the same way as we did for the <code class="literal">MyApp.view.myaccount.Edit</code> class (source file: <code class="literal">10_reading_data_quotation/app/view/quotation/Edit.js</code>).</p><p>Define the <code class="literal">myapp-show</code> event handler<a id="id152" class="indexterm"/>. This will be quite a long source code. So, while being careful to look out for the new and edit points inside the <code class="literal">onShow</code> method, try it out by using the following source file for reference:</p><p><code class="literal">10_reading_data_quotation/app/controller/quotation/Edit.js</code></p><p>The functions have been divided into <code class="literal">onEditShow</code> and <code class="literal">onNewShow</code>. This time, only <code class="literal">onEditShow</code> method<a id="id153" class="indexterm"/> will run. With a later-listed implementation, newly made processes and the processes that are divided after editing are also implemented.</p><p>After it has finished reading, fire <code class="literal">myapp-undirty</code> in order to know whether it is in a clean condition. The button to fire the <code class="literal">myapp-show</code> event is already installed in the CT, so if you press the button, it will signal and begin to read.</p><p>Of course it's the processing of the <code class="literal">readForm</code> method, so it's only the fixed test data that will be read. But we can implement the reading from the database with SQL along with the implementation of <code class="literal">writeForm</code> that happens in the next chapter. With the name specified on the server side, we need to set a name in the field on the client side. If the name is correctly set up, the data should be inserted automatically.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec51"/>The Bill form</h2></div></div></div><p>Finally, implement <code class="literal">Bill</code> in the <a id="id154" class="indexterm"/>same way as <code class="literal">Quotation</code>. Firstly, configure Ext Direct in the CT.</p><p>Like in the previous step, we will add the code necessary for Direct (source file: <code class="literal">11_reading_data_bill/ct/bill/app_edit.js</code>).</p><p>Configure it without forgetting about reading the <code class="literal">API</code> key. This also repeats the process of making the HTML read <code class="literal">api.php</code> (source file: <code class="literal">11_reading_data_bill/ct/bill/app_edit.html</code>).</p><p>Now prepare the server side. We will add the <code class="literal">API</code> class for Direct that's used by the <code class="literal">Bill</code> class (source file: <code class="literal">11_reading_data_bill/php/config.php</code>):</p><div><pre class="programlisting">    'MyAppBill'=&gt;array(
        'methods'=&gt;array(
            'readForm'=&gt;array(
                'len'=&gt;0
            ),
            'writeForm'=&gt;array(
                'len'=&gt;1,
                'formHandler'=&gt;true
            )
        )
    ),
    'MyAppQuotation'=&gt;array(</pre></div><p>Next, implement the class defined by <code class="literal">config.php</code>.</p><p>Because the <a id="id155" class="indexterm"/>code is very long, please refer to the following source file on this occasion:</p><p><code class="literal">11_reading_data_bill/php/classes/MyAppBill.php</code></p><p>Then, configure the direct function in the <code class="literal">API</code> config file. Let's define the API property in the same way as we did for the <code class="literal">MyApp.view.quotation.Edit</code> class (source file: <code class="literal">11_reading_data_bill/app/view/bill/Edit.js</code>).</p><p>Finally, implement the event handler <code class="literal">myapp-show</code>. This is really similar to the implementation of <code class="literal">MyApp.controller.quotation.Edit</code>, so please try it for yourself. If you need to, you can refer to the source file at <code class="literal">11_reading_data_bill/app/view/bill/Edit.js</code>.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec32"/>Writing data and validations</h1></div></div></div><p>In regard to the <a id="id156" class="indexterm"/>writing process, as I mentioned before, just implement <code class="literal">MyAccount</code> and implement <code class="literal">writeForm</code> of <code class="literal">MyAccount</code>.</p><p>This is also<a id="id157" class="indexterm"/> quite long, so please refer to the source file <code class="literal">12_writing_data_and_validations/php/classes/MyAppMyAccount.php</code>.</p><p>The content of the process is simple; however, if you look at the PHP code, it looks pretty complicated. I'll try to explain it simply.</p><p>First, to return the associative array as a return value in the same way as the others, we have to set <code class="literal">success</code> as <code class="literal">true</code> and relay to the client that the writing process has finished normally.</p><p>At the beginning, there are places where we set the associative array with a key called <code class="literal">errors</code>, then set a field name key inside and insert a message. This is the input check on the server side.</p><p>If you use Ext Direct, this completes the input check.</p><p>Under errors, put in the field name for the error target and just by entering the error message in there, the server side automatically displays a red frame. If you hover the mouse over it, the message you set up on the server side is displayed. In other words, you need zero lines of programming code on the client side for error processing.</p><p>Normally, <a id="id158" class="indexterm"/>you receive the JSON data by communicating through AJAX,  but we need to define the error processing on the client side and the server side. So, I'm sure we would all prefer to use Ext Direct, which automatically processes this for us.</p><div><div><h3 class="title"><a id="tip04"/>Tip</h3><p>If you get used to this way of developing, you'll get hooked and you won't be able to go back.</p></div></div><p>Again, because you can wholly separate the client side and server side, one engineer does not need to construct both. Instead, it's possible to progress the work by completely separating the server side and client side. Once the input check has been passed, the user information is acquired from the database where the session ID is being saved.</p><p>Finally,<a id="id159" class="indexterm"/> set up the success key that displays <code class="literal">true</code> when the processing has been completed. <code class="literal">writeForm</code> is an implemented method used when writing form data. In the member on the server side that writes the form data, you need to set the <code class="literal">formHandler</code> method<a id="id160" class="indexterm"/> to <code class="literal">true</code>.</p><p>Everyone already has <code class="literal">formHandler</code> in <code class="literal">config.php</code> set to <code class="literal">true</code>, but when you get down to defining your own projects in a similar way, people often encounter problems when they forget to set the <code class="literal">formHandler</code> method to <code class="literal">true</code> meaning the data is not sent.</p><div><div><h3 class="title"><a id="tip05"/>Tip</h3><p>Set the <code class="literal">formHandler</code> method to <code class="literal">true</code>.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec33"/>Summary</h1></div></div></div><p>Great work so far! This was quite a long chapter, but this was also integral to our application (yes, all the chapters are integral, but this one more so!).</p><p>In this chapter, we started with the login screen and then implemented the <code class="literal">Edit</code> screen that uses forms from each screen. At the end, we learnt about Ext Direct.</p><p>In the next chapter, we'll implement the <code class="literal">List</code> and <code class="literal">Search</code> functions for each screen that uses Ext Direct. Have a quick coffee break and carry on when you're ready!</p></div></body></html>