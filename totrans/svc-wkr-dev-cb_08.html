<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Experimenting with Web Push</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Implementing a simple push notification</li><li class="listitem" style="list-style-type: disc">Showing rich push notifications</li><li class="listitem" style="list-style-type: disc">Using the notification tag</li><li class="listitem" style="list-style-type: disc">Implementing push clients</li><li class="listitem" style="list-style-type: disc">Subscribing to push notifications</li><li class="listitem" style="list-style-type: disc">Managing push notification quotas</li></ul></div><div><div><div><div><h1 class="title"><a id="ch08lvl1sec60"/>Introduction</h1></div></div></div><p>Push notifications have been popular with the features in mobile phone applications for the last few years. Regardless of whether you have an app opened, running in the foreground, or not running at all, push notifications will pop a message on your mobile phone. Similar to this, there is a new API available for the web called <a id="id363" class="indexterm"/>
<strong>Push API</strong>, which is an experimental technology at the time of writing. In order to make Push API work, we need to have an active service worker running and must have subscribed to push notifications.</p><p>Let's start off this chapter by looking at how to implement a simple push notification.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec61"/>Implementing a simple push notification</h1></div></div></div><p>Fetching remote resources <a id="id364" class="indexterm"/>can be done in different ways. In this recipe, we are going to look at two standard ways of fetching a remote resource using a service worker <a id="id365" class="indexterm"/>with and without <strong>cross-origin HTTP requests</strong> (<strong>CORS</strong>).</p><p>If you want to learn more about CORS, follow this link:</p><p>
<a class="ulink" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS">https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS</a>
</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec163"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the <em>Setting up service workers</em> recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the <em>Setting up GitHub pages for SSL</em> recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec164"/>How to do it...</h2></div></div></div><p>Follow these<a id="id366" class="indexterm"/> instructions to set up your file structure:</p><div><ol class="orderedlist arabic"><li class="listitem">Copy the <code class="literal">index.html</code>, <code class="literal">index.js</code>, <code class="literal">service-worker.js</code>, <code class="literal">manifest.json</code>, <code class="literal">server.js</code>, <code class="literal">package.json</code>, and <code class="literal">style.css</code> files from the following location:<p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/08/01/">https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/08/01/</a>
</p></li><li class="listitem">Run <code class="literal">npm install</code> from the command line.</li><li class="listitem">Go to <a class="ulink" href="https://console.developers.google.com/project">https://console.developers.google.com/project</a> and create an API project. Obtain a sender ID (project number) and replace <code class="literal">gcm_sender_id</code> in the <code class="literal">manifest.json</code> file. Also replace the <code class="literal">&lt;GCM API KEY&gt;</code> placeholder in the <code class="literal">server.js</code> file.<div><pre class="programlisting">webPush.setGCMAPIKey(/*GCM API KEY*/);</pre></div></li><li class="listitem">Run <code class="literal">npm start</code> to kick off a server.</li><li class="listitem">Open a browser and go to <code class="literal">index.html</code>. Make sure that you don't open the browser in the incognito mode. Click on the <strong>Send Notification!</strong> button to send a notification.<div><img src="img/B05381_08_01.jpg" alt="How to do it..."/></div></li><li class="listitem">Open<a id="id367" class="indexterm"/> the Developer Toolbar (<em>Cmd</em> + <em>Alt</em> + <em>I</em> or <em>F12</em>). Now refresh the page and look at the messages in the console. You will see that the fetch requests are logged out into the console.<div><img src="img/B05381_08_02.jpg" alt="How to do it..."/></div></li><li class="listitem">You will be prompted by your browser to allow notifications.<div><img src="img/B05381_08_03.jpg" alt="How to do it..."/></div></li><li class="listitem">Soon <a id="id368" class="indexterm"/>you will receive the notification. (It might also take some time depending on your configuration.)<div><img src="img/B05381_08_04.jpg" alt="How to do it..."/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec165"/>How it works...</h2></div></div></div><p>At the beginning of the <code class="literal">index.js</code> file, we specify the base URL we use for the server.</p><div><pre class="programlisting">var baseURL = 'https://localhost:3012/';</pre></div><p>Next, in order to get the user subscription to the push service, we use <code class="literal">pushManager</code>.</p><div><pre class="programlisting">return registration.pushManager.getSubscription()</pre></div><p>If a subscription was found, it will be returned. Otherwise, the user is subscribed.</p><div><pre class="programlisting">return registration.pushManager.getSubscription()
  .then(function(subscription) {
    if (subscription) {
      return subscription;
    }

    return registration.pushManager.subscribe({ userVisibleOnly: true });
  });</pre></div><p>Next, we <a id="id369" class="indexterm"/>will send subscription details to the server.</p><div><pre class="programlisting">fetch(baseURL + 'register', {
    method: 'post',
    headers: {
      'Content-type': 'application/json'
    },
    body: JSON.stringify({
      endpoint: subscription.endpoint,
    }),
  });</pre></div><p>This will make the server send a notification to the client.</p><div><pre class="programlisting">document.querySelector('#send').onclick = function() {
  var delay = document.querySelector('#notification-delay').value;
  var ttl = document.querySelector('#notification-ttl').value;

  fetch(baseURL + 'sendNotification?endpoint=' + endpoint + '&amp;delay=' + delay +
        '&amp;ttl=' + ttl,
    {
      method: 'post',
    }
  );
};</pre></div><p>We will add a section to the <code class="literal">index.html</code> file for the input fields for the delay as well as the active time.</p><div><pre class="programlisting">&lt;section id="notification-input"&gt;
    &lt;form&gt;
      &lt;h1&gt;Notification&lt;/h1&gt;
      Delay Time&amp;nbsp;&lt;input id='notification-delay' type='number' value='2'&gt;&lt;/input&gt; &lt;small&gt;s&lt;/small&gt;&lt;br/&gt;
      &lt;br/&gt;
      Active Time&amp;nbsp;&lt;input id='notification-ttl' type='number' value='0'&gt;&lt;/input&gt; &lt;small&gt;s&lt;/small&gt;&lt;br/&gt;
    &lt;/form&gt;
    &lt;button id="send"&gt;Send Notification!&lt;/button&gt;
&lt;/section&gt;</pre></div><p>We will use a <code class="literal">manifest.json</code> file for Google Chrome support.</p><div><pre class="programlisting">{
  "name": "Simple Push Notification",
  "short_name": "push-simple",
  "start_url": "./index.html",
  "display": "standalone",
  "gcm_sender_id": "46143029380",
  "gcm_user_visible_only": true
}</pre></div><p>In the <code class="literal">service-worker.js</code> file, we<a id="id370" class="indexterm"/> will add an event listener for registering the push event.</p><div><pre class="programlisting">'use strict';

self.addEventListener('push', function(event) {
  event.waitUntil(
    self.registration.showNotification('SW Push Notification', {
      body: 'Notification received!',
    })
  );
}); </pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec62"/>Showing rich notifications</h1></div></div></div><p>Rich push<a id="id371" class="indexterm"/> notifications can send images, vibration patterns, and localized notifications. Let's look at how we can achieve this.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec166"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the <em>Setting up service workers</em> recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the <em>Setting up GitHub pages for SSL</em> recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec167"/>How to do it...</h2></div></div></div><p>Follow these instructions to set up your file structure:</p><div><ol class="orderedlist arabic"><li class="listitem">Copy the <code class="literal">index.html</code>, <code class="literal">index.js</code>, <code class="literal">service-worker.js</code>, <code class="literal">manifest.json</code>, <code class="literal">server.js</code>, <code class="literal">package.json</code>, <code class="literal">amazon-logo.png</code>, and <code class="literal">style.css</code> files from the following location:<p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/08/03/">https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/08/03/</a>
</p></li><li class="listitem">Open a browser and go to <code class="literal">index.html</code>.<div><img src="img/B05381_08_05.jpg" alt="How to do it..."/></div></li><li class="listitem">You<a id="id372" class="indexterm"/> can change the delay time as well as the active time by changing them in the input fields.<div><img src="img/B05381_08_06.jpg" alt="How to do it..."/></div></li><li class="listitem">You may be prompted to allow push notifications.<div><img src="img/B05381_08_07.jpg" alt="How to do it..."/></div></li><li class="listitem">Soon<a id="id373" class="indexterm"/> you will receive the notification. (It might also take some time depending on your configuration.)<div><img src="img/B05381_08_08.jpg" alt="How to do it..."/></div></li><li class="listitem">Open the Developer Toolbar (<em>Cmd</em> + <em>Alt</em> + <em>I</em> or <em>F12</em>). Now refresh the page and look at the messages in the console.<div><img src="img/B05381_08_09.jpg" alt="How to do it..."/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec168"/>How it works...</h2></div></div></div><p>In the <code class="literal">index.js</code> file, we <a id="id374" class="indexterm"/>will handle the click event when the user clicks on the button.</p><p>This will make the server send a notification to the client.</p><div><pre class="programlisting">document.querySelector('#send').onclick = function() {
  var delay = document.querySelector('#notification-delay').value;
  var ttl = document.querySelector('#notification-ttl').value;

  fetch(baseURL + 'sendNotification?endpoint=' + endpoint + '&amp;delay=' + delay +
        '&amp;ttl=' + ttl,
    {
      method: 'post',
    }
  );
};</pre></div><p>In the <code class="literal">service-worker.js</code> file, we will add an event listener to register the push event.</p><div><pre class="programlisting">'use strict';

self.addEventListener('push', function(event) {
  event.waitUntil(
    self.registration.showNotification('SW Rich Push Notification', {
      body: 'Richer than richest',
      icon: 'amazon-logo.png',
      vibrate: [300, 100, 300]
    })
  );
});</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec63"/>Using the notification tag</h1></div></div></div><p>In order to <a id="id375" class="indexterm"/>replace old notifications, we can use the notification tag. This will help us show up-to-date information to the user.</p><p>This recipe will show you how to manage a queue of notifications and discard previous notifications or merge them into a single notification.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec169"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the first recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>: <em>Setting up service workers</em>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the <em>Setting up GitHub pages for SSL</em> recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec170"/>How to do it...</h2></div></div></div><p>Follow these instructions to set up your file structure:</p><div><ol class="orderedlist arabic"><li class="listitem">Copy the <code class="literal">index.html</code>, <code class="literal">index.js</code>, <code class="literal">service-worker.js</code>, <code class="literal">manifest.json</code>, <code class="literal">server.js</code>, <code class="literal">package.json</code>, and <code class="literal">style.css</code> files from the following location:<p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/08/04/">https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/08/04/</a>
</p></li><li class="listitem">Open a browser and go to <code class="literal">index.html</code>.<div><img src="img/B05381_08_10.jpg" alt="How to do it..."/></div></li><li class="listitem">Soon <a id="id376" class="indexterm"/>you will receive the notification. (It might also take some time depending on your configuration.)<div><img src="img/B05381_08_13.jpg" alt="How to do it..."/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec171"/>How it works...</h2></div></div></div><p>In the <code class="literal">service-worker.js</code> file, we will add an event listener to register the push event. Note the <code class="literal">tag</code> element passed into the <code class="literal">showNotification</code> method.</p><div><pre class="programlisting">'use strict';

self.addEventListener('push', function(event) {
  event.waitUntil(
     self.registration.showNotification('SW Push Notification', {
      body: 'Notification ' + count++,
      tag: 'swc'
    })  );
});</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec64"/>Implementing push clients</h1></div></div></div><p>Push clients<a id="id377" class="indexterm"/> enables us to focus on the tab that our app is running on when the user clicks on a notification message. We can even reopen our app if it was closed.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec172"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the first recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>, <em>Setting up service workers</em>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the following recipes of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>: <em>Setting up GitHub pages for SSL</em>, <em>Setting up SSL for Windows</em>, and <em>Setting up SSL for Mac</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec173"/>How to do it...</h2></div></div></div><p>Follow these instructions to set up your file structure:</p><div><ol class="orderedlist arabic"><li class="listitem">Copy the <code class="literal">index.html</code>, <code class="literal">index.js</code>, <code class="literal">service-worker.js</code>, <code class="literal">manifest.json</code>, <code class="literal">server.js</code>, <code class="literal">package.json</code>, and <code class="literal">style.css</code> files from the following location:<p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/08/05/">https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/08/05/</a>
</p></li><li class="listitem">Run <code class="literal">npm install</code> from the command line.</li><li class="listitem">Go to <a class="ulink" href="https://console.developers.google.com/project">https://console.developers.google.com/project</a> and create an API project. Obtain a sender ID (project number) and replace <code class="literal">gcm_sender_id</code> in the <code class="literal">manifest.json</code> file. Also replace the <code class="literal">&lt;GCM API KEY&gt;</code> placeholder in the <code class="literal">server.js</code> file.<div><pre class="programlisting">webPush.setGCMAPIKey(/*GCM API KEY*/);</pre></div></li><li class="listitem">Run <code class="literal">npm start</code> to kick off a server.</li><li class="listitem">Open a browser and go to <code class="literal">index.html</code>. Make sure that you don't open the browser in the incognito mode. Insert some text in the <strong>Payload</strong> field and click on the <strong>Send Notification!</strong> button to send a notification.<div><img src="img/B05381_08_14.jpg" alt="How to do it..."/></div></li><li class="listitem">Open the<a id="id378" class="indexterm"/> Developer Toolbar (<em>Cmd</em> + <em>Alt</em> + <em>I</em> or <em>F12</em>). Now refresh the page and look at the messages in the console. You will see that the fetch requests are logged out into the console.<div><img src="img/B05381_08_11.jpg" alt="How to do it..."/></div></li><li class="listitem">You will be <a id="id379" class="indexterm"/>prompted by your browser to allow notifications.<div><img src="img/B05381_08_12.jpg" alt="How to do it..."/></div></li><li class="listitem">Soon you will start to receive notifications. (It might also take some time depending on your configuration.)<div><img src="img/B05381_08_17.jpg" alt="How to do it..."/></div></li><li class="listitem">Clicking on this first notification will take you to the page your app is running.<div><img src="img/B05381_08_18.jpg" alt="How to do it..."/></div></li><li class="listitem">Clicking <a id="id380" class="indexterm"/>on the second notification will not do anything.<div><img src="img/B05381_08_19.jpg" alt="How to do it..."/></div></li><li class="listitem">Clicking on the third notification will open a new page with your app running.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec174"/>How it works...</h2></div></div></div><p>At the beginning of the <code class="literal">index.js</code> file, we will specify the base URL we use for the server.</p><div><pre class="programlisting">var baseURL = 'https://localhost:3012/'; </pre></div><p>Next, in order to get the user subscription to the push service, we use <code class="literal">pushManager</code>.</p><div><pre class="programlisting">return registration.pushManager.getSubscription()</pre></div><p>If a subscription was found, this will be returned. Otherwise the user will be subscribed.</p><div><pre class="programlisting">return registration.pushManager.getSubscription()
  .then(function(subscription) {
    if (subscription) {
      return subscription;
    }

    return registration.pushManager.subscribe({ userVisibleOnly: true });
});</pre></div><p>Next, we will send subscription details to the server.</p><div><pre class="programlisting">fetch(baseURL + 'register', {
    method: 'post',
    headers: {
      'Content-type': 'application/json'
    },
    body: JSON.stringify({
      endpoint: subscription.endpoint,
    }),
});</pre></div><p>The <code class="literal">send</code> button<a id="id381" class="indexterm"/> enables the server to send a notification to the client with the payload we specified in the form.</p><div><pre class="programlisting">document.querySelector('#send').onclick = function() {
  fetch(baseURL + 'sendNotification?endpoint=' + endpoint, {
      method: 'post',
  });
};</pre></div><p>We will add a section to the <code class="literal">index.html</code> file for instructing the user about the notification messages.</p><div><pre class="programlisting">&lt;section id="notification-input"&gt;
    &lt;form&gt;
      &lt;h1&gt;Notification&lt;/h1&gt;
      &lt;p&gt;&lt;strong&gt;Click 'Send notification' &amp;amp; try:&lt;/strong&gt;&lt;/p&gt;
      &lt;ul&gt;
        &lt;li&gt;Close this page: Click the notification, and it will be reopened.&lt;/li&gt;
        &lt;li&gt;Switch to another page: Click the notification, and it will be re-focused&lt;/li&gt;
        &lt;li&gt;Remain on current page: A different notification will be shown, Clicking will not do anything.&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/form&gt;
    &lt;button id="send"&gt;Send Notification!&lt;/button&gt;
&lt;/section&gt;</pre></div><p>We use a <code class="literal">manifest.json</code> file for Google Chrome support.</p><div><pre class="programlisting">{
  "name": "SW Push Clients Notification",
  "short_name": "push-clients",
  "start_url": "./index.html",
  "display": "standalone",
  "gcm_sender_id": "46143029380",
  "gcm_user_visible_only": true
}</pre></div><p>In the <code class="literal">service-worker.js</code> file, we will receive the payload and add an event listener for registering the<a id="id382" class="indexterm"/> push event.</p><div><pre class="programlisting">'use strict';

self.addEventListener('push', function(event) {
  event.waitUntil(
    self.clients.matchAll().then(function(clients) {

      var focused = clients.some(function(client) {
        return client.focused;
      });

      var notificationMessage;

      if (focused) {
        notificationMessage = 'Same Page';
      } else if (clients.length &gt; 0) {
        notificationMessage = 'Diffrerent Page, ' +
                              'click here to gain focus';
      } else {
        notificationMessage = 'Page Closed, ' +
                              'click here to re-open it!';
      }

      return self.registration.showNotification('ServiceWorker Cookbook', {
        body: notificationMessage,
      });
    })
  );
});</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec65"/>Subscribing to push notifications</h1></div></div></div><p>This recipe<a id="id383" class="indexterm"/> will teach you how to use push notifications with subscription management, enabling users to subscribe for features that your app will expose to keep in touch.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec175"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the first recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>, <em>Setting up service workers</em>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the following recipes of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>: <em>Setting up GitHub pages for SSL</em>, <em>Setting up SSL for Windows</em>, and <em>Setting up SSL for Mac</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec176"/>How to do it...</h2></div></div></div><p>Follow these <a id="id384" class="indexterm"/>instructions to set up your file structure:</p><div><ol class="orderedlist arabic"><li class="listitem">Copy the <code class="literal">index.html</code>, <code class="literal">index.js</code>, <code class="literal">service-worker.js</code>, <code class="literal">manifest.json</code>, <code class="literal">server.js</code>, <code class="literal">package.json</code>, and <code class="literal">style.css</code> files from the following location:<p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/08/06/">https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/08/06/</a>
</p></li><li class="listitem">Run <code class="literal">npm install</code> from the command line.</li><li class="listitem">Go to <a class="ulink" href="https://console.developers.google.com/project">https://console.developers.google.com/project</a> and create an API project. Obtain a sender ID (project number) and replace <code class="literal">gcm_sender_id</code> in the <code class="literal">manifest.json</code> file. Also replace the <code class="literal">&lt;GCM API KEY&gt;</code> placeholder in the <code class="literal">server.js</code> file.<div><pre class="programlisting">webPush.setGCMAPIKey(/*GCM API KEY*/);</pre></div></li><li class="listitem">Run <code class="literal">npm start</code> to kick off a server.</li><li class="listitem">Open a browser and go to <code class="literal">index.html</code>. Make sure that you don't open the browser in the incognito mode. Click on the <strong>Subscribe</strong> button. The button will change into <strong>Unsubscribe</strong>.<div><img src="img/B05381_08_20.jpg" alt="How to do it..."/></div></li><li class="listitem">Open<a id="id385" class="indexterm"/> the Developer Toolbar (<em>Cmd</em> + <em>Alt</em> + <em>I</em> or <em>F12</em>). Now refresh the page and look at the messages in the console. You will see that the fetch requests are logged out into the console.<div><img src="img/B05381_08_21.jpg" alt="How to do it..."/></div></li><li class="listitem">You might be prompted by your browser to allow notifications.<div><img src="img/B05381_08_22.jpg" alt="How to do it..."/></div></li><li class="listitem">Soon <a id="id386" class="indexterm"/>you will receive notifications. (It might also take some time depending on your configuration.) Once you click on the <strong>Unsubscribe</strong> button, the notifications will no longer appear.<div><img src="img/B05381_08_23.jpg" alt="How to do it..."/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec177"/>How it works...</h2></div></div></div><p>At the beginning of the <code class="literal">index.js</code> file, we will specify the base URL we use for the server.</p><div><pre class="programlisting">var baseURL = 'https://localhost:3012/'; </pre></div><p>Next, in order to get the user subscription to the push service, we use <code class="literal">pushManager</code>.</p><div><pre class="programlisting">return registration.pushManager.getSubscription()</pre></div><p>If a subscription was found, it will be returned. Otherwise the user is subscribed.</p><div><pre class="programlisting">return registration.pushManager.getSubscription()
  .then(function(subscription) {
    if (subscription) {
      return subscription;
    }

    return registration.pushManager.subscribe({ userVisibleOnly: true });
});</pre></div><p>Next, we <a id="id387" class="indexterm"/>will send subscription details to the server.</p><div><pre class="programlisting">fetch(baseURL + 'register', {
    method: 'post',
    headers: {
      'Content-type': 'application/json'
    },
    body: JSON.stringify({
      endpoint: subscription.endpoint,
    }),
  });</pre></div><p>The button enables the server to send a notification to the client with the payload we specified in the form.</p><div><pre class="programlisting">document.querySelector('#subscription-button').onclick = function() {
  fetch(baseURL + 'sendNotification?endpoint=' + endpoint, {
      method: 'post',
  });
};</pre></div><p>In order to manage subscriptions we will add toggle logic.</p><div><pre class="programlisting">function unsubscribe() {
  getSubscription().then(function(subscription) {
    return subscription.unsubscribe()
      .then(function() {
        console.log('Unsubscribed', subscription.endpoint);
        return fetch('unregister', {
          method: 'post',
          headers: {
            'Content-type': 'application/json'
          },
          body: JSON.stringify({
            endpoint: subscription.endpoint
          })
        });
      });
  }).then(setSubscribeButton);
}

function setSubscribeButton() {
  subscriptionBtn.onclick = subscribe;
  subscriptionBtn.textContent = 'Subscribe!';
}

function setUnsubscribeButton() {
  subscriptionBtn.onclick = unsubscribe;
  subscriptionBtn.textContent = 'Unsubscribe!';
}</pre></div><p>We will <a id="id388" class="indexterm"/>add a section to the <code class="literal">index.html</code> file for instructing the user about the notification messages.</p><div><pre class="programlisting">&lt;section id="notification-input"&gt;
    &lt;form&gt;
      &lt;h1&gt;Notification&lt;/h1&gt;
      &lt;p&gt;Click to subscribe&lt;/p&gt;
    &lt;/form&gt;
    &lt;button id="subscription-button" disabled=true&gt;&lt;/button&gt;
&lt;/section&gt;</pre></div><p>We will use a <code class="literal">manifest.json</code> file for Google Chrome support.</p><div><pre class="programlisting">{
  "name": "SW Push Notification Subscription Management",
  "short_name": "push-with_subscription",
  "start_url": "./index.html",
  "display": "standalone",
  "gcm_sender_id": "46143029380",
  "gcm_user_visible_only": true
}</pre></div><p>In the <code class="literal">service-worker.js</code> file, we will receive the payload and add an event listener for registering the push event.</p><div><pre class="programlisting">'use strict';

self.addEventListener('push', function(event) {
  event.waitUntil(self.registration.showNotification('ServiceWorker Cookbook', {
    body: 'Push Notification Subscription Management'
  }));
});

self.addEventListener('pushsubscriptionchange', function(event) {
  console.log('Subscription expired');
  event.waitUntil(
    self.registration.pushManager.subscribe({ userVisibleOnly: true })
    .then(function(subscription) {
      console.log('Subscribed after expiration', subscription.endpoint);
      return fetch('register', {
        method: 'post',
        headers: {
          'Content-type': 'application/json'
        },
        body: JSON.stringify({
          endpoint: subscription.endpoint
        })
      });
    })
  );
});</pre></div><p>In the <code class="literal">server.js</code> file, we will send notifications to the push service.</p><div><pre class="programlisting">function sendNotification(endpoint) {
  webPush.sendNotification(endpoint).then(function() {
    console.log('Push Application Server - Notification sent to ' + endpoint);
  }).catch(function() {
    console.log('ERROR in sending Notification, endpoint removed ' + endpoint);
    subscriptions.splice(subscriptions.indexOf(endpoint), 1);
  });
}</pre></div><p>For the <a id="id389" class="indexterm"/>purpose of demonstration, we will simulate the event that has occurred by sending a notification in every <code class="literal">pushInterval</code> to the registered end point. So, you will see notifications coming in rapidly.</p><div><pre class="programlisting">setInterval(function() {
  subscriptions.forEach(sendNotification);
}, pushInterval * 1000);

function isSubscribed(endpoint) {
  return (subscriptions.indexOf(endpoint) &gt;= 0);
}</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec66"/>Managing push notification quotas</h1></div></div></div><p>In this recipe, we <a id="id390" class="indexterm"/>are going to experiment with the quota management policies of different browsers. We will attempt to send as many notifications as possible to test against opened and closed tabs, clicking on notifications as well as ignoring them.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec178"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the <em>Setting up service workers</em> recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the following recipes of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <em>Learning Service Worker Basics</em>: <em>Setting up GitHub pages for SSL</em>, <em>Setting up SSL for Windows</em>, and <em>Setting up SSL for Mac</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec179"/>How to do it...</h2></div></div></div><p>Follow these instructions to set up your file structure:</p><div><ol class="orderedlist arabic"><li class="listitem">Copy the <code class="literal">index.html</code>, <code class="literal">index.js</code>, <code class="literal">service-worker.js</code>, <code class="literal">manifest.json</code>, <code class="literal">server.js</code>, <code class="literal">package.json</code>, and <code class="literal">style.css</code> files from the following location:<p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/08/07/">https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/08/07/</a>
</p></li><li class="listitem">Run <code class="literal">npm install</code> from the command line.</li><li class="listitem">Go to <a class="ulink" href="https://console.developers.google.com/project">https://console.developers.google.com/project</a> and create an API project. Obtain a sender ID (project number) and replace <code class="literal">gcm_sender_id</code> in the <code class="literal">manifest.json</code> file. Also, replace the <code class="literal">&lt;GCM API KEY&gt;</code> placeholder in the <code class="literal">server.js</code> file.<div><pre class="programlisting">webPush.setGCMAPIKey(/*GCM API KEY*/);</pre></div></li><li class="listitem">Run <code class="literal">npm start</code> to kick off a server.</li><li class="listitem">Open a browser and go to <code class="literal">index.html</code>. Make sure that you don't open the browser in the incognito mode. Click on either the <strong>Visible notifications</strong> or <strong>Invisible notifications</strong> button.<div><img src="img/B05381_08_24.jpg" alt="How to do it..."/></div></li><li class="listitem">Open<a id="id391" class="indexterm"/> the Developer Toolbar (<em>Cmd</em> + <em>Alt</em> + <em>I</em> or <em>F12</em>). Now refresh the page and look at the messages in the console. You will see that the fetch requests are logged out into the console.<div><img src="img/B05381_08_25.jpg" alt="How to do it..."/></div></li><li class="listitem">You may <a id="id392" class="indexterm"/>be prompted by your browser to allow notifications.<div><img src="img/B05381_08_26.jpg" alt="How to do it..."/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec180"/>How it works...</h2></div></div></div><p>At the beginning of the <code class="literal">index.js</code> file, we will specify the base URL we use for the server.</p><div><pre class="programlisting">var baseURL = 'https://localhost:3012/'; </pre></div><p>Next, in order to get the user subscription to the push service, we use <code class="literal">pushManager</code>.</p><div><pre class="programlisting">return registration.pushManager.getSubscription()</pre></div><p>If a subscription was found, that will be returned. Otherwise the user is subscribed.</p><div><pre class="programlisting">return registration.pushManager.getSubscription()
  .then(function(subscription) {
    if (subscription) {
      return subscription;
    }

  return registration.pushManager.subscribe({ userVisibleOnly: true });
});</pre></div><p>We will <a id="id393" class="indexterm"/>also retrieve the user's public key.</p><div><pre class="programlisting">var rawKey = subscription.getKey ? subscription.getKey('p256dh') : '';
key = rawKey ?
btoa(String.fromCharCode.apply(null, new Uint8Array(rawKey))) : '';
var rawAuthSecret = subscription.getKey ? subscription.getKey('auth') : '';
authSecret = rawAuthSecret ?
btoa(String.fromCharCode.apply(null, new Uint8Array(rawAuthSecret))) : '';

  endpoint = subscription.endpoint;</pre></div><p>Next, we will send subscription details to the server.</p><div><pre class="programlisting">fetch(baseURL + 'register', {
    method: 'post',
    headers: {
      'Content-type': 'application/json'
    },
    body: JSON.stringify({
      endpoint: subscription.endpoint,
      key: key,
      authSecret: authSecret
    }),
  });</pre></div><p>We will ask the server to send the client a notification for testing purposes.</p><div><pre class="programlisting">fetch(baseURL + 'sendNotification', {
    method: 'post',
    headers: {
      'Content-type': 'application/json'
    },
    body: JSON.stringify({
      endpoint: endpoint,
      key: key,
      visible: visible,
      num: notificationNum,
    }),
  });</pre></div><p>The <code class="literal">clear</code> button<a id="id394" class="indexterm"/> clears the notification cache, which stores the number of notifications received.</p><div><pre class="programlisting">document.querySelector('#clear').onclick = function() {
  window.caches.open('notifications').then(function(cache) {
    Promise.all([
      cache.put(new Request('invisible'), new Response('0', {
        headers: {
          'content-type': 'application/json'
        }
      })),
      cache.put(new Request('visible'), new Response('0', {
        headers: {
          'content-type': 'application/json'
        }
      })),
    ]).then(function() {
      updateNotificationNumbers();
    });
  });
};</pre></div><p>Update the UI by reading the number of notifications received.</p><div><pre class="programlisting">function updateNotificationNumbers() {
  window.caches.open('notifications').then(function(cache) {
    ['visible', 'invisible'].forEach(function(type) {
      cache.match(type).then(function(res) {
        if(res) {
          res.text().then(function(text) {
            document.getElementById('sent-' + type).textContent = text;
          });
        }
      });
    });
  });
}</pre></div><p>Also, update the number of notifications received periodically.</p><div><pre class="programlisting">window.onload = function() {
  updateNotificationNumbers();
  setInterval(updateNotificationNumbers, 1000);
};</pre></div><p>We will add<a id="id395" class="indexterm"/> a section to the <code class="literal">index.html</code> file for instructing the user about the notification messages.</p><div><pre class="programlisting">&lt;section id="notification-input"&gt;
    &lt;ul&gt;
      &lt;li&gt;Select &lt;strong&gt;Visible notifications&lt;/strong&gt; - They will appear one after another on your screen. The quota will not be enforced;&lt;/li&gt;
      &lt;li&gt;Select &lt;strong&gt;Invisible notifications&lt;/strong&gt; - They won't appear on your screen, but the number at the bottom of the page will update once the page is re-opened, to indicate the number of invisible notifications sent before reaching the quota.&lt;/li&gt;
    &lt;/ul&gt;

    &lt;form&gt;
    Notifications to send: &lt;input id="notification-count" type="number" value="30"&gt;&lt;/input&gt;
    &lt;/form&gt;

    &lt;button id="visible"&gt;Visible notifications&lt;/button&gt;
    &lt;button id="invisible"&gt;Invisible notifications&lt;/button&gt;

    &lt;p&gt;Received &lt;span id="sent-visible"&gt;0&lt;/span&gt; visible notifications&lt;br /&gt;
    Received &lt;span id="sent-invisible"&gt;0&lt;/span&gt; invisible notifications&lt;/p&gt;
    &lt;button id="clear"&gt;Clear&lt;/button&gt;
  &lt;/section&gt; id="subscription-button" disabled=true&gt;&lt;/button&gt;
&lt;/section&gt;</pre></div><p>We will use a <code class="literal">manifest.json</code> file for Google Chrome support.</p><div><pre class="programlisting">{
  "name": "SW Push Quota",
  "short_name": "push-quota",
  "start_url": "./index.html",
  "display": "standalone",
  "gcm_sender_id": "46143029380",
  "gcm_user_visible_only": true
}</pre></div><p>In the <code class="literal">service-worker.js</code> file, we keep the service worker alive until the notifications cache is updated.</p><div><pre class="programlisting">self.addEventListener('push', function(event) {

  var visible = event.data ? event.data.json() : false;

  if (visible) {
    event.waitUntil(updateNumber('visible').then(function(num) {
      return self.registration.showNotification('SW', {
        body: 'Received ' + num + ' visible notifications',
      });
    }));
  } else {
    event.waitUntil(updateNumber('invisible'));
  }
});</pre></div><p>We will <a id="id396" class="indexterm"/>create a notifications cache to store the notifications received.</p><div><pre class="programlisting">self.addEventListener('install', function(event) {
  event.waitUntil(
    caches.open(cacheName).then(function(cache) {
      return Promise.all([
        cache.put(new Request('invisible'), new Response('0', {
          headers: {
            'content-type': 'application/json'
          }
        })),
        cache.put(new Request('visible'), new Response('0', {
          headers: {
            'content-type': 'application/json'
          }
        })),
      ]);
    })
  );
});</pre></div><p>In the <code class="literal">server.js</code> file, we will send notifications to the push service.</p><div><pre class="programlisting">app.post('/sendNotification', function(req, res) {
  var num = 1;
  var promises = [];

  var intervalID = setInterval(function() {
     promises.push(webPush.sendNotification(req.body.endpoint, {
       TTL: 200,
       payload: JSON.stringify(req.body.visible),
       userPublicKey: req.body.key,
       userAuth: req.body.authSecret,
     }));

     if (num++ === Number(req.body.num)) {
       clearInterval(intervalID);

       Promise.all(promises)
       .then(function() {
         res.sendStatus(201);
       });
     }
   }, 1000);
});</pre></div></div></div></body></html>