<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Building a Canvas Game's Masterclass</h1></div></div></div><p>
<em>In the previous chapter, we explored some basic Canvas context drawing APIs and created a game named Untangle. In this chapter, we are going to enhance the game by using some other context drawing APIs.</em>
</p><p>In this chapter, you will learn how to do the following:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Implement the Untangle game logic</li><li class="listitem" style="list-style-type: disc">Fill text in the Canvas with a custom web font</li><li class="listitem" style="list-style-type: disc">Draw images in the Canvas</li><li class="listitem" style="list-style-type: disc">Animate a sprite sheet image</li><li class="listitem" style="list-style-type: disc">Build multiple Canvas layers</li></ul></div><p>The following screenshot is a preview of the final result that we are going to build through this chapter. It is a Canvas-based Untangle game with an animated game guideline and several subtle details:</p><div><img src="img/B04290_05_01.jpg" alt="Building a Canvas Game's Masterclass"/></div><p>You can also<a id="id394" class="indexterm"/> try the final game example at: <a class="ulink" href="http://makzan.net/html5-games/untangle/">http://makzan.net/html5-games/untangle/</a>.</p><p>So let's get on with it.</p><div><div><div><div><h1 class="title"><a id="ch05lvl1sec56"/>Making the Untangle puzzle game</h1></div></div></div><p>Now that we have <a id="id395" class="indexterm"/>created an interactive Canvas, we can<a id="id396" class="indexterm"/> drag the circles, and the lines connecting the circles which are intersecting with other lines. How about we make it a game? There are some predefined circles and lines and our aim is to drag the circles so that there are no lines intersecting with others. This is called an <strong>Untangle puzzle game</strong>.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec57"/>Time for action – making the Untangle puzzle game in Canvas</h1></div></div></div><p>Let's add the game logic to our line intersection code:</p><div><ol class="orderedlist arabic"><li class="listitem">We need two more files for the game logic. Create two new files named <code class="literal">untangle.game.js</code> and <code class="literal">untangle.levels.js</code> file. Put them into the <code class="literal">js</code> folder.</li><li class="listitem">Open the <code class="literal">index.html</code> file in a text editor. Add the following code to include our newly created file. Put the code in the file before including the <code class="literal">js/untangle.js</code> file:<div><pre class="programlisting">&lt;script src="img/untangle.levels.js"&gt;&lt;/script&gt;
&lt;script src="img/untangle.game.js"&gt;&lt;/script&gt;</pre></div></li><li class="listitem">Still in the <code class="literal">index.html</code> file, we add the following code after the <code class="literal">canvas</code> element. It displays the game level information:<div><pre class="programlisting">&lt;p&gt;Puzzle &lt;span id="level"&gt;0&lt;/span&gt;, Completeness: &lt;span id="progress"&gt;0&lt;/span&gt;%&lt;/p&gt;</pre></div></li><li class="listitem">Open the <code class="literal">untangle.levels.js</code> file. Put the following level data definition code into the<a id="id397" class="indexterm"/> file. It is a predefined level <a id="id398" class="indexterm"/>data for the players to play. It is a collection of data that defines where the circles are placed and how they connect to each other initially:<div><pre class="programlisting">if (untangleGame === undefined) {
  var untangleGame = {};
}
untangleGame.levels = [
  {
    circles : [
          {x : 400, y : 156},
          {x : 381, y : 241},
          {x : 84, y : 233},
          {x : 88, y : 73}],
    relationship : [
          {connectedPoints : [1,2]},
          {connectedPoints : [0,3]},
          {connectedPoints : [0,3]},
          {connectedPoints : [1,2]}
    ]
  },
  {
    circles : [
          {x : 401, y : 73},
          {x : 400, y : 240},
          {x : 88, y : 241},
          {x : 84, y : 72}],
    relationship : [
          {connectedPoints : [1,2,3]},
          {connectedPoints : [0,2,3]},
          {connectedPoints : [0,1,3]},
          {connectedPoints : [0,1,2]}
    ]
  },
  {
    circles : [
          {x : 192, y : 155},
          {x : 353, y : 109},
          {x : 493, y : 156},
          {x : 490, y : 236},
          {x : 348, y : 276},
          {x : 195, y : 228}],
    relationship : [
          {connectedPoints : [2,3,4]},
          {connectedPoints : [3,5]},
          {connectedPoints : [0,4,5]},
          {connectedPoints : [0,1,5]},
          {connectedPoints : [0,2]},
          {connectedPoints : [1,2,3]}
    ]
  }
];</pre></div></li><li class="listitem">Open the <code class="literal">untangle.game.js</code> file in text editor. We will put game logic into this file.</li><li class="listitem">This is a new file, so we define the <code class="literal">untangleGame</code> object at the beginning of the file:<div><pre class="programlisting">if (untangleGame === undefined) {
  var untangleGame = {};
}</pre></div></li><li class="listitem">Continue <a id="id399" class="indexterm"/>in the <code class="literal">untangle.game.js</code> file. Add the following variables to the file. They store the current<a id="id400" class="indexterm"/> level and level progress of the game:<div><pre class="programlisting">untangleGame.currentLevel = 0;
untangleGame.levelProgress = 0;</pre></div></li><li class="listitem">When starting on each level, we need to set up the initial level data. To help make the code more readable, we create a function. Append the following code to the <code class="literal">untangle.game.js</code> JavaScript file:<div><pre class="programlisting">untangleGame.setupCurrentLevel = function() {
  untangleGame.circles = [];
  var level = untangleGame.levels[untangleGame.currentLevel];
  for (var i=0; i&lt;level.circles.length; i++) {
    untangleGame.circles.push(new untangleGame.Circle(level.circles[i].x, level.circles[i].y, 10));
  }

  untangleGame.levelProgress = 0;

  untangleGame.connectCircles();
  untangleGame.updateLineIntersection();
  untangleGame.checkLevelCompleteness();
  untangleGame.updateLevelProgress();
}</pre></div></li><li class="listitem">This is a game with several levels. We need to check whether the player solves the puzzle in the current level and jumps to the next puzzle. Add the following function to the end of the <code class="literal">untangle.game.js</code> file:<div><pre class="programlisting">untangleGame.checkLevelCompleteness = function () {
  if (untangleGame.levelProgress === 100) {
    if (untangleGame.currentLevel+1 &lt; untangleGame.levels.length) {
      untangleGame.currentLevel+=1;
    }
    untangleGame.setupCurrentLevel();
  }
}</pre></div></li><li class="listitem">We need<a id="id401" class="indexterm"/> another function to <a id="id402" class="indexterm"/>update the game progress. Add the following function to the end of <code class="literal">untangle.game.js </code>file:<div><pre class="programlisting">untangleGame.updateLevelProgress = function() {
  // check the untangle progress of the level
  var progress = 0;
  for (var i=0; i&lt;untangleGame.lines.length; i++) {
    if (untangleGame.lines[i].thickness === untangleGame.thinLineThickness) {

      progress+=1;
    }
  }
  var progressPercentage = Math.floor(progress/untangleGame.lines.length*100);

  untangleGame.levelProgress = progressPercentage;
  $("#progress").text(progressPercentage);
  
  // display the current level
  $("#level").text(untangleGame.currentLevel);
}</pre></div></li><li class="listitem">Open the <code class="literal">untangle.input.js </code>file. We add the following code to the mouse move event handler, which updates the level progress:<div><pre class="programlisting">untangleGame.updateLevelProgress();</pre></div></li><li class="listitem">We add the following code to the mouse up event handler to check whether the player completes the level:<div><pre class="programlisting">untangleGame.checkLevelCompleteness();</pre></div></li><li class="listitem">Now open the <code class="literal">untangle.js</code> file in an editor. Inside the jQuery document's <code class="literal">ready</code> function, we had code to set up the circles and lines. They are now replaced by our level setup code. Delete the call to <code class="literal">untangleGame.createRandomCircles</code> and <code class="literal">untangleGame.connectCircles</code> functions. Replace them with the following code:<div><pre class="programlisting">untangleGame.setupCurrentLevel();</pre></div></li><li class="listitem">Finally, open <a id="id403" class="indexterm"/>the <code class="literal">untangle.drawing.js</code> file in<a id="id404" class="indexterm"/> the code editor. We replace the <code class="literal">connectCircles</code> function to connect circles based on the level data:<div><pre class="programlisting">untangleGame.connectCircles = function() {
  // set up all lines based on the circles relationship
  var level = untangleGame.levels[untangleGame.currentLevel];
  untangleGame.lines.length = 0;
  for (var i in level.relationship) {
    var connectedPoints = level.relationship[i].connectedPoints;
    var startPoint = untangleGame.circles[i];
    for (var j in connectedPoints) {
      var endPoint = untangleGame.circles[connectedPoints[j]];
      untangleGame.lines.push(new untangleGame.Line(startPoint, endPoint, untangleGame.thinLineThickness));
    }
  }
}</pre></div></li><li class="listitem">Save all files and test the game in the browser. We can drag the circles and the line thickness will indicate whether it is intersected with other lines. During the mouse dragging, the level completeness percentage should change when more or less line intersections are detected. If we solve the puzzle, that is when no lines are intersected, the game will jump to the next level. When the game reaches the last level, it will keep showing the last level again. This is because we have not yet added the game over screen.<div><img src="img/B04290_05_02.jpg" alt="Time for action – making the Untangle puzzle game in Canvas"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec123"/>
<em>What just happened?</em>
</h2></div></div></div><p>We have added the <a id="id405" class="indexterm"/>game logic to our Canvas so that we can<a id="id406" class="indexterm"/> play our circle dragging code that has been created throughout this chapter. This section changes quite a lot of code. You may find the working example with uncompressed source code at: <a class="ulink" href="http://makzan.net/html5-games/untangle-wip-gameplay/">http://makzan.net/html5-games/untangle-wip-gameplay/</a>.</p><p>Let's recall the variables we added to the <code class="literal">untangleGame</code> object. The following table lists the description and usage of these: </p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Variable</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">circleRadius</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The radius<a id="id407" class="indexterm"/> setting of all drawing circles.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">thinLineThickness</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The line <a id="id408" class="indexterm"/>thickness when drawing thin lines.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">boldLineThickness</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The line <a id="id409" class="indexterm"/>thickness when drawing bold lines.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">circles</code>
</p>
</td><td style="text-align: left" valign="top">
<p>An array <a id="id410" class="indexterm"/>to store all drawn circles in the Canvas.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">lines</code>
</p>
</td><td style="text-align: left" valign="top">
<p>An<a id="id411" class="indexterm"/> array to store all drawn lines in the Canvas.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">targetCircle</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Keeps <a id="id412" class="indexterm"/>track of the circle that we are dragging.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">levels</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Stores all<a id="id413" class="indexterm"/> initial data of each level in the JSON format.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">currentLevel</code>
</p>
</td><td style="text-align: left" valign="top">
<p>A number to <a id="id414" class="indexterm"/>help you remember the current level.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">levelProgress</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id415" class="indexterm"/>percentage of non-intersected lines over all the lines.</p>
</td></tr></tbody></table></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec124"/>Defining the leveling data</h2></div></div></div><p>In each level, we have an <a id="id416" class="indexterm"/>initial position of the circles for the Untangle puzzle. The level data is designed as an array of objects. Each object contains every level's data. Inside each level's data, there are three properties: level number, circles, and lines connecting the circles. The following table shows the properties in each level's data:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Level property</p>
</th><th style="text-align: left" valign="bottom">
<p>Definition</p>
</th><th style="text-align: left" valign="bottom">
<p>Discussion</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">circles</code>
</p>
</td><td style="text-align: left" valign="top">
<p>An array <a id="id417" class="indexterm"/>of circles' positions in the level.</p>
</td><td style="text-align: left" valign="top">
<p>This defines how the circles are placed initially when the level is set up.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">relationships</code>
</p>
</td><td style="text-align: left" valign="top">
<p>An <a id="id418" class="indexterm"/>array of relationships defining which circles connect to each other.</p>
</td><td style="text-align: left" valign="top">
<p>There are some lines connecting the circles in each level. We design the line connections so that there is a solution in each level. The array index of each relationship indicates the target circle. The value of the line relationship defines which circle connects to the target circle. For example, the following code means the target circle is connected to both circle 1 and circle 2:</p>
<p>
</p><div><pre class="programlisting">{"connectedPoints" : [1,2]}</pre></div><p>
</p>
</td></tr></tbody></table></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec125"/>Determining level-up</h2></div></div></div><p>The level is complete when<a id="id419" class="indexterm"/> there are no lines intersecting with each other. We loop through each line and see how many lines are thin. Thin lines mean they are not intersected with others. We can use the thin lines for all line ratios to get the percentage of the level of completeness:</p><div><pre class="programlisting">var progress = 0;
for (var i in untangleGame.lines) {
  if (untangleGame.lines[i].thickness === untangleGame.thinLineThickness) {
    progress+=1;
  }
}
var progressPercentage = Math.floor(progress/untangleGame.lines.length * 100);</pre></div><p>We can then simply determine that the level has been completed when the progress is 100 percent.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec126"/>Displaying the current level and completeness progress</h2></div></div></div><p>We have displayed a<a id="id420" class="indexterm"/> sentence below the Canvas game<a id="id421" class="indexterm"/> describing the current level status and progress. It is used to display the game status to the players so they know that they are making progress in the game:</p><div><pre class="programlisting">&lt;p&gt;Puzzle &lt;span id="level"&gt;0&lt;/span&gt;, Completeness: &lt;span id="progress"&gt;0&lt;/span&gt;%&lt;/p&gt;</pre></div><p>We use the jQuery <code class="literal">text</code> function that we discussed in <a class="link" href="ch02.html" title="Chapter 2. Getting Started with DOM-based Game Development">Chapter 2</a>, <em>Getting Started with DOM-based Game Development</em>, to update the completeness progress:</p><div><pre class="programlisting">$("#progress").text(progressPercentage);</pre></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec127"/>Have a go hero</h2></div></div></div><p>We have only defined three levels in the example Untangle puzzle game so far. But it is not fun enough to play with just three levels. How about adding more levels to the game? If you cannot come up with a level, try searching for similar untangle games on the Internet and get some inspiration on the levels.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec58"/>Drawing text in the Canvas</h1></div></div></div><p>Imagine that now<a id="id422" class="indexterm"/> we want to show the progress level directly inside the <a id="id423" class="indexterm"/>Canvas. Canvas provides us with methods to draw text inside the Canvas.</p></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec59"/>Time for action – displaying the progress level text inside the canvas element</h1></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">We will <a id="id424" class="indexterm"/>continue using our Untangle game. Open the<code class="literal"> untangle.drawing.js</code> JavaScript file in text editor. Add the following code after the Canvas drawing code in the <code class="literal">gameloop</code> function, which draws the current level and progress text inside the Canvas:<div><pre class="programlisting">untangleGame.drawLevelProgress = function() {
  var ctx = untangleGame.ctx;
  ctx.font = "26px Arial";
  ctx.fillStyle = "WHITE";
  ctx.textAlign = "left";
  ctx.textBaseline = "bottom";
  ctx.fillText("Puzzle "+untangleGame.currentLevel+", Completeness: " + untangleGame.levelProgress + "%", 60, ctx.canvas.height-60);
}</pre></div></li><li class="listitem">Open the <code class="literal">untangle.js</code> file. We put the following code inside the <code class="literal">gameloop</code> function:<div><pre class="programlisting">untangleGame.drawLevelProgress();</pre></div></li><li class="listitem">Save the file and preview the <code class="literal">index.html</code> in a web browser. We will see that the text is now drawn inside the Canvas.<div><img src="img/B04290_05_03.jpg" alt="Time for action – displaying the progress level text inside the canvas element"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec128"/>
<em>What just happened?</em>
</h2></div></div></div><p>We have just <a id="id425" class="indexterm"/>drawn the title and the level progress text in our Canvas-based game. We draw text in the Canvas by using the <code class="literal">fillText</code> function. The following table shows how we use the function:</p><div><pre class="programlisting">fillText(string, x, y);</pre></div><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Argument</p>
</th><th style="text-align: left" valign="bottom">
<p>Definition</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">String</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id426" class="indexterm"/>text that we are going to draw</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">X</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <em>x</em> coordinate<a id="id427" class="indexterm"/> that the text draws</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Y</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <em>y</em> <a id="id428" class="indexterm"/>coordinate that the text draws</p>
</td></tr></tbody></table></div><p>This is the basic setting to draw some text. There are several more drawing context properties to set up the text <a id="id429" class="indexterm"/>drawing:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Context properties</p>
</th><th style="text-align: left" valign="bottom">
<p>Definition</p>
</th><th style="text-align: left" valign="bottom">
<p>Discussion</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">context.font</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The font style of the text</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id430" class="indexterm"/> shares the same syntax we used to declare the font style in CSS. For example, the following code sets the font style to 20 pixels bold with the Arial typeface:</p>
<p>
</p><div><pre class="programlisting">ctx.font = "bold 20px Arial";</pre></div><p>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">context.textAlign</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The text alignment</p>
</td><td style="text-align: left" valign="top">
<p>The<a id="id431" class="indexterm"/> <strong>alignment</strong> defines how the text is aligned. It can be one of the following values:</p>
<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">start</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">end</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">left</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">right</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">center</code></li></ul></div>
<p>For instance, if we are going to place some text on the right edge of the Canvas, using the <code class="literal">left</code> alignment means we need to calculate the text's width in order to know the x coordinate of the text.</p>
<p>When using right alignment in this case, all we need to do is set the x position directly to the Canvas width. The text will then automatically be placed on the right edge of the Canvas.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">context.textBaseline</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The text baseline</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id432" class="indexterm"/>following lists the common value of a <code class="literal">textBaseline</code> property:</p>
<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">top</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">middle</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">bottom</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">alphabet</code></li></ul></div>
<p>Similar to text alignment, the <code class="literal">bottom</code> baseline<a id="id433" class="indexterm"/> is useful when we want to place our text at the bottom of the Canvas. The <em>y</em> position of the <code class="literal">fillText</code> function is based on the bottom baseline of the text instead of the top.</p>
<p>The <code class="literal">alphabet</code> baseline aligns the y position based on the lowercase alphabet. The following screenshot shows our text drawing with the<a id="id434" class="indexterm"/> <strong>alphabet</strong> baseline.</p>
</td></tr></tbody></table></div><div><div><h3 class="title"><a id="note17"/>Note</h3><p>Please <a id="id435" class="indexterm"/>be aware that the text drawing in Canvas is treated as bitmap image data. This means visitors cannot select the text; search engines cannot index the text; we cannot search the text. For this reason, we should think carefully about whether we want to draw the text inside the Canvas or just place it directly in the DOM. Alternatively, we should change the fallback text inside the <code class="literal">canvas</code> element to reflect the drawing text.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec129"/>Pop quiz – drawing text in the Canvas</h2></div></div></div><p>Q1. If we are going to draw some text close to the bottom-right corner of the Canvas, which alignment and baseline setting is better?</p><div><ol class="orderedlist arabic"><li class="listitem">Left alignment, bottom baseline.</li><li class="listitem">Center alignment, alphabet baseline.</li><li class="listitem">Right alignment, bottom baseline.</li><li class="listitem">Center alignment, middle baseline.</li></ol></div><p>Q2. We are going to make a realistic book with a flipping effect with the latest open web standard. Which of the following settings is better?</p><div><ol class="orderedlist arabic"><li class="listitem">Draw the realistic book in Canvas, including all the text and the flipping effect.</li><li class="listitem">Put all text and content in the DOM and draw the realistic page-flipping effect in Canvas.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec130"/>Using embedded web font inside the Canvas</h2></div></div></div><p>We used a <a id="id436" class="indexterm"/>custom font in our <a id="id437" class="indexterm"/>memory, matching the game in the previous<a id="id438" class="indexterm"/> chapter. Custom font embedding also works in the Canvas. Let's conduct an experiment on drawing a custom font in our Untangle game in the Canvas.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec60"/>Time for action – embedding a Google web font into the canvas element</h1></div></div></div><p>Let's draw the <a id="id439" class="indexterm"/>Canvas texts with a handwriting <a id="id440" class="indexterm"/>style font:</p><div><ol class="orderedlist arabic"><li class="listitem">First, go to the Google font directory and choose a handwriting style font. I used the font <strong>Rock Salt</strong> and you can get it from the following URL:<a class="ulink" href="http://www.google.com/fonts/specimen/Rock+Salt">http://www.google.com/fonts/specimen/Rock+Salt</a>.</li><li class="listitem">The Google font directory provides a CSS link code that we can add to our game in order to embed the font. Add the following CSS link to the head of <code class="literal">index.html</code>:<div><pre class="programlisting">&lt;link href='http://fonts.googleapis.com/css?family=Rock+Salt' rel='stylesheet' type='text/css'&gt;</pre></div></li><li class="listitem">The next thing is to use the font. We open the <code class="literal">untangle.drawing.js</code> JavaScript file and modify the context <code class="literal">font</code> property in the <code class="literal">drawLevelProgress</code> function to the following:<div><pre class="programlisting">ctx.font = "26px 'Rock Salt'";</pre></div></li><li class="listitem">It is time to open our game in the web browser to test the result. The text drawn in the Canvas is now using the font we chose in the Google font directory.<div><img src="img/B04290_05_04.jpg" alt="Time for action – embedding a Google web font into the canvas element"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec131"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just chose<a id="id441" class="indexterm"/> a web font and embedded it<a id="id442" class="indexterm"/> into the Canvas when drawing text. This shows that we can style the font family of the filled text in the Canvas just like other DOM elements.</p><div><div><h3 class="title"><a id="tip05"/>Tip</h3><p>Sometimes the width of the text varies in different font families although they have the same word count. In this case, we can use the <code class="literal">measureText</code> function to get the width of the text we draw. The Mozilla Developer Network explains how we can use the<a id="id443" class="indexterm"/> function at: <a class="ulink" href="https://developer.mozilla.org/en/Drawing_text_using_a_canvas#measureText()">https://developer.mozilla.org/en/Drawing_text_using_a_canvas#measureText()</a>.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec61"/>Drawing images in the Canvas</h1></div></div></div><p>We have drawn<a id="id444" class="indexterm"/> some <a id="id445" class="indexterm"/>text inside the Canvas. What about drawing an image? Yes. Drawing images and image manipulation is a big feature of the Canvas.</p></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec62"/>Time for action – adding graphics to the game</h1></div></div></div><p>We are going to draw a <a id="id446" class="indexterm"/>blackboard background to the<a id="id447" class="indexterm"/> game:</p><div><ol class="orderedlist arabic"><li class="listitem">Download the graphics files from the code example bundle or the following URL: <a class="ulink" href="http://mak.la/book-assets">http://mak.la/book-assets</a>. The graphics files include all the graphics that we need in this chapter.</li><li class="listitem">Put the newly downloaded graphics files into a folder named <code class="literal">images</code>.</li><li class="listitem">Now it is time to really load the image. There is a <code class="literal">board.png</code> file in the graphics file we just downloaded. It is a blackboard graphic that we will draw in the Canvas as a background. Add the following code after the code we just added in the previous step:<div><pre class="programlisting">untangleGame.loadImages = function() {
  // load the background image
  untangleGame.background = new Image();

  untangleGame.background.onerror = function() {
    console.log("Error loading the image.");
  }
  untangleGame.background.src = "images/board.png";
};</pre></div></li><li class="listitem">Since the image loading takes time, we also need to ensure it is loaded before drawing it:<div><pre class="programlisting">untangleGame.drawBackground = function() {
  // draw the image background
  untangleGame.ctx.drawImage(untangleGame.background, 0, 0);
};</pre></div></li><li class="listitem">Open the <code class="literal">untangle.js</code> file, in the jQuery document <code class="literal">ready</code> function:<div><pre class="programlisting">untangleGame.loadImages();</pre></div></li><li class="listitem">In the <code class="literal">gameloop</code> function in the <code class="literal">untangle.js</code> file, we draw the image in the Canvas after clearing the context and before drawing anything else:<div><pre class="programlisting">untangleGame.drawBackground();</pre></div></li><li class="listitem">Next, we do not want a background color set to the Canvas because we have a PNG background with a transparent border. Open the <code class="literal">untangle.css</code> file and remove the background property in Canvas.</li><li class="listitem">Now, save all files and open the <code class="literal">index.html</code> file in the web browser. The background should be there and the handwritten fonts should match our blackboard theme.<div><img src="img/B04290_05_05.jpg" alt="Time for action – adding graphics to the game"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec132"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just drew an<a id="id448" class="indexterm"/> image inside the <code class="literal">canvas</code> element. You <a id="id449" class="indexterm"/>can find the working example at the following URL:</p><p>
<a class="ulink" href="http://makzan.net/html5-games/untangle-wip-graphics1/">http://makzan.net/html5-games/untangle-wip-graphics1/</a>
</p><p>There are two common ways to draw an image in the Canvas. We can either reference an existing <code class="literal">&lt;img&gt;</code> tag or load the image on the fly in JavaScript.</p><p>Here is how we reference the existing image tag in <code class="literal">canvas</code>, assuming that we have the following <code class="literal">img</code> tag in HTML:</p><div><pre class="programlisting">&lt;img id="board" src="img/board.png"&gt;</pre></div><p>We can draw the image in the Canvas by using the following JavaScript code:</p><div><pre class="programlisting">var img = document.getElementById('board');
context.drawImage(img, x, y);</pre></div><p>Here is another code snippet to load the image without attaching the <code class="literal">&lt;img&gt;</code> tag into the DOM. If we load the image inside JavaScript, we need to make sure the image is loaded before drawing it in the Canvas. Therefore, we draw the image after the <code class="literal">onload</code> event of the image:</p><div><pre class="programlisting">var board = new Image();
board.onload = function() {
  context.drawImage(board, x, y);
}
board.src = "images/board.png";</pre></div><div><div><h3 class="title"><a id="tip06"/>Tip</h3><p>The order matters when setting the <code class="literal">onload</code> event handler and assigning the image <code class="literal">src</code>.</p><p>When we assign the <code class="literal">src</code> property to the image and if the image is cached by the browser, some browsers fire the <code class="literal">onload</code> event immediately. If we place the <code class="literal">onload</code> event handler after assigning the <code class="literal">src</code> property, we may miss it because it is fired before we set the event handler.</p></div></div><p>In our example, we<a id="id450" class="indexterm"/> used the latter approach. We create <a id="id451" class="indexterm"/>an <code class="literal">Image</code> object and loaded the background.</p><p>Another event that we should handle when loading the image is the <code class="literal">onerror</code> event. It is especially useful when we are accessing extra network data. We use the following code snippet to check the errors in our example:</p><div><pre class="programlisting">untangleGame.background.onerror = function() {
  console.log("Error loading the image.");
}</pre></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec133"/>Have a go hero</h2></div></div></div><p>The error loading now only displays a message in the console. The console is normally not viewed by players. How about writing a message to the Canvas to tell players that the game failed to load the game's assets?</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec134"/>Using the drawImage function</h2></div></div></div><p>There are three <a id="id452" class="indexterm"/>ways to draw an image in the Canvas using the <code class="literal">drawImage</code> function. We can draw the image without any modification on a given coordinate, we can also draw the image with a scaling factor on a given coordinate, or we can even crop the image and draw only the clipping region.</p><p>The <code class="literal">drawImage</code> function accepts several arguments:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Every argument present in <code class="literal">drawImage(image, x, y);</code> is explained in the following table:<div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Argument</p>
</th><th style="text-align: left" valign="bottom">
<p>Definition</p>
</th><th style="text-align: left" valign="bottom">
<p>Discussion</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">image</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id453" class="indexterm"/>reference of the image that we are going to draw.</p>
</td><td style="text-align: left" valign="top">
<p>We either get the image reference by using an existing <code class="literal">img</code> element or creating a JavaScript <code class="literal">Image</code> object.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">x</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id454" class="indexterm"/>position of <em>x</em> where the image will be placed in the Canvas coordinates.</p>
</td><td rowspan="2" style="text-align: left" valign="top">
<p>The <em>x</em> and <em>y</em> coordinate is where we place the image with respect to its top-left corner.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">y</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id455" class="indexterm"/>position of <em>y</em> where the image will be placed in the Canvas coordinates.</p>
</td></tr></tbody></table></div></li><li class="listitem" style="list-style-type: disc">Every <a id="id456" class="indexterm"/>argument present in <code class="literal">drawImage(image, x, y, width, height);</code> is explained in the following table:<div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Argument</p>
</th><th style="text-align: left" valign="bottom">
<p>Definition</p>
</th><th style="text-align: left" valign="bottom">
<p>Discussion</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">image</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The image reference that we are going to draw.</p>
</td><td style="text-align: left" valign="top">
<p>We <a id="id457" class="indexterm"/>either get the image reference by using an existing <code class="literal">img</code> element or creating a JavaScript <code class="literal">Image</code> object.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">x</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The position of <em>x</em> where the image will be placed in the Canvas coordinates.</p>
</td><td rowspan="2" style="text-align: left" valign="top">
<p>The <em>x</em> <a id="id458" class="indexterm"/>and <em>y</em> coordinate is where we <a id="id459" class="indexterm"/>place the image with respect to its top-left corner.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">y</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The position of <em>y</em> where the image will be placed in the Canvas coordinates.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">width</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The width of the final drawn image.</p>
</td><td rowspan="2" style="text-align: left" valign="top">
<p>We <a id="id460" class="indexterm"/>apply scale to the<a id="id461" class="indexterm"/> image if the width and height is not the same as the original image.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">height</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The height of the final drawn image.</p>
</td></tr></tbody></table></div></li><li class="listitem" style="list-style-type: disc">Every argument present in <code class="literal">drawImage(image, sx, sy, sWidth, sHeight, dx, dy, width, height);</code> is explained in the following table:<div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Argument</p>
</th><th style="text-align: left" valign="bottom">
<p>Definition</p>
</th><th style="text-align: left" valign="bottom">
<p>Discussion</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">image</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The image reference that we are going to draw.</p>
</td><td style="text-align: left" valign="top">
<p>We<a id="id462" class="indexterm"/> either get the image reference by getting an existing <code class="literal">img</code> element or creating a JavaScript <code class="literal">Image</code> object.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">sx</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <em>x</em> coordinate of the top-left corner of the clipping region.</p>
</td><td rowspan="4" style="text-align: left" valign="top">
<a id="id463" class="indexterm"/>
<p>Clipping <em>x</em>, <em>y</em>, width, height together defines a rectangular clipping area. The given image is clipped by this rectangle.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">sy</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <em>y</em> <a id="id464" class="indexterm"/>coordinate of the top-left corner of the clipping region.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">sWidth</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id465" class="indexterm"/>width of the clipping region.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">sHeight</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The<a id="id466" class="indexterm"/> height of the clipping region.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">dx</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The<a id="id467" class="indexterm"/> position of <em>x</em> where the image will be placed in the Canvas coordinates.</p>
</td><td rowspan="2" style="text-align: left" valign="top">
<p>The <em>x</em> and <em>y</em> coordinate is where we place the image with respect to its top-left corner.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">dy</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id468" class="indexterm"/>position of <em>y</em> where the image will be placed in the Canvas coordinates.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">width</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id469" class="indexterm"/>width of the final drawn image.</p>
</td><td rowspan="2" style="text-align: left" valign="top">
<p>We are applying scale to the clipped image if the width and height is not the same as the clipping dimension.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">height</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id470" class="indexterm"/>height of the final drawn image.</p>
</td></tr></tbody></table></div></li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec135"/>Have a go hero – optimizing the background image</h2></div></div></div><p>In the example, we draw the <a id="id471" class="indexterm"/>blackboard image as the background in every call to the <code class="literal">gameloop</code> function. Since our background is static and does not change with time, clearing it and redrawing it again and again is wasting CPU resources. How can we optimize this performance issue? In a later section, we will divide the game into multiple layers to avoid redrawing the static background image.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec136"/>Decorating the Canvas-based game</h2></div></div></div><p>We have enhanced the <a id="id472" class="indexterm"/>Canvas game with gradients and images. Before moving forward, let's decorate the web page of our Canvas game.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec63"/>Time for action – adding CSS styles and image decoration to the game</h1></div></div></div><p>We are going to build a <a id="id473" class="indexterm"/>center-aligned layout with a game title:</p><div><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">index.html</code> in<a id="id474" class="indexterm"/> a text editor. It is easier for us to style the layout with one grouping DOM element. We put all the elements inside the body into a section with the <code class="literal">id</code> page. Replace the contents of the HTML file with the following:<div><pre class="programlisting">&lt;section id="page"&gt;
  &lt;header&gt;
    &lt;h1&gt;Untangle Puzzle Game in Canvas&lt;/h1&gt;
  &lt;/header&gt;

  &lt;canvas id="game" width="768" height="400"&gt;
    This is an interactive game with circles and lines connecting them.
  &lt;/canvas&gt;
  &lt;p&gt;Puzzle &lt;span id="level"&gt;0&lt;/span&gt;, Completeness: &lt;span id="progress"&gt;0&lt;/span&gt;%&lt;/p&gt;

  &lt;footer&gt;
    &lt;p&gt;This is an example of Untangle Puzzle Game in Canvas.&lt;/p&gt;
  &lt;/footer&gt;
&lt;/section&gt;</pre></div></li><li class="listitem">Let's apply <a id="id475" class="indexterm"/>CSS to the page layout. Replace<a id="id476" class="indexterm"/> existing content in the <code class="literal">untangle.css</code> file with the following code:<div><pre class="programlisting">html, body {
  background: url(../images/title_bg.png) 50% 0 no-repeat, 
      url(../images/bg_repeat.png) 50% 0 repeat-y #889ba7;
  margin: 0;
  color: #111;
}

#game{
  position:relative;
}

#page {
  width: 820px;
  min-height: 800px;
  margin: 0 auto;
  padding: 0;
  text-align: center;
  text-shadow: 0 1px 5px rgba(60,60,60,.6);
}

header {
  height: 88px;
  padding-top: 36px;
  margin-bottom: 50px;
  font-family: "Rock Salt", Arial, sans-serif;
  font-size: 14px16px;
  text-shadow: 0 1px 0 rgba(200,200,200,.5);
  color: #121;
}</pre></div></li><li class="listitem">It is time to save all the files and preview the game in a web browser. We should see a title ribbon and a well-styled layout that is center-aligned. The following screenshot shows the result:<div><img src="img/B04290_05_06.jpg" alt="Time for action – adding CSS styles and image decoration to the game"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec137"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just <a id="id477" class="indexterm"/>decorated the web page that contains our<a id="id478" class="indexterm"/> Canvas-based game. Although our game is based on a Canvas drawing, it does not restrict us from decorating the whole web page with graphics and CSS styles.</p><div><div><h3 class="title"><a id="note18"/>Note</h3><p>
<strong>Default background of the canvas element</strong>
</p><p>The default background <a id="id479" class="indexterm"/>of the <code class="literal">canvas</code> element is <a id="id480" class="indexterm"/>transparent. If we do not set any background CSS style for the Canvas, it will be transparent. This is useful when our drawing is not a rectangle. In this example, the textured layout background shows within the Canvas region.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec138"/>Pop quiz – styling a Canvas background</h2></div></div></div><p>Q1. How can we set the Canvas background to be transparent?</p><div><ol class="orderedlist arabic"><li class="listitem">Set the background color to <code class="literal">#ffffff</code>.</li><li class="listitem">Do nothing. It is transparent by default.</li></ol></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec64"/>Animating a sprite sheet in Canvas</h1></div></div></div><p>We first used <a id="id481" class="indexterm"/>
<strong>sprite sheet</strong> images in <a class="link" href="ch03.html" title="Chapter 3. Building a Card-matching Game in CSS3">Chapter 3</a>, <em>Building a Card-matching Game in CSS3</em>, when<a id="id482" class="indexterm"/> displaying a deck of playing cards.</p></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec65"/>Time for action – making a game guide animation</h1></div></div></div><p>There is a graphics file <a id="id483" class="indexterm"/>named <code class="literal">guide_sprite.png</code> in the images folder. It is a game guideline graphic that contains each step of the animation.</p><div><img src="img/B04290_05_07.jpg" alt="Time for action – making a game guide animation"/></div><p>Let's draw this guide into our game with<a id="id484" class="indexterm"/> <strong>animations</strong>:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">untangle.drawing.js</code> JavaScript file in the text editor.</li><li class="listitem">In the <code class="literal">untangleGame.loadImages</code> function, add the following code:<div><pre class="programlisting">// load the guide sprite image
untangleGame.guide = new Image();
untangleGame.guide.onload = function() {
  // setup timer to switch the display frame of the guide sprite
  untangleGame.guideFrame = 0;
  setInterval(untangleGame.guideNextFrame, 500);
}
untangleGame.guide.src = "images/guide_sprite.png";</pre></div></li><li class="listitem">Still in the <code class="literal">untangleGame.drawing.js</code> file, we add the following function to move the current frame to the next frame every 500 milliseconds:<div><pre class="programlisting">untangleGame.guideNextFrame = function() {
  untangleGame.guideFrame++;
  // there are only 6 frames (0-5) in the guide animation.
  // we loop back the frame number to frame 0 after frame 5.
  if (untangleGame.guideFrame &gt; 5) {
    untangleGame.guideFrame = 0;
  }
}</pre></div></li><li class="listitem">Next, we <a id="id485" class="indexterm"/>define the <code class="literal">drawGuide</code> function in the <code class="literal">untangleGame.drawing.js</code> file. This function draws the guide animation according to the current frame:<div><pre class="programlisting">untangleGame.drawGuide = function() {
  var ctx = untangleGame.ctx;
  // draw the guide animation
  if (untangleGame.currentLevel === 0) {
    // the dimension of each frame is 80x130.
    var nextFrameX = untangleGame.guideFrame * 80;
    ctx.drawImage(untangleGame.guide, nextFrameX, 0, 80, 130, 325, 130, 80, 130);
  }
};</pre></div></li><li class="listitem">Let's switch to the <code class="literal">untangle.js</code> file. In the <code class="literal">gameloop</code> function, we call the guide drawing function before ending the <code class="literal">gameloop</code> function.<div><pre class="programlisting">untangleGame.drawGuide();</pre></div></li><li class="listitem">Let's watch the animation in the web browser by opening the <code class="literal">index.html</code> file. The following screenshot demonstrates the animation of the game guideline. The guideline animation will play and loop until the player levels up:<div><img src="img/B04290_05_08.jpg" alt="Time for action – making a game guide animation"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec139"/>
<em>What just happened?</em>
</h2></div></div></div><p>We can draw only <a id="id486" class="indexterm"/>a region of an image when using the <code class="literal">drawImage</code> context function.</p><p>The following screenshot demonstrates the process of animation step by step. The rectangle is the clipping region:</p><div><img src="img/B04290_05_09.jpg" alt="What just happened?"/></div><p>We used a variable <a id="id487" class="indexterm"/>named <code class="literal">guideFrame</code> to control which frame to show. The width of each frame is 80. Therefore, we get the x position of the clipping region by multiplying the width and the current frame number:</p><div><pre class="programlisting">var nextFrameX = untangleGame.guideFrame * 80;
ctx.drawImage(untangleGame.guide, nextFrameX, 0, 80, 130, 325, 130, 80, 130);</pre></div><p>The <code class="literal">guideFrame</code> variable is updated every 500 milliseconds by the following <code class="literal">guideNextFrame</code> function:</p><div><pre class="programlisting">untangleGame.guideNextFrame = function() {
  untangleGame.guideFrame += 1;
  // there are only 6 frames (0-5) in the guide animation.
  // we loop back the frame number to frame 0 after frame 5.
  if (untangleGame.guideFrame &gt; 5) {
     untangleGame.guideFrame = 0;
  }
}</pre></div><p>Animating a sprite is <a id="id488" class="indexterm"/>a commonly used technique when developing games. There are some benefits of using sprite animation when developing traditional video games. The reasons may not apply to web game development but there are other benefits of using sprite sheet animation:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">All frames are loaded as one file so the whole animation is ready once the sprite file is loaded.</li><li class="listitem" style="list-style-type: disc">Putting all frames into one file means we can reduce the HTTP request from the web browser to the server. If each frame is a file, the browser requests the file many times, while now it just requests one file and uses one HTTP request.</li><li class="listitem" style="list-style-type: disc">Putting different images into one file also reduces the duplication of files, which helps to reduce the duplicate file's header, footer, and metadata.</li><li class="listitem" style="list-style-type: disc">Putting all frames into one image means we can easily clip the image to display any frame without complex code to change the image source.</li></ul></div><p>Sprite sheet animation is usually used in character animation. The following screenshot is a <strong>sprite animation</strong>
<a id="id489" class="indexterm"/> of an angry cat that I used in an HTML5 game named<a id="id490" class="indexterm"/> <strong>Neighbours</strong>.</p><div><img src="img/B04290_05_10.jpg" alt="What just happened?"/></div><p>We built the sprite<a id="id491" class="indexterm"/> sheet animation by clipping the frame and setting up the timer ourselves in this example. When working with a lot of animations, we may want to use a third-party sprite animation plugin or create our own Canvas sprite animation to better reuse and manage the logic code.</p><div><div><h3 class="title"><a id="note19"/>Note</h3><p>Sprite animation<a id="id492" class="indexterm"/> is an important topic in HTML5 games development and there are many online resources discussing this topic. The following links are some of them:</p><p>The sprite animation<a id="id493" class="indexterm"/> tutorial (<a class="ulink" href="http://simurai.com/blog/2012/12/03/step-animation/">http://simurai.com/blog/2012/12/03/step-animation/</a>) by Simurai discusses how we can make a sprite animation with CSS only.</p><p>Spritely (<a class="ulink" href="http://www.spritely.net/">http://www.spritely.net/</a>), on the<a id="id494" class="indexterm"/> other hand, provides sprite animation over the DOM element with CSS. It is useful when we want to animate a sprite without using Canvas.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec66"/>Creating a multilayer Canvas game</h1></div></div></div><p>Now all things are drawn<a id="id495" class="indexterm"/> into the context, which has no other state to distinguish the items drawn. We may split the Canvas game into different layers and code the logic to control and draw each layer at a time.</p></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec67"/>Time for action – dividing the game into four layers</h1></div></div></div><p>We are going to separate our Untangle game into four layers:</p><div><ol class="orderedlist arabic"><li class="listitem">In <code class="literal">index.html</code>, we need to change or replace the current <code class="literal">canvas</code> tag with the following code. It should contain several Canvases within a section:<div><pre class="programlisting">&lt;section id="layers"&gt;
  &lt;canvas id="bg" width="768" height="440"&gt;
    This is an interactive game with circles and lines connecting them.
  &lt;/canvas&gt;
  &lt;canvas id="guide" width="768" height="440"&gt;&lt;/canvas&gt;
  &lt;canvas id="game" width="768" height="440"&gt;&lt;/canvas&gt;
  &lt;canvas id="ui" width="768" height="440"&gt;&lt;/canvas&gt;
&lt;/section&gt;</pre></div></li><li class="listitem">We also need to apply some styles to the Canvases so they overlap with each other to create a multiple layers effect. Also we have to prepare a <code class="literal">fadeout</code> class and a <code class="literal">dim</code> class to make the target transparent. Add the following code into the <code class="literal">untangle.css</code> file:<div><pre class="programlisting">#layers {
  position: relative;
  margin: 0 auto;
  width:768px;
  height: 440px;
}
#layers canvas{
  top: 0;
  left: 0;
  position: absolute;
}
#guide {
  opacity: 0.7;
  transition: opacity 0.5s ease-out;
}
#guide.fadeout {
  opacity: 0; 
}
#ui {
  transition: opacity 0.3s ease-out;
}
#ui.dim {
  opacity: 0.3;
}</pre></div></li><li class="listitem">Open the <code class="literal">untangle.js</code> JavaScript file. We modify the code to support the layers feature. First, we add an array to store the context reference of each Canvas. Add it at the beginning of the file, before the jQuery document ready function and after the <code class="literal">untangleGame</code> definition:<div><pre class="programlisting">untangleGame.layers = [];</pre></div></li><li class="listitem">Then, we remove the following lines of code in the jQuery document ready function.<div><pre class="programlisting">var canvas = document.getElementById("game");
untangleGame.ctx = canvas.getContext("2d");</pre></div></li><li class="listitem">We replace the <a id="id496" class="indexterm"/>code we deleted with the following code. We get the context reference of each Canvas layer and store them in the array:<div><pre class="programlisting">// prepare layer 0 (bg)
var canvas_bg = document.getElementById("bg");
untangleGame.layers[0] = canvas_bg.getContext("2d");

// prepare layer 1 (guide)
var canvas_guide = document.getElementById("guide");
untangleGame.layers[1] = canvas_guide.getContext("2d");

// prepare layer 2 (game)
var canvas = document.getElementById("game");    
var ctx = canvas.getContext("2d");
untangleGame.layers[2] = ctx;

// prepare layer 3 (ui)
var canvas_ui = document.getElementById("ui");
untangleGame.layers[3] = canvas_ui.getContext("2d");</pre></div></li><li class="listitem">Let's switch to <code class="literal">untangle.drawing.js</code> file. We are going to update the context references at several places to support multilayers.</li><li class="listitem">There are now four Canvas contexts that we may clear. Find the existing <code class="literal">clear</code> function and replace it with the following:<div><pre class="programlisting">untangleGame.clear = function(layerIndex) {
  var ctx = untangleGame.layers[layerIndex];
  ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
};</pre></div></li><li class="listitem">In the <code class="literal">drawCircle</code> and <code class="literal">drawLine</code> function, replace <code class="literal">var ctx = untangleGame.ctx;</code> with the following code:<div><pre class="programlisting">var ctx = untangleGame.layers[2];</pre></div></li><li class="listitem">In the <code class="literal">drawLevelProgress</code> function, replace <code class="literal">var ctx = untangleGame.ctx;</code> with the following code:<div><pre class="programlisting">var ctx = untangleGame.layers[3];</pre></div></li><li class="listitem">In the <code class="literal">drawBackground</code> function, we replace the existing code with the following, which draws on the background layer with index <code class="literal">0</code>:<div><pre class="programlisting">untangleGame.drawBackground = function() {
  // draw the image background
  var ctx = untangleGame.layers[0];
  ctx.drawImage(untangleGame.background, 0, 0);
};</pre></div></li><li class="listitem">Then, we <a id="id497" class="indexterm"/>move to the <code class="literal">loadImages</code> function. Add the following code to the function. It draws the background once:<div><pre class="programlisting">untangleGame.background.onload = function() {
  untangleGame.drawBackground();
}</pre></div></li><li class="listitem">In the <code class="literal">drawGuide</code> function, replace <code class="literal">var ctx = untangleGame.ctx;</code> with the following code:<div><pre class="programlisting">var ctx = untangleGame.layers[1];</pre></div></li><li class="listitem">Actually, we fade out the guide layer in this function too. So we replace the entire <code class="literal">drawGuide</code> function with the following:<div><pre class="programlisting">untangleGame.drawGuide = function() {
  var ctx = untangleGame.layers[1];
  // draw the guide animation
  if (untangleGame.currentLevel &lt; 2) {
    // the dimension of each frame is 80x130.
    var nextFrameX = untangleGame.guideFrame * 80;
    ctx.drawImage(untangleGame.guide, nextFrameX, 0, 80, 130, 325,
    130, 80, 130);
  }

  // fade out the guideline after level 0
  if (untangleGame.currentLevel === 1)   {
    $("#guide").addClass('fadeout');
  }
};</pre></div></li><li class="listitem">Inside the <code class="literal">guideNextFrame</code> function, we clear the guide layer and redraw it. Add the following code to the end of the function:<div><pre class="programlisting">untangleGame.clear(1);
untangleGame.drawGuide();</pre></div></li><li class="listitem">During the circle dragging, we don't want our progress text layer to block the game elements. So we will define an extra function that dims the opacity of the progress layer when there are any game circles overlapping the layer:<div><pre class="programlisting">untangleGame.dimUILayerIfNeeded = function() {
  // get all circles,
  // check if the ui overlap with the game objects
  var isOverlappedWithCircle = false;
  for(var i in untangleGame.circles) {
    var point = untangleGame.circles[i];
    if (point.y &gt; 280) {
      isOverlappedWithCircle = true;
    }
  }
  if (isOverlappedWithCircle) {
    $("#ui").addClass('dim');
  } else {
    $("#ui").removeClass('dim');
  }
};</pre></div></li><li class="listitem">We are done<a id="id498" class="indexterm"/> with the <code class="literal">untangle.drawing.js</code> file. Let's switch back to the <code class="literal">untangle.js</code> file. In the <code class="literal">gameloop</code> function, we remove the calls to the <code class="literal">drawBackground</code> and <code class="literal">drawGuide</code> functions. Then, we call the <code class="literal">dimUILayerIfNeeded</code> function. We also clear the layer 2 game elements and layer 3 level progress in every game loop. Now the <code class="literal">gameloop</code> function becomes the following:<div><pre class="programlisting">function gameloop() {
  // clear the canvas before re-drawing.
  untangleGame.clear(2);
  untangleGame.clear(3);

  untangleGame.drawAllLines();
  untangleGame.drawAllCircles();
  untangleGame.drawLevelProgress();
  untangleGame.dimUILayerIfNeeded();
}</pre></div></li><li class="listitem">Finally, open the <code class="literal">untangle.input.js</code> file. We had mouse down, move, and up event listeners on the <code class="literal">#game</code> Canvas. Since the game Canvases are now overlapping, the mouse event listener we had in the <code class="literal">game</code> Canvas does not fire anymore. We can change the listener to listen to the events from its parent <code class="literal">#layers</code> DIV, which has the same position and dimension of the Canvas:<div><pre class="programlisting">$("#layers"). bind("mousedown touchstart", function(e){
  // existing code that handles mousedown and touchstart.
});
$("#layers"). bind("mousemove touchmove", function(e) {
  // existing code that handles mousemove and touchmove.
});
$("#layers"). bind("mouseup touchend", function(e){
  // existing code that handles mouseup and touchend.
});</pre></div></li><li class="listitem">Save all the<a id="id499" class="indexterm"/> files and check our code changes in the web browser. The game should be displayed as if we haven't changed anything. Try dragging the circle down close to the bottom edge of the blackboard. The level progress text should dim to a low opacity. When you finish the first level, the guideline animation will fade out gracefully. The following screenshot shows the level progress in half opacity:<div><img src="img/B04290_05_11.jpg" alt="Time for action – dividing the game into four layers"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec140"/>
<em>What just happened?</em>
</h2></div></div></div><p>We divided our working game into four layers. There are quite a lot of changes in this section. You may try the working example at: <a class="ulink" href="http://makzan.net/html5-games/untangle/">http://makzan.net/html5-games/untangle/</a>. By observing the source code, you can view the uncompressed code example.</p><p>There are four <a id="id500" class="indexterm"/>Canvases in total now. Each Canvas is in charge of one layer. The layers are divided into the background, game guideline, game itself, and the user interface showing the level progress.</p><p>By default, the Canvases, like other elements, are placed one after the other. In order to overlap all Canvases to construct the layer effect, we applied the <code class="literal">absolute</code> position to them.</p><p>The following screenshots show the four layers in our game. By default, the DOM that was added later is on top of the one added before. Therefore, the <code class="literal">bg</code> Canvas is at the bottom and <code class="literal">ui</code> is on the top:</p><div><img src="img/B04290_05_12.jpg" alt="What just happened?"/></div><p>By using different layers, we can create specific logic for each layer. For example, the background in this game is static. We only draw it once. The guide layer is a 6-frames animation with 500 milliseconds for each frame. We redraw the guide layer in 500 milliseconds intervals. The game layer and UI layer are the core game logic, which we draw 30 times per second.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec141"/>Mixing a CSS technique with Canvas drawing</h2></div></div></div><p>We are creating a <a id="id501" class="indexterm"/>Canvas-based game but we are not<a id="id502" class="indexterm"/> restricted to use only a Canvas drawing API. Each layer is an individual Canvas layer. We can apply a CSS technique to any layer. The level progress information is now in another Canvas with the ID <code class="literal">ui</code>. In this example, we mixed the CSS technique we discussed in <a class="link" href="ch03.html" title="Chapter 3. Building a Card-matching Game in CSS3">Chapter 3</a>, <em>Building a Card-matching Game in CSS3</em>.</p><p>When we drag the circles around the Canvas, they may overlap the level information. When drawing the UI Canvas layer, we check whether any circle's coordinate is too low and is overlapping the text. We then fade the UI Canvas CSS opacity so it does not distract the player from the circles.</p><p>We also fade out the guideline animation after the player levels up. This is done by fading out the whole <code class="literal">guide</code> Canvas with CSS transition easing to 0 opacity. Since the <code class="literal">guide</code> Canvas is only in charge of that animation, hiding that Canvas does not affect other elements:</p><div><pre class="programlisting">if (untangleGame.currentLevel === 1) {
  $("#guide").addClass('fadeout');
}</pre></div><div><div><h3 class="title"><a id="tip07"/>Tip</h3><p>
<strong>Clearing only the changed region to boost the canvas performance</strong>
</p><p>We can use the clear function to only clear part of the Canvas context. This will give the performance some boost because it avoids redrawing the entire Canvas context every time. This is achieved by marking the 'dirty' region of the context that has changed state since last drawn.</p><p>In the guide Canvas layer in our example, we may consider clearing only the region of the sprite sheet image drawing instead of the whole Canvas.</p><p>We may not see significant differences in simple Canvas examples but it helps boost the performance when we have a complex Canvas game that includes many sprite image animations and complex shape drawings.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec142"/>Have a go hero</h2></div></div></div><p>We fade out the guide when the players advance to level 2. How about we fade out the guide animation once the player drags any circles? How can we do that?</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec68"/>Summary</h1></div></div></div><p>You learned a lot in this chapter about drawing gradients, text, and images in a Canvas. Specifically, we built the Untangle game logic and used several advanced Canvas techniques, including sprite sheet animation using the clipping function when drawing images. We divided the game into several layers by stacking several <code class="literal">canvas</code> elements. This allows us to handle different parts of the game rendering in separated and specific logic. Finally, we mixed the CSS transition animation in a Canvas-based game.</p><p>One thing we haven't mentioned in this book is the bitmap manipulation in Canvas. Canvas context is a bitmap data where we can apply an operation on each pixel. For instance, we may draw an image in the Canvas and apply Photoshop-like filters to the image. We will not cover this in the book because image manipulation is an advanced topic and the application may not relate to game development.</p><p>Now that you've learned about building games in Canvas and making animation for game objects, such as game character, we are ready to add audio components and sound effects to our games in the next chapter.</p><p>We will get back to Canvas-based games in <a class="link" href="ch09.html" title="Chapter 9. Building a Physics Car Game with Box2D and Canvas">Chapter 9</a>, <em>Building a Physics Car Game with Box2D and Canvas</em>.</p></div></body></html>