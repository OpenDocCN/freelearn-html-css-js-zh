<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Accessing Offline Content with Advanced Techniques"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Accessing Offline Content with Advanced Techniques</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Templating</li><li class="listitem" style="list-style-type: disc">Implementing read-through caching</li><li class="listitem" style="list-style-type: disc">Allowing offline Google Analytics</li><li class="listitem" style="list-style-type: disc">Allowing offline user interaction</li><li class="listitem" style="list-style-type: disc">Implementing selective caching</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec31"/>Introduction</h1></div></div></div><p>In this chapter, we will continue to improve on our experience working with offline content using the service worker.</p><p>We will look into advanced techniques, including how to use templating with a template engine, diving into Google Analytics, how to solve issues with offline user interaction, and implementing selective caching.</p><p>Let's start off this chapter by experimenting with templating for the service worker.</p></div></div>
<div class="section" title="Templating"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec32"/>Templating</h1></div></div></div><p>Traditional <a id="id193" class="indexterm"/>server-side page rendering has become a thing of the past with modern-day <span class="strong"><strong>single page applications</strong></span> (<span class="strong"><strong>SPAs</strong></span>). Even <a id="id194" class="indexterm"/>though server-side rendering is faster, state data will prove hard to implement with the service worker. Instead, we can request JSON data and a template, allow the service worker to take in the data and the template, and render a response page. JavaScript templating is a client-side data binding method, implemented with the use of the JavaScript language.</p><p>In order to learn more about <a id="id195" class="indexterm"/>templating, please refer the following link:</p><p>
<a class="ulink" href="https://en.wikipedia.org/wiki/JavaScript_templating">https://en.wikipedia.org/wiki/JavaScript_templating</a>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec83"/>Getting ready</h2></div></div></div><p>To get started <a id="id196" class="indexterm"/>with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the first recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <span class="emphasis"><em>Learning Service Worker Basics</em></span>: <span class="emphasis"><em>Setting up service workers</em></span>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the following recipes: <span class="emphasis"><em>Setting up GitHub pages for SSL</em></span>, <span class="emphasis"><em>Setting up SSL for Windows</em></span>, and <span class="emphasis"><em>Setting up SSL for Mac</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec84"/>How to do it...</h2></div></div></div><p>Follow these instructions to set up your file structure. Alternatively, you can download the files from the following location:</p><p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/tree/master/service-workers/04/01/">https://github.com/szaranger/szaranger.github.io/tree/master/service-workers/04/01/</a>
</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we must create an <code class="literal">index.html</code> file as follows:<div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;title&gt;Templating&lt;/title&gt;
  &lt;style&gt;
  * {
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
  }

  body {
    margin: 0 auto;
    text-align: center;
    font-family: sans-serif;
  }

  main {
    max-width: 350px;
    border: 1px solid #4CAF50;
    padding: 20px;
    border-radius: 5px;
    width: 350px;
    margin: 20px auto;
  }

  h1 {
    color: #4CAF50;
  }

  img {
    padding: 20px 0;
    max-width: 200px;
  }

  .hidden {
    display: none;
  }

  .frameworks {
    margin: 20px auto;
  }

  table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
  }

  .frameworks th {
    background-color: #000;
    color: #FFF;
    padding: 3px 10px;
  }

  .frameworks tr {
    text-align: left;
  }

  .frameworks td {
    background-color: #FFF;
    padding: 3px 10px;
  }

  #registration-status {
    background-color: #FFE454;
    padding: 10px;
  }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;section id="registration-status"&gt;
    &lt;p&gt;Registration status: &lt;strong id="status"&gt;&lt;/strong&gt;&lt;/p&gt;
    &lt;input type="button" id="resetButton" value="Reset" /&gt;
  &lt;/section&gt;
  &lt;section&gt;
      &lt;h2&gt;JS Frameworks &amp; Creators&lt;/h2&gt;
      &lt;table class="frameworks"&gt;
        &lt;tr&gt;
          &lt;th&gt;Framework&lt;/th&gt;
          &lt;th&gt;Name&lt;/th&gt;
          &lt;th&gt;Twitter&lt;/th&gt;
        &lt;/tr&gt;
        {{#users}}
          &lt;tr&gt;
              &lt;td&gt;{{framework}}&lt;/td&gt;
              &lt;td&gt;{{person.firstName}} 
			  {{person.lastName}}&lt;/td&gt;
              &lt;td&gt;&lt;a href="https://twitter.com/{{twitter}}"&gt;@{{twitter}}&lt;/a&gt;&lt;/td&gt;
          &lt;/tr&gt;
        {{/users}}
      &lt;/table&gt;
  &lt;/section&gt;

  &lt;script&gt;
  'use strict';

  var scope = {
    scope: './'
  };

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register(
      'service-worker.js',
      scope
    ).then( function(serviceWorker) {
      printStatus('successful');
    }).catch(function(error) {
      printStatus(error);
    });
  } else {
    printStatus('unavailable');
  }

  function printStatus(status) {
    document.querySelector('#status').innerHTML = status;
  }

  document.querySelector('#resetButton').addEventListener('click',
    function() {
      navigator.serviceWorker.getRegistration().then(function(registration) {
        registration.unregister();
        window.location.reload();
      });
    }
  );
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div></li><li class="listitem">Create a <a id="id197" class="indexterm"/>JavaScript file called <code class="literal">service-worker.js</code>, in the same folder as the <code class="literal">index.html</code> file, with the following code:<div class="informalexample"><pre class="programlisting">'use strict';

importScripts('handlebars.js');

var cacheName= 'template-cache';

self.addEventListener('install', function(event) {
  event.waitUntil(
    caches.open(cacheName)
      .then(function(cache) {
        return cache.addAll([
          'index.html',
          'service-worker.js',
          'people.json'
        ]);
      })
      .then(function() {
        return self.skipWaiting();
      })
  );
});

self.addEventListener('fetch', function(event) {
  var requestURL = new URL(event.request.url);

  event.respondWith(
    Promise.all([
      caches.match('index.html').then(function(res) {
        if(res) {
          return res.text();
        }
      }),
      caches.match('people.json').then(function(res) {
        return res.json();
      })
    ]).then(function(resps) {
      var template = resps[0],
        data = resps[1],
        renderTemplate = Handlebars.compile(template);

      return new Response(renderTemplate(data), {
        headers: {
          'Content-Type': 'text/html'
        }
      });
    })
  );
});</pre></div></li><li class="listitem">Create a <a id="id198" class="indexterm"/>JSON file called <code class="literal">people.js</code>, in the same folder as the <code class="literal">index.html</code> file, with the following code:<div class="informalexample"><pre class="programlisting">{
  "users":[
    {
      "framework": "Ember",
      "person":{
        "firstName": "Yehuda",
        "lastName": "Katz"
      },
      "twitter": "wycats"
    },
    {
      "framework": "React",
      "person":{
        "firstName": "Jordan",
        "lastName": "Walke"
      },
      "twitter": "jordwalke"
    },
    {
      "framework": "Angular",
      "person":{
        "firstName": "Miško",
        "lastName": "Hevery"
      },
      "twitter": "mhevery"
    }
  ]
}</pre></div></li><li class="listitem">Download the <a id="id199" class="indexterm"/>handlebars library from <a class="ulink" href="http://handlebarsjs.com/installation.html">http://handlebarsjs.com/installation.html</a> and save as <code class="literal">handlebars.js</code> in <a id="id200" class="indexterm"/>the same directory as the <code class="literal">index.html</code> file, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/B05381_04_01.jpg" alt="How to do it..."/></div></li><li class="listitem">Open up a browser and go to the <code class="literal">index.html</code> file:<div class="mediaobject"><img src="graphics/B05381_04_02.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec85"/>How it works...</h2></div></div></div><p>We are <a id="id201" class="indexterm"/>using handlebars as our choice of templating engine for this example.</p><p>The template for the service worker is the <code class="literal">index.html</code> file itself. We are using double curly braces, the <code class="literal">Handlebars</code> syntax, inside a table:</p><div class="informalexample"><pre class="programlisting">&lt;table class="frameworks"&gt;
    &lt;tr&gt;
    &lt;th&gt;Framework&lt;/th&gt;
       &lt;th&gt;Name&lt;/th&gt;
       &lt;th&gt;Twitter&lt;/th&gt;
    &lt;/tr&gt;
    {{#users}}
       &lt;tr&gt;
          &lt;td&gt;{{framework}}&lt;/td&gt;
          &lt;td&gt;{{person.firstName}} {{person.lastName}}&lt;/td&gt;
          &lt;td&gt;&lt;a href="https://twitter.com/{{twitter}}"&gt;
		  @{{twitter}}&lt;/a&gt;&lt;/td&gt;
          &lt;/tr&gt;
        {{/users}}
&lt;/table&gt;</pre></div><p>The values <a id="id202" class="indexterm"/>are read from the JSON file that we feed into the template. The <code class="literal">{{#users}}</code> tag is an array, and it works like a loop, printing out the content inside the <code class="literal">users</code> property to the screen by replacing the placeholder, such as <code class="literal">{{twitter}}</code>, with the relevant value.</p><p>The <code class="literal">people.json</code> file contains data we need for our template. The <code class="literal">users</code> property contains an array of the users:</p><div class="informalexample"><pre class="programlisting">{
  "users":[
    {
      "framework": "Ember",
      "person":{
        "firstName": "Yehuda",
        "lastName": "Katz"
      },
      "twitter": "wycats"
    },
    {
      "framework": "React",
      "person":{
        "firstName": "Jordan",
        "lastName": "Walke"
      },
      "twitter": "jordwalke"
    },
    {
      "framework": "Angular",
      "person":{
        "firstName": "Miško",
        "lastName": "Hevery"
      },
      "twitter": "mhevery"
    }
  ]
}</pre></div><p>Let's move on to the <code class="literal">service-worker.js</code> file. There we handle two events: install and fetch. In the install event handler, we are caching all the dependencies:</p><div class="informalexample"><pre class="programlisting">return cache.addAll([
          'index.html',
          'style.css',
          'service-worker.js',
          'people.json'
        ]);</pre></div><p>Inside the fetch <a id="id203" class="indexterm"/>handler, we check to see whether the fetch request is the template, in our case the <code class="literal">index.html</code> file, and we send the response in text format:</p><div class="informalexample"><pre class="programlisting">caches.match('index.html').then(function(response) {
        if(response) {
          return response.text();
        }
      }),</pre></div><p>If the fetch request is the JSON file, we return the result in JSON format:</p><div class="informalexample"><pre class="programlisting">   caches.match('people.json').then(function(response) {
        return response.json();
      })</pre></div><p>Finally, we render the template with the JSON data and then send the response back with a header:</p><div class="informalexample"><pre class="programlisting">]).then(function(resps) {
      var template = resps[0],
        data = resps[1],
        renderTemplate = Handlebars.compile(template);

      return new Response(renderTemplate(data), {
        headers: {
          'Content-Type': 'text/html'
        }
      });
    })</pre></div><p>The <code class="literal">Handlebars.compile()</code> function takes in a template and returns a function, which can in turn take in data and render an output.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec86"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Registering a service worker in detail</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <span class="emphasis"><em>Learning Service Worker Basics</em></span></li></ul></div></div></div>
<div class="section" title="Implementing read-through caching"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec33"/>Implementing read-through caching</h1></div></div></div><p>Read-through caching<a id="id204" class="indexterm"/> is an assertive approach to all-out caching for types of static content you visit regularly. This is not very suitable for dynamic content, such as news or sports. A selective caching approach would be better suited for such instances. Read-through caching saves us the necessary bandwidth for the server, as well as requests over the network. The way read-through caching works is that after the service worker takes control of your page, when the first <code class="literal">fetch()</code> request is called, the response will be cached, and subsequent requests to the same URL will be served from the cache.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec87"/>Getting ready</h2></div></div></div><p>To get <a id="id205" class="indexterm"/>started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the first recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <span class="emphasis"><em>Learning Service Worker Basics</em></span>: <span class="emphasis"><em>Setting up service workers</em></span>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the following recipes of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <span class="emphasis"><em>Learning Service Worker Basics</em></span>: <span class="emphasis"><em>Setting up GitHub pages for SSL</em></span>, <span class="emphasis"><em>Setting up SSL for Windows</em></span>, and <span class="emphasis"><em>Setting up SSL for Mac</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec88"/>How to do it...</h2></div></div></div><p>Follow the instructions to set up your file structure. Alternatively, you can download the files from the following location:</p><p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/tree/master/service-workers/04/02">https://github.com/szaranger/szaranger.github.io/tree/master/service-workers/04/02</a>/</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we must create an <code class="literal">index.html</code> file as follows:<div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;title&gt;Read-through Caching&lt;/title&gt;
  &lt;link rel="stylesheet" href="style.css"&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;section id="registration-status"&gt;
    &lt;p&gt;Registration status: &lt;strong id="status"&gt;&lt;/strong&gt;&lt;/p&gt;
    &lt;input type="button" id="resetButton" value="Reset" /&gt;
  &lt;/section&gt;
  &lt;section&lt;/section&gt;
  &lt;script src="index.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div></li><li class="listitem">Create a CSS file <a id="id206" class="indexterm"/>called <code class="literal">style.css</code> in the same folder as the <code class="literal">index.html</code> file:<div class="informalexample"><pre class="programlisting">* {
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

body {
  margin: 0 auto;
  text-align: center;
  font-family: sans-serif;
}

main {
  max-width: 350px;
  border: 1px solid #4CAF50;
  padding: 20px;
  border-radius: 5px;
  width: 350px;
  margin: 20px auto;
}

h1 {
  color: #4CAF50;
}

img {
  padding: 20px 0;
  max-width: 200px;
}

.hidden {
  display: none;
}

#registration-status {
  background-color: #FFE454;
  padding: 10px;
}</pre></div></li><li class="listitem">Create a JavaScript file called <code class="literal">index.js</code> in the same folder as the <code class="literal">index.html</code> file:<div class="informalexample"><pre class="programlisting">'use strict';

var scope = {
  scope: './'
};

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register(
    'service-worker.js',
    scope
  ).then( function(serviceWorker) {
    printStatus('successful');
  }).catch(function(error) {
    printStatus(error);
  });
} else {
  printStatus('unavailable');
}

function printStatus(status) {
  document.querySelector('#status').innerHTML = status;
}

document.querySelector('#resetButton').addEventListener('click',
  function() {
    navigator.serviceWorker.getRegistration().then(function(registration) {
      registration.unregister();
      window.location.reload();
    });
  }
);</pre></div></li><li class="listitem">Create a <a id="id207" class="indexterm"/>JavaScript file called <code class="literal">service-worker.js</code> in the same folder as the <code class="literal">index.html</code> file:<div class="informalexample"><pre class="programlisting">'use strict';

var version = 1,
  currentCaches= { readThrough : 'version-' + version },
  NOT_FOUND = -1,
  ERROR_RESPONSE = 400;

self.addEventListener('activate', function(event) {
  var expectingCacheNames = Object.keys(currentCaches).map(function(key) {
    return currentCaches[key];
  });

  event.waitUntil(
    caches.keys().then(function(cacheNames) {
      return Promise.all(
        cacheNames.map(function(cacheName) {
          if (expectingCacheNames.indexOf(cacheName) === NOT_FOUND) {
            console.log(
              '%c DELETE: Out of date cache: %s',
              'color: #ff0000',
              cacheName
            );
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
});

self.addEventListener('fetch', function(event) {
  var request = event.request,
    requestUrl = request.url;

  console.log(
    '%c <img src="graphics/B05381_04_18.jpg" alt="How to do it..."/> EVENT: %c Handling fetch event for %s',
    'color: #F57F20',
    'color: #000',
    requestUrl
  );

  event.respondWith(
    caches.open(currentCaches['readThrough']).then(function(cache) {
      return cache.match(request).then(function(response) {
        if (response) {
          console.log(
            '%c P RESPONSE: %c Found in cache: %s',
            'color: #5EBD00',
            'color: #000000',
            response
          );

          return response;
        }
        console.log(
          '%c O RESPONSE: %c For %s not found in cache. ' +
          'fetching from network...',
          'color: #F05266',
          'color: #000',
          requestUrl
        );

        return fetch(request.clone()).then(function(response) {
          console.log(
            '%c RESPONSE: %c For %s from network is: %O',
            'color: #F05266',
            'color: #000',
            requestUrl,
            response
          );

          if (response.status &lt; ERROR_RESPONSE) {
            cache.put(request, response.clone());
          }

          return response;
        });
      }).catch(function(err) {
        console.error('FAIL: Read-through cache:', err);
        throw error;
      });
    })
  );
});</pre></div></li><li class="listitem">Open up a<a id="id208" class="indexterm"/> browser and go to <code class="literal">index.html</code>:<div class="mediaobject"><img src="graphics/B05381_04_03.jpg" alt="How to do it..."/></div></li><li class="listitem">Open up<a id="id209" class="indexterm"/> Developer Tools (<span class="emphasis"><em>Cmd</em></span> + <span class="emphasis"><em>Alt</em></span> + <span class="emphasis"><em>I</em></span> or <span class="emphasis"><em>F12</em></span>). You will see messages logged on the console, saying most resources were not found in the cache, so were fetched from the network:<div class="mediaobject"><img src="graphics/B05381_04_04.jpg" alt="How to do it..."/></div></li><li class="listitem">If you <a id="id210" class="indexterm"/>refresh the page, you will see different messages appearing in the console. This time, the resources are fetched from the cache:<div class="mediaobject"><img src="graphics/B05381_04_05.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec89"/>How it works...</h2></div></div></div><p>In the <code class="literal">service-worker.js</code> file, we are setting a page-specific name for the cache, as the caches are<a id="id211" class="indexterm"/> origin-based, and no other page should use the same cache name. We are also versioning the cache, in order to address a scenario where you would want a fresh cache; in this instance, we can update the version:</p><div class="informalexample"><pre class="programlisting">var version = 1,
   currentCaches= { readThrough : 'version-' + version },</pre></div><p>We also make sure that the old caches are purged at the time the service worker is activated. So, we delete all the caches that do not match the name we previously specified for our cache name:</p><div class="informalexample"><pre class="programlisting">self.addEventListener('activate', function(event) {
  var expectingCacheNames = Object.keys(currentCaches).map(function(key) {
    return currentCaches[key];
  });

  event.waitUntil(
    caches.keys().then(function(cacheNames) {
      return Promise.all(
        cacheNames.map(function(cacheName) {
          if (expectingCacheNames.indexOf(cacheName) === NOT_FOUND) {
            console.log('%c DELETE: Out of date cache: %s',
              'color: #ff0000', cacheName);
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
});</pre></div><p>The fetch event listener looks into the cache to find whether our requested resource is in the cache; if it is found, it will respond with the entry:</p><div class="informalexample"><pre class="programlisting">event.respondWith(
    caches.open(currentCaches['readThrough']).then(function(cache) {
      return cache.match(request).then(function(response) {
        if (response) {
          console.log(
            '%c ✔ RESPONSE: %c Found in cache: %s',
            'color: #5EBD00','color: #000000',response
          );

          return response;
        }</pre></div><p>Otherwise, if there is no entry for <code class="literal">event.request</code> in the cache, the response is going to be undefined, so we have to fetch the resource using <code class="literal">fetch()</code>:</p><div class="informalexample"><pre class="programlisting">return fetch(request.clone()).then(function(response) {
          console.log(
            '%c RESPONSE: %c For %s from network is: %O',
            'color: #F05266',
            'color: #000',
            requestUrl,
            response
          );</pre></div><p>Here, the <code class="literal">clone()</code> call is useful if we use <code class="literal">cache.put()</code> later.</p><p>Making a <a id="id212" class="indexterm"/>copy is necessary because both <code class="literal">cache.put()</code> and <code class="literal">fetch()</code> will consume the request.</p><p>We also make sure not to cache error responses by checking the <code class="literal">response.status</code> parameter is not 400 or above:</p><div class="informalexample"><pre class="programlisting">if (response.status &lt; ERROR_RESPONSE) {</pre></div><p>Lastly, we call the <code class="literal">clone()</code> method on the response, in order to save a copy in the cache, and then return the response to the browser:</p><div class="informalexample"><pre class="programlisting">…
cache.put(request, response.clone());
}

return response;</pre></div></div></div>
<div class="section" title="Allowing offline Google Analytics"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec34"/>Allowing offline Google Analytics</h1></div></div></div><p>We discussed<a id="id213" class="indexterm"/> read-through caching in the previous recipe. Let's quickly recap what read-through caching is. After a service worker gains control of the page, the first time a new resource has been requested, the response will be stored in the service worker cache.</p><p>In this recipe, we are utilizing this feature to store any failed Google Analytics/collect pings in an IndexedDb database. IndexedDb is a client-side, user-specific storage specification that allows us to store data in an indexed manner, and is backed by an API that provides search capabilities. So any time the service worker starts up, any saved Google Analytics pings will be replayed.</p><p>To learn more <a id="id214" class="indexterm"/>about IndexedDb you can follow these links:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Using_IndexedDB">https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Using_IndexedDB</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://seanamarasinghe.com/developer/indexeddb/">http://seanamarasinghe.com/developer/indexeddb/</a></li></ul></div><p>This will give you a great platform to perform transactions offline, regardless of connectivity and availability.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec90"/>Getting ready</h2></div></div></div><p>To get <a id="id215" class="indexterm"/>started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the first recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <span class="emphasis"><em>Learning Service Worker Basics</em></span>: <span class="emphasis"><em>Setting up service workers</em></span>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the following recipes: <span class="emphasis"><em>Setting up GitHub pages for SSL</em></span>, <span class="emphasis"><em>Setting up SSL for Windows</em></span>, and <span class="emphasis"><em>Setting up SSL for Mac</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec91"/>How to do it...</h2></div></div></div><p>Follow the instructions to set up your file structure. Alternatively, you can download the files from the following location:</p><p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/tree/master/service-workers/04/03/">https://github.com/szaranger/szaranger.github.io/tree/master/service-workers/04/03/</a>
</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we must create an <code class="literal">index.html</code> file as follows:<div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;title&gt;Offline Google Analytics&lt;/title&gt;
  &lt;link rel="stylesheet" href="style.css"&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;section id="registration-status"&gt;
    &lt;p&gt;Registration status: &lt;strong id="status"&gt;&lt;/strong&gt;&lt;/p&gt;
    &lt;input type="button" id="resetButton" value="Reset" /&gt;
  &lt;/section&gt;
  &lt;section id="outlet"&gt;
    &lt;p id="message"&gt;&lt;/p&gt;
    &lt;div id="images" style="display: none"&gt;
       &lt;img src="https://raw.githubusercontent.com/szaranger/szaranger.github.io/master/service-workers/04/03/serice-worker.jpg"&gt;
    &lt;/div&gt;
  &lt;/section&gt;
  &lt;script src="index.js"&gt;&lt;/script&gt;
  &lt;script&gt;
      /* jshint ignore:start */
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-12345678-1', 'auto');
      ga('send', 'pageview');
      /* jshint ignore:end */
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div></li><li class="listitem">Create <a id="id216" class="indexterm"/>a CSS file called <code class="literal">style.css</code>, in the same folder as the <code class="literal">index.html</code> file, with the following code:<div class="informalexample"><pre class="programlisting">* {
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

body {
  margin: 0 auto;
  text-align: center;
  font-family: sans-serif;
}

main {
  max-width: 350px;
  border: 1px solid #4CAF50;
  padding: 20px;
  border-radius: 5px;
  width: 350px;
  margin: 20px auto;
}

h1 {
  color: #4CAF50;
}

img {
  padding: 20px 0;
  max-width: 400px;
}

.hidden {
  display: none;
}

#registration-status {
  background-color: #FFE454;
  padding: 10px;
}</pre></div></li><li class="listitem">Create a <a id="id217" class="indexterm"/>JavaScript file called <code class="literal">index.js</code>, in the same folder as the <code class="literal">index.html</code> file, with the following code:<div class="informalexample"><pre class="programlisting">'use strict';

var scope = {
  scope: './'
};

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register(
    'service-worker.js',
    scope
  ).then( function(serviceWorker) {
    printStatus('successful');
    if (navigator.serviceWorker.controller) {
      showImages();
    } else {
      document.querySelector('#message').textContent = 'Reload the page for images to be loaded from the service worker cache';
    }
  }).catch(function(error) {
    printStatus(error);
  });
} else {
  printStatus('unavailable');
}

function printStatus(status) {
  document.querySelector('#status').innerHTML = status;
}

document.querySelector('#resetButton').addEventListener('click',
  function() {
    navigator.serviceWorker.getRegistration().then(function(registration) {
      registration.unregister();
      window.location.reload();
    });
  }
);

function showImages() {
  document.querySelector('#images').style.display = 'block';
}</pre></div></li><li class="listitem">Create a <a id="id218" class="indexterm"/>JavaScript file called <code class="literal">analytics.js</code>, in the same folder as the <code class="literal">index.html</code> file, with the following code:<div class="informalexample"><pre class="programlisting">'use strict';

var RW = 'readwrite';

function checkForAnalyticsRequest(requestUrl) {
  var url = new URL(requestUrl),
    regex = /^(w{3}|ssl)\.google-analytics.com$/;

  if (url.hostname.match(regex) &amp;&amp; url.pathname === '/collect') {
    console.log('INDEXEDDB: Store request(Google analytics) for replaying later.');
    saveGoogleAnalyticsRequest(requestUrl);
  }
}

function saveGoogleAnalyticsRequest(requestUrl) {
  getIDBObjectStore(idbInstance, idbStore, RW).add({
    url: requestUrl,
    timestamp: Date.now()
  });
}

function replayGoogleAnalyticsRequests(idbInstance, idbStore, throttle) {
  var savedGoogleAnalyticsRequests = [];

  getIDBObjectStore(idbInstance, idbStore).openCursor().onsuccess = function(event) {
    var cursor = event.target.result;

    if (cursor) {
      savedGoogleAnalyticsRequests.push(cursor.value);
      cursor.continue();
    } else {
      console.log('REPLAY: Starting %d Google Analytics requests',
        savedGoogleAnalyticsRequests.length);

      savedGoogleAnalyticsRequests.forEach(function(savedRequest) {
        var queueTime = Date.now() - savedRequest.timestamp;
        if (queueTime &gt; throttle) {
          getIDBObjectStore(idbInstance, idbStore, RW).delete(savedRequest.url);
          console.log('REQUEST: Queued for %dms ' +
            'STOPPED: Replay attempt', queueTime);
        } else {
          var requestUrl = savedRequest.url + '&amp;qt=' + queueTime;

          console.log('%c ♫ REPLAY: %s %s', 'color: #1C99D8', 'in progress...', requestUrl);

          fetch(requestUrl).then(function(response) {
            if (response.status &lt; 400) {
              getIDBObjectStore(idbInstance, idbStore, RW).delete(savedRequest.url);
              console.log('%c ♫ REPLAY: %s', 'color: #1C99D8', 'success');
            } else {
              console.error('♫ REPLAY: fail -', response);
            }
          }).catch(function(err) {
            console.error('♫ REPLAY: fail - ', err);
          });
        }
      });
    }
  };
}</pre></div></li><li class="listitem">Open up a browser and go to the <code class="literal">index.html</code> file:<div class="mediaobject"><img src="graphics/B05381_04_06.jpg" alt="How to do it..."/></div></li><li class="listitem">Now<a id="id219" class="indexterm"/> open up DevTools (<span class="emphasis"><em>Cmd</em></span> + <span class="emphasis"><em>Alt</em></span> + <span class="emphasis"><em>I</em></span> or <span class="emphasis"><em>F12</em></span>) and go to the <span class="strong"><strong>Network</strong></span> tab. You will see the <code class="literal">/collect</code> requests have a state of <span class="strong"><strong>200</strong></span>, which means successful:<div class="mediaobject"><img src="graphics/B05381_04_07.jpg" alt="How to do it..."/></div></li><li class="listitem">Refresh<a id="id220" class="indexterm"/> the page. You will see an image as shown in the following screenshot:<div class="mediaobject"><img src="graphics/B05381_04_08.jpg" alt="How to do it..."/></div></li><li class="listitem">Go to <a id="id221" class="indexterm"/>the <span class="strong"><strong>Console</strong></span> tab of DevTools:<div class="mediaobject"><img src="graphics/B05381_04_09.jpg" alt="How to do it..."/></div></li><li class="listitem">Now, go to the <span class="strong"><strong>Network</strong></span> tab of DevTools and select <span class="strong"><strong>Offline</strong></span>:<div class="mediaobject"><img src="graphics/B05381_04_10.jpg" alt="How to do it..."/></div></li><li class="listitem">Refresh<a id="id222" class="indexterm"/> the page and you will still see the same page, but if you view the network requests, you will be able to find out that the service worker has saved the analytics requests in IndexedDb:<div class="mediaobject"><img src="graphics/B05381_04_11.jpg" alt="How to do it..."/></div></li><li class="listitem">Now change the <span class="strong"><strong>Offline</strong></span> option to <span class="strong"><strong>No throttling</strong></span> in DevTools:<div class="mediaobject"><img src="graphics/B05381_04_12.jpg" alt="How to do it..."/></div></li><li class="listitem">Click on the <span class="strong"><strong>Reset</strong></span> button on this page to refresh the service worker, and monitor the console in DevTools. You will see that the replay message extracted from IndexedDb has been sent:<div class="mediaobject"><img src="graphics/B05381_04_13.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec92"/>How it works...</h2></div></div></div><p>In the <code class="literal">service-worker.js</code> file, we are accessing IndexedDb by getting a reference to it. Then<a id="id223" class="indexterm"/> we go on attaching event handlers for the <code class="literal">error</code>, <code class="literal">upgradeneed</code>, and <code class="literal">onsuccess</code> events of the database instance:</p><div class="informalexample"><pre class="programlisting">var db = openIDBDatabase('offline-google-analytics', idbVersion);
db.onerror = function(err) {
  console.error('%c ✗ ERROR: IndexedDB - %s', 'color: #ff0000', err);
};

db.onupgradeneeded = function() {
  this.result.createObjectStore(idbStore, {keyPath: 'url'});
};

db.onsuccess = function() {
  idbInstance = this.result;
  replayGoogleAnalyticsRequests(idbInstance, idbStore, throttle);
};</pre></div><p>Because of the read-through, caching will cache the initial requests; the subsequent requests to the same resource will be handled by the <code class="literal">fetch()</code> event handler of the service worker. The fetch event handler queries the cache for requests in the <code class="literal">currentCaches</code> cache, and sends the response back to the browser:</p><div class="informalexample"><pre class="programlisting">event.respondWith(
    caches.open(currentCaches['offline-google-analytics']).then(function(cache) {
      return cache.match(event.request).then(function(res) {
        if (res) {
          console.log(
            '%c ✔ RESPONSE: %c Found in cache: %s',
            'color: #5EBD00', 'color: #000000', res
          );

          return res;
        }</pre></div><p>If the response was not found, it will send a fetch request to the network:</p><div class="informalexample"><pre class="programlisting"> return fetch(event.request.clone()).then(function(res) {
          console.log('%c ✔ RESPONSE: %c For %s from network: %O',
            'color: #5EBD00', 'color: #000000',
            event.request.url, res);

          if (res.status &lt; 400) {
            cache.put(event.request, res.clone());
          }</pre></div><p>If the response for the preceding request was successful, the response will be cloned and added to the cache, with the request as the key and the response as the value:</p><div class="informalexample"><pre class="programlisting">promises = promises.map(function(promise) {
      return Promise.resolve(promise);
    });</pre></div><p>Next, we <a id="id224" class="indexterm"/>make sure that we resolve the current promise as soon as another one in the array gets resolved:</p><div class="informalexample"><pre class="programlisting">if (res.status &lt; 400) {
            cache.put(event.request, res.clone());
          }</pre></div><p>If the response is not a server error, and is likely to be a timeout, we pass the request URL to <code class="literal">checkForAnalyticsRequest()</code>:</p><div class="informalexample"><pre class="programlisting">} else if (res.status &gt;= 500) {
            checkForAnalyticsRequest(event.request.url);
          }</pre></div><p>The <code class="literal">checkForAnalyticsRequest()</code> function is in the <code class="literal">analytics.js</code> file. Let's examine this method. The passed-in URL is first checked to make sure whether it's a call to <code class="literal">google-analytics.com</code>, regardless of whether the subdomain is <code class="literal">www</code> or <code class="literal">ssl</code>, and the path name has <code class="literal">/collect</code> in it. This is to make sure this is an analytics ping:</p><div class="informalexample"><pre class="programlisting">function checkForAnalyticsRequest(requestUrl) {
  var url = new URL(requestUrl),
    regex = /^(w{3}|ssl)\.google-analytics.com$/;

  if (url.hostname.match(regex) &amp;&amp; url.pathname === '/collect') {
    console.log('INDEXEDDB: Store request(Google analytics) for replaying later.');
    saveGoogleAnalyticsRequest(requestUrl);
  }
}</pre></div><p>The <code class="literal">saveGoogleAnalyticsRequest()</code> method will add the URL and the timestamp to the store, which in turn saves the entry.</p><p>The <code class="literal">onsuccess()</code> method, back in the <code class="literal">service-worker.js</code> file, calls the <code class="literal">replayGoogleAnalyticsRequests()</code> method. Inside this method, the analytics requests will be saved in a queue called <code class="literal">savedGoogleAnalyticsRequests</code>:</p><div class="informalexample"><pre class="programlisting">function replayGoogleAnalyticsRequests(idbInstance, idbStore, throttle) {
  var savedGoogleAnalyticsRequests = [];

  getIDBObjectStore(idbInstance, idbStore).openCursor().onsuccess = function(event) {
    var cursor = event.target.result;</pre></div><p>The <code class="literal">openCursor()</code> function is a pointer to the database where you can traverse records.</p><p>The callback of the <code class="literal">onsuccess</code> event handler will pass in the value of <code class="literal">event.target.result</code> into the <code class="literal">savedGoogleAnalyticsRequests</code> array:</p><div class="informalexample"><pre class="programlisting">getIDBObjectStore(idbInstance, idbStore).openCursor().onsuccess = function(event) {
    var cursor = event.target.result;

    if (cursor) {
      savedGoogleAnalyticsRequests.push(cursor.value);
      cursor.continue();
    }</pre></div><p>Otherwise, each <a id="id225" class="indexterm"/>saved Google Analytics request will be replayed:</p><div class="informalexample"><pre class="programlisting">} else {
      console.log('REPLAY: Starting %d Google Analytics requests',
        savedGoogleAnalyticsRequests.length);

      savedGoogleAnalyticsRequests.forEach(function(savedRequest) {
        var queueTime = Date.now() - savedRequest.timestamp;
        if (queueTime &gt; throttle) {
          getIDBObjectStore(idbInstance, idbStore, RW).delete(savedRequest.url);
          console.log('REQUEST: Queued for %dms ' +
            'STOPPED: Replay attempt', queueTime);
        } else {
          var requestUrl = savedRequest.url + '&amp;qt=' + queueTime;

          console.log('%c ♫ REPLAY: %s %s', 'color: #1C99D8', 'in progress...', requestUrl);

          fetch(requestUrl).then(function(response) {
            if (response.status &lt; 400) {
              getIDBObjectStore(idbInstance, idbStore, RW).delete(savedRequest.url);
              console.log('%c ♫ REPLAY: %s', 'color: #1C99D8', 'success');
            } else {
              console.error('♫ REPLAY: fail -', response);
            }
          }).catch(function(err) {
            console.error('♫ REPLAY: fail - ', err);
          });
        }
      });
    }</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec93"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Implementing read-through caching</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Allowing offline user interaction"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec35"/>Allowing offline user interaction</h1></div></div></div><p>Most <a id="id226" class="indexterm"/>websites out there, including news articles, sports videos, or music, are not quite able to be taken offline completely, given their amount of content. There is no real reason for having everything in your cache if you don't access them. But giving the user the option of saving the content in the cache to read later is the ideal solution. In this recipe, we are going to investigate how we can achieve this.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec94"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the first recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <span class="emphasis"><em>Learning Service Worker Basics</em></span>: <span class="emphasis"><em>Setting up service workers</em></span>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the following recipes: <span class="emphasis"><em>Setting up GitHub pages for SSL</em></span>, <span class="emphasis"><em>Setting up SSL for Windows</em></span>, and <span class="emphasis"><em>Setting up SSL for Mac</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec95"/>How to do it...</h2></div></div></div><p>Follow the instructions to set up your file structure. Alternatively, you can download the files from the following location:</p><p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/tree/master/service-workers/04/04/">https://github.com/szaranger/szaranger.github.io/tree/master/service-workers/04/04/</a>
</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we must create an <code class="literal">index.html</code> file as follows:<div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;title&gt;Offline User Interaction&lt;/title&gt;
  &lt;link rel="stylesheet" href="style.css"&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;section id="registration-status"&gt;
    &lt;p&gt;Registration status: &lt;strong id="status"&gt;&lt;/strong&gt;&lt;/p&gt;
    &lt;input type="button" id="resetButton" value="Reset" /&gt;
  &lt;/section&gt;
  &lt;section&gt;
    &lt;video width="320" height="240" id="video-01" controls&gt;
      &lt;source src="video.mp4" type="video/mp4"&gt;
      Your browser does not support the video tag.
    &lt;/video&gt;
    &lt;input type="button" id="watch-later" value="Watch Later" /&gt;
  &lt;/section&gt;
  &lt;script src="index.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div></li><li class="listitem">Create a <a id="id227" class="indexterm"/>JavaScript file called <code class="literal">index.js</code>, in the same folder as the <code class="literal">index.html</code> file, with the following code:<div class="informalexample"><pre class="programlisting">'use strict';

var scope = {
  scope: './'
};

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register(
    'service-worker.js',
    scope
  ).then( function(serviceWorker) {
    printStatus('successful');
  }).catch(function(error) {
    printStatus(error);
  });
} else {
  printStatus('unavailable');
}

document.querySelector('#resetButton').addEventListener('click',
  function() {
    navigator.serviceWorker.getRegistration().then(function(registration) {
      registration.unregister();
      window.location.reload();
    });
  }
);

function printStatus(status) {
  document.querySelector('#status').innerHTML = status;
}

document.getElementById('watch-later').addEventListener('click', function(event) {
  event.preventDefault();

  caches.open('video').then(function(cache) {
    fetch('video.mp4').then(function(response) {
      return response.url;
    }).then(function(url) {
      cache.add(url);
    });
  });
});</pre></div></li><li class="listitem">Create a <a id="id228" class="indexterm"/>JavaScript file called <code class="literal">service-worker.js</code>, in the same folder as the <code class="literal">index.html</code> file, with the following code:<div class="informalexample"><pre class="programlisting">'use strict';

var cacheName= 'user-interaction-cache';

self.addEventListener('install', function(event) {
  event.waitUntil(
    caches.open(cacheName)
      .then(function(cache) {
        return cache.addAll([
          'index.html'
        ]);
      })
      .then(function() {
        return self.skipWaiting();
      })
  );
});

self.addEventListener('fetch', function(event) {
  event.respondWith(
    caches.match(event.request)
      .then(function(response) {
        if (response) {
          console.log('Fetching from the cache: ', event.request.url);
          return response;
        } else {
          console.log('Fetching from server: ', event.request.url);
        }
       return fetch(event.request);
     }
   )
 );
});

self.addEventListener('activate', function(event) {
   console.log('Activating the service worker!');
   event.waitUntil(self.clients.claim());
});</pre></div></li><li class="listitem">Create a <a id="id229" class="indexterm"/>CSS file called <code class="literal">style.css</code>, in the same folder as the <code class="literal">index.html</code> file, with the following code:<div class="informalexample"><pre class="programlisting">* {
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

body {
  margin: 0 auto;
  text-align: center;
  font-family: sans-serif;
}

main {
  max-width: 350px;
  border: 1px solid #4CAF50;
  padding: 20px;
  border-radius: 5px;
  width: 350px;
  margin: 20px auto;
}

h1 {
  color: #4CAF50;
}

img {
  padding: 20px 0;
  max-width: 200px;
}

.hidden {
  display: none;
}

#registration-status {
  background-color: #FFE454;
  padding: 10px;
}

input#watch-later {
    display: block;
    margin: 10px auto;
    padding: 50px;
}</pre></div></li><li class="listitem">Open <a id="id230" class="indexterm"/>up a browser and go to the <code class="literal">index.html</code> file. You will see one prefetched bookmark:<div class="mediaobject"><img src="graphics/B05381_04_14.jpg" alt="How to do it..."/></div></li><li class="listitem">Add the<a id="id231" class="indexterm"/> video to the cache by clicking on the <span class="strong"><strong>Watch Later</strong></span> button:</li><li class="listitem">Now, change the <span class="strong"><strong>Offline</strong></span> option to <span class="strong"><strong>No throttling</strong></span> in DevTools:<div class="mediaobject"><img src="graphics/B05381_04_15.jpg" alt="How to do it..."/></div></li><li class="listitem">Now refresh the page. You will see that styles aren't loaded, but the video is still accessible:<div class="mediaobject"><img src="graphics/B05381_04_16.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec96"/>How it works...</h2></div></div></div><p>In <a id="id232" class="indexterm"/>our <code class="literal">service-worker.js</code> file, we are only caching the <code class="literal">index.html</code> file in order to load the page:</p><div class="informalexample"><pre class="programlisting">caches.open(cacheName)
      .then(function(cache) {
        return cache.addAll([
          'index.html'
        ]);
      })</pre></div><p>In the <code class="literal">index.html</code> file, we have a video tag with its source pointing to a video file. If the <code class="literal">.mp4</code> extension is not supported by the browser, it will show the <code class="literal">Your browser does not support the video tag</code> message:</p><div class="informalexample"><pre class="programlisting">&lt;section&gt;
    &lt;video width="320" height="240" id="video-01" controls&gt;
      &lt;source src="video.mp4" type="video/mp4"&gt;
      Your browser does not support the video tag.
    &lt;/video&gt;
    &lt;input type="button" id="watch-later" value="Watch Later" /&gt;
  &lt;/section&gt;</pre></div><p>When <a id="id233" class="indexterm"/>you click the <span class="strong"><strong>Watch Later</strong></span> button, the event handler gets fired, which is in turn is handled inside the <code class="literal">index.js</code> file:</p><div class="informalexample"><pre class="programlisting">document.getElementById('watch-later').addEventListener('click', function(event) {
  event.preventDefault();

  caches.open('video').then(function(cache) {
    fetch('video.mp4').then(function(response) {
      return response.url;
    }).then(function(url) {
      cache.add(url);
    });
  });
});</pre></div><p>The <code class="literal">cache.add()</code> function adds the response URL to the cache. Back in <code class="literal">service-worker.js</code>, the event listener for fetch retrieves this saved response when we refresh the page in offline mode:</p><div class="informalexample"><pre class="programlisting">self.addEventListener('fetch', function(event) {
  event.respondWith(
    caches.match(event.request)
      .then(function(response) {
        if (response) {
          console.log('Fetching from the cache: ', event.request.url);
          return response;
        } else {
          console.log('Fetching from server: ', event.request.url);
        }
       return fetch(event.request);
     }
   )
 );
});</pre></div></div></div>
<div class="section" title="Implementing selective caching"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec36"/>Implementing selective caching</h1></div></div></div><p>In the <a id="id234" class="indexterm"/>second recipe of this chapter, <span class="emphasis"><em>Implementing read-through caching</em></span>, we discussed caching all resources at the time of the first request, and we talked about how it does not suit some scenarios, such as news or sports, where most articles will become outdated and you will never access them again. The solution we pointed out at the time was selective caching. So let's look at a working example.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec97"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the first recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <span class="emphasis"><em>Learning Service Worker Basics</em></span>: <span class="emphasis"><em>Setting up service workers</em></span>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the following recipes: <span class="emphasis"><em>Setting up GitHub pages for SSL</em></span>, <span class="emphasis"><em>Setting up SSL for Windows</em></span>, and <span class="emphasis"><em>Setting up SSL for Mac</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec98"/>How to do it...</h2></div></div></div><p>Follow these instructions to set up your file structure:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we must create an <code class="literal">index.html</code> file as follows:<div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;title&gt;Cache First, then Network&lt;/title&gt;
  &lt;link rel="stylesheet" href="style.css"&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;section id="registration-status"&gt;
    &lt;p&gt;Registration status: &lt;strong id="status"&gt;&lt;/strong&gt;&lt;/p&gt;
    &lt;input type="button" id="resetButton" value="Reset" /&gt;
  &lt;/section&gt;
  &lt;section id="outlet"&gt;
    &lt;p&gt;&lt;/p&gt;
  &lt;/section&gt;
  &lt;script src="index.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div></li><li class="listitem">Create a JavaScript file called <code class="literal">index.js</code>, in the same folder as the <code class="literal">index.html</code> file, with the following code:<div class="informalexample"><pre class="programlisting">'use strict';

var scope = {
  scope: './'
};

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register(
    'service-worker.js',
    scope
  ).then( function(serviceWorker) {
    printStatus('successful');
    document.querySelector('#outlet p').textContent =
    'The service worker controlling this page has cached this funky font.';
  }).catch(function(error) {
    printStatus(error);
  });
} else {
  printStatus('unavailable');
}

function printStatus(status) {
  document.querySelector('#status').innerHTML = status;
}

document.querySelector('#resetButton').addEventListener('click',
  function() {
    navigator.serviceWorker.getRegistration().then(function(registration) {
      registration.unregister();
      window.location.reload();
    });
  }
);</pre></div></li><li class="listitem">Download<a id="id235" class="indexterm"/> the <code class="literal">webfont-serif.woff</code> file from the source code, or use your own font file, in the same folder as the <code class="literal">index.html</code> file.</li><li class="listitem">Create a JavaScript file called <code class="literal">service-worker.js</code>, in the same folder as the <code class="literal">index.html</code> file, with the following code:<div class="informalexample"><pre class="programlisting">'use strict';

var cacheVersion = 1,
  currentCaches = {
  font: 'selective-caching-v' + cacheVersion
};

self.addEventListener('activate', function(event) {
  var cacheNamesExpected = Object.keys(currentCaches).map(function(key) {
    return currentCaches[key];
  });

  event.waitUntil(
    caches.keys().then(function(cacheNames) {
      return Promise.all(
        cacheNames.map(function(cacheName) {
          if (cacheNamesExpected.indexOf(cacheName) === -1) {
            console.log('DELETE: out of date cache:', cacheName);
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
});
self.addEventListener('fetch', function(event) {
  console.log('%c <img src="graphics/B05381_04_19.jpg" alt="How to do it..."/> EVENT: %c Handling fetch event for %s','color: #F57F20',
  'color: #000',
  event.request.url);

  event.respondWith(
    caches.open(currentCaches.font).then(function(cache) {
      return cache.match(event.request).then(function(res) {
        if (res) {
          console.log(
            '%c ✔ RESPONSE: %c Found in cache: %s',
            'color: #5EBD00', 'color: #000000', res
          );
          return res;
        }

        console.log('%c  ✗ RESPONSE: %c Not found for %s in cache. ' +
          'Attempt to fetch from network', 'color: #EB4A4B', 'color: #000000',
          event.request.url);

        return fetch(event.request.clone()).then(function(res) {
          console.log('%c ✔ RESPONSE: %c For %s from network: %O',
            'color: #5EBD00', 'color: #000000',
            event.request.url, res);

          if (res.status &lt; 400 &amp;&amp;
              res.headers.has('content-type') &amp;&amp;
              res.headers.get('content-type').match(/^font\//i)) {
            console.log('%c ✔ RESPONSE: %c Caching to %s ',
              'color: #5EBD00', 'color: #000000',
              event.request.url);
            cache.put(event.request, res.clone());
          } else {
            console.log('%c ✔ RESPONSE: %c Not caching to %s ',
              'color: #5EBD00', 'color: #000000',
              event.request.url);
          }

          return res;
        });
      }).catch(function(err) {
        throw error;
      });
    })
  );
});</pre></div></li><li class="listitem">Create a <a id="id236" class="indexterm"/>CSS file called <code class="literal">style.css</code>, in the same folder as the <code class="literal">index.html</code> file, with the following code:<div class="informalexample"><pre class="programlisting">* {
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

body {
  margin: 0 auto;
  text-align: center;
  font-family: sans-serif;
}

main {
  max-width: 350px;
  border: 1px solid #4CAF50;
  padding: 20px;
  border-radius: 5px;
  width: 350px;
  margin: 20px auto;
}

h1 {
  color: #4CAF50;
}

img {
  padding: 20px 0;
  max-width: 200px;
}

.hidden {
  display: none;
}

#registration-status {
  background-color: #FFE454;
  padding: 10px;
}

@font-face{
  font-family: 'MyWebFont';
  src: url('webfont-serif.woff') format('woff');
}

#outlet p {
  font-family: 'MyWebFont', Arial, sans-serif;
}</pre></div></li><li class="listitem">Open up<a id="id237" class="indexterm"/> a browser and go to <code class="literal">index.html</code>. You will see the <span class="strong"><strong>Registration status: successful</strong></span> message and the logo:<div class="mediaobject"><img src="graphics/B05381_04_17.jpg" alt="How to do it..."/></div></li><li class="listitem">Now, if you refresh the page and inspect the <span class="strong"><strong>Console</strong></span> tab of the Developer Tools, you will be able to see that the <code class="literal">webfont-serif.woff</code> file has been fetched from the cache.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec99"/>How it works...</h2></div></div></div><p>In our <code class="literal">index.html</code> file, we<a id="id238" class="indexterm"/> add a placeholder section for our message to be displayed:</p><div class="informalexample"><pre class="programlisting">  &lt;section id="outlet"&gt;
    &lt;p&gt;&lt;/p&gt;
  &lt;/section&gt;</pre></div><p>In the <code class="literal">style.css</code> file, we declare the font family we are going to use, and then assign it to the paragraph we are targeting:</p><div class="informalexample"><pre class="programlisting">  @font-face{
  font-family: 'MyWebFont';
  src: url('webfont-serif.woff') format('woff');
}

#outlet p {
  font-family: 'MyWebFont', Arial, sans-serif;
}</pre></div><p>In <a id="id239" class="indexterm"/>our <code class="literal">service-worker.js</code> file, we make sure that if a cached version is available, we use it instead of a network request, but fetch an update the next time:</p><div class="informalexample"><pre class="programlisting">if (res.status &lt; 400 &amp;&amp;
              res.headers.has('content-type') &amp;&amp;
              res.headers.get('content-type').match(/^font\//i)) {
            console.log('%c ✔ RESPONSE: %c Caching to %s ',
              'color: #5EBD00', 'color: #000000',
              event.request.url);
            cache.put(event.request, res.clone());
          } else {
            console.log('%c ✔ RESPONSE: %c Not caching to %s ',
              'color: #5EBD00', 'color: #000000',
              event.request.url);
          }</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec100"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Implementing read-through caching</em></span> recipe</li></ul></div></div></div></body></html>