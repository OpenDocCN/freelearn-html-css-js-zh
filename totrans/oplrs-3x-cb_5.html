<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Adding Controls"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Adding Controls</h1></div></div></div><p>In this chapter we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Adding some visual controls</li><li class="listitem" style="list-style-type: disc">Adding the NavigationHistory control</li><li class="listitem" style="list-style-type: disc">Working with geolocation</li><li class="listitem" style="list-style-type: disc">Placing controls outside the map</li><li class="listitem" style="list-style-type: disc">Editing features on multiple vector layers</li><li class="listitem" style="list-style-type: disc">Modifying features</li><li class="listitem" style="list-style-type: disc">Measuring distances and areas</li><li class="listitem" style="list-style-type: disc">Getting feature information from a data source</li><li class="listitem" style="list-style-type: disc">Getting information from a WMS server</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec01"/>Introduction</h1></div></div></div><p>This chapter explores from the basics, the most important and common controls that OpenLayers offers us as developers. Controls allow us to navigate through the map, play with layers, zoom in or out, perform actions such as editing features, measuring distances, and the like. In essence, controls allow us to interact.</p><p>The<code class="literal"> OpenLayers.Control</code> class is the base class for all the controls and contains the common properties and methods that a control can have. We can summarize this as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A control is attached to a map</li><li class="listitem" style="list-style-type: disc">A control can trigger events</li><li class="listitem" style="list-style-type: disc">A control can be activated or deactivated</li><li class="listitem" style="list-style-type: disc">A control can have a visual representation (such as a button) or have no visual representation (such as the drag action)</li></ul></div><p>Controls are closely related to the<span class="strong"><strong> handlers</strong></span>. While controls are designed to contain the logic of the action, they delegate to the handlers<span class="emphasis"><em> the low-level tasks</em></span>, such as to know about the mouse or keyboard events. For example, the<code class="literal"> OpenLayers.Control.DragPan</code> control is responsible for dragging the map by reacting to the mouse events. While the task, to listen to the mouse events, is delegated to an internal instance of the<code class="literal"> OpenLayers.Handler.DragPan</code> class, the task to move the map is made by the control itself.</p><p>In a similar way as with the controls, the class<code class="literal"> OpenLayers.Handler</code> is the base class for all the existing handlers used by the controls.</p><p>Let's see some recipes that will help us to understand the controls better.</p></div></div>
<div class="section" title="Adding and removing controls"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec02"/>Adding and removing controls</h1></div></div></div><p>OpenLayers offers a great number of controls, commonly used on mapping applications.</p><p>This recipe shows how to use the most common controls that have a visual representation. The list includes the OverviewMap control, the Scale and ScaleLine controls, the Graticule control, the LayerSwitcher control, the PanZoomBar control, the MousePosition control, and the Permalink control:<a class="indexterm" id="id190"/>
</p><div class="mediaobject"><img alt="Adding and removing controls" src="graphics/7843_05_01.jpg"/></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec01"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First add the code for the buttons:<a class="indexterm" id="id191"/><div class="informalexample"><pre class="programlisting">&lt;button data-dojo-type="dijit.form.ToggleButton" data-dojo-props="iconClass:'dijitCheckBoxIcon', checked: true, onChange: layerSwitcherChanged"&gt;LayerSwitcher&lt;/button&gt;
&lt;button data-dojo-type="dijit.form.ToggleButton" data-dojo-props="iconClass:'dijitCheckBoxIcon', checked: true, onChange: panZoomBarChanged"&gt;PanZoomBar&lt;/button&gt;
&lt;button data-dojo-type="dijit.form.ToggleButton" data-dojo-props="iconClass:'dijitCheckBoxIcon', checked: true, onChange: mousePositionChanged"&gt;MousePosition&lt;/button&gt;
&lt;button data-dojo-type="dijit.form.ToggleButton" data-dojo-props="iconClass:'dijitCheckBoxIcon', checked: true, onChange: overviewMapChanged"&gt;OverviewMap&lt;/button&gt;
&lt;button data-dojo-type="dijit.form.ToggleButton" data-dojo-props="iconClass:'dijitCheckBoxIcon', checked: true, onChange: graticuleChanged"&gt;Graticule&lt;/button&gt;
&lt;button data-dojo-type="dijit.form.ToggleButton" data-dojo-props="iconClass:'dijitCheckBoxIcon', checked: true, onChange: scaleChanged"&gt;Scale&lt;/button&gt;
&lt;button data-dojo-type="dijit.form.ToggleButton" data-dojo-props="iconClass:'dijitCheckBoxIcon', checked: true, onChange: scaleLineChanged"&gt;ScaleLine&lt;/button&gt;
&lt;button data-dojo-type="dijit.form.ToggleButton" data-dojo-props="iconClass:'dijitCheckBoxIcon', checked: true, onChange: permalinkChanged"&gt;Permalink&lt;/button&gt;
</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note46"/>Note</h3><p>We are using the<span class="strong"><strong> Dojo Toolkit</strong></span> (<a class="ulink" href="http://dojotoolkit.org/">http://dojotoolkit.org/</a>) to create the richest user interface, thanks to the beautiful components it offers. The goal of the recipe is not to teach Dojo, but to teach OpenLayers, so we are free to change the code related to HTML, to use checkbox elements for input, instead of the Dojo toggle buttons, and work with the<code class="literal"> onclick</code> event.</p><p>The importance of the recipe is that the reader learns about creating different controls, attaching them to the map, and activating or deactivating them.</p></div></li><li class="listitem">Next, add the<code class="literal"> div</code> element to hold the map:<div class="informalexample"><pre class="programlisting">&lt;div id="ch05_visual_controls" style="width: 100%; height: 90%;"&gt;&lt;/div&gt;
</pre></div></li><li class="listitem">Create the map instance and add a base layer:<div class="informalexample"><pre class="programlisting">&lt;!-- The magic comes here --&gt;
&lt;script type="text/javascript"&gt;
    // Create map
    var map = new OpenLayers.Map("ch05_visual_controls", {
        controls: []
    });    
    var osm = new OpenLayers.Layer.OSM();        
    map.addLayer(osm);
</pre></div></li><li class="listitem">Add the set of controls:<a class="indexterm" id="id192"/><div class="informalexample"><pre class="programlisting">    // Add controls
    var layerSwitcher = new OpenLayers.Control.LayerSwitcher({'ascending':false});
    var panZoomBar = new OpenLayers.Control.PanZoomBar();
    var mousePosition = new OpenLayers.Control.MousePosition();
    var overviewMap = new OpenLayers.Control.OverviewMap({maximized: true});
    var graticule = new OpenLayers.Control.Graticule({displayInLayerSwitcher: false});
    var scale = new OpenLayers.Control.Scale();
    var scaleline = new OpenLayers.Control.ScaleLine();
    var permalink = new OpenLayers.Control.Permalink();
    
    map.addControls([layerSwitcher, panZoomBar, mousePosition, overviewMap,
        graticule, scale, scaleline, permalink]);
    
    map.setCenter(new OpenLayers.LonLat(0, 0), 2);
</pre></div></li><li class="listitem">Finally, add the code to add or remove the controls depending on the state of its corresponding buttons:<div class="informalexample"><pre class="programlisting">    function layerSwitcherChanged(checked) {
        if(checked) {
            layerSwitcher = new OpenLayers.Control.LayerSwitcher({'ascending':false});
            map.addControl(layerSwitcher);
        } else {
            map.removeControl(layerSwitcher);
            layerSwitcher.destroy();
        }
    }
    function panZoomBarChanged(checked) {
        if(checked) {
            panZoomBar = new OpenLayers.Control.PanZoomBar();
            map.addControl(panZoomBar);
        } else {
            map.removeControl(panZoomBar);
            panZoomBar.destroy();
        }
    }
    function mousePositionChanged(checked) {
        if(checked) {
            mousePosition = new OpenLayers.Control.MousePosition();
            map.addControl(mousePosition);
        } else {
            map.removeControl(mousePosition);
            mousePosition.destroy();
        }
    }
</pre></div></li><li class="listitem">Each function receives a<code class="literal"> checked</code> parameter that indicates if the button is pressed or not. Depending on its value, we simply add or remove the control from the map:<div class="informalexample"><pre class="programlisting">function overviewMapChanged(checked) {
        if(checked) {
            overviewMap = new OpenLayers.Control.OverviewMap({maximized: true});
            map.addControl(overviewMap);
        } else {
            map.removeControl(overviewMap);
            overviewMap.destroy();
        }
    }
    function graticuleChanged(checked) {
        if(checked) {
            graticule = new OpenLayers.Control.Graticule({displayInLayerSwitcher: false});
            map.addControl(graticule);
        } else {
            map.removeControl(graticule);
            graticule.destroy();
        }
    }
    function scaleChanged(checked) {
        if(checked) {
            scale = new OpenLayers.Control.Scale();
            map.addControl(scale);
        } else {
            map.removeControl(scale);
            scale.destroy();
        }
    }
    function scaleLineChanged(checked) {
        if(checked) {
            scaleline = new OpenLayers.Control.ScaleLine();
            map.addControl(scaleline);
        } else {
            map.removeControl(scaleline);
            scaleline.destroy();
        }
    }
    function permalinkChanged(checked) {
        if(checked) {
            permalink = new OpenLayers.Control.Permalink();
            map.addControl(permalink);
        } else {
            map.removeControl(permalink);
            permalink.destroy();
        } 
    }
&lt;/script&gt;
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec02"/>How it works...</h3></div></div></div><p>The first thing we have done is to create the map instance, forcing it to have no controls attached to it. This is done by setting the<code class="literal"> controls</code> property to an empty array:<a class="indexterm" id="id195"/>
</p><div class="informalexample"><pre class="programlisting">    // Create map
    var map = new OpenLayers.Map("ch05_visual_controls", {
        controls: []
    }); 
</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title">Note</h3><p>
When we create an <code class="literal">OpenLayers.Map</code> instance without specifying the <code class="literal">controls</code> property, OpenLayers automatically adds the next set of default controls to it: Navigation, PanZoom, ArgParser, and Attribution.</p></div><p>Next, we have created the controls and added all of them to the map using the<code class="literal"> addControls</code> method:</p><div class="informalexample"><pre class="programlisting">    var layerSwitcher = new OpenLayers.Control.LayerSwitcher({'ascending':false});
    ...
    ...
    ...
    var permalink = new OpenLayers.Control.Permalink();
    
    map.addControls([layerSwitcher, panZoomBar, mousePosition, overviewMap, graticule, scale, scaleline, permalink]);
</pre></div><p>Before continuing, let's take a look at the properties used in some of the controls' instantiation.</p><p>On the layer switcher, we have set the property<code class="literal"> ascending</code> to<code class="literal"> false</code>. This means the layers will be sorted in descending order, that is they will be added to the map in the reverse order:</p><div class="informalexample"><pre class="programlisting">    var layerSwitcher = new OpenLayers.Control.LayerSwitcher({'ascending':false});
</pre></div><p>On the OverviewMap control, the<code class="literal"> maximized</code> property allows us to expand the control created:</p><div class="informalexample"><pre class="programlisting">    var overviewMap = new OpenLayers.Control.OverviewMap({maximized: true});
</pre></div><p>Finally, for the Graticule control, the<code class="literal"> displayInLayerSwitcher</code> property allows to switch it on or off in the LayerSwitcher control:</p><div class="informalexample"><pre class="programlisting">    var graticule = new OpenLayers.Control.Graticule({ displayInLayerSwitcher: false});
</pre></div><p>Thanks to the Dojo Toolkit, the buttons we have created have the behavior of a toggle button. Each button has a function associated with it that is executed every time the button state changes from checked to unchecked. In the case of the overview map button, the associated function is<code class="literal"> overviewMapChanged</code> that is specified in the<code class="literal"> onChange</code> event within the<code class="literal"> data-dojo-props</code> attribute:<a class="indexterm" id="id196"/>
</p><div class="informalexample"><pre class="programlisting">&lt;button data-dojo-type="dijit.form.ToggleButton" data-dojo-props="iconClass:'dijitCheckBoxIcon', checked: true, onChange: overviewMapChanged"&gt;OverviewMap&lt;/button&gt;
</pre></div><p>The function that acts as the listener for the<code class="literal"> onChange</code> event receives a boolean parameter, indicating if the button is checked or unchecked.</p><p>All the listener functions are similar. Depending on the value of the checked parameter, it removes (and destroys) the control from the map or creates a new one:</p><div class="informalexample"><pre class="programlisting">    function overviewMapChanged(checked) {
        if(checked) {
            overviewMap = new OpenLayers.Control.OverviewMap({maximized: true});
            map.addControl(overviewMap);
        } else {
            map.removeControl(overviewMap);
            overviewMap.destroy();
        }
    }
</pre></div><p>In the same way as layers, removing a control from the map instance with the<code class="literal"> removeControl()</code> method does not free the possible resources used by the control. We need to explicitly do it with the<code class="literal"> destroy()</code> method.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec03"/>See also</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Placing controls outside the map</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Understanding how themes work using img folder</em></span> recipe (theming the PanZoomBar control) in<a class="link" href="ch06.html" title="Chapter 6. Theming"> Chapter 6</a>, <span class="emphasis"><em> Theming</em></span></li></ul></div></div></div></div>
<div class="section" title="Adding a navigation history control"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec03"/>Adding a navigation history control</h1></div></div></div><p>Probably the most commonly used control in our mapping applications will be the Navigation control.<code class="literal"> OpenLayers.Control.Navigation</code> control integrates (makes use of) some other controls, such as<code class="literal"> OpenLayers.Control.DragPan, OpenLayers.Control.ZoomBox</code>, or a wheel handler, which allows us to pan and zoom the map.<a class="indexterm" id="id197"/>
</p><p>While navigating, moving, or zooming, it can be interesting to store a history of the navigation actions made by the user, so he/she can go back or forward to previous places. Fortunately, we don't need to reinvent the wheel. OpenLayers offers us the<code class="literal"> OpenLayers.Control.NavigationHistory</code> control.</p><p>This recipe shows how easy it is to add it to our applications and benefit from its features.</p><div class="mediaobject"><img alt="Adding a navigation history control" src="graphics/7843_05_02.jpg"/></div><p>As you can see in the screenshot, we are going to add a button above the map that will enable or disable the Navigation component.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec04"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create an HTML file with the required OpenLayers dependencies. Add the code for the toggle button that will enable/disable the navigation control:<a class="indexterm" id="id198"/><div class="informalexample"><pre class="programlisting">&lt;button data-dojo-type="dijit.form.ToggleButton" data-dojo-props="iconClass:'dijitCheckBoxIcon', checked: true, onChange: navigationChanged"&gt;Navigation&lt;/button&gt;
</pre></div></li><li class="listitem">Next, add a<code class="literal"> div</code> element to hold the map:<div class="informalexample"><pre class="programlisting">&lt;div id="ch05_nav_history" style="width: 100%; height: 90%;"&gt;&lt;/div&gt;
</pre></div></li><li class="listitem">Now, create the map instance and add a base layer:<div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript"&gt;
    // Create map
    var map = new OpenLayers.Map("ch05_nav_history", {
        controls: []
    });    
    var osm = new OpenLayers.Layer.OSM();        
    map.addLayer(osm);
</pre></div></li><li class="listitem">Add the Navigation and NavigationHistory controls:<a class="indexterm" id="id199"/><div class="informalexample"><pre class="programlisting">    // Add controls
    var navigation = new OpenLayers.Control.Navigation();
    var history = new OpenLayers.Control.NavigationHistory();
    var panel = new OpenLayers.Control.Panel();
    panel.addControls([history.next, history.previous]);
    
    map.addControls([navigation, history, panel]);
    map.setCenter(new OpenLayers.LonLat(0, 0), 4);
</pre></div></li><li class="listitem">Implement the function responsible to enable/disable the navigation control:<div class="informalexample"><pre class="programlisting">    function navigationChanged(checked) {
        if(checked) {
            navigation.activate();
        } else {
            navigation.deactivate();
        }
    }
&lt;/script&gt;
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec05"/>How it works...</h3></div></div></div><p>First let's talk about the navigation control. Using it is not a mystery. Simply create a control instance and add it to the map:<a class="indexterm" id="id200"/>
</p><div class="informalexample"><pre class="programlisting">    var navigation = new OpenLayers.Control.Navigation();
    ....
    ....
    map.addControls([navigation, ...]);
</pre></div><p>The button created at the beginning makes use of the Dojo Toolkit, which allows us to easily convert it to a toggle button. In addition, we have added a listener function to check when the button's state changes between checked and unchecked. The<code class="literal"> navigationChanged</code> function activates or deactivates the control depending on the<code class="literal"> checked</code> value:<a class="indexterm" id="id201"/>
</p><div class="informalexample"><pre class="programlisting">    function navigationChanged(checked) {
        if(checked) {
            navigation.activate();
        } else {
            navigation.deactivate();
        }
    }
</pre></div><p>Each control has an<code class="literal"> activate()</code> and<code class="literal"> deactivate()</code> method. They are defined in the base class,<code class="literal"> OpenLayers.Control</code>, and all concrete controls inherit or override these methods.</p><p>The use of<code class="literal"> activate</code> and<code class="literal"> deactivate</code> is preferred over removing and adding the control from/to the map. This way, there is no need to either create or attach instances of the control. The control is simply in standby until we activate it again.</p><p>That is all related to the navigation control, let's take a look at how to add the navigation history control, because this is just a two-step process.</p><p>The<code class="literal"> OpenLayers.Control.NavigationHistory</code> control is a bit more special. It contains stacks to store the previous and next visited places and, among others, also contains references to two buttons (instances of the<code class="literal"> OpenLayers.Control.Button</code> control class), which allows us to go back and forward in the navigation history. The references to these buttons can be found in the<code class="literal"> previous</code> and<code class="literal"> next</code> properties.</p><p>By default, after adding a NavigationHistory control to the map, no button appears. It is our responsibility to show the previous and next buttons on the map. For this, and other similar purposes, OpenLayers offers us the<code class="literal"> OpenLayers.Control.Panel</code> control class. It is a special kind of control that can contain or group together other controls. So, with all this in mind, we can now explain the way the Navigation History control is added to the map.</p><p>First we need to create the<code class="literal"> OpenLayers.Control.NavigationHistory</code> instance and add it to the map. Second, we need to add a panel to show the two buttons and add the two buttons:</p><div class="informalexample"><pre class="programlisting">    var history = new OpenLayers.Control.NavigationHistory();
    var panel = new OpenLayers.Control.Panel();
    panel.addControls([history.next, history.previous]);
</pre></div><p>Finally, the panel itself must be added to the map as a new control:</p><div class="informalexample"><pre class="programlisting">    map.addControls([navigation, history, panel]);
</pre></div><p>As you can see, we have added the navigation, the navigation history, and the panel with the buttons as map controls, simply because all three are controls.</p><p>In<a class="link" href="ch06.html" title="Chapter 6. Theming"> Chapter 6</a>,<span class="emphasis"><em> Theming</em></span>, we will see how we can change the icons used by this control.<a class="indexterm" id="id202"/>
</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec06"/>See also</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Adding and removing controls</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Placing controls outside the map</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Understanding how themes work using the theme folder</em></span> recipe in<a class="link" href="ch06.html" title="Chapter 6. Theming"> Chapter 6</a>, <span class="emphasis"><em> Theming</em></span></li></ul></div></div></div></div>
<div class="section" title="Working with geolocation"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec04"/>Working with geolocation</h1></div></div></div><p>With the arrival of<span class="strong"><strong> HTML5</strong></span>, one of the many new APIs and concepts introduced in the specification is the possibility to identify the location of the client that is loading the web page, through the<span class="strong"><strong> Geolocation API</strong></span> (<a class="ulink" href="http://dev.w3.org/geo/api/spec-source.html">http://dev.w3.org/geo/api/spec-source.html</a>). Of course, in the world of web mapping applications, this opens new and great possibilities.<a class="indexterm" id="id203"/>
</p><p>In this recipe, we are going to show how easily we can identify the current location of the user and center the map's viewport to it:</p><div class="mediaobject"><img alt="Working with geolocation" src="graphics/7843_05_03.jpg"/></div><p>Every time the user clicks on the<span class="strong"><strong> Geolocation</strong></span> button, the map's viewport will be moved to the current user's location and a marker will be placed on it. Also, when the mouse goes over the marker, a popup with the current location will be shown.<a class="indexterm" id="id204"/>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec07"/>Getting ready</h2></div></div></div><p>As we mentioned at the beginning of the recipe, Geolocation is a feature that the browser must implement, so we need an HTML5 compliant browser to make this control work.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec08"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First create the HTML file with OpenLayers dependencies, then add the HTML code for the button and map element:<a class="indexterm" id="id205"/><div class="informalexample"><pre class="programlisting">&lt;button data-dojo-type="dijit.form.Button" data-dojo-props="onClick: geolocationClick"&gt;Geolocation&lt;/button&gt;
&lt;div id="ch05_geolocating" style="width: 100%; height: 90%;"&gt;&lt;/div&gt;
</pre></div></li><li class="listitem">Then, initialize the map instance and add a base layer:<div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript"&gt;
    // Create map
    var map = new OpenLayers.Map("ch05_geolocating");    
    var osm = new OpenLayers.Layer.OSM();        
    map.addLayer(osm);
</pre></div></li><li class="listitem">Now, add the<code class="literal"> OpenLayers.Control.Geolocate</code> control to the map:<div class="informalexample"><pre class="programlisting">    // Add controls
    var geolocate = new OpenLayers.Control.Geolocate({
        eventListeners: {
            "locationupdated": locateMarker,
            "locationfailed": function() {
                console.log('Location detection failed');
            }
        }
    });
    map.addControl(geolocate);
</pre></div></li><li class="listitem">Create and add to the map, the marker layer, where the marker will be placed:<a class="indexterm" id="id206"/><div class="informalexample"><pre class="programlisting">    var markers = new OpenLayers.Layer.Markers("Markers");
    map.addLayer(markers);
</pre></div></li><li class="listitem">Set an initial place for the view:<div class="informalexample"><pre class="programlisting">    map.setCenter(new OpenLayers.LonLat(0, 0), 6);
</pre></div></li><li class="listitem">Implement the listener function associated to the<span class="strong"><strong> Geolocation</strong></span> button:<div class="informalexample"><pre class="programlisting">    function geolocationClick() {
        geolocate.deactivate();
        geolocate.activate();
    }
</pre></div></li><li class="listitem">Finally, implement the function that is executed each time the location of the client is detected. The purpose of this function is to add a marker to the map at the current client's location, and show a popup with the coordinates when the mouse goes over the marker:<div class="informalexample"><pre class="programlisting">    function locateMarker(event) {
</pre></div></li><li class="listitem">Start by removing any previous markers:<div class="informalexample"><pre class="programlisting">        // Remove any existing marker
        markers.clearMarkers();
</pre></div></li><li class="listitem">Then, create the icon to be used by the marker:<div class="informalexample"><pre class="programlisting">        var size = new OpenLayers.Size(32, 37);
        var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
        var icon = new OpenLayers.Icon('./recipes/data/icons/symbol_blank.png', size, offset);
        icon.setOpacity(0.7);
        
        // Create a lonlat instance from the event location.
        // NOTE: The coordinates are transformed to the map's projection by
        // the geolocate control.
        var lonlat = new OpenLayers.LonLat(event.point.x, event.point.y);
        
        // Add the marker
        var popup = null;
        var marker = new OpenLayers.Marker(lonlat, icon);
</pre></div></li><li class="listitem">Then, register a listener for the mouseover event that will show the popup:<a class="indexterm" id="id207"/><div class="informalexample"><pre class="programlisting">        marker.events.on({
            "mouseover": function() {
                if(popup) {
                    map.removePopup(popup);
                }
                
                var content = "&lt;strong&gt;Longitude:&lt;/strong&gt; " + lonlat.lon + "&lt;br/&gt;" + "&lt;strong&gt;Latitude:&lt;/strong&gt; " + lonlat.lat;
            
                popup = new OpenLayers.Popup.FramedCloud(
                "popup", lonlat, new OpenLayers.Size(250, 100), content,
                null, true, null);
                
                map.addPopup(popup);
            }
        });
        
        markers.addMarker(marker);
    }
&lt;/script&gt;
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec09"/>How it works...</h3></div></div></div><p>The first step is to create the<code class="literal"> OpenLayers.Control.Geolocate</code> control instance and add it to the map:<a class="indexterm" id="id208"/>
</p><div class="informalexample"><pre class="programlisting">    var geolocate = new OpenLayers.Control.Geolocate({
        eventListeners: {
            "locationupdated": locateMarker,
            "locationfailed": function() {
                console.log('Location detection failed');
            }
        }
    });
</pre></div><p>The control can trigger three events:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">locationupdated:</code> This event is fired when the browser returns a new position</li><li class="listitem" style="list-style-type: disc"><code class="literal">locationfailed:</code> This event is fired if the geolocation fails</li><li class="listitem" style="list-style-type: disc"><code class="literal">locationuncapable:</code> This event is fired if you activate the control in a browser that does not support geolocation.</li></ul></div><p>In this recipe, we attached an event listener function for the events<code class="literal"> locationupdated</code> and<code class="literal"> locationfailed</code>.<a class="indexterm" id="id209"/>
</p><p>To use the Geolocate control, we need to invoke its<code class="literal"> activate()</code> method. Then, OpenLayers will request the browser to get the current user's location and the browser will ask if we want to share our location. If we accept, then a<code class="literal"> locationupdated</code> event will be triggered with the current location as an argument.</p><p>In the recipe, the<code class="literal"> geolocationClick</code> function is called when the button is clicked and forces the activation of the control:</p><div class="informalexample"><pre class="programlisting">    function geolocationClick() {
        geolocate.deactivate();
        geolocate.activate();
    }
</pre></div><p>Then, when the<code class="literal"> locationupdated</code> event is triggered, the<code class="literal"> locateMarker</code> function is executed, passing an<code class="literal"> event</code> parameter with all the related event information, including the client coordinates:<a class="indexterm" id="id210"/>
</p><div class="informalexample"><pre class="programlisting">    function locateMarker(event) {...}
</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title">Note</h3><p>
The coordinates stored at <code class="literal"> event.point</code> are transformed by the <span class="strong"><strong>Geolocate</strong></span> control, to be in the same coordinate system as the map.</p></div><p>The purpose of this function is to add a marker to the map at the current client's location and show a popup with the coordinates when the mouse goes over the marker.<a class="indexterm" id="id211"/>
</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec10"/>There's more...</h3></div></div></div><p>The<code class="literal"> OpenLayers.Control.Geolocate</code> control has a couple of interesting properties.</p><p>First the<code class="literal"> bind</code> property, by default set to<code class="literal"> true</code>, allows us to specify if the map's center must be updated to the location detected by the control.</p><p>The<code class="literal"> watch</code> property, by default set to<code class="literal"> false</code>, allows updating the position regularly.</p><p>In addition, we can pass to the control a<code class="literal"> geolocationOptions</code> object, defined in the specification (see<a class="ulink" href="http://dev.w3.org/geo/api/spec-source.html#position_options_interface)"> http://dev.w3.org/geo/api/spec-source.html#position_options_interface)</a> for better configuration of the control.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec11"/>See also</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Adding and removing controls</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Modifying features</em></span> recipe</li></ul></div></div></div></div>
<div class="section" title="Placing controls outside the map"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec05"/>Placing controls outside the map</h1></div></div></div><p>By default, all the controls are placed on the map. This way, controls such as the PanPanel, EditingToolbar, or MousePosition are rendered on top of the map and over any layer. This is the default behavior, but OpenLayers is flexible enough to allow us to put controls outside the map:<a class="indexterm" id="id212"/>
</p><div class="mediaobject"><img alt="Placing controls outside the map" src="graphics/7843_05_04.jpg"/></div><p>In this recipe we are going to create a map where the navigation toolbar and the mouse position controls are placed outside and above the map.<a class="indexterm" id="id213"/>
</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec12"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create an HTML file and add the OpenLayers dependencies. Add the following CSS code required to redefine some aspects of the controls we are going to use:<div class="informalexample"><pre class="programlisting">&lt;style&gt;
    .olControlNavToolbar {
        top: 0px;
        left: 0px;
        float: left;
    }
    .olControlNavToolbar div {
        float: left;
    }
&lt;/style&gt;
</pre></div></li><li class="listitem">Now, add the HTML code to place the two controls above the map:<div class="informalexample"><pre class="programlisting">&lt;table&gt;
    &lt;tr&gt;
        &lt;td&gt;
            Navigation: &lt;div id="navigation" class="olControlNavToolbar"&gt;&lt;/div&gt;
        &lt;/td&gt;
        &lt;td&gt;
            Position: &lt;div id="mouseposition" style="font-size: smaller;"&gt;&lt;/div&gt;
        &lt;/td&gt;
    &lt;/tr&gt;
&lt;/table&gt;

&lt;div id="ch05_control_outside" style="width: 100%; height: 90%;"&gt;&lt;/div&gt;
</pre></div></li><li class="listitem">Create the map instance and add a base layer:<div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript"&gt;
    // Create map
    var map = new OpenLayers.Map("ch05_control_outside");    
    var osm = new OpenLayers.Layer.OSM();        
    map.addLayer(osm);
    map.setCenter(new OpenLayers.LonLat(0, 0), 3);
</pre></div></li><li class="listitem">Now, add the mouse position and navigation toolbar controls:<a class="indexterm" id="id214"/><div class="informalexample"><pre class="programlisting">    var mousePosition = new OpenLayers.Control.MousePosition({
        div: document.getElementById('mouseposition') 
    });
    map.addControl(mousePosition);

    var navToolbarControl = new OpenLayers.Control.NavToolbar({
        div: document.getElementById("navigation")
    });
    map.addControl(navToolbarControl);
&lt;/script&gt;
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec13"/>How it works...</h3></div></div></div><p>The previous code seems pretty simple. We have added two controls to our map: an<code class="literal"> OpenLayers.Control.MousePosition</code> control, which shows the current coordinates of the mouse on the map, and<code class="literal"> OpenLayers.Control.NavToolbar</code>.</p><p>The<code class="literal"> OpenLayers.Control.NavToolbar</code> control is nothing more than a panel control that contains other controls: an<code class="literal"> OpenLayers.Control.Navigation</code> control, the hand icon (to move the map), and an<code class="literal"> OpenLayers.Control.ZoomBox</code> control, the magnifying glass icon (to zoom on a given box).<a class="indexterm" id="id215"/>
</p><p>So, where is the secret in the recipe for placing the controls outside the map? The answer is in the construction of each control.</p><p>The base class<code class="literal"> OpenLayers.Control</code> has a<code class="literal"> div</code> property that points to the<code class="literal"> div</code> element that will be used to hold the control. By default, no<code class="literal"> div</code> element is specified in the constructor, so the control creates a new one to be used.</p><p>If you specify a<code class="literal"> div</code> element in the control instantiation, then it is used as the place where the control will be rendered.<a class="indexterm" id="id216"/>
</p><p>For the MousePosition control, we have used the following code:</p><div class="informalexample"><pre class="programlisting">Position: &lt;div id="mouseposition" style="font-size: smaller;"&gt;&lt;/div&gt;
...
var mousePosition = new OpenLayers.Control.MousePosition({
    div: document.getElementById('mouseposition') 
});
</pre></div><p>This means we are placing the control on the previously created<code class="literal"> div</code> element, identified by the<code class="literal"> mouseposition</code> string.</p><p>For the navigation toolbar, it differs a bit:</p><div class="informalexample"><pre class="programlisting">Navigation: &lt;div id="navigation" class="olControlNavToolbar"&gt;&lt;/div&gt;
...
var navToolbarControl = new OpenLayers.Control.NavToolbar({
    div: document.getElementById("navigation")
});
</pre></div><p>In this case we have set the CSS class<code class="literal"> olControlNavToolbar</code>, defined by OpenLayers. Why?</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note47"/>Note</h3><p>When we do not specify the<code class="literal"> div</code> property, the control creates one and applies some default CSS classes that set the control icon, borders, background color, and so on. Remove the<code class="literal"> div</code> property from the navigation toolbar and see the results. A<code class="literal"> div</code> element will be created and placed on the map with some classes, such as<code class="literal"> olControlNavToolbar</code>, attached to it and will contain some other elements representing the buttons for the pan and zoom actions.</p></div><p>When we specify the<code class="literal"> div</code> property to be used, no style is automatically created and, because of this, controls can disappear or not be rendered nicely if we do not specify some CSS.</p><p>Once this is clear, we can say we have not used the CSS class with the mouse position control because it only contains some text. Well, we have only set the font size.</p><p>The navigation control is a more complex control, it contains two other controls and we need to tune up its style a bit.<a class="indexterm" id="id217"/>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title">Note</h3><p>
As we will see in <a class="link" href="ch06.html" title="Chapter 6. Theming">Chapter 6</a>, <span class="emphasis"><em>Theming</em></span>, most of the OpenLayers flexibility when working with controls is due to the use of the CSS classes. All the controls have, by default, a CSS class associated that defines its position, icons, color, and so on.</p></div><p>In the CSS code that we have set at the beginning of the recipe, we are redefining the place of the navigation toolbar within the<code class="literal"> div</code> and indicating that we want the contained elements, buttons, and flows in the<code class="literal"> left</code> direction:</p><div class="informalexample"><pre class="programlisting">&lt;style&gt;
    .olControlNavToolbar {
        top: 0px;
        left: 0px;
        float: left;
    }
    .olControlNavToolbar div {
        float: left;
    }
&lt;/style&gt;
</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec14"/>See also</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="link" href="ch06.html" title="Chapter 6. Theming">Chapter 6</a>, <span class="emphasis"><em> Theming</em></span></li></ul></div></div></div></div>
<div class="section" title="Editing features on multiple vector layers"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec06"/>Editing features on multiple vector layers</h1></div></div></div><p>When working with vector information, most probably, one of the most common things we can do in a GIS application is: add new features.<a class="indexterm" id="id218"/>
</p><p>OpenLayers has plenty of controls, so there is no need to reinvent the wheel. We have a set of tools and the only thing we need to do is learn how to use each one.</p><p>For this concrete purpose, add new features. OpenLayers has the<code class="literal"> OpenLayers.Control.EditingToolbar</code> control that shows a toolbar with some buttons to add polygons, polylines, and points:<a class="indexterm" id="id219"/>
</p><div class="mediaobject"><img alt="Editing features on multiple vector layers" src="graphics/7843_05_05.jpg"/></div><p>Because we can have many vector layers in the map, the control needs us to specify the layer it must work on.</p><p>In addition to showing how easy is to use the control, the goal of this recipe is to show how we can use the same control to add features to more than one layer.</p><p>This way, this little application will consist of a map with two vector layers. Thanks to the radio buttons, we will be able to chose the layer on which we want to create the new features.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec15"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, add the HTML code to create a couple of radio buttons that will allow us to select the vector layer on which we want to draw:<a class="indexterm" id="id220"/><div class="informalexample"><pre class="programlisting">&lt;form action=""&gt;
    Vector Layer A: &lt;input id="rbA" type="radio" dojoType="dijit.form.RadioButton" onChange="layerAChanged" name="layer" value="layerA" checked/&gt;
    Vector Layer B: &lt;input id="rbB" type="radio" dojoType="dijit.form.RadioButton" onChange="layerBChanged" name="layer" value="layerB"/&gt;
&lt;/form&gt;
&lt;div id="ch05_editing_vector" style="width: 100%; height: 100%;"&gt;&lt;/div&gt;
</pre></div></li><li class="listitem">Now, create a map instance and add a base layer:<a class="indexterm" id="id221"/><div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript"&gt;
    // Create map
    var map = new OpenLayers.Map("ch05_editing_vector");    
    var osm = new OpenLayers.Layer.OSM();        
    map.addLayer(osm);
    map.addControl(new OpenLayers.Control.LayerSwitcher());
    map.setCenter(new OpenLayers.LonLat(0, 0), 3);
</pre></div></li><li class="listitem">Add the two vector layers:<div class="informalexample"><pre class="programlisting">    var vectorLayerA = new OpenLayers.Layer.Vector("Vector layer A");
    var vectorLayerB = new OpenLayers.Layer.Vector("Vector layer B");
    map.addLayers([vectorLayerA, vectorLayerB]);
</pre></div></li><li class="listitem">Add the editing toolbar control, initially associated to the first vector layer:<div class="informalexample"><pre class="programlisting">    var editingToolbarControl = new OpenLayers.Control.EditingToolbar(vectorLayerA);
    map.addControl(editingToolbarControl);
</pre></div></li><li class="listitem">Finally, implement the code to handle the radio button changes. It will change the layer associated to the editing toolbar control:<div class="informalexample"><pre class="programlisting">    function layerAChanged(checked) {
        if(checked) {
            var controls = editingToolbarControl.getControlsByClass("OpenLayers.Control.DrawFeature");
            for(var i=0; i&lt; controls.length; i++) {
                controls[i].layer = vectorLayerA;
            }
        }
    }
    function layerBChanged(checked) {
        if(checked) {
            var controls = editingToolbarControl.getControlsByClass("OpenLayers.Control.DrawFeature");
            for(var i=0; i&lt; controls.length; i++) {
                controls[i].layer = vectorLayerB;
            }
        }
    }
&lt;/script&gt;
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec16"/>How it works...</h3></div></div></div><p>The use of the<code class="literal"> OpenLayers.Control.EditingToolbar</code> control has not much mystery. In the constructor, we need to indicate the vector layer we want to add the new features to.</p><p>The control will show some buttons on top of the map, allowing us to create new polygons, polylines, or points. Those new features will be added to the specified layer.</p><p>So, the secret to add features to other vector layers is about how to change the layer referenced by the control.</p><p>The<code class="literal"> OpenLayers.Control.EditingToolbar</code> control is nothing more than a panel that contains four controls. We encourage the reader to take a look at its<code class="literal"> initialize</code> method.<a class="indexterm" id="id222"/>
</p><p>The editor toolbar contains a navigation control, which is represented by the hand icon, and three instances of the<code class="literal"> OpenLayers.Control.DrawFeature</code> control.</p><p>The DrawFeature control is the essence of the editor toolbar control. Given a vector layer and a handler, the control allows drawing features on the layer.</p><p>As we mentioned at the beginning of this chapter, controls are closely related to handlers. Here, we can see how handlers are responsible for detecting the mouse events and translate it to the point, path, or polygon creation events. On the other side, the draw feature control listens for these events and creates the appropriate map features.</p><p>Let's summarize the key points:<a class="indexterm" id="id223"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The editor toolbar, as a panel, contains a list of controls: one Navigation control and three DrawFeature controls</li><li class="listitem" style="list-style-type: disc">In addition, the EditingToolbar control needs a reference to the vector layer to be edited</li><li class="listitem" style="list-style-type: disc">The vector layer reference is passed to the three DrawFeature controls, so they can add new features on the layer</li></ul></div><p>Now, we can see that by changing the layer reference in the draw feature controls, we change the layer where features are added. And this is exactly what the functions that listen for radio buttons' events do:<a class="indexterm" id="id224"/>
</p><div class="informalexample"><pre class="programlisting">    function layerAChanged(checked) {
        if(checked) {
            var controls = editingToolbarControl.getControlsByClass("OpenLayers.Control.DrawFeature");
            for(var i=0; i&lt; controls.length; i++) {
                controls[i].layer = vectorLayerA;
            }
        }
    }
</pre></div><p>As we can see in the code, from the editing toolbar we get all the draw feature controls with the call to the<code class="literal"> getControlsByClass</code> method, and then for each one we change the reference to the layer by changing the<code class="literal"> layer</code> property.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec17"/>There's more...</h3></div></div></div><p>If we look at the code of the<code class="literal"> initialize()</code> method of the<code class="literal"> OpenLayers.Control.EditingToolbar</code> class:</p><div class="informalexample"><pre class="programlisting">        var controls = [
          new OpenLayers.Control.DrawFeature(layer, OpenLayers.Handler.Point, {'displayClass': 'olControlDrawFeaturePoint'}),
          new OpenLayers.Control.DrawFeature(layer, OpenLayers.Handler.Path, {'displayClass': 'olControlDrawFeaturePath'}),
          new OpenLayers.Control.DrawFeature(layer, OpenLayers.Handler.Polygon, {'displayClass': 'olControlDrawFeaturePolygon'})
        ];
</pre></div><p>We can see it is passing a<code class="literal"> displayClass</code> property to the<code class="literal"> OpenLayers.Control.DrawFeature</code> controls.</p><p>This property is also common to all controls inherited from the<code class="literal"> OpenLayers.Control</code> class, and specifies the CSS class that must be applied to the<code class="literal"> div</code> element that will be used to draw the control.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec18"/>See also</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Placing controls outside the map</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Modifying features</em></span> recipe</li></ul></div></div></div></div>
<div class="section" title="Modifying features"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec07"/>Modifying features</h1></div></div></div><p>When working on the web mapping application, most probably, the capability to allow the users to add new features would be a desired requirement, but what about modifying features such as move vertex, rotate features, scale, and so on?<a class="indexterm" id="id225"/>
</p><p>Again, OpenLayers simplifies our lives as developers, giving us the powerful<code class="literal"> OpenLayers.Control.ModifyFeature</code> control:</p><div class="mediaobject"><img alt="Modifying features" src="graphics/7843_05_06.jpg"/></div><p>This time we are going to create a little application that will provide us with two important controls: first, to add new features and second, to modify them. For this purpose, we will use the<code class="literal"> OpenLayers.Control.EditingToolbar</code> and<code class="literal"> OpenLayers.Control.ModifyFeature</code> controls.</p><p>In concrete, we will see how we can reshape, resize, rotate, and drag features. In addition, we will see how to filter what kind of features can be affected by the modifications.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec19"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's start with creating the controls required for managing the control to modify a feature:<a class="indexterm" id="id226"/><div class="informalexample"><pre class="programlisting">&lt;form action=""&gt;
    &lt;button data-dojo-type="dijit.form.ToggleButton" data-dojo-props="iconClass:'dijitCheckBoxIcon', checked: false, onChange: modifyChanged"&gt;Modify&lt;/button&gt;
    Reshape: &lt;input id="reshape" dojoType="dijit.form.CheckBox"onChange="changeMode" name="layer"/&gt;
    Resize: &lt;input id="resize" dojoType="dijit.form.CheckBox" onChange="changeMode" name="layer"/&gt;
    Rotate &lt;input id="rotate" dojoType="dijit.form.CheckBox" onChange="changeMode" name="layer"/&gt;
    Drag: &lt;input id="drag" dojoType="dijit.form.CheckBox" onChange="changeMode" name="layer"/&gt;
    Filter: &lt;select dojoType="dijit.form.Select" id="filter" onChange="changeFilter" name="filter" style="width: 200px;"&gt;
        &lt;option value="ALL" selected&gt;No Filter&lt;/option&gt;
        &lt;option value="POINT"&gt;POINT&lt;/option&gt;
        &lt;option value="PATH"&gt;PATH&lt;/option&gt;
        &lt;option value="POLYGON"&gt;POLYGON&lt;/option&gt;
    &lt;/select&gt;
&lt;/form&gt;
</pre></div></li><li class="listitem">Add the element to hold the map:<div class="informalexample"><pre class="programlisting">&lt;div id="ch05_modify" style="width: 100%; height: 100%;"&gt;&lt;/div&gt;
</pre></div></li><li class="listitem">Start the JavaScript coding by initializing the map and adding a base layer:<div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript"&gt;
    // Create map
    var map = new OpenLayers.Map("ch05_modify");    
    var osm = new OpenLayers.Layer.OSM();        
    map.addLayer(osm);
    map.addControl(new OpenLayers.Control.LayerSwitcher());
    map.setCenter(new OpenLayers.LonLat(0, 0), 3);
</pre></div></li><li class="listitem">Now, add a vector layer to add and modify its features:<div class="informalexample"><pre class="programlisting">    var vectorLayer = new OpenLayers.Layer.Vector("Vector layer");
    map.addLayer(vectorLayer);
</pre></div></li><li class="listitem">Attach an editing toolbar control to the previous layer and add it to the map:<div class="informalexample"><pre class="programlisting">    var editingToolbarControl = new OpenLayers.Control.EditingToolbar(vectorLayer);
    map.addControl(editingToolbarControl);
</pre></div></li><li class="listitem">Similarly, attach a ModifyFeature control to the vector layer and add it to the map:<div class="informalexample"><pre class="programlisting">    var modifyControl = new OpenLayers.Control.ModifyFeature(vectorLayer);
    map.addControl(modifyControl);
</pre></div></li><li class="listitem">Add the listener functions that modify the behavior of the modify feature control. First add the function that activates or deactivates the control:<a class="indexterm" id="id227"/><div class="informalexample"><pre class="programlisting">    function modifyChanged(checked) {
        if(checked) {
            modifyControl.activate();
        } else {
            modifyControl.deactivate();
        }
    }
</pre></div></li><li class="listitem">Next, add the function that changes the way the modifications are made:<div class="informalexample"><pre class="programlisting">    function changeMode() {
        var reshape = dijit.byId("reshape").get("checked");
        var resize = dijit.byId("resize").get("checked");
        var rotate = dijit.byId("rotate").get("checked");
        var drag = dijit.byId("drag").get("checked");
       
        var mode = null;
        if(reshape) {
            mode |= OpenLayers.Control.ModifyFeature.RESHAPE;
        }
        if(resize) {
            mode |= OpenLayers.Control.ModifyFeature.RESIZE;
        }
        if(rotate) {
            mode |= OpenLayers.Control.ModifyFeature.ROTATE;
        }
        if(drag) {
            mode |= OpenLayers.Control.ModifyFeature.DRAG;
        }
        
        modifyControl.deactivate();
        modifyControl.mode = mode;
        modifyControl.activate();
    }
</pre></div></li><li class="listitem">Finally add the function to filter the type of geometries the control affects:<a class="indexterm" id="id228"/><div class="informalexample"><pre class="programlisting">    function changeFilter(value) {
        
        modifyControl.deactivate();
        map.removeControl(modifyControl);
        modifyControl.destroy();
        
        var geometryTypes = null;
        if(value=="POINT") {
            geometryTypes = ["OpenLayers.Geometry.Point"];
        } else if(value=="PATH") {
            geometryTypes = ["OpenLayers.Geometry.LineString"];
        } else if(value=="POLYGON") {
            geometryTypes = ["OpenLayers.Geometry.Polygon"];
        } 
        modifyControl = new OpenLayers.Control.ModifyFeature(vectorLayer, {
            geometryTypes: geometryTypes
        });
        map.addControl(modifyControl);
        modifyControl.activate();
    }
&lt;/script&gt;
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec20"/>How it works...</h3></div></div></div><p>The editing toolbar allows us to draw points, paths, and polygons. Once some features are added to the layer, we can click on the<span class="strong"><strong> Modify</strong></span> toggle button to activate or deactivate the modify feature control. This action is handled by the<code class="literal"> modifyChanged</code> function:<a class="indexterm" id="id229"/>
</p><div class="informalexample"><pre class="programlisting">    function modifyChanged(checked) {
        if(checked) {
            modifyControl.activate();
        } else {
            modifyControl.deactivate();
        }
    }
</pre></div><p>By default, the modify feature control allows to reshape any kind of feature, no matter whether it is a point, path, or polygon, that is we can move or add a new vertex to the feature.</p><p>With the checkboxes, we can modify the behavior of the control, for example, allowing resizing or dragging of the selected feature.</p><p>The function<code class="literal"> changeMode</code> listens for changes on any of the checkboxes and is responsible to modify the action that the control handles.</p><p>The action in question is specified through the<code class="literal"> mode</code> property of the control. We can set it at the time of instantiation, or later by modifying the property, as we are doing in this recipe.</p><p>In addition, the control allows to handle many actions at a time. We can specify all of them using the logical OR operator. For example:</p><div class="informalexample"><pre class="programlisting">mode = OpenLayers.Control.ModifyFeature.RESHAPE | OpenLayers.Control.ModifyFeature.RESIZE;
</pre></div><p>As you can see, we force the deactivation and later the activation of the control so that the new<code class="literal"> mode</code> value takes effect.</p><p>Finally, we can control one more thing of the control's behavior and that is, the kind of features we can modify. Using the select box, we can choose the kind of geometries that can be modified by the control. The function<code class="literal"> changeFilter</code> is listening for changes on the select box and changes the configuration of the modify feature control.</p><p>This geometry filter is done by using the<code class="literal"> geometryType</code> property of the control.</p><p>Unfortunately, this property can only be set at instantiation time, changes made later have no effect. So, we need to remove the control from the map and create a new one with the desired geometries to be filtered.<a class="indexterm" id="id230"/>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note48"/>Note</h3><p>Removing a control from the map does not free the possible resources used by the control. We need to destroy it to free the resources.</p></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec21"/>There's more...</h3></div></div></div><p>After reading this recipe, we know how to modify the features. But, what if we want to listen for events while features are being modified? How to know when a modification is going to be made?</p><p>The answer is simple, we need to listen for events in the vector layer we are modifying.</p><p>Registering for events, such as<code class="literal"> beforefeaturemodified, featureselected</code>, or<code class="literal"> vertexremoved</code> allows us to know what exactly is happening and react according to our requirements.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec22"/>See also</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Editing features on multiple vector layers</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Adding and removing controls</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Listening for vector layer features' event</em></span> recipe in<a class="link" href="ch04.html" title="Chapter 4. Working with Events"> Chapter 4</a>, <span class="emphasis"><em> Controls</em></span></li></ul></div></div></div></div>
<div class="section" title="Measuring distances and areas"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec08"/>Measuring distances and areas</h1></div></div></div><p>The capability to measure distances or areas is an important thing on many GIS applications.<a class="indexterm" id="id231"/>
</p><p>In this recipe, we are going to see in action what the Measure control in OpenLayers offers to the developer.</p><p>The application will show a simple map with some buttons on top, as shown in the following screenshot. The<span class="strong"><strong> Measure</strong></span> toggle button activates or deactivates the control, while the radio buttons bring us the possibility to select what to measure: a path or an area:</p><div class="mediaobject"><img alt="Measuring distances and areas" src="graphics/7843_05_07.jpg"/></div><p>In addition, we can set two control options. The<span class="strong"><strong> Geodesic</strong></span> control indicates if the distance of the area computation must be in geodesic metrics instead of planar. The<span class="strong"><strong> Immediate</strong></span> option is useful to update the measure every time we move the mouse.<a class="indexterm" id="id232"/>
</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec23"/>How to do it...</h2></div></div></div><p>Here, we are going to write not the whole source code but only those pieces of code that are important for the recipe. So, we are avoiding putting here the HTML code required to build the measure button, checkboxes, options radio buttons, and the<code class="literal"> div</code> element that holds the map instance.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's take a look at the JavaScript code. First, instantiate the map, add a base layer, and center the map display:<div class="informalexample"><pre class="programlisting">    var map = new OpenLayers.Map("ch05_measure");    
    var osm = new OpenLayers.Layer.OSM();        
    map.addLayer(osm);
    map.addControl(new OpenLayers.Control.LayerSwitcher());
    map.setCenter(new OpenLayers.LonLat(0, 0), 3);
</pre></div></li><li class="listitem">Now, add the Measure control. Note that we are registering two listener functions for the events<code class="literal"> measure</code> and<code class="literal"> measurepartial:</code><div class="informalexample"><pre class="programlisting">    var measureControl = new OpenLayers.Control.Measure(OpenLayers.Handler.Path, {
        persist: true,
        eventListeners: {
            'measure': measure,
            'measurepartial': measurepartial
        }
    });
</pre></div></li><li class="listitem">Next, place the code for the<span class="strong"><strong> Measure</strong></span> toggle button that activates or deactivates the control:<a class="indexterm" id="id233"/><div class="informalexample"><pre class="programlisting">    function measureClick(checked) {
        var path = dijit.byId('path').get('checked');
        var polygon = dijit.byId('polygon').get('checked');
        var regular = dijit.byId('regular').get('checked');
        
        if(checked){
            if(path) {
                measureControl.updateHandler(OpenLayers.Handler.Path, {persist: true});
            } else if(polygon) {
                measureControl.updateHandler(OpenLayers.Handler.Polygon, {persist: true});
            } else if(regular) {
                measureControl.updateHandler(OpenLayers.Handler.RegularPolygon, {persist: true});
            }
            map.addControl(measureControl);
            measureControl.activate();
        } else {
            measureControl.deactivate();
            map.removeControl(measureControl);
        }
        
        dojo.byId('value').innerHTML = "";
    }
</pre></div></li><li class="listitem">Implement the listener functions for the<code class="literal"> measure</code> and<code class="literal"> measurepartial</code> control events:<div class="informalexample"><pre class="programlisting">    function measure(event) {
        var message = event.measure + " " + event.units;
        if(event.order&gt;1) {
            message += "2";
        }
        dojo.byId('value').innerHTML = message;
    }
    
    function measurepartial(event) {
        var message = event.measure + " " + event.units;
        dojo.byId('value').innerHTML = message;
    }
</pre></div></li><li class="listitem">Finally, place the code for the functions that change the<span class="strong"><strong> Geodesic</strong></span> and<span class="strong"><strong> Immediate</strong></span> options:<a class="indexterm" id="id234"/><div class="informalexample"><pre class="programlisting">    function changeImmediate(checked) {
        measureControl.setImmediate(checked);
    }
    function changeGeodesic(checked) {
        measureControl.geodesic = checked;
    }
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec24"/>How it works...</h3></div></div></div><p>Let's start analyzing how we initialized the measure control:<a class="indexterm" id="id235"/>
</p><div class="informalexample"><pre class="programlisting">    var measureControl = new OpenLayers.Control.Measure(OpenLayers.Handler.Path, {
        persist: true,
        eventListeners: {
            'measure': measure,
            'measurepartial': measurepartial
        }
    });
</pre></div><p>The only parameter we need to pass to the control is a handler to be used.</p><p>Like many other controls, the<code class="literal"> OpenLayers.Control.Measure</code> class makes use of handlers to interact with the map. In this case, the measure control can make use of any handler that allows to draw geometries. To summarize, the flow is as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The control is activated and it delegates to a handler the task of drawing some geometry in the map</li><li class="listitem" style="list-style-type: disc">Once the handler has drawn the desired geometry, (such as a path or a polygon) the feature is returned to the control</li><li class="listitem" style="list-style-type: disc">The control computes the distance or area of the geometry and triggers an event<a class="indexterm" id="id236"/></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note49"/>Note</h3><p>Actually, we have a limitation to use handlers that return geometries that implement the<code class="literal"> getArea()</code> or<code class="literal"> getLength()</code> methods. For example, if you try to use the<code class="literal"> OpenLayers.Handler.Box</code> handler with the measure control, once you activate the control and draw a box, you will get an error in the browser console. This is because the box handler returns an<code class="literal"> OpenLayers.Bounds</code> instance that neither has a<code class="literal"> getLength</code> nor<code class="literal"> getArea</code> method.</p></div><p>In our code we have initialized the measure control setting as follows:<a class="indexterm" id="id237"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<code class="literal"> persist</code> property to<code class="literal"> true</code>. This property indicates that the geometry created by the handler must remain on the map until a new measure starts.</li><li class="listitem" style="list-style-type: disc">Two event listeners, for the events<code class="literal"> measure</code> and<code class="literal"> measurepartial</code>. The<code class="literal"> measure</code> event is triggered once the measure action has been finished. The<code class="literal"> measurepartial</code> is triggered on any measure update (only if the<code class="literal"> immediate</code> property is true).</li></ul></div><p>When the<span class="strong"><strong> Measure</strong></span> toggle button is pressed, the<code class="literal"> measureClick</code> function is executed. This function checks what kind of handler must be used for the measurement and sets it on the control.</p><p>This can be done by the<code class="literal"> updateHandler</code> method on the Measure control. For example:</p><div class="informalexample"><pre class="programlisting">measureControl.updateHandler(OpenLayers.Handler.Polygon, {persist: true});
</pre></div><p>In addition, the<code class="literal"> measureClick</code> function adds the control to the map and activates when the button is toggled on, or deactivates and removes the control from the map when the button is toggled off.</p><p>For the control options buttons, we have set two listening functions associated to the checkboxes.</p><p>When the<span class="strong"><strong> Immediate</strong></span> checkbox changes, the<code class="literal"> changeImmediate</code> function is executed. This, using the<code class="literal"> setImmediate</code> method, changes the<code class="literal"> immediate</code> property of the control, which allows triggering events every time the measure updates with a mouse movement:</p><div class="informalexample"><pre class="programlisting">    function changeImmediate(checked) {
        measureControl.setImmediate(checked);
    }
</pre></div><p>The<span class="strong"><strong> Geodesic</strong></span> checkbox sets the value of the<code class="literal"> geodesic</code> property. This time we can modify the property directly without the need of a setter function:<a class="indexterm" id="id238"/>
</p><div class="informalexample"><pre class="programlisting">    function changeGeodesic(checked) {
        measureControl.geodesic = checked;
    }
</pre></div><p>With the<code class="literal"> geodesic</code> property set to<code class="literal"> true</code>, the control will use a geodesic metric instead of a planar metric to compute the measures.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec25"/>There's more...</h3></div></div></div><p>An important part of the measurement is done with the geometric instances.</p><p>All the geometry classes, such as<code class="literal"> OpenLayers.Geometry.Polygon</code> or<code class="literal"> OpenLayers.Geometry.LineString</code>, contain methods to compute their area or length.</p><p>Looking at the measure control source code, we can see how once its associated handler returns a geometry, it simply calls the geometry methods to get the area or length and triggers an event.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec26"/>See also</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Working with geolocation</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Editing features on multiple vector layers</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Modifying features</em></span> recipe</li></ul></div></div></div></div>
<div class="section" title="Getting feature information from data source"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec09"/>Getting feature information from data source</h1></div></div></div><p>We work on web mapping applications almost every day. We know how to create a map and add raster and vector layers. More than that, we know how to get vector data from different data sources: GeoJSON file, KML file, or from a WFS server.<a class="indexterm" id="id239"/>
</p><p>At this point, and related to vector layers, one of the possible questions we could have is: how can we retrieve the feature's information? Fortunately, OpenLayers offers us some controls that can answer this question.</p><p>In this recipe, we are going to see in action the<code class="literal"> OpenLayers.Control.GetFeature</code> control class that has the ability to query the feature's data source.<a class="indexterm" id="id240"/>
</p><p>We are going to create a map with a base layer and two vector layers. One from a WFS server, with the USA, and the other from a GML file with Europe's countries.</p><p>On top of the map, a button allows us to activate/deactivate the<code class="literal"> GetFeature</code> control and two radio buttons allow us to select between the USA or Europe layers to be queried.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec27"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's start creating the HTML file with the OpenLayers dependencies. Then add the HTML code for the map and buttons:<div class="informalexample"><pre class="programlisting">&lt;button dojoType="dijit.form.ToggleButton" id="getfeatureButton" onChange="getFeatureClick" iconClass='dijitCheckBoxIcon' checked="false"&gt;Activated&lt;/button&gt;
Get Information from:
USA &lt;input id="usa" dojoType="dijit.form.RadioButton" onChange="changeHandler" checked name="layer"/&gt;
Europe &lt;input id="europe" dojoType="dijit.form.RadioButton" onChange="changeHandler" name="layer"/&gt;

&lt;div id="ch05_getfeature" style="width: 100%; height: 100%;"&gt;&lt;/div&gt;

</pre></div></li><li class="listitem">In the JavaScript section, set the proxy script to be used:<div class="informalexample"><pre class="programlisting">    OpenLayers.ProxyHost = "./utils/proxy.php?url=";
</pre></div></li><li class="listitem">Initialize the map and add a base layer:<div class="informalexample"><pre class="programlisting">    var map = new OpenLayers.Map("ch05_getfeature");    
    // Add a WMS layer
    var wms = new OpenLayers.Layer.WMS("Basic", "http://labs.metacarta.com/wms/vmap0",
    {
        layers: 'basic'
    });
    map.addLayer(wms);
    map.addControl(new OpenLayers.Control.LayerSwitcher());
    map.setCenter(new OpenLayers.LonLat(0, 40), 3);
</pre></div></li><li class="listitem">Add the two vector layers, the first from a WFS server and the second from a GML file:<a class="indexterm" id="id241"/><div class="informalexample"><pre class="programlisting">    var statesLayer = new OpenLayers.Layer.Vector("States", {
        protocol: new OpenLayers.Protocol.WFS({
            url: "http://demo.opengeo.org/geoserver/wfs",
            featureType: "states",
            featureNS: "http://www.openplans.org/topp"
        }),
        strategies: [new OpenLayers.Strategy.BBOX()]
    });
    map.addLayer(statesLayer);
    
    var europeLayer = new OpenLayers.Layer.Vector("Europe (GML)", {
        protocol: new OpenLayers.Protocol.HTTP({
            url: "http://localhost:8080/openlayers-cookbook/recipes/data/europe.gml",
            format: new OpenLayers.Format.GML()
        }),
        strategies: [new OpenLayers.Strategy.Fixed()]
    });
    map.addLayer(europeLayer);
</pre></div></li><li class="listitem">Add a third layer that will serve to show the selected features:<div class="informalexample"><pre class="programlisting">    var selected = new OpenLayers.Layer.Vector("Selected", {
        styleMap: new OpenLayers.Style(OpenLayers.Feature.Vector.style["temporary"])
    });
    map.addLayer(selected);
</pre></div></li><li class="listitem">Now add the<code class="literal"> GetFeature</code> control:<div class="informalexample"><pre class="programlisting">    var getFeature = new OpenLayers.Control.GetFeature({
        protocol: statesLayer.protocol,
        box: true,
        hover: false,
        multipleKey: "shiftKey",
        toggleKey: "ctrlKey",
        eventListeners: {
            "featureselected": function(event) {
                selected.addFeatures([event.feature]);
            },
            "featureunselected": function(event) {
                selected.removeFeatures([event.feature]);
            }
        }
    });
    map.addControl(getFeature);
</pre></div></li><li class="listitem">Insert the code to activate/deactivate the control:<div class="informalexample"><pre class="programlisting">    function getFeatureClick(checked) {
        if(checked) {
            getFeature.activate();
        } else {
            getFeature.deactivate();
        }
    }
</pre></div></li><li class="listitem">And finally, add the code that will change which layer to be queried by the control:<div class="informalexample"><pre class="programlisting">    function changeHandler() {
        var usa = dijit.byId('usa').get('checked');
        if(usa) {
            getFeature.protocol = statesLayer.protocol;
        } else {
            getFeature.protocol = europeLayer.protocol;
        }
    }
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec28"/>How it works...</h3></div></div></div><p>Because we are working with the WFS layer, and also the later queries made by the<code class="literal"> GetFeature</code> control are using AJAX, we need to configure a proxy script to be used.</p><p>After initializing the map, we have added a base WMS layer simply using the<code class="literal"> OpenLayers.Layer.WMS</code> class and specifying a URL to the server and the WMS layer name:</p><div class="informalexample"><pre class="programlisting">    var wms = new OpenLayers.Layer.WMS("Basic", "http://labs.metacarta.com/wms/vmap0",
    {
        layers: 'basic'
    });
</pre></div><p>The two vector layers have not much secret. Thanks to the<code class="literal"> OpenLayers.Protocol</code> subclasses, we can easily create vector layers from different data sources by simply specifying the right protocol:<a class="indexterm" id="id243"/>
</p><div class="informalexample"><pre class="programlisting">    var statesLayer = new OpenLayers.Layer.Vector("States", {
        protocol: new OpenLayers.Protocol.WFS(...),
        strategies: [new OpenLayers.Strategy.BBOX()]
    });
    
    var europeLayer = new OpenLayers.Layer.Vector("Europe (GML)", {
        protocol: new OpenLayers.Protocol.HTTP(...),
        strategies: [new OpenLayers.Strategy.Fixed()]
    });
</pre></div><p>In addition, we have created a third vector layer called<code class="literal"> selected</code>. Why? Let's explain first how the<code class="literal"> OpenLayers.Control.GetFeature</code> works:</p><div class="informalexample"><pre class="programlisting">    var getFeature = new OpenLayers.Control.GetFeature({
        protocol: statesLayer.protocol,
        box: true,
        hover: false,
        multipleKey: "shiftKey",
        toggleKey: "ctrlKey",
        eventListeners: {
            "featureselected": function(event) {
                selected.addFeatures([event.feature]);
            },
            "featureunselected": function(event) {
                selected.removeFeatures([event.feature]);
            }
        }
    });
</pre></div><p>By default,<code class="literal"> OpenLayers.Control.GetFeature</code> starts working when a click event is made. Then, using the specified<code class="literal"> protocol</code> instance, it queries the data source for the features under the click location.</p><p>In addition, by using the<code class="literal"> box</code> property, we can allow selecting features using a selection binding box. A third selection is done with the hover action but we have disabled it setting the<code class="literal"> hover</code> property to<code class="literal"> false</code>.</p><p>As the name implies, the properties<code class="literal"> multipleKey</code> and<code class="literal"> toggleKey</code> are used to define the control keys that are used to select multiple features and toggle their selection state.</p><p>Finally, the<code class="literal"> eventListeners</code> property allows us to register at the time the constructor is called and the events we want to listen for. In this case we will be notified when a feature will be selected or unselected.<a class="indexterm" id="id244"/>
</p><p>Let's go back to the third vector layer, the<code class="literal"> selected</code> layer.</p><p>In contrast to the other controls, such as the<code class="literal"> OpenLayers.Control.SelectFeature, OpenLayers.Control.GetFeature</code> didn't modify the visual style of the feature. That is, if you use the<code class="literal"> SelectFeature</code> control, you will see that each time you select a feature, its color and border will change to indicate it is selected.</p><p>On the other hand, with<code class="literal"> OpenLayers.Control.GetFeature</code>, nothing happens when a feature is selected. The control makes a query to the data source and an event is triggered. You are responsible to perform something with that event.</p><p>In this recipe, we are retrieving the feature from the event and adding it to the selected layer:</p><div class="informalexample"><pre class="programlisting">            "featureselected": function(event) {
                selected.addFeatures([event.feature]);
            },
            "featureunselected": function(event) {
                selected.removeFeatures([event.feature]);
            }
</pre></div><p>If we look at the instantiation code of the selected layer, it looks something like the following code:</p><div class="informalexample"><pre class="programlisting">    var selected = new OpenLayers.Layer.Vector("Selected", {
        styleMap: new OpenLayers.Style(OpenLayers.Feature.Vector.style["temporary"])
    });
</pre></div><p>We have supplied a different style for the layer. In this case, we are getting the<code class="literal">"temporary"</code> style defined at<code class="literal"> OpenLayers.Feature.Vector</code> and applying it to the layer so the features have a different look.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note50"/>Note</h3><p>More on styling is discussed in<a class="link" href="ch07.html" title="Chapter 7. Styling Features"> Chapter 7</a>, <span class="emphasis"><em> Styling Features.</em></span>
</p></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec29"/>There's more...</h3></div></div></div><p>It is important to note that the<code class="literal"> OpenLayers.Control.SelectFeature</code> control is similar to the<code class="literal"> OpenLayers.control.GetFeature</code> control, but they have important differences.<a class="indexterm" id="id245"/>
</p><p>First, the<code class="literal"> OpenLayers.control.GetFeature</code> control makes a query to the data source that returns the features involved by the selection. The<code class="literal"> openLayers.Control.SelectFeature</code> control makes no request, it works on the client-side and retrieves the selected feature from the specified vector layer.</p><p>Second, every time a feature is selected with the<code class="literal"> OpenLayers.Control.SelectFeature</code> control, a<code class="literal"> featureselected</code> event is triggered by the vector layer. So we can register listeners in the vector layer to be notified for the selection events.</p><p>With the<code class="literal"> OpenLayers.control.GetFeature</code> control, no event is triggered by the vector layer. The events are triggered by the control and because of this we need to register listeners in the control.</p><p>Finally, with the<code class="literal"> OpenLayers.control.GetFeature</code> control, we can use any protocol that supports spatial filters. Because of this, we can use the<code class="literal"> GetFeature</code> control against a WFS server or a GML file.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec30"/>See also</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Selecting and transforming features</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Getting information from the WMS server</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Adding GML layer</em></span> recipe in<a class="link" href="ch03.html" title="Chapter 3. Working with Vector Layers"> Chapter 3</a>, <span class="emphasis"><em> Vector Layers</em></span></li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Filtering features in WFS requests</em></span> in<a class="link" href="ch03.html" title="Chapter 3. Working with Vector Layers"> Chapter 3</a>, <span class="emphasis"><em> Vector Layers</em></span></li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Listening for vector layer features' event</em></span> in<a class="link" href="ch04.html" title="Chapter 4. Working with Events"> Chapter 4</a>, <span class="emphasis"><em> Controls</em></span></li></ul></div></div></div></div>
<div class="section" title="Getting information from the WMS server"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec10"/>Getting information from the WMS server</h1></div></div></div><p>Nowadays, the<span class="strong"><strong> Web Map Service (WMS)</strong></span>  has an important role in the GIS world, mainly because rendering tons of vector data at the client-side, no matter if its browser on a desktop consumes many resources.<a class="indexterm" id="id246"/>
</p><p>If we think, in the OpenStreetMap project, where we have tons of vector data about streets, places, and so on, we can see that the main way to render data is in a raster way.</p><p>In this scenario, WMS servers allow us to get vector or raster data, from a shapefile, from a<code class="literal"> .geotiff</code> file, from a spatial database, and so on, and render all together as a single image. Not only that, if properly configured, a WMS server allows us to query information of a feature at a given point.<a class="indexterm" id="id247"/>
</p><p>With OpenLayers, this can be easily done using the<code class="literal"> OpenLayers.Control.WMSGetFeatureInfo</code> control.</p><p>In the following screenshot, we can see what our current recipe looks like. Given some vector information about USA states, the server returns a raster image.</p><div class="mediaobject"><img alt="Getting information from the WMS server" src="graphics/7843_05_09.jpg"/></div><p>Once the control is activated, any click event on the map will trigger a request to the WMS server to get the feature information.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec31"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create an HTML file with the OpenLayers library dependencies and add the code for the button and the map's<code class="literal"> div</code> element:<div class="informalexample"><pre class="programlisting">&lt;button dojoType="dijit.form.ToggleButton" id="featureInfoButton" onChange="featureInfoChange" iconClass='dijitCheckBoxIcon' checked="false"&gt;Activated&lt;/button&gt;
&lt;div id="ch05_wmsfeatureinfo" style="width: 100%; height: 100%;"&gt;&lt;/div&gt;
</pre></div></li><li class="listitem">Set the proxy script, and initialize the map instance:<div class="informalexample"><pre class="programlisting">    OpenLayers.ProxyHost = "./utils/proxy.php?url=";
    // Create map
    var map = new OpenLayers.Map("ch05_wmsfeatureinfo"); 
</pre></div></li><li class="listitem">Now, add two WMS layers. The first will act as the base layer while the second will be an overlay layer with the USA states:<a class="indexterm" id="id248"/><div class="informalexample"><pre class="programlisting">    var wms = new OpenLayers.Layer.WMS("Basic", "http://demo.opengeo.org/geoserver/wms",
    {
        layers: 'topp:naturalearth'
    });
    map.addLayer(wms);
     var wms2 = new OpenLayers.Layer.WMS("Basic", "http://demo.opengeo.org/geoserver/wms",
    {
        layers: 'topp:states',
        transparent: true
    },{
        isBaseLayer: false
    });
    map.addLayer(wms2);
</pre></div></li><li class="listitem">Add the layer switcher control and center the map's viewport:<div class="informalexample"><pre class="programlisting">    map.addControl(new OpenLayers.Control.LayerSwitcher());
    map.setCenter(new OpenLayers.LonLat(-90, 40), 4);
</pre></div></li><li class="listitem">Then add the code for the<code class="literal"> WMSGetFeatureInfo</code> control:<div class="informalexample"><pre class="programlisting">    var featureInfo = new OpenLayers.Control.WMSGetFeatureInfo({
        url: 'http://demo.opengeo.org/geoserver/wms', 
        title: 'Identify features by clicking',
        queryVisible: true,
        eventListeners: {
            "getfeatureinfo": function(event) {
                map.addPopup(new OpenLayers.Popup.FramedCloud(
                "chicken", 
                map.getLonLatFromPixel(event.xy),
                null,
                event.text,
                null,
                true
            ));
            }
        }
    });
    map.addControl(featureInfo);
</pre></div></li><li class="listitem">Finally, add the code to activate/deactivate the control when the button is clicked:<a class="indexterm" id="id249"/><div class="informalexample"><pre class="programlisting">    function featureInfoChange(checked) {
        if(checked) {
            featureInfo.activate();
        } else {
            featureInfo.deactivate();
        }
    }
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec32"/>How it works...</h3></div></div></div><p>A WMS server implements different request types. The most important is the<code class="literal"> GetMap</code> request, which allows us to get an image given some parameters, such as a bounding box, the name of the layers, and so on.<a class="indexterm" id="id250"/>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note51"/>Note</h3><p>All this explanation is more close to understanding the WMS standard than working with OpenLayers. So, invest your time and learn what the WMS standard offers and how it works. You can find a very brief description at wikipedia:<a class="ulink" href="http://en.wikipedia.org/wiki/Web_Map_Service"> http://en.wikipedia.org/wiki/Web_Map_Service</a>, and the whole specification at OGC:<a class="ulink" href="http://www.opengeospatial.org/standards/wms"> http://www.opengeospatial.org/standards/wms</a>.</p></div><p>In addition, the WMS server can implement the<code class="literal"> GetFeatureInfo</code> request. This type of request allows us to, given a point and some layer names configured at the WMS server, retrieve information from a feature, that is, we can get a feature attribute from a layer which is rendered as a raster image.</p><p>Let's describe the code of this recipe, which is the goal of this book and not to explain how a WMS server works.</p><p>Because, the control will make an AJAX request, we need to set a proxy script to be used:</p><div class="informalexample"><pre class="programlisting">    OpenLayers.ProxyHost = "./utils/proxy.php?url=";
</pre></div><p>The WMS layer comes from a public server from the awesome<span class="strong"><strong> OpenGeo</strong></span> project (<a class="ulink" href="http://opengeo.org">http://opengeo.org</a>). The first layer acts as a base layer. The second one must be an overlay layer, because we have set the<code class="literal"> isBaseLayer</code> property to<code class="literal"> false</code>. In addition, to avoid the layer hiding the base layer, we have set the<code class="literal"> transparent</code> property, which is used in the WMS request, to<code class="literal"> true:</code>
<a class="indexterm" id="id251"/>
</p><div class="informalexample"><pre class="programlisting">     var wms2 = new OpenLayers.Layer.WMS("Basic", "http://demo.opengeo.org/geoserver/wms",
    {
        layers: 'topp:states',
        transparent: true
    },{
        isBaseLayer: false
    });
</pre></div><p>Adding the<code class="literal"> WMSGetFeatureInfo</code> control is easy, we need to set the WMS server URL, some desired properties and register some event listeners to make something with the returned information:</p><div class="informalexample"><pre class="programlisting">    var featureInfo = new OpenLayers.Control.WMSGetFeatureInfo({
        url: 'http://demo.opengeo.org/geoserver/wms', 
        queryVisible: true,
        eventListeners: {...}
    });
</pre></div><p>Because we want to show a popup with the data, we have registered a function on the<code class="literal"> getfeatureinfo</code> event, which is triggered when the control obtains the server data:</p><div class="informalexample"><pre class="programlisting">        eventListeners: {
            "getfeatureinfo": function(event) {
                map.addPopup(new OpenLayers.Popup.FramedCloud(
                "chicken", 
                map.getLonLatFromPixel(event.xy),
                null,
                event.text,
                null,
                true
            ));
            }
        }
</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note52"/>Note</h3><p>To query information of a layer in a WMS server, it must be configured as a queryable layer. If we request for a layer which is not queryable, then a<code class="literal"> nogetfeatureinfo</code> event will be triggered by the control.</p></div><p>By default, the control requests data for all WMS layers in the map. With the<code class="literal"> queryVisible</code> property, we can limit the query to those layers which are currently visible and forget those hidden layers.<a class="indexterm" id="id252"/>
</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec33"/>There's more...</h3></div></div></div><p>The<code class="literal"> WMSGetFeatureInfo</code> control has other interesting properties.</p><p>With the<code class="literal"> hover</code> property set to<code class="literal"> true</code> we can force the control to query the server, not only when the mouse clicks on the map, but also on the mouse hover event.</p><p>Using the<code class="literal"> layers</code> property, which accepts an array of<code class="literal"> OpenLayers.Layer.WMS</code> layers, we can control which layers must be queried on the server. If not specified, the layers are obtained from the map.</p><p>In addition, if a layer has been configured to work with more than one server, only the first one is used for the queries.</p><p>Also, it is important to note that a WMS server can return the data in different formats, for example, a plain text, an HTML response, or also in GML format.</p><p>With the<code class="literal"> infoFormat</code> property, we can indicate to the server the kind of response we desire. By default it is HTML.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec34"/>See also</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Getting feature information from data source</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Selecting and transforming features</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The<span class="emphasis"><em> Adding WMS layer</em></span> recipe</li></ul></div></div></div></div></body></html>