<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Roles and Permissions" id="aid-1AT9A1"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Roles and Permissions</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Creating and configuring roles</li><li class="listitem">Assigning user roles</li><li class="listitem">Creating role-dependent portlet</li><li class="listitem">Checking permissions in a custom portlet</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec39"/>Introduction</h1></div></div></div><p>Just like employees of companies in the real world, users in the system can carry out different tasks. Some of them may deal with the management of the entire intranet—creating new organizations, locations, user groups, and sites; assigning users; and setting permissions. The others may be responsible for the configuration of specific sites and their pages, and managing portlets. There can also be a group of users who are responsible for creating and posting content. What is more, it is also possible that the same user can be an administrator of one of the sites, but at the same time, not be able to do anything except view the content of another. To enable the management of such a complex net of allowances, Liferay introduced the role functionality, which allows us to define what actions can be performed by which users in defined places.</p><p>A role<a id="id264" class="indexterm"/> is a collection of actions that can be performed by users assigned to that particular role. There are three types of roles defined at the portal level available<a id="id265" class="indexterm"/> in<a id="id266" class="indexterm"/> Liferay: regular roles, site<a id="id267" class="indexterm"/> roles, <a id="id268" class="indexterm"/>and organization roles. Regular roles <a id="id269" class="indexterm"/>define a list of actions that can be performed in <a id="id270" class="indexterm"/>areas (scopes) of the system specified in its definition. Using the regular role allows us to perform actions within one particular scope only. Site roles include actions performed within the site. Organization roles group actions that can be performed within an organization (for more information about organizations and sites, refer to <a class="link" title="Chapter 3. Working with a Liferay User / User Group / Organization" href="part0030.xhtml#aid-SJGS1">Chapter 3</a>, <span class="emphasis"><em>Working with a Liferay User / User Group / Organization</em></span>, and <a class="link" title="Chapter 4. Liferay Site Configuration" href="part0037.xhtml#aid-1394Q1">Chapter 4</a>, <span class="emphasis"><em>Liferay Site Configuration</em></span>).</p></div></div>
<div class="section" title="Creating and configuring roles"><div class="titlepage" id="aid-1BRPS2"><div><div><h1 class="title"><a id="ch05lvl1sec40"/>Creating and configuring roles</h1></div></div></div><p>Regardless of the type of the role with which we are dealing, the process of creating a new role<a id="id271" class="indexterm"/> consists of two steps—creating a new, empty role and defining a set <a id="id272" class="indexterm"/>of permissions for the role.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec108"/>How to do it…</h2></div></div></div><p>In this recipe, we will show you how to create a new regular site and organization roles and how to define a set of permissions for them.</p><p>In order to create a new regular role, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to <span class="strong"><strong>Admin</strong></span> | <span class="strong"><strong>Control Panel</strong></span> | <span class="strong"><strong>Roles</strong></span>.</li><li class="listitem">Click on the <span class="strong"><strong>Add</strong></span> button.</li><li class="listitem">Choose the <span class="strong"><strong>Regular Role</strong></span>, <span class="strong"><strong>Site Role</strong></span> or <span class="strong"><strong>Organization Role</strong></span> option.<div class="mediaobject"><img src="../Images/image00325.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Provide <span class="strong"><strong>Name (Required)</strong></span>, <span class="strong"><strong>Title</strong></span>, and <span class="strong"><strong>Description</strong></span> for the role.</li><li class="listitem">Click on the <span class="strong"><strong>Save</strong></span> button, and you will come back to a list containing all the roles defined.</li><li class="listitem">Click on the <span class="strong"><strong>Actions</strong></span> button next to the newly created role.</li><li class="listitem">Choose the <span class="strong"><strong>Edit</strong></span> action.</li><li class="listitem">Click on the <span class="strong"><strong>Define Permissions</strong></span> tab.</li><li class="listitem">Using the<a id="id273" class="indexterm"/> left column navigation menu, choose the categories (such as <span class="strong"><strong>Site Administration</strong></span> | <span class="strong"><strong>Pages</strong></span> | <span class="strong"><strong>Site Pages</strong></span>) for which you want to <a id="id274" class="indexterm"/>define permissions.</li><li class="listitem">For each chosen category, mark the checkboxes next to the permissions for which you'd like to add the role.<div class="note" title="Note"><h3 class="title"><a id="note19"/>Note</h3><p>If you already know what categories you are searching for, then you could use the <span class="strong"><strong>Search</strong></span> text field to filter functionalities accordingly.</p></div><div class="mediaobject"><img src="../Images/image00326.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p><div class="note" title="Note"><h3 class="title"><a id="note20"/>Note</h3><p>When <a id="id275" class="indexterm"/>setting regular role permissions for categories within<a id="id276" class="indexterm"/> the <span class="strong"><strong>Site Administration</strong></span> group, you additionally need to choose the list of sites for which this role will be able to perform the action.</p></div></li><li class="listitem">Click on the <span class="strong"><strong>Save</strong></span> button.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec109"/>How it works…</h2></div></div></div><p>In the first <a id="id277" class="indexterm"/>part of the recipe, we showed you how to create a new empty role. In the <a id="id278" class="indexterm"/>second part, we described how to define permissions for this newly created role.</p><div class="section" title="Role parameters"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec34"/>Role parameters</h3></div></div></div><p>Each role has a <a id="id279" class="indexterm"/>name, title, and description. The description identifies the role in the system and consists of permissions. These permissions define what actions can be performed by users assigned to this role. Regular roles also have a list of users assigned to them.</p><p>The regular role may contain permissions for the <span class="strong"><strong>Control Panel</strong></span>, <span class="strong"><strong>Site Administration</strong></span>, and <span class="strong"><strong>My Account</strong></span> functionalities. The organization role consists of the <span class="strong"><strong>Users and Organizations</strong></span> and <span class="strong"><strong>Site Administration</strong></span> permissions. Site roles may only define the <span class="strong"><strong>Site Administration</strong></span> permissions.</p></div><div class="section" title="Control Panel, Site Administration, and My Account permissions"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec35"/>Control Panel, Site Administration, and My Account permissions</h3></div></div></div><p>The majority of <span class="strong"><strong>Control Panel</strong></span> category permissions are divided into two groups: <span class="strong"><strong>General Permissions</strong></span> and <span class="strong"><strong>Resource Permissions</strong></span>. For example, when configuring permissions<a id="id280" class="indexterm"/> for the <span class="strong"><strong>Users and Organizations</strong></span> functionality, we <a id="id281" class="indexterm"/>can define what actions can be<a id="id282" class="indexterm"/> performed for all applications in this group—whether they can be viewed, accessed in the <span class="strong"><strong>Control Panel</strong></span>, configured, whether users assigned to the role can perform user export action or set permissions for the <span class="strong"><strong>Users and Organizations</strong></span> functionality, and so on. All these are general permissions. Additionally, for the <span class="strong"><strong>Users and Organizations</strong></span> functionality, it is also possible to set <span class="strong"><strong>Resource Permissions</strong></span>. This defines which actions users having this role can perform on users and organizations, for instance, whether they can delete, impersonate, update, or view users; add organizations; assign members; manage suborganizations using the <span class="strong"><strong>Users and Organization</strong></span> section; and so on.</p><p>
<span class="strong"><strong>The Site Administration</strong></span> permissions, in most cases, are also divided into <span class="strong"><strong>General Permissions</strong></span> and <span class="strong"><strong>Resource Permissions</strong></span>. However, in addition, when defining the <span class="strong"><strong>Site Administration</strong></span> permissions, we can decide for which sites users having this role may perform actions. For example, it is possible to set the regular role, which allows users to manage pages or add content only for chosen sites.</p><p>The <span class="strong"><strong>My Account</strong></span> permissions are concerned with application actions only.</p></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec110"/>There's more…</h2></div></div></div><p>It is also possible to manage a role using actions available in the <span class="strong"><strong>Roles</strong></span> actions menu.</p><p>There are several <a id="id283" class="indexterm"/>possible actions that can be performed on a role:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><strong>Edit</strong></span> action allows us to change the <span class="strong"><strong>Name</strong></span>, <span class="strong"><strong>Title</strong></span>, and <span class="strong"><strong>Description</strong></span> of the role, define permissions, and assign members for the role.</li><li class="listitem">The <span class="strong"><strong>Permissions</strong></span> action allows us to set permissions for actions that can be performed on this role.</li><li class="listitem">The <span class="strong"><strong>Define</strong></span> permissions action allows us to define permissions for the role.</li><li class="listitem">The <span class="strong"><strong>Assign Members</strong></span> action allows us to assign the role for users. It is available for regular roles only.</li><li class="listitem">The <span class="strong"><strong>View Users</strong></span> action opens the list of all users having this particular role. It is available for regular roles only.</li><li class="listitem">The <span class="strong"><strong>Delete</strong></span> action allows us to delete a role. Out-of-the-box Liferay roles cannot be deleted.</li></ul></div><p>In order to perform one of the preceding actions, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to <span class="strong"><strong>Control Panel</strong></span> | <span class="strong"><strong>Roles</strong></span>.</li><li class="listitem">Click on the <span class="strong"><strong>Actions</strong></span> button located near the name of the role you want to modify:<div class="mediaobject"><img src="../Images/image00327.jpeg" alt="There's more…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on the name of the chosen action.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec111"/>See also</h2></div></div></div><p>For more information on organizations and sites, refer to the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="emphasis"><em>Managing an organization structure</em></span> recipe in <a class="link" title="Chapter 3. Working with a Liferay User / User Group / Organization" href="part0030.xhtml#aid-SJGS1">Chapter 3</a>, <span class="emphasis"><em>Working with a Liferay User / User Group / Organization</em></span></li><li class="listitem"><span class="emphasis"><em>Creating an organization and a standalone site</em></span> in <a class="link" title="Chapter 4. Liferay Site Configuration" href="part0037.xhtml#aid-1394Q1">Chapter 4</a>, <span class="emphasis"><em>Liferay Site Configuration</em></span></li></ul></div></div></div>
<div class="section" title="Assigning user roles" id="aid-1CQAE1"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec41"/>Assigning user roles</h1></div></div></div><p>In order to<a id="id284" class="indexterm"/> define what users can do, you need to assign roles for them. Each user can have multiple roles, including regular, site, and organization roles. Each role assigned to a user is available in the roles section of the user account.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec112"/>How to do it…</h2></div></div></div><p>In this recipe, we will show you how to assign members to regular roles.</p><p>In order to assign members for a regular role, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to <span class="strong"><strong>Admin</strong></span> | <span class="strong"><strong>Control Panel</strong></span> | <span class="strong"><strong>Roles</strong></span>.</li><li class="listitem">Click on the <span class="strong"><strong>Actions</strong></span> button located near the name of the role to which you want to assign users.</li><li class="listitem">Click on the <span class="strong"><strong>Assign Members</strong></span> action, and you will see a list of the current members of this role.</li><li class="listitem">Click on the <span class="strong"><strong>Available</strong></span> tab:<div class="mediaobject"><img src="../Images/image00328.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Choose the <span class="strong"><strong>Users</strong></span>, <span class="strong"><strong>Sites</strong></span>, <span class="strong"><strong>Organizations</strong></span>, or <span class="strong"><strong>User Groups</strong></span> tab.</li><li class="listitem">Mark <a id="id285" class="indexterm"/>users, sites, organizations, or user groups to which you want to assign the role.</li><li class="listitem">Click on the <span class="strong"><strong>Update Associations</strong></span> button.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec113"/>How it works…</h2></div></div></div><p>Regular roles can be assigned to users or collections of users, such as <span class="strong"><strong>Organizations</strong></span>, <span class="strong"><strong>Sites</strong></span>, and <span class="strong"><strong>User Groups</strong></span>. If the role is assigned to a user, this user gains all the permissions defined for this role. You can see the role by going to <span class="strong"><strong>Roles</strong></span> | <span class="strong"><strong>Regular Roles</strong></span> in the edit user form (to enter the edit user form go to <span class="strong"><strong>Users and Organizations</strong></span> | <span class="strong"><strong>All Users</strong></span> and click on the name of the user whose account you want to see). If a role is assigned to a collection of users, each member of that site, organization, or user group inherits this role. You can see this information by navigating to <span class="strong"><strong>Roles</strong></span> | <span class="strong"><strong>Inherited Roles</strong></span> in the edit user form.</p><div class="mediaobject"><img src="../Images/image00329.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p><p>The <span class="strong"><strong>Roles</strong></span> section <a id="id286" class="indexterm"/>in <span class="strong"><strong>Control Panel</strong></span> allows us to assign users or a collection of users to <span class="strong"><strong>Regular Roles</strong></span> only. <span class="strong"><strong>Organization Roles</strong></span> can be assigned using the <span class="strong"><strong>Assign Organization Roles</strong></span> action available in the <span class="strong"><strong>Organization</strong></span> action menu. <span class="strong"><strong>Site Roles</strong></span> can be assigned in the <span class="strong"><strong>Site Membership</strong></span> section of <span class="strong"><strong>Site Administration</strong></span>. It is important to remember that it is not possible to assign organization and site roles to collections of users.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec114"/>See also</h2></div></div></div><p>For more information on assigning organization roles and site roles, refer to the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="emphasis"><em>Managing an organization structure</em></span> in <a class="link" title="Chapter 3. Working with a Liferay User / User Group / Organization" href="part0030.xhtml#aid-SJGS1">Chapter 3</a>, <span class="emphasis"><em>Working with a Liferay User / User Group / Organization</em></span></li><li class="listitem"><span class="emphasis"><em>Creating an organization and a standalone site</em></span> in <a class="link" title="Chapter 4. Liferay Site Configuration" href="part0037.xhtml#aid-1394Q1">Chapter 4</a>, <span class="emphasis"><em>Liferay Site Configuration</em></span></li></ul></div></div></div>
<div class="section" title="Creating a role-dependent portlet"><div class="titlepage" id="aid-1DOR02"><div><div><h1 class="title"><a id="ch05lvl1sec42"/>Creating a role-dependent portlet</h1></div></div></div><p>Liferay provides two ways to check permissions. The first mechanism implements the <span class="strong"><strong>Java Portlet Specification 2.0</strong></span> (<span class="strong"><strong>JSR 286</strong></span>) and provides an XML definition to map a Liferay role<a id="id287" class="indexterm"/> and portlet role. The second mechanism uses the Liferay permission checker to verify users and the actions that they perform. In this recipe, we will show you how the Java Portlet Specification and Liferay work together.</p><div class="section" title="Getting ready…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec115"/>Getting ready…</h2></div></div></div><p>Generate or<a id="id288" class="indexterm"/> create an empty portlet using the Maven archetype generator. We described it in <a class="link" title="Chapter 1. Installation and Basic Configuration" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <span class="emphasis"><em>Installation and Basic Configuration</em></span>. It is not important which <code class="literal">PortletBridge</code> will be used. We will decide to use a simple one called <code class="literal">MVCPortlet</code>.</p><p>Let's assume that our goal is to write a greeting portlet that can recognize whether the current user is logged in as a user or a guest. In every situation, our portlet should display the greeting, <span class="strong"><strong>Welcome Guest!</strong></span> or <span class="strong"><strong>Welcome User</strong></span>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec116"/>How to do it…</h2></div></div></div><p>Our concept is based on the approach that every kind of greeting will be in a different <code class="literal">JSP</code> file and that our controller will decide which <code class="literal">JSP</code> file should be used. Follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">portlet.xml</code>, which is located in the <code class="literal">src/main/webapp/WEB-INF</code> folder, and add <code class="literal">init</code> parameters to it:<div class="informalexample"><pre class="programlisting">&lt;init-param&gt;
  &lt;name&gt;view-user-template&lt;/name&gt;
  &lt;value&gt;/html/user.jsp&lt;/value&gt;
&lt;/init-param&gt;
&lt;init-param&gt;
  &lt;name&gt;view-guest-template&lt;/name&gt;
  &lt;value&gt;/html/guest.jsp&lt;/value&gt;
&lt;/init-param&gt;</pre></div></li><li class="listitem">Create the <code class="literal">src/main/webapp/html</code> folder and add two files, <code class="literal">user.jsp</code> and <code class="literal">guest.jsp</code>. In each file, define the greeting. In the <code class="literal">guest.jsp</code> file, add the following content:<div class="informalexample"><pre class="programlisting">&lt;h1&gt;Welcome Guest!&lt;/h1&gt;</pre></div><p>In the <code class="literal">user.jsp</code> file, add this line:</p><div class="informalexample"><pre class="programlisting">  &lt;h1&gt;Welcome User!&lt;/h1&gt;</pre></div></li><li class="listitem">Define roles in the <code class="literal">&lt;security-role-ref&gt;</code> tag in <code class="literal">portlet.xml</code>:<div class="informalexample"><pre class="programlisting">&lt;security-role-ref&gt;
  &lt;role-name&gt;logged-user&lt;/role-name&gt;
&lt;/security-role-ref&gt;
&lt;security-role-ref&gt;
  &lt;role-name&gt;guest-user&lt;/role-name&gt;
&lt;/security-role-ref&gt;</pre></div><div class="note" title="Note"><h3 class="title"><a id="note21"/>Note</h3><p>We have <a id="id289" class="indexterm"/>changed the default role names on purpose to show you that the previous roles are different from the Liferay ones.</p></div></li><li class="listitem">Open <code class="literal">liferay-portlet.xml</code> and map portlet roles into Liferay roles as follows:<div class="informalexample"><pre class="programlisting">&lt;role-mapper&gt;
  &lt;role-name&gt;guest-user&lt;/role-name&gt;
  &lt;role-link&gt;Guest&lt;/role-link&gt;
&lt;/role-mapper&gt;
&lt;role-mapper&gt;
  &lt;role-name&gt;logged-user&lt;/role-name&gt;
  &lt;role-link&gt;User&lt;/role-link&gt;
&lt;/role-mapper&gt;</pre></div></li><li class="listitem">Define the portlet render method as follows:<div class="informalexample"><pre class="programlisting">public void render(RenderRequest request, RenderResponse response) throws PortletException, IOException {
  String renderPagePath = getInitParameter("view-guest-template");
  if (request.isUserInRole("logged-user")) {
    renderPagePath = getInitParameter("view-user-template");
  }
  
  include(renderPagePath, request, response);
  super.render(request, response);
}</pre></div></li><li class="listitem">Compile and deploy the portlet.</li><li class="listitem">Put our portlet on the welcome site and test it. Our greeting should be on the site depending on whether the user is authenticated or not.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec117"/>How it works…</h2></div></div></div><p>Portlet specification JSR-286 defines a set of the methods of the <code class="literal">PortletRequest</code> interface. These methods allow us to check the user's principal name or role:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">getUserPrincipal</code></li><li class="listitem"><code class="literal">getRemoteUser</code></li><li class="listitem"><code class="literal">isUserInRole</code></li></ul></div><p>The <code class="literal">getUserPrincipal</code> method returns the principal name of the current authenticated user and returns the <code class="literal">java.security.Principal</code> object. Similarly, <code class="literal">getRemoteUser</code> returns the<a id="id290" class="indexterm"/> name of the logged-in user. As a matter of fact, both methods return the same value, which is the <code class="literal">userId</code>, in the Liferay implementation. If a user is not authenticated, both methods return null. The third method expects a string parameter with the role name that is defined in <code class="literal">portlet.xml</code>. It checks the current user role and returns a <code class="literal">boolean</code> value.</p><p>The JSR-286 specification determines that every <code class="literal">security-role-ref</code> definition should be mapping into the internal system roles depending on the portlet container implementation. This mapping can be specified in <code class="literal">web.xml</code> as a pair of tags: <code class="literal">role-name</code> and <code class="literal">role-link</code>. Here is an example:</p><div class="informalexample"><pre class="programlisting">&lt;role-mapper&gt;
  &lt;role-name&gt;logged-user&lt;/role-name&gt;
  &lt;role-link&gt;User&lt;/role-link&gt;
&lt;/role-mapper&gt;</pre></div><p>Liferay specifies these mappings in <code class="literal">liferay-portlet.xml</code>.</p><p>However, this approach has a limitation. JSR-286 documents contain the following sentence:</p><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>"The developer must be aware that the use of this default mechanism may limit the flexibility in changing role-names in the application without having to recompile the portlet making the call."</em></span></p></blockquote></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec118"/>See also</h2></div></div></div><p>If you want to learn how to create new portlets or hooks, refer to these recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="emphasis"><em>Creating a custom portlet</em></span> in <a class="link" title="Chapter 1. Installation and Basic Configuration" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <span class="emphasis"><em>Installation and Basic Configuration</em></span></li><li class="listitem"><span class="emphasis"><em>The language properties hook</em></span> in <a class="link" title="Chapter 11. Quick Tricks and Advanced Knowledge" href="part0080.xhtml#aid-2C9D01">Chapter 11</a>, <span class="emphasis"><em>Quick Tricks and Advanced Knowledge</em></span></li><li class="listitem"><span class="emphasis"><em>Using Liferay Service Bus for communication between portlets</em></span> in <a class="link" title="Chapter 11. Quick Tricks and Advanced Knowledge" href="part0080.xhtml#aid-2C9D01">Chapter 11</a>, <span class="emphasis"><em>Quick Tricks and Advanced Knowledge</em></span></li></ul></div></div></div>
<div class="section" title="Checking permissions in a custom portlet"><div class="titlepage" id="aid-1ENBI2"><div><div><h1 class="title"><a id="ch05lvl1sec43"/>Checking permissions in a custom portlet</h1></div></div></div><p>Permissions in Liferay are very flexible but very complex to understand. In this recipe, we will show <a id="id291" class="indexterm"/>you only the basic use of permissions, but <a id="id292" class="indexterm"/>we hope this tutorial will be a start-up to implement more complex permissions. Let's assume that our goal is extending the previous portlet to display a secret message only for the users who have a specific permission. This permission should be configurable in the portlet permissions.</p><div class="section" title="Getting ready…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec119"/>Getting ready…</h2></div></div></div><p>We assume that you have a ready-to-use Maven portlet generated from Maven archetypes. In <a class="link" title="Chapter 1. Installation and Basic Configuration" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <span class="emphasis"><em>Installation and Basic Configuration</em></span>, we described how to achieve this.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec120"/>How to do it…</h2></div></div></div><p>To achieve our goal, we have to define and add a specific permission to our portlet from the previous recipe. Next, we should register our list of permissions. At the end, we will use those permissions to display the secret area in our portlet. Perform these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">src/main/resources/resource-actions</code> folder.</li><li class="listitem">Create a file called <code class="literal">roles.xml</code> in the <code class="literal">resource-actions</code> folder with the following content:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE resource-action-mapping PUBLIC "-//Liferay//DTD Resource Action Mapping 6.2.0//EN" "http://www.liferay.com/dtd/liferay-resource-action-mapping_6_2_0.dtd"&gt;

&lt;resource-action-mapping&gt;
  &lt;portlet-resource&gt;
    &lt;portlet-name&gt;roles-portlet&lt;/portlet-name&gt;
    &lt;permissions&gt;
      &lt;supports&gt;
        &lt;action-key&gt;ADD_SECTION&lt;/action-key&gt;
        &lt;action-key&gt;CONFIGURATION&lt;/action-key&gt;
        &lt;action-key&gt;VIEW&lt;/action-key&gt;
        &lt;action-key&gt;ACCESS_IN_CONTROL_PANEL&lt;/action-key&gt;
      &lt;/supports&gt;
      &lt;site-member-defaults&gt;
        &lt;action-key&gt;VIEW&lt;/action-key&gt;
      &lt;/site-member-defaults&gt;
      &lt;guest-defaults&gt;
        &lt;action-key&gt;VIEW&lt;/action-key&gt;
      &lt;/guest-defaults&gt;
      &lt;guest-unsupported&gt;
        &lt;action-key&gt;ACCESS_IN_CONTROL_PANEL&lt;/action-key&gt;
        &lt;action-key&gt;CONFIGURATION&lt;/action-key&gt;
      &lt;/guest-unsupported&gt;
    &lt;/permissions&gt;
  &lt;/portlet-resource&gt;
&lt;/resource-action-mapping&gt;</pre></div></li><li class="listitem">Create the <code class="literal">default.xml</code> file in the <code class="literal">resource-actions</code> folder with the following content:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE resource-action-mapping PUBLIC "-//Liferay//DTD Resource Action Mapping 6.2.0//EN" "http://www.liferay.com/dtd/liferay-resource-action-mapping_6_2_0.dtd"&gt;

&lt;resource-action-mapping&gt;
  &lt;resource file="resource-actions/roles.xml" /&gt;
&lt;/resource-action-mapping&gt;</pre></div></li><li class="listitem">Create<a id="id293" class="indexterm"/> the <code class="literal">portlet.properties</code> file in the <code class="literal">src/main/resources</code> folder (if it doesn't exist yet) and <a id="id294" class="indexterm"/>set the following property:<div class="informalexample"><pre class="programlisting">resource.actions.configs=resource-actions/default.xml</pre></div></li><li class="listitem">Edit <code class="literal">liferay-portlet.xml</code> and add the following tag in the <code class="literal">&lt;portlet&gt;</code> section:<div class="informalexample"><pre class="programlisting">&lt;add-default-resource&gt;true&lt;/add-default-resource&gt;</pre></div></li><li class="listitem">Compile and deploy the portlet.</li><li class="listitem">Put the portlet on the layout and go to <span class="strong"><strong>Options</strong></span> | <span class="strong"><strong>Configuration menu</strong></span>.</li><li class="listitem">Set the <code class="literal">action.ADD_SECTION</code> permission for <span class="strong"><strong>Power User</strong></span>.</li><li class="listitem">Go back to the Eclipse IDE. In the portlet render method, add the following code:<div class="informalexample"><pre class="programlisting">ThemeDisplay themeDisplay = (ThemeDisplay) request.getAttribute(WebKeys.THEME_DISPLAY);
boolean secretSection = true;
try {
  PermissionChecker permissionChecker = themeDisplay.getPermissionChecker();
  String portletId = themeDisplay.getPortletDisplay().getId();
  PortletPermissionUtil.check(permissionChecker, portletId, "ADD_SECTION");
} catch (PrincipalException pe) {
  secretSection = false;
} catch (SystemException | PortalException e) {}
request.setAttribute("secretSection", secretSection);</pre></div><div class="note" title="Note"><h3 class="title"><a id="tip10"/>Tip</h3><p>In our example, the render method is placed in the <code class="literal">com.packtpub.portlet.RolesPortlet</code> class.</p></div></li><li class="listitem">Create the <code class="literal">secret.jspf</code> file in the <code class="literal">src/main/webapp/html</code> folder with the following<a id="id295" class="indexterm"/> content:<div class="informalexample"><pre class="programlisting">&lt;c:if test="${requestScope.secretSection}"&gt;
  &lt;h2&gt;Secret section&lt;/h2&gt;
&lt;/c:if&gt;</pre></div></li><li class="listitem">Include <a id="id296" class="indexterm"/>this file in <code class="literal">guest.jsp</code> and <code class="literal">user.jsp</code>:<div class="informalexample"><pre class="programlisting">&lt;%@ include file="/html/secret.jspf" %&gt;</pre></div></li><li class="listitem">Compile, deploy, and run your portlet.<div class="note" title="Note"><h3 class="title"><a id="note22"/>Note</h3><p>You have to also define <code class="literal">c.tld</code> in both JSP files and in <code class="literal">liferay-plugin-package.properties</code>. A ready-to-use portlet is included in this book.</p></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec121"/>How it works…</h2></div></div></div><p>In general, Liferay divides permissions as <code class="literal">portlet-resources</code> and <code class="literal">model-resources</code>. Portlet resources are connected with the portlet and possible operations on the portlet itself (for instance, view, configuration). Model resources describe the possible permissions on the specific model (for instance, create, update, and delete). In this example, we showed only the <code class="literal">portlet-resources</code> definition, but <code class="literal">model-resources</code> is similar.</p><p>Portlet resources and model resources should be defined in the XML file and put in the classpath. In this recipe, we created two files: <code class="literal">default.xml</code> and <code class="literal">roles.xml</code>. This is the typical notation that Liferay applies in the core implementation. The first file lists all the resources where permissions are defined. The second one defines real permissions. It is possible to have just one file including the content of <code class="literal">roles.xml</code>. Typical resource action mapping consists of:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The portlet name, whose definition should be the same as in the <code class="literal">portlet.xml</code> file</li><li class="listitem">The <code class="literal">portlet-resource</code> section, which specifies supported permissions in our portlet, default permissions for a specific role, and unsupported permissions for a specific role</li><li class="listitem">The <code class="literal">model-resource</code> section, which was not used in this recipe</li></ul></div><p>A very <a id="id297" class="indexterm"/>useful option is <code class="literal">&lt;add-default-resource&gt;true&lt;/add-default-resource&gt;</code>, which we added in <code class="literal">liferay-portlet.xml</code>. The<a id="id298" class="indexterm"/> Liferay DTD definition explains this tag as follows:</p><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>"If the add-default-resource value is set to false and the portlet does not belong to the page but has been dynamically added, then the user will not have permissions to view the portlet. If the add-default-resource value is set to true, the default portlet resources and permissions are added to the page, and the user can then view the portlet. This is useful (and necessary) for portlets that need to be dynamically added to a page. However, to prevent security loopholes, the default value is false."</em></span></p></blockquote></div><p>The last thing is checking permissions. Liferay gives us a class called <code class="literal">PermissionChecker</code>, which is enabled in every portlet. <code class="literal">ThemeDisplay</code> aggregates this implementation. To check for permissions, Liferay provides a method that implements the <code class="literal">PermissionChecker</code> interface:</p><div class="informalexample"><pre class="programlisting">permissionChecker.hasPermission(groupId, name, primKey, actionId);</pre></div><p>Arguments of this method are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">groupId</code>: This is the primary key of the group containing the resource</li><li class="listitem"><code class="literal">name</code>: This is the resource's name, which can be either a class name or a portlet ID</li><li class="listitem"><code class="literal">primKey</code>: This is the primary key of the resource</li><li class="listitem"><code class="literal">actionId</code>: This is the action ID</li></ul></div><p>It is possible to use this type of checking in a direct way or to invoke the permission checker from <code class="literal">PortletPermissionUtil</code>. The second way is recommended by Liferay. The utility class has at least nine static methods called <code class="literal">check</code> with many variations of arguments depending on the situation. The <code class="literal">check</code> method doesn't return any value. If there is no permission, the method throws <code class="literal">PrincipalException</code>.</p><p>The second static method is <code class="literal">contain</code>, which returns <code class="literal">true</code> if a specific permission is enabled or <code class="literal">false</code> if the permission is disabled.</p><p>As a matter of fact, this recipe only touched upon the basics of permissions in Liferay. On the Internet, there are a lot of tutorials on how to use Liferay permissions and how to implement new functionalities. If we use a <span class="emphasis"><em>service builder</em></span> mechanism with a Liferay-based model, it is quite simple to implement the correct permissions. Liferay adds many things<a id="id299" class="indexterm"/> by default.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec122"/>See also</h2></div></div></div><p>If you <a id="id300" class="indexterm"/>want to learn how to create new portlets or hooks, refer to these recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="emphasis"><em>Creating a custom portlet</em></span> in <a class="link" title="Chapter 1. Installation and Basic Configuration" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <span class="emphasis"><em>Installation and Basic Configuration</em></span></li><li class="listitem">The <span class="emphasis"><em>language properties hook</em></span> and <span class="emphasis"><em>Using Liferay Service Bus for communication between portlets</em></span> in <a class="link" title="Chapter 11. Quick Tricks and Advanced Knowledge" href="part0080.xhtml#aid-2C9D01">Chapter 11</a>, <span class="emphasis"><em>Quick Tricks and Advanced Knowledge</em></span></li></ul></div></div></div></body></html>