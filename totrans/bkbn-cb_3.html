<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Collections"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Collections</h1></div></div></div><p>In this chapter we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating a collection of models</li><li class="listitem" style="list-style-type: disc">Getting a model from a collection by its index</li><li class="listitem" style="list-style-type: disc">Getting a model from a collection by its ID</li><li class="listitem" style="list-style-type: disc">Adding a model to a collection</li><li class="listitem" style="list-style-type: disc">Removing a model from a collection</li><li class="listitem" style="list-style-type: disc">Working with a collection as a stack or as a queue</li><li class="listitem" style="list-style-type: disc">Sorting a collection</li><li class="listitem" style="list-style-type: disc">Filtering models in a collection</li><li class="listitem" style="list-style-type: disc">Iterating through a collection</li><li class="listitem" style="list-style-type: disc">Chaining a collection</li><li class="listitem" style="list-style-type: disc">Running No SQL queries on a collection</li><li class="listitem" style="list-style-type: disc">Storing models of various types in the same collection</li><li class="listitem" style="list-style-type: disc">Implementing a one-to-many relationship</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec29"/>Introduction</h1></div></div></div><p>When developing applications with Backbone, you often need to work with a number of models, which can be organized in a <a class="indexterm" id="id184"/>collection. A collection is more than just a JavaScript array. Backbone provides various useful methods to work with it. Moreover, Backbone collection can easily communicate with a REST server to get or post a number of models.</p><p>In this chapter, we are going to learn <a class="indexterm" id="id185"/>common operations to work with collections, and will discover new extensions which provide amazing functionality.</p></div></div>
<div class="section" title="Creating a collection of models"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec30"/>Creating a collection of models</h1></div></div></div><p>In this recipe, we are<a class="indexterm" id="id186"/> going to learn how to create a collection of models. Collection is an object used for organizing models into an ordered set. There are specific methods to sort, filter, and iterate through a collection.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec70"/>How to do it...</h2></div></div></div><p>Follow these steps to create a collection:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Extend the <code class="literal">Backbone.Collection</code> object<a class="indexterm" id="id187"/> and pass the model's object name as an option.<div class="informalexample"><pre class="programlisting">var InvoiceItemCollection = Backbone.Collection.extend
({
  model: InvoiceItemModel
});</pre></div></li><li class="listitem">Initialize a new collection instance and pass the initial array of models.<div class="informalexample"><pre class="programlisting">var invoiceItemCollection = new InvoiceItemCollection
([
  {description: 'Wooden Toy House', price: 22, quantity: 3},
  {description: 'Farm Animal Set', price: 17, quantity: 1},
  {description: 'Farmer Figure', price: 8, quantity: 1},
  {description: 'Toy Tractor', price: 15, quantity: 1}
]);</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec71"/>How it works...</h2></div></div></div><p><code class="literal">Backbone.Collection</code> knows which model object to use when creating new instances, because we specified it in the <code class="literal">model</code> property. Internally, models are stored in the <code class="literal">models</code> array.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec72"/>There's more...</h2></div></div></div><p>We can also initialize a collection with the existing models. Here is how it is done.</p><div class="informalexample"><pre class="programlisting">invoiceItemModel1 = new InvoiceItemModel
  ({
    description: 'Wooden Toy House',
    price: 22,
    quantity: 3
  });
invoiceItemModel2 = new InvoiceItemModel
  ({
    description: 'Farm Animal Set',
    price: 17,
    quantity: 1
  });
var invoiceItemCollection2 = new InvoiceItemCollection
  ([
    invoiceItemModel1,
    invoiceItemModel2
  ]);</pre></div></div></div>
<div class="section" title="Getting a model from a collection by its index"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec31"/>Getting a model from a collection by its index</h1></div></div></div><p>When working with a collection<a class="indexterm" id="id188"/>, we may need to get a<a class="indexterm" id="id189"/> model at the specific index, because it is stored inside the collection.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec73"/>How to do it...</h2></div></div></div><p>Use the <code class="literal">at()</code> method<a class="indexterm" id="id190"/> to get a model from a collection at the specific index.</p><div class="informalexample"><pre class="programlisting">var model = invoiceItemCollection.at(2);
model.get('description'); // Farmer Figure</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec74"/>How it works...</h2></div></div></div><p>Internally, models are stored in the <code class="literal">models</code> array, so the first element starts with a zero index. <code class="literal">Backbone.Collection</code> keeps this array in the accurate state when we add a new model to a collection, remove one model, or perform sorting.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip11"/>Tip</h3><p><span class="strong"><strong>Be careful when sorting a collection</strong></span></p><p>When performing a collection, sorting it can update the model indexes, so the <code class="literal">at()</code> method with the same parameter can get different models before and after sorting.</p></div></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec75"/>There's more...</h2></div></div></div><p>In this section, we are going to learn some interesting details about models in a collection.</p><div class="section" title="Getting an index of a collection model"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec20"/>Getting an index of a collection model</h3></div></div></div><p>To get an index of a model <a class="indexterm" id="id191"/>stored in a collection, use the <code class="literal">indexOf()</code> method<a class="indexterm" id="id192"/> inherited from <code class="literal">Underscore.js</code>.</p><div class="informalexample"><pre class="programlisting">invoiceItemCollection.indexOf(model); // 2</pre></div></div><div class="section" title="Getting an independent copy of a model"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec21"/>Getting an independent copy of a model</h3></div></div></div><p>The model <a class="indexterm" id="id193"/>object that is retrieved from a collection is the same object stored there, so if we modify this object, one object in the collection gets updated.</p><div class="informalexample"><pre class="programlisting">model.set('description', 'Superman Figure');
invoiceItemCollection.at(2).get('description');
// Superman Figure</pre></div><p>If we need to get an independent copy of the model object, we can use the <code class="literal">clone()</code> method<a class="indexterm" id="id194"/> of a returned model. Changing the attributes of the cloned model does not affect the attributes of the original model.</p><div class="informalexample"><pre class="programlisting">var anotherModel = invoiceItemCollection.at(2).clone();
anotherModel.set('description', 'Another Figure');
invoiceItemCollection.at(2).get('description');
// Superman Figure</pre></div></div><div class="section" title="Getting the length of a collection"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec22"/>Getting the length of a collection</h3></div></div></div><p>There is a<a class="indexterm" id="id195"/> way to get the length of a collection. It is done with the help of the <code class="literal">length()</code> method<a class="indexterm" id="id196"/>. The following example gets a collection length and then obtains the last model from the collection:</p><div class="informalexample"><pre class="programlisting">var length = invoiceItemCollection.length; //4
model = invoiceItemCollection.at(length-1);
model.get('description'); // Toy Tractor</pre></div></div></div></div>
<div class="section" title="Getting a model from a collection by its ID"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec32"/>Getting a model from a collection by its ID</h1></div></div></div><p>In our <a class="indexterm" id="id197"/>application, <a class="indexterm" id="id198"/>we may need to request a model from a collection by its ID.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec76"/>How to do it...</h2></div></div></div><p>Follow these steps to get a model from a collection by its ID:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To get a model from a collection by its identifier, use the <a class="indexterm" id="id199"/><code class="literal">get()</code> method.<div class="informalexample"><pre class="programlisting">model = invoiceItemCollection2.get('4ryurtz3m5gn9udi');</pre></div></li><li class="listitem">To get a model from a collection by its client identifier, you can again use the <code class="literal">get()</code> method.<div class="informalexample"><pre class="programlisting">model = invoiceItemCollection.get('c4');
model.get('description'); // Toy Tractor</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec77"/>How it works...</h2></div></div></div><p>When getting<a class="indexterm" id="id200"/> a model by its ID, <code class="literal">Backbone.Collection</code> searches for the model in the <code class="literal">_byId</code> array, which stores models mapped to their IDs. Such an <a class="indexterm" id="id201"/>implementation guarantees the best performance, because there is no need to loop through all the models in a collection.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec78"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Extending an application with plugins</em></span> in <a class="link" href="ch02.html" title="Chapter 2. Models">Chapter 2</a>, <span class="emphasis"><em>Models</em></span></li></ul></div></div></div>
<div class="section" title="Adding a model to a collection"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec33"/>Adding a model to a collection</h1></div></div></div><p>In this <a class="indexterm" id="id202"/>recipe, we are going to learn different ways of adding <a class="indexterm" id="id203"/>new models to a collection.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec79"/>How to do it...</h2></div></div></div><p>Call the <code class="literal">add()</code> method<a class="indexterm" id="id204"/> to add a new model to the end of a collection.</p><div class="informalexample"><pre class="programlisting">invoiceItemCollection.add
  ({
    description: 'Toy Track',
    price: 10,
    quantity: 1
  });</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec80"/>How it works...</h2></div></div></div><p>The code in the <code class="literal">add()</code> method prevents duplicates from being added to the collection. A unique model is inserted into the <code class="literal">models</code> array and is mapped to its ID in the <code class="literal">_byId</code> array. Also, a reference to the collection is created in the model object in the <code class="literal">collection</code> property.</p><p>By default, a new model is added to the end of the collection. But in case sorting is enabled, or insertion index is specified, the model can be inserted at a different position.</p><p>When adding a new model to a collection, the <code class="literal">add</code> event is being triggered.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec81"/>There's more...</h2></div></div></div><p>In this section, we are going to learn different ways to add a model(s) into a collection.</p><div class="section" title="Adding a model at a specific position"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec23"/>Adding a model at a specific position</h3></div></div></div><p>To add a model <a class="indexterm" id="id205"/>at a specific position, we need to pass <code class="literal">{at: index}</code> as an option.</p><div class="informalexample"><pre class="programlisting">invoiceItemCollection.add
  (
    {description: 'Fisherman Hut', price: 15, quantity: 1},
    {at: 0}
  );
invoiceItemCollection.at(0).get('description');
// Fisherman Hut</pre></div></div><div class="section" title="Adding multiple models"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec24"/>Adding multiple models</h3></div></div></div><p>We <a class="indexterm" id="id206"/>can <a class="indexterm" id="id207"/>also add multiple models at the same time.</p><div class="informalexample"><pre class="programlisting">invoiceItemCollection.add
  ([
    {description: 'Powerboat', price: 12, quantity: 1},
    {description: 'Jet Ski', price: 12, quantity: 1}
  ]);</pre></div></div><div class="section" title="Adding existing models"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec25"/>Adding existing models</h3></div></div></div><p>We can<a class="indexterm" id="id208"/> also use existing model objects as the arguments<a class="indexterm" id="id209"/> for the <code class="literal">add()</code> method. We can pass a single object as well as an array of existing objects.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec82"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Handling events of Backbone objects</em></span> in <a class="link" href="ch05.html" title="Chapter 5. Events and Bindings">Chapter 5</a>, <span class="emphasis"><em>Events and Bindings</em></span></li></ul></div></div></div>
<div class="section" title="Removing a model from a collection"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec34"/>Removing a model from a collection</h1></div></div></div><p>In this recipe, <a class="indexterm" id="id210"/>we are going to learn about removing <a class="indexterm" id="id211"/>a model from a collection.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec83"/>How to do it...</h2></div></div></div><p>Call the <code class="literal">remove()</code> method<a class="indexterm" id="id212"/> to remove a model from a collection.</p><div class="informalexample"><pre class="programlisting">invoiceItemCollection.remove(['c0', 'c1', 'c2', 'c3']);</pre></div><p>Here we can pass the model's <code class="literal">id</code>, <code class="literal">cid</code>, or even the model object as a parameter. We can either pass a single value or an array of values.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec84"/>How it works...</h2></div></div></div><p>When<a class="indexterm" id="id213"/> calling the <code class="literal">remove()</code> method, a model is removed <a class="indexterm" id="id214"/>from the <code class="literal">models</code> array, and any references between them are removed as well. Thus, the model object itself is not destroyed, and we can still work with it if the need arises.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec85"/>There's more...</h2></div></div></div><p>Sometimes, we may need to delete all the existing models from a collection and add some others. There is a useful <code class="literal">reset()</code> method<a class="indexterm" id="id215"/>, which does both these jobs simultaneously. Here is how it works.</p><div class="informalexample"><pre class="programlisting">invoiceItemCollection.reset   ([
    {description: 'Wooden Toy House', price: 22, quantity: 3},
    {description: 'Farm Animal Set', price: 17, quantity: 1}
  ]);</pre></div></div></div>
<div class="section" title="Working with a collection as a stack or as a queue"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec35"/>Working with a collection as a stack or as a queue</h1></div></div></div><p>There are special methods in<a class="indexterm" id="id216"/> Backbone that allow working with a collection as a stack or as a queue.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec86"/>How to do it...</h2></div></div></div><p>Follow these steps to<a class="indexterm" id="id217"/> work with <a class="indexterm" id="id218"/>a collection as a<a class="indexterm" id="id219"/> stack or as a queue:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Call the <code class="literal">push()</code> method<a class="indexterm" id="id220"/> to add a model to the end of a collection.<div class="informalexample"><pre class="programlisting">invoiceItemCollection.push(model);</pre></div></li><li class="listitem">Call the <code class="literal">pop()</code> method<a class="indexterm" id="id221"/> to remove and return the last model from a collection.<div class="informalexample"><pre class="programlisting">model = invoiceItemCollection.pop();</pre></div></li><li class="listitem">Call the <code class="literal">unshift()</code> method<a class="indexterm" id="id222"/> to add a model at the beginning of a collection.<div class="informalexample"><pre class="programlisting">invoiceItemCollection.unshift(model);</pre></div></li><li class="listitem">Call the <code class="literal">shift()</code> method<a class="indexterm" id="id223"/> to remove and return the first model from a collection.<div class="informalexample"><pre class="programlisting">model = invoiceItemCollection.shift();</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec87"/>How it works...</h2></div></div></div><p>To organize<a class="indexterm" id="id224"/> a stack also known as LIFO (last in, first out), we need to use the <code class="literal">push</code> and <code class="literal">pop</code> (<code class="literal">unshift</code> and <code class="literal">shift</code>) methods. To organize a queue also known as FIFO (first in, first out), we need to use the <code class="literal">unshift</code> and <code class="literal">pop</code> (<code class="literal">push</code> and <code class="literal">shift</code>) methods.</p><p>The following image illustrates the difference between a stack and a queue:</p><div class="mediaobject"><img alt="How it works..." src="graphics/2728OS_03_01.jpg"/></div></div></div>
<div class="section" title="Sorting a collection"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec36"/>Sorting a collection</h1></div></div></div><p><code class="literal">Backbone.js</code> provides<a class="indexterm" id="id225"/> a sorting mechanism, out of the box, which we are going to learn in this recipe.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec88"/>How to do it...</h2></div></div></div><p>Follow these steps to sort a collection:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Assign the <code class="literal">comparator</code> callback to the <code class="literal">comparator</code> property of a collection to maintain the correct order.<div class="informalexample"><pre class="programlisting">invoiceItemCollection.comparator = function(model)
  {
    return model.get("price");
  };</pre></div></li><li class="listitem">The <code class="literal">comparator</code> callback accepts a single parameter, which is a model object. It should return a value according to which the collection is sorted.</li><li class="listitem">Optionally, call the <code class="literal">sort()</code> method to force sorting.<div class="informalexample"><pre class="programlisting">invoiceItemCollection.sort();</pre></div></li><li class="listitem">Check the result.<div class="informalexample"><pre class="programlisting">invoiceItemCollection.pluck("price"); // [8, 15, 17, 22]</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec89"/>How it works...</h2></div></div></div><p>When the <code class="literal">comparator</code> callback<a class="indexterm" id="id226"/> is defined, Backbone uses it to insert a new model in the <code class="literal">models</code> array <a class="indexterm" id="id227"/>so that it is inserted in the correct order.</p><p>If you assign a new <code class="literal">comparator</code> callback to a collection with existing models, you need to trigger sorting manually by calling the <a class="indexterm" id="id228"/>
<code class="literal">sort()</code> method.</p><p>You also need to call the <code class="literal">sort()</code> method if the model in the collection gets updated. This can be done automatically if you bind sorting on the model's <code class="literal">change</code> event.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec90"/>There's more...</h2></div></div></div><p>In this section, we are going to define a comparator in a different way.</p><div class="section" title="Comparing a pair of models in the comparator"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec26"/>Comparing a pair of models in the comparator</h3></div></div></div><p>Another way to <a class="indexterm" id="id229"/>implement a comparator is to evaluate a pair of models passed as parameters and return one of the following values:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">-1 (or any negative value), if the first model should come before the second</li><li class="listitem" style="list-style-type: disc">0, if they are of the same rank</li><li class="listitem" style="list-style-type: disc">1 (or any positive value), if the first model should come after the second</li></ul></div><p>The following example demonstrates sorting by the length of the <code class="literal">description</code> attribute:</p><div class="informalexample"><pre class="programlisting">invoiceItemCollection.comparator = function(m1, m1)
  {
    return m1.get("description").length -
    m2.get("description").length;
  };
invoiceItemCollection.sort();
invoiceItemCollection.pluck("description");
// ["Toy Tractor", "Farmer Figure", "Farm Animal Set",
// "Wooden Toy </pre></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec91"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Handling events of Backbone objects</em></span> in <a class="link" href="ch05.html" title="Chapter 5. Events and Bindings">Chapter 5</a>, <span class="emphasis"><em>Events and Bindings</em></span></li></ul></div></div></div>
<div class="section" title="Filtering models in a collection"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec37"/>Filtering models in a collection</h1></div></div></div><p>Backbone <a class="indexterm" id="id230"/>provides a simple filtering mechanism out of the box,<a class="indexterm" id="id231"/> which we can use.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec92"/>How to do it...</h2></div></div></div><p>To filter models in a collection, use the <code class="literal">where()</code> method<a class="indexterm" id="id232"/>. It accepts a search criteria and returns an array of found models.</p><div class="informalexample"><pre class="programlisting">var result = invoiceItemCollection.where({quantity: 1});
// Result is just an array of models, so let's create
// new collection.
var resultCollection = new InvoiceItemCollection(result);
resultCollection.pluck('quantity'); // [1, 1, 1]</pre></div><p>It is also possible to pass multiple criteria together.</p><div class="informalexample"><pre class="programlisting">invoiceItemCollection.where({quantity: 1, price: 10});</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec93"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Refer to the <span class="emphasis"><em>Running No SQL queries on a collection</em></span> recipe to learn more about advanced filtering</li></ul></div></div></div>
<div class="section" title="Iterating through a collection"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec38"/>Iterating through a collection</h1></div></div></div><p>In this recipe, <a class="indexterm" id="id233"/>we are going to discuss various ways of iterating through a collection to implement the functionality we need.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec94"/>How to do it...</h2></div></div></div><p>The easiest way to iterate through a collection is to use the <code class="literal">each()</code> method<a class="indexterm" id="id234"/> provided by <code class="literal">Underscore.js</code>.</p><div class="informalexample"><pre class="programlisting">var  descriptions_txt = '';
invoiceItemCollection.each(function(model, index, list)
  {
    descriptions_txt += descriptions_txt ? ', ' : ''; 
    descriptions_txt += model.get('description');
  });
descriptions_txt; // Wooden Toy House, Farm Animal Set</pre></div><p>In the <code class="literal">each()</code> method, we pass an iterator function, which is executed for each model. It accepts the following parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>model</strong></span>: The model that is being iterated</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>index</strong></span>: This is the model index</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>list</strong></span>: This is the whole model array</li></ul></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec95"/>How it works...</h2></div></div></div><p><code class="literal">Backbone.js</code> is based on <code class="literal">Underscore.js</code>, which provides various useful tools, including methods to work with the collections and arrays. Backbone collections support some of those functions.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec96"/>There's more...</h2></div></div></div><p>In this section, we are going to learn some methods <a class="indexterm" id="id235"/>that rely on the iteration method but are more specific.</p><div class="section" title="Checking every model to match a specific condition"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec27"/>Checking every model to match a specific condition</h3></div></div></div><p>To check every model in<a class="indexterm" id="id236"/> a collection that fulfills a specific criteria, use the <code class="literal">every()</code> method<a class="indexterm" id="id237"/>. It accepts a callback parameter which should return a <code class="literal">Boolean</code> value if the condition is fulfilled.</p><div class="informalexample"><pre class="programlisting">var multiple = invoiceItemCollection.every(function(model)
  {
    return model.get('quantity') &gt; 1;
  });
multiple; // false</pre></div></div><div class="section" title="Checking any model to match a specific condition"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec28"/>Checking any model to match a specific condition</h3></div></div></div><p>To check any model in a collection<a class="indexterm" id="id238"/> that fulfills a specific criteria, use the <code class="literal">some()</code> method<a class="indexterm" id="id239"/>. It accepts a callback parameter which should return a <code class="literal">Boolean</code> value if the condition is fulfilled.</p><div class="informalexample"><pre class="programlisting">var multiple = invoiceItemCollection.some(function(model)
  {
    return model.get('quantity') &gt; 1;
});
multiple; // true</pre></div></div><div class="section" title="Getting the attribute from each model in a collection"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec29"/>Getting the attribute from each model in a collection</h3></div></div></div><p>In the previous examples, <a class="indexterm" id="id240"/>we used the <code class="literal">pluck()</code> method<a class="indexterm" id="id241"/>, which returns an array of values for the specified attribute from each model in a collection. Let's see how it works.</p><div class="informalexample"><pre class="programlisting">var descriptions = invoiceItemCollection.pluck("description");
descriptions; // ["Wooden Toy House", "Farm Animal Set"]</pre></div></div><div class="section" title="Performing specific calculations to each model in a collection"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec30"/>Performing specific calculations to each model in a collection</h3></div></div></div><p>To perform specific calculations <a class="indexterm" id="id242"/>to each model in a collection, use the <code class="literal">map()</code> method<a class="indexterm" id="id243"/>. It takes callback as a parameter, executes it for each model in a collection, and returns an array of results.</p><div class="informalexample"><pre class="programlisting">var amounts = invoiceItemCollection.map(function(model)
  {
    return model.get('quantity') * model.get('price');
  });
amounts; // [66, 77]</pre></div></div><div class="section" title="Boiling down models in a collection into a single value"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec31"/>Boiling down models in a collection into a single value</h3></div></div></div><p>Models in a collection can be <a class="indexterm" id="id244"/>boiled down to a single value using the <code class="literal">reduce()</code> method<a class="indexterm" id="id245"/>. Here is how it works.</p><div class="informalexample"><pre class="programlisting">var count = invoiceItemCollection.reduce(function(memo,model)
  {
    return memo + model.get('quantity');
  }, 0);
count; // 4</pre></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec97"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">There are many helpful methods from <code class="literal">Underscore.js</code> that can be used with Backbone collections. You can find them in <code class="literal">Underscore.js</code> official docs from <a class="ulink" href="http://documentcloud.github.com/underscore/#collections">http://documentcloud.github.com/underscore/#collections</a>.</li></ul></div></div></div>
<div class="section" title="Chaining a collection"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec39"/>Chaining a collection</h1></div></div></div><p>If you <a class="indexterm" id="id246"/>want to perform several Underscore methods in a row, a good way of doing it is by chaining one method to the other method.</p><p>Let's consider a simple MapReduce example, which calculates the total amount.</p><div class="informalexample"><pre class="programlisting">var amounts = invoiceItemCollection.map(function(model)
  {
    return model.get('quantity') * model.get('price');
  });
// [66, 77]
var total_amount = _.reduce(amounts, function(memo, val)
  {
    return memo + val;
  }, 0);
total_amount; // 83</pre></div><p>Here, <code class="literal">amounts</code> is a JavaScript array, and it does not provide the <code class="literal">reduce()</code> method that we can call. To solve this problem, we are calling the <code class="literal">reduce()</code> method provided by <code class="literal">Underscore.js</code>, which takes an array as the first parameter.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec98"/>How to do it…</h2></div></div></div><p>With chaining, it<a class="indexterm" id="id247"/> is possible to call one method right after another using the <code class="literal">dot</code> syntax. Here is an example.</p><div class="informalexample"><pre class="programlisting">var amount = invoiceItemCollection.chain()
.map(function(model)
  {
    return model.get('quantity') * model.get('price');
  })
.reduce(function(memo, val)
  {
    return memo + val;
  })
.value(); // 83</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec99"/>How it works...</h2></div></div></div><p>The <code class="literal">chain()</code> method<a class="indexterm" id="id248"/> wraps a value into an object, which provides different methods that can be executed, which return their result as a wrapped value. To unwrap a result, use the<a class="indexterm" id="id249"/> <code class="literal">value()</code> method.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec100"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To see more chaining examples, please visit <a class="ulink" href="http://documentcloud.github.com/underscore/#chain">http://documentcloud.github.com/underscore/#chain</a></li></ul></div></div></div>
<div class="section" title="Running No SQL queries on a collection"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec40"/>Running No SQL queries on a collection</h1></div></div></div><p>In the previous<a class="indexterm" id="id250"/> recipe we described several techniques, including the one about searching the models in a collection with the <code class="literal">where()</code> method.</p><p>There are more advanced ways of searching the models in a collection, which can be done with the help of a Backbone extension named <span class="strong"><strong>Backbone Query</strong></span><a class="indexterm" id="id251"/>. It allows running No SQL (such as MongoDB) queries for searching, sorting, and paging the models in a collection.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec101"/>Getting ready</h2></div></div></div><p>You can download the<a class="indexterm" id="id252"/> Backbone Query extension from its GitHub page by going to <a class="ulink" href="https://github.com/davidgtonge/backbone_query">https://github.com/davidgtonge/backbone_query</a>. To include this extension into your project, save the <code class="literal">backbone-query.js</code> file into the <code class="literal">lib</code> folder and include the reference to it in <code class="literal">index.html</code>.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note10"/>Note</h3><p>Including the Backbone extension into your project is described in detail in the <span class="emphasis"><em>Extending an application with plugins</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Backbone">Chapter 1</a>, <span class="emphasis"><em>Understanding Backbone</em></span>.</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec102"/>How to do it...</h2></div></div></div><p>Follow these<a class="indexterm" id="id253"/> steps to perform a No SQL query<a class="indexterm" id="id254"/> to a collection:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To allow a No SQL query to be executed, extend a collection from the <code class="literal">Backbone.QueryCollection</code> object instead of a <code class="literal">Backbone.Collection</code> one.<div class="informalexample"><pre class="programlisting">var BuyerCollection = Backbone.QueryCollection.extend
  ({
    model: BuyerModel
  });</pre></div></li><li class="listitem">Run the <a class="indexterm" id="id255"/>query with the <code class="literal">query()</code> method.<div class="informalexample"><pre class="programlisting">var result = buyerCollection.query({ firstName: 'John' });</pre></div></li><li class="listitem">Optionally, run the <code class="literal">pluck</code> attribute from the resulting array.<div class="informalexample"><pre class="programlisting">var resultCollection = new BuyerCollection(result);
resultCollection.pluck('firstName'); // ["John", "John"]</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec103"/>How it works...</h2></div></div></div><p><code class="literal">Backbone.QueryCollection</code><a class="indexterm" id="id256"/> extends <code class="literal">Backbone.Collection</code> and provides the new <code class="literal">query()</code> method, which parses the base query into subqueries recursively and uses the <code class="literal">reduce()</code> method of <code class="literal">Underscore.js</code> to run queries of the same group sequentially.</p><p>Backbone Query is written initially in CoffeeScript and compiled into JavaScript later. So, if you are interested in understanding its source code, see <code class="literal">backbone-query.coffee</code>. It looks quite similar though.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec104"/>There's more...</h2></div></div></div><p>This section describes No SQL operators<a class="indexterm" id="id257"/> and covers some advanced topics, such as grouping, sorting, paging, and caching.</p><div class="section" title="Using standard operators"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec32"/>Using standard operators</h3></div></div></div><p>The following operators <a class="indexterm" id="id258"/>are common and applied to the attributes of the models stored in a collection.</p><div class="section" title="$equal"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl4sec01"/>$equal</h4></div></div></div><p>This <a class="indexterm" id="id259"/>performs<a class="indexterm" id="id260"/> a strict equality test using <code class="literal">===</code>.</p><div class="informalexample"><pre class="programlisting">buyerCollection.query({ firstName: {$equal: 'John'} });</pre></div><p>If no operator is provided, and the query value is neither a regex nor an array, then <code class="literal">$equal</code> is assumed.</p><div class="informalexample"><pre class="programlisting">buyerCollection.query({ firstName: 'John' });</pre></div></div><div class="section" title="$ne"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl4sec02"/>$ne</h4></div></div></div><p>This means<a class="indexterm" id="id261"/> not equal, <a class="indexterm" id="id262"/>which is the opposite of <code class="literal">$equal</code>, and returns all the models that are not equal to the query value.</p><div class="informalexample"><pre class="programlisting">buyerCollection.query({ firstName: {$ne: 'John'} });</pre></div></div><div class="section" title="$in"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl4sec03"/>$in</h4></div></div></div><p>An<a class="indexterm" id="id263"/> array<a class="indexterm" id="id264"/> of possible values can be supplied using <code class="literal">$in</code>; a model will be returned if any of the supplied values is matched.</p><div class="informalexample"><pre class="programlisting">buyerCollection.query({ firstName: {$in: ['John', 'Joe','Patrick']} });</pre></div></div><div class="section" title="$nin"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl4sec04"/>$nin</h4></div></div></div><p>This <a class="indexterm" id="id265"/>means <a class="indexterm" id="id266"/>not in, which is the opposite of <code class="literal">$in</code>, and a model will be returned if none of the supplied values is matched.</p><div class="informalexample"><pre class="programlisting">buyerCollection.query
({ firstName: {$nin: ['Samuel', 'Victor']} });</pre></div></div><div class="section" title="$exists or $has"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl4sec05"/>$exists or $has</h4></div></div></div><p>This<a class="indexterm" id="id267"/> checks<a class="indexterm" id="id268"/> for the existence <a class="indexterm" id="id269"/>of an attribute, and can be <a class="indexterm" id="id270"/>supplied as either <code class="literal">true</code> or <code class="literal">false</code>.</p><div class="informalexample"><pre class="programlisting">buyerCollection.query({ middleName: {$exists: true} });

buyerCollection.query({ middleName: {$has: false} });</pre></div></div></div><div class="section" title="Combining queries"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec33"/>Combining queries</h3></div></div></div><p>Multiple queries can <a class="indexterm" id="id271"/>be combined together. There are the <code class="literal">$and</code>, <code class="literal">$or</code>, <code class="literal">$nor</code>, and <code class="literal">$not</code> operators, which we are going to learn shortly.</p><div class="section" title="$and"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl4sec06"/>$and</h4></div></div></div><p>This is a <a class="indexterm" id="id272"/>logical AND operator. The following <a class="indexterm" id="id273"/>query selects all the buyers named John and who live in Alexandria:</p><div class="informalexample"><pre class="programlisting">buyerCollection.query({ $and: {firstName: 'John', city: 'Alexandria'}});</pre></div><p>The <code class="literal">$and</code> operator is used as a glue if no combining operator is supplied.</p><div class="informalexample"><pre class="programlisting">buyerCollection.query
({ firstName: 'John', city: 'Alexandria' });</pre></div></div><div class="section" title="$or"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl4sec07"/>$or</h4></div></div></div><p>This is<a class="indexterm" id="id274"/> a <a class="indexterm" id="id275"/>logical OR operator. The following query selects all the buyers named John or whether the buyers live in Alexandria:</p><div class="informalexample"><pre class="programlisting">buyerCollection.query
({ $or: {firstName: 'John', city: 'Alexandria'}});</pre></div></div><div class="section" title="$nor"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl4sec08"/>$nor</h4></div></div></div><p>This is the <a class="indexterm" id="id276"/>opposite <a class="indexterm" id="id277"/>of <code class="literal">$or</code>. The following query selects all the buyers with a name other than John or if they do not live in Alexandria:</p><div class="informalexample"><pre class="programlisting">buyerCollection.query
({ $nor: {firstName: 'John', city: 'Alexandria'}});</pre></div></div><div class="section" title="$not"><div class="titlepage"><div><div><h4 class="title"><a id="ch03lvl4sec09"/>$not</h4></div></div></div><p>This is <a class="indexterm" id="id278"/>the <a class="indexterm" id="id279"/>opposite of <code class="literal">$and</code>. The following query selects all buyers except anyone whose name is John and who lives in Alexandria:</p><div class="informalexample"><pre class="programlisting">buyerCollection.query
({ $not: {firstName: 'John', city: 'Alexandria'}});</pre></div></div></div><div class="section" title="Multiple queries on the same key"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec34"/>Multiple queries on the same key</h3></div></div></div><p>If we need to perform multiple queries<a class="indexterm" id="id280"/> on the same key, then we can supply the query as an array. The following query returns all the clients with the name John or Joe:</p><div class="informalexample"><pre class="programlisting">buyerCollection.query
  ({
    $or:[
      { firstName: 'John' },
      { firstName: 'Joe' }
    ]
  });</pre></div></div><div class="section" title="Sorting query results"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec35"/>Sorting query results</h3></div></div></div><p>To sort results by a property,<a class="indexterm" id="id281"/> we need to pass it with the <code class="literal">sortBy</code> key in a second argument. We can also specify the order by passing the <code class="literal">asc</code> or <code class="literal">desc</code> value with the <code class="literal">sort</code> key. By default, <code class="literal">asc</code> is assumed as the value. The following code shows how sorting is done:</p><div class="informalexample"><pre class="programlisting">result = buyerCollection.query
  (
    { firstName: {$like: 'John'} },
    { sortBy: 'lastName', order: 'desc' }
  );
resultCollection = new BuyerCollection(result);
resultCollection.pluck('lastName'); // ["Smith", "Doe"]</pre></div></div><div class="section" title="Paging query results"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec36"/>Paging query results</h3></div></div></div><p>There is a way to<a class="indexterm" id="id282"/> split a big result array on several pages and return a specified one. Let's see how it is done.</p><div class="informalexample"><pre class="programlisting">buyerCollection.query
({firstName: 'John'}, {limit:10, offset:1, page:2});</pre></div><p>We can specify the following properties in the second parameter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">limit</code>: It limits the resulting array size to a given number. The first N elements are returned. It is a required property.</li><li class="listitem" style="list-style-type: disc"><code class="literal">page</code>: It returns a specified resulting page. The page size is set by the limit property. It is an optional property.</li><li class="listitem" style="list-style-type: disc"><code class="literal">offset</code>: It skips the first N result items. It is an optional property.</li></ul></div></div><div class="section" title="Caching results"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec37"/>Caching results</h3></div></div></div><p>For performance reasons,<a class="indexterm" id="id283"/> we may want to cache our results. This can greatly decrease the query execution time, especially if using paging, because unpaged results are saved in the cache and a user can quickly navigate through its pages.</p><p>To enable caching, simply use the <code class="literal">cache</code> property in the second parameter.</p><div class="informalexample"><pre class="programlisting">buyerCollection.query
({firstName: 'John'}, {limit:10, page:2, cache: true});</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip12"/>Tip</h3><p>Caching is not set by default, because there is no automatic way to flush the cache, so when caching is enabled and the collection is being updated, the cache becomes outdated.</p><p>You should be aware of this problem, and manually perform cache flushing every time the collections or models in it are updated. This can be done by calling the <code class="literal">reset_query_cache()</code> method.</p></div></div><p>We can bind the collection's <code class="literal">change</code> event to the <code class="literal">reset_query_cache()</code> method, and thus, provide automatic cache flushing when the collection gets updated.</p><div class="informalexample"><pre class="programlisting">var BuyerCollection = Backbone.QueryCollection.extend
  ({
    initialize: function(){
      this.bind('change', this.reset_query_cache, this);
    }
  });</pre></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec105"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Please see more information about Backbone query operators from <a class="ulink" href="https://github.com/davidgtonge/backbone_query#query-api">https://github.com/davidgtonge/backbone_query#query-api</a></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Handling events of Backbone objects</em></span> in <a class="link" href="ch05.html" title="Chapter 5. Events and Bindings">Chapter 5</a>, <span class="emphasis"><em>Events and Bindings</em></span></li></ul></div></div></div>
<div class="section" title="Storing models of various types in the same collection"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec41"/>Storing models of various types in the same collection</h1></div></div></div><p>When building<a class="indexterm" id="id284"/> complex Backbone applications, you may<a class="indexterm" id="id285"/> need to work with models of different types, which should be processed in a similar way, so you may want them to be stored in the same collection. Fortunately, there is a <code class="literal">Backbone.Chosen</code> extension<a class="indexterm" id="id286"/> that allow us to do so.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec106"/>Getting ready</h2></div></div></div><p>You can find and download <code class="literal">Backbone.Chosen</code> from the following page: <a class="ulink" href="https://github.com/asciidisco/Backbone.Chosen">https://github.com/asciidisco/Backbone.Chosen</a>. To include <code class="literal">Backbone.Chosen</code> into your project, save the <code class="literal">backbone.chosen.js</code> file into the <code class="literal">lib</code> folder and include the reference to it in <code class="literal">index.html</code>.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note11"/>Note</h3><p>Including Backbone extension into your project is described in detail in the <span class="emphasis"><em>Extending an application with plugins</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Backbone">Chapter 1</a>, <span class="emphasis"><em>Understanding Backbone</em></span>.</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec107"/>How to do it...</h2></div></div></div><p>Let's say we have two different model classes, namely <code class="literal">IndividualContactModel</code><a class="indexterm" id="id287"/> and <code class="literal">OrganizationContactModel</code><a class="indexterm" id="id288"/>, and we want to organize them into a single collection. We can do this by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Define models.<div class="informalexample"><pre class="programlisting">var IndividualContactModel = Backbone.Model.extend
  ({
    name: function() {
      return this.get('firstName') + ' ' + this.get('lastName');
    }
  });

var OrganizationContactModel = Backbone.Model.extend
  ({
    name: function() {
      return this.get('businessName') + ', '
      + this.get('businessType');
    }
  });</pre></div><p>As we can see, these models have different attributes, but share a common <a class="indexterm" id="id289"/>
<code class="literal">name()</code> method.</p></li><li class="listitem">Define<a class="indexterm" id="id290"/> collection with a <code class="literal">chosen</code> attribute.<div class="informalexample"><pre class="programlisting">var ContactCollection = Backbone.Collection.extend
  ({
    model: {
      // Pass chosen properties.
      chosen: {
          // Attribute that should contain model type.
          attr: 'type',

          // Default model class.
          defaults: IndividualContactModel,

          // Mapping attribute values to model classes.
          map: {
            individual: IndividualContactModel,
            organization: OrganizationContactModel
          }
        }
      }
  });</pre></div></li><li class="listitem">Create a <a class="indexterm" id="id291"/>collection instance and specify the mapping attribute in the incoming JSON.<div class="informalexample"><pre class="programlisting">var contactCollection = new ContactCollection
  ([
    {
      firstName: 'John',
      lastName: 'Smith',
      type: 'individual'
    },
    {
      businessName: 'North American Veeblefetzer',
      businessType: 'LLC',
      type: 'organization'
    }
  ]);</pre></div></li><li class="listitem">Check <a class="indexterm" id="id292"/>the result. The newly added models to the collection should be the instance of the correct model class.<div class="informalexample"><pre class="programlisting">contactCollection.at(0) instanceof IndividualContactModel;
//true

contactCollection.at(0).name(); // John Smith

contactCollection.at(1) instanceof OrganizationContactModel;
//true

contactCollection.at(1).name();
// North American Veeblefetzer, LLC</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec108"/>How it works...</h2></div></div></div><p><code class="literal">Backbone.Chosen</code> overrides <a class="indexterm" id="id293"/>the <code class="literal">_prepareModel</code> method of <code class="literal">Backbone.Collection</code> to select the proper model object that depends on its mapping attribute value.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec109"/>There's more...</h2></div></div></div><p>This section explains<a class="indexterm" id="id294"/> how to perform advanced mapping.</p><div class="section" title="Mapping deeply nested attributes"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec38"/>Mapping deeply nested attributes</h3></div></div></div><p><code class="literal">Backbone.Chosen</code> also <a class="indexterm" id="id295"/>supports nested attributes. You can specify the value for the <code class="literal">attr</code> property with a <code class="literal">dot</code> syntax, for example, <code class="literal">options.type</code>, if your incoming JSON looks like the following code:</p><div class="informalexample"><pre class="programlisting">var contactCollection = new ContactCollection
  ([
    {
      firstName: 'John',
      lastName: 'Smith',
      options: {type: 'individual'}
    },
    {
      businessName: 'North American Veeblefetzer',
      businessType: 'LLC',
      options: {type: 'organization'}
    }
  ]);</pre></div></div><div class="section" title="Use a function to map the models"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec39"/>Use a function to map the models</h3></div></div></div><p>Sometimes, we may need<a class="indexterm" id="id296"/> to use more complex calculations to map the models. This can be done with the help of the mapping function. Here is how it is done.</p><div class="informalexample"><pre class="programlisting">// Set up a collection
var ContactCollection = Backbone.Collection.extend({
  model: {
    chosen: function (rawData) {
      if (rawData.spice === 'salt') {
        return SaltyModel;
        }
      if (rawData.spice === 'sugar') {
        return SweetyModel;
        }
      return BoringModel;
      }
    }
  });</pre></div></div></div></div>
<div class="section" title="Implementing a one-to-many relationship"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec42"/>Implementing a one-to-many relationship</h1></div></div></div><p>In <a class="link" href="ch02.html" title="Chapter 2. Models">Chapter 2</a>, <span class="emphasis"><em>Models</em></span>, there <a class="indexterm" id="id297"/>is a recipe about creating a one-to-one relationship between two models. In this recipe, we are going to learn about creating one-to-many relationships.</p><p>A one-to-many relationship <a class="indexterm" id="id298"/>can be used if the association between a single model and a collection of models of another type takes place. In our invoice application, the relationship between <code class="literal">InvoiceModel</code> and <code class="literal">InvoiceItemModel</code> is one such relationship. InvoiceItem Model can be multiple and thus is stored in <code class="literal">InvoiceItemCollection</code>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec110"/>Getting ready</h2></div></div></div><p>You can download the Backbone-relational extension<a class="indexterm" id="id299"/> from its GitHub page at <a class="ulink" href="https://github.com/PaulUithol/Backbone-relational">https://github.com/PaulUithol/Backbone-relational</a>. To include <code class="literal">Backbone.Relational</code><a class="indexterm" id="id300"/> into your project, save the <code class="literal">backbone-relational.js</code> file into the <code class="literal">lib</code> folder and include the reference to it in <code class="literal">index.html</code>.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note12"/>Note</h3><p>Including Backbone extension into your project is described in detail in the <span class="emphasis"><em>Extending an application with plugins</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Backbone">Chapter 1</a>, <span class="emphasis"><em>Understanding Backbone</em></span>.</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec111"/>How to do it...</h2></div></div></div><p>Implementation of a<a class="indexterm" id="id301"/> one-to-many relationship is similar to an implementation of a one-to-one relationship, except that we need to use <code class="literal">Backbone.HasMany</code><a class="indexterm" id="id302"/> as a type and specify <code class="literal">collectionType</code>, because multiple models should be stored in the collection. We can do this by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Extend the new model object from <code class="literal">Backbone.RelationalModel</code>.<div class="informalexample"><pre class="programlisting">var InvoiceItemModel = Backbone.RelationalModel.extend
  ({
  });</pre></div></li><li class="listitem">Define the collection for this model type.<div class="informalexample"><pre class="programlisting">var InvoiceItemCollection = Backbone.Collection.extend
  ({
    model: InvoiceItemModel
  });</pre></div></li><li class="listitem">Extend another model object from <code class="literal">Backbone.RelationalModel</code> and pass the <code class="literal">relations</code> property with a relationship definition.<div class="informalexample"><pre class="programlisting">var InvoiceModel = Backbone.RelationalModel.extend
  ({
    // Define one-to-many relationship.
    relations: [{
      // Relationship type
      type: Backbone.HasMany,

      // Relationship key in BuyerModel.
      key: 'items',
      // Related model.
      relatedModel: InvoiceItemModel,

      // Collection to store related models.
      collectionType: InvoiceItemCollection,

      // Define reverse relationship.
      reverseRelation: {
        key: 'invoice'
      }
    }]
  });</pre></div></li><li class="listitem">To<a class="indexterm" id="id303"/> initialize <a class="indexterm" id="id304"/>models with a one-to-many relationship, pass the invoice items' data in a single JSON when creating a new <code class="literal">InvoiceModel</code> object instance.<div class="informalexample"><pre class="programlisting">var invoiceModel = new InvoiceModel
  ({
    referenceNumber: '12345',
    date: '2012-09-01',
    items: [
      { description:'Wooden Toy House', price:22, quantity:3 },
      { description:'Farm Animal Set', price:17, quantity:1 }
    ]
  });

invoiceModel.get('items').at(0).get('description');
// Wooden Toy House

invoiceModel.get('items').at(0).get('invoice')
.get('referenceNumber'); // 12345</pre></div></li><li class="listitem">Add new records into this relation with the help of the <code class="literal">add()</code> method when accessing the related collection using the <code class="literal">items</code> attribute.<div class="informalexample"><pre class="programlisting">// Add new model to a collection
invoiceModel.get('items').add
  ({
    description: 'Powerboat',
    price: 12,
    quantity: 1
  });

invoiceModel.get('items').at(2).get('invoice') == invoiceModel;
// true</pre></div><p>Or we can also create an instance of <code class="literal">invoiceItemModel</code> and set the invoice attribute with an instance of <code class="literal">invoiceModel</code>; thus, a new relation in both the directions will be created.</p><div class="informalexample"><pre class="programlisting">// Add new model
invoiceItemModel = new InvoiceItemModel
  ({
    description: 'Jet Ski',
    price: 12,
    quantity: 1,
    invoice: invoiceModel
  });

invoiceModel.get('items').at(3).get('description');
// Jet Ski</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec112"/>How it works...</h2></div></div></div><p>Each <code class="literal">Backbone.RelationalModel</code><a class="indexterm" id="id305"/> registers itself with <code class="literal">Backbone.Store</code> upon creation, and is <a class="indexterm" id="id306"/>removed from <code class="literal">Store</code> when <a class="indexterm" id="id307"/>destroyed. When creating or updating an attribute that is a key in a relation, the removed related objects are notified of their removal, and new related objects are looked up in <code class="literal">Store</code>.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec113"/>There's more...</h2></div></div></div><p>In this section, we are going to learn some advanced usages of <code class="literal">Backbone.Relational</code>.</p><div class="section" title="Implementing a many-to-many relationship"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec40"/>Implementing a many-to-many relationship</h3></div></div></div><p>There is no way to <a class="indexterm" id="id308"/>create a many-to-many relationship between two models out of the box, but it can be easily done with the help of a pair of one-to-many relationships between those models and a new intermediate model.</p></div><div class="section" title="Exporting related models to JSON"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec41"/>Exporting related models to JSON</h3></div></div></div><p>When<a class="indexterm" id="id309"/> exporting a<a class="indexterm" id="id310"/> model to JSON, it does include related models. This is how we can export <code class="literal">InvoiceModel</code> to JSON.</p><div class="informalexample"><pre class="programlisting">JSON.stringify(invoiceModel.toJSON());</pre></div><p>And here is a result of such an export.</p><div class="informalexample"><pre class="programlisting">{
  "referenceNumber":"12345",
  "date":"2012-09-01",
  "items":[
    {
      "description":"Wooden Toy House","price":22,"quantity":3
    },
    {"description":"Farm Animal Set","price":17,"quantity":1},
    {"description":"Powerboat","price":12,"quantity":1},
    {"description":"Jet Ski","price":12,"quantity":1}
  ]
}</pre></div><p>This is how we can export the <code class="literal">InvoiceItemModel</code> model.</p><div class="informalexample"><pre class="programlisting">JSON.stringify(invoiceModel.get('items').at(0).toJSON())</pre></div><p>And the <a class="indexterm" id="id311"/>result is the following code snippet:</p><div class="informalexample"><pre class="programlisting">{
  "description":"Wooden Toy House",
  "price":22,
  "quantity":3,
  "invoice":{includeInJSON
    "referenceNumber":"12345",
    "date":"2012-09-01",
    "items":[
      null,
      {
        "description":"Farm Animal Set","price":17,
        "quantity":1
      },
      {"description":"Powerboat","price":12,"quantity":1},
      {"description":"Jet Ski","price":12,"quantity":1}
    ]
  }
}</pre></div><p>As we can see, the <code class="literal">toJSON()</code> method<a class="indexterm" id="id312"/> also exports reversed relationships, but we can control the attributes of the related models that need to be exported by specifying an array of such attributes in the <code class="literal">includeInJSON</code> property<a class="indexterm" id="id313"/> for direct and reverse relationships.</p><div class="informalexample"><pre class="programlisting">var InvoiceModel = Backbone.RelationalModel.extend
  ({
    relations: [{
      type: Backbone.HasMany,
      key: 'items',
      relatedModel: InvoiceItemModel,
      collectionType: InvoiceItemCollection,

      // Restrict related models properties when exporting
      // to JSON.
      includeInJSON: ['description', 'price', 'quantity'], 

      reverseRelation: {
        key: 'invoice',

        // Restrict related models properties when exporting
        // to JSON for reversed relations.
        includeInJSON: ['referenceNumber', 'items'],
      }
    }]
  });</pre></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec114"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Implementing a one-to-one relationship</em></span> in <a class="link" href="ch02.html" title="Chapter 2. Models">Chapter 2</a>, <span class="emphasis"><em>Models</em></span></li><li class="listitem" style="list-style-type: disc">More information about exporting to JSON is described in the <span class="emphasis"><em>Synchronizing models and collections with a RESTful service</em></span> recipe in <a class="link" href="ch07.html" title="Chapter 7. REST and Storage">Chapter 7</a>, <span class="emphasis"><em>REST and Storage</em></span></li><li class="listitem" style="list-style-type: disc">A complete documentation of the Backbone-relational extension can be found on its GitHub page at <a class="ulink" href="https://github.com/PaulUithol/Backbone-relational">https://github.com/PaulUithol/Backbone-relational</a></li><li class="listitem" style="list-style-type: disc">Also, there is an alternative to the Backbone-relational extension, which is Backbone-associations</li></ul></div></div></div></body></html>