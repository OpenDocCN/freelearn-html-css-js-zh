<html><head></head><body>
<div><h1 class="chapternumber">19</h1>
<h1 class="chaptertitle" id="_idParaDest-326">SportsStore: Authentication</h1>
<p class="normal1">In this chapter, I will use the OAuth protocol to allow users to use their Google accounts to identify themselves to<a id="_idIndexMarker1006" class="calibre3"/> the <em class="italic">SportsStore</em> application, instead of manually entering their contact details.</p>
<h1 class="heading" id="_idParaDest-327">Preparing for this chapter</h1>
<p class="normal1">This chapter uses the <code class="inlinecode">sportsstore</code> project from <em class="italic">Chapter 18</em>. No changes are required for this chapter. Open a new command prompt, navigate to the <code class="inlinecode">sportsstore</code> folder, and run the command shown in <em class="italic">Listing 19.1</em> to start the development tools.</p>
<div><p class="normal"><strong class="screentext">Tip</strong></p>
<p class="normal">You can download the example project for this chapter – and for all the other chapters in this book – from <a href="https://github.com/PacktPublishing/Mastering-Node.js-Web-Development" class="calibre3">https://github.com/PacktPublishing/Mastering-Node.js-Web-Development</a>. See <em class="italic">Chapter 1</em> for how to get help if you have problems running the examples.</p>
</div>
<p class="packt_figref">Listing 19.1: Starting the development tools</p>
<pre class="programlisting1"><code class="hljs-con">npm start
</code></pre>
<p class="normal">Open a <a id="_idIndexMarker1007" class="calibre3"/>new browser window, navigate to <code class="inlinecode">http://localhost:5000</code>, and you will see the product catalog, as shown in <em class="italic">Figure 19.1</em>.</p>
<figure class="mediaobject"><img alt="" src="img/B21959_19_01.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 19.1: Running the application</p>
<h1 class="heading" id="_idParaDest-328">Understanding the OAuth authentication process</h1>
<p class="normal1">OAuth<a id="_idIndexMarker1008" class="calibre3"/> allows users to grant applications access to their data without <a id="_idIndexMarker1009" class="calibre3"/>needing to provide their credentials to that application. During development, the developer registers their application with an OAuth authentication service and receives an ID that is used to identify the application to the service, as well as a secret that is used to sign and verify messages between the application and the service.</p>
<p class="normal">The<a id="_idIndexMarker1010" class="calibre3"/> registration process establishes the relationship between the application and the authentication service. Registration is done once and is performed before the application is deployed. Some degree of vetting may be required. The SportsStore application uses the Google OAuth service, which makes its basic features – such as the ones used in this chapter – available immediately, but reviews applications before more sensitive data can be accessed, and this can take days or weeks to complete.</p>
<p class="normal">Once the <a id="_idIndexMarker1011" class="calibre3"/>application is deployed, the user is presented with a button that offers them the option to sign in to the application with the authentication provider, or grant the application access to the data stored by the provider. <em class="italic">Figure 19.2</em> shows the simple example button added to the SportsStore application later in the chapter, which grants the application access to the user’s basic information, such as their name and email address.</p>
<figure class="mediaobject"><img alt="" src="img/B21959_19_02.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 19.2: The OAuth button that will be added to the SportsStore application</p>
<p class="normal">When the <a id="_idIndexMarker1012" class="calibre3"/>user clicks the button, the browser will be redirected to a URL that starts the authentication process. The user will be prompted for their credentials, which are not revealed to the application. The authentication process will show the user which application they are signing into and the data that the application has asked for. <em class="italic">Figure 19.3</em> shows the <a id="_idIndexMarker1013" class="calibre3"/>authentication prompt that will be shown to users of <em class="italic">SportsStore</em> once OAuth has been configured later in this chapter.</p>
<figure class="mediaobject"><img alt="" src="img/B21959_19_03.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 19.3: Authenticating with the OAuth service</p>
<p class="normal">Once the <a id="_idIndexMarker1014" class="calibre3"/>user has authenticated themselves, their <a id="_idIndexMarker1015" class="calibre3"/>browser is redirected back to the application, using a URL that contains an access code. The application sends an HTTP request directly to Google and exchanges the access code for the data it requires.</p>
<h2 class="heading1" id="_idParaDest-329">Understanding the advantages of OAuth</h2>
<p class="normal1">From the <a id="_idIndexMarker1016" class="calibre3"/>user’s perspective, OAuth allows them to use applications and services without having to create accounts on each one or repeatedly entering the same details. From the developer’s perspective, OAuth enables authentication without having to implement and manage the workflows for password recovery, two-factor authentication, and so on.</p>
<p class="normal">These advantages apply when using the OAuth services provided by big technology and social media companies. There are also OAuth services that you can use to manage just the user accounts for your application, in which case users will still have to create accounts, but the authentication process and the workflows are implemented by the OAuth provider. The most popular service is <a href="https://auth0.com" class="calibre3">https://auth0.com</a>, but there are alternatives, and most offer free and paid-for tiers of service. </p>
<h2 class="heading1" id="_idParaDest-330">Understanding the limitations of OAuth</h2>
<p class="normal1">Users will <a id="_idIndexMarker1017" class="calibre3"/>not always be willing to associate their account data with an application. This can be because they don’t trust the application, or that they don’t want their account associated with certain types of content. You may find that users are reluctant to use OAuth If you provide adult content of any sort, for example.</p>
<p class="normal">From the developer’s perspective, the main limitation of OAuth is the complexity of the initial setup. Even with a good authentication package, like the one used in this chapter, OAuth rarely works without some tinkering, and figuring out why authentication isn’t working can be a slow and confusing task. </p>
<h1 class="heading" id="_idParaDest-331">Creating the Google OAuth credentials</h1>
<p class="normal1">There are <a id="_idIndexMarker1018" class="calibre3"/>many OAuth providers, but the most widely used are those provided by the major technology companies, including Google and Facebook, because these are the accounts that most users already have. For the <em class="italic">SportsStore</em> application, I am going to use the Google OAuth service, but the process for other providers is similar. </p>
<div><p class="normal"><strong class="screentext">Getting help with external authentication</strong></p>
<p class="normal">The setup process I describe in this chapter is correct at the time of writing but may change by the time you read this chapter. Google regularly revises its developer portal, and you may find that features are given different names or arranged in different ways. The changes are likely to be small, but every authentication service provides developer documentation, which should point you in the right direction.</p>
<p class="normal">Please do not email me to ask for help setting up external authentication. I try to help readers with most problems, but figuring out external authentication issues would require signing into a reader’s Google account, which is something that I will not do, even for accounts that have been created specifically for the <em class="italic">SportsStore</em> application.</p>
</div>
<p class="normal">To get started, navigate to <a href="https://console.developers.google.com" class="calibre3">https://console.developers.google.com</a>, sign in with a Google account, and <a id="_idIndexMarker1019" class="calibre3"/>perform the following steps:</p>
<ol class="calibre6">
<li class="bulletlist1" value="1">Click <strong class="screentext">OAuth Consent Screen</strong>, and then click <strong class="screentext">Create Project</strong>.</li>
<li class="bulletlist1">Enter <code class="inlinecode">SportsStore</code> into the project name field and click the <strong class="screentext">Create</strong> button.</li>
<li class="bulletlist1">Select <strong class="screentext">External</strong> for <strong class="screentext">User Type</strong> and click the <strong class="screentext">Create</strong> button.</li>
<li class="bulletlist1">Enter <code class="inlinecode">SportsStore</code> into the <strong class="screentext">App Name</strong> field, enter your Google account email address for the email fields, and click the <strong class="screentext">Save And Continue</strong> button. The other fields can be left empty.</li>
<li class="bulletlist1">Click <strong class="screentext">Add Or Remove Scopes</strong>, and then check the following options (and no others):<ul class="calibre10">
<li class="bulletlist2"><strong class="screentext">.../auth/userinfo.email</strong></li>
<li class="bulletlist3"><strong class="screentext">.../auth/userinfo.profile</strong></li>
<li class="bulletlist3"><strong class="screentext">Openid</strong></li>
</ul>
</li>
<li class="bulletlist1">Click the <strong class="screentext">Update</strong> button, and then click the <strong class="screentext">Save And Continue</strong> button to move to the <strong class="screentext">Test Users</strong> section.</li>
<li class="bulletlist1">Click the <strong class="screentext">Save And Continue</strong> button without making any changes in the <strong class="screentext">Test Users</strong> section.</li>
<li class="bulletlist1">Click <strong class="screentext">Back To Dashboard</strong> to return to the <strong class="screentext">OAuth Consent Screen</strong> page.</li>
</ol>
<p class="normal">The basic flow<a id="_idIndexMarker1020" class="calibre3"/> for this part of the process is shown in <em class="italic">Figure 19.4</em>.</p>
<figure class="mediaobject"><img alt="" src="img/B21959_19_04.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 19.4: Creating and configuring the application</p>
<h3 class="heading2" id="_idParaDest-332">Publishing the app</h3>
<p class="normal1">Click the <strong class="screentext">Publish App</strong> button, and <a id="_idIndexMarker1021" class="calibre3"/>you will receive a prompt asking you to confirm the push to production, as shown in <em class="italic">Figure 19.5</em>. If you have configured the application as described in the previous section, the prompt should tell you that the application does not need to be submitted for verification. Click the <strong class="screentext">CONFIRM</strong> button to publish the application.</p>
<figure class="mediaobject"><img alt="" src="img/B21959_19_05.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 19.5: The push to production prompt</p>
<h3 class="heading2" id="_idParaDest-333">Creating the Client ID and Client Secret</h3>
<p class="normal1">The final <a id="_idIndexMarker1022" class="calibre3"/>step is to create the two values that are<a id="_idIndexMarker1023" class="calibre3"/> used to configure <strong class="screentext">OAuth</strong>: the <strong class="screentext">Client ID</strong>, which the <em class="italic">SportsStore</em> application will use to identify itself to Google, and the Client Secret, which will be used to sign and verify the data produced by Google. Perform the following steps: </p>
<ol class="calibre6">
<li class="bulletlist1" value="1">Click <strong class="screentext">Credentials</strong> in the Google Developer dashboard.</li>
<li class="bulletlist1">Click <strong class="screentext">Create Credentials</strong> and select <strong class="screentext">OAuth Client ID</strong> from the popup menu.</li>
<li class="bulletlist1">Select <strong class="screentext">Web Application</strong> from the <strong class="screentext">Application Type</strong> menu and enter <code class="inlinecode">SportsStore</code> in the <strong class="screentext">Name</strong> field.</li>
<li class="bulletlist1">No changes are required in the <strong class="screentext">Authorized JavaScript Origins</strong> section.</li>
<li class="bulletlist1">Click the <strong class="screentext">Add URI</strong> button in the <strong class="screentext">Authorized Redirect URIs</strong> section and add <code class="inlinecode">http://localhost:5000/signin-google</code> and <code class="inlinecode">https://localhost/signin-google</code>.</li>
<li class="bulletlist1">Click the <strong class="screentext">Create</strong> button.</li>
<li class="bulletlist1">Copy the <strong class="screentext">Client</strong> <strong class="screentext">ID</strong> and <strong class="screentext">Client Secret</strong> values from the popup summary and store them safely. Each value is presented with a copy button that ensures that all of the characters are copied correctly.</li>
<li class="bulletlist1">Click <a id="_idIndexMarker1024" class="calibre3"/>the <strong class="screentext">OK</strong> button to close the summary<a id="_idIndexMarker1025" class="calibre3"/> popup.</li>
</ol>
<p class="normal">At the end of the process, you will have two values to add to the <code class="inlinecode">development.env</code> file in the <code class="inlinecode">sportsstore</code> folder, as shown in <em class="italic">Listing 19.2</em>. (This listing shows placeholder values. You must replace these with the values you obtained from the Google portal for the examples to work.)</p>
<div><p class="normal"><strong class="screentext">Using local redirection URLs</strong></p>
<p class="normal">The authorized redirect<a id="_idIndexMarker1026" class="calibre3"/> URLs used in step 5 use <code class="inlinecode">localhost</code> for the hostname, which means that clients will be told to redirect to the local machine once authentication has been performed. This is useful for the SportsStore application, where the browser and the server run on the same machine. For real projects, you must use the public-facing URL that points to your project, which can be resolved by users’ browsers. This requires domain name registration, which is why the <em class="italic">SportsStore</em> uses localhost. </p>
</div>
<p class="packt_figref">Listing 19.2: Storing secrets in the development.env file in the sportsstore folder</p>
<pre class="programlisting"><code class="hljs-code"># secret used to sign session cookies
COOKIE_SECRET="sportsstoresecret"
# Google OAuth Credentials
GOOGLE_CLIENT_ID=enter client ID here
GOOGLE_CLIENT_SECRET=enter client secret here
</code></pre>
<h1 class="heading" id="_idParaDest-334">Getting profile details with OAuth</h1>
<p class="normal1">The starting <a id="_idIndexMarker1027" class="calibre3"/>point is to extend the data model so that it is possible to associate customers in the database with their Google accounts. When the OAuth service provides the SportsStore application with user data, a unique ID is included, which will be stored in the database alongside the customer’s name and email, and used to query the customer’s address if one is available in the SportsStore database. <em class="italic">Listing 19.3</em> adds a new property to the <code class="inlinecode">Customer</code> interface. </p>
<p class="packt_figref">Listing 19.3: Adding a property to the customer_models.ts file in the src/data folder</p>
<pre class="programlisting"><code class="hljs-code">export interface Customer {
    id?: number;
    name: string;
    email: string;
  <strong class="screentext">  federatedId?: string;</strong>
}
</code></pre>
<p class="normal">The new property <a id="_idIndexMarker1028" class="calibre3"/>requires a validation rule, as shown in <em class="italic">Listing 19.4</em>.</p>
<p class="packt_figref">Listing 19.4: Adding a new property to the order_rules.ts file in the src/data/validation folder</p>
<pre class="programlisting"><code class="hljs-code">import { Validator } from "./validator";
import { required, minLength, email, no_op } from "./basic_rules";
import { Address } from "../order_models";
import { Customer } from "../customer_models";
export const CustomerValidator = new Validator&lt;Customer&gt;({
    name: [required, minLength(6)],
    email: email,
   <strong class="screentext"> federatedId: no_op</strong>
});
export const AddressValidator = new Validator&lt;Address&gt;({
    street: required,
    city: required,
    state: required,
    zip: no_op
});
</code></pre>
<p class="normal">The <code class="inlinecode">no_op</code> rule is used because no validation is required for the data provided by the OAuth process.</p>
<p class="normal">A new set of<a id="_idIndexMarker1029" class="calibre3"/> repository methods is required to store the new data and use it as the basis for queries. Add a file named <code class="inlinecode">customer_repository.ts</code> to the <code class="inlinecode">src/data</code> folder, with the content shown in <em class="italic">Listing 19.5</em>.</p>
<p class="packt_figref">Listing 19.5: The contents of the customer_repository.ts file in the src/data folder</p>
<pre class="programlisting"><code class="hljs-code">import { Customer } from "./customer_models";
import { Address } from "./order_models";
export interface CustomerRepository {
    getCustomer(id: number) : Promise&lt;Customer | null&gt;;
    getCustomerByFederatedId(id: string): Promise&lt;Customer | null&gt;;
    getCustomerAddress(id: number): Promise&lt;Address | null&gt;;
    storeCustomer(customer: Customer): Promise&lt;Customer&gt;;
}
</code></pre>
<p class="normal">The <code class="inlinecode">getCustomer</code> method searches the database using the unique ID created by the database server. The <code class="inlinecode">getCustomerByFederatedId</code> method does the same thing but uses the unique ID that Google provides in the OAuth profile. The <code class="inlinecode">getCustomerAddress</code> method will return the most recent address associated with the user. There won’t be an address until an order has been placed, but the data that is stored will be available for the second and subsequent orders the customer creates. The final method, named <code class="inlinecode">storeCustomer</code>, will store a user in the database.</p>
<h2 class="heading1" id="_idParaDest-335">Implementing the new repository features</h2>
<p class="normal1">The next step is to update<a id="_idIndexMarker1030" class="calibre3"/> the Sequelize implementation of the repository. <em class="italic">Listing 19.6</em> adds a property to the ORM model class.</p>
<p class="packt_figref">Listing 19.6: Adding a property to the customer_models.ts file in the src/data/orm/models folder</p>
<pre class="programlisting"><code class="hljs-code">import { Model, CreationOptional, InferAttributes, InferCreationAttributes }
    from "sequelize";
import { Customer } from "../../customer_models";
export class CustomerModel extends Model&lt;InferAttributes&lt;CustomerModel&gt;,
        InferCreationAttributes&lt;CustomerModel&gt;&gt; implements Customer {
    declare id?: CreationOptional&lt;number&gt;;
    declare name: string;
    declare email: string;
 <strong class="screentext">   declare federatedId?: string;</strong>
}
</code></pre>
<p class="normal"><em class="italic">Listing 19.7</em> describes<a id="_idIndexMarker1031" class="calibre3"/> how the new property will be stored in the database.</p>
<p class="packt_figref">Listing 19.7: Describing a property in the customer_helpers.ts file in the src/data/orm/models folder</p>
<pre class="programlisting"><code class="hljs-code">import { DataTypes, Sequelize } from "sequelize";
import { CustomerModel } from "./customer_models";
export const initializeCustomerModels = (sequelize: Sequelize) =&gt; {
    CustomerModel.init({
        id: { type: DataTypes.INTEGER, autoIncrement: true, primaryKey: true},
        name: { type: DataTypes.STRING},       
        email: { type: DataTypes.STRING },
      <strong class="screentext">  federatedId: { type: DataTypes.STRING }</strong>
    }, { sequelize})
}
</code></pre>
<p class="normal">A new relationship between model classes is required to support the queries that will be performed by the new repository methods, as shown in <em class="italic">Listing 19.8</em>.</p>
<p class="packt_figref">Listing 19.8: Adding a new relationship to the order_helpers.ts file in the src/data/orm/models folder</p>
<pre class="programlisting"><code class="hljs-code">import { DataTypes, Sequelize } from "sequelize";
import { OrderModel, ProductSelectionModel, AddressModel }
    from "./order_models";
import { CustomerModel } from "./customer_models";
import { ProductModel } from ".";
const primaryKey = {
    id: { type: DataTypes.INTEGER, autoIncrement: true, primaryKey: true }
};
   
export const initializeOrderModels = (sequelize: Sequelize) =&gt; {
   
    // ...statements omitted for brevity...
    ProductSelectionModel.belongsTo(ProductModel, { as: "product"});
    <strong class="screentext">AddressModel</strong><strong class="screentext">.hasMany(OrderModel, { foreignKey: "addressId"});</strong>
}
</code></pre>
<p class="normal">To implement<a id="_idIndexMarker1032" class="calibre3"/> the methods required by the <code class="inlinecode">CustomerRepository</code> interface, add a file named <code class="inlinecode">customers.ts</code> to the <code class="inlinecode">src/data/orm</code> folder, with the content shown in <em class="italic">Listing 19.9</em>.</p>
<p class="packt_figref">Listing 19.9: The contents of the customers.ts file in the src/data/orm folder</p>
<pre class="programlisting"><code class="hljs-code">import { Customer } from "../customer_models";
import { CustomerRepository } from "../customer_repository";
import { Address } from "../order_models";
import { BaseRepo, Constructor } from "./core"
import { CustomerModel } from "./models/customer_models";
import { AddressModel, OrderModel } from "./models/order_models";
export function AddCustomers&lt;TBase extends
        Constructor&lt;BaseRepo&gt;&gt;(Base: TBase)  {
    return class extends Base implements CustomerRepository {
        getCustomer(id: number): Promise&lt;Customer | null&gt; {
            return CustomerModel.findByPk(id, {
                raw: true
            });
        }
        getCustomerByFederatedId(id: string): Promise&lt;Customer | null&gt; {
            return CustomerModel.findOne({
                where: { federatedId: id },
                raw: true
            })
        }
        getCustomerAddress(id: number): Promise&lt;Address | null&gt; {
            return AddressModel.findOne({
                include: [{
                    model: OrderModel,
                    where: { customerId: id },
                    attributes: []
                }],
                order: [["updatedAt", "DESC"]]
            });
        }
        async storeCustomer(customer: Customer): Promise&lt;Customer&gt; {
            const [data, created] = await CustomerModel.findOrCreate({
                where: { email: customer.email },
                defaults: customer,
            });
            if (!created) {
                data.name = customer.name;
                data.email = customer.email;
                data.federatedId = customer.federatedId;
                await data.save();
            }
            return data;
        }
    }
}
</code></pre>
<p class="normal">The <code class="inlinecode">getCustomer</code> and <code class="inlinecode">getCustomerByFederatedId</code> methods perform regular queries, but the <code class="inlinecode">getCustomerAddress</code> method has to query through another model class so that obtaining <a id="_idIndexMarker1033" class="calibre3"/>the most recent address for a customer is done by finding the customer’s earlier orders, and then obtaining the address data associated with them. The <code class="inlinecode">attributes</code> property is used in the <code class="inlinecode">include</code> expression to exclude the order data from the responses. The <code class="inlinecode">storeCustomer</code> method uses the <code class="inlinecode">findOrCreate</code> method to find a customer by email address if one exists; otherwise, it creates a new customer<a id="_idIndexMarker1034" class="calibre3"/> record. <em class="italic">Listing 19.10</em> includes the new methods in the repository mixin.</p>
<p class="packt_figref">Listing 19.10: Extending the mixin in the index.ts file in the src/data/orm folder</p>
<pre class="programlisting"><code class="hljs-code">import { BaseRepo } from "./core";
import { AddQueries } from "./queries";
import { AddStorage } from "./storage";
import { AddOrderQueries } from "./order_queries";
import { AddOrderStorage } from "./order_storage";
<strong class="screentext">import { AddCustomers } from "./customers";</strong>
const CatalogRepo = AddStorage(AddQueries(BaseRepo));
const RepoWithOrders = AddOrderStorage(AddOrderQueries(CatalogRepo));
<strong class="screentext">const RepoWithCustomers = AddCustomers(RepoWithOrders);</strong>
<strong class="screentext">export</strong><strong class="screentext"> const CatalogRepoImpl = RepoWithCustomers;</strong>
</code></pre>
<p class="normal">To complete the repository upgrade, Listing 19.11 adds a new property that exposes the new interface to the rest of the application.</p>
<p class="packt_figref">Listing 19.11: Adding a constant to the index.ts file in the src/data folder</p>
<pre class="programlisting"><code class="hljs-code">import { CatalogRepository } from "./catalog_repository";
import { CatalogRepoImpl} from "./orm";
import { OrderRepository } from "./order_repository";
<strong class="screentext">import { CustomerRepository } from "./customer_repository"</strong><strong class="screentext">;</strong>
const repo = new CatalogRepoImpl();
export const catalog_repository: CatalogRepository = repo;
export const order_repository: OrderRepository = repo;
<strong class="screentext">export const customer_repository: CustomerRepository = repo;</strong>
</code></pre>
<h2 class="heading1" id="_idParaDest-336">Setting Up OAuth authentication</h2>
<p class="normal1">To handle the details of <a id="_idIndexMarker1035" class="calibre3"/>OAuth requests and responses, I am going to use the Passport authentication package introduced in <em class="italic">Chapter 18</em>, which has authentication strategies for major authentication services, including Google. Run the commands shown in <em class="italic">Listing 19.12</em> in the <code class="inlinecode">sportsstore</code> folder to add the Passport package, the <a id="_idIndexMarker1036" class="calibre3"/>strategy package, and the type descriptions to the project. </p>
<p class="packt_figref">Listing 19.12: Installing the authentication packages</p>
<pre class="programlisting1"><code class="hljs-con">npm install passport@0.7.0
npm install passport-google-oauth20@2.0.0
npm install --save-dev @types/passport@1.0.16
npm install --save-dev @types/passport-google-oauth20@2.0.14
</code></pre>
<p class="normal">For quick reference, these packages are described in <em class="italic">Table 19.1</em>.</p>
<p class="packt_figref">Table 19.1: The Authentication Packages </p>
<table class="table-container" id="table001-16">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal">Name</p>
</td>
<td class="table-cell">
<p class="normal">Description</p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1">passport</code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal">This package contains the core Passport features.</p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1">passport-google-oauth20</code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal">This package contains a Passport strategy for authentication with the Google OAuth service.</p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1">@types/passport</code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal">This package contains type information. </p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1">@types/passport-google-oauth20</code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal">This package contains type information.</p>
</td>
</tr>
</tbody>
</table>
<p class="normal">Add a file named <code class="inlinecode">authentication.ts</code> to the <code class="inlinecode">src</code> folder with the content shown in <em class="italic">Listing 19.13</em>.</p>
<p class="packt_figref">Listing 19.13: The contents of the authentication.ts file in the src folder</p>
<pre class="programlisting"><code class="hljs-code">import { Express } from "express";
import { getConfig, getSecret } from "./config";
import passport from "passport";
import { Strategy as GoogleStrategy, Profile, VerifyCallback }
    from "passport-google-oauth20";
import { customer_repository } from "./data";
import { Customer } from "./data/customer_models";
const callbackURL: string = getConfig("auth:openauth:redirectionUrl");
const clientID = getSecret("GOOGLE_CLIENT_ID");
const clientSecret = getSecret("GOOGLE_CLIENT_SECRET");
declare global {
    namespace Express {
        interface User extends Customer {  }
    }
}
export const createAuthentication = (app:Express) =&gt; {
    passport.use(new GoogleStrategy({
        clientID, clientSecret, callbackURL,
        scope: ["email", "profile"],
        state: true
    } , async (accessToken: string, refreshToken: string,
            profile: Profile, callback: VerifyCallback) =&gt; {
        const emailAddr = profile.emails?.[0].value ?? "";           
        const customer = await customer_repository.storeCustomer({
            name: profile.displayName, email: emailAddr,
            federatedId: profile.id
        });
        const { id, name, email } = customer;
        return callback(null, { id, name, email });
    }));
    passport.serializeUser((user, callback) =&gt; {
        callback(null, user.id);
    });
    passport.deserializeUser((id: number, callbackFunc) =&gt; {
        customer_repository.getCustomer(id).then(user =&gt;
            callbackFunc(null, user));
    });
    app.use(passport.session());
}
</code></pre>
<p class="normal">The <code class="inlinecode">declare</code> keyword<a id="_idIndexMarker1037" class="calibre3"/> is used to tell the TypeScript compiler that the <code class="inlinecode">User</code> objects added to authenticated requests by the <code class="inlinecode">Passport</code> package will extend the <code class="inlinecode">Customer</code> type. The <code class="inlinecode">createAuthentiction</code> function sets up the Passport package to perform authentication using the Google OAuth service.</p>
<p class="normal">The <a id="_idIndexMarker1038" class="calibre3"/>configuration module is used to get the redirection URL, which will be included in the authentication request sent to Google and to which browsers will be redirected once authentication is complete. The URL must match the one used when setting up the OAuth credentials and, for real projects, should be a public-facing URL.</p>
<p class="normal">The Client ID and Client Secret are read and used to configure the Google authentication strategy along with the URL:</p>
<pre class="programlisting"><code class="hljs-code">...
passport.use(new GoogleStrategy({
    clientID, clientSecret, callbackURL,
    scope: ["email", "profile"]
...
</code></pre>
<p class="normal">The <code class="inlinecode">scope</code> settings specify which OAuth scopes will be requested and the <code class="inlinecode">email</code> and <code class="inlinecode">profile</code> values correspond to the scopes used when setting up the OAuth service. These two scopes give details of the user’s email addresses and their display name, which is all that’s needed for the <em class="italic">SportsStore</em> application.</p>
<div><p class="normal">There are many other scopes available, but they generally require applications to go through a vetting process before access is granted, whereas email and profile scopes can be used by any registered application.</p>
</div>
<p class="normal">The final argument to the strategy constructor is a callback function that is invoked when Google has authenticated the user and performed the redirection:</p>
<pre class="programlisting"><code class="hljs-code">...
} , async (accessToken: string, refreshToken: string,
        profile: Profile, callback: VerifyCallback) =&gt; {
...
</code></pre>
<p class="normal">The<a id="_idIndexMarker1039" class="calibre3"/> callback function receives an access token, which can be used to make API queries, and a refresh token, which can be used to obtain a new access token. Both tokens are described in the OAuth documentation (see <a href="https://www.oauth.com/oauth2-servers/access-tokens" class="calibre3">https://www.oauth.com/oauth2-servers/access-tokens</a>) but they are not required for this example. Instead, this example relies on the data provided by the third parameter, which is the user’s profile. Profiles vary between providers, but Passport normalizes the data returned by the Google OAuth service like this (edited to replace real data values with the <code class="inlinecode">X</code> character): </p>
<pre class="programlisting1"><code class="hljs-con">{
  id: '101XXXXXXXXXXXXXXXXXX',
  displayName: Alice Smith',
  name: { familyName: 'Smith', givenName: 'Alice' },
  emails: [ { value: alice@example.com', verified: true } ],
  photos: [{value: 'https://lh3.googleusercontent.com/a/XXXX'}],
  provider: 'google',
  _raw: '{\n' +
    '  "sub": "101XXXXXXXXXXXXXXXXXX",\n' +
    '  "name": "Alice Smith",\n' +
    '  "given_name": "Adam",\n' +
    '  "family_name": "Smith",\n' +
    '  "picture": "https://lh3.googleusercontent.com/a/XXXX",\n' +
    '  "email": "alice@example.com",\n' +
    '  "email_verified": true,\n' +
    '  "locale": "en"\n' +
    '}',
  _json: {
    sub: '101XXXXXXXXXXXXXXXXXX',
    name: Alice Smith',
    given_name: 'Alice',
    family_name: 'Smith',
    picture: 'https://lh3.googleusercontent.com/a/XXXX',
    email: 'alice@example.com',
    email_verified: true,
    locale: 'en'
  }
}
</code></pre>
<p class="normal">A detailed explanation of the normalized profile can be found at <a href="https://www.passportjs.org/reference/normalized-profile" class="calibre3">https://www.passportjs.org/reference/normalized-profile</a>, but the <em class="italic">SportsStore</em> application needs only the <code class="inlinecode">id</code> value, which uniquely identifies the user, the <code class="inlinecode">given_name</code> value, and the <code class="inlinecode">emails</code> value, from which the user’s email address will be obtained.</p>
<p class="normal">The final parameter is a callback that is invoked once the user’s data is ready. The code in <em class="italic">Listing 19.13</em> uses the profile data to store the customer’s details and invokes the callback to provide Passport with the user object. The implementation of the repository’s <code class="inlinecode">storeCustomer</code> method matches the <code class="inlinecode">federatedId</code> value if there is one, which means that the profile data will be used to update any existing data created for the same user in a previous order. </p>
<p class="normal">The calls to the <code class="inlinecode">passport.serializeUser</code> and <code class="inlinecode">passport.deserializeUser</code> are required to allow<a id="_idIndexMarker1040" class="calibre3"/> Passport to serialize the user data into a session. In this case, the unique ID assigned by the database is used to represent the serialized user, which is deserialized by querying the database. This is the final statement in <em class="italic">Listing 19.13</em>: </p>
<pre class="programlisting"><code class="hljs-code">...
app.use(passport.session());
...
</code></pre>
<p class="normal">The <code class="inlinecode">passport.session</code> function returns a middleware function that will authenticate requests using the data stored in a session from other authentication mechanisms, and it has the effect of deserializing the user for requests when they have been authenticated using the Google OAuth service.</p>
<p class="normal"><em class="italic">Listing 19.14</em> calls the <code class="inlinecode">createAuthentication</code> function to enable authentication as part of the server startup.</p>
<p class="packt_figref">Listing 19.14: Enabling authentication in the server.ts file in the src folder</p>
<pre class="programlisting"><code class="hljs-code">import { createServer } from "http";
import express, { Express } from "express";
import helmet from "helmet";
import { getConfig } from "./config";
import { createRoutes } from "./routes";
import { createTemplates } from "./helpers";
import { createErrorHandlers } from "./errors";
import { createSessions } from "./sessions";
<strong class="screentext">import { createAuthentication } from "./authentication";</strong>
const port = getConfig("http:port", 5000);
const expressApp: Express = express();
expressApp.use(helmet());
expressApp.use(express.json());
expressApp.use(express.urlencoded({extended: true}))
expressApp.use(express.static("node_modules/bootstrap/dist"));
expressApp.use(express.static("node_modules/bootstrap-icons"));
createTemplates(expressApp);
createSessions(expressApp);
<strong class="screentext">createAuthentication(expressApp);</strong>
createRoutes(expressApp);
createErrorHandlers(expressApp);
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</code></pre>
<p class="normal">To <a id="_idIndexMarker1041" class="calibre3"/>complete the authentication setup, <em class="italic">Listing 19.15</em> adds a new section to the configuration file that specifies the callback that will be used for OAuth requests.</p>
<p class="packt_figref">Listing 19.15: Adding settings to the server.config.json file in the SportsStore folder</p>
<pre class="programlisting"><code class="hljs-code">{
    "http": {
        "port": 5000
    },
    // ...configuration sections omitted for brevity...
    "sessions": {
        "maxAgeHrs": 2,
        "reset_db": true,
        "orm": {
            "settings": {
                "dialect": "sqlite",
                "storage": "sessions.db"
            },
            "logging": true
        }
    },
   <strong class="screentext"> "auth": {</strong>
<strong class="screentext">        "openauth": {</strong>
<strong class="screentext">            "redirectionUrl": "http://localhost:5000/signin-google"</strong>
<strong class="screentext">        }</strong>
<strong class="screentext">    }</strong>
}
</code></pre>
<p class="normal">As noted <a id="_idIndexMarker1042" class="calibre3"/>earlier, the <code class="inlinecode">localhost</code> URL relies on the browser and the server being on the same machine. For real projects, a real domain name should be used, although <code class="inlinecode">localhost</code> can be useful during development.</p>
<h2 class="heading1" id="_idParaDest-337">Changing the cookie configuration</h2>
<p class="normal1">OAuth is an <a id="_idIndexMarker1043" class="calibre3"/>excellent authentication system, but it can be finicky, and effort is often required to get everything working correctly. One common cause of problems is the configuration for the session cookies, which must be set up to match the expectations of the OAuth strategy, whose requirements may be different from the rest of the application.</p>
<p class="normal">When setting up OAuth for SportsStore, I found that I had to make two changes to get authentication working correctly, as shown in <em class="italic">Listing 19.16</em>.</p>
<p class="packt_figref">Listing 19.16: Changing cookie configuration in the sessions.ts file in the src folder</p>
<pre class="programlisting"><code class="hljs-code">...
app.use(session({
    secret, store,
  <strong class="screentext">  resave: false, saveUninitialized: true,</strong>
    cookie: {
        maxAge: config.maxAgeHrs * 60 * 60 * 1000,
        <strong class="screentext">sameSite: false, httpOnly: false, secure</strong><strong class="screentext">: false }</strong>
}));
...
</code></pre>
<p class="normal">You may<a id="_idIndexMarker1044" class="calibre3"/> need different configuration settings for other strategies or authentication providers, and some experimentation is usually required because session settings are not usually specified. </p>
<h2 class="heading1" id="_idParaDest-338">Applying authentication</h2>
<p class="normal1">The next step is to present the user<a id="_idIndexMarker1045" class="calibre3"/> with a button that will allow them to sign in with Google, as shown in <em class="italic">Listing 19.17</em>.</p>
<p class="packt_figref">Listing 19.17. Adding a Google button to the order_details.handlebars fle in the templates folder</p>
<pre class="programlisting"><code class="hljs-code">&lt;form method="post" action="/checkout"&gt;
    <strong class="screentext">&lt;div class="container"&gt;</strong>
<strong class="screentext">        &lt;div class="row flex-row align-items-center"&gt;</strong>
<strong class="screentext">            &lt;div</strong><strong class="screentext"> class="col-7"&gt;{{&gt; order_details_customer }}&lt;/div&gt;</strong>
<strong class="screentext">            &lt;div class="col"&gt;</strong>
<strong class="screentext">                &lt;div</strong><strong class="screentext"> class="d-flex justify-content-center"&gt;</strong>
<strong class="screentext">                    &lt;a class="btn btn-primary" href="/checkout/google"&gt;</strong>
<strong class="screentext">                        &lt;i</strong><strong class="screentext"> class="bi bi-google"&gt;&lt;/i&gt;</strong>
<strong class="screentext">                        Use Google Account</strong>
<strong class="screentext">                    &lt;/a&gt;</strong>
<strong class="screentext">                &lt;/div&gt;</strong>
<strong class="screentext">            &lt;/div&gt;</strong>
<strong class="screentext"> </strong><strong class="screentext">&lt;/div&gt;</strong>
<strong class="screentext">        &lt;div class="row"&gt;</strong>
<strong class="screentext">            {{&gt; order_details_address }}</strong>
<strong class="screentext">        &lt;/div&gt;</strong>
<strong class="screentext">        &lt;div class</strong><strong class="screentext">="row"&gt;</strong>
<strong class="screentext">            &lt;div class="m-2"&gt;</strong>
<strong class="screentext">                &lt;button type="submit" class</strong><strong class="screentext">="btn btn-primary"&gt;</strong>
<strong class="screentext">                    Place Order</strong>
<strong class="screentext">                &lt;/button&gt;</strong>
<strong class="screentext">                &lt;a href="/cart?returnUrl={{ escapeUrl (navigationUrl )}}"</strong>
<strong class="screentext">                    class="btn btn-primary"&gt;Back</strong><strong class="screentext">&lt;/a&gt;</strong>
<strong class="screentext">            &lt;/div&gt;</strong>
<strong class="screentext">        &lt;/div&gt;</strong>
<strong class="screentext">    &lt;/div&gt;</strong>
&lt;/form&gt;
</code></pre>
<p class="normal">The new<a id="_idIndexMarker1046" class="calibre3"/> element structure is configured with the Bootstrap CSS classes to create a grid, with the elements for the name and email address sharing a row with a new button that contains a Google icon from the Bootstrap Icons package and prompts the user to use their Google account. <em class="italic">Listing 19.18</em> defines the routes that support OAuth and use the customer’s Google details.</p>
<p class="packt_figref">Listing 19.18: Supporting OAuth in the orders.ts file in the src/routes folder</p>
<pre class="programlisting"><code class="hljs-code">import { Express } from "express";
import { Address } from "../data/order_models";
import { AddressValidator, CustomerValidator, ValidationResults, getData, isValid }
    from "../data/validation";
import { Customer } from "../data/customer_models";
import { createAndStoreOrder } from "./order_helpers";
<strong class="screentext">import { customer_repository } from "../data";</strong>
<strong class="screentext">import passport from "passport";</strong>
declare module "express-session" {
    interface SessionData {
       orderData?: {
            customer?: ValidationResults&lt;Customer&gt;,
            address?: ValidationResults&lt;Address&gt;
       },
       pageSize?: string;
    }
}
export const createOrderRoutes = (app: Express) =&gt; {
    <strong class="screentext">app.</strong><strong class="screentext">get("/checkout/google", passport.authenticate("google"));</strong>
<strong class="screentext">    app.get("/signin-google", passport.authenticate("google",</strong>
<strong class="screentext">        { successRedirect: "</strong><strong class="screentext">/checkout", keepSessionInfo: true }));</strong>
    app.get("/checkout", async (req, resp) =&gt; {
       <strong class="screentext"> if (!req.session.orderData &amp;&amp; req.</strong><strong class="screentext">user) {</strong>
<strong class="screentext">            req.session.orderData = {</strong>
<strong class="screentext">                customer: await CustomerValidator.validate(req.user),</strong>
<strong class="screentext">                address: await </strong><strong class="screentext">AddressValidator.validate(</strong>
<strong class="screentext">                    await customer_repository.getCustomerAddress(</strong>
<strong class="screentext">                        req.user?.id ?? 0) ?? {})  </strong>
<strong class="screentext">            }</strong>
<strong class="screentext"> </strong> }
        req.session.pageSize =
            req.session.pageSize ?? req.query.pageSize?.toString() ?? "3";
        resp.render("order_details", {
            order: req.session.orderData,
            page: 1,
            pageSize: req.session.pageSize
        });
    });
    // ...other routes omitted for brevity...
}
</code></pre>
<p class="normal">The <code class="inlinecode">/checkout/google</code> route is <a id="_idIndexMarker1047" class="calibre3"/>targeted by the button created in <em class="italic">Listing 19.17</em>, and its job is to start the OAuth process by requiring authentication with the <code class="inlinecode">google</code> strategy:</p>
<pre class="programlisting"><code class="hljs-code">...
app.get("/checkout/google", <strong class="screentext">passport.authenticate("google")</strong>);
...
</code></pre>
<p class="normal">Each Passport strategy module has a default name, and <code class="inlinecode">google</code> is the name of the strategy added to the project in <em class="italic">Listing 19.13</em>. The effect of this route is to redirect the user’s browser to the Google OAuth service.</p>
<p class="normal">The <code class="inlinecode">/signin-google</code> route handles the redirection back from Google when the authentication process is complete and also requires authentication with the <code class="inlinecode">google</code> strategy:</p>
<pre class="programlisting"><code class="hljs-code">...
app.get("/signin-google", <strong class="screentext">passport.authenticate("google",</strong>
<strong class="screentext">        { successRedirect: "/checkout", keepSessionInfo: true })</strong>);
...
</code></pre>
<p class="normal">This time, the<a id="_idIndexMarker1048" class="calibre3"/> authentication strategy will process the data sent by Google to authenticate the user and, if authentication has been successful, perform a redirection to the <code class="inlinecode">/checkout</code> URL. If authentication is not successful, then an error message will be displayed using the custom error handlers. The <code class="inlinecode">keepSessionInfo</code> setting ensures that existing session data is preserved once the user is authenticated.</p>
<p class="normal">The changes to the handler for the <code class="inlinecode">/checkout</code> URL populate the order data for authenticated requests. The user data added to the <code class="inlinecode">Request</code> object is used for the customer’s name and email address, and a query for the most recent address associated with the user is performed. There won’t be an address the first time a user creates an order because that’s not part of the profile data, but an address will be available for subsequent orders.</p>
<h1 class="heading" id="_idParaDest-339">Using the OAuth profile data</h1>
<p class="normal1">Open a new <a id="_idIndexMarker1049" class="calibre3"/>guest tab or private tab in your browser. Browsers use different names for these features, but the goal is to check the authentication process without interference from any cookies the browser may have stored, including cookies from Google.</p>
<p class="normal">Navigate to <code class="inlinecode">http://localhost:5000</code>, add a product to the cart, and click the <strong class="screentext">Checkout</strong> <a id="_idIndexMarker1050" class="calibre3"/>button. Click the <strong class="screentext">Use Google Account</strong> button, as shown in <em class="italic">Figure 19.6</em>. </p>
<figure class="mediaobject"><img alt="" src="img/B21959_19_06.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 19.6: Starting the OAuth process</p>
<p class="normal">Your browser will be redirected to Google, where you will be prompted to authenticate and sign in to <em class="italic">SportsStore</em>, as shown in <em class="italic">Figure 19.7</em>.</p>
<figure class="mediaobject"><img alt="" src="img/B21959_19_07.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 19.7: Authenticating with Google</p>
<p class="normal">The authentication process can differ based on the Google account settings. The account shown in <em class="italic">Figure 19.5</em> is configured to require additional confirmation using a smartphone, which is just one approach that Google supports to confirm authentication.</p>
<p class="normal">Once Google<a id="_idIndexMarker1051" class="calibre3"/> has authenticated the account, the browser is redirected back to the <em class="italic">SportsStore</em> application, and the account profile data will be used to populate the name and email address fields in the checkout form. Complete the form and place the order, as shown in <em class="italic">Figure 19.8</em>.</p>
<div><p class="normal"><strong class="screentext">Addressing common causes of problems</strong></p>
<p class="normal">There are some common problems to check if you don’t get the expected result. First, make sure that you have set the <strong class="screentext">Client ID</strong> and <strong class="screentext">Client Secret</strong> exactly as shown in the Google developer console. If these are not set correctly, then Google may not allow the user to authenticate, or the application won’t be able to verify the data that Google provides in the redirection. There is an option to download a JSON document containing both values, which is a useful way to make sure you have the correct data.</p>
<p class="normal">Second, make sure the same redirection URLs are configured in both the application and the Google developer console. If these are not set correctly, then Google won’t redirect the browser to the right location.</p>
<p class="normal">Third, check the session cookie settings. If authentication with Google works but the profile data isn’t used to populate the form, then the likely cause is that new sessions are being created for each request in the authentication sequence, or that the state data required to validate the data sent by Google isn’t being stored.</p>
<p class="normal">Finally, keep an eye on the Node.js console during the authentication process. If the application is configured to reset the databases, an application restart will drop the session database and prevent authentication from completing. The development tools for the <em class="italic">SportsStore</em> project are set up to restart the application if any file change is detected, and this may be triggered by a different process running on your development machine. (For example, I use an application that creates a snapshot of my code folder every hour, and this causes a restart.) If you suspect this is the case, then change the two <code class="inlinecode">reset_db</code> settings to false in the <code class="inlinecode">server.config.json</code> file so that restarts don’t delete the contents of the databases.</p>
</div>
<figure class="mediaobject"><img alt="" src="img/B21959_19_08.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 19.8: Placing an initial order</p>
<h2 class="heading1" id="_idParaDest-340">Placing a second order</h2>
<p class="normal1">The address data stored<a id="_idIndexMarker1052" class="calibre3"/> when the order is created will be available the next time the same user creates an order. Request <code class="inlinecode">http://localhost:5000</code> and go through the checkout process again. When you click the <strong class="screentext">Use Google Account</strong> button, the entire form should be populated, as shown in <em class="italic">Figure 19.9</em>.</p>
<figure class="mediaobject"><img alt="" src="img/B21959_19_09.png" class="calibre7"/></figure>
<p class="packt_figref">Figure 19.9: Using address data from a previous order</p>
<p class="normal">You typically <a id="_idIndexMarker1053" class="calibre3"/>won’t need to sign in to the Google account again because Google stores an authentication cookie. The browser is still redirected to the Google OAuth service, but the user doesn’t see this request or the subsequent redirection back to <em class="italic">SportsStore</em>.</p>
<h1 class="heading" id="_idParaDest-341">Summary</h1>
<p class="normal1">In this chapter, I added support for users to identify themselves to the <em class="italic">SportsStore</em> application using their Google account:</p>
<ul class="calibre4">
<li class="bulletlist">The OAuth protocol allows users to authenticate themselves without providing their credentials to the application.</li>
<li class="bulletlist1">Most major platforms offer an OAuth service, including Google, and there is a registration process to perform before the application can send OAuth requests.</li>
<li class="bulletlist1">There are differences in the data provided by OAuth services, but these are normalized by the <code class="inlinecode">Passport</code> authentication package.</li>
<li class="bulletlist1">Once the user has associated their Google credentials with a <em class="italic">SportsStore</em> order, their address will be loaded automatically when checking out in the future.</li>
</ul>
<p class="normal">In the next chapter, I will add administration tools that manage the <em class="italic">SportsStore</em> product catalog and change the order shipping status.</p>
</div>
</body></html>