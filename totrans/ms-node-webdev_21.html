<html><head></head><body>
<div class="calibre1" id="_idContainer262">
<h1 class="chapternumber"><span class="kobospan" id="kobo.1.1">19</span></h1>
<h1 class="chaptertitle" id="_idParaDest-326"><span class="kobospan" id="kobo.2.1">SportsStore: Authentication</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.3.1">In this chapter, I will use the OAuth protocol to allow users to use their Google accounts to identify themselves to</span><a id="_idIndexMarker1006" class="calibre3"/><span class="kobospan" id="kobo.4.1"> the </span><em class="italic"><span class="kobospan" id="kobo.5.1">SportsStore</span></em><span class="kobospan" id="kobo.6.1"> application, instead of manually entering their contact details.</span></p>
<h1 class="heading" id="_idParaDest-327"><span class="kobospan" id="kobo.7.1">Preparing for this chapter</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.8.1">This chapter uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.9.1">sportsstore</span></code><span class="kobospan" id="kobo.10.1"> project from </span><em class="italic"><span class="kobospan" id="kobo.11.1">Chapter 18</span></em><span class="kobospan" id="kobo.12.1">. </span><span class="kobospan" id="kobo.12.2">No changes are required for this chapter. </span><span class="kobospan" id="kobo.12.3">Open a new command prompt, navigate to the </span><code class="inlinecode"><span class="kobospan" id="kobo.13.1">sportsstore</span></code><span class="kobospan" id="kobo.14.1"> folder, and run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.15.1">Listing 19.1</span></em><span class="kobospan" id="kobo.16.1"> to start the development tools.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.17.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.18.1">You can download the example project for this chapter – and for all the other chapters in this book – from </span><a href="https://github.com/PacktPublishing/Mastering-Node.js-Web-Development" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.19.1">https://github.com/PacktPublishing/Mastering-Node.js-Web-Development</span></span></a><span class="kobospan" id="kobo.20.1">. </span><span class="kobospan" id="kobo.20.2">See </span><em class="italic"><span class="kobospan" id="kobo.21.1">Chapter 1</span></em><span class="kobospan" id="kobo.22.1"> for how to get help if you have problems running the examples.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.23.1">Listing 19.1: Starting the development tools</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.24.1">npm start
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.25.1">Open a </span><a id="_idIndexMarker1007" class="calibre3"/><span class="kobospan" id="kobo.26.1">new browser window, navigate to </span><code class="inlinecode"><span class="kobospan" id="kobo.27.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.28.1">, and you will see the product catalog, as shown in </span><em class="italic"><span class="kobospan" id="kobo.29.1">Figure 19.1</span></em><span class="kobospan" id="kobo.30.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.31.1"><img alt="" src="../Images/B21959_19_01.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.32.1">Figure 19.1: Running the application</span></p>
<h1 class="heading" id="_idParaDest-328"><span class="kobospan" id="kobo.33.1">Understanding the OAuth authentication process</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.34.1">OAuth</span><a id="_idIndexMarker1008" class="calibre3"/><span class="kobospan" id="kobo.35.1"> allows users to grant applications access to their data without </span><a id="_idIndexMarker1009" class="calibre3"/><span class="kobospan" id="kobo.36.1">needing to provide their credentials to that application. </span><span class="kobospan" id="kobo.36.2">During development, the developer registers their application with an OAuth authentication service and receives an ID that is used to identify the application to the service, as well as a secret that is used to sign and verify messages between the application and the service.</span></p>
<p class="normal"><span class="kobospan" id="kobo.37.1">The</span><a id="_idIndexMarker1010" class="calibre3"/><span class="kobospan" id="kobo.38.1"> registration process establishes the relationship between the application and the authentication service. </span><span class="kobospan" id="kobo.38.2">Registration is done once and is performed before the application is deployed. </span><span class="kobospan" id="kobo.38.3">Some degree of vetting may be required. </span><span class="kobospan" id="kobo.38.4">The SportsStore application uses the Google OAuth service, which makes its basic features – such as the ones used in this chapter – available immediately, but reviews applications before more sensitive data can be accessed, and this can take days or weeks to complete.</span></p>
<p class="normal"><span class="kobospan" id="kobo.39.1">Once the </span><a id="_idIndexMarker1011" class="calibre3"/><span class="kobospan" id="kobo.40.1">application is deployed, the user is presented with a button that offers them the option to sign in to the application with the authentication provider, or grant the application access to the data stored by the provider. </span><em class="italic"><span class="kobospan" id="kobo.41.1">Figure 19.2</span></em><span class="kobospan" id="kobo.42.1"> shows the simple example button added to the SportsStore application later in the chapter, which grants the application access to the user’s basic information, such as their name and email address.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.43.1"><img alt="" src="../Images/B21959_19_02.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.44.1">Figure 19.2: The OAuth button that will be added to the SportsStore application</span></p>
<p class="normal"><span class="kobospan" id="kobo.45.1">When the </span><a id="_idIndexMarker1012" class="calibre3"/><span class="kobospan" id="kobo.46.1">user clicks the button, the browser will be redirected to a URL that starts the authentication process. </span><span class="kobospan" id="kobo.46.2">The user will be prompted for their credentials, which are not revealed to the application. </span><span class="kobospan" id="kobo.46.3">The authentication process will show the user which application they are signing into and the data that the application has asked for. </span><em class="italic"><span class="kobospan" id="kobo.47.1">Figure 19.3</span></em><span class="kobospan" id="kobo.48.1"> shows the </span><a id="_idIndexMarker1013" class="calibre3"/><span class="kobospan" id="kobo.49.1">authentication prompt that will be shown to users of </span><em class="italic"><span class="kobospan" id="kobo.50.1">SportsStore</span></em><span class="kobospan" id="kobo.51.1"> once OAuth has been configured later in this chapter.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.52.1"><img alt="" src="../Images/B21959_19_03.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.53.1">Figure 19.3: Authenticating with the OAuth service</span></p>
<p class="normal"><span class="kobospan" id="kobo.54.1">Once the </span><a id="_idIndexMarker1014" class="calibre3"/><span class="kobospan" id="kobo.55.1">user has authenticated themselves, their </span><a id="_idIndexMarker1015" class="calibre3"/><span class="kobospan" id="kobo.56.1">browser is redirected back to the application, using a URL that contains an access code. </span><span class="kobospan" id="kobo.56.2">The application sends an HTTP request directly to Google and exchanges the access code for the data it requires.</span></p>
<h2 class="heading1" id="_idParaDest-329"><span class="kobospan" id="kobo.57.1">Understanding the advantages of OAuth</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.58.1">From the </span><a id="_idIndexMarker1016" class="calibre3"/><span class="kobospan" id="kobo.59.1">user’s perspective, OAuth allows them to use applications and services without having to create accounts on each one or repeatedly entering the same details. </span><span class="kobospan" id="kobo.59.2">From the developer’s perspective, OAuth enables authentication without having to implement and manage the workflows for password recovery, two-factor authentication, and so on.</span></p>
<p class="normal"><span class="kobospan" id="kobo.60.1">These advantages apply when using the OAuth services provided by big technology and social media companies. </span><span class="kobospan" id="kobo.60.2">There are also OAuth services that you can use to manage just the user accounts for your application, in which case users will still have to create accounts, but the authentication process and the workflows are implemented by the OAuth provider. </span><span class="kobospan" id="kobo.60.3">The most popular service is </span><a href="https://auth0.com" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.61.1">https://auth0.com</span></span></a><span class="kobospan" id="kobo.62.1">, but there are alternatives, and most offer free and paid-for tiers of service. </span></p>
<h2 class="heading1" id="_idParaDest-330"><span class="kobospan" id="kobo.63.1">Understanding the limitations of OAuth</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.64.1">Users will </span><a id="_idIndexMarker1017" class="calibre3"/><span class="kobospan" id="kobo.65.1">not always be willing to associate their account data with an application. </span><span class="kobospan" id="kobo.65.2">This can be because they don’t trust the application, or that they don’t want their account associated with certain types of content. </span><span class="kobospan" id="kobo.65.3">You may find that users are reluctant to use OAuth If you provide adult content of any sort, for example.</span></p>
<p class="normal"><span class="kobospan" id="kobo.66.1">From the developer’s perspective, the main limitation of OAuth is the complexity of the initial setup. </span><span class="kobospan" id="kobo.66.2">Even with a good authentication package, like the one used in this chapter, OAuth rarely works without some tinkering, and figuring out why authentication isn’t working can be a slow and confusing task. </span></p>
<h1 class="heading" id="_idParaDest-331"><span class="kobospan" id="kobo.67.1">Creating the Google OAuth credentials</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.68.1">There are </span><a id="_idIndexMarker1018" class="calibre3"/><span class="kobospan" id="kobo.69.1">many OAuth providers, but the most widely used are those provided by the major technology companies, including Google and Facebook, because these are the accounts that most users already have. </span><span class="kobospan" id="kobo.69.2">For the </span><em class="italic"><span class="kobospan" id="kobo.70.1">SportsStore</span></em><span class="kobospan" id="kobo.71.1"> application, I am going to use the Google OAuth service, but the process for other providers is similar. </span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.72.1">Getting help with external authentication</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.73.1">The setup process I describe in this chapter is correct at the time of writing but may change by the time you read this chapter. </span><span class="kobospan" id="kobo.73.2">Google regularly revises its developer portal, and you may find that features are given different names or arranged in different ways. </span><span class="kobospan" id="kobo.73.3">The changes are likely to be small, but every authentication service provides developer documentation, which should point you in the right direction.</span></p>
<p class="normal"><span class="kobospan" id="kobo.74.1">Please do not email me to ask for help setting up external authentication. </span><span class="kobospan" id="kobo.74.2">I try to help readers with most problems, but figuring out external authentication issues would require signing into a reader’s Google account, which is something that I will not do, even for accounts that have been created specifically for the </span><em class="italic"><span class="kobospan" id="kobo.75.1">SportsStore</span></em><span class="kobospan" id="kobo.76.1"> application.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.77.1">To get started, navigate to </span><a href="https://console.developers.google.com" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.78.1">https://console.developers.google.com</span></span></a><span class="kobospan" id="kobo.79.1">, sign in with a Google account, and </span><a id="_idIndexMarker1019" class="calibre3"/><span class="kobospan" id="kobo.80.1">perform the following steps:</span></p>
<ol class="calibre6">
<li class="bulletlist1" value="1"><span class="kobospan" id="kobo.81.1">Click </span><strong class="screentext"><span class="kobospan" id="kobo.82.1">OAuth Consent Screen</span></strong><span class="kobospan" id="kobo.83.1">, and then click </span><strong class="screentext"><span class="kobospan" id="kobo.84.1">Create Project</span></strong><span class="kobospan" id="kobo.85.1">.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.86.1">Enter </span><code class="inlinecode"><span class="kobospan" id="kobo.87.1">SportsStore</span></code><span class="kobospan" id="kobo.88.1"> into the project name field and click the </span><strong class="screentext"><span class="kobospan" id="kobo.89.1">Create</span></strong><span class="kobospan" id="kobo.90.1"> button.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.91.1">Select </span><strong class="screentext"><span class="kobospan" id="kobo.92.1">External</span></strong><span class="kobospan" id="kobo.93.1"> for </span><strong class="screentext"><span class="kobospan" id="kobo.94.1">User Type</span></strong><span class="kobospan" id="kobo.95.1"> and click the </span><strong class="screentext"><span class="kobospan" id="kobo.96.1">Create</span></strong><span class="kobospan" id="kobo.97.1"> button.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.98.1">Enter </span><code class="inlinecode"><span class="kobospan" id="kobo.99.1">SportsStore</span></code><span class="kobospan" id="kobo.100.1"> into the </span><strong class="screentext"><span class="kobospan" id="kobo.101.1">App Name</span></strong><span class="kobospan" id="kobo.102.1"> field, enter your Google account email address for the email fields, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.103.1">Save And Continue</span></strong><span class="kobospan" id="kobo.104.1"> button. </span><span class="kobospan" id="kobo.104.2">The other fields can be left empty.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.105.1">Click </span><strong class="screentext"><span class="kobospan" id="kobo.106.1">Add Or Remove Scopes</span></strong><span class="kobospan" id="kobo.107.1">, and then check the following options (and no others):</span><ul class="calibre10">
<li class="bulletlist2"><strong class="screentext"><span class="kobospan" id="kobo.108.1">.../auth/userinfo.email</span></strong></li>
<li class="bulletlist3"><strong class="screentext"><span class="kobospan" id="kobo.109.1">.../auth/userinfo.profile</span></strong></li>
<li class="bulletlist3"><strong class="screentext"><span class="kobospan" id="kobo.110.1">Openid</span></strong></li>
</ul>
</li>
<li class="bulletlist1"><span class="kobospan" id="kobo.111.1">Click the </span><strong class="screentext"><span class="kobospan" id="kobo.112.1">Update</span></strong><span class="kobospan" id="kobo.113.1"> button, and then click the </span><strong class="screentext"><span class="kobospan" id="kobo.114.1">Save And Continue</span></strong><span class="kobospan" id="kobo.115.1"> button to move to the </span><strong class="screentext"><span class="kobospan" id="kobo.116.1">Test Users</span></strong><span class="kobospan" id="kobo.117.1"> section.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.118.1">Click the </span><strong class="screentext"><span class="kobospan" id="kobo.119.1">Save And Continue</span></strong><span class="kobospan" id="kobo.120.1"> button without making any changes in the </span><strong class="screentext"><span class="kobospan" id="kobo.121.1">Test Users</span></strong><span class="kobospan" id="kobo.122.1"> section.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.123.1">Click </span><strong class="screentext"><span class="kobospan" id="kobo.124.1">Back To Dashboard</span></strong><span class="kobospan" id="kobo.125.1"> to return to the </span><strong class="screentext"><span class="kobospan" id="kobo.126.1">OAuth Consent Screen</span></strong><span class="kobospan" id="kobo.127.1"> page.</span></li>
</ol>
<p class="normal"><span class="kobospan" id="kobo.128.1">The basic flow</span><a id="_idIndexMarker1020" class="calibre3"/><span class="kobospan" id="kobo.129.1"> for this part of the process is shown in </span><em class="italic"><span class="kobospan" id="kobo.130.1">Figure 19.4</span></em><span class="kobospan" id="kobo.131.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.132.1"><img alt="" src="../Images/B21959_19_04.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.133.1">Figure 19.4: Creating and configuring the application</span></p>
<h3 class="heading2" id="_idParaDest-332"><span class="kobospan" id="kobo.134.1">Publishing the app</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.135.1">Click the </span><strong class="screentext"><span class="kobospan" id="kobo.136.1">Publish App</span></strong><span class="kobospan" id="kobo.137.1"> button, and </span><a id="_idIndexMarker1021" class="calibre3"/><span class="kobospan" id="kobo.138.1">you will receive a prompt asking you to confirm the push to production, as shown in </span><em class="italic"><span class="kobospan" id="kobo.139.1">Figure 19.5</span></em><span class="kobospan" id="kobo.140.1">. </span><span class="kobospan" id="kobo.140.2">If you have configured the application as described in the previous section, the prompt should tell you that the application does not need to be submitted for verification. </span><span class="kobospan" id="kobo.140.3">Click the </span><strong class="screentext"><span class="kobospan" id="kobo.141.1">CONFIRM</span></strong><span class="kobospan" id="kobo.142.1"> button to publish the application.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.143.1"><img alt="" src="../Images/B21959_19_05.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.144.1">Figure 19.5: The push to production prompt</span></p>
<h3 class="heading2" id="_idParaDest-333"><span class="kobospan" id="kobo.145.1">Creating the Client ID and Client Secret</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.146.1">The final </span><a id="_idIndexMarker1022" class="calibre3"/><span class="kobospan" id="kobo.147.1">step is to create the two values that are</span><a id="_idIndexMarker1023" class="calibre3"/><span class="kobospan" id="kobo.148.1"> used to configure </span><strong class="screentext"><span class="kobospan" id="kobo.149.1">OAuth</span></strong><span class="kobospan" id="kobo.150.1">: the </span><strong class="screentext"><span class="kobospan" id="kobo.151.1">Client ID</span></strong><span class="kobospan" id="kobo.152.1">, which the </span><em class="italic"><span class="kobospan" id="kobo.153.1">SportsStore</span></em><span class="kobospan" id="kobo.154.1"> application will use to identify itself to Google, and the Client Secret, which will be used to sign and verify the data produced by Google. </span><span class="kobospan" id="kobo.154.2">Perform the following steps: </span></p>
<ol class="calibre6">
<li class="bulletlist1" value="1"><span class="kobospan" id="kobo.155.1">Click </span><strong class="screentext"><span class="kobospan" id="kobo.156.1">Credentials</span></strong><span class="kobospan" id="kobo.157.1"> in the Google Developer dashboard.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.158.1">Click </span><strong class="screentext"><span class="kobospan" id="kobo.159.1">Create Credentials</span></strong><span class="kobospan" id="kobo.160.1"> and select </span><strong class="screentext"><span class="kobospan" id="kobo.161.1">OAuth Client ID</span></strong><span class="kobospan" id="kobo.162.1"> from the popup menu.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.163.1">Select </span><strong class="screentext"><span class="kobospan" id="kobo.164.1">Web Application</span></strong><span class="kobospan" id="kobo.165.1"> from the </span><strong class="screentext"><span class="kobospan" id="kobo.166.1">Application Type</span></strong><span class="kobospan" id="kobo.167.1"> menu and enter </span><code class="inlinecode"><span class="kobospan" id="kobo.168.1">SportsStore</span></code><span class="kobospan" id="kobo.169.1"> in the </span><strong class="screentext"><span class="kobospan" id="kobo.170.1">Name</span></strong><span class="kobospan" id="kobo.171.1"> field.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.172.1">No changes are required in the </span><strong class="screentext"><span class="kobospan" id="kobo.173.1">Authorized JavaScript Origins</span></strong><span class="kobospan" id="kobo.174.1"> section.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.175.1">Click the </span><strong class="screentext"><span class="kobospan" id="kobo.176.1">Add URI</span></strong><span class="kobospan" id="kobo.177.1"> button in the </span><strong class="screentext"><span class="kobospan" id="kobo.178.1">Authorized Redirect URIs</span></strong><span class="kobospan" id="kobo.179.1"> section and add </span><code class="inlinecode"><span class="kobospan" id="kobo.180.1">http://localhost:5000/signin-google</span></code><span class="kobospan" id="kobo.181.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.182.1">https://localhost/signin-google</span></code><span class="kobospan" id="kobo.183.1">.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.184.1">Click the </span><strong class="screentext"><span class="kobospan" id="kobo.185.1">Create</span></strong><span class="kobospan" id="kobo.186.1"> button.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.187.1">Copy the </span><strong class="screentext"><span class="kobospan" id="kobo.188.1">Client</span></strong> <strong class="screentext"><span class="kobospan" id="kobo.189.1">ID</span></strong><span class="kobospan" id="kobo.190.1"> and </span><strong class="screentext"><span class="kobospan" id="kobo.191.1">Client Secret</span></strong><span class="kobospan" id="kobo.192.1"> values from the popup summary and store them safely. </span><span class="kobospan" id="kobo.192.2">Each value is presented with a copy button that ensures that all of the characters are copied correctly.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.193.1">Click </span><a id="_idIndexMarker1024" class="calibre3"/><span class="kobospan" id="kobo.194.1">the </span><strong class="screentext"><span class="kobospan" id="kobo.195.1">OK</span></strong><span class="kobospan" id="kobo.196.1"> button to close the summary</span><a id="_idIndexMarker1025" class="calibre3"/><span class="kobospan" id="kobo.197.1"> popup.</span></li>
</ol>
<p class="normal"><span class="kobospan" id="kobo.198.1">At the end of the process, you will have two values to add to the </span><code class="inlinecode"><span class="kobospan" id="kobo.199.1">development.env</span></code><span class="kobospan" id="kobo.200.1"> file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.201.1">sportsstore</span></code><span class="kobospan" id="kobo.202.1"> folder, as shown in </span><em class="italic"><span class="kobospan" id="kobo.203.1">Listing 19.2</span></em><span class="kobospan" id="kobo.204.1">. </span><span class="kobospan" id="kobo.204.2">(This listing shows placeholder values. </span><span class="kobospan" id="kobo.204.3">You must replace these with the values you obtained from the Google portal for the examples to work.)</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.205.1">Using local redirection URLs</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.206.1">The authorized redirect</span><a id="_idIndexMarker1026" class="calibre3"/><span class="kobospan" id="kobo.207.1"> URLs used in step 5 use </span><code class="inlinecode"><span class="kobospan" id="kobo.208.1">localhost</span></code><span class="kobospan" id="kobo.209.1"> for the hostname, which means that clients will be told to redirect to the local machine once authentication has been performed. </span><span class="kobospan" id="kobo.209.2">This is useful for the SportsStore application, where the browser and the server run on the same machine. </span><span class="kobospan" id="kobo.209.3">For real projects, you must use the public-facing URL that points to your project, which can be resolved by users’ browsers. </span><span class="kobospan" id="kobo.209.4">This requires domain name registration, which is why the </span><em class="italic"><span class="kobospan" id="kobo.210.1">SportsStore</span></em><span class="kobospan" id="kobo.211.1"> uses localhost.</span><span> </span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.212.1">Listing 19.2: Storing secrets in the development.env file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.213.1"># secret used to sign session cookies
COOKIE_SECRET="sportsstoresecret"
# Google OAuth Credentials
GOOGLE_CLIENT_ID=enter client ID here
GOOGLE_CLIENT_SECRET=enter client secret here
</span></code></pre>
<h1 class="heading" id="_idParaDest-334"><span class="kobospan" id="kobo.214.1">Getting profile details with OAuth</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.215.1">The starting </span><a id="_idIndexMarker1027" class="calibre3"/><span class="kobospan" id="kobo.216.1">point is to extend the data model so that it is possible to associate customers in the database with their Google accounts. </span><span class="kobospan" id="kobo.216.2">When the OAuth service provides the SportsStore application with user data, a unique ID is included, which will be stored in the database alongside the customer’s name and email, and used to query the customer’s address if one is available in the SportsStore database. </span><em class="italic"><span class="kobospan" id="kobo.217.1">Listing 19.3</span></em><span class="kobospan" id="kobo.218.1"> adds a new property to the </span><code class="inlinecode"><span class="kobospan" id="kobo.219.1">Customer</span></code><span class="kobospan" id="kobo.220.1"> interface.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.221.1">Listing 19.3: Adding a property to the customer_models.ts file in the src/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.222.1">export interface Customer {
    id?: number;
    name: string;
    email: string;
  </span><strong class="screentext"><span class="kobospan" id="kobo.223.1">  federatedId?: string;</span></strong><span class="kobospan" id="kobo.224.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.225.1">The new property </span><a id="_idIndexMarker1028" class="calibre3"/><span class="kobospan" id="kobo.226.1">requires a validation rule, as shown in </span><em class="italic"><span class="kobospan" id="kobo.227.1">Listing 19.4</span></em><span class="kobospan" id="kobo.228.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.229.1">Listing 19.4: Adding a new property to the order_rules.ts file in the src/data/validation folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.230.1">import { Validator } from "./validator";
import { required, minLength, email, no_op } from "./basic_rules";
import { Address } from "../order_models";
import { Customer } from "../customer_models";
export const CustomerValidator = new Validator&lt;Customer&gt;({
    name: [required, minLength(6)],
    email: email,
   </span><strong class="screentext"><span class="kobospan" id="kobo.231.1"> federatedId: no_op</span></strong><span class="kobospan" id="kobo.232.1">
});
export const AddressValidator = new Validator&lt;Address&gt;({
    street: required,
    city: required,
    state: required,
    zip: no_op
});
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.233.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.234.1">no_op</span></code><span class="kobospan" id="kobo.235.1"> rule is used because no validation is required for the data provided by the OAuth process.</span></p>
<p class="normal"><span class="kobospan" id="kobo.236.1">A new set of</span><a id="_idIndexMarker1029" class="calibre3"/><span class="kobospan" id="kobo.237.1"> repository methods is required to store the new data and use it as the basis for queries. </span><span class="kobospan" id="kobo.237.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.238.1">customer_repository.ts</span></code><span class="kobospan" id="kobo.239.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.240.1">src/data</span></code><span class="kobospan" id="kobo.241.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.242.1">Listing 19.5</span></em><span class="kobospan" id="kobo.243.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.244.1">Listing 19.5: The contents of the customer_repository.ts file in the src/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.245.1">import { Customer } from "./customer_models";
import { Address } from "./order_models";
export interface CustomerRepository {
    getCustomer(id: number) : Promise&lt;Customer | null&gt;;
    getCustomerByFederatedId(id: string): Promise&lt;Customer | null&gt;;
    getCustomerAddress(id: number): Promise&lt;Address | null&gt;;
    storeCustomer(customer: Customer): Promise&lt;Customer&gt;;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.246.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.247.1">getCustomer</span></code><span class="kobospan" id="kobo.248.1"> method searches the database using the unique ID created by the database server. </span><span class="kobospan" id="kobo.248.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.249.1">getCustomerByFederatedId</span></code><span class="kobospan" id="kobo.250.1"> method does the same thing but uses the unique ID that Google provides in the OAuth profile. </span><span class="kobospan" id="kobo.250.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.251.1">getCustomerAddress</span></code><span class="kobospan" id="kobo.252.1"> method will return the most recent address associated with the user. </span><span class="kobospan" id="kobo.252.2">There won’t be an address until an order has been placed, but the data that is stored will be available for the second and subsequent orders the customer creates. </span><span class="kobospan" id="kobo.252.3">The final method, named </span><code class="inlinecode"><span class="kobospan" id="kobo.253.1">storeCustomer</span></code><span class="kobospan" id="kobo.254.1">, will store a user in the database.</span></p>
<h2 class="heading1" id="_idParaDest-335"><span class="kobospan" id="kobo.255.1">Implementing the new repository features</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.256.1">The next step is to update</span><a id="_idIndexMarker1030" class="calibre3"/><span class="kobospan" id="kobo.257.1"> the Sequelize implementation of the repository. </span><em class="italic"><span class="kobospan" id="kobo.258.1">Listing 19.6</span></em><span class="kobospan" id="kobo.259.1"> adds a property to the ORM model class.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.260.1">Listing 19.6: Adding a property to the customer_models.ts file in the src/data/orm/models folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.261.1">import { Model, CreationOptional, InferAttributes, InferCreationAttributes }
    from "sequelize";
import { Customer } from "../../customer_models";
export class CustomerModel extends Model&lt;InferAttributes&lt;CustomerModel&gt;,
        InferCreationAttributes&lt;CustomerModel&gt;&gt; implements Customer {
    declare id?: CreationOptional&lt;number&gt;;
    declare name: string;
    declare email: string;
 </span><strong class="screentext"><span class="kobospan" id="kobo.262.1">   declare federatedId?: string;</span></strong><span class="kobospan" id="kobo.263.1">
}
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.264.1">Listing 19.7</span></em><span class="kobospan" id="kobo.265.1"> describes</span><a id="_idIndexMarker1031" class="calibre3"/><span class="kobospan" id="kobo.266.1"> how the new property will be stored in the database.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.267.1">Listing 19.7: Describing a property in the customer_helpers.ts file in the src/data/orm/models folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.268.1">import { DataTypes, Sequelize } from "sequelize";
import { CustomerModel } from "./customer_models";
export const initializeCustomerModels = (sequelize: Sequelize) =&gt; {
    CustomerModel.init({
        id: { type: DataTypes.INTEGER, autoIncrement: true, primaryKey: true},
        name: { type: DataTypes.STRING},       
        email: { type: DataTypes.STRING },
      </span><strong class="screentext"><span class="kobospan" id="kobo.269.1">  federatedId: { type: DataTypes.STRING }</span></strong><span class="kobospan" id="kobo.270.1">
    }, { sequelize})
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.271.1">A new relationship between model classes is required to support the queries that will be performed by the new repository methods, as shown in </span><em class="italic"><span class="kobospan" id="kobo.272.1">Listing 19.8</span></em><span class="kobospan" id="kobo.273.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.274.1">Listing 19.8: Adding a new relationship to the order_helpers.ts file in the src/data/orm/models folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.275.1">import { DataTypes, Sequelize } from "sequelize";
import { OrderModel, ProductSelectionModel, AddressModel }
    from "./order_models";
import { CustomerModel } from "./customer_models";
import { ProductModel } from ".";
const primaryKey = {
    id: { type: DataTypes.INTEGER, autoIncrement: true, primaryKey: true }
};
   
export const initializeOrderModels = (sequelize: Sequelize) =&gt; {
   
    // ...statements omitted for brevity...
    </span><span class="kobospan" id="kobo.275.2">ProductSelectionModel.belongsTo(ProductModel, { as: "product"});
    </span><strong class="screentext"><span class="kobospan" id="kobo.276.1">AddressModel</span></strong><strong class="screentext"><span class="kobospan" id="kobo.277.1">.hasMany(OrderModel, { foreignKey: "addressId"});</span></strong><span class="kobospan" id="kobo.278.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.279.1">To implement</span><a id="_idIndexMarker1032" class="calibre3"/><span class="kobospan" id="kobo.280.1"> the methods required by the </span><code class="inlinecode"><span class="kobospan" id="kobo.281.1">CustomerRepository</span></code><span class="kobospan" id="kobo.282.1"> interface, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.283.1">customers.ts</span></code><span class="kobospan" id="kobo.284.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.285.1">src/data/orm</span></code><span class="kobospan" id="kobo.286.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.287.1">Listing 19.9</span></em><span class="kobospan" id="kobo.288.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.289.1">Listing 19.9: The contents of the customers.ts file in the src/data/orm folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.290.1">import { Customer } from "../customer_models";
import { CustomerRepository } from "../customer_repository";
import { Address } from "../order_models";
import { BaseRepo, Constructor } from "./core"
import { CustomerModel } from "./models/customer_models";
import { AddressModel, OrderModel } from "./models/order_models";
export function AddCustomers&lt;TBase extends
        Constructor&lt;BaseRepo&gt;&gt;(Base: TBase)  {
    return class extends Base implements CustomerRepository {
        getCustomer(id: number): Promise&lt;Customer | null&gt; {
            return CustomerModel.findByPk(id, {
                raw: true
            });
        }
        getCustomerByFederatedId(id: string): Promise&lt;Customer | null&gt; {
            return CustomerModel.findOne({
                where: { federatedId: id },
                raw: true
            })
        }
        getCustomerAddress(id: number): Promise&lt;Address | null&gt; {
            return AddressModel.findOne({
                include: [{
                    model: OrderModel,
                    where: { customerId: id },
                    attributes: []
                }],
                order: [["updatedAt", "DESC"]]
            });
        }
        async storeCustomer(customer: Customer): Promise&lt;Customer&gt; {
            const [data, created] = await CustomerModel.findOrCreate({
                where: { email: customer.email },
                defaults: customer,
            });
            if (!created) {
                data.name = customer.name;
                data.email = customer.email;
                data.federatedId = customer.federatedId;
                await data.save();
            }
            return data;
        }
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.291.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.292.1">getCustomer</span></code><span class="kobospan" id="kobo.293.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.294.1">getCustomerByFederatedId</span></code><span class="kobospan" id="kobo.295.1"> methods perform regular queries, but the </span><code class="inlinecode"><span class="kobospan" id="kobo.296.1">getCustomerAddress</span></code><span class="kobospan" id="kobo.297.1"> method has to query through another model class so that obtaining </span><a id="_idIndexMarker1033" class="calibre3"/><span class="kobospan" id="kobo.298.1">the most recent address for a customer is done by finding the customer’s earlier orders, and then obtaining the address data associated with them. </span><span class="kobospan" id="kobo.298.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.299.1">attributes</span></code><span class="kobospan" id="kobo.300.1"> property is used in the </span><code class="inlinecode"><span class="kobospan" id="kobo.301.1">include</span></code><span class="kobospan" id="kobo.302.1"> expression to exclude the order data from the responses. </span><span class="kobospan" id="kobo.302.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.303.1">storeCustomer</span></code><span class="kobospan" id="kobo.304.1"> method uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.305.1">findOrCreate</span></code><span class="kobospan" id="kobo.306.1"> method to find a customer by email address if one exists; otherwise, it creates a new customer</span><a id="_idIndexMarker1034" class="calibre3"/><span class="kobospan" id="kobo.307.1"> record. </span><em class="italic"><span class="kobospan" id="kobo.308.1">Listing 19.10</span></em><span class="kobospan" id="kobo.309.1"> includes the new methods in the repository mixin.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.310.1">Listing 19.10: Extending the mixin in the index.ts file in the src/data/orm folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.311.1">import { BaseRepo } from "./core";
import { AddQueries } from "./queries";
import { AddStorage } from "./storage";
import { AddOrderQueries } from "./order_queries";
import { AddOrderStorage } from "./order_storage";
</span><strong class="screentext"><span class="kobospan" id="kobo.312.1">import { AddCustomers } from "./customers";</span></strong><span class="kobospan" id="kobo.313.1">
const CatalogRepo = AddStorage(AddQueries(BaseRepo));
const RepoWithOrders = AddOrderStorage(AddOrderQueries(CatalogRepo));
</span><strong class="screentext"><span class="kobospan" id="kobo.314.1">const RepoWithCustomers = AddCustomers(RepoWithOrders);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.315.1">export</span></strong><strong class="screentext"><span class="kobospan" id="kobo.316.1"> const CatalogRepoImpl = RepoWithCustomers;</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.317.1">To complete the repository upgrade, Listing 19.11 adds a new property that exposes the new interface to the rest of the application.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.318.1">Listing 19.11: Adding a constant to the index.ts file in the src/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.319.1">import { CatalogRepository } from "./catalog_repository";
import { CatalogRepoImpl} from "./orm";
import { OrderRepository } from "./order_repository";
</span><strong class="screentext"><span class="kobospan" id="kobo.320.1">import { CustomerRepository } from "./customer_repository"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.321.1">;</span></strong><span class="kobospan" id="kobo.322.1">
const repo = new CatalogRepoImpl();
export const catalog_repository: CatalogRepository = repo;
export const order_repository: OrderRepository = repo;
</span><strong class="screentext"><span class="kobospan" id="kobo.323.1">export const customer_repository: CustomerRepository = repo;</span></strong>
</code></pre>
<h2 class="heading1" id="_idParaDest-336"><span class="kobospan" id="kobo.324.1">Setting Up OAuth authentication</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.325.1">To handle the details of </span><a id="_idIndexMarker1035" class="calibre3"/><span class="kobospan" id="kobo.326.1">OAuth requests and responses, I am going to use the Passport authentication package introduced in </span><em class="italic"><span class="kobospan" id="kobo.327.1">Chapter 18</span></em><span class="kobospan" id="kobo.328.1">, which has authentication strategies for major authentication services, including Google. </span><span class="kobospan" id="kobo.328.2">Run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.329.1">Listing 19.12</span></em><span class="kobospan" id="kobo.330.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.331.1">sportsstore</span></code><span class="kobospan" id="kobo.332.1"> folder to add the Passport package, the </span><a id="_idIndexMarker1036" class="calibre3"/><span class="kobospan" id="kobo.333.1">strategy package, and the type descriptions to the project. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.334.1">Listing 19.12: Installing the authentication packages</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.335.1">npm install passport@0.7.0
npm install passport-google-oauth20@2.0.0
npm install --save-dev @types/passport@1.0.16
npm install --save-dev @types/passport-google-oauth20@2.0.14
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.336.1">For quick reference, these packages are described in </span><em class="italic"><span class="kobospan" id="kobo.337.1">Table 19.1</span></em><span class="kobospan" id="kobo.338.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.339.1">Table 19.1: The Authentication Packages </span></p>
<table class="table-container" id="table001-16">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.340.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.341.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.342.1">passport</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.343.1">This package contains the core Passport features.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.344.1">passport-google-oauth20</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.345.1">This package contains a Passport strategy for authentication with the Google OAuth service.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.346.1">@types/passport</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.347.1">This package contains type information. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.348.1">@types/passport-google-oauth20</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.349.1">This package contains type information.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.350.1">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.351.1">authentication.ts</span></code><span class="kobospan" id="kobo.352.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.353.1">src</span></code><span class="kobospan" id="kobo.354.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.355.1">Listing 19.13</span></em><span class="kobospan" id="kobo.356.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.357.1">Listing 19.13: The contents of the authentication.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.358.1">import { Express } from "express";
import { getConfig, getSecret } from "./config";
import passport from "passport";
import { Strategy as GoogleStrategy, Profile, VerifyCallback }
    from "passport-google-oauth20";
import { customer_repository } from "./data";
import { Customer } from "./data/customer_models";
const callbackURL: string = getConfig("auth:openauth:redirectionUrl");
const clientID = getSecret("GOOGLE_CLIENT_ID");
const clientSecret = getSecret("GOOGLE_CLIENT_SECRET");
declare global {
    namespace Express {
        interface User extends Customer {  }
    }
}
export const createAuthentication = (app:Express) =&gt; {
    passport.use(new GoogleStrategy({
        clientID, clientSecret, callbackURL,
        scope: ["email", "profile"],
        state: true
    } , async (accessToken: string, refreshToken: string,
            profile: Profile, callback: VerifyCallback) =&gt; {
        const emailAddr = profile.emails?.[0].value ?? </span><span class="kobospan" id="kobo.358.2">"";           
        const customer = await customer_repository.storeCustomer({
            name: profile.displayName, email: emailAddr,
            federatedId: profile.id
        });
        const { id, name, email } = customer;
        return callback(null, { id, name, email });
    }));
    passport.serializeUser((user, callback) =&gt; {
        callback(null, user.id);
    });
    passport.deserializeUser((id: number, callbackFunc) =&gt; {
        customer_repository.getCustomer(id).then(user =&gt;
            callbackFunc(null, user));
    });
    app.use(passport.session());
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.359.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.360.1">declare</span></code><span class="kobospan" id="kobo.361.1"> keyword</span><a id="_idIndexMarker1037" class="calibre3"/><span class="kobospan" id="kobo.362.1"> is used to tell the TypeScript compiler that the </span><code class="inlinecode"><span class="kobospan" id="kobo.363.1">User</span></code><span class="kobospan" id="kobo.364.1"> objects added to authenticated requests by the </span><code class="inlinecode"><span class="kobospan" id="kobo.365.1">Passport</span></code><span class="kobospan" id="kobo.366.1"> package will extend the </span><code class="inlinecode"><span class="kobospan" id="kobo.367.1">Customer</span></code><span class="kobospan" id="kobo.368.1"> type. </span><span class="kobospan" id="kobo.368.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.369.1">createAuthentiction</span></code><span class="kobospan" id="kobo.370.1"> function sets up the Passport package to perform authentication using the Google OAuth service.</span></p>
<p class="normal"><span class="kobospan" id="kobo.371.1">The </span><a id="_idIndexMarker1038" class="calibre3"/><span class="kobospan" id="kobo.372.1">configuration module is used to get the redirection URL, which will be included in the authentication request sent to Google and to which browsers will be redirected once authentication is complete. </span><span class="kobospan" id="kobo.372.2">The URL must match the one used when setting up the OAuth credentials and, for real projects, should be a public-facing URL.</span></p>
<p class="normal"><span class="kobospan" id="kobo.373.1">The Client ID and Client Secret are read and used to configure the Google authentication strategy along with the URL:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.374.1">...
</span><span class="kobospan" id="kobo.374.2">passport.use(new GoogleStrategy({
    clientID, clientSecret, callbackURL,
    scope: ["email", "profile"]
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.375.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.376.1">scope</span></code><span class="kobospan" id="kobo.377.1"> settings specify which OAuth scopes will be requested and the </span><code class="inlinecode"><span class="kobospan" id="kobo.378.1">email</span></code><span class="kobospan" id="kobo.379.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.380.1">profile</span></code><span class="kobospan" id="kobo.381.1"> values correspond to the scopes used when setting up the OAuth service. </span><span class="kobospan" id="kobo.381.2">These two scopes give details of the user’s email addresses and their display name, which is all that’s needed for the </span><em class="italic"><span class="kobospan" id="kobo.382.1">SportsStore</span></em><span class="kobospan" id="kobo.383.1"> application.</span></p>
<div class="note">
<p class="normal"><span class="kobospan" id="kobo.384.1">There are many other scopes available, but they generally require applications to go through a vetting process before access is granted, whereas email and profile scopes can be used by any registered application.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.385.1">The final argument to the strategy constructor is a callback function that is invoked when Google has authenticated the user and performed the redirection:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.386.1">...
</span><span class="kobospan" id="kobo.386.2">} , async (accessToken: string, refreshToken: string,
        profile: Profile, callback: VerifyCallback) =&gt; {
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.387.1">The</span><a id="_idIndexMarker1039" class="calibre3"/><span class="kobospan" id="kobo.388.1"> callback function receives an access token, which can be used to make API queries, and a refresh token, which can be used to obtain a new access token. </span><span class="kobospan" id="kobo.388.2">Both tokens are described in the OAuth documentation (see </span><a href="https://www.oauth.com/oauth2-servers/access-tokens" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.389.1">https://www.oauth.com/oauth2-servers/access-tokens</span></span></a><span class="kobospan" id="kobo.390.1">) but they are not required for this example. </span><span class="kobospan" id="kobo.390.2">Instead, this example relies on the data provided by the third parameter, which is the user’s profile. </span><span class="kobospan" id="kobo.390.3">Profiles vary between providers, but Passport normalizes the data returned by the Google OAuth service like this (edited to replace real data values with the </span><code class="inlinecode"><span class="kobospan" id="kobo.391.1">X</span></code><span class="kobospan" id="kobo.392.1"> character): </span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.393.1">{
  id: '101XXXXXXXXXXXXXXXXXX',
  displayName: Alice Smith',
  name: { familyName: 'Smith', givenName: 'Alice' },
  emails: [ { value: alice@example.com', verified: true } ],
  photos: [{value: 'https://lh3.googleusercontent.com/a/XXXX'}],
  provider: 'google',
  _raw: '{\n' +
    '  "sub": "101XXXXXXXXXXXXXXXXXX",\n' +
    '  "name": "Alice Smith",\n' +
    '  "given_name": "Adam",\n' +
    '  "family_name": "Smith",\n' +
    '  "picture": "https://lh3.googleusercontent.com/a/XXXX",\n' +
    '  "email": "alice@example.com",\n' +
    '  "email_verified": true,\n' +
    '  "locale": "en"\n' +
    '}',
  _json: {
    sub: '101XXXXXXXXXXXXXXXXXX',
    name: Alice Smith',
    given_name: 'Alice',
    family_name: 'Smith',
    picture: 'https://lh3.googleusercontent.com/a/XXXX',
    email: 'alice@example.com',
    email_verified: true,
    locale: 'en'
  }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.394.1">A detailed explanation of the normalized profile can be found at </span><a href="https://www.passportjs.org/reference/normalized-profile" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.395.1">https://www.passportjs.org/reference/normalized-profile</span></span></a><span class="kobospan" id="kobo.396.1">, but the </span><em class="italic"><span class="kobospan" id="kobo.397.1">SportsStore</span></em><span class="kobospan" id="kobo.398.1"> application needs only the </span><code class="inlinecode"><span class="kobospan" id="kobo.399.1">id</span></code><span class="kobospan" id="kobo.400.1"> value, which uniquely identifies the user, the </span><code class="inlinecode"><span class="kobospan" id="kobo.401.1">given_name</span></code><span class="kobospan" id="kobo.402.1"> value, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.403.1">emails</span></code><span class="kobospan" id="kobo.404.1"> value, from which the user’s email address will be obtained.</span></p>
<p class="normal"><span class="kobospan" id="kobo.405.1">The final parameter is a callback that is invoked once the user’s data is ready. </span><span class="kobospan" id="kobo.405.2">The code in </span><em class="italic"><span class="kobospan" id="kobo.406.1">Listing 19.13</span></em><span class="kobospan" id="kobo.407.1"> uses the profile data to store the customer’s details and invokes the callback to provide Passport with the user object. </span><span class="kobospan" id="kobo.407.2">The implementation of the repository’s </span><code class="inlinecode"><span class="kobospan" id="kobo.408.1">storeCustomer</span></code><span class="kobospan" id="kobo.409.1"> method matches the </span><code class="inlinecode"><span class="kobospan" id="kobo.410.1">federatedId</span></code><span class="kobospan" id="kobo.411.1"> value if there is one, which means that the profile data will be used to update any existing data created for the same user in a previous order. </span></p>
<p class="normal"><span class="kobospan" id="kobo.412.1">The calls to the </span><code class="inlinecode"><span class="kobospan" id="kobo.413.1">passport.serializeUser</span></code><span class="kobospan" id="kobo.414.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.415.1">passport.deserializeUser</span></code><span class="kobospan" id="kobo.416.1"> are required to allow</span><a id="_idIndexMarker1040" class="calibre3"/><span class="kobospan" id="kobo.417.1"> Passport to serialize the user data into a session. </span><span class="kobospan" id="kobo.417.2">In this case, the unique ID assigned by the database is used to represent the serialized user, which is deserialized by querying the database. </span><span class="kobospan" id="kobo.417.3">This is the final statement in </span><em class="italic"><span class="kobospan" id="kobo.418.1">Listing 19.13</span></em><span class="kobospan" id="kobo.419.1">: </span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.420.1">...
</span><span class="kobospan" id="kobo.420.2">app.use(passport.session());
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.421.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.422.1">passport.session</span></code><span class="kobospan" id="kobo.423.1"> function returns a middleware function that will authenticate requests using the data stored in a session from other authentication mechanisms, and it has the effect of deserializing the user for requests when they have been authenticated using the Google OAuth service.</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.424.1">Listing 19.14</span></em><span class="kobospan" id="kobo.425.1"> calls the </span><code class="inlinecode"><span class="kobospan" id="kobo.426.1">createAuthentication</span></code><span class="kobospan" id="kobo.427.1"> function to enable authentication as part of the server startup.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.428.1">Listing 19.14: Enabling authentication in the server.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.429.1">import { createServer } from "http";
import express, { Express } from "express";
import helmet from "helmet";
import { getConfig } from "./config";
import { createRoutes } from "./routes";
import { createTemplates } from "./helpers";
import { createErrorHandlers } from "./errors";
import { createSessions } from "./sessions";
</span><strong class="screentext"><span class="kobospan" id="kobo.430.1">import { createAuthentication } from "./authentication";</span></strong><span class="kobospan" id="kobo.431.1">
const port = getConfig("http:port", 5000);
const expressApp: Express = express();
expressApp.use(helmet());
expressApp.use(express.json());
expressApp.use(express.urlencoded({extended: true}))
expressApp.use(express.static("node_modules/bootstrap/dist"));
expressApp.use(express.static("node_modules/bootstrap-icons"));
createTemplates(expressApp);
createSessions(expressApp);
</span><strong class="screentext"><span class="kobospan" id="kobo.432.1">createAuthentication(expressApp);</span></strong><span class="kobospan" id="kobo.433.1">
createRoutes(expressApp);
createErrorHandlers(expressApp);
const server = createServer(expressApp);
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.434.1">To </span><a id="_idIndexMarker1041" class="calibre3"/><span class="kobospan" id="kobo.435.1">complete the authentication setup, </span><em class="italic"><span class="kobospan" id="kobo.436.1">Listing 19.15</span></em><span class="kobospan" id="kobo.437.1"> adds a new section to the configuration file that specifies the callback that will be used for OAuth requests.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.438.1">Listing 19.15: Adding settings to the server.config.json file in the SportsStore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.439.1">{
    "http": {
        "port": 5000
    },
    // ...configuration sections omitted for brevity...
    </span><span class="kobospan" id="kobo.439.2">"sessions": {
        "maxAgeHrs": 2,
        "reset_db": true,
        "orm": {
            "settings": {
                "dialect": "sqlite",
                "storage": "sessions.db"
            },
            "logging": true
        }
    },
   </span><strong class="screentext"><span class="kobospan" id="kobo.440.1"> "auth": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.441.1">        "openauth": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.442.1">            "redirectionUrl": "http://localhost:5000/signin-google"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.443.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.444.1">    }</span></strong><span class="kobospan" id="kobo.445.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.446.1">As noted </span><a id="_idIndexMarker1042" class="calibre3"/><span class="kobospan" id="kobo.447.1">earlier, the </span><code class="inlinecode"><span class="kobospan" id="kobo.448.1">localhost</span></code><span class="kobospan" id="kobo.449.1"> URL relies on the browser and the server being on the same machine. </span><span class="kobospan" id="kobo.449.2">For real projects, a real domain name should be used, although </span><code class="inlinecode"><span class="kobospan" id="kobo.450.1">localhost</span></code><span class="kobospan" id="kobo.451.1"> can be useful during development.</span></p>
<h2 class="heading1" id="_idParaDest-337"><span class="kobospan" id="kobo.452.1">Changing the cookie configuration</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.453.1">OAuth is an </span><a id="_idIndexMarker1043" class="calibre3"/><span class="kobospan" id="kobo.454.1">excellent authentication system, but it can be finicky, and effort is often required to get everything working correctly. </span><span class="kobospan" id="kobo.454.2">One common cause of problems is the configuration for the session cookies, which must be set up to match the expectations of the OAuth strategy, whose requirements may be different from the rest of the application.</span></p>
<p class="normal"><span class="kobospan" id="kobo.455.1">When setting up OAuth for SportsStore, I found that I had to make two changes to get authentication working correctly, as shown in </span><em class="italic"><span class="kobospan" id="kobo.456.1">Listing 19.16</span></em><span class="kobospan" id="kobo.457.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.458.1">Listing 19.16: Changing cookie configuration in the sessions.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.459.1">...
</span><span class="kobospan" id="kobo.459.2">app.use(session({
    secret, store,
  </span><strong class="screentext"><span class="kobospan" id="kobo.460.1">  resave: false, saveUninitialized: true,</span></strong><span class="kobospan" id="kobo.461.1">
    cookie: {
        maxAge: config.maxAgeHrs * 60 * 60 * 1000,
        </span><strong class="screentext"><span class="kobospan" id="kobo.462.1">sameSite: false, httpOnly: false, secure</span></strong><strong class="screentext"><span class="kobospan" id="kobo.463.1">: false }</span></strong><span class="kobospan" id="kobo.464.1">
}));
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.465.1">You may</span><a id="_idIndexMarker1044" class="calibre3"/><span class="kobospan" id="kobo.466.1"> need different configuration settings for other strategies or authentication providers, and some experimentation is usually required because session settings are not usually specified. </span></p>
<h2 class="heading1" id="_idParaDest-338"><span class="kobospan" id="kobo.467.1">Applying authentication</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.468.1">The next step is to present the user</span><a id="_idIndexMarker1045" class="calibre3"/><span class="kobospan" id="kobo.469.1"> with a button that will allow them to sign in with Google, as shown in </span><em class="italic"><span class="kobospan" id="kobo.470.1">Listing 19.17</span></em><span class="kobospan" id="kobo.471.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.472.1">Listing 19.17. </span><span class="kobospan" id="kobo.472.2">Adding a Google button to the order_details.handlebars fle in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.473.1">&lt;form method="post" action="/checkout"&gt;
    </span><strong class="screentext"><span class="kobospan" id="kobo.474.1">&lt;div class="container"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.475.1">        &lt;div class="row flex-row align-items-center"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.476.1">            &lt;div</span></strong><strong class="screentext"><span class="kobospan" id="kobo.477.1"> class="col-7"&gt;{{&gt; order_details_customer }}&lt;/div&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.478.1">            &lt;div class="col"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.479.1">                &lt;div</span></strong><strong class="screentext"><span class="kobospan" id="kobo.480.1"> class="d-flex justify-content-center"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.481.1">                    &lt;a class="btn btn-primary" href="/checkout/google"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.482.1">                        &lt;i</span></strong><strong class="screentext"><span class="kobospan" id="kobo.483.1"> class="bi bi-google"&gt;&lt;/i&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.484.1">                        Use Google Account</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.485.1">                    &lt;/a&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.486.1">                &lt;/div&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.487.1">            &lt;/div&gt;</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.488.1">&lt;/div&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.489.1">        &lt;div class="row"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.490.1">            {{&gt; order_details_address }}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.491.1">        &lt;/div&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.492.1">        &lt;div class</span></strong><strong class="screentext"><span class="kobospan" id="kobo.493.1">="row"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.494.1">            &lt;div class="m-2"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.495.1">                &lt;button type="submit" class</span></strong><strong class="screentext"><span class="kobospan" id="kobo.496.1">="btn btn-primary"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.497.1">                    Place Order</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.498.1">                &lt;/button&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.499.1">                &lt;a href="/cart?returnUrl={{ escapeUrl (navigationUrl )}}"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.500.1">                    class="btn btn-primary"&gt;Back</span></strong><strong class="screentext"><span class="kobospan" id="kobo.501.1">&lt;/a&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.502.1">            &lt;/div&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.503.1">        &lt;/div&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.504.1">    &lt;/div&gt;</span></strong><span class="kobospan" id="kobo.505.1">
&lt;/form&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.506.1">The new</span><a id="_idIndexMarker1046" class="calibre3"/><span class="kobospan" id="kobo.507.1"> element structure is configured with the Bootstrap CSS classes to create a grid, with the elements for the name and email address sharing a row with a new button that contains a Google icon from the Bootstrap Icons package and prompts the user to use their Google account. </span><em class="italic"><span class="kobospan" id="kobo.508.1">Listing 19.18</span></em><span class="kobospan" id="kobo.509.1"> defines the routes that support OAuth and use the customer’s Google details.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.510.1">Listing 19.18: Supporting OAuth in the orders.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.511.1">import { Express } from "express";
import { Address } from "../data/order_models";
import { AddressValidator, CustomerValidator, ValidationResults, getData, isValid }
    from "../data/validation";
import { Customer } from "../data/customer_models";
import { createAndStoreOrder } from "./order_helpers";
</span><strong class="screentext"><span class="kobospan" id="kobo.512.1">import { customer_repository } from "../data";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.513.1">import passport from "passport";</span></strong><span class="kobospan" id="kobo.514.1">
declare module "express-session" {
    interface SessionData {
       orderData?: {
            customer?: ValidationResults&lt;Customer&gt;,
            address?: ValidationResults&lt;Address&gt;
       },
       pageSize?: string;
    }
}
export const createOrderRoutes = (app: Express) =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.515.1">app.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.516.1">get("/checkout/google", passport.authenticate("google"));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.517.1">    app.get("/signin-google", passport.authenticate("google",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.518.1">        { successRedirect: "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.519.1">/checkout", keepSessionInfo: true }));</span></strong><span class="kobospan" id="kobo.520.1">
    app.get("/checkout", async (req, resp) =&gt; {
       </span><strong class="screentext"><span class="kobospan" id="kobo.521.1"> if (!req.session.orderData &amp;&amp; req.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.522.1">user) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.523.1">            req.session.orderData = {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.524.1">                customer: await CustomerValidator.validate(req.user),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.525.1">                address: await </span></strong><strong class="screentext"><span class="kobospan" id="kobo.526.1">AddressValidator.validate(</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.527.1">                    await customer_repository.getCustomerAddress(</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.528.1">                        req.user?.id ?? </span><span class="kobospan" id="kobo.528.2">0) ?? </span><span class="kobospan" id="kobo.528.3">{})  </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.529.1">            }</span></strong>
<strong class="screentext"> </strong><span class="kobospan" id="kobo.530.1"> }
        req.session.pageSize =
            req.session.pageSize ?? </span><span class="kobospan" id="kobo.530.2">req.query.pageSize?.toString() ?? </span><span class="kobospan" id="kobo.530.3">"3";
        resp.render("order_details", {
            order: req.session.orderData,
            page: 1,
            pageSize: req.session.pageSize
        });
    });
    // ...other routes omitted for brevity...
</span><span class="kobospan" id="kobo.530.4">}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.531.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.532.1">/checkout/google</span></code><span class="kobospan" id="kobo.533.1"> route is </span><a id="_idIndexMarker1047" class="calibre3"/><span class="kobospan" id="kobo.534.1">targeted by the button created in </span><em class="italic"><span class="kobospan" id="kobo.535.1">Listing 19.17</span></em><span class="kobospan" id="kobo.536.1">, and its job is to start the OAuth process by requiring authentication with the </span><code class="inlinecode"><span class="kobospan" id="kobo.537.1">google</span></code><span class="kobospan" id="kobo.538.1"> strategy:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.539.1">...
</span><span class="kobospan" id="kobo.539.2">app.get("/checkout/google", </span><strong class="screentext"><span class="kobospan" id="kobo.540.1">passport.authenticate("google")</span></strong><span class="kobospan" id="kobo.541.1">);
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.542.1">Each Passport strategy module has a default name, and </span><code class="inlinecode"><span class="kobospan" id="kobo.543.1">google</span></code><span class="kobospan" id="kobo.544.1"> is the name of the strategy added to the project in </span><em class="italic"><span class="kobospan" id="kobo.545.1">Listing 19.13</span></em><span class="kobospan" id="kobo.546.1">. </span><span class="kobospan" id="kobo.546.2">The effect of this route is to redirect the user’s browser to the Google OAuth service.</span></p>
<p class="normal"><span class="kobospan" id="kobo.547.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.548.1">/signin-google</span></code><span class="kobospan" id="kobo.549.1"> route handles the redirection back from Google when the authentication process is complete and also requires authentication with the </span><code class="inlinecode"><span class="kobospan" id="kobo.550.1">google</span></code><span class="kobospan" id="kobo.551.1"> strategy:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.552.1">...
</span><span class="kobospan" id="kobo.552.2">app.get("/signin-google", </span><strong class="screentext"><span class="kobospan" id="kobo.553.1">passport.authenticate("google",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.554.1">        { successRedirect: "/checkout", keepSessionInfo: true })</span></strong><span class="kobospan" id="kobo.555.1">);
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.556.1">This time, the</span><a id="_idIndexMarker1048" class="calibre3"/><span class="kobospan" id="kobo.557.1"> authentication strategy will process the data sent by Google to authenticate the user and, if authentication has been successful, perform a redirection to the </span><code class="inlinecode"><span class="kobospan" id="kobo.558.1">/checkout</span></code><span class="kobospan" id="kobo.559.1"> URL. </span><span class="kobospan" id="kobo.559.2">If authentication is not successful, then an error message will be displayed using the custom error handlers. </span><span class="kobospan" id="kobo.559.3">The </span><code class="inlinecode"><span class="kobospan" id="kobo.560.1">keepSessionInfo</span></code><span class="kobospan" id="kobo.561.1"> setting ensures that existing session data is preserved once the user is authenticated.</span></p>
<p class="normal"><span class="kobospan" id="kobo.562.1">The changes to the handler for the </span><code class="inlinecode"><span class="kobospan" id="kobo.563.1">/checkout</span></code><span class="kobospan" id="kobo.564.1"> URL populate the order data for authenticated requests. </span><span class="kobospan" id="kobo.564.2">The user data added to the </span><code class="inlinecode"><span class="kobospan" id="kobo.565.1">Request</span></code><span class="kobospan" id="kobo.566.1"> object is used for the customer’s name and email address, and a query for the most recent address associated with the user is performed. </span><span class="kobospan" id="kobo.566.2">There won’t be an address the first time a user creates an order because that’s not part of the profile data, but an address will be available for subsequent orders.</span></p>
<h1 class="heading" id="_idParaDest-339"><span class="kobospan" id="kobo.567.1">Using the OAuth profile data</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.568.1">Open a new </span><a id="_idIndexMarker1049" class="calibre3"/><span class="kobospan" id="kobo.569.1">guest tab or private tab in your browser. </span><span class="kobospan" id="kobo.569.2">Browsers use different names for these features, but the goal is to check the authentication process without interference from any cookies the browser may have stored, including cookies from Google.</span></p>
<p class="normal"><span class="kobospan" id="kobo.570.1">Navigate to </span><code class="inlinecode"><span class="kobospan" id="kobo.571.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.572.1">, add a product to the cart, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.573.1">Checkout</span></strong> <a id="_idIndexMarker1050" class="calibre3"/><span class="kobospan" id="kobo.574.1">button. </span><span class="kobospan" id="kobo.574.2">Click the </span><strong class="screentext"><span class="kobospan" id="kobo.575.1">Use Google Account</span></strong><span class="kobospan" id="kobo.576.1"> button, as shown in </span><em class="italic"><span class="kobospan" id="kobo.577.1">Figure 19.6</span></em><span class="kobospan" id="kobo.578.1">. </span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.579.1"><img alt="" src="../Images/B21959_19_06.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.580.1">Figure 19.6: Starting the OAuth process</span></p>
<p class="normal"><span class="kobospan" id="kobo.581.1">Your browser will be redirected to Google, where you will be prompted to authenticate and sign in to </span><em class="italic"><span class="kobospan" id="kobo.582.1">SportsStore</span></em><span class="kobospan" id="kobo.583.1">, as shown in </span><em class="italic"><span class="kobospan" id="kobo.584.1">Figure 19.7</span></em><span class="kobospan" id="kobo.585.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.586.1"><img alt="" src="../Images/B21959_19_07.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.587.1">Figure 19.7: Authenticating with Google</span></p>
<p class="normal"><span class="kobospan" id="kobo.588.1">The authentication process can differ based on the Google account settings. </span><span class="kobospan" id="kobo.588.2">The account shown in </span><em class="italic"><span class="kobospan" id="kobo.589.1">Figure 19.5</span></em><span class="kobospan" id="kobo.590.1"> is configured to require additional confirmation using a smartphone, which is just one approach that Google supports to confirm authentication.</span></p>
<p class="normal"><span class="kobospan" id="kobo.591.1">Once Google</span><a id="_idIndexMarker1051" class="calibre3"/><span class="kobospan" id="kobo.592.1"> has authenticated the account, the browser is redirected back to the </span><em class="italic"><span class="kobospan" id="kobo.593.1">SportsStore</span></em><span class="kobospan" id="kobo.594.1"> application, and the account profile data will be used to populate the name and email address fields in the checkout form. </span><span class="kobospan" id="kobo.594.2">Complete the form and place the order, as shown in </span><em class="italic"><span class="kobospan" id="kobo.595.1">Figure 19.8</span></em><span class="kobospan" id="kobo.596.1">.</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.597.1">Addressing common causes of problems</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.598.1">There are some common problems to check if you don’t get the expected result. </span><span class="kobospan" id="kobo.598.2">First, make sure that you have set the </span><strong class="screentext"><span class="kobospan" id="kobo.599.1">Client ID</span></strong><span class="kobospan" id="kobo.600.1"> and </span><strong class="screentext"><span class="kobospan" id="kobo.601.1">Client Secret</span></strong><span class="kobospan" id="kobo.602.1"> exactly as shown in the Google developer console. </span><span class="kobospan" id="kobo.602.2">If these are not set correctly, then Google may not allow the user to authenticate, or the application won’t be able to verify the data that Google provides in the redirection. </span><span class="kobospan" id="kobo.602.3">There is an option to download a JSON document containing both values, which is a useful way to make sure you have the correct data.</span></p>
<p class="normal"><span class="kobospan" id="kobo.603.1">Second, make sure the same redirection URLs are configured in both the application and the Google developer console. </span><span class="kobospan" id="kobo.603.2">If these are not set correctly, then Google won’t redirect the browser to the right location.</span></p>
<p class="normal"><span class="kobospan" id="kobo.604.1">Third, check the session cookie settings. </span><span class="kobospan" id="kobo.604.2">If authentication with Google works but the profile data isn’t used to populate the form, then the likely cause is that new sessions are being created for each request in the authentication sequence, or that the state data required to validate the data sent by Google isn’t being stored.</span></p>
<p class="normal"><span class="kobospan" id="kobo.605.1">Finally, keep an eye on the Node.js console during the authentication process. </span><span class="kobospan" id="kobo.605.2">If the application is configured to reset the databases, an application restart will drop the session database and prevent authentication from completing. </span><span class="kobospan" id="kobo.605.3">The development tools for the </span><em class="italic"><span class="kobospan" id="kobo.606.1">SportsStore</span></em><span class="kobospan" id="kobo.607.1"> project are set up to restart the application if any file change is detected, and this may be triggered by a different process running on your development machine. </span><span class="kobospan" id="kobo.607.2">(For example, I use an application that creates a snapshot of my code folder every hour, and this causes a restart.) If you suspect this is the case, then change the two </span><code class="inlinecode"><span class="kobospan" id="kobo.608.1">reset_db</span></code><span class="kobospan" id="kobo.609.1"> settings to false in the </span><code class="inlinecode"><span class="kobospan" id="kobo.610.1">server.config.json</span></code><span class="kobospan" id="kobo.611.1"> file so that restarts don’t delete the contents of the databases.</span></p>
</div>
<figure class="mediaobject"><span class="kobospan" id="kobo.612.1"><img alt="" src="../Images/B21959_19_08.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.613.1">Figure 19.8: Placing an initial order</span></p>
<h2 class="heading1" id="_idParaDest-340"><span class="kobospan" id="kobo.614.1">Placing a second order</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.615.1">The address data stored</span><a id="_idIndexMarker1052" class="calibre3"/><span class="kobospan" id="kobo.616.1"> when the order is created will be available the next time the same user creates an order. </span><span class="kobospan" id="kobo.616.2">Request </span><code class="inlinecode"><span class="kobospan" id="kobo.617.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.618.1"> and go through the checkout process again. </span><span class="kobospan" id="kobo.618.2">When you click the </span><strong class="screentext"><span class="kobospan" id="kobo.619.1">Use Google Account</span></strong><span class="kobospan" id="kobo.620.1"> button, the entire form should be populated, as shown in </span><em class="italic"><span class="kobospan" id="kobo.621.1">Figure 19.9</span></em><span class="kobospan" id="kobo.622.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.623.1"><img alt="" src="../Images/B21959_19_09.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.624.1">Figure 19.9: Using address data from a previous order</span></p>
<p class="normal"><span class="kobospan" id="kobo.625.1">You typically </span><a id="_idIndexMarker1053" class="calibre3"/><span class="kobospan" id="kobo.626.1">won’t need to sign in to the Google account again because Google stores an authentication cookie. </span><span class="kobospan" id="kobo.626.2">The browser is still redirected to the Google OAuth service, but the user doesn’t see this request or the subsequent redirection back to </span><em class="italic"><span class="kobospan" id="kobo.627.1">SportsStore</span></em><span class="kobospan" id="kobo.628.1">.</span></p>
<h1 class="heading" id="_idParaDest-341"><span class="kobospan" id="kobo.629.1">Summary</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.630.1">In this chapter, I added support for users to identify themselves to the </span><em class="italic"><span class="kobospan" id="kobo.631.1">SportsStore</span></em><span class="kobospan" id="kobo.632.1"> application using their Google account:</span></p>
<ul class="calibre4">
<li class="bulletlist"><span class="kobospan" id="kobo.633.1">The OAuth protocol allows users to authenticate themselves without providing their credentials to the application.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.634.1">Most major platforms offer an OAuth service, including Google, and there is a registration process to perform before the application can send OAuth requests.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.635.1">There are differences in the data provided by OAuth services, but these are normalized by the </span><code class="inlinecode"><span class="kobospan" id="kobo.636.1">Passport</span></code><span class="kobospan" id="kobo.637.1"> authentication package.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.638.1">Once the user has associated their Google credentials with a </span><em class="italic"><span class="kobospan" id="kobo.639.1">SportsStore</span></em><span class="kobospan" id="kobo.640.1"> order, their address will be loaded automatically when checking out in the future.</span></li>
</ul>
<p class="normal"><span class="kobospan" id="kobo.641.1">In the next chapter, I will add administration tools that manage the </span><em class="italic"><span class="kobospan" id="kobo.642.1">SportsStore</span></em><span class="kobospan" id="kobo.643.1"> product catalog and change the order shipping status.</span></p>
</div>
</body></html>