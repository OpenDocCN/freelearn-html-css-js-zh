<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Deploying to the End User</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem">Deploying to Rackspace Cloud Files</li><li class="listitem">Deploying to AWS S3</li><li class="listitem">Deploying over FTP</li><li class="listitem">Deploying over SFTP</li><li class="listitem">Deploying to GitHub Pages</li><li class="listitem">Invalidating an AWS CloudFront distribution</li><li class="listitem">Running commands over SSH</li></ul></div><div><div><div><div><h1 class="title"><a id="ch07lvl1sec67"/>Introduction</h1></div></div></div><p>Once our web application is built and its assets are optimized for optimal delivery and consumption, it's time to make it available to our intended audience. This primarily involves transferring the assets that make up the application to some form of file hosting system that is dedicated to the delivery of static content over the Internet.</p><p>The primary points of focus in deploying the assets of a web application to the Internet are availability, speed, and service integration. Assets should always be available from anywhere in the world, be delivered as fast as possible, and the host system should allow us to easily upload and manage our content.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec68"/>Deploying to Rackspace Cloud Files</h1></div></div></div><p>In this <a id="id301" class="indexterm"/>recipe, we'll make use of the <code class="literal">cloudfiles (0.3.0)</code> plugin to upload files to a <strong>Rackspace Cloud Files</strong> container.</p><p>The Cloud Files service has the added benefit of providing a <a id="id302" class="indexterm"/>
<strong>Content Delivery Network</strong> (<strong>CDN</strong>) service to all content hosted on it, by default.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec161"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure that we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>The following<a id="id303" class="indexterm"/> example will also require a <strong>Rackspace Cloud</strong> account with an API key defined. We'll also need to create a Cloud Files container named <code class="literal">myapp</code> and configure it to host a <a id="id304" class="indexterm"/>
<strong>static website</strong>.</p><div><h3 class="title"><a id="tip75"/>Tip</h3><p>Refer to the following URL for <a id="id305" class="indexterm"/>more information on configuring a Cloud Files container to host a static website:</p><p><a class="ulink" href="http://docs.rackspace.com/files/api/v1/cf-devguide/content/Create_Static_Website-dle4000.html">http://docs.rackspace.com/files/api/v1/cf-devguide/content/Create_Static_Website-dle4000.html</a></p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec162"/>How to do it...</h2></div></div></div><p>The following steps take us through creating a simple HTML document and a task that uploads it to a Cloud Files container:</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by installing the package that contains the <code class="literal">cloudfiles</code> plugin, as per the instructions provided in the <em>Installing a plugin</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>.</li><li class="listitem">Next, we'll create a simple HTML document called <code class="literal">index.html</code> in the project directory, and provide it with the following contents:<div><pre class="programlisting">&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;MyApp&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;This is MyApp.&lt;/h1&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div></li><li class="listitem">Now, we'll add the following <code class="literal">cloudfiles</code> task to our configuration, which will indicate that we'd like to have the <code class="literal">index.html</code> file uploaded to the <code class="literal">myapp</code> Cloud Files container:<div><pre class="programlisting">cloudfiles: {
  myapp: {
    user: '[username]',
    key: '[api key]',
    region: 'LON',
    upload: [{
      container: 'myapp',
      src: 'index.html',
    }]
  }
}</pre></div><div><h3 class="title"><a id="tip76"/>Tip</h3><p>The <code class="literal">user</code> and <code class="literal">key</code> options are filled with placeholder values to indicate that you should make use of your own Rackspace Cloud account's username and API key.</p><p>You'll probably want to have the <code class="literal">user</code> and <code class="literal">key</code> options stored in a local file, as opposed to a shared repository. Refer to the <em>Importing external data</em> recipe of <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em> for an example of how to import configurations from external files. Also, be sure to exclude files that contain access credentials from your project's code repository.</p><p>The <code class="literal">region</code> option<a id="id306" class="indexterm"/> is used to indicate the geographical region of the hosted Cloud Files container. The desired region is indicated on creation of the container. For our example, we created a container in the <code class="literal">LON</code> region.</p></div></li><li class="listitem">We<a id="id307" class="indexterm"/> can now run the task by using the <code class="literal">grunt cloudfiles</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "cloudfiles:myapp" (cloudfiles) task</strong>
<strong>Uploading into myapp</strong>
<strong>Syncing files to container: myapp</strong>
<strong>Uploading index.html to myapp (NEW)</strong>
</pre></div></li><li class="listitem">We can now ensure that the file has been uploaded to our container and is accessible via the Internet. To do this, we'll need to determine the target domain of the container from its settings and navigate to it in our browser. This should look something like the following:<div><img src="img/image00274.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec163"/>There's more...</h2></div></div></div><p>The <a id="id308" class="indexterm"/>
<code class="literal">cloudfiles</code> task provides us with several useful options that can be used in conjunction with its basic <a id="id309" class="indexterm"/>uploading feature. We'll be looking at uploading the contents of a directory to a destination directory.</p><div><div><div><div><h3 class="title"><a id="ch07lvl3sec100"/>Uploading the contents of a directory</h3></div></div></div><p>In <a id="id310" class="indexterm"/>case we'd like to upload the contents of a directory, we can make use of the standard globbing patterns supported by Grunt in the <code class="literal">src</code> option. We would, however, probably also want to make use of the <code class="literal">stripcomponents</code> option to remove the leading paths from the directory names of the destination files.</p><p>The following example will upload the contents of the <code class="literal">www</code> directory to the <code class="literal">myapp</code> container, and <a id="id311" class="indexterm"/>strip the first path name from the target files when determining the destination file names:</p><div><pre class="programlisting">cloudfiles: {
  myapp: {
    user: 'juriejan',
    key: 'c980b9327b823b96dd83b51cdc5cf7dd',
    region: 'LON',
    upload: [{
      container: 'myapp',
      <strong>src: 'www/**/*',</strong>
<strong>      stripcomponents: 1</strong>
    }]
  }
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec101"/>Uploading to a destination directory</h3></div></div></div><p>In case <a id="id312" class="indexterm"/>we'd like to upload files to a specific destination directory on our target container, we can indicate the target directory by using the <code class="literal">dest</code> option, as shown in the following example:</p><div><pre class="programlisting">cloudfiles: {
  myapp: {
    user: 'juriejan',
    key: 'c980b9327b823b96dd83b51cdc5cf7dd',
    region: 'LON',
    upload: [{
      container: 'myapp',
      src: 'index.html',
      <strong>dest: '/htmlfiles/'</strong>
    }]
  }
}</pre></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec69"/>Deploying to AWS S3</h1></div></div></div><p>In<a id="id313" class="indexterm"/> this recipe, we'll make use of the <code class="literal">aws-s3 (0.12.3)</code> plugin to upload files to an <a id="id314" class="indexterm"/>
<strong>AWS S3 bucket</strong>.</p><p>This service doesn't provide a CDN setup by default, but can be easily integrated with <strong>AWS CloudFront</strong><a id="id315" class="indexterm"/> in order to speed up the distribution of the hosted files.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec164"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure that we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>In addition <a id="id316" class="indexterm"/>to the standard project setup, the following recipe will also require the setup of an <strong>AWS user</strong><a id="id317" class="indexterm"/> with an <a id="id318" class="indexterm"/>
<strong>AWS access key</strong>.</p><div><h3 class="title"><a id="tip77"/>Tip</h3><p>Refer to the following <a id="id319" class="indexterm"/>URL for details on how to obtain your AWS security credentials:</p><p><a class="ulink" href="http://docs.aws.amazon.com/general/latest/gr/getting-aws-sec-creds.html">http://docs.aws.amazon.com/general/latest/gr/getting-aws-sec-creds.html</a></p></div><p>A bucket with a name in the <code class="literal">[name].myapp</code> format will also need to be created, with <code class="literal">[name]</code> being any unique name that you wish to use. The aforementioned user should also have full access granted to the created bucket using the <a id="id320" class="indexterm"/>
<strong>AWS IAM</strong> interface.</p><div><h3 class="title"><a id="tip78"/>Tip</h3><p>Refer to the following URL for more information on how to grant a user account access to an S3 bucket:</p><p><a class="ulink" href="http://blogs.aws.amazon.com/security/post/Tx3VRSWZ6B3SHAV/Writing-IAM-Policies-How-to-grant-access-to-an-Amazon-S3-bucket">http://blogs.aws.amazon.com/security/post/Tx3VRSWZ6B3SHAV/Writing-IAM-Policies-How-to-grant-access-to-an-Amazon-S3-bucket</a></p></div><p>In order for the bucket to behave as required, it should also be configured for <a id="id321" class="indexterm"/>
<strong>static website hosting</strong>, and <code class="literal">index.html</code> should be defined as its <a id="id322" class="indexterm"/>
<strong>index document</strong>.</p><div><h3 class="title"><a id="tip79"/>Tip</h3><p>Refer to the following URL for more information on how to configure an <a id="id323" class="indexterm"/>AWS S3 bucket for static website hosting:</p><p><a class="ulink" href="http://docs.aws.amazon.com/AmazonS3/latest/dev/HowDoIWebsiteConfiguration.html">http://docs.aws.amazon.com/AmazonS3/latest/dev/HowDoIWebsiteConfiguration.html</a></p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec165"/>How to do it...</h2></div></div></div><p>The following steps take us through creating a sample HTML document and configuring a task that uploads it to an AWS S3 bucket:</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by installing the package that contains the <code class="literal">aws-s3</code> plugin, as per the instructions provided in the <em>Installing a plugin</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>.</li><li class="listitem">Next, we'll create a simple HTML document called <code class="literal">index.html</code> in the project directory, and provide it with the following contents:<div><pre class="programlisting">&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;MyApp&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;This is MyApp.&lt;/h1&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div></li><li class="listitem">Now, we'll <a id="id324" class="indexterm"/>add the following <code class="literal">aws_s3</code> task to our configuration, which indicates that we'd like to upload the <code class="literal">index.html</code> file to the <code class="literal">gruntbook.myapp</code> bucket:<div><pre class="programlisting">aws_s3: {
  myapp: {
    options: {
      accessKeyId: '[access key id]',
      secretAccessKey: '[secret access key]',
      region: 'eu-west-1',
      bucket: 'gruntbook.myapp',
    },
    files: [{
      src: 'index.html',
      dest: '/'
    }]
  }
}</pre></div><div><h3 class="title"><a id="tip80"/>Tip</h3><p>The <code class="literal">accessKeyId</code> and <code class="literal">secretAccessKey</code> options are filled with placeholder values to indicate that you should make use of your own AWS access credentials.</p><p>The <code class="literal">accessKeyId</code> option should be set to an <strong>access key ID</strong>,<a id="id325" class="indexterm"/> generated for your user using the <a id="id326" class="indexterm"/>
<strong>AWS Identity and Access Management</strong> (<strong>IAM</strong>) console.</p><p>The <code class="literal">secretAccessKey</code> option should be set to the <a id="id327" class="indexterm"/>
<strong>secret access key</strong> that was generated for the specific access key ID that you specified in the <code class="literal">accessKeyId</code> option. Note that the secret access key is only displayed on creation of the access key ID, so you won't be able to find it in the IAM console if you didn't save it the first time.</p><p>You'll probably want to have the <code class="literal">accessKeyId</code> and <code class="literal">secretAccessKey</code> options stored in a local file, as opposed to a shared repository. Refer to the <em>Importing external data</em> recipe of <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em> for an example of how to import configurations from external files. Also, be sure to exclude files that contain access credentials from your project's code repository.</p><p>The <code class="literal">region</code> option is used to indicate the geographical region of the hosted bucket. The desired region is indicated on creation of the bucket. For our example, we created a container in the <code class="literal">eu-west-1</code> region.</p><p>Note that the files configuration for this task supports all the standard Grunt options. You can read more about them at the following URL:</p><p><a class="ulink" href="http://gruntjs.com/configuring-tasks#files">http://gruntjs.com/configuring-tasks#files</a></p></div></li><li class="listitem">We can <a id="id328" class="indexterm"/>now run the task by using the <code class="literal">grunt aws_s3</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "aws_s3:myapp" (aws_s3) task</strong>
<strong>Uploading to https://s3-eu-west-1.amazonaws.com/gruntbook.myapp/</strong>
<strong>.</strong>
<strong>List: (1 objects):</strong>
<strong>- index.html -&gt; https://s3-eu-west-1.amazonaws.com/gruntbook.myapp/index.html</strong>
</pre></div></li><li class="listitem">We can now ensure that the file has been uploaded to our container and is accessible via the Internet. To do this, we'll need to determine the endpoint of the bucket from its properties section and navigate to it in our browser. This should look something like the following:<div><img src="img/image00275.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec166"/>There's more...</h2></div></div></div><p>The <a id="id329" class="indexterm"/>
<code class="literal">aws_s3</code> task <a id="id330" class="indexterm"/>provides us with several useful options that can be used in conjunction with its uploading feature. We'll look at how to specify the accessibility of uploaded files and enable concurrent operations.</p><div><div><div><div><h3 class="title"><a id="ch07lvl3sec102"/>Specifying the accessibility of uploaded files</h3></div></div></div><p>Every <a id="id331" class="indexterm"/>file uploaded to an AWS S3 bucket has a set of access permissions that indicate who has access to it. If we'd like to indicate a specific set of permissions, we can do so by using the <code class="literal">access</code> option. The following example sets the <code class="literal">access</code> option to <code class="literal">private</code>, indicating that all files uploaded should only be accessible to the user account that was used during the upload:</p><div><pre class="programlisting">aws_s3: {
  myapp: {
    options: {
      accessKeyId: 'AKIAJG27ICB3NTY3SGCQ',
      secretAccessKey: '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',
      region: 'eu-west-1',
      bucket: 'gruntbook.myapp',
      <strong>access: 'private'</strong>
    },
    files: [{
      src: 'index.html',
      dest: '/'
    }]
  }
}</pre></div><div><h3 class="title"><a id="tip81"/>Tip</h3><p>A list of the possible values for the access option is in the documentation for the AWS <code class="literal">putObject</code> operation at the following URL (look under the ACL parameter):</p><p><a class="ulink" href="http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#putObject-property">http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#putObject-property</a></p></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec103"/>Enabling concurrent uploads</h3></div></div></div><p>The <a id="id332" class="indexterm"/>default behavior for the <code class="literal">aws_s3</code> task is to complete uploads, one after another. If we'd like to perform uploads in parallel, we can do so by making use of the <code class="literal">uploadConcurrency</code> option. In the following example, we indicate that we'd like to have a maximum of <code class="literal">3</code> files uploaded simultaneously:</p><div><pre class="programlisting">aws_s3: {
  myapp: {
    options: {
      accessKeyId: 'AKIAJG27ICB3NTY3SGCQ',
      secretAccessKey: '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',
      region: 'eu-west-1',
      bucket: 'gruntbook.myapp',
      <strong>uploadConcurrency: 3</strong>
    },
    files: [{
      expand: true,
      cwd: 'www',
      src: '**/*',
      dest: '/'
    }]
  }
}</pre></div><div><h3 class="title"><a id="tip82"/>Tip</h3><p>The previous example also demonstrates the configuration involved in recursively uploading the contents of an entire directory.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec70"/>Deploying over FTP</h1></div></div></div><p>In this<a id="id333" class="indexterm"/> recipe, we will make use of the <code class="literal">ftp-push (0.3.2)</code> plugin to upload files to a hosting server, using the <strong>File Transfer Protocol</strong> (<strong>FTP</strong>).</p><p>FTP has <a id="id334" class="indexterm"/>been around since the early days of the Internet and is still in abundant use. As its name implies, it provides a way to transfer files over the Internet and as such, has been the staple for the deployment of resources to web servers since its inception.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec167"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure that we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>In addition to the standard project setup, the following recipe will also require an existing user account on the targeted FTP-enabled server. Their credentials are usually provided by the hosting service or the systems administrator in charge of maintaining the server in question.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec168"/>How to do it...</h2></div></div></div><p>The following steps take us through creating a simple HTML document and configuring a task that uploads it to a server using FTP:</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by installing the package that contains the <code class="literal">ftp-push</code> plugin, as per the instructions provided in the <em>Installing a plugin</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>.</li><li class="listitem">Next, we'll create a simple HTML document called <code class="literal">index.html</code> in the project directory, and provide it with the following contents:<div><pre class="programlisting">&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;MyApp&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;This is MyApp.&lt;/h1&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div></li><li class="listitem">Now, we'll add the following <code class="literal">ftp_push</code> task to our configuration and indicate <a id="id335" class="indexterm"/>that we'd like <a id="id336" class="indexterm"/>it to upload the <code class="literal">index.html</code> file to our hosting server:<div><pre class="programlisting">ftp_push: {
  myapp: {
    options: {
      host: '[host]',
      username: '[username]',
      password: '[password]',
      dest: '/www'
    },
    files: [{
      src: 'index.html',
    }]
  }
}</pre></div><div><h3 class="title"><a id="tip83"/>Tip</h3><p>The <code class="literal">username</code>, <code class="literal">password</code>, and <code class="literal">host</code> options are filled with placeholder values to indicate that you should make use of your own specific access credentials and hosting server address.</p><p>You'll probably want to have the <code class="literal">username</code> and <code class="literal">password</code> options stored in a local file, as opposed to a shared repository. Refer to the <em>Importing external data</em> recipe of <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em> for an example of how to import configurations from external files. Also, keep in mind that you should exclude files that contain access credentials from your project's code repository.</p><p>The <code class="literal">host</code> option<a id="id337" class="indexterm"/> is used to specify the Internet address of the server that you'd like to upload files to. If you are not sure what this value should be, this type of information can usually be provided to you by the hosting provider or the systems administrator in charge of maintaining the server in question.</p><p>The <code class="literal">dest</code> option<a id="id338" class="indexterm"/> is required to indicate the destination directory for the files that we'll be uploading. For our example, we'll indicate that files should be uploaded to the <code class="literal">www</code> directory on the hosting server.</p><p>Note that the files<a id="id339" class="indexterm"/> configuration for this task supports all the standard Grunt options. You can read more about them at the following URL:</p><p><a class="ulink" href="http://gruntjs.com/configuring-tasks#files">http://gruntjs.com/configuring-tasks#files</a></p></div></li><li class="listitem">We can now run the task by using the <code class="literal">grunt ftp_push</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "ftp_push:myapp" (ftp_push) task</strong>
<strong>&gt;&gt; [username] successfully authenticated!</strong>
<strong>&gt;&gt; /www/index.html transferred successfully.</strong>
<strong>&gt;&gt; FTP connection closed!</strong>
</pre></div><div><h3 class="title"><a id="tip84"/>Tip</h3><p>Note that the <code class="literal">ftp_push</code> task cannot automatically create the destination directory, so the <code class="literal">www</code> directory needs to exist on the root of the FTP server before running this task.</p></div></li><li class="listitem">Our <code class="literal">index.html</code> file should <a id="id340" class="indexterm"/>now be present on our<a id="id341" class="indexterm"/> hosting server and, if correctly configured, should be accessible via the Internet. Configuring a domain name to point to a site hosted in this fashion is beyond the scope of this book.</li></ol><div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec71"/>Deploying over SFTP</h1></div></div></div><p>In this<a id="id342" class="indexterm"/> recipe, we'll make use of the <code class="literal">sftp</code> task, which is provided by the <code class="literal">ssh (0.12.2)</code> plugin to upload files to a hosting server, using the <strong>SSH File Transfer Protocol</strong> (<strong>SFTP</strong>).</p><p>The SFTP provides the<a id="id343" class="indexterm"/> same functionality as the regular FTP that was discussed in the previous recipe, but with benefits from an added layer of security by making use of the <a id="id344" class="indexterm"/>
<strong>Secure Shell</strong> (<strong>SSH</strong>) network protocol.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec169"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure that we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>In addition to the standard project setup, the following recipe will also require an existing user account on the targeted SSH-enabled server. These credentials are usually provided by the hosting service or the systems administrator in charge of maintaining the targeted server.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec170"/>How to do it...</h2></div></div></div><p>The following steps take us through creating a simple HTML document and configuring a task that uploads <a id="id345" class="indexterm"/>it to the server using SFTP:</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by installing the package that contains the <code class="literal">ssh</code> plugin, as per the instructions provided in the <code class="literal">Installing a plugin</code> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>.</li><li class="listitem">Next, we'll create a simple HTML document called <code class="literal">index.html</code> in the project directory, and providing it with the following contents:<div><pre class="programlisting">&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;MyApp&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;This is MyApp.&lt;/h1&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div></li><li class="listitem">Now, we'll <a id="id346" class="indexterm"/>add the following <code class="literal">sftp</code> task to our configuration, which indicates that we'd like to have the <code class="literal">index.html</code> file uploaded to a specific host that supports SFTP:<div><pre class="programlisting">sftp: {
  myapp: {
    options: {
      host: '[host]',
      username: '[username]',
      password: '[password]',
      path: 'www/'
    },
    files: [{
      src: 'index.html',
    }]
  }
}</pre></div><div><h3 class="title"><a id="tip85"/>Tip</h3><p>The <code class="literal">username</code>, <code class="literal">password</code>, and <code class="literal">host</code> options are filled with placeholder values to indicate that you should make use of your own specific access credentials and hosting server address.</p><p>You'll probably want to have the <code class="literal">username</code> and <code class="literal">password</code> options stored in a local file, as opposed to a shared repository. Refer to the <em>Importing external data</em> recipe of <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>, for an example of how to import configurations from external files. Also, keep in mind that you should exclude files that contain access credentials from your project's code repository.</p><p>The <code class="literal">host</code> option<a id="id347" class="indexterm"/> is used to specify the Internet address of the server that you'd like to upload files to. If you are not sure what this value should be, this type of information can usually be provided to you by the hosting provider or the systems administrator in charge of maintaining the server in question.</p><p>The <code class="literal">path</code> option<a id="id348" class="indexterm"/> is required to indicate the destination directory for the files that we'll be uploading. For our example, we'll indicate that files should be uploaded to the <code class="literal">www</code> directory on the hosting server.</p><p>Note that the files configuration for this task supports all the standard Grunt options. You can read more about them at the following URL:</p><p><a class="ulink" href="http://gruntjs.com/configuring-tasks#files">http://gruntjs.com/configuring-tasks#files</a></p></div></li><li class="listitem">We<a id="id349" class="indexterm"/> can now run the task by using the <code class="literal">grunt sftp</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "sftp:myapp" (sftp) task</strong>
<strong>Copied 1 files</strong>
</pre></div><div><h3 class="title"><a id="tip86"/>Tip</h3><p>Note that the <code class="literal">sftp</code> task cannot automatically create the destination directory, so the <code class="literal">www</code> directory needs to exist on the root of the FTP server before running this task.</p></div></li><li class="listitem">Our <code class="literal">index.html</code> file should now be present on our hosting server and, if correctly <a id="id350" class="indexterm"/>configured, should be accessible via the Internet. Configuring a domain name to point to a site hosted in this fashion is beyond the scope of this book.</li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec171"/>There's more...</h2></div></div></div><p>The <code class="literal">sftp</code> task<a id="id351" class="indexterm"/> provides us with several useful options that can be used in conjunction with its uploading feature. We'll look at how to use a private key and passphrase and using an SSH agent.</p><div><div><div><div><h3 class="title"><a id="ch07lvl3sec104"/>Using a private key and passphrase</h3></div></div></div><p>In case we'd like<a id="id352" class="indexterm"/> to make use of a private key and passphrase to access our host server, we can do so by using the <code class="literal">privateKey</code> and <code class="literal">passphrase</code> options. In the following example, we will load <a id="id353" class="indexterm"/>our private key from the usual location by using the <code class="literal">grunt.file.load</code> function and provide the passphrase that was used to lock it.</p><div><pre class="programlisting">sftp: {
  myapp: {
    options: {
      host: '[host]',
      username: '[username]',
      <strong>privateKey: grunt.file.read('[path to home]/.ssh/id_rsa'),</strong>
<strong>      passphrase: '[passphrase]',</strong>
      path: 'www/'
    },
    files: [{
      src: 'index.html',
    }]
  }
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec105"/>Using an SSH agent</h3></div></div></div><p>If we often <a id="id354" class="indexterm"/>make use of SSH to access our servers, we're probably better off making use of an <strong>SSH agent</strong> to<a id="id355" class="indexterm"/> store our unencrypted private key after unlocking it the first time during our session. This will allow us to access all the services that make use of our <a id="id356" class="indexterm"/>
<strong>public key</strong>, without having to enter the passphrase again for the duration of our user session.</p><div><h3 class="title"><a id="tip87"/>Tip</h3><p>Most Unix-like (this includes OS X) operating systems should have an SSH agent installed and running by default, in which case the following example should work without any initial steps. A Windows user will have to manually install and configure an SSH agent.</p></div><p>The following example makes use of an SSH agent by indicating path to the socket file using the <code class="literal">agent</code> option:</p><div><pre class="programlisting">sftp: {
  myapp: {
    options: {
      host: '[host]',
      username: '[username]',
      <strong>agent: process.env.SSH_AUTH_SOCK,</strong>
      path: 'www/'
    },
    files: [{
      src: 'index.html',
    }]
  }
}</pre></div><div><h3 class="title"><a id="tip88"/>Tip</h3><p>Most SSH agent<a id="id357" class="indexterm"/> programs that come packaged with operating systems follow the convention of providing the socket on which it runs by using the <code class="literal">SSH_AUTH_SOCK</code> environment variable. In our example, we use the standard Node.js <code class="literal">process.env</code> object to retrieve the value of this environment variable.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec72"/>Deploying to GitHub Pages</h1></div></div></div><p>In <a id="id358" class="indexterm"/>this recipe, we'll make use of the <code class="literal">gh-pages (0.10.0)</code> plugin to publish our site to the <strong>GitHub Pages</strong> service.</p><p>The GitHub Pages <a id="id359" class="indexterm"/>service provides a simple way for GitHub users to host static sites related to themselves, their organizations, or their projects. At the core of this service lies the standard <strong>GitHub</strong> service that provides hosting for <strong>Git</strong>-based code repositories.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec172"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure that we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>In addition to the standard project setup, the following recipe will require a GitHub user account that has the appropriate public key (SSH) associated with it.</p><div><h3 class="title"><a id="tip89"/>Tip</h3><p>Please refer to the following URL for help to create and set up<a id="id360" class="indexterm"/> SSH keys for your GitHub account:</p><p><a class="ulink" href="https://help.github.com/articles/generating-ssh-keys/">https://help.github.com/articles/generating-ssh-keys/</a></p></div><p>We'll also need to create a repository called <code class="literal">myapp</code> on GitHub, clone it, and use it as our project folder.</p><div><h3 class="title"><a id="tip90"/>Tip</h3><p>You can read more about how to create and clone a repository on GitHub at the following URLs:</p><p><a class="ulink" href="https://help.github.com/articles/creating-a-new-repository/">https://help.github.com/articles/creating-a-new-repository/</a></p><p><a class="ulink" href="https://help.github.com/articles/cloning-a-repository/">https://help.github.com/articles/cloning-a-repository/</a></p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec173"/>How to do it...</h2></div></div></div><p>The <a id="id361" class="indexterm"/>following <a id="id362" class="indexterm"/>steps take us through creating a simple HTML document and configuring a task that publishes it to the site of GitHub Pages for our project:</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by installing the package that contains the <code class="literal">gh-pages</code> plugin as per the instructions provided in the <em>Installing a plugin</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>.</li><li class="listitem">Next, we'll create a simple HTML document called <code class="literal">index.html</code> in the <code class="literal">www</code> directory, and provide it with the following contents:<div><pre class="programlisting">&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;MyApp Project Site&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Welcome!&lt;/h1&gt;
    &lt;h2&gt;This is the MyApp project site.&lt;/h1&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div></li><li class="listitem">Now, we'll add the following <code class="literal">gh-pages</code> task to our configuration and indicate that we'd like to have the contents of the <code class="literal">www</code> directory uploaded to our project's repository:<div><pre class="programlisting">'gh-pages': {
  myapp: {
    options: {
      base: 'www'
    },
    src: '**/*'
  }
}</pre></div><div><h3 class="title"><a id="tip91"/>Tip</h3><p>The <code class="literal">base</code> option<a id="id363" class="indexterm"/> is used to provide the directory that contains our site. In the case of our example, we'll use the <code class="literal">www</code> directory, as that is where we created our sample HTML file.</p><p>The <a id="id364" class="indexterm"/>
<code class="literal">src</code> option is used to provide files in the base directory which should be transferred to the target repository. For our example, we set it to <code class="literal">**/*</code> to indicate that we'd like to have all files in the base directory transferred.</p></div></li><li class="listitem">We<a id="id365" class="indexterm"/> can now <a id="id366" class="indexterm"/>run the task by using the <code class="literal">grunt gh-pages</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "gh-pages:myapp" (gh-pages) task</strong>
<strong>Cloning git@github.com:[name]/myapp.git into .grunt/grunt-gh-pages/gh-pages/myapp</strong>
<strong>Cleaning</strong>
<strong>Fetching origin</strong>
<strong>Checking out origin/gh-pages</strong>
<strong>Removing files</strong>
<strong>Copying files</strong>
<strong>Adding all</strong>
<strong>Committing</strong>
<strong>Pushing</strong>
</pre></div></li><li class="listitem">We should now be able to view our project site by navigating to the <code class="literal">[name].github.io/myapp</code> domain name that was automatically assigned to our project by GitHub. Doing so should look something like the following:<div><img src="img/image00276.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec73"/>Invalidating an AWS CloudFront distribution</h1></div></div></div><p>In this recipe, we <a id="id367" class="indexterm"/>make use of the <code class="literal">invalidate-cloudfront (0.1.6)</code> plugin to invalidate a AWS CloudFront distribution.</p><p>The AWS CloudFront service provides us with an easy way to distribute the files of our websites and applications over a CDN with edge locations all over the world. This leads to faster response times for our intended audience, no matter where they may be in the world.</p><p>A side effect of having our file hosted on a CDN is that whenever they are updated at the source, the updates may take a while to reflect at the various edge locations, potentially keeping critical updates from our audience. AWS CloudFront does, however, allow us to indicate that we'd like to refresh the content that is stored on the CDN by invalidating a distribution.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec174"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure that we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>In addition to the standard project setup, the following recipe will also require the setup of an AWS user with an AWS access key.</p><div><h3 class="title"><a id="tip92"/>Tip</h3><p>Refer to the following URL for details of how to obtain your <a id="id368" class="indexterm"/>AWS access credentials:</p><p><a class="ulink" href="http://docs.aws.amazon.com/general/latest/gr/getting-aws-sec-creds.html">http://docs.aws.amazon.com/general/latest/gr/getting-aws-sec-creds.html</a></p></div><p>An AWS CloudFront distribution will also need to be created so that we can use it in our recipe. For our example, we'll have it distribute the files contained in the bucket that we created in the <em>Deploying to AWS S3</em> recipe, earlier in this chapter.</p><div><h3 class="title"><a id="tip93"/>Tip</h3><p>Refer to the <a id="id369" class="indexterm"/>following URL for more information on how to create an AWS CloudFront distribution:</p><p><a class="ulink" href="http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-creating.html">http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-creating.html</a></p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec175"/>How to do it...</h2></div></div></div><p>The following steps take us through creating and configuring a task that invalidates a specific<a id="id370" class="indexterm"/> AWS CloudFront distribution:</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by installing the package that contains the <code class="literal">invalidate-cloudfront</code> plugin, as per the instructions provided in the <em>Installing a plugin</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>.</li><li class="listitem">Now, we'll add the following <code class="literal">invalidate_cloudfront</code> task to our configuration and indicate that we'd like to have each of the files that can be found in the <code class="literal">www</code> directory refreshed on the CloudFront CDN:<div><pre class="programlisting">invalidate_cloudfront: {
  myapp: {
    options: {
      key: '[key]',
      secret: '[secret]',
      distribution: '[distribution id]'
    },
    files: [{
      expand: true,
      cwd: 'www',
      src: '**/*'
    }]
  }
}</pre></div><div><h3 class="title"><a id="tip94"/>Tip</h3><p>The <code class="literal">key</code> and <code class="literal">secret</code> options are filled with placeholder values to indicate that you should make use of your own specific access credentials.</p><p>The <code class="literal">key</code> option should be set to an <strong>access key ID</strong><a id="id371" class="indexterm"/> that was generated for your user, using the AWS IAM console.</p><p>The <code class="literal">secret</code> option should be set to the secret access key that was generated for the specific access key ID, you specified in the <code class="literal">key</code> option. Note that the secret access key is only displayed on creation of the access key ID, so you won't be able to find it in the IAM console if you didn't save it the first time.</p><p>You'll probably want to have the <code class="literal">key</code> and <code class="literal">secret</code> options stored in a local file, as opposed to a shared repository. Refer to the <em>Importing external data</em> recipe of <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em> for an example of how to import configurations from external files. Also, keep in mind that you should exclude files that contain security credentials from your project's code repository.</p></div></li><li class="listitem">We can now run the task by using the <code class="literal">grunt invalidate_cloudfront</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "invalidate_cloudfront:myapp" (invalidate_cloudfront) task</strong>
<strong>Invalidating 1 files: /index.html</strong>

<strong>0 Completed and 0 In Progress invalidations on: [dist id]</strong>

<strong>Creating invalidation for 1 files</strong>
<strong>Invalidation created at https://cloudfront.amazonaws.com/2014-10-21/distribution/[dist id]/invalidation/[invalidation id]</strong>
</pre></div></li><li class="listitem">The <a id="id372" class="indexterm"/>targeted CloudFront distribution should now be in the process of being invalidated. If there are any changes made to the underlying content, it should be reflected at all edge locations on the CloudFront CDN within a few minutes.</li></ol><div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec74"/>Running commands over SSH</h1></div></div></div><p>In this recipe, we'll <a id="id373" class="indexterm"/>make use of the <code class="literal">sshexec</code> task provided by the <code class="literal">ssh (0.12.2)</code> plugin to run commands on a remote server over the SSH network protocol.</p><p>Running commands on a remote server can become a necessity during the deployment process, and when we run commands, we'd like be sure that it is being done securely. The SSH protocol is the de facto standard to run commands on remote servers, due in part to the improved security that it provides by encrypting all data that is sent over the network.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec176"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure that we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>In addition to the standard project setup, the following recipe will also require an existing user account on the targeted SSH-enabled server. These credentials are usually provided by the hosting service or administrator who maintains the targeted server.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec177"/>How to do it...</h2></div></div></div><p>The following steps take us through creating and configuring a task that will run a command that prints the date and time on a remote server:</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by installing the package that contains the <code class="literal">ssh</code> plugin, as per the instructions provided in the <em>Installing a plugin</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>.</li><li class="listitem">Now, we'll add the following <code class="literal">sshexec</code> task to our configuration and set it up to print the date and time on our remote server by running the <code class="literal">date</code> command:<div><pre class="programlisting">sshexec: {
  date: {
    options: {
      host: '[host]',
      username: '[username]',
      password: '[password]'
    },
    command: 'date'
  }
}</pre></div><div><h3 class="title"><a id="tip95"/>Tip</h3><p>The <code class="literal">username</code>, <code class="literal">password</code>, and <code class="literal">host</code> options are filled with placeholder values to indicate that you should make use of your own specific access credentials and hosting server.</p><p>You'll probably want to have the <code class="literal">username</code> and <code class="literal">password</code> options stored in a local file, as opposed to a shared repository. Refer to the <em>Importing external data</em> recipe of <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em> for an example of how to import configurations from external files. Also, keep in mind that you should exclude files that contain access credentials from your project's code repository.</p><p>The <code class="literal">host</code> option<a id="id374" class="indexterm"/> is used to specify the Internet address of the server that you'd like to upload files to. If you are not sure what this value should be, this type of information can usually be provided to you by the hosting provider or the systems administrator in charge of maintaining the server in question.</p></div></li><li class="listitem">We <a id="id375" class="indexterm"/>can now run the task by using the <code class="literal">grunt sshexec</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "sshexec:myapp" (sshexec) task</strong>
<strong>Thu Jan 1 12:00:00 GMT 2015</strong>
</pre></div></li><li class="listitem">If we can see a date and time returned after running the command, we have successfully run a command on the remote server.</li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec178"/>There's more...</h2></div></div></div><p>The <a id="id376" class="indexterm"/>
<code class="literal">sshexec</code> task provides us with several useful options that can be used in conjunction with its uploading feature. We'll look at how to use a private key and passphrase and using an SSH agent.</p><div><div><div><div><h3 class="title"><a id="ch07lvl3sec106"/>Using a private key and passphrase</h3></div></div></div><p>In case <a id="id377" class="indexterm"/>we'd like to make use of a private key and passphrase to access our host server, we can do so using the <code class="literal">privateKey</code> and <code class="literal">passphrase</code> options. In <a id="id378" class="indexterm"/>the following example, we will load our private key from the usual location by using the <code class="literal">grunt.file.load</code> function and provide the passphrase that was used to lock it.</p><div><pre class="programlisting">sshexec: {
  date: {
    options: {
      host: '[host]',
      username: '[username]',
      <strong>privateKey: grunt.file.read('[path to home]/.ssh/id_rsa'),</strong>
<strong>      passphrase: '[passphrase]'</strong>
    },
    command: 'date'
  }
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec107"/>Using an SSH agent</h3></div></div></div><p>If we<a id="id379" class="indexterm"/> often make use of SSH to access our servers, we're probably better off making use of an SSH agent to store our unencrypted private key after unlocking it the first time during our session. This will allow us to access all the services that make use of our public key, without having to enter the passphrase again for the duration of our user session.</p><div><h3 class="title"><a id="tip96"/>Tip</h3><p>Most *nix (this includes OS X) operating systems should have an SSH agent installed and running by default, in which case the following example should work without any initial steps. A Windows user will have to manually install and configure an SSH agent.</p></div><p>The following example makes use of an SSH agent by indicating the socket that runs with the <code class="literal">agent</code> option:</p><div><pre class="programlisting">sshexec: {
  date: {
    options: {
      host: '[host]',
      username: '[username]',
      <strong>agent: process.env.SSH_AUTH_SOCK</strong>
    },
    command: 'date'
  }
}</pre></div><div><h3 class="title"><a id="tip97"/>Tip</h3><p>Most SSH agent programs that come packaged with operating systems follow the convention of providing the socket on which it runs, using the <code class="literal">SSH_AUTH_SOCK</code> environment variable. In our example, we made use of the standard Node.js <code class="literal">process.env</code> object to retrieve the value of this environment variable.</p></div></div></div></div></body></html>