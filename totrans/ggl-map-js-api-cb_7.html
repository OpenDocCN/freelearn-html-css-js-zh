<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Working with Services</h1></div></div></div><p>In this chapter, we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Finding coordinates for an address</li><li class="listitem" style="list-style-type: disc">Finding addresses on a map with a click</li><li class="listitem" style="list-style-type: disc">Getting elevations on a map with a click</li><li class="listitem" style="list-style-type: disc">Creating a distance matrix for the given locations</li><li class="listitem" style="list-style-type: disc">Getting directions for the given locations</li><li class="listitem" style="list-style-type: disc">Adding Street View to your maps</li></ul></div><div><div><div><div><h1 class="title"><a id="ch07lvl1sec57"/>Introduction</h1></div></div></div><p>This chapter focuses on the various services offered by the Google Maps JavaScript API. These services add significant functionality that largely differentiates Google Maps from its competitors. The reliability and the quality of the underlying data makes these services even more appreciated, as this allows applications making use of Google Maps to provide added functionalities.</p><p>These services generally follow an asynchronous pattern in which a request is sent to an external server and a callback method is provided to process the responses.</p><div><div><h3 class="title"><a id="note20"/>Note</h3><p>These services are not available all over the world; there are restrictions or quotas—even if it is available—to prevent the abuse of these services. Detailed information will be given on these services in related recipes.</p></div></div><p>The good part of these services is, as they are part of the Google Maps JavaScript API, they are fully compatible with the classes and objects of the API.</p><p>For instance, you can find directions between two addresses using the Google Maps API Directions Service. Firstly, you make the request supplying the necessary parameters. Then, by using your callback function, you will get the directions if everything goes on track. But, for a time lapse, you may have to think of ways to overlay these directions on the base maps. Luckily, the API provides the infrastructure for this so that with one line of additional code, you can observe your requested directions on top of your base maps.</p><p>This chapter will describe each of the service types in detail, including geocoding, directions, elevation, distance matrix, and Street View, with each recipe consisting of a related scenario.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec58"/>Finding coordinates for an address</h1></div></div></div><p>Locating an <a id="id567" class="indexterm"/>address or place on the map has always been a<a id="id568" class="indexterm"/> tedious task, and the Google Maps JavaScript API eases this task with the geocoding service. Geocoding, <a id="id569" class="indexterm"/>in its simplest definition, is to associate geographic coordinates with the address information, be it only a street name, the detailed building number and zip code, or only a locality name.</p><p>By having the coordinates of your respective addresses, you can easily overlay them in your map applications.</p><p>In this recipe, you will succeed in entering your holiday places and addresses and then map them as markers on top of your base maps in your application.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec178"/>Getting ready</h2></div></div></div><p>This recipe will make use of the concepts related to adding vector layers, particularly markers, introduced in the <em>Adding markers to maps </em>recipe in <a class="link" href="ch03.html" title="Chapter 3. Adding Vector Layers">Chapter 3</a>, <em>Adding Vector Layers</em>. It is advised to go through this recipe to have a general understanding of vector layers and their properties.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec179"/>How to do it…</h2></div></div></div><p>You can locate your addresses by following the given steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Create HTML markup so that you can enter your addresses and search for them:<div><pre class="programlisting">&lt;input id="addressField" type="text" size="30"  placeholder="Enter your Address" /&gt;
&lt;input type="button" id="listAddressBtn" value="Pin Address On Map" /&gt;
&lt;p id="placesText"&gt;&lt;/p&gt;
&lt;ul id="addressList" class="addressList"&gt;&lt;/ul&gt;</pre></div></li><li class="listitem">Define the global <code class="literal">geocoder</code> object:<div><pre class="programlisting">var geocoder;</pre></div></li><li class="listitem">Initialize the <code class="literal">geocoder</code> object in your <code class="literal">initMap()</code> function:<div><pre class="programlisting">geocoder = new google.maps.Geocoder();</pre></div></li><li class="listitem">Get the <code class="literal">listAddressBtn</code> button element and add a <code class="literal">click</code> event listener:<div><pre class="programlisting">var listAddressBtn = document.getElementById('listAdressBtn');
listAddressBtn.addEventListener('click', function(){
    listAddresses();
});</pre></div></li><li class="listitem">Create a <a id="id570" class="indexterm"/>function for listing addresses on the <code class="literal">addressList</code> element <a id="id571" class="indexterm"/>and send the geocoding request:<div><pre class="programlisting">function listAddresses() {
    //get text input handler
    var addressField = document.getElementById('addressField');
    //get addressList &lt;ul&gt; element handle
    var addressList = document.getElementById('addressList');
    if (addressList.children.length === 0) {
        var placesText = document.getElementById('placesText');
        placesText.innerHTML = 'Places You Have Visited (Click on the place name to see on map):';
    }
    //create a list item
    var listItem = document.createElement('li');
    //get the text in the input element and make it a //list item
    listItem.innerHTML = addressField.value;
    listItem.addEventListener('click', function() {
        geocodeAddress (listItem.innerHTML);
    });
    //append it to the &lt;ul&gt; element
    addressList.appendChild(listItem);
    //call the geocoding function
    geocodeAddress(addressField.value);
}</pre></div></li><li class="listitem">Create a function for geocoding the addresses entered:<div><pre class="programlisting">function geocodeAddress(addressText) {
    //real essence, send the geocoding request
    geocoder.geocode( {'address': addressText}, function(results, status) {
        //if the service is working properly...
        if (status == google.maps.GeocoderStatus.OK) {
            //show the first result on map
            pinpointResult(results[0]);
        } else {
            alert('Cannot geocode because: ' + status);
        }
    });
}</pre></div></li><li class="listitem">Place a marker <a id="id572" class="indexterm"/>on the map and attach an <code class="literal">InfoWindow</code> <a id="id573" class="indexterm"/>object to display its details:<div><pre class="programlisting">function pinpointResult(result) {
    var marker = new google.maps.Marker({
        map: map,
        position: result.geometry.location
    });

    map.setCenter(result.geometry.location);
    map.setZoom(16);

    //infowindow stuff
    google.maps.event.addListener(marker, 'click', function() {
        var popupContent = '&lt;b&gt;Address: &lt;/b&gt; ' + result.formatted_address;
        popup.setContent(popupContent);
        popup.open(map, this);
    });
}</pre></div></li><li class="listitem">You will have your addresses pinned on your map as shown in the following screenshot:<div><img src="img/ch07_recipe01_img01.jpg" alt="How to do it…"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec180"/>How it works...</h2></div></div></div><p>Making a<a id="id574" class="indexterm"/> geocoding request is in fact quite simple. Firstly, you<a id="id575" class="indexterm"/> create a <code class="literal">Geocoder</code> object:</p><div><pre class="programlisting">geocoder = new google.maps.Geocoder();</pre></div><p>Then, you call the <code class="literal">geocode()</code> method<a id="id576" class="indexterm"/> from the <code class="literal">geocoder</code> object, supplying its address parameter with an address, place, or locality name:</p><div><pre class="programlisting">geocoder.geocode( {'address': addressText}, function(results, status) {…});</pre></div><p>This method takes the address, sends it to the Google servers to be geocoded, and by a callback function, gets back the results in the form of the <code class="literal">GeocoderResult</code> object array.</p><p>The responses come in an array in order of the most relevant matches. For instance, when you search for <code class="literal">Colosseum</code>, the <code class="literal">formatted_address</code> property of the first <code class="literal">GeocoderResult</code> object is:</p><div><pre class="programlisting">Colosseum, Piazza del Colosseo, 1, 00184 Rome, Italy</pre></div><p>The second is:</p><div><pre class="programlisting">Colosseum, Enschede, The Netherlands</pre></div><p>You can quickly <a id="id577" class="indexterm"/>grasp that the ancient and highly touristic Colosseum in <a id="id578" class="indexterm"/>Rome is more popular than the second result. You can, of course, bias results through the restriction of map boundaries and country codes (we will review this in detail in the upcoming sections). However, without any intervention, you will see the geocoded results of high popularity at the top through various countries and continents.</p><p>The <code class="literal">GeocoderResult</code> object has its <code class="literal">geometry</code> property so that you can view it via a marker overlay on top of base maps. In our recipe, the <code class="literal">pinpointResult()</code>function makes use of this, where it takes the <code class="literal">GeocoderResult</code> object named <code class="literal">result</code> as its only parameter:</p><div><pre class="programlisting">    function pinpointResult(result) {
        var marker = new google.maps.Marker({
            map: map,
            position: result.geometry.location
        });
    ...
    }</pre></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec181"/>There's more...</h2></div></div></div><p>The geocoding service request<a id="id579" class="indexterm"/> and response has an extensive set of options<a id="id580" class="indexterm"/> and properties. Let's start with the request first. In addition to the <code class="literal">address</code> parameter, which is the primary and required parameter of the <code class="literal">GeocodeRequest</code> object (supplied as the first parameter for the <code class="literal">geocode()</code> method of the <code class="literal">Geocoder</code> object), there is a <code class="literal">bounds</code> property that you can use to specify the returning geocoded results, as shown in the following code:</p><div><pre class="programlisting">    geocoder.geocode({
        'address': addressText,
        'bounds': new google.maps.LatLngBounds(
        new google.maps.LatLng(25.952910068468075, -15.93734749374994),
        new google.maps.LatLng(57.607047845370246, 54.37515250625006)
        )
        },
        function(results, status) {...}
    );</pre></div><p>When you supply the <code class="literal">bounds</code> property, such as the one used in the preceding code covering Europe, and then when you search for Sun Street, the first result is the UK. This is because the <code class="literal">bounds</code> property biases the geocoding results present inside the <code class="literal">LatLngBounds</code> object supplied. When you delete the <code class="literal">bounds</code> property, the first result from the same search comes from the USA.</p><p>In addition, you<a id="id581" class="indexterm"/> can bias the results by using the <code class="literal">region</code> parameter, in which an IANA language region subtag is accepted.</p><div><div><h3 class="title"><a id="note21"/>Note</h3><p>The complete listing for IANA language region subtags can be found at <a class="ulink" href="http://www.iana.org/assignments/language-subtag-registry/language-subtag-registry">http://www.iana.org/assignments/language-subtag-registry/language-subtag-registry</a>.</p><p>Detailed information on the <code class="literal">GeocodeRequest</code> object can be found at <a class="ulink" href="https://developers.google.com/maps/documentation/javascript/reference#GeocoderRequest">https://developers.google.com/maps/documentation/javascript/reference#GeocoderRequest</a>.</p></div></div><p>For instance, <a id="id582" class="indexterm"/>supplying the <code class="literal">region</code> parameter with <code class="literal">'ve'</code> for Venezuela as shown in the following code and searching for <code class="literal">'Valencia'</code> returns the city of <code class="literal">'Valencia' in Venezuela</code> in the first place:</p><div><pre class="programlisting">    geocoder.geocode({
        'address': addressText,
        'region':'ve'},
        function(results, status) {...}
    );</pre></div><p>Without the <code class="literal">region</code> parameter, this would return the city of <code class="literal">'Valencia' in Spain</code> in the first place.</p><p>Passing the returned results and their properties to the <code class="literal">GeocoderResult</code> object, this object carries an accuracy indicator since certain geocoding processes are about interpolation and matching and not about one-to-one equality.</p><p>The value of the result is stored in the <code class="literal">geometry</code> property of the <code class="literal">GeocoderResult</code> object, which contains the <code class="literal">location_type</code> property. These values are in the order of their highest to lowest accuracies:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">google.maps.GeocoderLocationType.ROOFTOP</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">google.maps.GeocoderLocationType.RANGE_INTERPOLATED</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">google.maps.GeocoderLocationType.GEOMETRIC CENTER</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">google.maps.GeocoderLocationType.APPROXIMATE</code></li></ul></div><p>In the preceding<a id="id583" class="indexterm"/> code, the <code class="literal">ROOFTOP</code> value represents the exact address, <code class="literal">RANGE_INTERPOLATED</code> represents that there is an interpolation between <a id="id584" class="indexterm"/>certain sections of the road, <code class="literal">GEOMETRIC_CENTER</code> represents the geometric center of the road or region, and finally <code class="literal">APPROXIMATE</code> tells us that the returned result's location is an approximation.</p><p>For instance, when we search for <code class="literal">'William Village</code>', the first result's <code class="literal">formatted_address</code> is:</p><div><pre class="programlisting">    "Bremerton, WA, USA"</pre></div><p>The <code class="literal">location_type</code> property of the geometry of the result is <code class="literal">APPROXIMATE</code>. This generally happens when there is no direct linkage between the search phrase and the returned result, as it is in our case.</p><p>Apart from the accuracy of the geocoding process, we can get the type of the <code class="literal">GeocoderResult</code> object through its <code class="literal">types</code> property. The <code class="literal">types</code> property is an array that is of the category to which the returned result belongs.</p><p>For instance, for the Colosseum in Rome, the <code class="literal">types</code> property is:</p><div><pre class="programlisting">    ["point_of_interest", "establishment"]</pre></div><p>While for Via del Corso, Rome, it is:</p><div><pre class="programlisting">    ["route"]</pre></div><p>For Uffizi Gallery, Florence, it is:</p><div><pre class="programlisting">    ["museum", "point_of_interest", "establishment"]</pre></div><div><div><h3 class="title"><a id="note22"/>Note</h3><p>The complete listing for the possible values of the <code class="literal">types</code> property of the <code class="literal">GeocoderResult</code> object can be found at <a class="ulink" href="https://developers.google.com/maps/documentation/javascript/geocoding #GeocodingAddressTypes">https://developers.google.com/maps/documentation/javascript/geocoding #GeocodingAddressTypes</a>.</p></div></div><p>It is important to note that the callback function through which we get our results of the geocoding request requires another parameter, which is about the status of the request. The most prominent possible values for this parameter are:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">google.maps.GeocoderStatus.OK</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">google.maps.GeocoderStatus.ZERO_RESULTS</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">google.maps.GeocoderStatus.OVER_QUERY_LIMIT</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">google.maps.GeocoderStatus.REQUEST_DENIED</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">google.maps.GeocoderStatus.INVALID_REQUEST</code></li></ul></div><p>The values<a id="id585" class="indexterm"/> except <code class="literal">GeocoderStatus.OK</code> point to a problem. Among all, <code class="literal">GeocoderStatus.OVER_QUERY_LIMIT</code> requires special attention. In the <a id="id586" class="indexterm"/>introduction of this chapter, we have mentioned that all of these Google Maps services are subject to limited use in terms of geography and request rates. And, this status code is fired when you go beyond the limit of the usage of the geocoding services.</p><div><div><h3 class="title"><a id="note23"/>Note</h3><p>A detailed explanation of the <code class="literal">OVER_QUERY_LIMIT</code> status code can be found at <a class="ulink" href="https://developers.google.com/maps/documentation/business/articles/usage_limits#limitexceeded">https://developers.google.com/maps/documentation/business/articles/usage_limits#limitexceeded</a>.</p><p>The complete listing for the possible values of the <code class="literal">GeocoderStatus</code> object can be found at <a class="ulink" href="https://developers.google.com/maps/documentation/javascript/geocoding#GeocodingStatusCodes">https://developers.google.com/maps/documentation/javascript/geocoding#GeocodingStatusCodes</a>.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec182"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Adding markers to maps</em> recipe in <a class="link" href="ch03.html" title="Chapter 3. Adding Vector Layers">Chapter 3</a>, <em>Adding Vector Layers</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec59"/>Finding addresses on a map with a click</h1></div></div></div><p>In the previous recipe, <a id="id587" class="indexterm"/>we had the address in our hand and our aim was to find the map location; in other terms, the coordinates of the address on earth. But, what happens if we have the exact coordinates and try to find the address that matches these exact coordinates?</p><p>This process is known as reverse geocoding, and it is the process of converting coordinates to human-readable addresses.</p><p>In this recipe, we will make use of the reverse geocoding capabilities of the Google Maps JavaScript API. When the user clicks on the map, we will find the address where the user clicked and imminently display it to him/her.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec183"/>Getting ready</h2></div></div></div><p>Reviewing the recipe <em>Drawing shapes on the map</em> in <a class="link" href="ch06.html" title="Chapter 6. Google Maps JavaScript Libraries">Chapter 6</a>, <em>Google Maps JavaScript Libraries</em>, will ease your work because greater detail on drawing shapes and their background is required for this recipe.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec184"/>How to do it…</h2></div></div></div><p>Here are the steps to allow your user to click on the map and find the address of the place that he/she clicked on:</p><div><ol class="orderedlist arabic"><li class="listitem">Define the <code class="literal">geocoder</code> object as global:<div><pre class="programlisting">var geocoder;</pre></div></li><li class="listitem">Define the <code class="literal">popup</code> object as global:<div><pre class="programlisting">var popup;</pre></div></li><li class="listitem">Initialize<a id="id588" class="indexterm"/> the <code class="literal">geocoder</code> and <code class="literal">popup</code> objects, inside the <code class="literal">initMap()</code> function:<div><pre class="programlisting">geocoder = new google.maps.Geocoder();
popup = new google.maps.InfoWindow();</pre></div></li><li class="listitem">Create the <code class="literal">drawingManager</code> object inside <code class="literal">initMap()</code>:<div><pre class="programlisting">var drawingManager = new google.maps.drawing.DrawingManager(
{
    //initial drawing tool to be enabled, we want to be in //no drawing mode at start
    drawingMode:null,
    //enable the drawingControl to be seen in the UI
    drawingControl:true,
    //select which drawing modes to be seen in the //drawingControl and position the drawingControl itself
    drawingControlOptions: {
        //select a control position in the UI
        position: google.maps.ControlPosition.TOP_CENTER,
        //selected drawing modes to be seen in the control
        drawingModes:[
        google.maps.drawing.OverlayType.MARKER	
        ]
    }
});</pre></div></li><li class="listitem">Enable the drawing functionality:<div><pre class="programlisting">drawingManager.setMap(map);</pre></div></li><li class="listitem">Add an event <a id="id589" class="indexterm"/>listener for the completion of the user-drawn marker, perform the reverse geocoding task, and find the address:<div><pre class="programlisting">google.maps.event.addListener(drawingManager, 'markercomplete', function(marker) {
    //get the LatLng object of the marker, it is necessary //for the geocoder
    var markerPosition = marker.getPosition();
    //reverse geocode the LatLng object to return the //addresses
    geocoder.geocode({'latLng': markerPosition}, function(results, status) {
        //if the service is working properly...
        if (status == google.maps.GeocoderStatus.OK) {
            //Array of results will return if everything //is OK
            if (results) {
                //infowindow stuff
                showAddressOfResult(results[0],marker);
            }
        }
        //if the service is not working, deal with it
        else {
            alert('Reverse Geocoding failed because: ' + status);
        }
    });
});</pre></div></li><li class="listitem">Create a function for displaying the address on the <code class="literal">InfoWindow</code> object of the marker drawn:<div><pre class="programlisting">function showAddressOfResult(result, marker) {
    //set the center of the map the marker position
    map.setCenter(marker.getPosition());
    map.setZoom(13);

    //create the InfoWindow content
    var popupContent = '&lt;b&gt;Address: &lt;/b&gt; ' + result.formatted_address;

    //set the InfoWindow content and open it
    popup.setContent(popupContent);
    popup.open(map, marker);
}</pre></div></li><li class="listitem">You can now <a id="id590" class="indexterm"/>click on and get the address information in the info window as shown in the following screenshot:<div><img src="img/ch07_recipe02_img01.jpg" alt="How to do it…"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec185"/>How it works...</h2></div></div></div><p>If you have looked at the <em>Finding coordinates for an address</em> recipe in this chapter, you may have realized that we are again using the same <code class="literal">geocoder</code> object as shown:</p><div><pre class="programlisting">    geocoder = new google.maps.Geocoder();</pre></div><p>However, this time we are supplying the coordinate pairs in the form of the <code class="literal">LatLng</code> object instead of the address text for the familiar <code class="literal">geocode()</code> method of the <code class="literal">geocoder</code> object:</p><div><pre class="programlisting">    geocoder.geocode({'latLng': markerPosition}, function(results, status) {
    ...
    });</pre></div><p>In fact, there was another property that the <code class="literal">geocode()</code> method has which we have not discussed in the previous recipe; that is, the <code class="literal">latlng</code> property that accepts the <code class="literal">LatLng</code> object.</p><p>Therefore, the <code class="literal">geocode()</code> method of the <code class="literal">geocoder</code> object can be used bi-directionally, both for<a id="id591" class="indexterm"/> geocoding and reverse geocoding. For geocoding, we must use the <code class="literal">address</code> property to fill in the address for which we want to have the location. For reverse geocoding, we must use the <code class="literal">latlng</code> property to fill in the <code class="literal">LatLng</code> object for which we want the address information.</p><p>We get the <code class="literal">LatLng</code> object of the marker that the user draws by using the <code class="literal">getPosition()</code> method of the marker:</p><div><pre class="programlisting">    var markerPosition = marker.getPosition();</pre></div><p>In our callback function, which we have to supply for our reverse geocoding request, we have two parameters that get their values when we get the replies of our request:</p><div><pre class="programlisting">    function(results, status) {
        ...
    }</pre></div><p>The first parameter is an array of the <code class="literal">GeocoderResult</code> objects, and the second one is an array of the <code class="literal">GeocoderStatus</code> object.</p><div><div><h3 class="title"><a id="note24"/>Note</h3><p>You can review the available for the <code class="literal">GeocoderStatus</code> object as a well-detailed breakdown on the <code class="literal">GeocoderResult</code> object in the <em>Finding coordinates for an address</em> recipe of this chapter.</p></div></div><p>After testing the service status, we can work with our array of the <code class="literal">GeocoderResult</code> objects if everything is OK:</p><div><pre class="programlisting">    if (status == google.maps.GeocoderStatus.OK) {
        //Array of results will return if everything //is //OK
        if (results) {
            //infowindow stuff
            showAddressOfResult(results[0], marker);
        }
    }</pre></div><p>We have picked the first object because it is the most precise one. For instance, for the marker position in our recipe, the complete array of address information is:</p><div><pre class="programlisting">    results[0].formatted_address: "764-768 5th Avenue, New York, NY 10019, USA"
    results[1].formatted_address: "5 Av/West 60 - 59 St, New York, NY 10019, USA"
    results[2].formatted_address: "New York, NY 10153, USA"
    results[3].formatted_address: "5 Av/59 St, New York, NY 10022, USA"
    results[4].formatted_address: "New York, NY 10019, USA"
    results[5].formatted_address: "Midtown, New York, NY, USA"
    results[6].formatted_address: "Manhattan, New York, NY, USA"
    results[7].formatted_address: "New York, NY, USA"
    results[8].formatted_address: "New York, NY, USA"
    ...
    results[10].formatted_address: "New York, USA"
    results[11].formatted_address: "United States"</pre></div><p>You can observe<a id="id592" class="indexterm"/> that iterating from the start of the array to the end, we end up in <code class="literal">"United States"</code>, the least precise address information for our reverse geocoding request.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec186"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Finding coordinates for an address</em> recipe in this chapter</li><li class="listitem" style="list-style-type: disc">The <em>Drawing shapes on the map</em> recipe in <a class="link" href="ch06.html" title="Chapter 6. Google Maps JavaScript Libraries">Chapter 6</a>, <em>Google Maps JavaScript Libraries</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec60"/>Getting elevations on a map with a click</h1></div></div></div><p>The Google Maps <a id="id593" class="indexterm"/>JavaScript API provides information on elevation data, returning positive values on the terrain relative to the sea surface. It also gives information on the depth of ocean floors in negative values.</p><p>Using the <code class="literal">ElevationService</code> object, we can get elevation information on individual locations as well as paths.</p><p>In this recipe, firstly we will show how to get an elevation data from a single point that the user selects, and then we will go over the same scenario with the paths.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec187"/>Getting ready</h2></div></div></div><p>It is a good idea to have a quick glance at the <em>Drawing shapes on the map</em> recipe in <a class="link" href="ch06.html" title="Chapter 6. Google Maps JavaScript Libraries">Chapter 6</a>, <em>Google Maps JavaScript Libraries</em>, as the recipe covers every detail on how to draw a shape using the Google Maps JavaScript API.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec188"/>How to do it…</h2></div></div></div><p>You can view the<a id="id594" class="indexterm"/> elevation data of a location of your choice if you follow the given steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Define the <code class="literal">elevator</code> object as global:<div><pre class="programlisting">var elevator;</pre></div></li><li class="listitem">Define the <code class="literal">popup</code> object as global:<div><pre class="programlisting">var popup;</pre></div></li><li class="listitem">Initialize the <code class="literal">elevator</code> and <code class="literal">popup</code> objects, inside the <code class="literal">initMap()</code> function:<div><pre class="programlisting">elevator = new google.maps.ElevationService();
popup = new google.maps.InfoWindow();</pre></div></li><li class="listitem">Create the <code class="literal">drawingManager</code> object inside <code class="literal">initMap()</code>:<div><pre class="programlisting">var drawingManager = new google.maps.drawing.DrawingManager(
{
    //initial drawing tool to be enabled, we want to be in //no drawing mode at start
    drawingMode:null,
    //enable the drawingControl to be seen in the UI
    drawingControl:true,
    //select which drawing modes to be seen in the //drawingControl and position the drawingControl itself
    drawingControlOptions: {
        //select a control position in the UI
        position: google.maps.ControlPosition.TOP_CENTER,
        //selected drawing modes to be seen in the control
        drawingModes: [
        google.maps.drawing.OverlayType.MARKER	
        ]
    }
});</pre></div></li><li class="listitem">Enable the drawing functionality:<div><pre class="programlisting">drawingManager.setMap(map);</pre></div></li><li class="listitem">Add an event listener for the completion of the user-drawn marker, send the request using the <code class="literal">elevator</code> object, and find the elevation data for the location of the marker:<div><pre class="programlisting">google.maps.event.addListener(drawingManager, 'markercomplete', function(marker) {
    //get the LatLng object of the marker, it is necessary //for the geocoder
    var markerPosition = marker.getPosition();
    //embed the marker position in an array
    var markerPositions = [markerPosition];
    //send the elevation request and get the results in the //callback function
    elevator.getElevationForLocations({'locations': markerPositions}, function(results, status) {
        //if the service is working properly...
        if (status == google.maps.ElevationStatus.OK) {
            //Array of results will return if everything //is OK
            if (results) {
                //infowindow stuff
                showElevationOfResult(results[0], marker);
            }
        }
        //if the service is not working, deal with it
        else {
            alert('Elevation request failed because: ' + status);
        }
    });
});</pre></div></li><li class="listitem">Create a function<a id="id595" class="indexterm"/> for displaying the elevation data on the <code class="literal">InfoWindow</code> object of the marker drawn:<div><pre class="programlisting">function showElevationOfResult(result, marker) {
    //set the center of the map the marker position
    map.setCenter(marker.getPosition());
    map.setZoom(13);

    //create the InfoWindow content
    var popupContent = '&lt;b&gt;Elevation: &lt;/b&gt; ' + result.elevation;

    //set the InfoWindow content and open it
    popup.setContent(popupContent);
    popup.open(map, marker);
}</pre></div></li><li class="listitem">You will now get the elevation of the point that you have clicked on, as shown in the following screenshot:<div><img src="img/ch07_recipe03_img01.jpg" alt="How to do it…"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec189"/>How it works...</h2></div></div></div><p>We get the<a id="id596" class="indexterm"/> elevation data using the <code class="literal">ElevationService</code> object:</p><div><pre class="programlisting">elevator = new google.maps.ElevationService();</pre></div><p>The <code class="literal">elevator</code> object has the <code class="literal">getElevationForLocations()</code> method that takes an array of <code class="literal">LatLng</code> objects to return the elevation data for each position that the specific <code class="literal">LatLng</code> object is standing for. In other words, if you allocate three <code class="literal">LatLng</code> objects in your array, you get three <code class="literal">ElevationResult</code> objects as an array in your callback function:</p><div><pre class="programlisting">elevator.getElevationForLocations({'locations': markerPositions}, function(results, status) {
...});</pre></div><p>However, bear in mind that the accuracy of the elevation is lowered when the number of the <code class="literal">LatLng</code> objects are embedded in the array. Therefore, if you want to have high accuracy, you must opt for the <code class="literal">LatLng</code> array containing a single element, as seen in our case.</p><p>The <code class="literal">LatLng</code> <a id="id597" class="indexterm"/>object array is given for the locations property of the <code class="literal">getElevationForLocations()</code> method. However, we have one <code class="literal">marker</code> object in hand to handle the <code class="literal">markercomplete</code> event when it is fired upon the drawing of the marker by the user:</p><div><pre class="programlisting">    google.maps.event.addListener(drawingManager, 'markercomplete',   function(marker)
    {...});</pre></div><p>Therefore, we are converting the single marker position to an array containing only one element:</p><div><pre class="programlisting">    var markerPosition = marker.getPosition();
    var markerPositions = [markerPosition];</pre></div><p>In the callback function, we get the status of the service together with the <code class="literal">ElevationResult</code> object array:</p><div><pre class="programlisting">    function(results, status) {
        //if the service is working properly...
        if (status == google.maps.ElevationStatus.OK) {
            //Array of results will return if everything //is OK
            if (results) {
                //infowindow stuff
                showElevationOfResult(results[0],marker);
            }
        }
        //if the service is not working, deal with it
        else {
            alert('Elevation request failed because: ' + status);
        }
    }</pre></div><p>The <code class="literal">status</code> parameter is of the type <code class="literal">ElevationStatus</code>, and it is very similar to the <code class="literal">GeocoderStatus</code> object in terms of its constants, which are listed as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">google.maps.ElevationStatus.OK</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">google.maps.ElevationStatus.UNKNOWN_ERROR</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">google.maps.ElevationStatus.OVER_QUERY_LIMIT</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">google.maps.ElevationStatus.REQUEST_DENIED</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">google.maps.ElevationStatus.INVALID_REQUEST</code></li></ul></div><p>Apart from <code class="literal">ElevationStatus.OK</code>, all the status values point to a problem. Other values are self-explanatory within their names.</p><div><div><h3 class="title"><a id="note25"/>Note</h3><p>The complete listing and details for the possible values of the <code class="literal">ElevationStatus</code> object can be found at <a class="ulink" href="https://developers.google.com/maps/documentation/javascript/reference# ElevationStatus">https://developers.google.com/maps/documentation/javascript/reference# ElevationStatus</a>.</p></div></div><p>The <code class="literal">results</code> parameter is of the type <code class="literal">ElevationResult</code>. The <code class="literal">ElevationResult</code> object has three properties called <code class="literal">elevation</code>, <code class="literal">location</code>, and <code class="literal">resolution</code>. We are making use of the <code class="literal">elevation</code> property in our <code class="literal">showElevationOfResult()</code> function:</p><div><pre class="programlisting">    var popupContent = '&lt;b&gt;Elevation: &lt;/b&gt; ' + result.elevation;</pre></div><p>The elevation data is the positive number for the terrain and the negative number for the ocean floor.</p><p>The location <a id="id598" class="indexterm"/>property is the <code class="literal">LatLng</code> object of <code class="literal">ElevationResult</code>, and the resolution property is the distance in meters between the sample points that is used to generate/interpolate this elevation data. The higher the resolution, the less accurate the elevation data.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec190"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Drawing shapes on the map</em> recipe in <a class="link" href="ch06.html" title="Chapter 6. Google Maps JavaScript Libraries">Chapter 6</a>, <em>Google Maps JavaScript Libraries</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec61"/>Creating a distance matrix for the given locations</h1></div></div></div><p>The Google Maps<a id="id599" class="indexterm"/> JavaScript API carries some interesting and <a id="id600" class="indexterm"/>particularly helpful properties, one of them being the Distance Matrix Service. Using this service, you can compute the travel time and distance between multiple origins and destination locations.</p><p>This is especially useful when you want to have a one-to-one report of your travel nodes, be it a delivery business or only a summertime holiday. This service gives you the travel time and distances within your choice of travel mode (driving, walking, and cycling); you can see the results oriented for each origin and destination.</p><p>It is worth noting that the output of this service cannot be mapped onto the base maps; you can have the information about the travel time and duration, but for the directions, you have to use the Directions service, explained in detail in the <em>Getting a direction for the given locations</em> recipe later in this chapter.</p><p>In this recipe, we will locate the origin and destination locations and get the distance matrix result for our locations.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec191"/>Getting ready</h2></div></div></div><p>This recipe will make use of the drawing library; therefore, it is advisable to go through the <em>Drawing shapes on the map</em> recipe in <a class="link" href="ch06.html" title="Chapter 6. Google Maps JavaScript Libraries">Chapter 6</a>, <em>Google Maps JavaScript Libraries</em>, and gain some understanding on the subject matter.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec192"/>How to do it…</h2></div></div></div><p>You can draw your <a id="id601" class="indexterm"/>origin and destination points and then request for a<a id="id602" class="indexterm"/> distance matrix by clicking on the button. You can see how to do this by following the given steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Add the HTML <code class="literal">input</code> element of the <code class="literal">button</code> type to kick off the distance matrix request:<div><pre class="programlisting">&lt;input type="button" id ="generateDistanceMatrix" value="Generate Distance Matrix" /&gt;</pre></div></li><li class="listitem">Define the global variables:<div><pre class="programlisting">//define an array that includes all origin LatLng objects
var originLatLngs;
//define an array that includes all destination LatLng objects
var destinationLatLngs;
//define a global DistanceMatrixService object
var distanceMatrixService;
//define a global markerCount variable
var markerCount;
//define a global matrixResultDiv variable
var matrixResultDiv;</pre></div></li><li class="listitem">Initialize the global variables in the <code class="literal">initMap()</code> function:<div><pre class="programlisting">//initialize originLatLngs array
originLatLngs = [];
//initialize destinationLatLngs array
destinationLatLngs = [];
//initialize markerCount - the count of markers to be drawn
markerCount = 0;
//assign matrixResultDiv to the specific div element
matrixResultDiv = document.getElementById('matrixResultDiv');</pre></div></li><li class="listitem">Get the <code class="literal">button</code> element and add a <code class="literal">click</code> event handler:<div><pre class="programlisting">var generateDistanceMatrixBtn = document.getElementById('generateDistanceMatrix');
generateDistanceMatrixBtn.addEventListener('click', function(){
    makeDistanceMatrixRequest();
});</pre></div></li><li class="listitem">Initialize <a id="id603" class="indexterm"/>the <code class="literal">distanceMatrixService</code> object<a id="id604" class="indexterm"/> in the <code class="literal">initMap()</code> function:<div><pre class="programlisting">distanceMatrixService = new google.maps.DistanceMatrixService();</pre></div></li><li class="listitem">Create the <code class="literal">drawingManager</code> object inside <code class="literal">initMap()</code>:<div><pre class="programlisting">var drawingManager = new google.maps.drawing.DrawingManager(
{
    //initial drawing tool to be enabled, we want to be in //no drawing mode at start
    drawingMode: null,
    //enable the drawingControl to be seen in the UI
    drawingControl: true,
    //select which drawing modes to be seen in the //drawingControl and position the drawingControl itself
    drawingControlOptions: {
        //select a control position in the UI
        position: google.maps.ControlPosition.TOP_CENTER,
        //selected drawing modes to be seen in the control
        drawingModes: [
        google.maps.drawing.OverlayType.MARKER
        ]
    }
});</pre></div></li><li class="listitem">Enable the drawing functionality:<div><pre class="programlisting">drawingManager.setMap(map);</pre></div></li><li class="listitem">Add an event listener for the completion of the user-drawn marker, set the marker icons based upon the positions they are pointing towards, whether origin or destination, and limit the total number of markers:<div><pre class="programlisting">google.maps.event.addListener(drawingManager, 'markercomplete', function(marker) {
    //count the number of markers drawn
    markerCount++;

    //limit the number of markers to 10
    if (markerCount &gt; 10) {
        alert('No more origins or destinations allowed');
        drawingManager.setMap(null);
        marker.setMap(null);
        return;
    }

    //distinguish the markers, make the blue ones be //destinations and red ones origins
    if (markerCount % 2 === 0) {
        destinationLatLngs.push(marker.getPosition());
        marker.setIcon('icons/b' + destinationLatLngs.length + '.png');
    }
    else {
        originLatLngs.push(marker.getPosition());
        marker.setIcon('icons/r' + originLatLngs.length + '.png');
    }
});</pre></div></li><li class="listitem">Create a <a id="id605" class="indexterm"/>function for preparing the request properties <a id="id606" class="indexterm"/>and sending the request for the <code class="literal">distanceMatrixService</code> object by using the <code class="literal">getDistanceMatrix()</code> method:<div><pre class="programlisting">function makeDistanceMatrixRequest() {
    distanceMatrixService.getDistanceMatrix(
        {
            origins: originLatLngs,
            destinations: destinationLatLngs,
            travelMode: google.maps.TravelMode.DRIVING,
        },
        getDistanceMatrixResult
    );
}</pre></div></li><li class="listitem">Create a callback function named <code class="literal">getDistanceMatrixResult</code> for the <code class="literal">getDistanceMatrix()</code> method call of the <code class="literal">distanceMatrixService</code> object:<div><pre class="programlisting">function getDistanceMatrixResult(result, status) {
    //clear the div contents where matrix results will be //written
    matrixResultDiv.innerHTML = '';

    //if everything is OK
    if (status == google.maps.DistanceMatrixStatus.OK) {
        //get the array of originAddresses
        var originAddresses = result.originAddresses;
        //get the array of destinationAddresses
        var destinationAddresses = result.destinationAddresses;

        //there are two loops, the outer is for origins, //the inner will be for destinations,
        //their intersection will be the element object //itself
        for (var i = 0, l= originAddresses.length; i &lt; l; i++) {
            //get the elements array
            var elements = result.rows[i].elements;
            for (var j = 0, m= elements.length;  j &lt; m; j++) {
                var originAddress = originAddresses[i];
                var destinationAddress = destinationAddresses[j];
                //get the element object
                var element = elements[j];

                //get distance and duration properties for //the element object
                var distance =  element.distance.text;
                var duration = element.duration.text;
                //write the results to the div for each //element object

                writeDistanceMatrixResultOnDiv(originAddress, destinationAddress, distance, duration, i, j);
            }
        }
    }
else {
        alert('Cannot find distance matrix because: ' + status);
    }
}</pre></div></li><li class="listitem">Create a <a id="id607" class="indexterm"/>function to be called by the callback function<a id="id608" class="indexterm"/> listed earlier to write the results to the <code class="literal">matrixResultDiv</code> object:<div><pre class="programlisting">function writeDistanceMatrixResultOnDiv(originAddress, destinationAddress, distance, duration, originAddressCount, destinationAddressCount) {
    //get the existing content
    var existingContent = matrixResultDiv.innerHTML;

    var newContent;
    //write the Origin Address and Destination Address //together with travel distance and duration
    newContent = '&lt;b&gt;Origin ' + letterForCount(originAddressCount) + ' :&lt;/b&gt;&lt;br /&gt;';
    newContent += originAddress + '&lt;br /&gt;';
    newContent += '&lt;b&gt;Destination ' + letterForCount(destinationAddressCount) + ' :&lt;/b&gt;&lt;br /&gt;';
    newContent += destinationAddress + '&lt;br /&gt;';
    newContent += '&lt;b&gt;Distance: &lt;/b&gt; ' + distance + '&lt;br /&gt;';
    newContent += '&lt;b&gt;Duration: &lt;/b&gt; ' + duration + '&lt;br /&gt;';
    newContent += '&lt;br /&gt;';

    //add the newContent to the existingContent of the //matrixResultDiv
    matrixResultDiv.innerHTML = existingContent + newContent;
}</pre></div></li><li class="listitem">Create a function for converting counts to letters; the aim is to match the counts with the marker icons:<div><pre class="programlisting">function letterForCount(count)
{
    switch (count)
    {
        case 0:
        return 'A';
        case 1:
        return 'B';
        case 2:
        return 'C';
        case 3:
        return 'D';
        case 4:
        return 'E';
        default:
        return null;
    }
}</pre></div></li><li class="listitem">You will now have the distance matrix between the points of your selection, as shown in the following screenshot:<div><img src="img/ch07_recipe04_img01.jpg" alt="How to do it…"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec193"/>How it works...</h2></div></div></div><p>In our recipe, we are <a id="id609" class="indexterm"/>allowing the users to point the markers downward at the <a id="id610" class="indexterm"/>location of their choice. However, we are just following a scheme such that the first marker will point to the first origin, the second will point to the first destination, the third will point to the second origin, the fourth will point to the second destination location, and so on. In addition, we are limiting the number of markers that have to be drawn to 10.</p><p>This was about drawing markers. Then, we will prepare the origin and destination locations to be supplied to the <code class="literal">distanceMatrixService</code> object. The object is initialized as shown in the following code:</p><div><pre class="programlisting">    distanceMatrixService = new google.maps.DistanceMatrixService();</pre></div><p>The user pressed the input button element and we fire the request via the <code class="literal">getDistanceMatrix()</code> method:</p><div><pre class="programlisting">    function makeDistanceMatrixRequest() {
        distanceMatrixService.getDistanceMatrix(
        {
            origins: originLatLngs,
            destinations: destinationLatLngs,
            travelMode: google.maps.TravelMode.DRIVING,
        },
        getDistanceMatrixResult
    );
}</pre></div><p>Here, we supply <code class="literal">originLatLngs</code> to the <code class="literal">origins</code> property, where <code class="literal">originLatLngs</code> is an array of the <code class="literal">LatLng</code> objects collected <a id="id611" class="indexterm"/>out of user-drawn markers—the<a id="id612" class="indexterm"/> odd-numbered ones—in the <code class="literal">markercomplete</code> event listener for the <code class="literal">drawingManager</code> object:</p><div><pre class="programlisting">    if (markerCount % 2 === 0) {
        destinationLatLngs.push(marker.getPosition());

    }
    else {
        originLatLngs.push(marker.getPosition());

  }</pre></div><p>The <code class="literal">destinations</code> property is set for the <code class="literal">destimationLatLngs</code> array in the same logic.</p><p>As a quick reminder, the <code class="literal">destinations</code> and <code class="literal">origins</code> properties can take an array of address strings as well as an array of <code class="literal">LatLng</code> objects, as in our case.</p><p>The third property that we have used in our request is the <code class="literal">travelMode</code> property, which is used to set the mode of travel. The options other than <code class="literal">TravelMode.DRIVING</code> available for this property are:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">TravelMode.WALKING</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">TravelMode.BICYCLING</code></li></ul></div><p>In addition to the <code class="literal">DistanceMatrixRequest</code> object carrying the <code class="literal">origins</code>, <code class="literal">destinations</code>, and <code class="literal">travelMode</code> properties, we are supplying a callback function named <code class="literal">getDistanceMatrixResult</code> for the <code class="literal">getDistanceMatrix()</code> method call. The <code class="literal">getDistanceMatrixResult</code> function has two parameters: one is for the response of the service and the other one is for the status of the service. It is shown in the following code:</p><div><pre class="programlisting">    function getDistanceMatrixResult(result, status)
    {...}</pre></div><p>In this function, firstly we check whether the service is working properly:</p><div><pre class="programlisting">    if (status == google.maps.DistanceMatrixStatus.OK)
    {...}</pre></div><div><div><h3 class="title"><a id="note26"/>Note</h3><p>The complete listing and details for the possible values of the <code class="literal">DistanceMatrixStatus</code> object can be found at <a class="ulink" href="https://developers.google.com/maps/documentation/javascript/reference# DistanceMatrixStatus">https://developers.google.com/maps/documentation/javascript/reference# DistanceMatrixStatus</a>.</p></div></div><p>Then, we process<a id="id613" class="indexterm"/> the results of the type <code class="literal">DistanceMatrixResponse</code> <a id="id614" class="indexterm"/>object, which carries the <code class="literal">originAddresses</code> and <code class="literal">destinationAddresses</code> arrays of strings and a <code class="literal">DistanceMatrixResponseRow</code> array called <code class="literal">rows</code>. Firstly, we get the <code class="literal">originAddresses</code> and <code class="literal">destinationAddresses</code> arrays:</p><div><pre class="programlisting">    var originAddresses = result.originAddresses;
    var destinationAddresses = result.destinationAddresses;</pre></div><p>The <code class="literal">rows</code> array consists of another array called <code class="literal">elements</code>, in which its children are of the type <code class="literal">DistanceMatrixResponseElement</code>. Therefore, we have to have two loops to iterate through the <code class="literal">DistanceMatrixResponseElement</code> objects:</p><div><pre class="programlisting">    for (var i = 0, l=originAddresses.length; i &lt; l; i++) {
        //get the elements array
        var elements = result.rows[i].elements;
        for (var j = 0, m=elements.length;j &lt; m; j++) {
            ...
            var element = elements[j];
                    ...
        }
    }</pre></div><p>The <code class="literal">DistanceMatrixResponseElement</code> object has two prominent properties that we have used in our recipe: one is distance and the other is duration. They are elaborated in the following code:</p><div><pre class="programlisting">    var distance =  element.distance.text;
    var duration = element.duration.text;</pre></div><p>By using these properties, we reach the particular distance and duration properties of the corresponding origin address and destination address.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec194"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Drawing shapes on the map</em> recipe in <a class="link" href="ch06.html" title="Chapter 6. Google Maps JavaScript Libraries">Chapter 6</a>, <em>Google Maps JavaScript Libraries</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec62"/>Getting directions for the given locations</h1></div></div></div><p>Having directions<a id="id615" class="indexterm"/> between two or more locations has always been a <a id="id616" class="indexterm"/>favorite among users, car drivers, tourists, and so on. The need for navigation products either for driving, walking, or any other transit options is qualified by the sales of these products.</p><p>A good Directions service would need comprehensive road data with several attributes filled in such as the direction of traffic flow, turn restrictions, bridges, and underground tunnels. Hopefully, Google Maps has this data in the background; therefore, it is very natural for Google to include this functionality in Google Maps.</p><p>In Google Maps, directions is perhaps one of the most used features. It is also included in the Google Maps JavaScript API, giving developers the ability to generate directions programmatically between locations of their choice with a broad range of options.</p><p>In this recipe, firstly we will have the user enter an address or any location of a place, map them using the Geocoder service, and then provide the directions between them in the order of their entrance.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec195"/>Getting ready</h2></div></div></div><p>This recipe will make use of concepts related to the Geocoder service introduced in the <em>Finding coordinates for an address</em> recipe at the beginning of this chapter. It is highly advisable to go through this recipe to have a general understanding of Geocoder and its usage.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec196"/>How to do it…</h2></div></div></div><p>You can enter your addresses and get directions between them by executing the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Insert a <code class="literal">ContainerDiv</code> element of HTML that will be placed on the right-hand side of the <code class="literal">div</code> element of the map:<div><pre class="programlisting">&lt;div id="DirectionsContainerDiv"&gt;
    &lt;div id="PlacesContainerDiv"&gt;
        &lt;b&gt;Get Directions Between your Places&lt;/b&gt;&lt;/br&gt;
        &lt;input id="addressField" type="text" size="30"  placeholder="Enter your Address" /&gt;
        &lt;input type="button" id ="pinAddressOnMapBtn" value="Pin Address On Map" onclick="listAddresses()" /&gt;
        &lt;input type="button" id = "getDirectionsBtn" disabled value="Get Directions" onclick="getDirections()" /&gt;
        &lt;p id="placesText"&gt;&lt;/p&gt;
        &lt;ul id="addressList" class="addressList"&gt;
        &lt;/ul&gt;
    &lt;/div&gt;
    &lt;div id="DirectionsListContainerDiv"&gt;
        &lt;div id="DirectionsListDiv"&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Define the<a id="id617" class="indexterm"/> global<a id="id618" class="indexterm"/> variables:<div><pre class="programlisting">//define global marker popup variable
var popup;
//define global geocoder object
var geocoder;
//define global markers array
var markers;
//define global DirectionsService object
var directionsService;
//define global DirectionsRenderer object
var directionsRenderer;</pre></div></li><li class="listitem">Initialize the global variables in the <code class="literal">initMap()</code> function:<div><pre class="programlisting">//initialize geocoder object
geocoder = new google.maps.Geocoder();
//initialize markers array
markers = [];
//initialize directionsService object
directionsService = new google.maps.DirectionsService();
//initialize directionsRenderer object
directionsRenderer = new google.maps.DirectionsRenderer();</pre></div></li><li class="listitem">Give the instructions on <code class="literal">directionsRenderer</code> so that it will draw the directions on the map and will list the directions on the right-hand side of the map:<div><pre class="programlisting">//directionsRenderer will draw the directions on current //map
directionsRenderer.setMap(map);
//directionsRenderer will list the textual description of //the directions
//on directionsDiv HTML element
directionsRenderer.setPanel(document.getElementById('DirectionsListDiv'));</pre></div></li><li class="listitem">Create a <a id="id619" class="indexterm"/>function for listing the addresses the user has <a id="id620" class="indexterm"/>entered and calling the function that does the geocoding:<div><pre class="programlisting">function listAddresses() {
    //get text input handler
    var addressField = document.getElementById('addressField');
    //get addressList &lt;ul&gt; element handle
    var addressList = document.getElementById('addressList');
    if (addressList.children.length == 0) {
        var placesText = document.getElementById('placesText');
        placesText.innerHTML = 'Places You Have Visited (Click on the place name to see on map):';
    }
    //create a list item
    var listItem = document.createElement('li');
    //get the text in the input element and make it a list //item
    listItem.innerHTML = addressField.value;
    listItem.addEventListener('click', function() {
        pinAddressOnMap(listItem.innerHTML);
    });
    //append it to the &lt;ul&gt; element
    addressList.appendChild(listItem);
    //call the geocoding function
    pinAddressOnMap(addressField.value);
    if (addressList.children.length &gt; 1) {
        //get getDirectionsBtn button handler
        var getDirectionsBtn = document.getElementById('getDirectionsBtn');
        //enable the getDirectionsBtn
        getDirectionsBtn.disabled = false;
    }
    addressField.value = '';
}</pre></div></li><li class="listitem">Create a function that does the real geocoding task:<div><pre class="programlisting">function pinAddressOnMap(addressText) {
    //real essence, send the geocoding request
    geocoder.geocode({'address': addressText}, function(results, status) {
        //if the service is working properly...
        if (status == google.maps.GeocoderStatus.OK) {
            //show the first result on map
            pinpointResult(results[0]);
        } else {
            alert('Cannot geocode because: ' + status);
        }
    });
}</pre></div></li><li class="listitem">Create a<a id="id621" class="indexterm"/> function for placing a marker for the <a id="id622" class="indexterm"/>geocoding result of the user-entered address information and attaching an <code class="literal">InfoWindow</code> object to display its details:<div><pre class="programlisting">function pinpointResult(result) {
    var marker = new google.maps.Marker({
        map: map,
        position: result.geometry.location,
        zIndex: -10
    });

    map.setCenter(result.geometry.location);
    map.setZoom(16);

    //infowindow stuff
    google.maps.event.addListener(marker, 'click', function() {
        var popupContent = '&lt;b&gt;Address: &lt;/b&gt; ' + result.formatted_address;
        popup.setContent(popupContent);
        popup.open(map, this);
    });
    markers.push(marker);
}</pre></div></li><li class="listitem">At last, the real directions can be called upon by using the <code class="literal">getDirectionsBtn</code> button handler. Create a function for sending the request to the <code class="literal">directionsService </code>object, ensuring that the results are drawn and listed on the map:<div><pre class="programlisting">function getDirections() {
    //define an array that will hold all the waypoints
    var waypnts = [];
    //define a directionsRequest object
    var directionRequest;

    //if there are stops other than the origin and the //final destination
    if (markers.length &gt; 2) {
        for (i=1;i&lt;=markers.length-2;i++) {
            //add them to the waypnts array
            waypnts.push({
                location: markers[i].getPosition(),
                stopover: true
            });
        }

        //prepare the directionsRequest by including //the waypoints property
        directionRequest = {
           origin:markers[0].getPosition(),
           destination: markers[markers.length-1].getPosition(),
          waypoints: waypnts,
          travelMode: google.maps.TravelMode.DRIVING
        };
    }
    else {
        //this time, do not include the waypoints property as //there are no waypoints
        directionRequest = {
            origin:markers[0].getPosition(),
            destination:markers[markers.length-1].getPosition(),
            travelMode: google.maps.TravelMode.DRIVING
        };
    }

    //send the request to the directionsService
    directionsService.route(directionRequest, function(result, status) {
        if (status == google.maps.DirectionsStatus.OK) {
            directionsRenderer.setDirections(result);
        }
        else
        {
            alert('Cannot find directions because: ' + status);
        }
    });
}</pre></div></li><li class="listitem">You will now have the directions mapped between the points of your selection, as shown in the following screenshot:<div><img src="img/ch07_recipe05_img01.jpg" alt="How to do it…"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec197"/>How it works...</h2></div></div></div><p>In this recipe, <a id="id623" class="indexterm"/>we are making use of both <code class="literal">GeocoderService</code> and <code class="literal">DirectionsService</code>. However, in order to avoid redundancy (it is strongly <a id="id624" class="indexterm"/>recommended to go through the <em>Finding coordinates for an address</em> recipe of this chapter), we will mostly concentrate on <code class="literal">DirectionsService</code>, preparing the request properties, sending and getting back the results to draw on the map, and also its step-by-step textual descriptions.</p><p>At first, we are waiting for the user to enter addresses to be geocoded and shown on the map. These are the places that we will generate directions for. We are collecting all the markers that are the results of the user's geocoding requests so that we can use them for directions:</p><div><pre class="programlisting">    function pinpointResult(result) {
        ...
        markers.push(marker);
    }</pre></div><p>As soon as the <a id="id625" class="indexterm"/>numbers of the geocoded addresses are more <a id="id626" class="indexterm"/>than 1, the button labeled <strong>Get Directions</strong> gets enabled so that users can request for directions between their geocoded addresses:</p><div><pre class="programlisting">    function listAddresses()
    {
        ...
        if (addressList.children.length &gt; 1) {
            //get getDirectionsBtn button handler
            var getDirectionsBtn = document.getElementById('getDirectionsBtn');
            //enable the getDirectionsBtn
            getDirectionsBtn.disabled = false;
        }
        ...
    }</pre></div><p>After this, everything is ready for generating directions provided that we have prepared the infrastructure, so use the following code:</p><div><pre class="programlisting">    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer();</pre></div><p>The <code class="literal">DirectionsService</code> object is responsible for sending the <code class="literal">DirectionsRequest</code> object to the service servers at Google, while the <code class="literal">DirectionsRenderer</code> object, as its name implies, renders the <code class="literal">DirectionsResult</code> object onto the map and its textual description.</p><p>An origin and a destination are compulsory for <code class="literal">DirectionsRequest</code> logically; however, there may be waypoints in between the origin and the destination. If the user geocodes two addresses and presses the <strong>Get Directions</strong> button, there is no place for waypoints, and the first address becomes the origin, while the second becomes the destination.</p><p>If there are more than two addresses on the list of the geocoded addresses, the first will be the origin and the last will be the destination again. In addition to this, the waypoints will be present in between the addresses. We are preparing the <code class="literal">DirectionsRequest</code> parameters considering these factors, as shown in the following code:</p><div><pre class="programlisting">function getDirections() {
    ...
    //if there are stops other than the origin and the //final destination
    if (markers.length &gt; 2)
    {
        for (var i=1, markers.length;i&lt;=l-2;i++)
        {
            //add them to the waypnts array
            waypnts.push({
                location: markers[i].getPosition(),
                stopover: true
            });
        }

        //prepare the directionsRequest by including //the waypoints property
        directionRequest = {
            origin:markers[0].getPosition(),
            destination:markers[markers.length-1].getPosition(),
            waypoints: waypnts,
            travelMode: google.maps.TravelMode.DRIVING
        };
    }
    else
    {
        //this time, do not include the waypoints property as //there are no waypoints
        directionRequest = {
            origin:markers[0].getPosition(),
            destination:markers[markers.length-1].getPosition(),
            travelMode: google.maps.TravelMode.DRIVING
        };
    }
    ...
}</pre></div><p>You may have <a id="id627" class="indexterm"/>realized that we are supplying the <code class="literal">LatLng</code> objects for <a id="id628" class="indexterm"/>the <code class="literal">origin</code> and <code class="literal">destination</code> properties of the <code class="literal">directionsRequest</code> object. This does not have to be the case: you can also provide addresses as strings for the <code class="literal">origin</code> and <code class="literal">destination</code> properties, as well as the <code class="literal">location</code> property of the <code class="literal">DirectionsWaypoint</code> object that we are adding to our <code class="literal">waypnts</code> array. Also, there is a <code class="literal">stopover</code> property for the <code class="literal">DirectionsWaypoint</code> object. It specifies that the waypoint is actually a stop and splits the route. Another property for the <code class="literal">DirectionsRequest</code> object is <code class="literal">travelMode,</code> where we have opted for <code class="literal">DRIVING</code>.</p><div><div><h3 class="title"><a id="note27"/>Note</h3><p>The complete listing and details for the possible values of the <code class="literal">TravelMode</code> object can be found at <a class="ulink" href="https://developers.google.com/maps/documentation/javascript/reference#TravelMode">https://developers.google.com/maps/documentation/javascript/reference#TravelMode</a>.</p></div></div><p>We have included a few properties that are mostly required; however, the <code class="literal">DirectionsRequest</code> object has a lot more.</p><div><div><h3 class="title"><a id="note28"/>Note</h3><p>The complete listing of the properties of the <code class="literal">DirectionsRequest</code> object can be found at <a class="ulink" href="https://developers.google.com/maps/documentation/javascript/reference#DirectionsRequest">https://developers.google.com/maps/documentation/javascript/reference#DirectionsRequest</a>.</p></div></div><p>After <a id="id629" class="indexterm"/>preparing our <code class="literal">directionsRequest</code> object, we can send the <a id="id630" class="indexterm"/>request using our <code class="literal">directionsService</code> object through its <code class="literal">route()</code> method:</p><div><pre class="programlisting">    function getDirections() {
        ...
        //send the request to the directionsService
        directionsService.route(directionRequest, function(result, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionsRenderer.setDirections(result);
            }
            else
            {
                alert('Cannot find directions because: ' + status);
            }
        });
    }</pre></div><p>The <code class="literal">route()</code> method takes two parameters: one is the <code class="literal">DirectionsRequest</code> object and the other is the callback function that has the <code class="literal">DirectionsResult</code> and <code class="literal">DirectionsStatus</code> objects as parameters in return.</p><p>We test whether everything is on track using our <code class="literal">status</code> object, which is of the type <code class="literal">DirectionsStatus</code>.</p><div><div><h3 class="title"><a id="note29"/>Note</h3><p>The complete listing of constants of the DirectionsStatus object can be found at <a class="ulink" href="https://developers.google.com/maps/documentation/javascript/reference#DirectionsStatus">https://developers.google.com/maps/documentation/javascript/reference#DirectionsStatus</a>.</p></div></div><p>Then, we map the results and have textual descriptions on a <code class="literal">div</code> element using our old <code class="literal">directionsRenderer</code> object:</p><div><pre class="programlisting">    directionsRenderer.setDirections(result);</pre></div><p>But how did the <code class="literal">directionsRenderer</code> object know where to map the results, or which <code class="literal">div</code> to write the step-by-step instructions to? Hopefully, we have given the instructions earlier to the <code class="literal">DirectionsRenderer</code> object in our <code class="literal">initMap()</code> function:</p><div><pre class="programlisting">    directionsRenderer.setMap(map);
    directionsRenderer.setPanel(document.getElementById('DirectionsListDiv'));</pre></div><p>The <code class="literal">setMap()</code> method <a id="id631" class="indexterm"/>of the <code class="literal">DirectionsRenderer</code> <a id="id632" class="indexterm"/>object maps the <code class="literal">DirectionsResult</code> object to the selected map object. And, similarly, the <code class="literal">setPanel()</code> method is used for selecting an HTML <code class="literal">div</code> element to have the step-by-step instructions written on it. This is so that we can have both our directions mapped in our map instance. The map imminently gets zoomed out to show the entire route, and we can see the order of our journey with the help of additional markers with letters on each.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec198"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Finding coordinates for an address</em> recipe in this chapter</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec63"/>Adding Street View to your maps</h1></div></div></div><p>Google Maps already has <a id="id633" class="indexterm"/>good map data updated continuously with the <a id="id634" class="indexterm"/>ultimate cartographic quality. In addition, there comes the up-to-date satellite imagery. Although these were sufficient for Google Maps to be so popular and successful, there is another view that takes much interest—Street View.</p><p>Street View is the 360-degree panorama view from the roads that are covered under this service.</p><div><div><h3 class="title"><a id="note30"/>Note</h3><p>The complete listing of countries and cities where Street View is available can be found at <a class="ulink" href="http://maps.google.com/intl/ALL/maps/about/behind-the-scenes/streetview/">http://maps.google.com/intl/ALL/maps/about/behind-the-scenes/streetview/</a>.</p></div></div><p>In this recipe, we will go over how to add Street View panoramas to the current view, switch between the map view and Street View, and set the panorama properties.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec199"/>Getting ready</h2></div></div></div><p>In this recipe, we will <a id="id635" class="indexterm"/>make use of the concepts related to the geocoding <a id="id636" class="indexterm"/>service introduced in the <em>Finding coordinates for an address recipe</em> in this chapter. It is highly advisable to read this recipe to have a general understanding of Geocoder and its usage.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec200"/>How to do it…</h2></div></div></div><p>The following steps will enable your geocoded addresses to be seen on Street View:</p><div><ol class="orderedlist arabic"><li class="listitem">Firstly, use the HTML markup:<div><pre class="programlisting">&lt;div id="addressDiv"&gt;
    &lt;b&gt;Map your Holiday Places&lt;/b&gt;&lt;br /&gt;
    &lt;input id="addressField" type="text" size="30"placeholder="Enter your Address" /&gt;
    &lt;input type="button" id="pinAddress" value="Pin Address On Map" onclick="listAddresses()"&gt;
    &lt;input type="button" value="Show Map" onclick="showMap()"&gt;
    &lt;input type="button" value="Show StreetView" onclick="showStreetView()"&gt;
    &lt;p id="placesText"&gt;&lt;/p&gt;
    &lt;ul id="addressList" class="addressList"&gt;
    &lt;/ul&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Define the global objects:<div><pre class="programlisting">var geocoder;
var streetView;</pre></div></li><li class="listitem">Initialize the global objects in the <code class="literal">initMap()</code> function:<div><pre class="programlisting">geocoder = new google.maps.Geocoder();
//initialize streetView object of type StreetViewPanorama
streetView = map.getStreetView();</pre></div></li><li class="listitem">Create a function for listing addresses on the <code class="literal">addressList</code> element and for calling the geocoding function:<div><pre class="programlisting">function listAddresses() {
    //get text input handler
    var addressField = document.getElementById('addressField');
    //get addressList &lt;ul&gt; element handle
    var addressList = document.getElementById('addressList');
    if (addressList.children.length == 0) {
        var placesText = document.getElementById('placesText');
        placesText.innerHTML = 'Places You Have Visited (Click on the place name to see on map):';
    }
    //create a list item
    var listItem = document.createElement('li');
    //get the text in the input element and make it// a list item
    listItem.innerHTML = addressField.value;
    listItem.addEventListener('click', function() {
        pinAddressOnMapOrStreetView(listItem.innerHTML);
    });
    //append it to the &lt;ul&gt; element
    addressList.appendChild(listItem);
    //call the geocoding function
    pinAddressOnMapOrStreetView(addressField.value);
}</pre></div></li><li class="listitem">Create a <a id="id637" class="indexterm"/>function for geocoding the <a id="id638" class="indexterm"/>addresses:<div><pre class="programlisting">function pinAddressOnMapOrStreetView(addressText) {
    //send the geocoding request
    geocoder.geocode({'address': addressText}, function(results, status) {
        //if the service is working properly...
        if (status == google.maps.GeocoderStatus.OK) {
            //show the first result on map, either on
            showAddressMarkerOnMapOrStreetView(results[0]);
            if (streetView.getVisible())
            {
                //set the streetView properties, its //location and "Point Of View"
                setStreetViewOptions(results[0].geometry.location);
            }
        } else {
            alert('Cannot geocode because: ' + status);
        }
    });
}</pre></div></li><li class="listitem">Create a function for placing the marker in the map for the geocoded addresses:<div><pre class="programlisting">function showAddressMarkerOnMapOrStreetView(result) {
    var marker = new google.maps.Marker({
        map:map,
        position: result.geometry.location
    });
    map.setCenter(result.geometry.location);
    map.setZoom(16);
}</pre></div></li><li class="listitem">Create a <a id="id639" class="indexterm"/>function for setting the Street View<a id="id640" class="indexterm"/> panorama properties:<div><pre class="programlisting">function setStreetViewOptions(location)
{
    //set the location of the streetView object
    streetView.setPosition(location);
    //set the "Point Of View" of streetView object
    streetView.setPov({
        heading: 0,
        pitch: 10
    });
}</pre></div></li><li class="listitem">Create a function for displaying the familiar map view, which is called by the HTML click button labeled <strong>Show Map</strong>:<div><pre class="programlisting">function showMap()
{
    var pinAddressBtn = document.getElementById('pinAddress');
    pinAddressBtn.value = 'Pin Address On Map';
    streetView.setVisible(false);
}</pre></div></li><li class="listitem">Create a function for displaying the Street View panorama taking the location as the map's center location, which is called by the HTML click button labeled <strong>Show StreetView</strong>:<div><pre class="programlisting">function showStreetView() {
    var pinAddressBtn = document.getElementById('pinAddress');
    pinAddressBtn.value = 'Pin Address On StreetView';
    setStreetViewOptions(map.getCenter());
    streetView.setVisible(true);
}</pre></div></li><li class="listitem">You will now have the geocoded addresses with Street View, as shown in the following screenshot:<div><img src="img/ch07_recipe06_img01.jpg" alt="How to do it…"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec201"/>How it works...</h2></div></div></div><p>In our recipe, our<a id="id641" class="indexterm"/> aim is <a id="id642" class="indexterm"/>to perform the ordinary task of geocoding addresses, in addition to providing the availability of the Street View feature of the Google Maps JavaScript API in the same map's <code class="literal">div</code> element. To do this, we need the <code class="literal">StreetViewPanorama</code> object available:</p><div><pre class="programlisting">    streetView = map.getStreetView();</pre></div><p>This object enables us to display the Street View either within our map's <code class="literal">div</code> element or within a separate <code class="literal">div</code> element of our will.</p><div><div><h3 class="title"><a id="note31"/>Note</h3><p>The complete description of properties and methods of the <code class="literal">StreetViewPanorama</code> class can be found at <a class="ulink" href="https://developers.google.com/maps/documentation/javascript/reference#StreetViewPanorama">https://developers.google.com/maps/documentation/javascript/reference#StreetViewPanorama</a>.</p></div></div><p>Then, we can display the Street View when the button labeled <strong>Show Street View</strong> is clicked, providing the <code class="literal">map</code> object's center location as the <code class="literal">LatLng</code> object:</p><div><pre class="programlisting">    setStreetViewOptions(map.getCenter());</pre></div><p>Then, we set the<a id="id643" class="indexterm"/> properties of the <code class="literal">StreetViewPanorama</code> object<a id="id644" class="indexterm"/> by specifying the position and setting the point of view of the <code class="literal">streetView object</code>:</p><div><pre class="programlisting">    function setStreetViewOptions(location) {
        //set the location of the streetView object
        streetView.setPosition(location);
        //set the "Point Of View" of streetView object
        streetView.setPov({
            heading: 0,
            pitch: 10
        });
    }</pre></div><p>The <code class="literal">setPosition()</code> method takes the <code class="literal">LatLng</code> object as its parameter, and we are providing either the map center or the geocoded address' location. By using the <code class="literal">setPov()</code> method, we are arranging the camera view of the Street View. To have a camera view, the object must have an angle towards both true north and the street view origin—the street vehicle mostly.</p><p>The <code class="literal">heading</code> property of the <code class="literal">StreetViewPov</code> object is for the angle in reference to true north, where 0 degrees is true north, 90 degrees is east, 180 degrees is south, and 270 degrees is west. In our recipe, we have set the <code class="literal">heading</code> property to 0 degrees.</p><p>The <code class="literal">pitch</code> property is for the angle in reference to the Street View vehicle. This means that 90 degrees is totally upwards, viewing the sky or clouds, whereas -90 degrees is totally downwards, viewing the road ground in most cases.</p></div></div></body></html>