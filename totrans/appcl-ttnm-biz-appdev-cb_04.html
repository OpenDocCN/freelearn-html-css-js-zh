<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Interacting with Web Services"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Interacting with Web Services</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Consuming RSS feeds</li><li class="listitem" style="list-style-type: disc">Creating a business location map using Yahoo Local</li><li class="listitem" style="list-style-type: disc">Using Google Analytics in your app</li><li class="listitem" style="list-style-type: disc">Making SOAP service calls using SUDS.js</li><li class="listitem" style="list-style-type: disc">Using the LinkedIn Contacts API</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec26"/>Introduction</h1></div></div></div><p>Mobile devices have been one of the driving forces behind the growth in variety and number of web service offerings in both Enterprise and Consumer spaces. As the ultimate disconnected client, mobile apps have revived the interest in <span class="strong"><strong>Service-Oriented Architecture</strong></span> (<span class="strong"><strong>SOA</strong></span>) as <a id="id321" class="indexterm"/>organizations look to extend their existing systems and functionalities to their mobile customers. As a result, you will rarely find an Enterprise app that does not use internal or third-party remote services.</p><p>This chapter demonstrates how to use SOAP and REST calls to interface with popular third-party platforms while building your Enterprise apps.</p></div></div>
<div class="section" title="Consuming RSS feeds"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec27"/>Consuming RSS feeds</h1></div></div></div><p>The use of<a id="id322" class="indexterm"/> RSS and ATOM feeds is common among Enterprise apps that update content periodically. You can use the techniques demonstrated in this recipe to publish content from your organization or a third party. Many companies use this approach to provide their employees with current news and updates regarding their organization or industry.</p><p>In this recipe, an RSS feed<a id="id323" class="indexterm"/> from <a class="ulink" href="http://fastcompany.com">fastcompany.com</a> is consumed and displayed in a <code class="literal">Ti.UI.TableView</code> for the user to review and launch their browser to read the details.</p><div class="mediaobject"><img src="graphics/5343OT_04_01.jpg" alt="Consuming RSS feeds"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec53"/>Getting ready</h2></div></div></div><p>This recipe uses the <code class="literal">rss2Objects</code> CommonJS module<a id="id324" class="indexterm"/>. This module and other code assets can be<a id="id325" class="indexterm"/> downloaded <a id="id326" class="indexterm"/>from the source code provided by the book. Installing this module into your project is straightforward. Simply copy the <code class="literal">rss2objects.js</code> file into your project, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5343OT_04_02.jpg" alt="Getting ready"/></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec54"/>How to do it…</h2></div></div></div><p>Once you've added the <code class="literal">rss2objects.js</code> file to your project, you need to create your application namespaces in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the module into your code, as demonstrated in the following code block:</p><div class="informalexample"><pre class="programlisting">//Create our application namespace
var my = {
  reader : require('rss2objects'),
  isAndroid : ( Ti.Platform.osname === 'android'),
  rssTestUrl : "http://www.fastcompany.com/rss.xml"
};</pre></div><div class="section" title="Creating a UI for the sample app"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec102"/>Creating a UI for the sample app</h3></div></div></div><p>The demonstration<a id="id327" class="indexterm"/> app for this recipe provides two <code class="literal">Ti.UI.Button</code> controls to illustrate different techniques for fetching RSS results, and a <code class="literal">Ti.UI.TableView</code> to display the articles.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First we create our <code class="literal">Ti.UI.Window</code> to attach all UI elements onto:<div class="informalexample"><pre class="programlisting">  var win = Ti.UI.createWindow({
    backgroundColor:'#fff'
  });</pre></div></li><li class="listitem">Next, a button is created to demonstrate how to use YQL to load an RSS feed:<div class="informalexample"><pre class="programlisting">  var yqlButton = Ti.UI.createButton({
    title:"Load Using YQL",left:0 , width: 140, height:40, top:90
  });
  win.add(yqlButton);</pre></div></li><li class="listitem">A button is then added to demonstrate how to load an RSS feed using XML Parsing:<div class="informalexample"><pre class="programlisting">  var xmlButton = Ti.UI.createButton({
    title:"Load Using XML",right:0 , width: 140,height:40, top:90
  });
  win.add(xmlButton);</pre></div></li><li class="listitem">Finally, a <code class="literal">Ti.TableView</code> is added to display the RSS articles:<div class="informalexample"><pre class="programlisting">  var tableView = Ti.UI.createTableView({
    top:120, bottom: 0, width:Ti.UI.FILL
  });
  win.add(tableView);</pre></div></li></ol></div></div><div class="section" title="Reading an RSS feed with YQL"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec103"/>Reading an RSS feed with YQL</h3></div></div></div><p>Using Yahoo's YQL platform is a convenient way to read an RSS feed. <a id="id328" class="indexterm"/>YQL has two additional<a id="id329" class="indexterm"/> benefits over conventional XML parsing. The first<a id="id330" class="indexterm"/> benefit is YQL normalizes the feed output for you. The second benefit is Yahoo will convert the RSS stream to JSON. The downside to YQL is it will reduce download speeds due to the need to proxy the feed through Yahoo's servers.</p><p>This snippet demonstrates how to call the <code class="literal">yqlQuery</code> method of the <code class="literal">rss2Objects</code> module. The <code class="literal">yqlQuery</code> method takes two arguments: the first is the URL of the RSS feed you wish to read, and the second is a callback used to provide the feed item results.</p><div class="informalexample"><pre class="programlisting">  yqlButton.addEventListener('click',function(e){
    my.reader.yqlQuery(my.rssTestUrl,rssResults);
  });</pre></div></div><div class="section" title="Reading an RSS feed with XML parsing"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec104"/>Reading an RSS feed with XML parsing</h3></div></div></div><p>The <code class="literal">rss2Objects</code> module <a id="id331" class="indexterm"/>also provides the ability to directly parse the RSS feed with XML. This option provides the best download performance for larger feeds.</p><p>To use the XML feed directly, simply call the <code class="literal">query</code> method on the <code class="literal">rss2Objects</code> module. The <code class="literal">query</code> method takes three arguments:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The URL for the RSS feed you wish to read.</li><li class="listitem" style="list-style-type: disc">An optional dot query syntax that allows you to provide the path of the nodes you want returned. In the next example, <code class="literal">channel.item</code> is provided. This tells the <code class="literal">query</code> method to only return nodes from the <code class="literal">channel item</code> element list. If you want all objects returned, simply pass a null value as an argument.</li><li class="listitem" style="list-style-type: disc">The third argument is the callback method where the module will send the results once processing has been completed.<div class="informalexample"><pre class="programlisting">xmlButton.addEventListener('click',function(e){
  var queryPath = "channel.item";
  my.reader.query(my.rssTestUrl,queryPath,rssResults);
});</pre></div></li></ul></div></div><div class="section" title="Displaying the articles"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec105"/>Displaying the articles</h3></div></div></div><p>Both YQL and XML parsing<a id="id332" class="indexterm"/> demonstrations use the callback method shown next. This function takes the object dictionary provided by the <code class="literal">rss2objects</code> module and creates <code class="literal">TableView</code> rows for display:</p><div class="informalexample"><pre class="programlisting">  function rssResults(e){</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The parameter <code class="literal">e</code> in this function provides the result returned from the <code class="literal">rss2Objects</code> module. The first step is to check if the feed was returned successfully. This is done by checking the <code class="literal">e.success</code> property, as the following code block shows:<div class="informalexample"><pre class="programlisting">    if(!e.success){
      alert("Sorry we encountered an error");
      tableView.setData([]);
      return;
    };
    var items = e.rssDetails.items;
    var itemCount = items.length;
    var rows = [];</pre></div></li><li class="listitem">Next, all <a id="id333" class="indexterm"/>of the RSS items are looped through and a <code class="literal">Ti.UI.TableViewRow</code> definition is built for each item:<div class="informalexample"><pre class="programlisting">    for (var iLoop=0;iLoop&lt;itemCount ;iLoop++){
      rows.push({
        title: items[iLoop].title,
        article : items[iLoop],
        height: 60,
        hasChild:true,
        color:'#000'
      });
    }</pre></div></li><li class="listitem">Finally, the article rows built in the previous step are added to the <code class="literal">Ti.TableView</code> for display:<div class="informalexample"><pre class="programlisting">    tableView.setData(rows);
  };</pre></div></li></ol></div></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec55"/>How it works…</h2></div></div></div><p>The <code class="literal">rss2objects</code> module provides a straightforward API for reading RSS feeds. The two primary methods provided by the <code class="literal">rss2object.js</code> module are detailed in the following sections.</p><div class="section" title="Using the yqlQuery function"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec106"/>Using the yqlQuery function</h3></div></div></div><p>The <a id="id334" class="indexterm"/>
<code class="literal">yqlQuery</code> method<a id="id335" class="indexterm"/> uses <a id="id336" class="indexterm"/>Titanium's built-in YQL provider to parse the provided RSS feed URL into a dictionary of objects:</p><div class="informalexample"><pre class="programlisting">exports.yqlQuery = function(url,callback){</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">onComplete</code> method<a id="id337" class="indexterm"/> is used as a callback to the <code class="literal">Ti.Yahoo.yql</code> function. This method will process the YQL results into a standard format for consumption.<div class="informalexample"><pre class="programlisting">  function onComplete(e){</pre></div></li><li class="listitem">The argument <code class="literal">e</code> is a dictionary (with the results of the RSS feed query) provided by YQL.<div class="informalexample"><pre class="programlisting">    var results = {
      success:false,
      rssDetails : {
        url: url, full : null, items:null
      }
    };</pre></div></li><li class="listitem">The <code class="literal">e.success</code> property is checked to determine if the YQL statement generated an error. <a id="id338" class="indexterm"/>On Android, you must <a id="id339" class="indexterm"/>check the <code class="literal">e.data</code> property for <code class="literal">null</code> instead of using the <code class="literal">e.success</code> property.<div class="informalexample"><pre class="programlisting">    //Determine if we have an error
    results.success =  !((_isAndroid &amp;&amp; e.data == null)||(!_isAndroid &amp;&amp; (e.data == null || e.success==false)));</pre></div></li><li class="listitem">If successful, the <code class="literal">e.data.items</code> is added to the <code class="literal">results.rssDetails.items</code> array that will later be the callback method:<div class="informalexample"><pre class="programlisting">    if(results.success){
      results.rssDetails.items = [];
      var itemCount = e.data.item.length;
      for (var iLoop=0;iLoop&lt;itemCount ;iLoop++){
        results.rssDetails.items.push({
          //Add each field in our items
        });
      }
    }</pre></div></li><li class="listitem">The results of our YQL-parsed RSS feed are provided to the initially used <code class="literal">callback</code> method, when calling the <code class="literal">yqlQuery</code> module method:<div class="informalexample"><pre class="programlisting">    callback(results);
  };</pre></div></li><li class="listitem">The following snippet demonstrates a YQL select query that will return a title, link, description, and other listed columns from the RSS feed (of the URL argument provided):<div class="informalexample"><pre class="programlisting">  var yQuery = 'SELECT title, link, description,';
    yQuery += ' pubDate,guid,author,comments,';
    yQuery += ' enclosure,source FROM rss WHERE url =';
    yQuery += '"' + url + '"';</pre></div></li><li class="listitem">The next code block demonstrates using the <code class="literal">Ti.Yahoo.yql</code> method to run the query and send the results to the provided <code class="literal">onComplete</code> callback function:<div class="informalexample"><pre class="programlisting">  Ti.Yahoo.yql(yQuery, onComplete);
};</pre></div></li></ol></div></div><div class="section" title="Using the query function"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec107"/>Using the query function</h3></div></div></div><p>The<a id="id340" class="indexterm"/> <code class="literal">q</code>
<code class="literal">uery</code> method<a id="id341" class="indexterm"/> uses Titanium's <code class="literal">HTTPClient</code> and XML modules to read the provided RSS URL and to confirm the provided XML into a dictionary of objects:</p><div class="informalexample"><pre class="programlisting">exports.query = function(url,pathQuery,callback){
  var workers = {
    results : {
      success:false,
      rssDetails : {
        url:url,full : null,items:null
      }
    },</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">whenComplete</code> function<a id="id342" class="indexterm"/> is invoked when the <code class="literal">query</code> method has completed processing or resulted in an error. The <code class="literal">whenComplete</code> method is used to wrap the <code class="literal">callback</code> argument and provide the query results.<div class="informalexample"><pre class="programlisting">    whenComplete : function(){
     callback(workers.results);
    }
  };</pre></div></li><li class="listitem">Action taken by this part of the recipe is to create an HTTP client:<div class="informalexample"><pre class="programlisting">  var xhr = Ti.Network.createHTTPClient();</pre></div></li><li class="listitem">An <code class="literal">onload</code> callback is created to retrieve the HTTP response provided by the RSS feed:<div class="informalexample"><pre class="programlisting">  xhr.onload = function(e) {</pre></div></li><li class="listitem">When the request is returned, the <code class="literal">responseXML</code> property is used to gather the XML results from the RSS feed:<div class="informalexample"><pre class="programlisting">    var xml = this.responseXML;</pre></div></li><li class="listitem">The XML results are then converted to objects using our helper method:<div class="informalexample"><pre class="programlisting">    var objResults = helpers.parseToObjects (xml);</pre></div></li><li class="listitem">If the converted XML object is <code class="literal">null</code>, use the callback method to notify the user that the module failed to read the provided RSS feed:<div class="informalexample"><pre class="programlisting">    if(objResults ==null){
      workers.whenComplete();
      return;
    }</pre></div></li><li class="listitem">If the XML was successfully able to be converted into objects, populate the query<a id="id343" class="indexterm"/> results with the full XML results and create a flag indicating the query was successfully executed.<div class="informalexample"><pre class="programlisting">    workers.results.rssDetails.full = objResults;
    workers.results.success = true;
    workers.results.rssDetails.items = objResults.item;</pre></div></li><li class="listitem">If a <code class="literal">pathQuery</code> string <a id="id344" class="indexterm"/>was provided, run the query and update the <code class="literal">results</code> object with the output from the <a id="id345" class="indexterm"/><code class="literal">queryByPath</code> method.<div class="informalexample"><pre class="programlisting">    if(pathQuery!=null){
      workers.results.rssDetails.items = helpers.queryByPath(wobjResults,pathQuery);
    }
  };</pre></div></li><li class="listitem">Provide an <code class="literal">onerror</code> callback to handle an error generated during the <code class="literal">HTTPClient</code> request.<div class="informalexample"><pre class="programlisting">  xhr.onerror = function(e) {
    Ti.API.info(JSON.stringify(e));
    workers.whenComplete();
  };</pre></div></li><li class="listitem">Open the HTTP client and send a <code class="literal">GET</code> request to the RSS URL provided.<div class="informalexample"><pre class="programlisting">  xhr.open('GET', url);
  xhr.send();
};</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip24"/>Tip</h3><p>The order in which the functions are called is important. The <code class="literal">open</code> method must be called before calling the <code class="literal">send</code> method, as shown in the previous code section.</p></div></div></li></ol></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec56"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To learn more about YQL<a id="id346" class="indexterm"/>, visit the Yahoo developer site at <a class="ulink" href="http://developer.yahoo.com/yql">http://developer.yahoo.com/yql</a></li><li class="listitem" style="list-style-type: disc">For YQL usage guidelines<a id="id347" class="indexterm"/> and rate information, visit <a class="ulink" href="http://developer.yahoo.com/yql/guide/usage_info_limits.html">http://developer.yahoo.com/yql/guide/usage_info_limits.html</a></li></ul></div></div></div>
<div class="section" title="Creating a business location map using Yahoo Local"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec28"/>Creating a business location map using Yahoo Local</h1></div></div></div><p>Providing a store, <a id="id348" class="indexterm"/>client, or other location-listing feature is a common requirement for many Enterprise apps. In this recipe, we will <a id="id349" class="indexterm"/>show how to use the Yahoo Local Search API and <code class="literal">Ti.Map.View</code> to provide a store locator. For demonstration purposes, the recipe uses the Yahoo API to <a id="id350" class="indexterm"/>provide location search results for the popular American coffee chain, Starbucks. The search results for each location are then displayed on a <code class="literal">Ti.Map.View</code>, as shown in the following screenshots:</p><div class="mediaobject"><img src="graphics/5343OT_04_03.jpg" alt="Creating a business location map using Yahoo Local"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec57"/>Getting ready</h2></div></div></div><p>This recipe uses the Yahoo Search CommonJS module<a id="id351" class="indexterm"/>. This module and other code assets can be downloaded from the source code provided by the book. Installing this module into your project is straightforward. Simply add the <code class="literal">yahoo_search.js</code> file into your project, <a id="id352" class="indexterm"/>as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5343OT_04_04.jpg" alt="Getting ready"/></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec58"/>How to do it…</h2></div></div></div><p>Once you've added the <code class="literal">yahoo_search.js</code> file to your project, you need to create your application <a id="id353" class="indexterm"/>namespaces in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the module into your code, as shown in the following code block:</p><div class="informalexample"><pre class="programlisting">//Create our application namespace
var my = {
  search : require('yahoo_search'),
  isAndroid : ( Ti.Platform.osname === 'android')
};</pre></div><div class="section" title="Adding your API key"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec108"/>Adding your API key</h3></div></div></div><p>The next <a id="id354" class="indexterm"/>step in our recipe is to add your Yahoo developer API key. The following snippet shows how to register your API key with the module:</p><div class="informalexample"><pre class="programlisting">my.search.addAPIKey('YOUR_KEY_GOES_HERE');</pre></div></div><div class="section" title="Creating a UI for the sample app"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec109"/>Creating a UI for the sample app</h3></div></div></div><p>This recipe<a id="id355" class="indexterm"/> uses a simple UI containing <code class="literal">Ti.UI.TextField</code>, <code class="literal">Ti.Map.View</code>, and a <code class="literal">Ti.UI.Button</code> to search. Here we demonstrate the creation of these UI elements.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, we create a <code class="literal">Ti.UI.Window</code> to attach our visual elements.<div class="informalexample"><pre class="programlisting">  var win = Ti.UI.createWindow({
    backgroundColor:'#fff'
  });</pre></div></li><li class="listitem">Next, we attach a text field to allow the user to enter a business for which to search.<div class="informalexample"><pre class="programlisting">  var txtSubject = Ti.UI.createTextField({
    left:0, width:150, height:40,top:30,
    hintText:'Enter Business Name',
    borderStyle:Ti.UI.INPUT_BORDERSTYLE_ROUNDED
  });
  win.add(txtSubject);</pre></div></li><li class="listitem">Next, a button is added to allow the user to search for the business name entered in the text field.<div class="informalexample"><pre class="programlisting">  var searchButton = Ti.UI.createButton({
    title:'Search', right:0, width:150, height:40,top:30	
  });
  win.add(searchButton);</pre></div></li><li class="listitem">Finally, a map view is attached to display our search results.<div class="informalexample"><pre class="programlisting">  var mapView = Ti.Map.createView({
    mapType: Ti.Map.STANDARD_TYPE, width:Ti.UI.FILL,
    userLocation:true, top:75,bottom:0
  });
  win.add(mapView);</pre></div></li></ol></div></div><div class="section" title="Updating the map"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec110"/>Updating the map</h3></div></div></div><p>The <code class="literal">updateMap</code> function<a id="id356" class="indexterm"/> is the<a id="id357" class="indexterm"/> callback method to the search module. <code class="literal">updateMap</code> provides the search results and then it transforms them to display to the user.</p><div class="informalexample"><pre class="programlisting">  function updateMap(e){</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The search results are provided as the <code class="literal">e</code> parameter to the method. The first step in the process is to check if the search was successful, by checking the <code class="literal">e.success</code> property.<div class="informalexample"><pre class="programlisting">    if(!e.success){
      alert("Sorry we encountered an error");
      return;
    }</pre></div></li><li class="listitem">After verifying that the search was successful, a loop is used to create map annotations for each <code class="literal">e.item</code> provided in the results.<div class="informalexample"><pre class="programlisting">    var points = [], itemCount = e.items.length, rightBtn = Ti.UI.iPhone.SystemButton.DISCLOSURE;
    for (var iLoop=0;iLoop&lt;itemCount;iLoop++){
      points.push(Ti.Map.createAnnotation({
        latitude : e.items[iLoop].Latitude,
          longitude : e.items[iLoop].Longitude,
          title : e.items[iLoop].Address,
          subtitle : e.items[iLoop].Phone,
          pincolor : Ti.Map.ANNOTATION_GREEN,
          ClickUrl : items[iLoop].ClickUrl,
          animate:true, rightButton: rightBtn
      }));
    }
  
    var currentRegion = { latitude:e.latitude, longitude:e.longitude, latitudeDelta:0.04, longitudeDelta:0.04};</pre></div></li><li class="listitem">The new region object is created using the search coordinates and applied to set the viewing point of the map. This allows the user to see all of the pins added.<div class="informalexample"><pre class="programlisting">      mapView.setLocation(currentRegion);
      mapView.regionFit = true;</pre></div></li><li class="listitem">Finally, the points array containing all of our annotations is added to the <code class="literal">mapView</code>.<div class="informalexample"><pre class="programlisting">    mapView.annotations = points;
  };</pre></div></li></ol></div></div><div class="section" title="Searching"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec111"/>Searching</h3></div></div></div><p>When the <code class="literal">searchButton</code> button is pressed, the following snippet is used to perform a location search<a id="id358" class="indexterm"/> using the device's coordinates.</p><div class="informalexample"><pre class="programlisting">  searchButton.addEventListener('click',function(e){</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, any existing map pins are removed<div class="informalexample"><pre class="programlisting">    mapView.removeAllAnnotations();</pre></div></li><li class="listitem">If the text field's keyboard is open, the <code class="literal">blur</code> method is called to close it.<div class="informalexample"><pre class="programlisting">    txtSubject.blur();</pre></div></li><li class="listitem">To avoid an empty search, the text field is checked to make sure it contains a value.<div class="informalexample"><pre class="programlisting">    if((txtSubject.value+'').length ===0){
      alert('Enter a business to search');
      return;
    }</pre></div></li><li class="listitem">The module's <code class="literal">currentLocationQuery</code> method is then called, providing the business name entered in the text field and the <code class="literal">updateMap</code> function to be used as a callback.<div class="informalexample"><pre class="programlisting">    my.search.currentLocationQuery(txtSubject.value,updateMap);
  });</pre></div></li></ol></div></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec59"/>How it works…</h2></div></div></div><p>The Yahoo Search CommonJS module (<code class="literal">yahoo_search.js</code>) provides the following public functions, detailed in the following sections.</p><div class="section" title="Using addAPIKey to your Yahoo service key"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec112"/>Using addAPIKey to your Yahoo service key</h3></div></div></div><p>The Yahoo <a id="id359" class="indexterm"/>Local Search API requires a developer key. Before using any of the query methods, you must first use <code class="literal">addAPIKey</code>
<a id="id360" class="indexterm"/> to associate your developer key with the module.</p><div class="informalexample"><pre class="programlisting">my.search.addAPIKey('YOUR_KEY_GOES_HERE');</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip25"/>Tip</h3><p>You can obtain a Yahoo API key by visiting <a class="ulink" href="http://developer.yahoo.com">developer.yahoo.com</a> and creating a project within their developer portal.</p></div></div></div><div class="section" title="Using the geoQuery method"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec113"/>Using the geoQuery method</h3></div></div></div><p>The<a id="id361" class="indexterm"/> <code class="literal">geoQuery</code> function <a id="id362" class="indexterm"/>performs a Yahoo Local search using the latitude, longitude, and topic provided. The next example demonstrates how to search for Starbucks locations near Times Square in New York City. When the search has been completed, the results are provided to the <code class="literal">callback</code> function.</p><div class="informalexample"><pre class="programlisting">my.search.geoQuery(40.75773, -73.985708,'starbucks',callback);</pre></div></div><div class="section" title="Using the currentLocationQuery method"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec114"/>Using the currentLocationQuery method</h3></div></div></div><p>The<a id="id363" class="indexterm"/> <code class="literal">currentLocationQuery</code> method<a id="id364" class="indexterm"/> uses your device's location services to determine your current latitude and longitude. It then provides the <code class="literal">geoQuery</code> function with the required search details. The next code line demonstrates how to search for Starbucks outlets near your current position. Once the search has been completed, the results are provided to the <code class="literal">callback</code> function.</p><div class="informalexample"><pre class="programlisting">my.search.currentLocationQuery('starbucks',callback);</pre></div></div></div></div>
<div class="section" title="Using Google Analytics in your app"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec29"/>Using Google Analytics in your app</h1></div></div></div><p>Google Analytics<a id="id365" class="indexterm"/> is a popular service used to measure and record website traffic and activities. Most likely, your organization uses Google Analytics, or a similar service, to gather analytics about visitors to your site. Using a Titanium module, <a id="id366" class="indexterm"/>you can use the same Google Analytics platform within your app. This approach allows you to view both your mobile and web traffic in one easy-to-use dashboard.</p><p>In this recipe, we will demonstrate how to submit both "page view" and "action" events to your Google Analytics dashboard.</p><div class="mediaobject"><img src="graphics/5343OT_04_05.jpg" alt="Using Google Analytics in your app"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec60"/>Getting ready</h2></div></div></div><p>This recipe uses the <code class="literal">Ti.Google.Analytics</code> CommonJS module<a id="id367" class="indexterm"/>. This module and other code assets can be <a id="id368" class="indexterm"/>downloaded from the source code provided by the book, or individually through the links provided in the <span class="emphasis"><em>See also</em></span> section at the end of this recipe. Installing this module into your project is straightforward. Simply copy the <code class="literal">Ti.Google.Analytics.js</code> file into your project, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5343OT_04_06.jpg" alt="Getting ready"/></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec61"/>How to do it…</h2></div></div></div><p>Once you've added the <code class="literal">Ti.Google.Analytics.js</code> file to your project, you need to create your<a id="id369" class="indexterm"/> application namespaces in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the module into your code, as shown in the following code block:</p><div class="informalexample"><pre class="programlisting">//Create our application namespace
var my = {
  gAnalyticsModule : require('Ti.Google.Analytics'),
  isAndroid : (Ti.Platform.osname === 'android'),
  session:{}
};</pre></div><div class="section" title="Creating an instance of the module"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec115"/>Creating an instance of the module</h3></div></div></div><p>The next step <a id="id370" class="indexterm"/>in the recipe requires you to have a Google Analytics key. To obtain a key, please register your app at <a class="ulink" href="http://www.google.com/analytics">www.google.com/analytics</a>. Once you have a key, you will need to create a new instance of the <code class="literal">Analytics</code> module and provide your analytics key, as shown here:</p><div class="informalexample"><pre class="programlisting">my.session.ga = new my.gaModule('YOUR_KEY_HERE');</pre></div></div><div class="section" title="Helper functions"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec116"/>Helper functions</h3></div></div></div><p>Helper functions<a id="id371" class="indexterm"/> help to provide more meaningful information about the user's device. These functions are used throughout the recipe whenever a <code class="literal">PageView</code> action is fired.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The following snippet demonstrates how the <code class="literal">isTablet</code> property is attached to the application namespace on starting an app. This property is used by other functions to indicate if the app is running on a phone or tablet.<div class="informalexample"><pre class="programlisting">my.isTablet = (function() {
  var tabletCheck = Ti.Platform.osname === 'ipad' || 
    (Ti.Platform.osname === 'android' &amp;&amp; 
    (!(Math.min(
      Ti.Platform.displayCaps.platformHeight,
      Ti.Platform.displayCaps.platformWidth
    ) &lt; 700)));

  return tabletCheck;
})();</pre></div></li><li class="listitem">The <code class="literal">basePage</code> property works in a way similar to website routing, and sets the first part of the URL (that is sent to Google) as a device indicator. In Google Analytics, this will allow you to better segment usage patterns by device.<div class="informalexample"><pre class="programlisting">my.basePage = (function(){
  if(my.isAndroid){
    return ((my.isTablet)? 
    'AndroidTablet' : 'AndroidPhone');
  }else{
    //Return iPhone or iPad
    return Ti.Platform.model;
  }
})();</pre></div></li></ol></div></div><div class="section" title="Start recording events"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec117"/>Start recording events</h3></div></div></div><p>The next <a id="id372" class="indexterm"/>step is to call the <code class="literal">start</code> method. This will enable the module to start collecting analytics requests. The <code class="literal">start</code> method takes an integer value with the number of seconds on how often you wish the module to send queued analytics to Google. This is handled internally by the module using an interval timer.</p><div class="informalexample"><pre class="programlisting">my.session.ga.start(10);</pre></div></div><div class="section" title="Creating our sample UI"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec118"/>Creating our sample UI</h3></div></div></div><p>This section of<a id="id373" class="indexterm"/> the recipe outlines the sample UI used to trigger and submit Google Analytics requests.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, a <code class="literal">Ti.UI.Window</code> is created to anchor all UI controls.<div class="informalexample"><pre class="programlisting">  var win = Ti.UI.createWindow({
    backgroundColor:'#fff', layout:'vertical'
  });</pre></div></li><li class="listitem">After creating our window, two <code class="literal">Ti.UI.Button</code> controls are added. These buttons will be used later in the recipe to demonstrate how to create a <code class="literal">trackEvent</code> or <code class="literal">Pageview</code> event.<div class="informalexample"><pre class="programlisting">  var button1 = Ti.UI.createButton({
      title: 'Log Action', top:40, height:45, width:Ti.UI.FILL
  });
  win.add(button1);

  var button2 = Ti.UI.createButton({
    title: 'Open New Page', top:40, height:45, width:Ti.UI.FILL
  });
  win.add(button2);</pre></div></li></ol></div></div><div class="section" title="Recording an action"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec119"/>Recording an action</h3></div></div></div><p>The <code class="literal">trackEvent</code> function<a id="id374" class="indexterm"/>
<a id="id375" class="indexterm"/> allows you to publish granular event tracking to Google Analytics. This method requires the following parameters that will be used to publish actions to your <a id="id376" class="indexterm"/>Google Analytics dashboard:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Category</strong></span>: Typically, the object that was interacted with (for example, a button)</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Action</strong></span>: The type of interaction (for example, a click)</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Label</strong></span>: Useful for categorizing events (for example, nav buttons)</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Value</strong></span>: Values must be non-negative. Useful to pass counts (for example, four times)</li></ul></div><p>The next snippet demonstrates how to call the <code class="literal">trackEvent</code> method when <code class="literal">button1</code> is pressed. On firing of the button's click event, the <code class="literal">trackEvent</code> method is called with a category of <code class="literal">button</code>, an action of <code class="literal">click</code>, a label of <code class="literal">recipe_button</code>, and a value of <code class="literal">trigger_event</code>.</p><div class="informalexample"><pre class="programlisting">  button1.addEventListener('click',function(e){
    my.session.ga.trackEvent('button','click', 'win_button', 'trigger_event');
  });</pre></div></div><div class="section" title="The Pageview function on opening a window"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec120"/>The Pageview function on opening a window</h3></div></div></div><p>The <code class="literal">trackPageview</code> function <a id="id377" class="indexterm"/>is used to mimic the page traffic or views displayed in your Google Analytics dashboard. Using the <code class="literal">basePage</code> properties created earlier, you can create device-specific window tracking by using the convention shown in the following code block:</p><div class="informalexample"><pre class="programlisting">  win.addEventListener('open',function(e){
    my.session.ga.trackPageview(my.basePage + "/Main");
  });
  win.open();</pre></div></div><div class="section" title="The Pageview function on a child window"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec121"/>The Pageview function on a child window</h3></div></div></div><p>The following<a id="id378" class="indexterm"/> section of the recipe demonstrates how to use the <code class="literal">trackPageview</code> and <code class="literal">trackEvent</code> methods to record when and how a child window or view is opened. When the user presses <code class="literal">button2</code> and the click event is fired, the Google Analytics module is used to log each step of the navigation process.</p><div class="informalexample"><pre class="programlisting">  button2.addEventListener('click',function(e){</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Use the <code class="literal">trackEvent</code> method to record that the button to open a child window has been pressed:<div class="informalexample"><pre class="programlisting">  my.session.ga.trackEvent('button','click', 'win_button', 'open_win2');</pre></div><p>You need to provide the following parameters to the <code class="literal">trackEvent</code> method:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Category</strong></span>: A category value of <code class="literal">button</code> is provided in this sample</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Action</strong></span>: An action value of <code class="literal">click</code> is provided in this sample</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Label</strong></span>: A label value of <code class="literal">win_button</code> is provided in this sample</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Value</strong></span>: A value of <code class="literal">open_win2</code> is provided in this sample</li></ul></div></li><li class="listitem">Create a new window to demonstrate the <code class="literal">trackPageview</code> functionality on a child window.<div class="informalexample"><pre class="programlisting">    var win2 = Ti.UI.createWindow({
      backgroundColor:'yellow', layout:'vertical'
    });</pre></div></li><li class="listitem">On loading of the <code class="literal">win2</code> window, the <code class="literal">trackPageview</code> method is called, recording<a id="id379" class="indexterm"/> that the individual has viewed the page. The <code class="literal">my.basePage</code> is used to create a route showing which type of device accessed the <code class="literal">/win2</code> window.<div class="informalexample"><pre class="programlisting">    win2.addEventListener('open',function(e){
      my.session.ga.trackPageview(my.basePage + "/win2");
    });
    win2.open({modal:true});
  });</pre></div></li></ol></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec62"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">This recipe uses a modified version of Roger Chapman's Titanium Mobile Google Analytics module. To learn more about this module, please visit <a class="ulink" href="http://%20github.com/rogchap/Titanium-Google-Analytics">http:// github.com/rogchap/Titanium-Google-Analytics</a>.</li><li class="listitem" style="list-style-type: disc">For more information on detecting different device characteristics, see the <span class="emphasis"><em>Using platform indicators</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Patterns and Platform Tools">Chapter 1</a>, <span class="emphasis"><em>Patterns and Platform Tools</em></span>.</li></ul></div></div></div>
<div class="section" title="Making SOAP service calls using SUDS.js"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec30"/>Making SOAP service calls using SUDS.js</h1></div></div></div><p>In many<a id="id380" class="indexterm"/> Enterprise market segments, SOAP services remain the dominant web service protocol. Since SOAP is generally implemented over HTTP, most network clients including Titanium's <code class="literal">Ti.Network</code> can interact effectively with this protocol.</p><p>Even with Titanium's <code class="literal">Ti.Network</code> module working with SOAP, envelopes and XML results can be challenging, and often requires creating a SOAP envelope and a huge amount of XML manipulation. This recipe demonstrates how a few open-source modules can increase your productivity when interacting with SOAP services and their XML results.</p><p>To help illustrate how to interact with<a id="id381" class="indexterm"/> SOAP services, the recipe uses the <a class="ulink" href="http://www.webserviceX.NET">www.webserviceX.NET</a> weather SOAP service to return weather results for a city entered in the <span class="strong"><strong>City:</strong></span> field, as shown in the following screenshots:</p><div class="mediaobject"><img src="graphics/5343OT_04_07.jpg" alt="Making SOAP service calls using SUDS.js"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec63"/>Getting ready</h2></div></div></div><p>This recipe uses the <code class="literal">SUDS</code>
<a id="id382" class="indexterm"/> and <code class="literal">XMLTools</code>
<a id="id383" class="indexterm"/> CommonJS modules. These modules and other code assets can<a id="id384" class="indexterm"/> be downloaded from the source code provided by the book, or individually through the links provided in the <span class="emphasis"><em>See also</em></span> section at the end of this recipe. Installing these modules is straightforward and simply requires copying the <code class="literal">suds2.js</code> and <code class="literal">XMLTools.js</code> files into your Titanium project, as highlighted in the following screenshot:</p><div class="mediaobject"><img src="graphics/5343OT_04_08.jpg" alt="Getting ready"/></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec64"/>How to do it…</h2></div></div></div><p>Once you've added the <code class="literal">suds2.js</code> and <code class="literal">XMLTools.js</code> modules to your project, you need to create<a id="id385" class="indexterm"/> your application namespaces in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the module into your code, as shown in the following snippet:</p><div class="informalexample"><pre class="programlisting">//Create our application namespace
var my = {
  suds : require('suds2'),
  xmlTools : require("XMLTools"),
  isAndroid : (Ti.Platform.osname === 'android')
};</pre></div><div class="section" title="SOAP helper methods"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec122"/>SOAP helper methods</h3></div></div></div><p>In addition to<a id="id386" class="indexterm"/> the two CommonJS modules imported earlier, this recipe uses the <code class="literal">soapHelper</code> object to handle formatting and configuration activities.</p><div class="informalexample"><pre class="programlisting">var soapHelper = {</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The configuration object contains all the configuration details that <code class="literal">suds.js</code> needs to return an XML result:<div class="informalexample"><pre class="programlisting">  config : {
    endpoint:"http://www.webservicex.com/globalweather.asmx";  targetNamespace: 'http://www.webserviceX.NET/',
    includeNS : false,
    addTargetSchema : true 
  },</pre></div></li><li class="listitem">The <code class="literal">resultParser</code> object is used to format the returned XML result into JavaScript objects:<div class="informalexample"><pre class="programlisting">  resultParser : {</pre></div></li><li class="listitem">The <code class="literal">removeHeader</code> object is used to remove the XML header node. Android requires the header to be removed before the <code class="literal">parseString</code> function will correctly create an XML document object.<div class="informalexample"><pre class="programlisting">    removeHeader : function(text){
      return text.replace(
        '&lt;?xml version="1.0" encoding="utf-16"?&gt;',''); 
    },</pre></div></li><li class="listitem">The <code class="literal">xmlToObject</code> function<a id="id387" class="indexterm"/> converts a <code class="literal">Ti.XML.Document</code> object into JavaScript objects.<div class="informalexample"><pre class="programlisting">    xmlToObject : function(doc){</pre></div></li><li class="listitem">The first step is to get a <code class="literal">Ti.XML.Nodelist</code> for the tag <code class="literal">GetWeatherResponse</code>.<div class="informalexample"><pre class="programlisting">var results = doc.documentElement.getElementsByTagName(
 'GetWeatherResponse');</pre></div></li><li class="listitem">Android and iOS handle the conversion process differently. Use the <code class="literal">my.isAndroid</code> property to branch the conversion logic.<div class="informalexample"><pre class="programlisting">if(my.isAndroid){</pre></div></li><li class="listitem">The weather service result contains a nested XML document. The following example demonstrates how to read the embedded XML document from the <code class="literal">GetWeatherResponse</code> node into a new <code class="literal">Ti.XML.Document</code>. The <code class="literal">removeHeader</code> function is used to fix the <code class="literal">textContent</code> value, to be compliant with Android's <code class="literal">XML Documen</code>t format.<div class="informalexample"><pre class="programlisting">var docCurrent =Ti.XML.parseString(
  soapHelper.resultParser.removeHeader(
  results.item(0).textContent));</pre></div></li><li class="listitem">Next, the <code class="literal">Ti.XML.Document</code> object is provided to the <code class="literal">XMLTools</code> module's constructor and then converted into JavaScript objects using the<a id="id388" class="indexterm"/> <code class="literal">toObject</code> method, as demonstrated in the following snippet:<div class="informalexample"><pre class="programlisting">      return new my.xmlTools(docCurrent).toObject();
    }else{</pre></div></li><li class="listitem">On iOS, we use the <code class="literal">getChildNodes</code> function<a id="id389" class="indexterm"/> to obtain the weather child node:<div class="informalexample"><pre class="programlisting">    var weather =results.item(0).getChildNodes()
      .item(0).getChildNodes();</pre></div></li><li class="listitem">The XML string from the weather node is then loaded into the <code class="literal">XMLTools</code> module's constructor, and then converted into JavaScript objects using the <code class="literal">toObject</code> method, as demonstrated in the following code block:<div class="informalexample"><pre class="programlisting">        var docCurrentFromString = Ti.XML.parseString(soapHelper.resultParser.removeHeader(weather.item(0).textContent));
        return new my.xmlTools(docCurrentFromString).toObject();
      }
    }
  }
};</pre></div></li></ol></div></div><div class="section" title="Creating the UI"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec123"/>Creating the UI</h3></div></div></div><p>This section <a id="id390" class="indexterm"/>of the recipe outlines the sample UI used to call and display results from the weather SOAP service.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">A new <code class="literal">Ti.UI.Window</code> is created for all UI elements to be attached.<div class="informalexample"><pre class="programlisting">  var win = Ti.UI.createWindow({
    backgroundColor:'#fff', layout:'vertical'
  });</pre></div></li><li class="listitem">The text field <code class="literal">txtCity</code> is to allow the user to enter the city whose weather they wish to be displayed.<div class="informalexample"><pre class="programlisting">  var txtCity = Ti.UI.createTextField({
      value:'New York', hintText:'Enter city',top:10, height:40, left:10, right:10,textAlign:'left', borderStyle:Ti.UI.INPUT_BORDERSTYLE_ROUNDED 
  });
  win.add(txtCity);</pre></div></li><li class="listitem">The text field <code class="literal">txtCountry</code> is to allow the user to input the name of the country to which the city belongs.<div class="informalexample"><pre class="programlisting">  var txtCountry = Ti.UI.createTextField({
    value:'United States', hintText:'Enter country',top:10, height:40, left:10, right:10, textAlign:'left', borderStyle:Ti.UI.INPUT_BORDERSTYLE_ROUNDED 
  });
  win.add(txtCountry);</pre></div></li><li class="listitem">The <a id="id391" class="indexterm"/><code class="literal">goButton</code> is a <code class="literal">Ti.UI.Button</code> used to call the weather SOAP service.<div class="informalexample"><pre class="programlisting">  var goButton = Ti.UI.createButton({
    title:'Find Weather', left:10, top:10
  });
  win.add(goButton);</pre></div></li><li class="listitem">The <code class="literal">tableView</code> is a <code class="literal">Ti.UI.TableView</code> used to display the results of the SOAP service.<div class="informalexample"><pre class="programlisting">  var tableView = Ti.UI.createTableView({
    visible : false, top:10, height:100, width:Ti.UI.FILL
  });
  win.add(tableView);</pre></div></li></ol></div></div><div class="section" title="The uiHelpers object"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec124"/>The uiHelpers object</h3></div></div></div><p>The<a id="id392" class="indexterm"/> <code class="literal">uiHelpers</code> object is used to update the UI objects <a id="id393" class="indexterm"/>with different states of the app as well as load the <code class="literal">tableView</code> with the SOAP service result.</p><div class="informalexample"><pre class="programlisting">var uiHelpers = {</pre></div><p>The <code class="literal">updateUI</code> is used to format the object results from the SOAP service for display.</p><div class="informalexample"><pre class="programlisting">  updateUI : function(weather){
    var data = [];
    tableView.visible = true;
    data.push({title: "Sky Conditions: " + weather.SkyConditions, color:'#000'});
    data.push({title: "Temperature: " + weather.Temperature, color:'#000'});
    data.push({title: "Time: " + weather.Time});
    tableView.setData(data);	
  };</pre></div><p>The <code class="literal">resetUI</code> method is <a id="id394" class="indexterm"/>used to hide the <code class="literal">tableView</code> from the user when <code class="literal">SUDS</code> is calling the web service. This method is also used to hide the <code class="literal">tableView</code> when the a <code class="literal">SUDS</code> call results in an error.</p><div class="informalexample"><pre class="programlisting">  resetUI :function(){
    tableView.visible = false;
  };
};</pre></div></div><div class="section" title="Calling the SOAP service"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec125"/>Calling the SOAP service</h3></div></div></div><p>The click event <a id="id395" class="indexterm"/>on the <code class="literal">goButton</code> is used to perform the weather SOAP service call.</p><div class="informalexample"><pre class="programlisting">goButton.addEventListener('click',function(e){</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">resetUI</code> method<a id="id396" class="indexterm"/> is first called to hide the <code class="literal">tableView</code> while the service is being called.<div class="informalexample"><pre class="programlisting">  uiHelpers.resetUI()</pre></div></li><li class="listitem">A new instance of <code class="literal">sudsClient</code> is created with the configuration information defined earlier in the <code class="literal">soapHelper.config</code> object.<div class="informalexample"><pre class="programlisting">  var sudsClient = new my.suds(soapHelper.config);</pre></div></li><li class="listitem">The <code class="literal">invoke</code> method<a id="id397" class="indexterm"/> is then called on <code class="literal">sudsClient</code>. The first argument provided is the SOAP method that <code class="literal">suds</code> should call.<div class="informalexample"><pre class="programlisting">  sudsClient.invoke('GetWeather', </pre></div></li><li class="listitem">The second argument provided to <code class="literal">sudsClient</code> is the name of the city and country that the user has requested, to retrieve weather information.<div class="informalexample"><pre class="programlisting">  {
    CityName: txtCity.value,
    CountryName: txtCountry.value
  }, </pre></div></li><li class="listitem">The final argument of the <code class="literal">invoke</code> method is the callback method <code class="literal">SUDS</code>. This callback method will be provided will to provide a <code class="literal">Ti.XML.Document</code> with the service's results. The following example demonstrates using an inline function as a callback method:<div class="informalexample"><pre class="programlisting">  function(xml) {</pre></div></li><li class="listitem">The inline callback method will receive a <code class="literal">Ti.XML.Document</code> once the service has completed. Once received, the result is parsed into JavaScript objects using the <code class="literal">resultParser</code> object, as detailed earlier in the recipe.<div class="informalexample"><pre class="programlisting">    var weather = soapHelper.resultParser.xml2Object(xml);</pre></div></li><li class="listitem">The <code class="literal">Status</code> property is changed on the parsed object to determine if the weather objects have successfully been created.<div class="informalexample"><pre class="programlisting">    if(weather.Status==='Success'){</pre></div></li><li class="listitem">If the service results have successfully been converted into objects, they are provided to the <code class="literal">updateUI</code> method<a id="id398" class="indexterm"/>, to be displayed to the user.<div class="informalexample"><pre class="programlisting">      uiHelpers.updateUI(weather);
    }else{</pre></div></li><li class="listitem">If an error <a id="id399" class="indexterm"/>occurred in calling the service or processing the results, we alert the user and then hide the <code class="literal">tableView</code> display object.<div class="informalexample"><pre class="programlisting">      alert("Sorry a problem happened");
      uiHelpers.resetUI();
    }
  });
});</pre></div></li></ol></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec65"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Please review the following links to learn more about the open source projects used in this recipe:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>SUDS.js</strong></span>: For <a id="id400" class="indexterm"/>additional information on SUDS.js, <a id="id401" class="indexterm"/>please visit <a class="ulink" href="http://github.com/kwhinnery/Suds">http://github.com/kwhinnery/Suds</a>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>SUDS2.js</strong></span>: For more<a id="id402" class="indexterm"/> information about the version of SUDS.js <a id="id403" class="indexterm"/>used in this recipe, please visit <a class="ulink" href="http://github.com/benbahrenburg/Suds2">http://github.com/benbahrenburg/Suds2</a>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>XMLTools</strong></span>: This recipe <a id="id404" class="indexterm"/>uses the XMLTools module created by David Bankier. For more information about this<a id="id405" class="indexterm"/> module, please visit <a class="ulink" href="http://github.com/dbankier/XMLTools-For-Appcelerator-Titanium">http://github.com/dbankier/XMLTools-For-Appcelerator-Titanium</a>.</li></ul></div></li></ul></div></div></div>
<div class="section" title="Using the LinkedIn Contacts API"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec31"/>Using the LinkedIn Contacts API</h1></div></div></div><p>LinkedIn is a<a id="id406" class="indexterm"/> popular social-networking site for professionals. The LinkedIn API provides a rich set of integration services for use within your app. For Enterprise-focused apps, LinkedIn features such as Messaging and Contacts can be critical. Common examples of this would be providing a sales agent with access to their contacts within your app.</p><p>This recipe <a id="id407" class="indexterm"/>demonstrates how to integrate the LinkedIn Contacts API into<a id="id408" class="indexterm"/> your Titanium app, in a searchable fashion.</p><div class="mediaobject"><img src="graphics/5343OT_04_09.jpg" alt="Using the LinkedIn Contacts API"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec66"/>Getting ready</h2></div></div></div><p>This recipe uses several modules, including the innovative LinkedIn module, <code class="literal">linkedin_module-min.js</code>. This module and other code assets can be downloaded from the source code provided by the book, or individually through the links provided in the <span class="emphasis"><em>See also</em></span> section at the end of this recipe. Setting up the dependencies for this recipe is straightforward. First, copy the <code class="literal">lib</code> folder to the <code class="literal">Resources</code> folder of your Titanium project, and then, the <code class="literal">copy formatters.js</code> and <code class="literal">linkedin_module-min.js</code> files into the <code class="literal">Resources</code> folder, as shown highlighted in the following screenshot:</p><div class="mediaobject"><img src="graphics/5343OT_04_10.jpg" alt="Getting ready"/></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec67"/>How to do it…</h2></div></div></div><p>After you have<a id="id409" class="indexterm"/> set up the recipe's dependencies, the next step is to create your application namespaces in the <code class="literal">app.js</code> file and use <code class="literal">require</code> to import the module into your code, as shown in the following snippet:</p><div class="informalexample"><pre class="programlisting">//Create our application namespace
var my = {
  isAndroid : (Ti.Platform.osname === 'android'),
  linkedMod: require('linkedin_module-min'),
  formatters : require('formatters')
};</pre></div><div class="section" title="Adding your API key and secret key"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec126"/>Adding your API key and secret key</h3></div></div></div><p>The first step<a id="id410" class="indexterm"/> in using the LinkedIn module is to create a LinkedIn application at <a class="ulink" href="https://www.linkedin.com/secure/developer">https://www.linkedin.com/secure/developer</a>. Once you have <a id="id411" class="indexterm"/>registered your application, LinkedIn will provide you with the API and authentication keys needed to interact with their APIs. All of the APIs used in this recipe need <code class="literal">OAuth 1.0a</code> authentication to connect. The LinkedIn module will handle this for you by using the <code class="literal">init</code> method to register your <a id="id412" class="indexterm"/>secret <a id="id413" class="indexterm"/>and API keys, as shown in the following example:</p><div class="informalexample"><pre class="programlisting">my.linkedMod.init('YOUR_SECRET_KEY', 'YOUR_API_KEY');</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip26"/>Tip</h3><p>You must use the <code class="literal">init</code> method to set your secret and API keys, before using any of the module's functionality.</p></div></div></div><div class="section" title="Adding permissions"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec127"/>Adding permissions</h3></div></div></div><p>By default<a id="id414" class="indexterm"/>, if no permissions are specified, your app will only have rights to read basic "digital business card" information about the current user. Since this recipe needs access to the user's contacts, we must call the <code class="literal">addPermission</code> method to request for the <code class="literal">r_network</code> privilege, as shown in the following snippet:</p><div class="informalexample"><pre class="programlisting">my.linkedMod.addPermission('r_network');</pre></div><p>To add multiple permissions, simply call the <code class="literal">addPermission</code> method several times. The following snippet shows how to add the full profile access right to the app:</p><div class="informalexample"><pre class="programlisting">my.linkedMod.addPermission('r_fullprofile');</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip27"/>Tip</h3><p>For a full list of all the permissions, please visit <a class="ulink" href="https://developer.linkedin.com/documents/authentication">https://developer.linkedin.com/documents/authentication</a>.</p></div></div></div><div class="section" title="Creating the UI"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec128"/>Creating the UI</h3></div></div></div><p>This section of <a id="id415" class="indexterm"/>the recipe outlines how to create the UI that is used to display and search LinkedIn contacts.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, a <code class="literal">Ti.UI.Window</code> is created. This will be used to attach all of our visual elements and will also trigger a call to the LinkedIn API when the open event is fired.<div class="informalexample"><pre class="programlisting">  var win = Ti.UI.createWindow({
    backgroundColor:'#fff'
  });</pre></div></li><li class="listitem">A <code class="literal">Ti.UI.SearchBar</code> is then created. The search-bar control provides a search box that filters the contents of <code class="literal">Ti.UI.TableView</code>. In this recipe, we use the search-bar control to filter the user's LinkedIn contacts by last name.<div class="informalexample"><pre class="programlisting">  var search = Ti.UI.createSearchBar({
    barColor:'#385292', showCancel:true, hintText:'Search'
  });</pre></div></li><li class="listitem">The final UI component added to <code class="literal">Ti.UI.Window</code> is <code class="literal">Ti.UI.TableView</code> that will be<a id="id416" class="indexterm"/> used to display the user's LinkedIn contacts.<div class="informalexample"><pre class="programlisting">  var tableView = Ti.UI.createTableView({
    height:Ti.UI.FILL, width:Ti.UI.FILL, search:search, filterAttribute:'lastName'
  });
  win.add(tableView);</pre></div></li></ol></div></div><div class="section" title="Loading your LinkedIn contacts"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec129"/>Loading your LinkedIn contacts</h3></div></div></div><p>The next snippet <a id="id417" class="indexterm"/>demonstrates how the LinkedIn module can be used to load a list of your contacts as the <code class="literal">Ti.UI.Window</code> window is loaded.</p><div class="informalexample"><pre class="programlisting">  win.addEventListener('open',function(e){</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Use the <code class="literal">uiHelper.createWaitMsg</code> method to display a loading message to the user.<div class="informalexample"><pre class="programlisting">    uiHelpers.createWaitMsg('Loading please wait...');</pre></div></li><li class="listitem">Use the module's <code class="literal">getConnections</code> method to query the user's contacts from the LinkedIn API. In the next example, an inline function is used as a callback returning the user's contacts as the <code class="literal">_e</code> variable.<div class="informalexample"><pre class="programlisting">    my.linkedMod.getConnections(function(_e) {</pre></div></li><li class="listitem">The <code class="literal">uiHelpers.displayContacts</code> method is used to format and apply returned contacts for display.<div class="informalexample"><pre class="programlisting">      uiHelpers.displayContacts(_e);
    });
  });

  win.open();</pre></div></li></ol></div></div><div class="section" title="Using the uiHelpers object to format results"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec130"/>Using the uiHelpers object to format results</h3></div></div></div><p>The <code class="literal">uiHelpers</code> object is<a id="id418" class="indexterm"/> used to format the results of the LinkedIn Contacts API for display.</p><div class="informalexample"><pre class="programlisting">var uiHelpers = {</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">createWaitMsg</code> function is used to display a waiting message in the <code class="literal">tableView</code> while the LinkedIn API is being called.<div class="informalexample"><pre class="programlisting">  createWaitMsg : function(msg){
    tableView.setData([{title:msg}]);
  },</pre></div></li><li class="listitem">The <code class="literal">displayContacts</code> method is the primary method used to convert and display the API results.<div class="informalexample"><pre class="programlisting">  displayContacts : function(apiResults){</pre></div></li><li class="listitem">Update<a id="id419" class="indexterm"/> the <code class="literal">tableView</code> to alert the user that we are now loading their contacts.<div class="informalexample"><pre class="programlisting">    uiHelpers.createWaitMsg('Loading contacts please wait...');</pre></div></li><li class="listitem">The <code class="literal">convertToObject</code> method is called to convert the LinkedIn XML results into more manageable JavaScript objects.<div class="informalexample"><pre class="programlisting">    var resultAsObjects =  my.resultParser.convertToObjects(apiResults);</pre></div></li><li class="listitem">If the conversion result is <code class="literal">null</code>, display an error message to the user.<div class="informalexample"><pre class="programlisting">    if(resultAsObjects == null){
      alert('Sorry we ran into an error');
      return;
    }</pre></div></li><li class="listitem">Using the <code class="literal">formatter.createContactTableRows</code> function, format the JavaScript objects into the <code class="literal">Ti.UI.TableViewRow</code> layout shown earlier in this recipe's screenshots. The <code class="literal">tableView</code> is then updated with the formatted rows.<div class="informalexample"><pre class="programlisting">    tableView.setData(my.formatters.createContactTableRows( resultAsObjects)
    );
  }
};</pre></div></li></ol></div></div><div class="section" title="Parsing the LinkedIn API results"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec131"/>Parsing the LinkedIn API results</h3></div></div></div><p>The <code class="literal">resultParser</code> object <a id="id420" class="indexterm"/>is used to parse the XML provided by the LinkedIn API, <a id="id421" class="indexterm"/>into more manageable JavaScript objects.</p><div class="informalexample"><pre class="programlisting">my.resultParser = {</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">getText</code> function<a id="id422" class="indexterm"/> is used to return a specific key from a provided <code class="literal">Ti.XML.Element</code>. If no key is found, a null value is returned.<div class="informalexample"><pre class="programlisting">  getText : function(item, key) {
    var searchItem = item.getElementsByTagName(key).item(0);
    return ((searchItem == null)? null : searchItem.textContent);
  },</pre></div></li><li class="listitem">The <a id="id423" class="indexterm"/><code class="literal">getQueryParams</code> function<a id="id424" class="indexterm"/> is used to return an object with all query string parameters for a provided URL.<div class="informalexample"><pre class="programlisting">  getQueryParams : function(url){
    var params = {};
    url = url.substring(url.indexOf('?')+1).split('&amp;');
    var pair, d = decodeURIComponent;
    for (var i = url.length - 1; i &gt;= 0; i--) {
      pair = url[i].split('=');
      params[d(pair[0])] = d(pair[1]);
    }
    return params;
  },</pre></div></li><li class="listitem">The <a id="id425" class="indexterm"/><code class="literal">formatUrl</code> function<a id="id426" class="indexterm"/> returns a URL to the contact's profile. If no URL can be determined, a link to <a class="ulink" href="http://linkedin.com">linkedin.com</a> is provided.<div class="informalexample"><pre class="programlisting">  formatUrl : function(findKey){
    return ((findKey.hasOwnProperty("key")) ? ("http://www.linkedin.com/profile/view?id=" + findKey.key) : "http://www.linkedin.com");
  },</pre></div></li><li class="listitem">The <code class="literal">getProfileUrl</code> function<a id="id427" class="indexterm"/> is used to return a URL to the contact's profile. Since the LinkedIn API does not provide this information, a URL is generated by parsing the <code class="literal">site-standard-profile-request</code> node for key details. The construction of this URL is demonstrated in the following snippet:<div class="informalexample"><pre class="programlisting">  getProfileUrl : function(item) {
    var searchItem = item.getElementsByTagName("site-standard-profile-request").item(0);
    if(searchItem == null){
      return null;
    }
    if(searchItem.hasChildNodes()){
      var findKey = my.resultParser.getQueryParams(searchItem.getElementsByTagName('url').item(0).textContent);
      return my.resultParser.formatUrl(findKey);
    }else{
      return null;
    }
  },</pre></div></li><li class="listitem">The <code class="literal">isPublic</code> function<a id="id428" class="indexterm"/><a id="id429" class="indexterm"/> is used to determine if a contact's information is public. If the profile is not public,<a id="id430" class="indexterm"/> we will not add it to the displayed contact list.<div class="informalexample"><pre class="programlisting">  isPublic : function(item){
    return !((my.resultParser.getProfileUrl(item)==null));
  },</pre></div></li><li class="listitem">The <code class="literal">convertToObjects</code><a id="id431" class="indexterm"/> is the primary method responsible for converting the LinkedIn contacts' XML into JavaScript objects.<div class="informalexample"><pre class="programlisting">  convertToObjects : function(xmlString){
    var contacts = [];</pre></div></li><li class="listitem">First, the string of XML provided by the API is loaded into a <code class="literal">Ti.XML.Document</code>.<div class="informalexample"><pre class="programlisting">    var doc = Ti.XML.parseString(xmlString);</pre></div></li><li class="listitem">Retrieve all of the XML nodes under the <code class="literal">person</code> tag.<div class="informalexample"><pre class="programlisting">    var items = doc.documentElement.getElementsByTagName("person");</pre></div></li><li class="listitem">Start looping through each of the nodes under the <code class="literal">person</code> tag.<div class="informalexample"><pre class="programlisting">    for (var i = 0; i &lt; items.length; i++) {</pre></div></li><li class="listitem">Check that the profile is public.<div class="informalexample"><pre class="programlisting">      if(my.resultParser.isPublic(items.item(i))){</pre></div></li><li class="listitem">If the profile is public, create a JavaScript object with properties from the <code class="literal">Ti.XML.Node</code>.<div class="informalexample"><pre class="programlisting">        contacts.push({
          id : my.resultParser.getText(items.item(i), 'id'), headLine : my.resultParser.getText(items.item(i), 'headline'),
          firstName : my.resultParser.getText(items.item(i), 'first-name'),
          lastName : my.resultParser.getText(items.item(i), 'last-name'),
          pictureUrl : my.resultParser.getText(items.item(i), 'picture-url'),
          profileUrl : my.resultParser.getProfileUrl(items.item(i))
        });
      }
    }</pre></div></li><li class="listitem">For individuals with a large number of contacts, this conversion process can be <a id="id432" class="indexterm"/>memory<a id="id433" class="indexterm"/> intensive. To help reduce the size of variables in memory, we set all temporary objects to <code class="literal">null</code> before returning the converted results.<div class="informalexample"><pre class="programlisting">    doc = null, xmlString = null;
    return contacts;
  }
};</pre></div></li></ol></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec68"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">This recipe uses the <code class="literal">clearlyinnovative.linkedIn</code> module created by Aaron Saunders, of <a class="ulink" href="http://clearlyinnovative.com">clearlyinnovative.com</a>. For additional documentation, samples, and guidance with the module, please visit <a class="ulink" href="http://www.clearlyinnovative.com/blog/post/12521419647/titanium-appcelerator-quickie-linkedin-api-integration">http://www.clearlyinnovative.com/blog/post/12521419647/titanium-appcelerator-quickie-linkedin-api-integration</a>. To download the source of the module, please visit the project on Github, at <a class="ulink" href="http://github.com/aaronksaunders/clearlyinnovative.linkedIn">http://github.com/aaronksaunders/clearlyinnovative.linkedIn</a>.</li></ul></div></div></div></body></html>