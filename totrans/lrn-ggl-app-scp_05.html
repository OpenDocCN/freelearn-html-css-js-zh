<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Creating Google Calendar and Drive Applications"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Creating Google Calendar and Drive Applications</h1></div></div></div><p>In the previous chapter, you learned how to create Forms programmatically using <code class="literal">FormApp</code>, <code class="literal">ContentService</code>, and <code class="literal">HtmlService</code>. Also, you learned how to use the <code class="literal">doGet</code> and <code class="literal">doPost</code> functions.</p><p>In this chapter, you will learn to:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Create Calendar events</li><li class="listitem" style="list-style-type: disc">Enable Google's advanced services</li><li class="listitem" style="list-style-type: disc">Create a few Drive applications</li></ul></div><div class="section" title="The CalendarApp class"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec53"/>The CalendarApp class</h1></div></div></div><p>The <code class="literal">CalendarApp</code> class provides direct access to Calendar's basic service. This service allows <a class="indexterm" id="id192"/>you to read and update your default as well as subscribed Calendars. Using GAS, you can create Calendar events, and invite your friends programmatically. You can even grab event details and populate them in Sheets.</p><div class="section" title="Creating Calendar events from a simple description"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec15"/>Creating Calendar events from a simple description</h2></div></div></div><p>You <a class="indexterm" id="id193"/>can create an event by just passing a description as an argument to the <code class="literal">createEventFromDescription</code> method of the <code class="literal">CalendarApp</code> class:</p><div class="informalexample"><pre class="programlisting">function createCalendarEventFromDescription(){
  CalendarApp.getDefaultCalendar()
    .createEventFromDescription('Team Meeting, Monday from 3 PM to 4 PM');
}</pre></div></div><div class="section" title="Creating simple Calendar events"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec16"/>Creating simple Calendar events</h2></div></div></div><p>You<a class="indexterm" id="id194"/> can also create events by specifying the title, start time, and end time:</p><div class="informalexample"><pre class="programlisting">function createCalendarEvents() {
    var title = "Title of the event";
    var startTime = new Date("October 21, 2015 21:00:00");
    var endTime = new Date("October 21, 2015 21:30:00");

    CalendarApp.getDefaultCalendar()
      .createEvent(title, startTime, endTime);
}</pre></div></div><div class="section" title="Creating events with options"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec17"/>Creating events with options</h2></div></div></div><p>The<a class="indexterm" id="id195"/> following code shows how to create an event with the specified options, such as the description and location. Uncomment the <code class="literal">sendInvites</code> line only if you insert the guest's e-mail ID(s). Use a comma to separate them if there is more than one e-mail ID:</p><div class="informalexample"><pre class="programlisting">function createCalendarEventsWithOptions() {
  var options = {
    description : 'Description of the event',
    location : 'Event Location',
    //sendInvites : true,
    //guests : 'Comma-separated list of guest email IDs.'
  };

  var title = "Title of the event";
  var startTime = new Date("October 21, 2015 21:00:00");
  var endTime = new Date("October 21, 2015 21:30:00");

  CalendarApp.getDefaultCalendar()
    .createEvent(title, startTime, endTime, options);
}</pre></div></div><div class="section" title="Creating events from Sheets data"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec18"/>Creating events from Sheets data</h2></div></div></div><p>To <a class="indexterm" id="id196"/>create events from prepopulated Sheets data, create a Sheet named <code class="literal">Events</code> and create column headers as shown here:</p><div class="mediaobject"><img alt="Creating events from Sheets data" src="graphics/B05010_05_01.jpg"/></div><p>Create<a class="indexterm" id="id197"/> the function <code class="literal">createCalendarEventsFromSheetData</code> as shown here:</p><div class="informalexample"><pre class="programlisting">function createCalendarEventsFromSheetData() {
  /*
   * 'Events' sheet column numbers,
   * use 0 for column 'A',
   * 1 for column 'B' and so on.
   * This makes life easy to use in '0' indexed JS arrays.
   *
   */
  const TITLE = 0;
  const START_TIME = 1;
  const END_TIME = 2;
  const DESCRIPTION = 3;
  const LOCATION = 4;
  const SEND_INVITES = 5;
  const GUESTS = 6;

  var sheet = SpreadsheetApp.getActiveSpreadsheet()
              .getSheetByName("Events");

  var data = sheet.getDataRange().getValues();

  // Remove header
  var header = data.shift();

  var options = {
    description : '',
    location : '',
    sendInvites : false,
    guests : ''
  };

  for(var i in data){
    /*
     * 'data' is a 2-dim array.
     * First index for row numbers and
     * second index for column numbers.
     *
     */
    options.description = data[i][DESCRIPTION];
    options.location = data[i][LOCATION];
    options.sendInvites = data[i][SEND_INVITES];
    options.guests = data[i][GUESTS];

    var title = data[i][TITLE];
    var startTime = data[i][START_TIME];
    var endTime = data[i][END_TIME];

    CalendarApp.getDefaultCalendar()
      .createEvent(title, startTime, endTime, options);
  }  
}</pre></div></div><div class="section" title="Creating events from an external CSV file's contents"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec19"/>Creating events from an external CSV file's contents</h2></div></div></div><p>Instead<a class="indexterm" id="id198"/> of creating events from Sheet data, you can create them from an external CSV file uploaded to the Drive. Upload a CSV file with the same headers as in the previous task.</p><p>Get the key/ID of the uploaded file and replace it with the following code:</p><div class="informalexample"><pre class="programlisting">function createEventsFromCsvData(){
  // CSV columns, 0 based.
  const TITLE = 0;
  const START_TIME = 1;
  const END_TIME = 2;
  const DESCRIPTION = 3;
  const LOCATION = 4;
  const SEND_INVITES = 5;
  const GUESTS = 6;

  // Put the key/ID of the CSV file placed in Drive.
  var blob = DriveApp.getFileById("[[ CSV file id ]]").getBlob();
  var str = blob.getDataAsString();

  var data = Utilities.parseCsv(str);
  // Now the data is a two-dimensional array

  // Remove header
  data.shift();

  var options = {
    description : '',
    location : '',
    sendInvites : false,
    guests : ''
  };

  for(var i in data){

    // Skip if no title
    if(!data[i][0]) continue;

    // Populate the options object
    options.description = data[i][DESCRIPTION];
    options.location = data[i][LOCATION];
    options.sendInvites = data[i][SEND_INVITES];
    options.guests = data[i][GUESTS];

    var title = data[i][TITLE];
    var startTime = data[i][START_TIME];
    var endTime = data[i][END_TIME];
    
    CalendarApp.getDefaultCalendar()
      .createEvent(title, startTime, endTime, options);

  }
}</pre></div></div></div></div>
<div class="section" title="Enabling advanced Google services"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec54"/>Enabling advanced Google services</h1></div></div></div><p>Until<a class="indexterm" id="id199"/> now, you have been using GAS's basic services, such as <code class="literal">GmailApp</code> and <code class="literal">ContactsApp</code>. Now it is time to learn how to enable advanced services.</p><p>In this task, we are going to use a Calendar service, which is an advanced service, so we have to enable it before using it.</p><p>In the script editor, click on <span class="strong"><strong>Resources</strong></span>, and then on <span class="strong"><strong>Advanced Google services…</strong></span>, and a pop-up window will open:</p><div class="mediaobject"><img alt="Enabling advanced Google services" src="graphics/B05010_05_02.jpg"/></div><p>In<a class="indexterm" id="id200"/> the <span class="strong"><strong>Advanced Google Services</strong></span> pop-up window, all the GAS advanced services will be listed. Look for the <span class="strong"><strong>Calendar API</strong></span> service, select the latest version (it is selected by default), and then enable it if is not already enabled. In the following screenshot, you can see that the Calendar API service is enabled:</p><div class="mediaobject"><img alt="Enabling advanced Google services" src="graphics/B05010_05_03.jpg"/></div><p>Enabling<a class="indexterm" id="id201"/> advanced services only in scripts is not enough, you also need to enable it in the Google Developers Console, as indicated in the pop-up window. To do so, click on the link provided in the pop-window.</p><p>Then a new browser window or tab will open with popular APIs listed as groups. You can see <span class="strong"><strong>Calendar API</strong></span> under the <span class="strong"><strong>Google Apps APIs</strong></span> group. If not listed, search the word <code class="literal">calendar</code> using the search option provided at the top of the page.</p><div class="mediaobject"><img alt="Enabling advanced Google services" src="graphics/B05010_05_04.jpg"/></div><p>Click<a class="indexterm" id="id202"/> on <span class="strong"><strong>Calendar API</strong></span> (highlighted in yellow in the preceding screenshot), then on the follow-up web page, click on <span class="strong"><strong>Enable API</strong></span>:</p><div class="mediaobject"><img alt="Enabling advanced Google services" src="graphics/B05010_05_05.jpg"/></div><p>That's all; you have enabled Calendar advanced services.</p><div class="section" title="Listing all the Calendars"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec20"/>Listing all the Calendars</h2></div></div></div><p>After <a class="indexterm" id="id203"/>enabling Calendar advanced services, you can use the <code class="literal">listCalendars</code> function to log all of your Calendars:</p><div class="informalexample"><pre class="programlisting">/**
 *  Logs all of your calendars with IDs.
 *
 */
function listCalendars() {
  var calendars, pageToken = null;

  do {
    calendars = Calendar.CalendarList.list({
      maxResults: 100,
      pageToken: pageToken
    });
    
    if (calendars.items &amp;&amp; calendars.items.length &gt; 0) {
      for (var i = 0; i &lt; calendars.items.length; i++) {
        var calendar = calendars.items[i];
        Logger.log('%s (ID: %s)', calendar.summary, calendar.id);
      }
    } else {
      Logger.log('No calendars found.');
    };

    // If more than one page, then return a token, else null.
    pageToken = calendars.nextPageToken;

  } while (pageToken);
}</pre></div><p>The <code class="literal">Calendar.CalendarList.list</code> object returns a list of all the Calendars, provided that the number of Calendars is less than the value of <code class="literal">maxResults</code>. If the number of Calendars is greater than this value, then the <code class="literal">nextPageToken</code> value is used as a page token for the next iteration. A sample output of the log is shown here:</p><div class="mediaobject"><img alt="Listing all the Calendars" src="graphics/B05010_05_06.jpg"/></div></div><div class="section" title="Listing Calendar events in Sheets"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec21"/>Listing Calendar events in Sheets</h2></div></div></div><p>To list <a class="indexterm" id="id204"/>events from any one Calendar into Sheets, create a new Sheet named <code class="literal">ExistingEvents</code> and add the following function:</p><div class="informalexample"><pre class="programlisting">function listEventsFromOneCalendar() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet()
        .getSheetByName("ExistingEvents");

  var source = "Replace with source calendar email id";
  var srcCalId = Calendar.Calendars.get(source).id;

  var syncdays = 30;
  var now = new Date();
  var min = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  var max = new Date(now.getFullYear(), now.getMonth(), now.getDate() + syncdays);

  var srcEvents = Calendar.Events.list(srcCalId, {
    timeMin: min.toISOString(),
    timeMax: max.toISOString(),
    singleEvents: true,
    orderBy: 'startTime',
  }).items;

  /*
   * To store events data in a spreadsheet we need
   * to construct a 2-dim array
   *
   */
  var output = [];

  /*
   * 'srcEvents' is an array of event objects.
   *
   * Every event object is passed as 'e' to the anonymous
   * function.
   *
   */
  srcEvents.forEach(function(e){
    // Construct an event array (1-dim)
    var event = [];

    /*
     * Returns "" if object value is 'null' or 'undefined'
     *   otherwise returns the object value.
     *
     */
    event.push(e.summary || "");
    event.push(e.start.dateTime || "");
    event.push(e.end.dateTime || "");
    event.push(e.description || "");
    event.push(e.location || "");

    // Push each event array to output (2-dim array).
    output.push(event);
  });

  var header = [
                 "Title/Subject",
                 "Start Time",
                 "End Time",
                 "Description",
                 "Location"
               ];

  // Insert header at the top of the output.
  output.unshift(header);

  sheet.clearContents();

  sheet.getRange(1, 1, output.length, header.length)
  .setValues(output);
};</pre></div><p>The function <a class="indexterm" id="id205"/>we just mentioned collects all the events from the Calendar, constructs a 2-dimensional array, and stores that array in the <code class="literal">ExistingEvents</code> sheet. A sample output of the preceding code is shown here:</p><div class="mediaobject"><img alt="Listing Calendar events in Sheets" src="graphics/B05010_05_07.jpg"/></div></div><div class="section" title="Syncing events from one Calendar to another Calendar"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec22"/>Syncing events from one Calendar to another Calendar</h2></div></div></div><p>The <code class="literal">syncEvents</code> function (listed in the following code) syncs the last 30 days events from<a class="indexterm" id="id206"/> the source Calendar to the destination Calendar. To test this application, create the main function <code class="literal">syncEvents</code> and other helper functions such as <code class="literal">updateEvent_</code>, <code class="literal">deleteEvent_</code>, and <code class="literal">insertEvent_</code>. We are marking those events synced from the source to the destination by prefixing <code class="literal">sync:</code> and enclosing an event title/summary in square brackets. For example, if the source event is <code class="literal">Example event</code>, then it will be marked as <code class="literal">[sync:Example event]</code> and inserted/updated in the destination Calendar:</p><div class="informalexample"><pre class="programlisting">/**
 *  Replace Source and Destination with your own Calendars name.
 *
 *  You should have write access in the destination Calendar,
 *  in other words it should have been created by you.
 *
 */
function syncEvents() {
  const RATE_LIMIT = 10; // Milliseconds

  var source = "[[ Source ]]"; // Source calendar email id.
  var destination = "Destination"; // Destination calendar name.

  var srcCalId = Calendar.Calendars.get(source).id;
  
  // Returns calendars (matching with the name) as an array
  var dstCal = CalendarApp
                 .getCalendarsByName(destination)[0];

  var dstCalId = dstCal.getId();

  var syncdays = 30;
  var now = new Date();

  var min = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  var max = new Date(now.getFullYear(), now.getMonth(), now.getDate() + syncdays);

  // Get all source events as an array of objects.
  var srcEvents = Calendar.Events.list(srcCalId, {
    timeMin: min.toISOString(),
    timeMax: max.toISOString(),
    singleEvents: true,
    orderBy: 'startTime',
  }).items;

  // Get all destination events as an array of objects.
  var allDstEvents = Calendar.Events.list(dstCalId, {
    timeMin: min.toISOString(),
    timeMax: max.toISOString(),
    singleEvents: true,
    orderBy: 'startTime',
  }).items;

  /*
   * Get all destination events already synced from source
   * identified with the help of prefix '[sync:'
   *
   */
  var dstEvents = allDstEvents.filter(function(event){
      return /\[sync:\w+/.test(event.summary)?true:false;
  });

  // UPDATE all dstEvents with the corresponding srcEvents.
  for(var d in dstEvents){
    for(var s in srcEvents){

      if(dstEvents[d] &amp;&amp; srcEvents[s] &amp;&amp; dstEvents[d].id == srcEvents[s].id){
        /*
         * Update srcEvents with 'sync:' marking in the * destination calendar.
         *
         */
        srcEvents[s].summary = srcEvents[s].summary||'' + " [sync:"+source+"]";

        updateEvent_(srcEvents[s],dstCalId);

        // Delete updated dstEvents and srcEvents.
        srcEvents.splice(s,1);
        dstEvents.splice(d,1);
        Utilities.sleep(RATE_LIMIT);
      }

    }
  };

  /*
   * DELETE remaining dstEvents (those that do not exist in
   * srcEvents).
   *
   */
  for(var d in dstEvents){
    deleteEvent_(dstEvents[d],dstCalId);
    Utilities.sleep(RATE_LIMIT);
  };

  // INSERT remaining srcEvents (those do not exist in dstEvents).
  for(var s in srcEvents){
    srcEvents[s].summary = srcEvents[s].summary||'' 
+ " [sync:"+source+"]";
    insertEvent_(srcEvents[s],dstCalId);
    Utilities.sleep(RATE_LIMIT);
  }
};</pre></div><p>The <a class="indexterm" id="id207"/>previously mentioned <code class="literal">syncEvents</code> function collects events from the <code class="literal">Source</code> and <code class="literal">Destination</code> events and processes them as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">It updates all the events that appear in both the source and destination (common to both arrays)</li><li class="listitem" style="list-style-type: disc">It deletes all the events that are not present in the source but are present in the destination (that is, they are present in the destination only)</li><li class="listitem" style="list-style-type: disc">It inserts all the events that appear in the source but not in the destination (that is, they are present in the source only)</li></ul></div><p>The helper functions are listed here:</p><div class="informalexample"><pre class="programlisting">function updateEvent_(evt,calId){
  Calendar.Events.update( evt, calId, evt.id );
};


function deleteEvent_(evt,calId){
  Calendar.Events.remove(calId, evt.id);
};


function insertEvent_(evt,calId){
  try{
    Calendar.Events.insert(evt, calId);
  } catch(e) {
    var err = e.message;
    var newEvt = {
      summary:evt.summary,
      start:evt.start,
      end:evt.end,
      attachments:evt.attachments,
      attendees:evt.attendees,
      reminders:evt.reminders
    };

    if(err.search(/identifier already exists/gi) &gt;= 0){
      updateEvent_(evt,calId);
    } else if(err.search(/Not Found/gi) &gt;= 0){
      insertEvent_(newEvt,calId);
    } else if(err.search(/Invalid resource/gi) &gt;= 0){
      insertEvent_(newEvt,calId);
    } else {
      Logger.log("%s [%s]\n",evt,err);
    };
  }
};</pre></div><p>Congratulations! You have created a<a class="indexterm" id="id208"/> working Calendar sync application.</p></div></div>
<div class="section" title="The DriveApp class"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec55"/>The DriveApp class</h1></div></div></div><p>This<a class="indexterm" id="id209"/> class allows you to create, search, and modify files and folders in your Drive.</p><p>For reference <a class="indexterm" id="id210"/>documentation on the <code class="literal">DriveApp</code> class, refer to the website: <a class="ulink" href="https://developers.google.com/apps-script/reference/drive/drive-app?hl=en">https://developers.google.com/apps-script/reference/drive/drive-app?hl=en</a>.</p><div class="section" title="Creating customized PDF files"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec23"/>Creating customized PDF files</h2></div></div></div><p>Imagine <a class="indexterm" id="id211"/>that you need to create customized PDF files from the Sheet or external data. We can create PDF files from the HTML template. You simply need to format column headers and put some sample data in a new Sheet (<code class="literal">AddressBook</code>) as shown in the following screenshot:</p><div class="mediaobject"><img alt="Creating customized PDF files" src="graphics/B05010_05_10.jpg"/></div><p>Create the <code class="literal">createPdfs</code> function in the <code class="literal">Code.gs</code> file as listed here:</p><div class="informalexample"><pre class="programlisting">function createPdfs(){
  
  // 0 based column numbers
  const NAME = 0;
  const TITLE = 1;
  const COMPANY = 2;
  const ADDRESS = 3;
  const CITY = 4;
  const ZIP_PIN = 5;
  
  
  /* Get data from the sheet */
  var sheet = SpreadsheetApp.getActiveSheet();
  var data = sheet.getDataRange().getValues();
  /*
   * Alternatively you can get data * from an external CSV file or anything else.
   * 
   * Example:
   * var blob = DriveApp.getFileById(id).getBlob();
   * var text = blob.getDataAsString();
   * var data = JSON.parse(text);
   *
   */

  // Remove headers
  data.shift();
  
  var folderName = "Letters";
  var folder, folders = DriveApp.getFoldersByName(folderName);
  
  // 'folders' is an iterator
  if (folders.hasNext()){
    // Get first folder if more than 1 with same name.
    folder = folders.next();
  } else {
    // Create folder if it does not exist.
    folder = DriveApp.createFolder(folderName);
  }
  
  for(var i in data){
    /*
     * Set as global variables so that we will be able to access
     * in the Template.html code.
     *
     */
    name = data[i][NAME];
    title = data[i][TITLE];
    company = data[i][COMPANY];
    address = data[i][ADDRESS];
    city = data[i][CITY];
    zip_pin = data[i][ZIP_PIN];

    var html = HtmlService.createTemplateFromFile ("Template.html").evaluate();
    
    // Convert HTML to PDF
    var pdf = html.getAs("application/pdf") 
.setName(name + ".pdf");

    // Save in the 'My Drive | Letter' folder.
    folder.createFile(pdf);
  }
  
}</pre></div><p>The <code class="literal">createPdfs</code> function gets data from a Sheet, or you can modify it to get data from an <a class="indexterm" id="id212"/>external source. It creates an HTML template for each row of data, converts it to a PDF, and stores it in a Drive folder. Let's assign the <code class="literal">name</code>, <code class="literal">title</code>, <code class="literal">company</code>, <code class="literal">address</code>, <code class="literal">city</code>, and <code class="literal">zip_pin</code> variables as global variables. Only then can we get those values in an HTML template.</p><p>Create an HTML file called <code class="literal">Template.html</code> and enter the code listed here:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;body&gt;
    &lt;p&gt;To&lt;/p&gt;
    &lt;p&gt;
      &lt;?= name ?&gt;&lt;br /&gt;
      &lt;?= title ?&gt;&lt;br /&gt;
      &lt;?= company ?&gt;&lt;br /&gt;
      &lt;?= address ?&gt;&lt;br /&gt;
      &lt;?= city ?&gt;&lt;br /&gt;
      &lt;?= zip_pin ?&gt;&lt;br /&gt;
    &lt;/p&gt;
    &lt;p&gt;&amp;nbsp;&lt;/p&gt;
    &lt;p&gt;Dear &lt;?= name ?&gt;,&lt;/p&gt;
    &lt;p&gt;Your message goes here...&lt;/p&gt;
    
    &lt;p&gt;Regards,&lt;br /&gt;[Your name]&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div><p>This code gets the global variable values as we described and returns customized HTML. Update your message and name in the appropriate places. From this HTML template, the <code class="literal">createPdfs</code> function creates PDF files, each of which is customized with individual row data from the Sheet. All the PDF files created are saved in Drive (<code class="literal">My Drive</code> | <code class="literal">Letter</code>) folder.</p><p>The content<a class="indexterm" id="id213"/> of one of the PDF files (<code class="literal">Aaron.pdf</code>) created as per the Sheet data (row 2) is shown in the following screenshot:</p><div class="mediaobject"><img alt="Creating customized PDF files" src="graphics/B05010_05_11.jpg"/></div><p>For a sample, we used this template for a simple letter, but you can use any type of template, such as an invoice, resume, job application, and more, as per your requirements and imagination.</p></div><div class="section" title="Creating a Drive file routing application"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec24"/>Creating a Drive file routing application</h2></div></div></div><p>This<a class="indexterm" id="id214"/> application can move files by matching the name with the criteria terms in the <code class="literal">Settings</code> tab. First of all, create a new Sheet or tab named <code class="literal">Settings</code> and column headings as shown here:</p><div class="mediaobject"><img alt="Creating a Drive file routing application" src="graphics/B05010_05_08.jpg"/></div><p>Also, create the <code class="literal">moveDriveFiles</code> function as shown in the following code snippet. If you<a class="indexterm" id="id215"/> run this function, then it moves files from the root folder to the appropriate folder as per the settings in the <span class="strong"><strong>Settings</strong></span> Sheet. The destination folder is created if it does not already exist. You can also create a trigger to run this function at a predefined time or periodically:</p><div class="informalexample"><pre class="programlisting">function moveDriveFiles(){
  var SheetSettings = SpreadsheetApp.getActiveSpreadsheet()
        .getSheetByName("Settings");

  // Open the root folder.
  var rootFolderName = "Replace with root folder name.";
  var rootFolder, destFolder, folders = DriveApp
        .getFoldersByName(rootFolderName);

  // 'folders' is an iterator
  if (folders.hasNext()) rootFolder = folders.next();
  else {
    // Show warning "Folder does not exist."
    Browser.msgBox(
      "The root folder " + rootFolderName + " not exist."
    );

    return;
  }

  var data = SheetSettings.getDataRange().getValues();
  data.shift();// Remove header row

  for(var i in data){
    var fileName = data[i][0];
    var folderName = data[i][1];

    // Open or create the destination folder
    folders = rootFolder.getFoldersByName(folderName);

    if (folders.hasNext()) destFolder = folders.next();
    else destFolder = rootFolder.createFolder(folderName);

    /*
     * Move matching files to the destination folder
     * The filename should be enclosed in quotes.
     *
     */
    var dest, file, files = rootFolder
          .searchFiles('title contains "' + fileName + '"');
    /*
     * In the above line, the searchFiles method's argument should
     * be a string (SQL-like query), so take care to escape special
     * characters.
     * Here is an alternative way to write the method:
     * searchFiles("title contains \"" + fileName + "\"")
     *
     */

    /*
     * We cannot move files directly,
     * so copy file to the destination and remove in source.
     *
     */
    while (files.hasNext()){
      dest = destFolder;
      file = files.next();

      file.makeCopy(file, dest);
      rootFolder.removeFile(file);
    }
  }
}</pre></div></div><div class="section" title="Creating a Drive file search application"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec25"/>Creating a Drive file search application</h2></div></div></div><p>Now<a class="indexterm" id="id216"/> you are going to create a file search application. It can search files in Drive with certain criteria in a text field. Create the functions <code class="literal">onOpen</code>, <code class="literal">showSidebar</code>, and <code class="literal">listDriveFiles</code> in the <code class="literal">Code.gs</code> file as listed here:</p><div class="informalexample"><pre class="programlisting">function onOpen(){
  SpreadsheetApp.getUi().createAddonMenu()
  .addItem("File Search", "showSidebar")
  .addToUi();
  showSidebar();
}

/**
 * Opens sidebar containing the user interface.
 *
 */
function showSidebar() {
  SpreadsheetApp.getUi().showSidebar(
    HtmlService.createHtmlOutputFromFile('Sidebar')
      .setTitle('Search Files in Drive')
  );
}</pre></div><p>The <code class="literal">onOpen</code> function creates an add-ons menu and calls the <code class="literal">showSidebar</code> function. This means whenever<a class="indexterm" id="id217"/> the spreadsheet is opened, the add-ons menu is added and the sidebar is displayed:</p><div class="informalexample"><pre class="programlisting">/**
 *  Lists files matching with arg 'txt', in the Settings sheet.
 *  
 */
function listDriveFiles(txt){
  // 'Files' sheet column heading.
  var header = ["File", "URL"];

  var output = [header];

  var file, files = DriveApp.searchFiles ('title contains "' + txt + '"');

  // 'files' is an iterator.
  while (files.hasNext()){
    file = files.next();
    var name = file.getName();
    var link = file.getUrl();

    output.push([name,link]);
  };

  var sheet = SpreadsheetApp.getActiveSpreadsheet()
        .getSheetByName("Files");

  sheet.clearContents();

  /*
   * output.length for number of rows and
   * header.length for number of columns
   *
   */
  sheet.getRange(1, 1, output.length, header.length)
    .setValues(output);
}</pre></div><p>Create <a class="indexterm" id="id218"/>a new HTML file named <code class="literal">Sidebar.html</code> and put the following code in it:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;base target="_top"&gt;
    &lt;link rel="stylesheet" href="https://ssl.gstatic.com/docs/script /css/add-ons1.css" /&gt;
    &lt;script src="//ajax.googleapis.com/ajax/libs/jquery/ 1.9.1/jquery.min.js"&gt;
    &lt;/script&gt;

  &lt;/head&gt;

  &lt;body&gt;
    &lt;input type="text" id="txt" /&gt;
    &lt;button class="green" id="btn"&gt;Search&lt;/button&gt;
  &lt;/body&gt;

  &lt;script&gt;
    // On document load, assign click handler to the search
    // button.
    $(function() {
      $('#btn').click(listFiles);
    });

    function listFiles() {
      this.disabled = true;
      $('#error,#success').remove();
      google.script.run
        .withSuccessHandler(function(msg,elm){
           elm.disabled = false;
         })
        .withFailureHandler(function(err,elm){
           elm.disabled = false;
           showError(err,elm);
         })
        .withUserObject(this)
        .listDriveFiles($('#txt').val());
    }

    /**
     * Inserts a div that contains success message after a given 
     * element.
     *
     * @param {string} msg - The message to display.
     * @param {object} element - The element after which to 
     * display the message.
     *
     */
    function showSuccess(msg,element) {
      var div = $('&lt;div id="success"&gt;&lt;font color="green"&gt;' + msg + '&lt;/font&gt;&lt;/div&gt;');
      $(element).after(div);
    }

    /**
     * Inserts a div that contains error message after a given 
     * element.
     *
     * @param {string} msg - The error message to display.
     * @param {object} element - The element after which to 
     *  display the error.
     *
     */
    function showError(msg, element) {
      var div = $('&lt;div id="error" class="error"&gt;' + msg + '&lt;/div&gt;');
      $(element).after(div);
    }

  &lt;/script&gt;
&lt;/html&gt;</pre></div><p>On opening the spreadsheet or running the <code class="literal">showSidebar</code> function, the sidebar opens as shown in the following screenshot, except the text <code class="literal">Chapter</code> in the text field. You can type any other text to search files. On clicking the <span class="strong"><strong>Search</strong></span> button, the script searches the Drive <a class="indexterm" id="id219"/>for those files whose name contains the text and populates data in the <code class="literal">Files</code> Sheet.</p><p>The following screenshot shows the sidebar and sample output:</p><div class="mediaobject"><img alt="Creating a Drive file search application" src="graphics/B05010_05_09.jpg"/></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec56"/>Summary</h1></div></div></div><p>In this chapter, you learned about, and created, many useful real-world applications, including an event sync application. In the next chapter, you will learn how to create RSS/Atom readers and language translator applications.</p></div></body></html>