<html><head></head><body>
<div id="_idContainer019">
<h1 class="chapter-number" id="_idParaDest-72"><a id="_idTextAnchor072"/><span class="koboSpan" id="kobo.1.1">5</span></h1>
<h1 id="_idParaDest-73"><a id="_idTextAnchor073"/><span class="koboSpan" id="kobo.2.1">Deep Dive into Data Loading</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Every application ever created has been driven by data. </span><span class="koboSpan" id="kobo.3.2">Without data to process, an application is effectively useless. </span><span class="koboSpan" id="kobo.3.3">That’s why it’s very important for developers to have a firm understanding of how to manage the retrieval of that data for their application. </span><span class="koboSpan" id="kobo.3.4">When working with SvelteKit, this is done by exporting a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4.1">load()</span></strong><span class="koboSpan" id="kobo.5.1"> function in page or </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">layout files.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">In the previous chapter, we briefly touched on </span><strong class="source-inline"><span class="koboSpan" id="kobo.8.1">load()</span></strong><span class="koboSpan" id="kobo.9.1">. </span><span class="koboSpan" id="kobo.9.2">In this chapter, we’ll analyze it further by discussing how it works and by looking at more practical, real-world examples of making use of it. </span><span class="koboSpan" id="kobo.9.3">We’ll create an example of forcing </span><strong class="source-inline"><span class="koboSpan" id="kobo.10.1">load()</span></strong><span class="koboSpan" id="kobo.11.1"> in the client only as well as covering some key details to remember when using </span><strong class="source-inline"><span class="koboSpan" id="kobo.12.1">load()</span></strong><span class="koboSpan" id="kobo.13.1">. </span><span class="koboSpan" id="kobo.13.2">We’ll also use </span><strong class="source-inline"><span class="koboSpan" id="kobo.14.1">load()</span></strong><span class="koboSpan" id="kobo.15.1"> in layouts to showcase how it can make data portable across our application. </span><span class="koboSpan" id="kobo.15.2">Finally, we’ll look at an example of making use of some of the data provided in a server </span><strong class="source-inline"><span class="koboSpan" id="kobo.16.1">load()</span></strong><span class="koboSpan" id="kobo.17.1"> function that is unavailable in universal </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.18.1">load()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.19.1"> functions.</span></span></p>
<p><span class="koboSpan" id="kobo.20.1">We’re going to cover the following topics in </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.22.1">Loading </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">in Clients</span></span></li>
<li><span class="koboSpan" id="kobo.24.1">Loading </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">in Layouts</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.26.1">Destructuring RequestEvent</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.27.1">By the time you’ve finished this chapter, you’ll be comfortable with all the various ways you can load data in your </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">SvelteKit application.</span></span></p>
<h1 id="_idParaDest-74"><a id="_idTextAnchor074"/><span class="koboSpan" id="kobo.29.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.30.1">The complete code for this chapter is available on GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">at: </span></span><a href="https://github.com/PacktPublishing/SvelteKit-Up-and-Running/tree/main/chapters/chapter05"><span class="No-Break"><span class="koboSpan" id="kobo.32.1">https://github.com/PacktPublishing/SvelteKit-Up-and-Running/tree/main/chapters/chapter05</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.33.1">.</span></span></p>
<h1 id="_idParaDest-75"><a id="_idTextAnchor075"/><span class="koboSpan" id="kobo.34.1">Loading in Clients</span></h1>
<p><span class="koboSpan" id="kobo.35.1">While discussing</span><a id="_idIndexMarker096"/> <em class="italic"><span class="koboSpan" id="kobo.36.1">Creating Server Pages</span></em><span class="koboSpan" id="kobo.37.1"> in the previous chapter, we covered how a </span><strong class="source-inline"><span class="koboSpan" id="kobo.38.1">load()</span></strong><span class="koboSpan" id="kobo.39.1"> function exported from </span><strong class="source-inline"><span class="koboSpan" id="kobo.40.1">+page.js</span></strong><span class="koboSpan" id="kobo.41.1"> will run on both the client and the server. </span><span class="koboSpan" id="kobo.41.2">When we want to ensure load is only run on the server, we move it to </span><strong class="source-inline"><span class="koboSpan" id="kobo.42.1">+page.server.js</span></strong><span class="koboSpan" id="kobo.43.1">. </span><span class="koboSpan" id="kobo.43.2">But what if you’re trying to build an offline-ready application? </span><span class="koboSpan" id="kobo.43.3">You may be </span><a id="_idIndexMarker097"/><span class="koboSpan" id="kobo.44.1">building a </span><strong class="bold"><span class="koboSpan" id="kobo.45.1">Progressive Web App</span></strong><span class="koboSpan" id="kobo.46.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.47.1">PWA</span></strong><span class="koboSpan" id="kobo.48.1">), a </span><strong class="bold"><span class="koboSpan" id="kobo.49.1">Single-Page App</span></strong><span class="koboSpan" id="kobo.50.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.51.1">SPA</span></strong><span class="koboSpan" id="kobo.52.1">), or </span><a id="_idIndexMarker098"/><span class="koboSpan" id="kobo.53.1">both! </span><span class="koboSpan" id="kobo.53.2">For the sake of demonstration, let’s assume you want as much logic as possible to be managed on the client rather than your server. </span><span class="koboSpan" id="kobo.53.3">In this case, you’ll want </span><strong class="source-inline"><span class="koboSpan" id="kobo.54.1">load()</span></strong><span class="koboSpan" id="kobo.55.1"> functions to run on the client and not on the server. </span><span class="koboSpan" id="kobo.55.2">How can we do that when a </span><strong class="source-inline"><span class="koboSpan" id="kobo.56.1">load()</span></strong><span class="koboSpan" id="kobo.57.1"> function from </span><strong class="source-inline"><span class="koboSpan" id="kobo.58.1">+page.js</span></strong><span class="koboSpan" id="kobo.59.1"> runs in </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">both environments?</span></span></p>
<p><span class="koboSpan" id="kobo.61.1">Again, think back to the </span><em class="italic"><span class="koboSpan" id="kobo.62.1">Creating Server Pages</span></em><span class="koboSpan" id="kobo.63.1"> section in the previous chapter where we discussed page options, and you’ll remember the </span><strong class="source-inline"><span class="koboSpan" id="kobo.64.1">ssr</span></strong><span class="koboSpan" id="kobo.65.1"> option. </span><span class="koboSpan" id="kobo.65.2">When exported, this constant will disable or enable </span><strong class="bold"><span class="koboSpan" id="kobo.66.1">Server-Side Rendering</span></strong><span class="koboSpan" id="kobo.67.1"> based on the Boolean value we’ve provided it. </span><span class="koboSpan" id="kobo.67.2">To make a </span><strong class="source-inline"><span class="koboSpan" id="kobo.68.1">load()</span></strong><span class="koboSpan" id="kobo.69.1"> function in </span><strong class="source-inline"><span class="koboSpan" id="kobo.70.1">+page.js</span></strong><span class="koboSpan" id="kobo.71.1"> run only in the client, we can add </span><strong class="source-inline"><span class="koboSpan" id="kobo.72.1">export const ssr = false;</span></strong><span class="koboSpan" id="kobo.73.1">. </span><span class="koboSpan" id="kobo.73.2">Let’s go back to our </span><strong class="source-inline"><span class="koboSpan" id="kobo.74.1">fetch</span></strong><span class="koboSpan" id="kobo.75.1"> example from </span><a href="B19024_03_Final_AM.xhtml#_idTextAnchor051"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.76.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.77.1"> and modify it to </span><span class="No-Break"><span class="koboSpan" id="kobo.78.1">demonstrate this.</span></span></p>
<p><span class="koboSpan" id="kobo.79.1">Before making this adjustment, ensure the </span><strong class="source-inline"><span class="koboSpan" id="kobo.80.1">console.log('got response')</span></strong><span class="koboSpan" id="kobo.81.1"> function still exists. </span><span class="koboSpan" id="kobo.81.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.82.1">/fetch </span></strong><span class="koboSpan" id="kobo.83.1">route in your browser and confirm the output is shown in both the browser console and your development server. </span><span class="koboSpan" id="kobo.83.2">Once you’ve done so, disable SSR on the page by exporting the </span><strong class="source-inline"><span class="koboSpan" id="kobo.84.1">ssr</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.85.1">page option:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.86.1">src/routes/fetch/+page.js</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.87.1">
const key = 'DEMO_KEY'; // your API key here
export const ssr = false;
export function load() {
  const pic = fetch(`https://api.nasa.gov/planetary/apod?api_key=${key}`)
    .then(response =&gt; {
      console.log('got response');
      return response.json();
    });
  return {pic};
}</span></pre>
<p><span class="koboSpan" id="kobo.88.1">This example is identical to when we saw it earlier, except that on line 3, we’ve added </span><strong class="source-inline"><span class="koboSpan" id="kobo.89.1">export const ssr = false;</span></strong><span class="koboSpan" id="kobo.90.1">. </span><span class="koboSpan" id="kobo.90.2">This page option effectively disables SSR for the page, meaning that </span><strong class="source-inline"><span class="koboSpan" id="kobo.91.1">load()</span></strong><span class="koboSpan" id="kobo.92.1"> is only ever run in the client. </span><span class="koboSpan" id="kobo.92.2">You’ll notice the </span><strong class="source-inline"><span class="koboSpan" id="kobo.93.1">console.log()</span></strong><span class="koboSpan" id="kobo.94.1"> call isn’t output to the development server anymore but does show in the </span><span class="No-Break"><span class="koboSpan" id="kobo.95.1">browser console.</span></span></p>
<p><span class="koboSpan" id="kobo.96.1">From </span><a id="_idIndexMarker099"/><span class="koboSpan" id="kobo.97.1">here on out, we’ll differentiate </span><strong class="source-inline"><span class="koboSpan" id="kobo.98.1">load()</span></strong><span class="koboSpan" id="kobo.99.1"> functions as either </span><strong class="bold"><span class="koboSpan" id="kobo.100.1">universal</span></strong><span class="koboSpan" id="kobo.101.1"> or </span><strong class="bold"><span class="koboSpan" id="kobo.102.1">server</span></strong><span class="koboSpan" id="kobo.103.1">. </span><span class="koboSpan" id="kobo.103.2">Obviously, server </span><strong class="source-inline"><span class="koboSpan" id="kobo.104.1">load()</span></strong><span class="koboSpan" id="kobo.105.1"> functions are run on the server in </span><strong class="source-inline"><span class="koboSpan" id="kobo.106.1">+page.server.js</span></strong><span class="koboSpan" id="kobo.107.1">, which means that universal </span><strong class="source-inline"><span class="koboSpan" id="kobo.108.1">load()</span></strong><span class="koboSpan" id="kobo.109.1"> functions are run from </span><strong class="source-inline"><span class="koboSpan" id="kobo.110.1">+page.js</span></strong><span class="koboSpan" id="kobo.111.1">. </span><span class="koboSpan" id="kobo.111.2">At a high level, they are functionally identical. </span><span class="koboSpan" id="kobo.111.3">But there are a few idiosyncrasies </span><span class="No-Break"><span class="koboSpan" id="kobo.112.1">to mention:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.113.1">Both universal and server </span><strong class="source-inline"><span class="koboSpan" id="kobo.114.1">load()</span></strong><span class="koboSpan" id="kobo.115.1"> functions can access data related to the request that </span><span class="No-Break"><span class="koboSpan" id="kobo.116.1">called it.</span></span></li>
<li><span class="koboSpan" id="kobo.117.1">A server </span><strong class="source-inline"><span class="koboSpan" id="kobo.118.1">load()</span></strong><span class="koboSpan" id="kobo.119.1"> function will have access to more request data, such as cookies and the client </span><span class="No-Break"><span class="koboSpan" id="kobo.120.1">IP address.</span></span></li>
<li><span class="koboSpan" id="kobo.121.1">Universal </span><strong class="source-inline"><span class="koboSpan" id="kobo.122.1">load()</span></strong><span class="koboSpan" id="kobo.123.1"> functions always return an object. </span><span class="koboSpan" id="kobo.123.2">The values of that object may be </span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">nearly anything.</span></span></li>
<li><span class="koboSpan" id="kobo.125.1">Server </span><strong class="source-inline"><span class="koboSpan" id="kobo.126.1">load()</span></strong><span class="koboSpan" id="kobo.127.1"> functions </span><em class="italic"><span class="koboSpan" id="kobo.128.1">must</span></em><span class="koboSpan" id="kobo.129.1"> return data that can be serialized by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.130.1">devalue</span></strong><span class="koboSpan" id="kobo.131.1"> package (essentially, anything that can be converted into JSON). </span><span class="koboSpan" id="kobo.131.2">Find out more about </span><strong class="source-inline"><span class="koboSpan" id="kobo.132.1">devalue</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.133.1">at </span></span><a href="https://github.com/rich-harris/devalue"><span class="No-Break"><span class="koboSpan" id="kobo.134.1">https://github.com/rich-harris/devalue</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.135.1">.</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.136.1">Universal Load Timing</span></p>
<p class="callout"><span class="koboSpan" id="kobo.137.1">It should be</span><a id="_idIndexMarker100"/><span class="koboSpan" id="kobo.138.1"> mentioned that on the first render, </span><strong class="source-inline"><span class="koboSpan" id="kobo.139.1">load()</span></strong><span class="koboSpan" id="kobo.140.1"> will execute on the server and client. </span><span class="koboSpan" id="kobo.140.2">Each subsequent request will then be executed in the client only. </span><span class="koboSpan" id="kobo.140.3">To demonstrate this behavior, navigate your browser to a route that has </span><strong class="source-inline"><span class="koboSpan" id="kobo.141.1">load()</span></strong><span class="koboSpan" id="kobo.142.1"> run from a </span><strong class="source-inline"><span class="koboSpan" id="kobo.143.1">+page.js</span></strong><span class="koboSpan" id="kobo.144.1"> file, like our </span><strong class="source-inline"><span class="koboSpan" id="kobo.145.1">/fetch</span></strong><span class="koboSpan" id="kobo.146.1"> example from </span><a href="B19024_03_Final_AM.xhtml#_idTextAnchor051"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.147.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.148.1">. </span><span class="koboSpan" id="kobo.148.2">Observe the console output in the server as well as the client when initially opening the </span><strong class="source-inline"><span class="koboSpan" id="kobo.149.1">/fetch</span></strong><span class="koboSpan" id="kobo.150.1"> page in your browser. </span><span class="koboSpan" id="kobo.150.2">Navigating to another route and back will show the output only in </span><span class="No-Break"><span class="koboSpan" id="kobo.151.1">the client.</span></span></p>
<p><span class="koboSpan" id="kobo.152.1">One final note about calling </span><strong class="source-inline"><span class="koboSpan" id="kobo.153.1">load()</span></strong><span class="koboSpan" id="kobo.154.1">; it will always be invoked at runtime unless you have specified that the page should be prerendered by way of page options. </span><span class="koboSpan" id="kobo.154.2">If you have decided to prerender the page, then </span><strong class="source-inline"><span class="koboSpan" id="kobo.155.1">load()</span></strong><span class="koboSpan" id="kobo.156.1"> will be called at build time. </span><span class="koboSpan" id="kobo.156.2">Remember that pages should only be prerendered if the static HTML shown should be the same for each user to access </span><span class="No-Break"><span class="koboSpan" id="kobo.157.1">the page.</span></span></p>
<p><span class="koboSpan" id="kobo.158.1">We’ve just </span><a id="_idIndexMarker101"/><span class="koboSpan" id="kobo.159.1">covered how </span><strong class="source-inline"><span class="koboSpan" id="kobo.160.1">load()</span></strong><span class="koboSpan" id="kobo.161.1"> can be forced to run only on the client and some details about how it works. </span><span class="koboSpan" id="kobo.161.2">With all of this new information as well as the information from previous chapters, you should feel relatively comfortable about the fundamentals of </span><strong class="source-inline"><span class="koboSpan" id="kobo.162.1">load()</span></strong><span class="koboSpan" id="kobo.163.1">. </span><span class="koboSpan" id="kobo.163.2">Let’s expand on it and take a look at how it might be used in a </span><span class="No-Break"><span class="koboSpan" id="kobo.164.1">layout template.</span></span></p>
<h1 id="_idParaDest-76"><a id="_idTextAnchor076"/><span class="koboSpan" id="kobo.165.1">Loading in Layouts</span></h1>
<p><span class="koboSpan" id="kobo.166.1">So far, we’ve only</span><a id="_idIndexMarker102"/><span class="koboSpan" id="kobo.167.1"> looked at </span><strong class="source-inline"><span class="koboSpan" id="kobo.168.1">load()</span></strong><span class="koboSpan" id="kobo.169.1"> being used in </span><strong class="source-inline"><span class="koboSpan" id="kobo.170.1">+page.js</span></strong><span class="koboSpan" id="kobo.171.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.172.1">+page.server.js</span></strong><span class="koboSpan" id="kobo.173.1"> files, but it can also be utilized in </span><strong class="source-inline"><span class="koboSpan" id="kobo.174.1">+layout.js</span></strong><span class="koboSpan" id="kobo.175.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.176.1">+layout.server.js</span></strong><span class="koboSpan" id="kobo.177.1"> files. </span><span class="koboSpan" id="kobo.177.2">While layouts cannot export actions, they are otherwise functionally identical to page files. </span><span class="koboSpan" id="kobo.177.3">This means that previously mentioned page options (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.178.1">ssr</span></strong><span class="koboSpan" id="kobo.179.1">) and </span><strong class="source-inline"><span class="koboSpan" id="kobo.180.1">load()</span></strong><span class="koboSpan" id="kobo.181.1"> functions will apply to any components nested inside of the layout. </span><span class="koboSpan" id="kobo.181.2">Another important quality to understand about </span><strong class="source-inline"><span class="koboSpan" id="kobo.182.1">load()</span></strong><span class="koboSpan" id="kobo.183.1"> functions is that because they are run concurrently within SvelteKit, a single page will not render until all requests have completed. </span><span class="koboSpan" id="kobo.183.2">Having a </span><strong class="source-inline"><span class="koboSpan" id="kobo.184.1">load()</span></strong><span class="koboSpan" id="kobo.185.1"> function on a page as well as a layout will prevent rendering until both have completed. </span><span class="koboSpan" id="kobo.185.2">But because they will be run simultaneously, any delays should </span><span class="No-Break"><span class="koboSpan" id="kobo.186.1">be negligible.</span></span></p>
<p><span class="koboSpan" id="kobo.187.1">When loading data in a layout, the most obvious advantage of doing so is the ability to access that data in sibling and child pages. </span><span class="koboSpan" id="kobo.187.2">This means that any data loaded by a layout can then be accessed within an inherited </span><strong class="source-inline"><span class="koboSpan" id="kobo.188.1">+page.svelte</span></strong><span class="koboSpan" id="kobo.189.1"> file when it has exported the </span><strong class="source-inline"><span class="koboSpan" id="kobo.190.1">data</span></strong><span class="koboSpan" id="kobo.191.1"> variable. </span><span class="koboSpan" id="kobo.191.2">SvelteKit will also keep track of data loaded across the application and only trigger </span><strong class="source-inline"><span class="koboSpan" id="kobo.192.1">load()</span></strong><span class="koboSpan" id="kobo.193.1"> when it believes it to be absolutely necessary. </span><span class="koboSpan" id="kobo.193.2">In instances where we want to force data to be reloaded, we can import the </span><strong class="source-inline"><span class="koboSpan" id="kobo.194.1">invalidate</span></strong><span class="koboSpan" id="kobo.195.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.196.1">invalidateAll</span></strong><span class="koboSpan" id="kobo.197.1"> modules provided </span><span class="No-Break"><span class="koboSpan" id="kobo.198.1">by </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.199.1">$app/navigation</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.201.1">To demonstrate these concepts, let’s create a component alongside the navigation that can alert the user to unread notifications. </span><span class="koboSpan" id="kobo.201.2">The component will persist across the application header so it may be easily accessed. </span><span class="koboSpan" id="kobo.201.3">This makes for an ideal scenario showcasing loading data from a layout. </span><span class="koboSpan" id="kobo.201.4">We’ll also create another page that shows the full list of notifications to demonstrate how data loaded from a layout can be used in a </span><span class="No-Break"><span class="koboSpan" id="kobo.202.1">child component.</span></span></p>
<p><span class="koboSpan" id="kobo.203.1">Let’s start </span><a id="_idIndexMarker103"/><span class="koboSpan" id="kobo.204.1">with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.205.1">load()</span></strong><span class="koboSpan" id="kobo.206.1"> function in </span><strong class="source-inline"><span class="koboSpan" id="kobo.207.1">+layout.js</span></strong><span class="koboSpan" id="kobo.208.1">. </span><span class="koboSpan" id="kobo.208.2">For simplicity’s sake, we’ll return the data directly within the function call instead of making a call to an imaginary database </span><span class="No-Break"><span class="koboSpan" id="kobo.209.1">or API:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.210.1">src/routes/+layout.js</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.211.1">
export function load() {
  console.log('notifications loaded');
  return {
    notifications: {
      count: 3,
      items: [
        {
          type: `comment`,
          content: `Hi! </span><span class="koboSpan" id="kobo.211.2">I'm Dylan!`
        },
        {
          type: `comment`,
          content: `Hi Dylan. </span><span class="koboSpan" id="kobo.211.3">Nice to meet you!`
        },
        {
          type: `comment`,
          content: `Welcome to the chapter about load()!`
        }
      ]
    },
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.212.1">This file</span><a id="_idIndexMarker104"/><span class="koboSpan" id="kobo.213.1"> consists only of the exported </span><strong class="source-inline"><span class="koboSpan" id="kobo.214.1">load()</span></strong><span class="koboSpan" id="kobo.215.1"> function, which returns an object containing another </span><strong class="source-inline"><span class="koboSpan" id="kobo.216.1">notifications</span></strong><span class="koboSpan" id="kobo.217.1"> object. </span><span class="koboSpan" id="kobo.217.2">Remember that universal </span><strong class="source-inline"><span class="koboSpan" id="kobo.218.1">load()</span></strong><span class="koboSpan" id="kobo.219.1"> functions can export anything so long as it resides inside an object. </span><span class="koboSpan" id="kobo.219.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.220.1">notifications</span></strong><span class="koboSpan" id="kobo.221.1"> object is quite simple as it consists of two properties; a </span><strong class="source-inline"><span class="koboSpan" id="kobo.222.1">count</span></strong><span class="koboSpan" id="kobo.223.1"> property with the value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.224.1">3</span></strong><span class="koboSpan" id="kobo.225.1"> and another property labeled </span><strong class="source-inline"><span class="koboSpan" id="kobo.226.1">items</span></strong><span class="koboSpan" id="kobo.227.1">, which is just an array of three other objects. </span><span class="koboSpan" id="kobo.227.2">To show how the data isn’t loaded every time we navigate to a new page, we’ve included a </span><strong class="source-inline"><span class="koboSpan" id="kobo.228.1">console.log()</span></strong><span class="koboSpan" id="kobo.229.1"> call that outputs the text </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">notifications loaded</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.231.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.232.1">Next, we’ll make some changes to our root layout template so it can actually use our freshly loaded data. </span><span class="koboSpan" id="kobo.232.2">For the most part, it will stay the same, but we’ll need to add some markup that can show the data as well as minimal styling to convey the </span><a id="_idIndexMarker105"/><span class="koboSpan" id="kobo.233.1">concept of a </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.234.1">notification badge</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.235.1">:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.236.1">src/routes/+layout.svelte</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.237.1">
&lt;script&gt;
  import Nav from '$lib/Nav.svelte';
  import Notify from '$lib/Notify.svelte';
  export let data;
&lt;/script&gt;
&lt;div class='wrapper'&gt;
  &lt;div class='nav'&gt;
    &lt;div class='menu'&gt;
      &lt;Nav /&gt;
    &lt;/div&gt;
    &lt;div class='notifications'&gt;
      &lt;Notify count={data.notifications.count}/&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div class='content'&gt;
    &lt;slot&gt;&lt;/slot&gt;
  &lt;/div&gt;
  &lt;div class='footer'&gt;
    This is my footer
  &lt;/div&gt;
&lt;/div&gt;
&lt;style&gt;
  .wrapper {
    min-height: 100vh;
    display: grid;
    grid-template-rows: auto 1fr auto;
  }
  .footer {
    text-align: center;
    margin: 20px 0;
  }
  .nav {
    text-align: center;
  }
  .menu {
    display: inline-block;
  }
  .notifications {
    float: right;
  }
&lt;/style&gt;</span></pre>
<p><span class="koboSpan" id="kobo.238.1">Here are some</span><a id="_idIndexMarker106"/><span class="koboSpan" id="kobo.239.1"> important changes to make note of in this version </span><span class="No-Break"><span class="koboSpan" id="kobo.240.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.241.1">+layout.svelte</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.242.1">:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.243.1">A new </span><strong class="source-inline"><span class="koboSpan" id="kobo.244.1">Notify</span></strong><span class="koboSpan" id="kobo.245.1"> component is imported (</span><span class="No-Break"><span class="koboSpan" id="kobo.246.1">shown next).</span></span></li>
<li><span class="koboSpan" id="kobo.247.1">We exported the </span><strong class="source-inline"><span class="koboSpan" id="kobo.248.1">data</span></strong><span class="koboSpan" id="kobo.249.1"> variable to make use of the data returned </span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.251.1">src/routes/+layout.js</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.252.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.253.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.254.1">notifications</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.255.1">count</span></strong><span class="koboSpan" id="kobo.256.1"> property is sent to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">Notify</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.258.1"> component.</span></span></li>
<li><span class="koboSpan" id="kobo.259.1">The markup for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.260.1">.menu</span></strong><span class="koboSpan" id="kobo.261.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">.notifications</span></strong><span class="koboSpan" id="kobo.263.1"> elements are added to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.264.1">.nav</span></strong><span class="koboSpan" id="kobo.265.1"> div element. </span><span class="koboSpan" id="kobo.265.2">This allows us to show the </span><strong class="source-inline"><span class="koboSpan" id="kobo.266.1">Notify</span></strong><span class="koboSpan" id="kobo.267.1"> component in the top-right corner of </span><span class="No-Break"><span class="koboSpan" id="kobo.268.1">the page.</span></span></li>
<li><span class="koboSpan" id="kobo.269.1">New styles for elements with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.270.1">.nav</span></strong><span class="koboSpan" id="kobo.271.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.272.1">.menu</span></strong><span class="koboSpan" id="kobo.273.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.274.1">.notifications</span></strong><span class="koboSpan" id="kobo.275.1"> classes are added to style our </span><span class="No-Break"><span class="koboSpan" id="kobo.276.1">new markup.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.277.1">Next, let’s look at the </span><strong class="source-inline"><span class="koboSpan" id="kobo.278.1">Notify</span></strong><span class="koboSpan" id="kobo.279.1"> component we just imported. </span><span class="koboSpan" id="kobo.279.2">This component will contain the markup that shows our notification count and links to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.280.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.281.1">notification</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.282.1"> route:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.283.1">src/lib/Notify.svelte</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.284.1">
&lt;script&gt;
  export let count = 0;
&lt;/script&gt;
&lt;a href='/notifications'&gt;
  {count}
&lt;/a&gt;
&lt;style&gt;
  a {
    padding: 15px;
    color: white;
    text-decoration: none;
    background-color: #ea6262;
  }
&lt;/style&gt;</span></pre>
<p><span class="koboSpan" id="kobo.285.1">This</span><a id="_idIndexMarker107"/><span class="koboSpan" id="kobo.286.1"> component is relatively simple. </span><span class="koboSpan" id="kobo.286.2">Firstly, it exports the </span><strong class="source-inline"><span class="koboSpan" id="kobo.287.1">count</span></strong><span class="koboSpan" id="kobo.288.1"> variable and gives it a default value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.289.1">0</span></strong><span class="koboSpan" id="kobo.290.1">. </span><span class="koboSpan" id="kobo.290.2">This is necessary because, while this component is used inside the layout, it does not exist underneath or alongside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.291.1">+layout.js</span></strong><span class="koboSpan" id="kobo.292.1"> file we created earlier and so it does not have access to the information provided by the layout </span><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">load()</span></strong><span class="koboSpan" id="kobo.294.1"> function. </span><span class="koboSpan" id="kobo.294.2">Next, this component creates a link tag to contain the </span><strong class="source-inline"><span class="koboSpan" id="kobo.295.1">count</span></strong><span class="koboSpan" id="kobo.296.1"> variable. </span><span class="koboSpan" id="kobo.296.2">And finally, it contains spartan styling to decorate our </span><span class="No-Break"><span class="koboSpan" id="kobo.297.1">notification badge.</span></span></p>
<p><span class="koboSpan" id="kobo.298.1">Finally, let’s look at the notifications page. </span><span class="koboSpan" id="kobo.298.2">Because this file exists underneath the hierarchy of </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">+layout.js</span></strong><span class="koboSpan" id="kobo.300.1">, we can access </span><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">data</span></strong><span class="koboSpan" id="kobo.302.1"> as if it were loaded from a </span><strong class="source-inline"><span class="koboSpan" id="kobo.303.1">+page.js</span></strong><span class="koboSpan" id="kobo.304.1"> file that existed </span><span class="No-Break"><span class="koboSpan" id="kobo.305.1">alongside it:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.306.1">src/routes/notifications/+page.svelte</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.307.1">
&lt;script&gt;
  export let data;
&lt;/script&gt;
{#if data.notifications.count &gt; 0}
  &lt;ul&gt;
  {#each data.notifications.items as item}
    &lt;li&gt;{item.content}&lt;/li&gt;
  {/each}
  &lt;/ul&gt;
{/if}</span></pre>
<p><span class="koboSpan" id="kobo.308.1">This </span><a id="_idIndexMarker108"/><span class="koboSpan" id="kobo.309.1">page makes use of Svelte directives: </span><strong class="source-inline"><span class="koboSpan" id="kobo.310.1">{#if}</span></strong><span class="koboSpan" id="kobo.311.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.312.1">{#each}</span></strong><span class="koboSpan" id="kobo.313.1">. </span><span class="koboSpan" id="kobo.313.2">Since we exported the </span><strong class="source-inline"><span class="koboSpan" id="kobo.314.1">data</span></strong><span class="koboSpan" id="kobo.315.1"> variable at the top of the component, we can use data loaded from </span><strong class="source-inline"><span class="koboSpan" id="kobo.316.1">src/routes/+layout.js</span></strong><span class="koboSpan" id="kobo.317.1"> within this component. </span><span class="koboSpan" id="kobo.317.2">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.318.1">count</span></strong><span class="koboSpan" id="kobo.319.1"> property of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">notifications</span></strong><span class="koboSpan" id="kobo.321.1"> objects is greater than zero, it will create the markup necessary for an unordered list. </span><span class="koboSpan" id="kobo.321.2">It then outputs the </span><strong class="source-inline"><span class="koboSpan" id="kobo.322.1">content</span></strong><span class="koboSpan" id="kobo.323.1"> property of each comment item inside a </span><span class="No-Break"><span class="koboSpan" id="kobo.324.1">list item.</span></span></p>
<p><span class="koboSpan" id="kobo.325.1">Now, when you open your project in your browser, you should see a new notification badge displayed in the top-right corner of the app showing the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.326.1">count</span></strong><span class="koboSpan" id="kobo.327.1"> property from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">notification</span></strong><span class="koboSpan" id="kobo.329.1"> object. </span><span class="koboSpan" id="kobo.329.2">Try selecting some of the items in the navigation menu and see how the text </span><strong class="bold"><span class="koboSpan" id="kobo.330.1">notifications loaded</span></strong><span class="koboSpan" id="kobo.331.1"> isn’t output every time you click a link. </span><span class="koboSpan" id="kobo.331.2">It is shown on the initial load in both the development server as well as the browser console but not run again. </span><span class="koboSpan" id="kobo.331.3">That is because the data being loaded has yet to change, and SvelteKit </span><span class="No-Break"><span class="koboSpan" id="kobo.332.1">recognizes this.</span></span></p>
<p><span class="koboSpan" id="kobo.333.1">Let’s look at forcing the data to be reloaded when we click on the notification badge. </span><span class="koboSpan" id="kobo.333.2">We can do this by using </span><strong class="source-inline"><span class="koboSpan" id="kobo.334.1">invalidateAll</span></strong><span class="koboSpan" id="kobo.335.1"> imported from </span><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">$app/navigation</span></strong><span class="koboSpan" id="kobo.337.1">. </span><span class="koboSpan" id="kobo.337.2">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">load()</span></strong><span class="koboSpan" id="kobo.339.1"> function used </span><strong class="source-inline"><span class="koboSpan" id="kobo.340.1">fetch()</span></strong><span class="koboSpan" id="kobo.341.1">, it would make sense to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.342.1">invalidate</span></strong><span class="koboSpan" id="kobo.343.1"> module instead. </span><span class="koboSpan" id="kobo.343.2">In that instance, we would force the reload by passing the URL specified inside of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.344.1">fetch()</span></strong><span class="koboSpan" id="kobo.345.1"> call to </span><strong class="source-inline"><span class="koboSpan" id="kobo.346.1">invalidate()</span></strong><span class="koboSpan" id="kobo.347.1">. </span><span class="koboSpan" id="kobo.347.2">Since we’re simply returning an object, we’ll need to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">invalidateAll()</span></strong><span class="koboSpan" id="kobo.349.1"> to trigger </span><span class="No-Break"><span class="koboSpan" id="kobo.350.1">the reload:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.351.1">src/lib/Notify.svelte</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.352.1">
&lt;script&gt;
  import { invalidateAll } from '$app/navigation';
  export let count = 0;
&lt;/script&gt;
&lt;a href='/notifications' on:click={() =&gt; invalidateAll()}&gt;
  {count}
&lt;/a&gt;</span></pre>
<p><span class="koboSpan" id="kobo.353.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.354.1">Notify.svelte</span></strong><span class="koboSpan" id="kobo.355.1"> component, we’ve added the import of </span><strong class="source-inline"><span class="koboSpan" id="kobo.356.1">invalidateAll</span></strong><span class="koboSpan" id="kobo.357.1">. </span><span class="koboSpan" id="kobo.357.2">When the notification link badge is clicked, it calls </span><strong class="source-inline"><span class="koboSpan" id="kobo.358.1">invalidateAll()</span></strong><span class="koboSpan" id="kobo.359.1">, informing SvelteKit to rerun all </span><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">load()</span></strong><span class="koboSpan" id="kobo.361.1"> functions within the context. </span><span class="koboSpan" id="kobo.361.2">Now, when you click the notification link at the top of the page, you should see the browser console output </span><strong class="bold"><span class="koboSpan" id="kobo.362.1">notifications loaded</span></strong><span class="koboSpan" id="kobo.363.1">. </span><span class="koboSpan" id="kobo.363.2">Navigating to other pages such as </span><strong class="bold"><span class="koboSpan" id="kobo.364.1">About</span></strong><span class="koboSpan" id="kobo.365.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.366.1">News</span></strong><span class="koboSpan" id="kobo.367.1">, or </span><strong class="bold"><span class="koboSpan" id="kobo.368.1">Home</span></strong><span class="koboSpan" id="kobo.369.1"> will not produce </span><span class="No-Break"><span class="koboSpan" id="kobo.370.1">the output.</span></span></p>
<p><span class="koboSpan" id="kobo.371.1">In the future, should</span><a id="_idIndexMarker109"/><span class="koboSpan" id="kobo.372.1"> you find yourself building components that will be showing dynamic data across an application’s interface, consider the concepts we’ve just covered. </span><span class="koboSpan" id="kobo.372.2">By loading data in layout files, you can reduce the number of HTTP requests or database queries made, which can significantly improve the experience of the application for your users. </span><span class="koboSpan" id="kobo.372.3">And should you need to force that data to be reloaded, you’ll know how to go about invalidating data so SvelteKit will re-run the appropriate </span><strong class="source-inline"><span class="koboSpan" id="kobo.373.1">load()</span></strong><span class="koboSpan" id="kobo.374.1"> functions. </span><span class="koboSpan" id="kobo.374.2">Next, let’s take a look at how </span><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">load()</span></strong><span class="koboSpan" id="kobo.376.1"> can be leveraged further to build more </span><span class="No-Break"><span class="koboSpan" id="kobo.377.1">advanced functionality.</span></span></p>
<h1 id="_idParaDest-77"><a id="_idTextAnchor077"/><span class="koboSpan" id="kobo.378.1">Destructuring RequestEvent</span></h1>
<p><span class="koboSpan" id="kobo.379.1">When it </span><a id="_idIndexMarker110"/><span class="koboSpan" id="kobo.380.1">comes to </span><strong class="source-inline"><span class="koboSpan" id="kobo.381.1">load()</span></strong><span class="koboSpan" id="kobo.382.1">, the server seems to have more information available to it than the client does. </span><span class="koboSpan" id="kobo.382.2">With so much data, it can be hard to know exactly all the information that is available. </span><span class="koboSpan" id="kobo.382.3">In short, server </span><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">load()</span></strong><span class="koboSpan" id="kobo.384.1"> functions are called with a SvelteKit-specific </span><strong class="source-inline"><span class="koboSpan" id="kobo.385.1">RequestEvent</span></strong><span class="koboSpan" id="kobo.386.1">. </span><span class="koboSpan" id="kobo.386.2">Here’s a quick breakdown of the properties (</span><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">prop</span></strong><span class="koboSpan" id="kobo.388.1">) and functions (</span><strong class="source-inline"><span class="koboSpan" id="kobo.389.1">fn</span></strong><span class="koboSpan" id="kobo.390.1">) available from </span><span class="No-Break"><span class="koboSpan" id="kobo.391.1">that object:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">cookies</span></strong><span class="koboSpan" id="kobo.393.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.394.1">prop</span></strong><span class="koboSpan" id="kobo.395.1">) – The cookies sent during </span><span class="No-Break"><span class="koboSpan" id="kobo.396.1">the request.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.397.1">fetch</span></strong><span class="koboSpan" id="kobo.398.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.399.1">fn</span></strong><span class="koboSpan" id="kobo.400.1">) – A compatible variant of the Web API </span><strong class="source-inline"><span class="koboSpan" id="kobo.401.1">fetch()</span></strong><span class="koboSpan" id="kobo.402.1"> function discussed in </span><a href="B19024_03_Final_AM.xhtml#_idTextAnchor051"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.403.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.404.1">. </span><span class="koboSpan" id="kobo.404.2">It comes with the added benefit of allowing requests based on relative routes as well as passing cookies and headers through when on the </span><span class="No-Break"><span class="koboSpan" id="kobo.405.1">same server.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.406.1">getClientAddress</span></strong><span class="koboSpan" id="kobo.407.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.408.1">fn</span></strong><span class="koboSpan" id="kobo.409.1">) – Returns the client’s </span><span class="No-Break"><span class="koboSpan" id="kobo.410.1">IP address.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.411.1">locals</span></strong><span class="koboSpan" id="kobo.412.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.413.1">prop</span></strong><span class="koboSpan" id="kobo.414.1">) – Any custom data inserted into the request via SvelteKit’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.415.1">handle()</span></strong><span class="koboSpan" id="kobo.416.1"> hook. </span><span class="koboSpan" id="kobo.416.2">We’ll cover that in a </span><span class="No-Break"><span class="koboSpan" id="kobo.417.1">later chapter.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.418.1">params</span></strong><span class="koboSpan" id="kobo.419.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.420.1">prop</span></strong><span class="koboSpan" id="kobo.421.1">) – Parameters specific to the current route, such as the article slug passed to the news example in the </span><span class="No-Break"><span class="koboSpan" id="kobo.422.1">previous chapter.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.423.1">platform</span></strong><span class="koboSpan" id="kobo.424.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.425.1">prop</span></strong><span class="koboSpan" id="kobo.426.1">) – Data added by the </span><span class="No-Break"><span class="koboSpan" id="kobo.427.1">environment adapter.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.428.1">request</span></strong><span class="koboSpan" id="kobo.429.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.430.1">prop</span></strong><span class="koboSpan" id="kobo.431.1">) – The actual request data represented as </span><span class="No-Break"><span class="koboSpan" id="kobo.432.1">an object.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.433.1">route</span></strong><span class="koboSpan" id="kobo.434.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.435.1">prop</span></strong><span class="koboSpan" id="kobo.436.1">) – The identifier of the </span><span class="No-Break"><span class="koboSpan" id="kobo.437.1">requested route.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.438.1">setHeaders</span></strong><span class="koboSpan" id="kobo.439.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.440.1">fn</span></strong><span class="koboSpan" id="kobo.441.1">) – Allows for the manipulation of headers in the returned </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.442.1">Response</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.443.1"> object.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.444.1">url</span></strong><span class="koboSpan" id="kobo.445.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.446.1">prop</span></strong><span class="koboSpan" id="kobo.447.1">) – Data about the requested URL, which we covered in </span><a href="B19024_03_Final_AM.xhtml#_idTextAnchor051"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.448.1">Chapter 3</span></em></span></a><span class="No-Break"><span class="koboSpan" id="kobo.449.1">.</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.450.1">RequestEvent demo</span></p>
<p class="callout"><span class="koboSpan" id="kobo.451.1">To see this information for yourself, create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.452.1">src/routes/+layout.server.js</span></strong><span class="koboSpan" id="kobo.453.1"> file with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.454.1">console.log()</span></strong><span class="koboSpan" id="kobo.455.1"> function outputting a single passed-in argument to </span><strong class="source-inline"><span class="koboSpan" id="kobo.456.1">load()</span></strong><span class="koboSpan" id="kobo.457.1">. </span><span class="koboSpan" id="kobo.457.2">By creating it in the root layout, you’ll be able to see how properties change based on the different routes accessed from your browser. </span><span class="koboSpan" id="kobo.457.3">The data will then be shown in your </span><span class="No-Break"><span class="koboSpan" id="kobo.458.1">development console.</span></span></p>
<p><span class="koboSpan" id="kobo.459.1">A practical </span><a id="_idIndexMarker111"/><span class="koboSpan" id="kobo.460.1">example where you may find yourself needing to utilize this data is in the case of user authentication. </span><span class="koboSpan" id="kobo.460.2">Normally, after a user has authenticated, they are given a cookie (</span><em class="italic"><span class="koboSpan" id="kobo.461.1">for doing such a good job entering their password – pun intended</span></em><span class="koboSpan" id="kobo.462.1">) to store on their device, which ensures their authentication will persist for the duration of their visit. </span><span class="koboSpan" id="kobo.462.2">If they leave the application, it can later be used to confirm their identity so they aren’t required to authenticate yet again. </span><span class="koboSpan" id="kobo.462.3">Let’s observe how this might be accomplished with SvelteKit. </span><span class="koboSpan" id="kobo.462.4">Since this chapter is about </span><strong class="source-inline"><span class="koboSpan" id="kobo.463.1">load()</span></strong><span class="koboSpan" id="kobo.464.1">, we’ll build the actual form and discuss how to set the cookies in the next chapter. </span><span class="koboSpan" id="kobo.464.2">For now, we’ll simply check whether the user has a cookie set and set one manually in </span><span class="No-Break"><span class="koboSpan" id="kobo.465.1">the browser.</span></span></p>
<p><span class="koboSpan" id="kobo.466.1">To begin, let’s rename </span><strong class="source-inline"><span class="koboSpan" id="kobo.467.1">src/routes/+layout.js</span></strong><span class="koboSpan" id="kobo.468.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.469.1">src/routes/+layout.server.js</span></strong><span class="koboSpan" id="kobo.470.1">. </span><span class="koboSpan" id="kobo.470.2">If we’re going to access cookie data, we’ll need access to the data provided by </span><strong class="source-inline"><span class="koboSpan" id="kobo.471.1">RequestEvent</span></strong><span class="koboSpan" id="kobo.472.1">. </span><span class="koboSpan" id="kobo.472.2">By adding the logic to our root server layout, we have the added benefit of keeping the authentication checks in place across the </span><span class="No-Break"><span class="koboSpan" id="kobo.473.1">entire application:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.474.1">src/routes/+layout.server.js</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.475.1">
export function load({ cookies }) {
  const data = {
    notifications: {
      count: 3,
      items: [
        {
          type: `comment`,
          content: `Hi! </span><span class="koboSpan" id="kobo.475.2">I'm Dylan!`
        },
         …
      ]
    }
  };
  if(cookies.get('identity') === '1') {
    // lookup user ID in database
    data.user = {
      id: 1,
      name: 'Dylan'
    }
  }
  return data;
}</span></pre>
<p><span class="koboSpan" id="kobo.476.1">In this new </span><a id="_idIndexMarker112"/><span class="koboSpan" id="kobo.477.1">version of the root layout logic, we’ve destructured the argument passed to </span><strong class="source-inline"><span class="koboSpan" id="kobo.478.1">load()</span></strong><span class="koboSpan" id="kobo.479.1"> since we currently only need access to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.480.1">cookies</span></strong><span class="koboSpan" id="kobo.481.1"> property. </span><span class="koboSpan" id="kobo.481.2">We kept the </span><strong class="source-inline"><span class="koboSpan" id="kobo.482.1">notifications</span></strong><span class="koboSpan" id="kobo.483.1"> object we created earlier but put it inside a new variable called </span><strong class="source-inline"><span class="koboSpan" id="kobo.484.1">data</span></strong><span class="koboSpan" id="kobo.485.1">. </span><span class="koboSpan" id="kobo.485.2">This text also omits a couple of entries for the sake of brevity. </span><span class="koboSpan" id="kobo.485.3">From there, we check whether the request sent to our application contained a cookie by the name of </span><strong class="source-inline"><span class="koboSpan" id="kobo.486.1">user</span></strong><span class="koboSpan" id="kobo.487.1"> with the value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.488.1">1</span></strong><span class="koboSpan" id="kobo.489.1">. </span><span class="koboSpan" id="kobo.489.2">If it did, we insert some fake user information into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.490.1">user</span></strong><span class="koboSpan" id="kobo.491.1"> property of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.492.1">data</span></strong><span class="koboSpan" id="kobo.493.1"> object. </span><span class="koboSpan" id="kobo.493.2">Normally at this point, we would check the cookie value against valid sessions in a database, and if one was found, we would then </span><a id="_idIndexMarker113"/><span class="koboSpan" id="kobo.494.1">retrieve the appropriate user data and send that back to the client, but we’re trying to keep it simple. </span><span class="koboSpan" id="kobo.494.2">After all of that, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.495.1">data</span></strong><span class="koboSpan" id="kobo.496.1"> object is returned </span><span class="No-Break"><span class="koboSpan" id="kobo.497.1">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.498.1">load()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.499.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.500.1">Next, we’ll need to actually show that the user has been successfully authenticated. </span><span class="koboSpan" id="kobo.500.2">To do this, we’ll create a new route where our user can </span><span class="No-Break"><span class="koboSpan" id="kobo.501.1">log in:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.502.1">src/routes/login/+page.svelte</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.503.1">
&lt;script&gt;
  export let data;
&lt;/script&gt;
{#if data.user}
  &lt;p&gt;
    Welcome, {data.user.name}!
</span><span class="koboSpan" id="kobo.503.2">  &lt;/p&gt;
{/if}</span></pre>
<p><span class="koboSpan" id="kobo.504.1">As we covered in the last section, the data returned from </span><strong class="source-inline"><span class="koboSpan" id="kobo.505.1">+layout.js</span></strong><span class="koboSpan" id="kobo.506.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.507.1">+layout.server.js</span></strong><span class="koboSpan" id="kobo.508.1"> is made available in child components by exporting the </span><strong class="source-inline"><span class="koboSpan" id="kobo.509.1">data</span></strong><span class="koboSpan" id="kobo.510.1"> variable. </span><span class="koboSpan" id="kobo.510.2">Once that is done, we use the Svelte </span><strong class="source-inline"><span class="koboSpan" id="kobo.511.1">{#if}</span></strong><span class="koboSpan" id="kobo.512.1"> directive to check whether we have the </span><strong class="source-inline"><span class="koboSpan" id="kobo.513.1">user</span></strong><span class="koboSpan" id="kobo.514.1"> property set. </span><span class="koboSpan" id="kobo.514.2">If found, we then display the </span><strong class="source-inline"><span class="koboSpan" id="kobo.515.1">name</span></strong><span class="koboSpan" id="kobo.516.1"> property </span><span class="No-Break"><span class="koboSpan" id="kobo.517.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.518.1">data.user</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.519.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.520.1">Of course, nowhere in this example do we ever set a cookie. </span><span class="koboSpan" id="kobo.520.2">We’ll cover that in the next chapter so, for now, let’s manually create the cookie in our browser. </span><span class="koboSpan" id="kobo.520.3">Before doing so, navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.521.1">/login</span></strong><span class="koboSpan" id="kobo.522.1"> route and verify that nothing is shown on the page. </span><span class="koboSpan" id="kobo.522.2">Once you have confirmed it is a blank page, go ahead and create the cookie using the following steps for </span><span class="No-Break"><span class="koboSpan" id="kobo.523.1">your</span></span><span class="No-Break"><a id="_idIndexMarker114"/></span><span class="No-Break"><span class="koboSpan" id="kobo.524.1"> browser:</span></span></p>
<ul>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.525.1">Firefox</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.526.1">:</span></span><ol><li><span class="koboSpan" id="kobo.527.1">Open </span><strong class="bold"><span class="koboSpan" id="kobo.528.1">Developer Tools</span></strong><span class="koboSpan" id="kobo.529.1"> by using</span><a id="_idIndexMarker115"/><span class="koboSpan" id="kobo.530.1"> the </span><em class="italic"><span class="koboSpan" id="kobo.531.1">F12</span></em><span class="koboSpan" id="kobo.532.1"> key. </span><span class="koboSpan" id="kobo.532.2">Alternatively, open </span><strong class="bold"><span class="koboSpan" id="kobo.533.1">Menu </span></strong><span class="koboSpan" id="kobo.534.1">|</span><strong class="bold"><span class="koboSpan" id="kobo.535.1"> More Tools | </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.536.1">Developer Tools</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.537.1">.</span></span></li><li><span class="koboSpan" id="kobo.538.1">In </span><strong class="bold"><span class="koboSpan" id="kobo.539.1">Developer Tools</span></strong><span class="koboSpan" id="kobo.540.1">, select the tab </span><span class="No-Break"><span class="koboSpan" id="kobo.541.1">labeled </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.542.1">Storage</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.543.1">.</span></span></li><li><span class="koboSpan" id="kobo.544.1">Under </span><strong class="bold"><span class="koboSpan" id="kobo.545.1">Cookies</span></strong><span class="koboSpan" id="kobo.546.1">, select the project </span><strong class="bold"><span class="koboSpan" id="kobo.547.1">URL</span></strong><span class="koboSpan" id="kobo.548.1">. </span><span class="koboSpan" id="kobo.548.2">Doing so should show all available cookies</span><a id="_idIndexMarker116"/><span class="koboSpan" id="kobo.549.1"> for </span><span class="No-Break"><span class="koboSpan" id="kobo.550.1">the domain.</span></span></li><li><span class="koboSpan" id="kobo.551.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.552.1">+</span></strong><span class="koboSpan" id="kobo.553.1"> symbol to add </span><span class="No-Break"><span class="koboSpan" id="kobo.554.1">an item.</span></span></li><li><span class="koboSpan" id="kobo.555.1">Double-click the </span><strong class="bold"><span class="koboSpan" id="kobo.556.1">name</span></strong><span class="koboSpan" id="kobo.557.1"> field and enter the </span><span class="No-Break"><span class="koboSpan" id="kobo.558.1">text </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.559.1">identity</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.560.1">.</span></span></li><li><span class="koboSpan" id="kobo.561.1">Double-click the </span><strong class="bold"><span class="koboSpan" id="kobo.562.1">value</span></strong><span class="koboSpan" id="kobo.563.1"> field and enter the </span><span class="No-Break"><span class="koboSpan" id="kobo.564.1">text </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.565.1">1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">.</span></span></li><li><span class="koboSpan" id="kobo.567.1">Ensure the </span><strong class="bold"><span class="koboSpan" id="kobo.568.1">path</span></strong><span class="koboSpan" id="kobo.569.1"> field is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.570.1">/</span></strong><span class="koboSpan" id="kobo.571.1"> using the </span><span class="No-Break"><span class="koboSpan" id="kobo.572.1">same steps.</span></span></li></ol></li>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.573.1">Chrome</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.574.1">:</span></span><ol><li value="1"><span class="koboSpan" id="kobo.575.1">Open </span><strong class="bold"><span class="koboSpan" id="kobo.576.1">Developer Tools</span></strong><span class="koboSpan" id="kobo.577.1"> by</span><a id="_idIndexMarker117"/><span class="koboSpan" id="kobo.578.1"> using the </span><em class="italic"><span class="koboSpan" id="kobo.579.1">F12</span></em><span class="koboSpan" id="kobo.580.1"> key. </span><span class="koboSpan" id="kobo.580.2">Alternatively, open </span><a id="_idIndexMarker118"/><span class="koboSpan" id="kobo.581.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.582.1">Menu </span></strong><span class="koboSpan" id="kobo.583.1">|</span><strong class="bold"><span class="koboSpan" id="kobo.584.1"> More Tools </span></strong><span class="koboSpan" id="kobo.585.1">|</span><strong class="bold"> </strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.586.1">Developer Tools</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.587.1">.</span></span></li><li><span class="koboSpan" id="kobo.588.1">In </span><strong class="bold"><span class="koboSpan" id="kobo.589.1">Developer Tools</span></strong><span class="koboSpan" id="kobo.590.1">, select the tab </span><span class="No-Break"><span class="koboSpan" id="kobo.591.1">labeled </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.592.1">Application</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.593.1">.</span></span></li><li><span class="koboSpan" id="kobo.594.1">In</span><a id="_idIndexMarker119"/><span class="koboSpan" id="kobo.595.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.596.1">Storage</span></strong><span class="koboSpan" id="kobo.597.1"> section, select the </span><strong class="bold"><span class="koboSpan" id="kobo.598.1">Cookies</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.599.1">menu item.</span></span></li><li><span class="koboSpan" id="kobo.600.1">Select the </span><span class="No-Break"><span class="koboSpan" id="kobo.601.1">project URL.</span></span></li><li><span class="koboSpan" id="kobo.602.1">In the empty windowpane, select the </span><strong class="bold"><span class="koboSpan" id="kobo.603.1">name</span></strong><span class="koboSpan" id="kobo.604.1"> column and </span><span class="No-Break"><span class="koboSpan" id="kobo.605.1">enter </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.606.1">identity</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.607.1">.</span></span></li><li><span class="koboSpan" id="kobo.608.1">Select the </span><strong class="bold"><span class="koboSpan" id="kobo.609.1">value</span></strong><span class="koboSpan" id="kobo.610.1"> column and </span><span class="No-Break"><span class="koboSpan" id="kobo.611.1">enter </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.612.1">1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.613.1">.</span></span></li><li><span class="koboSpan" id="kobo.614.1">Ensure the </span><strong class="bold"><span class="koboSpan" id="kobo.615.1">path</span></strong><span class="koboSpan" id="kobo.616.1"> field is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.617.1">/</span></strong><span class="koboSpan" id="kobo.618.1"> using the </span><span class="No-Break"><span class="koboSpan" id="kobo.619.1">same steps.</span></span></li></ol></li>
</ul>
<p><span class="koboSpan" id="kobo.620.1">Having</span><a id="_idIndexMarker120"/><span class="koboSpan" id="kobo.621.1"> followed these steps, you should now have the correct cookie in your browser. </span><span class="koboSpan" id="kobo.621.2">After doing so, refresh the </span><strong class="source-inline"><span class="koboSpan" id="kobo.622.1">/login</span></strong><span class="koboSpan" id="kobo.623.1"> page in your browser and you’ll see a message welcoming the user with the value from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.624.1">name</span></strong><span class="koboSpan" id="kobo.625.1"> property specified. </span><span class="koboSpan" id="kobo.625.2">This example is quite simple and actual cookie-based login systems are functionally slightly more complicated; however, the concepts remain </span><span class="No-Break"><span class="koboSpan" id="kobo.626.1">the same.</span></span></p>
<p><span class="koboSpan" id="kobo.627.1">While the example we covered only made use of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.628.1">cookies</span></strong><span class="koboSpan" id="kobo.629.1"> property from </span><strong class="source-inline"><span class="koboSpan" id="kobo.630.1">RequestEvent</span></strong><span class="koboSpan" id="kobo.631.1">, we saw how trivial it would be to access any of the other properties such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.632.1">url</span></strong><span class="koboSpan" id="kobo.633.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.634.1">params</span></strong><span class="koboSpan" id="kobo.635.1">, or even to set our own headers with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.636.1">setHeaders</span></strong><span class="koboSpan" id="kobo.637.1"> function. </span><span class="koboSpan" id="kobo.637.2">With all of that data </span><a id="_idIndexMarker121"/><span class="koboSpan" id="kobo.638.1">available to us, the possibilities of what could be built into our application are </span><span class="No-Break"><span class="koboSpan" id="kobo.639.1">nearly limitless.</span></span></p>
<h1 id="_idParaDest-78"><a id="_idTextAnchor078"/><span class="koboSpan" id="kobo.640.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.641.1">In this chapter, we covered a lot of information about </span><strong class="source-inline"><span class="koboSpan" id="kobo.642.1">load()</span></strong><span class="koboSpan" id="kobo.643.1">. </span><span class="koboSpan" id="kobo.643.2">We first discussed how it can be done only in the client and then moved on to some finer details about how it works. </span><span class="koboSpan" id="kobo.643.3">After that, we looked at using </span><strong class="source-inline"><span class="koboSpan" id="kobo.644.1">load()</span></strong><span class="koboSpan" id="kobo.645.1"> in layouts to minimize the number of requests made for each page load and maximize convenient access to data that may be needed application-wide. </span><span class="koboSpan" id="kobo.645.2">We also looked at invalidating data in cases where we would want data to be reloaded. </span><span class="koboSpan" id="kobo.645.3">Finally, we covered how server </span><strong class="source-inline"><span class="koboSpan" id="kobo.646.1">load()</span></strong><span class="koboSpan" id="kobo.647.1"> functions are called by </span><strong class="source-inline"><span class="koboSpan" id="kobo.648.1">RequestEvent</span></strong><span class="koboSpan" id="kobo.649.1">, which gives us access to so much more valuable information. </span><span class="koboSpan" id="kobo.649.2">That information can enable us to build cookie-based login functionality for </span><span class="No-Break"><span class="koboSpan" id="kobo.650.1">our application.</span></span></p>
<p><span class="koboSpan" id="kobo.651.1">Having spent this chapter learning about some of the finer details behind </span><strong class="source-inline"><span class="koboSpan" id="kobo.652.1">load()</span></strong><span class="koboSpan" id="kobo.653.1">, you should feel comfortable taking a load off and relaxing. </span><span class="koboSpan" id="kobo.653.2">If you have any baked cookies to hand, I suggest you take a break from the book and treat yourself to some. </span><span class="koboSpan" id="kobo.653.3">You’ve </span><span class="No-Break"><span class="koboSpan" id="kobo.654.1">earned it.</span></span></p>
<p><span class="koboSpan" id="kobo.655.1">But do come back because, in the next chapter, we’ll cover more of the finer details behind receiving data from users through the use of forms, making the forms fun, and reducing the friction of data entry by </span><span class="No-Break"><span class="koboSpan" id="kobo.656.1">utilizing snapshots.</span></span></p>
<h1 id="_idParaDest-79"><a id="_idTextAnchor079"/><span class="koboSpan" id="kobo.657.1">Resources</span></h1>
<p><span class="No-Break"><span class="koboSpan" id="kobo.658.1">devalue: </span></span><a href="https://github.com/rich-harris/devalue"><span class="No-Break"><span class="koboSpan" id="kobo.659.1">https://github.com/rich-harris/devalue</span></span></a></p>
</div>
</body></html>