- en: Chapter 6. Light Speed Unit Testing
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In [Chapter 4](ch04.html "Chapter 4. Asynchronous Testing – AJAX"), *Asynchronous
    Testing – AJAX*, we saw how including AJAX testing in the application can increase
    the complexity of the tests. In the example in that chapter, we created a server
    where the results were predictable. It was basically a complex test fixture. Even
    though we could have used a real server implementation, it would increase the
    complexity of the test even more; try changing the state of a server with a database
    or third-party services from the browser—it is not an easy or scalable solution.
  prefs: []
  type: TYPE_NORMAL
- en: There is also the impact on productivity; these requests take time to process
    and transmit, which hurts the quick feedback loop that unit testing usually provides.
  prefs: []
  type: TYPE_NORMAL
- en: You can also say that these specs test both the client and the server code and,
    therefore, could not be considered unit tests; rather, they could be considered
    integration tests.
  prefs: []
  type: TYPE_NORMAL
- en: A solution to all these problems is to use either **stubs** or **fakes** in
    place of the real dependencies of the code. So, instead of making a request to
    the server, we use a test double of the server inside the browser.
  prefs: []
  type: TYPE_NORMAL
- en: We are going to use the same example from [Chapter 4](ch04.html "Chapter 4. Asynchronous
    Testing – AJAX"), *Asynchronous Testing – AJAX*, and rewrite it using different
    techniques.
  prefs: []
  type: TYPE_NORMAL
- en: Jasmine stubs
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: We have already seen some use cases for Jasmine spies. Remember that a spy is
    a special function that records how it was called. You can think of a stub as
    a spy with behavior.
  prefs: []
  type: TYPE_NORMAL
- en: We use stubs whenever we want to force a specific path in our specs or replace
    a real implementation for a simpler one.
  prefs: []
  type: TYPE_NORMAL
- en: Let's revisit the example of the acceptance criteria, "Stock when fetched, should
    update its share price", by rewriting it using Jasmine stubs.
  prefs: []
  type: TYPE_NORMAL
- en: 'We know that the stock''s `fetch` function is implemented using the `$.getJSON`
    function, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'We could use the `spyOn` function to set up a spy on the `getJSON` function
    with the following code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'But this time, we will use the `and.callFake` function to set a behavior to
    our spy (by default, a spy does nothing and returns undefined). We make the spy
    invoke its `callback` parameter with an object response (`{ sharePrice: 20.18
    }`).'
  prefs: []
  type: TYPE_NORMAL
- en: Later, at the expectation, we use the `toEqual` assertion to verify that the
    stock's `sharePrice` has changed.
  prefs: []
  type: TYPE_NORMAL
- en: To run this spec, you no longer need a server to make the requests to, which
    is a good thing, but there is one issue with this approach. If the fetch function
    gets refactored to use `$.ajax` instead of `$.getJSON`, then the test will fail.
    A better solution, provided by a Jasmine plugin called **jasmine-ajax**, is to
    stub the browser's AJAX infrastructure instead, so the implementation of the AJAX
    request is free to be done in different manners.
  prefs: []
  type: TYPE_NORMAL
- en: Jasmine Ajax
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Jasmine Ajax is an official plugin developed to help out the testing of AJAX
    requests. It changes the browser's AJAX request infrastructure to a fake implementation.
  prefs: []
  type: TYPE_NORMAL
- en: This fake (or mocked) implementation, although simpler, still behaves like the
    real implementation to any code using its API.
  prefs: []
  type: TYPE_NORMAL
- en: Installing the plugin
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Before we dig into the spec implementation, first we need to add the plugin
    to the project. Go to [https://github.com/jasmine/jasmine-ajax/](https://github.com/jasmine/jasmine-ajax/)
    and download the current release (which should be compatible with the Jasmine
    2.x release). Place it inside the `lib` folder.
  prefs: []
  type: TYPE_NORMAL
- en: 'It is also needed to be added to the `SpecRunner.html` file, so go ahead and
    add another script:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: A fake XMLHttpRequest
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Whenever you are using jQuery to make AJAX requests, under the hood it is actually
    using the `XMLHttpRequest` object to perform the request.
  prefs: []
  type: TYPE_NORMAL
- en: '`XMLHttpRequest` is the standard JavaScript HTTP API. Even though its name
    suggests that it uses XML, it supports other types of content such as JSON; the
    name has remained the same for compatibility reasons.'
  prefs: []
  type: TYPE_NORMAL
- en: So, instead of stubbing jQuery, we could change the `XMLHttpRequest` object
    with a fake implementation. That is exactly what this plugin does.
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s rewrite the previous spec to use this fake implementation:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'Drilling the implementation down:'
  prefs: []
  type: TYPE_NORMAL
- en: First, we tell the plugin to replace the original implementation of the `XMLHttpRequest`
    object by a fake implementation using the `jasmine.Ajax.install` function.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We then invoke the `stock.fetch` function, which will invoke `$.getJSON`, creating
    `XMLHttpRequest` anew under the hood.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: And finally, we use the `jasmine.Ajax.requests.mostRecent().respondWith` function
    to get the most recently made request and respond to it with a fake response.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'We use the `respondWith` function, which accepts an object with three properties:'
  prefs: []
  type: TYPE_NORMAL
- en: The `status` property to define the HTTP status code.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The `contentType` (JSON in the example) property.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The `responseText` property, which is a text string containing the response
    body for the request.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Then, it''s all a matter of running the expectations:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: 'Since the plugin changes the global `XMLHttpRequest` object, you must remember
    to tell Jasmine to restore it to its original implementation after the test runs;
    otherwise, you could interfere with the code from other specs (such as the Jasmine
    jQuery fixtures module). Here''s how you can accomplish this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: There is also a slightly different approach to write this spec; here, the request
    is first stubbed (with the response details) and the code to be exercised is executed
    later.
  prefs: []
  type: TYPE_NORMAL
- en: 'The previous example is changed to the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'It is possible to use the `jasmine.Ajax.stubRequest` function to stub any request
    to a specific request. In the example, it is defined by the URL `http://localhost:8000/stocks/AOUE`,
    and the response definition is as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: The response definition follows the same properties as the previously used `respondWith`
    function.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, you learned how asynchronous tests can hurt the quick feedback
    loop you can get with unit testing. I showed how you can use either stubs or fakes
    to make your specs run quicker and with fewer dependencies.
  prefs: []
  type: TYPE_NORMAL
- en: We have seen two different ways in which you could test AJAX requests with a
    simple Jasmine stub and with the more advanced, fake implementation of the `XMLHttpRequest`.
  prefs: []
  type: TYPE_NORMAL
- en: You also got more familiar with spies and stubs and should be more comfortable
    using them in different scenarios.
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we are going to go further into the complexity of our application,
    and we will do an overall refactoring to transform it into a fully featured single-page
    application using the `React.js` library.
  prefs: []
  type: TYPE_NORMAL
