<html><head></head><body>
<div id="_idContainer027">
<h1 class="chapter-number" id="_idParaDest-116"><a id="_idTextAnchor116"/><span class="koboSpan" id="kobo.1.1">9</span></h1>
<h1 id="_idParaDest-117"><a id="_idTextAnchor117"/><span class="koboSpan" id="kobo.2.1">Hooks and Error Handling</span></h1>
<p><span class="koboSpan" id="kobo.3.1">While it can be incredibly useful to make API requests from any page, imagine the nuisance of attempting to authenticate a user for an external API on </span><em class="italic"><span class="koboSpan" id="kobo.4.1">every</span></em><span class="koboSpan" id="kobo.5.1"> page. </span><span class="koboSpan" id="kobo.5.2">It may be possible to create a custom helper that adds specific headers or cookies to every single request to assist with this. </span><span class="koboSpan" id="kobo.5.3">Fortunately for us, SvelteKit provides methods to manipulate Request and Response objects across the entirety of a framework. </span><span class="koboSpan" id="kobo.5.4">It does so with what are called </span><strong class="bold"><span class="koboSpan" id="kobo.6.1">hooks</span></strong><span class="koboSpan" id="kobo.7.1">. </span><span class="koboSpan" id="kobo.7.2">These</span><a id="_idIndexMarker192"/><span class="koboSpan" id="kobo.8.1"> hooks can be incredibly powerful to manage data that flows in and out of our application. </span><span class="koboSpan" id="kobo.8.2">They can also be helpful for managing errors. </span><span class="koboSpan" id="kobo.8.3">Since our previous encounters with error handling have been so brief, we’ll examine error handling a little closer after </span><span class="No-Break"><span class="koboSpan" id="kobo.9.1">covering hooks.</span></span></p>
<p><span class="koboSpan" id="kobo.10.1">In this chapter, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.11.1">following topics:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.12.1">Using Hooks</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.13.1">Error Handling</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.14.1">As a practical example, we’ll build a simple interface allowing us to </span><em class="italic"><span class="koboSpan" id="kobo.15.1">star</span></em><span class="koboSpan" id="kobo.16.1"> the official SvelteKit repository on GitHub. </span><span class="koboSpan" id="kobo.16.2">You’ll have to authenticate your personal account, but if you don’t have an account on GitHub, fear not, as the concepts will be easy enough to follow along with. </span><span class="koboSpan" id="kobo.16.3">By the end of the exercise, we’ll have covered the hooks available to use within SvelteKit, as well as how they can be leveraged to assist in </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">managing errors.</span></span></p>
<h1 id="_idParaDest-118"><a id="_idTextAnchor118"/><span class="koboSpan" id="kobo.18.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.19.1">The complete code for this chapter is available on GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">at: </span></span><a href="https://github.com/PacktPublishing/SvelteKit-Up-and-Running/tree/main/chapters/chapter09"><span class="No-Break"><span class="koboSpan" id="kobo.21.1">https://github.com/PacktPublishing/SvelteKit-Up-and-Running/tree/main/chapters/chapter09</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.22.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.23.1">An account on GitHub is necessary to build the </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">example: </span></span><a href="https://github.com/signup"><span class="No-Break"><span class="koboSpan" id="kobo.25.1">https://github.com/signup</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.26.1">.</span></span></p>
<h1 id="_idParaDest-119"><a id="_idTextAnchor119"/><span class="koboSpan" id="kobo.27.1">Using Hooks</span></h1>
<p><span class="koboSpan" id="kobo.28.1">Unlike other</span><a id="_idIndexMarker193"/><span class="koboSpan" id="kobo.29.1"> JS frameworks that shall not be named, SvelteKit keeps the list of hooks to remember short and simple. </span><span class="koboSpan" id="kobo.29.2">At the time of writing, there are only two types of hooks – </span><strong class="bold"><span class="koboSpan" id="kobo.30.1">server hooks</span></strong><span class="koboSpan" id="kobo.31.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.32.1">shared hooks</span></strong><span class="koboSpan" id="kobo.33.1">. </span><span class="koboSpan" id="kobo.33.2">As we have come to expect from names, they work similarly to how </span><strong class="source-inline"><span class="koboSpan" id="kobo.34.1">+page.server.js</span></strong><span class="koboSpan" id="kobo.35.1"> runs only on the server and </span><strong class="source-inline"><span class="koboSpan" id="kobo.36.1">+page.js</span></strong><span class="koboSpan" id="kobo.37.1"> runs on either the server or the client. </span><span class="koboSpan" id="kobo.37.2">Both server and shared hooks are placed in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.38.1">src/</span></strong><span class="koboSpan" id="kobo.39.1"> directory, either in </span><strong class="source-inline"><span class="koboSpan" id="kobo.40.1">src/hooks.server.js</span></strong><span class="koboSpan" id="kobo.41.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.42.1">src/hooks.client.js</span></strong><span class="koboSpan" id="kobo.43.1">, depending on which environment we intend to run the hook on. </span><span class="koboSpan" id="kobo.43.2">We’ll break this section down into the </span><span class="No-Break"><span class="koboSpan" id="kobo.44.1">following subsections:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.45.1">Server hooks</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.46.1">Shared hooks</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.47.1">By the end of this section, you’ll be able to modify all incoming and outgoing requests to your </span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">SvelteKit applications.</span></span></p>
<h2 id="_idParaDest-120"><a id="_idTextAnchor120"/><span class="koboSpan" id="kobo.49.1">Server hooks</span></h2>
<p><span class="koboSpan" id="kobo.50.1">The hooks </span><a id="_idIndexMarker194"/><span class="koboSpan" id="kobo.51.1">that can only be run on the server are </span><strong class="source-inline"><span class="koboSpan" id="kobo.52.1">handleFetch()</span></strong><span class="koboSpan" id="kobo.53.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.54.1">handle()</span></strong><span class="koboSpan" id="kobo.55.1">. </span><span class="koboSpan" id="kobo.55.2">As we would expect, </span><strong class="source-inline"><span class="koboSpan" id="kobo.56.1">handleFetch()</span></strong><span class="koboSpan" id="kobo.57.1"> has the ability to </span><a id="_idIndexMarker195"/><span class="koboSpan" id="kobo.58.1">manipulate requests made by SvelteKit’s included </span><strong class="source-inline"><span class="koboSpan" id="kobo.59.1">fetch()</span></strong><span class="koboSpan" id="kobo.60.1"> method, which can be called within </span><strong class="source-inline"><span class="koboSpan" id="kobo.61.1">load()</span></strong><span class="koboSpan" id="kobo.62.1"> or through actions. </span><span class="koboSpan" id="kobo.62.2">The other hook, </span><strong class="source-inline"><span class="koboSpan" id="kobo.63.1">handle()</span></strong><span class="koboSpan" id="kobo.64.1">; can manipulate data as SvelteKit’s router receives requests. </span><span class="koboSpan" id="kobo.64.2">One way to think of this is that </span><strong class="source-inline"><span class="koboSpan" id="kobo.65.1">handleFetch()</span></strong><span class="koboSpan" id="kobo.66.1"> manipulates the data </span><em class="italic"><span class="koboSpan" id="kobo.67.1">leaving</span></em><span class="koboSpan" id="kobo.68.1"> an app and </span><strong class="source-inline"><span class="koboSpan" id="kobo.69.1">handle()</span></strong><span class="koboSpan" id="kobo.70.1"> manipulates data </span><em class="italic"><span class="koboSpan" id="kobo.71.1">coming into</span></em><span class="koboSpan" id="kobo.72.1"> it. </span><span class="koboSpan" id="kobo.72.2">As server hooks, both can be added </span><span class="No-Break"><span class="koboSpan" id="kobo.73.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.74.1">src/hooks.server.js</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.75.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.76.1">To begin this chapter’s example to demonstrate how useful hooks can be, let’s set up a few things. </span><span class="koboSpan" id="kobo.76.2">Firstly, we’ll need a way to authenticate our personal account with GitHub. </span><span class="koboSpan" id="kobo.76.3">The manner in which we will achieve this is by</span><a id="_idIndexMarker196"/><span class="koboSpan" id="kobo.77.1"> sending a </span><strong class="bold"><span class="koboSpan" id="kobo.78.1">personal access token</span></strong><span class="koboSpan" id="kobo.79.1"> to the appropriate GitHub API endpoints. </span><span class="koboSpan" id="kobo.79.2">Once generated, this token can be added to the HTTP request headers. </span><span class="koboSpan" id="kobo.79.3">It’s very important to treat tokens just as we treat passwords, so we’ll import this token securely through environment variables, which will be discussed further in a </span><span class="No-Break"><span class="koboSpan" id="kobo.80.1">later chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.81.1">To generate your token, visit </span><a href="https://github.com"><span class="koboSpan" id="kobo.82.1">https://github.com</span></a><span class="koboSpan" id="kobo.83.1"> and sign in. </span><span class="koboSpan" id="kobo.83.2">You can then navigate to your profile settings by clicking your profile image in the top-right corner and selecting </span><strong class="bold"><span class="koboSpan" id="kobo.84.1">Settings</span></strong><span class="koboSpan" id="kobo.85.1">. </span><span class="koboSpan" id="kobo.85.2">From there, scroll to the very bottom of the settings navigation pane and click </span><strong class="bold"><span class="koboSpan" id="kobo.86.1">Developer Settings</span></strong><span class="koboSpan" id="kobo.87.1">. </span><span class="koboSpan" id="kobo.87.2">We’ll then locate </span><strong class="bold"><span class="koboSpan" id="kobo.88.1">Personal access tokens</span></strong><span class="koboSpan" id="kobo.89.1"> and generate a </span><em class="italic"><span class="koboSpan" id="kobo.90.1">classic token</span></em><span class="koboSpan" id="kobo.91.1">. </span><span class="koboSpan" id="kobo.91.2">Give the token a name, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.92.1">SvelteKit star repo</span></strong><span class="koboSpan" id="kobo.93.1">, an expiration date, and the full </span><em class="italic"><span class="koboSpan" id="kobo.94.1">repo</span></em><span class="koboSpan" id="kobo.95.1"> scope. </span><span class="koboSpan" id="kobo.95.2">Once done, click </span><strong class="bold"><span class="koboSpan" id="kobo.96.1">Generate Token</span></strong><span class="koboSpan" id="kobo.97.1"> and copy the </span><span class="No-Break"><span class="koboSpan" id="kobo.98.1">value provided.</span></span></p>
<p><span class="koboSpan" id="kobo.99.1">We can </span><a id="_idIndexMarker197"/><span class="koboSpan" id="kobo.100.1">then open our SvelteKit project and, in the root folder </span><a id="_idIndexMarker198"/><span class="koboSpan" id="kobo.101.1">of the project, create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.102.1">.env</span></strong><span class="koboSpan" id="kobo.103.1"> file. </span><span class="koboSpan" id="kobo.103.2">In this file, we’ll add our token, </span><span class="No-Break"><span class="koboSpan" id="kobo.104.1">like so:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.105.1">.env</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.106.1">
GITHUB=YOUR_GITHUB_TOKEN_HERE</span></pre>
<p><span class="koboSpan" id="kobo.107.1">You can then save and close the file. </span><span class="koboSpan" id="kobo.107.2">We’ll go into more details on how how to manage secrets in a later chapter, but for now, just know that we’ve given our token a name using which we can import it into </span><span class="No-Break"><span class="koboSpan" id="kobo.108.1">our code.</span></span></p>
<p><span class="koboSpan" id="kobo.109.1">Next, let’s create a new route and add it </span><span class="No-Break"><span class="koboSpan" id="kobo.110.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.111.1">Nav.svelte</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.112.1">:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.113.1">src/lib/Nav.svelte</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.114.1">
&lt;nav&gt;
  &lt;ul&gt;
    &lt;li&gt;&lt;a href='/'&gt;Home&lt;/a&gt;&lt;/li&gt;
    ...
</span><span class="koboSpan" id="kobo.114.2">    &lt;li&gt;&lt;a href='/github'&gt;GitHub&lt;/a&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;</span></pre>
<p><span class="koboSpan" id="kobo.115.1">Again, this is a simple addition where we add markup for a link to our ever-growing list of links. </span><span class="koboSpan" id="kobo.115.2">Once we have added the markup for our new route to the navigation, we’ll create the appropriate </span><strong class="source-inline"><span class="koboSpan" id="kobo.116.1">+page.svelte</span></strong><span class="koboSpan" id="kobo.117.1"> file to render the route. </span><span class="koboSpan" id="kobo.117.2">This page will consist of a simple form, with buttons allowing us to </span><em class="italic"><span class="koboSpan" id="kobo.118.1">star</span></em><span class="koboSpan" id="kobo.119.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.120.1">unstar</span></em><span class="koboSpan" id="kobo.121.1"> the SvelteKit repository on GitHub, as well as some text showing just how many stars the repository </span><span class="No-Break"><span class="koboSpan" id="kobo.122.1">currently has:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.123.1">src/routes/(app)/github/+page.svelte</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.124.1">
&lt;script&gt;
  import { enhance } from '$app/forms';
  import { invalidate } from '$app/navigation';
  export let data;
  export let form;
  const reload = () =&gt; {
    invalidate('https://api.github.com/repos/');
  };
&lt;/script&gt;
{#if form &amp;&amp; form.message }
  {form.status}
  {form.message}
{/if}
&lt;p&gt;
  Stargazers on the official SvelteKit repo: {data.repo.stargazers_count}
&lt;/p&gt;
&lt;form method='POST' use:enhance&gt;
  &lt;button formaction='?/star' on:click={reload}&gt;Star&lt;/button&gt;
  &lt;button formaction='?/unstar' on:click={reload}&gt;Unstar&lt;/button&gt;
&lt;/form&gt;</span></pre>
<p><span class="koboSpan" id="kobo.125.1">There is </span><a id="_idIndexMarker199"/><span class="koboSpan" id="kobo.126.1">quite</span><a id="_idIndexMarker200"/><span class="koboSpan" id="kobo.127.1"> a lot going on here, but it’s nothing we haven’t seen yet. </span><span class="koboSpan" id="kobo.127.2">Starting at the end of the file, we can see that this page contains a </span><strong class="source-inline"><span class="koboSpan" id="kobo.128.1">&lt;form&gt;</span></strong><span class="koboSpan" id="kobo.129.1"> element consisting of two buttons. </span><span class="koboSpan" id="kobo.129.2">One button calls to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.130.1">/github?/star</span></strong><span class="koboSpan" id="kobo.131.1"> action and the other to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.132.1">/github?/unstar</span></strong><span class="koboSpan" id="kobo.133.1"> action. </span><span class="koboSpan" id="kobo.133.2">The form uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.134.1">enhance</span></strong><span class="koboSpan" id="kobo.135.1"> module, meaning requests are made in the background and do not trigger a page reload. </span><span class="koboSpan" id="kobo.135.2">Each button inside the form calls the function expression assigned to the constant </span><strong class="source-inline"><span class="koboSpan" id="kobo.136.1">reload</span></strong><span class="koboSpan" id="kobo.137.1">. </span><span class="koboSpan" id="kobo.137.2">That anonymous function utilizes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.138.1">invalidate</span></strong><span class="koboSpan" id="kobo.139.1"> module, which then forces any </span><strong class="source-inline"><span class="koboSpan" id="kobo.140.1">load()</span></strong><span class="koboSpan" id="kobo.141.1"> functions with </span><strong class="source-inline"><span class="koboSpan" id="kobo.142.1">fetch()</span></strong><span class="koboSpan" id="kobo.143.1"> methods calling the specified URL to be rerun. </span><span class="koboSpan" id="kobo.143.2">This is helpful, as the paragraph tag showing how many stars the repository has will then be updated </span><a id="_idIndexMarker201"/><span class="koboSpan" id="kobo.144.1">accordingly. </span><span class="koboSpan" id="kobo.144.2">The final portion of code to </span><a id="_idIndexMarker202"/><span class="koboSpan" id="kobo.145.1">make note of is the Svelte </span><strong class="source-inline"><span class="koboSpan" id="kobo.146.1">{#if}</span></strong><span class="koboSpan" id="kobo.147.1"> directive, which will alert us to the status of </span><span class="No-Break"><span class="koboSpan" id="kobo.148.1">the request.</span></span></p>
<p><span class="koboSpan" id="kobo.149.1">Once we have saved </span><strong class="source-inline"><span class="koboSpan" id="kobo.150.1">+page.svelte</span></strong><span class="koboSpan" id="kobo.151.1">, we’ll need to move on to our </span><strong class="source-inline"><span class="koboSpan" id="kobo.152.1">+page.server.js</span></strong><span class="koboSpan" id="kobo.153.1">, as it will contain the bulk of our logic. </span><span class="koboSpan" id="kobo.153.2">Importantly, it won’t contain any of the code related to authentication, as all of that will reside in </span><span class="No-Break"><span class="koboSpan" id="kobo.154.1">the hook:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.155.1">src/routes/(app)/github/+page.server.js</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.156.1">
const star_url = 'https://api.github.com/user/starred/sveltejs/kit';
export function load({ fetch }) {
  const repo = fetch( 'https://api.github.com/repos/sveltejs/kit' )
    .then( response =&gt; response.json() );
  return { repo };
}
export const actions = {
  star: async({ fetch }) =&gt; {
    const response = fetch(star_url, {
      method: 'PUT',
      headers: {
        'Content-Length': '0',
      }
    })
    .then(response =&gt; {
      const status = response.status;
      return {
        status: status,
        message: (status === 204 ? </span><span class="koboSpan" id="kobo.156.2">'Success!' </span><span class="koboSpan" id="kobo.156.3">: 'Error')
      }
    });
    return response;
  },
  unstar: async({ fetch }) =&gt; {
    const response = fetch(star_url, {
      method: 'DELETE'
    })
    .then(response =&gt; {
      const status = response.status;
      return {
        status: status,
        message: (status === 204 ? </span><span class="koboSpan" id="kobo.156.4">'Success!' </span><span class="koboSpan" id="kobo.156.5">: 'Error')
      }
    });
    return response;
  },
}</span></pre>
<p><span class="koboSpan" id="kobo.157.1">There is a</span><a id="_idIndexMarker203"/><span class="koboSpan" id="kobo.158.1"> lot </span><a id="_idIndexMarker204"/><span class="koboSpan" id="kobo.159.1">going on here, but again, it’s nothing we haven’t seen before. </span><span class="koboSpan" id="kobo.159.2">The very first line declares a constant </span><strong class="source-inline"><span class="koboSpan" id="kobo.160.1">star_url</span></strong><span class="koboSpan" id="kobo.161.1"> that can be referenced in our </span><strong class="source-inline"><span class="koboSpan" id="kobo.162.1">fetch()</span></strong><span class="koboSpan" id="kobo.163.1"> requests later on. </span><span class="koboSpan" id="kobo.163.2">This is the endpoint we will reach out to alert GitHub that we want to </span><em class="italic"><span class="koboSpan" id="kobo.164.1">star</span></em><span class="koboSpan" id="kobo.165.1"> or </span><em class="italic"><span class="koboSpan" id="kobo.166.1">unstar</span></em><span class="koboSpan" id="kobo.167.1"> the repository. </span><span class="koboSpan" id="kobo.167.2">The very next chunk of code creates a familiar </span><strong class="source-inline"><span class="koboSpan" id="kobo.168.1">load()</span></strong><span class="koboSpan" id="kobo.169.1"> function. </span><span class="koboSpan" id="kobo.169.2">This endpoint does not actually require authentication and will return general information about the </span><span class="No-Break"><span class="koboSpan" id="kobo.170.1">specified repository.</span></span></p>
<p><span class="koboSpan" id="kobo.171.1">From there, we</span><a id="_idIndexMarker205"/><span class="koboSpan" id="kobo.172.1"> can examine the two actions we’ve created – </span><em class="italic"><span class="koboSpan" id="kobo.173.1">star</span></em><span class="koboSpan" id="kobo.174.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.175.1">unstar</span></em><span class="koboSpan" id="kobo.176.1">. </span><span class="koboSpan" id="kobo.176.2">Both of these destructure the </span><strong class="bold"><span class="koboSpan" id="kobo.177.1">RequestEvent</span></strong><span class="koboSpan" id="kobo.178.1"> object </span><a id="_idIndexMarker206"/><span class="koboSpan" id="kobo.179.1">by retrieving the </span><strong class="source-inline"><span class="koboSpan" id="kobo.180.1">fetch()</span></strong><span class="koboSpan" id="kobo.181.1"> method bundled with SvelteKit. </span><span class="koboSpan" id="kobo.181.2">Both then use </span><strong class="source-inline"><span class="koboSpan" id="kobo.182.1">fetch()</span></strong><span class="koboSpan" id="kobo.183.1"> to make a request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.184.1">star_url</span></strong><span class="koboSpan" id="kobo.185.1"> endpoint but differ in the type of HTTP method they utilize, as per the GitHub API specifications. </span><span class="koboSpan" id="kobo.185.2">We’ve also added an extra header to the </span><em class="italic"><span class="koboSpan" id="kobo.186.1">star</span></em><span class="koboSpan" id="kobo.187.1"> request, as the official GitHub API documentation dictates that </span><strong class="source-inline"><span class="koboSpan" id="kobo.188.1">Content-Body</span></strong><span class="koboSpan" id="kobo.189.1"> should be set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.190.1">0</span></strong><span class="koboSpan" id="kobo.191.1"> for this particular request. </span><span class="koboSpan" id="kobo.191.2">Both actions then return an object consisting of the request status and a message alerting us as to whether the request went through successfully, or whether an error </span><span class="No-Break"><span class="koboSpan" id="kobo.192.1">was received.</span></span></p>
<p><span class="koboSpan" id="kobo.193.1">At this</span><a id="_idIndexMarker207"/><span class="koboSpan" id="kobo.194.1"> point, we could navigate to </span><strong class="source-inline"><span class="koboSpan" id="kobo.195.1">http://localhost/github</span></strong><span class="koboSpan" id="kobo.196.1"> in our browser and view the number of stars on the official SvelteKit repository. </span><span class="koboSpan" id="kobo.196.2">However, attempting to star it will result in an error, as we won’t have the appropriate permissions with the GitHub API. </span><span class="koboSpan" id="kobo.196.3">To authenticate, we’ll need to provide our access token in the headers of our network requests. </span><span class="koboSpan" id="kobo.196.4">While we could do this in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.197.1">+page.server.js</span></strong><span class="koboSpan" id="kobo.198.1"> file inside each of the actions, it would quickly become a hassle if we decided to build more routes that also required authentication with GitHub. </span><span class="koboSpan" id="kobo.198.2">For instance, what if we wanted to build functionality allowing us to read and react to comments on issues? </span><span class="koboSpan" id="kobo.198.3">Instead, we can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.199.1">handleFetch()</span></strong><span class="koboSpan" id="kobo.200.1"> to catch all outgoing </span><strong class="source-inline"><span class="koboSpan" id="kobo.201.1">fetch()</span></strong><span class="koboSpan" id="kobo.202.1"> requests before they leave our application and authenticate in a single location. </span><span class="koboSpan" id="kobo.202.2">To do so, we’ll need to </span><span class="No-Break"><span class="koboSpan" id="kobo.203.1">create </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.204.1">src/hooks.server.js</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.206.1">src/hooks.server.js</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.207.1">
import { GITHUB } from '$env/static/private';
export async function handleFetch( { request, fetch  } ) {
  if (request.url.startsWith('https://api.github.com/')) {
    request.headers.set('Accept', 'application/vnd.github+json');
    request.headers.set('Authorization', 'Bearer ' + GITHUB);
    request.headers.set('X-GitHub-Api-Version', '2022-11-28');
  }
  return fetch(request);
}</span></pre>
<p><span class="koboSpan" id="kobo.208.1">We begin</span><a id="_idIndexMarker208"/><span class="koboSpan" id="kobo.209.1"> by importing the personal access token we created earlier. </span><span class="koboSpan" id="kobo.209.2">Again, we’ll </span><a id="_idIndexMarker209"/><span class="koboSpan" id="kobo.210.1">examine how this works in a later chapter, so for now, just acknowledge that we’ve imported the token saved to </span><strong class="source-inline"><span class="koboSpan" id="kobo.211.1">.env</span></strong><span class="koboSpan" id="kobo.212.1">. </span><span class="koboSpan" id="kobo.212.2">We then create the function definition for </span><strong class="source-inline"><span class="koboSpan" id="kobo.213.1">handleFetch()</span></strong><span class="koboSpan" id="kobo.214.1">. </span><span class="koboSpan" id="kobo.214.2">Fetch is an asynchronous API, so we need to specify that this function will also be </span><strong class="source-inline"><span class="koboSpan" id="kobo.215.1">async</span></strong><span class="koboSpan" id="kobo.216.1">. </span><span class="koboSpan" id="kobo.216.2">We’ve then destructured the </span><strong class="source-inline"><span class="koboSpan" id="kobo.217.1">RequestEvent</span></strong><span class="koboSpan" id="kobo.218.1"> object to extract </span><strong class="source-inline"><span class="koboSpan" id="kobo.219.1">request</span></strong><span class="koboSpan" id="kobo.220.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">fetch</span></strong><span class="koboSpan" id="kobo.222.1">. </span><span class="koboSpan" id="kobo.222.2">Within the hook, we check to see whether the requested URL is </span><a href="https://api.github.com/"><span class="koboSpan" id="kobo.223.1">https://api.github.com/</span></a><span class="koboSpan" id="kobo.224.1">. </span><span class="koboSpan" id="kobo.224.2">If it is, we’ll then set the necessary </span><strong class="source-inline"><span class="koboSpan" id="kobo.225.1">Accept</span></strong><span class="koboSpan" id="kobo.226.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.227.1">Authorization</span></strong><span class="koboSpan" id="kobo.228.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.229.1">X-GitHub-Api-Version</span></strong><span class="koboSpan" id="kobo.230.1"> headers. </span><span class="koboSpan" id="kobo.230.2">While </span><strong class="source-inline"><span class="koboSpan" id="kobo.231.1">Accept</span></strong><span class="koboSpan" id="kobo.232.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.233.1">X-GitHub-Api-Version</span></strong><span class="koboSpan" id="kobo.234.1"> are simple predetermined strings, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.235.1">Authorization</span></strong><span class="koboSpan" id="kobo.236.1"> header value is the concatenated string </span><em class="italic"><span class="koboSpan" id="kobo.237.1">bearer</span></em><span class="koboSpan" id="kobo.238.1">, as well as the imported personal </span><span class="No-Break"><span class="koboSpan" id="kobo.239.1">access token.</span></span></p>
<p><span class="koboSpan" id="kobo.240.1">We can now open </span><strong class="source-inline"><span class="koboSpan" id="kobo.241.1">http://localhost/github</span></strong><span class="koboSpan" id="kobo.242.1"> in our browser and click the </span><em class="italic"><span class="koboSpan" id="kobo.243.1">star</span></em><span class="koboSpan" id="kobo.244.1"> button. </span><span class="koboSpan" id="kobo.244.2">Because we’ve used </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">invalidate()</span></strong><span class="koboSpan" id="kobo.246.1"> on the GitHub API URL, we should then observe the count increasing by one. </span><span class="koboSpan" id="kobo.246.2">The developers of SvelteKit have certainly earned our star, but if you’re uncomfortable with this simple act of charity, try clicking the </span><em class="italic"><span class="koboSpan" id="kobo.247.1">unstar</span></em><span class="koboSpan" id="kobo.248.1"> button and observing the </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">change again.</span></span></p>
<p><span class="koboSpan" id="kobo.250.1">It’s important to note that </span><strong class="source-inline"><span class="koboSpan" id="kobo.251.1">handleFetch()</span></strong><span class="koboSpan" id="kobo.252.1"> will only hook into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.253.1">fetch()</span></strong><span class="koboSpan" id="kobo.254.1"> function provided by SvelteKit and not a standard </span><strong class="source-inline"><span class="koboSpan" id="kobo.255.1">fetch()</span></strong><span class="koboSpan" id="kobo.256.1">. </span><span class="koboSpan" id="kobo.256.2">This can be observed by removing the destructured </span><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">fetch</span></strong><span class="koboSpan" id="kobo.258.1"> parameter from the </span><em class="italic"><span class="koboSpan" id="kobo.259.1">star</span></em><span class="koboSpan" id="kobo.260.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.261.1">unstar</span></em><span class="koboSpan" id="kobo.262.1"> actions in </span><strong class="source-inline"><span class="koboSpan" id="kobo.263.1">src/routes/(app)/github/+page.server.js</span></strong><span class="koboSpan" id="kobo.264.1">. </span><span class="koboSpan" id="kobo.264.2">Then, attempting to star the repository will return an </span><em class="italic"><span class="koboSpan" id="kobo.265.1">unauthorized</span></em><span class="koboSpan" id="kobo.266.1"> error from the GitHub API, as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">handleFetch()</span></strong><span class="koboSpan" id="kobo.268.1"> hook is not called unless we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.269.1">fetch()</span></strong><span class="koboSpan" id="kobo.270.1"> method provided with SvelteKit. </span><span class="koboSpan" id="kobo.270.2">This can also be observed by removing the destructured </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">fetch</span></strong><span class="koboSpan" id="kobo.272.1"> from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">load()</span></strong><span class="koboSpan" id="kobo.274.1"> function in </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">+page.server.js</span></strong><span class="koboSpan" id="kobo.276.1">. </span><span class="koboSpan" id="kobo.276.2">Provided you have not exceeded GitHub’s rate limits, the standard </span><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">fetch()</span></strong><span class="koboSpan" id="kobo.278.1"> function will continue providing data because the endpoint called to does not require authentication. </span><span class="koboSpan" id="kobo.278.2">Because of this, it is strongly encouraged to use SvelteKit’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.279.1">fetch()</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.280.1">whenever possible.</span></span></p>
<p><span class="koboSpan" id="kobo.281.1">As we can see, being able to manipulate requests leaving our application is quite powerful, but what about the requests coming into our platform? </span><span class="koboSpan" id="kobo.281.2">For that, we need to leverage </span><strong class="source-inline"><span class="koboSpan" id="kobo.282.1">handle()</span></strong><span class="koboSpan" id="kobo.283.1">. </span><span class="koboSpan" id="kobo.283.2">For this example, we’ll demonstrate it by adding the </span><strong class="source-inline"><span class="koboSpan" id="kobo.284.1">handle()</span></strong><span class="koboSpan" id="kobo.285.1"> hook </span><span class="No-Break"><span class="koboSpan" id="kobo.286.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.287.1">src/hooks.server.js</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.288.1">:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.289.1">src/hooks.server.js</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.290.1">
import { GITHUB } from '$env/static/private';
export async function handleFetch( { request, fetch  } ) {
  if (request.url.startsWith('https://api.github.com/')) {
    request.headers.set('Accept', 'application/vnd.github+json');
    request.headers.set('Authorization', 'Bearer ' + GITHUB);
    request.headers.set('X-GitHub-Api-Version', '2022-11-28');
  }
  return fetch(request);
}
export async function handle({ event, resolve }) {
  event.setHeaders({'X-NOT-FROM-GITHUB': 'our value'});
  const response = await resolve(event);
  response.headers.set('X-ANOTHER-HEADER', 'something else');
  return response;
}</span></pre>
<p><span class="koboSpan" id="kobo.291.1">In this </span><a id="_idIndexMarker210"/><span class="koboSpan" id="kobo.292.1">version, we’ve added the </span><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">handle()</span></strong><span class="koboSpan" id="kobo.294.1"> function definition to the end of the file. </span><span class="koboSpan" id="kobo.294.2">This function accepts a </span><strong class="source-inline"><span class="koboSpan" id="kobo.295.1">RequestEvent</span></strong><span class="koboSpan" id="kobo.296.1"> object as well as a </span><strong class="source-inline"><span class="koboSpan" id="kobo.297.1">resolve()</span></strong><span class="koboSpan" id="kobo.298.1"> function. </span><span class="koboSpan" id="kobo.298.2">In </span><a id="_idIndexMarker211"/><span class="koboSpan" id="kobo.299.1">our version, we’ve added a custom header that will be added to all requests within our application. </span><span class="koboSpan" id="kobo.299.2">That header is </span><strong class="source-inline"><span class="koboSpan" id="kobo.300.1">X-NOT-FROM-GITHUB</span></strong><span class="koboSpan" id="kobo.301.1"> and will contain the value </span><em class="italic"><span class="koboSpan" id="kobo.302.1">our value</span></em><span class="koboSpan" id="kobo.303.1">. </span><span class="koboSpan" id="kobo.303.2">Once the header has been added to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.304.1">event</span></strong><span class="koboSpan" id="kobo.305.1"> object, we complete the request by passing the event to </span><strong class="source-inline"><span class="koboSpan" id="kobo.306.1">resolve()</span></strong><span class="koboSpan" id="kobo.307.1"> and returning the promise. </span><span class="koboSpan" id="kobo.307.2">We’ve also added another method to demonstrate how you might go about modifying the headers after the request is made with </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">resolve()</span></strong><span class="koboSpan" id="kobo.309.1">. </span><span class="koboSpan" id="kobo.309.2">These headers can be observed by opening the browser on any page within our application, opening </span><strong class="bold"><span class="koboSpan" id="kobo.310.1">Developer Tools</span></strong><span class="koboSpan" id="kobo.311.1">, navigating to the </span><strong class="bold"><span class="koboSpan" id="kobo.312.1">Network</span></strong><span class="koboSpan" id="kobo.313.1"> tab, and refreshing the page. </span><span class="koboSpan" id="kobo.313.2">Opening the very first request will show our custom headers and values in </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.314.1">Response Headers</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.315.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.316.1">Of course, we’re not </span><a id="_idIndexMarker212"/><span class="koboSpan" id="kobo.317.1">limited to setting only headers. </span><span class="koboSpan" id="kobo.317.2">Headers were chosen simply for demonstration purposes. </span><span class="koboSpan" id="kobo.317.3">We can also set data that will be made available to us in </span><strong class="source-inline"><span class="koboSpan" id="kobo.318.1">load()</span></strong><span class="koboSpan" id="kobo.319.1"> and server pages by setting </span><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">event.locals</span></strong><span class="koboSpan" id="kobo.321.1"> to the object of our choosing. </span><span class="koboSpan" id="kobo.321.2">We can even utilize </span><strong class="source-inline"><span class="koboSpan" id="kobo.322.1">event.cookies</span></strong><span class="koboSpan" id="kobo.323.1"> to modify cookie values. </span><span class="koboSpan" id="kobo.323.2">However, if we use SvelteKit’s included </span><strong class="source-inline"><span class="koboSpan" id="kobo.324.1">fetch()</span></strong><span class="koboSpan" id="kobo.325.1"> method, those cookies will automatically be passed within the application, so long as it lives at a domain that has permission to access the cookies. </span><span class="koboSpan" id="kobo.325.2">One final note to make is that both </span><strong class="source-inline"><span class="koboSpan" id="kobo.326.1">handle()</span></strong><span class="koboSpan" id="kobo.327.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">handleFetch()</span></strong><span class="koboSpan" id="kobo.329.1"> will run either on render or during the prerendering process. </span><span class="koboSpan" id="kobo.329.2">This is particularly important to remember if you’re attempting to generate a static site </span><span class="No-Break"><span class="koboSpan" id="kobo.330.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.331.1">adapter-static</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.332.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.333.1">As we just </span><a id="_idIndexMarker213"/><span class="koboSpan" id="kobo.334.1">demonstrated, server hooks can be a powerful tool to leverage when you need to customize request and response headers. </span><span class="koboSpan" id="kobo.334.2">While modifying header data is only one use case for them, the example we provided should highlight the many possible solutions they can address. </span><span class="koboSpan" id="kobo.334.3">Next, let’s take a look at the hooks available to us on the client as well as </span><span class="No-Break"><span class="koboSpan" id="kobo.335.1">the server.</span></span></p>
<h2 id="_idParaDest-121"><a id="_idTextAnchor121"/><span class="koboSpan" id="kobo.336.1">Shared hooks</span></h2>
<p><span class="koboSpan" id="kobo.337.1">Having just</span><a id="_idIndexMarker214"/><span class="koboSpan" id="kobo.338.1"> covered </span><a id="_idIndexMarker215"/><span class="koboSpan" id="kobo.339.1">the two hooks available in server environments, we now only have </span><strong class="source-inline"><span class="koboSpan" id="kobo.340.1">handleError()</span></strong><span class="koboSpan" id="kobo.341.1"> available to us in client environments. </span><span class="koboSpan" id="kobo.341.2">This hook is useful for capturing errors that weren’t thrown through the use of SvelteKit’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.342.1">error</span></strong><span class="koboSpan" id="kobo.343.1"> module – that is, any critical application errors, or errors thrown using </span><strong class="source-inline"><span class="koboSpan" id="kobo.344.1">throw new Error()</span></strong><span class="koboSpan" id="kobo.345.1">. </span><span class="koboSpan" id="kobo.345.2">It can be very useful to log application errors. </span><span class="koboSpan" id="kobo.345.3">It also allows us to control what users will see when they encounter a serious issue with an application. </span><span class="koboSpan" id="kobo.345.4">To demonstrate how a shared hook works, let’s add it to both </span><strong class="source-inline"><span class="koboSpan" id="kobo.346.1">src/hooks.server.js</span></strong><span class="koboSpan" id="kobo.347.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">src/hooks.client.js</span></strong><span class="koboSpan" id="kobo.349.1">. </span><span class="koboSpan" id="kobo.349.2">In this example, we’ll log errors on the server to a file and errors on the client </span><span class="No-Break"><span class="koboSpan" id="kobo.350.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">console.log()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.352.1">:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.353.1">src/hooks.client.js</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.354.1">
export async function handleError({ error, event }) {
  console.log('client handled error' + error.message);
  console.log(event.url);
  return {message: 'Whoops, looks like you found an error! </span><span class="koboSpan" id="kobo.354.2">Sorry about that.'};
}</span></pre>
<p><span class="koboSpan" id="kobo.355.1">In this</span><a id="_idIndexMarker216"/><span class="koboSpan" id="kobo.356.1"> example, we use </span><strong class="source-inline"><span class="koboSpan" id="kobo.357.1">console.log()</span></strong><span class="koboSpan" id="kobo.358.1"> to show various messages within the browser console. </span><span class="koboSpan" id="kobo.358.2">It would be nice if </span><strong class="source-inline"><span class="koboSpan" id="kobo.359.1">handleError()</span></strong><span class="koboSpan" id="kobo.360.1"> ran for every unexpected</span><a id="_idIndexMarker217"/><span class="koboSpan" id="kobo.361.1"> error within the client; however, that is not the case, as it only runs if an error is encountered during a client-side </span><strong class="source-inline"><span class="koboSpan" id="kobo.362.1">load()</span></strong><span class="koboSpan" id="kobo.363.1"> or while rendering on the client. </span><span class="koboSpan" id="kobo.363.2">As such, we’ll need to throw an error in another location to see it in action. </span><span class="koboSpan" id="kobo.363.3">To trigger this error, we’ll make a minor change </span><span class="No-Break"><span class="koboSpan" id="kobo.364.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.365.1">src/routes/(site)/fetch/+page.js</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.366.1">:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.367.1">src/routes/(site)/fetch/+page.js</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.368.1">
import { browser } from '$app/environment';
const key = 'DEMO_KEY'; // your API key here
export const prerender = true;
export function load() {
  if(browser) {
    throw new Error('in the browser');
  }
  const pic = fetch(`https://api.nasa.gov/planetary/apod?api_key=${key}`)
    .then(response =&gt; {
      console.log('got response');
      return response.json();
    });
  return {pic};
}</span></pre>
<p><span class="koboSpan" id="kobo.369.1">The first change we make is importing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.370.1">browser</span></strong><span class="koboSpan" id="kobo.371.1"> module from </span><strong class="source-inline"><span class="koboSpan" id="kobo.372.1">$app/environment</span></strong><span class="koboSpan" id="kobo.373.1">. </span><span class="koboSpan" id="kobo.373.2">Once done, we check that the code being run is in the browser and then throw an error, leaving the rest of the code alone. </span><span class="koboSpan" id="kobo.373.3">When we navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.374.1">/fetch</span></strong><span class="koboSpan" id="kobo.375.1"> route in our application, we’ll see the messages output from </span><strong class="source-inline"><span class="koboSpan" id="kobo.376.1">src/hooks.client.js</span></strong><span class="koboSpan" id="kobo.377.1">. </span><span class="koboSpan" id="kobo.377.2">With this hook, we can </span><a id="_idIndexMarker218"/><span class="koboSpan" id="kobo.378.1">ensure that no sensitive data is output to the client during client-side errors. </span><span class="koboSpan" id="kobo.378.2">We can also tailor the message in the returned error </span><span class="No-Break"><span class="koboSpan" id="kobo.379.1">object accordingly.</span></span></p>
<p><span class="koboSpan" id="kobo.380.1">To </span><a id="_idIndexMarker219"/><span class="koboSpan" id="kobo.381.1">demonstrate </span><strong class="source-inline"><span class="koboSpan" id="kobo.382.1">handleError()</span></strong><span class="koboSpan" id="kobo.383.1"> on the server, we can write the error messages to a log file, which can be easily read at a later time by developers or a daemon installed on </span><span class="No-Break"><span class="koboSpan" id="kobo.384.1">the server:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.385.1">src/hooks.server.js</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.386.1">
import { GITHUB } from '$env/static/private';
import fs from 'fs';
export async function handleFetch( { request, fetch  } ) {
  if (request.url.startsWith('https://api.github.com/')) {
    request.headers.set('Accept', 'application/vnd.github+json');
    request.headers.set('Authorization', 'Bearer ' + GITHUB);
    request.headers.set('X-GitHub-Api-Version', '2022-11-28');
  }
  return fetch(request);
}
export async function handle({ event, resolve }) {
  event.setHeaders({'X-NOT-FROM-GITHUB': 'our value'});
  const response = await resolve(event);
  response.headers.set('another', 'custom value');
  return response;
}
function today() {
  const current = new Date();
  return current.getDate() + "-" +
         current.getDay() + "-" +
         current.getFullYear() + " " +
         current.getHours() + ":" +
         current.getMinutes() + ":" +
         current.getSeconds();
}
export async function handleError({ error, event }) {
  const log = today() + ' ' + error.message + ' @ ' + event.request.url;
  fs.appendFile('./app.log', log + '\n', (err) =&gt; {
    if(err) {
      console.log(err);
    }
  });
  return {
    error: error.message
  };
}</span></pre>
<p><span class="koboSpan" id="kobo.387.1">The</span><a id="_idIndexMarker220"/><span class="koboSpan" id="kobo.388.1"> first change</span><a id="_idIndexMarker221"/><span class="koboSpan" id="kobo.389.1"> in this example to note is that we’ve imported the </span><strong class="source-inline"><span class="koboSpan" id="kobo.390.1">fs</span></strong><span class="koboSpan" id="kobo.391.1"> module. </span><span class="koboSpan" id="kobo.391.2">This is a Node-specific module for accessing the filesystem. </span><span class="koboSpan" id="kobo.391.3">This is worth noting, as including it will prevent us from building our application for another environment. </span><span class="koboSpan" id="kobo.391.4">The next change to note is that we’ve added the </span><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">today()</span></strong><span class="koboSpan" id="kobo.393.1"> function, which returns the current date and time as a string. </span><span class="koboSpan" id="kobo.393.2">Ideally, this function would live in a </span><strong class="source-inline"><span class="koboSpan" id="kobo.394.1">utilities</span></strong><span class="koboSpan" id="kobo.395.1"> folder, likely located in </span><strong class="source-inline"><span class="koboSpan" id="kobo.396.1">src/lib/</span></strong><span class="koboSpan" id="kobo.397.1">, but for this demonstration, we can include it here. </span><span class="koboSpan" id="kobo.397.2">We’ve also added </span><strong class="source-inline"><span class="koboSpan" id="kobo.398.1">handleError()</span></strong><span class="koboSpan" id="kobo.399.1"> to the end of the file. </span><span class="koboSpan" id="kobo.399.2">It </span><a id="_idIndexMarker222"/><span class="koboSpan" id="kobo.400.1">accepts an </span><strong class="source-inline"><span class="koboSpan" id="kobo.401.1">error</span></strong><span class="koboSpan" id="kobo.402.1"> object as well as an </span><strong class="source-inline"><span class="koboSpan" id="kobo.403.1">event</span></strong><span class="koboSpan" id="kobo.404.1"> object. </span><span class="koboSpan" id="kobo.404.2">We then concatenate the output from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.405.1">today()</span></strong><span class="koboSpan" id="kobo.406.1"> function with the error message, as well as information about where the error occurred. </span><span class="koboSpan" id="kobo.406.2">This is all then written to our log file using </span><strong class="source-inline"><span class="koboSpan" id="kobo.407.1">fs.appendFile()</span></strong><span class="koboSpan" id="kobo.408.1">. </span><span class="koboSpan" id="kobo.408.2">If an error is encountered while writing to the file, we’ll output it to the console. </span><span class="koboSpan" id="kobo.408.3">Finally, we return an object containing the </span><span class="No-Break"><span class="koboSpan" id="kobo.409.1">error message.</span></span></p>
<p><span class="koboSpan" id="kobo.410.1">To</span><a id="_idIndexMarker223"/><span class="koboSpan" id="kobo.411.1"> trigger </span><strong class="source-inline"><span class="koboSpan" id="kobo.412.1">handleError()</span></strong><span class="koboSpan" id="kobo.413.1">, we can throw an error in one of our actions or </span><strong class="source-inline"><span class="koboSpan" id="kobo.414.1">load()</span></strong><span class="koboSpan" id="kobo.415.1">. </span><span class="koboSpan" id="kobo.415.2">The precise location isn’t particularly important, but we can see our logging in action by adding </span><strong class="source-inline"><span class="koboSpan" id="kobo.416.1">throw new Error('our custom error');</span></strong><span class="koboSpan" id="kobo.417.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.418.1">+page.server.js</span></strong><span class="koboSpan" id="kobo.419.1">. </span><span class="koboSpan" id="kobo.419.2">In fact, try throwing an error from various </span><strong class="source-inline"><span class="koboSpan" id="kobo.420.1">load()</span></strong><span class="koboSpan" id="kobo.421.1"> functions or actions we’ve created so far. </span><span class="koboSpan" id="kobo.421.2">You can even experiment with the data provided from the request. </span><span class="koboSpan" id="kobo.421.3">For example, it might be helpful to log various headers, such as the client User-Agent, as this information can be helpful when troubleshooting browser compatibility. </span><span class="koboSpan" id="kobo.421.4">Once you have thrown a few errors, open </span><strong class="source-inline"><span class="koboSpan" id="kobo.422.1">app.log</span></strong><span class="koboSpan" id="kobo.423.1"> in the root of the project directory and observe the output. </span><span class="koboSpan" id="kobo.423.2">This simple logging mechanism can be tailored to a </span><span class="No-Break"><span class="koboSpan" id="kobo.424.1">project’s needs.</span></span></p>
<p><span class="koboSpan" id="kobo.425.1">By leveraging </span><strong class="source-inline"><span class="koboSpan" id="kobo.426.1">handleError()</span></strong><span class="koboSpan" id="kobo.427.1">, we can effortlessly bootstrap our own logging mechanism. </span><span class="koboSpan" id="kobo.427.2">We can also customize messages shown during errors on client-side rendering or </span><strong class="source-inline"><span class="koboSpan" id="kobo.428.1">load()</span></strong><span class="koboSpan" id="kobo.429.1">, which is especially helpful if our application is a single-page app. </span><span class="koboSpan" id="kobo.429.2">Of course, </span><strong class="source-inline"><span class="koboSpan" id="kobo.430.1">handleError()</span></strong><span class="koboSpan" id="kobo.431.1"> is very helpful, but it’s only helpful for unexpected errors. </span><span class="koboSpan" id="kobo.431.2">How should we manage errors that we </span><span class="No-Break"><span class="koboSpan" id="kobo.432.1">fully expect?</span></span></p>
<h1 id="_idParaDest-122"><a id="_idTextAnchor122"/><span class="koboSpan" id="kobo.433.1">Error Handling</span></h1>
<p><span class="koboSpan" id="kobo.434.1">Oftentimes, pesky</span><a id="_idIndexMarker224"/><span class="koboSpan" id="kobo.435.1"> users attempt to access resources they’re not supposed to access. </span><span class="koboSpan" id="kobo.435.2">Or maybe they’re just users being users and not paying attention to where they’re clicking. </span><span class="koboSpan" id="kobo.435.3">In any case, we’ve all met at least one user like this. </span><span class="koboSpan" id="kobo.435.4">As developers, it is in our best interest to ensure our code gives those users meaningful messages when they inevitably encounter an error. </span><span class="koboSpan" id="kobo.435.5">For the sake of our sanity and future selves, we should discuss errors </span><span class="No-Break"><span class="koboSpan" id="kobo.436.1">in SvelteKit.</span></span></p>
<p><span class="koboSpan" id="kobo.437.1">All of the errors we just created with </span><strong class="source-inline"><span class="koboSpan" id="kobo.438.1">handleError()</span></strong><span class="koboSpan" id="kobo.439.1"> are considered </span><em class="italic"><span class="koboSpan" id="kobo.440.1">unexpected errors</span></em><span class="koboSpan" id="kobo.441.1">. </span><span class="koboSpan" id="kobo.441.2">That is because we did not use SvelteKit’s error module. </span><span class="koboSpan" id="kobo.441.3">Errors created using this module are considered </span><em class="italic"><span class="koboSpan" id="kobo.442.1">expected errors</span></em><span class="koboSpan" id="kobo.443.1">. </span><span class="koboSpan" id="kobo.443.2">By importing the module, we can send custom status codes and error messages to SvelteKit, which can then be captured and used by </span><strong class="source-inline"><span class="koboSpan" id="kobo.444.1">+error.svelte</span></strong><span class="koboSpan" id="kobo.445.1"> components. </span><span class="koboSpan" id="kobo.445.2">This gives us even greater control over how our messaging displays </span><span class="No-Break"><span class="koboSpan" id="kobo.446.1">to users.</span></span></p>
<p><span class="koboSpan" id="kobo.447.1">In </span><a href="B19024_04_Final_AM.xhtml#_idTextAnchor060"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.448.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.449.1">, we briefly examined how the routing mechanism will interact with the closest </span><strong class="source-inline"><span class="koboSpan" id="kobo.450.1">+error.svelte</span></strong><span class="koboSpan" id="kobo.451.1"> template available. </span><span class="koboSpan" id="kobo.451.2">However, we didn’t really discuss the </span><strong class="source-inline"><span class="koboSpan" id="kobo.452.1">error</span></strong><span class="koboSpan" id="kobo.453.1"> module or how to use it. </span><span class="koboSpan" id="kobo.453.2">Firstly, it needs to be imported from </span><strong class="source-inline"><span class="koboSpan" id="kobo.454.1">@sveltejs/kit</span></strong><span class="koboSpan" id="kobo.455.1">. </span><span class="koboSpan" id="kobo.455.2">Once imported, we can then throw the error with </span><strong class="source-inline"><span class="koboSpan" id="kobo.456.1">throw error()</span></strong><span class="koboSpan" id="kobo.457.1"> and pass the function two arguments. </span><span class="koboSpan" id="kobo.457.2">The first argument is an integer representing the HTTP status </span><a id="_idIndexMarker225"/><span class="koboSpan" id="kobo.458.1">code classifying the error. </span><span class="koboSpan" id="kobo.458.2">For instance, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.459.1">401</span></strong><span class="koboSpan" id="kobo.460.1"> code represents a </span><em class="italic"><span class="koboSpan" id="kobo.461.1">client unauthorized</span></em><span class="koboSpan" id="kobo.462.1"> error. </span><span class="koboSpan" id="kobo.462.2">The second argument passed to </span><strong class="source-inline"><span class="koboSpan" id="kobo.463.1">error()</span></strong><span class="koboSpan" id="kobo.464.1"> is an object containing a message property, with the message we would </span><span class="No-Break"><span class="koboSpan" id="kobo.465.1">like conveyed.</span></span></p>
<p><span class="koboSpan" id="kobo.466.1">To see an example, let’s make some modifications to our </span><span class="No-Break"><span class="koboSpan" id="kobo.467.1">previous code:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.468.1">src/routes/(app)/github/+page.server.js</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.469.1">
import { error } from '@sveltejs/kit';
const star_url= 'https://api.github.com/user/starred/sveltejs/kit';
export function load({ fetch }) {
  throw error(401, {
    message: 'You don\'t have permission to see this!',
    id: crypto.randomUUID()
  });
  const repo = fetch( 'https://api.github.com/repos/sveltejs/kit' )
    .then( response =&gt; response.json() );
  return { repo };
}
export const actions = {
    // omitted for brevity
}</span></pre>
<p><span class="koboSpan" id="kobo.470.1">In this example, we’ve imported the </span><strong class="source-inline"><span class="koboSpan" id="kobo.471.1">error</span></strong><span class="koboSpan" id="kobo.472.1"> module from </span><strong class="source-inline"><span class="koboSpan" id="kobo.473.1">@sveltejs/kit</span></strong><span class="koboSpan" id="kobo.474.1">. </span><span class="koboSpan" id="kobo.474.2">Within the </span><strong class="source-inline"><span class="koboSpan" id="kobo.475.1">load()</span></strong><span class="koboSpan" id="kobo.476.1"> function, we then immediately throw an error using the module. </span><span class="koboSpan" id="kobo.476.2">For our error, we supply the </span><strong class="source-inline"><span class="koboSpan" id="kobo.477.1">401</span></strong><span class="koboSpan" id="kobo.478.1"> status code and an object with </span><strong class="source-inline"><span class="koboSpan" id="kobo.479.1">message</span></strong><span class="koboSpan" id="kobo.480.1"> properties, as well as a custom error </span><strong class="source-inline"><span class="koboSpan" id="kobo.481.1">id</span></strong><span class="koboSpan" id="kobo.482.1">. </span><span class="koboSpan" id="kobo.482.2">Again, this can be helpful for reporting and logging errors because we can customize the </span><a id="_idIndexMarker226"/><span class="koboSpan" id="kobo.483.1">error object with whatever information we’d like to provide. </span><span class="koboSpan" id="kobo.483.2">If we prefer not to create a whole object, we can instead provide a string with the error message or even just the HTTP status code! </span><span class="koboSpan" id="kobo.483.3">We’ll leave the rest of the code in this </span><span class="No-Break"><span class="koboSpan" id="kobo.484.1">file unchanged.</span></span></p>
<p><span class="koboSpan" id="kobo.485.1">Instead of building a traditional </span><strong class="source-inline"><span class="koboSpan" id="kobo.486.1">try catch</span></strong><span class="koboSpan" id="kobo.487.1"> statement around the error, we’ll let SvelteKit handle the catching by providing a customized </span><strong class="source-inline"><span class="koboSpan" id="kobo.488.1">+</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.489.1">error.svelte</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.490.1"> component:</span></span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.491.1">src/routes/(app)/github/+error.server.js</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.492.1">
&lt;script&gt;
  import { page } from '$app/stores';
&lt;/script&gt;
{$page.error.message}
{#if $page.error.id}
  &lt;p&gt;
    Error ID: {$page.error.id}
  &lt;/p&gt;
{/if}</span></pre>
<p><span class="koboSpan" id="kobo.493.1">To show our error messages, we’ll have to leverage the data within the Svelte store </span><strong class="source-inline"><span class="koboSpan" id="kobo.494.1">page</span></strong><span class="koboSpan" id="kobo.495.1">. </span><span class="koboSpan" id="kobo.495.2">This store is imported from </span><strong class="source-inline"><span class="koboSpan" id="kobo.496.1">$app/stores</span></strong><span class="koboSpan" id="kobo.497.1">, and the data within it can be accessed by prefacing the store name with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.498.1">$</span></strong><span class="koboSpan" id="kobo.499.1"> symbol. </span><span class="koboSpan" id="kobo.499.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.500.1">page</span></strong><span class="koboSpan" id="kobo.501.1"> store contains various properties and data pertaining to the accessed page. </span><span class="koboSpan" id="kobo.501.2">We then show the provided error message, followed by a Svelte </span><strong class="source-inline"><span class="koboSpan" id="kobo.502.1">{#if}</span></strong><span class="koboSpan" id="kobo.503.1"> directive to show the error ID, provided </span><span class="No-Break"><span class="koboSpan" id="kobo.504.1">it exists.</span></span></p>
<p><span class="koboSpan" id="kobo.505.1">We can then navigate to </span><strong class="source-inline"><span class="koboSpan" id="kobo.506.1">http://localhost/github</span></strong><span class="koboSpan" id="kobo.507.1"> and view our new error message, as well as an error ID number. </span><span class="koboSpan" id="kobo.507.2">To play around with this example and learn a little more about error handling, try moving </span><strong class="source-inline"><span class="koboSpan" id="kobo.508.1">src/routes/(app)/github/+error.svelte</span></strong><span class="koboSpan" id="kobo.509.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.510.1">src/routes/(app)/+error.svelte</span></strong><span class="koboSpan" id="kobo.511.1">. </span><span class="koboSpan" id="kobo.511.2">What happens if you move it all the way up to </span><strong class="source-inline"><span class="koboSpan" id="kobo.512.1">src/routes/+error.svelte</span></strong><span class="koboSpan" id="kobo.513.1">? </span><span class="koboSpan" id="kobo.513.2">You should try this in your own project, but in short, Svelte’s routing mechanism is robust enough to take the error to the nearest </span><strong class="source-inline"><span class="koboSpan" id="kobo.514.1">+error.svelte</span></strong><span class="koboSpan" id="kobo.515.1"> component </span><span class="No-Break"><span class="koboSpan" id="kobo.516.1">it finds.</span></span></p>
<p><span class="koboSpan" id="kobo.517.1">Having explored </span><a id="_idIndexMarker227"/><span class="koboSpan" id="kobo.518.1">error handling, you should now be able to show your application users pertinent information related to the error they’ve stumbled across. </span><span class="koboSpan" id="kobo.518.2">Doing so in an informative way should minimize the time spent triaging </span><span class="No-Break"><span class="koboSpan" id="kobo.519.1">support tickets.</span></span></p>
<h1 id="_idParaDest-123"><a id="_idTextAnchor123"/><span class="koboSpan" id="kobo.520.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.521.1">Having explored the various hooks available in SvelteKit as well as error handling, we’ve covered a lot. </span><span class="koboSpan" id="kobo.521.2">We first saw how we can modify outgoing </span><strong class="source-inline"><span class="koboSpan" id="kobo.522.1">fetch()</span></strong><span class="koboSpan" id="kobo.523.1"> requests that leverage SvelteKit’s included </span><strong class="source-inline"><span class="koboSpan" id="kobo.524.1">fetch()</span></strong><span class="koboSpan" id="kobo.525.1"> by changing familiar </span><strong class="source-inline"><span class="koboSpan" id="kobo.526.1">RequestEvent</span></strong><span class="koboSpan" id="kobo.527.1"> objects in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.528.1">handleFetch()</span></strong><span class="koboSpan" id="kobo.529.1"> hook. </span><span class="koboSpan" id="kobo.529.2">We also saw how we can adjust data flowing into our application via </span><strong class="source-inline"><span class="koboSpan" id="kobo.530.1">handle()</span></strong><span class="koboSpan" id="kobo.531.1">. </span><span class="koboSpan" id="kobo.531.2">Then, we explored the </span><strong class="source-inline"><span class="koboSpan" id="kobo.532.1">handleError()</span></strong><span class="koboSpan" id="kobo.533.1"> shared hook and how it can be utilized to build a rich logging mechanism or incorporated with another service. </span><span class="koboSpan" id="kobo.533.2">Finally, we returned to look at how we can manage expected errors with SvelteKit’s error routing devices, which allow us to customize the look and feel through custom </span><span class="No-Break"><span class="koboSpan" id="kobo.534.1">Svelte components.</span></span></p>
<p><span class="koboSpan" id="kobo.535.1">Now that we have a firm grasp on how to manage errors, we’ll move on to the next chapter to assess how we can best manage </span><span class="No-Break"><span class="koboSpan" id="kobo.536.1">static assets.</span></span></p>
<h1 id="_idParaDest-124"><a id="_idTextAnchor124"/><span class="koboSpan" id="kobo.537.1">Resources</span></h1>
<ul>
<li><span class="koboSpan" id="kobo.538.1">GitHub API </span><span class="No-Break"><span class="koboSpan" id="kobo.539.1">documentation: </span></span><a href="https://docs.github.com/en/rest"><span class="No-Break"><span class="koboSpan" id="kobo.540.1">https://docs.github.com/en/rest</span></span></a></li>
</ul>
</div>
</body></html>