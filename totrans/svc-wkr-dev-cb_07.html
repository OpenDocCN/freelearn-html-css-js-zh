<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Fetching Resources"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Fetching Resources</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Fetching remote resources</li><li class="listitem" style="list-style-type: disc">Fetching with <code class="literal">FetchEvent</code></li><li class="listitem" style="list-style-type: disc">Fetching a JSON file during service worker installation</li><li class="listitem" style="list-style-type: disc">Proxying</li><li class="listitem" style="list-style-type: disc">Prefetching</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec54"/>Introduction</h1></div></div></div><p>In this chapter, we will look at how to request files and resources from different sources, which in more technical terms perform fetch actions against different resources. We will look at fetching a JSON file during the service worker installation, using the service worker as a proxy middleware, and prefetching a list of specific resource URLs during the installation process, so that you have the resources handy before loading the page.</p><p>Let's start off this chapter by looking at a simple example of fetching a resource from two different resources.</p></div></div>
<div class="section" title="Fetching remote resources"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec55"/>Fetching remote resources</h1></div></div></div><p>Fetching remote resources<a id="id330" class="indexterm"/> can be done in different ways. In this recipe, we are going to look at two standard ways of fetching a remote resource using a service worker, with and without <span class="strong"><strong>cross-origin HTTP requests</strong></span> (<span class="strong"><strong>CORS</strong></span>).</p><p>You can learn more about CORS at the following link:</p><p>
<a class="ulink" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS">https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS</a>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec148"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the first recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <span class="emphasis"><em>Learning Service Worker Basics</em></span>: <span class="emphasis"><em>Setting up service workers</em></span>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the <span class="emphasis"><em>Setting up GitHub pages for SSL</em></span> recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <span class="emphasis"><em>Learning Service Worker Basics</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec149"/>How to do it...</h2></div></div></div><p>Follow these <a id="id331" class="indexterm"/>instructions to set up your file structure:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Copy the <code class="literal">index.html</code>, <code class="literal">index.js</code>, <code class="literal">service-worker.js</code>, and <code class="literal">style.css</code> file from the following location:<p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/07/01/">https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/07/01/</a>
</p></li><li class="listitem">Open up a browser and go to <code class="literal">index.html</code>. You will see two images fetched from two different protocols, <code class="literal">https</code> and <code class="literal">https-acao</code>:<div class="mediaobject"><img src="graphics/B05381_07_01.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec150"/>How it works...</h2></div></div></div><p>At the beginning of the <code class="literal">index.js</code> file, we are testing two different protocols for loading resources:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">https</code>: HTTP with <span class="strong"><strong>Secure Socket Layer</strong></span> (<span class="strong"><strong>SSL</strong></span>) protocol</li><li class="listitem" style="list-style-type: disc"><code class="literal">https-acao</code>: SSL protocol with the <code class="literal">Access-Control-Origin=*</code> header</li></ul></div><p>We will <a id="id332" class="indexterm"/>use two different URLs, which will be loaded multiple times:</p><div class="informalexample"><pre class="programlisting">var protocols = {
  'https-acao': 'https://i942.photobucket.com/albums/ad261/szaranger/Packt/packt-logo.png',
  'https': 'https://dz13w8afd47il.cloudfront.net/sites/all/themes/packt_v4/images/packtlib-logo-dark.png'
};</pre></div><p>We will also use two different methods for fetching resources, with or without CORS:</p><div class="informalexample"><pre class="programlisting">navigator.serviceWorker.getRegistration().then(function(registration) {
  var fetchModes = ['cors', 'no-cors'];</pre></div><p>Next, we will check to see whether the service worker is registered:</p><div class="informalexample"><pre class="programlisting">if (!registration || !navigator.serviceWorker.controller) {  
    navigator.serviceWorker.register(
    './service-worker.js').then(function() {
      console.log('Service worker registered, reloading the page');
      window.location.reload();
    });</pre></div><p>If that is not the case, we register it and reload the page to ensure that the client is under the service worker's control:</p><div class="informalexample"><pre class="programlisting">for (var protocol in protocols) {
  if (protocols.hasOwnProperty(protocol)) {
    buildImage(protocol, protocols[protocol]);

    for (var i = 0; i &lt; fetchModes.length; i++) {
      var fetchMode = fetchModes[i],
      init = { 
        method: 'GET',
        mode: fetchMode,
        cache: 'default' 
      };

    }
  }
}</pre></div><p>The two <code class="literal">for</code> loops go through the provided protocols array and make requests for each protocol. They also build a DOM image element with each URL and go through each mode of the <code class="literal">fetchModes</code> array.</p><p>The <code class="literal">init</code> object <a id="id333" class="indexterm"/>contains any custom settings that you may want to apply to the request. Let's look at the properties of the <code class="literal">init</code> object:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">method</code>: The request method, for example, <code class="literal">GET</code>, and <code class="literal">POST</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">mode</code>: The mode you want to use for the request, for example, <code class="literal">cors</code>, <code class="literal">no-cors</code>, or <code class="literal">same-origin</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">cache</code>: The cache mode you want to use for the request, for example <code class="literal">default</code>, <code class="literal">no-store</code>, <code class="literal">reload</code>, <code class="literal">no-cache</code>, <code class="literal">force-cache</code>, or <code class="literal">only-if-cached</code></li></ul></div><p>The <code class="literal">buildImage</code> function takes two arguments, <code class="literal">protocol</code> and <code class="literal">url</code>. It creates an image element on the fly and attaches the URL as the source of that image. Then it goes on to add that image to the DOM tree, where the ID is one of <code class="literal">https-acao-image</code>, <code class="literal">https-image</code>, or <code class="literal">http–image</code>. JavaScript has no control over the URL handling at this point; the browser handles the URLs:</p><div class="informalexample"><pre class="programlisting">function buildImage(protocol, url) {
  var element = protocol + '-image',
    image = document.createElement('img');

  image.src = url;
  document.getElementById(element).appendChild(image);
}</pre></div><p>Images will be rendered for HTTPS requests only, as service workers only support connections over SSL.</p><p>The requests over SSL with the <code class="literal">Access-Control-Origin=*</code> header (Access Control Allow Origin) will return results successfully.</p><p>By default, fetching a resource from a third-party URL will fail if CORS is not supported by it. You can add a non-CORS option to the Request to overcome this. However, this will cause an opaque response, which means that you won't be able to tell whether the response was successful or not.</p><p>The <code class="literal">fireRequest</code> function takes three arguments, <code class="literal">fetchMode</code>, <code class="literal">protocol</code>, and <code class="literal">init</code>. This function returns another function, which we can call as a composition. We start with fetching the given resource directly from the remote resource:</p><div class="informalexample"><pre class="programlisting"> fetch(url, init).then(function(response) {
    printSuccess(response, url, section);
 }).catch(function(error) {
    printError(error, url, section);
 });</pre></div><p>If the fetch was successful, we print it into the console as well as log it on the web page. The same applies if the request fails, only this time we print the error.</p><p>The helper <a id="id334" class="indexterm"/>function log finds the DOM element by the ID and adds a paragraph element, as well as a class attribute to depict the type of the message:</p><div class="informalexample"><pre class="programlisting">function log(id, message, type) {
  var type = type || 'success',
    sectionElement = document.getElementById(id),
    logElement = document.createElement('p');

  if (type) {
    logElement.classList.add(type);
  }
  logElement.textContent = message;
  sectionElement.appendChild(logElement);
}</pre></div><p>In the <code class="literal">index.html</code> file, we have style declarations in the head section:</p><div class="informalexample"><pre class="programlisting">&lt;style&gt;
.error {
     color: #FF0000;
   }
   .success {
     color: #00FF00;
   }
&lt;/style&gt;</pre></div><p>In our <code class="literal">log()</code> function, we set the undefined type to success so that it will display the color green when we add it to <code class="literal">classList</code>. The error type will display red, as declared in the preceding styles.</p></div></div>
<div class="section" title="Fetching with FetchEvent"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec56"/>Fetching with FetchEvent</h1></div></div></div><p>The <code class="literal">FetchEvent</code> class<a id="id335" class="indexterm"/> is a fetch action dispatched on the service worker. It contains details about requests as well as responses. It provides all important <code class="literal">FetchEvent.reponseWith()</code> methods, which we can use to provide a response back to the page that is controlled by the service worker.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec151"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the first recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <span class="emphasis"><em>Learning Service Worker Basics</em></span>: <span class="emphasis"><em>Setting up service workers</em></span>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the following recipes of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <span class="emphasis"><em>Learning Service Worker Basics</em></span>: <span class="emphasis"><em>Setting up GitHub pages for SSL</em></span>, <span class="emphasis"><em>Setting up SSL for Windows</em></span>, and <span class="emphasis"><em>Setting up SSL for Mac</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec152"/>How to do it...</h2></div></div></div><p>Follow these <a id="id336" class="indexterm"/>instructions to set up your file structure:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Copy the <code class="literal">index.html</code>, <code class="literal">index.js</code>, <code class="literal">service-worker.js</code>, <code class="literal">adeobe-log.png</code>, and <code class="literal">style.css</code> files from the following location:<p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/07/02/">https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/07/02/</a>
</p></li><li class="listitem">Open up a browser and go to <code class="literal">index.html</code>:<div class="mediaobject"><img src="graphics/B05381_07_02.jpg" alt="How to do it..."/></div></li><li class="listitem">Open up the Developer Toolbar (<span class="emphasis"><em>Cmd</em></span> + <span class="emphasis"><em>Alt</em></span> + <span class="emphasis"><em>I</em></span> or <span class="emphasis"><em>F12</em></span>). Now refresh the page and look at the messages in the console. You will see the fetch requests are logged in the console:<div class="mediaobject"><img src="graphics/B05381_07_03.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec153"/>How it works...</h2></div></div></div><p>We are <a id="id337" class="indexterm"/>simply printing out different stages within the fetch event handler of the service worker to the console. The fetch method of our <code class="literal">service-worker.js</code> file looks like the following:</p><div class="informalexample"><pre class="programlisting">var cacheName= 'fetch-event-cache';

self.addEventListener('install', function(event) {
  event.waitUntil(
    caches.open(cacheName)
      .then(function(cache) {
        return cache.addAll([
          'adobe-logo.png',
          'style.css',
          'index.html',
          'index.js',
          'style.css'
        ]);
      })
      .then(function() {
        return self.skipWaiting();
      })
  );
});

self.addEventListener('fetch', function(event) {
  console.log('Handling fetch event for', event.request.url);

  event.respondWith(
    caches.match(event.request).then(function(res) {
      if (res) {
        console.log('Fetching from cache:', res);

        return res;
      }
      console.log('No response from cache. Fetching from network...');

      return fetch(event.request).then(function(res) {
        console.log('Response from network:', res);

        return res;
      }).catch(function(error) {
        console.error('ERROR: Fetching failed:', error);

        throw error;
      });
    })
  );
});</pre></div><p>Let's discuss <a id="id338" class="indexterm"/>some of these <a id="id339" class="indexterm"/>API methods in more detail.</p><div class="section" title="Cache.addAll()"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec18"/>Cache.addAll()</h3></div></div></div><p>This<a id="id340" class="indexterm"/> method takes in a URL array, retrieves the response, and then adds that result to a specified cache. The specified cache in our example is <code class="literal">'fetch-event-cache'</code>:</p><div class="informalexample"><pre class="programlisting">var cacheName= 'fetch-event-cache';</pre></div></div><div class="section" title="ExtendableEvent.waitUntil()"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec19"/>ExtendableEvent.waitUntil()</h3></div></div></div><p>This<a id="id341" class="indexterm"/> method extends the lifetime of an event. In our example, we are waiting until the resources are cached:</p><div class="informalexample"><pre class="programlisting">.then(function(cache) {
        return cache.addAll([
          'adobe-logo.png',
          'style.css',
          'index.html',
          'index.js',
          'style.css'
        ]);
      })</pre></div></div><div class="section" title="FetchEvent.respondWith()"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec20"/>FetchEvent.respondWith()</h3></div></div></div><p>This <a id="id342" class="indexterm"/>method resolves by returning a <code class="literal">Response</code> object or a network error to the <code class="literal">Fetch</code> object:</p><div class="informalexample"><pre class="programlisting">event.respondWith(
    caches.match(event.request).then(function(res) {</pre></div></div></div></div>
<div class="section" title="Fetching a JSON file during service worker installation"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec57"/>Fetching a JSON file during service worker installation</h1></div></div></div><p>In this <a id="id343" class="indexterm"/>recipe, we are going to learn how to cache resource files using a JSON file by specifying the names of the resource files in it. Usually, this is done by keeping an array in the service worker JavaScript file, but you might want them in a separate location, for reasons such as versioning, for example.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec154"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the first recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <span class="emphasis"><em>Learning Service Worker Basics</em></span>: <span class="emphasis"><em>Setting up service workers</em></span>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the following recipes of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <span class="emphasis"><em>Learning Service Worker Basics</em></span>: <span class="emphasis"><em>Setting up GitHub pages for SSL</em></span>, <span class="emphasis"><em>Setting up SSL for Windows</em></span>, and <span class="emphasis"><em>Setting up SSL for Mac</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec155"/>How to do it...</h2></div></div></div><p>Follow these instructions to set up your file structure:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download all the files from the following location:</li><li class="listitem"><a class="ulink" href="https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/07/03/">https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/07/03/</a></li><li class="listitem">Open up a browser and go to the <code class="literal">index.html</code> file:<div class="mediaobject"><img src="graphics/B05381_07_04.jpg" alt="How to do it..."/></div></li><li class="listitem">Now <a id="id344" class="indexterm"/>open up the DevTools (<span class="emphasis"><em>Cmd</em></span> + <span class="emphasis"><em>Alt</em></span> + <span class="emphasis"><em>I</em></span> or <span class="emphasis"><em>F12</em></span>) and make sure the <span class="strong"><strong>Preserve log</strong></span> checkbox is clicked. Now refresh the page and you will see the log messages retrieving files from the cache:<p>      </p><div class="mediaobject"><img src="graphics/B05381_07_05.jpg" alt="How to do it..."/></div><p>
</p></li><li class="listitem">If you<a id="id345" class="indexterm"/> look at the <span class="strong"><strong>Resources</strong></span> tab, you will see the cached resources:<div class="mediaobject"><img src="graphics/B05381_07_06.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec156"/>How it works...</h2></div></div></div><p>We only require one action, which is at the time of the initial load for caching the assets and registering the service worker. So at the time of installation, we load the JSON file, parse JSON, and add the files to the cache. Our <code class="literal">service-worker.js</code> file looks like this:</p><div class="informalexample"><pre class="programlisting">var cacheName= 'fetch-json';

self.addEventListener('install', function(event) {
  event.waitUntil(
    caches.open(cacheName)
      .then(function(cache) {
        return fetch('files.json').then(function(response) {
          return response.json();
        }).then(function(files) {
          console.log('Installing files from JSON file: ', files);
          return cache.addAll(files);
        });
      })
      .then(function() {
        console.log(
          'All resources cached'
        );

        return self.skipWaiting();
      })
  );
});</pre></div><p>Return a <a id="id346" class="indexterm"/>response from the cache if it was found:</p><div class="informalexample"><pre class="programlisting">self.addEventListener('fetch', function(event) {
  event.respondWith(
    caches.match(event.request)
      .then(function(response) {
        if (response) {
          console.log('Fetching from the cache: ', event.request.url);
          return response;
        } else {
          console.log('Fetching from server: ', event.request.url);
        }
       return fetch(event.request);
     }
   )
 );
});</pre></div><p>The client claims the service worker:</p><div class="informalexample"><pre class="programlisting">self.addEventListener('activate', function(event) {
   console.log('Activating the service worker!');
   event.waitUntil(self.clients.claim());
}); </pre></div><p>We will list the resource file names in the <code class="literal">files.json</code> file:</p><div class="informalexample"><pre class="programlisting">[
  "adobe-logo.png",
  "apple-logo.png",
  "google-logo.png",
  "style.css",
  "index.html",
  "index.js",
  "style.css"
]</pre></div><p>We will <a id="id347" class="indexterm"/>add a section to our <code class="literal">index.html</code> file for the images:</p><div class="informalexample"><pre class="programlisting">&lt;section&gt;
    &lt;h2&gt;Assets from JSON&lt;/h2&gt;
    &lt;img src="adobe-logo.png" alt="adobe logo"&gt;
    &lt;img src="apple-logo.png" alt="apple logo"&gt;
    &lt;img src="google-logo.png" alt="google logo"&gt;
&lt;/section&gt;</pre></div></div></div>
<div class="section" title="Proxying"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec58"/>Proxying</h1></div></div></div><p>A proxy is<a id="id348" class="indexterm"/> an intermediary between a web browser and the Internet. In this recipe, we will learn how to use the service worker as a proxy middleware.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec157"/>Getting ready</h2></div></div></div><p>To get <a id="id349" class="indexterm"/>started with service workers, you will <a id="id350" class="indexterm"/>need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the first recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <span class="emphasis"><em>Learning Service Worker Basics</em></span>: <span class="emphasis"><em>Setting up service workers</em></span>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the following recipes: <span class="emphasis"><em>Setting up GitHub pages for SSL</em></span>, <span class="emphasis"><em>Setting up SSL for Windows</em></span>, and <span class="emphasis"><em>Setting up SSL for Mac</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec158"/>How to do it...</h2></div></div></div><p>Follow these instructions to set up your file structure:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download all the files from the following location:<p>
<a class="ulink" href="https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/07/04/">https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/07/04/</a>
</p></li><li class="listitem">Open up a browser and go to <code class="literal">index.html</code>:<div class="mediaobject"><img src="graphics/B05381_07_07.jpg" alt="How to do it..."/></div></li><li class="listitem">Now<a id="id351" class="indexterm"/> click on the first link to<a id="id352" class="indexterm"/> navigate to the <code class="literal">/hello</code> link:<div class="mediaobject"><img src="graphics/B05381_07_08.jpg" alt="How to do it..."/></div></li><li class="listitem">Now open up DevTools (<span class="emphasis"><em>Cmd</em></span> + <span class="emphasis"><em>Alt</em></span> + <span class="emphasis"><em>I</em></span> or <span class="emphasis"><em>F12</em></span>) to see the log messages on the <span class="strong"><strong>Console</strong></span> tab:<div class="mediaobject"><img src="graphics/B05381_07_09.jpg" alt="How to do it..."/></div></li><li class="listitem">Now<a id="id353" class="indexterm"/> click on<a id="id354" class="indexterm"/> the first link to navigate to the <code class="literal">/hello/world</code> link:<div class="mediaobject"><img src="graphics/B05381_07_10.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec159"/>How it works...</h2></div></div></div><p>We are adding two links to the <code class="literal">index.html</code> file where we are planning to create a proxy:</p><div class="informalexample"><pre class="programlisting">&lt;section &gt;
    &lt;h1&gt;Proxy&lt;/h1&gt;
    &lt;p&gt;Click the links below for navigating to fetch handlers:&lt;/p&gt;
    &lt;div class="links"&gt;
      &lt;a href="/service-workers/07/04/hello"&gt;/hello&lt;/a&gt;&lt;br /&gt;
      &lt;a href="/service-workers/07/04/hello/world"&gt;/hello/world&lt;/a&gt;
    &lt;/div&gt;
&lt;/section&gt;</pre></div><p>We create a <a id="id355" class="indexterm"/>proxy for requests to the local URLs, inside the <code class="literal">service-worker.js</code> file, containing a <code class="literal">hello</code> string as well as <code class="literal">hello/world</code>. The <a id="id356" class="indexterm"/>client will recognize this as a local resource:</p><div class="informalexample"><pre class="programlisting">var helloFetchHandler = function(event) {
  if (event.request.url.indexOf('/hello') &gt; 0) {
    console.log('DEBUG: Inside the /hello handler.');
    event.respondWith(new Response('Fetch handler for /hello'));
  }
};

var helloWorldFetchHandler = function(event) {
  if (event.request.url.endsWith('/hello/world')) {
    console.log('DEBUG: Inside the /hello/world handler.');
    event.respondWith(new Response('Fetch handler for /hello/world'));
  }
};</pre></div><p>We pass these handlers into the fetch event listener as callbacks:</p><div class="informalexample"><pre class="programlisting">var fetchHandlers = [helloWorldFetchHandler, helloFetchHandler];

fetchHandlers.forEach(function(fetchHandler) {
  self.addEventListener('fetch', fetchHandler);
}); </pre></div></div></div>
<div class="section" title="Prefetching"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec59"/>Prefetching</h1></div></div></div><p>Prefetching resources<a id="id357" class="indexterm"/> during the service worker installation phase can easily enable offline viewing of a website. In this recipe, we will look into be prefetching resources including pages and images.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec160"/>Getting ready</h2></div></div></div><p>To get started with service workers, you will need to have the service worker experiment feature turned on in your browser settings. If you have not done this yet, refer to the first recipe of <a class="link" href="ch01.html" title="Chapter 1. Learning Service Worker Basics">Chapter 1</a>, <span class="emphasis"><em>Learning Service Worker Basics</em></span>: <span class="emphasis"><em>Setting up service workers</em></span>. Service workers only run across HTTPS. To find out how to set up a development environment to support this feature, refer to the following recipes: <span class="emphasis"><em>Setting up GitHub pages for SSL</em></span>, <span class="emphasis"><em>Setting up SSL for Windows</em></span>, and <span class="emphasis"><em>Setting up SSL for Mac</em></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec161"/>How to do it...</h2></div></div></div><p>Follow<a id="id358" class="indexterm"/> these instructions to set up your file structure:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download all the files from the following location:</li><li class="listitem"><a class="ulink" href="https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/07/05/">https://github.com/szaranger/szaranger.github.io/blob/master/service-workers/07/05/</a></li><li class="listitem">Open up a browser and go to the <code class="literal">index.html</code> file:<div class="mediaobject"><img src="graphics/B05381_07_11.jpg" alt="How to do it..."/></div></li><li class="listitem">Open up the Developer Toolbar (<span class="emphasis"><em>Cmd</em></span> + <span class="emphasis"><em>Alt</em></span> + <span class="emphasis"><em>I</em></span> or <span class="emphasis"><em>F12</em></span>) and look at the messages in the console. You will see the resources have been successfully cached:<div class="mediaobject"><img src="graphics/B05381_07_12.jpg" alt="How to do it..."/></div></li><li class="listitem">Now go<a id="id359" class="indexterm"/> offline by selecting offline on the DevTools <span class="strong"><strong>Network</strong></span> tab:<div class="mediaobject"><img src="graphics/B05381_07_13.jpg" alt="How to do it..."/></div></li><li class="listitem">Now click on the <span class="strong"><strong>prefetched.txt</strong></span> link. The linked text file will open in a new tab:<div class="mediaobject"><img src="graphics/B05381_07_14.jpg" alt="How to do it..."/></div></li><li class="listitem">Click on the <span class="strong"><strong>prefetched.html</strong></span> link. The linked page will open in a new tab:<div class="mediaobject"><img src="graphics/B05381_07_15.jpg" alt="How to do it..."/></div></li><li class="listitem">Click <a id="id360" class="indexterm"/>on the <span class="strong"><strong>apple-log.png</strong></span> link. The linked image will open in a new tab:<div class="mediaobject"><img src="graphics/B05381_07_16.jpg" alt="How to do it..."/></div></li><li class="listitem">If you examine the console, you will find the links have been served from the cache:<div class="mediaobject"><img src="graphics/B05381_07_17.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec162"/>How it works...</h2></div></div></div><p>In the <code class="literal">index.html</code> file, we are adding a section with links to the prefetched files:</p><div class="informalexample"><pre class="programlisting">  &lt;section id="prefetched"&gt;
    &lt;ul&gt;
      &lt;li&gt;&lt;a href="prefetched.txt" target="_blank"&gt;prefetched.txt&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href="prefetched.html" target="_blank"&gt;prefetched.html&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href="apple-logo.png" target="_blank"&gt;apple-logo.png&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/section&gt;</pre></div><p>In the <code class="literal">service-worker.js</code> file, we start with declaring the cache version at the top in case you <a id="id361" class="indexterm"/>have to force pages controlled by the service worker to use a new cache:</p><div class="informalexample"><pre class="programlisting">var cacheName= 'cache';
var currentCaches = {
  prefetch: 'prefetch-' + cacheName
};</pre></div><p>We also list the resources to be cached:</p><div class="informalexample"><pre class="programlisting">var prefetchedURLs = [
    'prefetched.txt',
    'prefetched.html',
    'apple-logo.png'
];</pre></div><p>The following line will construct a new URL from the list we have given it, using the service worker's script location as its base:</p><div class="informalexample"><pre class="programlisting">  var url = new URL(prefetchedURLs, location.href);</pre></div><p>Next, we add a cache busting timestamp to the query string:</p><div class="informalexample"><pre class="programlisting">url.search += (url.search ? '&amp;' : '?') + 'cache-bust=' + Date.now();</pre></div><p>We have to make sure to specify <code class="literal">{mode: 'no-cors'}</code> if there is a possibility that the server delivering the resource does not support CORS:</p><div class="informalexample"><pre class="programlisting">var request = new Request(url, {mode: 'no-cors'});</pre></div><p>Next, we fetch the resources and cache them:</p><div class="informalexample"><pre class="programlisting">return fetch(request).then(function(res) {
    if (res.status &gt;= 400) {
        throw new Error('FAIL: request for ' + prefetchedURLs +
        ' failed, status ' + res.statusText);
    }
    console.log('CACHING: Caching');
    return cache.put(prefetchedURLs, res);
}).catch(function(err) {
    console.error('CACHING: Not caching ' + prefetchedURLs + ' due to ' + err);
});</pre></div><p>Now let's <a id="id362" class="indexterm"/>look at the activate event handler. We make sure to delete all the caches that aren't in the <code class="literal">currentChaches</code> object we declared at the start:</p><div class="informalexample"><pre class="programlisting">    self.addEventListener('activate', function(evt) {
        var expectedCacheNames = Object.keys(currentCaches).map(function(key) {
            return currentCaches[key];
        });

        evt.waitUntil(
            caches.keys().then(function(cacheNames) {
              return Promise.all(
                cacheNames.map(function(cacheName) {
                  if (expectedCacheNames.indexOf(cacheName) === -1) {
                    console.log('DELETE: out of date cache:', cacheName);
                    return caches.delete(cacheName);
                  }
                })
              );
            })
        );
    });</pre></div><p>The fetch event listener is where the service worker looks for the cached resources:</p><div class="informalexample"><pre class="programlisting">self.addEventListener('fetch', function(evt) {
  console.log('FETCH: Handling fetch event for ', evt.request.url);

  evt.respondWith(
    caches.match(evt.request).then(function(res) {
      if (res) {
        console.log('RESPONSE: found in cache:', res);

        return res;
      }

      console.log('RESPONSE: not found in cache. Fetching from network.');

      return fetch(evt.request).then(function(res) {
        console.log('RESPONSE: from network:', res);

        return res;
      }).catch(function(error) {
        console.error('FAIL: fetching :', error);

        throw error;
      });
    })
  );
});</pre></div></div></div></body></html>