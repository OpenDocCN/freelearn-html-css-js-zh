<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Deployment Preparations</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem">Minifying HTML</li><li class="listitem">Minifying CSS</li><li class="listitem">Optimizing images</li><li class="listitem">Linting JavaScript code</li><li class="listitem">Uglifying JavaScript code</li><li class="listitem">Setting up RequireJS</li></ul></div><div><div><div><div><h1 class="title"><a id="ch06lvl1sec60"/>Introduction</h1></div></div></div><p>Once our web application is built and its stability ensured, we can start preparing it for deployment to its intended market. This will mainly involve the optimization of the assets that make up the application. Optimization in this context mostly refers to compression of one kind or another, some of which might lead to performance increases too.</p><p>The focus on compression is primarily due to the fact that the smaller the asset, the faster it can be transferred from where it is hosted to a user's web browser. This leads to a much better user experience, and can sometimes be essential to the functioning of an application.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec61"/>Minifying HTML</h1></div></div></div><p>In this recipe, we<a id="id249" class="indexterm"/> make use of the <code class="literal">contrib-htmlmin (0.3.0)</code> plugin to decrease the size of some <strong>HTML</strong> documents by <strong>minifying</strong> them.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec144"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec145"/>How to do it...</h2></div></div></div><p>The following <a id="id250" class="indexterm"/>steps take us through creating a sample HTML document and configuring a task that minifies it:</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by installing the package that contains the <code class="literal">contrib-htmlmin</code> plugin as per the instructions provided in the <em>Installing a plugin</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>.</li><li class="listitem">Next, we'll create a simple HTML document called <code class="literal">index.html</code> in the <code class="literal">src</code> directory, which we'd like to minify, and add the following content in it:<div><pre class="programlisting">&lt;html&gt; 
  &lt;head&gt; 
    &lt;title&gt;Test Page&lt;/title&gt; 
  &lt;/head&gt; 
  &lt;body&gt; 
    &lt;!-- This is a comment! --&gt; 
    &lt;h1&gt;This is a test page.&lt;/h1&gt; 
  &lt;/body&gt; 
&lt;/html&gt;</pre></div></li><li class="listitem">Now, we'll add the following <code class="literal">htmlmin</code> task to our configuration, which indicates that we'd like to have the white space and comments removed from the <code class="literal">src/index.html</code> file, and that we'd like the result to be saved in the <code class="literal">dist/index.html</code> file:<div><pre class="programlisting">htmlmin: { 
  dist: { 
    src: 'src/index.html', 
    dest: 'dist/index.html', 
    options: { 
      removeComments: true, 
      collapseWhitespace: true
    }
  }
}</pre></div><div><h3 class="title"><a id="tip64"/>Tip</h3><p>The <code class="literal">removeComments</code> and <code class="literal">collapseWhitespace</code> options are used as examples here, as using the default <code class="literal">htmlmin</code> task will have no effect. Other <a id="id251" class="indexterm"/>minification options can be found at the following URL:</p><p><a class="ulink" href="https://github.com/kangax/html-minifier#options-quick-reference">https://github.com/kangax/html-minifier#options-quick-reference</a></p></div></li><li class="listitem">We can <a id="id252" class="indexterm"/>now run the task using the <code class="literal">grunt htmlmin</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "htmlmin:dist" (htmlmin) task </strong>
<strong>Minified dist/index.html 147 B → 92 B</strong>
</pre></div></li><li class="listitem">If we now take a look at the <code class="literal">dist/index.html</code> file, we will see that all white space and comments have been removed:<div><pre class="programlisting">&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Test Page&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;This is a test page.&lt;/h1&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div></li></ol><div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec62"/>Minifying CSS</h1></div></div></div><p>In this recipe, we'll <a id="id253" class="indexterm"/>make use of the <code class="literal">contrib-cssmin (0.10.0)</code> plugin to decrease the size of some <strong>CSS</strong> documents by <strong>minifying</strong> them.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec146"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec147"/>How to do it...</h2></div></div></div><p>The following steps take us through creating a sample CSS document and configuring a task that minifies it.</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by installing the package that contains the <code class="literal">contrib-cssmin</code> plugin as per the instructions provided in the <em>Installing a plugin </em>recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>.</li><li class="listitem">Then, we'll create a simple CSS document called <code class="literal">style.css</code> in the <code class="literal">src</code> directory, which <a id="id254" class="indexterm"/>we'd like to minify, and provide it with the following contents:<div><pre class="programlisting">body { 
  /* Average body style */
  background-color: #ffffff; 
  color: #000000; /*! Black (Special) */
}</pre></div></li><li class="listitem">Now, we'll add the following <code class="literal">cssmin</code> task to our configuration, which indicates that we'd like to have the <code class="literal">src/style.css</code> file compressed, and have the result saved to the <code class="literal">dist/style.min.css</code> file:<div><pre class="programlisting">cssmin: { 
  dist: { 
    src: 'src/style.css', 
    dest: 'dist/style.min.css' 
  } 
}</pre></div></li><li class="listitem">We can now run the task using the <code class="literal">grunt cssmin</code> command, which should produce the following output:<div><pre class="programlisting">
<strong>Running "cssmin:dist" (cssmin) task </strong>
<strong>File dist/style.css created: 55 B → 38 B</strong>
</pre></div></li><li class="listitem">If we take a look at the <code class="literal">dist/style.min.css</code> file that was produced, we will see that it has the compressed contents of the original <code class="literal">src/style.css</code> file:<div><pre class="programlisting">body{background-color:#fff;color:#000;/*! Black (Special) */}</pre></div></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec148"/>There's more...</h2></div></div></div><p>The <code class="literal">cssmin</code> task<a id="id255" class="indexterm"/> provides us with several useful options that can be used in conjunction with its basic compression feature. We'll look at prefixing a banner, removing special comments, and reporting gzipped results.</p><div><div><div><div><h3 class="title"><a id="ch06lvl3sec83"/>Prefixing a banner</h3></div></div></div><p>In the case that<a id="id256" class="indexterm"/> we'd like to automatically include some information about the compressed result in the resulting CSS file, we can do so in a banner. A banner can be prepended to the result by supplying the desired banner content to the <code class="literal">banner</code> option, as shown in the following example:</p><div><pre class="programlisting">cssmin: { 
  dist: { 
    src: 'src/style.css', 
    dest: 'dist/style.min.css', 
    options: { 
      <strong>banner: '/* Minified version of style.css */' </strong>
    } 
  } 
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec84"/>Removing special comments</h3></div></div></div><p>Comments that <a id="id257" class="indexterm"/>should not be removed by the minification process are called special comments and can be indicated using the "<code class="literal">/*! comment */</code>" markers. By default, the <code class="literal">cssmin</code> task will leave all special comments untouched, but we can alter this behavior by making use of the <code class="literal">keepSpecialComments</code> option.</p><p>The <code class="literal">keepSpecialComments</code> option can be set to either the <code class="literal">*</code>, <code class="literal">1</code>, or <code class="literal">0</code> value. The <code class="literal">*</code> value is the default and indicates that all special comments should be kept, <code class="literal">1</code> indicates that only the first comment that is found should be kept, and <code class="literal">0</code> indicates that none of them should be kept. The following configuration will ensure that all comments are removed from our minified result:</p><div><pre class="programlisting">cssmin: { 
  dist: { 
    src: 'src/style.css', 
    dest: 'dist/style.min.css', 
    options: { 
      <strong>keepSpecialComments: 0 </strong>
    } 
  } 
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec85"/>Reporting on gzipped results</h3></div></div></div><p>Reporting <a id="id258" class="indexterm"/>is useful to see exactly how well the <code class="literal">cssmin</code> task has compressed our CSS files. By default, the size of the targeted file and minified result will be displayed, but if we'd also like to see the gzipped size of the result, we can set the <code class="literal">report</code> option to <code class="literal">gzip</code>, as shown in the following example:</p><div><pre class="programlisting">cssmin: {
  dist: {
    src: 'src/main.css',
    dest: 'dist/main.css',
    options: {
      <strong>report: 'gzip'</strong>
    }
  }
}</pre></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec63"/>Optimizing images</h1></div></div></div><p>In this<a id="id259" class="indexterm"/> recipe, we'll make use of the <code class="literal">contrib-imagemin (0.9.4)</code> plugin to decrease the size of images by compressing them as much as possible without compromising on their quality. This plugin also provides a plugin framework of its own, which is discussed at the end of this recipe.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec149"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec150"/>How to do it...</h2></div></div></div><p>The following steps take us through configuring a task that will compress an image for our project.</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by installing the package that contains the <code class="literal">contrib-imagemin</code> plugin as per the instructions provided in the <em>Installing a plugin</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>.</li><li class="listitem">Next, we can ensure that we have an image called <code class="literal">image.jpg</code> in the <code class="literal">src</code> directory on which we'd like to perform optimizations.<div><h3 class="title"><a id="tip65"/>Tip</h3><p>For the rest of this example, we'll make use of the sample image provided with the sample code that accompanies this recipe.</p></div></li><li class="listitem">Now, we'll add the following <code class="literal">imagemin</code> task to our configuration and indicate that we'd like to have the <code class="literal">src/image.jpg</code> file optimized, and have the result saved to the <code class="literal">dist/image.jpg</code> file:<div><pre class="programlisting">imagemin: {
  dist: {
    src: 'src/image.jpg',
    dest: 'dist/image.jpg'
  }
}</pre></div></li><li class="listitem">We can then run the task using the <code class="literal">grunt imagemin</code> command, which should produce the following output:<div><pre class="programlisting">
<strong>Running "imagemin:dist" (imagemin) task</strong>
<strong>Minified 1 image (saved 13.36 kB)</strong>
</pre></div></li><li class="listitem">If we now take a look at the <code class="literal">dist/image.jpg</code> file, we will see that its size has decreased without any impact on the quality.</li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec151"/>There's more...</h2></div></div></div><p>The <a id="id260" class="indexterm"/>
<code class="literal">imagemin</code> task <a id="id261" class="indexterm"/>provides us with several options that allow us to tweak its optimization features. We'll look at how to adjust the <strong>PNG</strong> compression level, disable the progressive <a id="id262" class="indexterm"/>
<strong>JPEG</strong> generation, disable the interlaced <strong>GIF</strong> generation, specify <strong>SVGO</strong> plugins to be used, and use the <code class="literal">imagemin</code> plugin framework.</p><div><div><div><div><h3 class="title"><a id="ch06lvl3sec86"/>Adjusting the PNG compression level</h3></div></div></div><p>The<a id="id263" class="indexterm"/> compression of a PNG image can be increased <a id="id264" class="indexterm"/>by running the compression algorithm on it multiple times. By default, the compression algorithm is run 16 times. This number can be changed by providing a number from <code class="literal">0</code> to <code class="literal">7</code> to the <code class="literal">optimizationLevel</code> option. The <code class="literal">0</code> value means that the compression is effectively disabled and <code class="literal">7</code> indicates that the algorithm should run 240 times. In the following configuration we set the compression level to its maximum:</p><div><pre class="programlisting">imagemin: {
  dist: {
    src: 'src/image.png',
    dest: 'dist/image.png',
    options: {
      <strong>optimizationLevel: 7</strong>
    }
  }
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec87"/>Disabling the progressive JPEG generation</h3></div></div></div><p>Progressive JPEGs <a id="id265" class="indexterm"/>are compressed in multiple passes, which allows a low-quality version of them to quickly become visible and increase in quality as the rest of the image is received. This is especially helpful when displaying images over a slower connection.</p><p>By default, the <code class="literal">imagemin</code> plugin will generate JPEG images in the progressive format, but this behavior can be disabled by setting the <code class="literal">progressive</code> option to <code class="literal">false</code>, as shown in the following example:</p><div><pre class="programlisting">imagemin: {
  dist: {
    src: 'src/image.jpg',
    dest: 'dist/image.jpg',
    options: {
      <strong>progressive: false</strong>
    }
  }
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec88"/>Disabling the interlaced GIF generation</h3></div></div></div><p>An<a id="id266" class="indexterm"/> interlaced GIF is the equivalent of a progressive JPEG in that it allows the contained image to be displayed at a lower resolution before it has been fully downloaded, and increases in quality as the rest of the image is received.</p><p>By default, the <code class="literal">imagemin</code> plugin will generate GIF images in the interlaced format, but this behavior can be disabled by setting the <code class="literal">interlaced</code> option to <code class="literal">false</code>, as shown in the following example:</p><div><pre class="programlisting">imagemin: {
  dist: {
    src: 'src/image.gif',
    dest: 'dist/image.gif',
    options: {
      <strong>interlaced: false</strong>
    }
  }
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec89"/>Specifying SVGO plugins to be used</h3></div></div></div><p>When<a id="id267" class="indexterm"/> optimizing SVG images, the SVGO library is used by default. This allows us to specify the use of various plugins provided by the SVGO library that each performs a specific function on the targeted files.</p><div><h3 class="title"><a id="tip66"/>Tip</h3><p>Refer to the following URL for more detailed instructions on how to<a id="id268" class="indexterm"/> use the svgo plugins options and the SVGO library:</p><p><a class="ulink" href="https://github.com/sindresorhus/grunt-svgmin#available-optionsplugins">https://github.com/sindresorhus/grunt-svgmin#available-optionsplugins</a></p></div><p>Most of the plugins in the library are enabled by default, but if we'd like to specifically indicate which of these should be used, we can do so using the <code class="literal">svgoPlugins</code> option. Here, we can provide an array of objects, where each contain a property with the name of the plugin to be affected, followed by a <code class="literal">true</code> or <code class="literal">false</code> value to indicate whether it should be activated. The following configuration disables three of the default plugins:</p><div><pre class="programlisting"> imagemin: {
  dist: {
    src: 'src/image.svg',
    dest: 'dist/image.svg',
    options: {
      svgoPlugins: [
        <strong>{removeViewBox:false},</strong>
<strong>        {removeUselessStrokeAndFill:false},</strong>
<strong>        {removeEmptyAttrs:false}</strong>
      ]
    }
  }
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec90"/>Using the 'imagemin' plugin framework</h3></div></div></div><p>In order to <a id="id269" class="indexterm"/>provide support for the various image optimization projects, the <code class="literal">imagemin</code> plugin <a id="id270" class="indexterm"/>has a plugin framework of its own that allows developers to easily create an extension that makes use of the tool they require.</p><div><h3 class="title"><a id="tip67"/>Tip</h3><p>You can get a list of the available plugin modules for the<a id="id271" class="indexterm"/> <code class="literal">imagemin</code> plugin's framework at the following URL:</p><p><a class="ulink" href="https://www.npmjs.com/browse/keyword/imageminplugin">https://www.npmjs.com/browse/keyword/imageminplugin</a></p></div><p>The following steps will <a id="id272" class="indexterm"/>take us through installing and making use of the <code class="literal">mozjpeg</code> plugin to compress an image in our project. These steps start where the main recipe takes off.</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by installing the <code class="literal">imagemin-mozjpeg</code> package using the <code class="literal">npm install imagemin-mozjpeg</code> command, which should produce the following output:<div><pre class="programlisting">
<strong>imagemin-mozjpeg@4.0.0 node_modules/imagemin-mozjpeg</strong>
</pre></div></li><li class="listitem">With the package installed, we need to import it into our configuration file, so that we can make use of it in our task configuration. We do this by adding the following line at the top of our <code class="literal">Gruntfile.js</code> file:<div><pre class="programlisting">var mozjpeg = require('imagemin-mozjpeg');</pre></div></li><li class="listitem">With the plugin installed and imported, we can now change the configuration of our <code class="literal">imagemin</code> task by adding the <code class="literal">use</code> option and providing it with the initialized plugin:<div><pre class="programlisting">imagemin: {
  dist: {
    src: 'src/image.jpg',
    dest: 'dist/image.jpg',
    options: {
      <strong>use: [mozjpeg()]</strong>
    }
  }
}</pre></div></li><li class="listitem">Finally, we <a id="id273" class="indexterm"/>can test our setup by <a id="id274" class="indexterm"/>running the task using the <code class="literal">grunt imagemin</code> command. This should produce an output similar to the following:<div><pre class="programlisting">
<strong>Running "imagemin:dist" (imagemin) task</strong>
<strong>Minified 1 image (saved 9.88 kB)</strong>
</pre></div></li></ol><div></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec64"/>Linting JavaScript code</h1></div></div></div><p>In this<a id="id275" class="indexterm"/> recipe, we'll make use of the <code class="literal">contrib-jshint (0.11.1)</code> plugin to detect errors and potential problems in our JavaScript code. It is also commonly used to enforce code conventions within a team or project. As can be derived from its name, it's basically a Grunt adaptation for the JSHint tool.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec152"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec153"/>How to do it...</h2></div></div></div><p>The following steps take us through creating a sample JavaScript file and configuring a task that will scan and analyze it using the JSHint tool.</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by installing the package that contains the <code class="literal">contrib-jshint</code> plugin as per the instructions provided in the <em>Installing a plugin</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>.</li><li class="listitem">Next, we'll create a sample JavaScript file called <code class="literal">main.js</code> in the <code class="literal">src</code> directory, and add the following content in it:<div><pre class="programlisting">sample = 'abc';
console.log(sample);</pre></div></li><li class="listitem">With our sample file ready, we can now add the following <code class="literal">jshint</code> task to our configuration. We'll configure this task to target the sample file and also add a basic option that we require for this example:<div><pre class="programlisting">jshint: {
  main: {
    options: {
      undef: true
    },
    src: ['src/main.js']
  }
}</pre></div><div><h3 class="title"><a id="tip68"/>Tip</h3><p>The <code class="literal">undef</code> option<a id="id276" class="indexterm"/> is a standard JSHint option used specifically for this example and is not required for this plugin to function. Specifying this option indicates that we'd like to have errors raised for variables that are used without being explicitly defined.</p></div></li><li class="listitem">We <a id="id277" class="indexterm"/>can now run the task using the <code class="literal">grunt jshint</code> command, which should produce output informing us of the problems found in our sample file:<div><pre class="programlisting">
<strong>Running "jshint:main" (jshint) task</strong>

<strong>   src/main.js</strong>
<strong>      1 |sample = 'abc';</strong>
<strong>         ^ 'sample' is not defined.</strong>
<strong>      2 |console.log(sample);</strong>
<strong>         ^ 'console' is not defined.</strong>
<strong>      2 |console.log(sample);</strong>
<strong>                     ^ 'sample' is not defined.</strong>

<strong>&gt;&gt; 3 errors in 1 file</strong>
</pre></div></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec154"/>There's more...</h2></div></div></div><p>The <code class="literal">jshint</code> task<a id="id278" class="indexterm"/> provides us with several options that allow us to change its general behavior, in addition to how it analyzes the targeted code. We'll look at how to specify standard JSHint options, specify globally defined variables, send reported output to a file, and prevent task failure on JSHint errors.</p><div><div><div><div><h3 class="title"><a id="ch06lvl3sec91"/>Specifying standard JSHint options</h3></div></div></div><p>The<a id="id279" class="indexterm"/> <code class="literal">contrib-jshint</code> plugin provides a simple way to pass all the standard JSHint options from the task's options object to the underlying JSHint tool.</p><div><h3 class="title"><a id="tip69"/>Tip</h3><p>A list of all the options provided by the JSHint tool<a id="id280" class="indexterm"/> can be found at the following URL:</p><p><a class="ulink" href="http://jshint.com/docs/options/">http://jshint.com/docs/options/</a></p></div><p>The following example adds the <code class="literal">curly</code> option to the task we created in our main recipe to enforce the use of curly braces wherever they are appropriate:</p><div><pre class="programlisting">jshint: {
  main: {
    options: {
      undef: true,
      <strong>curly: true</strong>
    },
    src: ['src/main.js']
  }
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec92"/>Specifying globally defined variables</h3></div></div></div><p>Making<a id="id281" class="indexterm"/> use of globally defined variables is quite common when working with JavaScript, which is where the <code class="literal">globals</code> option comes in handy. Using this option, we can define a set of global values that we'll use in the targeted code, so that errors aren't raised when JSHint encounters them.</p><p>In the following example, we indicate that the <code class="literal">console</code> variable should be treated as a global, and not raise errors when encountered:</p><div><pre class="programlisting">jshint: {
  main: {
    options: {
      undef: true,
      <strong>globals: {</strong>
<strong>        console: true</strong>
<strong>      }</strong>
    },
    src: ['src/main.js']
  }
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec93"/>Sending reported output to a file</h3></div></div></div><p>If we'd like to <a id="id282" class="indexterm"/>store the resulting output from our JSHint analysis, we can do so by specifying a path to a file that should receive it using the <code class="literal">reporterOutput</code> option, as shown in the following example:</p><div><pre class="programlisting">jshint: {
  main: {
    options: {
      undef: true,
      <strong>reporterOutput: 'report.dat'</strong>
    },
    src: ['src/main.js']
  }
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec94"/>Preventing task failure on JSHint errors</h3></div></div></div><p>The <a id="id283" class="indexterm"/>default behavior for the <code class="literal">jshint</code> task is to exit the running Grunt process once a JSHint error is encountered in any of the targeted files. This behavior becomes especially undesirable if you'd like to keep watching files for changes, even when an error has been raised.</p><p>In the following example, we indicate that we'd like to keep the process running when errors are encountered by giving the <code class="literal">force</code> option a <code class="literal">true</code> value:</p><div><pre class="programlisting">jshint: {
  main: {
    options: {
      undef: true,
      <strong>force: true</strong>
    },
    src: ['src/main.js']
  }
}</pre></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec65"/>Uglifying JavaScript Code</h1></div></div></div><p>In this recipe, we'll<a id="id284" class="indexterm"/> make use of the <code class="literal">contrib-uglify (0.8.0)</code> plugin to compress and mangle some files containing JavaScript code.</p><p>For the most part, the process of uglifying just removes all the unnecessary characters and shortens variable names in a source code file. This has the potential to dramatically reduce the size of the file, slightly increase performance, and make the inner workings of your publicly available code a little more obscure.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec155"/>Getting ready</h2></div></div></div><p>In this <a id="id285" class="indexterm"/>example, we'll work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec156"/>How to do it...</h2></div></div></div><p>The following steps take us through creating a sample JavaScript file and configuring a task that will uglify it.</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by installing the package that contains the <code class="literal">contrib-uglify</code> plugin as per the instructions provided in the <em>Installing a plugin</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>.</li><li class="listitem">Then, we can create a sample JavaScript file called <code class="literal">main.js</code> in the <code class="literal">src</code> directory, which we'd like to uglify, and provide it with the following contents:<div><pre class="programlisting">var main = function () {
  var one = 'Hello' + ' ';
  var two = 'World';

  var result = one + two;

  console.log(result);
};</pre></div></li><li class="listitem">With our sample file ready, we can now add the following <code class="literal">uglify</code> task to our configuration, indicating the sample file as the target and providing a destination output file:<div><pre class="programlisting">uglify: {
  main: {
    src: 'src/main.js',
    dest: 'dist/main.js'
  }
}</pre></div></li><li class="listitem">We can now run the task using the <code class="literal">grunt uglify</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "uglify:main" (uglify) task</strong>
<strong>&gt;&gt; 1 file created.</strong>
</pre></div></li><li class="listitem">If we now take a look at the resulting <code class="literal">dist/main.js</code> file, we should see that it contains the uglified <a id="id286" class="indexterm"/>contents of the original <code class="literal">src/main.js</code> file.</li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec157"/>There's more...</h2></div></div></div><p>The <code class="literal">uglify</code> task<a id="id287" class="indexterm"/> provides us with several options that allow us to change its general behavior and see how it uglifies the targeted code. We'll look at specifying standard UglifyJS options, generating source maps, and wrapping generated code in an enclosure.</p><div><div><div><div><h3 class="title"><a id="ch06lvl3sec95"/>Specifying standard UglifyJS options</h3></div></div></div><p>The<a id="id288" class="indexterm"/> underlying UglifyJS tool can provide a set of options for each of its separate functional parts. These parts are the mangler, compressor, and beautifier. The <code class="literal">contrib-plugin</code> allows passing options to each of these parts using the <code class="literal">mangle</code>, <code class="literal">compress</code>, and <code class="literal">beautify</code> options.</p><div><h3 class="title"><a id="tip70"/>Tip</h3><p>The available options for each of the mangler, compressor, and beautifier parts can be found at each of following URLs (listed in the order mentioned):</p><p><a class="ulink" href="https://github.com/mishoo/UglifyJS2#mangler-options">https://github.com/mishoo/UglifyJS2#mangler-options</a></p><p><a class="ulink" href="https://github.com/mishoo/UglifyJS2#compressor-options">https://github.com/mishoo/UglifyJS2#compressor-options</a></p><p><a class="ulink" href="https://github.com/mishoo/UglifyJS2#beautifier-options">https://github.com/mishoo/UglifyJS2#beautifier-options</a></p></div><p>The following example alters the configuration of the main recipe to provide a single option to each of these parts:</p><div><pre class="programlisting">uglify: {
  main: {
    src: 'src/main.js',
    dest: 'dist/main.js',
    options: {
<strong>      mangle: {</strong>
<strong>        toplevel: true</strong>
<strong>      },</strong>
<strong>      compress: {</strong>
<strong>        evaluate: false</strong>
<strong>      },</strong>
<strong>      beautify: {</strong>
<strong>        semicolons: false</strong>
<strong>      }</strong>
    }
  }
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec96"/>Generating source maps</h3></div></div></div><p>As code <a id="id289" class="indexterm"/>gets mangled and compressed, it becomes effectively unreadable to humans, and therefore, nearly impossible to debug. For this reason, we are provided with the option of generating a source map when uglifying our code.</p><p>The following example makes use of the <code class="literal">sourceMap</code> option to indicate that we'd like to have a source map generated along with our uglified code:</p><div><pre class="programlisting">uglify: {
  main: {
    src: 'src/main.js',
    dest: 'dist/main.js',
    options: {
      <strong>sourceMap: true</strong>
    }
  }
}</pre></div><p>Running the altered task will now, in addition to the <code class="literal">dist/main.js</code> file with our uglified source, generate a source map file called <code class="literal">main.js.map</code> in the same directory as the uglified file.</p></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec97"/>Wrapping generated code in an enclosure</h3></div></div></div><p>When <a id="id290" class="indexterm"/>building your own JavaScript code modules, it's usually a good idea to have them wrapped in a wrapper function to ensure that you don't pollute the global scope with variables that you won't be using outside of the module itself.</p><p>For this purpose, we can use the <code class="literal">wrap</code> option to indicate that we'd like to have the resulting uglified code wrapped in a wrapper function, as shown in the following example:</p><div><pre class="programlisting">uglify: {
  main: {
    src: 'src/main.js',
    dest: 'dist/main.js',
    options: {
<strong>      wrap: true</strong>
    }
  }
}</pre></div><p>If we now take a look at the result <code class="literal">dist/main.js</code> file, we should see that all the uglified contents of the <a id="id291" class="indexterm"/>original file are now contained within a wrapper function.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec66"/>Setting up RequireJS</h1></div></div></div><p>In this <a id="id292" class="indexterm"/>recipe, we'll make use of the <code class="literal">contrib-requirejs (0.4.4)</code> plugin to package the modularized source code of our web application into a single file.</p><p>For the most part, this plugin just provides a wrapper for the <strong>RequireJS</strong> tool. RequireJS provides a framework to modularize JavaScript source code and consume those modules in an orderly fashion. It also allows packaging an entire application into one file and importing only the modules that are required while keeping the module structure intact.</p><div><h3 class="title"><a id="tip71"/>Tip</h3><p>To see the packaged application created in this recipe in action, please refer to the sample code provided for this recipe. It includes a basic development server setup as per the <em>Setting up a basic web server</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em> along with the required libraries and a sample <code class="literal">index.html</code> file that consumes the generated application bundle file.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec158"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec159"/>How to do it...</h2></div></div></div><p>The following steps take us through creating some files for a sample application and setting up a task that bundles them into one file.</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by installing the package that contains the <code class="literal">contrib-requirejs</code> plugin as per the instructions provided in the <em>Installing a plugin</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>.</li><li class="listitem">First, we'll need a file that will contain our RequireJS configuration. Let's create a file called <code class="literal">config.js</code> in the <code class="literal">src</code> directory and add the following content in it:<div><pre class="programlisting">require.config({
  baseUrl: 'app'
});</pre></div></li><li class="listitem">Secondly, we'll create a sample module that we'd like to use in our application. Let's create a file called <code class="literal">sample.j</code>s in the <code class="literal">src/app</code> directory and add the following content in it:<div><pre class="programlisting">define(function (require) {
  return function () {
    console.log('Sample Module');
  }
});</pre></div></li><li class="listitem">Lastly, we'll <a id="id293" class="indexterm"/>need a file that will contain the main entry point for our application, and also makes use of our sample module. Let's create a file called <code class="literal">main.js</code> in the <code class="literal">src/app</code> directory and add the following content in it:<div><pre class="programlisting">require(['sample'], function (sample) {
  sample();
});</pre></div></li><li class="listitem">Now that we've got all the necessary files required for our sample application, we can setup a <code class="literal">requirejs</code> task that will bundle it all into one file:<div><pre class="programlisting">requirejs: {
  app: {
    options: {
      mainConfigFile: 'src/config.js',
      name: 'main',
      out: 'www/js/app.js'
    }
  }
}</pre></div><div><h3 class="title"><a id="tip72"/>Tip</h3><p>The <code class="literal">mainConfigFile</code> option points out the configuration file that will determine the behavior of RequireJS.</p><p>The <code class="literal">name</code> option indicates the name of the module that contains the application entry point. In the case of this example, our application entry point is contained in the <code class="literal">app/main.js</code> file, and <code class="literal">app</code> is the base directory of our application in the <code class="literal">src/config.js</code> file. This translates the <code class="literal">app/main.js</code> filename into the <code class="literal">main</code> module name.</p><p>The <code class="literal">out</code> option is used to indicate the file that should receive the result of the bundled application.</p></div></li><li class="listitem">We can now run the task using the <code class="literal">grunt requirejs</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "requirejs:app" (requirejs) task</strong>
</pre></div></li><li class="listitem">We should <a id="id294" class="indexterm"/>now have a file named <code class="literal">app.js</code> in the <code class="literal">www/js</code> directory that contains our entire sample application.</li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec160"/>There's more...</h2></div></div></div><p>The <code class="literal">requirejs</code> task<a id="id295" class="indexterm"/> provides us with all the underlying options provided by the RequireJS tool. We'll look at how to use these exposed options and generate a source map.</p><div><div><div><div><h3 class="title"><a id="ch06lvl3sec98"/>Using RequireJS optimizer options</h3></div></div></div><p>The <a id="id296" class="indexterm"/>RequireJS optimizer is quite an intricate tool, and therefore, provides a large number of options to tweak its behavior. The <code class="literal">contrib-requirejs</code> plugin allows us to easily set any of these options by just specifying them as options of the plugin itself.</p><div><h3 class="title"><a id="tip73"/>Tip</h3><p>A list of all the available configuration options for the <a id="id297" class="indexterm"/>RequireJS build system can be found in the example configuration file at the following URL:</p><p><a class="ulink" href="https://github.com/jrburke/r.js/blob/master/build/example.build.js">https://github.com/jrburke/r.js/blob/master/build/example.build.js</a></p></div><p>The following example indicates that the <strong>UglifyJS2</strong> optimizer<a id="id298" class="indexterm"/> should be used instead of the default <strong>UglifyJS</strong> optimizer<a id="id299" class="indexterm"/> by using the <code class="literal">optimize</code> option:</p><div><pre class="programlisting">requirejs: {
  app: {
    options: {
      mainConfigFile: 'src/config.js',
      name: 'main',
      out: 'www/js/app.js',
      <strong>optimize: 'uglify2'</strong>
    }
  }
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec99"/>Generating a source map</h3></div></div></div><p>When<a id="id300" class="indexterm"/> the source code is bundled into one file, it becomes somewhat harder to debug, as you now have to trawl through miles of code to get to the point you're actually interested in.</p><p>A source map can help us with this issue by relating the resulting bundled file to the modularized structure it is derived from. Simply put, with a source map, our debugger will display the separate files we had before, even though we're actually using the bundled file.</p><p>The following example makes use of the <code class="literal">generateSourceMap</code> option to indicate that we'd like to generate a source map along with the resulting file:</p><div><pre class="programlisting">requirejs: {
  app: {
    options: {
      mainConfigFile: 'src/config.js',
      name: 'main',
      out: 'www/js/app.js',
      optimize: 'uglify2',
      preserveLicenseComments: false,
      <strong>generateSourceMaps: true</strong>
    }
  }
}</pre></div><div><h3 class="title"><a id="tip74"/>Tip</h3><p>In order to use the <code class="literal">generateSourceMap</code> option, we have to indicate that UglifyJS2 is to be used for optimization, by setting the <code class="literal">optimize</code> option to <code class="literal">uglify2</code>, and that license comments should not be preserved, by setting the <code class="literal">preserveLicenseComments</code> option to <code class="literal">false</code>.</p></div></div></div></div></body></html>