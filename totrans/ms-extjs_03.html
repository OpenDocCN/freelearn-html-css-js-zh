<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch03"/>Chapter 3. The Login Page</h1></div></div></div><p>It is very common to have a login page<a id="id180" class="indexterm"/> for an application of which we want to control the access to the system by identifying and authenticating the user through the credentials presented by the user. Once the user is logged in, we can track the actions performed by the user. We can also restrain access to some features and screens of the system that we do not want a particular user to have access to or even a specific group of users.</p><p>In this chapter, we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating the login page</li><li class="listitem" style="list-style-type: disc">Handling the login page on the server</li><li class="listitem" style="list-style-type: disc">Adding the Caps Lock warning message in the <strong>Password</strong> field</li><li class="listitem" style="list-style-type: disc">Submitting the form when pressing the <em>Enter</em> key</li><li class="listitem" style="list-style-type: disc">Encrypting the password before sending to the server</li></ul></div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec17"/>The Login screen</h1></div></div></div><p>The<a id="id181" class="indexterm"/> <strong>Login</strong> window will be the first view that we are going to implement in this project. We are going to build it step-by-step, as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The user will enter the username and password to log in</li><li class="listitem" style="list-style-type: disc">Client-side validation (username and password required to log in)</li><li class="listitem" style="list-style-type: disc">Submit the login form by pressing <em>Enter</em></li><li class="listitem" style="list-style-type: disc">Encrypt the password before sending to the server</li><li class="listitem" style="list-style-type: disc">Password Caps Lock warning (similar to Windows OS)</li><li class="listitem" style="list-style-type: disc">Multilingual capability</li></ul></div><p>Except for the multilingual capability, which we are going to implement in the next chapter, we will implement all the other features throughout this topic. So at the end of the implementation, we<a id="id182" class="indexterm"/> will have a <strong>Login</strong> window that looks as follows:</p><div><img src="img/0457OT_03_01.jpg" alt="The Login screen"/></div><p>So let's get started!</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec18"/>Creating the Login screen</h1></div></div></div><p>Under<a id="id183" class="indexterm"/> the <code class="literal">app/view</code> directory, we will create a new folder to organize all the source code related to the <strong>Login</strong> screen named <code class="literal">login</code>. Inside the <code class="literal">login</code> folder, we will also create a new file named <code class="literal">Login.js</code>. In this file, we will implement all the code that the user is going to see on the screen.</p><p>Inside <code class="literal">view/login/Login.js</code>, we will implement the following code:</p><div><pre class="programlisting">Ext.define('Packt.view.login.Login', { // #1
    extend: 'Ext.window.Window',       // #2

    xtype: 'login-dialog',             // #3

    autoShow: true,                    // #4
    height: 170,                       // #5
    width: 360,                        
    layout: {
        type: 'fit'                    // #7
    },
    iconCls: 'fa fa-key fa-lg',        // #8
    title: 'Login',                    // #9
    closeAction: 'hide',               // #10
    closable: false,                   // #11
    draggable: false,                  // #12
    resizable: false                   // #13
});</pre></div><p>On the first line (<code class="literal">#1</code>), we have the definition of the class. To define a class, we use <code class="literal">Ext.define</code>, which (<code class="literal">define</code>) is a method call of the <code class="literal">Ext</code> singleton class, and which takes two arguments: the class name (<code class="literal">#1</code>) and the object literal with the configuration of the class (<code class="literal">#2</code>–<code class="literal">#13</code>).</p><p>We also need to pay attention to the name of the class. This is the formula suggested by Sencha in Ext JS MVC projects: <em>App Namespace + package name + name of the JS file</em>. In the previous chapter, we defined the namespace as <code class="literal">Packt</code> (the name of the application we passed as parameter for the <code class="literal">sencha generate app</code> command). If we open an existing file that was created by Sencha Cmd (the <code class="literal">app/view/main/Main.js</code> file) for example, we will note that the name of the class starts with <code class="literal">Packt</code>. So all the classes we are going to create through out this book will start with the namespace <code class="literal">Packt</code>.</p><p>We are creating<a id="id184" class="indexterm"/> a View for this project, so we will create the JS file under the <code class="literal">view</code> folder. For organization purposes, we created a subfolder named <code class="literal">login</code>. And then, the name of the file we created is <code class="literal">Login.js</code>; therefore, we will lose the <code class="literal">.js</code> and use only <code class="literal">Login</code> as the name of the View. Putting it all together, we have <code class="literal">Packt.view.login.Login</code>, and this will be the name of our class. It is very important that the class name follows the directory layout as explained; otherwise, we can get an error in the code saying Ext JS did not find the class. The following screenshot shows the dependency between the project directory layout and the class name:</p><div><img src="img/0457OT_03_20.jpg" alt="Creating the Login screen"/></div><p>Then, we say that the <code class="literal">login</code> class will extend from the <code class="literal">Window</code> class (<code class="literal">#2</code>). Recapitulating what we have covered in <a class="link" href="ch01.html" title="Chapter 1. Sencha Ext JS Overview">Chapter 1</a>, <em>Sencha Ext JS Overview</em>, we can use inheritance in Ext JS. The <code class="literal">login</code> class will inherit the behavior from the <code class="literal">Window</code> class (it is a subclass of the <code class="literal">Component</code> class). The <code class="literal">window</code> component represents a pop up that is rendered centralized in the browser.</p><div><div><h3 class="title"><a id="tip07"/>Tip</h3><p>For more information about the<a id="id185" class="indexterm"/> window component, please access <a class="ulink" href="http://docs.sencha.com/extjs/5.0.0/apidocs/#!/api/Ext.window.Window">http://docs.sencha.com/extjs/5.0.0/apidocs/#!/api/Ext.window.Window</a>. And for more details on inheritance, please read <a class="ulink" href="http://goo.gl/v4bmq8">http://goo.gl/v4bmq8</a>.</p></div></div><p>We also assign this class: <code class="literal">xtype</code> (<code class="literal">#3</code>). The <code class="literal">xtype</code> class is a shorter name that can be used to instantiate the class instead of using its full name. We can also use the configuration <code class="literal">alias</code> instead of <code class="literal">xtype</code>.</p><p>The <code class="literal">alias</code> for<a id="id186" class="indexterm"/> a class that extends from a component always starts with <code class="literal">widget</code>, followed by the <code class="literal">alias</code> or <code class="literal">xtype</code> class we want to assign. If we want to use the <code class="literal">alias</code> configuration instead of <code class="literal">xtype</code>, we could use <code class="literal">alias: 'widget.login-dialog'</code> instead of <code class="literal">xtype: 'login-dialog'</code>. The result will be the same; it is just a matter of personal preference.</p><p>The naming convention for <code class="literal">xtype</code> and <code class="literal">alias</code> is lowercase. It is also important to remember that the alias must be unique in an application. In this case, we want to assign the <code class="literal">xtype</code> class <code class="literal">login</code> to this class so that later we can instantiate this same class using its <code class="literal">alias</code> (which is the same as <code class="literal">xtype</code>). For example, we can instantiate the <code class="literal">Login</code> class in five different ways:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Option 1: Using the complete name of the class, which is the most used method:<div><pre class="programlisting">Ext.create('Packt.view.login.Login');</pre></div></li><li class="listitem" style="list-style-type: disc">Option 2: Using <code class="literal">alias</code> in the <code class="literal">Ext.create</code> method:<div><pre class="programlisting">Ext.create('widget.login-dialog');</pre></div></li><li class="listitem" style="list-style-type: disc">Option 3: Using <code class="literal">Ext.widget</code>, which is shorthand for <code class="literal">Ext.ClassManager.instantiateByAlias</code>:<div><pre class="programlisting">Ext.widget('login-dialog');</pre></div></li><li class="listitem" style="list-style-type: disc">Option 4: Using <code class="literal">xtype</code> as an item of another component:<div><pre class="programlisting">items: [
  {
    xtype: 'login-dialog'
  }
]</pre></div></li><li class="listitem" style="list-style-type: disc">Option 5: Using the <code class="literal">new</code> keyword:<div><pre class="programlisting">new Packt.view.login.Login();</pre></div></li></ul></div><p>In this book, we will use the options 1, 3, and 4 the most. Options 1, 2, 3, and 5 return a reference to the instantiated component.</p><p>Option number 5 is not a good practice. Although options 4 and 5 were the only way to instantiate classes until Ext JS 3, the other options were introduced in Ext JS 4, and option 5 became deprecated.</p><div><div><h3 class="title"><a id="tip08"/>Tip</h3><p>Although option 5 became deprecated with Ext JS 4 and later versions, we can still find some code in the Ext JS documentation and official Ext JS examples that use the <code class="literal">new</code> keyword. But do not get confused because of it. Option 5 should be avoided, always!</p></div></div><p>Then we have the <code class="literal">autoShow</code> configured to <code class="literal">true</code> (<code class="literal">#4</code>). Consider the following line of code:</p><div><pre class="programlisting">Ext.create('Packt.view.login.Login');</pre></div><p>When we execute <a id="id187" class="indexterm"/>the preceding code, an instance of the <code class="literal">Login</code> class will be created (and if we need to, we can store this reference in a variable to manipulate it later). As the <code class="literal">Login</code> class is a subclass of the <code class="literal">Window</code> class, it inherits all its behavior, and one if its behaviors is that the window is not displayed automatically when instantiated. If we want to display the <code class="literal">Window</code> class (or any of its subclasses in the application), we need to call the <code class="literal">show()</code> method manually, as follows:</p><div><pre class="programlisting">Ext.create('Packt.view.login.Login').show();</pre></div><p>An alternative to the preceding code is to have the <code class="literal">autoShow</code> configuration set to <code class="literal">true</code>. This way the <code class="literal">Window</code> class (or the <code class="literal">login</code> class in our case) will be automatically displayed when we instantiate it.</p><p>We also have the <code class="literal">height</code> (<code class="literal">#5</code>) and <code class="literal">width</code> (<code class="literal">#6</code>) of the window.</p><p>We set <code class="literal">layout</code> as <code class="literal">fit</code> (<code class="literal">#7</code>). Recapitulating, the <code class="literal">fit</code> layout is used when the parent container (in this case, <code class="literal">Login</code>) has only one child, and this child will occupy all the available space of the parent container. As our <strong>Login</strong> window will have two fields inside it (username and password), these two fields need to be placed inside the <code class="literal">form</code> subclass . In this case, the <code class="literal">form</code> subclass will be the child of the <code class="literal">Login</code> class.</p><p>We are setting <code class="literal">iconCls</code> (<code class="literal">#8</code>) to the <strong>Login</strong> window; this way, we will have an icon of a key in the header of the window (we will set up the icons later in this chapter). We can also give a <code class="literal">title</code> to the window (<code class="literal">#9</code>), and in this case, we chose <code class="literal">Login</code>.</p><p>There are also the <code class="literal">closeAction</code> (<code class="literal">#10</code>) and <code class="literal">closable</code> (<code class="literal">#11</code>) configurations. The <code class="literal">closeAction</code> will tell if we want to destroy the window when we close it. In this case, we do not want to destroy it; we only want to hide it. And the <code class="literal">closable</code> configuration tells us whether we want to display the <em>X</em> icon on the top-right corner of the window. As this is a <strong>Login</strong> window, we do not want to give this option for the user (the user can only try to submit the username and password to log in to the application).</p><div><div><h3 class="title"><a id="note22"/>Note</h3><p>What is the difference between the methods <code class="literal">close</code>, <code class="literal">hide</code>, and <code class="literal">destroy</code>? The <code class="literal">close</code> method closes the panel, and by default, this method removes it from the DOM and destroys the panel object and all its descendant components. The <code class="literal">hide</code> method hides the component, setting it to invisible (it can be made visible again by calling the <code class="literal">show</code> method). And the <code class="literal">destroy</code> method cleans up the object and its resources, but removes it from the DOM and frees the object so that it can be cleaned by the garbage collector.</p></div></div><p>We also have the <code class="literal">draggable</code> (<code class="literal">#12</code>) and <code class="literal">resizable</code> (<code class="literal">#13</code>) configurations. The <code class="literal">draggable</code> configuration controls whether the component can be <code class="literal">draggable</code> throughout the browser space. When the <code class="literal">resizable</code> configuration is set to <code class="literal">true</code> (its default value), the user can scroll over the corner of the component and resize it.</p><p>So far, this is<a id="id188" class="indexterm"/> the output we have—a single window with a blank icon in the top-left corner with the title <strong>Login</strong> (we will set up all the icons later in this chapter):</p><div><img src="img/0457OT_03_02.jpg" alt="Creating the Login screen"/></div><p>The next step is to add the <code class="literal">form</code> with the <code class="literal">username</code> and <code class="literal">password</code> fields. We are going to add the following code to the <code class="literal">Login</code> class (after line <code class="literal">#13</code>):</p><div><pre class="programlisting">items: [
{
    xtype: 'form',          //#14
    bodyPadding: 15,        //#15
    defaults: {             //#16
        xtype: 'textfield', //#17
        anchor: '100%',     //#18
        labelWidth: 60      //#19
    },
    items: [
        {
            name: 'user',
            fieldLabel: 'User'
        },
        {
            inputType: 'password', //#20
            name: 'password',
            fieldLabel: 'Password'
        }
    ]
]</pre></div><p>As we are using the <code class="literal">fit</code> layout, we can only declare one child <code class="literal">item</code> inside the <code class="literal">Login</code> class. So we are going to add a <code class="literal">form</code> (<code class="literal">#14</code>) inside the <code class="literal">Login</code> class. Note that here we are using option 4 presented earlier. When declaring items in Ext JS, this is usually the way we instantiate the components (using option 4). We added a body <code class="literal">padding</code> to the <code class="literal">form</code> body (<code class="literal">#15</code>), which is going to add a space between the form and the window border, making it look prettier.</p><p>As we are going to add <a id="id189" class="indexterm"/>two fields to the form, we probably want to avoid repeating some code. That is why we are going to declare some field configurations inside the <code class="literal">defaults</code> configuration of the <code class="literal">form</code> (<code class="literal">#16</code>); this way, the configuration we declare inside <code class="literal">defaults</code> will be applied to all items of the <code class="literal">form</code>, and we will need to declare only the configurations we want to customize. As we are going to declare two fields, both of them will be of the type <code class="literal">textfield</code> (<code class="literal">#17</code>).</p><p>The default layout used by the <code class="literal">form</code> component is the <code class="literal">anchor</code> layout, so we do not need to make this declaration explicit. However, we want both fields to occupy all the horizontal available space of the body of the form. That is why we are declaring the <code class="literal">anchor</code> as <code class="literal">100%</code> (<code class="literal">#18</code>).</p><p>While the <code class="literal">fit</code> layout allows you to render only one child component that will occupy all the available space within the parent container, the Anchor layout enables you to anchor child containers relative to the parent container dimensions. In this case, we want the text fields to occupy 100 percent of the horizontal space available in the form. If we wanted the text fields to occupy only 70 percent of the available horizontal space, we could set the <code class="literal">anchor</code> config to <code class="literal">70%</code>.</p><p>By default, the <code class="literal">width</code> attribute of the label of the <code class="literal">textfield</code> class is 100 pixels. This is too much space for a label <code class="literal">User</code> and <code class="literal">Password</code>, so we are going to decrease this value to <code class="literal">60 pixels</code> (<code class="literal">#19</code>).</p><p>And finally, we have the <code class="literal">user</code> <code class="literal">textfield</code> and the <code class="literal">password</code> <code class="literal">textfield</code>. The configuration <code class="literal">name</code> is what we are going to use to identify each field when we submit the form to the server.</p><p>There is only one detail missing: when the user types the password into the field, the system cannot display its value—we need to mask it somehow. That is why <code class="literal">inputType</code> is <code class="literal">'password'</code> (<code class="literal">#20</code>) for the <code class="literal">password</code> field because we want to display bullets instead of the original value—and the user will not be able to see the password value.</p><div><div><h3 class="title"><a id="note23"/>Note</h3><p>Other input types can be used with the <code class="literal">textfield</code> as well. Input types of HTML5, such as <code class="literal">email</code>, <code class="literal">url</code>, and <code class="literal">tel</code> can be used as well. However, if the application is being executed from an older browser (or a browser that does not support the input type), Ext JS automatically changes it to its default value, which is <code class="literal">text</code>. For more information about <a id="id190" class="indexterm"/>HTML5 input types and browsers that support each type, please visit <a class="ulink" href="http://www.w3schools.com/html/html5_form_input_types.asp">http://www.w3schools.com/html/html5_form_input_types.asp</a>.</p></div></div><p>Now we have <a id="id191" class="indexterm"/>improved our <strong>Login</strong> window a little more. This is the output so far:</p><div><img src="img/0457OT_03_03.jpg" alt="Creating the Login screen"/></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec32"/>Client-side validations</h2></div></div></div><p>The<a id="id192" class="indexterm"/> field component in Ext JS provides some client-side validation capability. This can save time and also bandwidth (the system will only make a server request when it is sure the information has the basic validation and we also do not need to wait for the server to validate the input). It also helps to point out to the user where they have gone wrong in filling out the form. Of course it is also good to validate<a id="id193" class="indexterm"/> the information again on the server side for security reasons, but for now we will focus on the validations we can apply to the form of our <strong>Login</strong> window.</p><p>Let's brainstorm some validations we can apply to the username and password fields:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">username</code> and <code class="literal">password</code> must be mandatory—how are you going to authenticate the user without a username and password?</li><li class="listitem" style="list-style-type: disc">The user can only enter alphanumeric characters (A-Z, a-z, and 0-9) in both fields</li><li class="listitem" style="list-style-type: disc">The user can only type between 3 and 25 chars on the <code class="literal">username</code> field</li><li class="listitem" style="list-style-type: disc">The user can only type between 3 and 15 chars on the <code class="literal">password</code> field</li></ul></div><p>So let's add into the code the ones that are common to both fields:</p><div><pre class="programlisting">allowBlank: false, // #21
vtype: 'alphanum', // #22
minLength: 3,      // #23
msgTarget: 'under' // #24</pre></div><p>We are going to<a id="id194" class="indexterm"/> add <a id="id195" class="indexterm"/>the preceding configurations inside the <code class="literal">defaults</code> configuration of the <code class="literal">form</code> as they all apply to both fields we have. First, both need to be mandatory (<code class="literal">#21</code>), second, we can only allow the user to enter alphanumeric characters (<code class="literal">#22</code>), and the minimum number of characters the user needs to input is three (<code class="literal">#23</code>). Then, a last common configuration is that we want to display any validation error message under the field (<code class="literal">#24</code>).</p><p>And the only validation customized for each field is that we can enter a maximum of 25 characters in the <strong>User</strong> field:</p><div><pre class="programlisting">name: 'user', 
fieldLabel: 'User',
<strong>maxLength: 25</strong>
</pre></div><p>And a maximum of 15 characters in the <strong>Password</strong> field:</p><div><pre class="programlisting">inputType: 'password', 
name: 'password',
fieldLabel: 'Password',
<strong>maxLength: 15</strong>
</pre></div><p>After we apply the client validations, we will have the following output just in case the user went wrong in filling out the <strong>Login</strong> window:</p><div><img src="img/0457OT_03_04.jpg" alt="Client-side validations"/></div><p>If you do not like the error message being displayed under the field, we can change the place where the error message appears. We just need to change the <code class="literal">msgTarget</code> value. The available options are: <code class="literal">title</code>, <code class="literal">under</code>, <code class="literal">side</code>, and <code class="literal">none</code>. We can also show the error message as a <code class="literal">tooltip</code> (<code class="literal">qtip</code>) or display them in a specific target (<code class="literal">innerHTML</code> of a specific component).</p><p>For the <code class="literal">side</code> option, for example, the <a id="id196" class="indexterm"/>red exclamation mark will be displayed on the side of the field, and<a id="id197" class="indexterm"/> when the user does a mouseover on it, the <code class="literal">tooltip</code> with the error message is displayed. Once the input is valid (the user enters more characters in the <strong>User</strong> field or deletes some characters from the <strong>Password</strong> field, the error message disappears automatically).</p><div><div><div><div><h3 class="title"><a id="ch03lvl3sec05"/>Creating custom VTypes</h3></div></div></div><p>Many systems have a special format for passwords. Let's <a id="id198" class="indexterm"/>say we need the password to have at least one digit (0-9), one letter lowercase, one letter uppercase, one special character (@,#,$,%, and so on) and its length between 6 and 20 characters.</p><p>We can create a regular expression to validate that the password is being entered into the app. And to do this, we can create a custom <code class="literal">VType</code> to do the validation for us. To create a custom <code class="literal">VType</code> is simple. For our case, we can create a custom <code class="literal">VType</code> called <code class="literal">customPass</code>, as follows:</p><div><pre class="programlisting">Ext.apply(Ext.form.field.VTypes, {
    customPass: function(val, field) {
        return /^((?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[@#$%]).{6,20})/.test(val);
    },
    customPassText: 'Not a valid password.  Length must be at least 6 characters and maximum of 20. Password must contain one digit, one letter lowercase, one letter uppercase, one special symbol @#$% and between 6 and 20 characters.'
});</pre></div><p>The name of our custom <code class="literal">VType</code> is <code class="literal">customPass</code>, and we need to declare a function that will validate our regular expression. And <code class="literal">customPassText</code> is the message that will be displayed to the user just in case the incorrect password format is entered.</p><div><div><h3 class="title"><a id="note24"/>Note</h3><p>To learn more about <a id="id199" class="indexterm"/>regular expressions, please visit <a class="ulink" href="http://www.regular-expressions.info/">http://www.regular-expressions.info/</a>.</p></div></div><p>The preceding code can be added anywhere in the code, inside the <code class="literal">init</code> function of a Controller, inside the <code class="literal">launch</code> function of <code class="literal">app.js</code>, or even in a separate JavaScript file (recommended) where you can put all your custom <code class="literal">Vtypes</code>.</p><div><div><h3 class="title"><a id="note25"/>Note</h3><p>The <code class="literal">VType</code><a id="id200" class="indexterm"/> is a singleton class that contains a set of commonly used field validation functions and provides a mechanism to create reusable custom field validations. For more information about this class and the default validations <a id="id201" class="indexterm"/>supported by Ext JS, please visit <a class="ulink" href="http://docs.sencha.com/extjs/5.1/5.1.0-apidocs/#!/api/Ext.form.field.VTypes">http://docs.sencha.com/extjs/5.1/5.1.0-apidocs/#!/api/Ext.form.field.VTypes</a>.</p></div></div><p>Create a new file named <code class="literal">CustomVTypes.js</code> under the <code class="literal">app</code> directory. Add the preceding code to this file. Now, we<a id="id202" class="indexterm"/> need this file to be loaded with our application as well. But hold your instincts to manually include this JavaScript file in the <code class="literal">index.html</code> file. We are going to follow best practices!</p><p>Locate the following code around line 110 of the <code class="literal">app.json</code> file inside the <code class="literal">masteringextjs</code> folder:</p><div><pre class="programlisting">"js": [
    {
        "path": "app.js",
        "bundle": true
    }
],</pre></div><p>To make our <code class="literal">CustomVTypes.js</code> file automatically load with our application, we simply need to add the following highlighted code:</p><div><pre class="programlisting">"js": [
    {
        "path": "app.js",
        "bundle": true
    }<strong>,</strong>
    <strong>{</strong>
<strong>        "path": "app/CustomVTypes.js",</strong>
<strong>        "includeInBundle": true</strong>
<strong>    }</strong>
], </pre></div><p>The <code class="literal">includeInBundle</code> configuration tells Sencha Cmd that this file needs to be added to the final <code class="literal">.js</code> file that is generated.</p><p>Only one file can have the <code class="literal">bundle: true</code> configuration. This means that it is the main file of the application.</p><div><div><h3 class="title"><a id="tip09"/>Tip</h3><p>Always remember to have the <code class="literal">sencha app watch</code> command running in a terminal window so that Sencha Cmd can make a new build every time we make changes to the code. In this case, <code class="literal">CustomVTypes.js</code> will be loaded without any further changes to the <code class="literal">index.html</code> file. Really cool!</p></div></div><p>Now, let's apply the custom <code class="literal">VType</code> to our code. Add the following code to the password field:</p><div><pre class="programlisting">vtype: 'customPass',
msgTarget: 'side'</pre></div><p>Also, change the message target for the password field. As the error message is quite long, it will not look nice <a id="id203" class="indexterm"/>with the message target <code class="literal">under</code>. This will be the result after we apply the custom <code class="literal">vType</code>:</p><div><img src="img/0457OT_03_05.jpg" alt="Creating custom VTypes"/></div></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec33"/>Adding the toolbar with buttons</h2></div></div></div><p>Until now, we <a id="id204" class="indexterm"/>created the <strong>Login</strong> window, which contains a form with two fields and it is already being validated as well. The only thing missing is to add the two buttons, <strong>Cancel</strong> and <strong>Submit</strong>.</p><p>We are <a id="id205" class="indexterm"/>going to add the buttons as items of a <code class="literal">toolbar</code>, and the <code class="literal">toolbar</code> will be added on the <code class="literal">form</code> as a docked item. The <code class="literal">dockedItems</code> can be docked to either the <em>top</em>, <em>right</em>, <em>left</em>, or <em>bottom</em> of a panel (both form and window components are subclasses of a panel). In this case, we will <code class="literal">dock</code> the <code class="literal">toolbar</code> at the bottom of the form. Add the following code right after the items configuration of the form:</p><div><pre class="programlisting">dockedItems: [
    {
        xtype: 'toolbar',
        dock: 'bottom',
        items: [
                xtype: 'tbfill' //#25
            },
            {
                xtype: 'button', //#26
                iconCls: 'fa fa-times fa-lg',
                text: 'Cancel'
            },
            { 
                xtype: 'button', //#27
                formBind: true,  //#28
                iconCls: 'fa fa-sign-in fa-lg',
                text: 'Submit'
            }
        ]
    }
]</pre></div><p>If we take a<a id="id206" class="indexterm"/> look back to the screenshot of the <strong>Login</strong> screen that we first presented at the beginning of this chapter, we will notice that there is a component for the translation/multilingual capability. And after this component, there<a id="id207" class="indexterm"/> is a space and then we have the <strong>Cancel</strong> and <strong>Submit</strong> buttons. As we do not have the multilingual component yet, we can only implement the two buttons, but they need to be at the right end of the form, and we need to leave that space. That is why we first need to add a <code class="literal">tbfill</code> component (<code class="literal">#25</code>), which is going to instruct the toolbar's layout to begin using the right-justified button container.</p><p>Then we will add the <strong>Cancel</strong> button (<code class="literal">#26</code>) and then the <strong>Submit</strong> button (<code class="literal">#27</code>). We are going to add an icon to both buttons (<code class="literal">iconCls</code>) that we will add to our CSS file later in this chapter.</p><p>We already have the client validations, but even with the validations, the user can click on the <strong>Submit</strong> button, and we want to avoid this behavior. That is why we are binding the <strong>Submit</strong> button to the form (<code class="literal">#28</code>); this way, the button will only be enabled if the form has no error from the client validation.</p><p>In the following screenshot, we can see the current output of the <strong>Login</strong> form (after we added the toolbar) and also verify the behavior of the <strong>Submit</strong> button:</p><div><img src="img/0457OT_03_06.jpg" alt="Adding the toolbar with buttons"/></div><div><div><h3 class="title"><a id="tip10"/>Tip</h3><p>When we want to add a toolbar with buttons in a form, we can add it using the configuration <code class="literal">buttons</code> as well. For more<a id="id208" class="indexterm"/> information, please access <a class="ulink" href="http://goo.gl/X38h8Q">http://goo.gl/X38h8Q</a>.</p></div></div><div><div><div><div><h3 class="title"><a id="ch03lvl3sec06"/>Running the code</h3></div></div></div><p>To <a id="id209" class="indexterm"/>execute the code we have created so far, we need to make a few changes in the <code class="literal">Application.js</code> file.</p><p>First, we need to declare the <code class="literal">views</code> we are using (only one in this case), as follows:</p><div><pre class="programlisting">views: [
    'login.Login'
],</pre></div><p>And the last change is inside the <code class="literal">launch</code> function. In the preceding chapter, we left a <code class="literal">console.log</code> message where we needed to instantiate our initial view; now we only need to replace the <code class="literal">console.log</code> message with the <code class="literal">Login</code> instance (<code class="literal">#1</code>):</p><div><pre class="programlisting">me.splashscreen.next().fadeOut({
    duration: 1000,
    remove:true,
    listeners: {
       afteranimate: function(el, startTime, eOpts ){
<strong>            Ext.widget('login-dialog'); //#1</strong>
        }
    }
});</pre></div><p>Now that <code class="literal">Application.js</code> is OK, and we can execute what we have implemented so far!</p><div><div><div><div><h4 class="title"><a id="ch03lvl4sec01"/>A quick overview about Ext JS dynamic class loading</h4></div></div></div><p>Dynamic class loading was<a id="id210" class="indexterm"/> introduced in Ext JS 4. It provides an integrated dependency management capability, and it is very useful, especially when working on the development (local) environment (it also plays an important role in the final production build). This capability is also one of the reasons why option 5 for instantiating classes in Ext JS (using the keyword <code class="literal">new</code>) became deprecated and not a best practice.</p><p>What does <a id="id211" class="indexterm"/>dynamic loading mean? It means that we do not need to load all Ext JS SDK classes prior to load our application. For example, for the Login window, we are using the <code class="literal">Window</code>, <code class="literal">Form</code>, and <code class="literal">TextField</code> classes from the Ext JS SDK. To execute our application, we do not need the source code of the grid, tree, and charts. Do you agree?</p><p>Still on the Login window example, when our application is loaded, Ext JS will read that the '<code class="literal">login.Login</code>' view needs to be loaded. As all the application source code is inside the <code class="literal">app</code> folder, and the views are inside the <code class="literal">app/view</code> folder, the Ext JS loader will expect to find the <code class="literal">app/view/login/Login.js</code> file, and inside this file it expects to find the '<code class="literal">Packt.view.login.Login</code>' class definition (this is why it is very important to follow the naming conventions we introduced earlier). The <a id="id212" class="indexterm"/>Ext JS loader will then see that this class inherits from the <code class="literal">Ext.window.Window</code> class, and if this class was not loaded yet, it is going to figure out all its dependencies (from the <code class="literal">extend</code> and <code class="literal">requires</code> declarations—we will discuss <code class="literal">requires</code> in a bit) and load them until we have all the source code required to execute the application loaded (and it will do this recursively until all code is loaded).</p><p>For example, when you try to execute the application, open the Chrome Developer Tools (<em>Ctrl + Shift + I</em> or <em>Command + Shift + I</em>) or Firebug for Firefox (enable all panels) and open the <strong>Network</strong> tab. We will be able to see all files that were loaded for our application, as follows:</p><div><img src="img/0457OT_03_07.jpg" alt="A quick overview about Ext JS dynamic class loading"/></div><p>We know that <strong>5MB</strong> is scary for only a <strong>Login</strong> screen, but we will solve this issue when we do the production build later on this book. We do not need to worry about it for now.</p><p>What will happen later when we do the production build is that Ext JS will know which classes from the SDK need to be included in the final JavaScript file, will concatenate everything into a single file, and will also obfuscate it. If you try to open any of the files listed in the preceding screenshot, you will be able to read the source code (and it will be pretty and indented as the development source code should be).</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec34"/>Adding Font Awesome support (Glyph icons)</h2></div></div></div><p>Using <a id="id213" class="indexterm"/>icons on the application improves its look <a id="id214" class="indexterm"/>and feel, it makes the application look prettier, and users usually enjoy it. However, unless we get (or buy) icons with different sizes, the icons are 16 x 16 pixels big. With the introduction of <a id="id215" class="indexterm"/>
<strong>CSS3</strong>, one of the new features is called <a id="id216" class="indexterm"/>
<strong>CSS3 Web Fonts</strong> (<a class="ulink" href="http://www.w3schools.com/css/css3_fonts.asp">http://www.w3schools.com/css/css3_fonts.asp</a>), which allow us to use fonts that are not installed on the user's computer.</p><p>This feature <a id="id217" class="indexterm"/>allowed developers to create a new type of icons, called <a id="id218" class="indexterm"/>
<strong>Glyph icons</strong>, which are not actually icons, but fonts where each character looks like an icon (similar to the<a id="id219" class="indexterm"/> <em>Webding</em> font, <a class="ulink" href="http://en.wikipedia.org/wiki/Webdings">http://en.wikipedia.org/wiki/Webdings</a>).</p><p>Using Glyph icons is great because we can change the size and color of the icon to match the application's theme. Whenever possible, we will use Glyph icons in our application. There is an open source and free font that is used widely by modern applications (HTML5 applications) called <strong>Font Awesome</strong>, and we are going to use this in our project as well.</p><p>So the first step is downloading the <a id="id220" class="indexterm"/>Font Awesome files from <a class="ulink" href="http://fortawesome.github.io/Font-Awesome/">http://fortawesome.github.io/Font-Awesome/</a>. Click on the <strong>Download</strong> button. The file that is going to be downloaded is a <code class="literal">.zip</code> file. Unzip it. Copy the <code class="literal">fonts</code> folder and paste it inside the <code class="literal">resources</code> folder of the <code class="literal">masteringextjs</code> application. Copy the <code class="literal">scss</code> folder and paste it inside the <code class="literal">sass/etc</code> folder. Rename the <code class="literal">scss</code> folder to <code class="literal">fontAwesome</code>. This is how the <code class="literal">sass/etc</code> and <code class="literal">resource</code> folders will look after the changes:</p><div><img src="img/0457OT_03_08.jpg" alt="Adding Font Awesome support (Glyph icons)"/></div><p>We are<a id="id221" class="indexterm"/> almost there! Open the <code class="literal">sass/etc/fontAwesome/_variables.scss</code> file, and change the variable <code class="literal">$fa-font-path</code> to the following value:</p><div><pre class="programlisting">$fa-font-path: "../resources/fonts" !default;</pre></div><p>This is to tell Sass where we placed the font files.</p><p>Now all we have to do is open the <code class="literal">sass/etc/all.scss</code> file and add the following code in the first line of the file:</p><div><pre class="programlisting">@import "fontAwesome/font-awesome";</pre></div><p>If you are<a id="id222" class="indexterm"/> running <code class="literal">sencha app watch</code> in the terminal application, you should note that the application was rebuilt and we are ready to see the icons in our application. The following is how the <strong>Login</strong> screen will look:</p><div><img src="img/0457OT_03_09.jpg" alt="Adding Font Awesome support (Glyph icons)"/></div><p>The next step<a id="id223" class="indexterm"/> is to add <a id="id224" class="indexterm"/>some action to the <strong>Cancel</strong> and <strong>Submit</strong> buttons.</p><div><div><h3 class="title"><a id="note26"/>Note</h3><p>To learn more about Sass variables<a id="id225" class="indexterm"/> and import capabilities, please visit <a class="ulink" href="http://sass-lang.com/guide">http://sass-lang.com/guide</a>.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec35"/>Creating the Login Controller</h2></div></div></div><p>We have<a id="id226" class="indexterm"/> created the view for the <strong>Login</strong> screen so far. As we <a id="id227" class="indexterm"/>are following the MVC architecture, we are not implementing the user interaction on the <code class="literal">View</code> class. If we click on the buttons on the <code class="literal">Login</code> class, nothing will happen, because we have not implemented this logic yet. We are going to implement this logic now on the <code class="literal">Controller</code> class.</p><p>In Ext JS 5, we have two options to do this: use the default MVC architecture or use the MVVM architecture pattern (or a <em>hybrid</em> pattern).</p><div><div><div><div><h3 class="title"><a id="ch03lvl3sec07"/>Introducing the MVVM architecture</h3></div></div></div><p>In the preceding <a id="id228" class="indexterm"/>chapter, we covered an introduction<a id="id229" class="indexterm"/> of the MVC architecture in Ext JS. Let's refresh our memory quickly of how MVC works:</p><div><img src="img/0457OT_03_10.jpg" alt="Introducing the MVVM architecture"/></div><p>The <a id="id230" class="indexterm"/>
<strong>Model</strong> <a id="id231" class="indexterm"/>represents <a id="id232" class="indexterm"/>the information that is being used by the application. The <a id="id233" class="indexterm"/>
<strong>View</strong><a id="id234" class="indexterm"/> is what the user will see on the screen—the components. In each interaction of the user with the application, the components will fire events. The <a id="id235" class="indexterm"/>
<strong>Controller</strong><a id="id236" class="indexterm"/> is where we are going to handle the events and execute any logic that is needed; the Controller is going to manage the information (<strong>Model</strong>) and also manage the <strong>View</strong> (and the interaction between the <strong>View</strong> and <strong>Model</strong>).</p><p>In Ext JS 5, Sencha introduced this new pattern called <a id="id237" class="indexterm"/>
<strong>Model View ViewModel</strong> (<strong>MVVM)</strong>, which is shown in the following diagram:</p><div><img src="img/0457OT_03_11.jpg" alt="Introducing the MVVM architecture"/></div><p>What happens in the MVVM is that using this pattern, it is much easier to control the <strong>View</strong> <a id="id238" class="indexterm"/>and the <strong>Model</strong> if <a id="id239" class="indexterm"/>they are bound. For example, consider that we have a data grid where we list some contacts. When we select a contact and click on the <strong>Edit</strong> button, we want the application to open a pop up about the title that will be the name of the contact and the pop up will also have a form that will display the contact details for editing. If we use the default MVC pattern, we will need to control the way <a id="id240" class="indexterm"/>the <strong>View</strong> (data grid, pop up, and form) interacts with<a id="id241" class="indexterm"/> the <a id="id242" class="indexterm"/>
<strong>Model</strong> (contact information). The MVVM (which is based on the MVC) introduces a new abstraction entity that is the <strong>ViewModel</strong>. The<a id="id243" class="indexterm"/> <strong>ViewModel</strong> mediates changes between the <strong>View</strong> and the associated <strong>Model</strong>.</p><p>However, with<a id="id244" class="indexterm"/> this new pattern and new <strong>ViewModel</strong> abstraction, Sencha also introduced an abstraction for the controller, which is bound to the <strong>View</strong>, called the <strong>ViewController</strong>. The <strong>ViewController</strong><a id="id245" class="indexterm"/> is very similar to the traditional controller of the MVC pattern, which is as follows:</p><div><img src="img/0457OT_03_12.jpg" alt="Introducing the MVVM architecture"/></div><p>However, as we learned in <a class="link" href="ch02.html" title="Chapter 2. Getting Started">Chapter 2</a>, <em>Getting Started</em>, the controllers of the MVC pattern are created in the scope of the application, and they are unique instances (meaning a single instance of each controller of the application). As long as the application is running, the controllers are also alive.</p><p>The <strong>ViewModel</strong><a id="id246" class="indexterm"/> and <strong>ViewController</strong><a id="id247" class="indexterm"/> are part of the component (we learned about component in <a class="link" href="ch01.html" title="Chapter 1. Sencha Ext JS Overview">Chapter 1</a>, <em>Sencha Ext JS Overview</em>). As long as the <strong>View</strong> is alive, they are also alive. When the <strong>View</strong> is destroyed, they also get destroyed. This means that we can save some memory (if we do not have many instances of the same <strong>View</strong> at once).</p><p>Do not worry if you do not understand all these concepts 100 percent right now. We will learn how to use them and how they work with some examples, and throughout this book we will use these different options of architecture so that we can learn how each one works, and maybe you can choose the one you like the most or the one that is going to fit your project best.</p></div><div><div><div><div><h3 class="title"><a id="ch03lvl3sec08"/>Creating the ViewController for Login View</h3></div></div></div><p>Let's stop to <a id="id248" class="indexterm"/>think a little bit. Logging<a id="id249" class="indexterm"/> in is performed once during the application's lifetime. There are three things we can do in the application: log in to start using it, use its capabilities, or log out (because we clicked on the logout button or the session expired). Once we have logged in, we are in, and that is it.</p><p>In the previous topic we learned that the <a id="id250" class="indexterm"/>
<strong>ViewModel</strong> and the <a id="id251" class="indexterm"/>
<strong>ViewController</strong> are destroyed once the <strong>View</strong> <a id="id252" class="indexterm"/>is destroyed. So, instead of having a controller for the login alive during the application's lifetime, we can have a controller that will be alive only during the time that the login View is alive. For this reason, for the <strong>Login</strong> screen, we will use the <strong>ViewController</strong>.</p><p>The first <a id="id253" class="indexterm"/>step is creating the JavaScript file. Inside <code class="literal">app/view/login</code>, we will create the <code class="literal">LoginController.js</code> file. Inside this file, we will implement the following code, which is only a base of the <code class="literal">ViewController</code> class we are going to implement:</p><div><pre class="programlisting">Ext.define('Packt.view.login.LoginController', { // #1
    extend: 'Ext.app.ViewController',            // #2
    alias: 'controller.login',                   // #3 

    onTextFieldSpecialKey: function(field, e, options){ }, // #4

    onTextFieldKeyPress: function(field, e, options){ }, // #5

    onButtonClickCancel: function(button, e, options){ }, // #6

    onButtonClickSubmit: function(button, e, options){ }, // #7

    doLogin: function() { }, // #8

    onLoginFailure: function(form, action) { }, // #9

    onLoginSuccess: function(form, action) { } // #10
});</pre></div><p>As usual, on the first line of the class, we have its name (<code class="literal">#1</code>). Following the same formula we used for the <code class="literal">view/login/Login.js</code>, we will have <code class="literal">Packt</code> (<em>app namespace</em>) + <code class="literal">view</code> (<em>name of the package</em>) + <code class="literal">login</code> (<em>name of the sub package</em>) + <code class="literal">LoginController</code> (<em>name of the file</em>), resulting in <code class="literal">Packt.view.login.LoginController</code>.</p><p>The <code class="literal">ViewController</code> classes need to extend from <code class="literal">Ext.app.ViewController</code> (<code class="literal">#2</code>) so that we will always use this parent class for our <code class="literal">ViewController</code>.</p><p>We also need to give an <code class="literal">alias</code> to this <code class="literal">ViewController</code> (<code class="literal">#3</code>). Aliases for ViewControllers start with <code class="literal">'controller'</code>, followed by the alias we want to assign (remember that the alias is always in lowercase).</p><p>For <code class="literal">#4</code>–<code class="literal">#10</code>, we have<a id="id254" class="indexterm"/> the signature of some methods we <a id="id255" class="indexterm"/>will implement until the end of this chapter. We will go through each of them later.</p><div><div><div><div><h4 class="title"><a id="ch03lvl4sec02"/>Binding the ViewController to the View</h4></div></div></div><p>Now that <a id="id256" class="indexterm"/>we have the base of our ViewController ready, we <a id="id257" class="indexterm"/>need to bind the ViewController to its View, which is the <code class="literal">Login</code> View. Going back to the <code class="literal">Packt.view.login.Login</code> class, we are going to add the following configuration to the class:</p><div><pre class="programlisting">controller: 'login',</pre></div><p>The preceding configuration will bind the <code class="literal">ViewController</code> class to the <code class="literal">Login</code> class life cycle. Note that we are using the alias we defined in <code class="literal">#3</code>.</p><p>If you try to execute the code, it will throw an error. This is because Ext JS does not know which <code class="literal">ViewController</code> class has the <code class="literal">login</code> alias (since this alias is not a native of the framework; we are creating it). To make it work, we need to add the following code to the <code class="literal">login</code> class as well:</p><div><pre class="programlisting">requires: [
    'Packt.view.login.LoginController'
],</pre></div><p>This will tell the Ext JS loader that it also needs to be loaded when loading the <code class="literal">Login</code> class. Ext JS will load this class and all its dependencies. By the time Ext JS parses the <code class="literal">controller: 'login'</code> code, it will have registered the <code class="literal">login</code> alias for a controller and it is going to be OK.</p></div></div><div><div><div><div><h3 class="title"><a id="ch03lvl3sec09"/>Listening to the button click event</h3></div></div></div><p>Our <a id="id258" class="indexterm"/>next step now is to start listening to the <strong>Login</strong> window events. First, we are going to listen to the <strong>Submit</strong> and <strong>Cancel</strong> buttons.</p><p>As we are <a id="id259" class="indexterm"/>using a <code class="literal">ViewController</code> class and not a Controller (MVC), we need to add listeners inside the <code class="literal">Login</code> class. First, let's do it for the <strong>Cancel</strong> button, as follows:</p><div><pre class="programlisting">xtype: 'button',
iconCls: 'fa fa-times fa-lg',
text: 'Cancel',
<strong>listeners: {    click: 'onButtonClickCancel'}</strong>
</pre></div><p>This code <a id="id260" class="indexterm"/>means that when a user clicks on the <strong>Cancel</strong> button, the <code class="literal">onButtonClickCancel</code> method from the <code class="literal">Login ViewController</code> class will be executed. So let's implement this method! Back to the <code class="literal">LoginController</code> class, we already know that this is the method we are going to implement:</p><div><pre class="programlisting">
<strong>onButtonClickCancel</strong>: function(button, e, options){}</pre></div><p>But how do we know which are the parameters the method can receive? We can find the answer to this question in the documentation. If we take a look at the click event in the documentation (<code class="literal">Button</code> class), this is what we will find:</p><div><img src="img/0457OT_03_13.jpg" alt="Listening to the button click event"/></div><p>This is exactly what we declared. For all the other event listeners, we will go to the docs and see which <a id="id261" class="indexterm"/>are the parameters the event accepts, and then list them as parameters in our code. This is also a very good practice. We should always list out all the arguments from the docs even if we are only interested in the first one (or even none). This way, we always know that we have the full collection of the parameters, and this can come in very handy when we are doing maintenance on the application.</p><div><div><h3 class="title"><a id="tip11"/>Tip</h3><p>Make sure the documentation becomes your best friend while developing Ext JS applications. The Ext JS documentation is really good and user friendly.</p></div></div><p>Note that we also want to listen to the <strong>Submit</strong> button click. The <code class="literal">onButtonClickSubmit</code> method has the same signature as the <code class="literal">onButtonClickCancel</code> method. Let's go ahead and also add the listener to the <strong>Submit</strong> button, as follows:</p><div><pre class="programlisting">xtype: 'button',
formBind: true,
iconCls: 'fa fa-sign-in fa-lg',
text: 'Submit',
<strong>listeners: {    click: 'onButtonClickSubmit'}</strong>
</pre></div><p>Let's do a quick <a id="id262" class="indexterm"/>test to see if everything is working as expected so far:</p><div><pre class="programlisting">onButtonClickCancel: function(button, e, options){
    console.log('login cancel'); // #1
},

onButtonClickSubmit: function(button, e, options){
    console.log('login submit');  // #2          
},</pre></div><p>For now, we <a id="id263" class="indexterm"/>are only going to output a message on the console to make sure our code is working. So, we are going to output <code class="literal">'login submit'</code> (<code class="literal">#2</code>) if the user clicks on the <strong>Submit</strong> button, and <code class="literal">'login cancel'</code> (<code class="literal">#1</code>) if the user clicks on the <strong>Cancel</strong> button.</p><p>Let's go ahead and try it. Click on the <strong>Cancel</strong> button and then on the <strong>Submit</strong> button. This should be the output:</p><div><img src="img/0457OT_03_14.jpg" alt="Listening to the button click event"/></div><div><div><div><div><h4 class="title"><a id="ch03lvl4sec03"/>Cancel Button Listener implementation</h4></div></div></div><p>Let's <a id="id264" class="indexterm"/>remove the <code class="literal">console.log</code> messages and add the code we actually want the methods to execute. First, let's work on the <code class="literal">onButtonClickCancel</code> method. When we execute this method, we want it to reset the <strong>Login</strong> form.</p><p>So this is the logic sequence we want to program:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Get the form reference</li><li class="listitem" style="list-style-type: disc">Call the <code class="literal">reset</code> method to reset the form</li></ul></div><p>If we take a look at the parameters we have available on the <code class="literal">onButtonClickCancel</code> method, we have <code class="literal">button</code>, <code class="literal">e</code>, and <code class="literal">options</code>, and none of them provides us with the form reference. So what can we do about it?</p><p>The <code class="literal">ViewController</code> class has an interesting way of getting a reference of the <code class="literal">Login</code> class or any of its children, which uses the method <code class="literal">lookupReference(reference)</code> from the <code class="literal">ViewController</code> class. To be able to use this method, all we have to do is add a reference for the <code class="literal">form</code> in the <code class="literal">Login View</code> class:</p><div><pre class="programlisting">xtype: 'form',
<strong>reference: 'form',</strong>
</pre></div><p>With this reference, we <a id="id265" class="indexterm"/>will be able to call the <code class="literal">this.lookupReference('form')</code> method directly to retrieve the form reference. With the form reference, all we have to do is call the method <code class="literal">reset()</code> from the <code class="literal">form</code> class. The complete code for the <code class="literal">onButtonClickCancel</code> method would be:</p><div><pre class="programlisting">onButtonClickCancel: function(button, e, options){
    this.lookupReference('form').reset();
},</pre></div></div><div><div><div><div><h4 class="title"><a id="ch03lvl4sec04"/>Submit Button Listener implementation</h4></div></div></div><p>Now we <a id="id266" class="indexterm"/>need to implement the <code class="literal">onButtonClickSubmit</code> method. Inside this method, we want to program the logic to send the <strong>User</strong> and <strong>Password</strong> values to the server so that the user can be authenticated.</p><p>We can implement two programming logics inside this method: the first one is to use the <code class="literal">submit</code> method that is provided by the <code class="literal">Form Basic</code> class, and the second one is to use an Ajax call to submit the values to the server. Either way, we will achieve what we want to do. For this example, we will use the default form submit call.</p><p>These are the steps we need to perform in this method:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Get the <strong>Login</strong> form reference</li><li class="listitem" style="list-style-type: disc">Get the <strong>Login</strong> window reference (so we can close it once the user has been authenticated)</li><li class="listitem" style="list-style-type: disc">Send Login information to the server</li><li class="listitem" style="list-style-type: disc">Handle the server response, as follows:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">If the user is authenticated, display application</li><li class="listitem" style="list-style-type: disc">If not, display error message</li></ul></div></li></ul></div><p>We already know how to get the form reference. This is how <code class="literal">onButtonClickSubmit</code> will look:</p><div><pre class="programlisting">onButtonClickSubmit: function(button, e, options){
    var me = this;
    if (me.lookupReference('form').isValid()){ // #1
        me.doLogin();              // #2
    }
},</pre></div><p>So first, before doing anything, we will make sure the user has entered all the required information (user name and valid password (<code class="literal">#1</code>)). If everything is OK, then we call a helper method that will handle the authentication (<code class="literal">#2</code>), as follows:</p><div><pre class="programlisting">doLogin: function() {
    var me = this,
        form = me.lookupReference('form');

    form.submit({
        clientValidation: true,        // #3
        url: 'php/security/login.php', // #4
        scope: me,         // #5
        success: 'onLoginSuccess',     // #6
        failure: 'onLoginFailure'      // #7
    });
},</pre></div><p>First, just to <a id="id267" class="indexterm"/>make sure the data we are trying to submit is valid (we will call this <code class="literal">doLogin</code> method from another method as well, so to be sure we are sending valid data to server is never too much!), we set the <code class="literal">clientValidation</code> configuration as <code class="literal">true</code> to validate the information one more time (<code class="literal">#3</code>). Then we have the <code class="literal">url</code> that is going to be called (<code class="literal">#4</code>). The <code class="literal">success</code> (<code class="literal">#6</code>) and <code class="literal">failure</code> (<code class="literal">#7</code>) callbacks were declared as separate functions, which belong to the <code class="literal">ViewController</code> class, and that is why the scope is the <code class="literal">ViewController</code> class (<code class="literal">#5</code>).</p><div><div><h3 class="title"><a id="tip12"/>Tip</h3><p>We could implement the success and failure methods inside the submit call as well (as showed by the example in the documentation <a class="ulink" href="http://docs.sencha.com/extjs/5.0.0/apidocs/#!/api/Ext.form.Basic-method-submit">http://docs.sencha.com/extjs/5.0.0/apidocs/#!/api/Ext.form.Basic-method-submit</a>). But we do not know how much code we will need to handle the authentication. Working with scoped callbacks is better because our code stays organized, with better readability.</p></div></div><p>If we try to run this code, the application will send the request to the server, but we will get an error as response because we do not have the <code class="literal">login.php</code> page implemented yet. That's OK because we are interested in other details right now.</p><p>With Firebug or Chrome Developer Tools enabled, open the <strong>Network</strong> tab and filter by the <strong>XHR</strong> requests. Make sure to enter a <code class="literal">username</code> and <code class="literal">password</code> (any valid value so we can click on the <strong>Submit</strong> button). This will be the output:</p><div><img src="img/0457OT_03_15.jpg" alt="Submit Button Listener implementation"/></div><p>Note that the user and <a id="id268" class="indexterm"/>password are being sent as form data. This information is useful to handle the information on the server side (which in our case is the PHP code).</p><div><div><h3 class="title"><a id="tip13"/>Tip</h3><p>Whenever you have questions or you have no idea how you are going to handle the information sent by Ext JS to the server, open the debug tool of your browser and inspect the call. This helps a lot and also helps you to learn more about how Ext JS works when communicating with the server.</p></div></div></div></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec36"/>Creating the User and Groups tables</h2></div></div></div><p>Before we start <a id="id269" class="indexterm"/>coding the <code class="literal">login.php</code> page, we need to add two tables to the Sakila database. These two tables are going to represent the users and also<a id="id270" class="indexterm"/> the group that the user can belong to. In our project, a user can belong to only one group, as shown in the following figure:</p><div><img src="img/0457OT_03_16.jpg" alt="Creating the User and Groups tables"/></div><div><ol class="orderedlist arabic"><li class="listitem">First, we are going to create the <code class="literal">Group</code> table, as follows:<div><pre class="programlisting">CREATE  TABLE IF NOT EXISTS `sakila`.`Groups` (
  `id` INT NOT NULL AUTO_INCREMENT ,
  `name` VARCHAR(45) NOT NULL ,
  PRIMARY KEY (`id`) )
ENGINE = InnoDB;</pre></div></li><li class="listitem">Then, we<a id="id271" class="indexterm"/> are going to create the <code class="literal">User</code> table containing the indexes and also the <code class="literal">foreign key</code> to the <code class="literal">Group</code> table:<div><pre class="programlisting">CREATE  TABLE IF NOT EXISTS `sakila`.`User` (
  `id` INT NOT NULL AUTO_INCREMENT ,
  `name` VARCHAR(100) NOT NULL ,
  `userName` VARCHAR(20) NOT NULL ,
  `password` VARCHAR(100) NOT NULL ,
  `email` VARCHAR(100) NOT NULL ,
  `picture` VARCHAR(100) NULL ,
  `Group_id` INT NOT NULL ,
  PRIMARY KEY (`id`, `Group_id`) ,
  UNIQUE INDEX `userName_UNIQUE` (`userName` ASC) ,
  INDEX `fk_User_Group1_idx` (`Group_id` ASC) ,
  CONSTRAINT `fk_User_Group1`
    FOREIGN KEY (`Group_id` )
    REFERENCES `sakila`.`Groups` (`id` )
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;</pre></div></li><li class="listitem">The next <a id="id272" class="indexterm"/>step is to insert some data into these tables:<div><pre class="programlisting">INSERT INTO `sakila`.`Groups` (`name`) VALUES ('admin');
INSERT INTO `sakila`.`User` (`name`, `userName`, `password`, `email`, `Group_id`) 
VALUES ('Loiane Groner', 'loiane', '$2a$10$2a4e8803c91cc5edca222evoNPfhdRyGEG9RZcg7.qGqTjuCgXKda', 'me@loiane.com', '1');</pre></div></li></ol></div><p>As the password <a id="id273" class="indexterm"/>will be saved hashed on the database, the value <code class="literal">$2a$10$2a4e8803c91cc5edca222evoNPfhdRyGEG9RZcg7.qGqTjuCgXKda</code> corresponds to the <a id="id274" class="indexterm"/>value <code class="literal">Packt123@</code>. We will be hashing our password for more security in the user administration module.</p><p>Now we are ready to start developing the <code class="literal">login.php</code> page.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec37"/>Handling the Login page on the server</h2></div></div></div><p>Since we<a id="id275" class="indexterm"/> have part of the Ext JS code to send the login<a id="id276" class="indexterm"/> information to the server, we can implement the server-side code. As mentioned in the first chapter of this book, we are going to use PHP to implement the server-side code. But if you do not know PHP, do not worry because the code is not going to be complicated, and we are going to use pure PHP as well. The goal is to focus on the programming logic we need to use on the server side; this way we apply the same programming logic to any other server-side language that you like to use (Java, .NET, Ruby, Python, and so on).</p><div><div><div><div><h3 class="title"><a id="ch03lvl3sec10"/>Connecting to the database</h3></div></div></div><p>The first step is<a id="id277" class="indexterm"/> to create the file that is going to be responsible for connecting to the database. We are going to reuse this file in almost every PHP page that we are going to develop.</p><p>Create a new folder named <code class="literal">php</code> under the project's root folder, and under <code class="literal">php</code>, create a new folder named <code class="literal">db</code>. Then, create a new file named <code class="literal">db.php</code>:</p><div><pre class="programlisting">&lt;?php 
$server = "127.0.0.1";
$user = "root";
$pass = "root";
$dbName = "sakila";

$mysqli = new mysqli($server, $user, $pass, $dbName);

/* check connection */
if ($mysqli-&gt;connect_errno) {
    printf("Connect failed: %s\n", mysqli_connect_error());
    exit();
}
?&gt;</pre></div><p>The connection is pretty straightforward. We simply need to inform the <code class="literal">server</code> (which is going to be <code class="literal">localhost</code>), the<a id="id278" class="indexterm"/> databases <code class="literal">username</code> and <code class="literal">password</code>, and also the database <code class="literal">name</code> that we want to connect to. And at last, we can check whether the connection was done successfully or any error occurred.</p><div><div><h3 class="title"><a id="note27"/>Note</h3><p>For more information about <a id="id279" class="indexterm"/>MySQLi, please visit <a class="ulink" href="http://php.net/manual/en/book.mysqli.php">http://php.net/manual/en/book.mysqli.php</a>.</p></div></div></div><div><div><div><div><h3 class="title"><a id="ch03lvl3sec11"/>Login.php</h3></div></div></div><p>Finally, we<a id="id280" class="indexterm"/> can create the <code class="literal">login.php</code> file under the <code class="literal">php/security</code> folder. So let's start implementing it, as follows:</p><div><pre class="programlisting">require("../db/db.php"); // #1
require("PassHash.php"); // #2

session_start();         // #3

$userName = $_POST['user']; // #4
$pass = $_POST['password']; // #5

$userName = stripslashes($userName); // #6
$pass = stripslashes($pass);         // #7

$userName = $mysqli-&gt;real_escape_string($userName); // #8
$sql = "SELECT * FROM USER WHERE userName='$userName'"; // #9</pre></div><p>First, we need to <em>require</em> the <code class="literal">db.php</code> file to connect to the database (<code class="literal">#1</code>). We are also going to <code class="literal">require</code> the <code class="literal">PassHash.php</code> file (<code class="literal">#2</code>). This file contains the <code class="literal">check_password</code> method, which will compare the password entered by the user with the one that is stored in the database (hashed).</p><p>Then, we start a session (<code class="literal">#3</code>)—we are going to store the username on the session later.</p><p>The next step is to retrieve the <code class="literal">user</code> and <code class="literal">password</code> values sent by the form submit method from Ext JS (<code class="literal">#4</code> and <code class="literal">#5</code>).</p><p>The <code class="literal">stripslashes</code> function removes the backslashes from the given string (<code class="literal">#6</code> and <code class="literal">#7</code>). For example, if the user value is <code class="literal">"Loiane\'s"</code>, the return of <code class="literal">stripslashes</code> will be <code class="literal">"Loiane's"</code>.</p><div><div><h3 class="title"><a id="tip14"/>Tip</h3><p>These two steps help a little bit to ensure the security of the application; however, they are not enough. It is very important to <em>sanitize</em> the user input in the server so that we do not store or try to execute SQL statements with malicious input. For the purpose of this book, we will not apply this technique to keep the server-side code simple, so even though you do not know PHP, you will be able to read and understand the logic behind it and implement something similar in the server-side language of your choice. However, be aware that in real-world applications, it is very important to apply this step, especially if you are releasing your application to the general public (not for internal use only).</p><p>There is a project called <a id="id281" class="indexterm"/>
<strong>Open Web Application Security Project</strong> (<strong>OWASP</strong>), which is free and open source that provides a set of libraries and APIs to apply security techniques in your application. There are subprojects available for .NET, Java, and PHP, tutorials on how to avoid XSS attacks and SQL injections, and how to prevent other security vulnerabilities. For <a id="id282" class="indexterm"/>more information, please visit <a class="ulink" href="https://www.owasp.org">https://www.owasp.org</a>.</p></div></div><p>Then, we <a id="id283" class="indexterm"/>prepare the <code class="literal">$username</code> variables for the SQL statement using the function <code class="literal">real_escape_string</code> (<code class="literal">#8</code>), which escapes special characters in a string for use in a SQL statement.</p><p>Next, we prepare the SQL query that is going to be executed (<code class="literal">#9</code>). It is a simple <code class="literal">SELECT</code> statement that is going to return a result matching the given <code class="literal">username</code>.</p><p>Let's continue with the next part of the code:</p><div><pre class="programlisting">if ($resultDb = $mysqli-&gt;query($sql)) { //#10

  $count = $resultDb-&gt;num_rows; //#11

  if($count==1){ //#12

        $record = $resultDb-&gt;fetch_assoc(); //#13

         //#14  
        if (PassHash::check_password($record['password'],$pass)){
            $_SESSION['authenticated'] = "yes"; //#15
            $_SESSION['username'] = $userName; //#16

            $result['success'] = true; //#17
            $result['msg'] = 'User authenticated!'; //#18
        } else{
            $result['success'] = false; //#19
            $result['msg'] = 'Incorrect password.'; //#20
        }
  } else {
    $result['success'] = false; //#21
    $result['msg'] = 'Incorrect user or password.'; //#22
  }
  $resultDb-&gt;close(); //#23
}</pre></div><p>Next, we need to execute the SQL query, and we are going to store the result set in the <code class="literal">resultDb</code> variable (<code class="literal">#10</code>). Then, we are going to store data according to whether the result set returned any rows within the result set (<code class="literal">#11</code>).</p><p>Now comes the<a id="id284" class="indexterm"/> most important part of the code. We are going to verify whether the result set returned any rows. As we passed the <code class="literal">username</code>, the number of rows returned within the result set must be exactly <code class="literal">1</code>. So, if the number of rows is equal to <code class="literal">1</code> (<code class="literal">#12</code>), we need to see whether the hashed password stored in the database matches the password entered by the user, but first, we need to retrieve this information from the record that was fetched from the database (<code class="literal">#13</code>).</p><p>The <code class="literal">PassHash</code> class is responsible for hashing the password, making it a little bit more secure to save the hashed password in the database (instead of the plain password), for decrypting the hashed password from the database (<code class="literal">$record['password']</code>), and for comparing to the password the user entered in the login page (<code class="literal">#14</code>).</p><div><div><h3 class="title"><a id="note28"/>Note</h3><p>For now, you can get the complete code for <code class="literal">PassHash.php</code> from the source code downloaded from this book. In <a class="link" href="ch06.html" title="Chapter 6. User Management">Chapter 6</a>, <em>User Management</em>, we will go through it line by line.</p></div></div><p>If the password entered by the user and the decrypted hash password from the database match, it means the user can be authenticated. We are going to store the <code class="literal">username</code> of the authenticated user (<code class="literal">#16</code>) in the <code class="literal">Session</code> and also the information that the user is <code class="literal">authenticated</code> (<code class="literal">#15</code>).</p><p>We also need to prepare the result that we are going to return to Ext JS. We are going to send back two pieces of information: the first one is about whether the user is <code class="literal">authenticated</code> (<code class="literal">#17</code>)—in this case <code class="literal">"true"</code>—and we can also send back a message (<code class="literal">#18</code>).</p><p>If the password entered by the user and the one from the database do not match, then we also need to return something to Ext JS. The <code class="literal">success</code> is going to be <code class="literal">false</code> (<code class="literal">#19</code>), and we are going to return a message so that we can display to the user (<code class="literal">#20</code>).</p><p>If the <code class="literal">username</code> does not exist in the database (number of rows returned within the result set is different from <code class="literal">1</code>), we are also going to send back a message to Ext JS saying the username or password informed by the user is incorrect (<code class="literal">#22</code>). Therefore, the <code class="literal">success</code> information will be <code class="literal">false</code> (<code class="literal">#21</code>).</p><p>Then, we need to close the result set (<code class="literal">#23</code>).</p><p>Now, the third and last part of the code of <code class="literal">login.php</code>:</p><div><pre class="programlisting">$mysqli-&gt;close(); // #23

echo json_encode($result); // #24</pre></div><p>We need to close<a id="id285" class="indexterm"/> the database connection (<code class="literal">#23</code>), and we are going to <code class="literal">encode</code> the <code class="literal">result</code> that we are going to send back to Ext JS in the JSON format (<code class="literal">#24</code>).</p><p>And now, the <code class="literal">login.php</code> code is complete. We cannot forget to add <code class="literal">&lt;?php</code> before the preceding code.</p></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec38"/>Handling the return of the server – logged in or not?</h2></div></div></div><p>We already <a id="id286" class="indexterm"/>took care of the server-side code. Now, we need to go back to the Ext JS code and handle the response from the server.</p><p>Success <a id="id287" class="indexterm"/>and failure in Ext JS has two different concepts. The form handles it in a way and the Ajax request handles it in a different one. This can be a little bit confusing, so we are going to implement requests to the server using the form submit (as this example) and also the Ajax request so that we can learn how to implement the proper code using both ways.</p><p>For the form, the server needs to return the <code class="literal">success: true</code> information so that the callback to be executed is a successful one. For failure, the server needs to return <code class="literal">success: false</code>, which can be returned if any communication error might have occurred (page nor found, exception on server, and so on). For the Ajax request, it does not matter whether <code class="literal">success</code> is <code class="literal">true</code> or <code class="literal">false</code>; it is going to execute the success callback; only if any communication error occurs is it going to execute the failure callback.</p><div><div><h3 class="title"><a id="note29"/>Note</h3><p>It is good to remember that the content type that the server needs to return to Ext JS is <code class="literal">application/json</code> and in the JSON format.</p></div></div><p>Let's handle the success callback first. In the event of success, the <code class="literal">onLoginSuccess</code> method is going to be executed. In this case, we want to close the <strong>Login</strong> window and display the main screen of the application, as follows:</p><div><pre class="programlisting">onLoginSuccess: function(form, action) {
    this.getView().close();             //#1
    Ext.create('Packt.view.main.Main'); //#2
}</pre></div><p>The <code class="literal">Window</code> class has a method called <code class="literal">close</code> that we can call to close the window. The question is how to get the reference of the <code class="literal">login window</code> class. The <code class="literal">ViewController</code> class is directly bound to it, and we can reference the <code class="literal">Login</code> class itself by calling the method <code class="literal">getView</code> of the <code class="literal">ViewController</code> class (<code class="literal">#1</code>). Then, we can create the main screen by instantiating the <code class="literal">Main</code> class (<code class="literal">#2</code>) that was created by Sencha Cmd when we created the application. We are going to reuse this class to create our main screen.</p><div><div><h3 class="title"><a id="tip15"/>Tip</h3><p>With the preceding approach, there is a flaw with the security of the code. A smart user who understands how Ext JS works can access the main page using a code similar to the preceding one even if the user is not authenticated. A more secure way would be to redirect to a page that holds the application (calling the <code class="literal">Main</code> class directly). As we are working with an example here, that is OK. However, keep that in mind when developing a real application!</p></div></div><p>In the event<a id="id288" class="indexterm"/> of<a id="id289" class="indexterm"/> failure, there are two cases that we need to handle: the first one is if the user was not authenticated because the user does not exist or because the password is incorrect. The second one is if there is any communication failure (for example, error 404). Our <code class="literal">onLoginFailure</code> method will look like the following code:</p><div><pre class="programlisting">onLoginFailure: function(form, action) {

  var result = Ext.JSON.decode(action.response.responseText, true); //#3

  if (!result){ //#4
      result = {};
      result.success = false;
      result.msg = action.response.responseText;
  }

  switch (action.failureType) {
      case Ext.form.action.Action.CLIENT_INVALID:  //#5
          Ext.Msg.show({
            title:'Error!',
            msg: 'Form fields may not be submitted with invalid values',
            icon: Ext.Msg.ERROR,
            buttons: Ext.Msg.OK
        });
      break;
      case Ext.form.action.Action.CONNECT_FAILURE:  //#6
        Ext.Msg.show({
            title:'Error!',
            msg: 'Form fields may not be submitted with invalid values',
            icon: Ext.Msg.ERROR,
            buttons: Ext.Msg.OK
        });
         break;
      case Ext.form.action.Action.SERVER_INVALID:  //#7
          Ext.Msg.show({
            title:'Error!',
            msg: result.msg, //#8
            icon: Ext.Msg.ERROR,
            buttons: Ext.Msg.OK
        });
  }
},</pre></div><p>Before we dive<a id="id290" class="indexterm"/> into the failure callback, note that both <code class="literal">onLoginFailure</code> and <code class="literal">onLoginSuccess</code> receive two parameters: <code class="literal">form</code> and <code class="literal">action</code>. Where do they come from?</p><p>If we take a look at the<a id="id291" class="indexterm"/> documentation, specifically on the <code class="literal">submit</code> method of the <code class="literal">Form</code> class (<code class="literal">Ext.form.Panel</code>), we will see that this <code class="literal">submit</code> method is calling the <code class="literal">submit</code> method from the class <code class="literal">Ext.form.Basic</code> (which is the class that actually contains all methods to handle form actions). If we take a look at the <code class="literal">submit</code> method from the <a id="id292" class="indexterm"/>
<code class="literal">Ext.form.Basic</code> class (<a class="ulink" href="http://docs.sencha.com/extjs/5.0/5.0.1-apidocs/#!/api/Ext.form.Basic-method-submit">http://docs.sencha.com/extjs/5.0/5.0.1-apidocs/#!/api/Ext.form.Basic-method-submit</a>), we will see a code similar to ours as an example. If we read the description, it says that this <code class="literal">submit</code> method is a shortcut to the <code class="literal">doAction</code> method<a id="id293" class="indexterm"/> from the same class.</p><p>If we open the documentation for this method (<a class="ulink" href="http://docs.sencha.com/extjs/5.0/apidocs/#!/api/Ext.form.Basic-method-doAction">http://docs.sencha.com/extjs/5.0/apidocs/#!/api/Ext.form.Basic-method-doAction</a>), we will be able to see the parameters we used for the form submit call (<code class="literal">url</code>, <code class="literal">success</code>, and <code class="literal">failure</code> callbacks, among others) and also the parameters that both success and failure callbacks receive—<code class="literal">form</code> and <code class="literal">action</code>—as follows:</p><div><img src="img/0457OT_03_22.jpg" alt="Handling the return of the server – logged in or not?"/></div><p>The <code class="literal">action</code> parameter<a id="id294" class="indexterm"/> contains four attributes inside it. For our failure callback, we are interested in two of them: <code class="literal">failureType</code> and <code class="literal">response</code>. Let's analyze <code class="literal">response</code> first. Add the following code (<code class="literal">console.log(action);</code>) to the first line of the failure callback, and try to submit an incorrect user or password in the <strong>Login</strong> screen. Before submitting to the server, open Chrome Developer Tools or Firebug to see what is going to be logged, as follows:</p><div><img src="img/0457OT_03_21.jpg" alt="Handling the return of the server – logged in or not?"/></div><p>Inside the <a id="id295" class="indexterm"/>response, note that there is <code class="literal">responseText</code> with JSON that we returned from the server. So, the first thing we are going to do is decode this JSON (<code class="literal">#3</code>). After we decode it, we will be able to access <code class="literal">result.success</code> and <code class="literal">result.msg</code>. We also need to be careful about one detail: we do not know what is going to be returned from the server. We always hope that is our <code class="literal">success</code> and <code class="literal">msg</code> information; however, we<a id="id296" class="indexterm"/> cannot be sure of it. If any other error is returned, it is also going to be returned inside <code class="literal">action.response.responseText</code>, and it cannot have the JSON format we are expecting (cannot be a JSON either). If this happens, <code class="literal">Ext.JSON.decode</code> will fail, and it will throw an exception. We can silence the exception (passing <code class="literal">true</code> as the second parameter to the <code class="literal">Ext.JSON.decode</code> function, and the <code class="literal">result</code> will have the value <code class="literal">null</code>), but we still need to handle it. And it is what we do when checking whether the <code class="literal">result</code> variable is <code class="literal">null</code> (<code class="literal">#4</code>). If it is null, we are instantiating the <code class="literal">result</code> and assigning some values (the <code class="literal">msg</code> will receive the error sent by the server).</p><p>After that, we will use the action <code class="literal">failureType</code> to see what type of error occurred. As <code class="literal">failureType</code> is code, Ext JS has some constants defined that are more developer friendly (<code class="literal">Ext.form.action.Action.CLIENT_INVALID</code>, for example). If <code class="literal">failureType</code> is <code class="literal">'client'</code> (<code class="literal">#5</code>), then we will display an error message in an alert pop up with an error icon. If a connection error happened with the server, then (<code class="literal">#6</code>) will handle it by displaying an error alert pop up as well. And if any exception or success is returned as false, (<code class="literal">#7</code>) will handle it. As we treated the return of the server to display the custom error message or any other message, we can simply display <code class="literal">result.msg</code> on the alert pop up (<code class="literal">#8</code>).</p><p>Try entering a wrong <a id="id297" class="indexterm"/>user or password again and see what happens. Change <code class="literal">login.php</code> <code class="literal">url</code> to <code class="literal">login.php</code> (or change to any other <code class="literal">url</code>), or inside the <code class="literal">db.php</code> file, enter the incorrect password to connect to the database to simulate an error, and here's what you will see:</p><div><img src="img/0457OT_03_17.jpg" alt="Handling the return of the server – logged in or not?"/></div><p>This way, we can handle <a id="id298" class="indexterm"/>all kind of server responses; not only the ones we are waiting for, but also any exceptions!</p><div><div><div><div><h3 class="title"><a id="ch03lvl3sec12"/>Reusing code by creating a Util class</h3></div></div></div><p>Note that in (<code class="literal">#5</code>), (<code class="literal">#6</code>), and (<code class="literal">#7</code>) we are <a id="id299" class="indexterm"/>using the same error alert pop up, so code is repeated. Alert errors like this are used in different places of the <a id="id300" class="indexterm"/>application. As we are going to handle more Ajax requests and form submits in other screens of the application as well, the code in (<code class="literal">#3</code>) and (<code class="literal">#4</code>) will be repeated as well. For this reason, we can create a <code class="literal">Util</code> class that will encapsulate this code and provide us with the means to reuse it. Besides the reuse pro, it is also good to establish a pattern to be followed by the application, such as working out the JSON format that the server needs to return to Ext JS. This will make the application more organized, and it is also good when working in a team (usually each developer has their own pattern that they like to follow, and this way, we follow the same pattern for the same application, and it will not look as though it was implemented by different developers).</p><p>So let's go ahead and create our first <code class="literal">Util</code> class. We will name it <code class="literal">Packt.util.Util</code>. For this reason, we are going to create a new file named <code class="literal">Util.js</code>, and we are also going to create a new folder named <code class="literal">util</code> under the <code class="literal">app</code> folder, as follows:</p><div><pre class="programlisting">Ext.define('Packt.util.Util', {

    statics : { //#1

        decodeJSON : function (text) { //#2
            var result = Ext.JSON.decode(text, true);
            if (!result){
                result = {};
                result.success = false;
                result.msg = text;
            }

            return result;
        },

        showErrorMsg: function (text) { //#3
            Ext.Msg.show({
                title:'Error!',
                msg: text,
                icon: Ext.Msg.ERROR,
                buttons: Ext.Msg.OK
            });
        }
    }
});</pre></div><p>All methods will be<a id="id301" class="indexterm"/> inside the <code class="literal">statics</code> declaration (<code class="literal">#1</code>). As <a id="id302" class="indexterm"/>we learned in <a class="link" href="ch01.html" title="Chapter 1. Sencha Ext JS Overview">Chapter 1</a>, <em>Sencha Ext JS Overview</em>, we can simply call <code class="literal">Packt.util.Util.decodeJSON</code> for example, without needing to instantiate the <code class="literal">Packt.util.Util</code> class. The <code class="literal">decodeJSON</code> method (<code class="literal">#2</code>) contains the code to handle the JSON decoding, and the method <code class="literal">showErrorMsg</code> (<code class="literal">#3</code>) contains the code to display an error pop up alert with the content passed in the text parameter.</p><div><div><h3 class="title"><a id="tip16"/>Tip</h3><p>Static methods do not require an instance of the class to be called. It is a concept of object-oriented programming.</p></div></div><p>Let's rewrite the <code class="literal">onLoginFailure</code> method by using the <code class="literal">Util</code> class, as follows:</p><div><pre class="programlisting">onLoginFailure: function(form, action) {

    var result = Packt.util.Util.decodeJSON(action.response.responseText);

    switch (action.failureType) {
        case Ext.form.action.Action.CLIENT_INVALID:
            Packt.util.Util.showErrorMsg('Form fields may not be submitted with invalid values');
            break;
        case Ext.form.action.Action.CONNECT_FAILURE:
       Packt.util.Util.showErrorMsg(action.response.responseText);
            break;
        case Ext.form.action.Action.SERVER_INVALID:
            Packt.util.Util.showErrorMsg(result.msg);
    }
}, </pre></div><p>Instead of 36 lines of code, now <a id="id303" class="indexterm"/>we have only 15, and the readability is better as well! In case we need to maintain this code, we can make the changes in the <code class="literal">Util</code> class, and<a id="id304" class="indexterm"/> the changes will be applied everywhere in the code that the class is being used! Best practices make our code really cool!</p><p>One last detail: we need to add the <code class="literal">Packt.util.Util</code> class in the <code class="literal">requires</code> declaration of the <code class="literal">ViewController</code> class as well:</p><div><pre class="programlisting">requires: [
    'Packt.util.Util'
],</pre></div><p>This is because of the dynamic loading we discussed earlier in this chapter. If we try to execute the preceding code without having the <code class="literal">Util</code> class loaded, we can get an error.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec19"/>Enhancing the Login screen</h1></div></div></div><p>Our <strong>Login</strong> screen<a id="id305" class="indexterm"/> is done. However, there are some enhancements we can apply to it to make it even better and also offer a better experience to the user.</p><p>The following list details the enhancements that we are going to apply in our <strong>Login</strong> screen:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Apply a loading mask while authenticating</li><li class="listitem" style="list-style-type: disc">Submit the form when the user presses <em>Enter</em></li><li class="listitem" style="list-style-type: disc">Displaying a Caps Lock warning message</li></ul></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec39"/>Applying a loading mask on the form while authenticating</h2></div></div></div><p>Sometimes, when<a id="id306" class="indexterm"/> the user clicks on the <strong>Submit</strong> button, there can be some delay while waiting for the server to send back the response. Some users will be patient, while some others will not. The ones that are not very patient will be able to click on the <strong>Submit</strong> button again, and this means making another request to the server. We can avoid this behavior by applying a loading mask to the <strong>Login</strong> window while awaiting the response.</p><p>First, we need to add the following code right before the <code class="literal">form.submit</code> call (inside the <code class="literal">doLogin</code> method):</p><div><pre class="programlisting">this.getView().mask('Authenticating... Please wait...');</pre></div><p>This will apply the mask to the <strong>Login</strong> screen.</p><p>Then, on the first <a id="id307" class="indexterm"/>line inside the <code class="literal">onLoginSuccess</code> and <code class="literal">onLoginFailure</code> functions, we need to add the following line of code:</p><div><pre class="programlisting">this.getView().unmask();</pre></div><p>And this will remove the mask from the <strong>Login</strong> window.</p><p>If we try to execute the code, we will have the following output:</p><div><img src="img/0457OT_03_18.jpg" alt="Applying a loading mask on the form while authenticating"/></div><p>Notice that the Login screen is not reachable and the user cannot click on the buttons again until the server sends back a response and removes the mask.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec40"/>Form submit on Enter</h2></div></div></div><p>For<a id="id308" class="indexterm"/> some forms, especially for the <strong>Login</strong> form, it is very natural for people to hit <em>Enter</em> when they are ready. This behavior is not automatic for Ext JS; therefore, we have to implement it.</p><p>The <code class="literal">textfield</code> component has an event to handle special keys, such as <em>Enter</em>. This event is called <code class="literal">specialkey</code>, and it is the one that we are going to listen to in our login controller. As we want to listen to this event for both text fields we have (<strong>User</strong> and <strong>Password</strong>), we can add the following code inside the defaults of the form from the <strong>Login</strong> window:</p><div><pre class="programlisting">listeners: {
    specialKey: 'onTextFieldSpecialKey'
}</pre></div><p>Next, we need <a id="id309" class="indexterm"/>to implement the <code class="literal">onTextFieldSpecialKey</code> method inside the <code class="literal">ViewController</code> class as well, as follows:</p><div><pre class="programlisting">onTextFieldSpecialKey: function(field, e, options){
    if (e.getKey() === e.ENTER) {
        this.doLogin();
    }
},</pre></div><p>First, we are going to verify that the key pressed by the user is <em>Enter</em>. If positive, we call the <code class="literal">doLogin</code> method we implemented earlier. Then, the form validation will be done and if the form is valid, it will try to log in. This will be the same as clicking on the <strong>Submit</strong> button.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec41"/>Caps Lock warning message</h2></div></div></div><p>The<a id="id310" class="indexterm"/> last enhancement we will apply to the form is the <strong>Caps Lock</strong> message. Sometimes the <em>Caps Lock</em> key is active, and when we<a id="id311" class="indexterm"/> input the password, we can input the correct password, but the system will say it is incorrect because it is case sensitive; warning the user about this is a nice thing to do.</p><p>The following screenshot presents the final result of the <strong>Caps Lock</strong> warning implementation:</p><div><img src="img/0457OT_03_19.jpg" alt="Caps Lock warning message"/></div><p>As you can see in the preceding screenshot, we will display the warning as a tooltip. So the first thing we need to do is go back to the <code class="literal">Application.js</code> launch function, and on the first line, we need to add the following code:</p><div><pre class="programlisting">Ext.tip.QuickTipManager.init();</pre></div><p>An alternative is<a id="id312" class="indexterm"/> using the configuration <code class="literal">enableQuickTips: true</code> inside <code class="literal">Aplication.js</code> as well. You can use either one, and the result will be the same.</p><p>Without the preceding code, the tooltips will not work in the application.</p><p>Ext JS has two <a id="id313" class="indexterm"/>concepts of tooltips. The first one is the <code class="literal">Tooltip</code> class, which does not have a built-in method of automatically populating the tooltip's text based on the target element; you must either configure a fixed HTML value for each tooltip instance or implement custom logic (inside an event listener). The second one is the <code class="literal">QuickTip</code> class, which automatically populates and configures a tooltip based on specific DOM attributes of each target element. Tooltips are enabled by default. QuickTips are managed by the <code class="literal">QuickTipManager</code>, which requires to be manually initiated.</p><p>The event that we are going to listen to is the <code class="literal">keypress</code> event, and we are only going to listen to this event fired by the <code class="literal">password</code> field. By default, the <code class="literal">textfield</code> component does not fire this event because it is a little bit heavy with regard to performance. As we want to listen to this event, we need to add a configuration (<code class="literal">enableKeyEvents</code>) to the <code class="literal">password</code> field (inside the <code class="literal">view/login/Login.js</code> file):</p><div><pre class="programlisting">id: 'password',
enableKeyEvents: true,
listeners: {
    keypress: 'onTextFieldKeyPress'
}</pre></div><p>We also need to add an <code class="literal">id</code> value to this field. Later, we will discuss the importance of avoiding using <code class="literal">id</code> in the components (since it is not a good practice), but in this case, there is nothing we can do about it. This is because when creating the <code class="literal">Tooltip</code> class, we need to set a <code class="literal">target</code> (in this case, the <code class="literal">password</code> field), and this <code class="literal">target</code> only accepts the <code class="literal">id</code> of the component, and not <code class="literal">itemId</code>.</p><p>Before we add the code to the Controller, we need to create the <code class="literal">Tooltip</code> class. We are going to create a new view called <code class="literal">Packt.view.login.CapsLockTooltip</code>, so we need to create a file named <code class="literal">CapsLockTooltip.js</code> under the <code class="literal">app/view/login</code> folder:</p><div><pre class="programlisting">Ext.define('Packt.view.login.CapsLockTooltip', {
    extend: 'Ext.tip.QuickTip',

    xtype: 'capslocktooltip',

    target: 'password',
    anchor: 'top',
    anchorOffset: 0,
    width: 300,
    dismissDelay: 0,
    autoHide: false,
    title: '&lt;div class="fa fa-exclamation-triangle"&gt; Caps Lock is On&lt;/div&gt;',
    html: '&lt;div&gt;Having Caps Lock on may cause you to enter ' +
        'your password incorrectly.&lt;/div&gt;&lt;br/&gt;' +
        '&lt;div&gt;You should press Caps Lock to turn it off ' +
        'before entering your password.&lt;/div&gt;'
});</pre></div><p>In <code class="literal">Packt.view.login.CapsLockTooltip</code>, we declare some configurations that are going<a id="id314" class="indexterm"/> to set the <a id="id315" class="indexterm"/>behavior of the <code class="literal">Tooltip</code> class. For example, we have the following:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">target</code>: This has<a id="id316" class="indexterm"/> the <code class="literal">id</code> value of the <code class="literal">password</code> field.</li><li class="listitem" style="list-style-type: disc"><code class="literal">anchor</code>: This <a id="id317" class="indexterm"/>indicates that the tip should be anchored to a particular side of the target element (the <code class="literal">password</code> <code class="literal">id</code> field), with an arrow pointing back at the target.</li><li class="listitem" style="list-style-type: disc"><code class="literal">anchorOffset</code>: This<a id="id318" class="indexterm"/> is a numeric value (in pixels) used to offset the default position of the anchor arrow. In this case, the arrow will be displayed 60 pixels after the tooltip box beginning.</li><li class="listitem" style="list-style-type: disc"><code class="literal">width</code>: This<a id="id319" class="indexterm"/> is the numeric value (in pixels) to represent the <code class="literal">width</code> of the tooltip box.</li><li class="listitem" style="list-style-type: disc"><code class="literal">dismissDelay</code>: This<a id="id320" class="indexterm"/> is the delay value (in milliseconds) before the tooltip automatically hides. As we do not want the tooltip to be automatically hidden, we set the value to <code class="literal">0</code> (zero) to disable it.</li><li class="listitem" style="list-style-type: disc"><code class="literal">autoHide</code>: Set <a id="id321" class="indexterm"/>it to <code class="literal">true</code> to automatically hide the tooltip after the mouse exits the target element. And as we do not want it, we set it to <code class="literal">false</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">title</code>: This <a id="id322" class="indexterm"/>is the title text to be used as the title of the tooltip.</li><li class="listitem" style="list-style-type: disc"><code class="literal">html</code>: This is <a id="id323" class="indexterm"/>the HTML fragment that will be displayed in the tooltip body.</li></ul></div><p>Note that on the title, we added a class to the <code class="literal">&lt;div&gt;</code> tag. This will display a warning icon from Font Awesome that we configured earlier.</p><div><div><h3 class="title"><a id="note30"/>Note</h3><p>To see all icons from <a id="id324" class="indexterm"/>Font Awesome that are available to be used in the application, please visit <a class="ulink" href="http://fortawesome.github.io/Font-Awesome/cheatsheet/">http://fortawesome.github.io/Font-Awesome/cheatsheet/</a>.</p></div></div><p>And at last, we need to make some changes in the <code class="literal">ViewController</code> class. First, in the <code class="literal">requires</code> declaration, we will add the <code class="literal">CapsLockTooltip</code> class:</p><div><pre class="programlisting">requires: [
<strong>    'Packt.view.login.CapsLockTooltip',</strong>
    'Packt.util.Util'
],</pre></div><p>Next, we are going<a id="id325" class="indexterm"/> to implement the <code class="literal">onTextFieldKeyPress</code> method, as follows:</p><div><pre class="programlisting">onTextFieldKeyPress: function(field, e, options){

    var charCode = e.getCharCode(),  
        me = this;

    if((e.shiftKey &amp;&amp; charCode &gt;= 97 &amp;&amp; charCode &lt;= 122) || //#2
        (!e.shiftKey &amp;&amp; charCode &gt;= 65 &amp;&amp; charCode &lt;= 90)){

        if(me.capslockTooltip === undefined){                 //#3
          me.capslockTooltip = Ext.widget('capslocktooltip'); //#4
        }

        me.capslockTooltip.show(); //#5

    } else {

        if(me.capslockTooltip !== undefined){ //#6
            me.capslockTooltip.hide();        //#7
        }
    }
},</pre></div><p>First, we need to get the <code class="literal">code</code> of the key that the user pressed (<code class="literal">#1</code>). Then, we need to verify that the <em>Shift</em> key is pressed and if the user pressed one of the small alphabet keys (a-z), or if the <em>Shift</em> key is not pressed and the user pressed one of the capital alphabet keys (A-Z) (<code class="literal">#2</code>). If the result of this verification is true, this means that the <em>Caps Lock</em> is active. If you want to check the values of<a id="id326" class="indexterm"/> each key, you can go to <a class="ulink" href="http://www.asciitable.com/">http://www.asciitable.com/</a>.</p><p>If the <em>Caps Lock</em> is active, we will verify that there is a reference of the <code class="literal">CapsLockTooltip</code> class (<code class="literal">#3</code>). If there is not, we will create a reference using its <code class="literal">xtype</code> (<code class="literal">#4</code>) and store it in a variable named <code class="literal">capslockTooltip</code>. This variable will be created as part of the <code class="literal">ViewController</code> class, so if this method is executed again, we can access it. Then, we display it by executing the method shown (<code class="literal">#5</code>).</p><p>If the <em>Caps Lock</em> is not active, we need to verify that there is a reference to the <code class="literal">CapsLockTooltip</code> class (<code class="literal">#6</code>). If positive, we will <code class="literal">hide</code> the tooltip because the <em>Caps Lock</em> is not active.</p><p>The Caps Lock warning code<a id="id327" class="indexterm"/> is now complete. We can save the project and test it.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec20"/>Summary</h1></div></div></div><p>In this chapter, we covered the details on how to implement a login page step by step. We covered how to create the login View and the <code class="literal">Login</code> <code class="literal">ViewController</code> class. We applied client validations on the form to make sure we send acceptable data to the server. We covered how to do a basic login using PHP, and we covered important concepts of how to handle the data that the server is going to send back to Ext JS.</p><p>We learned about some enhancements that we can apply to the <strong>Login</strong> screen, such as submitting the form when the user hit <em>Enter</em>, displaying a Caps Lock warning in the password field, and also how to apply a load mask on the form while it is sending data and waiting for information from the server.</p><p>We also added support to Font Awesome that will be used throughout our project.</p><p>In the next chapter, we will continue to work on the <strong>Login</strong> screen. We will learn how to add the multilingual capability and also implement the Logout and Session Monitor capabilities.</p></div></body></html>