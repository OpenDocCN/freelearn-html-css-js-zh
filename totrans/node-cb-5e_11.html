<html><head></head><body>
  <div id="_idContainer090">
   <h1 class="chapter-number" id="_idParaDest-345">
    <a id="_idTextAnchor353">
    </a>
    <span class="koboSpan" id="kobo.1.1">
     11
    </span>
   </h1>
   <h1 id="_idParaDest-346">
    <a id="_idTextAnchor354">
    </a>
    <span class="koboSpan" id="kobo.2.1">
     Deploying Node.js Microservices
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.3.1">
     The term
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.4.1">
      microservices
     </span>
    </strong>
    <span class="koboSpan" id="kobo.5.1">
     is used to
    </span>
    <a id="_idIndexMarker852">
    </a>
    <span class="koboSpan" id="kobo.6.1">
     describe applications that have been built based on the microservice architecture paradigm.
    </span>
    <span class="koboSpan" id="kobo.6.2">
     This architecture encourages larger applications to be built as a set of smaller modular applications, where each application focuses on one key concern.
    </span>
    <span class="koboSpan" id="kobo.6.3">
     Microservice architectures are a contrast to the monolithic architectures of the past.
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.7.1">
      Monolith
     </span>
    </strong>
    <span class="koboSpan" id="kobo.8.1">
     is a term given to an application
    </span>
    <a id="_idIndexMarker853">
    </a>
    <span class="koboSpan" id="kobo.9.1">
     that handles many
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.10.1">
      disparate concerns.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.11.1">
     There are numerous benefits to adopting a microservice architecture.
    </span>
    <span class="koboSpan" id="kobo.11.2">
     Ensuring that an application only serves one purpose means that the application can be optimized to best serve that purpose.
    </span>
    <span class="koboSpan" id="kobo.11.3">
     Microservices help to decouple various parts of a system, which can result in easier debuggability if something goes wrong.
    </span>
    <span class="koboSpan" id="kobo.11.4">
     Adopting a microservice architecture also enables you to scale different parts of the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.12.1">
      system independently.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.13.1">
     There are not only technical benefits to adopting a microservice architecture.
    </span>
    <span class="koboSpan" id="kobo.13.2">
     Separating microservices into separate code bases can enable smaller teams to have autonomy over the microservices they’re responsible for.
    </span>
    <span class="koboSpan" id="kobo.13.3">
     Many microservice-based systems are written in a variety of frameworks and languages.
    </span>
    <span class="koboSpan" id="kobo.13.4">
     Development teams can choose the language and framework they feel is best suited for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.14.1">
      their microservice.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.15.1">
     Microservices can, however, increase complexity due to the management of multiple services, which requires mature DevOps practices and comprehensive monitoring.
    </span>
    <span class="koboSpan" id="kobo.15.2">
     For this reason, microservices are often not suitable for simple applications where the management overhead outweighs
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.16.1">
      the benefits.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.17.1">
     Node.js microservices commonly
    </span>
    <a id="_idIndexMarker854">
    </a>
    <span class="koboSpan" id="kobo.18.1">
     expose
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.19.1">
      RESTful
     </span>
    </strong>
    <span class="koboSpan" id="kobo.20.1">
     APIs.
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.21.1">
      Representational State Transfer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.22.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.23.1">
      REST
     </span>
    </strong>
    <span class="koboSpan" id="kobo.24.1">
     ) is very
    </span>
    <a id="_idIndexMarker855">
    </a>
    <span class="koboSpan" id="kobo.25.1">
     popular.
    </span>
    <span class="koboSpan" id="kobo.25.2">
     A RESTful API exposes its API via HTTP, making appropriate use of the HTTP verbs.
    </span>
    <span class="koboSpan" id="kobo.25.3">
     For example, if a blogging service exposed a RESTful API, you’d expect it to expose an endpoint to which you could send an HTTP GET request to retrieve a blog post.
    </span>
    <span class="koboSpan" id="kobo.25.4">
     Similarly, it would likely expose an endpoint to which you could send an HTTP POST request, with data, to publish
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.26.1">
      new blogs.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.27.1">
     Microservices and container technologies go hand in hand.
    </span>
    <span class="koboSpan" id="kobo.27.2">
     Cloud and container technologies are growing in adoption, with Docker and Kubernetes, which are the leading choices for deploying
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.28.1">
      microservice-based applications.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.29.1">
     This chapter contains the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.30.1">
      following recipes:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.31.1">
      Generating a microservice
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.32.1">
       with LoopBack
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.33.1">
      Consuming
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.34.1">
       a microservice
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.35.1">
      Building a
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.36.1">
       Docker container
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.37.1">
      Publishing a
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.38.1">
       Docker image
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.39.1">
      Deploying
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.40.1">
       to Kubernetes
      </span>
     </span>
    </li>
   </ul>
   <h1 id="_idParaDest-347">
    <a id="_idTextAnchor355">
    </a>
    <span class="koboSpan" id="kobo.41.1">
     Technical requirements
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.42.1">
     You will need to have Node.js installed, preferably the latest version – Node.js 22.
    </span>
    <span class="koboSpan" id="kobo.42.2">
     You’ll also need access to an editor and browser of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.43.1">
      your choice.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.44.1">
     Before completing this chapter, it is recommended that you have some understanding of HTTP protocols – you can refer to
    </span>
    <a href="B19212_04.xhtml#_idTextAnchor100">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.45.1">
        Chapter 4
       </span>
      </em>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.46.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.47.1">
     The latter three recipes of this chapter will require you to have
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.48.1">
      Docker for Desktop
     </span>
    </strong>
    <span class="koboSpan" id="kobo.49.1">
     installed.
    </span>
    <span class="koboSpan" id="kobo.49.2">
     It is recommended to install Docker for Desktop
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.50.1">
      from
     </span>
    </span>
    <a href="https://docs.docker.com/engine/install/">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.51.1">
       https://docs.docker.com/engine/install/
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.52.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.53.1">
     The recipe code for this chapter can be found at
    </span>
    <a href="https://github.com/PacktPublishing/Node.js-Cookbook-Fifth-Edition">
     <span class="koboSpan" id="kobo.54.1">
      https://github.com/PacktPublishing/Node.js-Cookbook-Fifth-Edition
     </span>
    </a>
    <span class="koboSpan" id="kobo.55.1">
     in the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.56.1">
       Chapter11
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.57.1">
      folder.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-348">
    <a id="_idTextAnchor356">
    </a>
    <span class="koboSpan" id="kobo.58.1">
     Generating a microservice with LoopBack
    </span>
   </h1>
   <p>
    <strong class="bold">
     <span class="koboSpan" id="kobo.59.1">
      LoopBack
     </span>
    </strong>
    <span class="koboSpan" id="kobo.60.1">
     (
    </span>
    <a href="https://loopback.io/">
     <span class="koboSpan" id="kobo.61.1">
      https://loopback.io/
     </span>
    </a>
    <span class="koboSpan" id="kobo.62.1">
     ) is an
    </span>
    <a id="_idIndexMarker856">
    </a>
    <span class="koboSpan" id="kobo.63.1">
     extensible open source Node.js framework
    </span>
    <a id="_idIndexMarker857">
    </a>
    <span class="koboSpan" id="kobo.64.1">
     that is purpose-built for creating
    </span>
    <a id="_idIndexMarker858">
    </a>
    <span class="koboSpan" id="kobo.65.1">
     REST APIs and microservices.
    </span>
    <span class="koboSpan" id="kobo.65.2">
     Early versions of LoopBack were both inspired by and based directly on the Express.js web framework.
    </span>
    <span class="koboSpan" id="kobo.65.3">
     The most recent version, LoopBack 4, went through a significant refactor and was rewritten in TypeScript.
    </span>
    <span class="koboSpan" id="kobo.65.4">
     This refactor allowed the maintainers to expand the features of LoopBack without being restricted by the technical implementation decisions made in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.66.1">
      prior versions.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.67.1">
     In this recipe, we’re going to use
    </span>
    <a id="_idIndexMarker859">
    </a>
    <span class="koboSpan" id="kobo.68.1">
     the LoopBack 4
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.69.1">
      Command-Line Interface
     </span>
    </strong>
    <span class="koboSpan" id="kobo.70.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.71.1">
      CLI
     </span>
    </strong>
    <span class="koboSpan" id="kobo.72.1">
     ) to generate a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.73.1">
      Node.js microservice.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-349">
    <a id="_idTextAnchor357">
    </a>
    <span class="koboSpan" id="kobo.74.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.75.1">
     To prepare for the recipe, we need to globally install the LoopBack CLI.
    </span>
    <span class="koboSpan" id="kobo.75.2">
     Enter the following command in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.76.1">
      your terminal:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.77.1">
$ npm install --global @loopback/cli</span></pre>
   <p>
    <span class="koboSpan" id="kobo.78.1">
     Now that we have globally installed the LoopBack CLI, let’s move on to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.79.1">
      the recipe.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-350">
    <a id="_idTextAnchor358">
    </a>
    <span class="koboSpan" id="kobo.80.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.81.1">
     In this recipe, we’re going to generate a RESTful API, which will form our Node.js microservice.
    </span>
    <span class="koboSpan" id="kobo.81.2">
     The RESTful API that we will create will mimic a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.82.1">
      bookstore inventory:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.83.1">
      The LoopBack CLI should be available in your path as
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.84.1">
       lb4
      </span>
     </strong>
     <span class="koboSpan" id="kobo.85.1">
      .
     </span>
     <span class="koboSpan" id="kobo.85.2">
      To start generating the project, we call the LoopBack CLI, providing a project name.
     </span>
     <span class="koboSpan" id="kobo.85.3">
      Let’s give our project the name
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.86.1">
       loopback-bookstore
      </span>
     </strong>
     <span class="koboSpan" id="kobo.87.1">
      .
     </span>
     <span class="koboSpan" id="kobo.87.2">
      Enter the following command in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.88.1">
       your terminal:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.89.1">$ lb4 loopback-bookstore</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.90.1">
      Entering the command will start an interactive interface where the LoopBack CLI will request
     </span>
     <a id="_idIndexMarker860">
     </a>
     <span class="koboSpan" id="kobo.91.1">
      information
     </span>
     <a id="_idIndexMarker861">
     </a>
     <span class="koboSpan" id="kobo.92.1">
      for your new project.
     </span>
     <span class="koboSpan" id="kobo.92.2">
      For the project description, project root directory, and application class name, just hit
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.93.1">
       Enter
      </span>
     </em>
     <span class="koboSpan" id="kobo.94.1">
      to accept the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.95.1">
       default names.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.96.1">
      The fourth CLI question asks the user which features should be enabled in the project.
     </span>
     <span class="koboSpan" id="kobo.96.2">
      Hit
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.97.1">
       Enter
      </span>
     </em>
     <span class="koboSpan" id="kobo.98.1">
      to enable all features.
     </span>
     <span class="koboSpan" id="kobo.98.2">
      If you are shown a subsequent command detailing that Yarn is available, enter
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.99.1">
       N
      </span>
     </strong>
     <span class="koboSpan" id="kobo.100.1">
      to indicate we do not wish to enable it
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.101.1">
       by default.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.102.1">
      You should now see the LoopBack CLI scaffolding your application.
     </span>
     <span class="koboSpan" id="kobo.102.2">
      Expect to see output starting with the following in your terminal window, detailing files and directories that have
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.103.1">
       been created:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.104.1">
    force loopback-bookstore/.yo-rc.json
   create loopback-bookstore/.eslintignore
   create loopback-bookstore/.eslintrc.js
   create loopback-bookstore/.mocharc.json
   create loopback-bookstore/.prettierignore
   create loopback-bookstore/.prettierrc
   create loopback-bookstore/DEVELOPING.md
   create loopback-bookstore/package.json
   create loopback-bookstore/tsconfig.json
...</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.105.1">
      The LoopBack CLI has now generated our application.
     </span>
     <span class="koboSpan" id="kobo.105.2">
      It should have also automatically
     </span>
     <a id="_idIndexMarker862">
     </a>
     <span class="koboSpan" id="kobo.106.1">
      installed our
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.107.1">
       npm
      </span>
     </strong>
     <span class="koboSpan" id="kobo.108.1">
      dependencies.
     </span>
     <span class="koboSpan" id="kobo.108.2">
      Navigate
     </span>
     <a id="_idIndexMarker863">
     </a>
     <span class="koboSpan" id="kobo.109.1">
      to the application directory and start the application with the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.110.1">
       following commands:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.111.1">$ cd loopback-bookstore</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.112.1">$ npm install</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.113.1">$ npm start</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.114.1">
      If you navigate to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.115.1">
       http://localhost:3000
      </span>
     </strong>
     <span class="koboSpan" id="kobo.116.1">
      in your browser, you should expect to see the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.117.1">
       application running:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer076">
     <span class="koboSpan" id="kobo.118.1">
      <img alt="Figure 11.1 – The generated LoopBack home page for the LoopBack bookstore application" src="image/Figure_11.1_B19212.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.119.1">
     Figure 11.1 – The generated LoopBack home page for the LoopBack bookstore application
    </span>
   </p>
   <ol>
    <li value="7">
     <span class="koboSpan" id="kobo.120.1">
      Go back to your terminal and press
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.121.1">
       Ctrl
      </span>
     </em>
     <span class="koboSpan" id="kobo.122.1">
      +
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.123.1">
       C
      </span>
     </em>
     <span class="koboSpan" id="kobo.124.1">
      to stop the application.
     </span>
     <span class="koboSpan" id="kobo.124.2">
      So far, the LoopBack CLI has just generated a barebones project structure.
     </span>
     <span class="koboSpan" id="kobo.124.3">
      Now we can build our
     </span>
     <a id="_idIndexMarker864">
     </a>
     <span class="koboSpan" id="kobo.125.1">
      bookstore
     </span>
     <a id="_idIndexMarker865">
     </a>
     <span class="koboSpan" id="kobo.126.1">
      API.
     </span>
     <span class="koboSpan" id="kobo.126.2">
      We can do this using LoopBack’s model generator.
     </span>
     <span class="koboSpan" id="kobo.126.3">
      Enter the following command to start creating
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.127.1">
       a model:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.128.1">$ lb4 model</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.129.1">
      LoopBack’s model generator will open an interactive CLI where we can define the model and its properties.
     </span>
     <span class="koboSpan" id="kobo.129.2">
      The model we want to create is a book of the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.130.1">
       Entity
      </span>
     </strong>
     <span class="koboSpan" id="kobo.131.1">
      type.
     </span>
     <span class="koboSpan" id="kobo.131.2">
      First, add
     </span>
     <a id="_idIndexMarker866">
     </a>
     <span class="koboSpan" id="kobo.132.1">
      the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.133.1">
       id
      </span>
     </strong>
     <span class="koboSpan" id="kobo.134.1">
      property, which will be a number.
     </span>
     <span class="koboSpan" id="kobo.134.2">
      You’ll also need to add
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.135.1">
       author
      </span>
     </strong>
     <span class="koboSpan" id="kobo.136.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.137.1">
       title
      </span>
     </strong>
     <span class="koboSpan" id="kobo.138.1">
      properties to the model, which should both be mandatory and of the string type.
     </span>
     <span class="koboSpan" id="kobo.138.2">
      Enter these via the interactive session.
     </span>
     <span class="koboSpan" id="kobo.138.3">
      The transcript of the session should look like
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.139.1">
       the following:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer077">
     <span class="koboSpan" id="kobo.140.1">
      <img alt="Figure 11.2 – An overview of the expected transcript of the LoopBack model generator" src="image/Figure_11.2_B19212.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.141.1">
     Figure 11.2 – An overview of the expected transcript of the LoopBack model generator
    </span>
   </p>
   <ol>
    <li value="9">
     <span class="koboSpan" id="kobo.142.1">
      Now that we’ve
     </span>
     <a id="_idIndexMarker867">
     </a>
     <span class="koboSpan" id="kobo.143.1">
      created
     </span>
     <a id="_idIndexMarker868">
     </a>
     <span class="koboSpan" id="kobo.144.1">
      our model, we need to create our data source using LoopBack’s data source CLI.
     </span>
     <span class="koboSpan" id="kobo.144.2">
      Enter the following command in your
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.145.1">
       terminal window:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.146.1">$ lb4 datasource</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.147.1">
      The interactive CLI will request information about the data source.
     </span>
     <span class="koboSpan" id="kobo.147.2">
      We’re going to use an in-memory data store.
     </span>
     <span class="koboSpan" id="kobo.147.3">
      The values you should supply should be
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.148.1">
       Data source name: local
      </span>
     </strong>
     <span class="koboSpan" id="kobo.149.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.150.1">
       In-memory DB
      </span>
     </strong>
     <span class="koboSpan" id="kobo.151.1">
      .
     </span>
     <span class="koboSpan" id="kobo.151.2">
      For the last two questions, hit
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.152.1">
       Enter
      </span>
     </em>
     <span class="koboSpan" id="kobo.153.1">
      to accept the defaults.
     </span>
     <span class="koboSpan" id="kobo.153.2">
      Expect the transcript of your session to match
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.154.1">
       the following:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer078">
     <span class="koboSpan" id="kobo.155.1">
      <img alt="Figure 11.3 – An overview of the transcript of the LoopBack data source generator" src="image/Figure_11.3_B19212.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.156.1">
     Figure 11.3 – An overview of the transcript of the LoopBack data source generator
    </span>
   </p>
   <ol>
    <li value="11">
     <span class="koboSpan" id="kobo.157.1">
      Next, we need to create a LoopBack repository.
     </span>
     <span class="koboSpan" id="kobo.157.2">
      This is a LoopBack class that binds the data source and the model.
     </span>
     <span class="koboSpan" id="kobo.157.3">
      Enter the following command to start the repository
     </span>
     <a id="_idIndexMarker869">
     </a>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.158.1">
       generator
      </span>
     </span>
     <span class="No-Break">
      <a id="_idIndexMarker870">
      </a>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.159.1">
       interface:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.160.1">$ lb4 repository</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.161.1">
      For the repository, we want to use
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.162.1">
       LocalDatasource
      </span>
     </strong>
     <span class="koboSpan" id="kobo.163.1">
      for the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.164.1">
       Book
      </span>
     </strong>
     <span class="koboSpan" id="kobo.165.1">
      model with a
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.166.1">
       DefaultCrudRepository
      </span>
     </strong>
     <span class="koboSpan" id="kobo.167.1">
      base class.
     </span>
     <span class="koboSpan" id="kobo.167.2">
      The terminal should match the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.168.1">
       following
      </span>
     </span>
     <span class="No-Break">
      <a id="_idIndexMarker871">
      </a>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.169.1">
       output:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer079">
     <span class="koboSpan" id="kobo.170.1">
      <img alt="Figure 11.4 – Expected transcript of the LoopBack repository generator" src="image/Figure_11.4_B19212.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.171.1">
     Figure 11.4 – Expected transcript of the LoopBack repository generator
    </span>
   </p>
   <ol>
    <li value="13">
     <span class="koboSpan" id="kobo.172.1">
      Now, we need to create a LoopBack controller.
     </span>
     <span class="koboSpan" id="kobo.172.2">
      A LoopBack controller handles the API requests and responses.
     </span>
     <span class="koboSpan" id="kobo.172.3">
      Enter the following command to start the controller
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.173.1">
       generator interface:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.174.1">$ lb4 controller</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.175.1">
      Our controller should be a
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.176.1">
       REST Controller with Create, Read, Update, and Delete
      </span>
     </strong>
     <span class="koboSpan" id="kobo.177.1">
      (
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.178.1">
       CRUD
      </span>
     </strong>
     <span class="koboSpan" id="kobo.179.1">
      )
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.180.1">
       functions
      </span>
     </strong>
     <span class="koboSpan" id="kobo.181.1">
      named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.182.1">
       Books
      </span>
     </strong>
     <span class="koboSpan" id="kobo.183.1">
      .
     </span>
     <span class="koboSpan" id="kobo.183.2">
      For the remainder of the questions, you can
     </span>
     <a id="_idIndexMarker872">
     </a>
     <span class="koboSpan" id="kobo.184.1">
      accept
     </span>
     <a id="_idIndexMarker873">
     </a>
     <span class="koboSpan" id="kobo.185.1">
      the
     </span>
     <a id="_idIndexMarker874">
     </a>
     <span class="koboSpan" id="kobo.186.1">
      defaults by hitting
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.187.1">
       Enter
      </span>
     </em>
     <span class="koboSpan" id="kobo.188.1">
      .
     </span>
     <span class="koboSpan" id="kobo.188.2">
      The terminal should look
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.189.1">
       as follows:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer080">
     <span class="koboSpan" id="kobo.190.1">
      <img alt="Figure 11.5 – An overview of the transcript of the LoopBack controller generator" src="image/Figure_11.5_B19212.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.191.1">
     Figure 11.5 – An overview of the transcript of the LoopBack controller generator
    </span>
   </p>
   <ol>
    <li value="15">
     <span class="koboSpan" id="kobo.192.1">
      Start the application with
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.193.1">
       $ npm start
      </span>
     </strong>
     <span class="koboSpan" id="kobo.194.1">
      and navigate to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.195.1">
       http://localhost:3000/explorer/
      </span>
     </strong>
     <span class="koboSpan" id="kobo.196.1">
      .
     </span>
     <span class="koboSpan" id="kobo.196.2">
      This will open up the LoopBack API explorer that we can use to test our API.
     </span>
     <span class="koboSpan" id="kobo.196.3">
      Observe that the routes for various HTTP verbs have been automatically generated
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.197.1">
       for us:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer081">
     <span class="koboSpan" id="kobo.198.1">
      <img alt="Figure 11.6 – LoopBack API Explorer for the loopback-bookstore application" src="image/Figure_11.6_B19212.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.199.1">
     Figure 11.6 – LoopBack API Explorer for the loopback-bookstore application
    </span>
   </p>
   <ol>
    <li value="16">
     <span class="koboSpan" id="kobo.200.1">
      Navigate to the
     </span>
     <a id="_idIndexMarker875">
     </a>
     <span class="koboSpan" id="kobo.201.1">
      HTTP
     </span>
     <a id="_idIndexMarker876">
     </a>
     <span class="koboSpan" id="kobo.202.1">
      POST route in the explorer.
     </span>
     <span class="koboSpan" id="kobo.202.2">
      Clicking the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.203.1">
       Try it out
      </span>
     </strong>
     <span class="koboSpan" id="kobo.204.1">
      button will open an interface where you will be able to add a book to the inventory.
     </span>
     <span class="koboSpan" id="kobo.204.2">
      Change the sample
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.205.1">
       title
      </span>
     </strong>
     <span class="koboSpan" id="kobo.206.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.207.1">
       author
      </span>
     </strong>
     <span class="koboSpan" id="kobo.208.1">
      values and then
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.209.1">
       click
      </span>
     </span>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.210.1">
        Execute
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.211.1">
       :
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer082">
     <span class="koboSpan" id="kobo.212.1">
      <img alt="Figure 11.7 – LoopBack API Explorer request interface" src="image/Figure_11.7_B19212.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.213.1">
     Figure 11.7 – LoopBack API Explorer request interface
    </span>
   </p>
   <ol>
    <li value="17">
     <span class="koboSpan" id="kobo.214.1">
      Navigate to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.215.1">
       http://localhost:3000/books
      </span>
     </strong>
     <span class="koboSpan" id="kobo.216.1">
      .
     </span>
     <span class="koboSpan" id="kobo.216.2">
      This route will return a JSON array of all of
     </span>
     <a id="_idIndexMarker877">
     </a>
     <span class="koboSpan" id="kobo.217.1">
      the
     </span>
     <a id="_idIndexMarker878">
     </a>
     <span class="koboSpan" id="kobo.218.1">
      books stored.
     </span>
     <span class="koboSpan" id="kobo.218.2">
      Expect to see the book that we added in the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.219.1">
       previous step:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.220.1">
[{"id":1,"title":"Watership Down","author":"Richard Adams"}]</span></pre>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.221.1">
     We’ve generated a RESTful API that represents a bookstore inventory using the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.222.1">
      LoopBack CLI.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-351">
    <a id="_idTextAnchor359">
    </a>
    <span class="koboSpan" id="kobo.223.1">
     How it works…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.224.1">
     The recipe demonstrated how to build a RESTful API for a sample
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.225.1">
      bookstore inventory.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.226.1">
     The first command we supplied to the generator was
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.227.1">
      $ lb4 loopback-bookstore
     </span>
    </strong>
    <span class="koboSpan" id="kobo.228.1">
     .
    </span>
    <span class="koboSpan" id="kobo.228.2">
     This command scaffolds a LoopBack project structure for our application.
    </span>
    <span class="koboSpan" id="kobo.228.3">
     In the recipe, we enabled all the following
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.229.1">
      optional features:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.230.1">
       ESLint
      </span>
     </strong>
     <span class="koboSpan" id="kobo.231.1">
      : A popular linter
     </span>
     <a id="_idIndexMarker879">
     </a>
     <span class="koboSpan" id="kobo.232.1">
      with some pre-defined
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.233.1">
       linter rules
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.234.1">
       Prettier
      </span>
     </strong>
     <span class="koboSpan" id="kobo.235.1">
      : A popular code formatter that is used throughout the examples in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.236.1">
       this book
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.237.1">
       Mocha
      </span>
     </strong>
     <span class="koboSpan" id="kobo.238.1">
      : A Node.js
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.239.1">
       test framework
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.240.1">
       Loopback Build
      </span>
     </strong>
     <span class="koboSpan" id="kobo.241.1">
      : A set of LoopBack build helpers, exposed via the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.242.1">
       @
      </span>
     </strong>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.243.1">
        loopback/build
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.244.1">
       module
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.245.1">
       VSCode
      </span>
     </strong>
     <span class="koboSpan" id="kobo.246.1">
      : Configuration files for the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.247.1">
       VSCode editor
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.248.1">
       Docker
      </span>
     </strong>
     <span class="koboSpan" id="kobo.249.1">
      : Generates
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.250.1">
       Dockerfile
      </span>
     </strong>
     <span class="koboSpan" id="kobo.251.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.252.1">
       .dockerignore
      </span>
     </strong>
     <span class="koboSpan" id="kobo.253.1">
      for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.254.1">
       the application
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.255.1">
       Repositories
      </span>
     </strong>
     <span class="koboSpan" id="kobo.256.1">
      : Enables convenience methods that can automatically bind
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.257.1">
       repository classes
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.258.1">
       Services
      </span>
     </strong>
     <span class="koboSpan" id="kobo.259.1">
      : Includes service-proxy imports (refer to
     </span>
     <a href="https://loopback.io/doc/en/lb4/Service.html">
      <span class="koboSpan" id="kobo.260.1">
       https://loopback.io/doc/en/lb4/Service.html
      </span>
     </a>
     <span class="koboSpan" id="kobo.261.1">
      for more information
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.262.1">
       on services)
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.263.1">
     Once the optional features were selected, the LoopBack CLI generated a base application structure.
    </span>
    <span class="koboSpan" id="kobo.263.2">
     This
    </span>
    <a id="_idIndexMarker880">
    </a>
    <span class="koboSpan" id="kobo.264.1">
     structure
    </span>
    <a id="_idIndexMarker881">
    </a>
    <span class="koboSpan" id="kobo.265.1">
     includes directories and files related to the optional features that were selected.
    </span>
    <span class="koboSpan" id="kobo.265.2">
     For example, the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.266.1">
      eslintrc.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.267.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.268.1">
      mocharc.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.269.1">
     files were generated to configure ESLint
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.270.1">
      and Mocha.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.271.1">
     We used the LoopBack model generator to create representations of the data we needed to store.
    </span>
    <span class="koboSpan" id="kobo.271.2">
     In our case, we created one model named
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.272.1">
      Book
     </span>
    </strong>
    <span class="koboSpan" id="kobo.273.1">
     that contained the data we wished to store for each book.
    </span>
    <span class="koboSpan" id="kobo.273.2">
     The LoopBack generator assisted us in adding these properties, including specifying which type the properties should be and whether they are required or optional properties.
    </span>
    <span class="koboSpan" id="kobo.273.3">
     In larger and more complex APIs, it’s common to have multiple models, where some models may reference others, in a comparable manner to how relational databases
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.274.1">
      are structured.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.275.1">
     The model generator created our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.276.1">
      Book
     </span>
    </strong>
    <span class="koboSpan" id="kobo.277.1">
     model in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.278.1">
      src/models/book.model.ts
     </span>
    </strong>
    <span class="koboSpan" id="kobo.279.1">
     .
    </span>
    <span class="koboSpan" id="kobo.279.2">
     The model file contains a representation of a book in the form of a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.280.1">
      TypeScript class.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.281.1">
     After creating the model, we used the LoopBack data source generator to create a data source.
    </span>
    <span class="koboSpan" id="kobo.281.2">
     We opted to use an in-memory data source to avoid the need to provision an instance of a database.
    </span>
    <span class="koboSpan" id="kobo.281.3">
     Using an in-memory data source means that by default, when we stop our API from running, the data is lost.
    </span>
    <span class="koboSpan" id="kobo.281.4">
     LoopBack handles data source integrations, removing the need for the developer to create and set up the data store connection.
    </span>
    <span class="koboSpan" id="kobo.281.5">
     For the most part, this means the developer will not need to write code that is specific to the data store, making it easier to change between
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.282.1">
      data stores.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.283.1">
     With LoopBack 4, it is necessary to create a repository for our
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.284.1">
      Book
     </span>
    </strong>
    <span class="koboSpan" id="kobo.285.1">
     model.
    </span>
    <span class="koboSpan" id="kobo.285.2">
     A repository acts as an interface to a model, providing strong-typed
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.286.1">
      data operations.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.287.1">
     The final step of the recipe involved generating a controller to handle API requests and responses.
    </span>
    <span class="koboSpan" id="kobo.287.2">
     We instructed the generator to create a REST Controller with CRUD functions for the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.288.1">
      Book
     </span>
    </strong>
    <span class="koboSpan" id="kobo.289.1">
     model.
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.290.1">
      CRUD
     </span>
    </strong>
    <span class="koboSpan" id="kobo.291.1">
     covers the four basic functions that enable
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.292.1">
      persistent storage.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.293.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.294.1">
      Book
     </span>
    </strong>
    <span class="koboSpan" id="kobo.295.1">
     controller
    </span>
    <a id="_idIndexMarker882">
    </a>
    <span class="koboSpan" id="kobo.296.1">
     was
    </span>
    <a id="_idIndexMarker883">
    </a>
    <span class="koboSpan" id="kobo.297.1">
     created at
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.298.1">
      src/controllers/books.controller.ts
     </span>
    </strong>
    <span class="koboSpan" id="kobo.299.1">
     and contains generated functions to handle each REST API operation for our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.300.1">
      Book
     </span>
    </strong>
    <span class="koboSpan" id="kobo.301.1">
     model.
    </span>
    <span class="koboSpan" id="kobo.301.2">
     For example, the following code was generated in the controller to handle an HTTP GET request on the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.302.1">
      /books
     </span>
    </strong>
    <span class="koboSpan" id="kobo.303.1">
     route.
    </span>
    <span class="koboSpan" id="kobo.303.2">
     This route returns all books in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.304.1">
      data store:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.305.1">
@get('/books', {
    responses: {
      '200': {
        description: 'Array of Book model instances',
        content: {
          'application/json': {
            schema: {
              type: 'array',
              items: getModelSchemaRef(Book, {includeRelations: true}),
            },
          },
        },
      },
    },
  })
  async find(
    @param.filter(Book) filter?: Filter&lt;Book&gt;,
  ): Promise&lt;Book[]&gt; {
    return this.bookRepository.find(filter);
  }</span></pre>
   <p>
    <span class="koboSpan" id="kobo.306.1">
     The controller, repositories, and data sources that were created are all loaded and bound to the application at boot time.
    </span>
    <span class="koboSpan" id="kobo.306.2">
     This is handled by the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.307.1">
      @
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.308.1">
       loopback/boot
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.309.1">
      module.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.310.1">
     In the final part of the recipe, we used the API explorer (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.311.1">
      http://localhost:3000/explorer/
     </span>
    </strong>
    <span class="koboSpan" id="kobo.312.1">
     ) to send requests to our API.
    </span>
    <span class="koboSpan" id="kobo.312.2">
     The route explorer displays the
    </span>
    <a id="_idIndexMarker884">
    </a>
    <span class="koboSpan" id="kobo.313.1">
     available routes and provides
    </span>
    <a id="_idIndexMarker885">
    </a>
    <span class="koboSpan" id="kobo.314.1">
     sample requests for each route, allowing for an intuitive way to test your API.
    </span>
    <span class="koboSpan" id="kobo.314.2">
     This explorer is implemented using Swagger
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.315.1">
      UI (
     </span>
    </span>
    <a href="https://swagger.io/">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.316.1">
       https://swagger.io/
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.317.1">
      ).
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.318.1">
     LoopBack also allows for the generation of an OpenAPI specification document for the API, providing a standard interface for the RESTful API that includes human- and machine-readable definitions of the API routes.
    </span>
    <span class="koboSpan" id="kobo.318.2">
     This can be achieved by running the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.319.1">
      npm run openapi-spec ./open-api.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.320.1">
     command, which will create an
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.321.1">
      open-api.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.322.1">
     file containing the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.323.1">
      OpenAPI specification.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.324.1">
     This recipe highlighted that it is possible to generate a RESTful Node.js API without writing any code.
    </span>
    <span class="koboSpan" id="kobo.324.2">
     Once your base API has been generated, it would then be possible to extend the application with any necessary business logic.
    </span>
    <span class="koboSpan" id="kobo.324.3">
     LoopBack abstracts and handles some of the common technical tasks related to creating APIs, such as implementing CRUD operations.
    </span>
    <span class="koboSpan" id="kobo.324.4">
     This enables developers to focus on the business logic of their microservice, rather than
    </span>
    <a id="_idIndexMarker886">
    </a>
    <span class="koboSpan" id="kobo.325.1">
     underlying and repetitive
    </span>
    <a id="_idIndexMarker887">
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.326.1">
      technical implementations.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-352">
    <a id="_idTextAnchor360">
    </a>
    <span class="koboSpan" id="kobo.327.1">
     See also
    </span>
   </h2>
   <ul>
    <li>
     <a href="B19212_06.xhtml#_idTextAnchor178">
      <span class="No-Break">
       <em class="italic">
        <span class="koboSpan" id="kobo.328.1">
         Chapter 6
        </span>
       </em>
      </span>
     </a>
    </li>
    <li>
     <span class="koboSpan" id="kobo.329.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.330.1">
       Consuming a microservice
      </span>
     </em>
     <span class="koboSpan" id="kobo.331.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.332.1">
       this chapter
      </span>
     </span>
    </li>
   </ul>
   <h1 id="_idParaDest-353">
    <a id="_idTextAnchor361">
    </a>
    <span class="koboSpan" id="kobo.333.1">
     Consuming a microservice
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.334.1">
     In this recipe, we will create
    </span>
    <a id="_idIndexMarker888">
    </a>
    <span class="koboSpan" id="kobo.335.1">
     an Express.js web application that will consume the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.336.1">
      loopback-bookstore
     </span>
    </strong>
    <span class="koboSpan" id="kobo.337.1">
     microservice created in the previous recipe,
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.338.1">
      Generating a microservice with LoopBack
     </span>
    </em>
    <span class="koboSpan" id="kobo.339.1">
     .
    </span>
    <span class="koboSpan" id="kobo.339.2">
     This will demonstrate how modern web architectures are implemented based on the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.340.1">
      microservice pattern.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-354">
    <a id="_idTextAnchor362">
    </a>
    <span class="koboSpan" id="kobo.341.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.342.1">
     In this recipe, we will be consuming the microservice created in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.343.1">
      Generating a microservice with LoopBack
     </span>
    </em>
    <span class="koboSpan" id="kobo.344.1">
     recipe.
    </span>
    <span class="koboSpan" id="kobo.344.2">
     If you have not completed that recipe, you can obtain the code from the Packt GitHub repository at
    </span>
    <a href="https://github.com/PacktPublishing/Node.js-Cookbook-Fifth-Edition">
     <span class="koboSpan" id="kobo.345.1">
      https://github.com/PacktPublishing/Node.js-Cookbook-Fifth-Edition
     </span>
    </a>
    <span class="koboSpan" id="kobo.346.1">
     in the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.347.1">
       Chapter11/loopback-bookstore
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.348.1">
      directory.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.349.1">
     We will also be creating a frontend web application, using the Express.js generator to create a base for our web application.
    </span>
    <span class="koboSpan" id="kobo.349.2">
     For more information on the Express.js generator,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.350.1">
      visit
     </span>
    </span>
    <a href="https://expressjs.com/en/starter/generator.html">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.351.1">
       https://expressjs.com/en/starter/generator.html
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.352.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.353.1">
     Enter the following commands in your terminal to create the base application using the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.354.1">
      Express.js generator:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.355.1">
$ npx express-generator --view=ejs ./bookstore-web-app
$ cd bookstore-web-app
$ npm install</span></pre>
   <p>
    <span class="koboSpan" id="kobo.356.1">
     We will be creating a route and HTML form to add a book to the bookstore inventory.
    </span>
    <span class="koboSpan" id="kobo.356.2">
     Let’s create the files for those
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.357.1">
      in advance:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.358.1">
$ touch routes/inventory.js views/inventory.ejs</span></pre>
   <p>
    <span class="koboSpan" id="kobo.359.1">
     Now that we have a base Express.js web application, we’re ready to move on to the recipe steps, where we’ll extend the application to interact with the bookstore
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.360.1">
      inventory microservice.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-355">
    <a id="_idTextAnchor363">
    </a>
    <span class="koboSpan" id="kobo.361.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.362.1">
     We’re going to build a web application with Express.js that consumes our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.363.1">
      loopback-bookstore
     </span>
    </strong>
    <span class="koboSpan" id="kobo.364.1">
     microservice.
    </span>
    <span class="koboSpan" id="kobo.364.2">
     The web application should enable us to view the inventory and add a book to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.365.1">
      the inventory:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.366.1">
      Start by adding two routes to the application.
     </span>
     <span class="koboSpan" id="kobo.366.2">
      The first route we will add is a
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.367.1">
       /inventory
      </span>
     </strong>
     <span class="koboSpan" id="kobo.368.1">
      route that will accept an HTTP GET request.
     </span>
     <span class="koboSpan" id="kobo.368.2">
      This route will respond with a list of books in the inventory and an HTML form that can be used to add a book to the inventory.
     </span>
     <span class="koboSpan" id="kobo.368.3">
      The second route will accept an HTTP POST request on the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.369.1">
       /inventory/add
      </span>
     </strong>
     <span class="koboSpan" id="kobo.370.1">
      endpoint.
     </span>
     <span class="koboSpan" id="kobo.370.2">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.371.1">
       /inventory/add
      </span>
     </strong>
     <span class="koboSpan" id="kobo.372.1">
      route will interact with the bookstore inventory microservice to persist a new book.
     </span>
     <span class="koboSpan" id="kobo.372.2">
      Add the
     </span>
     <a id="_idIndexMarker889">
     </a>
     <span class="koboSpan" id="kobo.373.1">
      following to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.374.1">
       routes/inventory.j
      </span>
      <a id="_idTextAnchor364">
      </a>
      <span class="koboSpan" id="kobo.375.1">
       s
      </span>
     </strong>
     <span class="koboSpan" id="kobo.376.1">
      to create these
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.377.1">
       two routes:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.378.1">
const { Router } = require('express');
const router = Router();
router.get('/', function (req, res) {
  fetch('http://localhost:3000/books')
    .then((res) =&gt; res.json())
    .then((json) =&gt;
      res.render('inventory', {
        books: json,
      })
    );
});
router.post('/add', function (req, res) {
  console.log(req.body);
  fetch('http://localhost:3000/books', {
    method: "POST",
    body: JSON.stringify(req.body),
    headers: { 'Content-Type': 'application/json' },
  })
    .then(res.redirect('/inventory'))
    .catch((err) =&gt; {
      throw err;
    });
});
module.exports = router;</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.379.1">
      Now, in
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.380.1">
       app.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.381.1">
      , we need to
     </span>
     <a id="_idIndexMarker890">
     </a>
     <span class="koboSpan" id="kobo.382.1">
      register our new
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.383.1">
       inventory
      </span>
     </strong>
     <span class="koboSpan" id="kobo.384.1">
      router.
     </span>
     <span class="koboSpan" id="kobo.384.2">
      Add the following line to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.385.1">
       app.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.386.1">
      to first import the router using
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.387.1">
       var
      </span>
     </strong>
     <span class="koboSpan" id="kobo.388.1">
      to be consistent with the rest of the generated file.
     </span>
     <span class="koboSpan" id="kobo.388.2">
      Add the following just below the other
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.389.1">
       router imports:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.390.1">
var inventoryRouter = require('./routes/inventory');</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.391.1">
      Next, we need to instruct our Express.js application to use the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.392.1">
       inventory
      </span>
     </strong>
     <span class="koboSpan" id="kobo.393.1">
      router.
     </span>
     <span class="koboSpan" id="kobo.393.2">
      Add the following line below
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.394.1">
        app.use('/users', usersRouter);
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.395.1">
       :
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.396.1">
app.use('/inventory', inventoryRouter);</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.397.1">
      Our inventory routes reference
     </span>
     <a id="_idIndexMarker891">
     </a>
     <span class="koboSpan" id="kobo.398.1">
      an
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.399.1">
       Embedded JavaScript
      </span>
     </strong>
     <span class="koboSpan" id="kobo.400.1">
      (
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.401.1">
       EJS
      </span>
     </strong>
     <span class="koboSpan" id="kobo.402.1">
      ) template file named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.403.1">
       inventory.ejs
      </span>
     </strong>
     <span class="koboSpan" id="kobo.404.1">
      .
     </span>
     <span class="koboSpan" id="kobo.404.2">
      This template file will output a list of all books stored in the inventory and expose a form we can use to add books to the inventory.
     </span>
     <span class="koboSpan" id="kobo.404.3">
      Add the following to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.405.1">
       views/inventory.ejs
      </span>
     </strong>
     <span class="koboSpan" id="kobo.406.1">
      file we created in the
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.407.1">
       Getting started
      </span>
     </em>
     <span class="koboSpan" id="kobo.408.1">
      section
     </span>
     <a id="_idIndexMarker892">
     </a>
     <span class="koboSpan" id="kobo.409.1">
      of
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.410.1">
       this recipe:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.411.1">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Book Inventory&lt;/title&gt;
    &lt;link rel='stylesheet' href='/stylesheets/style.css' /&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Book Inventory&lt;/h1&gt;
    &lt;ul&gt;
        &lt;% for(let book of books) { %&gt;
            &lt;li&gt;&lt;%= book.title %&gt; - &lt;%= book.author %&gt;&lt;/li&gt;
        &lt;% } %&gt;
    &lt;/ul&gt;
    &lt;h2&gt;Add Book:&lt;/h2&gt;
    &lt;form action="/inventory/add" method="POST"&gt;
        &lt;label for="title"&gt;Title&lt;/label&gt;
        &lt;input type="text" name="title" /&gt;
        &lt;label for="author"&gt;Author&lt;/label&gt;
        &lt;input type="text" name="author" /&gt;
        &lt;button type="submit" value="Submit"&gt;Submit&lt;/button&gt;
    &lt;/form&gt;
  &lt;/body&gt;
&lt;/html&gt;</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.412.1">
      Start your
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.413.1">
       loopback-bookstore
      </span>
     </strong>
     <span class="koboSpan" id="kobo.414.1">
      microservice from the previous recipe.
     </span>
     <span class="koboSpan" id="kobo.414.2">
      Do this from within the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.415.1">
        loopback-bookstore
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.416.1">
       directory:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.417.1">$ npm start</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.418.1">
      Now, in a separate
     </span>
     <a id="_idIndexMarker893">
     </a>
     <span class="koboSpan" id="kobo.419.1">
      terminal window, start the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.420.1">
       bookstore-web-app
      </span>
     </strong>
     <span class="koboSpan" id="kobo.421.1">
      application with the following command.
     </span>
     <span class="koboSpan" id="kobo.421.2">
      We’ll also pass a
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.422.1">
       PORT
      </span>
     </strong>
     <span class="koboSpan" id="kobo.423.1">
      environment variable to the start command to set a custom port.
     </span>
     <span class="koboSpan" id="kobo.423.2">
      Express.js web applications default to port
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.424.1">
       3000
      </span>
     </strong>
     <span class="koboSpan" id="kobo.425.1">
      , but this will already be in use by our
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.426.1">
       loopback-bookstore
      </span>
     </strong>
     <span class="koboSpan" id="kobo.427.1">
      microservice, so we need to supply an alternative port.
     </span>
     <span class="koboSpan" id="kobo.427.2">
      Run the following command from the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.428.1">
        bookstore-web-app
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.429.1">
       directory:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.430.1">$ PORT=8080 npm start</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.431.1">
      Navigate to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.432.1">
       http://localhost:8080/inventory
      </span>
     </strong>
     <span class="koboSpan" id="kobo.433.1">
      in your browser and expect to see the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.434.1">
       following output:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer083">
     <span class="koboSpan" id="kobo.435.1">
      <img alt="Figure 11.8 – HTML page showing an empty bookstore inventory and an HTML form to add a new book" src="image/Figure_11.8_B19212.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.436.1">
     Figure 11.8 – HTML page showing an empty bookstore inventory and an HTML form to add a new book
    </span>
   </p>
   <ol>
    <li value="8">
     <span class="koboSpan" id="kobo.437.1">
      Now we can try
     </span>
     <a id="_idIndexMarker894">
     </a>
     <span class="koboSpan" id="kobo.438.1">
      adding a book to the inventory.
     </span>
     <span class="koboSpan" id="kobo.438.2">
      Populate the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.439.1">
       title
      </span>
     </strong>
     <span class="koboSpan" id="kobo.440.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.441.1">
       author
      </span>
     </strong>
     <span class="koboSpan" id="kobo.442.1">
      input fields and then click the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.443.1">
       Submit
      </span>
     </strong>
     <span class="koboSpan" id="kobo.444.1">
      button.
     </span>
     <span class="koboSpan" id="kobo.444.2">
      After submitting, you should expect to see the book you submitted added to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.445.1">
       the inventory:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer084">
     <span class="koboSpan" id="kobo.446.1">
      <img alt="Figure 11.9 – Web page showing a populated bookstore inventory" src="image/Figure_11.9_B19212.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.447.1">
     Figure 11.9 – Web page showing a populated bookstore inventory
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.448.1">
     We’ve successfully built
    </span>
    <a id="_idIndexMarker895">
    </a>
    <span class="koboSpan" id="kobo.449.1">
     a frontend web application that communicates with our
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.450.1">
       loopback-bookstore
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.451.1">
      microservice.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-356">
    <a id="_idTextAnchor365">
    </a>
    <span class="koboSpan" id="kobo.452.1">
     How it works…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.453.1">
     In the recipe, we implemented a frontend web application layer that was backed by our
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.454.1">
       loopback-bookstore
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.455.1">
      microservice.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.456.1">
     When our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.457.1">
      /inventory
     </span>
    </strong>
    <span class="koboSpan" id="kobo.458.1">
     web page loads, under the covers, the Express.js web frontend queries the data from the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.459.1">
      loopback microservice.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.460.1">
     Our Express.js server sends an HTTP POST request to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.461.1">
      http://localhost:3000/books
     </span>
    </strong>
    <span class="koboSpan" id="kobo.462.1">
     endpoint.
    </span>
    <span class="koboSpan" id="kobo.462.2">
     The request is supplied with the HTML
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.463.1">
      form data.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.464.1">
     Once the request to the LoopBack microservice is complete, the Express.js web application redirects to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.465.1">
      /inventory
     </span>
    </strong>
    <span class="koboSpan" id="kobo.466.1">
     route.
    </span>
    <span class="koboSpan" id="kobo.466.2">
     This refreshes the template, which will then list the newly
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.467.1">
      added book.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.468.1">
     This architecture demonstrates how you can modularize an application by building the backend API, in this case,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.469.1">
      loopback-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.470.1">
     , separately from the frontend web application.
    </span>
    <span class="koboSpan" id="kobo.470.2">
     This enables both applications to be scaled independently and keeps the code
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.471.1">
      loosely coupled.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.472.1">
     For larger systems, it’s
    </span>
    <a id="_idIndexMarker896">
    </a>
    <span class="koboSpan" id="kobo.473.1">
     common to have many microservices
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.474.1">
      communicating together.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-357">
    <a id="_idTextAnchor366">
    </a>
    <span class="koboSpan" id="kobo.475.1">
     See also
    </span>
   </h2>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.476.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.477.1">
       Receiving HTTP POST requests
      </span>
     </em>
     <span class="koboSpan" id="kobo.478.1">
      recipe in
     </span>
     <a href="B19212_04.xhtml#_idTextAnchor100">
      <span class="No-Break">
       <em class="italic">
        <span class="koboSpan" id="kobo.479.1">
         Chapter 4
        </span>
       </em>
      </span>
     </a>
    </li>
    <li>
     <a href="B19212_06.xhtml#_idTextAnchor178">
      <span class="No-Break">
       <em class="italic">
        <span class="koboSpan" id="kobo.480.1">
         Chapter 6
        </span>
       </em>
      </span>
     </a>
    </li>
    <li>
     <span class="koboSpan" id="kobo.481.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.482.1">
       Generating a microservice w
      </span>
      <a id="_idTextAnchor367">
      </a>
      <a id="_idTextAnchor368">
      </a>
      <span class="koboSpan" id="kobo.483.1">
       ith LoopBack
      </span>
     </em>
     <span class="koboSpan" id="kobo.484.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.485.1">
       this chapter
      </span>
     </span>
    </li>
   </ul>
   <h1 id="_idParaDest-358">
    <a id="_idTextAnchor369">
    </a>
    <span class="koboSpan" id="kobo.486.1">
     Building a Docker container
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.487.1">
     Once we have a Node.js microservice, we
    </span>
    <a id="_idIndexMarker897">
    </a>
    <span class="koboSpan" id="kobo.488.1">
     need to package it ready for deployment to the cloud.
    </span>
    <span class="koboSpan" id="kobo.488.2">
     Cloud and container technologies go hand in hand, and one of the most prevalent container technologies
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.489.1">
      is Docker.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.490.1">
     Docker is a tool used for creating, deploying, and running applications with containers.
    </span>
    <span class="koboSpan" id="kobo.490.2">
     A container enables you to package up your application with all its dependencies.
    </span>
    <span class="koboSpan" id="kobo.490.3">
     A container is often said to be like a virtual machine, the key difference being that Docker allows applications to reuse the same Linux kernel, whereas a virtual machine virtualizes the whole
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.491.1">
      operating system.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.492.1">
     The key benefit to containerizing a microservice is that it is encapsulated, which means that the container holds everything that the microservice requires in order to run.
    </span>
    <span class="koboSpan" id="kobo.492.2">
     This helps make the application portable and consistent
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.493.1">
      across machines.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.494.1">
     Container technologies such as Docker are seen as the de facto tools for deploying to modern cloud environments, often combined with a container orchestrator such as Kubernetes, which we’ll cover in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.495.1">
      Deploying to Kubernetes
     </span>
    </em>
    <span class="koboSpan" id="kobo.496.1">
     recipe of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.497.1">
      this chapter.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.498.1">
     Docker and Kubernetes are large and complex technologies.
    </span>
    <span class="koboSpan" id="kobo.498.2">
     This chapter will focus on demonstrating how to leverage Docker and Kubernetes to deploy Node.js microservices.
    </span>
    <span class="koboSpan" id="kobo.498.3">
     An in-depth overview of Docker and Kubernetes is beyond the scope of this book.
    </span>
    <span class="koboSpan" id="kobo.498.4">
     Refer to the following links for more detailed information about Docker
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.499.1">
      and Kubernetes:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.500.1">
      Kubernetes
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.501.1">
       overview:
      </span>
     </span>
     <a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/">
      <span class="No-Break">
       <span class="koboSpan" id="kobo.502.1">
        https://kubernetes.io/docs/tutorials/kubernetes-basics/
       </span>
      </span>
     </a>
    </li>
    <li>
     <span class="koboSpan" id="kobo.503.1">
      Kubernetes setup
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.504.1">
       guide:
      </span>
     </span>
     <a href="https://kubernetes.io/docs/setup/">
      <span class="No-Break">
       <span class="koboSpan" id="kobo.505.1">
        https://kubernetes.io/docs/setup/
       </span>
      </span>
     </a>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.506.1">
     In this recipe, we’ll be packaging a sample Node.js microservice into a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.507.1">
      Docker container.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-359">
    <a id="_idTextAnchor370">
    </a>
    <span class="koboSpan" id="kobo.508.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.509.1">
     For this recipe, you will need to have Docker installed.
    </span>
    <span class="koboSpan" id="kobo.509.2">
     It is recommended to install Docker for Desktop
    </span>
    <a id="_idIndexMarker898">
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.510.1">
      from
     </span>
    </span>
    <a href="https://docs.docker.com/engine/install/">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.511.1">
       https://docs.docker.com/engine/install/
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.512.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.513.1">
     Ensure Docker is running.
    </span>
    <span class="koboSpan" id="kobo.513.2">
     You can test this by entering the following command in your
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.514.1">
      terminal window:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.515.1">
$ docker run hello-world</span></pre>
   <p>
    <span class="koboSpan" id="kobo.516.1">
     This command pulls the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.517.1">
      hello-world
     </span>
    </strong>
    <span class="koboSpan" id="kobo.518.1">
     image from Docker Hub and creates a container to run it.
    </span>
    <span class="koboSpan" id="kobo.518.2">
     Docker Hub is a central repository of Docker images, almost like an
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.519.1">
      npm
     </span>
    </strong>
    <span class="koboSpan" id="kobo.520.1">
     registry for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.521.1">
      Docker images.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.522.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.523.1">
      hello-world
     </span>
    </strong>
    <span class="koboSpan" id="kobo.524.1">
     image is a sample image that you can use to test that Docker is installed and operating correctly.
    </span>
    <span class="koboSpan" id="kobo.524.2">
     When you run the image, expect to see
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.525.1">
      Hello from Docker!
     </span>
    </strong>
    <span class="koboSpan" id="kobo.526.1">
     returned along with additional
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.527.1">
      help text.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.528.1">
     We will also need an API, or microservice, to build into a Docker container.
    </span>
    <span class="koboSpan" id="kobo.528.2">
     We’ll use the Fastify CLI to generate an API.
    </span>
    <span class="koboSpan" id="kobo.528.3">
     For more information on Fastify, refer to
    </span>
    <a href="B19212_06.xhtml#_idTextAnchor178">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.529.1">
        Chapter 6
       </span>
      </em>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.530.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.531.1">
     Generate a sample API in a new directory named
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.532.1">
      fastify-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.533.1">
     by entering the following commands in your
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.534.1">
      terminal window:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.535.1">
$ npx fastify-cli generate fastify-microservice
$ cd fastify-microservice</span></pre>
   <p>
    <span class="koboSpan" id="kobo.536.1">
     Now that we have confirmed that Docker is installed and we have a sample microservice, we can move on to the recipe steps, where we’ll build
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.537.1">
      a container.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-360">
    <a id="_idTextAnchor371">
    </a>
    <span class="koboSpan" id="kobo.538.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.539.1">
     In this recipe, we will be building a container for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.540.1">
      our
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.541.1">
       fastify-microservice
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.542.1">
      :
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.543.1">
      Start by creating a
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.544.1">
       Dockerfile
      </span>
     </strong>
     <span class="koboSpan" id="kobo.545.1">
      file and a
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.546.1">
       .dockerignore
      </span>
     </strong>
     <span class="koboSpan" id="kobo.547.1">
      file in the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.548.1">
        fastify-microservice
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.549.1">
       directory:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.550.1">$ touch Dockerfile .dockerignore</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.551.1">
      A
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.552.1">
       Dockerfile
      </span>
     </strong>
     <span class="koboSpan" id="kobo.553.1">
      file is a set of instructions on how to build the container for our application or
     </span>
     <a id="_idIndexMarker899">
     </a>
     <span class="koboSpan" id="kobo.554.1">
      microservice.
     </span>
     <span class="koboSpan" id="kobo.554.2">
      Open the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.555.1">
       Dockerfile
      </span>
     </strong>
     <span class="koboSpan" id="kobo.556.1">
      file and add the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.557.1">
       following lines:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.558.1">
FROM node:22
WORKDIR "/app"
RUN apt-get update \
 &amp;&amp; apt-get dist-upgrade -y \
 &amp;&amp; apt-get clean \
 &amp;&amp; echo 'Finished installing dependencies'
COPY package*.json ./
RUN npm install --production
COPY . </span><span class="koboSpan" id="kobo.558.2">/app
ENV PORT 3000
EXPOSE 3000
USER node
CMD ["npm", "start"]</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.559.1">
      Next, we’ll create the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.560.1">
       .dockerignore
      </span>
     </strong>
     <span class="koboSpan" id="kobo.561.1">
      file.
     </span>
     <span class="koboSpan" id="kobo.561.2">
      Similar to a
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.562.1">
       .gitignore
      </span>
     </strong>
     <span class="koboSpan" id="kobo.563.1">
      file, the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.564.1">
       .dockerignore
      </span>
     </strong>
     <span class="koboSpan" id="kobo.565.1">
      file is used to exclude files from being built into a container.
     </span>
     <span class="koboSpan" id="kobo.565.2">
      Add the following to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.566.1">
       .
      </span>
     </strong>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.567.1">
        dockerignore
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.568.1">
       file:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.569.1">
.git
.gitignore
node_modules
npm-debug.log</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.570.1">
      We’re now ready to
     </span>
     <a id="_idIndexMarker900">
     </a>
     <span class="koboSpan" id="kobo.571.1">
      build the microservice.
     </span>
     <span class="koboSpan" id="kobo.571.2">
      We do this by using the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.572.1">
       docker build
      </span>
     </strong>
     <span class="koboSpan" id="kobo.573.1">
      command, along with
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.574.1">
       fastify-microservice
      </span>
     </strong>
     <span class="koboSpan" id="kobo.575.1">
      as a tag for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.576.1">
       our image:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.577.1">$ docker build --tag fastify-microservice .</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.578.1">
      Expect to see the following output as Docker builds
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.579.1">
       the image:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer085">
     <span class="koboSpan" id="kobo.580.1">
      <img alt="Figure 11.10 – Web page showing a populated bookstore inventory" src="image/Figure_11.10_B19212.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.581.1">
     Figure 11.10 – Web page showing a populated bookstore inventory
    </span>
   </p>
   <ol>
    <li value="6">
     <span class="koboSpan" id="kobo.582.1">
      Enter the following
     </span>
     <a id="_idIndexMarker901">
     </a>
     <span class="koboSpan" id="kobo.583.1">
      command in your terminal window to list all of your Docker images.
     </span>
     <span class="koboSpan" id="kobo.583.2">
      You should expect to see the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.584.1">
       fastify-microservice
      </span>
     </strong>
     <span class="koboSpan" id="kobo.585.1">
      Docker image in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.586.1">
       the list:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.587.1">$ docker images</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.588.1">
      Now we can run the Docker image as a Docker container, passing the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.589.1">
       --publish
      </span>
     </strong>
     <span class="koboSpan" id="kobo.590.1">
      flag to instruct Docker to map port
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.591.1">
       3000
      </span>
     </strong>
     <span class="koboSpan" id="kobo.592.1">
      from within the container to port
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.593.1">
       3000
      </span>
     </strong>
     <span class="koboSpan" id="kobo.594.1">
      on our local machine.
     </span>
     <span class="koboSpan" id="kobo.594.2">
      Enter the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.595.1">
       following command:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.596.1">$ docker run --publish 3000:3000 fastify-microservice</span></strong><span class="koboSpan" id="kobo.597.1">
&gt; fastify-microservice@1.0.0 start /app
&gt; fastify start -l info app.js
{"level":30,"time":1594555188739,"pid":19,"hostname":"f83abfa3276a","msg":"Server listening at http://0.0.0.0:3000"}</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.598.1">
      You should be able to navigate to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.599.1">
       http://localhost:3000/example
      </span>
     </strong>
     <span class="koboSpan" id="kobo.600.1">
      and see the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.601.1">
       this is an
      </span>
     </strong>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.602.1">
        example
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.603.1">
       output.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.604.1">
      Press
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.605.1">
       Ctrl
      </span>
     </em>
     <span class="koboSpan" id="kobo.606.1">
      +
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.607.1">
       C
      </span>
     </em>
     <span class="koboSpan" id="kobo.608.1">
      in your terminal window to stop
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.609.1">
       your container.
      </span>
     </span>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.610.1">
     We’ve now successfully built our first
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.611.1">
      containerized microservice.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-361">
    <a id="_idTextAnchor372">
    </a>
    <span class="koboSpan" id="kobo.612.1">
     How it works…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.613.1">
     Containers enable you to package your application into an isolated environment.
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.614.1">
      Dockerfile
     </span>
    </strong>
    <span class="koboSpan" id="kobo.615.1">
     is used to define the environment.
    </span>
    <span class="koboSpan" id="kobo.615.2">
     The environment should include the libraries and dependencies that are required to run the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.616.1">
      application code.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.617.1">
     Let’s examine the contents of the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.618.1">
       Dockerfile
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.619.1">
      file:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.620.1">
       FROM node:22
      </span>
     </strong>
     <span class="koboSpan" id="kobo.621.1">
      : The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.622.1">
       node
      </span>
     </strong>
     <span class="koboSpan" id="kobo.623.1">
      instruction is used to initialize a new build stage.
     </span>
     <span class="koboSpan" id="kobo.623.2">
      A
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.624.1">
       Dockerfile
      </span>
     </strong>
     <span class="koboSpan" id="kobo.625.1">
      file must start with a
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.626.1">
       FROM
      </span>
     </strong>
     <span class="koboSpan" id="kobo.627.1">
      instruction pointing to a valid Docker image that can be
     </span>
     <a id="_idIndexMarker902">
     </a>
     <span class="koboSpan" id="kobo.628.1">
      used as a base for our image.
     </span>
     <span class="koboSpan" id="kobo.628.2">
      In this example, the image is based on the Docker Official
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.629.1">
       Node.js image.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.630.1">
       RUN apt-get update...
      </span>
     </strong>
     <span class="koboSpan" id="kobo.631.1">
      : This line instructs Docker to update the containers’ OS dependencies using
     </span>
     <a id="_idIndexMarker903">
     </a>
     <span class="koboSpan" id="kobo.632.1">
      the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.633.1">
       Advanced Package Tool
      </span>
     </strong>
     <span class="koboSpan" id="kobo.634.1">
      (
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.635.1">
       APT
      </span>
     </strong>
     <span class="koboSpan" id="kobo.636.1">
      ), which is Debian’s default package manager.
     </span>
     <span class="koboSpan" id="kobo.636.2">
      It’s important that OS dependencies are up to date to ensure that your dependencies contain the latest available fixes
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.637.1">
       and patches.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.638.1">
       COPY package*.json ./
      </span>
     </strong>
     <span class="koboSpan" id="kobo.639.1">
      : This copies the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.640.1">
       package.json
      </span>
     </strong>
     <span class="koboSpan" id="kobo.641.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.642.1">
       package-lock.json
      </span>
     </strong>
     <span class="koboSpan" id="kobo.643.1">
      files, should they exist, into
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.644.1">
       the container.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.645.1">
       RUN npm install --production
      </span>
     </strong>
     <span class="koboSpan" id="kobo.646.1">
      : This executes the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.647.1">
       npm install
      </span>
     </strong>
     <span class="koboSpan" id="kobo.648.1">
      command within the container based on the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.649.1">
       package*.json
      </span>
     </strong>
     <span class="koboSpan" id="kobo.650.1">
      files copied earlier into the container.
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.651.1">
       npm install
      </span>
     </strong>
     <span class="koboSpan" id="kobo.652.1">
      must be run within the container as some dependencies may have native components that need to be built based on the container’s OS.
     </span>
     <span class="koboSpan" id="kobo.652.2">
      For example, if you’re developing locally on macOS and have native dependencies, you will not be able to just copy the contents of
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.653.1">
       node_modules
      </span>
     </strong>
     <span class="koboSpan" id="kobo.654.1">
      into the container, as the native macOS dependencies will not work in the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.655.1">
       Debian-based container.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.656.1">
       COPY .
      </span>
      <span class="koboSpan" id="kobo.656.2">
       /app.
      </span>
     </strong>
     <span class="koboSpan" id="kobo.657.1">
      : This copies our application code into the container.
     </span>
     <span class="koboSpan" id="kobo.657.2">
      Note that the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.658.1">
       COPY
      </span>
     </strong>
     <span class="koboSpan" id="kobo.659.1">
      command will ignore all patterns listed in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.660.1">
       .dockerignore
      </span>
     </strong>
     <span class="koboSpan" id="kobo.661.1">
      file.
     </span>
     <span class="koboSpan" id="kobo.661.2">
      This means that the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.662.1">
       COPY
      </span>
     </strong>
     <span class="koboSpan" id="kobo.663.1">
      command will not copy
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.664.1">
       node_modules
      </span>
     </strong>
     <span class="koboSpan" id="kobo.665.1">
      and other information to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.666.1">
       the container.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.667.1">
       ENV PORT 3000
      </span>
     </strong>
     <span class="koboSpan" id="kobo.668.1">
      : This sets the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.669.1">
       PORT
      </span>
     </strong>
     <span class="koboSpan" id="kobo.670.1">
      environment variable in the container
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.671.1">
       to
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.672.1">
        3000
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.673.1">
       .
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.674.1">
       EXPOSE 3000
      </span>
     </strong>
     <span class="koboSpan" id="kobo.675.1">
      : The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.676.1">
       EXPOSE
      </span>
     </strong>
     <span class="koboSpan" id="kobo.677.1">
      instruction is used as a form of documentation as to which port is intended to be published for the containerized application.
     </span>
     <span class="koboSpan" id="kobo.677.2">
      It does not publish
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.678.1">
       the port.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.679.1">
       USER node
      </span>
     </strong>
     <span class="koboSpan" id="kobo.680.1">
      : This instructs Docker to run the image as the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.681.1">
       node
      </span>
     </strong>
     <span class="koboSpan" id="kobo.682.1">
      user.
     </span>
     <span class="koboSpan" id="kobo.682.2">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.683.1">
       node
      </span>
     </strong>
     <span class="koboSpan" id="kobo.684.1">
      user is created by the Docker Official Node.js image.
     </span>
     <span class="koboSpan" id="kobo.684.2">
      When omitted, the image will default to being run as the root user.
     </span>
     <span class="koboSpan" id="kobo.684.3">
      You should run your containers as an unprivileged (non-root) user where possible as
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.685.1">
       security mitigation.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.686.1">
       CMD ["npm", "start"]
      </span>
     </strong>
     <span class="koboSpan" id="kobo.687.1">
      : This executes the command to start
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.688.1">
       the application.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.689.1">
     The ordering of the
    </span>
    <a id="_idIndexMarker904">
    </a>
    <span class="koboSpan" id="kobo.690.1">
     commands in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.691.1">
      Dockerfile
     </span>
    </strong>
    <span class="koboSpan" id="kobo.692.1">
     is important.
    </span>
    <span class="koboSpan" id="kobo.692.2">
     For each command in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.693.1">
      Dockerfile
     </span>
    </strong>
    <span class="koboSpan" id="kobo.694.1">
     file, Docker creates a new layer in the image.
    </span>
    <span class="koboSpan" id="kobo.694.2">
     Docker will only rebuild the layers that have changed, so the ordering of the commands in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.695.1">
      Dockerfile
     </span>
    </strong>
    <span class="koboSpan" id="kobo.696.1">
     file can impact rebuild times.
    </span>
    <span class="koboSpan" id="kobo.696.2">
     It is for this reason that we copy the application code into the container after running
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.697.1">
      npm install
     </span>
    </strong>
    <span class="koboSpan" id="kobo.698.1">
     , as we’re more commonly going to be changing the application code as opposed to changing
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.699.1">
      our dependencies.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.700.1">
     It’s possible to view the Docker layers for an image using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.701.1">
      docker history
     </span>
    </strong>
    <span class="koboSpan" id="kobo.702.1">
     command.
    </span>
    <span class="koboSpan" id="kobo.702.2">
     For example,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.703.1">
      $ docker history fastify-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.704.1">
     will output the layers of our
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.705.1">
       fastify-microservice
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.706.1">
      image:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer086">
     <span class="koboSpan" id="kobo.707.1">
      <img alt="Figure 11.11 – An overview of Docker history output for the fastify-microservice image" src="image/Figure_11.11_B19212.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.708.1">
     Figure 11.11 – An overview of Docker history output for the fastify-microservice image
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.709.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.710.1">
      $ docker build --tag fastify-microservice .
     </span>
    </strong>
    <span class="koboSpan" id="kobo.711.1">
     command builds the Docker image, based
    </span>
    <a id="_idIndexMarker905">
    </a>
    <span class="koboSpan" id="kobo.712.1">
     on the instructions in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.713.1">
      Dockerfile
     </span>
    </strong>
    <span class="koboSpan" id="kobo.714.1">
     file in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.715.1">
      current directory.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.716.1">
     To run the image, we call
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.717.1">
      docker run --publish 3000:3000 fastify-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.718.1">
     .
    </span>
    <span class="koboSpan" id="kobo.718.2">
     We pass this command the name of the image we’d like to run, and also the port we wish to expose.
    </span>
    <span class="koboSpan" id="kobo.718.3">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.719.1">
      --publish 3000:3000
     </span>
    </strong>
    <span class="koboSpan" id="kobo.720.1">
     option maps port
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.721.1">
      3000
     </span>
    </strong>
    <span class="koboSpan" id="kobo.722.1">
     on your host machine to port
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.723.1">
      3000
     </span>
    </strong>
    <span class="koboSpan" id="kobo.724.1">
     on the container, ensuring that any traffic sent to port
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.725.1">
      3000
     </span>
    </strong>
    <span class="koboSpan" id="kobo.726.1">
     on the host is forwarded to port
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.727.1">
      3000
     </span>
    </strong>
    <span class="koboSpan" id="kobo.728.1">
     in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.729.1">
      the container.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-362">
    <a id="_idTextAnchor373">
    </a>
    <span class="koboSpan" id="kobo.730.1">
     There’s more…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.731.1">
     When creating a Docker image, it’s important to make it as small as possible.
    </span>
    <span class="koboSpan" id="kobo.731.2">
     It’s considered good practice for your production image to only contain the dependencies and libraries required to run the application in production.
    </span>
    <span class="koboSpan" id="kobo.731.3">
     To create a smaller image, we can leverage Docker’s multistage builds
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.732.1">
      capability (
     </span>
    </span>
    <a href="https://docs.docker.com/develop/develop-images/multistage-build/">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.733.1">
       https://docs.docker.com/develop/develop-images/multistage-build/
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.734.1">
      ).
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.735.1">
     Docker multistage builds allow us to define multiple Docker images in the same
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.736.1">
      Dockerfile
     </span>
    </strong>
    <span class="koboSpan" id="kobo.737.1">
     file.
    </span>
    <span class="koboSpan" id="kobo.737.2">
     For Node.js applications, we can split the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.738.1">
      build
     </span>
    </em>
    <span class="koboSpan" id="kobo.739.1">
     and
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.740.1">
      run
     </span>
    </em>
    <span class="koboSpan" id="kobo.741.1">
     steps into separate containers.
    </span>
    <span class="koboSpan" id="kobo.741.2">
     The result is that the final production container, the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.742.1">
      run
     </span>
    </strong>
    <span class="koboSpan" id="kobo.743.1">
     container, will be a smaller and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.744.1">
      lighter-weight container.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.745.1">
     We could use the
    </span>
    <a id="_idIndexMarker906">
    </a>
    <span class="koboSpan" id="kobo.746.1">
     following multistage
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.747.1">
      Dockerfile
     </span>
    </strong>
    <span class="koboSpan" id="kobo.748.1">
     file
    </span>
    <a id="_idTextAnchor374">
    </a>
    <span class="koboSpan" id="kobo.749.1">
     to containerize
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.750.1">
      our
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.751.1">
       fastify-microservice
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.752.1">
      :
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.753.1">
FROM node:22
WORKDIR "/app"
RUN apt-get update \
 &amp;&amp; apt-get dist-upgrade -y \
 &amp;&amp; apt-get clean \
 &amp;&amp; echo 'Finished installing dependencies'
COPY package*.json ./
RUN npm install --production
FROM node:22-slim
WORKDIR "/app"
RUN apt-get update \
 &amp;&amp; apt-get dist-upgrade -y \
 &amp;&amp; apt-get clean \
 &amp;&amp; echo 'Finished installing dependencies'
COPY --from=0 /app/node_modules /app/node_modules
COPY . </span><span class="koboSpan" id="kobo.753.2">/app
ENV NODE_ENV production
ENV PORT 3000
USER node
EXPOSE 3000
CMD ["npm", "start"]</span></pre>
   <p>
    <span class="koboSpan" id="kobo.754.1">
     Observe that there are two
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.755.1">
      FROM
     </span>
    </strong>
    <span class="koboSpan" id="kobo.756.1">
     instructions in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.757.1">
      Dockerfile
     </span>
    </strong>
    <span class="koboSpan" id="kobo.758.1">
     file, indicating that there are two
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.759.1">
      build stages.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.760.1">
     The first build stage creates a container that handles the installation of dependencies and any build tasks.
    </span>
    <span class="koboSpan" id="kobo.760.2">
     In our example, the first container executes the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.761.1">
      npm install
     </span>
    </strong>
    <span class="koboSpan" id="kobo.762.1">
     command.
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.763.1">
      node_modules
     </span>
    </strong>
    <span class="koboSpan" id="kobo.764.1">
     may contain native add-ons, which means the first container needs the relevant compilers
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.765.1">
      and dependencies.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.766.1">
     The second container uses a base of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.767.1">
      node:22-slim
     </span>
    </strong>
    <span class="koboSpan" id="kobo.768.1">
     image.
    </span>
    <span class="koboSpan" id="kobo.768.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.769.1">
      node:22-slim
     </span>
    </strong>
    <span class="koboSpan" id="kobo.770.1">
     image is a variant of
    </span>
    <a id="_idIndexMarker907">
    </a>
    <span class="koboSpan" id="kobo.771.1">
     the official Node.js Docker image that contains the minimum libraries required to run Node.js.
    </span>
    <span class="koboSpan" id="kobo.771.2">
     This image is a much smaller and lighter-weight image.
    </span>
    <span class="koboSpan" id="kobo.771.3">
     The regular
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.772.1">
      node
     </span>
    </strong>
    <span class="koboSpan" id="kobo.773.1">
     Docker image is around 1 GB in size, whereas the multi-stage
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.774.1">
      slim
     </span>
    </strong>
    <span class="koboSpan" id="kobo.775.1">
     image is around 200 MB.
    </span>
    <span class="koboSpan" id="kobo.775.2">
     When deploying to the cloud, in many cases, you’ll be charged per MB.
    </span>
    <span class="koboSpan" id="kobo.775.3">
     Minimizing your image size can result in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.776.1">
      cost savings.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.777.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.778.1">
     Once you’ve completed the recipes in this chapter, you should stop and remove the Docker containers and images.
    </span>
    <span class="koboSpan" id="kobo.778.2">
     Otherwise, the containers and images may linger on your system and consume system resources.
    </span>
    <span class="koboSpan" id="kobo.778.3">
     Use
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.779.1">
      $ docker ps
     </span>
    </strong>
    <span class="koboSpan" id="kobo.780.1">
     to list your containers.
    </span>
    <span class="koboSpan" id="kobo.780.2">
     Locate the container identifier and pass this to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.781.1">
      $ docker stop &lt;containerID&gt;
     </span>
    </strong>
    <span class="koboSpan" id="kobo.782.1">
     to stop a container.
    </span>
    <span class="koboSpan" id="kobo.782.2">
     Follow this up with
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.783.1">
      $ docker rm -f &lt;containerID&gt;
     </span>
    </strong>
    <span class="koboSpan" id="kobo.784.1">
     to remove a container.
    </span>
    <span class="koboSpan" id="kobo.784.2">
     Similarly, to remove a Docker image, use the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.785.1">
      $ docker image rm &lt;image&gt;
     </span>
    </strong>
    <span class="koboSpan" id="kobo.786.1">
     command.
    </span>
    <span class="koboSpan" id="kobo.786.2">
     You can also use (with caution) the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.787.1">
      $ docker system prune --all
     </span>
    </strong>
    <span class="koboSpan" id="kobo.788.1">
     command to remove all images and containers on
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.789.1">
      your system.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-363">
    <a id="_idTextAnchor375">
    </a>
    <span class="koboSpan" id="kobo.790.1">
     See also
    </span>
   </h2>
   <ul>
    <li>
     <a href="B19212_06.xhtml#_idTextAnchor178">
      <span class="No-Break">
       <em class="italic">
        <span class="koboSpan" id="kobo.791.1">
         Chapter 6
        </span>
       </em>
      </span>
     </a>
    </li>
    <li>
     <span class="koboSpan" id="kobo.792.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.793.1">
       Publishing a Docker image
      </span>
     </em>
     <span class="koboSpan" id="kobo.794.1">
      recipe
     </span>
     <a id="_idIndexMarker908">
     </a>
     <span class="koboSpan" id="kobo.795.1">
      in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.796.1">
       this chapter
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.797.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.798.1">
       Deploying to Kubernetes
      </span>
     </em>
     <span class="koboSpan" id="kobo.799.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.800.1">
       this chapter
      </span>
     </span>
    </li>
   </ul>
   <h1 id="_idParaDest-364">
    <a id="_idTextAnchor376">
    </a>
    <span class="koboSpan" id="kobo.801.1">
     Publishing a Docker image
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.802.1">
     Docker Hub provides a
    </span>
    <a id="_idIndexMarker909">
    </a>
    <span class="koboSpan" id="kobo.803.1">
     global repository of images.
    </span>
    <span class="koboSpan" id="kobo.803.2">
     Throughout this chapter and
    </span>
    <a href="B19212_07.xhtml#_idTextAnchor212">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.804.1">
        Chapter 7
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.805.1">
     , we’ve pulled Docker images that were stored in the Docker Hub repository.
    </span>
    <span class="koboSpan" id="kobo.805.2">
     This includes the Docker Official Node.js image, which we used as a basis for our image in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.806.1">
      Building a Docker container
     </span>
    </em>
    <span class="koboSpan" id="kobo.807.1">
     recipe in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.808.1">
      this chapter.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.809.1">
     In this recipe, we’re going to publish our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.810.1">
      fastify-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.811.1">
     image to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.812.1">
      Docker Hub.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-365">
    <a id="_idTextAnchor377">
    </a>
    <span class="koboSpan" id="kobo.813.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.814.1">
     This recipe will use the image created in the previous recipe,
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.815.1">
      Building a
     </span>
    </em>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.816.1">
       Docker container
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.817.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.818.1">
     If you haven’t completed that recipe, the code is available in the Packt GitHub repository (
    </span>
    <a href="https://github.com/PacktPublishing/Node.js-Cookbook-Fifth-Edition">
     <span class="koboSpan" id="kobo.819.1">
      https://github.com/PacktPublishing/Node.js-Cookbook-Fifth-Edition
     </span>
    </a>
    <span class="koboSpan" id="kobo.820.1">
     ) in the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.821.1">
       Chapter11/fastify-microservice
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.822.1">
      directory.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-366">
    <a id="_idTextAnchor378">
    </a>
    <span class="koboSpan" id="kobo.823.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.824.1">
     In this recipe, we’re going to sign up for a Docker Hub account and publish our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.825.1">
      fastify-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.826.1">
     image to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.827.1">
      Docker Hub:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.828.1">
      First, we need to create a Docker Hub account.
     </span>
     <span class="koboSpan" id="kobo.828.2">
      Visit
     </span>
     <a href="https://hub.docker.com/signup">
      <span class="koboSpan" id="kobo.829.1">
       https://hub.docker.com/signup
      </span>
     </a>
     <span class="koboSpan" id="kobo.830.1">
      to create an account.
     </span>
     <span class="koboSpan" id="kobo.830.2">
      You will need to enter your details and click
     </span>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.831.1">
        Sign up
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.832.1">
       .
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.833.1">
      Once you’ve created your Docker Hub account, you need to authenticate your Docker client.
     </span>
     <span class="koboSpan" id="kobo.833.2">
      Do this by entering the following command in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.834.1">
       your terminal:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.835.1">$ docker login</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.836.1">
      Once we have authenticated our Docker client, we then need to retag our image for it to be pushed to Docker Hub.
     </span>
     <span class="koboSpan" id="kobo.836.2">
      Tag the image with the following command, substituting
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.837.1">
       &lt;namespace&gt;
      </span>
     </strong>
     <span class="koboSpan" id="kobo.838.1">
      with your Docker
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.839.1">
       Hub ID:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.840.1">$ docker tag fastify-microservice &lt;namespace&gt;/fastify-microservice</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.841.1">
      Now, we need to
     </span>
     <a id="_idIndexMarker910">
     </a>
     <span class="koboSpan" id="kobo.842.1">
      push the newly tagged image using the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.843.1">
       docker
      </span>
     </strong>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.844.1">
        push
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.845.1">
       command:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.846.1">$ docker push &lt;namespace&gt;/fastify-microservice</span></strong><span class="koboSpan" id="kobo.847.1">
Using default tag: latest
The push refers to repository [docker.io/&lt;namespace&gt;/fastify-microservice]
2e4fc733214e: Preparing
f4ab51cf75a4: Preparing
92f894697ee2: Preparing
69619ce237eb: Preparing
3e23088f380e: Preparing
...</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.848.1">
      You can now navigate to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.849.1">
       https://hub.docker.com/repository/docker/&lt;namespace&gt;/fastify-microservice
      </span>
     </strong>
     <span class="koboSpan" id="kobo.850.1">
      to verify that your image has been published to Docker Hub.
     </span>
     <span class="koboSpan" id="kobo.850.2">
      Again, you’ll need to substitute
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.851.1">
       &lt;namespace&gt;
      </span>
     </strong>
     <span class="koboSpan" id="kobo.852.1">
      with your Docker Hub ID.
     </span>
     <span class="koboSpan" id="kobo.852.2">
      Expect to see output similar to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.853.1">
       the following:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer087">
     <span class="koboSpan" id="kobo.854.1">
      <img alt="Figure 11.12 – Docker Hub view of the published fastify-microservice image" src="image/Figure_11.12_B19212.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.855.1">
     Figure 11.12 – Docker Hub view of the published fastify-microservice image
    </span>
   </p>
   <ol>
    <li value="6">
     <span class="koboSpan" id="kobo.856.1">
      If you click on
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.857.1">
       Tags
      </span>
     </strong>
     <span class="koboSpan" id="kobo.858.1">
      , you
     </span>
     <a id="_idIndexMarker911">
     </a>
     <span class="koboSpan" id="kobo.859.1">
      should see that our Docker image has one tag
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.860.1">
       named
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.861.1">
        latest
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.862.1">
       .
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.863.1">
      It is also now possible to pull the image with the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.864.1">
       following command:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.865.1">$ docker pull &lt;namespace&gt;/fastify-microservice</span></strong></pre>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.866.1">
     We’ve pushed a Docker image containing our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.867.1">
      fastify-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.868.1">
     image to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.869.1">
      Docker Hub.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-367">
    <a id="_idTextAnchor379">
    </a>
    <span class="koboSpan" id="kobo.870.1">
     How it works…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.871.1">
     We first tagged the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.872.1">
      fastify-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.873.1">
     image with the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.874.1">
      &lt;namespace&gt;/fastify-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.875.1">
     tag.
    </span>
    <span class="koboSpan" id="kobo.875.2">
     This tag format instructs Docker that this image is associated with a repository on Docker Hub.
    </span>
    <span class="koboSpan" id="kobo.875.3">
     Once we’ve appropriately tagged our image, we use the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.876.1">
      docker push
     </span>
    </strong>
    <span class="koboSpan" id="kobo.877.1">
     command to publish the image to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.878.1">
      Docker Hub.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.879.1">
     By default, our Docker Hub image will be publicly accessible.
    </span>
    <span class="koboSpan" id="kobo.879.2">
     Production microservices are not typically expected to be published publicly to Docker Hub to avoid exposing any proprietary code or secrets.
    </span>
    <span class="koboSpan" id="kobo.879.3">
     Docker Hub does provide private image functionality, but users are limited to one private registry on Docker Hub’s free account plan.
    </span>
    <span class="koboSpan" id="kobo.879.4">
     It is possible to sign up for a paid account plan with Docker Hub, which provides unlimited
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.880.1">
      private repositories.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.881.1">
     When deploying images for use in production-grade systems, it is common to create a private Docker registry.
    </span>
    <span class="koboSpan" id="kobo.881.2">
     Docker exposes a registry image (
    </span>
    <a href="https://hub.docker.com/_/registry">
     <span class="koboSpan" id="kobo.882.1">
      https://hub.docker.com/_/registry
     </span>
    </a>
    <span class="koboSpan" id="kobo.883.1">
     ) that can be used to provision a private registry.
    </span>
    <span class="koboSpan" id="kobo.883.2">
     For more information on setting up a private registry, refer
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.884.1">
      to
     </span>
    </span>
    <a href="https://docs.docker.com/registry/deploying/">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.885.1">
       https://docs.docker.com/registry/deploying/
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.886.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.887.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.888.1">
      &lt;IP&gt;:&lt;PORT&gt;/&lt;IMAGE&gt;
     </span>
    </strong>
    <span class="koboSpan" id="kobo.889.1">
     format is used when referring to images stored in private registries, where the IP is the address of the private registry.
    </span>
    <span class="koboSpan" id="kobo.889.2">
     Many of the leading cloud providers also provide
    </span>
    <a id="_idIndexMarker912">
    </a>
    <span class="koboSpan" id="kobo.890.1">
     commercial container registry solutions, which can be used to avoid the overhead of managing a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.891.1">
      container registry.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-368">
    <a id="_idTextAnchor380">
    </a>
    <span class="koboSpan" id="kobo.892.1">
     There’s more…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.893.1">
     In this recipe, we did not specify a version tag for our Docker image.
    </span>
    <span class="koboSpan" id="kobo.893.2">
     Therefore, Docker defaulted to creating the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.894.1">
      latest
     </span>
    </strong>
    <span class="koboSpan" id="kobo.895.1">
     version tag for our image.
    </span>
    <span class="koboSpan" id="kobo.895.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.896.1">
      latest
     </span>
    </strong>
    <span class="koboSpan" id="kobo.897.1">
     tag is automatically updated each time we rebuild our image without explicitly specifying a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.898.1">
      version tag.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.899.1">
     It is generally considered good practice to version Docker Hub images similar to how you’d version an application.
    </span>
    <span class="koboSpan" id="kobo.899.2">
     Versioning Docker Hub images provides a history of images, which makes it possible to roll back to earlier image versions should something
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.900.1">
      go wrong.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.901.1">
     We can tag our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.902.1">
      fastify-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.903.1">
     image with the following command, substituting the namespace for our Docker
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.904.1">
      Hub username:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.905.1">
$ docker tag fastify-microservice &lt;namespace&gt;/fastify-microservice:1.0.0</span></pre>
   <p>
    <span class="koboSpan" id="kobo.906.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.907.1">
      1.0.0
     </span>
    </strong>
    <span class="koboSpan" id="kobo.908.1">
     version is specified in the preceding command to match the version declared in our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.909.1">
      package.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.910.1">
     file.
    </span>
    <span class="koboSpan" id="kobo.910.2">
     This is just one of many approaches we can take to versioning as there is no formal standard for how Docker images should be versioned.
    </span>
    <span class="koboSpan" id="kobo.910.3">
     Other options include an incremental versioning scheme or even using the Git commit SHA of the application code as the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.911.1">
      version tag.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.912.1">
     We push the image to Docker Hub with the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.913.1">
      following command:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.914.1">
$ docker push &lt;namespace&gt;/fastify-microservice:1.0.0</span></pre>
   <p>
    <span class="koboSpan" id="kobo.915.1">
     If we navigate to the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.916.1">
      Tags
     </span>
    </strong>
    <span class="koboSpan" id="kobo.917.1">
     panel for our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.918.1">
      fastify-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.919.1">
     image on Docker Hub, we should be able to
    </span>
    <a id="_idIndexMarker913">
    </a>
    <span class="koboSpan" id="kobo.920.1">
     see that our newly pushed image version
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.921.1">
      is available.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-369">
    <a id="_idTextAnchor381">
    </a>
    <span class="koboSpan" id="kobo.922.1">
     See also
    </span>
   </h2>
   <ul>
    <li>
     <a href="B19212_06.xhtml#_idTextAnchor178">
      <span class="No-Break">
       <em class="italic">
        <span class="koboSpan" id="kobo.923.1">
         Chapter 6
        </span>
       </em>
      </span>
     </a>
    </li>
    <li>
     <span class="koboSpan" id="kobo.924.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.925.1">
       Building a Docker container
      </span>
     </em>
     <span class="koboSpan" id="kobo.926.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.927.1">
       this chapter
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.928.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.929.1">
       Deploying to Kubernetes
      </span>
     </em>
     <span class="koboSpan" id="kobo.930.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.931.1">
       this chapter
      </span>
     </span>
    </li>
   </ul>
   <h1 id="_idParaDest-370">
    <a id="_idTextAnchor382">
    </a>
    <span class="koboSpan" id="kobo.932.1">
     Deploying to Kubernetes
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.933.1">
     Kubernetes is
    </span>
    <a id="_idIndexMarker914">
    </a>
    <span class="koboSpan" id="kobo.934.1">
     an open source container orchestration and management system originally developed by Google.
    </span>
    <span class="koboSpan" id="kobo.934.2">
     Today, the Kubernetes project is maintained by the Cloud Native Computing
    </span>
    <a id="_idIndexMarker915">
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.935.1">
      Foundation (
     </span>
    </span>
    <a href="https://www.cncf.io/">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.936.1">
       https://www.cncf.io/
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.937.1">
      ).
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.938.1">
     Kubernetes is a comprehensive and complex tool that provides the following features,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.939.1">
      among others:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.940.1">
      Service discovery and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.941.1">
       load balancing
      </span>
     </span>
    </li>
    <li>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.942.1">
       Storage orchestration
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.943.1">
      Automated rollouts
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.944.1">
       and rollbacks
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.945.1">
      Automatic bin packing, specifying how much CPU and memory each
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.946.1">
       container needs
      </span>
     </span>
    </li>
    <li>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.947.1">
       Self-healing
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.948.1">
      Secret and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.949.1">
       configuration management
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.950.1">
     An oversimplified description of Kubernetes is that it is a tool used to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.951.1">
      manage containers.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.952.1">
     This recipe will serve as an introduction to Kubernetes, demonstrating how we can deploy a microservice, packaged into a Docker container,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.953.1">
      to Kubernetes.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-371">
    <a id="_idTextAnchor383">
    </a>
    <span class="koboSpan" id="kobo.954.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.955.1">
     You should have Node.js 22 installed, and access to both an editor and browser of your choice.
    </span>
    <span class="koboSpan" id="kobo.955.2">
     This recipe also relies on the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.956.1">
      fastify-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.957.1">
     image that we created in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.958.1">
      Building a Docker container
     </span>
    </em>
    <span class="koboSpan" id="kobo.959.1">
     recipe in this chapter.
    </span>
    <span class="koboSpan" id="kobo.959.2">
     If you haven’t completed that recipe, you can download the code from the Packt GitHub repository (
    </span>
    <a href="https://github.com/PacktPublishing/Node.js-Cookbook-Fifth-Edition">
     <span class="koboSpan" id="kobo.960.1">
      https://github.com/PacktPublishing/Node.js-Cookbook-Fifth-Edition
     </span>
    </a>
    <span class="koboSpan" id="kobo.961.1">
     ) in the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.962.1">
       Chapter11/fastify-microservice
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.963.1">
      directory.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.964.1">
     For this recipe, you will additionally need to have both Docker and Kubernetes installed.
    </span>
    <span class="koboSpan" id="kobo.964.2">
     It’s possible to install
    </span>
    <a id="_idIndexMarker916">
    </a>
    <span class="koboSpan" id="kobo.965.1">
     and enable Kubernetes via Docker for Desktop.
    </span>
    <span class="koboSpan" id="kobo.965.2">
     It is recommended to install Docker for Desktop
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.966.1">
      from
     </span>
    </span>
    <a href="https://docs.docker.com/engine/install/">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.967.1">
       https://docs.docker.com/engine/install/
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.968.1">
      .
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.969.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.970.1">
     This recipe has been written based on using Docker for Desktop, which handles the setup of Kubernetes and installation of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.971.1">
      kubectl
     </span>
    </strong>
    <span class="koboSpan" id="kobo.972.1">
     CLI.
    </span>
    <span class="koboSpan" id="kobo.972.2">
     However, Docker for Desktop is only available on macOS and Windows OSs.
    </span>
    <span class="koboSpan" id="kobo.972.3">
     On Linux, an alternative is to use
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.973.1">
      minikube
     </span>
    </strong>
    <span class="koboSpan" id="kobo.974.1">
     , which is
    </span>
    <a id="_idIndexMarker917">
    </a>
    <span class="koboSpan" id="kobo.975.1">
     a tool that runs a Kubernetes cluster in a virtual machine on your local device.
    </span>
    <span class="koboSpan" id="kobo.975.2">
     Minikube has a more complicated setup compared to Docker for Desktop.
    </span>
    <span class="koboSpan" id="kobo.975.3">
     First, you’ll need to manually install the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.976.1">
      kubectl
     </span>
    </strong>
    <span class="koboSpan" id="kobo.977.1">
     CLI (
    </span>
    <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">
     <span class="koboSpan" id="kobo.978.1">
      https://kubernetes.io/docs/tasks/tools/install-kubectl/
     </span>
    </a>
    <span class="koboSpan" id="kobo.979.1">
     ), and then follow the installation instructions for Minikube
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.980.1">
      at
     </span>
    </span>
    <a href="https://kubernetes.io/docs/tasks/tools/install-minikube">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.981.1">
       https://kubernetes.io/docs/tasks/tools/install-minikube
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.982.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.983.1">
     To enable Kubernetes in Docker for Desktop, perform the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.984.1">
      following steps:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.985.1">
      Click the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.986.1">
       Docker
      </span>
     </strong>
     <span class="koboSpan" id="kobo.987.1">
      icon in your
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.988.1">
       menu bar.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.989.1">
      Navigate to the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.990.1">
       Preferences/Settings
      </span>
     </strong>
     <span class="koboSpan" id="kobo.991.1">
      |
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.992.1">
       Kubernetes
      </span>
     </strong>
     <span class="koboSpan" id="kobo.993.1">
      tab (as shown in the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.994.1">
       following screenshot):
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer088">
     <span class="koboSpan" id="kobo.995.1">
      <img alt="Figure 11.13 – The Docker for Desktop Kubernetes tab" src="image/Figure_11.13_B19212.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.996.1">
     Figure 11.13 – The Docker for Desktop Kubernetes tab
    </span>
   </p>
   <ol>
    <li value="3">
     <span class="koboSpan" id="kobo.997.1">
      Check the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.998.1">
       Enable
      </span>
     </strong>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.999.1">
        Kubernetes
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1000.1">
       checkbox.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1001.1">
      Click
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1002.1">
       Apply &amp;
      </span>
     </strong>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.1003.1">
        restart
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1004.1">
       .
      </span>
     </span>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1005.1">
     It will take a short while for
    </span>
    <a id="_idIndexMarker918">
    </a>
    <span class="koboSpan" id="kobo.1006.1">
     Kubernetes to install.
    </span>
    <span class="koboSpan" id="kobo.1006.2">
     The installation process will instantiate all of the images that are required to run a Kubernetes cluster on your laptop.
    </span>
    <span class="koboSpan" id="kobo.1006.3">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1007.1">
      kubectl
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1008.1">
     CLI will also be installed at
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1009.1">
      /usr/local/bin/kubectl
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1010.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1010.2">
     We will be using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1011.1">
      kubectl
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1012.1">
     CLI to interact with our
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1013.1">
      Kubernetes cluster.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1014.1">
     If you already use Kubernetes, ensure that you are configured to use the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1015.1">
      docker-desktop
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1016.1">
     context.
    </span>
    <span class="koboSpan" id="kobo.1016.2">
     To do so, perform the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1017.1">
      following steps:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1018.1">
      Click the Docker icon in your
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1019.1">
       menu bar.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1020.1">
      Click
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1021.1">
       Kubernetes
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1022.1">
      and select the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1023.1">
        docker-desktop
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1024.1">
       context.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1025.1">
      Open a new terminal window and verify that both Docker and the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1026.1">
       kubectl
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1027.1">
      CLI are present by entering the following commands.
     </span>
     <span class="koboSpan" id="kobo.1027.2">
      Expect to see output similar to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1028.1">
       the following:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1029.1">$ docker --version</span></strong><span class="koboSpan" id="kobo.1030.1">
Docker version 26.1.4, build 5650f9b
</span><strong class="bold"><span class="koboSpan" id="kobo.1031.1">$ kubectl version</span></strong><span class="koboSpan" id="kobo.1032.1">
Client Version: v1.29.2
Kustomize Version: v5.0.4-0.20230601165947-6ce0bf390ce3
Server Version: v1.29.2</span></pre>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1033.1">
     Should any issues arise, refer to the official Docker for Desktop installation and the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1034.1">
      Getting Started
     </span>
    </em>
    <span class="koboSpan" id="kobo.1035.1">
     guides
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1036.1">
      at
     </span>
    </span>
    <a href="https://docs.docker.com/desktop/#get-started">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1037.1">
       https://docs.docker.com/desktop/#get-started
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1038.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1039.1">
     Now that we have Docker
    </span>
    <a id="_idIndexMarker919">
    </a>
    <span class="koboSpan" id="kobo.1040.1">
     and Kubernetes installed and started, we can move to our
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1041.1">
      recipe steps.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-372">
    <a id="_idTextAnchor384">
    </a>
    <span class="koboSpan" id="kobo.1042.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1043.1">
     In this recipe, we’re going to deploy our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1044.1">
      fastify-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1045.1">
     image to Kubernetes.
    </span>
    <span class="koboSpan" id="kobo.1045.2">
     We’ll be using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1046.1">
      kubectl
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1047.1">
     CLI to interact with our
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1048.1">
      Kubernetes cluster:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1049.1">
      First, let’s test out some
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1050.1">
       kubectl
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1051.1">
      commands.
     </span>
     <span class="koboSpan" id="kobo.1051.2">
      Enter the following commands to list the Kubernetes nodes and services present on
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1052.1">
       our cluster:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1053.1">$ kubectl get nodes</span></strong><span class="koboSpan" id="kobo.1054.1">
NAME             STATUS   ROLES           AGE    VERSION
docker-desktop   Ready    control-plane   109s   v1.29.2
</span><strong class="bold"><span class="koboSpan" id="kobo.1055.1">$ kubectl get services</span></strong><span class="koboSpan" id="kobo.1056.1">
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP    PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   110s</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1057.1">
      Now, we can proceed to deploy our
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1058.1">
       fastify-microservice
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1059.1">
      image.
     </span>
     <span class="koboSpan" id="kobo.1059.2">
      Let’s start by ensuring we have our Docker image built.
     </span>
     <span class="koboSpan" id="kobo.1059.3">
      To do so, run the following command within the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1060.1">
        fastify-microservice
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1061.1">
       directory:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1062.1">$ docker build --tag fastify-microservice .</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1063.1">
      Next, we’ll create our deployment files.
     </span>
     <span class="koboSpan" id="kobo.1063.2">
      The deployment files will be a set of YAML files that are used to configure Kubernetes.
     </span>
     <span class="koboSpan" id="kobo.1063.3">
      We’ll create a subdirectory named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1064.1">
       deployment
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1065.1">
      to hold the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1066.1">
       deployment files:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1067.1">$ mkdir deployment</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1068.1">$ touch deployment/fastify-app.yml deployment/fastify-app-svc.yml</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1069.1">
      We’re going to create
     </span>
     <a id="_idIndexMarker920">
     </a>
     <span class="koboSpan" id="kobo.1070.1">
      a Kubernetes deployment.
     </span>
     <span class="koboSpan" id="kobo.1070.2">
      We can configure a Kubernetes deployment with a YAML file.
     </span>
     <span class="koboSpan" id="kobo.1070.3">
      To create a deployment YAML file, add the following
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1071.1">
       to
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1072.1">
        deployment/fastify-app.yml
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1073.1">
       :
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1074.1">
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastify-app
  labels:
    app: fastify
spec:
  replicas: 3
  selector:
    matchLabels:
      app: fastify
  template:
    metadata:
      labels:
        app: fastify
    spec:
      containers:
      - name: fastify-app
        image: fastify-microservice:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 3000</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1075.1">
      To create the Kubernetes deployment, we need to apply our YAML file that describes the deployment.
     </span>
     <span class="koboSpan" id="kobo.1075.2">
      We can confirm that the deployment has been created by asking our
     </span>
     <a id="_idIndexMarker921">
     </a>
     <span class="koboSpan" id="kobo.1076.1">
      Kubernetes cluster to list its deployments.
     </span>
     <span class="koboSpan" id="kobo.1076.2">
      Do this by entering the following
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1077.1">
       two commands:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1078.1">$ kubectl apply --filename deployment/fastify-app.yml</span></strong><span class="koboSpan" id="kobo.1079.1">
deployment.apps/fastify-app created
</span><strong class="bold"><span class="koboSpan" id="kobo.1080.1">$ kubectl get deployments</span></strong><span class="koboSpan" id="kobo.1081.1">
NAME          READY   UP-TO-DATE   AVAILABLE   AGE
fastify-app   3/3     3            3           7m19s</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1082.1">
      In our YAML file, we instructed Kubernetes to create three replicas.
     </span>
     <span class="koboSpan" id="kobo.1082.2">
      This means three Kubernetes pods will be created.
     </span>
     <span class="koboSpan" id="kobo.1082.3">
      A Kubernetes pod is a group of one or more containers that are deployed together on the same host and share the same network namespace and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1083.1">
       storage volumes.
      </span>
     </span>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1084.1">
       We can confirm that these have been created by listing all of the pods in our Kubernetes cluster by means of the
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1085.1">
        following command:
       </span>
      </span>
     </p>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1086.1">$ kubectl get pods</span></strong><span class="koboSpan" id="kobo.1087.1">
NAME                           READY   STATUS    RESTARTS   AGE
fastify-app-749687fd5f-2vxcb   1/1     Running   0          6s
fastify-app-749687fd5f-94rlc   1/1     Running   0          6s
fastify-app-749687fd5f-rvx6n   1/1     Running   0          6s</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1088.1">
      Now, let’s move on to how we can expose the instances of our
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1089.1">
       fastify-microservice
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1090.1">
      image running in the pods.
     </span>
     <span class="koboSpan" id="kobo.1090.2">
      We do this by creating a Kubernetes Service.
     </span>
     <span class="koboSpan" id="kobo.1090.3">
      Add the
     </span>
     <a id="_idIndexMarker922">
     </a>
     <span class="koboSpan" id="kobo.1091.1">
      following to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1092.1">
       fastify-app-svc.yml
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1093.1">
      to create the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1094.1">
       Kubernetes Service:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1095.1">
apiVersion: v1
kind: Service
metadata:
  name: fastify-app-svc
  labels:
    run: fastify
spec:
  selector:
    app: fastify
  ports:
    - protocol: TCP
      port: 3000
      targetPort: 3000
  type: NodePort</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1096.1">
      To create the Kubernetes Service defined in the previous step, we need to apply the Service YAML file with the following commands.
     </span>
     <span class="koboSpan" id="kobo.1096.2">
      We can confirm that the Kubernetes Service was created by supplying the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1097.1">
       kubectl get service
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1098.1">
      command.
     </span>
     <span class="koboSpan" id="kobo.1098.2">
      Enter the following in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1099.1">
       your terminal:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1100.1">$ kubectl apply --filename deployment/fastify-app-svc.yml</span></strong><span class="koboSpan" id="kobo.1101.1">
service/fastify-app-svc created
</span><strong class="bold"><span class="koboSpan" id="kobo.1102.1">$ kubectl get service</span></strong><span class="koboSpan" id="kobo.1103.1">
NAME              TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE
fastify-app-svc   NodePort    10.97.82.33   &lt;none&gt;        3000:31815/TCP   15m
kubernetes        ClusterIP   10.96.0.1     &lt;none&gt;        443/TCP          65d</span></pre>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1104.1">
     Now that we have created a Kubernetes Service, we should be able to access the application in our browser.
    </span>
    <span class="koboSpan" id="kobo.1104.2">
     You
    </span>
    <a id="_idIndexMarker923">
    </a>
    <span class="koboSpan" id="kobo.1105.1">
     will need to access the application via the external port, which is the port number detailed in the output of the previous step.
    </span>
    <span class="koboSpan" id="kobo.1105.2">
     In the preceding example, the application is located at
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1106.1">
      https://localhost:31815/example
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1107.1">
     , but you will need to substitute the port, as it is randomly assigned by Kubernetes.
    </span>
    <span class="koboSpan" id="kobo.1107.2">
     The external port, by default, will be in the range of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1108.1">
      30000
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1109.1">
     to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1110.1">
      32767
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1111.1">
     as this is the default range
    </span>
    <a id="_idIndexMarker924">
    </a>
    <span class="koboSpan" id="kobo.1112.1">
     assigned to
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1113.1">
      NodePort services
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1114.1">
     by Kubernetes.
    </span>
    <span class="koboSpan" id="kobo.1114.2">
     Expect to see the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1115.1">
      following output:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer089">
     <span class="koboSpan" id="kobo.1116.1">
      <img alt="Figure 11.14 – Browser showing the this is an example string" src="image/Figure_11.14_B19212.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.1117.1">
     Figure 11.14 – Browser showing the this is an example string
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1118.1">
     We’ve now pushed our containerized
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1119.1">
      fastify-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1120.1">
     image to our local
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1121.1">
      Kubernetes cluster.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-373">
    <a id="_idTextAnchor385">
    </a>
    <span class="koboSpan" id="kobo.1122.1">
     How it works…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1123.1">
     In the recipe, we
    </span>
    <a id="_idIndexMarker925">
    </a>
    <span class="koboSpan" id="kobo.1124.1">
     deployed our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1125.1">
      fastify-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1126.1">
     image to the local Kubernetes cluster running under Docker for Desktop.
    </span>
    <span class="koboSpan" id="kobo.1126.2">
     Many of the leading cloud providers have commercial Kubernetes offerings that can be used should you not wish to manage a Kubernetes cluster.
    </span>
    <span class="koboSpan" id="kobo.1126.3">
     These commercial offerings extend the Kubernetes open source project, meaning the underlying Kubernetes technology remains consistent across cloud providers.
    </span>
    <span class="koboSpan" id="kobo.1126.4">
     Most of the providers offer CLIs to interact with their Kubernetes offering; however, the APIs provided by these CLIs tend to just be wrappers or shortcuts for
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1127.1">
       kubectl
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1128.1">
      commands.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1129.1">
     The following is a selection of the commercial Kubernetes Services available from leading
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1130.1">
      cloud providers:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.1131.1">
      Amazon Elastic Kubernetes
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1132.1">
       Service:
      </span>
     </span>
     <a href="https://aws.amazon.com/eks/">
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1133.1">
        https://aws.amazon.com/eks/
       </span>
      </span>
     </a>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1134.1">
      Azure Kubernetes
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1135.1">
       Service:
      </span>
     </span>
     <a href="https://azure.microsoft.com/en-gb/services/kubernetes-service/">
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1136.1">
        https://azure.microsoft.com/en-gb/services/kubernetes-service/
       </span>
      </span>
     </a>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1137.1">
      Google Kubernetes
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1138.1">
       Engine:
      </span>
     </span>
     <a href="https://cloud.google.com/kubernetes-engine">
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1139.1">
        https://cloud.google.com/kubernetes-engine
       </span>
      </span>
     </a>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1140.1">
      IBM Cloud Kubernetes
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1141.1">
       Service:
      </span>
     </span>
     <a href="https://www.ibm.com/products/kubernetes-service">
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1142.1">
        https://www.ibm.com/products/kubernetes-service
       </span>
      </span>
     </a>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.1143.1">
     The recipe relied on our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1144.1">
      fastify-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1145.1">
     image being built and available on the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1146.1">
      local machine.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1147.1">
     We declared a Kubernetes deployment in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1148.1">
      deployment/fastify-app.yml
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1149.1">
     file.
    </span>
    <span class="koboSpan" id="kobo.1149.2">
     A Kubernetes deployment is a resource object in Kubernetes.
    </span>
    <span class="koboSpan" id="kobo.1149.3">
     A Kubernetes deployment allows you to define the life cycle of your application.
    </span>
    <span class="koboSpan" id="kobo.1149.4">
     The life cycle definition includes
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1150.1">
      the following:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.1151.1">
      The image to use
     </span>
     <a id="_idIndexMarker926">
     </a>
     <span class="koboSpan" id="kobo.1152.1">
      for the deployment is included.
     </span>
     <span class="koboSpan" id="kobo.1152.2">
      In the recipe, the deployment YAML referenced the local
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1153.1">
       fastify-microservice
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1154.1">
      image that we created in the
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1155.1">
       Building a Docker container
      </span>
     </em>
     <span class="koboSpan" id="kobo.1156.1">
      recipe of this chapter.
     </span>
     <span class="koboSpan" id="kobo.1156.2">
      Note that we could have supplied an external image, such as one from Docker Hub, or referenced an image in a
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1157.1">
       private registry.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1158.1">
      The number of replicas or pods that should be available
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1159.1">
       are included.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1160.1">
      How the replicas or pods should be updated
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1161.1">
       is detailed.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.1162.1">
     In
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1163.1">
      deployment/fastify-app.yml
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1164.1">
     , we declared that there should be three replicas, and therefore three pods were created by Kubernetes.
    </span>
    <span class="koboSpan" id="kobo.1164.2">
     We set three replicas so that if one pod crashes, then the other two pods can handle the load.
    </span>
    <span class="koboSpan" id="kobo.1164.3">
     The number of replicas required will depend on the typical load of a given application.
    </span>
    <span class="koboSpan" id="kobo.1164.4">
     Having multiple instances available is part of what provides Kubernetes’ “high-availability” behaviors; having other pods available that can handle the load in the case where one pod crashes can reduce downtime.
    </span>
    <span class="koboSpan" id="kobo.1164.5">
     If we were to manually kill a pod with
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1165.1">
      docker delete pod &lt;podname&gt;
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1166.1">
     , Kubernetes would automatically try to restart and spin up a new pod in its place.
    </span>
    <span class="koboSpan" id="kobo.1166.2">
     This demonstrates Kubernetes’ “
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1167.1">
      auto-restart” behavior.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1168.1">
     To access our application, we needed to define a Kubernetes Service.
    </span>
    <span class="koboSpan" id="kobo.1168.2">
     This Service is used to expose an application running on a set of pods.
    </span>
    <span class="koboSpan" id="kobo.1168.3">
     In the case of the recipe, we created a Kubernetes Service to expose
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1169.1">
      fastify-microservice
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1170.1">
     , which was running in three pods.
    </span>
    <span class="koboSpan" id="kobo.1170.2">
     Kubernetes creates a single DNS name for a group of Kubernetes pods, enabling load balancing
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1171.1">
      between them.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1172.1">
     This recipe has only touched upon Kubernetes in the context of deploying a simple Node.js microservice.
    </span>
    <span class="koboSpan" id="kobo.1172.2">
     A full introduction to Kubernetes is beyond the scope of this book.
    </span>
    <span class="koboSpan" id="kobo.1172.3">
     For more detailed information on Kubernetes, you can refer to the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1173.1">
      following guides:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.1174.1">
      Kubernetes
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1175.1">
       overview:
      </span>
     </span>
     <a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/">
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1176.1">
        https://kubernetes.io/docs/tutorials/kubernetes-basics/
       </span>
      </span>
     </a>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1177.1">
      Kubernetes setup
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1178.1">
       guide:
      </span>
     </span>
     <a href="https://kubernetes.io/docs/setup/">
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1179.1">
        https://kubernetes.io/docs/setup/
       </span>
      </span>
     </a>
    </li>
   </ul>
   <h2 id="_idParaDest-374">
    <a id="_idTextAnchor386">
    </a>
    <span class="koboSpan" id="kobo.1180.1">
     There’s more…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1181.1">
     Kubernetes is focused on
    </span>
    <a id="_idIndexMarker927">
    </a>
    <span class="koboSpan" id="kobo.1182.1">
     enabling the high availability of applications to minimize downtime.
    </span>
    <span class="koboSpan" id="kobo.1182.2">
     When deploying an updated version of your microservice, Kubernetes will conduct a rolling update.
    </span>
    <span class="koboSpan" id="kobo.1182.3">
     Rolling updates aim for zero downtime by incrementally updating individual pod instances with the new version of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1183.1">
      the microservice.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1184.1">
     We can demonstrate Kubernetes rolling updates by updating our microservice and instructing Kubernetes to deploy the updated version of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1185.1">
      the microservice:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1186.1">
      We can start by making a small change to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1187.1">
       fastify-microservice
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1188.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1188.2">
      Open
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1189.1">
       routes/example/index.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1190.1">
      and change the response that is returned on line 5 to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1191.1">
       the following:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1192.1">    return 'this is an updated example'</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1193.1">
      Now we need to rebuild our container for our microservice.
     </span>
     <span class="koboSpan" id="kobo.1193.2">
      We’ll tag this image with version
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1194.1">
       2.0.0
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1195.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1195.2">
      Enter the following command to rebuild and tag
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1196.1">
       the image:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1197.1">$ docker build --tag fastify-microservice:2.0.0 .</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1198.1">
      Now we need to update our Kubernetes deployment.
     </span>
     <span class="koboSpan" id="kobo.1198.2">
      Open
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1199.1">
       deployment/fastify-app.yml
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1200.1">
      and change the image to reference our new
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1201.1">
       image tag:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1202.1">
        image: fastify-microservice:2.0.0</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1203.1">
      Now we need to reapply our Kubernetes deployment configuration with the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1204.1">
       following command:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1205.1">$ kubectl apply --filename deployment/fastify-app.yml</span></strong><span class="koboSpan" id="kobo.1206.1">
deployment.apps/fastify-app configured</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1207.1">
      Enter the following to obtain the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1208.1">
       NodePort
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1209.1">
      for our Kubernetes Service.
     </span>
     <span class="koboSpan" id="kobo.1209.2">
      We need this port to access the application from
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1210.1">
       our browser:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1211.1">$ kubectl describe service fastify-app-svc | grep NodePort:</span></strong><span class="koboSpan" id="kobo.1212.1">
NodePort:                 &lt;unset&gt;  </span><strong class="bold"><span class="koboSpan" id="kobo.1213.1">31815</span></strong><span class="koboSpan" id="kobo.1214.1">/TCP</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1215.1">
      Navigate to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1216.1">
       http://localhost:&lt;NodePort&gt;/example
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1217.1">
      , where
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1218.1">
       NodePort
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1219.1">
      is the port output from the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1220.1">
       previous command.
      </span>
     </span>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1221.1">
     The
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1222.1">
      this is an updated example
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1223.1">
     string should be returned in your browser, indicating that the rolling update has
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1224.1">
      taken
     </span>
    </span>
    <span class="No-Break">
     <a id="_idIndexMarker928">
     </a>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1225.1">
      place.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.1226.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1227.1">
     Once you’ve completed this recipe, including the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1228.1">
      There’s more…
     </span>
    </em>
    <span class="koboSpan" id="kobo.1229.1">
     section, you should delete the Kubernetes resources you have created to avoid an unnecessary load on your system.
    </span>
    <span class="koboSpan" id="kobo.1229.2">
     To delete the deployment, use the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1230.1">
      $ kubectl delete deployment fastify-app
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1231.1">
     command.
    </span>
    <span class="koboSpan" id="kobo.1231.2">
     Similarly, to delete the Kubernetes Service, use the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1232.1">
      $ kubectl delete service
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1233.1">
       fastify-app-svc
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1234.1">
      command.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-375">
    <a id="_idTextAnchor387">
    </a>
    <span class="koboSpan" id="kobo.1235.1">
     See also
    </span>
   </h2>
   <ul>
    <li>
     <a href="B19212_06.xhtml#_idTextAnchor178">
      <span class="No-Break">
       <em class="italic">
        <span class="koboSpan" id="kobo.1236.1">
         Chapter 6
        </span>
       </em>
      </span>
     </a>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1237.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1238.1">
       Building a Docker container
      </span>
     </em>
     <span class="koboSpan" id="kobo.1239.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1240.1">
       this chapter
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1241.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1242.1">
       Publishing a Docker image
      </span>
     </em>
     <span class="koboSpan" id="kobo.1243.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1244.1">
       this chapter
      </span>
     </span>
    </li>
   </ul>
  </div>
 </body></html>