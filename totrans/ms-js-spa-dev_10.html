<html><head></head><body><div class="chapter" title="Chapter&#xA0;10.&#xA0;Displaying Views"><div class="titlepage"><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Displaying Views</h1></div></div></div><p>The heart and soul of most SPAs is a dynamic frontend. SPAs move a lot of the heavy lifting, related to display logic, onto the browser. Modern browsers have fast and powerful JavaScript engines that can handle a lot more computation than just a few years ago. In fact, Node.js is built on top of the VB engine, which is a standard part of the Chrome browser.</p><p>Most importantly, however, the main idea of an SPA is to give the user an experience approaching that of a desktop application. Complete page loads are a thing of the past, replaced by snappy changes in state.</p><p>In this chapter, we will build out the heart of our own SPA. This will be a dashboard where users can build <code class="literal">giftlists</code> and share them with other users. We will have to build out a couple more routes and data structures on the backend, but we will focus on the frontend. We will build an Express view that will load AngularJS - a JavaScript toolkit designed specifically for rapid creation of SPAs.</p><p>We will build AngularJS routes, views, services, and controllers that will implement the core functionality of the SPA. Using the AngularJS plugin, UI-router, we will manage the state of our application. We will also implement services to communicate to the end so that data can flow freely in our application.</p><p>In this chapter we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Developing the initial dashboard view in Express</li><li class="listitem" style="list-style-type: disc">Implementing AngularJS</li><li class="listitem" style="list-style-type: disc">AngularJS routing</li><li class="listitem" style="list-style-type: disc">Using AngularJS <code class="literal">$resource</code> to access RESTful endpoints</li></ul></div><div class="section" title="Setting up our dashboard"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec57"/>Setting up our dashboard</h1></div></div></div><p>Since this is a SPA, we need to set up a single page to contain our application. In our case, we are going to build a user dashboard. That dashboard will allow a user to create <code class="literal">giftlists</code> (such as birthday wish lists), choose who they want to share them with, and see lists that have been shared with them. In the next chapter, we're going to build authentication so that individual users will only be able to see their own dashboards, but for now we need to mock things up without authentication a bit.</p><p>We'll need a couple of routes, and a view. We're also going to use <code class="literal">Bootstrap</code> to style our view a little.</p><div class="section" title="Building the view"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec120"/>Building the view</h2></div></div></div><p>We need to create a view for our dashboard. Create a new folder in your views directory called <code class="literal">dash</code>. Inside that folder, create a file called <code class="literal">dashboard.ejs</code>:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html&gt; &#13;
&lt;head&gt; &#13;
    &lt;title&gt;Dashboard for &lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; &lt;/title&gt; &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
&lt;h1&gt;&lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; Dashboard&lt;/h1&gt; &#13;
&lt;div&gt; &#13;
    &lt;h2&gt;My Lists&lt;/h2&gt; &#13;
&lt;/div&gt; &#13;
 &#13;
&lt;div&gt; &#13;
    &lt;h2&gt;Lists Shared With Me&lt;/h2&gt; &#13;
&lt;/div&gt; &#13;
 &#13;
&lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>So there's nothing too exciting here yet. We have set up some placeholders, and we are assuming that we'll have a <code class="literal">user</code> object to display. We can't see our view yet - for that we need a <code class="literal">route</code> which will render the view.</p><p>Let's set up the <code class="literal">route</code> to display our dashboard. In your <code class="literal">routes</code> directory, create a new file called <code class="literal">dashboard.js</code>:</p><pre class="programlisting">var express = require('express'); &#13;
var router = express.Router(); &#13;
 &#13;
 &#13;
router.get('/', function(req, res, next) { &#13;
    res.send('respond with a resource'); &#13;
}); &#13;
 &#13;
router.param('id', function(req, res, next, id) { &#13;
    var db = req.db; &#13;
    var collection = db.get('users'); &#13;
    collection.findOne({ "_id": id }, {}, function(err,User){ &#13;
        if(err){ &#13;
            res.send(err); &#13;
        }else if(User){ &#13;
            req.user = User; &#13;
            next(); &#13;
        } else { &#13;
            res.send(new Error('User not found.')); &#13;
        } &#13;
    }); &#13;
}); &#13;
 &#13;
router.get('/:id', function(req, res, next){ &#13;
    res.render('dash/dashboard', {user: req.user}); &#13;
}); &#13;
 &#13;
module.exports = router; &#13;
</pre><p>We have done a couple of things here. First, we set up our middleware to respond to routes with an id parameter as we did with our users' routes. Next, we set up a route for displaying our dashboard.</p><p>Unless you have the ID for a user memorized, it's going to be hard to test our new view. Let's make it a little easier by modifying the view that lists our users. Open up <code class="literal">views/users/show.ejs</code>:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html&gt; &#13;
&lt;head&gt; &#13;
    &lt;title&gt;Show Users&lt;/title&gt; &#13;
    &lt;link rel='stylesheet' href='/stylesheets/style.css' /&gt; &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
&lt;h1&gt;User List: &lt;%= appName %&gt;&lt;/h1&gt; &#13;
 &#13;
&lt;table&gt; &#13;
    &lt;thead&gt; &#13;
        &lt;tr&gt; &#13;
 &#13;
            &lt;th&gt;First Name&lt;/th&gt; &#13;
            &lt;th&gt;Last Name&lt;/th&gt; &#13;
            &lt;th&gt;Email Address&lt;/th&gt; &#13;
<span class="strong"><strong>            &lt;th&gt;Dashboard&lt;/th&gt;</strong></span> &#13;
        &lt;/tr&gt; &#13;
    &lt;/thead&gt; &#13;
    &lt;tbody&gt; &#13;
    &lt;% users.forEach(function(user, index){ -%&gt; &#13;
        &lt;tr&gt; &#13;
            &lt;td&gt;&lt;a href="show/&lt;%= user._id%&gt; "&gt;&lt;%= user.firstName %&gt;&lt;/a&gt;&lt;/td&gt; &#13;
            &lt;td&gt;&lt;%= user.lastName %&gt;&lt;/td&gt; &#13;
            &lt;td&gt;&lt;%= user.email %&gt;&lt;/td&gt; &#13;
<span class="strong"><strong>            &lt;td&gt;&lt;a href="/dash/&lt;%= user._id %&gt;"&gt;View&lt;/a&gt;&lt;/td&gt;</strong></span> &#13;
        &lt;/tr&gt; &#13;
    &lt;% }); %&gt; &#13;
    &lt;/tbody&gt; &#13;
&lt;/table&gt; &#13;
 &#13;
 &#13;
&lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>We added a new column in our users table with a link to the dashboard for each user. We still can't display our dashboard yet. We have to make a change to our <code class="literal">app.js</code> file:</p><pre class="programlisting">var express = require('express'); &#13;
var path = require('path'); &#13;
var favicon = require('serve-favicon'); &#13;
var logger = require('morgan'); &#13;
var cookieParser = require('cookie-parser'); &#13;
var bodyParser = require('body-parser'); &#13;
var isJSON = require('./utils/json'); &#13;
var routing = require('resource-routing'); &#13;
var controllers = path.resolve('./controllers'); &#13;
 &#13;
//Database stuff &#13;
var mongodb = require('mongodb'); &#13;
var monk = require('monk'); &#13;
var db = monk('localhost:27017/giftapp') &#13;
 &#13;
var routes = require('./routes/index'); &#13;
var users = require('./routes/users'); &#13;
<span class="strong"><strong>var dashboard = require('./routes/dashboard');</strong></span> &#13;
 &#13;
var app = express(); &#13;
 &#13;
// view engine setup &#13;
app.set('views', path.join(__dirname, 'views')); &#13;
app.set('view engine', 'ejs'); &#13;
 &#13;
app.set('x-powered-by', false); &#13;
 &#13;
app.locals.appName = "My Gift App"; &#13;
 &#13;
// uncomment after placing your favicon in /public &#13;
//app.use(favicon(path.join(__dirname, 'public', 'favicon.ico'))); &#13;
app.use(logger('dev')); &#13;
app.use(bodyParser.json()); &#13;
app.use(bodyParser.urlencoded({ extended: false })); &#13;
app.use(cookieParser()); &#13;
app.use(express.static(path.join(__dirname, 'public'))); &#13;
app.use(isJSON); &#13;
 &#13;
//Database middleware &#13;
app.use(function(req,res,next){ &#13;
    req.db = db; &#13;
    next(); &#13;
}); &#13;
 &#13;
app.use('/', routes); &#13;
app.use('/users', users); &#13;
<span class="strong"><strong>app.use('/dash', dashboard);</strong></span> &#13;
 &#13;
routing.resources(app, controllers, "giftlist"); &#13;
routing.expose_routing_table(app, { at: "/my-routes" }); &#13;
 &#13;
// catch 404 and forward to error handler &#13;
app.use(function(req, res, next) { &#13;
  var err = new Error('Not Found'); &#13;
  err.status = 404; &#13;
  next(err); &#13;
}); &#13;
 &#13;
// error handlers &#13;
 &#13;
// development error handler &#13;
// will print stacktrace &#13;
if (app.get('env') === 'development') { &#13;
  app.use(function(err, req, res, next) { &#13;
    res.status(err.status || 500); &#13;
    res.render('error', { &#13;
      message: err.message, &#13;
      error: err &#13;
    }); &#13;
  }); &#13;
} &#13;
 &#13;
// production error handler &#13;
// no stacktraces leaked to user &#13;
app.use(function(err, req, res, next) { &#13;
  res.status(err.status || 500); &#13;
  res.render('error', { &#13;
    message: err.message, &#13;
    error: {} &#13;
  }); &#13;
}); &#13;
 &#13;
 &#13;
module.exports = app; &#13;
</pre><p>The two key changes here are that we import the dashboard router, we then map any requests to <code class="literal">/dash</code> to that <code class="literal">router</code>.</p><p>Make sure your MongoDB daemon is still running, and restart it if it isn't. Start or restart your server. Navigate to your list of users at <code class="literal">http://localhost:3000/users/show</code> and then click on one of the <code class="literal">view</code> links in the right of the table:</p><p>
</p><div class="mediaobject"><img src="graphics/image_10_001.jpg" alt="Building the view"/></div><p>
</p><p>The URL should look something like this: <code class="literal">http://localhost:3000/dash/566dd0cb1c09d090fd36ba83</code>. You should see a page that looks like this:</p><p>
</p><div class="mediaobject"><img src="graphics/image_10_002.jpg" alt="Building the view"/></div><p>
</p><p>Now we have a <code class="literal">view</code> template and routing set up to display the page. The next thing we need to do is to build out some data.</p></div><div class="section" title="Connecting to initial data"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec121"/>Connecting to initial data</h2></div></div></div><p>Our application is going to allow users to build <code class="literal">giftlists</code> and share them with other users. We want to think a little bit about how we want to represent our data. A good data model will serve us, even as we add and change features.</p><p>As we have learned, MongoDB is very flexible, and we could just embed documents inside documents. This might work; we could just have each user with an array of lists. The issue with that is that our individual user documents would be highly mutable, and could grow to an enormous size easily. It also doesn't offer a lot of flexibility down the road if we want to do something like having shared lists.</p><p>The type of relationship that we want to have for now is a one-to-many relationship. One user can have many lists. The way we'll accomplish this is to store a reference to the user who owns the list on the list itself. Later, if we want to have more than one user <span class="emphasis"><em>own</em></span> a list, the change would be pretty straightforward.</p><p>We want to use our <code class="literal">giftapp</code> database, and we are going to be creating a new collection of <code class="literal">giftlists</code>. Start up the MongoDB command-line tool in a new terminal window. Note that you'll want to copy the exact <code class="literal">ID</code> of one of your users since it will differ from mine:</p><pre class="programlisting">
<span class="strong"><strong>&gt;use giftapp</strong></span>
<span class="strong"><strong>switched to db giftapp</strong></span>
<span class="strong"><strong>&gt; db.giftlist.insert({'name':'Birthday List', 'gifts':[{'name':'ball'},&#13;
     {'name':'pony'},{'name':'gift card'}], 'owner_id':&#13;
       566dff161c09d090fd36ba85"})</strong></span>
<span class="strong"><strong>WriteResult({ "nInserted" : 1 })</strong></span>
<span class="strong"><strong>&gt; db.giftlist.insert({'name':'Christmas  List', 'gifts':[{'name':'TV'},&#13;
      {'name':'Corvette'},{'name':'gift card'}], 'owner_id':&#13;
       566dff161c09d090fd36ba85"})</strong></span>
<span class="strong"><strong>WriteResult({ "nInserted" : 1 })</strong></span>
</pre><p>The important part here is the format of the insert statement. Let's break it apart a little bit.</p><pre class="programlisting">db.giftlist.insert({ &#13;
    'name':'Christmas  List',  &#13;
    'gifts':[{'name':'TV'},{'name':'Corvette'},{'name':'gift card'}],  &#13;
    'owner_id': 566dff161c09d090fd36ba85") &#13;
    } &#13;
}) &#13;
</pre><p>We insert this object into the <code class="literal">giftlist</code> collection, which will be created if it doesn't already exist. The object has a name property and a <code class="literal">gifts</code> property. The <code class="literal">gifts</code> property is an array of objects, each containing a name property.</p><p>We also have an <code class="literal">owner_id</code> property. This property is a reference to the user to whom the <code class="literal">giftlist</code> belongs. It's just the string of the user's <code class="literal">_id</code>. Since MongoDB is a non-relational database, we will just stash this in here to do lookups in the <code class="literal">users</code> collection.</p><p>We know we're going to be looking things up by the owner, so let's add an <code class="literal">index</code>:</p><pre class="programlisting">
<span class="strong"><strong>&gt; db.giftlist.ensureIndex({'owner_id':1})</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  "createdCollectionAutomatically" : false,</strong></span>
<span class="strong"><strong>  "numIndexesBefore" : 1,</strong></span>
<span class="strong"><strong>  "numIndexesAfter" : 2,</strong></span>
<span class="strong"><strong>  "ok" : 1</strong></span>
<span class="strong"><strong>}</strong></span>
</pre><p>Now, let's see what we have got by running a query on the command line:</p><pre class="programlisting">
<span class="strong"><strong>&gt;db.giftlist.find({'owner':{'$ref':'users','$id':ObjectId('566dff161c09d090fd36ba85')}}).pretty()</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  "_id" : ObjectId("569bd08d94b6b374a00e8b49"),</strong></span>
<span class="strong"><strong>  "name" : "Birthday List",</strong></span>
<span class="strong"><strong>  "gifts" : [</strong></span>
<span class="strong"><strong>    {</strong></span>
<span class="strong"><strong>      "name" : "ball"</strong></span>
<span class="strong"><strong>    },</strong></span>
<span class="strong"><strong>    {</strong></span>
<span class="strong"><strong>      "name" : "pony"</strong></span>
<span class="strong"><strong>    },</strong></span>
<span class="strong"><strong>    {</strong></span>
<span class="strong"><strong>      "name" : "gift card"</strong></span>
<span class="strong"><strong>    }</strong></span>
<span class="strong"><strong>  ],</strong></span>
<span class="strong"><strong>  "owner_id" : 566dff161c09d090fd36ba85"</strong></span>
<span class="strong"><strong>}</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  "_id" : ObjectId("569bd0d794b6b374a00e8b4a"),</strong></span>
<span class="strong"><strong>  "name" : "Christmas  List",</strong></span>
<span class="strong"><strong>  "gifts" : [</strong></span>
<span class="strong"><strong>    {</strong></span>
<span class="strong"><strong>      "name" : "TV"</strong></span>
<span class="strong"><strong>    },</strong></span>
<span class="strong"><strong>    {</strong></span>
<span class="strong"><strong>      "name" : "Corvette"</strong></span>
<span class="strong"><strong>    },</strong></span>
<span class="strong"><strong>    {</strong></span>
<span class="strong"><strong>      "name" : "gift card"</strong></span>
<span class="strong"><strong>    }</strong></span>
<span class="strong"><strong>  ],</strong></span>
<span class="strong"><strong>  "owner_id" : "566dff161c09d090fd36ba85"</strong></span>
<span class="strong"><strong>}</strong></span>
</pre><p>Just what we would expect.</p><p>Now, let's modify our <code class="literal">dashboard.js</code> route:</p><pre class="programlisting">var express = require('express'); &#13;
var router = express.Router(); &#13;
 &#13;
 &#13;
router.get('/', function(req, res, next) { &#13;
    res.send('respond with a resource'); &#13;
}); &#13;
 &#13;
<span class="strong"><strong>router.param('id', function(req, res, next, id)&#13;
 {&#13;
</strong></span>
<span class="strong"><strong>    var db = req.db;&#13;
</strong></span>
<span class="strong"><strong>    var collection = db.get('giftlist');&#13;
</strong></span>
<span class="strong"><strong>    collection.find({'owner_id':id}, {}, function(err,giftlists)&#13;
{</strong></span>
<span class="strong"><strong>        if(err){&#13;
</strong></span>
<span class="strong"><strong>            res.send(err);&#13;
</strong></span>
<span class="strong"><strong>        }else if(giftlists)&#13;
{&#13;
</strong></span>
<span class="strong"><strong>            req.giftlists = giftlists;&#13;
</strong></span>
<span class="strong"><strong>            collection = db.get('users');</strong></span>
<span class="strong"><strong>            collection.findOne({"_id":id}, function(err, user)&#13;
{&#13;
</strong></span>
<span class="strong"><strong>                if(err){&#13;
</strong></span>
<span class="strong"><strong>                    res.send(err);&#13;
</strong></span>
<span class="strong"><strong>                } else&#13;
 {&#13;
</strong></span>
<span class="strong"><strong>                    req.user = user;&#13;
</strong></span>
<span class="strong"><strong>                    next();&#13;
</strong></span>
<span class="strong"><strong>                }&#13;
</strong></span>
<span class="strong"><strong>            });&#13;
</strong></span>
<span class="strong"><strong>        } else {&#13;
</strong></span>
<span class="strong"><strong>            res.send(new Error('User not found.'));&#13;
</strong></span>
<span class="strong"><strong>        }&#13;
</strong></span>
<span class="strong"><strong>    });&#13;
</strong></span>
<span class="strong"><strong>});</strong></span> &#13;
 &#13;
router.get('/:id', function(req, res, next){ &#13;
<span class="strong"><strong>    res.render('dash/dashboard', {user: req.user, giftlists: req.giftlists});</strong></span> &#13;
}); &#13;
 &#13;
module.exports = router; &#13;
</pre><p>We have modified the call to <code class="literal">router.param()</code> to search the <code class="literal">giftlists</code> collection based on the user <code class="literal">id</code> passed in. If we get a <code class="literal">giftlist</code> back, we then search the <code class="literal">users</code> collection to get the user data.</p><p>Yes, there are two calls to the database here. This is a bit of a trade-off in performance for flexibility. Remember that we decided earlier not to embed <code class="literal">giftlists</code> in the user document. This trade-off is something you will want to think through in your own applications.</p><p>Let's also modify our <code class="literal">dashboard.ejs</code> view template:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html&gt; &#13;
&lt;head&gt; &#13;
    &lt;title&gt;Dashboard for &lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; &lt;/title&gt; &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
&lt;h1&gt;&lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; Dashboard&lt;/h1&gt; &#13;
&lt;div&gt; &#13;
    &lt;h2&gt;My Lists&lt;/h2&gt; &#13;
 &#13;
<span class="strong"><strong>    &lt;ul&gt;</strong></span>
<span class="strong"><strong>    &lt;% giftlists.forEach(function(giftlist, index){ -%&gt;</strong></span>
<span class="strong"><strong>        &lt;li&gt;&lt;%= giftlist.name %&gt;&lt;/li&gt;</strong></span>
<span class="strong"><strong>    &lt;% }); %&gt;</strong></span>
<span class="strong"><strong>    &lt;/ul&gt;</strong></span> &#13;
&lt;/div&gt; &#13;
 &#13;
&lt;div&gt; &#13;
    &lt;h2&gt;Lists Shared With Me&lt;/h2&gt; &#13;
&lt;/div&gt; &#13;
 &#13;
&lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>Now we have an unordered list that renders the name of each of our <code class="literal">giftlists</code>. When we start adding AngularJS, we'll link each of these to a state that displays the lists. Navigating to the <code class="literal">user dashboard</code> page, you should see this:</p><p>
</p><div class="mediaobject"><img src="graphics/image_10_003.jpg" alt="Connecting to initial data"/></div><p>
</p><p>We now have a list of our user's <code class="literal">giftlists</code> and a placeholder for lists that have been shared with them. In a little bit, when we add AngularJS, we will also add the code for adding, editing, and sharing lists.</p><p>Right now, our dashboard is somewhat ugly. Let's fix that a little bit.</p></div><div class="section" title="Implementing Bootstrap"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec122"/>Implementing Bootstrap</h2></div></div></div><p>If you haven't heard of <code class="literal">Bootstrap</code> before, it is an extremely popular CSS framework. Plugging in <code class="literal">Bootstrap</code> helps frontend developers do things such as layout, painting buttons, and implementing controls without writing a lot of code by hand.</p><p>You can get <code class="literal">Bootstrap</code>, and see its documentation at <a class="ulink" href="https://getbootstrap.com">https://getbootstrap.com</a>.</p><p>Let's sweeten up our <code class="literal">dashboard.ejs</code> template a little:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html&gt; &#13;
&lt;head&gt; &#13;
    &lt;title&gt;Dashboard for &lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; &lt;/title&gt; &#13;
 &#13;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt; &#13;
 &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"&gt; &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"&gt; &#13;
 &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
&lt;nav class="nav navbar-default"&gt; &#13;
    &lt;div class="container-fluid"&gt; &#13;
        &lt;div class="navbar-header"&gt; &#13;
            &lt;a class="navbar-brand" href="#"&gt;&lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; Dashboard&lt;/a&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/nav&gt; &#13;
 &#13;
 &#13;
&lt;div class="container"&gt; &#13;
    &lt;div class="row"&gt; &#13;
        &lt;div class="col-xs-12 col-md-6"&gt; &#13;
            &lt;h2&gt;My Lists&lt;/h2&gt; &#13;
 &#13;
            &lt;ul class="list-unstyled"&gt; &#13;
            &lt;% giftlists.forEach(function(giftlist, index){ -%&gt; &#13;
                &lt;li&gt;&lt;a class="btn btn-link" href="#" role="button"&gt;&lt;%= giftlist.name %&gt;&lt;/a&gt;&lt;/li&gt; &#13;
            &lt;% }); %&gt; &#13;
            &lt;/ul&gt; &#13;
        &lt;/div&gt; &#13;
 &#13;
        &lt;div class="col-xs-12 col-md-6"&gt; &#13;
            &lt;h2&gt;Lists Shared With Me&lt;/h2&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/div&gt; &#13;
 &#13;
&lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>In the head of our document, you'll see three new lines. The first is a <code class="literal">meta</code> tag, which sets the viewport for mobile devices. The next two load <code class="literal">Bootstrap</code> and a <code class="literal">Bootstrap</code> theme from a CDN.</p><p>We then place what we had inside an <code class="literal">H1</code> tag into a number of elements, which will paint a <code class="literal">nav</code> bar at the top of the page.</p><p>The next section is a <code class="literal">div</code> element with a class of container. This is necessary for the <code class="literal">Bootstrap</code> layout to work. <code class="literal">Bootstrap</code> uses a grid system for a layout with rows and columns. Basically, there are 12 columns of equal width in a row.</p><p>Classes such as <code class="literal">col-xs-12</code> tell <code class="literal">Bootstrap</code> that, when the view port is extra small (like on a phone), that particular element should take up the entire width of the container. The  <code class="literal">col-md-6</code> class, makes the element half the width (six columns) when the screen is medium width or greater. By combining these classes, we can have a variable layout that makes sense based upon screen width. This is a main component of what's referred to as responsive design.</p><p>Looking at our dashboard in full width, we see this:</p><p>
</p><div class="mediaobject"><img src="graphics/image_10_004.jpg" alt="Implementing Bootstrap"/></div><p>
</p><p>In full size, our dashboard is divided into two equal width columns. You can also see our top <code class="literal">nav</code> bar is with <span class="strong"><strong>Mark Smith Dashboard</strong></span> is rendering. Now, if you drag the side of your browser to make it narrow like a mobile phone screen, you'll see this:</p><p>
</p><div class="mediaobject"><img src="graphics/image_10_005.jpg" alt="Implementing Bootstrap"/></div><p>
</p><p>Our columns are now stacked one on top of each other, which makes a lot more sense for a mobile form factor. Let's add a button element to add new lists, which we'll actually connect later:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html&gt; &#13;
&lt;head&gt; &#13;
    &lt;title&gt;Dashboard for &lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; &lt;/title&gt; &#13;
 &#13;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt; &#13;
 &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"&gt; &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"&gt; &#13;
 &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
&lt;nav class="nav navbar-default"&gt; &#13;
    &lt;div class="container-fluid"&gt; &#13;
        &lt;div class="navbar-header"&gt; &#13;
            &lt;a class="navbar-brand" href="#"&gt;&lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; Dashboard&lt;/a&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/nav&gt; &#13;
 &#13;
 &#13;
&lt;div class="container"&gt; &#13;
    &lt;div class="row"&gt; &#13;
        &lt;div class="col-xs-12 col-md-6"&gt; &#13;
            &lt;h2&gt;My Lists&lt;/h2&gt; &#13;
<span class="strong"><strong>            &lt;button class="btn btn-primary"&gt;</strong></span>
<span class="strong"><strong>                &lt;span class="glyphicon glyphicon-plus" aria-hidden="true"&gt;&lt;/span&gt;</strong></span>
<span class="strong"><strong>                Add List&lt;/button&gt;</strong></span> &#13;
            &lt;ul class="list-unstyled"&gt; &#13;
            &lt;% giftlists.forEach(function(giftlist, index){ -%&gt; &#13;
                &lt;li&gt;&lt;a class="btn btn-link" href="#" role="button"&gt;&lt;%= giftlist.name %&gt;&lt;/a&gt;&lt;/li&gt; &#13;
            &lt;% }); %&gt; &#13;
            &lt;/ul&gt; &#13;
        &lt;/div&gt; &#13;
 &#13;
        &lt;div class="col-xs-12 col-md-6"&gt; &#13;
            &lt;h2&gt;Lists Shared With Me&lt;/h2&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/div&gt; &#13;
 &#13;
&lt;script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"&gt;&lt;/script&gt; &#13;
&lt;script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" &gt;&lt;/script&gt; &#13;
&lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>We added a button with a class of <code class="literal">btn-primary</code>. Inside that button we have a span with a couple of <code class="literal">glyphicon</code> classes. These classes actually use a font to paint different types of common symbols.</p><p>Viewing our page now, we'll see a pretty blue button with a plus sign:</p><p>
</p><div class="mediaobject"><img src="graphics/image_10_006.jpg" alt="Implementing Bootstrap"/></div><p>
</p><p>We'll be developing further visual components as AngularJS views.</p></div></div></div>
<div class="section" title="Implementing AngularJS"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec58"/>Implementing AngularJS</h1></div></div></div><p>Now it's time to implement most of our view logic by implementing a more robust AngularJS application. The first thing we need to do is to add AngularJS code to our <code class="literal">dashboard.ejs</code> view template:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
<span class="strong"><strong>&lt;html ng-app&gt;</strong></span> &#13;
&lt;head&gt; &#13;
    &lt;title&gt;Dashboard for &lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; &lt;/title&gt; &#13;
 &#13;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt; &#13;
 &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"&gt; &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"&gt; &#13;
<span class="strong"><strong>    &lt;script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"&gt;&lt;/script&gt;</strong></span>
<span class="strong"><strong>    &lt;script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.15/angular-ui-router.min.js"&gt;&lt;/script&gt;</strong></span> &#13;
 &#13;
 &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
&lt;nav class="nav navbar-default"&gt; &#13;
    &lt;div class="container-fluid"&gt; &#13;
        &lt;div class="navbar-header"&gt; &#13;
            &lt;a class="navbar-brand" href="#"&gt;&lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; Dashboard&lt;/a&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/nav&gt; &#13;
 &#13;
 &#13;
&lt;div class="container"&gt; &#13;
    &lt;div class="row"&gt; &#13;
        &lt;div class="col-xs-12 col-md-6"&gt; &#13;
            &lt;h2&gt;My Lists&lt;/h2&gt; &#13;
            &lt;button class="btn btn-primary"&gt; &#13;
                &lt;span class="glyphicon glyphicon-plus" aria-hidden="true"&gt;&lt;/span&gt; &#13;
                Add List&lt;/button&gt; &#13;
            &lt;ul class="list-unstyled"&gt; &#13;
            &lt;% giftlists.forEach(function(giftlist, index){ -%&gt; &#13;
                &lt;li&gt;&lt;a class="btn btn-link" href="#" role="button"&gt;&lt;%= giftlist.name %&gt;&lt;/a&gt;&lt;/li&gt; &#13;
            &lt;% }); %&gt; &#13;
            &lt;/ul&gt; &#13;
        &lt;/div&gt; &#13;
 &#13;
        &lt;div class="col-xs-12 col-md-6"&gt; &#13;
            &lt;h2&gt;Lists Shared With Me&lt;/h2&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/div&gt; &#13;
 &#13;
&lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>We linked to AngularJS version 1.4.8 on a CDN, as well as a plugin called UI-router. We'll be talking about UI-router in depth. We also added the AngularJS directive <code class="literal">ng-app</code> to the opening <code class="literal">html</code> tag. When AngularJS loads, it looks for this directive to see what part of the document it should manage. Most applications will have Angular manage from the top level by doing this, though one could <code class="literal">Bootstrap</code> AngularJS into any part of the document.</p><div class="section" title="Our AngularJS module"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec123"/>Our AngularJS module</h2></div></div></div><p>AngularJS packages applications, parts of applications, and dependencies using modules. Everything we're going to do with AngularJS is going to be done by using modules or using code, such as controllers, which have been added to modules.</p><p>This is a core part of AngularJS architecture. Modules are containers for the parts of your application, and allow AngularJS to properly <code class="literal">Bootstrap</code> your application.</p><p>For now, our module is going to be simple, then we'll add to it as we go on. Create a new file called <code class="literal">giftapp.js</code> inside <code class="literal">public/javascripts</code>:</p><pre class="programlisting">var giftAppModule = angular.module('giftAppModule', ['ui.router']); &#13;
</pre><p>We create our module by invoking the <code class="literal">angular.module()</code> function. The first argument is the name of the module. The second argument is an array containing a list of dependencies we want to inject into our module. In this case, the only one we're injecting at the moment is UI-router.</p><p>Now, we need to add our module to our <code class="literal">dashboard.ejs</code> template:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
<span class="strong"><strong>&lt;html ng-app="giftAppModule"&gt;</strong></span> &#13;
&lt;head&gt;  &#13;
    &lt;title&gt;Dashboard for &lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; &lt;/title&gt; &#13;
 &#13;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt; &#13;
 &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"&gt; &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"&gt; &#13;
    &lt;script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"&gt;&lt;/script&gt; &#13;
    &lt;script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.15/angular-ui-router.min.js"&gt;&lt;/script&gt; &#13;
 &#13;
 &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
&lt;nav class="nav navbar-default"&gt; &#13;
    &lt;div class="container-fluid"&gt; &#13;
        &lt;div class="navbar-header"&gt; &#13;
            &lt;a class="navbar-brand" href="#"&gt;&lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; Dashboard&lt;/a&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/nav&gt; &#13;
 &#13;
 &#13;
&lt;div class="container"&gt; &#13;
    &lt;div class="row"&gt; &#13;
        &lt;div class="col-xs-12 col-md-6"&gt; &#13;
            &lt;h2&gt;My Lists&lt;/h2&gt; &#13;
            &lt;button class="btn btn-primary"&gt; &#13;
                &lt;span class="glyphicon glyphicon-plus" aria-hidden="true"&gt;&lt;/span&gt; &#13;
                Add List&lt;/button&gt; &#13;
            &lt;ul class="list-unstyled"&gt; &#13;
            &lt;% giftlists.forEach(function(giftlist, index){ -%&gt; &#13;
                &lt;li&gt;&lt;a class="btn btn-link" href="#" role="button"&gt;&lt;%= giftlist.name %&gt;&lt;/a&gt;&lt;/li&gt; &#13;
            &lt;% }); %&gt; &#13;
            &lt;/ul&gt; &#13;
        &lt;/div&gt; &#13;
 &#13;
        &lt;div class="col-xs-12 col-md-6"&gt; &#13;
            &lt;h2&gt;Lists Shared With Me&lt;/h2&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/div&gt; &#13;
 &#13;
<span class="strong"><strong>&lt;script src="/javascripts/giftapp.js"&gt;&lt;/script&gt;</strong></span> &#13;
&lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>We simply load our module using a normal <code class="literal">script</code> tag. Also, we change the <code class="literal">ng-app</code> directive so that it will use our new module as the main application entry point for the page.</p></div><div class="section" title="Controlling state with UI-router"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec124"/>Controlling state with UI-router</h2></div></div></div><p>State can mean a lot of things in applications, but in our SPA it refers to a given set of views, controllers, and data that can be invoked using a URL changer. By far the most popular way for developers to handle state in their AngularJS applications is with a plugin called UI-router.</p><p>The UI-router plugin allows us to control state rather elegantly, and is extremely flexible.</p><p>Let's implement UI-router in our application. First, we will reference UI-router from a CDN in our <code class="literal">dashboard.ejs</code> template:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html ng-app="giftapp"&gt; &#13;
&lt;head &gt; &#13;
    &lt;title&gt;Dashboard for &lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; &lt;/title&gt; &#13;
 &#13;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt; &#13;
 &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"&gt; &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"&gt; &#13;
    &lt;script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"&gt;&lt;/script&gt; &#13;
<span class="strong"><strong>    &lt;script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.15/angular-ui-router.min.js"&gt;&lt;/script&gt;</strong></span> &#13;
 &#13;
 &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
&lt;nav class="nav navbar-default"&gt; &#13;
    &lt;div class="container-fluid"&gt; &#13;
        &lt;div class="navbar-header"&gt; &#13;
            &lt;a class="navbar-brand" href="#"&gt;&lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; Dashboard&lt;/a&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/nav&gt; &#13;
 &#13;
 &#13;
&lt;div class="container"&gt; &#13;
 &#13;
<span class="strong"><strong>    &lt;div ui-view&gt;&lt;/div&gt;</strong></span> &#13;
 &#13;
 &#13;
&lt;/div&gt; &#13;
 &#13;
 &#13;
&lt;script src="/javascripts/giftapp.js"&gt;&lt;/script&gt; &#13;
&lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>We linked to UI-router on a CDN and loaded it using a normal <code class="literal">script</code> tag. The other major change in our template is the addition of a <code class="literal">ui-view</code> directive implemented as an attribute on a <code class="literal">div</code> element. The <code class="literal">ui-view</code> directive tells UI-router where to load the views that it's going to be painting.</p><p>The next step is to edit our <code class="literal">giftapp.js</code> application file to add routing:</p><pre class="programlisting">angular.module('giftapp', ['ui.router']) &#13;
 &#13;
    .config( &#13;
        ['$stateProvider', '$urlRouterProvider', &#13;
            function ($stateProvider,   $urlRouterProvider) { &#13;
 &#13;
                $urlRouterProvider &#13;
                    .otherwise('/dash'); &#13;
 &#13;
                $stateProvider &#13;
 &#13;
                    .state('dash', { &#13;
                        url:'/dash', &#13;
                        templateUrl: '/templates/dash-main.tpl.html' &#13;
                    }) &#13;
                    .state('add', { &#13;
                        url:'/add', &#13;
                        templateUrl: '/templates/dash-add.tpl.html' &#13;
                    }); &#13;
 &#13;
            }]); &#13;
</pre><p>First, we make sure to inject the <code class="literal">ui.router</code> module into our module. We chain a <code class="literal">config</code> function onto our module declaration. Using an array notation, we inject <code class="literal">$stateProvider</code> and <code class="literal">$urlRouteprovider</code> into the <code class="literal">config</code> function.</p><p>Inside that function, the magic happens. First, we invoke <code class="literal">$urlRouterProvider.otherwise('/dash');</code>, which sets the default route. When we load our page, unless another route is triggered with a URL fragment, <code class="literal">#/dash</code> will be appended to the URL.</p><p>Next, we set up two states on <code class="literal">$stateProvider</code>. For now, each is named and has a URL and <code class="literal">templateURL</code> property. The template URL points to a URL for a visual template to load.</p><p>Let's mock up our two templates. Create a new directory at <code class="literal">public/templates</code>.</p><p>Here's our <code class="literal">dash-main.tpl.html</code>:</p><pre class="programlisting">&lt;div class="row"&gt; &#13;
    &lt;div class="col-xs-12 col-md-6"&gt; &#13;
        &lt;h2&gt;My Lists&lt;/h2&gt; &#13;
        &lt;a class="btn btn-primary" role="button" ui-sref="add" href="#/add"&gt; &#13;
            &lt;span class="glyphicon glyphicon-plus" aria-hidden="true"&gt;&lt;/span&gt; &#13;
            Add List&lt;/a&gt; &#13;
        &lt;ul class="list-unstyled"&gt; &#13;
 &#13;
            &lt;li&gt;&lt;a class="btn btn-link" href="#" role="button"&gt;Angular Router List&lt;/a&gt;&lt;/li&gt; &#13;
            &lt;li&gt;&lt;a class="btn btn-link" href="#" role="button"&gt;Angular Router List 2&lt;/a&gt;&lt;/li&gt; &#13;
        &lt;/ul&gt; &#13;
    &lt;/div&gt; &#13;
 &#13;
    &lt;div class="col-xs-12 col-md-6"&gt; &#13;
        &lt;h2&gt;Lists Shared With Me&lt;/h2&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/div&gt; &#13;
</pre><p>And this is our <code class="literal">dash-add.tpl.html</code> file:</p><pre class="programlisting">&lt;div class="row"&gt; &#13;
    &lt;div class="col-md-12"&gt; &#13;
        &lt;h2&gt;Add a new list&lt;/h2&gt; &#13;
        &lt;form class="form-horizontal"&gt; &#13;
            &lt;div class="form-group"&gt; &#13;
                &lt;label for="listname" class="col-sm-2 control-label"&gt;List Name&lt;/label&gt; &#13;
                &lt;div class="col-sm-10"&gt; &#13;
                    &lt;input type="text" class="form-control" id="listname" placeholder="Name"&gt; &#13;
                &lt;/div&gt; &#13;
            &lt;/div&gt; &#13;
            &lt;div class="form-group"&gt; &#13;
                &lt;label for="item[]" class="col-sm-2 control-label"&gt;Item 1&lt;/label&gt; &#13;
                &lt;div class="col-sm-10"&gt; &#13;
                    &lt;input type="text" class="form-control" id="Item[]"&gt; &#13;
                &lt;/div&gt; &#13;
            &lt;/div&gt; &#13;
            &lt;div class="form-group"&gt; &#13;
                &lt;label for="item[]" class="col-sm-2 control-label"&gt;Item 1&lt;/label&gt; &#13;
                &lt;div class="col-sm-10"&gt; &#13;
                    &lt;input type="text" class="form-control" id="Item[]"&gt; &#13;
                &lt;/div&gt; &#13;
            &lt;/div&gt; &#13;
            &lt;div class="form-group"&gt; &#13;
                &lt;label for="item[]" class="col-sm-2 control-label"&gt;Item 1&lt;/label&gt; &#13;
                &lt;div class="col-sm-10"&gt; &#13;
                    &lt;input type="text" class="form-control" id="Item[]"&gt; &#13;
                &lt;/div&gt; &#13;
            &lt;/div&gt; &#13;
            &lt;div class="form-group"&gt; &#13;
                &lt;div class="col-sm-offset-2 col-sm-10"&gt; &#13;
                    &lt;a href="#/dash" class="btn btn-default"&gt; &#13;
                    Save &#13;
                    &lt;/a&gt; &#13;
                &lt;/div&gt; &#13;
            &lt;/div&gt; &#13;
        &lt;/form&gt; &#13;
 &#13;
    &lt;/div&gt; &#13;
 &#13;
&lt;/div&gt; &#13;
</pre><p>Here, we've mocked up a form that could be used to add a new list. We'll flesh it out later, and actually connect it to the backend to store data.</p></div><div class="section" title="AngularJS controllers"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec125"/>AngularJS controllers</h2></div></div></div><p>Right now, our templates are basically just dumb HTML, the AngularJS method of linking our DOM to data and functionality. Controllers contain business logic, but should not be used to manipulate the DOM directly.</p><p>In using UI-router, we can easily attach controllers to states, making their <code class="literal">$scope</code> available to our views.</p><p>Create a new controllers folder inside <code class="literal">public/javascripts</code>. Create a new JavaScript file called <code class="literal">dashMainController.js</code>:</p><pre class="programlisting">angular.module('giftappControllers',[]) &#13;
    .controller('DashMainController', ['$scope', function($scope) { &#13;
        $scope.lists = [{'name':'Christmas List'}, {'name':'Birthday List'}]; &#13;
    }]); &#13;
</pre><p>We create a new module called <code class="literal">giftAppControllers</code> that takes no dependencies. Then, we build a controller called <code class="literal">DashMainController</code>. Using an array notation, we inject <code class="literal">$scope</code> and then declare a constructor function.</p><p>Inside that function we attach a lists array to <code class="literal">$scope</code>, which will make it available to any view that references this controller.</p><p>Next, we need to load that file into the <code class="literal">dashboard.ejs</code> view template:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html ng-app="giftapp"&gt; &#13;
&lt;head &gt; &#13;
    &lt;title&gt;Dashboard for &lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; &lt;/title&gt; &#13;
 &#13;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt; &#13;
 &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"&gt; &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"&gt; &#13;
    &lt;script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"&gt;&lt;/script&gt; &#13;
    &lt;script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.15/angular-ui-router.min.js"&gt;&lt;/script&gt; &#13;
 &#13;
 &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
&lt;nav class="nav navbar-default"&gt; &#13;
    &lt;div class="container-fluid"&gt; &#13;
        &lt;div class="navbar-header"&gt; &#13;
            &lt;a class="navbar-brand" href="#"&gt;&lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; Dashboard&lt;/a&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/nav&gt; &#13;
 &#13;
 &#13;
&lt;div class="container"&gt; &#13;
 &#13;
    &lt;div ui-view&gt;&lt;/div&gt; &#13;
 &#13;
    &lt;!-- div class="row"&gt; &#13;
        &lt;div class="col-xs-12 col-md-6"&gt; &#13;
            &lt;h2&gt;My Lists&lt;/h2&gt; &#13;
            &lt;a class="btn btn-primary" role="button" ui-sref="add"&gt; &#13;
                &lt;span class="glyphicon glyphicon-plus" aria-hidden="true"&gt;&lt;/span&gt; &#13;
                Add List&lt;/a&gt; &#13;
            &lt;a class="btn btn-primary" role="button" ui-sref="dash"&gt; &#13;
                &lt;span class="glyphicon glyphicon-plus" aria-hidden="true"&gt;&lt;/span&gt; &#13;
                Add List&lt;/a&gt; &#13;
            &lt;ul class="list-unstyled"&gt; &#13;
            &lt;% giftlists.forEach(function(giftlist, index){ -%&gt; &#13;
                &lt;li&gt;&lt;a class="btn btn-link" role="button"&gt;&lt;%= giftlist.name %&gt;&lt;/a&gt;&lt;/li&gt; &#13;
            &lt;% }); %&gt; &#13;
            &lt;/ul&gt; &#13;
        &lt;/div&gt; &#13;
 &#13;
        &lt;div class="col-xs-12 col-md-6"&gt; &#13;
            &lt;h2&gt;Lists Shared With Me&lt;/h2&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div --&gt; &#13;
 &#13;
&lt;/div&gt; &#13;
 &#13;
 &#13;
&lt;script src="/javascripts/giftapp.js"&gt;&lt;/script&gt; &#13;
<span class="strong"><strong>&lt;script src="/javascripts/controllers/dashMainController.js"&gt;&lt;/script&gt;</strong></span> &#13;
&lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>You'll note that you can load the controller module after your main module.</p><p>Next, we need to edit our main <code class="literal">giftapp.js</code> module to use the new controller as part of a route:</p><pre class="programlisting">
<span class="strong"><strong>angular.module('giftapp', ['ui.router', 'giftappControllers' ])</strong></span> &#13;
 &#13;
    .config( &#13;
        ['$stateProvider', '$urlRouterProvider', &#13;
            function ($stateProvider, $urlRouterProvider) { &#13;
 &#13;
                $urlRouterProvider &#13;
                    .otherwise('/dash'); &#13;
 &#13;
                $stateProvider &#13;
 &#13;
                    .state('dash', { &#13;
                        url:'/dash', &#13;
                        templateUrl: '/templates/dash-main.tpl.html', &#13;
<span class="strong"><strong>                        controller: 'DashMainController'</strong></span> &#13;
                    }) &#13;
                    .state('add', { &#13;
                        url:'/add', &#13;
                        templateUrl: '/templates/dash-add.tpl.html', &#13;
 &#13;
                    }); &#13;
 &#13;
            }]); &#13;
</pre><p>The first thing we do is to inject our new controller module into our <code class="literal">giftapp</code> module. This makes the <code class="literal">DashMainController</code> available in the module. We then set its name, as a string, to the controller property on our <code class="literal">dash</code> state.</p><p>The last thing we should do is to modify our template to take advantage of our new controller. Any methods or properties added to <code class="literal">$scope</code> in a controller become available inside the view.</p><p>Here's our new <code class="literal">dash-main.tpl.html</code>:</p><pre class="programlisting">&lt;div class="row"&gt; &#13;
    &lt;div class="col-xs-12 col-md-6"&gt; &#13;
        &lt;h2&gt;My Lists&lt;/h2&gt; &#13;
        &lt;a class="btn btn-primary" role="button" ui-sref="add" href="#/add"&gt; &#13;
            &lt;span class="glyphicon glyphicon-plus" aria-hidden="true"&gt;&lt;/span&gt; &#13;
            Add List&lt;/a&gt; &#13;
        &lt;ul class="list-unstyled"&gt; &#13;
<span class="strong"><strong>            &lt;li ng-repeat="list in lists"&gt;&lt;a class="btn btn-link" href="#" role="button"&gt;{{ list.name }}&lt;/a&gt;&lt;/li&gt;</strong></span> &#13;
 &#13;
        &lt;/ul&gt; &#13;
    &lt;/div&gt; &#13;
 &#13;
    &lt;div class="col-xs-12 col-md-6"&gt; &#13;
        &lt;h2&gt;Lists Shared With Me&lt;/h2&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/div&gt; &#13;
</pre><p>Instead of canned list items, we rely on the <code class="literal">ng-repeat</code> directive (provided by AngularJS itself). The <code class="literal">ng-repeat</code> directive iterates over things that are iterable - in this case an array called list. For each member of the array, the directive will paint a <code class="literal">li</code> element, assigning the instance to the variable list (essentially creating a new scope). Since our list objects all have name properties, we can access this in a markup expression with <code class="literal">{{list.name}}</code>.</p><p>Making sure our database and server are running, refreshing our dashboard should look like this:</p><p>
</p><div class="mediaobject"><img src="graphics/image_10_007.jpg" alt="AngularJS controllers"/></div><p>
</p><p>
<span class="strong"><strong>Christmas List</strong></span> and <span class="strong"><strong>Birthday List</strong></span> are coming from <code class="literal">$scope</code> in our new controller. Clicking on the <span class="strong"><strong>Add List</strong></span> button takes us to our add state and the page suddenly looks like this:</p><p>
</p><div class="mediaobject"><img src="graphics/image_10_008.jpg" alt="AngularJS controllers"/></div><p>
</p><p>So now we have the essence of a single page web application working. We have a model, views, and a controller. We have a method of managing state.</p><p>In mocking up this functionality, we did remove the connection to the database. So let's add that back in the AngularJS way.</p></div></div>
<div class="section" title="Talking to the backend"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec59"/>Talking to the backend</h1></div></div></div><p>So now we need to connect our frontend to our backend. Instead of rendering data in our page on load, we want to use AJAX to connect and do all of our CRUD. Fortunately for us, Angular has a pretty elegant way of handling this.</p><div class="section" title="Creating an AngularJS factory"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec126"/>Creating an AngularJS factory</h2></div></div></div><p>Let's say that different parts of our application may need access to some of the same data endpoints, or some other functionality. A great way to handle this is with an AngularJS provider. A provider is essentially an injectable singleton, and there are a number of options available - see <a class="ulink" href="https://docs.angularjs.org/guide/providers">https://docs.angularjs.org/guide/providers</a>.</p><p>The provider type we are going to use is a factory. Let's start by creating a <code class="literal">services</code> directory inside our <code class="literal">public/javascripts</code> directory. Create a new file called <code class="literal">giftlistFactory.js</code> inside that directory:</p><pre class="programlisting">angular.module('giftlistServices', []) &#13;
    .factory('List', function(){ &#13;
        return {} &#13;
    }); &#13;
</pre><p>We've created another module for services, and then created a factory called <code class="literal">List</code> on that module. That factory doesn't do much yet, but we'll get to that.</p><p>Next, we'll load this file using a <code class="literal">script</code> tag in our <code class="literal">dashboard.ejs</code> template:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html ng-app="giftapp"&gt; &#13;
&lt;head &gt; &#13;
    &lt;title&gt;Dashboard for &lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; &lt;/title&gt; &#13;
 &#13;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt; &#13;
 &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"&gt; &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"&gt; &#13;
    &lt;script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"&gt;&lt;/script&gt; &#13;
    &lt;script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.15/angular-ui-router.min.js"&gt;&lt;/script&gt; &#13;
 &#13;
 &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
&lt;nav class="nav navbar-default"&gt; &#13;
    &lt;div class="container-fluid"&gt; &#13;
        &lt;div class="navbar-header"&gt; &#13;
            &lt;a class="navbar-brand" href="#"&gt;&lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; Dashboard&lt;/a&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/nav&gt; &#13;
 &#13;
 &#13;
&lt;div class="container"&gt; &#13;
 &#13;
    &lt;div ui-view&gt;&lt;/div&gt; &#13;
 &#13;
     &#13;
 &#13;
&lt;/div&gt; &#13;
 &#13;
 &#13;
&lt;script src="/javascripts/giftapp.js"&gt;&lt;/script&gt; &#13;
&lt;script src="/javascripts/controllers/dashMainController.js"&gt;&lt;/script&gt; &#13;
<span class="strong"><strong>&lt;script src="/javascripts/services/giftlistFactory.js"&gt;&lt;/script&gt;</strong></span> &#13;
&lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>Now that we're loading this module, we can inject it into our controller. Open up <code class="literal">dashMainController.js</code> and edit the following:</p><pre class="programlisting">
<span class="strong"><strong>angular.module('giftappControllers',['giftlistServices'])</strong></span>
<span class="strong"><strong>    .controller('DashMainController', ['$scope','List', function($scope,List) {</strong></span> &#13;
        $scope.lists = [{'name':'Christmas List'}, {'name':'Birthday List'}]; &#13;
    }]); &#13;
</pre><p>We inject the <code class="literal">giftlistServices</code> module into our <code class="literal">giftappControllers</code> module. In our <code class="literal">DashMainController</code>, we inject the <code class="literal">List</code> factory. Currently, <code class="literal">List</code> only returns an empty object, but anything we place in there going forward becomes available to our controller.</p></div><div class="section" title="Using AngularJS $resource"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec127"/>Using AngularJS $resource</h2></div></div></div><p>The smart people who develop AngularJS figured out that a lot of what people want to do in an SPA is to talk to RESTful services. They had the idea to build a factory on top of their <code class="literal">$http</code> service (which provides AJAX functionality), which would provide an easy way to interact with a RESTful interface. That's precisely what <code class="literal">$resource</code> does.</p><p>We will begin by loading the <code class="literal">ngResource</code> module, which exposes <code class="literal">$resource</code>. In our <code class="literal">dashboard.ejs</code> template, add a <code class="literal">script</code> tag to load the module from CDN:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html ng-app="giftapp"&gt; &#13;
&lt;head &gt; &#13;
    &lt;title&gt;Dashboard for &lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; &lt;/title&gt; &#13;
 &#13;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt; &#13;
 &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"&gt; &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"&gt; &#13;
    &lt;script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"&gt;&lt;/script&gt; &#13;
    &lt;script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.15/angular-ui-router.min.js"&gt;&lt;/script&gt; &#13;
    &lt;script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-resource.js"&gt;&lt;/script&gt; &#13;
 &#13;
 &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
&lt;nav class="nav navbar-default"&gt; &#13;
    &lt;div class="container-fluid"&gt; &#13;
        &lt;div class="navbar-header"&gt; &#13;
            &lt;a class="navbar-brand" href="#"&gt;&lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; Dashboard&lt;/a&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/nav&gt; &#13;
 &#13;
 &#13;
&lt;div class="container"&gt; &#13;
 &#13;
    &lt;div ui-view&gt;&lt;/div&gt; &#13;
 &#13;
 &#13;
&lt;/div&gt; &#13;
 &#13;
 &#13;
&lt;script src="/javascripts/giftapp.js"&gt;&lt;/script&gt; &#13;
&lt;script src="/javascripts/controllers/dashMainController.js"&gt;&lt;/script&gt; &#13;
&lt;script src="/javascripts/services/giftlistFactory.js"&gt;&lt;/script&gt; &#13;
&lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>Now we have the module loaded, let's edit our factory to utilize <code class="literal">$resource</code>. Open <code class="literal">giftlistFactory</code> and make the following edits:</p><pre class="programlisting">angular.module('giftlistServices', ['ngResource']) &#13;
    .factory('List', function($resource){ &#13;
        return $resource('/giftlist/:id',{id: '@_id'}) &#13;
    }); &#13;
</pre><p>You can see that we inject the <code class="literal">ngResource</code> module in our module. This allows us to inject <code class="literal">$resource</code> into our <code class="literal">List</code> factory. Lastly, we return the result of invoking <code class="literal">$resouce</code> with the path <code class="literal">/giftlist/:id</code>. This, combined with the second argument, sets up a number of functions that optionally include an <code class="literal">id</code>.</p><p>Remember the resourceful controller we built earlier? We're going to make an edit with some hardcoded data, for now. <code class="literal">Opencontrollers/giftlist_controller.js</code>:</p><pre class="programlisting">exports.index = function(req, res){ &#13;
 &#13;
        var db = req.db; &#13;
        var collection = db.get('giftlist'); &#13;
 &#13;
        collection.find({'owner_id':'566dd0cb1c09d090fd36ba83'}, {}, function(err,giftlists){ &#13;
            if(err){ &#13;
                res.send(err); &#13;
            }else if(giftlists){ &#13;
                res.json(giftlists); &#13;
 &#13;
            }; &#13;
        }); &#13;
 &#13;
 &#13;
}; &#13;
</pre><p>For now, only edit the <code class="literal">index</code>. You can see that I've hardcoded the <code class="literal">owner_id</code> for the query to match the user in the database I've been working with. You should match your <code class="literal">user id</code> accordingly as it will differ from mine.</p><p>Now, edit your <code class="literal">dashMainController.js</code> file:</p><pre class="programlisting">angular.module('giftappControllers',['giftlistServices']) &#13;
    .controller('DashMainController', ['$scope','List', function($scope,List) { &#13;
<span class="strong"><strong>        $scope.lists = List.query();</strong></span> &#13;
         &#13;
    }]); &#13;
</pre><p>We set the value of <code class="literal">$scope.lists</code> to the result of running a query on our <code class="literal">List</code> resource. In this case, the result is an array of objects. If you restart your server and then reload the page, you'll see this:</p><p>
</p><div class="mediaobject"><img src="graphics/image_10_009.jpg" alt="Using AngularJS $resource"/></div><p>
</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec60"/>Summary</h1></div></div></div><p>In this chapter, you built out the major parts of the UI side of your SPA. You started by building a view in Express. You included <code class="literal">Bootstrap</code> for some easy styling, layout, and responsiveness. Then you refactored the page to utilize AngularJS.</p><p>You set up modules, routes, templates, and a controller using AngularJS. You then built a factory and injected <code class="literal">$resource</code> into it. You started to access data from a RESTful endpoint and then displayed that data in your application by mapping it to <code class="literal">$scope</code> in your controller.</p></div></body></html>