<html><head></head><body><div class="chapter" title="Chapter&#xA0;1.&#xA0;Patterns and Platform Tools"><div class="titlepage"><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Patterns and Platform Tools</h1></div></div></div><p>In this chapter we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Defining an app namespace</li><li class="listitem" style="list-style-type: disc">CommonJS in practice</li><li class="listitem" style="list-style-type: disc">Using platform indicators</li><li class="listitem" style="list-style-type: disc">Global logging using Ti.App.Listener</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec08"/>Introduction</h1></div></div></div><p>For many, building a Titanium app<a id="id0" class="indexterm"/> will be their first experience with a large, complete JavaScript project. Whether you are designing a small expense tracking system or a complete CRM tool<a id="id1" class="indexterm"/>, implementing proper design patterns in Titanium will improve the performance and maintainability of your app.</p><p>The cross-platform nature and underlying architecture of Titanium influences how many common design patterns can be implemented. In this chapter, we will demonstrate how to apply patterns to increase speed of development while implementing best practices for multiple device support.</p><div class="section" title="Introducing Titanium"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec07"/>Introducing Titanium</h2></div></div></div><p>Appcelerator Titanium Mobile<a id="id2" class="indexterm"/> is a platform for building cross-platform native mobile applications using modern web technologies, such as JavaScript<a id="id3" class="indexterm"/>, CSS<a id="id4" class="indexterm"/>, and HTML<a id="id5" class="indexterm"/>. Titanium Mobile is an open source project developed by Appcelerator Inc and licensed under the OSI-approved Apache Public License (Version 2).<a id="id6" class="indexterm"/>
</p><p>The Titanium Mobile project<a id="id7" class="indexterm"/> is one of the most active on Github with a large number of commits each day. The Github repository<a id="id8" class="indexterm"/> is the focal point for many in the community including module developers, app developers needing night builds, and individual contributors to the Titanium project.</p><p>The Titanium ecosystem<a id="id9" class="indexterm"/> is one of the largest in the industry with a community of more than 450,000 worldwide developers running apps on 10 percent of the world's devices. Appcelerator boasts one of the largest mobile marketplaces providing third-party components for Titanium Mobile platform.</p></div><div class="section" title="Architecture of Titanium"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec08"/>Architecture of Titanium</h2></div></div></div><p>Titanium is a module-based <a id="id10" class="indexterm"/>mobile development platform consisting of JavaScript and native platform code (Java, Objective-C, and C++). The architectural goal of Titanium is to provide a cross-platform JavaScript runtime and API for mobile development; this differs from other frameworks' approaches of building "native-wrapped" web applications.</p><p>Titanium uses a JavaScript interpreter to create a bridge between your app's JavaScript code and the underlying native platform. This approach allows Titanium to expose a large number of APIs, and native UI widgets without sacrificing performance. Titanium's UI controls are truly native and not visually emulated through CSS. Thus, when you create a <code class="literal">Ti.UI.Switch</code>, it is actually using the native UISwitch control on iOS.</p><p>Each Titanium application is organized into layered architecture consisting of the following major components:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Your JavaScript code</strong></span>: At <a id="id11" class="indexterm"/>compile time, this will be encoded and inserted into Java or Objective-C files</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Titanium's JavaScript interpreter</strong></span>: On <a id="id12" class="indexterm"/>Android V8 or JavaScriptCore for iOS</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The Titanium API</strong></span>: This <a id="id13" class="indexterm"/>is specific for a targeted platform created in Java, Objective-C, or C++</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Native Custom Modules</strong></span>: A<a id="id14" class="indexterm"/> large variety of open source and commercial modules are available<div class="mediaobject"><img src="graphics/5343OT_01_07.jpg" alt="Architecture of Titanium"/></div></li></ul></div><p>At runtime, the Titanium SDK embedded within your app creates a native code JavaScript execution context. This<a id="id15" class="indexterm"/> execution content is then used to evaluate your app's JavaScript code. As your JavaScript is executed, it will create proxy objects to access native APIs such as buttons and views. These proxies are special objects that exist both in the JavaScript and native contexts acting as a bridge between the two environments.</p><p>For example, if we have a <code class="literal">Ti.UI.View</code> object and we update the <code class="literal">backgroundColor</code> to <code class="literal">blue</code>, the property is changed in JavaScript and then the proxy then updates the correct property in the underlying native layer as shown in the following diagram:</p><div class="mediaobject"><img src="graphics/5343OT_01_08.jpg" alt="Architecture of Titanium"/></div></div><div class="section" title="Building a Cross-platform"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec09"/>Building a Cross-platform</h2></div></div></div><p>Titanium provides <a id="id16" class="indexterm"/>a high-level cross-platform API, <a id="id17" class="indexterm"/>however it is not a write once, run anywhere framework. When building cross-platform apps, it is recommended to adopt a "write once, adapt everywhere" philosophy. With Titanium you can add platform-specific code to handle each platform's different UI requirements, while keeping your business logic 100 percent cross-platform compatible.</p><p>Building best of breed cross-platform applications, Titanium provides tools to:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Identify the platform and model at runtime</li><li class="listitem" style="list-style-type: disc">Ability to handle platform-specific resources at build time</li><li class="listitem" style="list-style-type: disc">Apply platform and device-specific styling</li></ul></div><p>In addition<a id="id18" class="indexterm"/> to platform tooling, the Titanium API is designed to assist with cross-platform development. <a id="id19" class="indexterm"/>Each major component such as <code class="literal">Maps</code>, <code class="literal">Contacts</code>, and <code class="literal">FileSystem</code> are separated into its own component namespaces under the top-level namespace called <code class="literal">Ti</code> or <code class="literal">Titanium</code>. These component namespaces then have their own child namespaces to segment platform-specific behavior.</p><p>An example of this segmentation is the <code class="literal">Ti.UI namespace</code>, which contains all UI components. This namespace contains common APIs such as <code class="literal">Ti.UI.View</code> and <code class="literal">Ti.UI.TableView</code>. Additionally, the <code class="literal">Ti.UI</code> namespace has platform-specific child namespaces such as <code class="literal">Ti.UI.iPad</code> containing controls such as <code class="literal">Ti.UI.iPad.Popover</code>. The same design applies to non-visual APIs such as <code class="literal">Ti.Android</code>, a namespace which contains Android-specific behavior.</p></div></div></div>
<div class="section" title="Defining an app namespace"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Defining an app namespace</h1></div></div></div><p>Using namespaces is <a id="id20" class="indexterm"/>important in Titanium app development, as it helps organize your code while not polluting the global namespace. The practice of creating variables and methods without being associated with a namespace or other scoping condition is called <span class="strong"><strong>polluting the global namespace</strong></span>
<a id="id21" class="indexterm"/>. Since these functions and objects are scoped globally, they will not be eligible for collection until the global namespace loses scope during application shutdown. This can often result in memory leaks or other unwanted side effects.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec10"/>How to do it...</h2></div></div></div><p>The following example shows how to create a namespace for our app in our <code class="literal">app.js</code> called <code class="literal">my</code> with three subnamespaces called <code class="literal">ui</code>, <code class="literal">tools</code>, and <code class="literal">controllers</code>.</p><div class="informalexample"><pre class="programlisting">var my = {ui:{},tools:{},controllers:{}}</pre></div><p>As we build our recipes, we will continue to add functionality to the preceding namespaces.</p></div></div>
<div class="section" title="CommonJS in practice"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec10"/>CommonJS in practice</h1></div></div></div><p>Organizing your <a id="id22" class="indexterm"/>application code using CommonJS modules is a best practice in Titanium development. CommonJS is a popular specification for creating reusable JavaScript modules and has been adopted by several major platforms and frameworks such as Node.js<a id="id23" class="indexterm"/> and <a id="id24" class="indexterm"/>MongoDb.</p><p>CommonJS modules<a id="id25" class="indexterm"/> help solve JavaScript scope problems, placing each module within its own namespace and execution context. Variables and functions are locally scoped to the module, unless explicitly exported for use by other modules.</p><p>In addition to assisting with JavaScript scope concerns, CommonJS provides a pattern to expose a public stable interface to program against. The information-hiding design pattern allows module developers to update the internals of the module without breaking the public contract or interface. The ability to maintain a stable public interface in JavaScript is the key part of writing maintainable code that will be shared across apps and teams.</p><p>Titanium has implemented CommonJS in a similar fashion to Node.js in that you use the <code class="literal">require</code> method to return a JavaScript object, with properties, functions, and other data assigned to it, which form the public interface to the module.</p><p>The following screenshots illustrate the example app used to demonstrate the CommonJS high-level concepts that will be used throughout the book.</p><div class="mediaobject"><img src="graphics/5343OT_01_01.jpg" alt="CommonJS in practice"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec11"/>Getting ready</h2></div></div></div><p>Adding the CommonJS modules <a id="id26" class="indexterm"/>used in this recipe is straightforward and consists of copying the <code class="literal">datahelper.js</code> and <code class="literal">dateWin.js</code> files into the root of our Titanium project as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5343OT_01_02.jpg" alt="Getting ready"/></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec12"/>How to do it...</h2></div></div></div><p>The following <a id="id27" class="indexterm"/>recipe illustrates how to use CommonJS to create both <code class="literal">UI</code> and <code class="literal">Tools</code> modules. In the following example, a simple app is created, which allows the user to increase or decrease the date by a day.</p><div class="section" title="Creating the project's app.js"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec01"/>Creating the project's app.js</h3></div></div></div><p>In our <code class="literal">app.js</code>
<a id="id28" class="indexterm"/> we create our application namespace. These namespace variables will be used to reference our CommonJS modules later in the example.</p><div class="informalexample"><pre class="programlisting">//Create our application namespace
var my = {
  ui:{
    mod : require('dateWin')
  },
  tools:{},
  controllers:{}
};</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip02"/>Tip</h3><p>
<span class="strong"><strong>Downloading the example code</strong></span>
</p><p>You can download the example code files for all Packt books you have purchased from your account at <a class="ulink" href="http://www.PacktPub.com">http://www.PacktPub.com</a>. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.PacktPub.com/support">http://www.PacktPub.com/support</a> and register to have the files e-mailed directly to you.</p></div></div><p>
<code class="literal">Ti.UI.Window</code>
<a id="id29" class="indexterm"/> is then created using the <code class="literal">my.ui.mod</code> already added to our app namespace. The <code class="literal">open</code> method<a id="id30" class="indexterm"/> is then called on our <code class="literal">win</code> object to open our example app's main window.</p><div class="informalexample"><pre class="programlisting">my.ui.win = my.ui.mod.createWindow();

my.ui.win.open();</pre></div></div><div class="section" title="Building the datehelpers module"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec02"/>Building the datehelpers module</h3></div></div></div><p>In the <code class="literal">Resources</code> folder<a id="id31" class="indexterm"/> of our project, we have a CommonJS module <code class="literal">datehelpers.js</code>. This module has the following code:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">helpers</code> method<a id="id32" class="indexterm"/> is created within the <code class="literal">datahelpers</code> module. This function is private by default until it is exposed using the <code class="literal">exports</code> object.<div class="informalexample"><pre class="programlisting">var helpers = function(){
  var createAt = new Date();</pre></div></li><li class="listitem">The <code class="literal">createdOn</code> method<a id="id33" class="indexterm"/> is added to the <code class="literal">helpers</code> function. This function returns the <code class="literal">createAt</code> variable. This function is used to provide a timestamp value to demonstrate how the module can be initialized several times. Each time a new session is created for the module, the <code class="literal">createAt</code> variable will display the newly initialized timestamp.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  </strong></span>this.createdOn = function(){
    return createAt;
  };</pre></div></li><li class="listitem">The <code class="literal">addDays</code> method<a id="id34" class="indexterm"/> is added to the <code class="literal">helpers</code> function. This method increases the provided date value by the number of days provided in the <code class="literal">n</code> argument.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  </strong></span>this.addDays = function(value,n){
    var tempValue = new Date(value.getTime()); 
    tempValue.setDate(tempValue.getDate()+n);
    return tempValue;
  }
};</pre></div></li></ol></div><p>The <code class="literal">module.exports</code> is the object returned as the result of a <code class="literal">require</code> call. By assigning the <code class="literal">helpers</code> function to <code class="literal">module.exports</code>, we are able to make the private <code class="literal">helpers</code> function<a id="id35" class="indexterm"/> publically accessible.</p><div class="informalexample"><pre class="programlisting">module.exports = helpers;</pre></div></div><div class="section" title="The dateWin module"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec03"/>The dateWin module</h3></div></div></div><p>Also included in <a id="id36" class="indexterm"/>the <code class="literal">Resources</code> folder of our project is a CommonJS module <code class="literal">dateWin.js</code>. The following code section discusses the contents of this module.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Use the <code class="literal">require</code> keyword to import the <code class="literal">datehelpers</code> CommonJS module<a id="id37" class="indexterm"/>. This is imported in the <code class="literal">mod</code> module level variable for later usage.<div class="informalexample"><pre class="programlisting">var mod = require('datehelpers');</pre></div></li><li class="listitem">The <code class="literal">createWindow</code> function<a id="id38" class="indexterm"/> returns <code class="literal">Ti.UI.Window</code> allowing the user to work with the recipe.<div class="informalexample"><pre class="programlisting">exports.fetchWindow=function(){</pre></div></li><li class="listitem">Next a new instance of the <code class="literal">dateHelper</code> module<a id="id39" class="indexterm"/> is created.<div class="informalexample"><pre class="programlisting">  var dateHelper = new mod();</pre></div></li><li class="listitem">The next step in building the <code class="literal">createWindow</code> function<a id="id40" class="indexterm"/> is to set the <code class="literal">currentDateTime</code> module property to a default of the current date/time.<div class="informalexample"><pre class="programlisting">  var currentDateTime = new Date();</pre></div></li><li class="listitem">The <code class="literal">Ti.UI.Window</code> object, which will be returned by the <code class="literal">createWindow</code> function, is then created. This will be used to attach all of our UI elements.<div class="informalexample"><pre class="programlisting">  var win = Ti.UI.createWindow({
    backgroundColor:'#fff'
  });</pre></div></li><li class="listitem">The <code class="literal">dateDisplayLabel</code> is used to show the result of the <code class="literal">datehelper</code> module as the user increases or decreases the date value.<div class="informalexample"><pre class="programlisting">  var dateDisplayLabel = Ti.UI.createLabel({
    text:String.formatDate
    (exports.currentDateTime,"medium"),
    top:120, height:50, width:Ti.UI.FILL, 
    textAlign:'center', color:'#000', font:{fontSize:42}
  });
  win.add(dateDisplayLabel);</pre></div></li><li class="listitem">The <code class="literal">addButton</code> is used later in this recipe to call the <code class="literal">datehelper</code> module and add days to the current module value.<div class="informalexample"><pre class="programlisting">  var addButton = Ti.UI.createButton({
    title:"Add Day", top:220, left:5, width:150, height:50
  });
  win.add(addButton);</pre></div></li><li class="listitem">The <code class="literal">subtractButton</code><a id="id41" class="indexterm"/> is used later in this recipe to call the <code class="literal">datehelper</code> module and reduce the date of the current module value.<div class="informalexample"><pre class="programlisting">  var subtractButton = Ti.UI.createButton({
    title:"Subtract Day", top:220, right:5, 
  	 width:150, height:50
  });
  win.add(subtractButton);</pre></div></li><li class="listitem">The following <a id="id42" class="indexterm"/>code in the <code class="literal">addButton</code> and <code class="literal">subtractButton</code> click handlers shows how the <code class="literal">AddDays</code> method is called to increment the <code class="literal">currentDateTime</code> property of the module.<div class="informalexample"><pre class="programlisting">  addButton.addEventListener('click',function(e){</pre></div></li><li class="listitem">The following line demonstrates how to increase the <code class="literal">currentDateTime</code> value by a single day:<div class="informalexample"><pre class="programlisting">    exports.currentDateTime = 
    dateHelper.addDays(currentDateTime,1);</pre></div></li><li class="listitem">Update the <code class="literal">dateDisplayLabel</code> with the new module value.<div class="informalexample"><pre class="programlisting">    dateDisplayLabel.text = String.formatDate(
    exports.currentDateTime,"medium");
  });    
  subtractButton.addEventListener('click',function(e){</pre></div></li><li class="listitem">The following code snippet demonstrates how to reduce the <code class="literal">currentDateTime</code> by a day:<div class="informalexample"><pre class="programlisting">    exports.currentDateTime = 
    _dateHelper.addDays(currentDateTime,-1);</pre></div></li><li class="listitem">Update the <code class="literal">dateDisplayLabel</code> with the new module value.<div class="informalexample"><pre class="programlisting">    dateDisplayLabel.text = String.formatDate(
    currentDateTime,"medium");
  });
  return win;
};</pre></div></li></ol></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec13"/>How it works...</h2></div></div></div><p>Creating a<a id="id43" class="indexterm"/> module is easy. You simply add a JavaScript file to your project and write your application code. By default, any variables, objects, or functions are private unless you have added them to the <code class="literal">module</code> or <code class="literal">exports</code> objects. The <code class="literal">module</code> and <code class="literal">exports</code> objects are special JavaScript objects created by Titanium and returned by the <code class="literal">require</code> method.</p><div class="section" title="Require"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec04"/>Require</h3></div></div></div><p>To use a CommonJS module <a id="id44" class="indexterm"/>you must use the globally available <code class="literal">require</code> function. This function has a single parameter through which you provide the path to your JavaScript module. The following line demonstrates how to load a CommonJS module called <code class="literal">datehelpers.js</code> located in the root of your Titanium project.</p><div class="informalexample"><pre class="programlisting">var myModule = require('datehelpers');</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note02"/>Note</h3><p>When providing the <code class="literal">require</code> function with an absolute path, Titanium will start from the <code class="literal">Resources</code> folder of your project.</p></div></div><p>Titanium has optimized the module loading process so that when a module is first loaded using the <code class="literal">require</code> method, it is then cached to avoid the need to re-evaluate the module's JavaScript. This approach significantly improves the load performance for modules which share common dependencies. It is helpful to keep in mind the JavaScript is not re-evaluated if you have the need to manage/alter the module on load.</p></div><div class="section" title="Properties"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec05"/>Properties</h3></div></div></div><p>Adding a property to<a id="id45" class="indexterm"/> your CommonJS module is easy. You simply attach a variable to the <code class="literal">exports</code> object.</p><p>The following snippet demonstrates how to create a basic CommonJS property with a default value.</p><div class="informalexample"><pre class="programlisting">exports.myProperty = "I am a property";</pre></div><p>More complex object properties can also be created, for example, as follows:</p><div class="informalexample"><pre class="programlisting">exports.myObjectProperty = {
  foo:1,
  bar:'hello'
};</pre></div><p>You can also use a private variable to set the initial property's value. This often makes for more readable and streamlined code.</p><p>Create a local variable reflecting your business need.</p><div class="informalexample"><pre class="programlisting">var _myObjectProperty = {
  foo:1,
  bar:'hello'
};</pre></div><p>You can then assign the local variable to a property attached to the <code class="literal">exports</code> object, for example, as follows:</p><div class="informalexample"><pre class="programlisting">exports.myObjectProperty = _myObjectProperty</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note03"/>Note</h3><p>Remember these are just properties on the <code class="literal">exports</code> JavaScript object and can be changed by any caller.</p></div></div></div><div class="section" title="Functions"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec06"/>Functions</h3></div></div></div><p>Creating public functions<a id="id46" class="indexterm"/> is easy in CommonJS, you simply add a function to the <code class="literal">exports</code> object. Create an <code class="literal">Adddays</code> method as part of the <code class="literal">exports</code> object. This function accepts a date in the <code class="literal">value</code> parameter and an integer as the <code class="literal">n</code> value.</p><div class="informalexample"><pre class="programlisting">exports.AddDays = function(value,n){</pre></div><p>Create a new variable to avoid the provided value from mutating.</p><div class="informalexample"><pre class="programlisting">  var workingValue = new Date(value.getTime());</pre></div><p>Increase the date by using the <code class="literal">n</code> value provided. This could be either a positive or negative value. Negative values will decrease the date value provided.</p><div class="informalexample"><pre class="programlisting">  workingValue.setDate(workingValue.getDate()+n);</pre></div><p>Return the new adjusted value.</p><div class="informalexample"><pre class="programlisting">  return workingValue;
};</pre></div><p>You can also assign an <code class="literal">exports</code> method to a privately scoped function. This can be helpful in managing large or complex functions.</p><p>Create a locally scoped function named <code class="literal">addDays</code>.</p><div class="informalexample"><pre class="programlisting">function addDays(value,n){
  var workingValue = new Date(value.getTime());
  workingValue.setDate(workingValue.getDate()+n);
  return workingValue;
};</pre></div><p>The <code class="literal">addDays</code> function is then assigned to <code class="literal">exports.AddDays</code> exposing it to callers outside of the module.</p><div class="informalexample"><pre class="programlisting">exports.AddDays = addDays;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note04"/>Note</h3><p>Remember these are just methods on the <code class="literal">exports</code> JavaScript object and can be changed by any caller.</p></div></div></div><div class="section" title="Instance object using module.exports"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec07"/>Instance object using module.exports</h3></div></div></div><p>Titanium provides <a id="id47" class="indexterm"/>the ability to create a module instance object using <code class="literal">module.exports</code>. This allows you to create a new instance of the function or object attached to <code class="literal">module.exports</code>. This is helpful in describing one particular object and the instance methods represent actions that this particular object can take.</p><p>This pattern encourages developers to think more modularly and to follow the single responsibility principle as only one object or function can be assigned to the <code class="literal">module.exports</code>.</p><p>The following code snippets demonstrate how to create and call a module using this pattern:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Using Titanium Studio, create the employee (<code class="literal">employee.js</code>) module file.</li><li class="listitem">Next create the <code class="literal">employee</code> function.<div class="informalexample"><pre class="programlisting">var employee = function(name,employeeId,title){
  this.name = name;
  this.employeeId = employeeId;
  this.title = title;
  this.isVIP = function(level){
    return (title.toUpperCase()==='CEO');
  }
};</pre></div></li><li class="listitem">Then assign the <code class="literal">employee</code> function to <code class="literal">module.exports</code>. This will make the <code class="literal">employee</code> function publicly available to call using <code class="literal">require</code>.<div class="informalexample"><pre class="programlisting">module.exports = employee;</pre></div></li><li class="listitem">Using <code class="literal">require</code>, a reference to the module is created and assigned to the <code class="literal">employee</code> variable.<div class="informalexample"><pre class="programlisting">var employee = require('employee');</pre></div></li><li class="listitem">Next the <code class="literal">bob</code> and <code class="literal">chris</code> objects are created using new instances of the <code class="literal">employee</code> object created earlier.<div class="informalexample"><pre class="programlisting">var bob = new employee('Bob Smith',1234,'manager');
var chris = new employee('Chris Jones',001,'CEO');</pre></div></li><li class="listitem">Finally, the properties and functions on the <code class="literal">bob</code> and <code class="literal">chris</code> objects are called to demonstrate each object's instance information.<div class="informalexample"><pre class="programlisting">Ti.API.info('Is ' + bob.name + ' a VIP? ' + bob.isVIP());
Ti.API.info('Is ' + chris.name + ' a VIP? ' + chris.isVIP());</pre></div></li></ol></div></div><div class="section" title="CommonJS global scope anti-pattern"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec08"/>CommonJS global scope anti-pattern</h3></div></div></div><p>The CommonJS implementation <a id="id48" class="indexterm"/>across Android and iOS is largely the same with one major scoping exception. If you are using a version of the Titanium <a id="id49" class="indexterm"/>framework below version 3.1, Android scopes all variable access to the module itself, while iOS allows the module to access objects outside of the module already loaded in the execution context. This should be considered an anti-pattern as it breaks many of the encapsulation principles the CommonJS specification was designed to prevent.</p><p>In Titanium Version 3.1, the decision has been made to deprecate global scope access in both iOS and Android in favor of the new <code class="literal">Alloy.Globals</code> object. You can read more about the <code class="literal">Alloy.Globals</code> object at <a class="ulink" href="http://docs.appcelerator.com/titanium/latest/#!/api/Alloy">http://docs.appcelerator.com/titanium/latest/#!/api/Alloy</a>.</p><p>The following recipe demonstrates this common anti-pattern and highlights the CommonJS implementation differences in this area between iOS and Android.</p><div class="informalexample"><pre class="programlisting">//Create our application namespace
var my = {
  tools: require('scope_test'),
  session:{
    foo: "Session value in context"
  }
};</pre></div><p>The <code class="literal">testScope</code> method is called on the <code class="literal">tools</code> module. This demonstrates how CommonJS module scope anti-pattern works.</p><div class="informalexample"><pre class="programlisting">my.tools.testScope();</pre></div><p>The <code class="literal">tools</code> module containing the <code class="literal">testScope</code> method is part of this recipe's code and can be found in the <code class="literal">scope.js</code> file root of our project. This module contains the following code:</p><div class="informalexample"><pre class="programlisting">exports.testScope = function(){
<span class="strong"><strong>  Ti.API.log</strong></span>
<span class="strong"><strong>  ("Test Module Scope - Foo =  " + my.session.foo);</strong></span>
<span class="strong"><strong>  return my.session.foo;</strong></span>
};</pre></div><p>The scope-access anti-pattern is shown when calling the <code class="literal">my.tools.testScope()</code> method. In iOS, <code class="literal">my.tools.testScope()</code> returns <code class="literal">"Session Value in context"</code>, because it has access to <code class="literal">my.session.foo</code> from the current execution context. In Android, prior to <a id="id50" class="indexterm"/>Titanium SDK Version 3.1, undefined<a id="id51" class="indexterm"/> object used to be returned as the module did not have access to the <code class="literal">my.session.foo</code> object. In the Titanium SDK Version 3.1 and greater, Android now returns <code class="literal">"Session Value in context"</code> as it has access to the <code class="literal">my.session.foo</code> object.</p><p>Access to global scope has been deprecated on both platforms starting with Titanium SDK Version 3.1 and will be removed in a future version of the SDK. If you have previously implemented this anti-pattern, corrective action is recommended as the deprecation of this feature will cause breaking changes within your app.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec14"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To learn more about the CommonJS specification, please visit the wiki on CommonJS.org at <a class="ulink" href="http://wiki.commonjs.org/wiki/CommonJS">http://wiki.commonjs.org/wiki/CommonJS</a></li><li class="listitem" style="list-style-type: disc">For more details and examples on Titanium's implementation of the CommonJS specification, please review their guides at <a class="ulink" href="http://docs.appcelerator.com/titanium/latest/#!/guide/CommonJS_Modules_in_Titanium">http://docs.appcelerator.com/titanium/latest/#!/guide/CommonJS_Modules_in_Titanium</a></li></ul></div></div></div>
<div class="section" title="Using platform indicators"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec11"/>Using platform indicators</h1></div></div></div><p>Handling <a id="id52" class="indexterm"/>different devices, platforms, and models <a id="id53" class="indexterm"/>is often the biggest challenge with cross-platform development. Titanium provides the <code class="literal">Ti.Platform</code> namespace to help you make decisions in your code on how to handle runtime execution.</p><p>In the following recipes, we will walk through how to create a <code class="literal">PlatformHelpers</code> CommonJS module<a id="id54" class="indexterm"/> containing convenience methods to solve many of your platform-related queries. The following screenshots demonstrate this recipe while running on both the iPhone and Android platforms.</p><div class="mediaobject"><img src="graphics/5343OT_01_03.jpg" alt="Using platform indicators"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec15"/>Getting ready</h2></div></div></div><p>The <code class="literal">Ti.Platform</code> namespace is helpful for providing platform and device-specific details, but often you need <a id="id55" class="indexterm"/>a high level of detail such as when you have a tablet running your app and if so if it is an iPad Mini.</p><div class="section" title="Adding recipe components to your project"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec09"/>Adding recipe components to your project</h3></div></div></div><p>Adding the <code class="literal">PlatformHelpers</code> module<a id="id56" class="indexterm"/> to your project is easy. Simply copy the <code class="literal">platform_helpers.js</code> file into your project as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5343OT_01_04.jpg" alt="Adding recipe components to your project"/></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec16"/>How to do it...</h2></div></div></div><p>The following <code class="literal">app.js</code> demonstrates the <code class="literal">PlatformHelpers</code> module<a id="id57" class="indexterm"/> described earlier in this chapter. This sample app presents a window with your device details. Give it a try on all of your Android and iOS devices.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To create our same app, first we declare our app namespace and import our <code class="literal">PlatformHelper</code> module.<div class="informalexample"><pre class="programlisting">//Create our application namespace
var my = {
  platformHelpers : require('platform_helpers')
};

(function(){</pre></div></li><li class="listitem">Next we create the window in which we will present the device information.<div class="informalexample"><pre class="programlisting">var win = Ti.UI.createWindow({
  backgroundColor:'#fff'
});</pre></div></li><li class="listitem">Next we create an empty array to store our device details.<div class="informalexample"><pre class="programlisting">var deviceData = [];</pre></div><p>An entry is added to <code class="literal">deviceData</code> if your device is running on a simulator.</p><p>The <code class="literal">isSimulator</code> property<a id="id58" class="indexterm"/> is used to show the simulator message, only if the recipe is currently running on a platform simulator or emulator.</p><div class="informalexample"><pre class="programlisting">if(my.platformHelpers.isSimulator){
  deviceData.push({
    title:'Running on Simulator', child:false
  });
}</pre></div></li><li class="listitem">Next the<a id="id59" class="indexterm"/> platform, operating system's name, and manufacturer are added to <code class="literal">deviceData</code>.<div class="informalexample"><pre class="programlisting">deviceData.push({
  title:'Platform: ' + 
  (my.platformHelpers.isAndroid ? 'Android' : 'iOS'), 
  child:false
});

deviceData.push({
  title:'osname: ' +  my.platformHelpers.osname, 
  child:false
});

deviceData.push({
  title:'manufacturer: ' +  
  my.platformHelpers.manufacturer, child:false
});</pre></div></li><li class="listitem">The following statement adds a flag to <code class="literal">deviceData</code> indicating if the current device is a tablet form factor:<div class="informalexample"><pre class="programlisting">deviceData.push({
  title:(my.platformHelpers.isTablet ? 
  'Is a Tablet' : 'Is not a Tablet'), child:false
});</pre></div></li><li class="listitem">Next we add the device model and specify if it supports background tasks in the <code class="literal">deviceData</code> array.<div class="informalexample"><pre class="programlisting">deviceData.push({
  title:'Model: ' + my.platformHelpers.deviceModel, 
  child:false
});

deviceData.push({
  title:'Backgrounding Support: ' + 
  my.platformHelpers.supportsBackground,
  child:false
});</pre></div></li><li class="listitem">Screen dimensions<a id="id60" class="indexterm"/> are the most commonly used properties. The following snippet adds the height and width of the screen to the <code class="literal">deviceData</code> array:<div class="informalexample"><pre class="programlisting">deviceData.push({
  title:'Height: ' + my.platformHelpers.deviceHeight +
  ' Width: ' + my.platformHelpers.deviceWidth,
  child:false
});</pre></div></li><li class="listitem">If your app is currently running on an iOS device, the following snippet adds the device type and specifies if it is retina enabled, to the <code class="literal">deviceData</code> array.<div class="informalexample"><pre class="programlisting">if(my.platformHelpers.isIOS){
  deviceData.push({
    title:'iOS Device Type: ' + 
    (my.platformHelpers.iPad ? 
    (my.platformHelpers.iPadMiniNonRetina ? 
    'iPad Mini' : 'Is an iPad') : 'iPhone'),
    child:false
  });

  deviceData.push({
    title:'Is Retina : ' + my.platformHelpers.isRetina,
    child:false
  });				
}</pre></div></li><li class="listitem">The <code class="literal">PlatformHelper</code> module provides a great deal of data. To best display this, we will be using a <code class="literal">Ti.UI.TableView</code> with the <code class="literal">deviceData</code> array that we have built in an earlier code snippet.<div class="informalexample"><pre class="programlisting">var tableView = Ti.UI.createTableView({top:0, 
data:deviceData});

  win.add(tableView);
  win.open();
})(); </pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec17"/>How it works...</h2></div></div></div><p>The device platform lookups <a id="id61" class="indexterm"/>will frequently be accessed across your app. To avoid performance issues by repeatedly crossing the JavaScript Bridge, we import the values we will use and assign them to properties in our CommonJS <code class="literal">PlatformHelpers</code> module.</p><div class="informalexample"><pre class="programlisting">exports.osname = Ti.Platform.osname;
exports.manufacturer = Ti.Platform.manufacturer;
exports.deviceModel = Ti.Platform.model;
exports.deviceHeight = Ti.Platform.displayCaps.platformHeight;
exports.deviceWidth = Ti.Platform.displayCaps.platformWidth;
exports.densitylevel = Ti.Platform.displayCaps.density;
exports.deviceDPI = Ti.Platform.displayCaps.dpi;</pre></div><p>It is often helpful to have a Boolean indicator for the platform with which you are working. The following snippet shows how to create <code class="literal">isAndroid</code> and <code class="literal">isIOS</code> properties to accomplish this:</p><div class="informalexample"><pre class="programlisting">exports.isAndroid = exports.osname === 'android';
exports.isIOS = (exports.osname === 'ipad' || 
exports.osname === 'iphone');</pre></div><div class="section" title="Simulator check"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec10"/>Simulator check</h3></div></div></div><p>Depending on your platform,<a id="id62" class="indexterm"/> several features may not work in that platform's simulator or emulator. By using the <code class="literal">isSimulator</code> property, detect which environment you are in and branch your code accordingly.</p><div class="informalexample"><pre class="programlisting">exports.isSimulator = (function(){
  return (Ti.Platform.model.toUpperCase() === 'GOOGLE_SDK' || 
  Ti.Platform.model.toUpperCase()  === 'SIMULATOR' || 
  Ti.Platform.model.toUpperCase()  === 'X86_64')
})();</pre></div></div><div class="section" title="Background capabilities"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec11"/>Background capabilities</h3></div></div></div><p>Mobile apps are often <a id="id63" class="indexterm"/>required to perform tasks in the background. This recipe demonstrates how to perform a version-based capability <a id="id64" class="indexterm"/>check to determine if the device your application is running on supports backgrounding/multitasking.</p><div class="informalexample"><pre class="programlisting">exports.supportsBackground = (function(){</pre></div><p>Now perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First check if the user is running on Android. If so, return <code class="literal">true</code> as most Android ROMs support background processing by default.<div class="informalexample"><pre class="programlisting">  if(exports.osname === 'android'){
    return true;
  }</pre></div></li><li class="listitem">Next confirm the recipe is running on an iOS device.<div class="informalexample"><pre class="programlisting">  if(exports.osname === 'iphone'){</pre></div></li><li class="listitem">The version is checked to ensure that the device is running iOS 4 or greater. This confirms the operating system supports background processing.<div class="informalexample"><pre class="programlisting">    var osVersion = Ti.Platform.version.split(".");
    //If no iOS 4, then false
    if(parseInt(osVersion[0],10) &lt; 4){
      return false;
    } </pre></div></li><li class="listitem">Finally the recipe confirms the device version is greater than the iPhone 3GS. This confirms the hardware supports background processing.<div class="informalexample"><pre class="programlisting">    var model = exports.deviceModel.toLoweCase()
    .replace("iphone","").trim();
    var phoneVersion = Ti.Platform.version.split(".");
    if(parseInt(phoneVersion[0],10) &lt; 3){
      return false;
    } 		
  }
  //Assume modern device return true
  return true;

})();</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note05"/>Note</h3><p>Depending on the platform, this feature may be turned off by the user. A secondary capacity check is also recommended.</p></div></div></li></ol></div><div class="section" title="Detecting tablets"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl4sec01"/>Detecting tablets</h4></div></div></div><p>Universal app<a id="id65" class="indexterm"/> development is a common requirement on both Android and iOS. The following helper provides a Boolean indicator if your app is running on a tablet form factor:</p><div class="informalexample"><pre class="programlisting">//Determine if running on a tablet
exports.isTablet = (function() {</pre></div><p>Check if the device is either an iPad or an Android device with at least one dimension of 700 pixels or greater.</p><div class="informalexample"><pre class="programlisting">  var tabletCheck = exports.osname === 'ipad' || 
    (exports.osname === 'android' &amp;&amp; 
    (!(Math.min(
    exports.deviceHeight,
    exports.deviceWidth
    ) &lt; 700)));
    return tabletCheck;
})();</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note06"/>Note</h3><p>For Android, this checks if there is a height or width greater than 700 pixels. You may wish to change this based on your targeted devices. For example, if you are targeting some of the larger screen Android phones, you would need to update the default 700 pixels/points to reflect them having a large screen yet still being considered a phone form factor.</p></div></div></div><div class="section" title="A 4-inch iPhone"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl4sec02"/>A 4-inch iPhone</h4></div></div></div><p>With the introduction of <a id="id66" class="indexterm"/>the iPhone 5, we need to be aware of two different iPhone screen sizes. The following snippet shows how to create a property indicating if your app is running on an iPhone with this new screen size.</p><div class="informalexample"><pre class="programlisting">exports.newIPhoneSize = (function(){</pre></div><p>First verify the recipe is running on an iPhone device.</p><div class="informalexample"><pre class="programlisting">  if(exports.osname !== 'iphone'){
    return false;
  }</pre></div><p>Next check the size to see if there is any dimension greater than 480 points.</p><div class="informalexample"><pre class="programlisting">  return (Math.max(
    exports.deviceHeight,
    exports.deviceWidth
  ) &gt; 480);
});</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note07"/>Note</h3><p>Please note, the preceding <code class="literal">newIPhoneSize</code> method will only return <code class="literal">true</code>, if the app has been completed to support a 4-inch display. Otherwise, it will return <code class="literal">false</code> as your app is running in the letterbox mode.</p></div></div></div><div class="section" title="iPad"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl4sec03"/>iPad</h4></div></div></div><p>Titanium allows<a id="id67" class="indexterm"/> you to create universal apps on iOS. Using the following property, you can branch your code to show different functionalities to your iPad users:</p><div class="informalexample"><pre class="programlisting">exports.iPad = exports.osname === 'ipad';</pre></div></div><div class="section" title="iPad Mini"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl4sec04"/>iPad Mini</h4></div></div></div><p>The iPad Mini was <a id="id68" class="indexterm"/>designed with the same resolution as the first and second generation iPads. Although designed to run iPad apps without modification, the smaller screen size often requires UI adjustments for smaller touch targets. The following code demonstrates how to determine if your app is running on an iPad Mini:</p><div class="informalexample"><pre class="programlisting">exports.iPadMiniNonRetina= (function() {</pre></div><p>Now perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First check if the recipe is running on a nonretina iPad.<div class="informalexample"><pre class="programlisting">  if((exports.osname !== 'ipad')||
  (exports.osname === 'ipad' &amp;&amp;
  exports.densitylevel==='high')){
    return false;
  }</pre></div></li><li class="listitem">Next verify if the nonretina iPad is not an iPad 1 or iPad 2. If not either of these modules, assume the recipe is running on an iPad Mini.<div class="informalexample"><pre class="programlisting">  var modelToCompare = exports.deviceModel.toLowerCase();
  return !(
    (modelToCompare==="ipad1,1")||
    (modelToCompare==="ipad2,1")||
    (modelToCompare==="ipad2,2")||
    (modelToCompare==="ipad2,3")||	
    (modelToCompare==="ipad2,4")		
  );
})();</pre></div></li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note08"/>Note</h3><p>Apple currently does not provide a platform indicator for the iPad Mini. This check uses model numbers and might not be future proof.</p></div></div></div></div></div></div>
<div class="section" title="Global logging using Ti.App.Listener"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec12"/>Global logging using Ti.App.Listener</h1></div></div></div><p>There is built-in ability of <a id="id69" class="indexterm"/>Titanium to fire and listen to application wide events. This powerful feature can be a perfect fit for creating<a id="id70" class="indexterm"/> loosely-coupled components. This pattern can provide a decoupled logging approach, which is helpful for specific situations such as analytics, logging, and process monitoring modules.</p><p>This recipe details how <code class="literal">Ti.App.Listener</code> can be used to create a decoupled re-useable application component. The following screenshot demonstrates this recipe running on both the iPhone and Android platforms:</p><div class="mediaobject"><img src="graphics/5343OT_01_05.jpg" alt="Global logging using Ti.App.Listener"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec18"/>Getting ready</h2></div></div></div><p>Adding the CommonJS <a id="id71" class="indexterm"/>modules used in<a id="id72" class="indexterm"/> this recipe is straightforward and consists of copying the <code class="literal">logger.js</code> and <code class="literal">mainWin.js</code> files into the root of our Titanium project as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5343OT_01_06.jpg" alt="Getting ready"/></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec19"/>How to do it...</h2></div></div></div><p>Application-level events allow you to implement a publish/subscribe pattern globally in your app, even across<a id="id73" class="indexterm"/> execution contexts. By simply adding a listener such as the following, you can receive messages fired from anywhere in your app:</p><div class="informalexample"><pre class="programlisting">Ti.App.addEventListener('app:myEvent', myFunctionToHandleThisEvent);</pre></div><p>Firing a custom event in Titanium is easy. You simply use the <code class="literal">Ti.App.fireEvent</code> and provide the event name and an optional parameter payload. This example shows how to call the <code class="literal">app:myEvent</code> listener we defined earlier.</p><div class="informalexample"><pre class="programlisting">Ti.App.fireEvent('app:myEvent',"My parameter objects");</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip03"/>Tip</h3><p>It is recommended that you name your events using a descriptive convention. For example, <code class="literal">app:myEvent</code> describes that this is an application event and is defined in my <code class="literal">app.js</code> file.</p></div></div><div class="section" title="Designing global logging using events"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec12"/>Designing global logging using events</h3></div></div></div><p>The following recipes<a id="id74" class="indexterm"/> show how to use application-level custom events to implement logging across the different contexts of our app.</p><div class="section" title="Defining our app.js"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl4sec05"/>Defining our app.js</h4></div></div></div><p>In the <code class="literal">app.js</code>, we define<a id="id75" class="indexterm"/> our application namespace and import the logger and UI CommonJS modules.</p><div class="informalexample"><pre class="programlisting">//Create our application namespace
var my = {
  ui:{
    mainWindow : require('mainWin').createWindow()
  },
  logger : require('logger')
};</pre></div><p>Next in our <code class="literal">app.js</code>, the <code class="literal">setup</code> method is called on the <code class="literal">logger</code> module. This ensures our database logging tables are created.</p><div class="informalexample"><pre class="programlisting">//Run setup to create our logging db
my.logger.setup();</pre></div><p>The application-level listener is then defined in our <code class="literal">app.js</code>. This listener will wait for the <code class="literal">app:log</code> event to be fired and then call the logger's <code class="literal">add</code> method with the payload provided.</p><div class="informalexample"><pre class="programlisting">//Add a global event to listen for log messages
<span class="strong"><strong>Ti.App.addEventListener('app:log',function(e){</strong></span>
<span class="strong"><strong>  //Provide Log Message to CommonJS Logging Component</strong></span>
<span class="strong"><strong>  my.logger.add(e);</strong></span>
<span class="strong"><strong>});</strong></span>

//Open our sample window
my.ui.mainWindow.open();</pre></div></div><div class="section" title="The logging module"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl4sec06"/>The logging module</h4></div></div></div><p>The following code<a id="id76" class="indexterm"/> snippet demonstrates how to create the basic CommonJS module, <code class="literal">logger.js</code>, used in our global listener recipe. This module has two methods; <code class="literal">setup</code>, which creates our database objects, and <code class="literal">add</code>, which the listener calls to log our messages.</p><p>Create a constant with the logging database name.</p><div class="informalexample"><pre class="programlisting">var LOG_DB_NAME = "my_log_db";</pre></div><p>Create the <code class="literal">setup</code> module-level method. This is used to create the <code class="literal">LOG_HISTORY</code> table, which will later be used to record all log statements.</p><div class="informalexample"><pre class="programlisting">exports.setup=function(){
  var createSQL = 'CREATE TABLE IF NOT EXISTS LOG_HISTORY '; 
  createSQL +='(LOG_NAME TEXT, LOG_MESSAGE TEXT, ';
  createSQL += 'LOG_DATE DATE)';
  //Install the db if needed
  var db = Ti.Database.open(LOG_DB_NAME);
  //Create our logging table if needed
  db.execute(createSQL);
  //Close the db
  db.close();
};</pre></div><p>Create the <code class="literal">add</code> <a id="id77" class="indexterm"/>module-level method. This method is used to record the information to be added to the log table.</p><div class="informalexample"><pre class="programlisting">exports.add=function(logInfo){
  var insertSQL ="INSERT INTO LOG_HISTORY ";
  insertSQL +=" (LOG_NAME,LOG_MESSAGE,LOG_DATE)"; 
  insertSQL +=" "VALUES(?,?,?)";
  var db = Ti.Database.open(LOG_DB_NAME);
  //Create our logging table if needed
  db.execute(insertSQL,logInfo.name,logInfo.message, 
  new Date());
  //Close the db
  db.close();
};</pre></div></div></div><div class="section" title="Bringing it all together"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec13"/>Bringing it all together</h3></div></div></div><p>The following sections show the contents of our <code class="literal">mainWin.js</code> module<a id="id78" class="indexterm"/>. This module returns a window with a single button that when pressed fires our logging event.</p><div class="section" title="Window and module variable setup"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl4sec07"/>Window and module variable setup</h4></div></div></div><p>The <code class="literal">fetchWindow</code> function<a id="id79" class="indexterm"/> returns a simple window demonstrating how to fire an application-level event. To demonstrate, a new message is sent each time, and we add a module level variable named <code class="literal">_press_Count</code>, which increments with each click.</p><p>Create the module-level variable <code class="literal">_press_Count</code> to record the number of times <code class="literal">addLogButton</code> has been pressed.</p><div class="informalexample"><pre class="programlisting">var _press_Count = 0;</pre></div><p>The <code class="literal">fetchWindow</code> method returns a <code class="literal">Ti.UI.Window</code> containing the UI elements for this recipe.</p><div class="informalexample"><pre class="programlisting">exports.fetchWindow=function(){</pre></div><p>A <code class="literal">Ti.UI.Window</code> is created for all of our UI elements to be attached.</p><div class="informalexample"><pre class="programlisting">  var win = Ti.UI.createWindow({
    backgroundColor:'#fff'
  });</pre></div><p>The <code class="literal">addLogButton Ti.UI.Button</code> is created. This button will be used to trigger the <code class="literal">Ti.App.fireEvent</code> used to demonstrate global listeners in this recipe.</p><div class="informalexample"><pre class="programlisting">  var addLogButton = Ti.UI.createButton({
    title:"Fire Log Event", top:180, 
    left:5,right:5, height:50
  });</pre></div></div><div class="section" title="Firing the application-level event"><div class="titlepage"><div><div><h4 class="title"><a id="ch01lvl4sec08"/>Firing the application-level event</h4></div></div></div><p>On clicking on the <code class="literal">addLogButton</code> button, the <code class="literal">_press_Count</code> variable is increased by one and a logging object is created.<a id="id80" class="indexterm"/> The following code demonstrates how the <code class="literal">Ti.App.fireEvent</code> method is called for the <code class="literal">app:log</code> event and a JavaScript object containing our logging details is provided. The listener we defined in our <code class="literal">app.js</code> will then receive this message and log our results.</p><div class="informalexample"><pre class="programlisting">  addLogButton.addEventListener('click',function(e){		</pre></div><p>The first action taken after the user taps the <code class="literal">addLogButton</code> is to increase the <code class="literal">_pressCount</code> by one.</p><div class="informalexample"><pre class="programlisting">    _press_Count ++;</pre></div><p>Next the <code class="literal">logObject</code> containing information to be submitted for logging is created.</p><div class="informalexample"><pre class="programlisting">    var logObject = {
      name:'test log',
      message:'example message ' + 
      _press_Count
    };</pre></div><p>Finally, the <code class="literal">Ti.App.fireEvent</code> is called for the <code class="literal">app:log</code> event. The <code class="literal">logObject</code> is also provided as a parameter when calling this application global event.</p><div class="informalexample"><pre class="programlisting">    Ti.App.fireEvent('app:log',logObject);
  });    
  win.add(addLogButton);
    
  //Return window
  return win;
};</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note09"/>Note</h3><p>App logging is just one of the many examples of how you can use application-level events to decouple your app's components. This pattern will be used several times over the course of this book when decoupled component interaction is required.</p></div></div></div></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec20"/>There's more...</h2></div></div></div><p>Since application-level listeners are globally scoped, you need to take caution where and when they are defined. A general rule of thumb is to define application-level listeners in an area of your app that is always available and never reloaded, such as your <code class="literal">app.js</code>, CommonJS file which is only loaded once, or another bootstrapping method.</p><p>If you must define them within a window or other module that is loaded repeatedly, make sure you remove the listener when the object is no longer needed. To remove the event listener, you need to call the <code class="literal">Ti.App.removeEventListener</code> method<a id="id81" class="indexterm"/> with the same arguments used on creation. The following snippet shows how to remove the <code class="literal">app:myEvent</code> listener created earlier:</p><div class="informalexample"><pre class="programlisting">Ti.App.removeEventListener('app:myEvent', myFunctionToHandleThisEvent);</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip04"/>Tip</h3><p>If you do not remove a listener, all associated JavaScript objects will not be eligible for garbage collection, often resulting in a memory leak.</p></div></div></div></div></body></html>