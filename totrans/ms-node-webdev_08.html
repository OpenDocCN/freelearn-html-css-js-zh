<html><head></head><body>
<div class="calibre1" id="_idContainer111">
<h1 class="chapternumber"><span class="kobospan" id="kobo.1.1">8</span></h1>
<h1 class="chaptertitle" id="_idParaDest-147"><span class="kobospan" id="kobo.2.1">Unit Testing and Debugging</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.3.1">In this chapter, I describe the features that Node.js provides for testing and debugging JavaScript code. </span><span class="kobospan" id="kobo.3.2">I begin by demonstrating the Node.js integrated test runner, which makes it easy to define and execute unit tests. </span><span class="kobospan" id="kobo.3.3">I continue by demonstrating the Node.js debugger, which is integrated into the JavaScript runtime but used through external tools. </span><em class="italic"><span class="kobospan" id="kobo.4.1">Table 8.1</span></em><span class="kobospan" id="kobo.5.1"> puts testing and debugging in context.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.6.1">Table 8.1: Putting testing and debugging in context</span></p>
<table class="table-container" id="table001-5">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.7.1">Question</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.8.1">Answer</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.9.1">What is it?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.10.1">Unit testing</span><a id="_idIndexMarker407" class="calibre3"/><span class="kobospan" id="kobo.11.1"> is the process of defining and running tests that check the behavior of code. </span><span class="kobospan" id="kobo.11.2">Debugging</span><a id="_idIndexMarker408" class="calibre3"/><span class="kobospan4" id="kobo.12.1"> is the process of inspecting the state of the application as it is executed to determine the cause of unexpected or undesirable behavior. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.13.1">Why is it useful?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.14.1">Testing and debugging help identify problems in code before applications are deployed to real users. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.15.1">How is it used?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.16.1">Unit tests</span><a id="_idIndexMarker409" class="calibre3"/><span class="kobospan" id="kobo.17.1"> are written in JavaScript code and executed using the integrated Node.js test runner. </span><span class="kobospan4" id="kobo.17.2">The Node.js runtime includes support for debugging, which is used through external tools, including popular code editors.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.18.1">Are there any pitfalls or limitations?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.19.1">Differing views on how code should be tested often cause tension in development teams. </span><span class="kobospan4" id="kobo.19.2">Effort that could be spent completing the project is too often spent arguing about testing.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.20.1">Are there any alternatives?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.21.1">Testing and debugging are both optional activities. </span><span class="kobospan4" id="kobo.21.2">Both can help produce code with fewer defects, but neither is compulsory.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.22.1">Table 8.2</span></em><span class="kobospan" id="kobo.23.1"> summarizes the chapter.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.24.1">Table 8.2: Chapter Summary</span></p>
<table class="table-container" id="table002-5">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.25.1">Problem</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.26.1">Solution</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.27.1">Listing</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.28.1">Create a unit test </span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.29.1">Create a file with the </span><code class="inlinecode"><span class="kobospan2" id="kobo.30.1">test.js</span></code><span class="kobospan" id="kobo.31.1"> suffix and use the </span><code class="inlinecode"><span class="kobospan2" id="kobo.32.1">test</span></code><span class="kobospan" id="kobo.33.1"> function defined in the </span><code class="inlinecode"><span class="kobospan2" id="kobo.34.1">node:test</span></code><span class="kobospan4" id="kobo.35.1"> module.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.36.1">3</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.37.1">Run unit tests </span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.38.1">Use the </span><code class="inlinecode"><span class="kobospan2" id="kobo.39.1">--test</span></code><span class="kobospan" id="kobo.40.1"> argument to start Node.js in test mode. </span><span class="kobospan" id="kobo.40.2">Use the </span><code class="inlinecode"><span class="kobospan2" id="kobo.41.1">--watch</span></code><span class="kobospan4" id="kobo.42.1"> argument to run tests automatically when a change is detected.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.43.1">4-8</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.44.1">Create mocks</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.45.1">Use the </span><code class="inlinecode"><span class="kobospan2" id="kobo.46.1">fn</span></code><span class="kobospan" id="kobo.47.1">, </span><code class="inlinecode"><span class="kobospan2" id="kobo.48.1">method</span></code><span class="kobospan" id="kobo.49.1">, </span><code class="inlinecode"><span class="kobospan2" id="kobo.50.1">getter</span></code><span class="kobospan" id="kobo.51.1">, or </span><code class="inlinecode"><span class="kobospan2" id="kobo.52.1">setter</span></code><span class="kobospan4" id="kobo.53.1"> methods.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.54.1">9-10</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.55.1">Understand how mocks are used</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.56.1">Use the spy features added to mocks.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.57.1">11</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.58.1">Check the outcome of a test</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.59.1">Use the assertion functions in the </span><code class="inlinecode"><span class="kobospan2" id="kobo.60.1">assert</span></code><span class="kobospan4" id="kobo.61.1"> module.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.62.1">12</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.63.1">Test asynchronous code</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.64.1">Create asynchronous mocks that produce test data.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.65.1">13-16</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.66.1">Testing different outcomes</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.67.1">Use subtests.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.68.1">17</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.69.1">Trigger the debugger</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.70.1">Use the </span><code class="inlinecode"><span class="kobospan2" id="kobo.71.1">debugger</span></code><span class="kobospan4" id="kobo.72.1"> keyword or set breakpoints in the code editor.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.73.1">18-20</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.74.1">Debug an application </span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.75.1">Use the features provided by popular code editors or browsers.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.76.1">21-22</span></em></p>
</td>
</tr>
</tbody>
</table>
<h1 class="heading" id="_idParaDest-148"><span class="kobospan" id="kobo.77.1">Preparing for this chapter</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.78.1">In this chapter, I continue to use the </span><code class="inlinecode"><span class="kobospan" id="kobo.79.1">webapp</span></code><span class="kobospan" id="kobo.80.1"> project from </span><em class="italic"><span class="kobospan" id="kobo.81.1">Chapter 7</span></em><span class="kobospan" id="kobo.82.1">. </span><span class="kobospan" id="kobo.82.2">No changes are required to prepare for this chapter. </span><span class="kobospan" id="kobo.82.3">Open a command prompt, navigate to the </span><code class="inlinecode"><span class="kobospan" id="kobo.83.1">webapp</span></code><span class="kobospan" id="kobo.84.1"> folder, and run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.85.1">Listing 8.1</span></em><span class="kobospan" id="kobo.86.1"> to start the build tools.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.87.1">Listing 8.1: Starting the build tools</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.88.1">npm start
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.89.1">Open a web browser, request </span><code class="inlinecode"><span class="kobospan" id="kobo.90.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.91.1">, enter a message into the text field, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.92.1">Send Message</span></strong><span class="kobospan" id="kobo.93.1"> button. </span><span class="kobospan" id="kobo.93.2">The client-side JavaScript code will send the contents of the </span><code class="inlinecode"><span class="kobospan" id="kobo.94.1">input</span></code><span class="kobospan" id="kobo.95.1"> element to the backend server, which will pipe it back to the browser in the response, as shown in </span><em class="italic"><span class="kobospan" id="kobo.96.1">Figure 8.1</span></em><span class="kobospan" id="kobo.97.1">.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.98.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.99.1">You can download the example project for this chapter – and for all the other chapters in this book – from </span><a href="https://github.com/PacktPublishing/Mastering-Node.js-Web-Development" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.100.1">https://github.com/PacktPublishing/Mastering-Node.js-Web-Development</span></span></a><span class="kobospan" id="kobo.101.1">. </span><span class="kobospan" id="kobo.101.2">See </span><em class="italic"><span class="kobospan" id="kobo.102.1">Chapter 1</span></em><span class="kobospan" id="kobo.103.1"> for how to get help if you have problems running the examples.</span></p>
</div>
<figure class="mediaobject"><span class="kobospan" id="kobo.104.1"><img alt="" src="../Images/B21959_08_01.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.105.1">Figure 8.1: Running the example application</span></p>
<h1 class="heading" id="_idParaDest-149"><span class="kobospan" id="kobo.106.1">Unit testing Node.js applications</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.107.1">Node.js</span><a id="_idIndexMarker410" class="calibre3"/><span class="kobospan" id="kobo.108.1"> has a built-in test runner, which is a convenient </span><a id="_idIndexMarker411" class="calibre3"/><span class="kobospan" id="kobo.109.1">way to define and run unit tests. </span><span class="kobospan" id="kobo.109.2">As much as I recommend TypeScript for development, unit tests are best written in pure JavaScript. </span><span class="kobospan" id="kobo.109.3">Unit testing requires extensive use of fake objects – known as </span><em class="italic"><span class="kobospan" id="kobo.110.1">mocks</span></em><span class="kobospan" id="kobo.111.1"> – to isolate the code being tested from the rest of the application, and the process of creating mocks – known as </span><em class="italic"><span class="kobospan" id="kobo.112.1">mocking</span></em><span class="kobospan" id="kobo.113.1"> – relies on creating objects that have just enough functionality to run a test, which can upset the TypeScript compiler. </span><span class="kobospan" id="kobo.113.2">To prepare for pure JavaScript unit tests, </span><em class="italic"><span class="kobospan" id="kobo.114.1">Listing 8.2</span></em><span class="kobospan" id="kobo.115.1"> changes the configuration for the TypeScript compiler. </span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.116.1">Deciding Whether to Unit Test</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.117.1">Being able to easily perform unit testing is one of the benefits of using Node.js, but it isn’t for everyone, and I have no intention of pretending otherwise. </span><span class="kobospan" id="kobo.117.2">I like unit testing, and I use it in my projects, but not all of them, and not as consistently as you might expect. </span><span class="kobospan" id="kobo.117.3">I tend to focus on writing unit tests for features and functions that I know will be hard to write and likely will be the source of bugs in deployment. </span><span class="kobospan" id="kobo.117.4">In these situations, unit testing helps structure my thoughts about how to best implement what I need. </span><span class="kobospan" id="kobo.117.5">I find that just thinking about what I need to test helps produce ideas about potential problems, and that’s before I start dealing with actual bugs and defects.</span><span> </span></p>
<p class="normal"><span class="kobospan" id="kobo.118.1">That said, unit testing is a tool and not a religion, and only you know how much testing you require. </span><span class="kobospan" id="kobo.118.2">If you don’t find unit testing useful or you have a different methodology that suits you better, then don’t feel you need to unit test just because it is fashionable. </span><span class="kobospan" id="kobo.118.3">(However, if you don’t have a better methodology and you are not testing at all, then you are probably letting users find your bugs, which is rarely ideal. </span><span class="kobospan" id="kobo.118.4">You don’t have to unit test, but you really should consider doing some testing of some kind.)</span></p>
<p class="normal"><span class="kobospan" id="kobo.119.1">If you have not encountered unit testing before, then I encourage you to give it a try to see how it works. </span><span class="kobospan" id="kobo.119.2">If you are not a fan of unit testing, then you can skip this section and move on to the </span><em class="italic"><span class="kobospan" id="kobo.120.1">Debugging JavaScript code</span></em><span class="kobospan" id="kobo.121.1"> section, where I demonstrate how to use the Node.js debugging features.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.122.1">Listing 8.2: Adding properties in the tsconfig.Json file in the webapp folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.123.1">{
    "extends": "@tsconfig/node20/tsconfig.json",
     "compilerOptions": {                      
         "rootDir": "src",  
         "outDir": "dist",
        </span><strong class="screentext"><span class="kobospan" id="kobo.124.1"> "allowJs": true</span></strong><span class="kobospan" id="kobo.125.1">
     },
     </span><strong class="screentext"><span class="kobospan" id="kobo.126.1">"include": ["src/**/*"]</span></strong><span class="kobospan" id="kobo.127.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.128.1">The new </span><a id="_idIndexMarker412" class="calibre3"/><span class="kobospan" id="kobo.129.1">configuration properties tell the TypeScript compiler to</span><a id="_idIndexMarker413" class="calibre3"/><span class="kobospan" id="kobo.130.1"> process JavaScript as well as TypeScript files and specify that all of the source code files are in the </span><code class="inlinecode"><span class="kobospan" id="kobo.131.1">src</span></code><span class="kobospan" id="kobo.132.1"> folder. </span></p>
<p class="normal"><span class="kobospan" id="kobo.133.1">To get </span><a id="_idIndexMarker414" class="calibre3"/><span class="kobospan" id="kobo.134.1">started with</span><a id="_idIndexMarker415" class="calibre3"/><span class="kobospan" id="kobo.135.1"> testing, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.136.1">readHandler.test.js</span></code><span class="kobospan" id="kobo.137.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.138.1">src</span></code><span class="kobospan" id="kobo.139.1"> folder with the contents shown in </span><em class="italic"><span class="kobospan" id="kobo.140.1">Listing 8.3</span></em><span class="kobospan" id="kobo.141.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.142.1">Listing 8.3: The contents of the readHandler.test.js file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.143.1">import { test } from "node:test";
test("my first test", () =&gt; {
    // do nothing - test will pass
});
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.144.1">The testing functionality is provided in the </span><code class="inlinecode"><span class="kobospan" id="kobo.145.1">node:test</span></code><span class="kobospan" id="kobo.146.1"> module, and the most important function is </span><code class="inlinecode"><span class="kobospan" id="kobo.147.1">test</span></code><span class="kobospan" id="kobo.148.1">, which is used to define a unit test. </span><span class="kobospan" id="kobo.148.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.149.1">test</span></code><span class="kobospan" id="kobo.150.1"> function accepts a name for the test and a function, which is executed to perform the test.</span></p>
<p class="normal"><span class="kobospan" id="kobo.151.1">Tests can be executed from the command line. </span><span class="kobospan" id="kobo.151.2">Open a new command prompt and run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.152.1">Listing 8.4</span></em><span class="kobospan" id="kobo.153.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.154.1">webapp</span></code><span class="kobospan" id="kobo.155.1"> folder.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.156.1">Listing 8.4: Running unit tests</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.157.1">node --test dist
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.158.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.159.1">--test</span></code><span class="kobospan" id="kobo.160.1"> argument executes the Node.js test runner. </span><span class="kobospan" id="kobo.160.2">Test files are discovered automatically, either because the filename contains </span><code class="inlinecode"><span class="kobospan" id="kobo.161.1">test</span></code><span class="kobospan" id="kobo.162.1"> or because files are in a folder named </span><code class="inlinecode"><span class="kobospan" id="kobo.163.1">test</span></code><span class="kobospan" id="kobo.164.1">. </span><span class="kobospan" id="kobo.164.2">I followed the common convention of defining the tests for a module in a file that shares the module’s name but with the</span><code class="inlinecode"><span class="kobospan" id="kobo.165.1">.test.js</span></code><span class="kobospan" id="kobo.166.1"> suffix.</span></p>
<p class="normal"><span class="kobospan" id="kobo.167.1">The TypeScript compiler will process the JavaScript file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.168.1">src</span></code><span class="kobospan" id="kobo.169.1"> folder and generate a file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.170.1">dist</span></code><span class="kobospan" id="kobo.171.1"> folder that contains the test code. </span><span class="kobospan" id="kobo.171.2">The test runner will produce the following output, which may include additional characters, such as checkmarks, depending on your platform and command line:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.172.1">...
</span><span class="kobospan" id="kobo.172.2">my first test (0.5989ms)
tests 1
suites 0
pass 1
fail 0
cancelled 0
skipped 0
todo 0
duration_ms 51.685
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.173.1">The </span><a id="_idIndexMarker416" class="calibre3"/><span class="kobospan" id="kobo.174.1">test doesn’t do anything yet, but the output shows </span><a id="_idIndexMarker417" class="calibre3"/><span class="kobospan" id="kobo.175.1">the test runner has found the file and executed the function it contains.</span></p>
<p class="normal"><span class="kobospan" id="kobo.176.1">The test runner can also be run in watch mode, where it will run tests automatically when there is a file change. </span><em class="italic"><span class="kobospan" id="kobo.177.1">Listing 8.5</span></em><span class="kobospan" id="kobo.178.1"> adds a new command to the </span><code class="inlinecode"><span class="kobospan" id="kobo.179.1">scripts</span></code><span class="kobospan" id="kobo.180.1"> section of the </span><code class="inlinecode"><span class="kobospan" id="kobo.181.1">package.json</span></code><span class="kobospan" id="kobo.182.1"> file.</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.183.1">Using a Test Package</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.184.1">I have used the built-in Node.js test runner in this chapter because it is simple to use and does everything that most projects require. </span><span class="kobospan" id="kobo.184.2">But there are good open-source test packages available; the most popular is</span><a id="_idIndexMarker418" class="calibre3"/><span class="kobospan" id="kobo.185.1"> Jest (</span><a href="https://jestjs.io" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.186.1">https://jestjs.io</span></span></a><span class="kobospan" id="kobo.187.1">). </span><span class="kobospan" id="kobo.187.2">A testing package can be useful if you have specialized testing needs or want to use the same package for testing the client- and server-side JavaScript code in your projects. </span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.188.1">Listing 8.5: Adding a command in the package.json file in the webapp folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.189.1">...
</span><span class="kobospan" id="kobo.189.2">"scripts": {
    "server": "tsc-watch --noClear --onsuccess \"node dist/server.js\"",
    "client": "webpack serve",
    "start": "npm-run-all --parallel server client",
    </span><strong class="screentext"><span class="kobospan" id="kobo.190.1">"test": "node --test --watch dist"</span></strong><span class="kobospan" id="kobo.191.1">
},
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.192.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.193.1">--watch</span></code><span class="kobospan" id="kobo.194.1"> argument puts the test runner into watch mode. </span><span class="kobospan" id="kobo.194.2">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.195.1">Listing 8.6</span></em><span class="kobospan" id="kobo.196.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.197.1">webapp</span></code><span class="kobospan" id="kobo.198.1"> folder to start the command defined in </span><em class="italic"><span class="kobospan" id="kobo.199.1">Listing 8.5</span></em><span class="kobospan" id="kobo.200.1">.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.201.1">Listing 8.6: Running the Test Runner in Watch Mode</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.202.1">npm run test
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.203.1">The </span><a id="_idIndexMarker419" class="calibre3"/><span class="kobospan" id="kobo.204.1">test runner will start, discover the test file in</span><a id="_idIndexMarker420" class="calibre3"/><span class="kobospan" id="kobo.205.1"> the </span><code class="inlinecode"><span class="kobospan" id="kobo.206.1">dist</span></code><span class="kobospan" id="kobo.207.1"> file, and run the test it contains, producing the following output:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.208.1">...
</span><span class="kobospan" id="kobo.208.2">my first test (</span><span class="hljs-number"><span class="kobospan" id="kobo.209.1">0.</span></span><span class="kobospan" id="kobo.210.1">5732ms)
...
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.211.1">Listing 8.7</span></em><span class="kobospan" id="kobo.212.1"> changes the name given to the test to confirm the test watch mode is working.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.213.1">Listing 8.7: Changing the name in the readHandler.test.js file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.214.1">import { test } from "node:test";
</span><strong class="screentext"><span class="kobospan" id="kobo.215.1">test("my new test name", () =&gt; {</span></strong><span class="kobospan" id="kobo.216.1">
    // do nothing - test will pass
});
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.217.1">The main build process will detect the change to the JavaScript file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.218.1">src</span></code><span class="kobospan" id="kobo.219.1"> folder and create a corresponding file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.220.1">dist</span></code><span class="kobospan" id="kobo.221.1"> folder. </span><span class="kobospan" id="kobo.221.2">The Node.js test runner will detect the change to the pure JavaScript file and execute its contents, producing the following output:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.222.1">...
</span><span class="kobospan" id="kobo.222.2">my first test (0.5732ms)
</span><strong class="screentext"><span class="kobospan" id="kobo.223.1">my new test name (0.6408ms)</span></strong><span class="kobospan" id="kobo.224.1">
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.225.1">The Node.js test runner considers tests to have passed if they complete without throwing an exception, which is why the test passes, even though it doesn’t do anything. </span><em class="italic"><span class="kobospan" id="kobo.226.1">Listing 8.8</span></em><span class="kobospan" id="kobo.227.1"> modifies the sample test so that it fails.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.228.1">Listing 8.8: Creating a failing test in the readHandler.test.js file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.229.1">import { test } from "node:test";
test("my new test name", () =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.230.1">throw new Error("something went wrong");</span></strong><span class="kobospan" id="kobo.231.1">
});
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.232.1">When the </span><a id="_idIndexMarker421" class="calibre3"/><span class="kobospan" id="kobo.233.1">test runner executes the test, the exception is </span><a id="_idIndexMarker422" class="calibre3"/><span class="kobospan" id="kobo.234.1">thrown and the failure is displayed in the console output, along with some details about the exception:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.235.1">...
</span><span class="kobospan" id="kobo.235.2">my first test (0.5732ms)
my new test name (0.6408ms)
</span><strong class="screentext"><span class="kobospan" id="kobo.236.1">my new test name (0.6288ms)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.237.1">  Error: something went wrong</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.238.1">      at TestContext.&lt;anonymous&gt; (C:\webapp\dist\readHandler.test.js:6:11)</span></strong><span class="kobospan" id="kobo.239.1">
...
</span></code></pre>
<h2 class="heading1" id="_idParaDest-150"><span class="kobospan" id="kobo.240.1">Writing unit tests</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.241.1">A common approach to writing unit tests is to follow the </span><strong class="screentext"><span class="kobospan" id="kobo.242.1">arrange/act/assert</span></strong><span class="kobospan" id="kobo.243.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.244.1">A/A/A</span></strong><span class="kobospan" id="kobo.245.1">) pattern, which </span><a id="_idIndexMarker423" class="calibre3"/><span class="kobospan" id="kobo.246.1">breaks unit tests into three parts. </span><em class="italic"><span class="kobospan" id="kobo.247.1">Arrange</span></em><span class="kobospan" id="kobo.248.1"> refers to setting up the conditions for the test, </span><em class="italic"><span class="kobospan" id="kobo.249.1">act</span></em><span class="kobospan" id="kobo.250.1"> refers to performing the</span><a id="_idIndexMarker424" class="calibre3"/><span class="kobospan" id="kobo.251.1"> test, and </span><em class="italic"><span class="kobospan" id="kobo.252.1">assert</span></em><span class="kobospan" id="kobo.253.1"> refers to verifying that the result was the one that was expected.</span></p>
<h3 class="heading2" id="_idParaDest-151"><span class="kobospan" id="kobo.254.1">Arranging a test</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.255.1">For web </span><a id="_idIndexMarker425" class="calibre3"/><span class="kobospan" id="kobo.256.1">applications, the arrange section of a unit test usually means simulating an HTTP request and response to be able to test a request handler. </span><span class="kobospan" id="kobo.256.2">As a reminder, here is the </span><code class="inlinecode"><span class="kobospan" id="kobo.257.1">readHandler</span></code><span class="kobospan" id="kobo.258.1"> from the example project: </span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.259.1">import { Request, Response } from "express";
export const readHandler = (req: Request, resp: Response) =&gt; {   
    resp.cookie("sessionID", "mysecretcode");
    req.pipe(resp);
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.260.1">This handler does two things: sets a cookie and invokes the </span><code class="inlinecode"><span class="kobospan" id="kobo.261.1">Request.pipe</span></code><span class="kobospan" id="kobo.262.1"> method so that the body of the response is read from the body of the request. </span><span class="kobospan" id="kobo.262.2">To test this functionality, the unit test needs a mock </span><code class="inlinecode"><span class="kobospan" id="kobo.263.1">Request</span></code><span class="kobospan" id="kobo.264.1"> that has a </span><code class="inlinecode"><span class="kobospan" id="kobo.265.1">pipe</span></code><span class="kobospan" id="kobo.266.1"> method and a </span><code class="inlinecode"><span class="kobospan" id="kobo.267.1">Response</span></code><span class="kobospan" id="kobo.268.1"> that has a </span><code class="inlinecode"><span class="kobospan" id="kobo.269.1">cookie</span></code><span class="kobospan" id="kobo.270.1"> method. </span><span class="kobospan" id="kobo.270.2">The unit test doesn’t need to recreate the real functionality of the </span><code class="inlinecode"><span class="kobospan" id="kobo.271.1">pipe</span></code><span class="kobospan" id="kobo.272.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.273.1">cookie</span></code><span class="kobospan" id="kobo.274.1"> methods because these are outside the scope of the code being tested. </span><em class="italic"><span class="kobospan" id="kobo.275.1">Listing 8.9</span></em><span class="kobospan" id="kobo.276.1"> uses the features provided by Node.js to create </span><a id="_idIndexMarker426" class="calibre3"/><span class="kobospan" id="kobo.277.1">mock objects.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.278.1">Listing 8.9: Creating mock HTTP objects in the readHandler.test.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.279.1">import { test } from "node:test";
</span><strong class="screentext"><span class="kobospan" id="kobo.280.1">test("readHandler tests", (testCtx) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.281.1">    // Arrange - set up the test</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.282.1">    const req = {</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.283.1">pipe: testCtx.mock.fn()</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.284.1">    };</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.285.1">    const resp = {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.286.1">        cookie: testCtx.mock.fn()</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.287.1">    };</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.288.1">    // TODO - Act - perform the test</span></strong>
<strong class="screentext"> </strong>
<strong class="screentext"><span class="kobospan" id="kobo.289.1">    // TODO - Assert - verify the results</span></strong><span class="kobospan" id="kobo.290.1">
});
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.291.1">A good mock object contains just enough functionality to run the test but also has to support inspecting the outcome. </span><span class="kobospan" id="kobo.291.2">When the Node.js test runner invokes the test function, it provides a </span><code class="inlinecode"><span class="kobospan" id="kobo.292.1">TestContext</span></code><span class="kobospan" id="kobo.293.1"> object, whose </span><code class="inlinecode"><span class="kobospan" id="kobo.294.1">mock</span></code><span class="kobospan" id="kobo.295.1"> property returns a </span><code class="inlinecode"><span class="kobospan" id="kobo.296.1">MockTracker</span></code><span class="kobospan" id="kobo.297.1"> object that can be used to create mocks, and whose most useful methods are described in </span><em class="italic"><span class="kobospan" id="kobo.298.1">Table 8.3</span></em><span class="kobospan" id="kobo.299.1">.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.300.1">Table 8.3: Useful MockTracker Methods </span></p>
<table class="table-container" id="table003-5">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.301.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.302.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.303.1">fn(orig, impl)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.304.1">This method creates a mock function. </span><span class="kobospan" id="kobo.304.2">The optional arguments are the original implementation of the function and a new implementation. </span><span class="kobospan" id="kobo.304.3">If the arguments are omitted, a </span><code class="inlinecode"><span class="kobospan2" id="kobo.305.1">no-op</span></code><span class="kobospan4" id="kobo.306.1"> function is returned.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.307.1">method(obj, name, impl, opts) </span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.308.1">This method creates a mock method. </span><span class="kobospan" id="kobo.308.2">The arguments are an object and the method name to mock. </span><span class="kobospan4" id="kobo.308.3">The optional argument is a replacement implementation of the method.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.309.1">getter(obj, name, impl, opts)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.310.1">Similar to </span><code class="inlinecode"><span class="kobospan2" id="kobo.311.1">method</span></code><span class="kobospan4" id="kobo.312.1"> but creates a getter.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.313.1">setter(obj, name, impl, opts)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.314.1">Similar to </span><code class="inlinecode"><span class="kobospan2" id="kobo.315.1">method</span></code><span class="kobospan4" id="kobo.316.1"> but creates a setter.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.317.1">The methods </span><a id="_idIndexMarker427" class="calibre3"/><span class="kobospan" id="kobo.318.1">described in </span><em class="italic"><span class="kobospan" id="kobo.319.1">Table 8.3</span></em><span class="kobospan" id="kobo.320.1"> are used to create functions or methods that keep track of how they are used, which is useful in the assert part of the test, described in the </span><em class="italic"><span class="kobospan" id="kobo.321.1">Asserting test results</span></em><span class="kobospan" id="kobo.322.1"> section.</span></p>
<p class="normal"><span class="kobospan" id="kobo.323.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.324.1">method</span></code><span class="kobospan" id="kobo.325.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.326.1">getter</span></code><span class="kobospan" id="kobo.327.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.328.1">setter</span></code><span class="kobospan" id="kobo.329.1"> methods can create wrappers around existing functionality, as demonstrated in the </span><em class="italic"><span class="kobospan" id="kobo.330.1">Testing asynchronous code</span></em><span class="kobospan" id="kobo.331.1"> section. </span><span class="kobospan" id="kobo.331.2">It is difficult to wrap the HTTP request and response methods and properties because of the way they are created and their dependency on so much of the Node.js API. </span><span class="kobospan" id="kobo.331.3">Instead, the </span><code class="inlinecode"><span class="kobospan" id="kobo.332.1">fn</span></code><span class="kobospan" id="kobo.333.1"> method can be used to create a function that tracks how it is used and provides a simple building block to create the features needed to test the handler. </span><span class="kobospan" id="kobo.333.2">JavaScript functions can accept any number of arguments, which is how the function returned from the </span><code class="inlinecode"><span class="kobospan" id="kobo.334.1">fn</span></code><span class="kobospan" id="kobo.335.1"> method can be used anywhere. </span><span class="kobospan" id="kobo.335.2">This is one of the reasons why writing tests in TypeScript can be so difficult and why pure JavaScript should be used.</span></p>
<h3 class="heading2" id="_idParaDest-152"><span class="kobospan" id="kobo.336.1">Performing a test</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.337.1">For unit tests on </span><a id="_idIndexMarker428" class="calibre3"/><span class="kobospan" id="kobo.338.1">HTTP handlers, performing the test is often the simplest part of the process, because it involves invoking the handler function with the mock HTTP request and response objects, as shown in </span><em class="italic"><span class="kobospan" id="kobo.339.1">Listing 8.10</span></em><span class="kobospan" id="kobo.340.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.341.1">Listing 8.10: Performing the test in the readHandler.test.js file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.342.1">import { test } from "node:test";
</span><strong class="screentext"><span class="kobospan" id="kobo.343.1">import { readHandler } from</span></strong><strong class="screentext"><span class="kobospan" id="kobo.344.1"> "./readHandler";</span></strong><span class="kobospan" id="kobo.345.1">
test("readHandler tests", (testCtx) =&gt; {
    // Arrange - set up the test
    const req = {
        pipe: testCtx.mock.fn()
    };
    const resp = {
        cookie: testCtx.mock.fn()
    };
    </span><strong class="screentext"><span class="kobospan" id="kobo.346.1">// Act - perform the test</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.347.1">    readHandler(req, resp);</span></strong><span class="kobospan" id="kobo.348.1">
   
    // TODO - Assert - verify the results
});
</span></code></pre>
<h3 class="heading2" id="_idParaDest-153"><span class="kobospan" id="kobo.349.1">Asserting test results</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.350.1">The methods</span><a id="_idIndexMarker429" class="calibre3"/><span class="kobospan" id="kobo.351.1"> in </span><em class="italic"><span class="kobospan" id="kobo.352.1">Table 8.3</span></em><span class="kobospan" id="kobo.353.1"> produce results that have a </span><code class="inlinecode"><span class="kobospan" id="kobo.354.1">mock</span></code><span class="kobospan" id="kobo.355.1"> property that can be used to learn how a function or method was used when the test was performed. </span><span class="kobospan" id="kobo.355.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.356.1">mock</span></code><span class="kobospan" id="kobo.357.1"> property returns a </span><code class="inlinecode"><span class="kobospan" id="kobo.358.1">MockFunctionContext</span></code><span class="kobospan" id="kobo.359.1"> object, whose most useful features are described in </span><em class="italic"><span class="kobospan" id="kobo.360.1">Table 8.4</span></em><span class="kobospan" id="kobo.361.1">.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.362.1">Table 8.4: Useful MockFunctionContext Features</span></p>
<table class="table-container" id="table004-4">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.363.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.364.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.365.1">callCount()</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.366.1">This method returns the number of times the function or method has been called.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.367.1">calls</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.368.1">This method returns an array of objects, where each element describes one call.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.369.1">The </span><a id="_idIndexMarker430" class="calibre3"/><span class="kobospan" id="kobo.370.1">result from the </span><code class="inlinecode"><span class="kobospan" id="kobo.371.1">calls</span></code><span class="kobospan" id="kobo.372.1"> property described in </span><em class="italic"><span class="kobospan" id="kobo.373.1">Table 8.4</span></em><span class="kobospan" id="kobo.374.1"> contains objects with the properties described in </span><em class="italic"><span class="kobospan" id="kobo.375.1">Table 8.5</span></em><span class="kobospan" id="kobo.376.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.377.1">Table 8.5: Useful Properties Used to Describe a Method or Function Call</span></p>
<table class="table-container" id="table005-3">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.378.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.379.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.380.1">arguments</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.381.1">This property returns an array of arguments that were passed to the function or method.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.382.1">result</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.383.1">This property returns the result produced by the function or method.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.384.1">error</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.385.1">This property returns an object if the function throws an error and </span><code class="inlinecode"><span class="kobospan2" id="kobo.386.1">undefined</span></code><span class="kobospan4" id="kobo.387.1"> if it does not.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.388.1">stack</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.389.1">This property returns an </span><code class="inlinecode"><span class="kobospan2" id="kobo.390.1">Error</span></code><span class="kobospan4" id="kobo.391.1"> object that can be used to determine where an error was thrown.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.392.1">The mocked functions and methods act as spies that report on how they were used during the test, allowing the result to be easily inspected and assessed, as shown in </span><em class="italic"><span class="kobospan" id="kobo.393.1">Listing 8.11</span></em><span class="kobospan" id="kobo.394.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.395.1">Listing 8.11: Assessing rest results in the readHandler.test.js file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.396.1">import { test } from "node:test";
import { readHandler } from "./readHandler";
test("readHandler tests", (testCtx) =&gt; {
    // Arrange - set up the test
    const req = {
        pipe: testCtx.mock.fn()
    };
    const resp = {
        cookie: testCtx.mock.fn()
    };
    // Act - perform the test
    readHandler(req, resp);
</span><strong class="screentext"><span class="kobospan" id="kobo.397.1">    // Assert - verify the results</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.398.1">    if (req.pipe.mock.callCount() !== 1</span></strong><strong class="screentext"><span class="kobospan" id="kobo.399.1"> ||</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.400.1">        req.pipe.mock.calls[0].arguments[0] !== resp) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.401.1">            throw new Error("Request not piped"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.402.1">);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.403.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.404.1">    if (resp.cookie.mock.callCount() === 1) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.405.1">        const [name, val] = resp.cookie.mock.calls[0</span></strong><strong class="screentext"><span class="kobospan" id="kobo.406.1">].arguments;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.407.1">        if (name !== "sessionID" || val !== "mysecretcode") {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.408.1">            throw new Error("Cookie not set correctly");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.409.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.410.1">    } else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.411.1">        throw</span></strong><strong class="screentext"><span class="kobospan" id="kobo.412.1"> new Error("cookie method not called once");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.413.1">    }</span></strong><span class="kobospan" id="kobo.414.1">
});
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.415.1">The </span><a id="_idIndexMarker431" class="calibre3"/><span class="kobospan" id="kobo.416.1">new statements use the </span><code class="inlinecode"><span class="kobospan" id="kobo.417.1">mock</span></code><span class="kobospan" id="kobo.418.1"> properties to confirm that the </span><code class="inlinecode"><span class="kobospan" id="kobo.419.1">pipe</span></code><span class="kobospan" id="kobo.420.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.421.1">cookie</span></code><span class="kobospan" id="kobo.422.1"> methods have been called once and have received the correct arguments.</span></p>
<p class="normal"><span class="kobospan" id="kobo.423.1">The assessment of test results can be simplified by using </span><em class="italic"><span class="kobospan" id="kobo.424.1">assertions</span></em><span class="kobospan" id="kobo.425.1">, which are methods that perform comparisons and throw exceptions more concisely. </span><span class="kobospan" id="kobo.425.2">Node.js provides assertions in the </span><code class="inlinecode"><span class="kobospan" id="kobo.426.1">assert</span></code><span class="kobospan" id="kobo.427.1"> module and the most useful methods are described in </span><em class="italic"><span class="kobospan" id="kobo.428.1">Table 8.6</span></em><span class="kobospan" id="kobo.429.1">.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.430.1">Table 8.6: Useful Assertions </span></p>
<table class="table-container" id="table006-3">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.431.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.432.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.433.1">assert(val)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.434.1">This method throws an error if </span><code class="inlinecode"><span class="kobospan2" id="kobo.435.1">val</span></code><span class="kobospan" id="kobo.436.1"> isn’t truthy (as described in </span><em class="italic"><span class="kobospan2" id="kobo.437.1">Chapter 2</span></em><span class="kobospan4" id="kobo.438.1">).</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.439.1">equal(v1, v2)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.440.1">This method throws an error if </span><code class="inlinecode"><span class="kobospan2" id="kobo.441.1">v1</span></code><span class="kobospan" id="kobo.442.1"> doesn’t equal </span><code class="inlinecode"><span class="kobospan2" id="kobo.443.1">v2</span></code><span class="kobospan4" id="kobo.444.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.445.1">notEqual(v1, v2)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.446.1">This method throws an error if </span><code class="inlinecode"><span class="kobospan2" id="kobo.447.1">v1</span></code><span class="kobospan" id="kobo.448.1"> equals </span><code class="inlinecode"><span class="kobospan2" id="kobo.449.1">v2</span></code><span class="kobospan4" id="kobo.450.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.451.1">deepStrictEqual(v1, v2)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.452.1">This method performs a deep comparison of </span><code class="inlinecode"><span class="kobospan2" id="kobo.453.1">v1</span></code><span class="kobospan" id="kobo.454.1"> and </span><code class="inlinecode"><span class="kobospan2" id="kobo.455.1">v2</span></code><span class="kobospan4" id="kobo.456.1"> and throws an error if they do not match. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.457.1">notDeepStrictEqual(v1, v2)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.458.1">This method performs a deep comparison of </span><code class="inlinecode"><span class="kobospan2" id="kobo.459.1">v1</span></code><span class="kobospan" id="kobo.460.1"> and </span><code class="inlinecode"><span class="kobospan2" id="kobo.461.1">v2</span></code><span class="kobospan4" id="kobo.462.1"> and throws an error if they match.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.463.1">match(str, regexp)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.464.1">This method throws an error if </span><code class="inlinecode"><span class="kobospan2" id="kobo.465.1">str</span></code><span class="kobospan4" id="kobo.466.1"> isn’t matched by the specified regular expression.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.467.1">doesNotMatch(str, regexp)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.468.1">This method throws an error if </span><code class="inlinecode"><span class="kobospan2" id="kobo.469.1">str</span></code><span class="kobospan4" id="kobo.470.1"> is matched by the specified regular expression.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.471.1">Listing 8.12</span></em><span class="kobospan" id="kobo.472.1"> revises the unit test to use the assertions to check the results.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.473.1">Listing 8.12: Using assertions in the readHandler.test.js file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.474.1">import { test } from "node:test";
import { readHandler } from "./readHandler";
</span><strong class="screentext"><span class="kobospan" id="kobo.475.1">import { equal } from "assert";</span></strong><span class="kobospan" id="kobo.476.1">
test("readHandler tests", (testCtx) =&gt; {
    // Arrange - set up the test
    const req = {
        pipe: testCtx.mock.fn()
    };
    const resp = {
        cookie: testCtx.mock.fn()
    };
    // Act - perform the test
    readHandler(req, resp);
    // Assert - verify the results
    </span><strong class="screentext"><span class="kobospan" id="kobo.477.1">equal</span></strong><strong class="screentext"><span class="kobospan" id="kobo.478.1">(req.pipe.mock.callCount(), 1);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.479.1">    equal(req.pipe.mock.calls[0].arguments</span></strong><strong class="screentext"><span class="kobospan" id="kobo.480.1">[0], resp);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.481.1">    equal(resp.cookie.mock.callCount(), 1);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.482.1">    equal(resp.cookie.mock.calls</span></strong><strong class="screentext"><span class="kobospan" id="kobo.483.1">[0].arguments[0], "sessionID");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.484.1">    equal(resp.cookie.mock.calls[0].arguments</span></strong><strong class="screentext"><span class="kobospan" id="kobo.485.1">[1], "mysecretcode");</span></strong><span class="kobospan" id="kobo.486.1">
});
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.487.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.488.1">equal</span></code><span class="kobospan" id="kobo.489.1"> method is</span><a id="_idIndexMarker432" class="calibre3"/><span class="kobospan" id="kobo.490.1"> used to make a series of comparisons and will throw an error that will cause the test to fail if the values do not match.</span></p>
<h2 class="heading1" id="_idParaDest-154"><span class="kobospan" id="kobo.491.1">Testing asynchronous code</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.492.1">The Node.js test runner has support</span><a id="_idIndexMarker433" class="calibre3"/><span class="kobospan" id="kobo.493.1"> for testing asynchronous code. </span><span class="kobospan" id="kobo.493.2">For promise-based code, the test fails if the promise is rejected. </span><span class="kobospan" id="kobo.493.3">To prepare, </span><em class="italic"><span class="kobospan" id="kobo.494.1">Listing 8.13</span></em><span class="kobospan" id="kobo.495.1"> changes the handler so that it performs an asynchronous file read and sends the file contents to the client. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.496.1">Listing 8.13: Performing an asynchronous operation in the readHander.ts File in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.497.1">import { Request, Response } from "express";
</span><strong class="screentext"><span class="kobospan" id="kobo.498.1">import { readFile } from "fs";</span></strong><span class="kobospan" id="kobo.499.1">
export const readHandler = (req: Request, resp: Response) =&gt; {   
    </span><strong class="screentext"><span class="kobospan" id="kobo.500.1">readFile</span></strong><strong class="screentext"><span class="kobospan" id="kobo.501.1">("data.json", (err, data) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.502.1">        if (err != null) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.503.1">            resp.writeHead(500, err.message);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.504.1">        } else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.505.1">            resp.setHeader</span></strong><strong class="screentext"><span class="kobospan" id="kobo.506.1">("Content-Type", "application/json")</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.507.1">            resp.write(data);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.508.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.509.1">        resp.end();       </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.510.1">    });</span></strong><span class="kobospan" id="kobo.511.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.512.1">Ignore the output from the test runner for the moment and check the handler works by using a browser to request </span><a href="http://localhost:5000" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.513.1">http://localhost:5000</span></span></a><span class="kobospan" id="kobo.514.1"> and clicking the </span><strong class="screentext"><span class="kobospan" id="kobo.515.1">Send Message</span></strong><span class="kobospan" id="kobo.516.1"> button. </span><span class="kobospan" id="kobo.516.2">The response will contain the JSON data read from the </span><code class="inlinecode"><span class="kobospan" id="kobo.517.1">data.json</span></code><span class="kobospan" id="kobo.518.1"> file, as shown in </span><em class="italic"><span class="kobospan" id="kobo.519.1">Figure 8.2</span></em><span class="kobospan" id="kobo.520.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.521.1"><img alt="" src="../Images/B21959_08_02.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.522.1">Figure 8.2: Testing the revised handler</span></p>
<p class="normal"><span class="kobospan" id="kobo.523.1">To write the</span><a id="_idIndexMarker434" class="calibre3"/><span class="kobospan" id="kobo.524.1"> unit test, a different approach to mocking is required, as shown in </span><em class="italic"><span class="kobospan" id="kobo.525.1">Listing 8.14</span></em><span class="kobospan" id="kobo.526.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.527.1">Listing 8.14: Testing an asynchronous handler in the readHandler.test.js file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.528.1">import { test } from "node:test";
import { readHandler } from "./readHandler";
import { equal } from "assert";
</span><strong class="screentext"><span class="kobospan" id="kobo.529.1">import fs from "fs";</span></strong><span class="kobospan" id="kobo.530.1">
test("readHandler tests", async (testCtx) =&gt; {
    // Arrange - set up the test
   </span><strong class="screentext"><span class="kobospan" id="kobo.531.1"> const data = "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.532.1">json-data";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.533.1">    testCtx.mock.method(fs, "readFile", (file, cb) =&gt; cb(undefined, data));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.534.1">    const req = {};</span></strong>
<strong class="screentext"> </strong>
<strong class="screentext"><span class="kobospan" id="kobo.535.1">    const resp = {</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.536.1">setHeader: testCtx.mock.fn(),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.537.1">        write: testCtx.mock.fn(),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.538.1">        end: testCtx.mock.fn()</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.539.1">    };</span></strong><span class="kobospan" id="kobo.540.1">
    // Act - perform the test
    </span><strong class="screentext"><span class="kobospan" id="kobo.541.1">await readHandler(req, resp);</span></strong><span class="kobospan" id="kobo.542.1">
    // Assert - verify the results
  </span><strong class="screentext"><span class="kobospan" id="kobo.543.1">  equal(resp.setHeader.mock.calls[0].arguments[0], "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.544.1">Content-Type");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.545.1">    equal(resp.setHeader.mock.calls[0].arguments[1], "application/json");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.546.1">    equal(resp.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.547.1">write.mock.calls[0].arguments[0], data);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.548.1">    equal(resp.end.mock.callCount(), </span></strong><strong class="screentext"><span class="kobospan" id="kobo.549.1">1);</span></strong><span class="kobospan" id="kobo.550.1">
});
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.551.1">The key to this test is being able to mock the </span><code class="inlinecode"><span class="kobospan" id="kobo.552.1">readFile</span></code><span class="kobospan" id="kobo.553.1"> function in the </span><code class="inlinecode"><span class="kobospan" id="kobo.554.1">fs</span></code><span class="kobospan" id="kobo.555.1"> module, which is done by this statement:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.556.1">...
</span><span class="kobospan" id="kobo.556.2">testCtx.mock.</span><strong class="screentext"><span class="kobospan" id="kobo.557.1">method</span></strong><span class="kobospan" id="kobo.558.1">(fs, "readFile", (file, cb) =&gt; cb(undefined, data));
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.559.1">This is difficult to explain because the name and the result use the same word: the method named </span><code class="inlinecode"><span class="kobospan" id="kobo.560.1">method</span></code><span class="kobospan" id="kobo.561.1"> mocks a method on an object. </span><span class="kobospan" id="kobo.561.2">In this case, the object is the entire </span><code class="inlinecode"><span class="kobospan" id="kobo.562.1">fs</span></code><span class="kobospan" id="kobo.563.1"> module, which was imported like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.564.1">...
</span><span class="kobospan" id="kobo.564.2">import fs from "fs";
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.565.1">The </span><a id="_idIndexMarker435" class="calibre3"/><span class="kobospan" id="kobo.566.1">top-level functions defined by the module are presented as methods on an object named </span><code class="inlinecode"><span class="kobospan" id="kobo.567.1">fs</span></code><span class="kobospan" id="kobo.568.1">, which allows them to be mocked using </span><code class="inlinecode"><span class="kobospan" id="kobo.569.1">method</span></code><span class="kobospan" id="kobo.570.1">. </span><span class="kobospan" id="kobo.570.2">In this case, the </span><code class="inlinecode"><span class="kobospan" id="kobo.571.1">readFile</span></code><span class="kobospan" id="kobo.572.1"> function has been replaced with a mock implementation that invokes the callback function with test data, making it possible to perform the test without having to read from the file system. </span><span class="kobospan" id="kobo.572.2">The other mocks in this example are created with the </span><code class="inlinecode"><span class="kobospan" id="kobo.573.1">fn</span></code><span class="kobospan" id="kobo.574.1"> method and correspond to the </span><code class="inlinecode"><span class="kobospan" id="kobo.575.1">Response</span></code><span class="kobospan" id="kobo.576.1"> methods that are called by the handler being tested.</span></p>
<h3 class="heading2" id="_idParaDest-155"><span class="kobospan" id="kobo.577.1">Testing promises</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.578.1">Testing code that uses </span><a id="_idIndexMarker436" class="calibre3"/><span class="kobospan" id="kobo.579.1">promises is done in much the same way, except the mock resolves the promise with test data. </span><em class="italic"><span class="kobospan" id="kobo.580.1">Listing 8.15</span></em><span class="kobospan" id="kobo.581.1"> updates the handler to use the promise-based version of the </span><code class="inlinecode"><span class="kobospan" id="kobo.582.1">readFile</span></code><span class="kobospan" id="kobo.583.1"> function.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.584.1">Listing 8.15: Using promises in the readHandler.ts file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.585.1">import { Request, Response } from "express";
</span><strong class="screentext"><span class="kobospan" id="kobo.586.1">import { readFile } from "fs/promises";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.587.1">export const readHandler = async (req: Request, resp: Response) =&gt; {   </span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.588.1">try {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.589.1">        resp.setHeader("Content-Type", "application/json")</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.590.1">        resp.write(await readFile("data.json"));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.591.1">    } catch (err) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.592.1">        resp.writeHead(</span></strong><strong class="screentext"><span class="kobospan" id="kobo.593.1">500);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.594.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.595.1">    resp.end();</span></strong><span class="kobospan" id="kobo.596.1">
}
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.597.1">Listing 8.16</span></em><span class="kobospan" id="kobo.598.1"> updates the unit test so that the mock resolves a promise.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.599.1">Listing 8.16: Testing a promise in the readHandler.test.js file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.600.1">import { test } from "node:test";
import { readHandler } from "./readHandler";
import { equal } from "assert";
</span><strong class="screentext"><span class="kobospan" id="kobo.601.1">import fs from "fs/promises";</span></strong><span class="kobospan" id="kobo.602.1">
test("readHandler tests", async (testCtx) =&gt; {
    // Arrange - set up the test
    const data = "json-data";
    </span><strong class="screentext"><span class="kobospan" id="kobo.603.1">testCtx.mock.method(fs, "readFile", async () =&gt; data);</span></strong><span class="kobospan" id="kobo.604.1">
    const req = {};
       
    const resp = {
        setHeader: testCtx.mock.fn(),
        write: testCtx.mock.fn(),
        end: testCtx.mock.fn()
    };
    // Act - perform the test
    await readHandler(req, resp);
    // Assert - verify the results
    equal(resp.setHeader.mock.calls[0].arguments[0], "Content-Type");
    equal(resp.setHeader.mock.calls[0].arguments[1], "application/json");
    equal(resp.write.mock.calls[0].arguments[0], data);
    equal(resp.end.mock.callCount(), 1);
});
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.605.1">The </span><a id="_idIndexMarker437" class="calibre3"/><span class="kobospan" id="kobo.606.1">mock is an asynchronous function that produces the test data when it resolves. </span><span class="kobospan" id="kobo.606.2">The rest of the unit test is unchanged.</span></p>
<h2 class="heading1" id="_idParaDest-156"><span class="kobospan" id="kobo.607.1">Creating subtests</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.608.1">The test in </span><em class="italic"><span class="kobospan" id="kobo.609.1">Listing 8.16</span></em><span class="kobospan" id="kobo.610.1"> doesn’t test how</span><a id="_idIndexMarker438" class="calibre3"/><span class="kobospan" id="kobo.611.1"> the handler responds when there is a problem reading the data from the file. </span><span class="kobospan" id="kobo.611.2">A little more work is required, as shown in </span><em class="italic"><span class="kobospan" id="kobo.612.1">Listing 8.17</span></em><span class="kobospan" id="kobo.613.1">.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.614.1">Listing 8.17: Testing multiple outcomes in the readHandler.test.js file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.615.1">import { test } from "node:test";
import { readHandler } from "./readHandler";
import { equal } from "assert";
import fs from "fs/promises";
</span><strong class="screentext"><span class="kobospan" id="kobo.616.1">const createMockResponse = (testCtx) =&gt; ({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.617.1">    writeHead</span></strong><strong class="screentext"><span class="kobospan" id="kobo.618.1">: testCtx.mock.fn(),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.619.1">    setHeader: testCtx.mock.fn(),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.620.1">    write: testCtx.mock.fn(),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.621.1">    end: testCtx.mock</span></strong><strong class="screentext"><span class="kobospan" id="kobo.622.1">.fn()   </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.623.1">});</span></strong><span class="kobospan" id="kobo.624.1">
test("readHandler tests", async (testCtx) =&gt; {
    // Arrange - set up the test
    const req = {};
       
    </span><strong class="screentext"><span class="kobospan" id="kobo.625.1">// const resp = {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.626.1">    //     setHeader: testCtx.mock.fn(),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.627.1">    //     write: testCtx.mock.fn(),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.628.1">    //     end: testCtx.mock.fn()</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.629.1">    // };</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.630.1">    // Test the successful outcome</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.631.1">    await testCtx.test("Successfully reads file", async (innerCtx) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.632.1">        // Arrange - set up the test</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.633.1">        const data = "json-data";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.634.1">        innerCtx.mock</span></strong><strong class="screentext"><span class="kobospan" id="kobo.635.1">.method(fs, "readFile", async () =&gt; data);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.636.1">        const resp = createMockResponse(innerCtx);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.637.1">        // Act - perform the test</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.638.1">        await readHandler(req, resp);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.639.1">        // Assert - verify the results</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.640.1">        equal</span></strong><strong class="screentext"><span class="kobospan" id="kobo.641.1">(resp.setHeader.mock.calls[0].arguments[0], "Content-Type");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.642.1">        equal(resp.setHeader.mock</span></strong><strong class="screentext"><span class="kobospan" id="kobo.643.1">.calls[0].arguments[1], "application/json");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.644.1">        equal(resp.write.mock.calls[0</span></strong><strong class="screentext"><span class="kobospan" id="kobo.645.1">].arguments[0], data);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.646.1">        equal(resp.end.mock.callCount(), 1);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.647.1">    });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.648.1">    // Test the failure outcome</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.649.1">    await testCtx.test</span></strong><strong class="screentext"><span class="kobospan" id="kobo.650.1">("Handles error reading file", async (innerCtx) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.651.1">        // Arrange - set up the test</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.652.1">        innerCtx.mock.method(fs, "readFile", </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.653.1">            () =&gt; Promise.reject("file error"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.654.1">));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.655.1">        const resp = createMockResponse(innerCtx);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.656.1">        // Act - perform the test</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.657.1">        await readHandler(req, resp);</span></strong>
<strong class="screentext"> </strong>
<strong class="screentext"><span class="kobospan" id="kobo.658.1">        // Assert - verify the results</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.659.1">        equal(resp.writeHead.mock.calls</span></strong><strong class="screentext"><span class="kobospan" id="kobo.660.1">[0].arguments[0], 500);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.661.1">        equal(resp.end.mock.callCount(), 1);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.662.1">    });</span></strong><span class="kobospan" id="kobo.663.1">
});
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.664.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.665.1">TestContext</span></code><span class="kobospan" id="kobo.666.1"> class</span><a id="_idIndexMarker439" class="calibre3"/><span class="kobospan" id="kobo.667.1"> defines a </span><code class="inlinecode"><span class="kobospan" id="kobo.668.1">test</span></code><span class="kobospan" id="kobo.669.1"> method that can be used to create subtests. </span><span class="kobospan" id="kobo.669.2">Subtests receive their own context object that can be used to create mocks specific to that subtest and </span><em class="italic"><span class="kobospan" id="kobo.670.1">Listing 8.17</span></em><span class="kobospan" id="kobo.671.1"> uses this feature to create tests that use different implementations for the mock </span><code class="inlinecode"><span class="kobospan" id="kobo.672.1">readFile</span></code><span class="kobospan" id="kobo.673.1"> function. </span><span class="kobospan" id="kobo.673.2">Save the changes and the output from the test runner will reflect the addition of the subtests, like this:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.674.1">...
</span><span class="kobospan" id="kobo.674.2">readHandler tests
  Successfully reads file (0.5485ms)
  Handles error reading file (0.2952ms)
readHandler tests (2.0538ms)
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.675.1">Notice that the subtests are asynchronous and require the </span><code class="inlinecode"><span class="kobospan" id="kobo.676.1">await</span></code><span class="kobospan" id="kobo.677.1"> keyword. </span><span class="kobospan" id="kobo.677.2">If you don’t wait for subtests, then the top-level test will be completed early, and the test runner will report an error.</span></p>
<h1 class="heading" id="_idParaDest-157"><span class="kobospan" id="kobo.678.1">Debugging javascript code</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.679.1">Unit testing</span><a id="_idIndexMarker440" class="calibre3"/><span class="kobospan" id="kobo.680.1"> is the process of confirming code behaves as it should; debugging</span><a id="_idIndexMarker441" class="calibre3"/><span class="kobospan" id="kobo.681.1"> is the process of figuring out why it doesn’t. </span><span class="kobospan" id="kobo.681.2">Before starting, use </span><em class="italic"><span class="kobospan" id="kobo.682.1">Ctrl + C</span></em><span class="kobospan" id="kobo.683.1"> to stop the build process and the unit-testing process. </span><span class="kobospan" id="kobo.683.2">Once the processes have stopped, run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.684.1">Listing 8.18</span></em><span class="kobospan" id="kobo.685.1"> to start the webpack </span><a id="_idIndexMarker442" class="calibre3"/><span class="kobospan" id="kobo.686.1">development server on its own. </span><span class="kobospan" id="kobo.686.2">The debugger will be applied to the backend server, which will be started on its own, but relies on webpack to handle requests for client-side content.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.687.1">Listing 8.18: Starting the webpack development server</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.688.1">npm run client
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.689.1">The</span><a id="_idIndexMarker443" class="calibre3"/><span class="kobospan" id="kobo.690.1"> next step is to configure the TypeScript compiler so that it generates source maps, as shown in </span><em class="italic"><span class="kobospan" id="kobo.691.1">Listing 8.19</span></em><span class="kobospan" id="kobo.692.1">, which lets the debugger correlate the pure JavaScript being executed by Node.js with the TypeScript code written by the developer. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.693.1">Listing 8.19: Enabling source maps in the tsconfig.json file in the src folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.694.1">{
    "extends": "@tsconfig/node20/tsconfig.json",
     "compilerOptions": {                      
         "rootDir": "src",  
         "outDir": "dist",
         "allowJs": true,
         </span><strong class="screentext"><span class="kobospan" id="kobo.695.1">"sourceMap": true</span></strong><span class="kobospan" id="kobo.696.1">
     },
     "include": ["src/**/*"]
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.697.1">When you save the file, the compiler will start generating files with the </span><code class="inlinecode"><span class="kobospan" id="kobo.698.1">map</span></code><span class="kobospan" id="kobo.699.1"> file extension in the </span><code class="inlinecode"><span class="kobospan" id="kobo.700.1">dist</span></code><span class="kobospan" id="kobo.701.1"> folder.</span></p>
<h2 class="heading1" id="_idParaDest-158"><span class="kobospan" id="kobo.702.1">Adding code breakpoints</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.703.1">Code editors that</span><a id="_idIndexMarker444" class="calibre3"/><span class="kobospan" id="kobo.704.1"> have good TypeScript support, such as Visual Studio Code, allow breakpoints to be added to code files. </span><span class="kobospan" id="kobo.704.2">My experience with this feature has been mixed, and I have found them unreliable, which is why I rely on the less elegant but more predictable </span><code class="inlinecode"><span class="kobospan" id="kobo.705.1">debugger</span></code><span class="kobospan" id="kobo.706.1"> JavaScript keyword.</span></p>
<p class="normal"><span class="kobospan" id="kobo.707.1">When a JavaScript application is executed through a debugger, execution halts when the </span><code class="inlinecode"><span class="kobospan" id="kobo.708.1">debugger</span></code><span class="kobospan" id="kobo.709.1"> keyword is encountered, and control is passed to the developer. </span><em class="italic"><span class="kobospan" id="kobo.710.1">Listing 8.20</span></em><span class="kobospan" id="kobo.711.1"> adds the </span><code class="inlinecode"><span class="kobospan" id="kobo.712.1">debugger</span></code><span class="kobospan" id="kobo.713.1"> keyword to the </span><code class="inlinecode"><span class="kobospan" id="kobo.714.1">readHandler.ts</span></code><span class="kobospan" id="kobo.715.1"> file. </span></p>
<p class="packt_figref"><span><span class="kobospan" id="kobo.716.1">Listing 8.20: Adding the debugger keyword in the readHandler.ts file in the src folder</span></span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.717.1">import { Request, Response } from "express";
import { readFile } from "fs/promises";
export const readHandler = async (req: Request, resp: Response) =&gt; {   
    try {
        resp.setHeader("Content-Type", "application/json")
        resp.write(await readFile("data.json"));
        </span><strong class="screentext"><span class="kobospan" id="kobo.718.1">debugger</span></strong><span class="kobospan" id="kobo.719.1">
    } catch (err) {
        resp.writeHead(500);
    }
    resp.end();
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.720.1">There will be no change in the output when the code is executed because Node.js ignores the </span><code class="inlinecode"><span class="kobospan" id="kobo.721.1">debugger</span></code><span class="kobospan" id="kobo.722.1"> keyword by default.</span></p>
<h2 class="heading1" id="_idParaDest-159"><span class="kobospan" id="kobo.723.1">Using Visual Studio Code for debugging</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.724.1">Most good code editors </span><a id="_idIndexMarker445" class="calibre3"/><span class="kobospan" id="kobo.725.1">have some degree of support for debugging TypeScript and JavaScript code. </span><span class="kobospan" id="kobo.725.2">In this section, I will show you how to perform debugging with Visual Studio Code to give you an idea of the process. </span><span class="kobospan" id="kobo.725.3">There may be different steps required if you use another editor, but the basic approach is likely to be similar. </span></p>
<p class="normal"><span class="kobospan" id="kobo.726.1">To set up the configuration for debugging, select </span><strong class="screentext"><span class="kobospan" id="kobo.727.1">Add Configuration</span></strong><span class="kobospan" id="kobo.728.1"> from the </span><strong class="screentext"><span class="kobospan" id="kobo.729.1">Run</span></strong><span class="kobospan" id="kobo.730.1"> menu and select </span><strong class="screentext"><span class="kobospan" id="kobo.731.1">Node.js</span></strong><span class="kobospan" id="kobo.732.1"> from the list of environments when prompted, as shown in </span><em class="italic"><span class="kobospan" id="kobo.733.1">Figure 8.3</span></em><span class="kobospan" id="kobo.734.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.735.1"><img alt="" src="../Images/B21959_08_03.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.736.1">Figure 8.3: Selecting the debugging environment</span></p>
<p class="normal"><span class="kobospan" id="kobo.737.1">Visual Studio Code </span><a id="_idIndexMarker446" class="calibre3"/><span class="kobospan" id="kobo.738.1">will create a </span><code class="inlinecode"><span class="kobospan" id="kobo.739.1">.vscode</span></code><span class="kobospan" id="kobo.740.1"> folder and a file called </span><code class="inlinecode"><span class="kobospan" id="kobo.741.1">launch.json</span></code><span class="kobospan" id="kobo.742.1">, which is used to configure the debugger. </span><span class="kobospan" id="kobo.742.2">Change the value of the </span><code class="inlinecode"><span class="kobospan" id="kobo.743.1">program</span></code><span class="kobospan" id="kobo.744.1"> property so that the debugger executes the JavaScript code in the </span><code class="inlinecode"><span class="kobospan" id="kobo.745.1">dist</span></code><span class="kobospan" id="kobo.746.1"> folder, as shown in </span><em class="italic"><span class="kobospan" id="kobo.747.1">Listing 8.21</span></em><span class="kobospan" id="kobo.748.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.749.1">Listing 8.21: Configuring the debugger in the launch.json file in the .vscode folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.750.1">{
    "version": "0.2.0",
    "configurations": [
        {
            "type": "node",
            "request": "launch",
            "name": "Launch Program",
            "skipFiles": [
                "&lt;node_internals&gt;/**"
            ],
           </span><strong class="screentext"><span class="kobospan" id="kobo.751.1"> "program": "${workspaceFolder}/dist/server.js"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.752.1">,</span></strong><span class="kobospan" id="kobo.753.1">
            "preLaunchTask": "tsc: build - tsconfig.json",
            "outFiles": [
                "${workspaceFolder}/dist/**/*.js"
            ]
        }
    ]
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.754.1">Save the changes to the </span><code class="inlinecode"><span class="kobospan" id="kobo.755.1">launch.json</span></code><span class="kobospan" id="kobo.756.1"> file and select </span><strong class="screentext"><span class="kobospan" id="kobo.757.1">Start Debugging</span></strong><span class="kobospan" id="kobo.758.1"> from the </span><strong class="screentext"><span class="kobospan" id="kobo.759.1">Run</span></strong><span class="kobospan" id="kobo.760.1"> menu. </span><span class="kobospan" id="kobo.760.2">Visual Studio Code will start Node.js and execution will continue as normal until the </span><code class="inlinecode"><span class="kobospan" id="kobo.761.1">debugger</span></code><span class="kobospan" id="kobo.762.1"> keyword is reached. </span><span class="kobospan" id="kobo.762.2">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.763.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.764.1"> and click the </span><strong class="screentext"><span class="kobospan" id="kobo.765.1">Send Message</span></strong><span class="kobospan" id="kobo.766.1"> button. </span><span class="kobospan" id="kobo.766.2">The request will be passed to the handler for processing, and when the </span><code class="inlinecode"><span class="kobospan" id="kobo.767.1">debugger</span></code><span class="kobospan" id="kobo.768.1"> keyword is reached, execution will be halted and control will be transferred to the debugging popup, as shown in </span><em class="italic"><span class="kobospan" id="kobo.769.1">Figure 8.4</span></em><span class="kobospan" id="kobo.770.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.771.1"><img alt="" src="../Images/B21959_08_04.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.772.1">Figure 8.4: Debugging with Visual Studio Code</span></p>
<p class="normal"><span class="kobospan" id="kobo.773.1">The state of the</span><a id="_idIndexMarker447" class="calibre3"/><span class="kobospan" id="kobo.774.1"> application is displayed in the sidebar, showing the variables that are set at the point that execution was halted. </span><span class="kobospan" id="kobo.774.2">Standard debugging features are available, including setting watches, stepping into and over statements, and resuming execution. </span><span class="kobospan" id="kobo.774.3">The </span><strong class="screentext"><span class="kobospan" id="kobo.775.1">Debug Console</span></strong><span class="kobospan" id="kobo.776.1"> window allows JavaScript statements to be executed in the context of the application so that entering a variable name and pressing </span><em class="italic"><span class="kobospan" id="kobo.777.1">Return</span></em><span class="kobospan" id="kobo.778.1">, for example, will return the value assigned to that variable.</span></p>
<h2 class="heading1" id="_idParaDest-160"><span class="kobospan" id="kobo.779.1">Using the remote Node.js debugger</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.780.1">If you don’t want to use </span><a id="_idIndexMarker448" class="calibre3"/><span class="kobospan" id="kobo.781.1">the code editor for debugging, then Google Chrome provides good integrated debugging for Node.js, using the same features that are used to debug client-side code. </span><span class="kobospan" id="kobo.781.2">Stop the Visual Studio Code debugger from the previous section and run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.782.1">Listing 8.22</span></em><span class="kobospan" id="kobo.783.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.784.1">webapp</span></code><span class="kobospan" id="kobo.785.1"> folder to start Node.js in debugging mode.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.786.1">Listing 8.22: Starting Node.js in debugging mode</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.787.1">node --inspect dist/server.js
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.788.1">When Node.js starts, it will produce messages like these, which include details of the URL on which it is ready to accept debugging requests:</span></p>
<pre class="programlisting1"><code class="hljs-con"><strong class="screentext"><span class="kobospan" id="kobo.789.1">Debugger listening on ws://127.0.0.1:9229/faed1dec-fbb0-4425-bd87-410c98980716</span></strong><span class="kobospan" id="kobo.790.1">
For help, see: https://nodejs.org/en/docs/inspector
HTTP Server listening on port 5000
Debugger attached.
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.791.1">Using Google</span><a id="_idIndexMarker449" class="calibre3"/><span class="kobospan" id="kobo.792.1"> Chrome, request </span><code class="inlinecode"><span class="kobospan" id="kobo.793.1">chrome://inspect</span></code><span class="kobospan" id="kobo.794.1"> and click on the </span><strong class="screentext"><span class="kobospan" id="kobo.795.1">Open Dedicated DevTools for Node</span></strong><span class="kobospan" id="kobo.796.1"> option and the debugging window will open, as shown in </span><em class="italic"><span class="kobospan" id="kobo.797.1">Figure 8.5</span></em><span class="kobospan" id="kobo.798.1">.</span><span> </span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.799.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.800.1">All of the browsers that use the Chromium engine support this feature, including Brave, Opera, and Edge. </span><span class="kobospan" id="kobo.800.2">Use the name of the browser for the URL that opens the Node.js tools, such as </span><code class="inlinecode"><span class="kobospan" id="kobo.801.1">brave://inspect</span></code><span class="kobospan" id="kobo.802.1"> for the Brave browser. </span><span class="kobospan" id="kobo.802.2">This doesn’t work for Firefox, which has its own browser engine.</span><span> </span></p>
</div>
<figure class="mediaobject"><span class="kobospan" id="kobo.803.1"><img alt="" src="../Images/B21959_08_05.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.804.1">Figure 8.5: Using the chrome node.Js debugging features</span></p>
<p class="normal"><span class="kobospan" id="kobo.805.1">Open a new </span><a id="_idIndexMarker450" class="calibre3"/><span class="kobospan" id="kobo.806.1">browser window, request </span><code class="inlinecode"><span class="kobospan" id="kobo.807.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.808.1">, and click </span><strong class="screentext"><span class="kobospan" id="kobo.809.1">Send Message</span></strong><span class="kobospan" id="kobo.810.1">. </span><span class="kobospan" id="kobo.810.2">As the request is being processed, Node.js reaches the </span><code class="inlinecode"><span class="kobospan" id="kobo.811.1">debugger</span></code><span class="kobospan" id="kobo.812.1"> keyword. </span><span class="kobospan" id="kobo.812.2">Execution is halted and control is passed to the Chrome developer tools, as shown in </span><em class="italic"><span class="kobospan" id="kobo.813.1">Figure 8.6</span></em><span class="kobospan" id="kobo.814.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.815.1"><img alt="" src="../Images/B21959_08_06.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.816.1">Figure 8.6: The Chrome developer tools debugging Node.js</span></p>
<h1 class="heading" id="_idParaDest-161"><span class="kobospan" id="kobo.817.1">Summary</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.818.1">In this chapter, I described the Node.js features for unit testing and debugging.</span></p>
<ul class="calibre4">
<li class="bulletlist"><span class="kobospan" id="kobo.819.1">Node.js includes a built-in test runner, with support for executing tests and creating mock functions and methods.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.820.1">Unit tests for web applications focus on request handling and require mocks of HTTP requests and responses.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.821.1">Third-party packages, such as Jest, can be used for projects that require the same test tools for client- and server-side JavaScript code.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.822.1">Node.js includes support for debugging, which can be performed with many code editors or with one of the Chromium-based browsers, such as Google Chrome.</span></li>
</ul>
<p class="normal"><span class="kobospan" id="kobo.823.1">In the next part of this book, I demonstrate how Node.js can be used to create the features required for web applications, such as generating dynamic content and authenticating users.</span></p>
</div>
</body></html>