<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch10"/>Chapter 10. The App: Consuming Tweets Via Web Workers</h1></div></div></div><p>Up until now, JavaScript has been single-threaded. With a slow-running or lengthy process, everything on your page could come to a screeching halt waiting for something to finish. So far you could use AJAX or even <code class="literal">setTimeout</code> to delegate your tasks; however, neither of these solutions allows for real parallel execution and handling state gets pretty messy.</p><p>To make up for this deficiency, the HTML5 specification introduces <a id="id591" class="indexterm"/>Web Workers. Web Workers allow you to create non-user oriented background threads that can run simultaneously. They are typically meant for computationally heavy tasks. However, for our MovieNow enterprise application, we will use Web Workers to find tweets near a theater and display them. Although not necessarily computationally heavy, Web Workers can be useful to update the state of multiple elements on a page without interrupting the overall user experience (notice that there is still generally only a single UI-rendering thread).</p><p>In this chapter, we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Getting the data</li><li class="listitem" style="list-style-type: disc">Capturing geocodes</li><li class="listitem" style="list-style-type: disc">Anatomy of a Web Worker</li><li class="listitem" style="list-style-type: disc">Using Web Workers to get nearby tweets</li><li class="listitem" style="list-style-type: disc">Updating the event listener</li><li class="listitem" style="list-style-type: disc">Styling the tweets</li></ul></div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec78"/>Getting the data</h1></div></div></div><p>To start us out, let us create an endpoint for querying the Twitter REST API and returning tweets near a specified geocode. At the root of the application, create a PHP file called <code class="literal">nearbytweets.php</code>. Open it and paste in the following code:</p><div><pre class="programlisting">&lt;?php 
  $latitude = $_GET['latitude'];
  $longitude = $_GET['longitude'];
  if (strpos($latitude, '.') == false) {
    $latitude = substr($latitude, 0, -4) . '.' . substr($latitude, -4);
  }
  if (strpos($longitude, '.') == false) {
    $longitude = substr($longitude, 0, -4) . '.' . substr($longitude, -4);
  }
  $tweets = file_get_contents('http://search.twitter.com/search.json?include_entities=true&amp;result_type=mixed&amp;geocode=' . $latitude . ',' . $longitude . ',0.25mi'); 
    echo $tweets;
?&gt;</pre></div><p>This is a simple page that takes two parameters: latitude and longitude. It then queries the Twitter REST API 1.1 as defined in <a class="ulink" href="https://dev.twitter.com/docs/api/1.1">https://dev.twitter.com/docs/api/1.1</a>. It returns JSON data containing tweets originating from within 0.25 miles from the specified latitude and longitude.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec79"/>Capturing geocodes</h1></div></div></div><a id="id592" class="indexterm"/><p>Now that we have a place to get data, we will need to capture the latitude and longitude of each theater to send to our new endpoint. In <code class="literal">movienow.geolocation.js</code>, we will make a minor modification. In the <code class="literal">displayShowtimes</code> method, we will need to adjust where the theater name is displayed. Specifically, we will need to input the latitude and longitude and add them to a new <code class="literal">data</code> attribute. This allows us to use this data later on.</p><p>Change the following line:</p><div><pre class="programlisting">movieHTML+='&lt;p class="theater"&gt;'+movie.theater.title+" "+movie.theater.address+'&lt;/p&gt;';</pre></div><p>Change it to:</p><div><pre class="programlisting">movieHTML+='&lt;p class="theater" <strong>data-location= "'+movie.theater.latitude+','+movie.theater.longitude+'"</strong>&gt;'+movie.theater.title+" "+movie.theater.address+'&lt;/p&gt;';</pre></div><a id="id593" class="indexterm"/><p>Next, we will create a new JavaScript file called <code class="literal">movienow.nearbytweets.js</code> in the <code class="literal">js</code> folder. In <code class="literal">index.php</code>, we will add a reference to the new JavaScript file:</p><div><pre class="programlisting">&lt;script src="img/ios-orientationchange-fix.js"&gt;&lt;/script&gt;
&lt;script src="img/jquery-1.8.0.min.js"&gt;&lt;/script&gt;
&lt;script src="img/jquery.xdomainajax.js"&gt;&lt;/script&gt;
&lt;script src="img/three.js"&gt;&lt;/script&gt;
<strong>&lt;script src="img/movienow.nearbytweets.js"&gt;&lt;/script&gt;</strong>
&lt;script src="img/movienow.tweet.js"&gt;&lt;/script&gt;
&lt;script src="img/movienow.draganddrop.js"&gt;&lt;/script&gt;
&lt;script src="img/movienow.charts.js"&gt;&lt;/script&gt;
&lt;script src="img/movienow.geolocation.js"&gt;&lt;/script&gt;
&lt;script src="img/movienow.js"&gt;&lt;/script&gt;</pre></div><p>In <code class="literal">movienow.nearbytweets.js</code>, we will start with some boilerplate code. Add the following to set up the <code class="literal">nearbytweets</code> namespace within <code class="literal">movienow</code>:</p><div><pre class="programlisting">var movienow = movienow || {};
movienow.nearbytweets = (function(){
  var that = this;
})();</pre></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec80"/>Anatomy of a Web Worker</h1></div></div></div><a id="id594" class="indexterm"/><p>To really understand Web Workers, imagine a work-at-home business where households are sent packages of promotions and envelopes. Each household is to stuff the envelopes with the promotional literature, seal the envelopes, and send them as a parcel back to the originating business. The work-at-home households know nothing about the internals of the business. They merely know they are given a parcel, they must do something with the parcel, and they must return the parcel.</p><a id="id595" class="indexterm"/><p>Web Workers run in an isolated thread wherein they know nothing about the state of the page that invokes them. They are simply sent a message, they do something with that message, and then return a message. The calling procedure specifies an event listener that responds when a message is returned by a Web Worker.</p><p>There are two types of Web Workers. They are:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Dedicated Web Workers</strong>: They are sometimes referred to as just Web Workers. They are only reachable by the script that created them, although message ports can be used to communicate with other contexts.<a id="id596" class="indexterm"/> </li><li class="listitem" style="list-style-type: disc"><strong>Shared Web Workers</strong>: They are named and share a global scope, so any script running in the same origin can obtain a reference of this kind of worker.<a id="id597" class="indexterm"/></li></ul></div><p>In this case, we will use Dedicated Web Workers. Web Workers are typically defined in a separate JavaScript file. To create a Web Worker, you simply need to instantiate it:</p><div><pre class="programlisting">var worker = new Worker('mywebworker.js');</pre></div><p>Once created, you can communicate with a Web Worker by using the <code class="literal">postMessage</code> method:</p><div><pre class="programlisting">worker.postMessage('Hi worker!');</pre></div><p>To receive communications back from the Web Worker, simply define an event listener that triggers based on the <code class="literal">onmessage</code> event:</p><div><pre class="programlisting">worker.addEventListener('message', function(e) {
  console.log(e.data);
}, false);</pre></div><p>The Web Worker can then be defined as follows:</p><div><pre class="programlisting">self.addEventListener('message', function(e) {
  self.postMessage(e.data);
}, false);</pre></div><p>It basically has an event listener defined for incoming messages. As messages arrive, it executes the function attached to the message event and returns it by using the <code class="literal">postMessage</code> method in much the same way it was invoked. The event listener on the client side is invoked and everyone goes on their merry way.</p><p>If an error does occur in a Web Worker, the exception can be handled by listening to the error event on the Web Worker:</p><div><pre class="programlisting">worker.addEventListener('error', function(e) {
  console.log(e.message);
}, false);</pre></div><p>It is important to note that the Web Worker exists in a sandbox. It is not accessing the state of the page at all. Instead, anything it receives will always be a copy of what was sent. Event referenced JavaScript libraries are not available. In fact, the DOM, the <code class="literal">window</code>, the <code class="literal">document</code>, and the <code class="literal">parent</code> objects are unavailable, so you cannot do any manipulation of or reading from the DOM or make use of the <code class="literal">window</code> object in a Web Worker. You are a completely separate household.</p><a id="id598" class="indexterm"/><p>You can however use the <code class="literal">navigator</code> object, make use of the <code class="literal">XMLHttpRequest</code> object, and spawn other Web Workers. </p><div><div><h3 class="title"><a id="tip61"/>Tip</h3><p>Nested workers must be hosted within the same origin as the parent document. Moreover, the URIs for nested workers are resolved relative to the parent worker's location rather than the owning document.</p></div></div><p>You can also import scripts using the <code class="literal">importScripts</code> method as well as use <code class="literal">setTimeout</code> and <code class="literal">setInterval</code>. </p></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec81"/>Using Web Workers to get nearby tweets</h1></div></div></div><a id="id599" class="indexterm"/><p>In <code class="literal">movienow.nearbytweets.js</code>, we are going to define a couple of methods. First of all, let us define an entry point method for getting tweets:</p><div><pre class="programlisting">this.getTweets = function() {};</pre></div><p>Once we have added this, we can invoke it from <code class="literal">movienow.geolocation.js</code> at the very end of the <code class="literal">displayShowtimes</code> method:</p><div><pre class="programlisting">  $("#movies-near-me li .charting-button").click(that.showCharts);
  init();
  <strong>getTweets();</strong>
};</pre></div><p>So far, so good, but we are not doing anything yet. Let us add a new method to <code class="literal">movienow.nearbytweets.js</code> called <code class="literal">getTweetsByTheater</code>:</p><div><pre class="programlisting">this.getTweetsByTheater = function(theater) {};</pre></div><p>The new <code class="literal">getTweetsByTheater</code> method will take a "theater" element and get tweets for it. What we mean by a "theater" element in this case is a <code class="literal">div</code> tag of the <code class="literal">theater</code> class as defined in <code class="literal">movienow.geolocation.js</code>. We will then invoke it from the <code class="literal">getTweets</code> method using a simple jQuery call. Augment <code class="literal">getTweets</code> as follows:</p><div><pre class="programlisting">this.getTweets = function() {
  $('.theater').each(function() {
    that.getTweetsByTheater(this);
  });
};</pre></div><a id="id600" class="indexterm"/><p>Now onto the meat of our script. We will instantiate our Web Worker. Let us start by adding a skeleton of the Web Worker mechanism. Add the following to the <code class="literal">getTweetsByTheater</code> method<a id="id601" class="indexterm"/>:</p><div><pre class="programlisting">var worker = new Worker('js/movienow.worker.js');
worker.addEventListener('message', function(e) {
}, false);
worker.postMessage();</pre></div><p>To finish out the skeleton, we will add a new JavaScript file called <code class="literal">movienow.worker.js</code> to the <code class="literal">js</code> folder. Add the following code snippet to it:</p><div><pre class="programlisting">self.addEventListener('message', function(e) {
}, false);</pre></div><p>Now that we have our initial skeleton of the Web Worker set, let us extract the geocode from the theater object passed into <code class="literal">getTweetsByTheater</code> and pass it along to the Web Worker. We will take the <code class="literal">data-location</code> attribute we added earlier in <code class="literal">movienow.geolocation.js</code> and parse out the latitude and longitude. Replace the skeleton <code class="literal">worker.postMessage()</code> invocation with the following code:</p><div><pre class="programlisting">var geocode = $(theater).attr('data-location');
var latitude = geocode.split(',')[0];
var longitude = geocode.split(',')[1];
worker.postMessage({
  'latitude': latitude,
  'longitude': longitude 
});</pre></div><p>Now that we are passing the latitude and longitude to the Web Worker, let us update it to invoke the service we implemented at the beginning of this chapter. Add the following to the body of the event listener in <code class="literal">movienow.worker.js</code>:</p><div><pre class="programlisting">var url = '../nearbytweets.php';
var data = 'latitude='+e.data.latitude+'&amp;longitude='+e.data.longitude;
var xhr = new XMLHttpRequest();
xhr.open('GET', url + '?' + data, true);
xhr.send(null);
xhr.onreadystatechange = function() {
  if (xhr.readyState == 4) {
    if (xhr.status == 200 || xhr.status ==0) {
      self.postMessage(xhr.responseText);
    } else {
      throw xhr.status + xhr.responseText;
    }
  } 
}</pre></div><a id="id602" class="indexterm"/><p>Notice that we are using <code class="literal">XMLHttpRequest</code>. Normally, we would use the jQuery <code class="literal">ajax</code> method to make such a call. However, since jQuery has dependencies on the DOM and—as you may recall—the DOM is not available in this context, we cannot use it here. Instead, we will have to invoke the object directly and make the request. Once the AJAX request is made and the <code class="literal">onreadystatechange</code> event<a id="id603" class="indexterm"/> is triggered, the payload is passed back to the client via <code class="literal">self.postMessage()</code>.</p><p>The complete <code class="literal">movienow.worker.js</code> code should look similar to the following code snippet:</p><div><pre class="programlisting">self.addEventListener('message', function(e) {
  var url = '../nearbytweets.php';
  var data = 'latitude='+e.data.latitude+'&amp;longitude='+e.data.longitude;
  var xhr = new XMLHttpRequest();
  xhr.open('GET', url + '?' + data, true);
  xhr.send(null);
  xhr.onreadystatechange = function() {
    if (xhr.readyState == 4) {
      if (xhr.status == 200 || xhr.status ==0) {
        self.postMessage(xhr.responseText);
      } else {
        throw xhr.status + xhr.responseText;
      }
    } 
  }
}, false);</pre></div><div><div><h3 class="title"><a id="tip62"/>Tip</h3><p>It is possible to implement Web Workers without creating a separate worker file. You can check out a tutorial on implementing this technique at the following location: <a class="ulink" href="http://www.html5rocks.com/en/tutorials/workers/basics/#toc-inlineworkers">http://www.html5rocks.com/en/tutorials/workers/basics/#toc-inlineworkers</a>
</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec82"/>Updating the event listener</h1></div></div></div><a id="id604" class="indexterm"/><a id="id605" class="indexterm"/><p>Going back to <code class="literal">movienow.nearbytweets.js</code>, we can update the event listener to take the JSON object returned from the Web Worker. If you look at the following code that we will add to the event listener body, you will see that we get the returned data and loop through the result set to capture the text of each tweet:</p><div><pre class="programlisting">var data = objectifyJSON(e.data);
var nearbyTweets = '';
for (var i=0; i&lt;data.results.length; i++) {
  nearbyTweets += '&lt;li&gt;'+data.results[i].text+'&lt;/li&gt;';
}
var tweetCounter = (data.results.length==1) ? data.results.length+" tweet" : data.results.length+" tweets";
$(theater)
  .append(' &lt;span class="tweet-count"&gt;('+ tweetCounter +')&lt;/span&gt;')
  .parents('li').append('&lt;section class="nearby-tweets"&gt;&lt;h3&gt;Nearby Tweets&lt;/h3&gt;&lt;ul&gt;'+nearbyTweets+'&lt;/ul&gt;&lt;/section&gt;')
  .find('.tweet-count').click(that.showNearbyTweets)
  .parents('li').find('.nearby-tweets').click(that.hideNearbyTweets);</pre></div><div><div><h3 class="title"><a id="note25"/>Note</h3><p>Remember that we defined the <a id="id606" class="indexterm"/>
<code class="literal">objectifyJSON</code> function in previous chapters inside <code class="literal">movienow.geolocation.js</code>. It returns the same input if the parameter passed is an object and parses the content and returns an object if it is a string.</p></div></div><p>Here we are doing two things. First, we are appending a tweet count to the theater name (notice that we verify the number of tweets to add a singular <strong>tweet</strong> or plural <strong>tweets</strong> label). Secondly, we are adding a <code class="literal">section</code> element <a id="id607" class="indexterm"/>
<a id="id608" class="indexterm"/>containing an unordered list of tweets. The target behavior is that we click on the tweet count and display the tweets. In addition, we will need to add two more methods to the <code class="literal">nearbytweets</code> object to show and hide the tweets:</p><div><pre class="programlisting">this.showNearbyTweets = function(event) {
  $(event.target).parents('li').addClass('nearby-tweets').addClass('open');
};
this.hideNearbyTweets = function(event) {
  $(this).parents('li').removeClass('open');
};</pre></div><p>The complete <code class="literal">movienow.nearbytweets.js</code> code should look like the following: <a id="id609" class="indexterm"/>
<a id="id610" class="indexterm"/>
</p><div><pre class="programlisting">movienow.nearbytweets = (function(){
    var that = this;
    this.getTweets = function() {
      $('.theater').each(function() {
        that.getTweetsByTheater(this);
      });
    };
  this.showNearbyTweets = function(event) {
    $(event.target).parents('li').addClass('nearby-tweets').addClass('open');
  };
  this.hideNearbyTweets = function(event) {
    $(this).parents('li').removeClass('open');
  };
    this.getTweetsByTheater = function(theater) {
      var worker = new Worker('js/movienow.worker.js');
    worker.addEventListener('message', function(e) {
      var data = objectifyJSON(e.data);
      var nearbyTweets = '';
      for (var i=0; i&lt;data.results.length; i++) {
        nearbyTweets += '&lt;li&gt;'+data.results[i].text+'&lt;/li&gt;';
      }
      var tweetCounter = (data.results.length==1) ? data.results.length+" tweet" : data.results.length+" tweets";
        $(theater)
        .append(' &lt;span class="tweet-count"&gt;('+ tweetCounter +')&lt;/span&gt;')
        .parents('li').append('&lt;section class="nearby-tweets"&gt;&lt;h3&gt;Nearby Tweets&lt;/h3&gt;&lt;ul&gt;'+nearbyTweets+'&lt;/ul&gt;&lt;/section&gt;')
        .find('.tweet-count').click(that.showNearbyTweets)
        .parents('li').find('.nearby-tweets').click(that.hideNearbyTweets);
    }, false);
    var geocode = $(theater).attr('data-location');
    var latitude = geocode.split(',')[0];
    var longitude = geocode.split(',')[1];
    worker.postMessage({
      'latitude': latitude,
      'longitude': longitude 
    });
    };
})();</pre></div><p>Before we go on, we need to make one more modification to <code class="literal">movienow.geolocation.js</code>. Because we are mimicking the same behavior as the info and ratings buttons, we will need to make sure we are hiding and showing these in conjunction with the nearby tweets section.</p><p>Change the <code class="literal">showCharts</code> method by changing the following line:</p><div><pre class="programlisting">that.charts($(event.target).parent().parent().removeClass("desc").addClass("open").find("canvas")[0], "3DChart");</pre></div><a id="id611" class="indexterm"/><a id="id612" class="indexterm"/><p>We will change it to:</p><div><pre class="programlisting">that.charts($(event.target).parent().parent().removeClass("desc").addClass("open").removeClass('nearby-tweets').find("canvas")[0], "3DChart");</pre></div><p>Change the <code class="literal">showDetails</code> method <a id="id613" class="indexterm"/>by changing the following line:</p><div><pre class="programlisting">$(event.target).parent().parent().addClass("desc").addClass("open");</pre></div><p>Change it to:</p><div><pre class="programlisting">$(event.target).parent().parent().addClass("desc").addClass("open").removeClass('nearby-tweets');</pre></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec83"/>Styling the tweets</h1></div></div></div><a id="id614" class="indexterm"/><p>Now that the mechanics are set up for retrieving and loading nearby tweets, we will need to add some styles to make everything look complete. First, we will need to add the same treatment for the new nearby-tweets section as we have for the description and charting sections. We will do this by modifying the following lines in <code class="literal">styles.css</code>.</p><p>Look for the following line:</p><div><pre class="programlisting">#movies-near-me li,#movies-near-me li section.main-info,#movies-near-me li section.description,#movies-near-me li section.charting{</pre></div><p>Change it by adding a selector for <code class="literal">nearby-tweets</code>:<a id="id615" class="indexterm"/>
</p><div><pre class="programlisting">#movies-near-me li,#movies-near-me li section.main-info,#movies-near-me li section.description,#movies-near-me li section.charting,#movies-near-me li section.nearby-tweets{</pre></div><p>Likewise, look for the following line:</p><div><pre class="programlisting">#movies-near-me li section.description,#movies-near-me li section.charting{</pre></div><p>Change it by adding a selector for <code class="literal">nearby-tweets</code>:</p><div><pre class="programlisting">#movies-near-me li section.description,#movies-near-me li section.charting,#movies-near-me li section.nearby-tweets{</pre></div><a id="id616" class="indexterm"/><p>Now add the following code to <code class="literal">styles.css</code>:</p><div><pre class="programlisting">.tweet-count {
  cursor:pointer;
  color:#0000cd;
}
#movies-near-me li section.nearby-tweets,#movies-near-me li.nearby-tweets section.description,#movies-near-me li.nearby-tweets section.charting {
  display:none;
}
#movies-near-me li.nearby-tweets section.nearby-tweets {
  display:block;
}
#movies-near-me li section.nearby-tweets {
  overflow:scroll;
  padding-left:10px;
}
#movies-near-me li section.nearby-tweets h3 {
  padding: 10px 0 3px 0;
}
#movies-near-me li section.nearby-tweets li {
  height:auto;
  border:0;
  margin-bottom:10px;
}</pre></div><p>With the styles in place, we can test out our behavior by previewing our changes. You should see the following when the data loads:</p><div><img src="img/5689_10_01.jpg" alt="Styling the tweets"/></div><a id="id617" class="indexterm"/><p>Notice <strong>(18 tweets)</strong> next to the theater name. It is the result of the Web Worker's efforts. If you click on it, you should see the following:</p><div><img src="img/5689_10_02.jpg" alt="Styling the tweets"/></div><p>If all goes well, the nearby tweets section should open, revealing the latest tweets that were posted near the theater's location.</p></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec84"/>Summary</h1></div></div></div><p>We walked through the anatomy of a Web Worker, how to set one up, and how it can be used to solve problems without disaffecting the user experience. Although a contrived example, we stepped through how to use Web Workers to get tweets near a theater based on its geocode.</p><p>Some real world use cases for Web Workers include:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Processor-intensive calculations that should not block the general enterprise application flow</li><li class="listitem" style="list-style-type: disc">Auto-correction and syntax highlighting</li><li class="listitem" style="list-style-type: disc">Posting images to a message queue</li><li class="listitem" style="list-style-type: disc">Consuming data in parallel using concurrent AJAX requests</li></ul></div><p>In the next chapter, we will walk through debugging applications. We will cover tools available at our disposal to get under the hood and figure out what is happening in our enterprise applications. We will also cover some powerful techniques using proxies to sniff out problems as they occur.</p></div></body></html>