<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Building Interactive Projects with RGB LED</h1>
                </header>
            
            <article>
                
<p>Now that we've<span> </span><span> built a project with Johnny-Five and Raspi-IO, it's time to tackle GPIO expanders and PWM outputs, and build an interactive project with an RGB LED. We'll also learn more about the Johnny-Five REPL, learn how a PWM pin works, and use this knowledge to control an RGB LED from the command line.</span></p>
<p><span>The following topics will be covered in this chapter:</span></p>
<ul>
<li>Looking at the LED and LED.RGB API</li>
<li>PWM pins and GPIO expanders</li>
<li>Bringing in other node packages with color</li>
<li>The Johnny-Five REPL</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>You will have <span>already</span><span> </span><span>installed</span><span> </span><span>all the software prerequisites for this chapter from </span><a href="bab2feb9-9667-4f8b-bb2e-1702009b87b4.xhtml" target="_blank">Chapter 1</a><span>,</span> <em>Setting Up Your Development Environment</em><span>. You'll want to make sure your Raspberry Pi is connected to the internet and that you have SSHed in using your method of choice.</span></p>
<div class="packt_infobox">The example code for this chapter can be found at <a href="https://github.com/nodebotanist/hands-on-robotics-with-javascript/tree/master/ch3">https://github.com/nodebotanist/hands-on-robotics-with-javascript/tree/master/ch3</a>.</div>
<p>As for hardware, you will need the following:</p>
<ul>
<li>Your Raspberry Pi</li>
<li>Cobbler/breadboard</li>
<li>Breadboard wires</li>
<li>PCA9685 GPIO expander board</li>
<li>RGB LED</li>
<li>330-ohm resistor x 3</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Looking at the LED and LED.RGB API</h1>
                </header>
            
            <article>
                
<p>We took a brief look at the LED API in Johnny-Five in the last chapter, but in this chapter, we will delve deeper and talk about the PWM output and the cousin of the standard LED, the RGB LED—so named because it has a red, green, and blue channel, and can replicate thousands of colors. We will use an RGB LED, as well as some of the more powerful tools built into Johnny-Five, to build an interactive project in this chapter.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The LED object</h1>
                </header>
            
            <article>
                
<p>The LED object is usually the first thing in Johnny-Five that people look through the documentation for. It's also a great object to use to outline the general structure of the object documentation. Let's take a look at each section and get a grasp of where we should look for what later:</p>
<ul>
<li><strong>Parameters</strong>: This section addresses the parameters that need to be passed into the object constructor, and what form they need to be in (order, object key, and so on).</li>
<li><strong>Shapes</strong>: These are the fields attached to the constructed object that may be useful to the user in writing their code. They can be read-only, and are marked if this is the case.</li>
<li><strong>Component Initialization</strong>: This is usually a piece of sample code, but it's always a description of how to construct a common usage of the object in question. If there are multiple controllers for a specific component, they are enumerated with examples for each controller. This will come in handy for our GPIO expander board.</li>
<li><strong>Usage</strong>: This is a sample code denoting how to use the most basic functions of an object; for the LED, this is the <kbd>blink</kbd> function, and for sensors, this would show the function that you would usually use to get readings from the sensor.</li>
<li><strong>API</strong>: This is a full documentation of every function available to the object, including the parameters and intended result.</li>
<li><strong>Events</strong>: Many objects emit events (such as the board's <kbd>ready</kbd> event); this section details when they will fire.</li>
<li><strong>Examples</strong>: The Johnny-Five community is a fantastic source of examples, and the examples that are relevant to the object in question will be cataloged and linked in this section.</li>
</ul>
<p>Take a moment to get used to the LED documentation (<a href="http://johnny-five.io/api/led/">http://johnny-five.io/api/led/</a>), because the <kbd>Led.RGB</kbd> object is essentially a subclass of the LED object, and will inherit many of its functions.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The Led.RGB object</h1>
                </header>
            
            <article>
                
<p>Once you've acquainted yourself with the LED object, click on the <span class="packt_screen">Led.RGB</span> link in the sidebar, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-346 image-border" src="assets/383b380c-eff2-4b96-9fea-2c2d72c4aa25.png" style="width:16.67em;height:13.00em;"/></p>
<p>You'll be taken to the Led.RGB documentation page. In the <em>Component Initialization</em> section, look for the <em>LED RGB PCA9685</em> section. Ignore the wiring diagram (it's for the Tessel 2, a different microcontroller), but do make a note of the example code, as shown here:</p>
<pre><span class="hljs-keyword">new</span><span> five.Led.RGB({<br/>   controller: </span><span class="hljs-string">"PCA9685"</span><span>,<br/>   pins: {<br/>     red: </span><span class="hljs-number">2</span><span>,<br/>     green: </span><span class="hljs-number">1</span><span>,<br/>     blue: </span><span class="hljs-number">0<br/></span><span>   }<br/>});</span></pre>
<p>This is the code that we will use to initialize our <kbd>RGB.LED</kbd> object.</p>
<p>We will also need the API section in order to determine the functions and parameters that we will need for using the <kbd>RGB.LED</kbd> object. Take a look at the <kbd>color()</kbd> function, in particular. </p>
<p><span><span>Now that we have our module for converting colors into RGB values, we can start talking about how to use an RGB LED in order to get those colors into our projects.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">PWM pins and GPIO expanders</h1>
                </header>
            
            <article>
                
<p>Before we wire up and run our RGB LED project, a discussion about PWM pins and GPIO expanders is warranted, because these are topics that will affect most Johnny-Five projects that you will complete.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How do PWM pins work?</h1>
                </header>
            
            <article>
                
<p>You don't always want an LED to at its full brightness, especially in the case of RGB LEDs, where the brightness of each channel (red, green, and blue) determines the perceived color of the LED. The pins on most microcontrollers are digital: they are either HIGH at 5V or LOW at 0V. So how do you adjust the brightness of an LED with these types of pins? The answer involves the idea of average voltage and the speed at which we can flip a digital pin from HIGH to LOW. </p>
<p>Pulse-width modulation, or PWM, pins operate by setting, effectively, the percentage of time that a pin is HIGH and LOW. The following screenshot shows an oscilloscope reading for the state of a pin running at 50% over a short period of time:</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<p class="mceNonEditable"/>
<p class="CDPAlignCenter CDPAlign"><img src="assets/ecb4a571-2d64-46e8-bbd3-406e66ee51bb.png"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">Oscilloscope reading for a 50% PWM pin</div>
<p>Instead of the LED flickering on and off, this results in the LED appearing to glow at half-brightness: this is because the human eye cannot keep up with the speed of the state changes, and sees the LED as on, but dimmed. This helps us to use RGB LEDs to create thousands of different colors by combining a red, green, and blue channel at varying degrees of brightness.</p>
<p>When we set the colors in our Johnny-Five code, we can pass values from <kbd>0</kbd> to <kbd>255</kbd> for red, green, and blue. This works well with web hex colors, which use the same range. In general, you can set a PWM pin from <kbd>0</kbd> to <kbd>255</kbd> (with some exceptions outside the scope of this book).</p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Why we need a GPIO expander</h1>
                </header>
            
            <article>
                
<p>So why do we need a GPIO expander right off the bat, when the Raspberry Pi has so many GPIO pins? This is because PWM pins require computing resources and timers, and many microcontrollers have a limited number of hardware PWM pins. You can emulate PWM pins with software, but the results tend to be on the unreliable side. The Arduino Uno, for example, has eight PWM pins. The Raspberry Pi has only one GPIO pin, and many projects (including the servo and motor projects included later in this book) will require many more than one, and we do not want to use software PWM. </p>
<p>This is why we are using the PCA9685 GPIO expander: it has <span>16</span><span> </span><span>dedicated PWM pins and provides all the resources to run them. It communicates with the Raspberry Pi using a protocol called I<sup>2</sup>C (pronounced <em>eye-squared-see</em>), the details of which are outside the scope of this book, and are abstracted away in the Johnny-Five component object. See the</span> <em>Further reading</em> section <span>if you'd like to learn more about how I<sup>2</sup>C works.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Wiring up our GPIO expander and RGB LED</h1>
                </header>
            
            <article>
                
<p>First, you'll want to wire the PCA9685 breakout to your PI: GND to GND, VCC to 5V, SDA to SDA, and SCL to SCL. Next, wire a second GND pin from the cobbler to one of the ground lines on the side of the breadboard. Next, our LED: the long leg wires to ground. The leg by itself on one side of the long leg is the red channel; wire that to the 0 column PWM row pin on the PCA9685 board. Green and blue are on the other side; wire them to PWM-1 and PWM-2, respectively. Once this is all done, your project should look similar to the following:</p>
<p class="mce-root"/>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-163 image-border" src="assets/60cc32c2-5331-481e-b60d-5ddad2c72b00.png" style="width:82.67em;height:42.08em;"/></p>
<div class="packt_figref CDPAlignCenter CDPAlign">The finished wiring for this chapter's project</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Bringing in other node packages</h1>
                </header>
            
            <article>
                
<p>Node.js prides itself on creating small, bordering on tiny, packages, and has the excellent npm package manager (and others) to help manage those packages. Because the Raspberry Pi runs a full version of Node.js, we can leverage that to our advantage and bring in other packages in order to build more interesting projects.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Project – building a rainbow</h1>
                </header>
            
            <article>
                
<p>Can you remember the RGB code for orange off the top of your head? I can't. It's easier to remember to convert the color systems we do know into RGB (especially names such as red, orange, and cornflower blue). But instead of building a function to convert it for us, we'll leverage what I call Stilwell's law: <em>if you've thought of it, it's probably on npm already</em>. True to form, the color module is going to help us out.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Using the color npm module</h1>
                </header>
            
            <article>
                
<p>In order to use the <kbd>color npm</kbd> module, first we will install it. In your SSH session, in your <kbd>project</kbd> folder, run the following code:</p>
<pre><strong>npm i --save color</strong></pre>
<p>This will also save the color package to your <kbd>package.json</kbd> for code portability purposes. The module exports a function, which we will use to convert color strings like <kbd>red</kbd> or <kbd>#FF0000</kbd> to an array of integers representing <kbd>red</kbd>, <kbd>green</kbd>, and <kbd>blue</kbd>. We will use these values to set our RGB LED. This is shown in the following example:</p>
<pre>const Color = require('color')<br/><br/>let ledColor = Color('orange')<br/>let ledRed = ledColor.red()<br/>let ledGreen = ledColor.green()<br/>let ledBlue = ledColor.blue()</pre>
<p>We'll use this to help set the color of our RGB LED in our Johnny-Five program.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting our Johnny-Five code started</h1>
                </header>
            
            <article>
                
<p>Let's pull together what we've learned about the <kbd>Led.RGB</kbd> object and the color npm module to pull together a basic code project that we will call <kbd>rgb-led-rainbow.js</kbd>:</p>
<div>
<pre><span>const</span><span> </span><span>Raspi</span><span> </span><span>=</span><span> </span><span>require</span><span>(</span><span>'raspi-io'</span><span>)<br/></span><span>const</span><span> </span><span>five</span><span> </span><span>=</span><span> </span><span>require</span><span>(</span><span>'johnny-five'</span><span>)<br/></span><span>const</span><span> </span><span>color</span><span> </span><span>=</span><span> </span><span>require</span><span>(</span><span>'color'</span><span>)<br/></span><span><br/>const</span><span> </span><span>board</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>five</span><span>.</span><span>Board</span><span>({<br/></span><span> </span><span>io:</span><span> </span><span>new</span><span> </span><span>Raspi</span><span>()<br/></span><span>})<br/><br/></span><span>board</span><span>.</span><span>on</span><span>(</span><span>'ready'</span><span>, () </span><span>=&gt;</span><span> {<br/></span><span>  </span><span>let</span><span> </span><span>rgbLED</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>five</span><span>.</span><span>Led</span><span>.</span><span>RGB</span><span>({<br/></span><span>  </span><span>controller:</span><span> </span><span>"PCA9685"</span><span>,<br/></span><span>  </span><span>pins:</span><span> {<br/></span><span>    </span><span>red:</span><span> </span><span>0</span><span>,<br/></span><span>    </span><span>green:</span><span> </span><span>1</span><span>,<br/></span><span>    </span><span>blue:</span><span> </span><span>2<br/></span><span>  }<br/></span><span>  });<br/></span><span> <br/>  </span><span>let</span><span> </span><span>colors</span><span> </span><span>=</span><span> [</span><span>'red'</span><span>, </span><span>'orange'</span><span>, </span><span>'yellow'</span><span>, </span><span>'green'</span><span>, </span><span>'blue'</span><span>, </span><span>'rebeccapurple'</span><span>]<br/></span><span>  </span><span>let</span><span> </span><span>colorIndex</span><span> </span><span>=</span><span> </span><span>0<br/></span><span>  </span><span>let</span><span> </span><span>currentColor<br/></span><span><br/>  </span><span>setTimeout</span><span>(() </span><span>=&gt;</span><span> {<br/></span><span>    </span><span>currentColor</span><span> </span><span>=</span><span> </span><span>color</span><span>(</span><span>colors</span><span>[</span><span>colorIndex</span><span>])<br/></span><span>    </span><span>rgbLED</span><span>.</span><span>color</span><span>([</span><span>currentColor</span><span>.</span><span>red</span><span>(), </span><span>currentColor</span><span>.</span><span>green</span><span>(), </span><span>currentColor</span><span>.</span><span>blue</span><span>()])<br/></span><span>    </span><span>colorIndex</span><span>++<br/></span><span>    if</span><span>(</span><span>colorIndex</span><span> </span><span>&gt;=</span><span> </span><span>colors</span><span>.</span><span>length</span><span>) {<br/></span><span>      colorIndex</span><span> </span><span>=</span><span> </span><span>0<br/></span><span>    }<br/></span><span>  }, </span><span>1000</span><span>)<br/></span><span>})</span></pre>
<p>This code cycles through the colors in the <kbd>colors</kbd> array and, once per second, sets the RGB LED's color and moves forward, generating a rainbow.</p>
</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The REPL – a powerful tool in Johnny-Five</h1>
                </header>
            
            <article>
                
<p><span>Debugging our LED can be tricky. Without rewiring things, how can we tell if our green and blue channels are flipped, or if the red is far brighter than the other channels? One tool that is very helpful for debugging Johnny-Five projects is the <strong>Read–Eval–Print Loop</strong> (<strong>REPL</strong>).</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How does the REPL work?</h1>
                </header>
            
            <article>
                
<p>If you have worked with Node.js, Python, or a few other interpreted languages in the past, the REPL may not be new to you. It allows you to write statements into the CLI at runtime to generate results straight from the language engine. This can be very helpful when debugging code, as you can get a glimpse into and modify the state of code at runtime. This is also true in Johnny-Five: the REPL allows us to insert Johnny-Five objects, so we can look at manipulating them at runtime. We're going to use this to play with our RGB LED and control it from the command line.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Adding our RGB LED to the REPL</h1>
                </header>
            
            <article>
                
<p>Take a look at the Johnny-Five documentation for the REPL; it's in the <kbd>Board</kbd> component section of the API. What matters to us is <kbd>this.repl.inject()</kbd>, which takes an object and makes any property of that object accessible from the CLI. Let's modify our code to make use of the REPL by making the <kbd>rainbow</kbd> function check for a Boolean before setting the LED, and adding that Boolean and the RGB LED component object to the CLI:</p>
<pre><span>const</span><span> </span><span>Raspi</span><span> </span><span>=</span><span> </span><span>require</span><span>(</span><span>'raspi-io'</span><span>)<br/></span><span>const</span><span> </span><span>five</span><span> </span><span>=</span><span> </span><span>require</span><span>(</span><span>'johnny-five'</span><span>)<br/></span><span>const</span><span> </span><span>color</span><span> </span><span>=</span><span> </span><span>require</span><span>(</span><span>'color'</span><span>)<br/></span><span><br/>const</span><span> </span><span>board</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>five</span><span>.</span><span>Board</span><span>({<br/></span><span> </span><span>io:</span><span> </span><span>new</span><span> </span><span>Raspi</span><span>()<br/></span><span>})<br/><br/></span><span>board</span><span>.</span><span>on</span><span>(</span><span>'ready'</span><span>, () </span><span>=&gt;</span><span> {<br/></span><span>  </span><span>let</span><span> </span><span>rgbLED</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>five</span><span>.</span><span>Led</span><span>.</span><span>RGB</span><span>({<br/></span><span>  </span><span>controller:</span><span> </span><span>"PCA9685"</span><span>,<br/></span><span>  </span><span>pins:</span><span> {<br/></span><span>    </span><span>red:</span><span> </span><span>0</span><span>,<br/></span><span>    </span><span>green:</span><span> </span><span>1</span><span>,<br/></span><span>    </span><span>blue:</span><span> </span><span>2<br/></span><span>  }<br/></span><span>  });<br/></span><span><br/>  </span><span>let</span><span> </span><span>colors</span><span> </span><span>=</span><span> [</span><span>'red'</span><span>, </span><span>'orange'</span><span>, </span><span>'yellow'</span><span>, </span><span>'green'</span><span>, </span><span>'blue'</span><span>, </span><span>'rebeccapurple'</span><span>]<br/></span><span>  </span><span>let</span><span> </span><span>colorIndex</span><span> </span><span>=</span><span> </span><span>0<br/></span><span>  </span><span>let</span><span> </span><span>currentColor<br/></span><span>  let rainbowCycle = true<br/><br/>  </span><span>setTInterval</span><span>(() </span><span>=&gt;</span><span> {<br/>    if(rainbowCycle) {<br/></span><span>      </span><span>currentColor</span><span> </span><span>=</span><span> </span><span>color</span><span>(</span><span>colors</span><span>[</span><span>colorIndex</span><span>])<br/></span><span>      </span><span>rgbLED</span><span>.</span><span>color</span><span>([</span><span>currentColor</span><span>.</span><span>red</span><span>(), </span><span>currentColor</span><span>.</span><span>green</span><span>(), </span><span>currentColor</span><span>.</span><span>blue</span><span>()])<br/></span><span>      </span><span>colorIndex</span><span>++<br/></span><span>      if</span><span>(</span><span>colorIndex</span><span> </span><span>&gt;=</span><span> </span><span>colors</span><span>.</span><span>length</span><span>) {<br/></span><span>        colorIndex</span><span> </span><span>=</span><span> </span><span>0<br/></span><span>      }<br/>    }<br/></span><span>  }, </span><span>1000</span><span>)<br/><br/>  this.repl.inject({<br/>    rainbowCycle,<br/>    rgbLED,<br/>    color<br/>   })<br/></span><span>})</span></pre>
<p>Now, we have access to the LED and the Boolean that controls the rainbow cycle from the command-line REPL supplied to us by Johnny-Five when we run this code on our Raspberry Pi.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Controlling our LED from the command-line interface</h1>
                </header>
            
            <article>
                
<p>Move the code over to your Raspberry Pi, and in your SSH session, navigate to your <kbd>project</kbd> folder using <kbd>cd</kbd> and run your project (be sure to use <kbd>sudo</kbd>!):</p>
<pre><strong>sudo node rgb-led-repl.js</strong></pre>
<p>Then, you can manipulate the RGB LED and the color library to change the light's color. Here are a few things to try:</p>
<pre><strong>&gt;&gt; rainbowCycle = false // this stops the rainbow color cycle</strong><br/><strong>&gt;&gt; rgbLED.off() // turns the RGB LED off</strong><br/><strong>&gt;&gt; rgbLED.color(color('rebeccapurple').rgb().array()) // sets the LED purple!</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, you created your first interactive project with the Raspberry Pi and Johnny-Five! We started by exploring the LED and LED.RGB APIs, then explored the power that running in Node.js gives us by allowing us to use <kbd>npm</kbd> modules, and then we brought it all together with the REPL!</p>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<ol>
<li>What does PWM stand for, and what does it accomplish with LEDs?</li>
<li>Does the Raspberry Pi have any PWM-capable pins? How many?</li>
<li>Why do we need a GPIO expander board to control our RGB LED?</li>
<li>How many colors would our RGB LED be able to show without PWM?</li>
<li>What protocol does our GPIO expander use to communicate with the Raspberry Pi?</li>
<li>What does the color module do for us?</li>
<li>How does the REPL help with debugging? What makes it so powerful?</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<ul>
<li><strong>More reading on PWM</strong>: <a href="https://learn.sparkfun.com/tutorials/pulse-width-modulation">https://learn.sparkfun.com/tutorials/pulse-width-modulation</a></li>
<li><strong>More reading on I<sup>2</sup>C</strong>: <a href="https://learn.sparkfun.com/tutorials/i2c">https://learn.sparkfun.com/tutorials/i2c</a></li>
</ul>


            </article>

            
        </section>
    </body></html>