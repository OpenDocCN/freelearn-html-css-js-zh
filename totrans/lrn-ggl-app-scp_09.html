<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;More Tips and Tricks and Creating an Add-on"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. More Tips and Tricks and Creating an Add-on</h1></div></div></div><p>In the previous chapter, you built an order processing workflow application. In this chapter, you will learn:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To overcome script maximum execution time restriction</li><li class="listitem" style="list-style-type: disc">To use script codes from other script files or libraries</li><li class="listitem" style="list-style-type: disc">Create add-ons that use the OAuth2 external library</li></ul></div><div class="section" title="Overcoming the &quot;script exceeded maximum execution time&quot; error"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec78"/>Overcoming the "script exceeded maximum execution time" error</h1></div></div></div><p>What if one of your script functions has a bug that causes endless (not terminating) execution, for example, an endless for loop and/or while loop. There are no remedies other than carefully examining the loop terminating statements.</p><p>Sometimes, your <a class="indexterm" id="id388"/>script may be flawless or bug free, but if it needs to handle a large spreadsheet or external data, it may take a long time to complete the execution. The maximum allowed time for your script to run continuously is 6 minutes. If it exceeds that limit, GAS would throw the "Exceeded maximum execution time" exception.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip22"/>Tip</h3><p>For a list of other<a class="indexterm" id="id389"/> limitations, please visit: <a class="ulink" href="https://developers.google.com/apps-script/guides/services/quotas#current_limitations">https://developers.google.com/apps-script/guides/services/quotas#current_limitations</a>.</p></div></div><p>To overcome this bottleneck, you can follow these steps. For example, if your <code class="literal">doLengthyProcess</code> function takes a long time to finish, then manually create a minute's trigger for the <code class="literal">doLengthyProcess</code> function so that it executes every 10 minutes. Your function should periodically check the elapsed time since the start. If the function completes successfully within the time limit then, at the end of the function, it deletes the trigger. Otherwise, the trigger value is stored in a loop counter in a dedicated Sheet or in script properties. This value should be read and assigned to the loop counter, when the function is triggered again.</p><p>A sample skeleton<a class="indexterm" id="id390"/> of such a function is given here:</p><div class="informalexample"><pre class="programlisting">var ss = SpreadsheetApp.getActiveSpreadsheet();

// A dedicated sheet to store values temporarily.
var sheet = ss.getSheetByName("Settings");

function doLengthyProcess() {
  // Prefix '+' to get date as epochy number.
  var elapsedTime, startTime = +new Date();

  // Loop variable.
  // Load value of 'i' from spreadsheet cell, or default 0.
  var i = sheet.getRange("A1").getValue() || 0;

  for(; i&lt;1000; i++){
    // Your time consuming process goes here.
    …
    …
    …
    …

    // Recalculate elapsedTime.
    elapsedTime = +new Date() - startTime;

    if(elapsedTime&gt; 300000){ // 300000 ms or 5 minutes.
      sheet.getRange("A1").setValue(i);
      return;
    }
  };

  // Loop completed successfully, so delete trigger.
  deleteTriggers_();
}

// Helper function
function deleteTriggers_(){
  var triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(function(trigger){
    ScriptApp.deleteTrigger(trigger);
    /*
     * Wait a moment before calling deleteTrigger again.
     * Otherwise you may get warning message something like
     * "Service invoked too many times..."
     *
     */
    Utilities.sleep(1000); // In millisecond.
  });

};</pre></div><p>To sum up, you <a class="indexterm" id="id391"/>create an "every minutes" trigger manually, and then the function executes until it completes successfully.</p><p>If you feel hesitant to create triggers manually, you can create them by script as we discussed in <a class="link" href="ch03.html" title="Chapter 3. Parsing and Sending E-mails">Chapter 3</a>, <span class="emphasis"><em>Parsing and Sending E-mails</em></span> but this time, create every minute's trigger:</p><div class="informalexample"><pre class="programlisting">function createTrigger_(funcName,minutes){
// Delete already created triggers if any.
deleteTriggers_();
  ScriptApp.newTrigger(funcName).timeBased()
    .everyMinutes(minutes).create();
}</pre></div><p>Here you created a trigger for the functions which do not start immediately but with a delay. However, if you want to automate everything, it means creating a trigger and calling the function immediately. Create another function <code class="literal">startProcess</code> as shown here:</p><div class="informalexample"><pre class="programlisting">function startProcess(){
  createTrigger_("doLengthyProcess",10);
  doLengthyProcess();
}</pre></div><p>Now, you just need to run the <code class="literal">startProcess</code> function. Also, you can assign a menu for this function.</p></div></div>
<div class="section" title="Configuring your script project to use external libraries"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec79"/>Configuring your script project to use external libraries</h1></div></div></div><p>Sometimes you <a class="indexterm" id="id392"/>would like to reuse code from<a class="indexterm" id="id393"/> other script project(s) or other programmer's code in your projects. You can import external code as it resides in the current project. You need to make a simple configuration in your current project.</p><p>For an example, we will explain how to import the previous chapter's code into the current project.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open any one of your previously created scripts (for example, <a class="link" href="ch08.html" title="Chapter 8. Building a Workflow Application">Chapter 8</a>, <span class="emphasis"><em>Building a Workflow Application</em></span>) in the script editor, save a version if you haven't already.</li><li class="listitem">Now, click <a class="indexterm" id="id394"/>on the <span class="strong"><strong>File</strong></span> menu and then <span class="strong"><strong>Project properties</strong></span>. The <span class="strong"><strong>Project properties</strong></span> dialog will open as shown here:<div class="mediaobject"><img alt="Configuring your script project to use external libraries" src="graphics/B05010_09_01.jpg"/></div></li><li class="listitem">Copy the <a class="indexterm" id="id395"/><span class="strong"><strong>Project key</strong></span> value (this value should be different for your project).</li><li class="listitem">Open the current script, navigate to <span class="strong"><strong>Resources</strong></span> | <span class="strong"><strong>Libraries…</strong></span>, and then the <span class="strong"><strong>Included Libraries</strong></span> dialog will open as shown here:<div class="mediaobject"><img alt="Configuring your script project to use external libraries" src="graphics/B05010_09_02.jpg"/></div></li><li class="listitem">Paste <span class="strong"><strong>Project key</strong></span> (you already copied in step 1) into the <span class="strong"><strong>Find a Library</strong></span> textbox and <a class="indexterm" id="id396"/>click on the <span class="strong"><strong>Select</strong></span> <a class="indexterm" id="id397"/>button.</li></ol></div><p>Now, the <code class="literal">Chapter 8</code> project will be included in the libraries list as shown here:</p><div class="mediaobject"><img alt="Configuring your script project to use external libraries" src="graphics/B05010_09_03.jpg"/></div><p>Select the version (the version you are going to use in this current project); and if you like, you can change the<a class="indexterm" id="id398"/> identifier (<code class="literal">Chapter8</code>) too. Leave <span class="strong"><strong>Development Mode</strong></span> off means using a selected version; set it to <span class="strong"><strong>on</strong></span> to override the selected version and use the current version. Click<a class="indexterm" id="id399"/> on the <span class="strong"><strong>Save</strong></span> button to save the changes.</p><p>Now all the functions (except private functions, that is, function names appended with "<code class="literal">_</code>") and the global variables are available to use in the current project. For example, you can use the <code class="literal">doGet</code> function from <a class="link" href="ch08.html" title="Chapter 8. Building a Workflow Application">Chapter 8</a>, <span class="emphasis"><em>Building a Workflow Application</em></span> here by prefixing with the identifier. It means that you can use the <code class="literal">doGet</code> function as <code class="literal">Chapter8.doGet()</code>, the <code class="literal">getPrice</code> function as <code class="literal">Chapter8.getPrice()</code>, and so on.</p><p>If you need more explanation, then here is a sample usage:</p><div class="informalexample"><pre class="programlisting">function test(){

  var pricelist = Chapter8.getPrice();

  Logger.log(pricelist);
}</pre></div></div>
<div class="section" title="Using JSDoc annotations"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec80"/>Using JSDoc annotations</h1></div></div></div><p>In the preceding<a class="indexterm" id="id400"/> test function, you can see that the code hint became active as soon as you type a '<code class="literal">.</code>' next to the identifier name (<code class="literal">Chapter8</code>). This shows all the functions and global variables available in the external library as shown here:</p><div class="mediaobject"><img alt="Using JSDoc annotations" src="graphics/B05010_09_04.jpg"/></div><p>The preceding code hints are generic, for example, <code class="literal">index</code> shown as <code class="literal">Object</code>. For detailed code hints, you should use the JSDoc style documentations (annotations or comments at top lines of function definitions).</p><p>For example, if you used the following annotations to the <code class="literal">getPrice</code> function in <a class="link" href="ch08.html" title="Chapter 8. Building a Workflow Application">Chapter 8</a>, <span class="emphasis"><em>Building a Workflow Application</em></span>:</p><div class="informalexample"><pre class="programlisting">/**
 *  Returns price list data from the Stock tab/sheet
 *
 *  @param {number} index 
 *  @return {array}
 *
 */
function getPrice(index){
          …
}</pre></div><p>Then the code hint would be as shown here:</p><div class="mediaobject"><img alt="Using JSDoc annotations" src="graphics/B05010_09_05.jpg"/></div><p>Now, you can <a class="indexterm" id="id401"/>notice how the code hint returns with useful information for the <code class="literal">getPrice</code> function.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip23"/>Tip</h3><p>For further reading on <a class="indexterm" id="id402"/>JSDoc, visit: <a class="ulink" href="https://developers.google.com/closure/compiler/docs/js-for-compiler">https://developers.google.com/closure/compiler/docs/js-for-compiler</a>.</p></div></div></div>
<div class="section" title="Using the OAuth open source library"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec81"/>Using the OAuth open source library</h1></div></div></div><p>If your application<a class="indexterm" id="id403"/> interacts with external libraries other than Google's basic services, then it should be authenticated. In other words, if your application runs on behalf of a user, then that user should authorize your application to grant access to his/her data. GAS does not provide any built-in authentication service, but you can use an open source OAuth library.</p></div>
<div class="section" title="Creating, testing, and publishing add-ons"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec82"/>Creating, testing, and publishing add-ons</h1></div></div></div><p>If you<a class="indexterm" id="id404"/> need to use<a class="indexterm" id="id405"/> other external libraries in your current project, you need to<a class="indexterm" id="id406"/> know the project key and you should have at least read access to that project. At the same time, every new version of the master project will not reflect in the client project unless the client selects the current version. Add-ons override this configuration hassle.</p><p>Add-ons are installable<a class="indexterm" id="id407"/> scripts by the click of a button, no configuration required. You can<a class="indexterm" id="id408"/> install add-ons in Sheets, Docs, and/or Forms published by the<a class="indexterm" id="id409"/> other programmer or from the Google Chrome Web Store.</p><div class="section" title="Installing add-ons from Chrome Web Store"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec35"/>Installing add-ons from Chrome Web Store</h2></div></div></div><p>To install an add-on from <a class="indexterm" id="id410"/>Chrome Web Store, open the document (Sheets, Docs, or Forms) and click on <span class="strong"><strong>Get add-ons…</strong></span> from the <span class="strong"><strong>Add-ons</strong></span> menu. Select <a class="indexterm" id="id411"/>any one of your favorite add-ons from the <span class="strong"><strong>Add-ons</strong></span> dialog (if you hover your mouse over any add-on, then a plus symbol will appear on the application; click on it and authorize if required). A sample <span class="strong"><strong>Add-ons</strong></span> dialog is shown here, but the actual add-ons included may vary from time to time.</p><div class="mediaobject"><img alt="Installing add-ons from Chrome Web Store" src="graphics/B05010_09_06.jpg"/></div><p>You will get that add-on installed and added to your document's <span class="strong"><strong>Add-ons</strong></span> menu. Each add-on comes with easy-to-use menu items. For example, if you installed <span class="strong"><strong>autoCrat</strong></span> then the menu item would<a class="indexterm" id="id412"/> look like in the screenshot shown <a class="indexterm" id="id413"/>here:</p><div class="mediaobject"><img alt="Installing add-ons from Chrome Web Store" src="graphics/B05010_09_07.jpg"/></div></div><div class="section" title="Creating custom add-ons"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec36"/>Creating custom add-ons</h2></div></div></div><p>You can create add-ons <a class="indexterm" id="id414"/>by yourself, use within your other documents, or share with other users. Your users <a class="indexterm" id="id415"/>can use your add-ons but cannot see the code. So, you can keep your intellectual property (that is, code and data) confidential.</p><p>Add menu items to the <span class="strong"><strong>Add-on</strong></span> menu such that:</p><div class="informalexample"><pre class="programlisting">function onOpen(e){
  SpreadsheetApp.getUi().createAddonMenu()
  .addItem("Show Sidebar", "showSidebar")
  .addToUi();
}</pre></div><p>The <code class="literal">addItem</code> method's first argument is the label for the menu item and the next one is the function name. Add the <code class="literal">onInstall</code> event function if you are going to publish an add-on for Chrome Web Store such that:</p><div class="informalexample"><pre class="programlisting">function onInstall(e){
  onOpen(e);
}</pre></div><p>The preceding function invokes the <code class="literal">onOpen</code> function while the add-on is installed for the first time in Sheets, Docs, or Forms. If your add-on needs a user interface, then create the sidebar dialog:</p><div class="informalexample"><pre class="programlisting">/**
 *  Opens sidebar in the document containing the add-on's
 *   user interface.
 *
 */
function showSidebar() {
  SpreadsheetApp.getUi().showSidebar(
    HtmlService.createHtmlOutputFromFile('Sidebar')
  );
}</pre></div><p>To style the<a class="indexterm" id="id416"/> sidebar (create <code class="literal">Sidebar.html</code>), you can use the officially<a class="indexterm" id="id417"/> supported CSS package from the <a class="ulink" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">https://ssl.gstatic.com/docs/script/css/add-ons1.css</a> URL.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note13"/>Note</h3><p>For more help<a class="indexterm" id="id418"/> on this package visit <a class="ulink" href="https://developers.google.com/apps-script/add-ons/css">https://developers.google.com/apps-script/add-ons/css</a>.</p></div></div></div><div class="section" title="Testing your add-on"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec37"/>Testing your add-on</h2></div></div></div><p>To test your add-on within the script editor, navigate to the <span class="strong"><strong>Publish</strong></span> | <span class="strong"><strong>Test as add-on…</strong></span> menu and then within the<a class="indexterm" id="id419"/> resulting dialog select the document in which you want to test the add-on as shown here:</p><div class="mediaobject"><img alt="Testing your add-on" src="graphics/B05010_09_08.jpg"/></div><p>To share your add-on with others, it is enough to share the document. More than that, if you would like to publish the script, follow the <span class="strong"><strong>Publish</strong></span> | <span class="strong"><strong>Deploy</strong></span> as an add-on menu. In the resulting dialog, fill the required fields and follow the guidelines provided. Your add-on should strictly<a class="indexterm" id="id420"/> adhere to the Chrome Web Store's content and style guidelines and undergo a review process before being listed and made available to the public.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note14"/>Note</h3><p>For more<a class="indexterm" id="id421"/> information on add-ons, visit <a class="ulink" href="https://developers.google.com/apps-script/add-ons/">https://developers.google.com/apps-script/add-ons/</a>.</p></div></div></div><div class="section" title="Creating an add-on that uses an OAuth2 external library"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec38"/>Creating an add-on that uses an OAuth2 external library</h2></div></div></div><p>To get hands-on<a class="indexterm" id="id422"/> experience on all aforesaid concepts, we will create an add-on that can send an active spreadsheet as a PDF attachment to the active user's e-mail ID.</p><p>Create a new script project in Sheets. In the script editor, we will first create a few global variables as shown here:</p><div class="informalexample"><pre class="programlisting">var ss = SpreadsheetApp.getActiveSpreadsheet();
var activeSheet = ss.getActiveSheet();
var activeSheetName = activeSheet.getSheetName();</pre></div><p>Next, take a look at the <code class="literal">onOpen</code> and <code class="literal">onInstall</code> trigger functions.</p><div class="informalexample"><pre class="programlisting">/**
 * Creates a menu entry in the Google Sheets UI when the document
 * is opened.
 *
 * @param {object} e The event parameter for a simple onOpen
 * trigger.
 *
 */
function onOpen(e){
  // Create an Add-on menu item and associate a function.
  SpreadsheetApp.getUi().createAddonMenu()
  .addItem("Sheet To PDF", "sendSheetAsPdfToActiveUser")
  .addToUi();
}

/**
 * Runs when the add-on is installed.
 *
 * @param {object} e The event parameter for a simple onInstall
 * trigger.
 *
 */
function onInstall(e){
  onOpen(e);
}</pre></div><p>In the <code class="literal">onOpen</code> trigger, we have associated the function <code class="literal">sendSheetAsPdfToActiveUser</code> to the <span class="strong"><strong>Sheet To PDF</strong></span> menu item. We will create that function now:</p><div class="informalexample"><pre class="programlisting">/** 
* Sends PDF attachment to the active user e-mail id. 
* 
*/ 
function sendSheetAsPdfToActiveUser(){ 
  // Get active user's email id. 
  var mailTo = Session.getActiveUser().getEmail(); 
  // Returns either pdf or false. 
  var attachments = getAttachments(); 
  // Send only if there is attachment. 
  if(attachments){ 
    MailApp.sendEmail( 
        mailTo, activeSheetName, '', {attachments:attachments} 
); 
  } 
}</pre></div><p>The said function <a class="indexterm" id="id423"/>sends an e-mail with the PDF attachment, which is returned from the <code class="literal">getAttachments</code> function. An example is given here:</p><div class="informalexample"><pre class="programlisting">/**
 * Authorizes the application for the first time or the token
 *  expires. If authentication token is valid then returns the pdf
 *  file with other attachment parameter otherwise prompts the 
 *  user to authorize.
 *
 *  @return {Object} Array of attachment objects.
 */
function getAttachments(){
  // Authenticated service object.
  var service = getGoogleService();

  // Proceed further only if authenticated, otherwise prompt for
  // authentication.
  if (service.hasAccess()) {

    // The url to download activesheet as pdf.
    var url = ss.getUrl()
        .replace("edit", "export?gid=" + activeSheet.getSheetId()
          + "&amp;format=pdf&amp;attachment=false");

    // The access token should be sent on every request.
    var headers = {
        Authorization:'Bearer ' + service.getAccessToken()
    };

    // Send request to the pdf url with the access token.
    var response = UrlFetchApp.fetch(url, { headers:headers });

    // Returned content.
    var content = response.getContent();

    // Returns as an array of objects.
    return [{
      fileName: activeSheetName + ".pdf",
      content: content,
      mimeType:"application/pdf"
    }];

  } else {

    // Authorization url from the service object.
    var authorizationUrl = service.getAuthorizationUrl();

    // Side bar with the authorization link.
var template = HtmlService 
    .createTemplate( 
    '&lt;a href="&lt;?= authorizationUrl ?&gt;" 
    target="_blank"&gt;Authorize&lt;/a&gt;.' 
);

    // Authorization url assigned to template
    template.authorizationUrl = authorizationUrl;

    // Finally evaluate the template and show sidebar.
    var page = template.evaluate();
    SpreadsheetApp.getUi().showSidebar(page);

    // Attracting user attention.
    Browser.msgBox('Authorize on sidebar and run again.');

    // Return false, so no need to send e-mail.
    return false;
  }
}</pre></div><p>The said function prompts the user to authenticate the application if he is using it for the first time or already has an authenticated token but it is expired. If the authenticated token is valid, then it returns the PDF attachment, otherwise it returns false.</p><p>Now, the only thing<a class="indexterm" id="id424"/> we have left to do is implementing OAuth2 flow. We will create a function for the same:</p><div class="informalexample"><pre class="programlisting">/**
 * Executes OAuth2 flow.
 *
 * @return {Object} Authentication service object.
 *
 */
function getGoogleService(){
  /*
   * Create a new service with the given name (here 'PACKT').
   * The name will be used when persisting the authorized token,
   * so ensure it is unique within the scope of the property
   * store.
   *
   */
  return OAuth2.createService("PACKT")

// Endpoint URLs are same for all Google services. 
.setAuthorizationBaseUrl( 
'https://accounts.google.com/o/oauth2/auth' 
)
.setTokenUrl('https://accounts.google.com/o/oauth2/token')
  /*
   * Replace with your client ID and secret got from developers
   * console.
   *
   */
  .setClientId('...')
  .setClientSecret('...')

  // A callback function to complete the OAuth2 flow.
  .setCallbackFunction('authCallback')

  // A place to store authenticated tokens.
  .setPropertyStore(PropertiesService.getUserProperties())

  /*
   * Scopes to request, separate with space if more than one
   * scope.
   *
   */
  .setScope('https://docs.google.com/feeds/')


  /*
   * Google-specific parameters.
   *
   * Sets the login hint, which will prevent the account chooser
   * screen from being shown to users if logged in with multiple
   * accounts.
   *
   */
  .setParam('login_hint', Session.getActiveUser().getEmail())

  // Requests offline access.
  .setParam('access_type', 'offline')

  /*
   * Forces the approval prompt every time to show up.
   * This is useful for testing, but not desirable in a production
   * application.
   *
   */
  .setParam('approval_prompt', 'force');
}</pre></div><p>Don't forget to replace your own client ID and secret. We will see how to get them. Can you remember what <a class="indexterm" id="id425"/>you did to enable advanced services in <a class="link" href="ch05.html" title="Chapter 5. Creating Google Calendar and Drive Applications">Chapter 5</a>, <span class="emphasis"><em>Creating Google Calendar and Drive Applications</em></span>? Use the same steps here, but with a few additional tasks.</p><p>Within the script editor, navigate to <span class="strong"><strong>Resources</strong></span> | <span class="strong"><strong>Developers Console Project…</strong></span> and click on <span class="strong"><strong>View Developers Console</strong></span> on the dialog that opens:</p><div class="mediaobject"><img alt="Creating an add-on that uses an OAuth2 external library" src="graphics/B05010_09_09.jpg"/></div><p>That should take<a class="indexterm" id="id426"/> you to the developer's console dashboard where you can click on the <span class="strong"><strong>Enable and manage APIs</strong></span> option.</p><div class="mediaobject"><img alt="Creating an add-on that uses an OAuth2 external library" src="graphics/B05010_09_10.jpg"/></div><p>Once enabled, click <a class="indexterm" id="id427"/>on <span class="strong"><strong>Credentials</strong></span> on the left pane of the console dashboard:</p><div class="mediaobject"><img alt="Creating an add-on that uses an OAuth2 external library" src="graphics/B05010_09_11.jpg"/></div><p>To complete the OAuth2 flow, this callback function will be invoked, and it shows a message to the user. Then, the OAuth2 client IDs are listed as <span class="strong"><strong>Apps Script</strong></span>. Click on <span class="strong"><strong>Apps Script</strong></span> to see<a class="indexterm" id="id428"/> the details as shown here:</p><div class="mediaobject"><img alt="Creating an add-on that uses an OAuth2 external library" src="graphics/B05010_09_12.jpg"/></div><p>You need to add an authorized redirect URL for this project. Enter the URL as shown here, but replaced with your project key:</p><div class="informalexample"><pre class="programlisting">https://script.google.com/macros/d/[[PROJECT KEY]]/usercallback</pre></div><p>Before clicking on <span class="strong"><strong>Save</strong></span>, a copy of the client ID and client secret is required in the <code class="literal">getGoogleService</code> function. Once this is done, click on <span class="strong"><strong>Save</strong></span>; you can return to this dashboard anytime afterwards.</p><p>Also add the <code class="literal">authCallback</code> function as shown here:</p><div class="informalexample"><pre class="programlisting">function authCallback(request) {
  var service = getGoogleService();
  var isAuthorized = service.handleCallback(request);

  if (isAuthorized) {
return HtmlService 
  .createHtmlOutput('Success! You can close this tab.'); 
  } else {
return HtmlService 
  .createHtmlOutput('Denied. You can close this tab'); 
  }
}</pre></div><p>Before testing the <a class="indexterm" id="id429"/>add-on, import the OAuth2 client library using the project key:</p><div class="informalexample"><pre class="programlisting">MswhXl8fVhTFUH_Q3UOJbXvxhMjh3Sh48</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip24"/>Tip</h3><p>The following are some sample keys:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">OAuth1 Lib Key: <code class="literal">Mb2Vpd5nfD3Pz-_a-39Q4VfxhMjh3Sh48</code></li><li class="listitem" style="list-style-type: disc">OAuth2 Lib Key: <code class="literal">MswhXl8fVhTFUH_Q3UOJbXvxhMjh3Sh48</code></li></ul></div></div></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note15"/>Note</h3><p>For more information on<a class="indexterm" id="id430"/> open source OAuth2 external library, visit <a class="ulink" href="https://github.com/googlesamples/apps-script-oauth2">https://github.com/googlesamples/apps-script-oauth2</a>.</p></div></div><p>Now, you have completed all the setup steps. Refresh the spreadsheet window so that your add-on appears in an <span class="strong"><strong>Add-on</strong></span> menu.</p><p>In addition, once authenticated, you can reset or revoke the authentication using this function:</p><div class="informalexample"><pre class="programlisting">function clearService(){
  OAuth2.createService('PACKT')
  .setPropertyStore(PropertiesService.getUserProperties())
  .reset();
}</pre></div><p>Notice the same<a class="indexterm" id="id431"/> service name (<code class="literal">PACKT</code>) used here.</p></div></div>
<div class="section" title="Other useful links"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec83"/>Other useful links</h1></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Tutorials: <a class="ulink" href="https://developers.google.com/apps-script/articles">https://developers.google.com/apps-script/articles</a></li><li class="listitem" style="list-style-type: disc">Documentation: <a class="ulink" href="https://developers.google.com/apps-script/">https://developers.google.com/apps-script/</a></li><li class="listitem" style="list-style-type: disc">Blog: <a class="ulink" href="http://googleappsdeveloper.blogspot.in/search/label/Apps%20Script">http://googleappsdeveloper.blogspot.in/search/label/Apps%20Script</a></li></ul></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec84"/>Summary</h1></div></div></div><p>In this <a class="indexterm" id="id432"/>chapter, you learned how to <a class="indexterm" id="id433"/>overcome script maximum run<a class="indexterm" id="id434"/> time restrictions, how to import external libraries, how to use OAuth, and how to create an add-on. We hope you enjoyed reading this book, learning, and gathering hands-on skills on most aspects of the Google Apps Script. Happy coding and enjoy!</p></div></body></html>