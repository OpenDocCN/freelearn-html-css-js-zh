<html><head></head><body>
  <div id="sbo-rt-content"><div class="chapter" title="Chapter 5. ESRI in Leaflet"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. ESRI in Leaflet</h1></div></div></div><p>As you start making more maps and looking for geospatial data to work with, you will almost certainly run into the file type shapefile (<code class="literal">.shp</code>). <span class="strong"><strong>Economic and Social Research Institute</strong></span> (<span class="strong"><strong>ESRI</strong></span>) is the creator of the most widely used GIS system, ArcGIS, and the shapefile is one of their data formats.</p><p>You may see<a id="id366" class="indexterm"/> another format called geodatabase with a <code class="literal">.gdb</code> extension. Even if you never run into a shapefile or geodatabase, you will eventually run into a REST service that is an endpoint to an ArcServer installation.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note26"/>Note</h3><p>ArcServer is an ESRI product <a id="id367" class="indexterm"/>for distributing GIS services and web mapping applications. It is separate from ArcGIS, which refers to the desktop application to create maps and geographic data.</p></div></div><p>The more data formats you know how to consume in your Leaflet maps, the less time you will need to spend converting data to suit your needs. In this chapter, you will learn how to consume ESRI formats and services in Leaflet.</p><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">ESRI basemaps</li><li class="listitem" style="list-style-type: disc">Working with shapefiles</li><li class="listitem" style="list-style-type: disc">Displaying a dynamic map layer</li><li class="listitem" style="list-style-type: disc">Heatmaps</li><li class="listitem" style="list-style-type: disc">Geocoding and reverse geocoding</li><li class="listitem" style="list-style-type: disc">Query layers</li></ul></div><div class="section" title="ESRI basemaps"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec39"/>ESRI basemaps</h1></div></div></div><p>ESRI provides<a id="id368" class="indexterm"/> eight different basemaps <a id="id369" class="indexterm"/>that you can use in your Leaflet map. The eight layers<a id="id370" class="indexterm"/> are the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Streets</li><li class="listitem" style="list-style-type: disc">Topographic</li><li class="listitem" style="list-style-type: disc">National Geographic</li><li class="listitem" style="list-style-type: disc">Oceans</li><li class="listitem" style="list-style-type: disc">Gray</li><li class="listitem" style="list-style-type: disc">Dark gray</li><li class="listitem" style="list-style-type: disc">Imagery</li><li class="listitem" style="list-style-type: disc">Shaded relief</li></ul></div><p>In addition to the eight basemaps, there are six basemap label layers, <code class="literal">OceansLabels</code>, <code class="literal">GrayLabels</code>, <code class="literal">DarkGrayLabels</code>, <code class="literal">ImageryLabels</code>, <code class="literal">ImageryTransportation</code>, and <code class="literal">ShadedReliefLabels</code>, to compliment the basemaps. If that<a id="id371" class="indexterm"/> is not enough, there is also a retina version of each basemap.</p><p>To use an ESRI basemap, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, add a<a id="id372" class="indexterm"/> reference to the ESRI-leaflet file. It is in beta, but that doesn't mean that it is not fully functional:<div class="informalexample"><pre class="programlisting">&lt;script src="http://cdn-geoweb.s3.amazonaws.com/esri- leaflet/0.0.1-beta.5/esri-Leaflet"&gt;&lt;/script&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note27"/>Note</h3><p>On its GitHub repository, ESRI states that the library is on track to be moved from beta to production in 2014. You can find more information and download the additional files at <a class="ulink" href="https://github.com/Esri/esri-leaflet/">https://github.com/Esri/esri-leaflet/</a>.</p></div></div></li><li class="listitem">Next, create an ESRI basemap layer, passing one of the eight options. In this example, use <code class="literal">Gray</code>. Always remember to add it to the map:<div class="informalexample"><pre class="programlisting">var gray = L.esri.basemapLayer("Gray").addTo(map);</pre></div></li><li class="listitem">You now have a map with an ESRI basemap layer. The preceding code is the minimal code required to add a basemap. The ESRI basemap layer inherits from the Leaflet <code class="literal">L.TileLayer</code> class, and therefore, allows you to use all of the options, methods, and events available to any other Leaflet <code class="literal">L.TileLayer</code> class. One option that is extremely useful when building <a id="id373" class="indexterm"/>mobile maps is the <code class="literal">detectRetina</code> option. To use this option, just pass it after the basemap name as shown in the following code:<div class="informalexample"><pre class="programlisting">var gray = L.esri.basemapLayer("Gray",{detectRetina: true}).addTo(map);</pre></div></li></ol></div><p>Many examples that you find in the documentation will create the layers without assigning them to a variable, as shown in the following code from the ESRI website:</p><div class="informalexample"><pre class="programlisting">var map = L.map('map').setView([37.75,-122.45], 12);
L.esri.basemapLayer("Topographic").addTo(map);</pre></div><p>When you do this, you have no way of calling methods or events on the layer unless you chain them. In the preceding example, you assigned the basemap to the variable <code class="literal">gray</code>, so you have access to all of the methods and <a id="id374" class="indexterm"/>events as shown in the following code:</p><div class="informalexample"><pre class="programlisting">gray.setOpacity(.75);   
gray.on("load", alertme);
function alertme(){alert("ESRI Basemap Loaded");}</pre></div><p>The preceding code modifies the opacity of the basemap layer and also subscribes to the <code class="literal">load</code> event. When the layer loads, it executes the <code class="literal">alertme()</code> function and pops up an alert stating that it is complete.</p><p>The last thing you may need to do with your ESRI basemap layer is to add the corresponding label layer. To do so, just add another basemap layer, passing the label layer as shown in the following code:</p><div class="informalexample"><pre class="programlisting">var grayLabel = L.esri.basemapLayer("GrayLabels").addTo(map);</pre></div><p>Now, you will have a map that looks like this:</p><div class="mediaobject"><img src="images/4812OS_05_01.jpg" alt="ESRI basemaps"/></div></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Using shapefiles in Leaflet"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec40"/>Using shapefiles in Leaflet</h1></div></div></div><p>A shapefile is the<a id="id375" class="indexterm"/> most common geographic file type that you will most likely encounter. A shapefile is not a single file, but rather several files used to create geographic features on a map. When you download a shapefile, you will have <code class="literal">.shp</code>, <code class="literal">.shx</code>, and <code class="literal">.dbf</code> at a minimum. These files are the shapefiles that contain the geometry, the index, and a database of attributes. Your shapefile will most likely include a projection file (<code class="literal">.prj</code>) that<a id="id376" class="indexterm"/> will tell that application the projection of the data so the coordinates make sense to the application. In the examples, you will also have a <code class="literal">.shp.xml</code> file that<a id="id377" class="indexterm"/> contains metadata<a id="id378" class="indexterm"/> and two spatial index files, <code class="literal">.sbn</code> and <code class="literal">.sbx</code>.</p><p>To find shapefiles, you can usually<a id="id379" class="indexterm"/> search for open data and a city name. In this example, we will be using a shapefile from ABQ Data, the City of Albuquerque data portal. You can find more data on this at <a class="ulink" href="http://www.cabq.gov/abq-data">http://www.cabq.gov/abq-data</a>. When you download a shapefile, it will most likely be in the ZIP format because it will contain multiple files.</p><p>To open a shapefile in Leaflet using<a id="id380" class="indexterm"/> the <code class="literal">leaflet-shpfile</code> plugin, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, add<a id="id381" class="indexterm"/> references to two JavaScript files. The first, <code class="literal">leaflet-shpfile</code>, is the plugin, and the second depends on the shapefile parser, <code class="literal">shp.js</code>:<div class="informalexample"><pre class="programlisting">&lt;script src="leaflet.shpfile.js"&gt;&lt;/script&gt;
&lt;script src="shp.js"&gt;&lt;/script&gt;</pre></div></li><li class="listitem">Next, create a new shapefile layer and add it to the map. Pass the layer path to the zipped shapefile:<div class="informalexample"><pre class="programlisting">var shpfile = new L.Shapefile('council.zip');
shpfile.addTo(map);</pre></div></li></ol></div><p>Your map should<a id="id382" class="indexterm"/> display the shapefile as shown in the following screenshot:</p><div class="mediaobject"><img src="images/4812OS_05_02.jpg" alt="Using shapefiles in Leaflet"/></div><p>Performing the preceding steps will add the shapefile to the map. You will not be able to see any individual feature properties. When you create a shapefile layer, you specify the data, followed by specifying the<a id="id383" class="indexterm"/> options. The options are passed to the <code class="literal">L.geoJson</code> class. To add a pop up or to style the features, you use the same process that you learned in <a class="link" href="ch02.html" title="Chapter 2. Mapping GeoJSON Data">Chapter 2</a>, <span class="emphasis"><em>Mapping GeoJSON Data</em></span>. The following code shows you how to add a pop up to your shapefile layer:</p><div class="informalexample"><pre class="programlisting">var shpfile = new 
   L.Shapefile('council.zip',{onEachFeature:function(feature, layer) {
layer.bindPopup("&lt;a 
href='"+feature.properties.WEBPAGE+"'&gt;Page&lt;/a&gt;&lt;br&gt;&lt;a href='"+feature.properties.PICTURE+"'&gt;Image&lt;/a&gt;");
}});</pre></div><p>In the preceding code, you pass <code class="literal">council.zip</code> to the shapefile, and for options, you use the <code class="literal">onEachFeature</code> option, which takes a function. In this case, you use an anonymous function and bind the pop up to the layer. In the text of the pop up, you concatenate your HTML with the name of the property you want to display using the format <code class="literal">feature.properties.NAME-OF-PROPERTY</code>. To find the names of the properties in a shapefile, you can open <code class="literal">.dbf</code> and look at the column headers. However, this can be cumbersome, and you may<a id="id384" class="indexterm"/> want to add all of the shapefiles in a directory without knowing its contents. If you do not know the names of the properties for a given<a id="id385" class="indexterm"/> shapefile, the following example shows you how to get them and then display them with their value in a pop up:</p><div class="informalexample"><pre class="programlisting">var holder=[];

for (var key in feature.properties){ 
holder.push(key+": "+feature.properties[key]+"&lt;br&gt;");
popupContent=holder.join("");
layer.bindPopup(popupContent);
}
shapefile.addTo(map);</pre></div><p>In the preceding code, you first create an array to hold all of the lines in your pop up, one for each key/value pair. Next, you run a <code class="literal">for</code> loop that iterates through the object, grabbing each key and concatenating the key name with the value and a line break. You push each line into the array and then join all of the elements into a single string. When you use the <code class="literal">.join()</code> method, it will <a id="id386" class="indexterm"/>separate each element of the array in the new string with a comma.</p><p>You can pass empty quotes to remove the comma. Lastly, you bind the pop up with the string as the content and then add the shapefile to the map.</p><p>You now have a map that looks like the following screenshot:</p><div class="mediaobject"><img src="images/4812OS_05_03.jpg" alt="Using shapefiles in Leaflet"/></div><p>The shapefile also<a id="id387" class="indexterm"/> takes a style option. You can pass any of the path class options, such as the color, opacity, or stroke, to change the appearance of the layer. The following code creates a red polygon<a id="id388" class="indexterm"/> with a black outline and sets it slightly transparent:</p><div class="informalexample"><pre class="programlisting">var shpfile = new 
L.Shapefile('council.zip',{style:function(feature){return  {color:"black",fillColor:"red",fillOpacity:.75}}});</pre></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Consuming ESRI services"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec41"/>Consuming ESRI services</h1></div></div></div><p>In the first example of this chapter, you learned how to use the <code class="literal">esri-leaflet</code> plugin for basemaps. You then learned how to use a plugin to work with the most common ESRI file format: the shapefile. While<a id="id389" class="indexterm"/> you will most certainly run into a shapefile, you will increasingly find yourself running into ESRI services that provide endpoints that you can connect to and consume geographic services from. With the <code class="literal">esri-leaflet</code> plugin, you can connect to these services, and besides basemaps, display five other layer types:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The tiled map layer</li><li class="listitem" style="list-style-type: disc">The dynamic map layer</li><li class="listitem" style="list-style-type: disc">The feature layer</li><li class="listitem" style="list-style-type: disc">The clustered feature layer</li><li class="listitem" style="list-style-type: disc">The heatmap feature layer</li></ul></div><p>Once you know how to add one of these layers, you can add any of the others because the process is almost identical. The only differences are the available options and methods, which are well documented in the API at <a class="ulink" href="http://esri.github.io/esri-leaflet/api-reference/">http://esri.github.io/esri-leaflet/api-reference/</a>. Later in this chapter, we <a id="id390" class="indexterm"/>will learn how to create a heatmap feature layer, but for now, let's see how to add a dynamic map layer.</p><p>On the City of Albuquerque data page at <a class="ulink" href="http://www.cabq.gov/abq-data">http://www.cabq.gov/abq-data</a>, select the public art dataset. You will be presented with the contents of the directory. You can read the <code class="literal">MetaData.pdf</code> file to learn about the data source, download a Google Earth <code class="literal">.KMZ</code> file, download or link to a JSON file, or consume a <code class="literal">PublicArtREST</code> service.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note28"/>Note</h3><p>The JSON file available<a id="id391" class="indexterm"/> from the City of Albuquerque data page is ESRI JSON. It is not GeoJSON, and thus, it will not be compatible without some conversion.</p></div></div><p>Click on the link for PublicArtREST and you will be presented with the details of this service. Scrolling to the bottom of the page will tell you the available fields. This will be very useful when designing the pop ups. Now that you know where to find the service, follow these steps to add it to your map:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, add a reference to the ESRI-leaflet file:<div class="informalexample"><pre class="programlisting">&lt;script src="http://cdn-geoweb.s3.amazonaws.com/esri- leaflet/0.0.1-beta.5/esri-Leaflet"&gt;&lt;/script&gt;</pre></div></li><li class="listitem">Create a dynamic map layer by copying the link to the REST service—all dynamic map layers will end in <code class="literal">/mapserver</code>. We removed <code class="literal">/0</code> from the URL, which means that we are now loading the entire map file. In the following code, set the opacity option to <code class="literal">0.75</code> and add the layer to the map:<div class="informalexample"><pre class="programlisting">var art = L.esri.dynamicMapLayer("http://coagisweb.cabq.gov/arcgis/re st/services/public/PublicArt/MapServer).addTo(map);</pre></div></li><li class="listitem">Lastly, bind a pop up using a function that will return the content. In the following code, use the format <code class="literal">feature.features[0].properties.NAME-OF-PROPERTY</code>:<div class="informalexample"><pre class="programlisting">art.bindPopup(function (err, feature) { 
return feature.features[0].properties.TITLE+"&lt;br&gt; by:  &lt;b&gt;"+feature.features[0].properties.ARTIST;  });</pre></div></li></ol></div><p>Your map will now look like this:</p><div class="mediaobject"><img src="images/4812OS_05_04.jpg" alt="Consuming ESRI services"/></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Heatmaps with ESRI in Leaflet"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec42"/>Heatmaps with ESRI in Leaflet</h1></div></div></div><p>In <a class="link" href="ch03.html" title="Chapter 3. Creating Heatmaps and Choropleth Maps">Chapter 3</a>, <span class="emphasis"><em>Creating Heatmaps and Choropleth Maps</em></span>, you learned about several plugins that you can use to create heatmaps. The <code class="literal">esri-leaflet</code> plugin also has a heatmap layer that will allow you to pass an ESRI service as the data. To create<a id="id392" class="indexterm"/> a heatmap using the <code class="literal">esri-leaflet</code> plugin, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, add a<a id="id393" class="indexterm"/> reference to the ESRI-leaflet file, and since the heatmap layer is not included in the core build of the <code class="literal">esri-leaflet</code> plugin, you<a id="id394" class="indexterm"/> will need to reference an additional ESRI file, <code class="literal">esri-leaflet-heatmap-feature-layer.js</code>. The ESRI heatmap layer requires <code class="literal">leaflet-heat.js</code>, so you need to add a reference to that as well:<div class="informalexample"><pre class="programlisting">&lt;script src="http://cdn-geoweb.s3.amazonaws.com/esri- leaflet/0.0.1-beta.5/esri-Leaflet"&gt;&lt;/script&gt;
&lt;script src="esri-leaflet-heatmap-feature- layer.js"&gt;&lt;/script&gt;
&lt;script src="leaflet-heat.js"&gt;&lt;/script&gt;</pre></div></li><li class="listitem">Create your map and basemap as you normally would and then add the heatmap layer. The heatmap layer requires a link to a feature layer service and acquires all of the options available in <code class="literal">leaflet-heat.js</code>. Add the layer to the map:<div class="informalexample"><pre class="programlisting">url= ("http://services.arcgis.com/pmcEyn9tLWCoX7Dm/arcgis/rest/ services/USGS_Earthquakes_Excel_Layer/FeatureServer/0";
var heatmap = new L.esri.HeatmapFeatureLayer(url, {
            radius: 50,
   blur:90,
   maxZoom:10
}).addTo(map);</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note29"/>Note</h3><p>To see a list of the available<a id="id395" class="indexterm"/> services from ESRI, browse to <a class="ulink" href="http://services.arcgis.com/rOo16HdIMeOBI4Mb/ArcGIS/rest/services/">http://services.arcgis.com/rOo16HdIMeOBI4Mb/ArcGIS/rest/services/</a>. The location of ArcServer services defaults to <code class="literal">http://Server Name/ ArcGIS/rest/services</code>.</p></div></div></li></ol></div><p>Your<a id="id396" class="indexterm"/> map will<a id="id397" class="indexterm"/> look like the following screenshot:</p><div class="mediaobject"><img src="images/4812OS_05_05.jpg" alt="Heatmaps with ESRI in Leaflet"/></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Geocoding addresses in Leaflet"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec43"/>Geocoding addresses in Leaflet</h1></div></div></div><p>Geocoding is the<a id="id398" class="indexterm"/> process by which you can enter an address and be taken to a point on the map. Geocoding functionality is<a id="id399" class="indexterm"/> not part of the Esri-leaflet core but is a<a id="id400" class="indexterm"/> separate plugin. You can find more information on<a id="id401" class="indexterm"/> the esri-leaflet-geocoder GitHub page at <a class="ulink" href="https://github.com/Esri/esri-leaflet-geocoder">https://github.com/Esri/esri-leaflet-geocoder</a>.</p><div class="section" title="Geocoding – from an address to a point"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec49"/>Geocoding – from an address to a point</h2></div></div></div><p>The geocoding plugin places a search box below the zoom <a id="id402" class="indexterm"/>control. As you type an address, the search autocompletes and presents the possible options. You can either type the whole<a id="id403" class="indexterm"/> address or select from the list when the one you want is available. Clicking on an option or pressing enter will put a marker on the map at the location and zoom into it. To create a map with geocoding<a id="id404" class="indexterm"/> functionality, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Reference the CSS and JS files:<div class="informalexample"><pre class="programlisting">&lt;script src="http://cdn-geoweb.s3.amazonaws.com/esri- leaflet-geocoder/0.0.1-beta.3/esri-leaflet-geocoder.js"&gt;&lt;/script&gt;
&lt;link rel="stylesheet" type="text/css" href="http://cdn- geoweb.s3.amazonaws.com/esri-leaflet-geocoder/0.0.1- beta.3/esri-leaflet-geocoder.css"&gt;</pre></div></li><li class="listitem">Create the control:<div class="informalexample"><pre class="programlisting">var searchControl = new  L.esri.Controls.Geosearch().addTo(map);</pre></div></li><li class="listitem">Create a layer where the result will be placed:<div class="informalexample"><pre class="programlisting">  var results = new L.LayerGroup().addTo(map);</pre></div></li><li class="listitem">Subscribe to the results event and add the marker:<div class="informalexample"><pre class="programlisting">searchControl.on("results", function(data){
results.clearLayers();
results.addLayer(L.marker(data.results[0].latlng));</pre></div></li></ol></div><p>Your map will now have a small magnifying glass under the zoom control, as shown in the following screenshot:</p><div class="mediaobject"><img src="images/4812OS_05_06.jpg" alt="Geocoding – from an address to a point"/></div><p>When you click on<a id="id405" class="indexterm"/> the magnifying glass, it will expand into a textbox. As you type, the textbox will autocomplete and guess the location that you are typing. Once<a id="id406" class="indexterm"/> you see the address you want, select it from the list. Your map should look like the following screenshot:</p><div class="mediaobject"><img src="images/4812OS_05_07.jpg" alt="Geocoding – from an address to a point"/></div><p>Once you have clicked on<a id="id407" class="indexterm"/> your selection, the map will automatically<a id="id408" class="indexterm"/> place a marker at the location and zoom into it. You will now have a map that looks like the following:</p><div class="mediaobject"><img src="images/4812OS_05_08.jpg" alt="Geocoding – from an address to a point"/></div><p>For the <a id="id409" class="indexterm"/>next example, you<a id="id410" class="indexterm"/> will use a URL to map an address.</p></div><div class="section" title="Geocoding from URL parameters"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec50"/>Geocoding from URL parameters</h2></div></div></div><p>In the last example, a user is able to load the map and enter an address to find it. In this example, you will allow the<a id="id411" class="indexterm"/> user to enter the address in the URL and be presented with a map that has zoomed into a marker at the location. To create the map, follow<a id="id412" class="indexterm"/> these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, add a reference to the <code class="literal">esri-leaflet-geocoder.js</code> file. You do not need the CSS file, as you did in the previous example, because you are not adding the search box:<div class="informalexample"><pre class="programlisting">&lt;script src="http://cdn-geoweb.s3.amazonaws.com/esri- leaflet-geocoder/0.0.1-beta.5/esri-leaflet- geocoder.js"&gt;&lt;/script&gt;</pre></div></li><li class="listitem">Next, you need to get the parameter from the URL. In this example, <code class="literal">a</code> is chosen as the variable that will contain the address. To get the URL parameters, use <code class="literal">location.search</code>. This grabs everything after the question mark. You only want the address, so split it on the equals sign and then grab the second element of the returned array, <code class="literal">y[1]</code>. This will return <code class="literal">%20</code> wherever there is a space in the URL, so use <code class="literal">decodeURIComponent(y[1])</code> to remove them:<div class="informalexample"><pre class="programlisting">var x = location.search;
var y = x.split("=");
var temp=y[1];
var address = decodeURIComponent(temp);
var geocodeService = new L.esri.Services.Geocoding();</pre></div></li><li class="listitem">Create the geocoding service, passing the address, parameters, and a callback function. The function <a id="id413" class="indexterm"/>will create a marker from the<a id="id414" class="indexterm"/> first result and then set the view zoomed in on the marker:<div class="informalexample"><pre class="programlisting">geocodeService.geocode(address, {}, function(error,  result){
L.marker(result[0].latlng).addTo(map);
map.setView(result[0].latlng,8);
});</pre></div></li></ol></div><p>Load the page and add <code class="literal">?a=400 roma ave ne,albuquerque,nm,usa</code> after the <code class="literal">URLgeocode.html</code> file. Your map will load and look like this:</p><p> </p><div class="mediaobject"><img src="images/4812OS_05_09.jpg" alt="Geocoding from URL parameters"/></div><p>
</p></div><div class="section" title="Reverse geocoding – using points to find addresses"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec51"/>Reverse geocoding – using points to find addresses</h2></div></div></div><p>Reverse geocoding does<a id="id415" class="indexterm"/> the exact opposite of geocoding. It takes a point on a map and finds its address. In this example, you<a id="id416" class="indexterm"/> will allow the user to click on the <a id="id417" class="indexterm"/>map and add a<a id="id418" class="indexterm"/> marker that has the address as a pop up. To create the map, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, add a reference to the Esri-leaflet and <code class="literal">esri-leaflet-geocoder.js</code> files:<div class="informalexample"><pre class="programlisting">&lt;script src="http://cdn-geoweb.s3.amazonaws.com/esri- leaflet/0.0.1-beta.5/esri-Leaflet"&gt;&lt;/script&gt;
&lt;script src="http://cdn-geoweb.s3.amazonaws.com/esri- leaflet-geocoder/0.0.1-beta.5/esri-leaflet-geocoder.js"&gt;&lt;/script&gt;</pre></div></li><li class="listitem">Create a new geocoding service:<div class="informalexample"><pre class="programlisting">  var geocodeService = new L.esri.Services.Geocoding();</pre></div></li><li class="listitem">Subscribe to the <code class="literal">click</code> event and add a function that calls <code class="literal">reverse()</code>, passing longitude and latitude options, and a callback function. The callback function will create a marker, add it to the map, and then bind a pop up. The address is stored in the result object as <code class="literal">result.address</code>. This code will add a point every time you click on the map. To only have one point displayed, add <code class="literal">map.removeLayer(r)</code> before creating the marker:<div class="informalexample"><pre class="programlisting">map.on('click', function(e){
geocodeService.reverse(e.latlng, {}, function(error,  result){
r = L.marker(result.latlng).addTo(map).bindPopup(result.address ).openPopup();
    });
 });</pre></div></li></ol></div><p>When you are finished, your map will look like this:</p><div class="mediaobject"><img src="images/4812OS_05_10.jpg" alt="Reverse geocoding – using points to find addresses"/></div></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Query by attribute"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec44"/>Query by attribute</h1></div></div></div><p>When consuming a service, you usually load the entire layer. Sometimes, you may only want a subset<a id="id419" class="indexterm"/> of the layer data. Using a query will allow you to load only that subset that you are interested in. In this example, you<a id="id420" class="indexterm"/> will query a graffiti layer for open and closed cases. To create the map, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Reference the Esri-leaflet file as you have seen in the previous examples. You do not need any additional files. Style the &lt;<code class="literal">div</code>&gt; query using CSS:<div class="informalexample"><pre class="programlisting">&lt;style&gt;
  #query {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
    background: white;
    padding: 1em;
  }
  #query select {
    font-size: 16px;
  }
&lt;/style&gt;</pre></div></li><li class="listitem">Create the selection element and add <code class="literal">Open</code> and <code class="literal">Closed</code> as options:<div class="informalexample"><pre class="programlisting">&lt;label&gt;
 Status
  &lt;select id="caseStatus"&gt;
    &lt;option value=''&gt;Clear Screen&lt;/option&gt;
    &lt;option value='Open'&gt;Open&lt;/option&gt;
    &lt;option value='Closed'&gt;Closed&lt;/option&gt;
      &lt;/select&gt;
&lt;/label&gt;</pre></div></li><li class="listitem">Add a feature layer that connects<a id="id421" class="indexterm"/> to the graffiti service. Use the <code class="literal">pointToLayer</code> option to create a marker for each feature and<a id="id422" class="indexterm"/> add them to the map:<div class="informalexample"><pre class="programlisting">var graffiti =  L.esri.featureLayer('http://services.arcgis.com/ rOo16HdIMeOBI4Mb/ArcGIS/rest/services/Graffiti_Locations3 /FeatureServer/0', {
   pointToLayer: function (geojson, latlng, feature) {
      return L.marker(latlng);
    },
  }).addTo(map);</pre></div></li><li class="listitem">Create a <code class="literal">popupTemplate</code> variable. You can find the parameters in the layer by browsing to the link in the feature layer. Bind the pop up by creating a function that returns the template. The template allows you to pass the fields contained in the ESRI layer to the template. The field name goes in curly braces. Then, you can use the template as your string in <code class="literal">bindPopup()</code>:<div class="informalexample"><pre class="programlisting">var popupTemplate = 
   "&lt;h3&gt;Details:&lt;/h3&gt;Address:{Incident_Address_Display}&lt;br&gt;
Borough: {Borough}&lt;br&gt;Community Board: 
{Community_Board}&lt;br&gt;Police Precinct:  {Police_Precinct}&lt;br&gt;City_Council_District: {City_Council_District}&lt;br&gt;Created_Date: {Created_Date}&lt;br&gt;Status: {Status}&lt;br&gt;Resolution_Action: {Resolution_Action}&lt;br&gt;Closed_Date: {Closed_Date}&lt;br&gt;City: {City}&lt;br&gt;State: {State}";
graffiti.bindPopup(function(feature){
return L.Util.template(popupTemplate, feature.properties)
      });</pre></div></li><li class="listitem">Create an event for when the selection element changes. Pass the value of the current selection to the method <code class="literal">setWhere()</code>. This method refreshes the feature layer based on the <code class="literal">where</code> query. In this example, <code class="literal">where</code> is the value of the <code class="literal">status</code> property:<div class="informalexample"><pre class="programlisting">  caseStatus.addEventListener('change', function(){
  graffiti.setWhere('Status="'+caseStatus.value+'"');
  });</pre></div></li></ol></div><p>When you are finished, you can select <span class="strong"><strong>Closed</strong></span>, and the map will look like this:</p><div class="mediaobject"><img src="images/4812OS_05_11.jpg" alt="Query by attribute"/></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Query by proximity"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec45"/>Query by proximity</h1></div></div></div><p>In the previous example, you queried a feature layer based on an attribute. You can also query your feature layer based on its proximity to a point. In this example, you will query the layer based on the location of a mouse click. The following instructions will walk you through<a id="id423" class="indexterm"/> creating a proximity query:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Reference the Esri-leaflet file as you have in previous examples. Add the feature layer to the map. You will pass the <code class="literal">pointToLayer</code> option, returning <code class="literal">circleMarker</code> for each feature. You need to create the circle marker so that you can change the color of the marker in a later step:<div class="informalexample"><pre class="programlisting">var graffiti = L.esri.featureLayer('http://services.arcgis.com/ rOo16HdIMeOBI4Mb/ArcGIS/rest/services/Graffiti_Locations3/FeatureServer/0', {
   pointToLayer: function (geojson, latlng) {
      return L.circleMarker(latlng);
    },
  }).addTo(map);</pre></div></li><li class="listitem">Create a pop-up template using the feature properties. Bind the pop up to the feature as follows:<div class="informalexample"><pre class="programlisting">var popupTemplate = "&lt;h3&gt;Details:&lt;/h3&gt;Address: Incident_Address_Display}&lt;br&gt;Borough: {Borough}&lt;br&gt;Community Board: Community_Board}&lt;br&gt;Police Precinct: {Police_Precinct}&lt;br&gt;City_Council_District: City_Council_District}&lt;br&gt;Created_Date: {Created_Date}&lt;br&gt;Status: Status}&lt;br&gt;Resolution_Action: {Resolution_Action}&lt;br&gt;Closed_Date: Closed_Date}&lt;br&gt;City: {City}&lt;br&gt;State: {State}";
graffiti.bindPopup(function(feature){
return L.Util.template(popupTemplate, feature.properties)
  });</pre></div></li><li class="listitem">Create a query. If you<a id="id424" class="indexterm"/> browse to the service—place the URL of the query in your browser—and scroll to the bottom of the page, you will see on the last line that this service supports querying. Pass the query to the layer you want to query:<div class="informalexample"><pre class="programlisting">var query = 
L.esri.Tasks.query('http://services.arcgis.com/  rOo16HdIMeOBI4Mb/ArcGIS/rest/services/  Graffiti_Locations3/FeatureServer /0');</pre></div></li><li class="listitem">Create an event for a mouse click and subscribe using the <code class="literal">runQuery()</code> function:<div class="informalexample"><pre class="programlisting">map.on('click', runQuery);</pre></div></li><li class="listitem">Create a function, <code class="literal">runQuery()</code>, to be executed when the user clicks on the map. This function will do three things: it will execute a query using the <code class="literal">nearby()</code> method, passing <a id="id425" class="indexterm"/>the latitude and longitude of the mouse click and a distance of 804 meters (half mile); it will set the style of all of the circle markers to blue; and it will take the results of the query and pass the ID of every marker that is returned to a <code class="literal">style</code> function, turning them green. We used the circle marker in the second step so that we could change the color to highlight the query results:<div class="informalexample"><pre class="programlisting">function runQuery(e){
graffiti.query().nearby(e.latlng,804).ids(function  (error,ids){
graffiti.setStyle(function(){return { color: "blue"};});
for(var i=0;i&lt;ids.length;i++){graffiti.setFeatureStyle(ids[i], {color:"green"});}});
}</pre></div></li></ol></div><p>When you click on the map, it should look like this:</p><div class="mediaobject"><img src="images/4812OS_05_12.jpg" alt="Query by proximity"/></div><p>The green markers are all<a id="id426" class="indexterm"/> within half a mile of the user's click.</p></div></div>


  <div id="sbo-rt-content"><div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec46"/>Summary</h1></div></div></div><p>In this chapter, you learned how to use the most common file format for geographical data: the shapefile. You also learned how to use the <code class="literal">esri-leaflet</code> plugin to connect to ESRI services and add basemaps as well as five other ESRI layer types. You already learned about heatmaps previously, but in this chapter, you also learned how to consume ESRI services and add them as a heatmap. You learned how to geocode an address to a map and also how to reverse geocode a point to a street address. Lastly, you learned how to query an ESRI service first by attribute and then by location.</p><p>In the next chapter, you will combine everything you have learned to create an application using Leaflet with other programming languages.</p></div></div>
</body></html>