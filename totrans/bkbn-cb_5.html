<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Events and Bindings</h1></div></div></div><p>In this chapter, we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Managing events in <code class="literal">Backbone.js</code></li><li class="listitem" style="list-style-type: disc">Handling events of Backbone objects</li><li class="listitem" style="list-style-type: disc">Binding a model to a view</li><li class="listitem" style="list-style-type: disc">Binding a collection to a view</li><li class="listitem" style="list-style-type: disc">Bidirectional binding with <code class="literal">Backbone.stickit</code></li><li class="listitem" style="list-style-type: disc">Binding a model and a collection to a select list</li><li class="listitem" style="list-style-type: disc">Handling keyboard shortcuts in a view</li><li class="listitem" style="list-style-type: disc">Handling router events</li></ul></div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec51"/>Introduction</h1></div></div></div><p>This chapter is devoted to the <code class="literal">Backbone.Events</code> object and its involvement in other Backbone objects, such as models, collections, views, and routers.</p><p>We will learn how to assign a callback to a specific event or how to listen to events of other objects. We will also learn how to bind a model or a collection to a view in both directions. So if a model is updated, the view automatically shows the changes, or if a user inputs data into a view, the model is validated and updated.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec52"/>Managing events in Backbone.js</h1></div></div></div><p>Backbone <a class="indexterm" id="id389"/>provides a unified way for triggering and handling events in other <a class="indexterm" id="id390"/>Backbone objects, such as <code class="literal">Model</code>, <code class="literal">Collection</code>, <code class="literal">View</code>, and <code class="literal">Router</code>. This becomes possible due to the <code class="literal">Backbone.Events</code> object, which provides this functionality and thus can be mixed to any object, including your own.</p><p>In this recipe, we are going to learn how to mix <code class="literal">Backbone.Events</code><a class="indexterm" id="id391"/> to your own object, how to trigger an event, and how to bind a callback to an event.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec138"/>How to do it...</h2></div></div></div><p>Perform<a class="indexterm" id="id392"/> the following<a class="indexterm" id="id393"/> steps to handle object events.</p><div><ol class="orderedlist arabic"><li class="listitem">Define a new object.<div><pre class="programlisting">object1 = {};</pre></div></li><li class="listitem">Mix <code class="literal">Backbone.Events</code> to your object.<div><pre class="programlisting">_.extend(object1, Backbone.Events);</pre></div></li><li class="listitem">Define a callback function.<div><pre class="programlisting">var hello = function(msg) {
  alert("Hello"+ msg);     
}</pre></div></li><li class="listitem">Bind the callback using the <code class="literal">on()</code> method<a class="indexterm" id="id394"/>.<div><pre class="programlisting">object1.on("handshake", hello);</pre></div><p>Alternatively, you can use the <code class="literal">once()</code> method<a class="indexterm" id="id395"/> to fire the callback once before it is unbound.</p><div><pre class="programlisting">object1.once("handshake", hello);</pre></div><div><div><h3 class="title"><a id="note13"/>Note</h3><p>If you have a large number of different events for an object, the convention is to use colons to name them <code class="literal">poll:start</code>, or <code class="literal">change:selection</code>.</p></div></div></li><li class="listitem">Trigger an event by calling the <a class="indexterm" id="id396"/><code class="literal">trigger()</code> method.<div><pre class="programlisting">object1.trigger("handshake", "world!");</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec139"/>How it works...</h2></div></div></div><p>In the <code class="literal">on()</code> method, <code class="literal">Backbone.Events</code> saves callback in an associative array <code class="literal">_events</code>, and then in the <code class="literal">trigger()</code> method it runs all callbacks for that event iteratively.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec140"/>There's more...</h2></div></div></div><p>In this section, we will learn some important topics about events: unbinding callback from the event and listening events of other objects.</p><div><div><div><div><h3 class="title"><a id="ch05lvl3sec47"/>Unbinding callback from the event</h3></div></div></div><p>To unbind callbacks <a class="indexterm" id="id397"/>from the event, we need to use the <code class="literal">off()</code> method<a class="indexterm" id="id398"/>. The following line of code will unbind a specific callback we set previously.</p><div><pre class="programlisting">object1.off("handshake", hello);</pre></div><p>To unbind all callbacks from the event, skip the second parameter.</p><div><pre class="programlisting">object1.off("handshake");</pre></div><p>To unbind a specific callback from all events, skip the first parameter.</p><div><pre class="programlisting">object1.off(null, hello);</pre></div><p>To unbind all callbacks from all events, skip both parameters.</p><div><pre class="programlisting">object1.off();</pre></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec48"/>Listening to events on other objects</h3></div></div></div><p>To listen to <a class="indexterm" id="id399"/>events on other objects, we can use the <a class="indexterm" id="id400"/>
<code class="literal">listenTo()</code> method.</p><div><pre class="programlisting">object2.listenTo(object1, 'handshake', object2.hello);</pre></div><p>It works similar to the <code class="literal">on()</code> method, but its advantage is that it allows us to keep a track of the events, and they can be removed all at once later on.</p><div><pre class="programlisting">object2.stopListening(object1);</pre></div><p>To stop listening to all objects, run the <code class="literal">stopListening()</code> method without parameters.</p><div><pre class="programlisting">object2.stopListening();</pre></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec53"/>Handling events of Backbone objects</h1></div></div></div><p>All <a class="indexterm" id="id401"/>Backbone objects implement <code class="literal">Backbone.Events</code>, and <a class="indexterm" id="id402"/>some of them provide built-in events, to which your objects can listen.</p><p>For example, a <code class="literal">change</code> event is fired when a model is changed. Especially for this event, there are several methods in <code class="literal">Backbone.Model</code> that can be used in the <code class="literal">change</code> event callback. In this recipe, we are going to learn how to use them.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec141"/>How to do it...</h2></div></div></div><p>Perform the following steps to handle model events.</p><div><ol class="orderedlist arabic"><li class="listitem">Create a new <code class="literal">model</code> instance.<div><pre class="programlisting">  var model = new Backbone.Model({
    firstName: 'John',
    lastName: 'Doe',
    age: 20,
  });</pre></div></li><li class="listitem">Bind<a class="indexterm" id="id403"/> the callback to the <code class="literal">change</code> event.<div><pre class="programlisting">  model.on('change', function(model) {

  }</pre></div></li><li class="listitem">Use <a class="indexterm" id="id404"/>the <code class="literal">hasChanged()</code> method in the event callback to check if the specific attribute has been changed since the last <code class="literal">change</code> event.<div><pre class="programlisting">    model.hasChanged("age"); // true
    model.hasChanged("firstName"); // false</pre></div></li><li class="listitem">Use the <code class="literal">changedAttributes()</code> method<a class="indexterm" id="id405"/> in the event callback to obtain changed attributes' hash.<div><pre class="programlisting">    model.changedAttributes(); // Object {age: 21}</pre></div></li><li class="listitem">Use the <code class="literal">previous()</code> method<a class="indexterm" id="id406"/> in the event callback to get the value of the previous attribute.<div><pre class="programlisting">    model.previous('age'); // 20</pre></div></li><li class="listitem">Use the <code class="literal">previousAttributes()</code> method<a class="indexterm" id="id407"/> in the event callback to get the hash of the previous attributes.<div><pre class="programlisting">    model.previousAttributes();
      // Object {firstName: "John", lastName: "Doe", age: 20}</pre></div></li><li class="listitem">Change a <code class="literal">model</code> attribute to trigger the <code class="literal">change</code> event.<div><pre class="programlisting">    model.set('age', 21);</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec142"/>There's more...</h2></div></div></div><p>In this section, <a class="indexterm" id="id408"/>we are going to learn more about events to Backbone objects: avoiding event triggering when working with Backbone objects and using built-in events.</p><div><div><div><div><h3 class="title"><a id="ch05lvl3sec49"/>Avoiding event triggering when working with Backbone objects</h3></div></div></div><p>There is<a class="indexterm" id="id409"/> a way to avoid event triggering when working with Backbone events. This can be helpful if you want to update object properties without making event callbacks know about this fact.</p><p>For example, you can pass <code class="literal">{silent: true}</code> when updating model values.</p><div><pre class="programlisting">model.set('age', 22, {silent: true});</pre></div><p>The following line of code is also valid:</p><div><pre class="programlisting">model.set({ age: 25 }, {silent: true});</pre></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec50"/>Using built-in events</h3></div></div></div><p>The following events <a class="indexterm" id="id410"/>are used with model objects:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>change</strong> (model, options): It<a class="indexterm" id="id411"/> is <a class="indexterm" id="id412"/>fired when a model's attributes have changed</li><li class="listitem" style="list-style-type: disc"><strong>change:[attribute]</strong> (model, value, options): It is <a class="indexterm" id="id413"/>fired when<a class="indexterm" id="id414"/> a specific attribute has been updated</li><li class="listitem" style="list-style-type: disc"><strong>destroy</strong> (model, collection, options): It is <a class="indexterm" id="id415"/>fired<a class="indexterm" id="id416"/> when a model is destroyed</li><li class="listitem" style="list-style-type: disc"><strong>invalid</strong> (model, error, options): It <a class="indexterm" id="id417"/>is fired when a <a class="indexterm" id="id418"/>model's validation fails on the client</li><li class="listitem" style="list-style-type: disc"><strong>error</strong> (model, xhr, options): It is <a class="indexterm" id="id419"/>fired when a model's save <a class="indexterm" id="id420"/>call fails on the server</li><li class="listitem" style="list-style-type: disc"><strong>sync</strong> (model, resp, options): It is<a class="indexterm" id="id421"/> fired when a model has<a class="indexterm" id="id422"/> been successfully synced with the server</li></ul></div><p>The following events are used with collections:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>add</strong> (model, collection, options): It is <a class="indexterm" id="id423"/>fired when a model is<a class="indexterm" id="id424"/> added to a collection</li><li class="listitem" style="list-style-type: disc"><strong>remove</strong> (model, collection, options): It <a class="indexterm" id="id425"/>is fired <a class="indexterm" id="id426"/>when a model is removed from a collection</li><li class="listitem" style="list-style-type: disc"><strong>reset</strong> (collection, options): It is <a class="indexterm" id="id427"/>fired when the entire <a class="indexterm" id="id428"/>content of the collection has been replaced</li><li class="listitem" style="list-style-type: disc"><strong>sort</strong> (collection, options): It<a class="indexterm" id="id429"/> is fired when the collection <a class="indexterm" id="id430"/>has been re-sorted</li><li class="listitem" style="list-style-type: disc"><strong>sync</strong> (collection, resp, options): It <a class="indexterm" id="id431"/>is fired when a collection <a class="indexterm" id="id432"/>has been successfully synced with the server</li></ul></div><p>The following events are used with the router object:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>route:[name]</strong> (params): It <a class="indexterm" id="id433"/>is fired<a class="indexterm" id="id434"/> by<a class="indexterm" id="id435"/> the router when a<a class="indexterm" id="id436"/> specific route is matched</li><li class="listitem" style="list-style-type: disc"><strong>route</strong> (router, route, params): It is fired by history (or router) when any route has been matched</li></ul></div><p>The following events are triggered when storage operations are performed:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>route:[name]</strong> (params): It is fired by the router when a specific route is matched</li><li class="listitem" style="list-style-type: disc"><strong>route</strong> (router, route, params): It is fired by history (or router) when any route has been matched</li></ul></div><p>To handle<a class="indexterm" id="id437"/> any triggered event, use the special event <code class="literal">all</code>.</p></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec143"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You can find the complete built-in events catalog from <a class="ulink" href="http://backbonejs.org/#Events-catalog">http://backbonejs.org/#Events-catalog</a></li><li class="listitem" style="list-style-type: disc">To check which Backbone methods support <code class="literal">{silent: true}</code>, please refer to the official docs</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec54"/>Binding a model to a view</h1></div></div></div><p>One of the <a class="indexterm" id="id438"/>useful features in <code class="literal">Backbone.js</code> is the ability to bind model changes to a view, thus a view is re-rendered every time a model is changed. It allows you to write less code and makes your application work like an AJAX app, for example, when new data is fetched from a REST server, the user sees the update immediately.</p><p>Let's take an example of the <em>Rendering a model in a view</em> recipe from <a class="link" href="ch04.html" title="Chapter 4. Views">Chapter 4</a>, <em>Views</em>, where we rendered a model with a view and modified it, so views is re-rendered every time the model is updated.</p><p>The view which we are going to implement will be rendered as shown in the following screenshot:</p><div><img alt="Binding a model to a view" src="img/2728OS_05_01.jpg"/></div><p>In the browser console, we can modify the model values, thus the <code class="literal">change</code> event is triggered and the view is re-rendered.</p><div><img alt="Binding a model to a view" src="img/2728OS_05_02.jpg"/></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec144"/>How to do it...</h2></div></div></div><p>Perform <a class="indexterm" id="id439"/>the following steps to bind a model to a view.</p><div><ol class="orderedlist arabic"><li class="listitem">Define a new model.<div><pre class="programlisting">  var InvoiceItemModel = Backbone.Model.extend({

  });</pre></div></li><li class="listitem">Define a view that renders this model.<div><pre class="programlisting">  var InvoiceItemView = Backbone.View.extend({
    
    // HTML element name, where to render a view.
    el: 'body',

    // Render view.
    render: function() {
      var html = 'Description: ' + 
        this.model.get('description') + '. ' +
        'Price: ' + this.model.get('price') + '. ' +
        'Quantity: ' + this.model.get('quantity') + '.';
      // Set html for the view element using jQuery.
      $(this.el).html(html);
    }
  });</pre></div></li><li class="listitem">Bind the model to <code class="literal">InvoiceItemView</code> in the <code class="literal">initialize()</code> method.<div><pre class="programlisting">    initialize: function() {
      this.listenTo(this.model, 'change', this.render, this);
    }</pre></div></li><li class="listitem">Create the model instance.<div><pre class="programlisting">    var invoiceItemModel = new InvoiceItemModel({
      description: 'Farmer Figure',
      price: 8,
      quantity: 1
    });</pre></div></li><li class="listitem">Create <a class="indexterm" id="id440"/>a view instance and pass <code class="literal">model</code> to it as a parameter.<div><pre class="programlisting">    var invoiceItemView = new InvoiceItemView({
      
      // Pass model as a parameter to a view.
      model: invoiceItemModel
    });</pre></div></li><li class="listitem">Render the view.<div><pre class="programlisting">    invoiceItemView.render();</pre></div></li><li class="listitem">To check how binding works, export the model to be a global variable, so we can update model values in a browser console.<div><pre class="programlisting">window.invoiceItemModel = invoiceItemModel;</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec145"/>How it works...</h2></div></div></div><p>Both the <code class="literal">Backbone.Model</code> and <code class="literal">Backbone.View</code> objects implement <code class="literal">Backbone.Events</code>, so it is possible to listen to model changes in the view and bind the <code class="literal">render()</code> method as a callback for the <code class="literal">change</code> event.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec55"/>Binding a collection to a view</h1></div></div></div><p>In this <a class="indexterm" id="id441"/>recipe, we are going to learn how to bind a collection to a view. This can be very helpful if we have different views working with the same collection, or if we want to synchronize data with a REST server.</p><p>Let's take an example of the <em>Rendering a model in a view</em> recipe from <a class="link" href="ch04.html" title="Chapter 4. Views">Chapter 4</a>, <em>Views</em>, where we rendered a collection with subviews and modified it. We are going to add an additional view with the <strong>Add</strong> and <strong>Remove</strong> buttons, which will update the collection.</p><p>Also, we <a class="indexterm" id="id442"/>will bind appropriate callbacks to the model and collection events in our first view, so it is re-rendered automatically when the collection is changed.</p><div><img alt="Binding a collection to a view" src="img/2728OS_05_03.jpg"/></div><p>When a user clicks on the <strong>Add</strong> button, he/she is prompted to enter the required information to create <code class="literal">InvoiceItemModel</code>.</p><div><img alt="Binding a collection to a view" src="img/2728OS_05_04.jpg"/></div><p>After the <a class="indexterm" id="id443"/>user goes through all the questions, a new model is created and added into a collection, and the corresponding views are updated.</p><div><img alt="Binding a collection to a view" src="img/2728OS_05_05.jpg"/></div><p>When the <strong>Remove</strong> button is clicked, the user is promoted to enter the position of the item to be removed.</p><div><img alt="Binding a collection to a view" src="img/2728OS_05_06.jpg"/></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec146"/>How to do it...</h2></div></div></div><p>Perform <a class="indexterm" id="id444"/>the following steps to bind a collection to a view.</p><div><ol class="orderedlist arabic"><li class="listitem">Make sure you have the model and collection definitions.<div><pre class="programlisting">  var InvoiceItemModel = Backbone.Model.extend({

  });

  var InvoiceItemCollection = Backbone.Collection.extend({
    model: InvoiceItemModel
  });</pre></div></li><li class="listitem">Define a view for rendering a single model.<div><pre class="programlisting">  // Define new view to render a model.
  var InvoiceItemView = Backbone.View.extend({
    
    // Define element tag name.
    tagName: 'tr',

    // Render view.
    render: function() {

      // Add cells to the table row.
      $(this.el).html(_.map([
        this.model.get('quantity'),
        this.model.get('description'),
        this.model.get('price'), this.model.calculateAmount(),
      ], function(val, key){
        return '&lt;td&gt;' + val + '&lt;/td&gt;'
      }));

      return this;
    }
  });</pre></div></li><li class="listitem">In the <code class="literal">initialize()</code> method of the <code class="literal">InvoiceItemView</code> object, bind callback to handle the <code class="literal">destroy</code> event of the model.<div><pre class="programlisting">    initialize: function() {
      this.listenTo(this.model, 'destroy', this.destroy, this);
    }</pre></div></li><li class="listitem">Add<a class="indexterm" id="id445"/> the <code class="literal">destroy()</code> method, which removes the view bound to a model.<div><pre class="programlisting">    destroy: function() {
      this.remove();
    }</pre></div></li><li class="listitem">Define a view for rendering a collection.<div><pre class="programlisting">  // Define new view to render a collection.
  var InvoiceItemListView = Backbone.View.extend({

    // Define element tag name.
    tagName: 'table',

    // Define element class name.
    className: 'invoice-item-view',

    // Render view.
    render: function() {

      $(this.el).empty();

      // Append table with a table header.
      $(this.el).append($('&lt;tr&gt;&lt;/tr&gt;').html(
        _.map(['Quantity', 'Description', 'Price', 'Total'], 
          function(val, key){
            return '&lt;th&gt;' + val + '&lt;/th&gt;'
          }
        )
      ));

      // Append table  with a row.
      _.each(this.collection.models, function(model, key) {
        this.append(model);
      }, this);

      return this;
    },

    // Add invoice item row to the table.
    append: function(model) {
      $(this.el).append(
        new InvoiceItemView({ model: model }).render().el
      );
    }
  });</pre></div><p>Here we used the <code class="literal">append()</code> method<a class="indexterm" id="id446"/>, which adds <code class="literal">InvoiceItemView</code> into the output table. We will use this method later on.</p></li><li class="listitem">In<a class="indexterm" id="id447"/> the <code class="literal">initialize()</code> method of the <code class="literal">InvoiceItemListView</code> object, bind the callback to handle the <code class="literal">add</code> event of the collection.<div><pre class="programlisting">    initialize: function() {
      this.listenTo(
        this.collection, 'add', this.append, this
      );
    },</pre></div><p>Here we have called the same <code class="literal">append()</code> method.</p></li><li class="listitem">Define the view with Add and Remove controls.<div><pre class="programlisting">  var InvoiceItemListControlsView = Backbone.View.extend({
    render: function() {
      var html = 
        '&lt;br&gt;&lt;input id="add" type="button"' value="Add" id&gt;' +
        ' &lt;input id="remove" type="button" value="Remove"&gt;';

      $(this.el).html(html);

      return this;
    },

    // Handle HTML events.
    events: {
      'click #add': 'addNewInvoiceItem',
      'click #remove': 'removeInvoiceItem',
    },

    // Add button handler.
    addNewInvoiceItem: function() {
      var description = prompt('Enter item description', '');
      var price = prompt('Enter item price', '0');
      var quantity = prompt('Enter item quantity', '1');

      this.collection.add([{
        description: description,
        price: price,
        quantity: quantity
      }]);
    },

    // Remove button handler.
    removeInvoiceItem: function() {
      var position =
        prompt('Enter position of item to remove', '');

      model = this.collection.at(position);
      model.destroy();
    }
  }); </pre></div></li><li class="listitem">Define a <a class="indexterm" id="id448"/>view for rendering a whole page.<div><pre class="programlisting">  var InvoiceItemListPageView = Backbone.View.extend({

    // Render whole page view.
    render: function() {
      $(this.el).html(new InvoiceItemListView({
        collection: this.collection
      }).render().el);

      $(this.el).append(new InvoiceItemListControlsView({
        collection: this.collection
      }).render().el);
    }
  });</pre></div></li><li class="listitem">Create and initialize the collection instance with data.<div><pre class="programlisting">var invoiceItemCollection = new InvoiceItemCollection([
  { description: 'Wooden Toy House', price: 22, quantity: 3 },
  { description: 'Farm Animal Set', price: 17, quantity: 1 }
]);</pre></div></li><li class="listitem">Create <a class="indexterm" id="id449"/>the whole page view instance and render it.<div><pre class="programlisting">    new InvoiceItemListPageView({
      collection: invoiceItemCollection,
      el: 'body'
    }).render();</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec147"/>How it works...</h2></div></div></div><p>When a new model is added to the collection, the <code class="literal">add</code> event is fired, and the model is rendered as a table row and appended to the table.</p><p>When a model is destroyed, the <code class="literal">destroy</code> event is fired, and a view corresponding to this model is removed, also a view element is removed from a DOM tree.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec56"/>Bidirectional binding with Backbone.stickit</h1></div></div></div><p>In <code class="literal">Backbone.js</code>, we <a class="indexterm" id="id450"/>can bind a model to a view out of the box, but it is not easy to make binding in reverse direction <a class="indexterm" id="id451"/>without the need to parse values of HTML elements.</p><p>In this recipe, we will speak about the <code class="literal">Backbone.stickit</code> extension, which allows developers to implement bidirectional binding of the model properties and view elements in a simple and native <code class="literal">Backbone.js</code> way.</p><p>Among many similar extensions, <code class="literal">Backbone.stickit</code> stands out by its perfect documentation, simplicity, and the great advantage that it gives to application developers. It was written in New York Times not so long time ago, and its popularity is being growing day-by-day. It is definitely one of the coolest extensions for <code class="literal">Backbone.js</code>.</p><p>In this recipe, we are going to build a simple application that has a couple of views bound to the same model, so if a user makes changes in the element of the first view, the second view is updated automatically. The user interface of our application will look like the following screenshot:</p><div><img alt="Bidirectional binding with Backbone.stickit" src="img/2728OS_05_07.jpg"/></div><p>There are a <a class="indexterm" id="id452"/>couple of views <a class="indexterm" id="id453"/>that are bound to the same model. When the user enters data into the form, the model and the other view are updated.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec148"/>Getting ready</h2></div></div></div><p>You can download the <code class="literal">Backbone.stickit</code> extension from the <strong>GitHub</strong> page <a class="ulink" href="https://github.com/nytimes/backbone.stickit">https://github.com/nytimes/backbone.stickit</a>. To include this extension into your project, save the <code class="literal">backbone.stickit.js</code> file into the <code class="literal">lib</code> folder of your project and include the reference to this file in <code class="literal">index.html</code>.</p><div><div><h3 class="title"><a id="note14"/>Note</h3><p>Including a Backbone extension into your project is described in detail in the <em>Extending an application with plugins</em> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Backbone">Chapter 1</a>, <em>Understanding Backbone</em>.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec149"/>How to do it...</h2></div></div></div><p>Perform the following steps to perform a bidirectional binding.</p><div><ol class="orderedlist arabic"><li class="listitem">Make sure you have a model defined.<div><pre class="programlisting">  var InvoiceItemModel = Backbone.Model.extend({

  });</pre></div></li><li class="listitem">Define the form view.<div><pre class="programlisting">  var InvoiceItemFormView = Backbone.View.extend({

    // Define class name of view element.
    className: 'invoice-item-form-view',
  });</pre></div></li><li class="listitem">Add<a class="indexterm" id="id454"/> the bindings hash to the view.<div><pre class="programlisting">    bindings: {
      '#description': 'description',
      '#price': 'price',
      '#quantity': 'quantity'
    }</pre></div><p>Here we used short binding definition, which acts as an alias for the detailed definition shown in the next snippet.</p><div><pre class="programlisting">    bindings: {
      '#description': { observe: 'description' },
      '#price': { observe: 'price' },
      '#quantity': { observe: 'quantity' }
    }</pre></div></li><li class="listitem">Add<a class="indexterm" id="id455"/> the <code class="literal">render()</code> method<a class="indexterm" id="id456"/> to the view and call <code class="literal">this.stickit()</code> after rendering.<div><pre class="programlisting">    render: function() {
      var html = '&lt;label&gt;Description:&lt;/label&gt;' + 
        '&lt;input type="text" id="description"&gt;&lt;/input&gt;&lt;br&gt;' +
        '&lt;label&gt;Price:&lt;/label&gt;' +
        '&lt;input type="text" id="price"&gt;&lt;/input&gt;&lt;br&gt;' +
        '&lt;label&gt;Quantity:&lt;/label&gt;' +
        '&lt;input type="text" id="quantity"&gt;&lt;/input&gt;&lt;br&gt;';

      // Set html for the view element using jQuery.
      $(this.el).html(html);

      // Here binding occurs.
      this.stickit();

      return this;
    }</pre></div></li><li class="listitem">Define the other view in a similar way.<div><pre class="programlisting">  var InvoiceItemView = Backbone.View.extend({

    // Define class name of view element.
    className: 'invoice-item-view',

    // Bind HTML elements to the view model.
    bindings: {
      '#description': 'description',
      '#price': 'price',
      '#quantity': 'quantity'
    },

    // Render view.
    render: function() {
      var html = 'Description:' +
        '&lt;span id="description"&gt;&lt;/span&gt;, ' +
        'Price:  &lt;span id="price"&gt;&lt;/span&gt;, ' +
        'Quantity:  &lt;span id="quantity"&gt;&lt;/span&gt;.';

      // Set html for the view element using jQuery.
      $(this.el).html(html);

      // Here binding occurs.
      this.stickit();

      return this;
    },
  });</pre></div></li><li class="listitem">Create<a class="indexterm" id="id457"/> a new <code class="literal">model</code> instance.<div><pre class="programlisting">    var invoiceItemModel = new InvoiceItemModel({
      description: 'Farmer Figure',
      price: 8,
      quantity: 1
    });</pre></div></li><li class="listitem">Append <a class="indexterm" id="id458"/>both views to the HTML body.<div><pre class="programlisting">    $('body').append(new InvoiceItemView({
      model: invoiceItemModel
    }).render().el);
    $('body').append(new InvoiceItemFormView({
      model: invoiceItemModel
    }).render().el);</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec150"/>How it works...</h2></div></div></div><p>Whenever the <code class="literal">stickit()</code> method<a class="indexterm" id="id459"/> is called, the stickit extension initializes <code class="literal">innerHTML</code> of the HTML elements, which we have defined in the bindings hash. Because of such initialization, Stickit lets us to keep our templates clean, and we don't need to pass model values into the <code class="literal">html</code> variable manually when rendering the view.</p><p>For <a class="indexterm" id="id460"/>the <code class="literal">InvoiceItemView</code> view, one-way binding is configured (model to view), so every time model properties get changed, the corresponding HTML elements are updated.</p><p>For the <code class="literal">InvoiceItemFormView</code> view, Stickit sets up two-way binding (model to view and then, view to model), connecting and reflecting changes in the view elements with changes in bound model attributes.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec151"/>There's more...</h2></div></div></div><p>This section describes advanced usage<a class="indexterm" id="id461"/> of the <code class="literal">Backbone.stickit</code> extension: overriding model getters and setters, overriding view element updates, and listening to a specific HTML event.</p><div><div><div><div><h3 class="title"><a id="ch05lvl3sec51"/>Overriding model getters and setters</h3></div></div></div><p>When <a class="indexterm" id="id462"/>getting or setting <a class="indexterm" id="id463"/>properties of a model bound to our view, we can override the getting or setting behavior by specifying the <code class="literal">onGet</code> and <code class="literal">onSet</code> callbacks.</p><div><pre class="programlisting">    bindings: {
      '#price': {
        observe: 'price',
        onGet: 'priceGetter',
        onGet: 'priceSetter'
      }
    },
    priceGetter: function(val, options) { 
      return '$ ' + val; 
    },
    priceSetter: function(val, options) { 
      return Number(val.replace(/[^0-9\.]+/g, ''));
    }</pre></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec52"/>Overriding view element updates</h3></div></div></div><p>There <a class="indexterm" id="id464"/>are different ways in <a class="indexterm" id="id465"/>which we can override and customize view element updates. We can specify an <code class="literal">update</code> callback, which is triggered when an HTML element gets updated or we can specify <code class="literal">afterUpdate</code> callback, which will be executed afterwards.</p><div><pre class="programlisting">    bindings: {
      '#price': {
        observe: 'price',
        update: function($el, val, model, options) { 
          $el.val(val);
        }
        afterUpdate: 'highlight',
      },
      },
      highlight: function($el, val, options) { 
        $el.animate({ backgroundColor: "#ff9999" }, "fast")
          .animate({ backgroundColor: "#ffffff" }, "fast");
      } 
    }</pre></div><p>There is another way in which we can override value update for the view element by specifying <code class="literal">updateMethod</code>. By default it uses the <code class="literal">text</code> method, but we can change its value to <code class="literal">html</code>. If the <code class="literal">html</code> method is used, and we want to escape model values before assigning it to an HTML element, we can set the <code class="literal">escape</code> option to <code class="literal">true</code>.</p><div><pre class="programlisting">    bindings: {
      '#price': {
        observe: 'price',
        updateMethod: 'html',
        escape: true
      }
    }</pre></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec53"/>Listening to a specific HTML event</h3></div></div></div><p>By default, <a class="indexterm" id="id466"/>for a textbox, <a class="indexterm" id="id467"/>textarea and other content-editable HTML elements, the <code class="literal">Backbone.stickit</code> extension listens to the following events, <code class="literal">keyup</code>, <code class="literal">change</code>, <code class="literal">cut</code>, and <code class="literal">paste</code>. For other elements, the <code class="literal">Backbone.stickit</code> extension listens to the <code class="literal">change</code> event.</p><p>However, there is a way to override this setting by specifying the <code class="literal">events</code> array.</p><div><pre class="programlisting">    bindings: {
      '#price': {
        observe: 'price',
        events: ['blur'],
      },
    }</pre></div><p>In this case, <a class="indexterm" id="id468"/>view-to-model <a class="indexterm" id="id469"/>binding will occur on the <code class="literal">blur</code> event of the <code class="literal">#price</code> textbox.</p></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec152"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In the following recipe, we are going to continue learning about the Stickit extension. You can also find complete docs on <code class="literal">Backbone.stickit</code> on the <strong>GitHub</strong> page <a class="ulink" href="http://nytimes.github.com/backbone.stickit/">http://nytimes.github.com/backbone.stickit/</a>.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec57"/>Binding a model and a collection to a select list</h1></div></div></div><p>In the previous recipe, we talked about how to bind a model to an HTML arbitrary element of the view. In this recipe we are going to learn how to bind a model to a select element. By <a class="indexterm" id="id470"/>changing the value of the select list, we need to change the associated property of a bound model.</p><p>This is a bit<a class="indexterm" id="id471"/> more complex, because we may want to take key-value pairs for select options from an array or a collection. Fortunately, the <code class="literal">Backbone.stickit</code> extension allows us to do this easily.</p><p>In this recipe, we will create a simple example to demonstrate how we can bind a model and a collection to a select list.</p><div><img alt="Binding a model and a collection to a select list" src="img/2728OS_05_08.jpg"/></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec153"/>Getting ready</h2></div></div></div><p>You can download the <code class="literal">Backbone.stickit</code> extension from the <strong>GitHub</strong> page <a class="ulink" href="https://github.com/nytimes/backbone.stickit">https://github.com/nytimes/backbone.stickit</a>. To include this extension into your project, save the <code class="literal">backbone.stickit.js</code> file into the <code class="literal">lib</code> folder and include the reference to it in <code class="literal">index.html</code>.</p><div><div><h3 class="title"><a id="note15"/>Note</h3><p>Including the Backbone extension into your project is described in detail in the <em>Extending an application with plugins</em> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Backbone">Chapter 1</a>, <em>Understanding Backbone</em>.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec154"/>How to do it...</h2></div></div></div><p>Perform<a class="indexterm" id="id472"/> the<a class="indexterm" id="id473"/> following steps to bind a model and a collection to a select list.</p><div><ol class="orderedlist arabic"><li class="listitem">Define a model.<div><pre class="programlisting">  var InvoiceModel = Backbone.Model.extend({

  });</pre></div></li><li class="listitem">Define a view.<div><pre class="programlisting">  var InvoiceView = Backbone.View.extend({

    // Define class name of view element.
    className: 'invoice-item-view',

    },

    // Render view.
    render: function() {
      var html = 'Status: &lt;select id="items"&gt;&lt;/select&gt;';

      // Set html for the view element using jQuery.
      $(this.el).html(html);

      // Here binding occurs.
      this.stickit();

      return this;
    },
  });</pre></div></li><li class="listitem">Add bindings hash to the view.<div><pre class="programlisting">    // Bind HTML elements to the view model.
    bindings: {
      'select#items': {
        observe: 'status',

        // Define additional options for select element.
        selectOptions: {

          // You can return regular Backbone collection or
          // an array of objects.
          collection: function() {
            return [
              {name: null, label: '- Status-'},
              {name: 'in_progress', label: 'In Progress'},
              {name: 'complete', label: 'Complete'}
            ]
          },

          // Set the path to the label value for select
          // options within the collection of objects.
          labelPath: 'label',

          // Define the path to the values for select options
          // within the collection of objects. 
          valuePath: 'name'
        }
      }</pre></div></li><li class="listitem">Create <a class="indexterm" id="id474"/>a new model instance.<div><pre class="programlisting">    var invoiceModel = new InvoiceModel({ 
      status: 'in_progress' 
    });</pre></div></li><li class="listitem">Render the view.<div><pre class="programlisting">$('body').append(new InvoiceView({
  model: invoiceModel
}).render().el);</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec155"/>How it works...</h2></div></div></div><p><code class="literal">Backbone.stickit</code> takes values for select list options from the <code class="literal">collection</code> property and assumes <a class="indexterm" id="id475"/>that it defines either a path to a collection relative to the window object or a function, which returns a collection. Also, an array of objects can be used instead of a collection, as shown in the previous example.</p><p><code class="literal">labelPath</code> indicates a path to a property of a collection object, which is used as a label for select list options, and <code class="literal">valuePath</code> defines the path to an option value.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec156"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You can find additional details about binding a model and a collection to a select list on the <code class="literal">Bacbkone.stickit</code> <strong>GitHub</strong> page <a class="ulink" href="http://nytimes.github.com/backbone.stickit/">http://nytimes.github.com/backbone.stickit/</a></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec58"/>Handling keyboard shortcuts in a view</h1></div></div></div><p>To perform <a class="indexterm" id="id476"/>the best user experience, your application should support various types of navigation within an application. One of these ways could be achieved by using shortcuts. Shortcut is a combination of keystrokes that provides easier access to a command or operation.</p><p>In this recipe, we are going to handle a couple of shortcuts for a view we implemented in the <em>Binding a collection to a view</em> recipe.</p><p>To perform keyboard shortcut handling, we are going to use the <code class="literal">Moustrap</code> library and the <code class="literal">Backbone.Mousetrap</code> extension<a class="indexterm" id="id477"/>, which provide the functionality we need.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec157"/>Getting ready</h2></div></div></div><p>You can download both the <code class="literal">Moustrap</code> library<a class="indexterm" id="id478"/> and the <code class="literal">Backbone.Moustrap</code> extension from the <strong>GitHub</strong> pages <a class="ulink" href="https://github.com/ccampbell/mousetrap">https://github.com/ccampbell/mousetrap</a> and <a class="ulink" href="https://github.com/elasticsales/backbone.mousetrap">https://github.com/elasticsales/backbone.mousetrap</a> respectively.</p><p>To include them into your project, save the <code class="literal">mousetrap.js</code> and <code class="literal">backbone.mousetrap.js</code> files into the <code class="literal">lib</code> folder and include references to them in <code class="literal">index.html</code>.</p><div><div><h3 class="title"><a id="note16"/>Note</h3><p>Including a Backbone extension into your project is described in detail in the <em>Extending an application with plugins</em> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Backbone">Chapter 1</a>, <em>Understanding Backbone</em>.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec158"/>How to do it...</h2></div></div></div><p>To perform keyboard shortcut handling, add the following property into a view object:</p><div><pre class="programlisting">    keyboardEvents: {
      'shift+n': 'addNewInvoiceItem',
      'shift+d': 'removeInvoiceItem',
    },</pre></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec159"/>How it works...</h2></div></div></div><p><code class="literal">Backbone.Mousetrap</code> automatically delegates keyboard events to a view when it's being created and undelegates when it is removed or when <code class="literal">undelegateEvents()</code><a class="indexterm" id="id479"/> is called.</p><p>The <a class="indexterm" id="id480"/>following keys, <code class="literal">shift</code>, <code class="literal">ctrl</code>, <code class="literal">alt</code>, <code class="literal">option</code>, <code class="literal">meta</code>, and <code class="literal">command</code> are available. Other special keys are <code class="literal">backspace</code>, <code class="literal">tab</code>, <code class="literal">enter</code>, <code class="literal">return</code>, <code class="literal">capslock</code>, <code class="literal">esc</code>, <code class="literal">escape</code>, <code class="literal">space</code>, <code class="literal">pageup</code>, <code class="literal">pagedown</code>, <code class="literal">end</code>, <code class="literal">home</code>, <code class="literal">left</code>, <code class="literal">up</code>, <code class="literal">right</code>, <code class="literal">down</code>, <code class="literal">ins</code>, and <code class="literal">del</code>.</p><p>You should be able to reference any other key by names, such as <code class="literal">a</code>, <code class="literal">/</code>, <code class="literal">$</code>, <code class="literal">*</code>, or <code class="literal">=</code>.</p><p>By default, Mousetrap prevents shortcut events from being handled when the browser is focused on any form element, such as input, text area, or select box. However, if you want to handle a shortcut event for such elements, you can add the <code class="literal">mousetrap</code> class to it.</p><div><pre class="programlisting">&lt;textarea name="message" class="mousetrap"&gt;&lt;/textarea&gt;</pre></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec160"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Please visit the following resource in order to learn more about Mousetrap: <a class="ulink" href="http://craig.is/killing/mice">http://craig.is/killing/mice</a></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec59"/>Handling router events</h1></div></div></div><p>Though<a class="indexterm" id="id481"/> there are not many use cases for handling router events, <code class="literal">Backbone.js</code> provides a mechanism to do so. In this recipe, we are going to create a simple application that logs router events.</p><div><img alt="Handling router events" src="img/2728OS_05_09.jpg"/></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec161"/>How to do it...</h2></div></div></div><p>Perform<a class="indexterm" id="id482"/> the following steps in order to handle router events.</p><div><ol class="orderedlist arabic"><li class="listitem">Listen to the <code class="literal">route</code> event of <code class="literal">Backbone.History</code>.<div><pre class="programlisting">    initialize: function() {  
      Backbone.history.on('route', this.routeTracker);
    },</pre></div></li><li class="listitem">Define the <code class="literal">route</code> event callback.<div><pre class="programlisting">    routeTracker: function(router, route, params) {
      console.log(
       'Route: ' + route + '. Params: ' + params + '.'
      );
    },</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec162"/>How it works...</h2></div></div></div><p>The <code class="literal">route</code> event is triggered after routing has been successfully performed. The <code class="literal">route</code> event callback accepts the following parameters:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>router</strong>: This <a class="indexterm" id="id483"/>parameter indicates a current router in use</li><li class="listitem" style="list-style-type: disc"><strong>route</strong>: This parameter <a class="indexterm" id="id484"/>indicates a router callback name</li><li class="listitem" style="list-style-type: disc"><strong>params</strong>: This <a class="indexterm" id="id485"/>indicates parameters passed to a router callback</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec163"/>There's more...</h2></div></div></div><p>To handle <a class="indexterm" id="id486"/>a specific event for a specific router, listen to the <code class="literal">route:[name]</code> event.</p><div><pre class="programlisting">  var Workspace = Backbone.Router.extend({
    routes: {
      '': 'invoiceList',
      'invoice': 'invoiceList',
      'invoice/:id': 'invoicePage',
    },

    initialize: function() {
       this.on('route:invoicePage', this.invoicePageEvent);
    },

    invoicePageEvent: function(param1, param2) {
      console.log(param1);
    },
});</pre></div><p>In this case, the event callback accepts the <code class="literal">routes</code> parameters.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec164"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">More information about <code class="literal">routes</code> can be found in the <em>Implementing URL routing in your application</em> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Backbone">Chapter 1</a>, <em>Understanding Backbone</em></li></ul></div></div></div></body></html>