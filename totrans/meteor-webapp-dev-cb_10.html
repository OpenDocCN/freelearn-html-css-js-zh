<html><head></head><body><div class="chapter" title="Chapter&#xA0;10.&#xA0;Working with Accounts" id="aid-2BASE1"><div class="titlepage"><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Working with Accounts</h1></div></div></div><p>In this chapter, you will learn the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Implementing OAuth accounts packages</li><li class="listitem">Customizing the accounts login</li><li class="listitem">Performing two-factor authentication</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec73"/>Introduction</h1></div></div></div><p>Critical to nearly every application we build is some type of authentication and user identification. Usually, we will spend days and weeks developing an accounts system, when we could spend that time programming our app. Meteor solves this problem, and solves it well. From integrations with major OAuth providers (Twitter, Google, Facebook, etc.) to a simple, secure password-based system, adding accounts and authentication inside of your Meteor app is quick and painless. The recipes in this chapter will cover the most important aspects of Meteor's <code class="literal">accounts</code> packages, enabling you to easily take care of user accounts and move on to other things.</p></div></div>
<div class="section" title="Implementing OAuth accounts packages"><div class="titlepage" id="aid-2C9D02"><div><div><h1 class="title"><a id="ch10lvl1sec74"/>Implementing OAuth accounts packages</h1></div></div></div><p>Today, there are so <a id="id545" class="indexterm"/>many popular authentication services available, with such large user bases, that it's kind of silly not to take advantage of those services. If you use the accounts system of a major service, like Twitter or GitHub, you instantly tap into an enormous user base which can increase the use of your app. This recipe will show you how to implement an OAuth accounts system in a Meteor app, using the Twitter accounts service as an example.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec264"/>Getting ready</h2></div></div></div><p>We are going to focus almost exclusively on the accounts and authentication piece of our application, and as such, we only need a very simple, baseline application.</p><p>In a terminal window, create your root project by entering the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ meteor create twitter-login</strong></span>
<span class="strong"><strong>$ cd twitter-login</strong></span>
<span class="strong"><strong>$ mkdir {client,server,both}</strong></span>
<span class="strong"><strong>$ mv twitter-login.* client/</strong></span>
<span class="strong"><strong>$ meteor add twbs:bootstrap</strong></span>
<span class="strong"><strong>$ meteor</strong></span>
</pre></div><p>That's all it takes. Everything else will be done inside our recipe, so let's get going!</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec265"/>How to do it...</h2></div></div></div><p>We will add the <a id="id546" class="indexterm"/>appropriate <code class="literal">accounts</code> packages, and configure our Twitter login service. Proceed with the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In a new terminal window (keep your application running), navigate to the root folder of your project, and enter the following two commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ meteor add accounts-twitter</strong></span>
<span class="strong"><strong>$ meteor add accounts-ui</strong></span>
</pre></div><p>This will add several dependent packages, so you don't have to. How thoughtful and gentlemanly of Meteor to do that for us!</p><div class="note" title="Note"><h3 class="title"><a id="tip40"/>Tip</h3><p>You can just as easily use another authentication service by replacing <code class="literal">accounts-twitter</code> used in this step with any of the following: <code class="literal">accounts-facebook</code>, <code class="literal">accounts-github</code>, <code class="literal">accounts-google</code>, <code class="literal">accounts-meetup</code>, <code class="literal">account-weibo</code>, or <code class="literal">accounts-meteor-developer.</code></p></div></li><li class="listitem">Open <code class="literal">[project root]/client/twitter-login.html</code> and add the following template inclusion just after the starting <code class="literal">&lt;body&gt;</code> tag:<div class="informalexample"><pre class="programlisting">&lt;body&gt;
<span class="strong"><strong>  {{&gt; loginButtons}}</strong></span>
</pre></div></li><li class="listitem">Save this change, and navigate to your app in a browser (usually <code class="literal">http://localhost:3000/</code>). At the top-left of your screen you will see a red button that says <span class="strong"><strong>Configure Twitter Login</strong></span>, as shown in the following screenshot:<div class="mediaobject"><img src="../Images/image00409.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on <span class="strong"><strong>Configure Twitter Login</strong></span> button, and a set of instructions for configuring your Twitter app will appear. Follow those instructions <span class="emphasis"><em>exactly</em></span>, entering your <code class="literal">consumerkey</code> (API key) and consumer <code class="literal">secret</code> key(API secret) where appropriate.<div class="note" title="Note"><h3 class="title"><a id="tip41"/>Tip</h3><p>For this recipe, the value you enter in the website field is going to be <code class="literal">http://127.0.0.1:3000</code> rather than <code class="literal">http://localhost:3000</code>. Twitter doesn't allow the use of <code class="literal">localhost</code>.</p></div></li><li class="listitem">With your service <a id="id547" class="indexterm"/>configured, you are ready to log in. Click on the blue (formerly red) button labeled <span class="strong"><strong>Sign In</strong></span> with Twitter, and a new window should pop up, asking you to authorize your app, as shown in the following screenshot:<div class="mediaobject"><img src="../Images/image00410.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Once you authorize the app, you should be logged in, indicated by a status change in the <a id="id548" class="indexterm"/>login button, as shown in the following screenshot:<div class="mediaobject"><img src="../Images/image00411.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec266"/>How it works...</h2></div></div></div><p>This recipe is pretty packaged up, so there's not a lot of code involved. That said, we can dissect what's going on, so that we can understand where to tweak this recipe when needed.</p><p>Let's do a deep dive into how the authentication piece is working. <code class="literal">accounts-twitter</code> relies on the <code class="literal">accounts-base</code>, <code class="literal">accounts-oauth</code> and <code class="literal">twitter</code> packages. If we crack open each of those packages, we can see just how much legwork has been done for us:</p><div class="mediaobject"><img src="../Images/image00412.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p><p>Put as simply as possible, <code class="literal">accounts-ui</code> and <code class="literal">accounts-twitter</code> give you a responsive UI, and make calls to <code class="literal">accounts-base</code>, which handles all of the account administration. <code class="literal">accounts-oauth</code> helps <code class="literal">accounts-base</code> by handling the OAuth-specific events and calls. <code class="literal">accounts-oauth</code> is configured by the <code class="literal">twitter</code> package, which provides specific URLs and parameters needed to use Twitter's OAuth service.</p><p>Here's a more detailed explanation:</p><p>The <code class="literal">accounts-base</code> package is a generic accounts package that accepts different types of login methods, provides helper methods for account administration, and helps maintain the <code class="literal">users</code> collection. The <code class="literal">users</code> collection is where we store logged-in state, preferences, and profile information.</p><p>One of the exposed methods in <code class="literal">accounts-base</code> is <code class="literal">Accounts.registerLoginHandler()</code>, which can be used by more specific login packages (such as <code class="literal">accounts-oauth</code> or <code class="literal">accounts-password</code>) to register handlers for login <a id="id549" class="indexterm"/>information:</p><div class="mediaobject"><img src="../Images/image00413.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p><p>When <code class="literal">accounts-base</code> gets a request for a login, that request has a certain <code class="literal">type</code>, and has certain <code class="literal">service</code> parameters. <code class="literal">accounts-base</code> runs the information through all the login handlers that were registered, and lets each of those handlers respond with either <code class="literal">undefined</code> ("this is not my login method"), <code class="literal">error</code> ("the credentials were wrong"), or <code class="literal">serviceData</code> object ("login was accepted"), including a token for reconnecting easily.</p><p>The <code class="literal">accounts-oauth</code> package builds off of the <code class="literal">accounts-base</code> by registering a login handler of type: <code class="literal">'oauth'</code>, and exposing some helpers of its own. The <code class="literal">accounts-oauth</code> helpers allow us to configure a specific OAuth service. Each OAuth service requires customized URLs and parameters. We chose the Twitter OAuth service, and therefore used the <code class="literal">twitter</code> and <code class="literal">accounts-twitter</code> packages to configure those URLs and parameters.</p><p>The <code class="literal">accounts-oauth</code> packages is also responsible for handling the message/callback from the OAuth service, via the popup authentication form. That is, when the popup authentication from Twitter was complete, it redirected to <code class="literal">http://localhost:3000/_oauth/twitter</code> and had an OAuth token to pass to our app. The <code class="literal">accounts-oauth</code> package evaluates that particular URL (because we configured it with the <a id="id550" class="indexterm"/>
<code class="literal">twitter</code> package), snatches up the token, and then attempts a login, using the <code class="literal">Accounts.callLoginMethod()</code> with some JSON that looks similar to the following:</p><div class="informalexample"><pre class="programlisting">{
methodArguments: [{oauth: {
<span class="strong"><strong>credentialToken:</strong></span> "m3OHQUrRWU34anuq40Bx3q7JBoEmVgwKGICU1jY4H7_"
<span class="strong"><strong>credentialSecret:</strong></span> "2qPoqew8m-AXiC2OVfrkWem0_M_APcdMpnz-cGsl6-k"
}},
...
]}</pre></div><p>The login handler that <code class="literal">accounts-oauth</code> registered receives this JSON, and confirms with the (Twitter) OAuth service that the token is valid. If it is valid, a <code class="literal">user</code> profile is created/updated in the <code class="literal">users</code> collection, and <code class="literal">serviceData</code> (containing a login token, among other things) is passed to the client via a callback function. Because of the callback, and because the client is subscribing to the <code class="literal">users</code> collection, the client sees that there is a logged-in user, and acts accordingly.</p><p>The <code class="literal">twitter</code> and <code class="literal">accounts-twitter</code> packages contain convenience methods that work on top of <code class="literal">accounts-base</code> and <code class="literal">accounts-oauth</code>. For example, the <code class="literal">twitter</code> package has a server file (<code class="literal">twitter_server.js</code>) that declares the specific Twitter URLs, registers the <code class="literal">twitter</code> service through the <code class="literal">OAuth.registerService()</code> method, and even creates a Twitter-specific credential call, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">Twitter.retrieveCredential = 
 function(credentialToken, credentialSecret) {
    return OAuth.retrieveCredential(
      credentialToken, credentialSecret);
 };</pre></div><p>The <code class="literal">accounts-twitter</code> packages creates the <code class="literal">Meteor.loginWithTwitter()</code> method, and declares which profile fields are visible on the client, using <code class="literal">Accounts.addAutoPublishFields()</code>.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec267"/>There's more…</h2></div></div></div><p>Sometimes, seeing how the user and configuration information is stored can be helpful in understanding what's going on under the hood. We can do this using the <code class="literal">meteor mongo</code> command in a terminal window. Open a new terminal window (keep your application running), navigate to your project root, and enter the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ meteor mongo</strong></span>
</pre></div><p>You will now have command line access to the collections that store user information and login service configurations.</p><p>To view the Twitter <a id="id551" class="indexterm"/>configuration settings, enter the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt; db.meteor_accounts_loginServiceConfiguration.find()</strong></span>
</pre></div><p>You will see the configuration for your Twitter login service, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">{ "service" : "twitter", 
  "consumerKey" : "th2is2i2safa333kecon442sume24r433key", 
  "secret" : "th9isi9sa9fa87kesecr666e3t", 
  "loginStyle" : "popup", "_id" : "DBfakeYnnFbmidbC" 
}</pre></div><p>If you would like to reconfigure your Twitter login service, you can remove the entry using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt; db.meteor_accounts_loginServiceConfiguration.remove({})</strong></span>
</pre></div><p>Once you do this, you can follow the instructions on the screen and re-enter your Twitter credentials as you did in the preceding recipe.</p><p>To view the different states of a logged in user, run and re-run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt; db.users.findOne()</strong></span>
</pre></div><p>Go ahead and experiment with this, running it when the user is logged out, when the user is logged in, and when the user doesn't exist yet. Pay special attention to the <code class="literal">services</code> section and you'll be able to see how logins are handled by both the <code class="literal">twitter</code> and <code class="literal">resume</code> login services.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec268"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="emphasis"><em>Customizing the accounts login</em></span> recipe in this chapter</li><li class="listitem">The <span class="emphasis"><em>Building custom server methods</em></span> and <span class="emphasis"><em>Handling asynchronous events</em></span> recipes in <a class="link" title="Chapter 11. Leveraging Advanced Features" href="part0083.xhtml#aid-2F4UM1">Chapter 11</a>, <span class="emphasis"><em>Leveraging Advanced Features</em></span></li></ul></div></div></div>
<div class="section" title="Customizing the accounts login"><div class="titlepage" id="aid-2D7TI2"><div><div><h1 class="title"><a id="ch10lvl1sec75"/>Customizing the accounts login</h1></div></div></div><p>Packaged <a id="id552" class="indexterm"/>accounts logins are great and all, but they don't always go with the design of the rest of our page, or they provide too much functionality when all we need is a little functionality. This recipe will show you how to customize Meteor's accounts packages using the Twitter OAuth service as an example.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec269"/>Getting ready</h2></div></div></div><p>We will essentially be using the <span class="emphasis"><em>Implementing OAuth accounts packages</em></span> recipe found in this chapter as our baseline, but we aren't going to add the <code class="literal">accounts-ui</code> package, and therefore will not be configuring the Twitter service through the UI, so we need to roll our own.</p><p>In a terminal window, create your root project by entering the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ meteor create twitter-custom</strong></span>
<span class="strong"><strong>$ cd twitter-custom</strong></span>
<span class="strong"><strong>$ mkdir {client,server,both}</strong></span>
<span class="strong"><strong>$ mv twitter-custom.* client/</strong></span>
<span class="strong"><strong>$ meteor add twbs:bootstrap</strong></span>
<span class="strong"><strong>$ meteor</strong></span>
</pre></div><p>Open a new terminal window (keep your app running) and add the <code class="literal">accounts-twitter</code> and the <code class="literal">service-configuration</code> packages:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ meteor add service-configuration</strong></span>
<span class="strong"><strong>$ meteor add accounts-twitter</strong></span>
</pre></div><p>We now need to configure our login service manually, using the API key and API secret from our existing Twitter service (the one we created with the <span class="emphasis"><em>Implementing OAuth accounts packages</em></span> recipe). Create a file named <code class="literal">[project root]/server/auth-init.js</code> and add the following code, replacing the appropriate sections with your key and secret:</p><div class="informalexample"><pre class="programlisting">ServiceConfiguration.configurations.upsert({
  service:"twitter" },
  {
    $set: {
      "consumerKey" : "[your API Key from apps.twitter.com]",
      "secret" : "[your API secret from apps.twitter.com]"
    }
  }
);</pre></div><div class="note" title="Note"><h3 class="title"><a id="tip42"/>Tip</h3><p>When you copy your keys from the Twitter Apps page, there's usually an extra space character on the end. Make sure you remove that character (e.g. <code class="literal">"key123 "</code> needs to be <code class="literal">"key123"</code>) or your authentication will fail!</p></div><p>We are now ready to build our own customized login.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec270"/>How to do it...</h2></div></div></div><p>To build our own <a id="id553" class="indexterm"/>login, we'll need a couple of buttons, and some type of indicator that we're logged in. Easy peasy.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">[project root]/client/twitter-custom.html</code> and add the following template:<div class="informalexample"><pre class="programlisting">&lt;template name="customLogin"&gt;
  {{#if currentUser}}
    &lt;div id="logout" class="btn btn-info"&gt;Log out&lt;/div&gt;
    &lt;img src="{{profPic}}" alt=""&gt;
  {{else}}
    &lt;div id="login" class="btn btn-default"&gt;Log in&lt;/div&gt;
  {{/if}}
&lt;/template&gt;</pre></div></li><li class="listitem">We now want to call our template. Make the following changes inside the <code class="literal">&lt;body&gt;</code> tag, and save the file:<div class="informalexample"><pre class="programlisting">&lt;body&gt;
<span class="strong"><strong>  &lt;div class="container"&gt;</strong></span>
<span class="strong"><strong>    {{&gt;customLogin}}</strong></span>

    &lt;h1&gt;Welcome to Meteor!&lt;/h1&gt;

    {{&gt; hello}}
  &lt;/div&gt;
&lt;/body&gt;</pre></div></li><li class="listitem">Create a new file named <code class="literal">[project root]/client/templatehelpers.js</code>, and add the following <code class="literal">customLogin</code> template helpers:<div class="informalexample"><pre class="programlisting">Template.customLogin.helpers({
  profPic: function(){
    var loggedin = Meteor.user();
    return loggedin &amp;&amp;
loggedin.services...url;
  }
});</pre></div></li><li class="listitem">Now, let's hook up our login and logout buttons. In the same <code class="literal">templatehelpers.js</code> file, add the following events declarations:<div class="informalexample"><pre class="programlisting">Template.customLogin.events({
  'click #login' : function(e){
    Meteor.loginWithTwitter();
  },
  'click #logout': function(e){
    Meteor.logout();
  }
});</pre></div></li><li class="listitem">Save your changes, and navigate to your app in a browser (usually <code class="literal">http://localhost:3000</code>). You should see a login button, as shown in following screenshot:<div class="mediaobject"><img src="../Images/image00414.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">If you click the <a id="id554" class="indexterm"/><span class="strong"><strong>Log in</strong></span> button and authorize the Twitter app when prompted by the popup window, you will be authenticated and your Twitter avatar will appear, next to a <span class="strong"><strong>Log out</strong></span> button, as shown in the following screenshot:<div class="mediaobject"><img src="../Images/image00415.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec271"/>How it works...</h2></div></div></div><p>Starting in the <code class="literal">customLogin</code> template, we make use of the <code class="literal">{{#if currentUser}}</code> helper, which checks to see whether <code class="literal">Meteor.user()</code> is <code class="literal">null</code> or not. In other words, if a user is logged in, <code class="literal">currentUser</code> returns <code class="literal">true</code>.</p><p>If <code class="literal">currentUser</code> is <code class="literal">true</code>, we add a <span class="strong"><strong>Log out</strong></span> button, and an <code class="literal">&lt;img&gt;</code> tag, with the <code class="literal">src</code> attribute set to a property found on the user profile. Specifically, <code class="literal">profPic</code> returns the <code class="literal">services.twitter.profile_image_url</code> property if a user is logged in.</p><p>For the login and logout events, we simply call the <code class="literal">Meteor.loginWithTwitter()</code> (provided by the <code class="literal">accounts-twitter</code> package) and the <code class="literal">Meteor.logout()</code> methods. Meteor takes care of the rest for us.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec272"/>There's more…</h2></div></div></div><p>The accounts <a id="id555" class="indexterm"/>interface itself is quite customizable, with many packages available at <a class="ulink" href="https://atmospherejs.com/?q=accounts-ui">https://atmospherejs.com/?q=accounts-ui</a>.</p><p>We suggest installing the <code class="literal">accounts-ui-unstyled</code> package and experimenting with CSS/styling. You can get a great overview of what options and DOM elements are available by checking <a id="id556" class="indexterm"/>out the raw repository available at <a class="ulink" href="https://github.com/meteor/meteor/tree/devel/packages/accounts-ui-unstyled">https://github.com/meteor/meteor/tree/devel/packages/accounts-ui-unstyled</a>.</p><p>Pay particular attention <a id="id557" class="indexterm"/>to the <code class="literal">login_buttons.html</code> and <code class="literal">login_buttons.js</code> files, as they'll give you some pointers on what's possible.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec273"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="emphasis"><em>Implementing OAuth accounts packages</em></span> recipe in this chapter</li></ul></div></div></div>
<div class="section" title="Performing two-factor authentication"><div class="titlepage" id="aid-2E6E42"><div><div><h1 class="title"><a id="ch10lvl1sec76"/>Performing two-factor authentication</h1></div></div></div><p>We can make any <a id="id558" class="indexterm"/>application more secure (and safer from bots or hack attempts) by providing two-factor authentication. Two-factor authentication requires an individual to verify their identity using two separate methods. One such method, SMS text verification, has become quite popular, due to its convenience and difficulty in mimicking. This recipe will show you how to create two-factor authentication in a Meteor app, using the Twitter OAuth and Twilio SMS services.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec274"/>Getting ready</h2></div></div></div><p>Using the <span class="emphasis"><em>Customizing the accounts login</em></span> recipe found in this chapter, we already have an application that authenticates against Twitter. We will expand that recipe, and add the Twilio SMS service to send a 6-digit verification code for our second authentication challenge. So that we <a id="id559" class="indexterm"/>can focus on the authentication part of the recipe, we will set up the Twilio service here rather than in the main recipe.</p><div class="section" title="Creating our baseline application"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec25"/>Creating our baseline application</h3></div></div></div><p>Please follow <a id="id560" class="indexterm"/>the <span class="emphasis"><em>Customizing the accounts login</em></span> recipe found in this chapter, and recreate that project, changing the name from <code class="literal">twitter-custom</code> to <code class="literal">two-factor</code>.</p></div><div class="section" title="Signing up for the Twilio SMS service"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec26"/>Signing up for the Twilio SMS service</h3></div></div></div><p>Navigate to <a class="ulink" href="https://www.twilio.com/try-twilio">https://www.twilio.com/try-twilio</a> in a browser, or visit the home page at <a class="ulink" href="https://www.twilio.com/">https://www.twilio.com/</a>, and click on the <span class="strong"><strong>SIGN UP</strong></span> link on the top right.</p><p>Enter the <a id="id561" class="indexterm"/>necessary information to create <a id="id562" class="indexterm"/>an account, and click <span class="strong"><strong>Get Started</strong></span>.</p><p>Verify that you're human <a id="id563" class="indexterm"/>by entering your phone number and clicking on <span class="strong"><strong>Text Me</strong></span>. Shortly thereafter, you will receive a text message (if not, you can retry). Enter the code from that message into the verify section, and click on the <span class="strong"><strong>Verify</strong></span> button.</p><p>You will now have a phone number generated for you. Accept the default number, or choose one for yourself (the default one is free), and click on the <span class="strong"><strong>Go To Your Account</strong></span> button.</p><div class="note" title="Note"><h3 class="title"><a id="tip43"/>Tip</h3><p>Make a note of your assigned phone number, as you will need it later in this recipe.</p></div><p>Congratulations, you're all set up with a trial account from Twilio!</p></div><div class="section" title="Creating an SMS service on Twilio"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec27"/>Creating an SMS service on Twilio</h3></div></div></div><p>While logged <a id="id564" class="indexterm"/>in to Twilio, click on your name in the top right corner of the page. Select the <span class="strong"><strong>Account</strong></span> option to go to the <span class="strong"><strong>Account </strong></span><a id="id565" class="indexterm"/>
<span class="strong"><strong>Settings</strong></span> page. There you will be presented with two sets of API keys. You can use either of those for testing, but would obviously want to use the Live credentials for a production application. Your screen should look like the following screenshot:</p><div class="mediaobject"><img src="../Images/image00416.jpeg" alt="Creating an SMS service on Twilio"/></div><p style="clear:both; height: 1em;"> </p><p>Decide which <a id="id566" class="indexterm"/>credentials you'll be <a id="id567" class="indexterm"/>using, and make note of both the <span class="strong"><strong>AccountSID</strong></span> and the <span class="strong"><strong>AuthToken</strong></span>.</p></div><div class="section" title="Installing the twilio-node npm package"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec28"/>Installing the twilio-node npm package</h3></div></div></div><p>Stop your <a id="id568" class="indexterm"/>application (<span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>C</em></span>) in the terminal, and enter the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ meteor add meteorhacks:npm</strong></span>
</pre></div><p>Run your application <a id="id569" class="indexterm"/>again by entering the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ meteor</strong></span>
</pre></div><p>You will receive a message letting you know that <code class="literal">meteorhacks:npm</code> has been initialized, as shown in the following example:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>-&gt; npm support has been initialized.</strong></span>
<span class="strong"><strong>-&gt; please start your app again.</strong></span>
</pre></div><p>Before starting our app again, we will need to declare that we are going to use the <code class="literal">twilio-node</code> npm package. Open the newly-created <code class="literal">[project root]/packages.json</code> file, and add the following declaration:</p><div class="informalexample"><pre class="programlisting">{
<span class="strong"><strong>  "twilio":"1.10.0"</strong></span>
}</pre></div><p>Now, start your application back up again in the terminal, using the <code class="literal">meteor</code> command, as shown in the preceding examples.</p><p>With the <code class="literal">twilio-node</code> npm package installed, all that's left to do is create a Twilio messaging <a id="id570" class="indexterm"/>method and <a id="id571" class="indexterm"/>test it.</p></div><div class="section" title="Creating and testing the sendTwilio() method"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec29"/>Creating and testing the sendTwilio() method</h3></div></div></div><p>Create a <a id="id572" class="indexterm"/>new file named <code class="literal">[project root]/server/twilio.js</code> and add the following code, replacing the <code class="literal">AccountSID</code>, <code class="literal">AuthToken</code>, and <a id="id573" class="indexterm"/>
<code class="literal">Twilio Phone Number</code> as appropriate:</p><div class="informalexample"><pre class="programlisting">sendTwilio = function (phone, message) {
  return Meteor.wrapAsync(function (phone, message, callback) {
    var Twilio = Meteor.npmRequire('twilio')
      ('[YOUR AccountSID GOES HERE]',
        '[YOUR AuthToken GOES HERE]');
    var phoneNum = '+1' + phone;
    var twilioPhone = '[TWILIO NUMBER PATTERN: +1NUMBER]';
   
    Twilio.sendMessage({
      to: phoneNum,
      from: twilioPhone,
      body: message
    }, function (err, msg) {
      if (err) {
        callback &amp;&amp; callback(err);
      } else {
        callback &amp;&amp; callback(null, msg);
      }
    });
  })(phone, message);
};</pre></div><p>A good chunk of time could be spent explaining what all the preceding code does, but sufficeth to say, the <code class="literal">Twilio.sendMessage()</code> method gets called using <code class="literal">Meteor.wrapAsync()</code> with a callback, because Twilio is an npm module and therefore requires the wrapper. You <a id="id574" class="indexterm"/>should now be able to send messages to your phone, which you can test by opening a new terminal window (keep your app running), navigating to your root folder, and using the <code class="literal">meteor shell</code> command to test.</p><p>If your mobile number were <code class="literal">555.867.5309</code>, you would enter the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ meteor shell</strong></span>
<span class="strong"><strong>&gt; sendTwilio('5558675309','test',function(e,d){console.log(e,d);})</strong></span>
</pre></div><p>If everything is set up properly, you will get a text message on your phone, similar to the following screenshot:</p><div class="mediaobject"><img src="../Images/image00417.jpeg" alt="Creating and testing the sendTwilio() method"/></div><p style="clear:both; height: 1em;"> </p><p>If something went wrong, the console will spit out an error message, and you can trace down the source of your error.</p><p>Hopefully everything went <a id="id575" class="indexterm"/>right, and we are now ready to complete our <a id="id576" class="indexterm"/>two-factor authentication recipe!</p></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec275"/>How to do it...</h2></div></div></div><p>We'll start by <a id="id577" class="indexterm"/>getting everything running smoothly on the server side, incorporating a new login state called <code class="literal">verified</code>. Once the server side is complete, we'll then build out the different user states in our UI.</p><p>We will need to generate a 6-digit code to be sent to the user, and we can leverage an existing Meteor package to do so.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In a new terminal window (keep your app running), in the project root, enter the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ meteor add random</strong></span>
</pre></div></li><li class="listitem">Now, create a file named <code class="literal">[project root]/both/helpers.js</code> and add the following code:<div class="informalexample"><pre class="programlisting">Random.digits = function(len){
  var numArr = [0,1,2,3,4,5,6,7,8,9];
  var ret = '';
  while(ret.length&lt;len){
    ret+=Random.choice(numArr);
  }
  return ret;
};</pre></div></li><li class="listitem">We've just extended the random package to spit out simple codes of any length we choose. You can test this if you would like by entering <code class="literal">Random.digits(6)</code> in the web console.</li><li class="listitem">Open <code class="literal">[project root]/server/auth-init.js</code> and append the following declaration:<div class="informalexample"><pre class="programlisting">var verifiedField = ['services.twofactor.verified', 'services.twofactor.phone'];
Accounts.addAutopublishFields({ forLoggedInUser: verifiedField, forOtherUsers: [] });</pre></div></li><li class="listitem">Now, to make <a id="id578" class="indexterm"/>sure that the <code class="literal">services.twofactor.verified</code> property exists on each account, we will initialize it both when an account is created, and when a user logs in successfully. Append the following code to <code class="literal">auth-init.js</code>:<div class="informalexample"><pre class="programlisting">Accounts.onCreateUser(function(options,user) {
  check(options, Object);
  check(user, Object);
  user.services.twofactor = {};
  user.services.twofactor.code = Random.digits(6);
  user.services.twofactor.verified = false;
  user.profile = options.profile;
  return user;
});

Accounts.onLogin(function(options){
  if (options.type!=='resume'){
    Meteor.users.update(
      options.user._id,
      {$set:
       {"services.twofactor.verified":false,
        "services.twofactor.code":Random.digits(6)
       }
      }
    );
  }
});</pre></div></li><li class="listitem">Everything is in place for us to now create the SMS authentication challenge. Create a new file named <code class="literal">[project root]/server/auth-methods.js</code> and add the following <code class="literal">Meteor.methods</code> declarations:<div class="informalexample"><pre class="programlisting">Meteor.methods({
  sendChallenge : function (phone){
    if (!this.userId) return;
    var newCode = Random.digits(6);
    if (phone!=null){
      Meteor.users.update(
        this.userId,
        {$set:
         {"services.twofactor.phone":phone,
          "services.twofactor.code":newCode}});
    } else {
      Meteor.users.update(
        this.userId,
        {$set:
         {"services.twofactor.code":newCode}});
      
    }
    var curUser = Meteor.users.findOne(this.userId);
    return sendTwilio(curUser.services.twofactor.phone, curUser.services.twofactor.code);
  },
  verifyCode : function(code){
    if (!this.userId) return;
    var curUser = Meteor.users.findOne(this.userId);
    if (!curUser) return;
    if (curUser.services.twofactor.code == code){
      Meteor.users.update(
        this.userId,
        {$set:
         {"services.twofactor.verified":true}});
    }
  }
});</pre></div></li><li class="listitem">With everything <a id="id579" class="indexterm"/>on the server set, we now need to update our templates and events on the client side. Let's first create some kind of visual sign that we've successfully authenticated. Open [<code class="literal">project root]/client/two-factor.html</code> and modify the <code class="literal">&lt;button&gt;</code> element as follows:<div class="informalexample"><pre class="programlisting">&lt;button class="btn {{btnState}}"&gt;Click Me&lt;/button&gt;</pre></div></li><li class="listitem">Now open <code class="literal">two-factor.js</code> in the same folder and make the following addition to the <code class="literal">Template.hello.helpers</code> declaration:<div class="informalexample"><pre class="programlisting">counter: function () {
      return Session.get('counter');
    }<span class="strong"><strong>,</strong></span>
<span class="strong"><strong>    btnState: function(){</strong></span>
<span class="strong"><strong>      var curUser =Meteor.user();</strong></span>
<span class="strong"><strong>      if (curUser &amp;&amp; curUser.services.twofactor.verified)</strong></span>
<span class="strong"><strong>        return 'btn-success';</strong></span>
<span class="strong"><strong>      return 'btn-danger';</strong></span>
<span class="strong"><strong>    }</strong></span>
</pre></div></li><li class="listitem">Finally, make the following changes to the <code class="literal">'click button'</code> event handler:<div class="informalexample"><pre class="programlisting">'click button': function () {
      // increment the counter when button is clicked
<span class="strong"><strong>      var curUser =Meteor.user();</strong></span>
<span class="strong"><strong>      if (curUser &amp;&amp; curUser.services.twofactor.verified) {</strong></span>
<span class="strong"><strong>        Session.set('counter', Session.get('counter') + 1);</strong></span>
<span class="strong"><strong>      } else {</strong></span>
<span class="strong"><strong>        alert ('not authorized!');</strong></span>
<span class="strong"><strong>      }</strong></span>
    }</pre></div></li><li class="listitem">Everything else <a id="id580" class="indexterm"/>is done. We now only need to provide a way to make our server calls. Open <code class="literal">[project root]/client/two-factor.html</code> and make the following changes to the <code class="literal">customLogin</code> template:<div class="informalexample"><pre class="programlisting">&lt;template name="customLogin"&gt;
<span class="strong"><strong>  &lt;div class="btn-toolbar"&gt;</strong></span>
<span class="strong"><strong>    &lt;div class="btn-group" role="group"&gt;</strong></span>
      {{#if currentUser}}
      &lt;div type="button" id="logout" class="btn btn-info btn-lg"&gt;Log out&lt;/div&gt;
<span class="strong"><strong>      &lt;div id="profile" class="btn btn-default btn-lg"&gt;</strong></span>
       &lt;img src="{{profPic}}" alt=""&gt;
<span class="strong"><strong>      &lt;/div&gt;</strong></span>
      {{else}}
      &lt;div type="button" id="login" class="btn btn-default btn-lg"&gt;Log in&lt;/div&gt;
      {{/if}}
    &lt;/div&gt;
<span class="strong"><strong>    {{#if currentUser}}</strong></span>
<span class="strong"><strong>    {{&gt;secondLogin}}</strong></span>
<span class="strong"><strong>    {{/if}}</strong></span>
  &lt;/div&gt;
&lt;/template&gt;</pre></div></li><li class="listitem">We now need to create the <code class="literal">secondLogin</code> template, with conditionals based on whether the user is verified or not. Append the following template to the bottom of <code class="literal">two-factor.html</code>:<div class="informalexample"><pre class="programlisting">&lt;template name="secondLogin"&gt;
  {{#if verified}}
  &lt;div class="btn btn-success btn-lg"&gt;
    &lt;span class="glyphicon glyphicon-ok"&gt;&lt;/span&gt;
  &lt;/div&gt;
  {{else}}
  &lt;div class="btn-group" role="group"&gt;
    &lt;div class="btn btn-primary btn-lg" id="btnChallenge"&gt;
      &lt;span class="glyphicon glyphicon-phone"&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;input type="text" id="phoneNum" class="btn btn-default btn-lg" placeholder="{{defaultPhone}}"&gt;
  &lt;/div&gt;
  &lt;div class="btn-group" role="group"&gt;
    &lt;input type="text" id="verCode" class="btn btn-default btn-lg" placeholder="code..."&gt;
    &lt;div class="btn btn-primary btn-lg" id="btnVerify"&gt;
      &lt;span class="glyphicon glyphicon-check"&gt;&lt;/span&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  {{/if}}
&lt;/template&gt;</pre></div></li><li class="listitem">We have the <a id="id581" class="indexterm"/>tiniest bit of CSS to add to make our profile pic behave. Open the file named <code class="literal">[project root]/client/two-factor.css</code> and add the following CSS declarations:<div class="informalexample"><pre class="programlisting">#profile img {
  max-height: 44px;
  margin: 0 0;
}

#profile {
  padding: 0 0;
}</pre></div></li><li class="listitem">Open <code class="literal">[project root]/client/templatehelpers.js</code> and add the following helpers:<div class="informalexample"><pre class="programlisting">Template.secondLogin.helpers({
  verified: function(){
    var curUser = Meteor.user();
    return (curUser&amp;&amp;curUser.services.twofactor.verified);
  },
  defaultPhone: function(){
    var curUser = Meteor.user();
    return curUser &amp;&amp; curUser.services.twofactor.phone;
  }
});</pre></div></li><li class="listitem">Last of all, we need to add the event handlers for the buttons to send SMS texts and to verify the code found in the SMS messages. Append the following code to <code class="literal">templatehelpers.js</code>:<div class="informalexample"><pre class="programlisting">Template.secondLogin.events({
  'click #btnChallenge' : function (e){
    var phoneNum = $('#phoneNum').val();
    if (!phoneNum.length)
      phoneNum = $('#phoneNum').attr('placeholder');
    if (!phoneNum.length==10) return;
    Meteor.call('sendChallenge',phoneNum);
  },
  'click #btnVerify' : function(e){
    var verCode = $('#verCode').val();
    if (!verCode.length==6) return;
    Meteor.call('verifyCode',verCode);
  }
});</pre></div></li><li class="listitem">Save all your <a id="id582" class="indexterm"/>changes, and go ahead and test your new UI. Upon authenticating via Twitter, you will receive two text prompts and two buttons, as shown in the following screenshots:<div class="mediaobject"><img src="../Images/image00418.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>The button on the left will send a randomized code to the phone number you specify (or the saved phone number, if one exists). The button on the right will submit a verification code. If you entered the correct code (found in the text message sent to your phone), you will be verified, and your screen will look similar to the following screenshot:</p><div class="mediaobject"><img src="../Images/image00419.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><p>Congratulations, you've just implemented two-factor authentication in your Meteor app!</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec276"/>How it works...</h2></div></div></div><p>Several things had to be accomplished in order for two-factor authentication to work. First, we had to extend the <a id="id583" class="indexterm"/>users collection with a new service named <code class="literal">twofactor</code>. Some of the <code class="literal">services.twofactor</code> properties needed to be exposed for use on the client, and we had to set <code class="literal">services.twofactor.verified</code> to <code class="literal">false</code> whenever a new user was created, or when a user logs in using Twitter OAuth. Inside of our <code class="literal">auth-init.js</code> file, we accomplished both of these tasks, first by calling the <code class="literal">Accounts.addAutopublishFields()</code> method, and then by listening and updating via the <code class="literal">Accounts.onCreateUser()</code> and the <code class="literal">Accounts.onLogin()</code> event handlers:</p><div class="informalexample"><pre class="programlisting">Accounts.addAutopublishFields({ forLoggedInUser: <span class="strong"><strong>verifiedField,</strong></span> forOtherUsers: [] });
Accounts.onCreateUser(function(options,user) {
  ...
  user.services.twofactor.code = Random.digits(6);
<span class="strong"><strong>  user.services.twofactor.verified = false;</strong></span>
  ...
});
  Accounts.onLogin(function(options){
    ...
        {$set:
         {<span class="strong"><strong>"services.twofactor.verified":false,</strong></span>
          "services.twofactor.code":Random.digits(6)
         }
    ...
  });</pre></div><p>We added two server methods to helps us with verifying the user. The first, <code class="literal">sendChallenge()</code>, generates a new 6 digit random code, updates the <code class="literal">services.twofactor.code</code> property, and then sends the code to the specified phone number via the Twilio service. The second, <code class="literal">verifyCode()</code>, receives manual input from the user, checks the manually entered code against the <code class="literal">services.twofactor.code</code> property, and updates <code class="literal">services.twofactor.verified</code> to <code class="literal">true</code> if they match:</p><div class="informalexample"><pre class="programlisting">Meteor.methods({
<span class="strong"><strong>  sendChallenge</strong></span> : function (phone){
    if (!this.userId) return;
    var newCode = Random.digits(6);
    ...
    return <span class="strong"><strong>sendTwilio(...);</strong></span>
  },
<span class="strong"><strong>  verifyCode</strong></span> : function(code){
    ...
    if (curUser.services.twofactor.code == code){
      Meteor.users.update(
        this.userId,
        {$set:
         {<span class="strong"><strong>"services.twofactor.verified":true</strong></span>}});
    }
  }
});</pre></div><p>With the addition of the <code class="literal">verified</code> property, and the server methods used to change the <code class="literal">verified</code> property from <a id="id584" class="indexterm"/>
<code class="literal">false</code> to <code class="literal">true</code>, we can now use <code class="literal">verified</code> in our UI. We created a helper method, <code class="literal">Template.secondLogin.verified</code>, that checks to see if the <code class="literal">services.twofactor.verified</code> property is set to <code class="literal">true</code>. We then use this helper in our <code class="literal">secondLogin</code> template to show that the user is logged in and verified:</p><div class="informalexample"><pre class="programlisting">&lt;template name="secondLogin"&gt;
<span class="strong"><strong>  {{#if verified}}</strong></span>
  &lt;div class="btn btn-success btn-lg"&gt;
    &lt;span class="glyphicon <span class="strong"><strong>glyphicon-ok</strong></span>"&gt;&lt;/span&gt;
  &lt;/div&gt;
<span class="strong"><strong>  {{else}}</strong></span>
    ...
<span class="strong"><strong>  {{/if}}</strong></span>
&lt;/template&gt;</pre></div><p>The rest of the event handlers and helpers on the UI are used for convenience, or to make calls to the server methods previously outlined.</p><p>The simplified version is this: we extended the <code class="literal">users</code> collection, adding a <code class="literal">verified</code> property. We used the SMS text and verification to change the value of the <code class="literal">verified</code> property. We disallow any activity in the client UI unless <code class="literal">verified==true</code>. This check, as a complement to checking if there is a logged in user, allows us to require two-factor authentication in our UI.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec277"/>There's more…</h2></div></div></div><p>This model of extending the <code class="literal">users</code> collection with new <code class="literal">services</code> properties can be used for pretty much anything, and is not just limited to SMS text challenges. By adding and exposing new <code class="literal">services</code> properties, you can control what features are available, depending on the user status. Imagine being able to limit some features of the UI, based on the subscription plan a user has purchased. Or imagine remembering layout and view preferences based on the saved preferences of the user. All of this, and more, is possible by extending the <code class="literal">users</code> <a id="id585" class="indexterm"/>collection.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec278"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="emphasis"><em>Building a smooth interface with Bootstrap</em></span> recipe in <a class="link" title="Chapter 3. Building Great User Interfaces" href="part0036.xhtml#aid-12AK81">Chapter 3</a>, <span class="emphasis"><em>Building Great User Interfaces</em></span></li><li class="listitem">The <span class="emphasis"><em>Using npm packages directly</em></span> recipe in <a class="link" title="Chapter 8. Integrating Third-party Libraries" href="part0069.xhtml#aid-21PMQ1">Chapter 8</a>, <span class="emphasis"><em>Integrating Third-party Libraries</em></span></li><li class="listitem">The <span class="emphasis"><em>Customizing the accounts login</em></span> recipe in this chapter</li><li class="listitem">The <span class="emphasis"><em>Using asynchronous functions</em></span> recipe in <a class="link" title="Chapter 11. Leveraging Advanced Features" href="part0083.xhtml#aid-2F4UM1">Chapter 11</a>, <span class="emphasis"><em>Leveraging Advanced Features</em></span></li></ul></div></div></div></body></html>