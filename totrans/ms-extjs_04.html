<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch04"/>Chapter 4. The Logout and Multilingual Capabilities</h1></div></div></div><p>In this chapter, we are going to implement the multilingual capability of the system. This feature will allow the system to display the translation of the labels according to the language selected by the user (using some HTML5 features as well).</p><p>We will also learn how to implement the logout capability so that the user can end the session, and also for security reasons, we will learn how to implement a session timeout warning for the user, in the case of inactivity (not using the mouse or keyboard for a while).</p><p>Also, after the user is authenticated, we need to display the application. In this chapter, we will learn how to implement the base of the application.</p><p>So, in this chapter, we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The base of the application</li><li class="listitem" style="list-style-type: disc">The logout capability</li><li class="listitem" style="list-style-type: disc">Activity monitoring and session timeout warnings</li><li class="listitem" style="list-style-type: disc">Structuring the application to receive the multilingual capability</li><li class="listitem" style="list-style-type: disc">Creating the change language component</li><li class="listitem" style="list-style-type: disc">Handling the change language component at runtime</li></ul></div><p>While we cover all the application capabilities, we will cover some Ext JS components as well.</p><div><div><div><div><h1 class="title"><a id="ch04lvl1sec21"/>The base of the application – view/main/Main.js</h1></div></div></div><p>When we<a id="id328" class="indexterm"/> implemented the <code class="literal">success</code> function in the <strong>Submit</strong> button<a id="id329" class="indexterm"/> listener on the login controller, we mentioned the <code class="literal">Packt.view.main.Main</code> class. We are going to reuse this class (it was automatically created by Sencha Cmd when we created the project) as the base of our application. Before we start with the hands-on approach, let's take a look at what is going to be the result of the application by the end of this chapter:</p><div><img src="img/0457OT_04_01.jpg" alt="The base of the application – view/main/Main.js"/></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec42"/>The Viewport</h2></div></div></div><p>Whenever <a id="id330" class="indexterm"/>we construct an application entirely<a id="id331" class="indexterm"/> with Ext JS (because we do have the option of using a single component rendered to a <code class="literal">&lt;div&gt;</code> tag if we want to, in a manner similar to what is done in jQuery), we need to use a component that is going to be the base of the application. This component is the Viewport. The Viewport is a specialized container representing the viewable application area (the browser viewport). The Viewport renders itself to the document body, and automatically sizes itself to the size of the browser viewport and manages window resizing. There might only be one Viewport created in an application.</p><p>Before we create the Viewport, if we click on the <strong>Submit</strong> button of the <strong>Login</strong> screen, we will see a grayish screen, even though we are calling <code class="literal">Ext.create('Packt.view.main.Main');</code> inside the <code class="literal">LoginController</code> class. This means <code class="literal">Packt.view.main.Main</code> is being created, but nothing is being displayed on the screen. This is because the <code class="literal">Main</code> class is not being rendered as a child of any component, and it is also not being rendered to the HTML body. But we are going to change this behavior by changing it to a Viewport.</p><p>Open the <code class="literal">app/view/main/Main.js</code> file. In the second line of code, you will find the following snippet:</p><div><pre class="programlisting">extend: 'Ext.container.Container'</pre></div><p>The <code class="literal">Main</code> class that <a id="id332" class="indexterm"/>was created by Sencha Cmd is extending the <code class="literal">Container</code> component. The <code class="literal">Container</code> component is the simplest container component<a id="id333" class="indexterm"/> in the Ext JS API. It supports adding and removing items to it, and it is also the parent class to many other components, such as Panel, Window, and TabPanel. We are going to change <code class="literal">Ext.container.Container</code> to <code class="literal">Ext.container.Viewport</code> so that we can use the <code class="literal">Main</code> class as the base class of our application. Save the code, refresh the browser, and give it a try. The next time you click on the <strong>Submit</strong> button, you should see the original code created by Sencha Cmd after you are logged in.</p><div><div><div><div><h3 class="title"><a id="ch04lvl3sec13"/>Using the Viewport plugin</h3></div></div></div><p>Extending<a id="id334" class="indexterm"/> the <code class="literal">Ext.container.Viewport</code> class is the <a id="id335" class="indexterm"/>classic and traditional way of having a Viewport in Ext JS applications. Ext JS 5 introduces a new way of using a Viewport by using the Viewport plugin (<code class="literal">Ext.plugin.Viewport</code>).</p><div><div><h3 class="title"><a id="note31"/>Note</h3><p>To learn more about <a id="id336" class="indexterm"/>Ext JS plugins, please read <a class="ulink" href="http://www.sencha.com/blog/advanced-plugin-development-with-ext-js/">http://www.sencha.com/blog/advanced-plugin-development-with-ext-js/</a>.</p></div></div><p>To use the plugin, first roll back the changes we made in the preceding topic (the <code class="literal">Main</code> class will continue to extend <code class="literal">Ext.container.Container</code>) and add the following code after the <code class="literal">extend</code> code:</p><div><pre class="programlisting">Ext.define('Packt.view.main.Main', {
    extend: 'Ext.container.Container',

<strong>    plugins: 'viewport',</strong>

    xtype: 'app-main',</pre></div><p>Using the <code class="literal">plugins</code> configuration has the same result as extending the <code class="literal">Viewport</code> class. This plugin transforms any component into a Viewport, making it fill all the available space in the browser. The advantage of this plugin is that we can still reuse this class in other contexts, for example, inside a window.</p><p>We know that the <strong>ptype</strong> (plugin type) of the Viewport plugin is <strong>viewport</strong> by accessing the documentation:</p><div><img src="img/0457OT_04_02.jpg" alt="Using the Viewport plugin"/></div><div><div><h3 class="title"><a id="tip17"/>Tip</h3><p>Always remember that <a id="id337" class="indexterm"/>the documentation <a id="id338" class="indexterm"/>needs to be your best friend while developing Ext JS applications!</p></div></div></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec43"/>Organizing the main screen using the Border layout</h2></div></div></div><p>As we <a id="id339" class="indexterm"/>learned in <a class="link" href="ch01.html" title="Chapter 1. Sencha Ext JS Overview">Chapter 1</a>, <em>Sencha Ext JS Overview</em>, the Border layout can be used to organize the children of a parent container into five regions: north, south, west, east, and center.</p><p>The center<a id="id340" class="indexterm"/> region is the only one that is mandatory to have. The other ones are optional. Looking at the following screenshot, we can see that we are going to organize our main screen into four regions: <strong>center</strong>, <strong>north</strong>, <strong>south</strong>, and <strong>west</strong>:</p><div><img src="img/0457OT_04_03.jpg" alt="Organizing the main screen using the Border layout"/></div><p>Let's take a look at the <code class="literal">items</code> configuration of the <code class="literal">Main</code> class (you can replace the code that was generated by <a id="id341" class="indexterm"/>Sencha Cmd with the following code):</p><div><pre class="programlisting">items: [{
    region: 'center',   // #1
    xtype: 'mainpanel'
},{
    xtype: 'appheader', // #2
    region: 'north'
},{
    xtype: 'appfooter', // #3
    region: 'south'
},{
    xtype: 'container', // #4
    region: 'west',
    width: 200,
    split: true
}]</pre></div><p>In the <code class="literal">center</code> region, we<a id="id342" class="indexterm"/> have <code class="literal">mainpanel</code> (<code class="literal">#1</code>). In <a class="link" href="ch05.html" title="Chapter 5. Advanced Dynamic Menu">Chapter 5</a>, <em>Advanced Dynamic Menu</em>, we are going to create a dynamic menu that will give the options to the user to open the screens the user is entitled to. Each screen the user opens will be created as a tab in <code class="literal">mainpanel</code>. We will create it in a minute.</p><p>In the <code class="literal">north</code> region, we have the header (<code class="literal">#2</code>), and in the <code class="literal">south</code> region, we have the footer (<code class="literal">#3</code>). We will also work on them in a minute.</p><p>In the <code class="literal">west</code> region, we have <code class="literal">container</code> (<code class="literal">#4</code>), which we will use in the next chapter to render the dynamic menu. For now, we will leave the space reserved for it.</p><p>It is important to know that for the <code class="literal">center</code> region, we do not need to specify <code class="literal">width</code> or <code class="literal">height</code>. The container that is being rendered in the <code class="literal">center</code> region is going to use whatever space is left in the Border layout. For the <code class="literal">south</code> and <code class="literal">north</code> regions, you are required to specify <code class="literal">height</code>. We will do this when we create <code class="literal">Header</code> and <code class="literal">Footer</code>. The <code class="literal">south</code> and <code class="literal">north</code> regions are going to use all the available horizontal space that is available in the screen—limited by <code class="literal">height</code>—which is why <code class="literal">width</code> is not required. For the <code class="literal">west</code> and <code class="literal">east</code> regions, it is required to specify <code class="literal">width</code>. As we are only using the <code class="literal">west</code> region, we specified <code class="literal">200</code> pixels (<code class="literal">#4</code>).</p><div><div><div><div><h3 class="title"><a id="ch04lvl3sec14"/>Creating the main TabPanel component</h3></div></div></div><p>We need to <a id="id343" class="indexterm"/>create <a id="id344" class="indexterm"/>the <code class="literal">mainpanel</code> component that we are using in the <code class="literal">center</code> region of the <code class="literal">Main</code> class. To do so, we are going to create a new file named <code class="literal">Panel.js</code> inside the <code class="literal">app/view/main</code> folder, and we are going to write the following code inside it:</p><div><pre class="programlisting">Ext.define('Packt.view.main.Panel', { // #1
    extend: 'Ext.tab.Panel',          // #2
    xtype: 'mainpanel',             // #3

    activeTab: 0,                     // #4

    items: [
        {
            xtype: 'panel',                      // #5
            closable: false,                     // #6
            iconCls: 'fa fa-home fa-lg tabIcon', // #7
            title: 'Home'          // #8 
        }
    ]
});</pre></div><p>As usual, we will <a id="id345" class="indexterm"/>start with the name of the class. The class name convention is <em>app namespace + folder </em>(inside <code class="literal">app</code>)<em> + filename </em>(without the <code class="literal">.js</code> extension), which will result in <code class="literal">Packt.view.main.Panel</code> (<code class="literal">#1</code>). The <code class="literal">main.Panel</code> class is extending the TabPanel component (<code class="literal">#2</code>).</p><p>In line <code class="literal">#3</code>, we<a id="id346" class="indexterm"/> have <code class="literal">xtype</code> of the <code class="literal">main.Panel</code> class. This is the <code class="literal">xytpe</code> class we used to instantiate this class inside the <code class="literal">Main</code> class. In line <code class="literal">#4</code>, we have the <code class="literal">activeTab</code> configuration. When we set a tab to active, the TabPanel component is going to display the contents of the tab, and it is also going to highlight it.</p><p>As we learned in <a class="link" href="ch01.html" title="Chapter 1. Sencha Ext JS Overview">Chapter 1</a>, <em>Sencha Ext JS Overview</em>, the TabPanel component is a container that has tabs as children organized by the Card layout, which means that the user will see the content of one active tab at a time. Each child declared inside the <code class="literal">items</code> configuration is an instance of the <code class="literal">tab</code> class (<code class="literal">Ext.tab.Tab</code>), and it can be of any type as we have in line <code class="literal">#5</code>. So as not to display an empty screen, we are displaying a <code class="literal">'Home'</code> tab (<code class="literal">#8</code>) that is a panel (<code class="literal">#5</code>), which means it can have toolbars and other components inside it as well. This <code class="literal">Home</code> tab cannot be closed (<code class="literal">#6</code>); otherwise, the user will see a blank space in the middle of the main screen, and we do not want that. We are also setting a Font Awesome icon in the format of <code class="literal">home</code> in line <code class="literal">#7</code> for it to look prettier.</p><p>You can use this <strong>Home</strong> tab to display announcements or to behave like a dashboard, where the user will see a summary of all the pending tasks.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec15"/>Creating the footer</h3></div></div></div><p>The<a id="id347" class="indexterm"/> next step is creating the <a id="id348" class="indexterm"/>footer of the main screen. We are going to create a new file named <code class="literal">Footer.js</code> inside <code class="literal">app/view/main</code> with the following code inside it:</p><div><pre class="programlisting">Ext.define('Packt.view.main.Footer', {
    extend: 'Ext.container.Container', //#1
    xtype: 'appfooter',                //#2

    cls: 'app-footer',                 //#3

    height: 30,                        //#4

    layout: 'center',                  //#5

    items: [
        {
            xtype: 'component',               //#6
            width: 350,                       //#7
            componentCls: 'app-footer-title', //#8
            bind: {
                html: '{footer}'              //#9
            }
        }
    ]
});</pre></div><p><code class="literal">Footer</code> is going to extend from the <code class="literal">Container</code> class (<code class="literal">#1</code>). The <code class="literal">Container</code> class is the lightest component that we can create that can have items inside it. We should give preference to use it whenever possible. We will discuss this in greater detail later. Then, we declare the <code class="literal">xtype</code> class (<code class="literal">#2</code>), which is the alias we are using to instantiate this class in the <code class="literal">Main</code> class.</p><div><div><h3 class="title"><a id="tip18"/>Tip</h3><p>Always remember that the convention for aliases (<code class="literal">xtype</code>) is to use all letters in lowercase. If you would like to, you can separate words with "<code class="literal">-</code>" (a hyphen) depending on your personal preference.</p></div></div><p>If we look at the first image of this chapter, we will note that the footer has a top border. We add a style on line <code class="literal">#3</code> that adds this border to the footer. The <code class="literal">cls</code> configuration allows us to add extra CSS to a component in Ext JS. It is available to all components. We will add the style to our CSS in a minute.</p><p>As we are declaring <code class="literal">Footer</code> in the south region of the <code class="literal">Main</code> class, you are required to set the <code class="literal">height</code> parameter. We can do this inside the <code class="literal">Footer</code> class or inside the <code class="literal">Main</code> class when declaring the south region. In this case, we are setting it inside the <code class="literal">Footer</code> class (<code class="literal">#4</code>).</p><p>Inside the<a id="id349" class="indexterm"/> <code class="literal">Footer</code> class, we want to have only one component in this example, which is text (you can use a copyright message), and<a id="id350" class="indexterm"/> we are going to display it using HTML. We also want this text to be centered. For this reason, we can use the <code class="literal">center</code> layout (<code class="literal">#5</code>). To use the <code class="literal">center</code> layout, the parent container needs to have only one child component (because it inherits from the <code class="literal">fit</code> layout, which only supports a single child as well). It is also required to declare the <code class="literal">width</code> parameter of the child component (<code class="literal">#7</code>); in this case, the text we are going to display is approximately <code class="literal">350</code> pixels wide.</p><div><div><h3 class="title"><a id="note32"/>Note</h3><p>In Ext JS 4, the Center layout was used as a UX plugin shipped with the Ext JS SDK. In Ext JS 5, this layout was promoted to the native API, but it kept backwards compatibility. In the layout configuration, you can use <code class="literal">center</code> (introduced in Ext JS 5) and also keep using <code class="literal">ux.center</code> (from Ext JS 4) if you are migrating an application from Ext JS 4 to 5.</p></div></div><p>To render the HTML, we are going to use the lightest and simplest component as possible, which is <code class="literal">component</code> (<code class="literal">#6</code>). As we also want to apply some CSS to our text, we are going to use the <code class="literal">componentCls</code> (<code class="literal">#8</code>) class, which is a CSS class that is added to a component's root-level element.</p><p>Note that there is no text declared anywhere inside the <code class="literal">Footer</code> class. Instead, we are binding the <code class="literal">html</code> configuration to a value (<code class="literal">#9</code>) named <code class="literal">footer</code>. This is also part of the new MVVM architecture that we are also going to use in this chapter. In the preceding chapter, we only used the <code class="literal">View</code> and <code class="literal">ViewController</code> classes for the login capability. In this chapter, we are going to use the complete feature: View, ViewController, and ViewModel from the MVVM architecture (Sencha Cmd already generated these classes when we created the project, so we better reuse them!). For now, keep in mind that this is part of the ModelView binding that we will dive into in the next topic.</p><div><div><div><div><h4 class="title"><a id="ch04lvl4sec05"/>A quick word about modular CSS</h4></div></div></div><p>Let's discuss another <a id="id351" class="indexterm"/>way of adding CSS to our application. We already know that the best practice to add CSS to our application is to add using Sass inside the <code class="literal">sass/etc</code> folder as we did in the previous examples. However, there are some styles that we create to apply to specific components, and we are not going to reuse them throughout the application. Instead of adding these CSS styles to our <code class="literal">all.scss</code> file and having a big file that can give us a headache later if we need to maintain it, we can use a more modular CSS approach to create specific CSS for our Ext JS views.</p><p>Inside the <code class="literal">sass</code> folder, create <a id="id352" class="indexterm"/>a new folder named <code class="literal">src</code> (if it has not been created by Sencha Cmd automatically), and inside <code class="literal">src</code>, create a new folder named <code class="literal">view</code>. Inside <code class="literal">view</code>, create a new folder named <code class="literal">main</code>. We will have the directory <code class="literal">sass/src/view/main</code>. Inside this directory, create a file named <code class="literal">Footer.scss</code> with the following content inside it:</p><div><pre class="programlisting">$packt-footer-text-color: rgb(11, 103, 196); //#1

.app-footer-title {
  color: $packt-footer-text-color; //#2
  font-size: 12px;
  font-weight: bold;
}

.app-footer {
  border-top: 1px solid darken($packt-footer-text-color, 15); //#3
}</pre></div><p>In line <code class="literal">#1</code>, we declare a Sass variable with a bluish color (the same blue color as the <code class="literal">TabPanel</code> background). We are reusing this variable in lines <code class="literal">#2</code> and <code class="literal">#3</code> in the styles we created to use in our <code class="literal">Footer</code> class.</p><div><div><h3 class="title"><a id="note33"/>Note</h3><p>In line <code class="literal">#3</code>, we use the <code class="literal">darken</code> function from Sass, which accepts a color and a number from 0-100, the percentage to which we want to make the color darker. For more information, please refer to the Sass documentation at <a class="ulink" href="http://goo.gl/JsAnVz">http://goo.gl/JsAnVz</a>.</p></div></div><p>The <code class="literal">view/main/Footer.scss</code> file has the same path as the <code class="literal">view/main/Footer.js</code> file. Note that this way, it is easier to maintain the styles specific to the <code class="literal">Footer</code> class. We will do the same for the <code class="literal">Header</code> class in the next topic. We separate the CSS into modules for it to be easier to read and maintain, and when we do the build, all the CSS will be concatenated into a single production CSS file—this is called modular CSS. See, developing applications with Ext JS is not all about Ext JS; we can apply the knowledge from other frontend technologies as well!</p></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec16"/>Creating the Header class</h3></div></div></div><p>Next, we <a id="id353" class="indexterm"/>are <a id="id354" class="indexterm"/>going to create the <code class="literal">Header</code> class. The <code class="literal">Header</code> class contains the logo of the application along with the application name, the dropdown that offers the translation capability, and the <strong>Logout</strong> button. To create the header, we are going to create a new file, <code class="literal">Header.js</code>, inside the <code class="literal">app/view/main</code> folder with the following code:</p><div><pre class="programlisting">Ext.define('Packt.view.main.Header', {
    extend: 'Ext.toolbar.Toolbar', //#1
    xtype: 'appheader',            //#2

    requires: [
        'Packt.view.locale.Translation' //#3
    ],

    ui: 'footer',                       //#4

    items: [{
            xtype: 'component',         //#5
            bind: {                     //#6
                html: '{appHeaderIcon}' 
            }
        },{
            xtype: 'component',
            componentCls: 'app-header-title', //#7
            bind: {                           //#8
                html: '{appName}'
            }
        },{
            xtype: 'tbfill'           //#9
        },{
            xtype: 'translation'      //#10
        },{
            xtype: 'tbseparator'      //#11
        },{
            xtype: 'button',          //#12
            itemId: 'logout',         //#13
            text: 'Logout',         
            reference: 'logout',      //#14
            iconCls: 'fa fa-sign-out fa-lg buttonIcon', //#15
            listeners: {  
                click: 'onLogout'  //#16
            }
        }
    ]
});</pre></div><p>Our<a id="id355" class="indexterm"/> <code class="literal">Header</code> class<a id="id356" class="indexterm"/> is going to extend the <code class="literal">Toolbar</code> class (<code class="literal">#1</code>). The <code class="literal">Toolbar</code> class is usually used inside panels and its subclasses (grid, form, tree) to organize buttons, but it can also be used to hold other components as we are going to do in this example. We will cover more about toolbars in other chapters as well. We are also declaring an <code class="literal">xtype</code> class for the <code class="literal">Header</code> class that we are making a reference to in the <code class="literal">Main</code> class (<code class="literal">#2</code>).</p><p>Whenever we use an<a id="id357" class="indexterm"/> <code class="literal">xtype</code> class created by ourselves, Ext JS does not understand what component we are trying to instantiate. For this reason, we require the class we are referring to. For example, in line <code class="literal">#3</code>, we reference the class of the translation component we are instantiating using its <code class="literal">xtype</code> class in line <code class="literal">#10</code>. We are going to develop this component later in the chapter.</p><div><div><h3 class="title"><a id="note34"/>Note</h3><p>Note that in the <code class="literal">Main</code> class, we did not use <code class="literal">requires</code> yet. We need to go back and add the required <code class="literal">Header</code>, <code class="literal">Footer</code>, and <code class="literal">main.Panel</code> classes.</p></div></div><p>The <code class="literal">ui</code> configuration <a id="id358" class="indexterm"/>allows us to use a specific theme for a component. The <code class="literal">Toolbar</code> component has the configuration <code class="literal">ui: 'footer'</code> (<code class="literal">#4</code>), which gives the toolbar a transparent background. The <code class="literal">footer</code> value is included in the Ext JS SDK, and it makes the toolbar transparent. We are going to create some custom <code class="literal">ui</code> configurations when we discuss themes later in this book.</p><p>The two first children items of the <code class="literal">Header</code> class are the icon (<code class="literal">#5</code>) and the application name. For the icon, we are going to use Font Awesome to display an icon in the format of a desktop. For the title of the application, we will use the same approach we used in the case of the <code class="literal">Footer</code> class. We are also using a <code class="literal">componentCls</code> configuration (<code class="literal">#7</code>) to style it. We get both values (icon-<code class="literal">#6</code> and application name-<code class="literal">#8</code>) from the ViewModel, which we will cover in a minute.</p><p>The next item is a toolbar fill (<code class="literal">#9</code>). This component will align the <code class="literal">translation</code> (<code class="literal">#10</code>) and <code class="literal">logout</code> buttons (<code class="literal">#13</code>) to the right, filling the <code class="literal">Toolbar</code> class with space in the middle (between the application title and the buttons).</p><div><div><h3 class="title"><a id="note35"/>Note</h3><p>Instead of <code class="literal">{ xtype: 'tbfill' }</code>, we could also use <code class="literal">'-&gt;'</code> as a shortcut.</p></div></div><p>We also have the <code class="literal">logout</code> button declared on line <code class="literal">#12</code>. We are going to assign <code class="literal">itemId</code> so that we can reference this button globally by the application. We will need it when we work with the session monitor capability. The <code class="literal">itemId</code> needs to be unique in its scope; in this case, it needs to be unique within this class, but it is going to be even better if it is unique at the application level.</p><p>As we are going to use the <code class="literal">ViewController</code> class to handle the logout, we will declare a <code class="literal">reference</code> (<code class="literal">#14</code>) to make it easier to retrieve the button reference inside the <code class="literal">ViewController</code> class, and we are also going to declare the listener (<code class="literal">#16</code>), which means that the <code class="literal">onLogout</code> function from the <code class="literal">ViewController</code> class is going to be executed when we click on the <strong>Logout</strong> button.</p><p>We are also setting <a id="id359" class="indexterm"/>an icon to the <code class="literal">Logout</code> button from Font Awesome (<code class="literal">#15</code>). By default, the icon will have the color black. The button text is white, and we want the icon to have the same color as the text. For this reason, we add a custom style (<code class="literal">buttonIcon</code>).</p><p>At last, we have <a id="id360" class="indexterm"/>the toolbar separator declared on line <code class="literal">#11</code>. This simply adds a separator ("|") between the buttons.</p><div><div><h3 class="title"><a id="note36"/>Note</h3><p>Likewise, <code class="literal">tbfill</code>, the toolbar separator, also has a shortcut. Instead of <code class="literal">{ xtype: ' tbseparator' }</code>, we could also use <code class="literal">'-'</code>.</p></div></div><div><div><div><div><h4 class="title"><a id="ch04lvl4sec06"/>Creating the Header CSS</h4></div></div></div><p>Just as we <a id="id361" class="indexterm"/>did with the <code class="literal">Footer</code> class, we are also going to create a filename, <code class="literal">Header.scss</code>, inside the <code class="literal">sass/view/main</code> folder with the following content inside it:</p><div><pre class="programlisting">$packt-header-text-color: #2a3f5d;

.app-header-logo {
  color: $packt-header-text-color;
}

.app-header-title {
  padding: 5px 0 5px 3px;
  color: $packt-header-text-color;
  font-size: 18px;
  font-weight: bold;
}</pre></div><p>The <code class="literal">app-header-logo</code> was created to customize the color of the icon to be the same as the application title. We are using the Sass variable inside both styles. The text color of the title is a dark blue.</p></div><div><div><div><div><h4 class="title"><a id="ch04lvl4sec07"/>Customizing the Font Awesome icon colors</h4></div></div></div><p>By <a id="id362" class="indexterm"/>default, the Font Awesome icons will be displayed in black. But we want some of the icons to have the same color as our theme. We can do this customization using CSS as well.</p><p>We have declared two styles to customize the Font Awesome icons until now. The first one was inside the <code class="literal">Panel</code> class (<code class="literal">tabIcon</code>), and the second one is the <strong>Logout</strong> button (<code class="literal">buttonIcon</code>). So we also need to add these styles to our CSS. To follow the modular CSS approach, let's create a new file, <code class="literal">iconColors.scss</code>, under <code class="literal">sass/etc</code> with the following content:</p><div><pre class="programlisting">$packt-button-icon-color: #fff;
$packt-tab-icon-color: rgb(11, 103, 196);

.tabIcon {
  color: $packt-tab-icon-color;
}

.buttonIcon {
  color: $packt-button-icon-color;
}</pre></div><div><div><h3 class="title"><a id="tip19"/>Tip</h3><p>We will get used to using Sass variables to make our life easier if we decide to customize the Ext JS theme later!</p></div></div><p>Then, all we <a id="id363" class="indexterm"/>need to do is import this file in the <code class="literal">all.scss</code> file:</p><div><pre class="programlisting">@import "fontAwesome/font-awesome";
<strong>@import "iconColors";</strong>
</pre></div></div></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec44"/>The main screen and MVVM</h2></div></div></div><p>Now, it's <a id="id364" class="indexterm"/>time to put everything together. Let's take a look at how the <code class="literal">Main</code> class<a id="id365" class="indexterm"/> looks with the complete code:</p><div><pre class="programlisting">Ext.define('Packt.view.main.Main', {
    extend: 'Ext.container.Container',
    plugins: 'viewport',
    xtype: 'app-main',

    <strong>requires: [ //#1        'Packt.view.main.Header',        'Packt.view.main.Footer',        'Packt.view.main.Panel',        'Packt.view.main.MainController',        'Packt.view.main.MainModel'    ],</strong>
    
    controller: 'main', //#2
    viewModel: {
        type: 'main' //#3
    },

    layout: {
        type: 'border'
    },

    items: [{
        region: 'center',
        xtype: 'mainpanel'
    },{
        xtype: 'appheader',
        region: 'north'
    },{
        xtype: 'appfooter',
        region: 'south'
    },{
        xtype: 'container',
        region: 'west',
        width: 200,
        split: true
    }]
});</pre></div><p>We need to <a id="id366" class="indexterm"/>add the <code class="literal">requires</code> declaration of <a id="id367" class="indexterm"/>all the classes we created (and we are referencing them by their <code class="literal">xtype</code> classes) and also the <code class="literal">Main</code> ViewModel and <code class="literal">Main</code> ViewController class that were already created by Sencha Cmd.</p><p>The <code class="literal">controller</code> (<code class="literal">#2</code>) and <code class="literal">viewModel</code> (<code class="literal">#3</code>) declarations were already added by Sencha Cmd when we created the project. We are simply reusing them by referencing their types.</p><div><div><div><div><h3 class="title"><a id="ch04lvl3sec17"/>The main ViewModel</h3></div></div></div><p>If we <a id="id368" class="indexterm"/>open the <code class="literal">MainModel.js</code> file inside the <code class="literal">app/view/main</code> folder, we will see some content inside it already. We are going to add more content to it, and the file is going to look as follows:</p><div><pre class="programlisting">Ext.define('Packt.view.main.MainModel', { //#1
    extend: 'Ext.app.ViewModel', //#2

    alias: 'viewmodel.main', //#3

    data: {
        name: 'Packt', //#4
        appName: 'DVD Rental Store', //#5
        appHeaderIcon: '&lt;span class="fa fa-desktop fa-lg app-header-logo"&gt;', //#6
        footer: 'Mastering ExtJS book - Loiane Groner - http://packtpub.com' //#7
    }
});</pre></div><p>Let's start with the<a id="id369" class="indexterm"/> name of the class (<code class="literal">#1</code>). The naming convention for ViewModel suggested by Sencha is the name of the view (<code class="literal">Main</code>) + "<code class="literal">Model</code>", resulting in <code class="literal">MainModel</code>. A ViewModel extends from the <code class="literal">ViewModel</code> class (<code class="literal">#2</code>) introduced in Ext JS 5, along with the MVVM architecture. The alias (<code class="literal">#3</code>) of a ViewModel is defined by "<code class="literal">viewmodel.</code>" + the name of the type we want to assign. In this case, Sencha already created this class for us with the type <code class="literal">main</code>. That is why we can reference this alias in the <code class="literal">View</code> class using the following code:</p><div><pre class="programlisting">viewModel: {
    type: 'main'
}</pre></div><p>The <code class="literal">data</code> configuration allows us to populate values in the <code class="literal">ViewModel</code> class. The <code class="literal">name</code> field (<code class="literal">#4</code>) was created by Sencha Cmd, so we are going to keep it (you can remove it if you want). The <code class="literal">appName</code> (<code class="literal">#5</code>) and <code class="literal">appHeaderIcon</code> (<code class="literal">#6</code>) properties are being used by <code class="literal">Header</code> and <code class="literal">footer</code> (<code class="literal">#7</code>) is being used by the <code class="literal">Footer</code> class.</p><p><code class="literal">MainModel</code> is bound to the <code class="literal">Main</code> class (View). Because <code class="literal">Header</code> and <code class="literal">Footer</code> are <code class="literal">items</code> of the <code class="literal">Main</code> component, they can also reference <code class="literal">MainModel</code>.</p><p>This is the simplest way in which we can create the <code class="literal">ViewModel</code> class, with prepopulated data. We will provide other advanced examples throughout this book, but we need to start with baby steps!</p><div><div><h3 class="title"><a id="note37"/>Note</h3><p>For more information about <a id="id370" class="indexterm"/>ViewModel, data binding, and how to bind different data types, please read the following Sencha guide: <a class="ulink" href="http://goo.gl/qta6kH">http://goo.gl/qta6kH</a>.</p></div></div></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec22"/>Logout capability</h1></div></div></div><p>As the<a id="id371" class="indexterm"/> user has<a id="id372" class="indexterm"/> the option to log in to the application, the user can also log out from it. Inside the <code class="literal">Header</code> class, we have already declared the <code class="literal">logout</code> button. The only thing pending is to implement the listener inside <code class="literal">MainController</code>.</p><p>As the <code class="literal">MainController</code> class was created by Sencha Cmd, we are reusing it. The file already has some code in it. Let's remove any listener created by Sencha. <code class="literal">MainController</code> will look like this:</p><div><pre class="programlisting">Ext.define('Packt.view.main.MainController', {
    extend: 'Ext.app.ViewController',

    requires: [
        'Ext.MessageBox'
    ],

    alias: 'controller.main',

<code class="literal">    //we will insert code here</code>
});</pre></div><p>In the <code class="literal">Header</code> class, we <a id="id373" class="indexterm"/>declared the <code class="literal">logout</code> button, its reference, and its listener. So we need to implement the <code class="literal">onLogout</code> function, as follows:</p><div><pre class="programlisting">onLogout: function(button, e, options){

    var me = this;      //#1
    Ext.Ajax.request({
        url: 'php/security/logout.php', //#2
        scope: me,                      //#3
        success: 'onLogoutSuccess',     //#4
        failure: 'onLogoutFailure'      //#5
    });
},</pre></div><p>The <code class="literal">me</code> (<code class="literal">#1</code>) variable makes a reference to <code class="literal">this</code>, which is the <code class="literal">MainController</code> class. We will make an Ajax call (<code class="literal">#2</code>) to <code class="literal">php/security/logout.php</code> (we will create this file soon). We will handle the <code class="literal">success</code> (<code class="literal">#4</code>) and <code class="literal">failure</code> (<code class="literal">#5</code>) callbacks in separate functions that are declared inside the <code class="literal">MainController</code> class as well. That is why the scope is set to the <code class="literal">MainController</code> class (<code class="literal">#3</code>) itself.</p><div><div><h3 class="title"><a id="tip20"/>Tip</h3><p>We could declare the <code class="literal">success</code> and <code class="literal">failure </code>callbacks directly inside the Ajax request. But then, our code will be very long, which would decrease its readability. This way, the code stays organized and easier to read. This is always a best practice to be followed.</p></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec45"/>Handling the logout on the server</h2></div></div></div><p>To handle<a id="id374" class="indexterm"/> the logout capability on the server, we will create a new PHP page named <code class="literal">logout.php</code> under the <code class="literal">php/security</code> folder. The code is very simple:</p><div><pre class="programlisting">&lt;?php

session_start(); // #1

$_SESSION = array(); // #2

session_destroy(); // #3

$result = array(); // #4

$result['success'] = true;
$result['msg'] = 'logout';

echo json_encode($result); // #5</pre></div><p>First, we need to <a id="id375" class="indexterm"/>resume the current session (<code class="literal">#1</code>), then we need to unset all of the session variables (<code class="literal">#2</code>), and next we need to destroy the session (<code class="literal">#3</code>). Lastly, we need to send the information back to Ext JS that the session has been destroyed (<code class="literal">#4</code> and <code class="literal">#5</code>).</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec46"/>Ajax request success versus failure</h2></div></div></div><p>We <a id="id376" class="indexterm"/>have already taken care of the server-side code. Now, we need to go back to the Ext JS code and handle the response from the server. But first, we need to understand a very important concept that usually confuses most Ext JS developers.</p><p>In <a class="link" href="ch03.html" title="Chapter 3. The Login Page">Chapter 3</a>, <em>The Login Page</em>, we mentioned that the ways that the form submit and Ajax requests in Ext JS handle the <em>success x failure</em><a id="id377" class="indexterm"/> are a little different, and this is what confuses most developers.</p><p>The <code class="literal">Ext.Ajax</code> class is responsible for Ajax requests done by Ext JS. If we look at the documentation, this class has three events: <code class="literal">beforerequest</code>, <code class="literal">requestcomplete</code>, and <code class="literal">requestexception</code>, which are explained as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The event <code class="literal">beforerequest</code> is fired before the request</li><li class="listitem" style="list-style-type: disc">The event <code class="literal">requestcomplete</code> is fired when Ext JS is able to get a response from the server</li><li class="listitem" style="list-style-type: disc">The <code class="literal">requestexception</code> event is fired when an HTTP error status is returned from the server</li></ul></div><p>Now, let's go back to the <code class="literal">Ext.Ajax.request</code> call. We can pass some options to the request, including the <code class="literal">url</code> property we want to connect to, parameters, and other options including the <code class="literal">success</code> and <code class="literal">failure</code> functions. Now, this is where the misunderstanding begins. Some developers understand that if the action happened successfully on the server, we usually return <code class="literal">success = true</code> from the server. If something goes wrong, we return <code class="literal">success = false</code>. Then, on the <code class="literal">success</code> function, <code class="literal">success = true</code> is handled, and on the <code class="literal">failure</code> function, <code class="literal">success = false</code> is handled. This is <em>wrong</em>, and it is not how Ext JS Ajax requests work; however, <em>that is exactly how form requests work</em> (as we learned in <a class="link" href="ch03.html" title="Chapter 3. The Login Page">Chapter 3</a>, <em>The Login Page</em>). See how it gets confusing?</p><p>For Ext JS Ajax requests, <code class="literal">success</code> is when the server returns a response (<code class="literal">success</code> <code class="literal">true</code> or <code class="literal">false</code>; it does not matter), and <code class="literal">failure</code> is when the server returns an HTTP error status. This means that if the server was able to return a response, we will handle this response on the <code class="literal">success</code> function (and we will need to handle it whether the <code class="literal">success</code> information is <code class="literal">true</code> or <code class="literal">false</code>), and on the <code class="literal">failure</code> message, we need to inform the user that something went wrong and the user should contact the system administrator.</p><p>We will <a id="id378" class="indexterm"/>implement the <code class="literal">failure</code> callback function first. So, inside the <code class="literal">ViewController</code> class, we will add the following code:</p><div><pre class="programlisting">onLogoutFailure: function(conn, response, options, eOpts){
    Packt.util.Util.showErrorMsg(conn.responseText);
},</pre></div><p>What we are going to do is display an alert to the user with an error icon and an <strong>OK</strong> button with the HTTP status error information.</p><p>To reproduce an error so the <code class="literal">requestexception</code> event can be fired, we can rename the <code class="literal">logout.php</code> file to something else (for example, <code class="literal">logout_.php</code>) only for testing purposes. And then, we can execute the code, and we will have the following output:</p><div><img src="img/0457OT_04_04.jpg" alt="Ajax request success versus failure"/></div><p>And this is all we need for the <code class="literal">failure</code> function. Note that we are reusing the <code class="literal">Packt.util.Util</code> class that we developed in <a class="link" href="ch03.html" title="Chapter 3. The Login Page">Chapter 3</a>, <em>The Login Page</em>, in this chapter again! See <a id="id379" class="indexterm"/>how it is nice to reuse code?</p><div><div><h3 class="title"><a id="note38"/>Note</h3><p>We are reusing code and saving some lines of duplicated code. We are also creating a pattern of how to handle a few things in our project. This is very important when working in a project, especially when working in a team. This way, the project will look like a single person and not that multiple people developed it, which is really good. This is also a best practice to be followed. Reusing code is also part of what is called <em>minimizing the payload size</em><a id="id380" class="indexterm"/>, which is one of the best practices while developing with JavaScript and also a concern of web development. To learn more about this, please visit <a class="ulink" href="https://developers.google.com/speed/docs/best-practices/payload">https://developers.google.com/speed/docs/best-practices/payload</a>.</p></div></div><p>To make the code work, remove the following code from the <code class="literal">MainController</code> class:</p><div><pre class="programlisting">requires: [
    'Ext.MessageBox'
],</pre></div><p>Write the following code in the preceding code's position:</p><div><pre class="programlisting">requires: [
<strong>    'Packt.util.Util'</strong>
],</pre></div><p>Now, let's focus on the <code class="literal">success</code> callback function:</p><div><pre class="programlisting">onLogoutSuccess: function(conn, response, options, eOpts){
   //#1
    var result = Packt.util.Util.decodeJSON(conn.responseText);

    if (result.success) { //#2
        this.getView().destroy(); //#3
        window.location.reload(); //#4
    } else {

        Packt.util.Util.showErrorMsg(result.msg); //#5
    }
}</pre></div><p>The first thing we need to do is decode the JSON message (<code class="literal">#1</code>) that we received from the server. If we log the <code class="literal">conn </code>parameter sent to the <code class="literal">success </code>function (<code class="literal">console.log(conn)</code>), this will be the output we will get on the console:</p><div><img src="img/0457OT_04_05.jpg" alt="Ajax request success versus failure"/></div><p>The <code class="literal">conn.responseText</code> property is where the information we want to retrieve is present, the <code class="literal">success</code> and <code class="literal">msg</code> values. Recall that in <a class="link" href="ch03.html" title="Chapter 3. The Login Page">Chapter 3</a>, <em>The Login Page</em>, we discussed the possibility of <code class="literal">responseText</code> containing an exception other than the JSON we are expecting. So, for<a id="id381" class="indexterm"/> this reason, we are going to reuse the <code class="literal">decodeJSON</code> function we created (<code class="literal">#1</code>) so that we can properly handle any results.</p><p>In the case of <code class="literal">success</code> (<code class="literal">#2</code>), we are going to <code class="literal">destroy</code> the <code class="literal">Main</code> class (<code class="literal">#3</code>), which is our Viewport (this is good to release the browser's memory and make the objects available for the JavaScript garbage collector). As the Viewport contains all the other components of our application, it is going to destroy them as well. Then, we will reload the application displaying the <strong>Login</strong> screen again (<code class="literal">#4</code>).</p><p>If <code class="literal">success</code> is <code class="literal">false</code> (or any error occurred), we will display an error alert with the error message (<code class="literal">#5</code>).</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec23"/>Client-side activity monitor</h1></div></div></div><p>Let's <a id="id382" class="indexterm"/>enhance our application a little bit more. It is <a id="id383" class="indexterm"/>very important to let the users know that web applications have a timeout and they cannot leave it open all day long—mainly for security reasons. Server-side languages also have a timeout. Once the user is logged in, the server will not be available forever. This is for security reasons. That is why we need to add this capability to our application as well.</p><p>We are going to use a plugin to do this. The plugin is called <code class="literal">Packt.util.SessionMonitor</code> and is based on the Activity Monitor plugin<a id="id384" class="indexterm"/> from the Sencha Market (<a class="ulink" href="https://market.sencha.com/extensions/extjs-activity-monitor">https://market.sencha.com/extensions/extjs-activity-monitor</a>). After an interval (a default of 15 minutes of inactivity), the plugin will display a message to the user asking whether the user wants to keep the session alive. If yes, then it will send an Ajax request to the server to keep the server session alive. If the user does not do anything after the message is displayed for 60 seconds, the application will logout automatically.</p><p>You can get the source code of this plugin from <a class="ulink" href="https://github.com/loiane/masteringextjs/blob/master/app/util/SessionMonitor.js">https://github.com/loiane/masteringextjs/blob/master/app/util/SessionMonitor.js</a>. It works in Ext JS 4 and Ext JS 5.</p><p>At line <em>53</em> inside <code class="literal">Ext.ComponentQuery.query</code> at the preceding URL, we will change the <code class="literal">logout</code> button selector to <code class="literal">button#logout</code>, which is the selector we have for our <code class="literal">logout</code> button (that is why we created <code class="literal">itemId</code> for the <code class="literal">logout</code> button).</p><p>Also, we will <a id="id385" class="indexterm"/>change the <code class="literal">url</code> property of the Ajax request on line <em>42</em> to <code class="literal">php/sessionAlive.php</code> at the preceding URL.</p><p>If we want<a id="id386" class="indexterm"/> to change the inactivity interval, we only need to change the <code class="literal">maxInactive</code> configuration.</p><p>To start monitoring the session, we only need to add this line of code inside the <code class="literal">onLoginSuccess</code> method of <code class="literal">LoginController</code> right after we instantiate the <code class="literal">Main</code> class:</p><div><pre class="programlisting">onLoginSuccess: function(form, action) {
    Ext.getBody().unmask();
    this.getView().close();
    Ext.create('Packt.view.main.Main');
<strong>    Packt.util.SessionMonitor.start();</strong>
} </pre></div><p>We cannot forget to add <code class="literal">'Packt.util.SessionMonitor</code>' to <code class="literal">requires</code> in <code class="literal">LoginController</code> as well.</p><p>In the <code class="literal">php/sessionAlive.php</code> file, we will have the following code:</p><div><pre class="programlisting">&lt;?php
session_start();</pre></div><p>That is only to keep the server session alive and also to reset the session timer back to 15 minutes.</p><p>If we run this code and wait for the inactivity time (15 minutes—of course we can change the <code class="literal">maxInactive </code>parameter to wait for less time), we will see a message like this one:</p><div><img src="img/0457OT_04_06.jpg" alt="Client-side activity monitor"/></div><p>Ext JS does not <a id="id387" class="indexterm"/>provide this capability natively. But as<a id="id388" class="indexterm"/> we can see, it is very easy to implement, and we can reuse this plugin for all Ext JS projects that we work on.</p></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec24"/>The multilingual capability</h1></div></div></div><p>Sometimes<a id="id389" class="indexterm"/> you want to ship the <a id="id390" class="indexterm"/>project or product that you are working on overseas, and so having the translation capability is very important. After all, not everyone understands or speaks the same language that you do. And this is what we are going to implement in this topic: a multilingual component that we can use to translate the labels of this project. So at the end of this topic, this is going to be our output:</p><div><img src="img/0457OT_04_07.jpg" alt="The multilingual capability"/></div><p>The idea is to store the user language preference locally, so the next time the user loads the application, the<a id="id391" class="indexterm"/> preferred language will be automatically set. And when the user changes the language, the application needs to be reloaded, so the new translations can be loaded into the memory.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec47"/>Creating the change language component</h2></div></div></div><p>If we<a id="id392" class="indexterm"/> take a look at the <a id="id393" class="indexterm"/>screenshot we showed at the beginning of this topic, we can notice that the multilingual component is a button, and when we click on the arrow, a menu pops up with the available languages.</p><p>The button with the arrow is a split button component, which has a Menu, and each language option is a Menu Item of the Menu. So, let's go ahead and create a new class named <code class="literal">Packt.view.locale.Translation</code> containing the characteristics we described.</p><div><div><h3 class="title"><a id="tip21"/>Tip</h3><p>Whenever we name a <code class="literal">View</code> class (also known as Ext JS widgets or components), it is nice to give a name that can quickly remind us what the class does. For example, by naming the class <code class="literal">locale.Translation</code>, we quickly know that the class provides capabilities localizing the application.</p></div></div><p>We need to create a new file named <code class="literal">Translation.js</code> under the <code class="literal">app/view/locale</code> folder with the following code inside it:</p><div><pre class="programlisting">Ext.define('Packt.view.locale.Translation', {
    extend: 'Ext.button.Split',   //#1
    xtype: 'translation',         //#2

    menu: {               //#3
        xtype: 'menu',    //#4
        items: [
            {
                xtype: 'menuitem', //#5
                iconCls: 'en',
                text: 'English'
            },
            {
                xtype: 'menuitem', //#6
                iconCls: 'es',
                text: 'Español'
            },
            {
                xtype: 'menuitem', //#7
                iconCls: 'pt_BR',
                text: 'Português'
            }
        ]
    }
});</pre></div><p>So, the class that <a id="id394" class="indexterm"/>we created is extending from the split button class (<code class="literal">#1</code>). A split button class is one that provides a built-in<a id="id395" class="indexterm"/> drop-down arrow that can fire an event separately from the default click event of the button. Typically, this would be used to display a drop-down menu that provides additional options to the primary button action. And we are also assigning the <code class="literal">xtype</code> class to this class (<code class="literal">#2</code>) that we used to instantiate it in the <code class="literal">Header</code> class.</p><p>Then, on <code class="literal">menu</code> (<code class="literal">#3</code>) configuration, we need to create an instance of the <code class="literal">menu</code> class (<code class="literal">#4</code>) followed by <code class="literal">menuitems</code> of the <code class="literal">menu</code> class, which are going to represent each locale option. So we have: an option to translate to <code class="literal">English</code> (<code class="literal">#5</code>)—and it will also show the American flag (<code class="literal">en</code>); an option to translate to <code class="literal">Spanish</code> (<code class="literal">#6</code>)—and it will also show the flag of Spain (<code class="literal">es</code>); and also an option to translate to <code class="literal">Portuguese</code> (<code class="literal">#7</code>)—and it will also display the flag of Brazil (<code class="literal">pt_BR</code>).</p><p>We can add as many options as we need to. For each translate option, we only need to add new <code class="literal">menuitems</code> of the <code class="literal">menu</code> class.</p><div><div><div><div><h3 class="title"><a id="ch04lvl3sec18"/>Adding the CSS – country flags</h3></div></div></div><p>The next <a id="id396" class="indexterm"/>step now is to add the CSS for <code class="literal">iconCls</code>, which <a id="id397" class="indexterm"/>we used in the translation component of the application CSS. To keep our code more organized (and leave room to add more languages and more flag icons if needed), we are going to create a new file named <code class="literal">flagIcons.scss</code> inside the <code class="literal">sass/etc</code> folder with the following content:</p><div><pre class="programlisting">.pt_BR {
  background-image:url('images/app/flags/br.png') !important;
}

.en {
  background-image:url('images/app/flags/us.png') !important;
}

.es {
  background-image:url('images/app/flags/es.png') !important;
}</pre></div><div><div><h3 class="title"><a id="note39"/>Note</h3><p>Note that the name of the style (<code class="literal">pt_BR</code>, <code class="literal">en</code>, and <code class="literal">es</code>) is the same as the <code class="literal">iconCls</code> property we used for each <code class="literal">menuitem</code>. This is very important.</p></div></div><p>Inside<a id="id398" class="indexterm"/> the <code class="literal">all.scss</code> file, we <a id="id399" class="indexterm"/>need to import this file we created. Add the following code on the second line (right after we imported the Font Awesome file):</p><div><pre class="programlisting">@import "flagIcons";</pre></div><p>But what about the icons? Font Awesome does not have flag icons. We are going to use the Flag set from<a id="id400" class="indexterm"/> FamFamFam (<a class="ulink" href="http://www.famfamfam.com/">http://www.famfamfam.com/</a>), which are free to use for any purpose (<em>Creative Commons License</em>). Create the folder <code class="literal">flags</code> under the directory <code class="literal">resources/images/app</code>, and copy and paste the flag icons. You might need to rename them to comply with the names we are using in this example.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec19"/>Using the translation component</h3></div></div></div><p>Now, the <code class="literal">translation</code> component<a id="id401" class="indexterm"/> is ready (only what is going to be displayed to the user). We are going to use the <code class="literal">translation</code> component in two places of our project: on the <strong>Login</strong> screen and before the <strong>Logout</strong> button on <code class="literal">Header</code> (which is already in place).</p><p>Let's add it to the <strong>Login</strong> screen. Open the <code class="literal">Packt.view.login.Login</code> class again. On the toolbar, we will add it as the first item so that it can look exactly as we showed in the screenshot at the beginning of this topic:</p><div><pre class="programlisting">items: [
  <strong>{      xtype: 'translation'  },</strong>
  {
      xtype: 'tbfill'
  },
  //...
]</pre></div><p>We cannot forget to add the class to the <code class="literal">requires</code> declaration of the <strong>Login</strong> screen class:</p><div><pre class="programlisting">requires: [
    ' Packt.view.locale.Translation '
],</pre></div><p>If we reload the <a id="id402" class="indexterm"/>application (do not forget to have <code class="literal">sencha app watch</code> executed on the terminal while we make all these changes), we are going to be able to see what we have developed until now.</p></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec48"/>Creating the multilingual files</h2></div></div></div><p>We need to <a id="id403" class="indexterm"/>store the translations somewhere in our project. We are going to store the translations for each language on a JavaScript file inside the <code class="literal">resources/locale</code> folder. As we are going to use <code class="literal">iconCls</code> as the ID to load the translation files, we need to create three files: <code class="literal">en.js</code>, <code class="literal">es.js</code>, and <code class="literal">pt_BR.js</code>. Inside each file, we will create a JavaScript object named <code class="literal">translations</code>, and each attribute of this object will be a translation. All translation files must be the same; the only thing that will be different is the value of each attribute that will contain the translation.</p><p>For example, the following code is for the <code class="literal">en.js</code> file:</p><div><pre class="programlisting">translations = {
    login: "Login",
    user: "User",
    password: "Password",

    cancel: "Cancel",
    submit: "Submit",
    logout: 'Logout',

    capsLockTitle: 'Caps Lock is On',
    capsLockMsg1: 'Having Caps Lock on may cause you to ',
    capsLockMsg2: 'enter your password incorrectly.',
    capsLockMsg3: 'You should press Caps Lock to turn it ',
    capsLockMsg4: 'off before entering your password.'
};</pre></div><p>The following code is for <code class="literal">pt_BR.js</code>, which contains the Brazilian Portuguese translations:</p><div><pre class="programlisting">translations = {
    login: "Login",
    user: "Usuário",
    password: "Senha",

    cancel: "Cancelar",
    submit: "Enviar",
    logout: 'Logout',

    capsLockTitle: 'Caps Lock está ativada',
    capsLockMsg1: 'Se Capslock estiver ativado, isso pode fazer ',
    capsLockMsg2: 'com que você digite a senha incorretamente.',
    capsLockMsg3: 'Você deve pressionar a tecla Caps lock para ',
    capsLockMsg4: 'desativá-la antes de digitar a senha.'
};</pre></div><p>The following<a id="id404" class="indexterm"/> code is the <code class="literal">es.js</code> code, which contains the Spanish translations:</p><div><pre class="programlisting">translations = {
    login: "Login",
    user: "Usuario",
    password: "Contraseña",

    cancel: "Cancelar",
    submit: "Enviar",
    logout: 'Logout',

    capsLockTitle:'Bloq Mayús está Activado',
    capsLockMsg1:'Tener el Bloq Mayús activado puede causar que ',
    capsLockMsg2:'introduzca su contraseña de forma incorrecta.',
    capsLockMsg3:'Usted debe presionar Bloq Mayús para apagarlo ',
    capsLockMsg4:'antes de escribir la contraseña.'
};</pre></div><p>As we can see, the files are the same; however, the translation is different. As the application grows, we will add more translations to it, and it is a good practice to maintain the files organized in the same way to facilitate changing any translation in the future.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec49"/>Applying the translation on the application's components</h2></div></div></div><p>To apply<a id="id405" class="indexterm"/> the translations on the components that we have developed until now is very simple: we need to use the <code class="literal">translations</code> dictionary we created instead of the string that is going to represent the label.</p><p>For example, in the <code class="literal">Packt.view.view.Login</code> class, we have the title of the window, the <code class="literal">fieldLabel</code> of the <code class="literal">username</code> and <code class="literal">password</code>, and the text of the <strong>Cancel</strong> and <strong>Submit</strong> buttons. The labels are hardcoded, and we want to get the translation from the translation files.</p><p>So, we need to replace the <code class="literal">title</code> of the :<strong>Login</strong> window with the following:</p><div><pre class="programlisting">title: translations.login,</pre></div><p>We need to replace the <code class="literal">fieldLabel</code> of <code class="literal">username</code> <code class="literal">textfield</code> with the following:</p><div><pre class="programlisting">fieldLabel: translations.user,</pre></div><p>We need to replace the <code class="literal">fieldLabel</code> of <code class="literal">password</code> <code class="literal">textfield</code> with the following:</p><div><pre class="programlisting">fieldLabel: translations.password,</pre></div><p>We need to replace the <code class="literal">text</code> of the <strong>Cancel</strong> button with the following:</p><div><pre class="programlisting">text: translations.cancel</pre></div><p>We need to replace the <code class="literal">text</code> of the <strong>Submit</strong> button with the following:</p><div><pre class="programlisting">text: translations.submit</pre></div><p>And so on. We can also apply the translation for the <strong>Logout</strong> button and also to the <code class="literal">CapsLockTooltip</code> class.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec50"/>HTML5 local storage</h2></div></div></div><p>Our<a id="id406" class="indexterm"/> idea for the <code class="literal">translate</code> component is to store<a id="id407" class="indexterm"/> the language preference of the user somewhere. We could use cookies for this, but what we want is very simple, and cookies are included with every HTTP request. We want to store this information for the long term and also use something that can be persisted beyond a page refresh or the fact that the user closed the browser. And the perfect option is to use local storage, one of the new features of HTML5.</p><p>Ext JS has support for local storage; it can be used with <a id="id408" class="indexterm"/>
<strong>LocalStorageProxy</strong>, but we need something simpler, and using the HTML5 feature itself on the code is simpler. And it also demonstrates that we can use other APIs along with the Ext JS API.</p><p>Local storage is not supported by every browser; it is only supported by IE 8.0+, Firefox 3.5+, Safari 4.0+, Chrome 4.0+, Opera 10.5+, iPhone 2.0+, and Android 2.0+. We will build a nice page warning the user to upgrade the browser later on in this book. We will also use other <a id="id409" class="indexterm"/>HTML5 features along with Ext JS in other screens as well. So, for now, we need to know that this code, which we will implement now, does not work on every browser.</p><div><div><h3 class="title"><a id="note40"/>Note</h3><p>For more information about <a id="id410" class="indexterm"/>HTML5 storage, please visit <a class="ulink" href="http://diveintohtml5.info/storage.html">http://diveintohtml5.info/storage.html</a>.</p></div></div><p>We want this code to be loaded right before we instantiate the Ext JS application. So, for this reason, we are going to add it right before <code class="literal">Ext.define('Packt.Application', {</code> in the <code class="literal">app/Application.js</code> file:</p><div><pre class="programlisting">function loadLocale(){

    var lang = localStorage ? (localStorage.getItem('user-lang') || 'en') : 'en',
        file = Ext.util.Format.format("resources/locale/{0}.js", lang);

    Ext.Loader.loadScript({url: file, onError: function(){
        alert('Error loading locale file. Please contact system administrator.');
    }});
}

loadLocale(); //#1</pre></div><p>So, first, we<a id="id411" class="indexterm"/> are going to verify that <code class="literal">localStorage</code> is available. If it is available, we are going to check whether there is an item named <code class="literal">user-lang</code> stored on <code class="literal">localStorage</code>; if not, English will be the default language. Even if <code class="literal">localStorage</code> is not available, English will be set as the default language.</p><p>Then, we create a variable named <code class="literal">file</code> that is going to receive the path of the translation file that must be loaded by the application.</p><div><div><h3 class="title"><a id="tip22"/>Tip</h3><p>Ext JS has a class, <code class="literal">Ext.util.Format</code>, that contains a static method format that concatenates the string and the values passed as tokens, which in this case is <code class="literal">lang</code>. It is cleaner than doing manual string concatenation in JavaScript.</p></div></div><p>After we have the <code class="literal">url</code> formatted, we are going to load it using <code class="literal">Ext.Loader</code>. The <code class="literal">loadScript</code> method loads the specified script URL and calls the supplied callbacks (if any). It accepts <code class="literal">onLoad</code> and <code class="literal">onError</code> callbacks. In our case, there is no need for a success callback (<code class="literal">onLoad</code>). If there is any error while loading the locale file, the application will not load, so the <code class="literal">onError</code> callback is interesting and needed in this case so that the user can contact support in the event of an error (try renaming the <code class="literal">en.js</code> file to simulate an error).</p><p>To avoid <a id="id412" class="indexterm"/>creating<a id="id413" class="indexterm"/> global variables (since this is not a good JavaScript practice), we wrapped our code in a function. Therefore, we need to call the function (<code class="literal">#1</code>) right before <code class="literal">Ext.define('Packt.Application'</code>.</p><p>By the time our application is loaded, it will have all the translations available.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec51"/>Handling change language in real time</h2></div></div></div><p>Now <a id="id414" class="indexterm"/>comes the final part of the code of the <code class="literal">translation</code> component. When the user selects a different language, we need to reload the application so that the <code class="literal">loadLocale</code> function is executed again and load the new language chosen by the user.</p><p>To do so, we <a id="id415" class="indexterm"/>will create a new Controller in our application just to handle the translation component. The question here is: do we use MVC (which we will cover in the next chapter) or MVVM now? The answer depends on your personal preference. For this capability, we will continue using MVVM, or better, the ViewController, for a simple reason: both files (<code class="literal">TranslationController.js</code> and <code class="literal">Translation.js</code>) are located in the same directory (<code class="literal">app/view/locale</code>). And this means that it is easier to copy and paste this component to use it in other projects (we can copy the <code class="literal">locale</code> folder altogether).</p><p>So we need to create a new class named <code class="literal">Packt.view.locale.TranslationController</code>, and to create this class, we need to create a new file named <code class="literal">TranslationController.js</code> under the <code class="literal">app/view/locale</code> folder. In this controller, we will need to listen to two events: one fired by the <code class="literal">translation</code> component itself and the other one fired by <code class="literal">menuitems</code>:</p><div><pre class="programlisting">Ext.define('Packt.view.locale.TranslationController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.translation'
});</pre></div><p>Let's go back to the <code class="literal">Translation.js</code> file and add <code class="literal">TranslationController</code> as the ViewController so that we can start listening to the events:</p><div><pre class="programlisting">requires: [
    'Packt.view.locale.TranslationController'
],

controller: 'translation',</pre></div><p>The split button has two events, which are the <code class="literal">click</code> (fired because it is a button) and the <code class="literal">arrowclick</code> events, fired when<a id="id416" class="indexterm"/> the user clicks on the arrow. We are not interested in either event. Inside the split button, there is a <code class="literal">Menu</code> class with <code class="literal">menuitems</code>, and each <code class="literal">menuitem</code> represents a locale file. The <code class="literal">MenuItem</code> component also fires the <code class="literal">click</code> event when clicked on. So we can add the <code class="literal">click</code> listener to each <code class="literal">MenuItem</code>—or even better, add a <code class="literal">defaults</code> configuration to <code class="literal">menu</code>, as follows (which is going to be applied to all items):</p><div><pre class="programlisting">xtype: 'menu',
<strong>defaults:{    listeners: {        click: 'onMenuItemClick'    }},</strong>
</pre></div><p>Now, we can go back to <code class="literal">TranslationController</code> and implement the <code class="literal">onMenuItemClick</code> method, as follows:</p><div><pre class="programlisting">onMenuItemClick: function(item, e, options){

    var menu = this.getView(); //#1

    menu.setIconCls(item.iconCls); //#2
    menu.setText(item.text);       //#3

    localStorage.setItem("user-lang", item.iconCls); //#4

    window.location.reload(); //#5
}</pre></div><p>First, we will <a id="id417" class="indexterm"/>get the reference to the <code class="literal">translation</code> component (<code class="literal">#1</code>). Then, we will update the split button <code class="literal">iconCls</code> and <code class="literal">text</code> with <code class="literal">iconCls</code> and <code class="literal">text</code> of the selected Menu Item (<code class="literal">#2</code> and <code class="literal">#3</code>). Next, we will update the new language selected by the user on <code class="literal">localStorage</code> (<code class="literal">#4</code>), and finally, we will ask the browser to reload the application (<code class="literal">#5</code>).</p><div><div><div><div><h3 class="title"><a id="ch04lvl3sec20"/>The early life of the ViewController</h3></div></div></div><p>There is <a id="id418" class="indexterm"/>still one detail missing. When we load the application, the <code class="literal">translation</code> component does not have text or an icon configured. We also need to take care of this. We could listen to the <code class="literal">beforerender</code> or <code class="literal">render</code> events to update these two properties before the component is displayed to the user, but there is a very important detail: the ViewController is created very early in the component's life cycle, and for this reason, it is not possible to listen to these events.</p><p>There are three methods that we can use that can execute some tasks during the key points of the component's life cycle according to the Sencha documentation:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">beforeInit</code>: This<a id="id419" class="indexterm"/> method can be overridden in order to operate on the view prior to its <code class="literal">initComponent</code> method being called. This method is called immediately after the controller is created, which occurs during <code class="literal">initConfig</code> called from the component constructor.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Init</code>: This<a id="id420" class="indexterm"/> is called shortly after <code class="literal">initComponent</code> has been called on the view. This is the typical time to perform initialization for the controller now that the view is initialized.</li><li class="listitem" style="list-style-type: disc"><code class="literal">initViewModel</code>: This <a id="id421" class="indexterm"/>is called when the view's ViewModel is created (if one is defined).</li></ul></div><p>As we want <a id="id422" class="indexterm"/>the <code class="literal">translation</code> component to have <code class="literal">iconCls</code> and <code class="literal">text</code> when it is rendered, we can use the <code class="literal">init</code> method in <code class="literal">TranslationController</code> to execute this logic for us:</p><div><pre class="programlisting">init: function() {
    var lang = localStorage ? (localStorage.getItem('user-lang') || 'en') : 'en',
        button = this.getView();

    button.setIconCls(lang); //#1

    if (lang == 'en'){       //#2
        button.setText('English');
    } else if (lang == 'es'){
        button.setText('Español');
    } else {
        button.setText('Português');
    }
}</pre></div><p>First, we will verify that there is <code class="literal">localStorage</code>, and if positive, we will get the language that was stored. If there is no <code class="literal">localStorage</code>, or the preferred language was not stored yet (the first time the user uses the application or the user has not changed the language yet), the default language will be <code class="literal">English</code>. Then, we will set the <code class="literal">iconCls</code> of the split button as the flag of the selected language (<code class="literal">#1</code>).</p><p>If the selected language is English, we will set the split button <code class="literal">text</code> as <code class="literal">"English"</code> (<code class="literal">#2</code>), and if the selected language is Spanish, we will set the split button <code class="literal">text</code> as <code class="literal">"Español"</code> (<code class="literal">#8</code>); otherwise, we will set the text as <code class="literal">"Português"</code> (Portuguese).</p><div><div><h3 class="title"><a id="note41"/>Note</h3><p>This controller is also available in the MVC architecture. You can take a look at the differences between the MVC and MVVM implementation at <a class="ulink" href="http://goo.gl/ajaIao">http://goo.gl/ajaIao</a>.</p></div></div><p>If we execute the application, we can change the preferred language and see that the result is a translated <a id="id423" class="indexterm"/>application, as follows:</p><div><img src="img/0457OT_04_08.jpg" alt="The early life of the ViewController"/></div></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec52"/>Using locale files to translate Ext JS</h2></div></div></div><p>As usual, there<a id="id424" class="indexterm"/> is one last thing missing. We are translating only the labels of the application. Form errors and other messages that are part of the Ext JS API are not translated. Ext JS provides locale file support. All we need to do is add the JavaScript locale file on the HTML page. To do so, we are going to add the following code inside the <code class="literal">loadLocale</code> function in the <code class="literal">Application.js</code> file:</p><div><pre class="programlisting">var extJsFile = Ext.util.Format.format("ext/packages/ext-locale/build/ext-locale-{0}.js", lang);
Ext.Loader.loadScript({url: extJsFile});</pre></div><div><div><h3 class="title"><a id="tip23"/>Tip</h3><p>The name of <code class="literal">iconCls</code> used for the flag and translation files (<code class="literal">en.js</code>, <code class="literal">es,js</code>, <code class="literal">pt_BR.js</code>) are due to the name of the locale files used by Sencha. So make sure you verify what name Sencha is using before naming your own file.</p></div></div><p>And now, if we try to execute the application again, we will be able to see that all the Ext JS messages will also be translated. For example, if we change the translation to Spanish, the form validation errors will also be in Spanish:</p><div><img src="img/0457OT_04_09.jpg" alt="Using locale files to translate Ext JS"/></div><p>Now, the locale support of the application is completed!</p><div><div><h3 class="title"><a id="tip24"/>Tip</h3><p>You might want to review the label size (use the <code class="literal">labelWidth</code> configuration to change its default size of 100 pixels) and the message targets for the screens after applying locale support. For example, the label <strong>Contraseña</strong> needs more width in the screen than <strong>Password</strong>.</p></div></div><p>After applying the<a id="id425" class="indexterm"/> locale, change <code class="literal">labelWidth</code> to <code class="literal">70</code> inside the <code class="literal">Login</code> class. You can change <code class="literal">msgTarget</code> to '<code class="literal">side</code>' or increase the <code class="literal">height</code> of the window so that the form validation messages can be properly displayed in other languages as well.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec25"/>Summary</h1></div></div></div><p>We covered how to implement the base of the application we are going to implement throughout this book using the Border layout, and you learned how to implement a <strong>Logout </strong>button (on the Ext JS side and also on the server side). We also covered the Client Activity Monitor and Session Timeout capabilities.</p><p>And finally, you learned how to build a <code class="literal">translation</code> component using HTML5 features along with Ext JS, which is able to translate all the labels of the application and also change the preferred language at runtime. You also learned how to use the Ext JS locale support used to translate the framework's messages and labels.</p><p>We made a great advance in this chapter regarding the implementation of our application. We created new files and our application is growing. We will continue to create more files and components in the next chapters of this book.</p><p>In the next chapter, we will learn how to build a dynamic menu using Accordion panels and trees.</p></div></body></html>