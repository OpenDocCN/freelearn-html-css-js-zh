<html><head></head><body>
<div class="calibre1" id="_idContainer290">
<h1 class="chapternumber"><span class="kobospan" id="kobo.1.1">21</span></h1>
<h1 class="chaptertitle" id="_idParaDest-359"><span class="kobospan" id="kobo.2.1">SportsStore: Deployment</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.3.1">In this chapter, I complete the SportsStore application and prepare it for deployment to a container platform. </span><span class="kobospan" id="kobo.3.2">As part of the preparations, I move from the file-based SQLite database to a conventional database server and introduce an HTTPS proxy, which will allow multiple instances of the SportsStore application to receive requests and share load.</span></p>
<h1 class="heading" id="_idParaDest-360"><span class="kobospan" id="kobo.4.1">Preparing for this chapter</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.5.1">This chapter uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.6.1">sportsstore</span></code><span class="kobospan" id="kobo.7.1"> project from </span><em class="italic"><span class="kobospan" id="kobo.8.1">Chapter 20</span></em><span class="kobospan" id="kobo.9.1">. </span><span class="kobospan" id="kobo.9.2">Open a new command prompt, navigate to the </span><code class="inlinecode"><span class="kobospan" id="kobo.10.1">sportsstore</span></code><span class="kobospan" id="kobo.11.1"> folder, and run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.12.1">Listing 21.1</span></em><span class="kobospan" id="kobo.13.1"> to start the development tools.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.14.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.15.1">You can download the example project for this chapter – and for all the other chapters in this book – from </span><a href="https://github.com/PacktPublishing/Mastering-Node.js-Web-Development" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.16.1">https://github.com/PacktPublishing/Mastering-Node.js-Web-Development</span></span></a><span class="kobospan" id="kobo.17.1">. </span><span class="kobospan" id="kobo.17.2">See </span><em class="italic"><span class="kobospan" id="kobo.18.1">Chapter 1</span></em><span class="kobospan" id="kobo.19.1"> for how to get help if you have problems running the examples.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.20.1">Listing 21.1: Starting the development tools</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.21.1">npm start
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.22.1">Open a new browser window, navigate to </span><code class="inlinecode"><span class="kobospan" id="kobo.23.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.24.1">, and you will see the product catalog, as shown in </span><em class="italic"><span class="kobospan" id="kobo.25.1">Figure 21.1</span></em><span class="kobospan" id="kobo.26.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.27.1"><img alt="" src="../Images/B21959_21_01.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.28.1">Figure 21.1: Running the application</span></p>
<h1 class="heading" id="_idParaDest-361"><span class="kobospan" id="kobo.29.1">Installing Docker Desktop</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.30.1">There are many ways to deploy</span><a id="_idIndexMarker1142" class="calibre3"/><span class="kobospan" id="kobo.31.1"> an application, and there is no way that I can describe them all. </span><span class="kobospan" id="kobo.31.2">Instead, I have chosen the approach that offers the most flexibility, which is to use </span><em class="italic"><span class="kobospan" id="kobo.32.1">containers</span></em><span class="kobospan" id="kobo.33.1">. </span><span class="kobospan" id="kobo.33.2">Containers are lightweight virtual machines that run self-contained </span><em class="italic"><span class="kobospan" id="kobo.34.1">images</span></em><span class="kobospan" id="kobo.35.1"> and are built and deployed using standard tools. </span><span class="kobospan" id="kobo.35.2">Containers are portable and can be deployed to private and cloud infrastructures, which makes them a good choice for most applications.</span></p>
<p class="normal"><span class="kobospan" id="kobo.36.1">The most popular tool for creating and managing containers is Docker. </span><span class="kobospan" id="kobo.36.2">Go to </span><code class="inlinecode"><span class="kobospan" id="kobo.37.1">docker.com</span></code><span class="kobospan" id="kobo.38.1"> and download and install the Docker Desktop package. </span><span class="kobospan" id="kobo.38.2">Follow the installation process, reboot your machine, and run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.39.1">Listing 21.2</span></em><span class="kobospan" id="kobo.40.1"> to check that Docker has been installed and is in your path. </span><span class="kobospan" id="kobo.40.2">(The Docker installation process seems to change often, which is why I have not been more specific about the process.)</span></p>
<p class="normal"><span class="kobospan" id="kobo.41.1">You will have to create an account on </span><code class="inlinecode"><span class="kobospan" id="kobo.42.1">docker.com</span></code><span class="kobospan" id="kobo.43.1">; the free version of Docker contains all of the features needed for this chapter and the paid-for services are not required. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.44.1">Listing 21.2: Checking the Docker Desktop installation</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.45.1">docker --version
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.46.1">If Docker is installed and running, you will see a response similar to this one:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.47.1">Docker version 25.0.3, build 4debf41
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.48.1">You may see a different version</span><a id="_idIndexMarker1143" class="calibre3"/><span class="kobospan" id="kobo.49.1"> number, but that’s OK because the point is to make sure that Docker Desktop is up and running.</span></p>
<h1 class="heading" id="_idParaDest-362"><span class="kobospan" id="kobo.50.1">Managing the database</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.51.1">Throughout this part of the book, the SportsStore application</span><a id="_idIndexMarker1144" class="calibre3"/><span class="kobospan" id="kobo.52.1"> has been configured to automatically recreate and seed the database each time the server is started. </span><span class="kobospan" id="kobo.52.2">I generally like this approach for my own projects, but it is especially useful for book examples because it ensures that the reader is always working with clean data and removes one potential cause of problems, where the code changes and becomes out of sync with the database schema.</span></p>
<p class="normal"><span class="kobospan" id="kobo.53.1">In production, the database should not be reset every time the server starts, but it is still important to ensure that the database is created and seeded during the initial deployment. </span><span class="kobospan" id="kobo.53.2">To extend the administration tool so that the database can be reset and reseeded, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.54.1">database_routes.ts</span></code><span class="kobospan" id="kobo.55.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.56.1">src/routes/admin</span></code><span class="kobospan" id="kobo.57.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.58.1">Listing 21.3</span></em><span class="kobospan" id="kobo.59.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.60.1">Listing 21.3: The contents of the database_routes.ts file in the src/routes/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.61.1">import { Router } from "express";
import { CategoryModel, ProductModel, SupplierModel }
    from "../../data/orm/models";
import { readFileSync } from "fs";
import { getConfig } from "../../config";
export const createDbManagementRoutes = (router: Router) =&gt; {
    router.get("", (req, resp) =&gt; {
        resp.render("admin/db_mgt");
    });
    router.post("/reset", async (req, resp) =&gt; {
        await ProductModel.sequelize?.drop();
        await ProductModel.sequelize?.sync();
        const data = JSON.parse(readFileSync(getConfig("catalog:orm_repo")
            .seed_file).toString());
        await ProductModel.sequelize?.transaction(async (transaction) =&gt; {
            await SupplierModel.bulkCreate(data.suppliers, { transaction });
            await CategoryModel.bulkCreate(data.categories, { transaction });
            await ProductModel.bulkCreate(data.products, { transaction });
        });
        resp.render("admin/db_mgt", {
            admin_msg: "Products database reset and seeded"
        });
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.62.1">The handler for </span><code class="inlinecode"><span class="kobospan" id="kobo.63.1">GET</span></code><span class="kobospan" id="kobo.64.1"> requests</span><a id="_idIndexMarker1145" class="calibre3"/><span class="kobospan" id="kobo.65.1"> renders a template named </span><code class="inlinecode"><span class="kobospan" id="kobo.66.1">admin/db_mgt</span></code><span class="kobospan" id="kobo.67.1">, which will present the user with the ability to reset the database. </span><span class="kobospan" id="kobo.67.2">The handler for </span><code class="inlinecode"><span class="kobospan" id="kobo.68.1">POST</span></code><span class="kobospan" id="kobo.69.1"> requests accesses the </span><code class="inlinecode"><span class="kobospan" id="kobo.70.1">Sequelize</span></code><span class="kobospan" id="kobo.71.1"> object created by the repository through the </span><code class="inlinecode"><span class="kobospan" id="kobo.72.1">sequelize</span></code><span class="kobospan" id="kobo.73.1"> property added to model classes, calls the </span><code class="inlinecode"><span class="kobospan" id="kobo.74.1">drop</span></code><span class="kobospan" id="kobo.75.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.76.1">sync</span></code><span class="kobospan" id="kobo.77.1"> methods to reset the database, and then populates the database with the seed data. </span><em class="italic"><span class="kobospan" id="kobo.78.1">Listing 21.4</span></em><span class="kobospan" id="kobo.79.1"> enables the new routes and defines a direct navigation URL.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.80.1">Listing 21.4: Enabling routes in the index.ts file in the src/routes/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.81.1">import { Express, NextFunction, Request, Response, Router } from "express";
import { createAdminCatalogRoutes } from "./admin_catalog_routes";
import { createAdminOrderRoutes } from "./admin_order_routes";
import passport from "passport";
import { getConfig} from "../../config";
</span><strong class="screentext"><span class="kobospan" id="kobo.82.1">import</span></strong><strong class="screentext"><span class="kobospan" id="kobo.83.1"> { createDbManagementRoutes } from "./database_routes";</span></strong><span class="kobospan" id="kobo.84.1">
const users: string[] = getConfig("admin:users", []);
export const createAdminRoutes = (app: Express) =&gt; {
    // ... </span><span class="kobospan" id="kobo.84.2">routes omitted for brevity...
    </span><span class="kobospan" id="kobo.84.3">const authCheck = (r: Request) =&gt; users.find(u =&gt; r.user?.email === u);
    const apiAuth = (req: Request, resp: Response, next: NextFunction) =&gt; {
        if (!authCheck(req)) {
            return resp.sendStatus(401)
        }
        next();
    };
    const cat_router = Router();
    createAdminCatalogRoutes(cat_router);
    app.use("/api/products", apiAuth, cat_router);
    const order_router = Router();
    createAdminOrderRoutes(order_router);
    app.use("/api/orders", apiAuth, order_router);
    </span><strong class="screentext"><span class="kobospan" id="kobo.85.1">const db_router = </span></strong><strong class="screentext"><span class="kobospan" id="kobo.86.1">Router();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.87.1">    createDbManagementRoutes(db_router);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.88.1">    app.use("/api/database", apiAuth, db_router);</span></strong><span class="kobospan" id="kobo.89.1">
    const userAuth = (req: Request, resp: Response, next: NextFunction) =&gt; {
        if (!authCheck(req)) {
            return resp.redirect("/admin/signin");
        }
        next();
    };
    // ...other routes omitted for brevity...
    </span><span class="kobospan" id="kobo.89.2">app.get("/admin/orders", userAuth, (req, resp) =&gt; {
        resp.locals.content = "/api/orders/table";
        resp.render("admin/admin_layout");
    })
   </span><strong class="screentext"><span class="kobospan" id="kobo.90.1"> app.get("/admin/database", userAuth, (req, resp) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.91.1">        resp.locals.content = "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.92.1">/api/database";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.93.1">        resp.render("admin/admin_layout");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.94.1">    })   </span></strong><span class="kobospan" id="kobo.95.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.96.1">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.97.1">db_mgt.handlebars</span></code><span class="kobospan" id="kobo.98.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.99.1">templates/admin</span></code><span class="kobospan" id="kobo.100.1"> folder, with the content</span><a id="_idIndexMarker1146" class="calibre3"/><span class="kobospan" id="kobo.101.1"> shown in </span><em class="italic"><span class="kobospan" id="kobo.102.1">Listing 21.5</span></em><span class="kobospan" id="kobo.103.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.104.1">Listing 21.5: The contents of the db_mgt.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.105.1">{{&gt; admin/area_buttons mode="database"}}
&lt;div class="m-2"&gt;
    &lt;h5 class="text-danger text-center"&gt;{{admin_msg}}&lt;/h5&gt;
&lt;/div&gt;
&lt;div class="m-2 text-center"&gt;
    &lt;button class="btn btn-danger m-2"
        hx-post="/api/database/reset"
        hx-target="#content"&gt;Reset &amp; Seed Database&lt;/button&gt;
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.106.1">The template contains a </span><code class="inlinecode"><span class="kobospan" id="kobo.107.1">button</span></code><span class="kobospan" id="kobo.108.1"> element that sends a </span><code class="inlinecode"><span class="kobospan" id="kobo.109.1">POST</span></code><span class="kobospan" id="kobo.110.1"> request to the handler defined in </span><em class="italic"><span class="kobospan" id="kobo.111.1">Listing 21.4</span></em><span class="kobospan" id="kobo.112.1">, with an </span><code class="inlinecode"><span class="kobospan" id="kobo.113.1">h5</span></code><span class="kobospan" id="kobo.114.1"> element that displays a message provided by the handler. </span><em class="italic"><span class="kobospan" id="kobo.115.1">Listing 21.6</span></em><span class="kobospan" id="kobo.116.1"> adds a button in the </span><code class="inlinecode"><span class="kobospan" id="kobo.117.1">area_buttons</span></code><span class="kobospan" id="kobo.118.1"> template to include the database features in the content presented to the user.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.119.1">Listing 21.6: Adding a button in the area_buttons.handlebars file in the templates/admin folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.120.1">&lt;swap_wrapper hx-swap-oob="innerHTML:#area_buttons"&gt;
    &lt;div class="d-grid gap-2" &gt;
        &lt;button id="products_btn" class="btn {{ buttonClass "products" mode }}"
            hx-get="/api/products/table" hx-target="#content"
            hx-push-url="/admin/products"&gt;
            Products
        &lt;/button&gt;
        &lt;button id="orders_btn" class="btn {{ buttonClass "orders" mode }}"
            hx-get="/api/orders/table" hx-target="#content"
            hx-push-url="/admin/orders"&gt;
            Orders
        &lt;/button&gt;
      </span><strong class="screentext"><span class="kobospan" id="kobo.121.1">  &lt;button id</span></strong><strong class="screentext"><span class="kobospan" id="kobo.122.1">="db_btn" class="btn {{ buttonClass "database" mode }}"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.123.1">            hx-get="/api/database" hx-target="#content"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.124.1">            hx-push-url="</span></strong><strong class="screentext"><span class="kobospan" id="kobo.125.1">/admin/database"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.126.1">            Database</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.127.1">        &lt;/button&gt;</span></strong><span class="kobospan" id="kobo.128.1">
    &lt;/div&gt;
&lt;/swap_wrapper&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.129.1">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.130.1">http://localhost:5000/admin</span></code><span class="kobospan" id="kobo.131.1">, authenticate using OAuth, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.132.1">Delete</span></strong><span class="kobospan" id="kobo.133.1"> button for a few of the products. </span><span class="kobospan" id="kobo.133.2">It doesn’t matter how many or which ones you remove, since the purpose is to ensure that the database is reset and reseeded. </span><span class="kobospan" id="kobo.133.3">Click the </span><strong class="screentext"><span class="kobospan" id="kobo.134.1">Database</span></strong><span class="kobospan" id="kobo.135.1"> button, and then click </span><strong class="screentext"><span class="kobospan" id="kobo.136.1">Reset &amp; Seed Database</span></strong><span class="kobospan" id="kobo.137.1">. </span><span class="kobospan" id="kobo.137.2">Once the database</span><a id="_idIndexMarker1147" class="calibre3"/><span class="kobospan" id="kobo.138.1"> has been reset, click the </span><strong class="screentext"><span class="kobospan" id="kobo.139.1">Products</span></strong><span class="kobospan" id="kobo.140.1"> button and you will see the original data, as shown in </span><em class="italic"><span class="kobospan" id="kobo.141.1">Figure 21.2</span></em><span class="kobospan" id="kobo.142.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.143.1"><img alt="" src="../Images/B21959_21_02.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.144.1">Figure 21.2: Resetting the database</span></p>
<h1 class="heading" id="_idParaDest-363"><span class="kobospan" id="kobo.145.1">Toggling the application environment</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.146.1">The SportsStore application will be deployed</span><a id="_idIndexMarker1148" class="calibre3"/><span class="kobospan" id="kobo.147.1"> in a Docker container, which will be configured to set the application environment to </span><code class="inlinecode"><span class="kobospan" id="kobo.148.1">production</span></code><span class="kobospan" id="kobo.149.1">. </span><span class="kobospan" id="kobo.149.2">It is helpful to be able to switch to the production environment outside of the container in order to prepare the application for deployment. </span><span class="kobospan" id="kobo.149.3">One way to do this is to set an environment variable named </span><code class="inlinecode"><span class="kobospan" id="kobo.150.1">NODE_ENV</span></code><span class="kobospan" id="kobo.151.1"> using the command prompt used to start Node.js, but that can be difficult to do consistently when there are multiple developers, each with their own command prompt or shell preferences, each of which deals with environment variables in its own way. </span><span class="kobospan" id="kobo.151.2">A more reliable way is to rely on the </span><code class="inlinecode"><span class="kobospan" id="kobo.152.1">dotenv</span></code><span class="kobospan" id="kobo.153.1"> package, which reads environment variables from files.</span></p>
<p class="normal"><span class="kobospan" id="kobo.154.1">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.155.1">overrides.env</span></code><span class="kobospan" id="kobo.156.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.157.1">sportsstore</span></code><span class="kobospan" id="kobo.158.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.159.1">Listing 21.7</span></em><span class="kobospan" id="kobo.160.1">. </span><span class="kobospan" id="kobo.160.2">This is a temporary file, just to confirm that the application behaves as it should before it is prepared for deployment. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.161.1">Listing 21.7: The contents of the overrides.env file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.162.1">NODE_ENV=production
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.163.1">Listing 21.8</span></em><span class="kobospan" id="kobo.164.1"> uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.165.1">dotenv</span></code><span class="kobospan" id="kobo.166.1"> package to read the </span><code class="inlinecode"><span class="kobospan" id="kobo.167.1">.env</span></code><span class="kobospan" id="kobo.168.1"> file, which is done as soon as the application starts.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.169.1">Listing 21.8: Reading the .env file in the index.ts file in the src/config folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.170.1">import { readFileSync } from "fs";
import { getEnvironment, Env } from "./environment";
import { merge } from "./merge";
import { config as dotenvconfig } from "dotenv";
</span><strong class="screentext"><span class="kobospan" id="kobo.171.1">dotenvconfig({ path: "overrides.env", override: false});</span></strong><span class="kobospan" id="kobo.172.1">
const file = process.env.SERVER_CONFIG ?? </span><span class="kobospan" id="kobo.172.2">"server.config.json"
const data = JSON.parse(readFileSync(file).toString());
dotenvconfig({
    path: getEnvironment().toString() + ".env"
})
try {
    const envFile = getEnvironment().toString() + "." </span><span class="kobospan" id="kobo.172.3">+ file;
    const envData = JSON.parse(readFileSync(envFile).toString());
    merge(data, envData);
} catch {
    // do nothing - file doesn't exist or isn't readable
}
export const getConfig = (path: string, defaultVal: any = undefined) =&gt; {
    const paths = path.split(":");
    let val = data;
    paths.forEach(p =&gt; val = val[p]);
    return val ?? </span><span class="kobospan" id="kobo.172.4">defaultVal;
}
export const getSecret = (name: string) =&gt; {
    const secret = process.env[name];
    if (secret === undefined) {
        throw new Error(`Undefined secret: ${name}`);
    }
    return secret;
}
export { getEnvironment, Env };
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.173.1">You may be tempted to override the value returned by </span><code class="inlinecode"><span class="kobospan" id="kobo.174.1">getEnvironment</span></code><span class="kobospan" id="kobo.175.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.176.1">config</span></code><span class="kobospan" id="kobo.177.1"> module, which was created in </span><em class="italic"><span class="kobospan" id="kobo.178.1">Chapter 16</span></em><span class="kobospan" id="kobo.179.1">. </span><span class="kobospan" id="kobo.179.2">This will affect all of the custom </span><em class="italic"><span class="kobospan" id="kobo.180.1">SportsStore</span></em><span class="kobospan" id="kobo.181.1"> code, which has been written to use the </span><code class="inlinecode"><span class="kobospan" id="kobo.182.1">config</span></code><span class="kobospan" id="kobo.183.1"> module, but it won’t change the behavior of the third-party packages on which </span><em class="italic"><span class="kobospan" id="kobo.184.1">SportsStore</span></em><span class="kobospan" id="kobo.185.1"> relies. </span><span class="kobospan" id="kobo.185.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.186.1">NODE_ENV</span></code><span class="kobospan" id="kobo.187.1"> environment variable is a widely used convention, and many packages alter their behavior based on its value. </span><span class="kobospan" id="kobo.187.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.188.1">express-handlebars</span></code><span class="kobospan" id="kobo.189.1"> package, which integrates Handlebars templates into the Express framework, automatically compiles and caches template files when </span><code class="inlinecode"><span class="kobospan" id="kobo.190.1">NODE_ENV</span></code><span class="kobospan" id="kobo.191.1"> is set to production, for example.</span></p>
<p class="normal"><span class="kobospan" id="kobo.192.1">The application won’t run in production</span><a id="_idIndexMarker1149" class="calibre3"/><span class="kobospan" id="kobo.193.1"> mode because there are no settings for the secrets used to sign session cookies or perform OAuth requests. </span><em class="italic"><span class="kobospan" id="kobo.194.1">Listing 21.9</span></em><span class="kobospan" id="kobo.195.1"> adds settings to the </span><code class="inlinecode"><span class="kobospan" id="kobo.196.1">overrides</span></code><span class="kobospan" id="kobo.197.1"> file so that the application can be prepared for deployment.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.198.1">Listing 21.9: Adding settings in the overrides.env file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.199.1">NODE_ENV=production
</span><strong class="screentext"><span class="kobospan" id="kobo.200.1">COOKIE_SECRET="sportsstoresecret"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.201.1">GOOGLE_CLIENT_ID=&lt;enter your client ID&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.202.1">GOOGLE_CLIENT_SECRET=&lt;enter your secret&gt;</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.203.1">You must replace the placeholder text in </span><em class="italic"><span class="kobospan" id="kobo.204.1">Listing 21.9</span></em><span class="kobospan" id="kobo.205.1"> with the client ID and secret provided by Google when you configured OAuth in </span><em class="italic"><span class="kobospan" id="kobo.206.1">Chapter 19</span></em><span class="kobospan" id="kobo.207.1">. </span><span class="kobospan" id="kobo.207.2">The application will start without these settings, but you won’t be able to authenticate with the administration tools and populate the database.</span></p>
<p class="normal"><span class="kobospan" id="kobo.208.1">Stop the application and run the command</span><a id="_idIndexMarker1150" class="calibre3"/><span class="kobospan" id="kobo.209.1"> shown in </span><em class="italic"><span class="kobospan" id="kobo.210.1">Listing 21.10</span></em><span class="kobospan" id="kobo.211.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.212.1">sportsstore</span></code><span class="kobospan" id="kobo.213.1"> folder to start just the Node.js server. </span><span class="kobospan" id="kobo.213.2">The </span><strong class="screentext"><span class="kobospan" id="kobo.214.1">webpack</span></strong><span class="kobospan" id="kobo.215.1"> bundler, which was useful in ensuring that the client was updated during development, is no longer required.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.216.1">Listing 21.10: Starting the Node.js server</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.217.1">npm run server
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.218.1">The server will still be built and restarted when there is a change, but the webpack development server isn’t started, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.219.1">production</span></code><span class="kobospan" id="kobo.220.1"> environment configured in the </span><code class="inlinecode"><span class="kobospan" id="kobo.221.1">overrides.env</span></code><span class="kobospan" id="kobo.222.1"> file means that the Node.js server will handle all HTTP requests without attempting to forward them. </span><span class="kobospan" id="kobo.222.2">Before moving on, check that the application is running correctly by using the browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.223.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.224.1">, which should produce the catalog display shown in </span><em class="italic"><span class="kobospan" id="kobo.225.1">Figure 21.3</span></em><span class="kobospan" id="kobo.226.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.227.1"><img alt="" src="../Images/B21959_21_03.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.228.1">Figure 21.3: Running the application in production mode</span></p>
<h1 class="heading" id="_idParaDest-364"><span class="kobospan" id="kobo.229.1">Using a database server</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.230.1">It should be clear by now</span><a id="_idIndexMarker1151" class="calibre3"/><span class="kobospan" id="kobo.231.1"> that I am a huge fan of the SQLite database, which is packaged with features and is supported by every major package and framework. </span><span class="kobospan" id="kobo.231.2">The main limitation of SQLite is that it can’t be readily shared between multiple Node.js servers, so it is time to move to a conventional database server that can be queried over a network. </span><span class="kobospan" id="kobo.231.3">The database I am going to use in this chapter is PostgreSQL, usually referred to just as Postgres. </span><span class="kobospan" id="kobo.231.4">As I noted in </span><em class="italic"><span class="kobospan" id="kobo.232.1">Part 2</span></em><span class="kobospan" id="kobo.233.1">, all of the mainstream databases are good, but I picked Postgres because it is the most popular open-source database and because it is well supported by the </span><code class="inlinecode"><span class="kobospan" id="kobo.234.1">Sequelize</span></code><span class="kobospan" id="kobo.235.1"> ORM package. </span></p>
<p class="normal"><span class="kobospan" id="kobo.236.1">The simplest way to use Postgres is by running the database server in a container.</span></p>
<p class="normal"><span class="kobospan" id="kobo.237.1">Open a new command prompt and run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.238.1">Listing 21.11</span></em><span class="kobospan" id="kobo.239.1"> to download an image for Postgres and use it to create a new container. </span><span class="kobospan" id="kobo.239.2">The command may take a few moments to complete because the image has to be downloaded the first time it is used, but it will be cached for subsequent operations.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.240.1">Listing 21.11: Creating a container</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.241.1">docker run -e POSTGRES_PASSWORD=MySecret$ -p 5432:5432 postgres:16.2
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.242.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.243.1">docker run</span></code><span class="kobospan" id="kobo.244.1"> command</span><a id="_idIndexMarker1152" class="calibre3"/><span class="kobospan" id="kobo.245.1"> creates a new container. </span><span class="kobospan" id="kobo.245.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.246.1">-e</span></code><span class="kobospan" id="kobo.247.1"> argument sets environment variables for the container and, in this case, is used to set the password that is used to access the database server. </span><span class="kobospan" id="kobo.247.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.248.1">-p</span></code><span class="kobospan" id="kobo.249.1"> argument configures the network ports and is used to expose port </span><code class="inlinecode"><span class="kobospan" id="kobo.250.1">5432</span></code><span class="kobospan" id="kobo.251.1"> so that it can be accessed from the host operating system, allowing the database server to be used from outside of its container. </span><span class="kobospan" id="kobo.251.2">Leave the command prompt open. </span><span class="kobospan" id="kobo.251.3">The container will run until the </span><code class="inlinecode"><span class="kobospan" id="kobo.252.1">docker run</span></code><span class="kobospan" id="kobo.253.1"> command is terminated with </span><em class="italic"><span class="kobospan" id="kobo.254.1">Ctrl + C</span></em><span class="kobospan" id="kobo.255.1">.</span></p>
<p class="normal"><span class="kobospan" id="kobo.256.1">Run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.257.1">Listing 21.12</span></em><span class="kobospan" id="kobo.258.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.259.1">sportsstore</span></code><span class="kobospan" id="kobo.260.1"> folder to install the packages that will allow Sequelize to work with Postgres.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.261.1">Listing 21.12: Adding database packages</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.262.1">npm install pg@8.11.3
npm install pg-hstore@2.3.4
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.263.1">Table 21.1</span></em><span class="kobospan" id="kobo.264.1"> describes these packages for quick reference.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.265.1">Table 21.1: The CookieOptions packges </span></p>
<table class="table-container" id="table001-18">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.266.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.267.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.268.1">pg</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.269.1">This package contains support for communicating with Postgres servers.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.270.1">pg-hstore</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.271.1">This package contains support for storing JSON data in a Postgres database.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.272.1">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.273.1">production.server.config.json</span></code><span class="kobospan" id="kobo.274.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.275.1">sportsstore</span></code><span class="kobospan" id="kobo.276.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.277.1">Listing 21.13</span></em><span class="kobospan" id="kobo.278.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.279.1">Listing 21.13: The contents of the production.server.config.json in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.280.1">{
    "catalog": {
        "orm_repo": {
            "reset_db": false,
            "settings": {
                "dialect": "postgres",
                "host": "localhost",
                "port": "5432",
                "username": "postgres",
                "password": "MySecret$"
            }
        }
    },
    "sessions": {
        "reset_db": false,
        "orm": {
            "settings": {
                "dialect": "postgres",
                "host": "localhost",
                "port": "5432",
                "username": "postgres",
                "password": "MySecret$"
            }
        }       
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.281.1">The settings in </span><em class="italic"><span class="kobospan" id="kobo.282.1">Listing 21.13</span></em><span class="kobospan" id="kobo.283.1"> override those defined</span><a id="_idIndexMarker1153" class="calibre3"/><span class="kobospan" id="kobo.284.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.285.1">server.config.json</span></code><span class="kobospan" id="kobo.286.1"> file and are only applied when the application is in the </span><code class="inlinecode"><span class="kobospan" id="kobo.287.1">production</span></code><span class="kobospan" id="kobo.288.1"> environment. </span><span class="kobospan" id="kobo.288.2">Both configuration sections disable resetting the database every time and provide the configuration settings to connect to the database in the container.</span></p>
<p class="normal"><span class="kobospan" id="kobo.289.1">Stop the Node.js application and run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.290.1">Listing 21.14</span></em><span class="kobospan" id="kobo.291.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.292.1">sportstore</span></code><span class="kobospan" id="kobo.293.1"> folder to start it again using the new configuration file.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.294.1">Listing 21.14: Starting the application</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.295.1">npm run server
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.296.1">The application should connect to the Postgres database server. </span><span class="kobospan" id="kobo.296.2">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.297.1">http://localhost:5000/admin</span></code><span class="kobospan" id="kobo.298.1">, authenticate using a Google account, and populate the database by clicking the </span><strong class="screentext"><span class="kobospan" id="kobo.299.1">Reset &amp; Seed</span></strong> <strong class="screentext"><span class="kobospan" id="kobo.300.1">Database</span></strong><span class="kobospan" id="kobo.301.1"> button in the </span><strong class="screentext"><span class="kobospan" id="kobo.302.1">Database</span></strong><span class="kobospan" id="kobo.303.1"> section. </span><span class="kobospan" id="kobo.303.2">Click the </span><strong class="screentext"><span class="kobospan" id="kobo.304.1">Products</span></strong><span class="kobospan" id="kobo.305.1"> selection to confirm the database has been populated, as shown in </span><em class="italic"><span class="kobospan" id="kobo.306.1">Figure 21.4</span></em><span class="kobospan" id="kobo.307.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.308.1"><img alt="" src="../Images/B21959_21_04.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.309.1">Figure 21.4: Populating the database</span></p>
<p class="normal"><span class="kobospan" id="kobo.310.1">Use </span><em class="italic"><span class="kobospan" id="kobo.311.1">Ctrl + C</span></em><span class="kobospan" id="kobo.312.1"> to stop both the application</span><a id="_idIndexMarker1154" class="calibre3"/><span class="kobospan" id="kobo.313.1"> and the database once you have confirmed that </span><em class="italic"><span class="kobospan" id="kobo.314.1">SportsStore</span></em><span class="kobospan" id="kobo.315.1"> is working with Postgres.</span></p>
<h1 class="heading" id="_idParaDest-365"><span class="kobospan" id="kobo.316.1">Creating the SportsStore Docker image</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.317.1">The next step is to prepare</span><a id="_idIndexMarker1155" class="calibre3"/><span class="kobospan" id="kobo.318.1"> an image that contains Node.js, the </span><em class="italic"><span class="kobospan" id="kobo.319.1">SportsStore</span></em><span class="kobospan" id="kobo.320.1"> application, all of the packages that it relies on, the templates, and the configuration files. </span><span class="kobospan" id="kobo.320.2">The first step is to create a file that tells Docker to ignore the </span><code class="inlinecode"><span class="kobospan" id="kobo.321.1">node_modules</span></code><span class="kobospan" id="kobo.322.1"> folder, which causes a slowdown in the creation of an image because all of the folders are scanned. </span><span class="kobospan" id="kobo.322.2">Create a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.323.1">.dockerignore</span></code><span class="kobospan" id="kobo.324.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.325.1">sportsstore</span></code><span class="kobospan" id="kobo.326.1"> folder, with the contents shown in </span><em class="italic"><span class="kobospan" id="kobo.327.1">Listing 21.15</span></em><span class="kobospan" id="kobo.328.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.329.1">Listing 21.15: The contents of the .dockerignore file in the sportsstore folder</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.330.1">node_modules
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.331.1">The next step is to create the file that tells Docker how to create the image. </span><span class="kobospan" id="kobo.331.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.332.1">Dockerfile</span></code><span class="kobospan" id="kobo.333.1"> (with no file extension) to the </span><code class="inlinecode"><span class="kobospan" id="kobo.334.1">sportsstore</span></code><span class="kobospan" id="kobo.335.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.336.1">Listing 21.16</span></em><span class="kobospan" id="kobo.337.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.338.1">Listing 21.16: The contents of the Dockerfile file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.339.1">FROM node:20.10.0
RUN mkdir -p /usr/src/sportsstore
COPY dist /usr/src/sportsstore/dist
COPY templates /usr/src/sportsstore/templates
COPY products.json /usr/src/sportsstore/
COPY server.config.json /usr/src/sportsstore/
COPY production.server.config.json /usr/src/sportsstore/
COPY package.json /usr/src/sportsstore/
WORKDIR /usr/src/sportsstore
RUN npm install --omit=dev
RUN npm install wait-for-it.sh@1.0.0
ENV NODE_ENV=production
ENV COOKIE_SECRET="sportsstoresecret"
ENV GOOGLE_CLIENT_ID=&lt;enter your ID&gt;
ENV GOOGLE_CLIENT_SECRET=&lt;enter your secret&gt;
EXPOSE 5000
ENTRYPOINT npx wait-for-it postgres:5432 &amp;&amp; node dist/server.js
</span></code></pre>
<p class="normal"><code class="inlinecode"><span class="kobospan" id="kobo.340.1">Dockerfile</span></code><span class="kobospan" id="kobo.341.1"> contains</span><a id="_idIndexMarker1156" class="calibre3"/><span class="kobospan" id="kobo.342.1"> a series of instructions that will be used to build the image. </span><span class="kobospan" id="kobo.342.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.343.1">FROM</span></code><span class="kobospan" id="kobo.344.1"> command tells Docker to use the image for the version of Node.js used throughout this book as the foundation for the image, which simplifies the setup process.</span></p>
<p class="normal"><span class="kobospan" id="kobo.345.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.346.1">COPY</span></code><span class="kobospan" id="kobo.347.1"> commands tell Docker to copy files from the project into the container. </span><span class="kobospan" id="kobo.347.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.348.1">WORKDIR</span></code><span class="kobospan" id="kobo.349.1"> command changes the working directory for subsequent commands. </span><span class="kobospan" id="kobo.349.2">This command installs the packages required to run the application:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.350.1">...
</span><span class="kobospan" id="kobo.350.2">RUN npm install --omit=dev
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.351.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.352.1">--omit</span></code><span class="kobospan" id="kobo.353.1"> argument is used to exclude the packages that were added with the </span><code class="inlinecode"><span class="kobospan" id="kobo.354.1">npm install --save-dev</span></code><span class="kobospan" id="kobo.355.1"> command, which means that packages such as the TypeScript compiler won’t be included in the image.</span></p>
<p class="normal"><span class="kobospan" id="kobo.356.1">The command that follows installs a package that is only required when the application is deployed:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.357.1">...
</span><span class="kobospan" id="kobo.357.2">RUN npm install wait-for-it.sh@1.0.0
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.358.1">Coordinating between containers can be difficult and it is important to ensure that the SportsStore application isn’t started until the database server is ready to receive requests. </span><span class="kobospan" id="kobo.358.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.359.1">wait-for-it </span></code><span class="kobospan" id="kobo.360.1">package waits until a TCP port has been opened and is a simple and reliable way to ensure that the application in one container is ready before another container is started.</span></p>
<p class="normal"><span class="kobospan" id="kobo.361.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.362.1">ENV</span></code><span class="kobospan" id="kobo.363.1"> commands set the environment variables and are used to set </span><code class="inlinecode"><span class="kobospan" id="kobo.364.1">production</span></code><span class="kobospan" id="kobo.365.1"> mode and define the secrets used to sign cookies and perform Google OAuth requests.</span></p>
<p class="normal"><span class="kobospan" id="kobo.366.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.367.1">EXPOSE</span></code><span class="kobospan" id="kobo.368.1"> command</span><a id="_idIndexMarker1157" class="calibre3"/><span class="kobospan" id="kobo.369.1"> tells Docker to expose port </span><code class="inlinecode"><span class="kobospan" id="kobo.370.1">5000</span></code><span class="kobospan" id="kobo.371.1">, which will allow the SportsStore application to receive HTTP requests. </span><span class="kobospan" id="kobo.371.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.372.1">ENTRYPOINT</span></code><span class="kobospan" id="kobo.373.1"> command is executed when the container is started and comes in two parts. </span><span class="kobospan" id="kobo.373.2">The first part uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.374.1">wait-for-it</span></code><span class="kobospan" id="kobo.375.1"> package to block until port </span><code class="inlinecode"><span class="kobospan" id="kobo.376.1">5432</span></code><span class="kobospan" id="kobo.377.1"> on a server named </span><code class="inlinecode"><span class="kobospan" id="kobo.378.1">postgres</span></code><span class="kobospan" id="kobo.379.1"> is open. </span><span class="kobospan" id="kobo.379.2">This is the name that will be given to the database when the containers are connected in the </span><em class="italic"><span class="kobospan" id="kobo.380.1">Composing the application and database servers</span></em><span class="kobospan" id="kobo.381.1"> section. </span><span class="kobospan" id="kobo.381.2">The second part runs the </span><code class="inlinecode"><span class="kobospan" id="kobo.382.1">server.js</span></code><span class="kobospan" id="kobo.383.1"> file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.384.1">dist</span></code><span class="kobospan" id="kobo.385.1"> folder, which will start the </span><em class="italic"><span class="kobospan" id="kobo.386.1">SportsStore</span></em><span class="kobospan" id="kobo.387.1"> application.</span></p>
<h2 class="heading1" id="_idParaDest-366"><span class="kobospan" id="kobo.388.1">Preparing the application</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.389.1">Images are a snapshot of an application</span><a id="_idIndexMarker1158" class="calibre3"/><span class="kobospan" id="kobo.390.1"> and its associated files. </span><span class="kobospan" id="kobo.390.2">Before creating the image, it is important to make any final configuration changes and build the code to make sure that the JavaScript included in the image reflects the final TypeScript code.</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.391.1">Listing 21.17</span></em><span class="kobospan" id="kobo.392.1"> alters the name used for the Postgres server from </span><code class="inlinecode"><span class="kobospan" id="kobo.393.1">localhost</span></code><span class="kobospan" id="kobo.394.1"> to </span><code class="inlinecode"><span class="kobospan" id="kobo.395.1">postgres</span></code><span class="kobospan" id="kobo.396.1">, which is the name that will be given to the database server when it is deployed. </span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.397.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.398.1">In a real project, you would also change the OAuth redirection URLs so that they contain the public domain name by which your users connect to the service. </span><span class="kobospan" id="kobo.398.2">The </span><em class="italic"><span class="kobospan" id="kobo.399.1">SportsStore</span></em><span class="kobospan" id="kobo.400.1"> application will only be used on the development machine, and so the redirection URLs containing </span><code class="inlinecode"><span class="kobospan" id="kobo.401.1">localhost</span></code><span class="kobospan" id="kobo.402.1"> will continue to work, but this will not be the case for real projects.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.403.1">Listing 21.17: Changing the server name in the production.server.config.json file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.404.1">{
    "catalog": {
        "orm_repo": {
            "reset_db": false,
            "settings": {
                "dialect": "postgres",
               </span><strong class="screentext"><span class="kobospan" id="kobo.405.1"> "host": "postgres",</span></strong><span class="kobospan" id="kobo.406.1">
                "port": "5432",
                "username": "postgres",
                "password": "MySecret$"
            }
        }
    },
    "sessions": {
        "reset_db": false,
        "orm": {
            "settings": {
                "dialect": "postgres",
</span><strong class="screentext"><span class="kobospan" id="kobo.407.1">                "host": "postgres",</span></strong><span class="kobospan" id="kobo.408.1">
                "port": "5432",
                "username": "postgres",
                "password": "MySecret$"
            }
        }       
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.409.1">Run the command</span><a id="_idIndexMarker1159" class="calibre3"/><span class="kobospan" id="kobo.410.1"> shown in </span><em class="italic"><span class="kobospan" id="kobo.411.1">Listing 21.18</span></em><span class="kobospan" id="kobo.412.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.413.1">sportsstore</span></code><span class="kobospan" id="kobo.414.1"> folder to run the TypeScript compiler to create the final build of the code.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.415.1">Listing 21.18: Compiling the TypeScript code</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.416.1">npx tsc
</span></code></pre>
<h2 class="heading1" id="_idParaDest-367"><span class="kobospan" id="kobo.417.1">Creating the SportsStore image</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.418.1">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.419.1">Listing 21.19</span></em><span class="kobospan" id="kobo.420.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.421.1">sportsstore</span></code><span class="kobospan" id="kobo.422.1"> folder</span><a id="_idIndexMarker1160" class="calibre3"/><span class="kobospan" id="kobo.423.1"> to create the image that contains the SportsStore application. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.424.1">Listing 21.19: Creating the sportsstore image</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.425.1">docker build . </span><span class="kobospan" id="kobo.425.2">-t sportsstore -f Dockerfile
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.426.1">As the image is created, you will see output similar to the following:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.427.1">[+] Building 25.6s (17/17) FINISHED    docker:default
 =&gt; [internal] load build definition from Dockerfile
=&gt; =&gt; transferring dockerfile: 785B
=&gt; [internal] load metadata for docker.io/library/node:20.10.0
=&gt; [auth] library/node:pull token for registry-1.docker.io
=&gt; [internal] load .dockerignore
=&gt; =&gt; transferring context: 52B
=&gt; [internal] load build context 
=&gt; =&gt; transferring context: 60.69kB
=&gt; [ 1/11] FROM docker.io/library/node:20.10.0@sha256:8d0f16fe841577f9317ab49011c6d819e1fa81f8d
=&gt; CACHED [ 2/11] RUN mkdir -p /usr/src/sportsstore
=&gt; CACHED [ 3/11] COPY dist /usr/src/sportsstore/dist
=&gt; CACHED [ 4/11] COPY templates /usr/src/sportsstore/templates
=&gt; CACHED [ 5/11] COPY products.json /usr/src/sportsstore/
=&gt; CACHED [ 6/11] COPY server.config.json /usr/src/sportsstore/
=&gt; CACHED [ 7/11] COPY production.server.config.json /usr/src/sportsstore/
=&gt; CACHED [ 8/11] COPY package.json /usr/src/sportsstore/
=&gt; CACHED [ 9/11] WORKDIR /usr/src/sportsstore
=&gt; [10/11] RUN npm install --omit=dev
=&gt; [11/11] RUN npm install wait-for-it.sh@1.0.0  
=&gt; exporting to image
=&gt; =&gt; exporting layers
=&gt; =&gt; writing image sha256:4b2f72d561dfbe21695573d7f448bc6ada3a9c4802bc5a70b8af1676e82c1fcd 
=&gt; =&gt; naming to docker.io/library/sportsstore
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.428.1">This command can take a while to run because the Node.js image must be downloaded, and the packages required by the SportsStore application have to be installed.</span></p>
<h1 class="heading" id="_idParaDest-368"><span class="kobospan" id="kobo.429.1">Composing the application and database servers</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.430.1">The next step is to create</span><a id="_idIndexMarker1161" class="calibre3"/><span class="kobospan" id="kobo.431.1"> the configuration file that specifies</span><a id="_idIndexMarker1162" class="calibre3"/><span class="kobospan" id="kobo.432.1"> how the SportsStore and Postgres images will be used to create containers. </span><span class="kobospan" id="kobo.432.2">This step is dependent on how the containers are going to be deployed, for which there are many options. </span><span class="kobospan" id="kobo.432.3">All of the major cloud platforms provide support for using containers, and the configuration will have to be adapted to the needs and features of the target platform.</span></p>
<p class="normal"><span class="kobospan" id="kobo.433.1">For this chapter, I am going to use Docker Compose, which is the built-in tool provided with Docker Desktop. </span><span class="kobospan" id="kobo.433.2">You may not use Docker Compose for your projects, but it has the same core features that you will encounter regardless of how you deploy, and it makes it easy to combine and test containers to create a complete application. </span><span class="kobospan" id="kobo.433.3">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.434.1">docker-compose.yml</span></code><span class="kobospan" id="kobo.435.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.436.1">sportsstore</span></code><span class="kobospan" id="kobo.437.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.438.1">Listing 21.20</span></em><span class="kobospan" id="kobo.439.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.440.1">Listing 21.20: The contents of the docker-compose.yml file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.441.1">version: "3"
volumes:
  databases:
services:
  postgres:
    image: "postgres:16.2"
    volumes:
      - databases:/var/lib/postgresql/data
    environment:
      - POSTGRES_PASSWORD=MySecret$
   
  sportsstore:
    image: "sportsstore"
    depends_on:
      - postgres
    ports:
      - 5000:5000
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.442.1">The format of the file is YAML, which is sensitive to indentation and the contents must be entered exactly as shown. </span><span class="kobospan" id="kobo.442.2">Most code editors, including Visual Studio Code, include YAML syntax highlighting, which helps identify content or formatting errors.</span></p>
<p class="normal"><span class="kobospan" id="kobo.443.1">The configuration in </span><em class="italic"><span class="kobospan" id="kobo.444.1">Listing 21.20</span></em><span class="kobospan" id="kobo.445.1"> tells Docker Compose to create two containers. </span><span class="kobospan" id="kobo.445.2">The first, which will be given the name </span><code class="inlinecode"><span class="kobospan" id="kobo.446.1">postgres</span></code><span class="kobospan" id="kobo.447.1">, contains the database server. </span><span class="kobospan" id="kobo.447.2">This service is configured with a volume, which is the Docker feature for persisting data and, without which, the contents of the database would be lost.</span></p>
<p class="normal"><span class="kobospan" id="kobo.448.1">The second, named </span><code class="inlinecode"><span class="kobospan" id="kobo.449.1">sportsstore</span></code><span class="kobospan" id="kobo.450.1">, contains</span><a id="_idIndexMarker1163" class="calibre3"/><span class="kobospan" id="kobo.451.1"> the application. </span><span class="kobospan" id="kobo.451.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.452.1">sportsstore</span></code><span class="kobospan" id="kobo.453.1"> container</span><a id="_idIndexMarker1164" class="calibre3"/><span class="kobospan" id="kobo.454.1"> is configured to export port </span><code class="inlinecode"><span class="kobospan" id="kobo.455.1">5000</span></code><span class="kobospan" id="kobo.456.1"> to the host operating system so that it can receive HTTP requests. </span><span class="kobospan" id="kobo.456.2">Communication between containers uses the service names as hostnames, which is why </span><em class="italic"><span class="kobospan" id="kobo.457.1">Listing 21.17</span></em><span class="kobospan" id="kobo.458.1"> changes the name of the database server to </span><code class="inlinecode"><span class="kobospan" id="kobo.459.1">postgres</span></code><span class="kobospan" id="kobo.460.1">.</span></p>
<p class="normal"><span class="kobospan" id="kobo.461.1">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.462.1">Listing 21.21</span></em><span class="kobospan" id="kobo.463.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.464.1">sportsstore</span></code><span class="kobospan" id="kobo.465.1"> folder to prepare the containers.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.466.1">Listing 21.21: Preparing the containers</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.467.1">docker-compose build
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.468.1">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.469.1">Listing 21.22</span></em><span class="kobospan" id="kobo.470.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.471.1">sportsstore</span></code><span class="kobospan" id="kobo.472.1"> folder to start the containers.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.473.1">Listing 21.22: Starting the containers</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.474.1">docker-compose up
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.475.1">Docker will create and start the containers for the database server and the application and display the console messages they generate. </span><span class="kobospan" id="kobo.475.2">Wait a moment to allow the containers to start up, and then use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.476.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.477.1">. </span><span class="kobospan" id="kobo.477.2">The database will be empty but can be populated using the administration tools, as shown in </span><em class="italic"><span class="kobospan" id="kobo.478.1">Figure 21.5</span></em><span class="kobospan" id="kobo.479.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.480.1"><img alt="" src="../Images/B21959_21_05.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.481.1">Figure 21.5: Using Docker Compose</span></p>
<p class="normal"><span class="kobospan" id="kobo.482.1">The application and the database</span><a id="_idIndexMarker1165" class="calibre3"/><span class="kobospan" id="kobo.483.1"> server are each running</span><a id="_idIndexMarker1166" class="calibre3"/><span class="kobospan" id="kobo.484.1"> in a container and can communicate with one another. </span><span class="kobospan" id="kobo.484.2">The network used for communication between containers is created and managed by Docker.</span></p>
<h1 class="heading" id="_idParaDest-369"><span class="kobospan" id="kobo.485.1">Setting up an HTTPS reverse proxy</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.486.1">The next step is to introduce</span><a id="_idIndexMarker1167" class="calibre3"/><span class="kobospan" id="kobo.487.1"> support for HTTPS, which will be handled</span><a id="_idIndexMarker1168" class="calibre3"/><span class="kobospan" id="kobo.488.1"> by a proxy package named </span><strong class="screentext"><span class="kobospan" id="kobo.489.1">HAProxy</span></strong><span class="kobospan" id="kobo.490.1"> (</span><a href="https://www.haproxy.org" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.491.1">https://www.haproxy.org</span></span></a><span class="kobospan" id="kobo.492.1">). </span><span class="kobospan" id="kobo.492.2">There are many proxies available, but this is one that I have used for many years and have always found reliable.</span></p>
<p class="normal"><span class="kobospan" id="kobo.493.1">To prepare for the proxy, copy your certificate and key files into the </span><code class="inlinecode"><span class="kobospan" id="kobo.494.1">sportsstore</span></code><span class="kobospan" id="kobo.495.1"> folder with the names </span><code class="inlinecode"><span class="kobospan" id="kobo.496.1">cert.pem</span></code><span class="kobospan" id="kobo.497.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.498.1">key.pem</span></code><span class="kobospan" id="kobo.499.1">. </span><em class="italic"><span class="kobospan" id="kobo.500.1">Chapter 5</span></em><span class="kobospan" id="kobo.501.1"> contains instructions for creating a free self-signed certificate, or you can copy the files from the GitHub project for this chapter, which contains a self-signed certificate that I created.</span></p>
<div class="note">
<p class="normal"><span class="kobospan" id="kobo.502.1">You can use a real certificate, but you must ensure that the domain name associated with the certificate resolves to the machine on which you are running the containers, which can be difficult to arrange.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.503.1">To create the proxy</span><a id="_idIndexMarker1169" class="calibre3"/><span class="kobospan" id="kobo.504.1"> configuration file, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.505.1">haproxy.cfg</span></code><span class="kobospan" id="kobo.506.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.507.1">sportsstore</span></code><span class="kobospan" id="kobo.508.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.509.1">Listing 21.23</span></em><span class="kobospan" id="kobo.510.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.511.1">Listing 21.23: The contents of the haproxy.cfg file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.512.1">defaults
    mode http
    timeout connect 5000
    timeout client  50000
    timeout server  50000
resolvers dockerdns
    nameserver dns1 127.0.0.11:53
frontend localnodes
    bind *:80
    bind *:443 ssl crt /usr/local/etc/haproxy/cert.pem
    http-request redirect scheme https unless { ssl_fc }
    default_backend app
backend app
    balance roundrobin
    server-template sportsstore- 5 sportsstore:5000 check resolvers dockerdns
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.513.1">This configuration sets up the proxy to listen for requests on port </span><code class="inlinecode"><span class="kobospan" id="kobo.514.1">80</span></code><span class="kobospan" id="kobo.515.1"> and port </span><code class="inlinecode"><span class="kobospan" id="kobo.516.1">443</span></code><span class="kobospan" id="kobo.517.1">. </span><span class="kobospan" id="kobo.517.2">HTTP requests will be redirected to use HTTPS. </span><span class="kobospan" id="kobo.517.3">HTTPS requests will be forwarded to SportsStore, which is located by querying the DNS provided by Docker to containers. </span><span class="kobospan" id="kobo.517.4">The use of DNS allows multiple </span><code class="inlinecode"><span class="kobospan" id="kobo.518.1">sportsstore</span></code><span class="kobospan" id="kobo.519.1"> containers to run and for the proxy to distribute requests between them.</span></p>
<p class="normal"><span class="kobospan" id="kobo.520.1">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.521.1">Dockerfile.proxy</span></code><span class="kobospan" id="kobo.522.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.523.1">sportsstore</span></code><span class="kobospan" id="kobo.524.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.525.1">Listing 21.24</span></em><span class="kobospan" id="kobo.526.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.527.1">Listing 21.24: The contents of the Dockerfile.proxy file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.528.1">FROM haproxy:2.9.6
COPY haproxy.cfg /usr/local/etc/haproxy
COPY cert.pem /usr/local/etc/haproxy
COPY key.pem /usr/local/etc/haproxy/cert.pem.key
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.529.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.530.1">FROM</span></code><span class="kobospan" id="kobo.531.1"> command uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.532.1">haproxy</span></code><span class="kobospan" id="kobo.533.1"> image to create the new container, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.534.1">COPY</span></code><span class="kobospan" id="kobo.535.1"> commands include the configuration and certificate files in the image. </span><span class="kobospan" id="kobo.535.2">Run the command</span><a id="_idIndexMarker1170" class="calibre3"/><span class="kobospan" id="kobo.536.1"> shown in </span><em class="italic"><span class="kobospan" id="kobo.537.1">Listing 21.25</span></em><span class="kobospan" id="kobo.538.1"> to create an image for the proxy.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.539.1">Listing 21.25: Creating the proxy image</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.540.1">docker build . </span><span class="kobospan" id="kobo.540.2">-t ss-proxy -f Dockerfile.proxy
</span></code></pre>
<h2 class="heading1" id="_idParaDest-370"><span class="kobospan" id="kobo.541.1">Updating the OAuth URLs</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.542.1">The change in ports</span><a id="_idIndexMarker1171" class="calibre3"/><span class="kobospan" id="kobo.543.1"> and forcing the use</span><a id="_idIndexMarker1172" class="calibre3"/><span class="kobospan" id="kobo.544.1"> of HTTPS require a change to the SportsStore configuration for the OAuth redirection URLs, as shown in </span><em class="italic"><span class="kobospan" id="kobo.545.1">Listing 21.26</span></em><span class="kobospan" id="kobo.546.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.547.1">Listing 21.26: Updating URLs in the production.server.config.json file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.548.1">{
    "catalog": {
        "orm_repo": {
            "reset_db": false,           
            "settings": {
                "dialect": "postgres",
                "host": "postgres",
                "port": "5432",
                "username": "postgres",
                "password": "MySecret$"
            }
        }
    },
    "sessions": {
        "reset_db": false,
        "orm": {
            "settings": {
                "dialect": "postgres",
                "host": "postgres",
                "port": "5432",
                "username": "postgres",
                "password": "MySecret$"
            }
        }       
    },
   </span><strong class="screentext"><span class="kobospan" id="kobo.549.1"> "auth": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.550.1">        "openauth": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.551.1">            "redirectionUrl": "https://localhost/signin-google"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.552.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.553.1">    },</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.554.1">    "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.555.1">admin": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.556.1">        "openauth": {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.557.1">            "redirectionUrl": "https://localhost/auth-signin-google"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.558.1">        }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.559.1">    }</span></strong><span class="kobospan" id="kobo.560.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.561.1">Without these</span><a id="_idIndexMarker1173" class="calibre3"/><span class="kobospan" id="kobo.562.1"> changes, the OAuth redirections</span><a id="_idIndexMarker1174" class="calibre3"/><span class="kobospan" id="kobo.563.1"> won’t be received by the application. </span><span class="kobospan" id="kobo.563.2">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.564.1">Listing 21.27</span></em><span class="kobospan" id="kobo.565.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.566.1">sportsstore</span></code><span class="kobospan" id="kobo.567.1"> folder to update the SportsStore image to reflect the configuration changes.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.568.1">Listing 21.27: Updating the SportsStore image</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.569.1">docker build . </span><span class="kobospan" id="kobo.569.2">-t sportsstore -f Dockerfile
</span></code></pre>
<h2 class="heading1" id="_idParaDest-371"><span class="kobospan" id="kobo.570.1">Completing the configuration</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.571.1">The final step is to update</span><a id="_idIndexMarker1175" class="calibre3"/><span class="kobospan" id="kobo.572.1"> the Docker Compose file to add the proxy and create multiple </span><em class="italic"><span class="kobospan" id="kobo.573.1">SportsStore</span></em><span class="kobospan" id="kobo.574.1"> containers, as shown in </span><em class="italic"><span class="kobospan" id="kobo.575.1">Listing 21.28</span></em><span class="kobospan" id="kobo.576.1">. </span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.577.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.578.1">This configuration opens ports that are restricted on some operating systems, which means that superuser or administrator access may be required.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.579.1">Listing 21.28: Completing the configuration in the docker-compose.yml file in the sportsstore folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.580.1">version: "3"
volumes:
  databases:
services:
  postgres:
    image: "postgres:16.2"
    volumes:
      - databases:/var/lib/postgresql/data
    environment:
      - POSTGRES_PASSWORD=MySecret$
   
  sportsstore:
    image: "sportsstore"
    depends_on:
      - postgres
 </span><strong class="screentext"><span class="kobospan" id="kobo.581.1">   # ports:</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.582.1">    #   - 5000:5000</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.583.1">    deploy:</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.584.1">      replicas: 5</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.585.1">  proxy:</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.586.1">    image: "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.587.1">ss-proxy"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.588.1">    ports:</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.589.1">      - 80:80</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.590.1">      - 443:443</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.591.1">Stop all of the existing containers by running the command shown in </span><em class="italic"><span class="kobospan" id="kobo.592.1">Listing 21.29</span></em><span class="kobospan" id="kobo.593.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.594.1">sportsstore</span></code><span class="kobospan" id="kobo.595.1"> folder.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.596.1">Listing 21.29: Stopping containers</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.597.1">docker-compose down
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.598.1">Wait until the containers</span><a id="_idIndexMarker1176" class="calibre3"/><span class="kobospan" id="kobo.599.1"> have stopped and then run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.600.1">Listing 21.30</span></em><span class="kobospan" id="kobo.601.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.602.1">sportsstore</span></code><span class="kobospan" id="kobo.603.1"> folder to start the database, multiple instances of the </span><em class="italic"><span class="kobospan" id="kobo.604.1">SportsStore</span></em><span class="kobospan" id="kobo.605.1"> application, and the proxy. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.606.1">Listing 21.30: Starting the containers</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.607.1">docker-compose up
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.608.1">Docker will start a total of five </span><em class="italic"><span class="kobospan" id="kobo.609.1">SportsStore</span></em><span class="kobospan" id="kobo.610.1"> containers, all of which will share access to the same session and catalog data. </span><span class="kobospan" id="kobo.610.2">Open a browser and request </span><code class="inlinecode"><span class="kobospan" id="kobo.611.1">http://localhost</span></code><span class="kobospan" id="kobo.612.1"> and you will be redirected to use HTTPS instead, as shown in </span><em class="italic"><span class="kobospan" id="kobo.613.1">Figure 21.6</span></em><span class="kobospan" id="kobo.614.1">. </span><span class="kobospan" id="kobo.614.2">As explained in </span><em class="italic"><span class="kobospan" id="kobo.615.1">Chapter 5</span></em><span class="kobospan" id="kobo.616.1">, you may have to navigate past security warnings because the certificate used by the proxy is self-signed.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.617.1"><img alt="" src="../Images/B21959_21_06.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.618.1">Figure 21.6: Redirecting insecure connections</span></p>
<p class="normal"><span class="kobospan" id="kobo.619.1">You can populate the database</span><a id="_idIndexMarker1177" class="calibre3"/><span class="kobospan" id="kobo.620.1"> using the administration tools. </span><span class="kobospan" id="kobo.620.2">The proxy is configured to forward requests to each </span><em class="italic"><span class="kobospan" id="kobo.621.1">SportsStore</span></em><span class="kobospan" id="kobo.622.1"> container in turn, and you can see this happening in the console messages, which include the name of the container from which each message originated:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.623.1">...
</span><span class="code-highlight"><strong class="hljs-slc"><span class="kobospan" id="kobo.624.1">sportsstore-1</span></strong></span><span class="kobospan" id="kobo.625.1">  | Executing (default): SELECT "sid", "expires", "data", "createdAt", "updatedAt" FROM "Sessions" AS "Session" WHERE "Session"."sid" = 'eGtcJR_TJhkO3N0gCzXiqsdJWV4exbmU';
</span><strong class="screentext"><span class="kobospan" id="kobo.626.1">sportsstore-1</span></strong><span class="kobospan" id="kobo.627.1">  | Executing (default): UPDATE "Sessions" SET "expires"=$1,"updatedAt"=$2 WHERE "sid" = $3; "2024-03-21 23:56:43.319 +00:00", "2024-03-21 21:56:43.319 +00:00", "eGtcJR_TJhkO3N0gCzXiqsdJWV4exbmU"
</span><strong class="screentext"><span class="kobospan" id="kobo.628.1">sportsstore-5</span></strong><span class="kobospan" id="kobo.629.1">  | Executing (default): SELECT "sid", "expires", "data", "createdAt", "updatedAt" FROM "Sessions" AS "Session" WHERE "Session"."sid" = 'eGtcJR_TJhkO3N0gCzXiqsdJWV4exbmU';
</span><strong class="screentext"><span class="kobospan" id="kobo.630.1">sportsstore-5</span></strong><span class="kobospan" id="kobo.631.1">  | Executing (default): UPDATE "Sessions" SET "expires"=$1,"updatedAt"=$2 WHERE "sid" = $3; "2024-03-21 23:56:43.389 +00:00", "2024-03-21 21:56:43.389 +00:00", "eGtcJR_TJhkO3N0gCzXiqsdJWV4exbmU"
</span><strong class="screentext"><span class="kobospan" id="kobo.632.1">sportsstore-2</span></strong><span class="kobospan" id="kobo.633.1">  | Executing (default): SELECT "sid", "expires", "data", "createdAt", "updatedAt" FROM "Sessions" AS "Session" WHERE "Session"."sid" = 'eGtcJR_TJhkO3N0gCzXiqsdJWV4exbmU';
</span><strong class="screentext"><span class="kobospan" id="kobo.634.1">sportsstore-2</span></strong><span class="kobospan" id="kobo.635.1">  | Executing (default): UPDATE "Sessions" SET "expires"=$1,"updatedAt"=$2 WHERE "sid" = $3; "2024-03-21 23:56:43.436 +00:00", "2024-03-21 21:56:43.437 +00:00", "eGtcJR_TJhkO3N0gCzXiqsdJWV4exbmU"
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.636.1">The configuration of the proxy detects up to five instances of the SportsStore container automatically and stops forwarding requests to containers if they become unavailable. </span><span class="kobospan" id="kobo.636.2">Open a new command prompt and run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.637.1">Listing 21.31</span></em><span class="kobospan" id="kobo.638.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.639.1">sportsstore</span></code><span class="kobospan" id="kobo.640.1"> folder to disable one of the SportsStore containers. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.641.1">Listing 21.31: Changing the number of sportsstore containers</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.642.1">docker-compose scale sportsstore=4
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.643.1">The command displays</span><a id="_idIndexMarker1178" class="calibre3"/><span class="kobospan" id="kobo.644.1"> the containers that are running and stops one of them, like this:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.645.1">...
</span><span class="kobospan" id="kobo.645.2">Running 6/6
Container sportsstore-postgres-1     Running
Container sportsstore-sportsstore-4  Running
Container sportsstore-sportsstore-3  Running
Container sportsstore-sportsstore-1  Running
Container sportsstore-sportsstore-2  Running
Container sportsstore-sportsstore-5  Removed
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.646.1">The proxy detects the change and determines that one of the containers is no longer available, producing a message like this:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.647.1">...
</span><span class="kobospan" id="kobo.647.2">proxy-1        | [WARNING]  (8) : Server app/sportsstore-3 is going DOWN for maintenance (No IP for server ). </span><span class="kobospan" id="kobo.647.3">4 active and 0 backup servers left. </span><span class="kobospan" id="kobo.647.4">0 sessions active, 0 requeued, 0 remaining in queue.
</span><span class="kobospan" id="kobo.647.5">...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.648.1">The names used for the containers don’t always match up with the names used by the Docker DNS service, which is why the container that has been stopped is named </span><code class="inlinecode"><span class="kobospan" id="kobo.649.1">sportsstore-sportsstore-5</span></code><span class="kobospan" id="kobo.650.1">, but the proxy reports that </span><code class="inlinecode"><span class="kobospan" id="kobo.651.1">app/sportsstore-3</span></code><span class="kobospan" id="kobo.652.1"> has stopped.</span></p>
<p class="normal"><span class="kobospan" id="kobo.653.1">Once you are happy that the application is working correctly, run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.654.1">Listing 21.32</span></em><span class="kobospan" id="kobo.655.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.656.1">sportsstore</span></code><span class="kobospan" id="kobo.657.1"> folder to stop all of the containers.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.658.1">Listing 21.32: Stopping the application containers</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.659.1">docker-compose down
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.660.1">Docker will stop all of the containers, updating the status display until all are shown as removed:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.661.1">...
</span><span class="kobospan" id="kobo.661.2">[+] Running 7/7
    Container sportsstore-sportsstore-2  Removed                                                                          
  Container sportsstore-proxy-1        Removed                                                                           
   Container sportsstore-sportsstore-3  Removed                                                                          
    Container sportsstore-sportsstore-1  Removed                                                                          
  Container sportsstore-sportsstore-4  Removed                                                                          
    Container sportsstore-postgres-1     Removed                                                                           
    Network sportsstore_default          Removed                                                                           
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.662.1">The application is containerized and the images</span><a id="_idIndexMarker1179" class="calibre3"/><span class="kobospan" id="kobo.663.1"> are ready to be deployed onto a production platform.</span></p>
<h1 class="heading" id="_idParaDest-372"><span class="kobospan" id="kobo.664.1">Summary</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.665.1">In this chapter, I completed the SportsStore application and prepared it for deployment to a container platform.</span></p>
<ul class="calibre4">
<li class="bulletlist"><span class="kobospan" id="kobo.666.1">The SportsStore image contains Node.js, the code and resources, and all of the JavaScript packages required to run the application.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.667.1">The container platform provides networking features that allow containers to communicate so that the SportsStore application can send requests to the database server using the name given to the Postgres container.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.668.1">The container platform can manage the number of instances of a container, which allows the SportsStore application to scale up to handle a larger number of requests.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.669.1">HTTPS requests are received by a proxy, which locates SportsStore containers using a DNS service provided by the container platform. </span><span class="kobospan" id="kobo.669.2">The proxy detects when a container is down and stops forwarding requests to that container.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.670.1">HTTP requests are redirected to HTTPS by the proxy. </span><span class="kobospan" id="kobo.670.2">The SportsStore containers receive only HTTP requests.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.671.1">Containers can be deployed to a wide range of platforms, including all of the large cloud providers, such as AWS and Azure.</span></li>
</ul>
<p class="normal"><span class="kobospan" id="kobo.672.1">That’s all I have to teach you about using Node.js to create web applications. </span><span class="kobospan" id="kobo.672.2">I can only hope that you have enjoyed reading this book as much as I enjoyed writing it, and I wish you every success in your Node.js projects.</span></p>
</div>
</body></html>