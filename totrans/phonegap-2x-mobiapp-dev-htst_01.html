<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Let's Get Local!</h1></div></div></div><p>There are a lot of languages in the world, and chances are good that you want your app to have the widest possible use and distribution, which means that you will need to provide your app with the ability to be multilingual. This can be a thorny task; a lot goes in to localization, translations, currency formats, date formats, and so on. But thankfully, there are some very smart people out there who have already worked through a lot of the pain involved. Now it's up to us to put that work to good use.</p><div><div><div><div><h1 class="title"><a id="ch01lvl1sec08"/>What do we build?</h1></div></div></div><p>The project <a id="id0" class="indexterm"/>that <a id="id1" class="indexterm"/>we will create is a simple game entitled <em>Quiz Time!</em> The game will essentially ask the player ten random questions in their native language and then tally and present their score when the game is finished. At the end, the app will ask the user if they want to try again as well.</p><p>The app itself will serve to introduce <a id="id2" class="indexterm"/>you to creating mobile apps using a simple framework named <a id="id3" class="indexterm"/>
<strong>YASMF</strong> (<strong>Yet Another Simple Mobile Framework</strong>). There are a multitude of fantastic frameworks out there (jQuery Mobile<a id="id4" class="indexterm"/>, jQuery Touch<a id="id5" class="indexterm"/>, iUI<a id="id6" class="indexterm"/>, Sencha Touch<a id="id7" class="indexterm"/>, and so on.), but the point of this book isn't to show you how to use a particular framework; rather, the point is to show you how to use PhoneGap to do some amazing things. The framework you choose to use ultimately doesn't really matter that much—they all do what they advertise—and our using a custom framework isn't intended to throw you off-kilter in any fashion. The main reason for using this particular custom framework is that it's very lightweight and simple, which means the concepts it uses will be easy to transfer to any framework. For more information regarding the framework, <a id="id8" class="indexterm"/>please visit <a class="ulink" href="https://github.com/photokandyStudios/YASMF/wiki">https://github.com/photokandyStudios/YASMF/wiki</a>.</p><p>The app itself will also serve as a foundation to creating localized apps in the future. Localization is absolutely critical to get right, even in the beginning stages of development, which is why we start with it here, and why we assign it such importance. In essence, this first project is intended to make the rest of your app development career easier.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec17"/>What does it do?</h2></div></div></div><p>As an app, <a id="id9" class="indexterm"/>Quiz Time! is pretty simple. There are only three screens, and only one of them is remotely complex. The game has ten built-in questions that it will randomly ask of the player. If the question is correct, the player is notified, and their score is increased by an arbitrarily large number. This is to show that we correctly handle the display of numbers in the player's locale. If the question is incorrect, we also notify the user, and then decrement their score. If they get enough questions wrong, they'll end up in negative territory, which is another great test for our localization skills.</p><p>Once the game is over, we'll display the score and the date to the player, along with the opportunity to try again. If the player does elect to try again, we'll reset everything and start the game over.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec18"/>Why is it great?</h2></div></div></div><p>You'll be primarily<a id="id10" class="indexterm"/> learning two things: building a simple game in PhoneGap, and localizing that app from the very beginning. A lot of projects forget about localization until near the end of the project, and then the poor developers find out that it is very difficult to shoehorn localization in after most of the project has already been developed. For example, the space assigned to some text might turn out to be too small for certain languages, or the images used as buttons or other widgets might not be large enough to hold the localized text. The app itself might crash in a certain language because it didn't expect to receive any non-English characters. By implementing localization at the start of your app development, you'll be saving yourself a lot of effort down the road, even if the first release of your app is only localized to one locale.</p><div><div><h3 class="title"><a id="note02"/>Note</h3><p>You'll often see the word <code class="literal">Cordova</code> in our code examples in this book. PhoneGap was recently acquired by Adobe and the underlying code was given to the Apache Incubator project. This project is named <code class="literal">Cordova</code>, and PhoneGap utilizes it to provide its various services. So if you see <code class="literal">Cordova</code>, it really means the same thing for now.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec19"/>How are we going to do it?</h2></div></div></div><p>We're going to follow the <a id="id11" class="indexterm"/>typical development cycle: design, implement, and test the app. Our design phase won't just include the user interface, but also the data model, that is, how our questions are stored and retrieved. The implementation will focus on our three stages of the app: the <em>start</em> view, the <em>game</em> view, and the <em>end</em> view. After implementation, we'll test the app not only to make sure it properly handles localization but also to make sure that the game works correctly.</p><p>Here's the general outline:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Designing the app, UI/interactions</li><li class="listitem" style="list-style-type: disc">Designing the data model</li><li class="listitem" style="list-style-type: disc">Implementing the data model</li><li class="listitem" style="list-style-type: disc">Implementing the start view</li><li class="listitem" style="list-style-type: disc">Implementing the game view</li><li class="listitem" style="list-style-type: disc">Implementing the end view</li><li class="listitem" style="list-style-type: disc">Putting it all together</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec20"/>What do I need to get started?</h2></div></div></div><a id="id12" class="indexterm"/><p>First, be sure to download the latest version of PhoneGap from <a class="ulink" href="http://phonegap.com/download">http://phonegap.com/download</a>, currently 2.2.0<a id="id13" class="indexterm"/> (as this was being written), and extract it to the appropriate directory. (For example, I use <code class="literal">/Applications/phonegap/phonegap220</code>.) Make sure that you have also installed the appropriate IDEs (Xcode for iOS development<a id="id14" class="indexterm"/> and Eclipse for Android development<a id="id15" class="indexterm"/>).</p><p>Next, download the latest version of the<a id="id16" class="indexterm"/> YASMF framework from <a class="ulink" href="https://github.com/photokandyStudios/YASMF/downloads">https://github.com/photokandyStudios/YASMF/downloads</a>, and extract it anywhere. (For example, I used my <code class="literal">Downloads</code> folder.) </p><p>If you want a copy of the projects for this book in order to look at, or to avoid the following project-creation steps, you can download them at <a class="ulink" href="https://github.com/photokandyStudios/phonegap-hotshot">https://github.com/photokandyStudios/phonegap-hotshot</a>.</p><p>Next, you need to create a project for the various platforms you intend to support. Here's how we create both projects at once on Mac OS X. The commands should translate to Linux and Android-only projects with a little modification<a id="id17" class="indexterm"/>, and the same should apply to creating Android projects on Windows with some additional modification. For the following steps, consider <code class="literal">$PROJECT_HOME</code> to be the location of your project, <code class="literal">$PHONEGAP_HOME</code> to be the location where you installed PhoneGap, and <code class="literal">$YASMF_DOWNLOAD</code> to be the location where you extracted the YASMF framework.</p><div><div><h3 class="title"><a id="note03"/>Note</h3><p>The following steps are just the steps that I use when setting up a project. You can, of course, structure it however you would like, but you'll need to make any modifications with regards to the file references and the likes on your own.</p></div></div><p>The following steps assume that you have downloaded PhoneGap (Cordova) 2.2.0<a id="id18" class="indexterm"/>. If you download a more recent version, the following steps <em>should</em> work with minimal modification:</p><div><div><h3 class="title"><a id="tip02"/>Tip</h3><p>
<strong>Downloading the example code</strong>
</p><p>You can download the example code files for all Packt books you have purchased from your account at <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a>. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p></div></div><div><ol class="orderedlist arabic"><li class="listitem">Use the following code snippet<a id="id19" class="indexterm"/>:<div><pre class="programlisting">mkdir $PROJECT_HOME
cd $PROJECT_HOME
mkdir Android iOS www
cd $PHONEGAP_HOME/lib/android/bin
./create $PROJECT_HOME/Android/QuizTime com.phonegaphotshot.QuizTime QuizTime
cd $PHONEGAP_HOME/lib/ios/bin
./create $PROJECT_HOME/iOS com.phonegaphotshot.QuizTime QuizTime
cd $PROJECT_HOME
mkdir www/cordova
cp Android/QuizTime/assets/www/cordova-2.2.0.js www/cordova/cordova-2.2.0-android.js
cp iOS/www/cordova-2.2.0.js www/cordova/cordova-2.2.0-ios.js
cd Android/QuizTime/assets
rm –rf www
ln –s ../../../www
cd ../../../iOS
rm –rf www
ln  -s ../www
cd ..
cd www
cp –r $YASMF_DOWNLOAD/framework .
mkdir images models views style
cd ..
cd Android/QuizTime/src/com/phonegaphotshot/QuizTime
edit QuizTime.java
Change "index.html" to "index_android.html"
Save the file.
cd $PROJECT_HOME/iOS/QuizTime</pre></div></li><li class="listitem">Edit <code class="literal">Cordova.plist</code>.</li><li class="listitem">Search for <code class="literal">UIWebViewBounce</code>.</li><li class="listitem">Change the <code class="literal">&lt;true/&gt;</code> tag just below it to <code class="literal">&lt;false/&gt;</code>.</li><li class="listitem">Search for <code class="literal">ShowSplashScreenSpinner</code>.</li><li class="listitem">Change the <code class="literal">&lt;true/&gt;</code> tag just below it to <code class="literal">&lt;false/&gt;</code>.</li><li class="listitem">Search for <code class="literal">ExternalHosts</code>.</li><li class="listitem">Remove the <code class="literal">&lt;array/&gt;</code> line and replace it with "<code class="literal">&lt;array&gt;</code>", "<code class="literal">&lt;string&gt;*&lt;/string&gt;</code>" and "<code class="literal">&lt;/array&gt;</code>". This isn't always something you'd want to do for a production app, but as it allows for our apps to access the Internet with no restrictions, it's good for testing purposes.</li><li class="listitem">Save the file.</li><li class="listitem">Start Eclipse.</li><li class="listitem"><strong>Navigate to File</strong> | <strong>New</strong> | <strong>Project…</strong>.</li><li class="listitem">Select <strong>Android Project</strong>.</li><li class="listitem">Click on <strong>Next</strong> <strong>&gt;</strong>.</li><li class="listitem">Select the <strong>Create project from existing source</strong> option.</li><li class="listitem">Click on <strong>Browse</strong>.</li><li class="listitem">Navigate to <code class="literal">$PROJECT_HOME/Android/QuizTime/</code>.</li><li class="listitem">Click on <strong>Open</strong>.</li><li class="listitem">Click on <strong>Next</strong> <strong>&gt;</strong>.</li><li class="listitem">Uncheck and re-check the highest <strong>Google APIs</strong> entry. (For some reason, Eclipse doesn't always keep the correct SDK version when doing this, so you may have to go back after the project is created and reset it. Just right-click any directory, <strong>Configure Build Paths…</strong> and go to the <strong>Android</strong> section. Then you can re-select the highest SDK.)</li><li class="listitem">Click on <strong>Next</strong> <strong>&gt;</strong>.</li><li class="listitem">Change the <strong>Minimum SDK</strong> value to 8.</li><li class="listitem">Click on <strong>Finish</strong>.</li><li class="listitem">Start Xcode.</li><li class="listitem">Navigate to<strong> File</strong> | <strong>Open…</strong>.</li><li class="listitem">Navigate to the project in <code class="literal">$PROJECT_HOME/iOS</code>.</li><li class="listitem">Click on <strong>Open</strong>.</li><li class="listitem">At this point you should have Xcode and Eclipse open with the project. Close both; we'll be using our favorite editor for now.</li></ol></div><p>When the project is created, the following directory structure results:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/Android: The Android project</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/iOS: The iOS project</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">/www</code><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/cordova</code>: We'll place the PhoneGap support libraries here.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/framework</code>: Our framework will be in this directory.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/cultures</code>: Any localization configuration will be placed here. The framework comes with <code class="literal">en-US</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/images</code>: All of our images will be in this directory.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/views</code>: All of our views will be here.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/models</code>: All of our data models will be here.</li><li class="listitem" style="list-style-type: disc"><code class="literal">/style</code>: Any custom CSS we need to use will live here.</li></ul></div></li></ul></div><p>Once you've created the project, you also need to download the jQuery/Globalize repository<a id="id20" class="indexterm"/> from <a class="ulink" href="https://github.com/jquery/globalize">https://github.com/jquery/globalize</a>. There's a lot of content there, but we're most interested in the <code class="literal">lib</code> directory. Copy the <code class="literal">globalize.culture.en-US.js</code> and <code class="literal">globalize.culture.es-ES.js</code> files to the <code class="literal">www/framework/cultures</code> directory. (If you want, feel free to copy other culture files as well, if you want to try your hand at localizing in a language you know.)</p><div><div><h3 class="title"><a id="note04"/>Note</h3><p>If you are using Eclipse, you must make absolutely certain that all the files you use in the <code class="literal">www</code> directory are set to the proper encoding. The easiest way to do this is to right-click on the <code class="literal">assets</code> directory, click on <code class="literal">Properties</code>, and then click on <code class="literal">Other</code>. Select the <code class="literal">UTF-8</code> option from the drop-down list and click on <code class="literal">Apply</code>. If you don't do this, it is entirely possible that some of your localized content will not be displayed correctly.</p></div></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Designing the app – UI/interactions</h1></div></div></div><p>In this first <a id="id21" class="indexterm"/>task we'll be <a id="id22" class="indexterm"/>designing the look and feel of the application as well as specifying the interactions between the various elements in the user interface and the player. For most of this task you can use pencil and paper or a graphics editor, though at some point you'll need a graphics editor such as Adobe Photoshop or GIMP in order to create some of the resources you'll need for the app.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec21"/>Getting on with it</h2></div></div></div><p>The difficulty when it comes to designing an app that can run on more than one platform is that each platform has many different ideas when it comes to how things should look on the screen. There are several ways to approach this; they are discussed as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You can build the user interface for the majority of your market, and use the exact interface on all the other devices (but be careful; this will often lead to poor reviews).</li><li class="listitem" style="list-style-type: disc">You could decide to customize the app's user interface for each device. This often requires a significant amount of work to accomplish and get it <em>just right</em>, but it can be very rewarding, especially when the end user has no idea the app wasn't written just for their own platform.</li><li class="listitem" style="list-style-type: disc">Or you could create a platform-agnostic look and feel. This is the direction we'll take in this app. The interface would be reasonably at home on iOS and Android devices. That's not to say that the appearance will be identical on both devices; it won't, but it will be similar while incorporating some of the platform-specific notions as well.</li></ul></div><p>Before we go too much further, we need to get out our pencil and paper and sketch out an idea of how we want our app to look. It should be similar to the following screenshot:</p><div><img src="img/9403OS_01_01.jpg" alt="Getting on with it"/></div><p>Our start view is a fairly simple view. At the top of the view we will have a navigation bar containing our <a id="id23" class="indexterm"/>app's title. <a id="id24" class="indexterm"/>In other views, this bar would often have other buttons in it, including one to go back to the previous view. At the bottom of the view, we will have a toolbar which will contain buttons relevant to the current view.</p><p>The app's title will be an image containing the title of the application. This image should be made using a font that's fun and stylistic. The image will be appropriately localized.</p><p>We'll have one button in the toolbar: a <strong>Start</strong> button. The text needs to be localized.</p><p>Below the navigation bar is the content area. Here we describe what the app will do. We won't have anything terribly fancy here; our space is limited, especially since we are restricted to the phone's screen size. In the future, we'll talk about how to allow content to scroll, but for now we'll keep it short and simple.</p><p>We do want to add a little bit of pizazz to the view, so we'll add a color splash to the background. You could make this anything you want, we'll go with rays of color shooting up from the bottom.</p><p>Our game view looks like the following screenshot:</p><div><img src="img/9403OS_01_02.jpg" alt="Getting on with it"/></div><p>Our game view is the most complex view we have in this app. Let's start outward and work in.</p><p>At the top, our <a id="id25" class="indexterm"/>navigation bar will indicate the current <a id="id26" class="indexterm"/>question number. This lets the player know how many questions they've answered. To the left of the text is a <strong>Back</strong> button. If clicked, it should take the player back to the start view.</p><p>At the bottom, our toolbar contains a single button: <strong>Skip</strong>. This button will allow the player to skip any question they don't want to answer. For now, we won't assign any penalty to skipping a question, but you could always add a score deduction or something worse if you wanted to do so. If you removed the button entirely, it would be wise to remove the toolbar as well.</p><p>In the middle is our content area, the most complex portion of the view; at the top we have the player's score, which needs to be localized. Below it is the question being asked, again, properly localized.</p><p>Below the <a id="id27" class="indexterm"/>question, we have several buttons;<a id="id28" class="indexterm"/> these need to be generated dynamically based on the question being asked. Not every question will have three answers; there may be some with two answers or some with four or more. The answers themselves also need to be properly localized.</p><p>Tapping a button will check to see if the button is labeled with the correct answer. If it is, we'll display a nice notice and increment the score. If it isn't, we'll indicate such and decrement the score.</p><p>After a question is answered or skipped, we'll get a new question and display it on the screen. Then, after ten questions have been answered, we'll end the game. The end view looks like the following screenshot:</p><div><img src="img/9403OS_01_03.jpg" alt="Getting on with it"/></div><p>The end view is similar to the start view in that it isn't terribly complex, but it does have a little more going on. It needs to properly display the final score and permit the player to play the game again.</p><p>The navigation bar contains the text <strong>Results</strong> and also a <strong>Back</strong> button. If tapped, it is the same thing as starting the game all over again.</p><p>The toolbar contains the <strong>Try</strong> <strong>Again?</strong> button. If tapped, it also starts the game again.</p><p>In the<a id="id29" class="indexterm"/> content area, we display a message containing the final score, and the date when it was achieved.</p><p>Of course,<a id="id30" class="indexterm"/> all of the content on the view needs to be properly localized. Numbers are hard enough; dates are even worse. It's a good thing that we have jQuery/Globalize to fall back on, or we'd have to do the hard work of localizing the date ourselves.</p><p>Now that we've sketched the user interface, it's time to start building some of the resources we'll need in our app. Open up your graphics editor and build a template of what any one of the views would look like. What we're doing here is determining what parts of the display will need to have images generated, and what parts will be able to be text or CSS-generated.</p><p>It's not super critical that you have the exact dimensions of any specific device. After all, the app can run on many different devices, each of which has a different screen size. We'll use 640 x 920 px, which just happens to be the available area on the screen for an iPhone 4 with a Retina display.</p><div><div><h3 class="title"><a id="note05"/>Note</h3><p>You do need to design using a high-enough resolution to get Retina-quality assets out of the design. That is, if you expect an icon to be 32 x 32 px, you will actually want it to be 64 x 64 px. Now whether you build on an exact size is up to you, but it's best to target the device you think will get the most use.</p></div></div><p>Here's the final template we're using:</p><div><img src="img/9403_01_04.jpg" alt="Getting on with it"/></div><p>There's a little bit of a texture there. While it's possible to do this in CSS, it's easiest to use images instead. The texture itself is tile-able and so it can adapt to any screen size. The navigation bar should be placed in the <code class="literal">images</code> directory and named <code class="literal">NavigationBar.png</code>.</p><p>Notice the title? <a id="id31" class="indexterm"/>While this could also be handled by CSS and adding the <a id="id32" class="indexterm"/>font to your app, that gets into a lot of sticky licensing issues. Instead, we'll use an image of it, which means the font itself will never get distributed. The title should be placed in the <code class="literal">images</code> directory and named <code class="literal">AppTitle-enus.png</code>. The Spanish version (which should read <em>¡Examen Tiempo!</em>) should be named <code class="literal">AppTitle-eses.png</code>.</p><p>The background will also be an image, though you could likely approximate it with CSS (though getting the texture there would be a bit painful). Since we're supporting many platforms and screen sizes, the image approach is the best. This image should be saved in the <code class="literal">images</code> directory and named <code class="literal">Background.jpg</code>.</p><p>We'll build the app so that the image stretches to fill the screen. There will be some minor distortion, of course, but since this image is just a color splash, it doesn't really matter. (Other options include creating the background at various resolutions, or to create a tile-able background that fills easily to any resolution.)</p><p>The button, on <a id="id33" class="indexterm"/>the other hand, is easy to build in CSS, and it's easy enough to get right on many platforms. In the worst case, the button won't be quite as shiny or rounded, but it'll still convey that it should be touched.</p><p>The middle area is <a id="id34" class="indexterm"/>where everything else will go, the player's score, the current question, the answers to the question, and so on. Since all of that is easily achievable with HTML, CSS, and JavaScript, we're not going to worry about putting those elements into the template.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec22"/>What did we do?</h2></div></div></div><p>In this task we designed our user interface and also spelled out the interaction between the various views and widgets. We indicated what parts we knew would need to be localized (everything!) and then drew up a pretty version of it in our favorite graphics editor. From this version we can splice the various elements that need to be saved as images while also identifying what portions can be rendered with HTML, CSS, and JavaScript.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec10"/>Designing the data model</h1></div></div></div><p>The data model is <a id="id35" class="indexterm"/>very important to get right: this is how we'll <a id="id36" class="indexterm"/>store our questions, the answers to those questions, and which answer is the correct answer for each of the questions. We'll also define how we should interact with the model, that is, how do we get a question, ask it if the answer is correct, and so forth.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec23"/>Getting ready</h2></div></div></div><p>Let's get out our pencil and paper again, or if you'd prefer, a diagramming tool that you're comfortable with. What we're really trying to do in this step is to come up with the properties the model needs in order to store the questions, and the interactions it will need in order to properly do everything we're asking of it.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec24"/>Getting on with it</h2></div></div></div><p>We'll essentially have two data models: a single question, and a collection of questions. Let's start with <a id="id37" class="indexterm"/>what the question model<a id="id38" class="indexterm"/> should do:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Store the actual question</li><li class="listitem" style="list-style-type: disc">Have a list of all the possible answers</li><li class="listitem" style="list-style-type: disc">Know the correct answer</li><li class="listitem" style="list-style-type: disc">Set the question when created</li><li class="listitem" style="list-style-type: disc">Return the question when asked</li><li class="listitem" style="list-style-type: disc">Add an answer to its list of answers</li><li class="listitem" style="list-style-type: disc">Return the list of answers when asked (in a random order)</li><li class="listitem" style="list-style-type: disc">Set the correct answer</li><li class="listitem" style="list-style-type: disc">Give the correct answer when asked</li><li class="listitem" style="list-style-type: disc">Return a specific answer in the list when asked</li><li class="listitem" style="list-style-type: disc">Check if a given answer is correct</li><li class="listitem" style="list-style-type: disc">Return the number of answers</li></ul></div><p>We can indicate this by creating a simple diagram as follows:</p><div><img src="img/9403OS_01_05.jpg" alt="Getting on with it"/></div><p>Our collection<a id="id39" class="indexterm"/> of questions<a id="id40" class="indexterm"/> should:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Have a list of all the questions</li><li class="listitem" style="list-style-type: disc">Be able to add a question to that list</li><li class="listitem" style="list-style-type: disc">Return the total number of questions in the list</li><li class="listitem" style="list-style-type: disc">Return a random question from the list</li></ul></div><p>The diagram covering these points would look like the following screenshot:</p><div><img src="img/9403OS_01_06.jpg" alt="Getting on with it"/></div><p>Having both of the models defined, let's come up with the questions we're going to ask, as well as the answers that will go along with them (for the full list of questions, see <code class="literal">chapter1/www/models/quizQuestions.js</code> in the download for this book):</p><div><table border="1"><colgroup><col width="1.92335464015152" style="text-align: left"/><col width="3.54498106060606" style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>#</p>
</th><th style="text-align: left" valign="bottom">
<p>English</p>
</th><th style="text-align: left" valign="bottom">
<p>Spanish</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">1</code>
</p>
</td><td style="text-align: left" valign="top">
<p>What is the color of the Sun?</p>
</td><td style="text-align: left" valign="top">
<p>¿Cuál es el color del Sol?</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>Green
</p>
</td><td style="text-align: left" valign="top">
<p>Verde</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>White
</p>
</td><td style="text-align: left" valign="top">
<p>Blanco</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>Yellow (correct)
</p>
</td><td style="text-align: left" valign="top">
<p>Amarillo (correct)</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">2</code>
</p>
</td><td style="text-align: left" valign="top">
<p>What is the name of the fourth planet?</p>
</td><td style="text-align: left" valign="top">
<p>¿Cuál es el nombre del cuarto planeta?</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>Mars (correct)
</p>
</td><td style="text-align: left" valign="top">
<p>Marzo (correct)</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>Venus
</p>
</td><td style="text-align: left" valign="top">
<p>Venus</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>Mercury
</p>
</td><td style="text-align: left" valign="top">
<p>Mercurio</p>
</td></tr></tbody></table></div><p>With the design of our model complete, and the questions we're going to ask, this task is complete.<a id="id41" class="indexterm"/> Next we'll write the code to implement the model.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl2sec25"/>What did we do?</h1></div></div></div><p>In this task we designed two data models: a single question and a collection of questions. We also determined the questions we were going to ask, along with their localized variants.</p></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec14"/>Implementing the data model</h1></div></div></div><p>We'll be creating<a id="id42" class="indexterm"/> two JavaScript files in the <code class="literal">www/models</code> directory named <code class="literal">quizQuestion.js</code> and <code class="literal">quizQuestions.js</code>. The file <code class="literal">quizQuestion.js</code> will <a id="id43" class="indexterm"/>be the actual model: it will specify how the data should be formatted and how we can interact with it. <code class="literal">quizQuestions.js</code> will contain our actual question data.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec26"/>Getting on with it</h2></div></div></div><p>Before we define our model, let's define a namespace where it will live. This is an important habit to establish since it relieves us of having to worry about whether or not we'll collide with another function, object, or variable of the same name.</p><p>While there are various methods used to create a namespace, we're going to do it simply using the following code snippet:</p><div><pre class="programlisting">// quizQuestion.js

var QQ = QQ || {};</pre></div><p>Now that our namespace is defined, we can create our <code class="literal">question</code> object as follows:</p><div><pre class="programlisting">QQ.Question = function ( theQuestion )
{
    var self = this;</pre></div><div><div><h3 class="title"><a id="note06"/>Note</h3><p>Note the use of <code class="literal">self</code>: this will allow us to refer to the object using <code class="literal">self</code> rather than using <code class="literal">this</code>. (Javascript's <code class="literal">this</code> is a bit nuts, so it's always better to refer to a variable that we know will always refer to the object.)</p></div></div><p>Next, we'll set up <a id="id44" class="indexterm"/>the <a id="id45" class="indexterm"/>properties based on the diagram we created from step two using the following code snippet:</p><div><pre class="programlisting">    self.question = theQuestion;
    self.answers = Array();
    self.correctAnswer = -1;</pre></div><p>We've set the <code class="literal">self.correctAnswer</code> value to <code class="literal">-1</code> to indicate that, at the moment, any answer provided by the player is considered correct. This means you can ask questions where all of the answers are right.</p><p>Our next step is to define the methods or interactions the object will have. Let's start with determining if an answer is correct. In the following code, we will take an incoming answer and compare it to the <code class="literal">self.correctAnswer</code> value. If it matches, or if the <code class="literal">self.correctAnswer</code> value is <code class="literal">-1</code>, we'll indicate that the answer is correct:</p><div><pre class="programlisting">    self.testAnswer = function( theAnswerGiven )
    {
        if ((theAnswerGiven == self.correctAnswer) 
            || (self.correctAnswer == -1))
        {
            return true;
        }    
        else
        {
            return false;
        }
    }</pre></div><p>We're going to need a way to access a specific answer, so we'll define the <code class="literal">answerAtIndex</code> function<a id="id46" class="indexterm"/> as follows:</p><div><pre class="programlisting">    self.answerAtIndex = function ( theIndex )
    {
        return self.answers[ theIndex ];
    }</pre></div><p>To be a well-defined model, we should always have a way of determining the number of items in the model as shown in the following code snippet:</p><div><pre class="programlisting">    self.answerCount = function ()
    {
        return self.answers.length;
    }</pre></div><p>Next, we need to<a id="id47" class="indexterm"/> define a method that allows an answer to be added to our object. Note that with the help of the return value, we return ourselves to permitting daisy-chaining in our code:</p><div><pre class="programlisting">    self.addAnswer = function( theAnswer )
    {
        self.answers.push ( theAnswer );
        return self;
    }</pre></div><p>In theory we could display the answers to a question in the order they were given to the object. In practice, that would turn out to be a pretty boring game: the answers would always be in the same order, and chances would be pretty good that the first answer would be the correct answer. So let's give ourselves a randomized list using the following code snippet:</p><div><pre class="programlisting">    self.getRandomizedAnswers = function ()
    {
        var randomizedArray = Array();
        var theRandomNumber;
        var theNumberExists;
        
        // go through each item in the answers array
        for (var i=0; i&lt;self.answers.length; i++)
        {
        
            // always do this at least once
            do 
            {
                // generate a random number less than the 
                // count of answers
                theRandomNumber = Math.floor ( Math.random() * 
                                  self.answers.length );
                theNumberExists = false;
                
                // check to see if it is already in the array
                for (var j=0; j&lt;randomizedArray.length; j++)
                {
                    if (randomizedArray[j] == theRandomNumber)
                    {
                        theNumberExists = true;
                    }
                }
                
                // If it exists, we repeat the loop.
            } while ( theNumberExists );
            
            // We have a random number that is unique in the   
            // array; add it to it.
            randomizedArray.push ( theRandomNumber );
        }
        
        return randomizedArray;
    }</pre></div><p>The randomized<a id="id48" class="indexterm"/> list is just an array of numbers that indexes into the <code class="literal">answers[]</code> array. To get the actual answer, we'll have to use the <code class="literal">answerAtIndex()</code> method<a id="id49" class="indexterm"/>.</p><p>Our model still needs a way to set the correct answer. Again, notice the return value in the following code snippet permitting us to daisy-chain later on:</p><div><pre class="programlisting">    self.setCorrectAnswer = function ( theIndex )
    {
        self.correctAnswer = theIndex;
        return self;
    }</pre></div><p>Now that we've properly set the correct answer, what if we need to ask the object what the correct answer is? For this let's define a <code class="literal">getCorrectAnswer</code> function<a id="id50" class="indexterm"/> using the following code snippet:</p><div><pre class="programlisting">    self.getCorrectAnswer = function ()
    {
        return self.correctAnswer;
    }</pre></div><p>Of course, our object also needs to return the question given to it whenever it was created; this can be done using the following code snippet:</p><div><pre class="programlisting">    self.getQuestion = function()
    {
        return self.question;
    }
}</pre></div><p>That's it for the <code class="literal">question</code> object. Next we'll create the container that will hold all of our questions using the following code line:</p><div><pre class="programlisting">QQ.questions = Array();</pre></div><p>We could go the regular object-oriented approach and make the container an object as well, but in this game we have only one list of questions, so it's easier to do it this way.</p><p>Next, we need to have the ability to add a question to the container, this can be done using the following code snippet:</p><div><pre class="programlisting">QQ.addQuestion = function (theQuestion)
{
    QQ.questions.push ( theQuestion );
}</pre></div><p>Like any good data model,<a id="id51" class="indexterm"/> we need to know how many questions we have; we can know this using the following code snippet:</p><div><pre class="programlisting">QQ.count = function ()
{
    return QQ.questions.length;
}</pre></div><p>Finally, we need to be able to get a random question out of the list so that we can show it to the player; this can be done using the following code snippet:</p><div><pre class="programlisting">QQ.getRandomQuestion = function ()
{
    var theQuestion = Math.floor (Math.random() * QQ.count());
    return QQ.questions[theQuestion];
}</pre></div><p>Our data model is officially complete. Let's define some questions using the following code snippet:</p><div><pre class="programlisting">// quizQuestions.js
//
// QUESTION 1
//
QQ.addQuestion ( new QQ.Question ( "WHAT_IS_THE_COLOR_OF_THE_SUN?" )
                       .addAnswer( "YELLOW" )
                       .addAnswer( "WHITE" )
                       .addAnswer( "GREEN" )
                       .setCorrectAnswer ( 0 ) );</pre></div><p>Notice how we attach the <code class="literal">addAnswer</code>
<a id="id52" class="indexterm"/> and <code class="literal">setCorrectAnswer</code> methods<a id="id53" class="indexterm"/> to the new question object. This is what is meant by daisy-chaining: it helps us write just a little bit less code.</p><p>You may be wondering why we're using upper-case text for the questions and answers. This is due to how we'll localize the text, which is next:</p><div><pre class="programlisting">PKLOC.addTranslation ( "en", "WHAT_IS_THE_COLOR_OF_THE_SUN?", "What is the color of the Sun?" );
PKLOC.addTranslation ( "en", "YELLOW", "Yellow" );
PKLOC.addTranslation ( "en", "WHITE",  "White" );
PKLOC.addTranslation ( "en", "GREEN",  "Green" );

PKLOC.addTranslation ( "es", "WHAT_IS_THE_COLOR_OF_THE_SUN?", "¿Cuál es el color del Sol?" );
PKLOC.addTranslation ( "es", "YELLOW", "Amarillo" );
PKLOC.addTranslation ( "es", "WHITE",  "Blanco" );
PKLOC.addTranslation ( "es", "GREEN",  "Verde" );                        </pre></div><p>The questions and answers themselves serve as keys to the actual translation. This serves two purposes: <a id="id54" class="indexterm"/>it makes the keys obvious in our code, so we know that the text will be replaced later on, and should we forget to include a translation for one of the keys, it'll show up in uppercase letters.</p><p>
<code class="literal">PKLOC</code> as used in the earlier code snippet is the namespace we're using for our localization library. It's defined in <code class="literal">www/framework/localization.js</code>. The <code class="literal">addTranslation</code> method<a id="id55" class="indexterm"/> is a method that adds a translation to a specific locale. The first parameter is the locale for which we're defining the translation, the second parameter is the key, and the third parameter is the translated text.</p><p>The <code class="literal">PKLOC.addTranslation</code> function<a id="id56" class="indexterm"/> looks like the following code snippet:</p><div><pre class="programlisting">PKLOC.addTranslation = function (locale, key, value)
{
  if (PKLOC.localizedText[locale])
  {
    PKLOC.localizedText[locale][key] = value;
  }
  else
  {
    PKLOC.localizedText[locale] = {};
    PKLOC.localizedText[locale][key] = value;
  }
}</pre></div><p>The <code class="literal">addTranslation</code> method first checks to see if an array is defined under the <code class="literal">PKLOC.localizedText</code> array for the desired locale. If it is there, it just adds the key/value pair. If it isn't, it creates the array first and then adds the key/value pair. You may be wondering how the <code class="literal">PKLOC.localizedText</code> array<a id="id57" class="indexterm"/> gets defined in the first place. The answer is that it is defined when the script is loaded, a little higher in the file:</p><div><pre class="programlisting">PKLOC.localizedText = {};</pre></div><p>Continue adding questions in this fashion until you've created all the questions you want. The <code class="literal">quizQuestions.js</code> file contains ten questions. You could, of course, add as many as you want.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec27"/>What did we do?</h2></div></div></div><p>In this task, we created our data model and created some data for the model. We also showed how translations are added to each locale.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec28"/>What else do I need to know?</h2></div></div></div><p>Before we move on to the next task, let's cover a little more of the localization library we'll be using. Our localization efforts<a id="id58" class="indexterm"/> are split into two parts: translation and data formatting<a id="id59" class="indexterm"/>.</p><p>For the translation effort<a id="id60" class="indexterm"/>, we're using our own simple translation framework, literally just an array of keys and values based on locale. Whenever code asks for the translation for a key, we'll look it up in the array and return whatever translation we find, if any. But first, we need to determine the actual locale of the player, using the following code snippet:</p><div><pre class="programlisting">// www/framework/localization.js

PKLOC.currentUserLocale = "";

PKLOC.getUserLocale = function()
{</pre></div><p>Determining the locale isn't hard, but neither is it as easy as you would initially think. There is a property (<code class="literal">navigator.language</code>) under WebKit browsers that is technically supposed to return the locale, but it has a bug under Android, so we have to use the <code class="literal">userAgent</code>. For WP7, we have to use one of three properties to determine the value.</p><p>Because that takes some work, we'll check to see if we've defined it before; if we have, we'll return that value instead:</p><div><pre class="programlisting">  if (PKLOC.currentUserLocale)
  {
    return PKLOC.currentUserLocale;
  }</pre></div><p>Next, we determine the current device we're<a id="id61" class="indexterm"/> on by using the <code class="literal">device</code> object provided by Cordova. We'll check for it first, and if it doesn't exist, we'll assume we can access it using one of the four properties attached to the <code class="literal">navigator</code> object using the following code snippet:</p><div><pre class="programlisting">  var currentPlatform = "unknown";
  if (typeof device != 'undefined')
  {
    currentPlatform = device.platform;
  }</pre></div><p>We'll also<a id="id62" class="indexterm"/> provide a suitable default locale if we can't determine the user's locale at all as seen in the following code snippet:</p><div><pre class="programlisting">  var userLocale = "en-US";</pre></div><p>Next, we handle parsing the user agent if we're on an Android platform. The following code is heavily inspired by an answer given online at <a class="ulink" href="http://stackoverflow.com/a/7728507/741043">http://stackoverflow.com/a/7728507/741043</a>.</p><div><pre class="programlisting">  if (currentPlatform == "Android")
  {
    var userAgent = navigator.userAgent;

    var tempLocale = userAgent.match(/Android.*([a-zA-Z]{2}-[a-zA-Z]{2})/);
    if (tempLocale)
    {
        userLocale = tempLocale[1];
    }
  }</pre></div><p>If we're on any other platform, we'll use the <code class="literal">navigator</code> object to retrieve the locale as follows:</p><div><pre class="programlisting">  else
  {
    userLocale = navigator.language ||
                 navigator.browserLanguage ||
                 navigator.systemLanguage ||
                 navigator.userLanguage;
}</pre></div><p>Once we have the locale, we return it as follows:</p><div><pre class="programlisting">  PKLOC.currentUserLocale = userLocale;
  return PKLOC.currentUserLocale;
}</pre></div><p>This method is called over and over by all of our translation codes, which means it needs to be efficient. This is why we've defined the <code class="literal">PKLOC.currentUserLocale</code> property. Once it is set, the preceding<a id="id63" class="indexterm"/> code won't try to calculate it out again. This also introduces another benefit: we can easily test our translation code by overwriting this property. While it is always important to test that the code properly localizes when the device is set to a specific language and region, it often takes considerable time to switch between these settings. Having the ability to set the specific locale helps us save time in the initial testing by bypassing the time it takes to switch device settings. It also permits us to focus on a specific locale, especially when testing.</p><p>Translation of text is <a id="id64" class="indexterm"/>accomplished by a convenience function named <code class="literal">__T()</code>. The convenience functions are going to be our only functions outside of any specific namespace simply because we are aiming for easy-to-type and easy-to-remember names that aren't arduous to add to our code. This is especially important since they'll wrap every string, number, date, or percentage in our code.</p><p>The <code class="literal">__T()</code> function depends on two functions: <code class="literal">substituteVariables</code>
<a id="id65" class="indexterm"/> and <code class="literal">lookupTranslation</code>. The<a id="id66" class="indexterm"/> first function is defined as follows:</p><div><pre class="programlisting">PKLOC.substituteVariables = function ( theString, theParms )
{
  var currentValue = theString;

  // handle replacement variables
  if (theParms)
  {
    for (var i=1; i&lt;=theParms.length; i++)
    {
      currentValue = currentValue.replace("%" + i, theParms[i-1]);
    }
  }
  
  return currentValue;
}</pre></div><p>All this function does is handle the substitution variables. This means we can define a translation with <code class="literal">%1</code> in the text and we will be able to replace <code class="literal">%1</code> with some value passed into the function.</p><p>The next function, <code class="literal">lookupTranslation</code>, is defined as follows:</p><div><pre class="programlisting">PKLOC.lookupTranslation = function ( key, theLocale )
{
  var userLocale = theLocale || PKLOC.getUserLocale();
  
  if ( PKLOC.localizedText[userLocale] )
  {
    if ( PKLOC.localizedText[userLocale][key.toUpperCase()] )
    {
       return PKLOC.localizedText[userLocale][key.toUpperCase()];
    }
  }
  
  return null;
}</pre></div><p>Essentially, we're checking to see if a specific translation exists for the given key and locale. If it does,<a id="id67" class="indexterm"/> we'll return the translation, but if it doesn't, we'll return <code class="literal">null</code>. Note that the key is always converted to uppercase, so case doesn't matter when looking up a translation.</p><p>Our <code class="literal">__T()</code> function looks as follows:</p><div><pre class="programlisting">function __T(key, parms, locale)
{
  var userLocale = locale || PKLOC.getUserLocale();
  var currentValue = "";</pre></div><p>First, we determine if the translation requested can be found in the locale, whatever that may be. Note that it can be passed in, therefore overriding the current locale. This can be done using the following code snippet:</p><div><pre class="programlisting">  if (! (currentValue=PKLOC.lookupTranslation(key,  
                                       userLocale)) )
  {</pre></div><p>Locales are often of the form <code class="literal">xx-YY</code>, where <code class="literal">xx</code> is a two-character language code and <code class="literal">YY</code> is a two-character character code. My locale is defined as <code class="literal">en-US</code>. Another player's might be defined as <code class="literal">es-ES</code>.</p><p>If you recall, we defined our translations only for the language. This presents a problem: the preceding code will not return any translation unless we defined the translation for the language and the country.</p><div><div><h3 class="title"><a id="note07"/>Note</h3><p>Sometimes it is critical to define a translation specific to a language and a country. While various regions may speak the same language from a technical perspective, idioms often differ. If you use an idiom in your translation, you'll need to localize them to the specific region that uses them, or you could generate potential confusion.</p></div></div><p>Therefore, we chop off the country code, and try again as follows:</p><div><pre class="programlisting">    userLocale = userLocale.substr(0,2);

    if (! (currentValue=PKLOC.lookupTranslation(key, userLocale)) )
    {</pre></div><p>But we've only defined translations for English (<code class="literal">en</code>) and Spanish(<code class="literal">es</code>)! What if the player's locale is <code class="literal">fr-FR</code> (French)? The preceding code will fail, because we've not defined any translation for the <code class="literal">fr</code> language (French). Therefore, we'll check for a suitable default, which we've defined to be <code class="literal">en-US</code>, American English:</p><div><pre class="programlisting">      userLocale = "en-US";      
      if (! (currentValue=PKLOC.lookupTranslation(key, userLocale)) )
      {</pre></div><p>Of course, we are now in the same boat as before: there are no translations defined for <code class="literal">en-US</code> in our game. So we need to fall back to <code class="literal">en</code> as follows:</p><div><pre class="programlisting">        userLocale = "en";      
        if (! (currentValue=PKLOC.lookupTranslation(key, userLocale)) )
        {</pre></div><p>But what <a id="id68" class="indexterm"/>happens if we can't find a translation at all? We could be mean and throw a nasty error, and perhaps you might want to do exactly that, but in our example, we're just returning the incoming key. If the convention of capitalizing the key is always followed, we'll still be able to see that something hasn't been translated.</p><div><pre class="programlisting">          currentValue = key;
        }
      }
    }
  }</pre></div><p>Finally, we pass the <code class="literal">currentValue</code> parameter to the <code class="literal">substituteVariables</code> property in order to process any substitutions that we might need as follows:</p><div><pre class="programlisting">  return PKLOC.substituteVariables( currentValue, parms 
         );
}</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec15"/>Implementing the start view</h1></div></div></div><p>To create our <a id="id69" class="indexterm"/>view, <a id="id70" class="indexterm"/>we need to create the file for it first. The files should be called <code class="literal">startView.html</code>, and should live under the <code class="literal">www/views</code> directory. The view we're creating will end up looking like the following screenshot for iOS:</p><div><img src="img/9403_01_07.jpg" alt="Implementing the start view"/></div><p>For Android (localized to Spanish), the view will be as follows:</p><div><img src="img/9403_01_08.jpg" alt="Implementing the start view"/></div><p>Before we actually create the view though, let's define the structure of our view. Depending upon the<a id="id71" class="indexterm"/> framework in use, the structure of a view can be vastly different. For the YASMF framework, our view will consist of some HTML that will depend on some pre-defined CSS, and some JavaScript defined below that same HTML. You could easily make the case that the JavaScript and inline styles should be separated out as well, and if you wish, you can do so.</p><p>The HTML portion for all our views will be of the following form:</p><div><pre class="programlisting">&lt;div class="viewBackground"&gt;
 &lt;div class="navigationBar"&gt;
  &lt;div id="theView_AppTitle"&gt;&lt;/div&gt;
  &lt;button class="barButton backButton" 
   id="theView_backButton" style="left:10px" &gt;&lt;/button&gt;
 &lt;/div&gt;
 &lt;div class="content avoidNavigationBar avoidToolBar" 
  id="theView_anId"&gt;
 &lt;/div&gt;
 &lt;div class="toolBar"&gt;
  &lt;button class="barButton" id="theView_aButton" 
   style="right:10px"&gt;&lt;/button&gt;
 &lt;/div&gt;
&lt;/div&gt;</pre></div><p>As you can see, there's no visible text anywhere in this code. Since everything must be localized, we'll be inserting the text programmatically via JavaScript.</p><p>The <code class="literal">viewBackground</code> class<a id="id72" class="indexterm"/> will be our view's container: everything related to the view's structure is defined within. The style is defined in <code class="literal">www/framework/base.css</code> and <code class="literal">www/style/style.css</code>; the latter is for our app's custom styles.</p><p>The <code class="literal">navigationBar</code> class <a id="id73" class="indexterm"/>indicates that the <code class="literal">div</code> class is just a navigation bar. For iOS users, this has instant meaning, but it should be pretty clear to everyone else: this bar holds the title of the view, as well as any buttons that serve for navigation (such as a <strong>back</strong> button). Notice that the <strong>title</strong> and <strong>back</strong> button both have <code class="literal">id</code> values. This value makes it easy for us to access them in our JavaScript later on. Notice also that we are namespacing these <code class="literal">id</code> values with the view name and an underscore; this is to prevent any issues with using the same <code class="literal">id</code> twice.</p><p>The next <code class="literal">div</code> class is given<a id="id74" class="indexterm"/> the class of <code class="literal">content avoidNavigationBar avoidToolBar</code>; this is where all the content will go. The latter two classes specify that it should be offset from the top of the screen and short enough to avoid both the navigation bar (already defined) and the toolbar (coming up).</p><p>Finally, the toolbar is defined. This is a bar much like the navigation bar, but is intended to hold buttons that are related to the view. For Android this would be commonly shown near or at the top of the screen, while for iPhone and WP7 display this bar is at the bottom. (iPad, on the other hand, would display this just below the navigation bar or on the navigation bar. We'll worry about that in <a class="link" href="ch10.html" title="Chapter 10. Scaling Up">Project 10</a>, <em>Scaling Up</em>.)</p><p>Below this HTML block, we'll define any templates we may need for localization, and then finally, any JavaScript we need.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec29"/>Getting on with it</h2></div></div></div><p>With these pointers in mind, let's create our start view, which should be named <code class="literal">startView.html</code> in the <code class="literal">www/views</code> directory as follows:</p><div><pre class="programlisting">&lt;div class="viewBackground"&gt;
 &lt;div class="navigationBar"&gt;
  &lt;div id="startView_AppTitle"&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="content avoidNavigationBar avoidToolBar"   
  id="startView_welcome"&gt;
 &lt;/div&gt;
 &lt;div class="toolBar"&gt;
  &lt;button class="barButton" id="startView_startButton" 
   style="right:10px"&gt;&lt;/button&gt;
 &lt;/div&gt;
&lt;/div&gt;</pre></div><p>The preceding code looks almost exactly like our view template defined earlier except that we're missing a <code class="literal">back</code> button. <a id="id75" class="indexterm"/>This is due to the fact that the first view we display to the user doesn't have anything to go back to, so we omit that button. The <code class="literal">id</code> values have also changed to include the name of our view.</p><p>None of these define what our view will look like, though. To determine that, we need to override our framework styles in <code class="literal">www/framework/base.css</code> by setting them in <code class="literal">www/style/style.css</code>.</p><p>First, to define the look of <code class="literal">navigationBar</code>, we use the glossy black bar from our template defined earlier in this project as follows:</p><div><pre class="programlisting">.navigationBar
{
  background-image: url(../images/NavigationBar.png);
  color: #FFF;
  background-color: transparent;
}</pre></div><p>The toolbar is defined similarly as follows:</p><div><pre class="programlisting">.toolBar
{
  background-image: url(../images/ToolBar.png);
}</pre></div><p>The view's background is defined as follows:</p><div><pre class="programlisting">.viewBackground
{
  background-image: url(../images/Background.jpg);
  background-size: cover;
}</pre></div><p>That's everything needed to make our start view start to look like a real app. Of course, there's a lot of pre-built stuff in <code class="literal">www/framework/base.css</code>, which you're welcome to analyze and reuse in your own projects.</p><p>Now that we've defined the view and the appearance, we need to define some of the view's content. We're <a id="id76" class="indexterm"/>going to do this by using a couple of hidden <code class="literal">div</code> elements that have the locale attached to their <code class="literal">id</code> values, as follows:</p><div><pre class="programlisting">&lt;div id="startView_welcome_en" class="hidden"&gt;
 &lt;h2&gt;PhoneGap-Hotshot Sample Application&lt;/h2&gt;
 &lt;h3&gt;Chapter 1: Let's Get Local!&lt;/h3&gt;
 &lt;p&gt;This application demonstrates localization
    between two languages, based on your device's
    language settings. The two languages implemented
    are English and Spanish.&lt;/p&gt;
&lt;/div&gt;

&lt;div id="startView_welcome_es" class="hidden"&gt;
 &lt;h2&gt;Ejemplo de aplicación de PhoneGap-Hotshot&lt;/h2&gt;
 &lt;h3&gt;Capítulo 1: Let's Get Local!&lt;/h3&gt;
 &lt;p&gt;Esta aplicación muestra la localización
     entre los dos idiomas, sobre la base de su dispositivo de
     la configuración de idioma. Las dos lenguas aplicadas
     son Inglés y Español.&lt;/p&gt;
&lt;/div&gt;</pre></div><p>These two <code class="literal">div</code> elements are classed <code class="literal">hidden</code> so that they won't be visible to the player. We'll then use some JavaScript to copy their content to the content area inside the view. Easier than using the <code class="literal">__T()</code> and <code class="literal">PKLOC.addTranslation()</code> functions<a id="id77" class="indexterm"/> for all that text, isn't it?</p><p>Next comes the JavaScript as follows:</p><div><pre class="programlisting">&lt;script&gt;
  var startView = $ge("startView") || {};  // properly namespace</pre></div><p>Our first act is to put all our script into a namespace. Unlike most of our other namespace definitions, we're actually going to piggyback onto the "<code class="literal">startView</code>" element (which the astute reader will notice has not been defined yet; that'll be near the end of this project). While the element is a proper DOM element, it also serves as a perfect place for us to attach to, as long as we avoid any of the cardinal sins of using the DOM method names as our own, which, I promise, we won't do.</p><p>You might be wondering <a id="id78" class="indexterm"/>what <code class="literal">$ge</code> does. Since we're not including any JavaScript framework like jQuery, we don't have a convenience method to get an element by its ID. jQuery does this with the <code class="literal">$()</code> method, and because you might actually be using jQuery along with the framework we're using, I chose to use the <code class="literal">$ge()</code> method, short for <em>get element</em>. It's defined in <code class="literal">www/framework/utility.js</code> like the following code snippet and all it does is act as a shortened version of <code class="literal">document.getElementById</code>:</p><div><pre class="programlisting">function $ge ( elementId )
{
  return document.getElementById ( elementId );
}</pre></div><p>Getting back to our start view script, we define what needs to happen when the view is initialized. Here we <em>hook</em> into the various buttons and other interface elements that are in the view, as well as localize all the text and content as follows:</p><div><pre class="programlisting">startView.initializeView = function ()
  {
    PKLOC.addTranslation ("en", "APP_TITLE_IMAGE", 
         "AppTitle-enus.png");
    PKLOC.addTranslation ("es", "APP_TITLE_IMAGE", 
         "AppTitle-eses.png");

    startView.applicationTitleImage = 
         $ge("startView_AppTitle");
    startView.applicationTitleImage.style.backgroundImage = 
        "url('./images/" + __T("APP_TITLE_IMAGE") + "')";</pre></div><p>This is our first use of the <code class="literal">__T()</code> function. This is how we can properly localize an image. The <code class="literal">APP_TITLE_IMAGE</code> key is set to point at either the English version or the Spanish version of the title image, and the <code class="literal">__T()</code> function returns the correct one based on our locale.</p><div><pre class="programlisting">    PKLOC.addTranslation ("en", "START", "Start");
    PKLOC.addTranslation ("es", "START", "Comenzar");

    startView.startButton = $ge("startView_startButton");
    startView.startButton.innerHTML = __T("START");</pre></div><p>Now we've properly localized our <code class="literal">start</code> button, but how do we make it do anything? We use a little function defined in <code class="literal">www/framework/ui-core.js</code> called <code class="literal">PKUI.CORE.addTouchListener()</code> as follows:</p><div><pre class="programlisting">    PKUI.CORE.addTouchListener( startView.startButton, 
        "touchend", startView.startGame );</pre></div><p>Finally, we need to display the correct <em>welcome</em> text in the content area using the following code snippet:</p><div><pre class="programlisting">    var theWelcomeContent = $geLocale("startView_welcome");
    $ge("startView_welcome").innerHTML = 
        theWelcomeContent.innerHTML;
  }</pre></div><p>We now introduce another <a id="id79" class="indexterm"/>convenience function: the <code class="literal">$geLocale()</code> function<a id="id80" class="indexterm"/>. This function acts like the <code class="literal">$ge()</code> function, except that it assumes there will be a locale appended to the ID of the element we're asking for. It's defined in the same file (<code class="literal">utility.js</code>) and looks like the following:</p><div><pre class="programlisting">function $geLocale ( elementId )
{
  var currentLocale = PKLOC.getUserLocale();
  var theLocalizedElementId = elementId + "_" + currentLocale;
  if ($ge(theLocalizedElementId)) { return 
      $ge(theLocalizedElementId); }

  theLocalizedElementId = elementId + "_" + 
      currentLocale.substr(0,2);
  if ($ge(theLocalizedElementId)) { return 
      $ge(theLocalizedElementId); }

  theLocalizedElementId = elementId + "_en-US";
  if ($ge(theLocalizedElementId)) { return 
      $ge(theLocalizedElementId); }

  theLocalizedElementId = elementId + "_en";
  if ($ge(theLocalizedElementId)) { return 
      $ge(theLocalizedElementId); }
  return $ge( elementId );
}</pre></div><p>Much like our <code class="literal">__T()</code> function, it attempts to find an element with our full locale attached (that is, <code class="literal">_xx-YY</code>). If it can't find it, it tries <code class="literal">_xx</code>, and here it should succeed if our locale is English- or Spanish-speaking. If it isn't, we'll then look for <code class="literal">_en-US</code>, and if that isn't found, we'll look for <code class="literal">_en</code>. If no suitable element is found, we'll return the original element –which in our case doesn't exist, which means we'll return "<code class="literal">undefined</code>".</p><p>Next up in our start view script, we have the function that is called whenever the start button is tapped as shown in the following code snippet:</p><div><pre class="programlisting">startView.startGame = function()
  {
    PKUI.CORE.pushView ( gameView );
  }
  
&lt;/script&gt;</pre></div><p>Real short, but packs a punch. This displays our game view to the player, which actually starts the game. For devices <a id="id81" class="indexterm"/>that support it (as this was being written, iOS and Android), the player also sees a nice animation between this view (start) and the next one (game).</p><p>If you want to know more about how the <code class="literal">pushView()</code> method<a id="id82" class="indexterm"/> works, visit <a class="ulink" href="https://github.com/photokandyStudios/YASMF/wiki/PKUI.CORE.pushView">https://github.com/photokandyStudios/YASMF/wiki/PKUI.CORE.pushView</a>.</p><p>Whew! That was a lot of work for a pretty simple view. Thankfully, most of the work is actually done by the framework, so our actual <code class="literal">startView.html</code> file is pretty small.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec30"/>What did we do?</h2></div></div></div><p>We implemented our start view, which is presented to the player when they first launch the app. We properly localized the view's title image based on the player's locale, and we also properly localized HTML content based on the locale.</p><p>We defined the various hooks and text for the widgets on the view such as the <strong>Start</strong> button, and attached touch listeners to the them to make them function correctly.</p><p>We covered a portion of the framework that provides support for pushing views onto the screen as well.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec31"/>What else do I need to know?</h2></div></div></div><p>It probably doesn't take much to guess, but there are several complementary functions to the <code class="literal">pushView</code> method: <code class="literal">popView</code>, <code class="literal">showView</code>, and <code class="literal">hideView</code>.</p><p>The <code class="literal">popView</code> function<a id="id83" class="indexterm"/> does the exact opposite of <code class="literal">pushView</code>, that is, it moves the views right (instead of left) by popping them off the view stack.</p><p>The<a id="id84" class="indexterm"/> <code class="literal">showView</code> and <code class="literal">hideView</code> functions<a id="id85" class="indexterm"/> do essentially the same thing, but simpler. They don't do any animation at all. Furthermore, since they don't involve any other view on the stack, they are most useful at the beginning of an app when we have to figure out how to display our very first view with no previous view to animate.</p><p>If you want to know more about view management, you might want to visit <a class="ulink" href="https://github.com/photokandyStudios/YASMF/wiki/Understanding-the-View-Stack-and-View-Management">https://github.com/photokandyStudios/YASMF/wiki/Understanding-the-View-Stack-and-View-Management</a> and explore <a class="ulink" href="https://github.com/photokandyStudios/YASMF/wiki/PKUI.CORE">https://github.com/photokandyStudios/YASMF/wiki/PKUI.CORE</a>.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec16"/>Implementing our game view</h1></div></div></div><p>To get <a id="id86" class="indexterm"/>started, <a id="id87" class="indexterm"/>create a file named <code class="literal">gameView.html</code> under the <code class="literal">www/views</code> directory. When we're done, we'll have a view that looks like the following screenshot for iOS:</p><div><img src="img/9403_01_10.jpg" alt="Implementing our game view"/></div><p>For Android, the view will look like the following screenshot:</p><div><img src="img/9403_01_11.jpg" alt="Implementing our game view"/></div><p>Now, before we get <a id="id88" class="indexterm"/>too deep into the view itself, let's go over the view stack and how it helps us deal with navigation. The view stack is shown in the following screenshot:</p><div><img src="img/9403OS_01_16.jpg" alt="Implementing our game view"/></div><p>The view stack is really just a stack that maintains the list of previously visible views and the currently visible view. When our app first starts, the stack will be empty as identified in the first step in the preceding screenshot. Then, the <code class="literal">startView</code> view is pushed onto the stack using the <code class="literal">showView</code> method, and you have the stack in (2). When the player taps the <strong>Start</strong> button, the <code class="literal">gameView</code> view is pushed onto the stack, which results in the stack as seen in (3). Then, when the game is over, we'll push the <code class="literal">endView</code> view on the stack, resulting in (4).</p><p>Because we're tracking <a id="id89" class="indexterm"/>all these views, including the ones that are no longer visible (especially at the end of the game), it makes it easy to go back to a previous view. For iOS, this is done via the <strong>back</strong> button. For Android, the device often has a physical back button that is used instead. Regardless of how a <code class="literal">back</code> event is triggered, we need to be able to go backwards in the stack.</p><p>Let's say that the user now decides to go back in the stack; we would have the stack in (5). If they decide to go back another step, (6) would result. At this point, iOS would permit no further backtracking, but for Android, another <code class="literal">back</code> event should exit the user out of the app.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec32"/>Getting on with it</h2></div></div></div><p>The game view will be very similar to our start view, except that it is a little more complicated. After all, it plays an entire game. Thankfully, there's really nothing terribly new here, so it should be smooth going.</p><p>Let's start with the HTML portion of the view given as follows:</p><div><pre class="programlisting">&lt;div class="viewBackground"&gt;
 &lt;div class="navigationBar"&gt;
  &lt;div id="gameView_title"&gt;&lt;/div&gt;
<strong>  &lt;button class="barButton backButton" </strong>
<strong>   id="gameView_backButton" style="left:10px"&gt;&lt;/button&gt;</strong>
 &lt;/div&gt;
 &lt;div class="content avoidNavigationBar avoidToolBar" 
  id="gameView_gameArea"&gt;
<strong>  &lt;div id="gameView_scoreArea" style="height:1em; text-  </strong>
<strong>   align: center;"&gt;&lt;/div&gt;</strong>
<strong>  &lt;div id="gameView_questionArea" style="text-align: </strong>
<strong>   center"&gt;&lt;/div&gt;</strong>
 &lt;/div&gt;
 &lt;div class="toolBar"&gt;
  &lt;button class="barButton" id="gameView_nextButton" 
   style="right:10px" &gt;&lt;/button&gt;
 &lt;/div&gt;
&lt;/div&gt;</pre></div><p>I've highlighted what's new in the earlier code, but there is not much as you can see. First we've defined a <code class="literal">back</code> button that lives in the navigation bar, and in the content area we've defined two new areas: one for the player's score, and another for the actual question (and answers).</p><p>Up next, while similar to the localized content in the start view, we have templates that specify how a question and its answers are displayed; this is given as follows:</p><div><pre class="programlisting">&lt;div id="gameView_questionTemplate" class="hidden"&gt;
 &lt;h2&gt;%QUESTION%&lt;/h2&gt;
 &lt;div style="text-align:center;"&gt;%ANSWERS%&lt;/div&gt;
&lt;/div&gt;</pre></div><p>First, we define the question template, which consists of a second-level heading that will have the question's text, and a div element that will contain all the answers. But what will the answers look like? That's next:</p><div><pre class="programlisting">&lt;div id="gameView_answerTemplate" class="hidden"&gt;
 &lt;button class="barButton answerButton" 
  onclick="gameView.selectAnswer(%ANSWER_INDEX%);"&gt;%ANSWER%
 &lt;/button&gt;&lt;br/&gt;
&lt;/div&gt;</pre></div><p>Each answer <a id="id90" class="indexterm"/>will be presented as a button with the answer text inside, and an <code class="literal">onclick</code> event<a id="id91" class="indexterm"/> attached to call the <code class="literal">gameView.selectAnswer()</code> method<a id="id92" class="indexterm"/> with the selected answer.</p><p>Of course, as these are templates, they don't appear to the player, and so they are given the <code class="literal">hidden</code> class. But we'll definitely make use of them in our JavaScript when we construct an actual random question to display to the player. Let's go over the script now:</p><div><pre class="programlisting">&lt;script&gt;

  var gameView = $ge("gameView") || {};

  gameView.questionNumber = -1;
  gameView.score = 0;
  gameView.theCurrentQuestion;</pre></div><p>By now you should be familiar with our namespacing technique, which comes first in our code. After that, though, we define the properties in our view. The question number, which will act as our counter so that when it reaches ten, we know the game is over; the score; and the current question. The latter isn't obvious, but it will be an actual question object, not an index to the object.</p><p>After that, we have the <code class="literal">initializeView</code> function<a id="id93" class="indexterm"/>, which will wire up all the widgets and do the localization of the text, as seen in the following code snippet:</p><div><pre class="programlisting">gameView.initializeView = function ()
  {
<strong>  PKUTIL.include ( ["./models/quizQuestions.js", </strong>
<strong>      "./models/quizQuestion.js"] );</strong>
  gameView.viewTitle = $ge("gameView_title");
  gameView.viewTitle.innerHTML = __T("APP_TITLE");

  gameView.backButton = $ge("gameView_backButton");
  gameView.backButton.innerHTML = __T("BACK");
  PKUI.CORE.addTouchListener(gameView.backButton, "touchend", 
      function () { PKUI.CORE.popView(); });

  gameView.nextButton = $ge("gameView_nextButton");
<strong>  gameView.nextButton.innerHTML = __T("SKIP");</strong>

  PKUI.CORE.addTouchListener(gameView.nextButton, "touchend", 
      gameView.nextQuestion);

<strong>  gameView.scoreArea = $ge("gameView_scoreArea");</strong>
<strong>  gameView.questionArea = $ge("gameView_questionArea");</strong>
}</pre></div><p>I've highlighted a few areas in the preceding code block. The last ones are more or less the same, as <a id="id94" class="indexterm"/>we're storing<a id="id95" class="indexterm"/> the <code class="literal">gameView_scoreArea</code> and <code class="literal">gameView_questionArea</code> elements<a id="id96" class="indexterm"/> into properties for later use, so that's not really anything new. What is new about it is that we aren't loading any content into them yet.</p><p>The second highlight is not something you'd really ever add to a production game. You may ask, so why is it here? The idea is that this button lets us skip the current question without a penalty. Why? The answer is testing. I don't want to have to tap through an answer, tap through the alert saying if I got it right or wrong a million times to see if the localization is working for all the questions. Hence, skip was born.</p><p>The first highlight though, is more interesting. It's a JavaScript include. "Wait," I hear you saying, "JavaScript doesn't do includes." And you'd be right.</p><p>But, it is possible to simulate an include by using <code class="literal">XmlHttpRequest</code>, which is often referred to as AJAX. With this short include statement, we're asking the browser to load the two referenced JavaScript files (<code class="literal">quizQuestions.js</code> and <code class="literal">quizQuestion.js</code>) on our behalf. It's important that this happens too; otherwise, our game would have no questions!</p><p>The <code class="literal">PKUTIL.include()</code> function<a id="id97" class="indexterm"/> is defined in <code class="literal">www/framework/utility.js</code>. We'll worry about the full implementation details a little later in this project, but it would suffice to say, it does what it says. The scripts are loaded and waiting for us when we need to use the questions. (At this point the reader with a gazillion questions is asking this key question, "Does the order matter?", the answer is, "Yes." And you'll see why in a short bit.)</p><p>So now that we have the initialization for <code class="literal">gameView</code> down, let's look at another key method: <code class="literal">viewWillAppear</code>. It is shown in the following code snippet:</p><div><pre class="programlisting">gameView.viewWillAppear = function ()
{
  gameView.questionNumber =1;
  gameView.score = 0;
  gameView.nextQuestion();
}</pre></div><p>The latter part<a id="id98" class="indexterm"/> of this code is fairly innocuous. We set the question number to 1, the score to zero, and call the <code class="literal">nextQuestion()</code> method<a id="id99" class="indexterm"/>, which, as it is turns out, renders the next question and displays it to the player.</p><p>The <code class="literal">viewWillAppear()</code> function<a id="id100" class="indexterm"/>, as you may remember, is called by <a id="id101" class="indexterm"/>
<code class="literal">PKUI.CORE.pushView()</code> and <code class="literal">PKUI.CORE.showView()</code> method<a id="id102" class="indexterm"/>s just prior to the actual animation that renders the view onscreen. Therefore, the act of the <strong>Start</strong> button on the start view pushing the game view on the stack will call this function, and start the game.</p><p>It also works when we're coming back to the view by popping the end view off the stack. We'll receive a <code class="literal">viewWillAppear</code> notification, reset the game, and it's as if the user gets a whole new game. It's almost magic!</p><div><div><h3 class="title"><a id="note08"/>Note</h3><p>To those who have done any amount of Objective-C programming for iOS using Apple's frameworks, I'll apologize right now for using the concepts in the framework. It's just that, well, they fit the view model so well! If you prefer Android's methodology, or Microsoft's, feel free to substitute. I just happen to like the framework Apple has built up for their platform.</p></div></div><p>Of course, we need to actually do something when the back button is pressed, the code for it is as follows:</p><div><pre class="programlisting">gameView.backButtonPressed = function ()
{
  PKUI.CORE.popView();
}</pre></div><p>
<code class="literal">The popView()</code> method<a id="id103" class="indexterm"/> is literally the reverse of <code class="literal">pushView</code>. It takes the currently visible view (<code class="literal">gameView</code>), pops it off the stack, and displays the underlying view, in this case, <code class="literal">startView</code>. The best thing to do here would be to prompt the player if they really wanted to do this; it will end their game, perhaps prematurely. For now, as an example, we'll leave it at this.</p><p>Next, we need <a id="id104" class="indexterm"/>to define how a question is displayed on the screen. We do that in <code class="literal">nextQuestion()</code>
<a id="id105" class="indexterm"/>, as seen in the following code snippet:</p><div><pre class="programlisting">gameView.nextQuestion = function ()
{</pre></div><p>First, we'll get a random question from the <code class="literal">QQ</code> namespace:</p><div><pre class="programlisting">  // load the next question into the view
  gameView.theCurrentQuestion = QQ.getRandomQuestion();</pre></div><p>Next, we get our templates:</p><div><pre class="programlisting">  var theQuestionTemplate = 
    $ge("gameView_questionTemplate").innerHTML;
  var theAnswerTemplate   = 
    $ge("gameView_answerTemplate").innerHTML;</pre></div><p>Now that we have our templates, we'll replace all occurrences of <code class="literal">"%QUESTION%</code>" with the translated question, as shown in the following code snippet:</p><div><pre class="programlisting">  theQuestionTemplate = theQuestionTemplate.replace( 
    "%QUESTION%", 
    __T(gameView.theCurrentQuestion.getQuestion()) );</pre></div><p>Generating the answers is a little more tricky. There may be two, three, or more answers for any one question, so we'll ask the question for a list of randomized answers first, and then loop through that list while building up an HTML string, as shown in the following code snippet:</p><div><pre class="programlisting">  var theAnswers = 
    gameView.theCurrentQuestion.getRandomizedAnswers();

  var theAnswersHTML = "";

  for (var i=0; i&lt;theAnswers.length; i++)
    {</pre></div><p>For each answer, we'll replace the <code class="literal">%ANSWER%</code> text with the translated text of the answer, and <code class="literal">"%ANSWER_INDEX%</code>" with the current index (<code class="literal">i</code>), as shown in the following screenshot:</p><div><pre class="programlisting">        theAnswersHTML += theAnswerTemplate.replace( 
          "%ANSWER%", 
          __T(gameView.theCurrentQuestion.answerAtIndex( 
          theAnswers[i] ) )).replace ( "%ANSWER_INDEX%", 
          theAnswers[i] );
    }</pre></div><p>Now that we've got the HTML for our answers, we can replace <code class="literal">%ANSWERS%</code> in the question template with it as follows:</p><div><pre class="programlisting">    theQuestionTemplate = theQuestionTemplate.replace ( 
      "%ANSWERS%", theAnswersHTML );</pre></div><p>At this point, we can display the question to the player:</p><div><pre class="programlisting">    gameView.questionArea.innerHTML = theQuestionTemplate;</pre></div><p>We also want to <a id="id106" class="indexterm"/>update the player's score. We're going to have an artificially absurd scoring system to highlight whether or not our localization is working correctly. Note that the <code class="literal">2</code> in the following code snippet specifies we want two decimal places in the score.</p><div><pre class="programlisting">    gameView.scoreArea.innerHTML = __T("SCORE_%1", 
      [ __N(gameView.score, "2") ]);</pre></div><p>We'll also update the view's title with the current question number. This time the "<code class="literal">0</code>" following code snippet indicates no decimal points:</p><div><pre class="programlisting">    gameView.viewTitle.innerHTML = __T("QUESTION_%1", 
      [ __N(gameView.questionNumber, "0") ]);
    
}</pre></div><p>All of this is well and good, but it does nothing without the user being able to select an answer, which is where the next function comes in:</p><div><pre class="programlisting">  gameView.selectAnswer = function ( theAnswer )
  {</pre></div><p>First, we'll ask the current question if the answer selected is correct using the following code snippet:</p><div><pre class="programlisting">    if (gameView.theCurrentQuestion.testAnswer ( theAnswer ))
    {</pre></div><p>If it is, we'll tell the user they got it right, and increment their score as follows:</p><div><pre class="programlisting">        alert (__T("CORRECT"));
        gameView.score += 483.07;
    }
    else
    {</pre></div><p>But if it is wrong,<a id="id107" class="indexterm"/> we'll indicate that it is incorrect, and decrement their score (We're mean, I guess. Not really though-we want to test that negative numbers work too.), using the following code snippet:</p><div><pre class="programlisting">        alert (__T("INCORRECT"));
        gameView.score -= 192.19;
    }</pre></div><p>Next, we check to see if we've asked the last question in the set as follows:</p><div><pre class="programlisting">    if (gameView.questionNumber &gt;= 10)
    {</pre></div><p>If we have, we'll communicate the score to the end view and push it onto the stack. This ends the game, using the following code snippet:</p><div><pre class="programlisting">        endView.setScore ( gameView.score );
        PKUI.CORE.pushView ( endView );
    }
    else
    {</pre></div><p>In this case, we've got more questions to answer, so we load the next question as follows:</p><div><pre class="programlisting">        gameView.questionNumber++;
        gameView.nextQuestion();
    }
  }
  
&lt;/script&gt;</pre></div><p>With that, we're done with the game view. Tell me, that wasn't too difficult, was it?</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec33"/>What did we do?</h2></div></div></div><p>We implemented the actual game in one view. We also learned how to handle the back button on Android, and back navigation on iOS. We also gained an understanding of how to use HTML blocks that are hidden as templates for dynamic content.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec34"/>What else do I need to know?</h2></div></div></div><p>If you remember, I mentioned that we'd talk about that wonderful little <code class="literal">include</code> function<a id="id108" class="indexterm"/> a little more. Let's look at it a bit closer:</p><div><pre class="programlisting">PKUTIL.include = function ( theScripts, completion )
{</pre></div><p>First off, let me clue you into something: we're using recursion here to load the scripts. So, as you'll see in the following code, we're testing the length of the incoming array, and if it is zero, we call the <code class="literal">completion</code> method<a id="id109" class="indexterm"/> passed to us. This allows us—if we like—to have code called after all the scripts are loaded. This code block is as follows:</p><div><pre class="programlisting">var theNewScripts = theScripts;
  if (theNewScripts.length == 0)
  {
    if (completion)
    {
       completion();
    }
    return;
  }</pre></div><p>In the next section, we'll pop off the next script to load. This also explains that the array must contain the scripts in reverse order of their dependencies. Yes, you could reverse the array yourself and you should, but I wanted to make the point. To pop off the script the following code instruction is used:</p><div><pre class="programlisting">  var theScriptName = theNewScripts.pop();</pre></div><p>Then we call another previously unknown function, <code class="literal">PKUTIL.load()</code>
<a id="id110" class="indexterm"/>. This method takes the script filename, and then calls the <code class="literal">completion</code> function we've given it. It will call it regardless of success or failure. Notice that it is an incoming parameter to the completion function. This function is shown in the following screenshot:</p><div><pre class="programlisting">  PKUTIL.load ( theScriptName, true, function ( success, data )
  {</pre></div><p>If the script was successfully loaded, we create a <code class="literal">SCRIPT</code> DOM element and add the data to it. It is important to note that nothing happens with the script until we actually attach it to the DOM. We do this by appending the child to the <code class="literal">BODY</code>. It is at this point that whatever is in the script will be executed. This conditional <code class="literal">if</code> block is shown in the following code snippet:</p><div><pre class="programlisting">    if (success)
    {
      var theScriptElement = document.createElement("script");
      theScriptElement.type = "text/javascript";
      theScriptElement.charset = "utf-8";
      theScriptElement.text = data;
      document.body.appendChild ( theScriptElement ); // add it as a script tag
    }</pre></div><p>If we fail to load the script, we'll generate a log message on the console. You could make a case that something worse should happen, like a fatal error that stops everything, but this also permits loading libraries that may or may not be there and taking advantage of them if they happen to exist. Perhaps not a feature one would use frequently, but useful at times nonetheless. The conditional <code class="literal">else</code> block is as follows:</p><div><pre class="programlisting">    else
    {
      console.log ("WARNING: Failed to load " + theScriptName );
    }</pre></div><p>And say hello to our little friend, recursion. We call ourselves with the array of script names (minus the one we just popped), with the <code class="literal">completion</code> function, and sooner or later, we'll end up with no items in the array. Then, the <code class="literal">completion</code> function will be called as seen in the following code block:</p><div><pre class="programlisting">    PKUTIL.include ( theNewScripts, completion );
  }
  );
}</pre></div><p>The <code class="literal">PKUTIL.load()</code> function is another interesting beast, which must work correctly for our includes to work. It's defined something like the following (for full implementation details, visit <a class="ulink" href="https://github.com/photokandyStudios/YASMF/blob/master/framework/utility.js#L126">https://github.com/photokandyStudios/YASMF/blob/master/framework/utility.js#L126</a>):</p><div><pre class="programlisting">PKUTIL.load = function ( theFileName, aSync, completion )
{</pre></div><p>First, we'll check to see if the browser understands <code class="literal">XMLHttpRequest</code>. If it doesn't, we'll call <code class="literal">completion</code> with a failure notice and a message describing that we couldn't load anything, as shown in the following code block:</p><div><pre class="programlisting">  if (!window.XMLHttpRequest) 
  { 
    if (completion) 
    {
      completion ( PKUTIL.COMPLETION_FAILURE,
                   "This browser does not support 
                    XMLHttpRequest." );
      return;
    }
  }</pre></div><p>Next we set up the <code class="literal">XMLHttpRequest</code>
<a id="id111" class="indexterm"/>, and assign the <code class="literal">onreadystatechange</code> function<a id="id112" class="indexterm"/> as follows:</p><div><pre class="programlisting">  var r = new XMLHttpRequest();
  r.onreadystatechange = function()
  {</pre></div><p>This function can be called many different times during the loading process, so we check for a specific value. In this case, <code class="literal">4</code> means that the content has been loaded:</p><div><pre class="programlisting">    if (r.readyState == 4)
    {</pre></div><p>Of course, just because we got data doesn't mean that it is useable data. We need to verify the status of the load, and here we get into a little bit of murky territory. iOS defines success with a zero value, while Android defines it with a <code class="literal">200</code>:</p><div><pre class="programlisting">      if ( r.status==200 || r.status == 0)
      {</pre></div><p>If we've successfully loaded the data, we'll call the <code class="literal">completion</code> function with a success notification, and the data, as follows:</p><div><pre class="programlisting">        if (completion)
        {
          completion ( PKUTIL.COMPLETION_SUCCESS,
                       r.responseText );
        } 
      }</pre></div><p>But if we've failed to load the data, we call the <code class="literal">completion</code> function with a failure notification and the status value of the load, as follows:</p><div><pre class="programlisting">      else
      {
        if (completion)
        {
          completion ( PKUTIL.COMPLETION_FAILURE,
                       r.status );
        }
      }
    }
  }</pre></div><p>Keep in mind that we're still just setting up the <code class="literal">XMLHttpRequest</code> object and that we've not actually triggered the load yet.</p><p>The next step is to specify the path to the file, and here we run into a problem on WP7 versus Android and iOS. On both Android and iOS we can load files relative to the <code class="literal">index.html</code> file, but on WP7, we have to load them relative to the <code class="literal">/app/www</code> directory. Subtle to track down, but critically important. Even though we aren't supporting WP7 in this book, the framework does, and so it needs to handle cases like this using the following code snippet:</p><div><pre class="programlisting">  if (device.platform=="WinCE")
  {
    r.open ('GET', "/app/www/" + theFileName, aSync); 
  }
  else
  {
    r.open ('GET', theFileName, aSync); 
  }</pre></div><p>Now that we've set the filename, we fire off the load:</p><div><pre class="programlisting">  r.send ( null );
      
}</pre></div><div><div><h3 class="title"><a id="note09"/>Note</h3><p>Should you ever decide to support WP7, it is critical that even though the framework supports passing <code class="literal">false</code> for <code class="literal">aSync</code>, which should result in a synchronous load, you shouldn't actually ever do so. WP7's browser does funny things when it can't load data asynchronously. For one thing, it loads it asynchronously anyway (not your intended behavior), and for another thing, it has a tendency to think the file simply doesn't exist. So instead of loading scripts, you'll get errors in the console indicating that a 404 error occurred. And you'll scratch your head (I did!) wondering why in the world that could be when the file is right there. Then you'll remember this long note, change the value back to <code class="literal">true</code>, and things will suddenly start working. (You seriously do not want to know the hours it took me to debug on WP7 to finally figure this out. I want those hours back!)</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec17"/>Implementing the end view</h1></div></div></div><p>We'll be <a id="id113" class="indexterm"/>creating <a id="id114" class="indexterm"/>the file name <code class="literal">endView.html</code> in the <code class="literal">www/views</code> directory. When we're done, we'll end up with this view for iOS:</p><div><img src="img/9403_01_13.jpg" alt="Implementing the end view"/></div><p>The view for Android will be as follows:</p><div><img src="img/9403_01_14.jpg" alt="Implementing the end view"/></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec35"/>Getting on with it</h2></div></div></div><p>As with our previous views, the first step is to define the HTML representation:</p><div><pre class="programlisting">&lt;div class="viewBackground"&gt;
 &lt;div class="navigationBar"&gt;
  &lt;div id="endView_title"&gt;&lt;/div&gt;
  &lt;button class="barButton backButton" id="endView_backButton" style="left:10px" &gt;&lt;/button&gt;
 &lt;/div&gt;
 &lt;div class="content avoidNavigationBar avoidToolBar" id="endView_gameArea"&gt;
  &lt;div id="endView_resultsArea"&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="toolBar"&gt;
  &lt;button class="barButton" id="endView_tryAgainButton" style="right:10px" &gt;&lt;/button&gt;
 &lt;/div&gt;
&lt;/div&gt;</pre></div><p>I've highlighted <a id="id115" class="indexterm"/>two areas in this code: <code class="literal">resultsArea</code> where we'll tell the player how they scored, and the button in the toolbar, which this time is a <code class="literal">Try Again?</code> button. It acts just like a back button, though.</p><p>Next, we need localized content. In this case, it's both localized content and a template, as shown in the following code snippet:</p><div><pre class="programlisting">&lt;div id="endView_template_en" class="hidden"&gt;
  &lt;h2&gt;Congratulations!&lt;/h2&gt;
  &lt;p&gt;You finished that round with a score of %SCORE%!&lt;/p&gt;
  &lt;p&gt;Dated: %DATE%&lt;/p&gt;
&lt;/div&gt;

&lt;div id="endView_template_es" class="hidden"&gt;
  &lt;h2&gt;¡Felicitaciones!&lt;/h2&gt;
  &lt;p&gt;¡Se terminó la ronda con una puntuación de %SCORE%!&lt;/p&gt;
  &lt;p&gt;Fecha: %DATE%&lt;/p&gt;
&lt;/div&gt;</pre></div><p>Again, these <code class="literal">div</code> elements are hidden so that the player can't see them, but we'll take their content, replace <code class="literal">%SCORE%</code> and <code class="literal">%DATE%</code>, and then show the resulting content to the player.</p><p>Let's look at our script:</p><div><pre class="programlisting">&lt;script&gt;
  
  var endView = $ge("endView") || {};  // properly namespace
  
  endView.score = 0;</pre></div><p>First, we set the score to zero, mainly for initialization purposes. We'll provide a utility function next that sets the score to any value. As you should remember, this is called when the game is ending in the game view. This initialization is shown in the following code snippet:</p><div><pre class="programlisting">  endView.setScore = function( theScore )
  {
    endView.score = theScore;
  }</pre></div><p>As has been<a id="id116" class="indexterm"/> typical of all our previous views, we have an <code class="literal">initializeView()</code> method<a id="id117" class="indexterm"/>. What's a little different is that it doesn't localize the content area; that's because we don't know the score at this point. The <code class="literal">initializeView()</code> function is called well in advance of the game even starting, let alone being finished. This function is given as follows:</p><div><pre class="programlisting">  endView.initializeView = function ()
  {
    
    endView.viewTitle = $ge("endView_title");
    endView.viewTitle.innerHTML = __T("RESULTS"); 
    
    endView.backButton = $ge("endView_backButton");
    endView.backButton.innerHTML = __T("BACK");
    PKUI.CORE.addTouchListener(endView.backButton, "touchend", 
      function () { PKUI.CORE.popView(); });
    
    endView.nextButton = $ge("endView_tryAgainButton");
    endView.nextButton.innerHTML = __T("TRY_AGAIN?");
    
    PKUI.CORE.addTouchListener(endView.nextButton, "touchend", 
      function () { PKUI.CORE.popView(); });
  
    endView.questionArea = $ge("endView_resultsArea");
  }</pre></div><p>Notice that both buttons, the <code class="literal">back</code> button and the <code class="literal">try again</code> button do the same thing, they pop the view. This works because when we pop off the view, <code class="literal">gameView</code> will get the <code class="literal">viewWillAppear</code> notification, which resets the game.</p><p>This view also needs such a notification to set up the content area, since we'll know the score by the time <code class="literal">endView</code> appears on screen:</p><div><pre class="programlisting">  endView.viewWillAppear = function ()
  {
    var theTemplate = $geLocale("endView_template").innerHTML;
    
    theTemplate = theTemplate.replace ( "%SCORE%", 
        __N(endView.score, "2") );

    theTemplate = theTemplate.replace ( "%DATE%",  
        __D(new Date(), "D") );
    
    endView.questionArea.innerHTML = theTemplate;
  }</pre></div><a id="id118" class="indexterm"/><p>We get the properly localized template and replace <code class="literal">%SCORE%</code> with the actual score, and <code class="literal">%DATE%</code> with the current date (the <code class="literal">D</code> here means long format date). We then show it to the end user. All of this happens just prior to the view animating on screen.</p><p>We need to have code that will handle the <code class="literal">back</code> button should it be pressed, which is a pop back to the <code class="literal">gameView</code>:</p><div><pre class="programlisting">endView.backButtonPressed = function ()
  {
    PKUI.CORE.popView();
  }</pre></div><p>Astonishingly, that's it. There's really no new ground to cover here, no new methods in the framework, no new utility methods, no new localization concepts. The only thing that looks new is the <code class="literal">__D()</code> function, which, as you can probably guess, is what localizes dates. In fact, there are two more functions that are similar: <code class="literal">__C()</code>, which localizes currency and <code class="literal">__PCT()</code>, which localizes percentages. We'll be dealing with these in later apps.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec36"/>What did we do?</h2></div></div></div><p>We created the End view. We properly localized a content template, and localized both numbers and dates.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec18"/>Putting it all together</h1></div></div></div><p>We've almost got a <a id="id119" class="indexterm"/>fully functional app on our hands, but we're missing a couple of critical components: the part that loads it all and starts it off. For this, we'll be creating an <code class="literal">app.js</code> file and two HTML files under the <code class="literal">www</code> directory.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec37"/>Getting on with it</h2></div></div></div><p>The <code class="literal">index.html</code> and <code class="literal">index_android.html</code> files are what kicks everything off by loading the necessary scripts and calling <code class="literal">app.js</code>. These are typically pretty standard for each app, so they aren't going to change much throughout the rest of the book.</p><p>First, <code class="literal">index.html</code>, which is intended for iOS, is as follows:</p><div><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Chapter 1 App: Quiz Time&lt;/title&gt;
    &lt;meta name="apple-mobile-web-app-capable" content="yes" /&gt;
    &lt;meta name="viewport" content="width=device-width, maximum-scale=1.0" /&gt;
    &lt;meta name="format-detection" content="telephone=no" /&gt;
    &lt;link rel="stylesheet" href="./framework/base.css" type="text/css" /&gt;
    &lt;link rel="stylesheet" href="./style/style.css" type="text/css" /&gt;
    &lt;script type="application/javascript" charset="utf-8" src="img/cordova-2.2.0-ios.js"&gt;&lt;/script&gt;
    &lt;script type="application/javascript" charset="utf-8" src="img/utility.js"&gt;&lt;/script&gt;
    &lt;script type="application/javascript" charset="utf-8" src="img/app.js"&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div class="container" id="rootContainer"&gt;
    &lt;/div&gt;
    &lt;div id="preventClicks"&gt;&lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div><p>Next, <code class="literal">index_android.html</code>, which is for Android is as follows:</p><div><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Chapter 1 App: Quiz Time&lt;/title&gt;
    &lt;meta name="apple-mobile-web-app-capable" content="yes" /&gt;
    &lt;meta name="viewport" content="width=device-width, maximum-scale=1.0, target-densityDpi=160" /&gt;
    &lt;meta name="format-detection" content="telephone=no" /&gt;
    &lt;link rel="stylesheet" href="./framework/base.css" type="text/css" /&gt;
    &lt;link rel="stylesheet" href="./style/style.css" type="text/css" /&gt;
    &lt;script type="application/javascript" charset="utf-8" src="img/cordova-2.2.0-android.js"&gt;&lt;/script&gt;
    &lt;script type="application/javascript" charset="utf-8" src="img/utility.js"&gt;&lt;/script&gt;
    &lt;script type="application/javascript" charset="utf-8" src="img/app.js"&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div class="container" id="rootContainer"&gt;
    &lt;/div&gt;
    &lt;div id="preventClicks"&gt;&lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div><p>The <code class="literal">app.js</code> file is what actually starts our app. It is also what initializes our localization, sets our current locale,<a id="id120" class="indexterm"/> loads various libraries (such as <code class="literal">ui-core.js</code>), and finally, starts our app. Let's look at the code now:</p><div><pre class="programlisting">var APP = APP || {};    </pre></div><p>As usual, we set <a id="id121" class="indexterm"/>up our namespace, this time as APP. Next, we'll attach an event listener to the <code class="literal">deviceready</code> event; this fires whenever Cordova has finished loading its libraries. We must wait for this event before we can do much of anything, especially anything that relies on Cordova. If we don't, we'll get errors. We'll set our namespace as follows:</p><div><pre class="programlisting">document.addEventListener("deviceready", onDeviceReady, false);

function onDeviceReady()
{
  APP.start();
}</pre></div><p>All that the preceding function does is call the <code class="literal">APP.start()</code> function<a id="id122" class="indexterm"/>, which is defined as follows:</p><div><pre class="programlisting">APP.start = function ()
{
  PKUTIL.include ( [ "./framework/ui-core.js", 
                     "./framework/device.js", 
                     "./framework/localization.js" ], 
           function () { APP.initLocalization(); } );
}</pre></div><p>You've already seen <code class="literal">PKUTIL.include</code>, so it isn't anything new to you, but here we're loading three libraries, and including a <code class="literal">completion</code> function to call <code class="literal">APP.initLocalization</code>. Because the include is asynchronous, we cannot continue writing the<a id="id123" class="indexterm"/> code after this call that relies on those libraries, or there's a good chance the library wouldn't be loaded in time. Therefore, we call the <code class="literal">initLocalization</code> function when all three libraries are fully loaded.</p><p>The next function, <code class="literal">initLocalization</code>, initializes our <code class="literal">jQuery/Globalize</code> by loading its libraries and when it is complete, we load any locales we might need. When those locales are finished loading, then we call <code class="literal">APP.init</code> and this is where the real work begins. The <code class="literal">APP.init</code> function<a id="id124" class="indexterm"/> is given as follows:</p><div><pre class="programlisting">APP.initLocalization = function ()
{
  PKLOC.initializeGlobalization( 
   function ()
   {
      PKLOC.loadLocales ( ["en-US","en-AU","en-GB",
        "es-ES","es-MX","es-US","es"], 
      function ()
     {
       APP.init();
     } );
   }
  );
}</pre></div><p>The <code class="literal">APP.init()</code> function defines our app's basic translation matrix (you may see translations you've seen before; that's because they originated from here), and we also proceed to load the three views we have created into the document:</p><div><pre class="programlisting">APP.init = function ()
{ </pre></div><p>First, we fake our locale by setting it to Spanish language and the country of Spain. If you want the app to determine the locale by querying the system, comment the line out.</p><div><pre class="programlisting">  PKLOC.currentUserLocale = "es-ES";</pre></div><p>Next, we have our basic translation matrix, application titles, the translations for correct and incorrect, start, back and skip, and more:</p><div><pre class="programlisting">  PKLOC.addTranslation ("en", "APP_TITLE",     "Quiz Time");
  PKLOC.addTranslation ("en", "APP_TITLE_IMAGE", "AppTitle-enus.png");
  PKLOC.addTranslation ("en", "CORRECT",       "Correct!");
  PKLOC.addTranslation ("en", "INCORRECT",     "Incorrect.");
  PKLOC.addTranslation ("en", "START",         "Start");
  PKLOC.addTranslation ("en", "BACK",          "Back");
  PKLOC.addTranslation ("en", "SKIP",          "Skip");
  PKLOC.addTranslation ("en", "QUESTION_%1",   "Question %1");
  PKLOC.addTranslation ("en", "SCORE_%1",   "Score: %1");
  PKLOC.addTranslation ("en", "RESULTS",    "Results");
  PKLOC.addTranslation ("en", "TRY_AGAIN?",    "Try Again?");
     
  PKLOC.addTranslation ("es", "APP_TITLE",     "Examen Tiempo");
  PKLOC.addTranslation ("es", "APP_TITLE_IMAGE", "AppTitle-eses.png");
  PKLOC.addTranslation ("es", "CORRECT",       "¡Correcto!");
  PKLOC.addTranslation ("es", "INCORRECT",     "Incorrecto.");
  PKLOC.addTranslation ("es", "START",         "Comenzar");
  PKLOC.addTranslation ("es", "BACK",          "Volver");
  PKLOC.addTranslation ("es", "SKIP",          "Omitir"); 
  PKLOC.addTranslation ("es", "QUESTION_%1",   "Pregunta %1");
  PKLOC.addTranslation ("es", "SCORE_%1",   "Puntuación: %1");
  PKLOC.addTranslation ("es", "RESULTS",    "Resultados");
  PKLOC.addTranslation ("es", "TRY_AGAIN?",    "¿Intentar du nuevo?");</pre></div><p>Next, we call a function in <code class="literal">PKUI.CORE</code> called <code class="literal">initializeApplication</code>. All this function does is attach a special event handler that tracks the orientation of the device. But by doing so, <a id="id125" class="indexterm"/>it also attaches the device, the form factor, and the orientation to the <code class="literal">BODY</code> element, which is what permits us to target various platforms with CSS. This function is given as follows:</p><div><pre class="programlisting">  PKUI.CORE.initializeApplication ( );</pre></div><p>Next, we load a view, <code class="literal">gameView</code> in this case (order doesn't really matter here):</p><div><pre class="programlisting">  PKUTIL.loadHTML ( "./views/gameView.html", 
                    { id : "gameView", 
                      className: "container", 
                      attachTo: $ge("rootContainer"), 
                      aSync: true
                    },
                    function (success)
                    {
                      if (success)
                      {
                        gameView.initializeView();
                      }
                    });</pre></div><p>We call <code class="literal">PKUTIL.loadHTML</code> to accomplish this, and if you're thinking it would be a lot like <code class="literal">PKUTIL.include</code>, you'd be right. We'll look at the definition a little later, but it should suffice to say, we're loading the content inside <code class="literal">gameView.html</code>, wrapping it with another <code class="literal">div</code> with an <code class="literal">id</code> value of <code class="literal">gameView</code> and a class of <code class="literal">container</code>, attaching it to the <code class="literal">rootContainer</code>, and indicating that it can be loaded asynchronously.</p><p>Once it finishes loading, we'll call <code class="literal">initializeView()</code> on it.</p><p>We load the end view the same way as follows:</p><div><pre class="programlisting">  PKUTIL.loadHTML ( "./views/endView.html", 
                    { id : "endView", 
                      className: "container", 
                      attachTo: $ge("rootContainer"), 
                      aSync: true
                    },
                    function (success)
                    {
                      if (success)
                      {
                        endView.initializeView();
                      }
                    });</pre></div><p>We load <a id="id126" class="indexterm"/>the start view almost exactly the same way as all the others. I'll highlight the difference in the following code block:</p><div><pre class="programlisting">  PKUTIL.loadHTML ( "./views/startView.html", 
                    { id : "startView", 
                      className: "container", 
                      attachTo: $ge("rootContainer"), 
                      aSync: true
                    },
                    function (success)
                    {
                      if (success)
                      {
                        startView.initializeView();
                        PKUI.CORE.showView (startView);
                      }
                    });

}</pre></div><p>The only thing we do differently is to show <code class="literal">startView</code> after we initialize it. At this point the game is fully loaded and running, and waiting for the player to tap <strong>Start</strong>.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec38"/>What did we do?</h2></div></div></div><p>We tied everything together by creating the <code class="literal">app.js</code> file. We learned how to initialize the jQuery/Globalize library, how to fake a locale, and how to set up our translation matrix. We learned how to load views, and how to show the first one.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec39"/>What else do I need to know?</h2></div></div></div><p>Let's look at <code class="literal">PKUTIL.loadHTML</code> a little closer:</p><div><pre class="programlisting">PKUTIL.loadHTML = function( theFileName, options, completion )
{
  var aSync = options["aSync"];</pre></div><p>The first thing we do is pull out the <code class="literal">aSync</code> option, we need it to call <code class="literal">PKUTIL.load</code>. Again, the warning about WP7 and loading synchronously still applies. It is best to assume you'll always be using <code class="literal">true</code> unless you can rule WP7 out of your supported platforms. We use the <code class="literal">aSync</code> option as follows:</p><div><pre class="programlisting">  PKUTIL.load ( theFileName, aSync, function ( success, data )
  {
    if (success)
    {</pre></div><p>At this point, we've successfully loaded the HTML file, as seen in the following code snippet, and now we have to figure out what to do with it:</p><div><pre class="programlisting">      var theId = options["id"];
      var theClass = options["className"];
      var attachTo = options["attachTo"];</pre></div><p>First, we extract out the other parameters we need, namely, <code class="literal">id</code>, <code class="literal">className</code>, and <code class="literal">attachTo</code>:</p><div><pre class="programlisting">      var theElement = document.createElement ("DIV");
      theElement.setAttribute ("id", theId);
      theElement.setAttribute ("class", theClass);
      theElement.style.display = "none";
      theElement.innerHTML = data;</pre></div><p>Next, we create a <code class="literal">div</code> element, and give it <code class="literal">id</code> and <code class="literal">class</code>. We also load the data into the element as shown in the following code block:</p><div><pre class="programlisting">      if (attachTo)
      {
        attachTo.appendChild (theElement);
      }
      else
      {
        document.body.appendChild (theElement);
      }</pre></div><p>If possible, we'll attach to the element specified in <code class="literal">attachTo</code>, but if it isn't defined, we'll attach to the <code class="literal">BODY</code> element. It is at this point that we become a real DOM element in the display hierarchy.</p><p>Unfortunately this isn't all. Remember that our HTML files have <code class="literal">SCRIPT</code> tags<a id="id127" class="indexterm"/> in them. For whatever reason, these scripts don't execute automatically when loaded in this fashion. We have to create <code class="literal">SCRIPT</code> tags for them again, as shown in the following code snippet:</p><div><pre class="programlisting">      var theScriptTags = theElement.getElementsByTagName 
          ("script");</pre></div><p>First, we get all the <code class="literal">SCRIPT</code> tags in our newly created element. Then we'll iterate through each one, like this:</p><div><pre class="programlisting">      for (var i=0;i&lt;theScriptTags.length;i++)
      {
        try 
        {
          // inspired by 
          http://bytes.com/topic/javascript/answers/513633-innerhtml-script-tag
          var theScriptElement = 
              document.createElement("script");
          theScriptElement.type = "text/javascript";
          theScriptElement.charset = "utf-8";
          if (theScriptTags[i].src)
          {
            theScriptElement.src = theScriptTags[i].src;
          }
          else
          {
            theScriptElement.text = theScriptTags[i].text;
          }
          document.body.appendChild (theScriptElement);</pre></div><p>If this code looks somewhat familiar, it's because <code class="literal">PKUTIL.include</code> has a variant of it. The important distinction is that it was only concerned about the data of the script; here we have to worry if the script is defined as an external script. That is why we check to see if the <code class="literal">SRC</code> attribute is defined.</p><p>We also have surrounded this in a <code class="literal">try</code>/<code class="literal">catch</code> block, just in case the scripts have errors in them:</p><div><pre class="programlisting">        }
        catch ( err )
        {
          console.log ( "When loading " + theFileName + 
                        ", error: " + err );
        }
      }</pre></div><p>We've finished loading the HTML and the scripts, so we call the <code class="literal">completion</code> function:</p><div><pre class="programlisting">      if (completion)
      {
        completion (PKUTIL.COMPLETION_SUCCESS);
      }
    }</pre></div><p>If, for whatever reason, we couldn't load the view, we generate a log message and call the <code class="literal">completion</code> function with a failure notification as follows:</p><div><pre class="programlisting">    else
    {
      console.log ("WARNING: Failed to load " + theFileName );
      if (completion)
      {
        completion (PKUTIL.COMPLETION_FAILURE);
      }
    }
  }
  );
}</pre></div><p>Next, we should review the new localization functions we encountered. The first was <code class="literal">PKLOC.initializeGlobalization()</code>:</p><div><pre class="programlisting">PKLOC.initializeGlobalization = function ( completion )
{
    PKUTIL.include ( [ "./framework/globalize.js" ], 
        completion );
}</pre></div><p>As you can see, all it does is load the <code class="literal">jQuery/Globalize</code> framework<a id="id128" class="indexterm"/>, and then call its completion handler.</p><p>The next function is <code class="literal">PKLOC.loadLocales</code>. It is designed to make it easy to load <code class="literal">jQuery/Globalize</code> culture files. These files live in the <code class="literal">www/framework/cultures</code> directory, and you can have and load as many as you like. Just remember that the more you have, the larger your app will be, and the longer it will take to start:</p><div><pre class="programlisting">PKLOC.loadLocales = function ( theLocales, completion )
{
   for (var i=0; i&lt;theLocales.length; i++)
  {
     theLocales[i] =        
        "./framework/cultures/globalize.culture." + 
        theLocales[i] + ".js";
  }
   PKUTIL.include ( theLocales, completion );
}</pre></div><p>Here we take advantage of the fact that <code class="literal">PKUTIL.include</code> takes an array of script files. The incoming locales (in no real particular order; <code class="literal">jQuery/Globalize</code> culture files only depend upon the <code class="literal">jQuery/Globalize</code> library being loaded) are already in an array, and so we alter the array to include the full path and name of the culture file. When we're done, we include them, and the <code class="literal">completion</code> function will be called when they are all loaded.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec19"/>Game Over..... Wrapping it up</h1></div></div></div><p>Wow, we've been <a id="id129" class="indexterm"/>through a lot together in this first project. We've learned a lot too, including:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">How to properly localize text</li><li class="listitem" style="list-style-type: disc">How to properly localize numbers</li><li class="listitem" style="list-style-type: disc">How to properly localize dates</li><li class="listitem" style="list-style-type: disc">How to properly localize images</li><li class="listitem" style="list-style-type: disc">How to properly localize HTML</li><li class="listitem" style="list-style-type: disc">How to implement simple HTML templates</li><li class="listitem" style="list-style-type: disc">How to create a new view</li><li class="listitem" style="list-style-type: disc">How to display the view</li><li class="listitem" style="list-style-type: disc">How to push a new view onscreen, and pop a view offscreen</li><li class="listitem" style="list-style-type: disc">How to handle the Android/WP7 back button</li><li class="listitem" style="list-style-type: disc">How to include files within our JavaScript</li><li class="listitem" style="list-style-type: disc">How to determine the user's locale</li><li class="listitem" style="list-style-type: disc">How to initialize jQuery/Globalize and load the locales we might need</li></ul></div><p>There are some resources that you might find interesting. You might want to look through the YASMF documentation to learn more about the framework we're using. Some of these resources are mentioned as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Adobe Photoshop at <a class="ulink" href="http://www.adobe.com/PhotoshopFamily">http://www.adobe.com/PhotoshopFamily</a></li><li class="listitem" style="list-style-type: disc">GIMP at <a class="ulink" href="http://www.gimp.org">http://www.gimp.org</a></li><li class="listitem" style="list-style-type: disc">PhoneGap downloads at <a class="ulink" href="http://www.phonegap.com/download">http://www.phonegap.com/download</a></li><li class="listitem" style="list-style-type: disc">PhoneGap documentation at <a class="ulink" href="http://docs.phonegap.com">http://docs.phonegap.com</a></li><li class="listitem" style="list-style-type: disc">YASMF GitHub at <a class="ulink" href="https://github.com/photokandyStudios/YASMF/">https://github.com/photokandyStudios/YASMF/</a></li><li class="listitem" style="list-style-type: disc">YASMF documentation at <a class="ulink" href="https://github.com/photokandyStudios/YASMF/wiki/">https://github.com/photokandyStudios/YASMF/wiki/</a></li><li class="listitem" style="list-style-type: disc">Xcode at <a class="ulink" href="https://developer.apple.com/xcode">https://developer.apple.com/xcode</a></li><li class="listitem" style="list-style-type: disc">Eclipse Classic 4.2.1 at <a class="ulink" href="http://www.eclipse.org/downloads/packages/eclipse-classic-421/junosr1">http://www.eclipse.org/downloads/packages/eclipse-classic-421/junosr1</a></li><li class="listitem" style="list-style-type: disc">Android SDK download at <a class="ulink" href="http://developer.android.com/sdk/index.html">http://developer.android.com/sdk/index.html</a></li></ul></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec20"/>Can you take the HEAT? The Hotshot Challenge</h1></div></div></div><p>There are quite <a id="id130" class="indexterm"/>a few ways that this project could be enhanced. Why don't you try your hand at one or more of them?</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The game currently supports English and Spanish. Try adding another language.</li><li class="listitem" style="list-style-type: disc">If you play the game for any length of time, you'll find that the same question is often asked again within the same set. Make it so that a question can only be asked once per set.</li><li class="listitem" style="list-style-type: disc">Add categories to the questions, and then allow the user to select which category they'd like to play through.</li><li class="listitem" style="list-style-type: disc">Add difficulty levels to the questions. These could affect the score awarded as well. Allow the user to select the difficulty level they want to play at.</li><li class="listitem" style="list-style-type: disc">Come up with an alternative look and feel for the game and implement it. Perhaps even allow the user to decide which look and feel they want to use.</li></ul></div></div></body></html>