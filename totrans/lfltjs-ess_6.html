<html><head></head><body>
  <div id="sbo-rt-content"><div class="chapter" title="Chapter 6. Leaflet in Node.js, Python, and C#"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Leaflet in Node.js, Python, and C#</h1></div></div></div><p>In the first five chapters, you covered the fundamentals of Leaflet.js. You now know how to add a wide variety of basemaps from multiple sources and in several different formats. You can draw simple geometries as well as display data from servers, GeoJSON, and ESRI file formats. Creating visualizations from your data was covered in <a class="link" href="ch03.html" title="Chapter 3. Creating Heatmaps and Choropleth Maps">Chapter 3</a>, <span class="emphasis"><em>Creating Heatmaps and Choropleth Maps</em></span>. You also know how to customize the look and feel of your markers now and how to utilize plugins in order to add extra functionalities to your map.</p><p>In this last chapter, you will learn how to build applications utilizing Leaflet.js in three popular programming frameworks: Node.js, Python, and C#. In Node.js and Python, you will build a server to render your web page and allow for AJAX calls to display additional data. In the last example, using C#, you will build a desktop Windows application that embeds a web page into a form, connects to MongoDB, and retrieves data using a general search and a spatial search.</p><p>While you are not expected to have a working knowledge of either of these three frameworks, Node.js is a JavaScript framework and the examples should be easy to follow. The Python and C# examples might be a little different from what you are used to; however, the main ideas should be easy to grasp and they will give you an idea of how you can think of using Leaflet in larger applications. Furthermore, starting to think about how Leaflet can interact with the server side will expand your ability to dream up new and exciting applications, utilizing libraries and resources from multiple frameworks.</p><p>The first example will start with the most familiar framework, Node.js.</p><div class="section" title="Building Leaflet applications with Node.js"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec47"/>Building Leaflet applications with Node.js</h1></div></div></div><p>Node.js is a JavaScript-based <a id="id427" class="indexterm"/>platform that builds<a id="id428" class="indexterm"/> non-blocking applications. The non-blocking feature is what has made Node.js extremely popular. Think about how you code. You complete tasks step-by-step. You might jump around in your code, calling functions and responding to events, but you wait until one action is complete before you start the next. With Node.js, you assign callbacks and move on to the next task or handle the next request. Take a database search, for example. In the following pseudocode, you retrieve a record and do something with it in the traditional manner:</p><div class="informalexample"><pre class="programlisting">var result = SELECT * from MyTable;
document.getElementById['results'].innerHTML= result;</pre></div><p>In the example, you wait for the database to <a id="id429" class="indexterm"/>send back the results, and then you move on to displaying them. In Node.js, you would do something<a id="id430" class="indexterm"/> similar but assign a callback function, as shown in the following example:</p><div class="informalexample"><pre class="programlisting">function showResults(){document.getElementById['results'].innerHTML= result;};
var result = query(SELECT * from MyTable, showResults);
doWhateverElseYouNeed();</pre></div><p>The preceding code will query the database and move on to the <code class="literal">doWhateverElseYouNeed</code> function until the query is finished, at which point it will execute the <code class="literal">showResult</code> callback function. This can be very confusing and make your code difficult to read, but it is very powerful, and on the server side, it allows for a large number of connections.</p><p>Now that you have an idea of what Node.js can do, you can download it at <a class="ulink" href="http://nodejs.org/">http://nodejs.org/</a>. Follow the<a id="id431" class="indexterm"/> instructions to install Node.js based on your operating system. Once it is installed, you will have a command-line interface and a Node.js window on Windows. Using the command line, you can launch your applications and install additional packages, which you will learn to do in a later example.</p><div class="section" title="A basic Node.js server with Leaflet"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec52"/>A basic Node.js server with Leaflet</h2></div></div></div><p>In this first example, you will <a id="id432" class="indexterm"/>create a simple Node.js server and serve <code class="literal">LeafletEssentials.html</code>. You can write your code in<a id="id433" class="indexterm"/> any text editor and save it as a <code class="literal">.js</code> file.</p><p>Create a folder to store your files and place a copy of <code class="literal">LeafletEssentials.html</code> in the folder. This will be the file that we are going to serve with Node.js. Next, you will create the server as shown in the following code:</p><div class="informalexample"><pre class="programlisting">require('http').createServer(function (req, res) {
   if ('/' == req.url){
         res.writeHead(200, { 'Content-Type': 'text/html' });
   require('fs').createReadStream('leafletessentials.html') .pipe(res);
        } 
}).listen(3000);</pre></div><p>The preceding code uses two modules: <code class="literal">http</code> and <code class="literal">fs</code>. You import these modules using <code class="literal">require(module)</code>. Both of these modules are standard Node.js modules and do not require any additional downloads. The preceding code imports the <code class="literal">http</code> module and then calls the <code class="literal">createServer()</code> method. It uses an anonymous function that takes a request and a response—<code class="literal">req</code> and <code class="literal">res</code>, respectively. The <code class="literal">if</code> block tests to see whether the request to the server is equal to the<a id="id434" class="indexterm"/> root directory; in this example, whether the browser is pointed to <code class="literal">http://localhost:3000</code>. The last line of code is listening on port 3000. If the request is to the root directory, then the code writes a header. It is beyond the scope of this book to cover the HTTP protocol and headers. However, know that when a response is sent, it is status 200 if successful and status 404 if it is not successful, and the response has the content type <code class="literal">text/html</code>. Lastly, the code imports the <code class="literal">fs</code> module and uses <code class="literal">pipe()</code> to read in and write out<a id="id435" class="indexterm"/> the contents of <code class="literal">LeafletEssentials.html</code>. Pipe is the preferred method for sending files; however, you could also manually write the HTML as a string using <code class="literal">res.end('the HTML')</code>. Piping allows you to do some neat things, such as reading and writing out a video file so that the user can play it while it is still receiving data from the server. Writing out HTML as a string will make your code long and complicated; never mind trying to escape all the quotes required in most HTML. In the last example, you will learn about a templating library in which you can store your HTML.</p><p>Using the command in tool, navigate to the directory that holds your <code class="literal">server.js</code> code and run it by typing <code class="literal">node server.js</code>. Point your browser to <code class="literal">http://localhost:3000</code>. You should see your loaded map as shown:</p><div class="mediaobject"><img src="images/4812OS_06_01.jpg" alt="A basic Node.js server with Leaflet"/></div><p>The preceding<a id="id436" class="indexterm"/> example <a id="id437" class="indexterm"/>simply serves a single file, and if the user points their browser to any other URL, such as <code class="literal">http://localhost:3000/about.html</code>, they will not see anything, not even an error message. The next example fixes this.</p></div><div class="section" title="Node.js, AJAX, and Leaflet"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec53"/>Node.js, AJAX, and Leaflet</h2></div></div></div><p>Now that you have a Node.js server running and serving up a Leaflet web page, you can use the same server to make <span class="strong"><strong>Asynchronous JavaScript and XML</strong></span> (<span class="strong"><strong>AJAX</strong></span>) calls. You are programming in<a id="id438" class="indexterm"/> JavaScript, so even though there is XML in <a id="id439" class="indexterm"/>AJAX, you should use JSON; it is much easier to handle than XML in JavaScript. Building on the first example, the following code adds another page and sends an error message on bad requests:</p><div class="informalexample"><pre class="programlisting"> require('http').createServer(function (req, res) {
   if ('/' == req.url){
         res.writeHead(200, { 'Content-Type': 'text/html' });
   require('fs').createReadStream('leafletessentialsAjax.html') .pipe(res);
        } else if ('/getpoints'==req.url){
         res.writeHead(200, { 'Content-Type': 'application/json' });
         res.end(JSON.stringify([{"lat":35,"long":-106}]));
   } else {
         res.writeHead(404);
         res.end('The page you requested '+req.url+' was not found');
   }
}).listen(3000);</pre></div><p>The preceding code makes two changes to the first example; it adds two new routes. The first <code class="literal">if</code> statement is the same, returning <code class="literal">LeafletEssentials.html</code>. The <code class="literal">else if</code> statement checks to see whether the browser is pointed at <code class="literal">http://localhost:3000/getpoints</code>. If it is, then the server returns a JSON string, <code class="literal">[{"lat":35,"long":-106}]</code>. Lastly, if the user requests a page that doesn't exist, the server will return a 404 error message saying that the page is not found and will return the value of the page they were looking for—<code class="literal">req.url</code>.</p><p>The preceding server requires a change to your <code class="literal">LeafletEssentials.html</code> file. You will need a subscriber for the <code class="literal">click</code> event and to make an AJAX call when it occurs. Before AJAX, you will need to submit a form or make a request to the server and then be redirected to a new page that would display the results. AJAX allows you to make a request to the server, have the results returned, and display them without reloading the entire page. In this<a id="id440" class="indexterm"/> example, you will make an AJAX call to the <code class="literal">getpoints</code> URL. You will receive a JSON representation of a point. Then, you will add a marker that will represent the returned point—all without refreshing the web page:</p><div class="informalexample"><pre class="programlisting">map.on('click',function(){
var xhReq = new XMLHttpRequest();
xhReq.open("GET", "getpoints", true); 
xhReq.send(); 
var serverResponse = xhReq.responseText;
var d=JSON.parse(serverResponse);
L.marker([d[0].lat,d[0].long]).addTo(map).bindPopup("Added via AJAX call to Node.js").openPopup();
});</pre></div><p>Without getting too deeply into the details of AJAX, the preceding code creates an <code class="literal">XMLHttpRequest</code> instance and opens the <code class="literal">getpoints.html</code> web page.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note30"/>Note</h3><p>For a quick lesson on <code class="literal">XMLHttpRequest</code>, check out the W3Schools website at <a class="ulink" href="http://www.w3schools.com/xml/xml_http.asp">http://www.w3schools.com/xml/xml_http.asp</a>.</p></div></div><p>It then receives the response, parses out the points separated by a comma, and then adds them to the map as a marker. You're only receiving a single point, so the <code class="literal">d</code> variable only has a single value, which is represented by <code class="literal">d[0]</code>. Objects in JavaScript are used by calling the object and then the value of a field, in this case, <code class="literal">d[0].lat</code> and <code class="literal">d[0].long</code>.</p><p>Your map will <a id="id441" class="indexterm"/> look exactly as it did in the first example. When you click on the map, you will see another point, and your map will look like the following screenshot:</p><div class="mediaobject"><img src="images/4812OS_06_02.jpg" alt="Node.js, AJAX, and Leaflet"/></div><p>This example returns the same point when the user clicks on the map. This example can be improved by returning a different point every time the user clicks on the map. To do so, simply use a random number generator to return a new latitude and longitude. The key here is to set the maximum and minimum values so that the point is close to our current location. The following code uses <code class="literal">Math.random()</code> to return different values. To do so, replace the <code class="literal">res.end(JSON.stringify([{"lat":35,"long":-106}]));</code> line in the server code with the following code:</p><div class="informalexample"><pre class="programlisting">var lat=Math.random()*(36-35)+35;
var lon=Math.random()*(-107+106)-106;
res.end(JSON.stringify([{"lat":lat,"long":lon}]));</pre></div><p>Now, when the user clicks on the map, the points will appear at random. After several clicks, your <a id="id442" class="indexterm"/> map should look like this:</p><div class="mediaobject"><img src="images/4812OS_06_03.jpg" alt="Node.js, AJAX, and Leaflet"/></div></div><div class="section" title="Node.js, Connect, and Leaflet"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec54"/>Node.js, Connect, and Leaflet</h2></div></div></div><p>In the previous example, you had to write the path for every possible URL. A user could type that path in your domain. You allowed two possibilities and sent an error for every other possibility. If you have a website with many pages, you would not want to type an <code class="literal">if</code> statement for every URL. Connect is a<a id="id443" class="indexterm"/> module that provides a middleware code for common tasks. The middleware allows you to accomplish these common tasks with minimal work on your part; you just need to use the <code class="literal">use()</code> function.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note31"/>Note</h3><p>You can learn<a id="id444" class="indexterm"/> about Connect at <a class="ulink" href="http://www.senchalabs.org/connect/">http://www.senchalabs.org/connect/</a>.</p></div></div><p>To install Connect, open<a id="id445" class="indexterm"/> the command-line tool for Node.js and enter the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>npm install –g connect</strong></span>
</pre></div><p>npm is a Node.js package manager. The preceding<a id="id446" class="indexterm"/> command launches the package manager and asks it to install Connect. The <code class="literal">–g</code> switch<a id="id447" class="indexterm"/> is to install it globally so that it is available everywhere on the machine. When Connect is installed, your command prompt will look like this:</p><div class="mediaobject"><img src="images/4812OS_06_04.jpg" alt="Node.js, Connect, and Leaflet"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note32"/>Note</h3><p>Make note of the version that is installed because you will need this in a later step.</p></div></div><p>Once you have Connect <a id="id448" class="indexterm"/>installed, you can start the example. This example will create a simple server that will only serve static files. Perform the following steps to create the server:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Make a <code class="literal">project</code> folder and place another folder inside and name it <code class="literal">www</code>.</li><li class="listitem">Place several HTML files in the directory, but especially <code class="literal">LeafletEssentials.html</code> and <code class="literal">getpoints.json</code>. You can use the sample included with the book or you can create your own. A minimum <code class="literal">getpoints.json</code> file would contain the following contents:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[{"lat":35,"long":-106}]</strong></span>
</pre></div><p>The contents of the file are a single point represented in JSON. You can add as many points as you like. You can even write a script to update the contents of the file at a set interval.</p></li><li class="listitem">Next, in the main project<a id="id449" class="indexterm"/> folder, create a file with the following contents and name it <code class="literal">package.json</code>. Note that this example is using a version of Connect prior to Version 3:<div class="informalexample"><pre class="programlisting">{
"name": "leafletessentials",
"version": "0.0.1",
"dependencies": {"connect": "2.21.1"}
}</pre></div><p>This file is used to build the project. At the command line, navigate to your <code class="literal">project</code> directory and type <code class="literal">npm install</code>. The package manager will read the <code class="literal">package.json</code> file and create a new subfolder in your <code class="literal">project</code> folder named <code class="literal">Node_modules</code>.</p></li><li class="listitem">Open the folder <a id="id450" class="indexterm"/>and you will see another folder with all of the files for the Connect module. Before writing the server, you need to make a change in <code class="literal">LeafletEssentialsAjax.html</code>. The code for the AJAX call needs to point to the <code class="literal">getpoints.json</code> file. Now you are ready to write the server.</li></ol></div><p>The first thing to do is to import the Connect module with <code class="literal">require()</code> and assign it to a variable. Create a server by calling <code class="literal">connect()</code>. And lastly, invoke the middleware <code class="literal">static()</code> and ask it to take the <code class="literal">www</code> directory and serve all files within it. The <code class="literal">_dirname</code> variable takes the current directory and concatenates it with the <code class="literal">/www</code> directory, giving the path to your files as shown in the following code. Listen on any available port:</p><div class="informalexample"><pre class="programlisting">var connect = require('connect')
var server = connect();
server.use(connect.static(__dirname+ '/www'));
server.listen(3000);</pre></div><p>The code is much shorter than the previous examples. There are no <code class="literal">if ('/' == req.url)</code> statements. The middleware knows all the files in the directory, and if a URL that matches a filename is requested, it will be sent. If it does not exist, the middleware will send the error page. If you add a new HTML file, it will be served up as soon as it is placed in the folder and requested. Now, when you connect and get your map, you can click on it, and the contents of <code class="literal">getpoints.json</code> will be returned and displayed on the map.</p></div><div class="section" title="Node.js, Express, Jade, and Leaflet"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec55"/>Node.js, Express, Jade, and Leaflet</h2></div></div></div><p>In the first two examples, you had to create a static HTML file for the server to serve to the client. In this example, you will use a template that allows you to pass variables to the HTML when loaded. This will allow you to create dynamic data-driven websites.</p><p>For this example, you will<a id="id451" class="indexterm"/> need to install the Jade module for Node.js. To do so, open the command-line tool and enter the<a id="id452" class="indexterm"/> following command. This is the same procedure as the previous example.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>echo '{}' &gt; package.json</strong></span>
<span class="strong"><strong>npm install jade –save</strong></span>
</pre></div><p>Now, you have the Jade module installed globally. You will also need to install Express. Express is one of the most <a id="id453" class="indexterm"/>popular web frameworks that can be used with Node.js. It is similar to Connect, but in this example, it is the tool that allows us to use a view engine, which is Jade. Again, type the following command and make sure that you note the installed versions:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>echo '{}' &gt; package.json</strong></span>
<span class="strong"><strong>npm install express –save</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note33"/>Note</h3><p>For more information<a id="id454" class="indexterm"/> on Express and Jade, you can go to the website for Express at <a class="ulink" href="http://expressjs.com/">http://expressjs.com/</a> and for<a id="id455" class="indexterm"/> Jade at <a class="ulink" href="http://jade-lang.com/">http://jade-lang.com/</a>.</p></div></div><p>Now that you have both modules installed, create a folder for your application. In the folder, you will need to create the <code class="literal">package.json</code> file. In this example, you have two dependencies, so your file should look like the following code:</p><div class="informalexample"><pre class="programlisting">{
"name": "leafletessentials",
"version": "0.0.1",
"dependencies": {
   "express": "4.4.5",
   "jade": "1.3.1"
 }
}</pre></div><p>Using the command-line tool, navigate to the application directory and use npm to add the dependencies using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>npm install</strong></span>
</pre></div><p>You will now have a <code class="literal">Node.js_modules</code> folder with the <code class="literal">Jade</code> and <code class="literal">Express</code> subfolders. You will need a directory to hold or view the template file. This folder needs to be named <code class="literal">views</code> because that is where Express will look. Create the directory and then open a text editor to create your view. For a quick introduction to Jade, you can read the tutorial at <a class="ulink" href="http://jade-lang.com/tutorial/">http://jade-lang.com/tutorial/</a>. The<a id="id456" class="indexterm"/> important thing to note is that Jade is whitespace sensitive, and hence indentations must be exact. This can be extremely frustrating at first. The following template is the modified <code class="literal">LeafletEssentials.html</code> file that you<a id="id457" class="indexterm"/> have been using in the previous examples. One key difference is the fourth line: <code class="literal">title = title</code>. This line sets the title of the HTML document to the value of a variable, <code class="literal">title</code>, in the server code:</p><div class="informalexample"><pre class="programlisting">doctype html
html(lang="en")
   head
          title= title
link(rel='stylesheet', href='http://cdn.leafletjs.com/leaflet- 0.7.2/leaflet.css')
script(src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js")
   body
   #map(style='width:'+900+'px;'+'height:'+800+'px')
   script(type='text/javascript').
var map = L.map('map', {center: [35.10418, -106.62987],	zoom: 9});
var base = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png').addTo(map);
L.marker([35.10418, -106.62987]).addTo(map).bindPopup("A Lonely Marker").openPopup();
map.on('click',function(){var xhReq = new XMLHttpRequest();xhReq.open("GET", "getpoints", false);xhReq.send(null);var serverResponse = xhReq.responseText;var d=JSON.parse(serverResponse);L.marker ([d[0].lat,d[0].long]).addTo(map).bindPopup ("Added via AJAX call to Node.js").openPopup();});</pre></div><p>Save the preceding code in a file named <code class="literal">LeafletEssentials.jade</code> within your view folder. Now, you are ready to write the server.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note34"/>Note</h3><p>Jade is a popular and powerful template module; however, there are others too. Two others that might be easier to learn at<a id="id458" class="indexterm"/> first are HAML at <a class="ulink" href="http://haml.info/">http://haml.info/</a> and <a id="id459" class="indexterm"/>EJS at <a class="ulink" href="http://embeddedjs.com/">http://embeddedjs.com/</a>.</p></div></div><p>The code for the server is as follows:</p><div class="informalexample"><pre class="programlisting">var express=require('express')
var app = express();
app.set('view engine', 'jade');
app.get('/', function(req,res){
   res.render('LeafletEssentials',{title:"Leaflet Essentials"});
   	});
app.get('/getpoints', function(req,res){
   res.send([{'lat':35,'long':-106])
});
var server = app.listen(3000);</pre></div><p>The preceding code imports the Express module and assigns it to a variable. It then creates an app with Express. The view engine defaults to Jade, but if you want to use another, you need the third line to set the appropriate engine. The next lines use <code class="literal">app.get()</code> to specify the two URLs that our application will return. The first one will return our view and the second is for the AJAX call and returns a point in JSON. In the first AJAX example, you needed to specify <code class="literal">JSON.stringify()</code> when you returned the point. One of the reasons to use a framework is that it takes care of many common tasks for you. In this case, Express<a id="id460" class="indexterm"/> will know what it is you are returning and set the value accordingly. In this example, you are returning a JSON string, and Express will automatically JSONify it for you.</p><p>Your map will look just like the one in the previous examples, and when the user clicks, a point will be added. The next examples will use Python to serve a Leaflet application.</p></div></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Leaflet with Python and CherryPy"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec48"/>Leaflet with Python and CherryPy</h1></div></div></div><p>The Python<a id="id461" class="indexterm"/> programming language is extremely powerful and has a large number of standard libraries and other third-party libraries. It is<a id="id462" class="indexterm"/> also fairly easy to pick up for simple tasks. There is extensive<a id="id463" class="indexterm"/> documentation, and a large number of books and different libraries are available on the language. You can download<a id="id464" class="indexterm"/> Python from the Python website at <a class="ulink" href="https://www.python.org/downloads/">https://www.python.org/downloads/</a>. Version 3 is the latest; however, Version 2.7 is still in use. It is probably best to start learning with Version 3, but if you have v2.7, it will<a id="id465" class="indexterm"/> work with the<a id="id466" class="indexterm"/> examples.</p><p>In this example, you will use the <a id="id467" class="indexterm"/>CherryPy library. You can download the library at <a class="ulink" href="http://www.cherrypy.org/">http://www.cherrypy.org/</a>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note35"/>Note</h3><p>For more books on CherryPy and Python web development, visit <a class="ulink" href="http://www.packtpub.com/CherryPy/book">http://www.packtpub.com/CherryPy/book</a> or <a class="ulink" href="http://www.packtpub.com/python-3-web-development-beginners-guide/book">http://www.packtpub.com/python-3-web-development-beginners-guide/book</a>.</p></div></div><p>CherryPy is a<a id="id468" class="indexterm"/> smaller web framework compared to Django or Pyramid—formerly Pylons. For this example, it will allow you to get up and running quickly without much overhead. To manually install a third-party Python library, extract it to a folder and run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>python setup.py install</strong></span>
</pre></div><p>After running the command, you will be able to import the library in your Python code. For this example, you will connect to a NoSQL database: MongoDB. MongoDB is a document database. It stores<a id="id469" class="indexterm"/> everything as a JSON-style document, not in relational tables. While it's not as spatially enabled as PostGIS, which is an extension to PostgreSQL, it has<a id="id470" class="indexterm"/> a few spatial features that make it an excellent choice for a Leaflet backend. You can download <a id="id471" class="indexterm"/>MongoDB at <a class="ulink" href="http://www.mongodb.org/">http://www.mongodb.org/</a>.</p><p>To use MongoDB with Python, you will also need to download and install PyMongo. You can download the library at <a class="ulink" href="https://pypi.python.org/pypi/pymongo/">https://pypi.python.org/pypi/pymongo/</a>. Once you have your <a id="id472" class="indexterm"/>environment set up, you can start your MongoDB by running the application mongod.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note36"/>Note</h3><p>If you receive an error about a missing path, you will need to add the <code class="literal">C:\data\db</code> directory. Just create the folders and then rerun mongod. On Linux and OS X, execute <code class="literal">mkdir -p /data/db</code> to add the data directory.</p></div></div><p>Your<a id="id473" class="indexterm"/> database is empty. The <code class="literal">pa.py</code> Python file that is available on these books' website will create a database and populate it with the public art<a id="id474" class="indexterm"/> data that was used in earlier chapters of this book. The file looks like the following code:</p><div class="informalexample"><pre class="programlisting">from pymongo import Connection
from pymongo import GEO2D
db=Connection().albuquerque
db.publicart.create_index([("loc",GEO2D)])
db.publicart.insert({"loc":[35.1555,-106.591838],"name":"Almond Blossom/Astronomy","popup":http://farm8.staticflickr.com/7153/6831137393_fa38634fd7_m.jpg })
  db.publicart.insert({"loc":[35.0931,-106.664177], "name":"Formas Esperando Palabra de Otros Mundos","popup": "http://farm3.staticflickr.com/2167/2479129916_0d861b2600.jpg"})
print " Completed…"</pre></div><p>The preceding code imports two modules from the PyMongo library: Connection and GEO2D. The first handles our connection to the DB and the second allows us to spatially enable it. The next line makes a connection to a database called <code class="literal">albuquerque</code>. Next, a spatially enabled index is created for a collection called <code class="literal">publicart</code> and it indexes the <code class="literal">loc</code> field. The next two lines are public art points that are inserted into the collection. They each contain a location, name, and pop-up field that contains the URL to an image of the piece.</p><p>Execute the file by typing <code class="literal">python pa.py</code>. Your MongoDB will now have a database, collection, and enough data to allow<a id="id475" class="indexterm"/> you to try some samples.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note37"/>Note</h3><p>If you ever delete, corrupt, or just want to refresh your database, you can run this file over again to start a fresh.</p></div></div><p>Now that you<a id="id476" class="indexterm"/> have your database running and populated and have Python installed with CherryPy and PyMongo, you are now ready to write your<a id="id477" class="indexterm"/> first server:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step is to import the Python libraries as follows:<div class="informalexample"><pre class="programlisting">import cherrypy
from pymongo import Connection,GEO2D</pre></div></li><li class="listitem">Next, you create a class and a function that will represent the URL to your application. In this example, it will be the <code class="literal">index</code> function:<div class="informalexample"><pre class="programlisting">class mongocherry(object):    
    def index(self):</pre></div></li><li class="listitem">The function <a id="id478" class="indexterm"/>will first create an array to hold the contents of an HTML file. You can append the contents of <code class="literal">LeafletEssentials.html</code> up until you add the tile layer basemap:<div class="informalexample"><pre class="programlisting">output =[]

output.append("&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;QUERY MONGODB&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;&lt;h1&gt;Query MongoDB&lt;/h1&gt;&lt;link rel='stylesheet' href='http://cdn.leafletjs.com/leaflet- 0.7.2/leaflet.css' /&gt;&lt;style&gt; html, body, #map {padding: 0;margin: 0;height: 100%;}&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;script src='http://cdn.leafletjs.com/leaflet- 0.7.2/leaflet.js'&gt;&lt;/script&gt;&lt;div id='map'&gt;&lt;/div&gt;&lt;script&gt;var map = L.map('map',{center: [35.10418, -106.62987],zoom: 9});L.tileLayer ('http://{s}.tile.osm.org/{z}/{x}/{y}.png').addTo(map);")</pre></div></li><li class="listitem">Now, create the database connection and search for all documents in the collection named <code class="literal">publicart</code>. The <code class="literal">find()</code> function will return a large number of records. On each record, you will append an HTML string, creating a marker using the record. The location field creates the marker and the name and pop-up fields are added to the markers' pop up:<div class="informalexample"><pre class="programlisting">db=Connection().albuquerque
for x in db.publicart.find():
output.append("L.marker(["+str(x["loc"][0])+","+str(x["loc" ][1])+"]).addTo(map).bindPopup(\""+x["name"]+"&lt;img src='"+x["popup"]+"'&gt;\");")</pre></div></li><li class="listitem">Once all the documents are added, you can append the closing HTML tags to the array. Then, convert the array to a string so that you can return it when the user requests the<a id="id479" class="indexterm"/> index of the<a id="id480" class="indexterm"/> application as follows:<div class="informalexample"><pre class="programlisting">output.append('&lt;/SCRIPT&gt;&lt;/BODY&gt;&lt;/HTML&gt;')
i=0
html=""
while i&lt;len(output):
   html+=str(output[i])
   i+=1
return html</pre></div></li><li class="listitem">Lastly, you need<a id="id481" class="indexterm"/> to expose the <code class="literal">index</code> function, set the address and port the application will use, and then start<a id="id482" class="indexterm"/> the server by calling the classname:<div class="informalexample"><pre class="programlisting">index.exposed = True
cherrypy.config.update({'server.socket_host': '127.0.0.1',
'server.socket_port': 8000,
}) 
cherrypy.quickstart(mongocherry())</pre></div></li></ol></div><p>When you have finished, run the program by opening a command line and typing the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>python mongocherry.py</strong></span>
</pre></div><p>Open a browser and point it to <code class="literal">http://127.0.0.1:8000</code>. You should see a map like the following one:</p><div class="mediaobject"><img src="images/4812OS_06_05.jpg" alt="Leaflet with Python and CherryPy"/></div><p>The application<a id="id483" class="indexterm"/> returned the contents<a id="id484" class="indexterm"/> of your MongoDB and displayed them in a Leaflet map. Now that you know how to create a URL<a id="id485" class="indexterm"/> route in an application, let's expand<a id="id486" class="indexterm"/> on this example to add an AJAX call for spatial searches.</p><div class="section" title="Spatial queries with Python, MongoDB, and Leaflet"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec56"/>Spatial queries with Python, MongoDB, and Leaflet</h2></div></div></div><p>MongoDB allows you<a id="id487" class="indexterm"/> to access spatial queries. You can search for results near a single point, near a point by setting a maximum distance, within a bounding rectangle, or <a id="id488" class="indexterm"/>within a circle. In this example, you<a id="id489" class="indexterm"/> will query for results<a id="id490" class="indexterm"/> near a point.</p><p>Import the<a id="id491" class="indexterm"/> required libraries. In the following code, you will<a id="id492" class="indexterm"/> import two new module tools from the <code class="literal">cherrypy</code> library and <code class="literal">json</code>:</p><div class="informalexample"><pre class="programlisting">import cherrypy
from pymongo import Connection,GEO2D
from cherrypy import tools
import json</pre></div><p>After importing the libraries, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the class. Using tools, you will expose the function with the <code class="literal">@</code> sign. Connect to the database and write out the HTML code. The HTML code in this example is different. You will add a listener for the <code class="literal">click</code> event. The code for this block will make an AJAX call to the <code class="literal">getdata</code> page and pass it the <code class="literal">(x,y)</code> coordinates of the <code class="literal">click</code> event. The data returned will only contain three objects, so you can hardcode the HTML instead of running a <code class="literal">for</code> loop as follows:<div class="informalexample"><pre class="programlisting">class mongocherry(object):
    @cherrypy.expose
    def index(self):
         db=Connection().albuquerque
         output =[]
    output.append("&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;QUERY MONGODB&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;&lt;h1&gt;Query MongoDB&lt;/h1&gt;&lt;link rel='stylesheet' href='http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css' /&gt;&lt;style&gt; html, body, #map {padding: 0;margin: 0;height: 100%;}&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;script src='http://cdn.leafletjs.com/leaflet- 0.7.2/leaflet.js'&gt;&lt;/script&gt;&lt;div id='map'&gt;&lt;/div&gt;&lt;script&gt;var lat; var lon; var map = L.map('map',{center: [35.10418, - 106.62987],zoom: 9});L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png') .addTo(map);map.on('click',function(e){var a=String(e.latlng).split(\",\");lat=a[0].split(\"(\");lon=a [1].split(\")\");var xhReq = new XMLHttpRequest();var s=\"getdata?x=\";var s2=String(lat[1]);var s3=\"&amp;y=\";var s4=String(lon[0]);var url=s.concat(s2,s3,s4); xhReq.open(\"GET\", url, false); xhReq.send(null); var serverResponse = xhReq.responseText; var d=JSON.parse(serverResponse);L.marker([d[0].lat,d[0].long]) .addTo(map);L.marker([d[1].lat,d[1].long]).addTo(map);L.mar ker([d[2].lat,d[2].long]).addTo(map);});")</pre></div></li><li class="listitem">Next, close the <a id="id493" class="indexterm"/>HTML tags, convert them<a id="id494" class="indexterm"/> to a string, and return them<a id="id495" class="indexterm"/> when the <code class="literal">page</code> function  is called:<div class="informalexample"><pre class="programlisting">   output.append("&lt;/SCRIPT&gt;&lt;/BODY&gt;&lt;/HTML&gt;")
   i=0
   html=""
   while i&lt;len(output):
         html+=str(output[i])
         i+=1

  return html </pre></div></li><li class="listitem">Now, you will define<a id="id496" class="indexterm"/> and expose another URL function. This one will be called <code class="literal">getdata</code> and it will handle the AJAX call from the users' click. This function gets passed the <code class="literal">x</code> and <code class="literal">y</code> variables. These will be the coordinates of the users' click. The query in this example is different<a id="id497" class="indexterm"/> than the previous example. Notice that you use <code class="literal">find()</code> but add <code class="literal">$near</code> and pass<a id="id498" class="indexterm"/> it the coordinates of the users' click. The search is set to only return three results. Lastly, you pass back the results as JSON using <code class="literal">@tools.json_out()</code>, as follows:<div class="informalexample"><pre class="programlisting">    @cherrypy.expose
    @tools.json_out()
    def getdata(self,x,y):
   db=Connection().albuquerque
   data=[]
   lat=float(x)
   long=float(y)
   for doc in db.publicart.find({"loc": {"$near": [lat, long]}}).limit(3): 
    data.append({'lat':str(doc["loc"][0]),'long':str(doc["loc"][1])})
  return data</pre></div></li><li class="listitem">Lastly, set the IP address of the server and port. Then, run it:<div class="informalexample"><pre class="programlisting">cherrypy.config.update({'server.socket_host': '127.0.0.1',
                         'server.socket_port': 8000,
                        }) 
cherrypy.quickstart(mongocherry())</pre></div></li></ol></div><p>Now you can run the file and <a id="id499" class="indexterm"/>point your browser to <code class="literal">http://127.0.0.1:8000</code>. You will see a blank map. Click anywhere on the map and you will see three points <a id="id500" class="indexterm"/>appear. These are the closest <a id="id501" class="indexterm"/>points to where you clicked. Your map will look like<a id="id502" class="indexterm"/> the following screenshot <a id="id503" class="indexterm"/>after clicking once:</p><div class="mediaobject"><img src="images/4812OS_06_06.jpg" alt="Spatial queries with Python, MongoDB, and Leaflet"/></div><p>Using Python to connect to your MongoDB allows you to not only query the database to display results, but with<a id="id504" class="indexterm"/> a little more code, you can use it to save the results of a map. You could allow the user to click on the map where they would like to add a point and then use the <code class="literal">(x,y)</code> coordinates and perform an <code class="literal">insert()</code> method instead of a <code class="literal">find()</code> function. The preceding examples provided a very brief overview of how to serve up a Leaflet map with Python and handle AJAX queries. The next examples will move on to using C# to make desktop applications with Leaflet.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Desktop applications in C# with Leaflet"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec49"/>Desktop applications in C# with Leaflet</h1></div></div></div><p>Leaflet is <a id="id505" class="indexterm"/>used in a web page; however, with C#, you can embed a web browser in a Windows form to create what appears to be a desktop application. The examples in this section will <a id="id506" class="indexterm"/>show you how to add a map to a C# application, add a point by calling a JavaScript function from C#, and show you how to connect to MongoDB in C# and display the results on the map.</p><div class="section" title="Adding a map to a C# application"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec57"/>Adding a map to a C# application</h2></div></div></div><p>To build an application in C#, you will need to<a id="id507" class="indexterm"/> install Microsoft Visual Studio Express. You will need at least Visual Studio C# 2010. You can download it at <a class="ulink" href="http://www.visualstudio.com/downloads/download-visual-studio-vs">http://www.visualstudio.com/downloads/download-visual-studio-vs</a>. This program is a slimmed-down version of the commercial Visual Studio. It allows you to rapidly build <span class="strong"><strong>Windows Form Applications</strong></span> and compile your code in to an easily<a id="id508" class="indexterm"/> redistributable Windows Executable.</p><p>Launch the <a id="id509" class="indexterm"/>application and create a new <span class="strong"><strong>Windows Form Application</strong></span> from the dialog box, as shown in the following screenshot:</p><div class="mediaobject"><img src="images/4812OS_06_07.jpg" alt="Adding a map to a C# application"/></div><p>Your application will be a blank form. Select the toolbox on the upper-left corner of the window and drag the web browser to the form, as shown in the following screenshot:</p><div class="mediaobject"><img src="images/4812OS_06_08.jpg" alt="Adding a map to a C# application"/></div><p>Click on<a id="id510" class="indexterm"/> the web browser that you dragged to the form and modify the <code class="literal">URL</code> property to point to an instance of <code class="literal">LeafletEssentials.html</code> running<a id="id511" class="indexterm"/> on your <a id="id512" class="indexterm"/>web server. Save the application. Click on the <span class="strong"><strong>Debug</strong></span> menu and then start debugging. Your application will launch and you will <a id="id513" class="indexterm"/>see your Leaflet map loaded in the Windows Form, as shown in the following screenshot:</p><div class="mediaobject"><img src="images/4812OS_06_09.jpg" alt="Adding a map to a C# application"/></div><p>You now <a id="id514" class="indexterm"/>have a map in a C# <a id="id515" class="indexterm"/>application without any code. The next <a id="id516" class="indexterm"/>example will add some functionality to your application.</p></div><div class="section" title="Adding a marker in C#"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec58"/>Adding a marker in C#</h2></div></div></div><p>In this example, you will build on the previous example<a id="id517" class="indexterm"/> by adding a marker. The first thing you need to do is drag a button onto the bottom of the form using the toolbox. In the properties of the<a id="id518" class="indexterm"/> button, change the <code class="literal">text</code> property from <code class="literal">button1</code> to <code class="literal">Add Marker</code>. Then, double-click on the button.</p><p>You are now<a id="id519" class="indexterm"/> looking at the code that Visual Studio created for you when you created the application, and it has now added a function to handle <a id="id520" class="indexterm"/>the button click. It wrote the function when you clicked on the button. Before you code the button, you will need to add a reference to <code class="literal">MSHTML.dll</code>. This file will allow you to use the web and HTML objects you need to make your map work. At the top of your code, you will see several lines that start with <code class="literal">using</code>. This is where you import the required libraries into your application. The most <a id="id521" class="indexterm"/>common ones have already been added. At the end of<a id="id522" class="indexterm"/> the list, type the code <code class="literal">using MSHTML;</code>. It will be underlined and won't be found. You now need to right-click<a id="id523" class="indexterm"/> on the project in the <span class="strong"><strong>Solution Explorer</strong></span> window and select <span class="strong"><strong>Add Reference</strong></span>. Add a COM reference to Microsoft HTML Object Library as shown in the following screenshot:</p><div class="mediaobject"><img src="images/4812OS_06_10.jpg" alt="Adding a marker in C#"/></div><p>Now that you have added the reference, the underline will disappear and you can start coding the <code class="literal">button1_Click()</code> function. Add the following code to the function:</p><div class="informalexample"><pre class="programlisting">HtmlElement head = webBrowser1.Document.GetElementsByTagName("head")[0];
HtmlElement scriptEl = webBrowser1.Document.CreateElement("script");
IHTMLScriptElement element = (IHTMLScriptElement)scriptEl.DomElement;
element.text = "var mymarker; function addPoints() { mymarker = new L.marker([36.104743, -106.629925]); map.addLayer(mymarker); mymarker.bindPopup('HELLO &lt;br&gt;Added By C#.'); }";
head.AppendChild(scriptEl);
webBrowser1.Document.InvokeScript("addPoints");</pre></div><p>The preceding code grabs the <code class="literal">&lt;head&gt;</code> tag of the <code class="literal">LeafletEssentials.html</code> file that you loaded through the web browser properties. It then creates a <code class="literal">&lt;script&gt;</code> element so that you can add<a id="id524" class="indexterm"/> JavaScript to the HTML and execute it. You then create the script element and pass it a <code class="literal">text</code> string. The string is a JavaScript function for adding a point to the map.</p><p>You must<a id="id525" class="indexterm"/> wrap your code in a function, because that is how C# will call and execute it. You then append the <code class="literal">&lt;script&gt;</code> tag to the <code class="literal">&lt;head&gt;</code> tag of the<a id="id526" class="indexterm"/> document and tell the web browser to invoke the <code class="literal">addPoints()</code>function. So now, when the user clicks on the button, the JavaScript function will be added to <code class="literal">LeafletEssentials.html</code> and will be executed. Save and debug the project. When the application launches, click on the button and your application should look like this:</p><div class="mediaobject"><img src="images/4812OS_06_11.jpg" alt="Adding a marker in C#"/></div><p>To allow<a id="id527" class="indexterm"/> C# applications to modify a Leaflet application, insert a JavaScript function to a base HTML file and <a id="id528" class="indexterm"/>then execute it using an event such as<a id="id529" class="indexterm"/> a button click. The next example will connect to MongoDB.</p></div><div class="section" title="Using MongoDB with C# and Leaflet"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec59"/>Using MongoDB with C# and Leaflet</h2></div></div></div><p>Just as in the<a id="id530" class="indexterm"/> Python example, to use MongoDB in C# will require a driver. You can download the C# drivers at <a class="ulink" href="https://github.com/mongodb/%E2%80%A8mongo-csharp-driver/releases">https://github.com/mongodb/mongo-csharp-driver/releases</a>. This example uses the <code class="literal">.zip</code> file. In your <a id="id531" class="indexterm"/>project, add another reference, but<a id="id532" class="indexterm"/> instead of selecting COM, this time, you will browse to where you extracted the drivers from the <code class="literal">.zip</code> file. The folder should contain <code class="literal">MongoDB.Bson.dll</code> and <code class="literal">MongoDB.Driver.dll</code>. After adding the reference, you must import the required libraries using the following code:</p><div class="informalexample"><pre class="programlisting">using MongoDB.Bson;
using MongoDB.Driver;
using MongoDB.Driver.Linq;
using MongoDB.Driver.Builders;</pre></div><p>With the libraries imported, you can modify your button to connect to MongoDB and load the points. The <a id="id533" class="indexterm"/>following instructions will walk you through the code to connect to MongoDB:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, you will need a string to hold the JavaScript function that will add the points. In C#, you will use <code class="literal">StringBuilder()</code> so that you can append to the string. You can start by appending the function name and the first brace:<div class="informalexample"><pre class="programlisting">StringBuilder myString = new StringBuilder();
myString.Append("function addPoints() {");</pre></div></li><li class="listitem">Next, you set up the connection to MongoDB. Connect to the IP and port—the default is localhost on port 27017. Get the server and then the database named <code class="literal">albuquerque</code>. Lastly, connect to the <code class="literal">publicart</code> collection:<div class="informalexample"><pre class="programlisting">var client = new MongoClient("mongodb://localhost:27017");
var server = client.GetServer();
var database = server.GetDatabase("albuquerque");
var collection = database.GetCollection("publicart");</pre></div></li><li class="listitem">Now, you can execute the query. The query will find all documents and return each one. The code appends a string, which creates a marker by concatenating the location, name, and pop-up information from each document:<div class="informalexample"><pre class="programlisting">            foreach (var document in collection.FindAll())
            {
                myString.Append("L.marker([" + document["loc"][0] + "," + document["loc"][1] + "]).addTo(map).bindPopup(\"" + document["name"] + "&lt;br&gt;&lt;img src='" + document["popup"] + "'&gt;\");" + "\r\n");
            }</pre></div></li><li class="listitem"> Close the string with the last brace:<div class="informalexample"><pre class="programlisting">            myString.Append("}");</pre></div></li><li class="listitem">The last<a id="id534" class="indexterm"/> code block is the same as the previous example. Create the HTML elements and insert the string by converting <code class="literal">StringBuilder.toString()</code>:<div class="informalexample"><pre class="programlisting">HtmlElement head = webBrowser1.Document.GetElementsByTagName("body")[0];
HtmlElement scriptElement = webBrowser1.Document.CreateElement("script");
IHTMLScriptElement addPointsElement = (IHTMLScriptElement)scriptElement.DomElement;
addPointsElement.text = myString.ToString();
head.AppendChild(scriptElement);
webBrowser1.Document.InvokeScript("addPoints");</pre></div></li></ol></div><p>Save and debug<a id="id535" class="indexterm"/> the project. When the application<a id="id536" class="indexterm"/> is launched, click on the button, and your application should look like the following screenshot:</p><div class="mediaobject"><img src="images/4812OS_06_12.jpg" alt="Using MongoDB with C# and Leaflet"/></div><p>The very last <a id="id537" class="indexterm"/>step is to select the <code class="literal">debug</code> menu and, instead of debugging, select <code class="literal">build solution</code>. If you browse to the <code class="literal">project</code> folder, you<a id="id538" class="indexterm"/> will have a directory named <code class="literal">bin</code>. Within the directory, you now have an <code class="literal">.exe</code> file.</p><p>Now, you have a MongoDB collection in a Leaflet map written in C# and compiled as <code class="literal">.exe</code>. For this to run on another machine, you would only need to make your MongoDB sit on a real IP and allow access from outside your network.</p><p>The last example <a id="id539" class="indexterm"/>will allow the user to click on the map and return the closest points.</p></div><div class="section" title="Querying with C#, Leaflet, and MongoDB"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec60"/>Querying with C#, Leaflet, and MongoDB</h2></div></div></div><p>You have learned how to pass data from C# to Leaflet by writing a JavaScript function, injecting it into the HTML file, and then executing it. Passing data from JavaScript back to C# is a little<a id="id540" class="indexterm"/> different. One way in which you can pass data is to have the<a id="id541" class="indexterm"/> JavaScript write the contents to <code class="literal">&lt;div&gt;</code>, and then C# can read it in. The key here<a id="id542" class="indexterm"/> is to set the <code class="literal">&lt;div&gt;</code> tag to be invisible. The following steps will walk you through the last example:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, modify <code class="literal">LeafletEssentials.html</code> by adding a new <code class="literal">&lt;div&gt;</code>, and set the style so that the display is set to <code class="literal">none</code>. If you set it as <code class="literal">hidden</code>, it will take up space in the document<a id="id543" class="indexterm"/> and there would be a blank spot below your map:<div class="informalexample"><pre class="programlisting">&lt;style&gt;
  html, body, #map {
      padding: 0;
      margin: 0;
      height: 100%;
    }
<span class="strong"><strong>#points.hidden {</strong></span>
<span class="strong"><strong>    display: none;</strong></span>
<span class="strong"><strong>}</strong></span>
&lt;/style&gt;
&lt;body&gt;
&lt;div id="map"&gt;&lt;/div&gt;
<span class="strong"><strong>&lt;div id="points"&gt;&lt;/div&gt;</strong></span>
</pre></div></li><li class="listitem">Next, create a listener for the <code class="literal">click</code> event and write a function that creates a marker, showing you the location of the <code class="literal">click</code> event that cleans up the text of the returned latitude and longitude and writes the results to <code class="literal">&lt;div&gt;</code>:<div class="informalexample"><pre class="programlisting">map.on('click',function(e){L.marker(e.latlng).addTo(map).bi 
ndPopup("SEARCH LOCATION").openPopup();
var a=String(e.latlng).split(",");
var lat=a[0].split("(");
var lon=a[1].split(")");
document.getElementById("points").innerHTML = lat[1]+","+lon[0];
});</pre></div></li><li class="listitem">With the HTML file ready, you can now modify the C#. The first step is to read in the points from the <code class="literal">&lt;div&gt;</code> tag and then parse them so that each is in its own variable as follows:<div class="informalexample"><pre class="programlisting">string hiddenHTML = webBrowser1.Document.GetElementById("points").InnerHtml;
string[] thePoints = hiddenHTML.Split(',');</pre></div></li><li class="listitem">Set up the<a id="id544" class="indexterm"/> connection to MongoDB. Connect to the IP and port. Get the server and then the database named <code class="literal">albuquerque</code>. Lastly, connect to the <code class="literal">publicart</code> collection:<div class="informalexample"><pre class="programlisting">var client = new MongoClient("mongodb://localhost:27017");
var server = client.GetServer();
var database = server.GetDatabase("albuquerque");
var collection = database.GetCollection("publicart");</pre></div></li><li class="listitem">Create a text<a id="id545" class="indexterm"/> string of the query and initialize your <code class="literal">StringBuilder()</code> function to hold the JavaScript of the function and results:<div class="informalexample"><pre class="programlisting">var query = Query.Near("loc", double.Parse(thePoints[0]), double.Parse(thePoints[1]));
StringBuilder myLocString = new StringBuilder();
myLocString.Append("function addLocPoints() {");</pre></div></li><li class="listitem">Execute the query in a loop using the <code class="literal">near()</code> function. Pass the results to the string, building up the JavaScript function:<div class="informalexample"><pre class="programlisting">            foreach (BsonDocument item in collection.Find(query).SetLimit(5))
            {
                BsonElement loc = item.GetElement("loc");
                string g = loc.Value.ToString();
                string x = g.Trim(new Char[] { '[', ']' });
                String[] a = x.Split(',');
           
                myLocString.Append("L.marker([" + a[0] + "," + a[1] + "]).addTo(map).bindPopup(\"" + item["name"] + "&lt;br&gt;&lt;img src='" + item["popup"] + "'&gt;\");" + "\r\n");
            }</pre></div></li><li class="listitem">The last code <a id="id546" class="indexterm"/>block is the same as the previous two examples. Create the HTML elements and insert the string by converting <code class="literal">StringBuilder.toString()</code>:<div class="informalexample"><pre class="programlisting">myLocString.Append("}");
HtmlElement head = webBrowser1.Document.GetElementsByTagName("body")[0];
HtmlElement scriptElement = webBrowser1.Document.CreateElement("script");
IHTMLScriptElement addPointsElement = (IHTMLScriptElement)scriptElement.DomElement;
addPointsElement.text = myLocString.ToString();
head.AppendChild(scriptElement);
webBrowser1.Document.InvokeScript("addLocPoints");</pre></div></li><li class="listitem">Save and<a id="id547" class="indexterm"/> debug the project. When the application is launched, click on the button, <a id="id548" class="indexterm"/>and your application<a id="id549" class="indexterm"/> should look like the following screenshot:<div class="mediaobject"><img src="images/4812OS_06_13.jpg" alt="Querying with C#, Leaflet, and MongoDB"/></div></li></ol></div></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec50"/>Summary</h1></div></div></div><p>In this last chapter, you have learned how to use <code class="literal">Leaflet.js</code> in other programming languages and frameworks. Starting with Node.js, you learned how to use JavaScript on the frontend and the backend. You created a Node.js server that returned a Leaflet web page. You then modified the code to allow AJAX calls back to the server to update the map without reloading the page.</p><p>You also learned how to create a server and allow AJAX requests using Python and CherryPy. The Python example introduced NoSQL databases, in particular, MongoDB. You learned how to write a query to return all the documents in a database collection as well as how to use AJAX to query only points that are near the points where a user has clicked.</p><p>Lastly—for something totally different—you learned how to embed a web browser into a Windows Form and run a desktop application with Leaflet. The applications used buttons on the form to execute JavaScript functions that were injected into the <code class="literal">LeafletEssentials.html</code> file. You then passed data in the other direction—from JavaScript back to C#—capturing mouse clicks on the map and using them to query MongoDB and return the results. The C# applications you built can then be compiled in a .exe file and distributed to anyone who can connect to your MongoDB and <code class="literal">LeafletEssentials.html</code> file.</p></div></div>
</body></html>