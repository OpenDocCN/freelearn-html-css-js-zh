<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Building Rat-man!"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Building Rat-man!</h1></div></div></div><p>In this chapter, we will be building a<a class="indexterm" id="id222"/> game called <span class="strong"><strong>Rat-man</strong></span>, which is actually a modified version of the<a class="indexterm" id="id223"/> famous game <span class="strong"><strong>Pac-Man</strong></span>. We will use canvas, JavaScript, CSS, and HTML to build our game.</p><p>Let's start with introducing our game's characters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Our game will have one rat. The player will act as the rat.</li><li class="listitem" style="list-style-type: disc">There will be four cats who will try to catch the rat and a lot of cheese for the rat to eat.</li><li class="listitem" style="list-style-type: disc">The main goal of the game is to eat all the cheese without being caught by the monster cats.</li></ul></div><p>Sounds fun, right? Let's get right to it...</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note26"/>Note</h3><p>To make our code clean, we will keep our JavaScript, CSS, and images files in separate folders. We will have three primary folders named as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">css</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">img</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">scripts</code></li></ul></div></div></div><div class="section" title="Game user interface"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec50"/>Game user interface</h1></div></div></div><p>To start building <a class="indexterm" id="id224"/>our game, we need to prepare our canvas. Our HTML file<a class="indexterm" id="id225"/> should look similar to the following:</p><div class="informalexample"><pre class="programlisting">&lt;html&gt;
  &lt;head&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;canvas id="main_canvas"&gt;&lt;/canvas&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div><p>Our game user interface will be in the <code class="literal">&lt;body&gt;&lt;/body&gt;</code> tags. We will add JavaScript to our canvas soon.</p><p>In the <code class="literal">css</code> folder, create a CSS file named <code class="literal">styles.css</code>, which will contain the following code for<a class="indexterm" id="id226"/> our <a class="indexterm" id="id227"/>HTML <code class="literal">body</code>, <code class="literal">canvas</code>, and a play <code class="literal">button</code>:</p><div class="informalexample"><pre class="programlisting">body {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  background-color: #ffffff;
  -webkit-background-size: cover;
  -moz-background-size: cover;
  -o-background-size: cover;
  background-size: cover;
  overflow: hidden;
}

canvas {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  margin: auto;
  border: 10px solid rgba(63, 72, 204, 0.7);
  border-radius: 20px;
  box-shadow: 0 0 500px 100px #ffffff;
}

button {
  width: 100%;
  height: 100%;
  background-color: #000000;
  color: #FFFFFF;
  font-size: 60px;
  opacity: 0;
  z-index: 1000;
  transition: 5s ease;
  visibility: hidden;
}</pre></div><p>Create another CSS file named <code class="literal">reset.css</code> in the same folder and add the following code to the CSS <a class="indexterm" id="id228"/>file. This file will design the user interface for<a class="indexterm" id="id229"/> the initial screen of the game:</p><div class="informalexample"><pre class="programlisting">html, body, div, span, applet, object, iframe,
h1, h2, h3, h4, h5, h6, p, blockquote, pre,
a, abbr, acronym, address, big, cite, code,
del, dfn, em, img, ins, kbd, q, s, samp,
small, strike, strong, sub, sup, tt, var,
b, u, i, center,
dl, dt, dd, ol, ul, li,
fieldset, form, label, legend,
table, caption, tbody, tfoot, thead, tr, th, td,
article, aside, canvas, details, embed, 
figure, figcaption, footer, header, hgroup, 
menu, nav, output, ruby, section, summary,
time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
  font-size: 100%;
  font: inherit;
  vertical-align: baseline;
}
article, aside, details, figcaption, figure, 
footer, header, hgroup, menu, nav, section {
  display: block;
}

body {
  line-height: 0;
}

ol, ul {
  list-style: none;
}

blockquote, q {
  quotes: none;
}

blockquote:before, blockquote:after,
q:before, q:after {
  content: '';
  content: none;
}

table {
  border-collapse: collapse;
  border-spacing: 0;
}</pre></div><p>Save both <a class="indexterm" id="id230"/>the files and include them in your HTML file <a class="indexterm" id="id231"/>with the following code in the <code class="literal">&lt;head&gt;&lt;/head&gt;</code> tags:</p><div class="informalexample"><pre class="programlisting">&lt;link href="css/styles.css" rel="stylesheet"/&gt;
&lt;link href="css/reset.css" rel="stylesheet"/&gt;</pre></div><p>If you open an HTML file of a browser now, you will see the following image:</p><div class="mediaobject"><img alt="Game user interface" src="graphics/B04720_08_01.jpg"/></div><p>We are going to draw our game interface in the preceding rectangle.</p></div></div>
<div class="section" title="Adding functionalities to the game"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec51"/>Adding functionalities to the game</h1></div></div></div><p>To add the <a class="indexterm" id="id232"/>user interface and the game's functionalities, we <a class="indexterm" id="id233"/>will be needing JavaScript. We will need the following JavaScript files in the <code class="literal">scripts</code> folder:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">app.main.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">app.display_functions.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">app.init.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">app.key_handler.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">app.movement_functions.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">app.constants.js</code></li></ul></div><div class="section" title="The app.main.js file"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec32"/>The app.main.js file</h2></div></div></div><p>Our <code class="literal">app.main.js</code> file<a class="indexterm" id="id234"/> should contain the following function that will deal with the <code class="literal">app.key_handler.js</code> file and your computer's keyboard. It will also call the <code class="literal">app.init.js</code> file for the initialization of our variables.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note27"/>Note</h3><p>Here we used <code class="literal">app.main.js</code>; You need not name your JavaScript file like this. But it is a good practice to maintain the naming convention.</p></div></div><p>The following code is the content of the <code class="literal">app.main.js</code> file:</p><div class="informalexample"><pre class="programlisting">(function () {
  "use strict";
  APP.Init();
  APP.timer = setInterval(APP.Show_World, 1000 / APP.GAME_FPS);
  window.addEventListener("keydown", APP.Keydown_Handler, false);
  APP.Reset = function () {
    APP.map.Init();
    APP.player.Init();
    APP.monsters.Init();
    APP.blackout.style.transition = "0s";
    APP.blackout.style.visibility = "hidden";
    setTimeout(function () {
      APP.timer = setInterval(APP.Show_World, 1000 / APP.GAME_FPS);
      APP.blackout.style.opacity = 0;
      APP.blackout.style.transition = "5s ease";
    }, 100);
  };
}());</pre></div></div><div class="section" title="The app.display_functions.js file"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec33"/>The app.display_functions.js file</h2></div></div></div><p>In<a class="indexterm" id="id235"/> our <code class="literal">app.display_functions.js</code> file, we will write a function, where we will include the <code class="literal">APP.Show_world</code> function, which is used in the <code class="literal">app.init.js</code> file.</p><p>The function should contain the following code (refer to the comments to understand what each step does):</p><div class="informalexample"><pre class="programlisting">  APP.Show_World = function () {
    var i,
    dots = 0; //initialized cheese number
    dots = APP.map.Draw(); //put our cheese on the canvas
    if (!dots) {
      APP.Game_Over("YOU WIN!"); //if all cheese are ate by the rat, then the screen should display this.
    }
    */This loop is determine if the rat is caught by the cats  */
    for (i = 0; i &lt; APP.MONSTERS_QUANTITY; i++) {
      if (APP.monsters[i].x === APP.player.x) {
        if (APP.monsters[i].y === APP.player.y) {
          APP.Game_Over("YOU LOSE!");
        }
      }
    }
    APP.monsters.Move(); //cats' movement function
    APP.player.Move();  // rat's movement function
    APP.player.Check_For_Dots(); //This function will check number of chees. 
    APP.portals.Show(); //This will display two portals by using these the rat can escape. 
    APP.player.Show(); //This will show the rat on the canvas. 
      /* this function will show the monster on the canvas */
    for (i = 0; i &lt; APP.MONSTERS_QUANTITY; i++) {
      APP.monsters[i].Show();
    }
  };</pre></div><p>The <code class="literal">APP.map.Draw</code> function will hold the following code:</p><div class="informalexample"><pre class="programlisting">    APP.map.Draw = function () {
      var i, j, image, x, y, dot_counter = 0; //initialized variables. 
      /*this loop will create our game map/maze */
      for (i = 0; i &lt; APP.MAP_WIDTH; i++) {
        for (j = 0; j &lt; APP.MAP_HEIGHT; j++) {
          image = APP.images[APP.map.cells[j][i]];
          x = i * APP.CELL_WIDTH;
          y = j * APP.CELL_HEIGHT;
          APP.context.drawImage(image, x, y);
          if (APP.map.cells[j][i] === APP.DOT_CELL_DIGIT) {
            dot_counter++;
          }
        }
      }
      return dot_counter;
    };</pre></div><p>For the<a class="indexterm" id="id236"/> cats' movement, we will use the <code class="literal">APP.monsters.Move</code> function with the following code:</p><div class="informalexample"><pre class="programlisting">    APP.monsters.Move = function () {
      var i;
      /*This loop will define the cats' quantity */
      for (i = 0; i &lt; APP.MONSTERS_QUANTITY; i++) {
        if (APP.monsters[i].frame === APP.monsters[i].speed) {
          if (APP.monsters[i].direction !== APP.Direction.STOP) {
            APP.monsters[i].previus_direction =
            APP.monsters[i].direction;
          }
          APP.monsters[i].Select_Direction(); //Will select the cats' direction.
          APP.monsters[i].Check_Direction(); //Will check the cats' direction.
          APP.monsters[i].Check_Wall();//Will check the surroundings of the canvas or any block. 
        }
        /* These conditions will check the boundaries of the canvas and make the cats move. */
        if (APP.monsters[i].direction !== APP.Direction.STOP) {
          if (APP.monsters[i].up) {
            APP.monsters[i].Move_Up();
          }
          if (APP.monsters[i].down) {
            APP.monsters[i].Move_Down();
          }
          if (APP.monsters[i].left) {
            APP.monsters[i].Move_Left();
          }
          if (APP.monsters[i].right) {
            APP.monsters[i].Move_Right();
          }
        }
      }
    };</pre></div><p>Our rat will<a class="indexterm" id="id237"/> move when the <code class="literal">APP.player.Move()</code> function is called with the following code:</p><div class="informalexample"><pre class="programlisting">    APP.player.Move = function () {
      if (APP.player.frame === APP.player.speed) {
        APP.player.Check_Direction();
        APP.player.Check_Wall(); //This will check wall
      }
      /* these conditions will check our rat's valid movements */
      if (APP.player.direction !== APP.Direction.STOP) {
        if (APP.player.up) {
          APP.player.Move_Up(); 
        }
        if (APP.player.down) {
          APP.player.Move_Down();
        }
        if (APP.player.left) {
          APP.player.Move_Left();
        }
        if (APP.player.right) {
          APP.player.Move_Right();
        }
      }
    };
    /*this function will feed our rat the chees */
    APP.player.Check_For_Dots = function () {
      if (APP.map.marks[APP.player.y][APP.player.x] === APP.DOT_MARK) {
        APP.player.bonuses++;
        APP.map.marks[APP.player.y][APP.player.x] = APP.BLANK_MARK;
        APP.map.cells[APP.player.y][APP.player.x] = APP.BLANK_CELL_DIGIT;
      }
    };</pre></div><p>Now, we will make our rat visible on our canvas while moving the rat on the blocks by calling the function with the following code:</p><div class="informalexample"><pre class="programlisting">APP.player.Show = function () {
  //initializing our needed variables. 
  var figure_offset = 5,
  frame_number = 2 - Math.floor(this.frame / 3),
  frame_offset = 1 - this.frame / this.speed,
  image, x, y;
  /* conditions for the rat's direction for up, down, left, right*/
  if (this.up) {
    image = this.up_images[frame_number];
    x = (this.x * APP.CELL_WIDTH) - figure_offset;
    y = ((this.y - frame_offset) * APP.CELL_HEIGHT) - figure_offset;

  } else if (this.down) {
    image = this.down_images[frame_number];
    x = (this.x * APP.CELL_WIDTH) - figure_offset;
    y = ((this.y + frame_offset) * APP.CELL_HEIGHT) - figure_offset;

  } else if (this.right) {
    image = this.right_images[frame_number];
    x = ((this.x + frame_offset) * APP.CELL_WIDTH) - figure_offset;
    y = (this.y * APP.CELL_HEIGHT) - figure_offset;

  } else {
    image = this.left_images[frame_number];
    x = ((this.x - frame_offset) * APP.CELL_WIDTH) - figure_offset;
    y = (this.y * APP.CELL_HEIGHT) - figure_offset;

  }
  APP.context.drawImage(image, x, y);
};</pre></div><p>To show<a class="indexterm" id="id238"/> our cats on the canvas, we need to use the following code in our <code class="literal">APP.Show_Monster()</code> function:</p><div class="informalexample"><pre class="programlisting">APP.Show_Monster = function () {
  //initializing needed variables. 
  var figure_offset = 15,
  frame_offset = 1 - this.frame / this.speed,
  image, x, y;
  /* binding the cats' directions for 4 directions*/
  if (this.up) {
    image = this.up_images[0];
    x = (this.x * APP.CELL_WIDTH) - figure_offset;
    y = ((this.y - frame_offset) * APP.CELL_HEIGHT) - figure_offset;

  } else if (this.down) {

    image = this.down_images[0];
    x = (this.x * APP.CELL_WIDTH) - figure_offset;
    y = ((this.y + frame_offset) * APP.CELL_HEIGHT) - figure_offset;

  } else if (this.right) {

    image = this.right_images[0];
    x = ((this.x + frame_offset) * APP.CELL_WIDTH) - figure_offset;
    y = (this.y * APP.CELL_HEIGHT) - figure_offset;

  } else {

    image = this.left_images[0];
    x = ((this.x - frame_offset) * APP.CELL_WIDTH) - figure_offset;
    y = (this.y * APP.CELL_HEIGHT) - figure_offset;

  }

  APP.context.drawImage(image, x, y);
};</pre></div><p>To show<a class="indexterm" id="id239"/> the portal, we need to write another function called <code class="literal">APP.portals.Show ()</code>, including the following code:</p><div class="informalexample"><pre class="programlisting">    APP.portals.Show = function () {
      //initialized variables and incremented. 
      var offset, frame_offset, sw = +!this.raise;
      frame_offset = sw - this.frame_counter / (this.speed * APP.GAME_FPS); 
      /*controlled frame of the game */
      offset = Math.abs(this.width * frame_offset);
      APP.context.drawImage(this[0].image, this[0].x - offset, this[0].y);
      APP.context.drawImage(this[1].image, this[1].x + offset, this[1].y);
      this.frame_counter++;
      if (this.frame_counter === this.speed * APP.GAME_FPS) {
        this.frame_counter = 0;
        this.raise = !this.raise;
      }
    };</pre></div><p>The user will need to see a message after the game is over or make the screen blur. To do this, we need to declare another function called <code class="literal">APP.Game_Over()</code> with the following code:</p><div class="informalexample"><pre class="programlisting">    APP.Game_Over = function (condition) {
      clearInterval(APP.timer);
      APP.blackout = document.getElementById("blackout");
      APP.blackout.textContent = condition;
      APP.blackout.style.visibility = "visible";
      APP.blackout.style.opacity = 0.7;
    };</pre></div></div><div class="section" title="The app.init.js file"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec34"/>The app.init.js file</h2></div></div></div><p>Our <code class="literal">app.init.js</code> file will contain a function. In the function, we will declare the following<a class="indexterm" id="id240"/> variables:</p><div class="informalexample"><pre class="programlisting">  APP.map = {};
  APP.player = {};
  APP.monsters = [{}, {}, {}, {}];
  APP.portals = [{}, {}];
  APP.images = [];
  APP.timer = {};
  APP.canvas = {};
  APP.context = {};
  APP.blackout = document.getElementById("blackout");</pre></div><p>Write a function that will contain few more variables, as follows:</p><div class="informalexample"><pre class="programlisting">  APP.Init = function () {
    APP.map.Init();
    APP.player.Init();
    APP.portals.Init();
    APP.monsters.Init();
    APP.images.Init();
    APP.canvas.Init();
  };</pre></div><p>Now, we will initialize our game's map:</p><div class="informalexample"><pre class="programlisting">APP.map.Init = function () {

  //initializing few variables ; few of them may look ugly, but don't worry they are a little bit random. 
  var i, j, map_in_strings = [
                "5000000000000250000000000002",
                "1777777777777117777777777771",
                "1750027500027117500027500271",
                "1716617166617117166617166171",
                "1740037400037437400037400371",
                "1777777777777777777777777771",
                "1750027527500000027527500271",
                "1740037117400250037117400371",
                "1777777117777117777117777771",
                "4000027140026116500317500003",
                "0000217150036436400217150000",
                "6666117116666666666117116666",
                "0000317116502665026117140000",
                "0000037436153664216437400000",
                "6666667666116666116667666666",
                "0000027526140000316527500000",
                "0000217116400000036117150000",
                "6666117116666666666117116666",
                "0000317116500000026117140000",
                "5000037436400250036437400002",
                "1777777777777117777777777771",
                "1750027500027117500027500271",
                "1740217400037437400037150371",
                "1777117777777777777777117771",
                "4027117527500000027527117503",
                "5037437117400250037117437402",
                "1777777117777117777117777771",
                "1750000340027117500340000271",
                "1740000000037437400000000371",
                "1777777777777777777777777771",
                "4000000000000000000000000003"
            ];
  APP.map.cells = [];
  for (i = 0; i &lt; APP.MAP_HEIGHT; i++) {
    APP.map.cells[i] = [];
    for (j = 0; j &lt; APP.MAP_WIDTH; j++) {
      APP.map.cells[i][j] = +map_in_strings[i].charAt(j);
    }
  }
  APP.map.marks = [];
  /* This loop will determine the map's size */
  for (i = 0; i &lt; APP.MAP_HEIGHT; i++) {
    APP.map.marks[i] = [];
    for (j = 0; j &lt; APP.MAP_WIDTH; j++) {
      if (APP.map.cells[i][j] &lt;= APP.WALL_CELL_DIGIT) {
        APP.map.marks[i][j] = APP.WALL_MARK;
      } else if (APP.map.cells[i][j] === APP.BLANK_CELL_DIGIT) {
        APP.map.marks[i][j] = APP.BLANK_MARK;
      } else if (APP.map.cells[i][j] === APP.DOT_CELL_DIGIT) {
        APP.map.marks[i][j] = APP.DOT_MARK;
      }
    }
  }
};</pre></div></div></div>
<div class="section" title="Images for Rat-man!"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec52"/>Images for Rat-man!</h1></div></div></div><p>To build the<a class="indexterm" id="id241"/> game, we will need a few images. We will keep all our <a class="indexterm" id="id242"/>images in the <code class="literal">img</code> folder. In the <code class="literal">img</code> folder, we will create four folders, as shown in the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">monsters</li><li class="listitem" style="list-style-type: disc">player</li><li class="listitem" style="list-style-type: disc">portal</li><li class="listitem" style="list-style-type: disc">walls</li></ul></div><p>We will keep two images, named <code class="literal">dot.png</code> and <code class="literal">blank.png</code>, in the <code class="literal">img</code> folder.</p><div class="section" title="The monsters folder"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec35"/>The monsters folder</h2></div></div></div><p>In the <code class="literal">monsters</code> folder, create four folders with our cats' names.</p><p>Say that<a class="indexterm" id="id243"/> our cats' names are as follows (you can name them whatever you want):</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">blinky</li><li class="listitem" style="list-style-type: disc">inky</li><li class="listitem" style="list-style-type: disc">pinky</li><li class="listitem" style="list-style-type: disc">clyde</li></ul></div><p>Each cat folder will have four folders for the directed images of the cats. The folder names are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">up</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">down</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">left</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">right</code></li></ul></div><p>Each direction folder should contain an image of our cat. The image name should be <code class="literal">0.png</code>.</p><p>You need to keep your image 50 x 50 px.</p></div><div class="section" title="The player folder"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec36"/>The player folder</h2></div></div></div><p>The <code class="literal">player</code> folder <a class="indexterm" id="id244"/>should contain four folders for the direction of our rat. The folders should be named as shown in the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">up</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">down</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">left</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">right</code></li></ul></div><p>Each folder should contain the rat's directed image. There need to be two images, <code class="literal">0.png</code> and <code class="literal">1.png</code>. One image is the open mouthed rat and another is of the closed mouthed rat. The images need to be 50 x 50 px.</p></div><div class="section" title="The portal folder"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec37"/>The portal folder</h2></div></div></div><p>The <code class="literal">portal</code> folder <a class="indexterm" id="id245"/>should contain two images of the portal through which our rat will travel from one end to another. The images names should be <code class="literal">0.png</code> and <code class="literal">1.png</code>.</p></div><div class="section" title="The walls folder"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec38"/>The walls folder</h2></div></div></div><p>The <code class="literal">walls</code> folder <a class="indexterm" id="id246"/>should have five images to draw the walls in the canvas.</p><p>The images should be named <code class="literal">0.png</code>, <code class="literal">1.png</code>, <code class="literal">2.png</code>, <code class="literal">3.png</code>, and <code class="literal">4.png</code>. The images will be the corners and straight lines of the wall.</p><p>The hierarchical representation of the images used in building our game is as follows:</p><div class="mediaobject"><img alt="The walls folder" src="graphics/B04720_08_05.jpg"/></div></div></div>
<div class="section" title="Adding images to our cats"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec53"/>Adding images to our cats</h1></div></div></div><p>We will <a class="indexterm" id="id247"/>write four functions to add perfect images for our cats. The function should look similar to the following function:</p><div class="informalexample"><pre class="programlisting">  APP.monsters[0].Init = function () {
    APP.monsters[0].up_images = [];
    APP.monsters[0].right_images = [];
    APP.monsters[0].down_images = [];
    APP.monsters[0].left_images = [];
    APP.monsters[0].up_images[0] = new Image();
    APP.monsters[0].up_images[0].src = "img/monsters/blinky/up/0.png";
    APP.monsters[0].right_images[0] = new Image();
    APP.monsters[0].right_images[0].src = "img/monsters/blinky/right/0.png";
    APP.monsters[0].down_images[0] = new Image();
    APP.monsters[0].down_images[0].src = "img/monsters/blinky/down/0.png";
    APP.monsters[0].left_images[0] = new Image();
    APP.monsters[0].left_images[0].src = "img/monsters/blinky/left/0.png";
    APP.monsters[0].up = false;
    APP.monsters[0].right = true;
    APP.monsters[0].down = false;
    APP.monsters[0].left = false;
    APP.monsters[0].x = APP.INITIAL_BLINKY_X;
    APP.monsters[0].y = APP.INITIAL_BLINKY_Y;
    APP.monsters[0].frame = APP.INITIAL_BLINKY_FRAME;
    APP.monsters[0].speed = APP.BLINKY_SPEED;
  };</pre></div><p>We will <a class="indexterm" id="id248"/>change the index number of the <code class="literal">APP.monsters[0].Init = function ();</code> function to <code class="literal">APP.monsters[1].Init = function ();</code> for the second cat. And <code class="literal">APP.monsters[2].Init = function ()</code> &amp; <code class="literal">APP.monsters[3].Init = function ()</code> for the third and fourth cats.</p><p>We also need to change the image location and index numbers for the cats.</p><p>For the initialization of the walls and cheese with the images, we need to write a function, as follows:</p><div class="informalexample"><pre class="programlisting">  APP.images.Init = function () {
    var i;
    for (i = 0; i &lt;= APP.DOT_CELL_DIGIT; i++) {
      APP.images[i] = new Image();
    }
    APP.images[0].src = "img/walls/0.png";
    APP.images[1].src = "img/walls/1.png";
    APP.images[2].src = "img/walls/2.png";
    APP.images[3].src = "img/walls/3.png";
    APP.images[4].src = "img/walls/4.png";
    APP.images[5].src = "img/walls/5.png";
    APP.images[6].src = "img/blank.png";
    APP.images[7].src = "img/dot.png";
  };</pre></div></div>
<div class="section" title="Draw the canvas"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec54"/>Draw the canvas</h1></div></div></div><p>We will <a class="indexterm" id="id249"/>draw our canvas by adding the following function to <a class="indexterm" id="id250"/>our <code class="literal">app.init.js</code> file:</p><div class="informalexample"><pre class="programlisting">APP.canvas.Init = function () {
  APP.canvas = document.getElementById("main_canvas");
  APP.canvas.width = APP.MAP_WIDTH * APP.CELL_WIDTH;
  APP.canvas.height = APP.MAP_HEIGHT * APP.CELL_HEIGHT;
  APP.context = APP.canvas.getContext("2d");
  APP.context.fillStyle = APP.BG_COLOR;
  APP.context.fillRect(0, 0, APP.canvas.width, APP.canvas.height);
};</pre></div><div class="section" title="The app.key_handler.js file"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec39"/>The app.key_handler.js file</h2></div></div></div><p>Now, in the <code class="literal">app.key_handler.js</code> file, we will write our code to give the player the ability to<a class="indexterm" id="id251"/> move our rat using the keyboard. The code should look similar to the following:</p><div class="informalexample"><pre class="programlisting">APP.Keydown_Handler = function (event) {
  "use strict";
  var KEYS = {
    /* We will initialize the arrow keys first. 37 = left key, 38 
      = up key, 39 = right key and 40 = down key. */
    LEFT    : 37,
    UP      : 38,
    RIGHT   : 39,
    DOWN    : 40
  }; 
  /* This switch-case will handle the key pressing and the rat's 
    movement. */
  switch (event.keyCode) {
    case KEYS.UP:
      APP.player.direction = APP.Direction.UP;
      break;
    case KEYS.RIGHT:
      APP.player.direction = APP.Direction.RIGHT;
      break;
    case KEYS.DOWN:
      APP.player.direction = APP.Direction.DOWN;
      break;
    case KEYS.LEFT:
      APP.player.direction = APP.Direction.LEFT;
      break;
  }
};</pre></div></div><div class="section" title="The app.movement_functions.js file"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec40"/>The app.movement_functions.js file</h2></div></div></div><p>We need to take a look where our wall ends or starts while pressing the keys. We need to stop moving<a class="indexterm" id="id252"/> the rat when we reach the edges. Therefore, we have to set some conditions for that. The first one is to check the direction. The function can be written as shown in the following:</p><div class="informalexample"><pre class="programlisting">  APP.Check_Direction = function () {
    switch (this.direction) {
      case APP.Direction.UP:
        if (APP.map.marks[this.y - 1][this.x] !== APP.WALL_MARK){
          this.up = true;
          this.down = false;
          this.right = false;
          this.left = false;
          return true;
        }
        break;
      case APP.Direction.DOWN:
        if (APP.map.marks[this.y + 1][this.x] !== APP.WALL_MARK) {
          this.up = false;
          this.down = true;
          this.right = false;
          this.left = false;
          return true;
        }
        break;
      case APP.Direction.RIGHT:
        if (APP.map.marks[this.y][this.x + 1] !== APP.WALL_MARK) {
          this.up = false;
          this.down = false;
          this.right = true;
          this.left = false;
          return true;
        }
        break;
      case APP.Direction.LEFT:
        if (APP.map.marks[this.y][this.x - 1] !== APP.WALL_MARK) {
          this.up = false;
          this.down = false;
          this.right = false;
          this.left = true;
          return true;
        }
        break;
    }
    return false;
  };</pre></div><p>While<a class="indexterm" id="id253"/> checking the directions, we also need to move in the right direction. The function to select the direction can be written as follows:</p><div class="informalexample"><pre class="programlisting">APP.Select_Direction = function () {
  var possible_directions = [],
  direction_quantity = 9,
  rnd;
  switch (this.previus_direction) {
    case APP.Direction.UP:
      possible_directions[0] = APP.Direction.UP;
      possible_directions[1] = APP.Direction.UP;
      possible_directions[2] = APP.Direction.UP;
      possible_directions[3] = APP.Direction.UP;
      possible_directions[4] = APP.Direction.UP;
      possible_directions[5] = APP.Direction.UP;
      possible_directions[6] = APP.Direction.RIGHT;
      possible_directions[7] = APP.Direction.DOWN;
      possible_directions[8] = APP.Direction.LEFT;
      break;
    case APP.Direction.RIGHT:
      possible_directions[0] = APP.Direction.RIGHT;
      possible_directions[1] = APP.Direction.RIGHT;
      possible_directions[2] = APP.Direction.RIGHT;
      possible_directions[3] = APP.Direction.RIGHT;
      possible_directions[4] = APP.Direction.RIGHT;
      possible_directions[5] = APP.Direction.RIGHT;
      possible_directions[6] = APP.Direction.UP;
      possible_directions[7] = APP.Direction.DOWN;
      possible_directions[8] = APP.Direction.LEFT;
      break;
    case APP.Direction.DOWN:
      possible_directions[0] = APP.Direction.DOWN;
      possible_directions[1] = APP.Direction.DOWN;
      possible_directions[2] = APP.Direction.DOWN;
      possible_directions[3] = APP.Direction.DOWN;
      possible_directions[4] = APP.Direction.DOWN;
      possible_directions[5] = APP.Direction.DOWN;
      possible_directions[6] = APP.Direction.UP;
      possible_directions[7] = APP.Direction.RIGHT;
      possible_directions[8] = APP.Direction.LEFT;
      break;
    case APP.Direction.LEFT:
      possible_directions[0] = APP.Direction.LEFT;
      possible_directions[1] = APP.Direction.LEFT;
      possible_directions[2] = APP.Direction.LEFT;
      possible_directions[3] = APP.Direction.LEFT;
      possible_directions[4] = APP.Direction.LEFT;
      possible_directions[5] = APP.Direction.LEFT;
      possible_directions[6] = APP.Direction.UP;
      possible_directions[7] = APP.Direction.RIGHT;
      possible_directions[8] = APP.Direction.DOWN;
      break;
  }
  rnd = Math.floor(Math.random() * direction_quantity);
  this.direction = possible_directions[rnd];
};</pre></div><p>Now, we<a class="indexterm" id="id254"/> have to check for the walls. We can do this by adding a few conditions to the function as shown in the following:</p><div class="informalexample"><pre class="programlisting">  APP.Check_Wall = function () {
    if (this.up) {
      if (APP.map.marks[this.y - 1][this.x] !== APP.WALL_MARK) {
        this.up = true;
        this.down = false;
        this.right = false;
        this.left = false;
      } else {
        this.direction = APP.Direction.STOP;
      }
    }

    if (this.right) {
      if (APP.map.marks[this.y][this.x + 1] !== APP.WALL_MARK) {
        this.up = false;
        this.down = false;
        this.right = true;
        this.left = false;
      } else {
        this.direction = APP.Direction.STOP;
      }
    }

    if (this.down) {
      if (APP.map.marks[this.y + 1][this.x] !== APP.WALL_MARK) {
        this.up = false;
        this.down = true;
        this.right = false;
        this.left = false;
      } else {
        this.direction = APP.Direction.STOP;
      }
    }

    if (this.left) {
      if (APP.map.marks[this.y][this.x - 1] !== APP.WALL_MARK) {
        this.up = false;
        this.down = false;
        this.right = false;
        this.left = true;
      } else {
        this.direction = APP.Direction.STOP;
      }
    }
  };</pre></div><p>The<a class="indexterm" id="id255"/> movement of the arrow keys should be well defined. We should create the following functions for the arrow keys:</p><div class="informalexample"><pre class="programlisting">APP.Move_Up = function () {
  if (this.frame === 0) {
    this.frame = this.speed;
    this.y--;
  } else {
    this.frame--;
  }
  if (this.y &lt; 0) {
    this.y = APP.MAP_HEIGHT - 1;
  }
};
APP.Move_Right = function () {
  if (this.frame === 0) {
    this.frame = this.speed;
    this.x++;
  } else {
    this.frame--;
  }
  if (this.x &gt;= APP.MAP_WIDTH) {
    this.x = 0;
  }
};
APP.Move_Down = function () {
  if (this.frame === 0) {
    this.frame = this.speed;
    this.y++;
  } else {
    this.frame--;
  }
  if (this.y &gt;= APP.MAP_HEIGHT) {
    this.y = 0;
  }
};
APP.Move_Left = function () {
  if (this.frame === 0) {
    this.frame = this.speed;
    this.x--;
  } else {
    this.frame--;
  }
  if (this.x &lt; 0) {
    this.x = APP.MAP_WIDTH - 1;
  }
};</pre></div></div><div class="section" title="The app.constants.js file"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec41"/>The app.constants.js file</h2></div></div></div><p>To keep <a class="indexterm" id="id256"/>our game's canvas clean and in good shape, we need to initialize a few variables with a few fixed variables (for example, height of map, height of cell, width of map, width of cell, and so on). We can do this by writing the following code in our <code class="literal">app.constants.js</code> file. Check the comments with the code to get a clear idea how the code will work:</p><div class="informalexample"><pre class="programlisting">var APP = {};
(function () {
  "use strict";
  //used for map's size and each cell's size
  APP.MAP_WIDTH = 28;
  APP.MAP_HEIGHT = 31;
  APP.CELL_WIDTH = 20;
  APP.CELL_HEIGHT = 20;
  APP.BG_COLOR = "#000000";
  APP.GAME_FPS = 40;
  APP.PLAYER_SPEED = 8;
  APP.INITIAL_PLAYER_FRAME = 8;
  APP.INITIAL_PLAYER_X = 14;
  APP.INITIAL_PLAYER_Y = 23;
  APP.WALL_CELL_DIGIT = 5;
  APP.BLANK_CELL_DIGIT = 6;
  APP.DOT_CELL_DIGIT = 7;
  APP.WALL_MARK = "W";
  APP.BLANK_MARK = "B";
  APP.DOT_MARK = "D";
  APP.PORTAL_BLINKING_SPEED = 2;
  APP.PORTAL_WIDTH = 20;
  APP.FIRST_PORTAL_X = 0;
  APP.FIRST_PORTAL_Y = 265;
  APP.SECOND_PORTAL_X = 510;
  APP.SECOND_PORTAL_Y = 265;
  APP.MONSTERS_QUANTITY = 4;
  APP.INKY_SPEED = 7;
  //for the cat's speed and position. 
  APP.INITIAL_INKY_X = 12;
  APP.INITIAL_INKY_Y = 14;
  APP.INITIAL_INKY_FRAME = 7;
  APP.PINKY_SPEED = 7;
  APP.INITIAL_PINKY_X = 13;
  APP.INITIAL_PINKY_Y = 14;
  APP.INITIAL_PINKY_FRAME = 4;
  APP.BLINKY_SPEED = 7;
  APP.INITIAL_BLINKY_X = 14;
  APP.INITIAL_BLINKY_Y = 11;
  APP.INITIAL_BLINKY_FRAME = 4;
  APP.CLYDE_SPEED = 7;
  APP.INITIAL_CLYDE_X = 15;
  APP.INITIAL_CLYDE_Y = 14;
  APP.INITIAL_CLYDE_FRAME = 7;
  APP.Direction = {
    UP      : "UP",
    RIGHT   : "RIGHT",
    DOWN    : "DOWN",
    LEFT    : "LEFT",
    STOP    : "STOP"
  };
})();</pre></div></div></div>
<div class="section" title="Playing the game"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec55"/>Playing the game</h1></div></div></div><p>If you<a class="indexterm" id="id257"/> correctly integrated the code and your HTML file now looks similar to the following, you can now run the HTML file:</p><div class="informalexample"><pre class="programlisting">&lt;html&gt;
  &lt;head&gt;
    &lt;link href="css/reset.css" rel="stylesheet"/&gt;
    &lt;link href="css/styles.css" rel="stylesheet"/&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;canvas id="main_canvas"&gt;&lt;/canvas&gt;
    &lt;button id="blackout" onclick="APP.Reset()"&gt;&lt;/button&gt;
    &lt;script src="scripts/app.constants.js"&gt;&lt;/script&gt;
    &lt;script src="scripts/app.init.js"&gt;&lt;/script&gt;
    &lt;script src="scripts/app.display_functions.js"&gt;&lt;/script&gt;
    &lt;script src="scripts/app.movement_functions.js"&gt;&lt;/script&gt;
    &lt;script src="scripts/app.key_handler.js"&gt;&lt;/script&gt;
    &lt;script src="scripts/app.main.js"&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div><p>After running the HTML file on your browser, you will be able to see the following screen:</p><div class="mediaobject"><img alt="Playing the game" src="graphics/B04720_08_02.jpg"/></div><p>Congratulations! You<a class="indexterm" id="id258"/> have successfully built Rat-man!</p><p>To play the game, click anywhere on the canvas and use the arrow keys for your rat's movement.</p><p>If you lose all your lives, you will see the following screen:</p><div class="mediaobject"><img alt="Playing the game" src="graphics/B04720_08_03.jpg"/></div><p>If you <a class="indexterm" id="id259"/>win, you will see the following screen:</p><div class="mediaobject"><img alt="Playing the game" src="graphics/B04720_08_04.jpg"/></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec56"/>Summary</h1></div></div></div><p>We have built the Rat-man! I hope that you are now playing the game that you have built. If you cannot play the game after coding for hours, don't worry. Keep calm and try again. The whole source code and required images are included in the book. You can download and run it. However, before doing this, I would suggest you to try at least twice. Let's move on to <a class="link" href="ch09.html" title="Chapter 9. Tidying up Your Code Using OOP">Chapter 9</a>, <span class="emphasis"><em>Tidying up Your Code Using OOP</em></span>, for a better idea about making files or folders and accessing them.</p></div></body></html>