<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Creating Custom Tasks</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem">Creating an alias task</li><li class="listitem">Creating a basic task</li><li class="listitem">Accessing project configuration</li><li class="listitem">Checking for required configurations</li><li class="listitem">Checking for the successful execution of other tasks</li><li class="listitem">Running non-blocking code in a task</li><li class="listitem">Failing a task</li><li class="listitem">Using command-line parameters</li><li class="listitem">Enqueuing tasks to run</li><li class="listitem">Creating a multi-task</li><li class="listitem">Using options in a task</li><li class="listitem">Using files in a task</li></ul></div><div><div><div><div><h1 class="title"><a id="ch08lvl1sec75"/>Introduction</h1></div></div></div><p>To truly begin appreciating the power and flexibility of Grunt, we have to delve into the creation of our own tasks.</p><p>On top of the vast array of plugins at our disposal, each of the tasks provided by them can be configured in a variety of ways that should cover most of our requirements. If, however, we do encounter a problem we cannot solve using an existing task and configuration combination, we can easily create a new task to fill in the gap.</p><p>We should also view the creation of tasks as the first stepping stone to creating plugins of our own. The methods of creating tasks discussed in this chapter will provide us with a simple laboratory, where we can build tasks that can eventually be transferred directly to a plugin.</p><div><h3 class="title"><a id="tip98"/>Tip</h3><p>The following two URLs provide a wealth of information on creating tasks and the tools Grunt makes available to build them. It is highly recommended that you go through these links if you are serious about creating tasks:</p><p><a class="ulink" href="http://gruntjs.com/creating-tasks">http://gruntjs.com/creating-tasks</a></p><p><a class="ulink" href="http://gruntjs.com/api/inside-tasks">http://gruntjs.com/api/inside-tasks</a></p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec76"/>Creating an alias task</h1></div></div></div><p>The tasks we <a id="id380" class="indexterm"/>configured for our project tend to perform a single function and nothing more. As a project grows, we will probably start to identify groups of tasks that we tend to run together, in a specific order. It is at this point that an alias task can become quite helpful to us as it allows us to group a set of tasks together under a new task name.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec179"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>This recipe also contains an example that makes use of the <em>Setting up a basic web server</em> and the <em>Watching files for changes</em> recipe of <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>, and the <em>Rendering Jade templates</em> recipe in <a class="link" title="Chapter 3. Templating Engines" href="part0031.xhtml#aid-TI1E1">Chapter 3</a>, <em>Templating Engines</em> in one setup. Be sure to refer to these if you'd like to gain a deeper understanding of each of these aspects.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec180"/>How to do it...</h2></div></div></div><p>The following steps will take us through building a basic website development setup that continuously renders HTML files from templates, serves them using a basic web server, and ensures a clean environment before starting by removing all previously rendered templates:</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by installing the packages that contains the <code class="literal">contrib-clean</code>, <code class="literal">contrib-connect</code>, <code class="literal">contrib-jade</code>, and <code class="literal">contrib-watch</code> plugins as per the instructions provided in the <em>Installing a plugin</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>.</li><li class="listitem">Next, we'll create a simple Jade template called <code class="literal">index.jade</code> in the <code class="literal">templates</code> directory, and provide it with the following contents:<div><pre class="programlisting">doctype html
html
  head
    title Sample Site
  body
    h1 Welcome to my Sample Site!</pre></div></li><li class="listitem">Now, we <a id="id381" class="indexterm"/>can add tasks to watch, render, serve, and clean our configuration:<div><pre class="programlisting">clean: {
  all: ['www']
},
jade: {
  www: {
    expand: true,
    cwd: 'templates',
    src: '**/*.jade',
    dest: 'www',
    ext: '.html'
  }
},
connect: {
  dev: {
    options: {
      base: 'www'
    }
  }
},
watch: {
  www: {
    files: 'templates/**/*.jade',
    tasks: ['jade:www']
  }
}</pre></div></li><li class="listitem">With all our tasks in place, we can now create an alias task called <code class="literal">run</code>, which ties them all together in the appropriate order. This is done by adding the following to the end of the main function in our Grunt configurations file:<div><pre class="programlisting">grunt.registerTask('run', [
  'clean:all',
  'jade:www',
  'connect:dev',
  'watch:www'
]);</pre></div></li><li class="listitem">We can now run the alias task just like a regular task by using the <code class="literal">grunt run</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "clean:all" (clean) task</strong>
<strong>&gt;&gt; 0 paths cleaned.</strong>

<strong>Running "jade:www" (jade) task</strong>
<strong>&gt;&gt; 1 file created.</strong>

<strong>Running "connect:dev" (connect) task</strong>
<strong>Started connect web server on http://localhost:8000</strong>

<strong>Running "watch" task</strong>
<strong>Waiting…</strong>
</pre></div></li><li class="listitem">As we can see from the output, our configured tasks have all run as per the order specified in the <code class="literal">run</code> task, and we are now serving the rendered <code class="literal">index.jade</code> template. To test the setup, we can navigate to <code class="literal">http://localhost:8000</code> in the browser, which will display the rendered template.</li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec181"/>There's more...</h2></div></div></div><p>There may <a id="id382" class="indexterm"/>be situations where we have a specific task that we'd like to run much more than others, so much so that we may come to think of it as the default task. In such a case, we can make use of the <code class="literal">default</code> task alias. This alias is called when there is no specific task indicated along with the <code class="literal">grunt</code> command.</p><p>We can modify our main recipe to make use of the <code class="literal">default</code> task by changing the alias task declaration to the following:</p><div><pre class="programlisting">grunt.registerTask(<strong>'default'</strong>, [
  'clean:all',
  'jade:www',
  'connect:dev',
  'watch:www'
]);</pre></div><p>If we now run the <code class="literal">grunt</code> command in our project without a task name following it, which should run all the tasks in the same way as it did in the previous section of this recipe.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec77"/>Creating a basic task</h1></div></div></div><p>Despite<a id="id383" class="indexterm"/> the large array of plugins available to Grunt users, situations might still arise where we would want to create tasks of our own. These situations are well provided for by Grunt, as it provides a set of utilities that make creating new ones quite simple.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec182"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec183"/>How to do it...</h2></div></div></div><p>The following <a id="id384" class="indexterm"/>steps will take us through creating a simple task that prints the current system date and time.</p><div><ol class="orderedlist arabic"><li class="listitem">First, we'll register our task with the name <code class="literal">datetime</code> and provide it with a description and an empty function as a placeholder. The following code shows the entire Grunt file with the task registration code highlighted:<div><pre class="programlisting">module.exports = function (grunt) {
  grunt.initConfig({});
  grunt.registerTask('default', []);
<strong>  grunt.registerTask(</strong>
<strong>    'datetime',</strong>
<strong>    'Prints out the current date and time.',</strong>
<strong>    function () {</strong>
<strong>    }</strong>
<strong>  );</strong>
};</pre></div></li><li class="listitem">With the task registered, we can now provide it with the code that will actually print the current date and time. The following code shows the task registration with the newly added code highlighted:<div><pre class="programlisting">grunt.registerTask(
  'datetime',
  'Prints out the current date and time.',
  function () {
    <strong>var date = new Date();</strong>
<strong>    grunt.log.writeln(date.toString());</strong>
  }
);</pre></div><div><h3 class="title"><a id="tip99"/>Tip</h3><p>This bit of code makes use of the standard JavaScript <code class="literal">Date</code> object and Grunt's <code class="literal">grunt.log</code> utility, which is specifically made available to tasks for logging all types of messages.</p><p>You can read more about the <code class="literal">grunt.log</code> utility<a id="id385" class="indexterm"/> at the following URL:</p><p><a class="ulink" href="http://gruntjs.com/api/grunt.log">http://gruntjs.com/api/grunt.log</a></p></div></li><li class="listitem">We can <a id="id386" class="indexterm"/>now try out a newly created task by running the <code class="literal">grunt datetime</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "datetime" task</strong>
<strong>Thu Jan 1 2015 12:00:00 GMT</strong>
</pre></div></li><li class="listitem">If the output of the task has presented us with the current system date and time, we have successfully created and executed our simple custom task.</li></ol><div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec78"/>Accessing project configuration</h1></div></div></div><p>In order <a id="id387" class="indexterm"/>for a task to function appropriately within a project, it often needs a way to get specific details about it. The standard practice for Grunt projects is to supply project-specific details in the configuration object provided in the <code class="literal">grunt.initConfig</code> function.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec184"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>If any of the steps in this recipe seem hard to follow, be sure to check out the <em>Creating a basic task</em> recipe provided earlier in this chapter.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec185"/>How to do it...</h2></div></div></div><p>The following steps will take us through creating a task that prints out a message determined by the project's configuration.</p><div><ol class="orderedlist arabic"><li class="listitem">First, we'll add some sample project configuration using the <code class="literal">grunt.initConfig</code> function. The following code shows the contents of the entire Grunt file with the configuration highlighted:<div><pre class="programlisting">module.exports = function (grunt) {
  grunt.initConfig({
    <strong>location: 'Earth',</strong>
<strong>    datetime: '&lt;%= new Date().toString() %&gt;',</strong>
<strong>    project: {</strong>
<strong>      name: 'Life'</strong>
<strong>    }</strong>
  });
  grunt.registerTask('default', []);
};</pre></div><div><h3 class="title"><a id="tip100"/>Tip</h3><p>Note the use of a template string in the <code class="literal">datetime</code> configuration. The following URL provides more information on using template strings in configuration values:</p><p><a class="ulink" href="http://gruntjs.com/configuring-tasks#templates">http://gruntjs.com/configuring-tasks#templates</a></p></div></li><li class="listitem">Next, we'll <a id="id388" class="indexterm"/>register our task with the name <code class="literal">describe</code> and provide it with a description and an empty function as a placeholder:<div><pre class="programlisting">grunt.registerTask(
  'describe',
  'Describes the situation.',
  function () {
  }
)</pre></div></li><li class="listitem">With the task registered, we can fill the empty function with the following code, which retrieves some project configurations and uses it when printing our message:<div><pre class="programlisting">var projectName = grunt.config('project.name');
var location = grunt.config('location');
var datetime = grunt.config('datetime');
grunt.log.write(
  projectName + ' on ' + location + ' at ' + datetime
);</pre></div><div><h3 class="title"><a id="tip101"/>Tip</h3><p>Here, we make use of the <code class="literal">grunt.config</code> function to fetch data from the configuration object provided in the <code class="literal">grunt.initConfig</code> function.</p><p>Note that dot notation can be used when retrieving the properties from objects in the configuration object, as demonstrated with the <code class="literal">projectName</code> variable.</p><p>Another concept demonstrated with the <code class="literal">datetime</code> variable is that values retrieved using the <code class="literal">grunt.config</code> function are rendered, meaning that any string containing templates will be parsed and rendered. If, for some reason, we'd like to fetch the un-rendered value, we can do so by making use of the <code class="literal">grunt.config.getRaw</code> function.</p></div></li><li class="listitem">We can <a id="id389" class="indexterm"/>now try out our custom task by running the <code class="literal">grunt describe</code> command, which should produce output similar to the following:<div><pre class="programlisting">Running "describe" task
Life on Earth at Thu Jan 1 2015 12:00:00 GMT</pre></div></li><li class="listitem">If the output of the task has presented us with a message containing the values we supplied in our project configuration, we have successfully created and executed a task that makes use of the project configuration.</li></ol><div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec79"/>Checking for required configurations</h1></div></div></div><p>It's quite <a id="id390" class="indexterm"/>common for tasks to require a minimum set of configurations in order for them to function properly. The Grunt framework provides the <code class="literal">grunt.config.requires</code> function specifically for this case, failing a task if the indicated configuration is not found.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec186"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>If any of the steps in this recipe seem hard to follow, be sure to check out the <em>Creating a basic task</em> recipe provided earlier in this chapter.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec187"/>How to do it...</h2></div></div></div><p>The following steps will take us through creating two tasks: the first will check for the required configurations that we will supply and the second will check for the configurations we will not supply.</p><div><ol class="orderedlist arabic"><li class="listitem">First, we'll add some sample project configurations using the <code class="literal">grunt.initConfig</code> function. The following code shows the contents of the entire Grunt file with the configurations highlighted:<div><pre class="programlisting">module.exports = function (grunt) {
  grunt.initConfig({
    <strong>integral: 'check',</strong>
<strong>    complex: {</strong>
<strong>      important: 'present'</strong>
<strong>    }</strong>
  });
};</pre></div></li><li class="listitem">Next, we'll register a task called <code class="literal">complete</code> that checks for the configurations that we supplied, by adding the following code after our <code class="literal">grunt.initConfig</code> call:<div><pre class="programlisting">grunt.registerTask(
  'complete',
  'Complete Configuration.',
  function () {
    grunt.config.requires('integral');
    grunt.config.requires('complex.important');
    grunt.log.write('Complete: Success!');
  }
);</pre></div></li><li class="listitem">Then, we <a id="id391" class="indexterm"/>can register a task called <code class="literal">incomplete</code>, which checks for a configuration that we have not supplied, by adding the following code:<div><pre class="programlisting">grunt.registerTask(
  'incomplete',
  'Incomplete Configuration.',
  function () {
    grunt.config.requires('missing');
    grunt.log.write('Incomplete: Success!');
  }
);</pre></div></li><li class="listitem">With our tasks added, we'll first run the task that will succeed by using the <code class="literal">grunt complete</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "complete" task</strong>
<strong>Complete: Success!</strong>
</pre></div></li><li class="listitem">Then, we can run the task that should fail by using the <code class="literal">grunt incomplete</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "incomplete" task</strong>
<strong>Verifying property missing exists in config...ERROR</strong>
<strong>&gt;&gt; Unable to process task.</strong>

<strong>Aborted due to warnings.</strong>
</pre></div></li><li class="listitem">As we can see from the output of the last task, it failed due to the <code class="literal">missing</code> configuration property not being found.</li></ol><div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec80"/>Checking for the successful execution of other tasks</h1></div></div></div><p>Due to<a id="id392" class="indexterm"/> it being detrimental to the reusability of a task, it's not at all common to have tasks depending on one another, due to it being detrimental to the reusability of a task. If tasks are so tightly coupled that they can't run independently, it should strongly be considered to combine them into a single task.</p><p>That being said, there are always exceptions, and Grunt provides for this by way of the <code class="literal">grunt.task.requires</code> function. When called, this function will check whether the task with the specified name has been successfully executed. If it finds that this is not the case, it will fail the current task.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec188"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>If any of the steps in this recipe seem hard to follow, be sure to check out the <em>Creating a basic task</em> recipe provided earlier in this chapter.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec189"/>How to do it...</h2></div></div></div><p>The following steps will take us through creating two tasks. The first task will print a simple message, and the second task will check whether the first one has been successfully executed.</p><div><ol class="orderedlist arabic"><li class="listitem">First, we'll register a task called <code class="literal">independent</code> that can run without any tasks having been run, and prints a message when it has done so. This is done by adding the following code to the main function in our Grunt file:<div><pre class="programlisting">grunt.registerTask(
  'independent',
  'Independent task.',
  function () {
    grunt.log.write('Independent: Success!')
  }
);</pre></div></li><li class="listitem">Next, we'll register a task called <code class="literal">dependent</code>, which will fail if the <code class="literal">independent</code> task did not run successfully. This is done by adding the following code to the main function in our Grunt file:<div><pre class="programlisting">grunt.registerTask(
  'dependent',
  'Dependent task.',
  function () {
    grunt.task.requires('independent');
    grunt.log.write('Dependent: Success!')
  }
);</pre></div></li><li class="listitem">To test <a id="id393" class="indexterm"/>this setup, we can first run the <code class="literal">dependent</code> task using the <code class="literal">grunt dependent</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "dependent" task</strong>
<strong>Warning: Required task "independent" must be run first. Use --force to continue.</strong>

<strong>Aborted due to warnings.</strong>
</pre></div></li><li class="listitem">As we can see from the output, this task has failed due to the <code class="literal">independent</code> task not having been executed successfully before attempting to run the <code class="literal">dependent</code> task.</li><li class="listitem">Finally, we can run the two tasks we created in succession using the <code class="literal">grunt independent dependent</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "independent" task</strong>
<strong>Independent: Success!</strong>
<strong>Running "dependent" task</strong>
<strong>Dependent: Success!</strong>
<strong>Done, without errors.</strong>
</pre></div></li><li class="listitem">This time around we can see that both the tasks ran without encountering any problems, and printed their respective messages.</li></ol><div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec81"/>Running non-blocking code in a task</h1></div></div></div><p>The <a id="id394" class="indexterm"/>majority of libraries <a id="id395" class="indexterm"/>available in the Node.js sphere tend to be implemented in such a way as to be non-blocking. This means that calling a function provided by a library will usually continue to execute the next line of code after being called, even though it has not fulfilled its intended purpose.</p><p>These types of functions tend to use either, or both, the event-driven approach or callback functions to indicate their progress. In either of these situations, we will require a function we can call once a task has been completed and for this purpose, Grunt provides us with the <code class="literal">this.async</code> utility.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec190"/>Getting ready</h2></div></div></div><p>In this <a id="id396" class="indexterm"/>example, we'll <a id="id397" class="indexterm"/>work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>If any of the steps in this recipe seem hard to follow, be sure to check out the <em>Creating a basic task</em> recipe provided earlier in this chapter.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec191"/>How to do it...</h2></div></div></div><p>The following steps will take us through creating a task that prints the current system time every second for 5 seconds and then exits.</p><div><ol class="orderedlist arabic"><li class="listitem">First, we'll register a task named <code class="literal">clock</code> with a description and an empty placeholder function by adding the following code to the end of the main function in our Grunt file:<div><pre class="programlisting">grunt.registerTask(
  'clock',
  'Prints the time every second for 5 seconds.',
  function () {
  }
);</pre></div></li><li class="listitem">Next, we'll define some variables inside our placeholder function that we'll be using in our time-printing code:<div><pre class="programlisting">var done = this.async();
var count = 5;
var interval = null;</pre></div><div><h3 class="title"><a id="tip102"/>Tip</h3><p>The <code class="literal">done</code> variable<a id="id398" class="indexterm"/> is the focus of this recipe as it demonstrates the usage of the <code class="literal">this.async</code> function. It is assigned the function that is returned by calling the <code class="literal">this.async</code> function. This returned function can be called to indicate whether the task has been completed.</p><p>The <code class="literal">count</code> variable<a id="id399" class="indexterm"/> will be used to keep track of the number of times the system time has been printed out. It will be decremented every time we print the date and time, and we'll stop printing the time when it reaches a value of <code class="literal">0</code>.</p><p>The <code class="literal">interval</code> variable<a id="id400" class="indexterm"/> is used to store the ID of the <strong>timer interval</strong><a id="id401" class="indexterm"/> that is started at the end of the task function. We need this ID to stop the timer interval from running once the <code class="literal">count</code> variable reaches a value of <code class="literal">0</code>.</p></div></li><li class="listitem">With all<a id="id402" class="indexterm"/> the required variables in place, we can now define the function that will print the current system date and time, and also stop the timer once it has run its course. The following code should be added immediately after the previous variable definitions:<div><pre class="programlisting">printTime = function () {
  grunt.log.writeln(new Date());
  count -= 1;
  if (count &lt;= 0) {
    clearInterval(interval);
    done();
  }
};</pre></div><div><h3 class="title"><a id="tip103"/>Tip</h3><p>Here, we make use of the <code class="literal">grunt.log</code> utility to print the current system date and time by providing it with a newly created built-in JavaScript <code class="literal">Date</code> object, which, by default, will always contain the current date and time.</p><p>We also <a id="id403" class="indexterm"/>decrement the count variable and check whether it is less than or equal to <code class="literal">zero</code>. If we find that it is lower than or equal to zero, we make use of the built-in <code class="literal">clearInterval</code> function to stop the running of the timer interval. We'll be assigning the timer interval ID to the <code class="literal">interval</code> variable in the next step.</p><p>Once we see that the counter has reached <code class="literal">0</code> and we've stopped the time interval, we can use the <code class="literal">done</code> function returned to us by the <code class="literal">this.async</code> function to indicate that the task has finished running.</p></div></li><li class="listitem">Finally, we'll start a timer interval that runs the function defined in our previous step every <code class="literal">1000</code> milliseconds by adding the following code immediately after our <code class="literal">printTime</code> function definition:<div><pre class="programlisting">interval = setInterval(printTime, 1000);</pre></div></li><li class="listitem">With our task now containing all the necessary code, we can try it out by running the <code class="literal">grunt clock</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "clock" task</strong>
<strong>Thu Apr 1 2015 12:00:00 GMT</strong>
<strong>Thu Apr 1 2015 12:00:01 GMT</strong>
<strong>Thu Apr 1 2015 12:00:02 GMT</strong>
<strong>Thu Apr 1 2015 12:00:03 GMT</strong>
<strong>Thu Apr 1 2015 12:00:04 GMT</strong>

<strong>Done, without errors.</strong>
</pre></div></li><li class="listitem">As can be seen <a id="id404" class="indexterm"/>in the output of the task, it <a id="id405" class="indexterm"/>has printed the current system date and time five times, and then stopped.</li></ol><div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec82"/>Failing a task</h1></div></div></div><p>The <a id="id406" class="indexterm"/>success or failure of a task can be used to indicate whether a task was completed without issue, or if a problem was encountered before it could perform its intended function. By default, Grunt will assume that a task has succeeded but it also provides us with a simple way to indicate whether a task has failed and pass on the reason for its failure.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec192"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>If any of the steps in this recipe seem hard to follow, be sure to check out the <em>Accessing project configuration</em> recipe provided earlier in this chapter.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec193"/>How to do it...</h2></div></div></div><p>The following steps will take us through creating a task whose success is based on the value of a project configuration property:</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by registering a task called <code class="literal">check</code> with a description and an empty placeholder function by adding the following code to the end of the main function in our Grunt file:<div><pre class="programlisting">grunt.registerTask(
  'check',
  'Fails if indicated in configuration.',
  function () {
  }
);</pre></div></li><li class="listitem">With the task registered, we can now fill the empty function with code that retrieves a project configuration property and uses it to decide whether it should fail the task:<div><pre class="programlisting">var fail = grunt.config('shouldFail');
if (fail === true) {
  return new Error('Error Message.');
} else {
  grunt.log.writeln('Success!');
}</pre></div><div><h3 class="title"><a id="tip104"/>Tip</h3><p>Note that we return a newly created <code class="literal">Error</code> object containing a message to indicate that the task has failed. If we simply wanted to fail the task without any message, we can just return the <code class="literal">false</code> value.</p></div></li><li class="listitem">With <a id="id407" class="indexterm"/>our task ready, we can add the required configuration property to indicate that it should not fail. The following code shows the entire <code class="literal">grunt.initConfig</code> call with the new configuration highlighted:<div><pre class="programlisting">grunt.initConfig({
  <strong>shouldFail: false</strong>
});</pre></div></li><li class="listitem">Now, we can run the task for the first time to see whether it succeeds as expected. This is done by using the <code class="literal">grunt check</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "check" task</strong>
<strong>Success!</strong>

<strong>Done, without errors.</strong>
</pre></div></li><li class="listitem">Now that we've seen the task succeed, we can change our configuration to indicate that we'd like for it to fail:<div><pre class="programlisting">grunt.initConfig({
  <strong>shouldFail: true</strong>
});</pre></div></li><li class="listitem">If we now run the task again using the <code class="literal">grunt check</code> command, it should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "check" task</strong>
<strong>Warning: Task "check" failed. Use --force to continue.</strong>

<strong>Aborted due to warnings.</strong>
</pre></div></li><li class="listitem">As we can see from the output, the task has failed as expected when setting the <code class="literal">shouldFail</code> configuration property to <code class="literal">true</code>.</li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec194"/>There's more...</h2></div></div></div><p>Since a task <a id="id408" class="indexterm"/>comes in a variety of types and structures, there are a variety of ways in which we'd like to indicate their failure. We'll now look at failing a non-blocking task and aborting a task immediately on failure.</p><div><div><div><div><h3 class="title"><a id="ch08lvl3sec108"/>Failing a non-blocking task</h3></div></div></div><p>In the <a id="id409" class="indexterm"/>case that we've made use of the <code class="literal">this.async</code> function to indicate whether our task should run in a non-blocking way, the return value of the task function becomes meaningless.</p><p>If we'd like to<a id="id410" class="indexterm"/> fail a non-blocking task, we can do so using the first parameter of the function returned from the call to the <code class="literal">this.async</code> method. Providing either <code class="literal">false</code> or an <code class="literal">Error</code> object using this parameter will indicate that the task has failed.</p><p>In the following example, we altered the task from our main recipe to run in a non-blocking way, and fail appropriately:</p><div><pre class="programlisting">grunt.registerTask(
  'check',
  'Fails if indicated in configuration.',
  function () {
<strong>    var done = this.async();</strong>
    var fail = grunt.config('shouldFail');
    if (fail === true) {
<strong>      done(new Error('Error Message.'));</strong>
    } else {
      grunt.log.writeln('Success!');
    }
  }
);</pre></div></div><div><div><div><div><h3 class="title"><a id="ch08lvl3sec109"/>Aborting a task immediately on failure</h3></div></div></div><p>At times, we<a id="id411" class="indexterm"/> might want to have a failing task abort the entire Grunt process as soon as a failure is encountered. This type of behavior is usually associated with what is commonly known as a fatal error.</p><p>The following example makes use of the <code class="literal">grunt.fail.fatal</code> utility to indicate that a fatal error has occurred, and that the Grunt process should exit without any further delay:</p><div><pre class="programlisting">grunt.registerTask(
  'check',
  'Fails if indicated in configuration.',
  function () {
    var fail = grunt.config('shouldFail');
    if (fail === true) {
      <strong>grunt.fail.fatal('Error message.');</strong>
    } else {
      grunt.log.writeln('Success!');
    }
  }
);</pre></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec83"/>Using command-line parameters</h1></div></div></div><p>In the case that a <a id="id412" class="indexterm"/>configurable aspect of a task needs to change quite often, it can be inefficient to add it to the project configuration. This is where the use of command-line parameters can be useful as they provide us with a way to easily provide options to our task, without having to alter our configuration.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec195"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>If any of the steps in this recipe seem hard to follow, be sure to check out the <em>Creating a basic task</em> recipe provided earlier in this chapter.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec196"/>How to do it...</h2></div></div></div><p>The following steps will take us through creating a task that receives two strings using command-line parameters and uses them to print a message:</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by registering a task called <code class="literal">welcome</code> with a description and an empty placeholder function by adding the following code to the end of the main function in our Grunt file:<div><pre class="programlisting">grunt.registerTask(
  'welcome',
  'Displays a welcome message.',
  function () {
  }
);</pre></div></li><li class="listitem">With the task registration setup, we can now fill the empty function with code that receives the command-line parameters and uses them to print a message:<div><pre class="programlisting">var message = 'Welcome to ' + city + ', ' + name + '!';
grunt.log.writeln(message);</pre></div></li><li class="listitem">Now, we <a id="id413" class="indexterm"/>can run the task using some example parameters. This is done by using the <code class="literal">grunt welcome:Aaron:London</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "welcome:Aaron:London" (welcome) task</strong>
<strong>Welcome to London, Aaron!</strong>
</pre></div><div><h3 class="title"><a id="tip105"/>Tip</h3><p>Note that if your task makes use of targets, the first parameter will always be assumed to be the name of the target, and will not be passed on to the task function.</p></div></li><li class="listitem">As we can see from the output, the task has successfully received the parameters we supplied to it and used them to display a welcome message.</li></ol><div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec84"/>Enqueuing tasks to run</h1></div></div></div><p>There <a id="id414" class="indexterm"/>might come a time that we would like to enqueue the running of the existing tasks from within our own task. This practice is not recommended because a well-designed task should usually be focused on a particular function and remain loosely coupled from other tasks. Tasks designed in this fashion generally tend to be more robust and useful in a larger variety of situations.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec197"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>If any of the steps in this recipe seem hard to follow, be sure to check out the <em>Creating a basic task</em> recipe provided earlier in this chapter.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec198"/>How to do it...</h2></div></div></div><p>The following steps will take us through creating two simple tasks that print a string with one of the tasks enqueuing the other inside itself:</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by registering a task called <code class="literal">first</code> that prints out a string. This can be done by adding the following code to the end of the main function in our Grunt file:<div><pre class="programlisting">grunt.registerTask('first', function() {
  grunt.log.write('First Task');
});</pre></div></li><li class="listitem">Next, we'll <a id="id415" class="indexterm"/>register another task after the one we just added called <code class="literal">second</code>. This task will also print a string and then proceed to enqueue the <code class="literal">first</code> task for running:<div><pre class="programlisting">grunt.registerTask('second', function() {
  grunt.log.write('Second Task');
  grunt.task.run('first');
});</pre></div></li><li class="listitem">Now that we've created our two tasks, we can try them out by running the <code class="literal">grunt second</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "second" task</strong>
<strong>Second Task</strong>
<strong>Running "first" task</strong>
<strong>First Task</strong>
</pre></div></li><li class="listitem">As we can see from the output, the <code class="literal">second</code> task that we ran enqueued the <code class="literal">first</code> task, which also ran.</li></ol><div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec85"/>Creating a multi-task</h1></div></div></div><p>Task configurations<a id="id416" class="indexterm"/> provide the most common way of tweaking the functionality of the tasks that we use in our project. With configurations, we can set up a task to fulfill our specific needs, and it also allows us to use the same task in various ways within a single project. The different configurations applied to the same task are called <a id="id417" class="indexterm"/>
<strong>task targets</strong>.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec199"/>Getting ready</h2></div></div></div><p>In this example, we'll work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>If any of the steps in this recipe seem hard to follow, be sure to check out the <em>Creating a basic task</em> recipe provided earlier in this chapter.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec200"/>How to do it...</h2></div></div></div><p>The following <a id="id418" class="indexterm"/>steps will take us through creating a simple task that prints the name of the target configuration and the data supplied to it:</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by registering a multi-task called <code class="literal">display</code> using the <code class="literal">registerMultiTask</code> function by adding the following code to the end of the main function in our Grunt file:<div><pre class="programlisting">grunt.registerMultiTask(
  'display',
  'Displays target name and related configuration',
  function() {
  }
);</pre></div></li><li class="listitem">With the task registered, we can fill the empty function with the following code that prints a message containing the name of the specified target and the data provided for it:<div><pre class="programlisting">grunt.log.write(
  'Displaying ' + this.target + ' with ' + this.data
);</pre></div><div><h3 class="title"><a id="tip106"/>Tip</h3><p>Note that it's only inside the scope of task functions registered using <code class="literal">registerMultiTask</code> that <code class="literal">this.target</code> and <code class="literal">this.data</code> will be populated with the target name and configuration data.</p></div></li><li class="listitem">Now that we have a registered and functional task, we can set up some sample configuration to our <code class="literal">grunt.initConfig</code> call, which we'll use to demonstrate the task's behavior:<div><pre class="programlisting">grunt.initConfig({
  <strong>display: {</strong>
<strong>    foo: 'these configurations',</strong>
<strong>    bar: 'those configurations'</strong>
<strong>  }</strong>
});</pre></div></li><li class="listitem">With our task created and configured, we can try it out by running the <code class="literal">grunt display</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "display:foo" (display) task</strong>
<strong>Displaying foo with these configurations</strong>
<strong>Running "display:bar" (display) task</strong>
<strong>Displaying bar with those configurations</strong>
</pre></div></li><li class="listitem">We can now also try to indicate that we'd like to use only the <code class="literal">foo</code> configuration target by running the <code class="literal">grunt display:foo</code> command, which should <a id="id419" class="indexterm"/>produce output similar to the following:<div><pre class="programlisting">
<strong>Running "display:foo" (display) task</strong>
<strong>Displaying foo with these configurations</strong>
</pre></div></li></ol><div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec86"/>Using options in a task</h1></div></div></div><p>The <a id="id420" class="indexterm"/>most common <a id="id421" class="indexterm"/>way of tweaking the functionality of a task is by providing options in the project configurations. Options can be specified by providing an object to the <code class="literal">options</code> property at either the task or target levels. If an option is provided at both the task and target levels, the one provided at the target level will take precedence.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec201"/>Getting ready</h2></div></div></div><p>In this example we'll work with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>If any of the steps in this recipe seem hard to follow, be sure to check out the <em>Creating a multi-task</em> recipe provided earlier in this chapter.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec202"/>How to do it...</h2></div></div></div><p>The following steps will take us through creating a multi-task that prints out the value of an option provided at the two available levels in two different tasks:</p><div><ol class="orderedlist arabic"><li class="listitem">We'll start by registering a multi-task called <code class="literal">display</code> using the <code class="literal">registerMultiTask</code> function by adding the following code to the end of the main function in our Grunt file:<div><pre class="programlisting">grunt.registerMultiTask(
  'display',
  "Displays the value of the 'foo' option",
  function() {
  }
);</pre></div></li><li class="listitem">With<a id="id422" class="indexterm"/> the task registered, we can fill the empty function with the following code that prints a message containing the value of the <code class="literal">foo</code> option:<div><pre class="programlisting">var options = this.options();
grunt.log.write("The value of foo is '" + options.foo + "'.");</pre></div><div><h3 class="title"><a id="tip107"/>Tip</h3><p>Note that the <code class="literal">this.options</code> method<a id="id423" class="indexterm"/> provided in the scope <a id="id424" class="indexterm"/>of the task function will automatically merge the task and target options, overriding the task options if they are provided in the target.</p><p>For more information about the <code class="literal">this.options</code> method, visit the following URL:</p><p><a class="ulink" href="http://gruntjs.com/api/inside-tasks#this.options">http://gruntjs.com/api/inside-tasks#this.options</a></p></div></li><li class="listitem">Now that <a id="id425" class="indexterm"/>we have a registered and functional task, we can set up some sample configuration, which we'll use to demonstrate the task's behavior:<div><pre class="programlisting">grunt.initConfig({
  <strong>display: {</strong>
<strong>    options: {</strong>
<strong>      foo: 'initial'</strong>
<strong>    },</strong>
<strong>    first: {},</strong>
<strong>    second: {</strong>
<strong>      options: {</strong>
<strong>        foo: 'override'</strong>
<strong>      }</strong>
<strong>    }</strong>
<strong>  }</strong>
});</pre></div></li><li class="listitem">With our task created and supplied with a sample configuration, we can try it out with the <code class="literal">first</code> target by running the <code class="literal">grunt display:first</code> command, which should provide output similar to the following:<div><pre class="programlisting">
<strong>Running "display:first" (display) task</strong>
<strong>The value of foo is 'initial'.</strong>
</pre></div></li><li class="listitem">Now that <a id="id426" class="indexterm"/>we've seen how the <code class="literal">first</code> target behaves, we can try it out with the <code class="literal">second</code> target by running the <code class="literal">grunt display:second</code> command, which <a id="id427" class="indexterm"/>should produce output similar to the following:<div><pre class="programlisting">Running "display:second" (display) task
The value of foo is 'override'.</pre></div></li></ol><div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec87"/>Using files in a task</h1></div></div></div><p>Tasks are<a id="id428" class="indexterm"/> commonly required to access a specific set of files, either using the data they <a id="id429" class="indexterm"/>contain, or altering it in some way. Grunt provides a uniform way of specifying sets of files using the <code class="literal">src</code>, <code class="literal">dest</code>, and <code class="literal">files</code> properties that can be used at either the task or target levels.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec203"/>Getting ready</h2></div></div></div><p>In this example, we'll be working with the basic project structure we created in the <em>Installing Grunt on a project</em> recipe in <a class="link" title="Chapter 1. Getting Started with Grunt" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Getting Started with Grunt</em>. Be sure to refer to it if you are not yet familiar with its contents.</p><p>If any of the steps in this recipe seem hard to follow, be sure to check out the <em>Creating a multi-task</em> recipe provided earlier in this chapter.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec204"/>How to do it...</h2></div></div></div><p>The following steps will take us through creating some sample data files and a simple task that prints their contents:</p><div><ol class="orderedlist arabic"><li class="listitem">Let's start by creating two sample files called <code class="literal">one.dat</code> and <code class="literal">two.dat</code> in a new directory called <code class="literal">data</code> and providing them with the following contents:<div><pre class="programlisting">one.dat - Initial sample data.
two.dat - Some more sample data.</pre></div></li><li class="listitem">Next, we'll register a multi-task called <code class="literal">display</code> using the <code class="literal">registerMultiTask</code> function by adding the following code to the end of the main function in our Grunt file:<div><pre class="programlisting">grunt.registerMultiTask(
  'display',
  "Displays the contents of the specified files.",
  function() {
  }
);</pre></div></li><li class="listitem">With the <a id="id430" class="indexterm"/>task registered, we can now fill the empty function with the following code that iterates over the indicated files and prints out their contents:<div><pre class="programlisting">this.files.forEach(function(file) {
  file.src.forEach(function(filepath) {
    var content = grunt.file.read(filepath);
    grunt.log.write(content);
  });
});</pre></div><div><h3 class="title"><a id="tip108"/>Tip</h3><p>Note that the <code class="literal">this.files</code> property<a id="id431" class="indexterm"/> is only provided inside the scope of a multi-task's function. It provides a normalized list of all file configurations <a id="id432" class="indexterm"/>provided at both the task and target levels.</p><p>For more information about the <code class="literal">this.files</code> property, visit the following URL:</p><p><a class="ulink" href="http://gruntjs.com/api/inside-tasks#this.files">http://gruntjs.com/api/inside-tasks#this.files</a></p></div></li><li class="listitem">In order to<a id="id433" class="indexterm"/> demonstrate our task, we can now add some configuration to our <code class="literal">grunt.initConfig</code> call, which will target all the files contained in the <code class="literal">data</code> directory:<div><pre class="programlisting">grunt.initConfig({
  <strong>display: {</strong>
<strong>    sample: {</strong>
<strong>      src: 'data/*'</strong>
<strong>    }</strong>
<strong>  }</strong>
});</pre></div></li><li class="listitem">With everything set up, we can now give the task a try by running the <code class="literal">grunt display</code> command, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "display:sample" (display) task</strong>
<strong>Initial sample data.</strong>
<strong>Some more sample data.</strong>
</pre></div></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec205"/>There's more...</h2></div></div></div><p>Apart from just reading from files, we will probably reach a point where we'd like to write to a file. The following <a id="id434" class="indexterm"/>steps alter the previous recipe in such a way as to write the contents of the indicated files to a destination file instead of printing it to the console:</p><div><ol class="orderedlist arabic"><li class="listitem">First, we'll change the code in the function of the <code class="literal">display</code> task we registered earlier to the following:<div><pre class="programlisting">this.files.forEach(function(file) {
  <strong>var content = file.src.map(function(filepath) {</strong>
<strong>    return grunt.file.read(filepath);</strong>
<strong>  }).join('');</strong>
<strong>  grunt.file.write(file.dest, content);</strong>
});</pre></div></li><li class="listitem">Next, we'll alter the project configuration to indicate a destination file that the output should be written to:<div><pre class="programlisting">grunt.initConfig({
  display: {
    sample: {
      src: 'data/*',
      <strong>dest: 'output.dat'</strong>
    }
  }
});</pre></div></li><li class="listitem">We can now try <a id="id435" class="indexterm"/>out our modified task by running the <code class="literal">grunt display</code> command again, which should produce output similar to the following:<div><pre class="programlisting">
<strong>Running "display:sample" (display) task</strong>
</pre></div></li><li class="listitem">A file named <code class="literal">output.dat</code> with the following contents should now be present in our project folder:<div><pre class="programlisting">Initial sample data.
Some more sample data.</pre></div></li></ol><div></div></div></div></body></html>