<html><head></head><body><div class="chapter" title="Chapter&#xA0;1.&#xA0;Instant Testing with CasperJS"><div class="titlepage"><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Instant Testing with CasperJS</h1></div></div></div><p>Welcome to <span class="emphasis"><em>Instant Testing with CasperJS</em></span>. This book will cover how to practice efficient and solid web page testing using CasperJS. CasperJS is a cross-platform, command-line utility that is able to load and script any web page.</p><div class="section" title="Installing CasperJS (Simple)"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec08"/>Installing CasperJS (Simple)</h1></div></div></div><p>In this recipe, we will cover the steps to install CasperJS and its dependencies on Windows, Mac OS X, and Linux.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec07"/>Getting ready</h2></div></div></div><p>The CasperJS sources are managed on GitHub. So, to get them on our local machine, we need Git.</p><p>To install Git on Windows, we can use msysGit to deploy the Git command-line utility plus a graphical interface:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to <a class="ulink" href="http://msysgit.github.io/">http://msysgit.github.io/</a>.</li><li class="listitem">Go to the <span class="strong"><strong>Downloads</strong></span> page.</li><li class="listitem">Download the latest version.</li><li class="listitem">Run the installer.</li></ol></div><p>To install Git on Mac, the easiest way is to use Git for OS X graphical interface:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to <a class="ulink" href="https://code.google.com/p/git-osx-installer/">https://code.google.com/p/git-osx-installer/</a>.</li><li class="listitem">Go to the <span class="strong"><strong>Downloads</strong></span> page.</li><li class="listitem">Download the latest version.</li><li class="listitem">Run the installer.</li></ol></div><p>You can also install Git from the MacPorts:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Make sure MacPorts is installed (if not, go to <a class="ulink" href="http://www.macports.org/">http://www.macports.org/</a> and follow the instructions).</li><li class="listitem">From a command line, enter the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo port install git-core +svn +doc +bash_completion +gitweb</strong></span>
</pre></div></li></ol></div><p>To install Git on Linux, use the following commands:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For Debian/Ubuntu, enter the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install git</strong></span>
</pre></div></li><li class="listitem" style="list-style-type: disc">For Fedora, enter the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ yum install git-core</strong></span>
</pre></div></li></ul></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec08"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First of all, we need to install PhantomJS.<p>Perform the following steps to install PhantomJS on Windows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to <a class="ulink" href="http://phantomjs.org/download.html">http://phantomjs.org/download.html</a>.</li><li class="listitem">Download the Windows version.</li><li class="listitem">Extract its content.</li><li class="listitem">Add the <code class="literal">phantomjs.exe</code> path to the <code class="literal">PATH</code> environment variable, assuming it is located at <code class="literal">C:\PhantomJS</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>...the existing PATH value...;C:\PhantomJS</strong></span>
</pre></div></li></ol></div><p>Perform the following steps to install PhantomJS on Mac and Linux:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to <a class="ulink" href="http://phantomjs.org/download.html">http://phantomjs.org/download.html</a>.</li><li class="listitem">Download the appropriate version (Mac OS X / Linux 32 bits / Linux 64 bits).</li><li class="listitem">Extract its content.</li><li class="listitem">Make <code class="literal">bin/phamtomjs</code> available in your system path using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>~ sudo ln -s &lt;path-to-extracted-folder&gt;/bin/phantomjs /usr/local/bin</strong></span>
</pre></div></li></ol></div><p>Now we should be able to run <code class="literal">phantomjs</code> from a command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>~  phantomjs --version</strong></span>
<span class="strong"><strong>1.9.0</strong></span>
</pre></div></li><li class="listitem">Now, we can install CasperJS using Git. We need to locally clone the official CasperJS repository from GitHub.<p>This can be achieved using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>~ git clone git://github.com/n1k0/casperjs.git</strong></span>
</pre></div><p>This should produce an output similar to the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Cloning into 'casperjs'...</strong></span>
<span class="strong"><strong>remote: Counting objects: 11156, done.</strong></span>
<span class="strong"><strong>remote: Compressing objects: 100% (4927/4927), done.</strong></span>
<span class="strong"><strong>remote: Total 11156 (delta 6580), reused 10692 (delta 6167)</strong></span>
<span class="strong"><strong>Receiving objects: 100% (11156/11156), 6.85 MiB | 113 KiB/s, done.</strong></span>
<span class="strong"><strong>Resolving deltas: 100% (6580/6580), done.</strong></span>
</pre></div></li><li class="listitem">To check out the last stable version, we need to run the following Git command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>~ git checkout tags/1.1-beta3</strong></span>
</pre></div><p>We will get the following message:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Note: checking out 'tags/1.1-beta3'.</strong></span>


<span class="strong"><strong>..</strong></span>

<span class="strong"><strong>HEAD is now at bc0da16... bump 1.1-beta3</strong></span>
</pre></div></li><li class="listitem">Let's check if CasperJS is properly installed.<p>To check if CasperJS is installed properly on Windows, use the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>~ cd casperjs</strong></span>
<span class="strong"><strong>~ bin\batchbin\casperjs.bat --version</strong></span>
</pre></div><p>To check if CasperJS is installed properly on Mac OS X / Linux, use the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>~ cd ./casperjs</strong></span>
<span class="strong"><strong>~ bin/casperjs --version</strong></span>
</pre></div><p>We should obtain the following result:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>1.1.0-beta3</strong></span>
</pre></div></li><li class="listitem">To complete the installation, we will now make sure that the <code class="literal">casperjs</code> executable is available in our system path.<p>To complete the installation on Windows add the following path to <code class="literal">casperjs.bat</code> to the <code class="literal">PATH</code> environment variable, assuming the repository is located in <code class="literal">C:\casperjs</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>...the existing PATH value...;C:\casperjs\batchbin</strong></span>
</pre></div><p>To complete the installation on Mac and Linux, link <code class="literal">bin/casperjs</code> in <code class="literal">/usr/local/bin</code> using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>~ sudo ln -s `pwd`/bin/casperjs /usr/local/bin</strong></span>
</pre></div><p>We can check if <code class="literal">casperjs</code> is in the system path using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>~ casperjs --version</strong></span>
<span class="strong"><strong>1.1.0-beta3</strong></span>
</pre></div></li></ol></div><p>The setup is now complete.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec09"/>How it works...</h2></div></div></div><p>Just after cloning the repository, we launched a Git command to get the Version 1.1 (which was still a beta version at the time we were writing those lines).</p><p>If we had not launched the Git command, we would still have had a correct CasperJS setup, but be careful; Git has downloaded all the CasperJS revisions since the very beginning of CasperJS's development till today, and <span class="emphasis"><em>has automatically checked out the last one</em></span>. So, we try using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>~ bin/casperjs --version</strong></span>
</pre></div><p>We will obtain something similar to the following result:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>1.1.0-DEV</strong></span>
</pre></div><p>It means that we are running the current development version and using a development version is probably not what we want as it might be unstable or even broken.</p><p>That is why we need to check out the 1.1 tagged revision specifically.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec10"/>There's more...</h2></div></div></div><p>Now, let's discuss some installation options.</p><div class="section" title="Installing CasperJS with Homebrew on Mac OS X"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec01"/>Installing CasperJS with Homebrew on Mac OS X</h3></div></div></div><p>Homebrew is a package manager for Mac OS X. It is a very handy way to deploy PhantomJS and CasperJS using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>~ brew install casperjs</strong></span>
</pre></div></div><div class="section" title="Installing PhantomJS on Ubuntu"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec02"/>Installing PhantomJS on Ubuntu</h3></div></div></div><p>Be careful; on Ubuntu, if we install PhantomJS from the distribution packages, we will get an old version (Version 1.4 or 1.6, depending on our Ubuntu version).</p><p>But CasperJS needs at least PhantomJS 1.7. So, package installation is not an option.</p></div><div class="section" title="Using the CasperJS Ruby executable"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec03"/>Using the CasperJS Ruby executable</h3></div></div></div><p>On Mac OS X and Linux, the default <code class="literal">casperjs</code> executable is a Python script. Python should be available on our system (unless we use an exotic Linux distribution), so it makes no problem.</p><p>Nevertheless, if we prefer to launch CasperJS using a Ruby script, we do have one in <code class="literal">./rubybin</code>. So, we just need to make it available in our system path this way:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>~ ln -sf `pwd`/rubybin/casperjs /usr/local/bin/casperjs</strong></span>
</pre></div></div></div></div></div>
<div class="section" title="Getting started with CasperJS (Simple)"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Getting started with CasperJS (Simple)</h1></div></div></div><p>This recipe will explain how to write basic CasperJS tests and will help us get familiar with the CasperJS approach.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec11"/>Getting ready</h2></div></div></div><p>In this recipe, we will build simple web pages in order to run our CasperJS tests in an appropriate context.</p><p>As we need to serve just static content (HTML, CSS, JavaScript), we need a very basic HTTP server and the simplest existing HTTP server is the Python 2 SimpleHTTTPServer, as it is part of the standard Python installation (so that no extra deployment is needed), and it does not need any system configuration.</p><p>On Mac OS X and Linux, Python 2 is part of the system; we just launch the following command line from the folder containing our web content:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>~ python -m SimpleHTTPServer</strong></span>
</pre></div><p>The preceding command should return this message:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Serving HTTP on 0.0.0.0 port 8000 …</strong></span>
</pre></div><p>The message means that our local web server is running on the <code class="literal">8000</code> port and we can access it with our web browser using the following URL:</p><p><code class="literal">http://localhost:8000/</code></p><p>On Windows, we can do the very same thing but Python is not installed by default, so we first need to install it this way:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to <a class="ulink" href="http://www.python.org/getit/">http://www.python.org/getit/</a>.</li><li class="listitem">Download the Python 2.7 Windows installer.</li><li class="listitem">Run it.</li><li class="listitem">Add Python to our system path:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>...the existing PATH value...;C:\Python27\</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec12"/>How to do it...</h2></div></div></div><p>We are now ready to write CasperJS tests. For our first test, we will not need our local web server as we will use the Wikipedia website:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's create the following file and name it <code class="literal">example1.js</code>:<div class="informalexample"><pre class="programlisting">var casper = require('casper').create();

casper.start('http://en.wikipedia.org/', function() {
    this.echo(this.getTitle());
});

casper.run();</pre></div></li><li class="listitem">When we run our script, we get the following output:<div class="mediaobject"><img src="graphics/9431OS_01_01.jpg" alt="How to do it..."/></div></li><li class="listitem">Let's see how it works:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In the first line, we get a new <code class="literal">'casper'</code> instance.</li><li class="listitem" style="list-style-type: disc">Then, in the second line, we start this instance and open the Wikipedia page.</li><li class="listitem" style="list-style-type: disc">We give the <code class="literal">start()</code> method a function that will be executed once the page is loaded. In this function, the context (<code class="literal">this</code>) is the <code class="literal">casper</code> instance. Here, we just use the <code class="literal">echo()</code> method to display the current page title (obtained using <code class="literal">getTitle()</code>).</li><li class="listitem" style="list-style-type: disc">In the last line, we launch the registered steps.</li></ul></div><p>Now, let's change a little bit of our script in order to perform a search on Wikipedia about <code class="literal">'javascript'</code>:</p><div class="informalexample"><pre class="programlisting">var casper = require('casper').create();

casper.start('http://en.wikipedia.org/', function() {
    this.echo(this.getTitle());
    this.fill('form#searchform', {
        'search': 'javascript'
    }, true);
});

casper.then(function() {
   this.echo(this.getCurrentUrl());
})

casper.run();</pre></div></li><li class="listitem">Let's run it:<div class="mediaobject"><img src="graphics/9431OS_01_02.jpg" alt="How to do it..."/></div><p>We have made two changes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We used the <code class="literal">fill()</code> method to submit our search keyword to the Wikipedia search form</li><li class="listitem" style="list-style-type: disc">We added a new step in our script using the <code class="literal">then()</code> method to make sure that we wait for the search result to be returned; we also displayed the current URL</li></ul></div><p>As we can see, it works perfectly as we obtained the URL of the Wikipedia article about JavaScript. Now, let's "assert" the world!</p><p>We just wrote a basic CasperJS script, but it is not a very efficient test script as a test script is supposed to check if an expected behavior is properly performed by the web page that we are testing.</p><p>To do that, CasperJS provides a tester API, which can be accessed via the <code class="literal">test</code> property of our CasperJS instance.</p></li><li class="listitem">Let's create the following example page and name it <code class="literal">example2.html</code>:<div class="informalexample"><pre class="programlisting">&lt;html&gt;&lt;body&gt;
   &lt;button id="button1" onclick="this.innerText='Done';"&gt;Click me&lt;/button&gt;
&lt;/body&gt;&lt;/html&gt;</pre></div><p>Now, let's launch our SimpleHTTPServer and see what the page looks like by going to <code class="literal">http://localhost:8000/example2.html</code>.</p><p>It shows a <span class="strong"><strong>Click me</strong></span> button and if we click on it, its label is changed to <span class="strong"><strong>Done</strong></span>.</p></li><li class="listitem">The following is a CasperJS test that could validate this behavior:<div class="informalexample"><pre class="programlisting">casper.test.begin('Test my form', 3, function(test) {
    casper.start('http://localhost:8000/example2.html', function() {
        test.assertVisible("button#button1");
        test.assertSelectorHasText("button#button1", "Click me");
    });

    casper.then(function() {
        this.click("button#button1");
    });

    casper.then(function() {
      test.assertSelectorHasText("button#button1", "Done");
    })

    casper.run(function() {
        test.done();
    });
});</pre></div></li><li class="listitem">Let's save this script as <code class="literal">example2.js</code> and run it using the <code class="literal">casperjs test</code> command:<div class="mediaobject"><img src="graphics/9431OS_01_03.jpg" alt="How to do it..."/></div><p>The <code class="literal">casperjs test</code> command allows us to use the <code class="literal">casper.test</code> property, which provides all the testing methods.</p><p>When using the <code class="literal">casperjs test</code> command, we do not need to create the <code class="literal">casper</code> instance, but we need to call the <code class="literal">begin</code> method and end the test with the <code class="literal">done</code> method.</p></li><li class="listitem">First, with <code class="literal">assertVisible</code>, we make sure that our button is visible. The most common way to designate an element is by providing an accurate CSS selector.</li><li class="listitem">Then, we use <code class="literal">assertSelectorHasText</code> to check the text content of the button before and after clicking on it. We can see that all our tests pass.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip02"/>Tip</h3><p>The <code class="literal">begin</code> method takes a description and the number of expected tests (beside the test itself) as parameters. The number of successful and failed tests are displayed in the final line.</p></div></div></li><li class="listitem">Now, let's break our tests by changing the second <code class="literal">assertSelectorHasText</code> tester as shown in the following code:<div class="informalexample"><pre class="programlisting">this.test.assertSelectorHasText("button#button1", "You can click again");</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip03"/>Tip</h3><p><span class="strong"><strong>Downloading the example code</strong></span></p><p>You can download the example code files for all Packt books you have purchased from your account at <a class="ulink" href="http://www.PacktPub.com">http://www.PacktPub.com</a>. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.PacktPub.com/support">http://www.PacktPub.com/support</a> and register to have the files e-mailed directly to you.</p></div></div></li><li class="listitem">And the result is as follows:<div class="mediaobject"><img src="graphics/9431OS_01_04.jpg" alt="How to do it..."/></div><p>We clearly see that our two assertions still pass, but one is now failing.</p></li></ol></div><div class="section" title="Timing is everything"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec04"/>Timing is everything</h3></div></div></div><p>When developing with JavaScript, we often need to chain two pieces of code (for instance, first we load some JSON data, then we update the page content using that data). But, each step is generally non-blocking, which means that the rest of the code will continue to execute even if the step is not complete, and there is no way to predict when the first step will be complete.</p><p>The most solid and common approach to solve this problem is the <span class="emphasis"><em>callback</em></span> mechanism. We put the second piece of code in a function and pass it as a parameter to the first one, so that it can call that function when it finishes.</p><p>As a result, there is no linear and predictably-ordered execution of the code. This makes testing a little bit tricky.</p><p>The following is an example (<code class="literal">example3.html</code>):</p><div class="informalexample"><pre class="programlisting">&lt;html&gt;
&lt;head&gt;
   &lt;script type='text/javascript' src='http://code.jquery.com/jquery-1.9.1.js'&gt;&lt;/script&gt;
   &lt;style&gt;
   .searching { color: grey;}
   .success { color: green;}
   .noresults {color: red;}
   &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
   &lt;script&gt;
   function geonamesSearch() {
      $('#results').html("Searching...");
      $('#results').attr('class', 'searching');
      var url = "http://api.geonames.org/searchJSON";
      var query = $('#searchedlocation').val();
        $.getJSON(url + "?username=demo&amp;q="+ query +"&amp;maxRows=25&amp;featureClass=P",null,            function(data) {
                var data = data.geonames;
                var names = [];
                if(data.length &gt; 0) {
                    $.each(data, function(i, val){  
                        names.push(val.name +" ("+val.adminName1+")");
                    });
                    $('#results').html(names.join("&lt;br/&gt;"));
                    $('#results').attr('class', 'success');
                } else {
                    $('#results').html("No matching place.");
                    $('#results').attr('class', 'noresults');
                }
            }
        );
   }
   &lt;/script&gt;
   &lt;input type="text" id="searchedlocation" /&gt;
   &lt;button id="search" onclick="geonamesSearch();"&gt;Click me&lt;/button&gt;
   &lt;div id="results"&gt;&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div><p>The demo account we are using here to access the Geonames.org service has a daily limit, if the limit is reached, we can go <a class="ulink" href="http://www.geonames.org/login">http://www.geonames.org/login</a> and create our own account. The preceding code will create a page that contains a text input field, a button, and an empty div with an ID as <code class="literal">'results'</code>. When we click on the button, the JavaScript function <code class="literal">geonamesSearch</code> does the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">It puts the <code class="literal">'searching'</code> class on the <code class="literal">results</code> div and inserts the <span class="strong"><strong>Searching...</strong></span> mention</li><li class="listitem" style="list-style-type: disc">It reads the text input's current value</li><li class="listitem" style="list-style-type: disc">It calls the GeoNames JSON web services to get the place names matching the value that you input</li><li class="listitem" style="list-style-type: disc">This JSON call is performed by jQuery and we provide it with a callback function that will be called when the GeoNames web service will respond and read the results</li><li class="listitem" style="list-style-type: disc">If there is no result, it changes the <code class="literal">results</code> div class to <code class="literal">'noresults'</code> and its text to <span class="strong"><strong>No matching place.</strong></span></li><li class="listitem" style="list-style-type: disc">If there are some results, it sets the class to <code class="literal">'success'</code> and displays the matching place names</li></ul></div><p>We can try it with our web browser and see it work nicely.</p><p>Now, let's test this page with the following script (<code class="literal">example3.js</code>), which enters the value <code class="literal">'barcelona'</code> and asserts that we do get <span class="strong"><strong>Barcelona (Catalonia)</strong></span> in the results:</p><div class="informalexample"><pre class="programlisting">casper.userAgent('Mozilla/5.0 (Macintosh; Intel Mac OS X)');

casper.test.begin('Search a city by name', 1, function(test) {
    casper.start('http://localhost:8000/example3.html', function() {
        this.sendKeys("input#searchedlocation", "barcelona");
        this.click("button#search");
    });

    casper.then(function() {
        test.assertTextExists('Barcelona (Catalonia)', 'Barcelona (Catalonia) has been found.');
    })

    casper.run(function() {
        test.done();
    });
});</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note02"/>Note</h3><p>We need to set up a regular user agent to make sure that <code class="literal">geonames.org</code> will accept to process our request.</p></div></div><p>If we run it, we get a failure:</p><div class="mediaobject"><img src="graphics/9431OS_01_05.jpg" alt="Timing is everything"/></div><p>Why is that? Because our <code class="literal">this.click()</code> triggers the <code class="literal">geonamesSearch</code> function and immediately after that we try to assert the result content. However, as the GeoNames web service did not have enough time to respond, the content is not yet the one expected at the time the assertion is performed.</p><p>To manage these kinds of cases, CasperJS offers us the ability to wait before executing the rest of our tests.</p><p>The following is a working test script:</p><div class="informalexample"><pre class="programlisting">casper.userAgent('Mozilla/5.0 (Macintosh; Intel Mac OS X)');

casper.test.begin('Search a city by name', 1, function(test) {
    casper.start('http://localhost:8000/example3.html', function() {
        this.sendKeys("input#searchedlocation", "barcelona");
        this.click("button#search");
    });

    casper.waitForSelector('div.success', function() {
        test.assertTextExists('Barcelona (Catalonia)', 'Barcelona (Catalonia) has been found.');
    })

    casper.run(function() {
        test.done();
    });
});</pre></div><p>We can see that the tests pass successfully now:</p><div class="mediaobject"><img src="graphics/9431OS_01_06.jpg" alt="Timing is everything"/></div><p>With <code class="literal">waitForSelector</code>, we make sure that the assertion will be performed only when the <code class="literal">results</code> div will have the <code class="literal">'success'</code> class, and it will happen only once our JSON loading callback function has been called.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note03"/>Note</h3><p>The <code class="literal">waitForSelector</code> method will not wait forever; it does have a timeout (with a default value of 5000 milliseconds, which can be changed) and we can provide a second function that will be called if the timeout is reached before the selector is satisfied.</p></div></div></div><div class="section" title="Live recording"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec05"/>Live recording</h3></div></div></div><p>Writing tests can take time. A quick and convenient way to produce tests is to record an actual usage sequence directly from our web browser (just like the Firefox Selenium plug-in).</p><p>To record web sequences as CasperJS tests, we can use a Chrome extension named <span class="strong"><strong>Resurrectio</strong></span>.</p><p>We install it from the Chrome Web Store (go to <a class="ulink" href="https://chrome.google.com/webstore/">https://chrome.google.com/webstore/</a>, search for <code class="literal">resurrectio</code>, and then click on the add button), and it just appends a new button next to the URL bar:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We click on the <span class="strong"><strong>Resurrectio</strong></span> button to start a recording:<div class="mediaobject"><img src="graphics/9431OS_01_07.jpg" alt="Live recording"/></div></li><li class="listitem">We can then navigate or perform any regular action in our window.</li><li class="listitem">By right-clicking, we can add some assertions or screenshots:<div class="mediaobject"><img src="graphics/9431OS_01_08.jpg" alt="Live recording"/></div></li><li class="listitem">By clicking again on the <span class="strong"><strong>Resurrectio</strong></span> button, we can stop the recording and then export the previous sequence as a a CasperJS test:<div class="mediaobject"><img src="graphics/9431OS_01_09.jpg" alt="Live recording"/></div></li></ol></div><p>Nevertheless, be careful; in some cases, we might need to manually modify the generated test because of the following reasons:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">It might contain a lot of useless assertions (due to extra clicks during the recording).</li><li class="listitem" style="list-style-type: disc">It might be too heavy and verbose, making it more difficult to maintain. So, we would prefer to simplify it to focus on the most meaningful aspects.</li><li class="listitem" style="list-style-type: disc">All assertions cannot be registered from Resurrectio, and we might need different assertions.</li></ul></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec13"/>How it works...</h2></div></div></div><p>One of the key advantages of CasperJS is its ability to chain test steps, knowing that these steps will be executed in the order they have been registered in.</p><p>As explained previously, the way to chain steps in JavaScript is by using callback functions as follows:</p><div class="informalexample"><pre class="programlisting">doStep1AndThen(function() {
   doStep2AndThen(function() {
      doStep3AndThen(function() {
         doStep4AndThen(function() {
            ...
         })
      })
   })
})</pre></div><p>If we were using PhantomJS directly, that would be how our tests would look, and it would not be very convenient to read or maintain.</p><p>But with CasperJS, using the <code class="literal">then()</code> or <code class="literal">waitFor()</code> methods, we can declare successive steps without this infinite callback nesting cascade.</p><p>CasperJS does that callback chaining for us behind the scenes, creating much more readable test scripts.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec14"/>There's more...</h2></div></div></div><p>Let's see a few more details about the different features we have just used here.</p><div class="section" title="XPath selectors"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec06"/>XPath selectors</h3></div></div></div><p>By default, CasperJS uses CSS3 selectors, but we can use XPath selectors if we prefer or if we have to.</p><p>XPath selectors are less readable than CSS3 selectors but they are more powerful (for instance, while matching text contents or putting conditions on the DOM element's ascendants or descendants).</p><p>To use XPath selectors, we just need to load the CasperJS <code class="literal">selectXPath</code> utility:</p><div class="informalexample"><pre class="programlisting">var x = require('casper').selectXPath;
...
    test.assertExists(x("//*[contains(text(), 'Barcelona (Catalonia)')]"), 'The search results are correct');</pre></div></div><div class="section" title="Assertion methods"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec07"/>Assertion methods</h3></div></div></div><p>The CasperJS tester API offers a large collection of assertion methods.</p><p>We can assert conditions and function results in the following ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">assert(Boolean condition[, String message])</code> method asserts that the condition is strictly <code class="literal">true</code></li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertNot(mixed subject[, String message])</code> method asserts that the condition is not <code class="literal">true</code></li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertTruthy(Mixed subject[, String message])</code> method asserts that the subject is <code class="literal">truthy</code></li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertFalsy(Mixed subject[, String message])</code> method asserts that the subject is <code class="literal">falsy</code><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note04"/>Note</h3><p>Let's explain what <code class="literal">true</code>, <code class="literal">false</code>, <code class="literal">truthy,</code> and <code class="literal">falsy</code> is.</p><p>In JavaScript, <code class="literal">true</code> and <code class="literal">false</code> are the two Boolean values stricto sensu. Values such as <code class="literal">null</code>, <code class="literal">undefined</code>, the empty string <code class="literal">''</code>, the number <code class="literal">0</code>, the number <code class="literal">NaN</code> are <code class="literal">falsy</code>, which means that if they are evaluated in a condition, they will return <code class="literal">false</code>.</p><p>And any other values are <code class="literal">truthy</code>, which means that if they are evaluated in a condition, they will return <code class="literal">true</code>.</p></div></div></li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertEquals(mixed testValue, mixed expected[, String message])</code> method asserts that the two parameters are equal</li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertNotEquals(mixed testValue, mixed expected[, String message])</code> method asserts that the two parameters are not equal</li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertEval(Function fn[, String message, Mixed arguments])</code> method asserts that the function evaluated in the page DOM returns <code class="literal">true</code><p>Example:</p><div class="informalexample"><pre class="programlisting">this.test.assertEval(function() {
   if(window.jQuery) {
      return true;
   } else {
      return false;
   }
}, "jQuery is available");</pre></div></li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertEvalEquals(Function fn, mixed expected[, String message, Mixed arguments])</code> method asserts that the function evaluated in the DOM page returns the expected value</li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertMatch(mixed subject, RegExp pattern[, String message])</code> method asserts that the value matches the regular expression</li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertRaises(Function fn, Array args[, String message])</code> method asserts that the function called with the provided arguments raises an error</li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertType(mixed value, String type[, String message])</code> method asserts that the value type is the expected one</li></ul></div><p>We can assert the DOM elements in the following ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">assertExists(String selector[, String message])</code> method asserts that the selector matches at least one element in the page</li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertDoesntExist(String selector[, String message])</code> method asserts that the selector does not match any element in the page</li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertField(String inputName, String expected[, String message])</code> method asserts that the form field has the expected value</li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertVisible(String selector[, String message])</code> method asserts that the element is visible</li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertNotVisible(String selector[, String message])</code> method asserts that the matched element is not visible</li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertSelectorHasText(String selector, String text[, String message])</code> method asserts that the matched element contains the expected text</li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertSelectorDoesntHaveText(String selector, String text[, String message])</code> method asserts that the matched element does not contain the given text</li></ul></div><p>We can assert the page information in the following ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">assertHttpStatus(Number status[, String message])</code> method asserts that the current HTTP status is the expected one</li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertResourceExists(Function testFx[, String message])</code> method asserts that the resource exists on the page<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note05"/>Note</h3><p>The parameter can be a string (the resource name), a regular expression (supposed to match at least one existing resource), or a function (supposed to return <code class="literal">true</code> for at least one of the existing resources).</p></div></div></li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertTextExists(String expected[, String message])</code> method asserts that the page contains the expected text</li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertTextDoesntExist(String unexpected[, String message])</code> method asserts that the page does not contain the given text</li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertTitle(String expected[, String message])</code> method asserts that the page title is the expected one</li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertTitleMatch(RegExp pattern[, String message])</code> method asserts that the page title matches the given regular expression</li><li class="listitem" style="list-style-type: disc">The <code class="literal">assertUrlMatch(Regexp pattern[, String message])</code> method asserts that the page URL matches the given regular expression</li></ul></div></div><div class="section" title="The WaitFor methods"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec08"/>The WaitFor methods</h3></div></div></div><p>The following is the list of the CasperJS <code class="literal">waitFor</code> methods:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">waitForText(String|RegExp pattern[, Function then, Function onTimeout, Number timeout])</code> method waits until the text is present</li><li class="listitem" style="list-style-type: disc">The <code class="literal">waitForSelector(String selector[, Function then, Function onTimeout, Number timeout])</code> method waits until the selector is satisfied</li><li class="listitem" style="list-style-type: disc">The <code class="literal">waitWhileSelector(String selector[, Function then, Function onTimeout, Number timeout])</code> method waits until the selector is not satisfied anymore</li><li class="listitem" style="list-style-type: disc">The <code class="literal">waitUntilVisible(String selector[, Function then, Function onTimeout, Number timeout])</code> method waits until the selected element is visible</li><li class="listitem" style="list-style-type: disc">The <code class="literal">waitWhileVisible(String selector[, Function then, Function onTimeout, Number timeout])</code> method waits until the selected element is not visible anymore</li><li class="listitem" style="list-style-type: disc">The <code class="literal">waitFor(Function testFx[, Function then, Function onTimeout, Number timeout])</code> method waits until the function returns true</li><li class="listitem" style="list-style-type: disc">The <code class="literal">waitForResource(Function testFx[, Function then, Function onTimeout, Number timeout])</code> method waits until the function matches an existing resource</li><li class="listitem" style="list-style-type: disc">The <code class="literal">waitForPopup(String|RegExp urlPattern[, Function then, Function onTimeout, Number timeout])</code> method waits until the pattern matches a pop-up URL</li></ul></div></div><div class="section" title="The wait() method"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec09"/>The wait() method</h3></div></div></div><p>In the list of <code class="literal">waitFor</code> methods, we have not mentioned the following one:</p><div class="informalexample"><pre class="programlisting">wait(Number timeout[, Function then])</pre></div><p>It just waits for a certain amount of time (in milliseconds).</p><p>But as discussed previously, in JavaScript, <span class="emphasis"><em>time is nothing and timing is everything</em></span>. Similarly, in JavaScript, waiting for a given amount of time brings no guarantee to the accuracy of our test.Generally, we use <code class="literal">wait()</code> when we are desperate. For instance, if we have no way to modify the tested page, we cannot append an interesting signal to observe such as the <code class="literal">'noresult'</code> and <code class="literal">'success'</code> classes in our example.</p><p>Nevertheless, let's just note a relevant usage of the <code class="literal">wait()</code> method. When our page contains some progressive JPEG images and we want to capture a new image (see the <span class="emphasis"><em>Beyond testing (Advanced) </em></span>recipe), we need to wait for some time before capturing, in order to let our images render entirely.</p></div><div class="section" title="Installing Resurrectio from the GitHub sources"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec10"/>Installing Resurrectio from the GitHub sources</h3></div></div></div><p>Resurrectio is not entirely stable yet, so it might be interesting to use the current development version.</p><p>To do so, you have to clone the <code class="literal">resurrectio</code> GitHub repository:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>~ git clone git://github.com/ebrehault/resurrectio.git</strong></span>
</pre></div><p>It will produce a <code class="literal">./resurrectio</code> folder.</p><p>Then, in Chrome, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to <span class="strong"><strong>Tools</strong></span> | <span class="strong"><strong>Extensions</strong></span>.</li><li class="listitem">Check the <span class="strong"><strong>Developer mode</strong></span> checkbox.</li><li class="listitem">Click on the <span class="strong"><strong>Load unpacked extension</strong></span> button.</li><li class="listitem">Select the <code class="literal">./resurrectio</code> folder.</li></ol></div></div></div></div>
<div class="section" title="Writing advanced tests (Intermediate)"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec10"/>Writing advanced tests (Intermediate)</h1></div></div></div><p>This recipe will detail how to simulate rich web interactions using CasperJS, in order to achieve more complex testing.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec15"/>How to do it...</h2></div></div></div><p>The following sections cover the various steps in writing advanced tests.</p><div class="section" title="Downloading files"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec11"/>Downloading files</h3></div></div></div><p>First, let's learn how to download files. The most common way to download a file from a web page is by providing a link to this file as follows (<code class="literal">example4.html</code>):</p><div class="informalexample"><pre class="programlisting">&lt;html&gt;&lt;body&gt;
   &lt;h1&gt;My example&lt;/h1&gt;
   &lt;a id="link-to-text" href="files/text.txt"&gt;Download a text&lt;/a&gt;
   &lt;a id="link-to-pdf" href="files/text.pdf"&gt;Download a PDF&lt;/a&gt;
&lt;/body&gt;&lt;/html&gt;</pre></div><p>Now, let's create the following CasperJS script (<code class="literal">example4.js</code>):</p><div class="informalexample"><pre class="programlisting">var casper = require('casper').create();

casper.start('http://localhost:8000/example4.html', function() {
    this.click("#link-to-text");
});
casper.then(function() {
   this.echo(this.getCurrentUrl());
});

casper.thenOpen('http://localhost:8000/example4.html', function() {
   this.click("#link-to-pdf");
});

casper.then(function() {
   this.echo(this.getCurrentUrl());
});

casper.run();</pre></div><p>It should open our page, click on the first link, log the current page URL, reopen the page, click on the second link, and log the current page URL.</p><p>To complete our test, let's create a folder named <code class="literal">files</code>, add two dummy files in this folder (<code class="literal">text.txt</code> and <code class="literal">text.pdf</code>), and start our SimpleHTTPServer web server.</p><p>Let's run the script:</p><div class="mediaobject"><img src="graphics/9431OS_01_10.jpg" alt="Downloading files"/></div><p>When we clicked on the first link, we actually opened the <code class="literal">.txt</code> file as a page, but when we clicked on the second one, we opened the file that was kept in the original location. If we check the current folder content, we will see that nothing has been downloaded.</p><p>So the <code class="literal">click()</code> method will not help us in downloading any file; it will navigate to the corresponding link if PhantomJS is able to open it, or it will open the file that was kept in the original location, producing no error and no output.</p><p>The right way to download a file is by using the <code class="literal">download()</code> method. Let's fix our test using the following code:</p><div class="informalexample"><pre class="programlisting">var casper = require('casper').create();
casper.start('http://localhost:8000/example4.html', function() {
    this.download("http://localhost:8000/files/text.txt", "text.txt");
    this.download("http://localhost:8000/files/text.pdf", "text.pdf");
});

casper.run();</pre></div><p>The outcome looks as follows:</p><div class="mediaobject"><img src="graphics/9431OS_01_11.jpg" alt="Downloading files"/></div><p>Now that our files have been downloaded, let's discover how to upload files.</p></div><div class="section" title="Uploading files"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec12"/>Uploading files</h3></div></div></div><p>To perform a file upload during a test, we will use the <code class="literal">fill()</code> method. The <code class="literal">fill()</code> method allows us to fill in a form and optionally, to submit it. Plus, it is able to manage file inputs.</p><p>The following is an example (<code class="literal">example5.js</code>):</p><div class="informalexample"><pre class="programlisting">var x = require('casper').selectXPath;
casper.test.begin('Upload a file', 1, function(test) {
    casper.start('http://imagebin.org/', function() {
        this.click(x("//a[normalize-space(text())='Add your image now!']"));
    });

    casper.then(function() {
        this.fill("form[name=image_form]", {
            'nickname' : 'casper',
            'image': './test.png',
            'title': 'my test',
            'description': 'just a test',
            'disclaimer_agree': 'Y'
        }, true);
    });

    casper.then(function() {
        test.assertExists('img[alt="my test"]', "The image has been uploaded");
        this.echo("It is available here: " + this.getCurrentUrl());
    });

    casper.run(function() {
        test.done();
    });
});</pre></div><p>You can perform the following steps with this test:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to <a class="ulink" href="http://imagebin.org">http://imagebin.org</a>.</li><li class="listitem">Click on the <span class="strong"><strong>Add your image now!</strong></span> link.</li><li class="listitem">Then, fill in the image submission form.</li><li class="listitem">Assert that we obtain a page containing our image.</li><li class="listitem">Display this page URL.</li></ol></div><p>As we can see, the <code class="literal">'image'</code> field is managed the same way as the other fields; its value is just the path to our local image.</p><p>After passing the first parameter containing the fields values, we pass <code class="literal">true</code> as a second parameter to <code class="literal">fill()</code>, so that the form is submitted.</p><p>Before running the test, we make sure that we put an image named <code class="literal">test.png</code> in our current folder and when we run the test, the following is what we get:</p><div class="mediaobject"><img src="graphics/9431OS_01_12.jpg" alt="Uploading files"/></div></div><div class="section" title="Authentication"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec13"/>Authentication</h3></div></div></div><p>Let's see how we can manage authentication. When we try to open a page that requires authentication, we get a 401 HTTP error (<code class="literal">example6.js</code>):</p><div class="informalexample"><pre class="programlisting">casper.test.begin('Log in', 1, function(test) {
    casper.start('http://www.plomino.net/zmiroot/testpage', function() {
        test.assertHttpStatus(401, 'We cannot see the page as we are not logged in.');
    });

    casper.run(function() {
        test.done();
    });
});</pre></div><p>The outcome is as follows:</p><div class="mediaobject"><img src="graphics/9431OS_01_13.jpg" alt="Authentication"/></div><p>Now, let's use the <code class="literal">setHttpAuth()</code> method to log in properly:</p><div class="informalexample"><pre class="programlisting">casper.test.begin('Log in', 1, function(test) {
    casper.start();

    casper.setHttpAuth('demoaccount', 'demoaccount');

    casper.thenOpen('http://www.plomino.net/zmiroot/testpage', function() {
        test.assertTextExists('You are logged in.', 'Now we can see the page.');
    });
    casper.run(function() {
        test.done();
    });
});</pre></div><p>The following is what we get:</p><div class="mediaobject"><img src="graphics/9431OS_01_14.jpg" alt="Authentication"/></div><p>The <code class="literal">setHttpAuth()</code> method can only be used for HTTP authentication. When our targeted page uses a web form authentication, we just need to fill the authentication form. The following is an example (<code class="literal">example7.js</code>):</p><div class="informalexample"><pre class="programlisting">casper.test.begin('Log in', 1, function(test) {
    casper.start('http://www.plomino.net/samples', function() {
        this.fill('#loginform',
            {
                '__ac_name': 'demouser',
                '__ac_password': 'demouser'
            }, true);
    });

    casper.then(function() {
        test.assertTextExists('Welcome! You are now logged in', 'We are logged in.');
    });

    casper.run(function() {
        test.done();
    });
});</pre></div><p>The output looks as follows:</p><div class="mediaobject"><img src="graphics/9431OS_01_15.jpg" alt="Authentication"/></div></div><div class="section" title="Keyboard and mouse events"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec14"/>Keyboard and mouse events</h3></div></div></div><p>Simulating keyboard and mouse events is another very common use case. Let's consider the following page (<code class="literal">example8.html</code>):</p><div class="informalexample"><pre class="programlisting">&lt;html&gt;&lt;body&gt;
   &lt;script&gt;
   function updateMessage(element) {
      var message = 'You have entered ' + element.value.length + ' characters.';
      document.querySelector('#message').textContent = message;
   }
   &lt;/script&gt;
   &lt;h1&gt;My example&lt;/h1&gt;
   &lt;form id="my-form"&gt;
      &lt;p&gt;Firstname: &lt;input
         type="text"
         name="firstname"
         onkeyup="updateMessage(this);"/&gt;
      &lt;/p&gt;
      &lt;div id="message"&gt;&lt;/div&gt;
   &lt;/form&gt;
&lt;/body&gt;&lt;/html&gt;</pre></div><p>If we launch our simple HTTP server, we can try opening the page at <code class="literal">http://localhost:8000/example8.html</code>.</p><p>When we enter a value in the input text, a message is displayed under the input text, indicating the number of characters we have entered.</p><p>To test this behavior, we can use the <code class="literal">sendKeys()</code> method (<code class="literal">example8.js</code>):</p><div class="informalexample"><pre class="programlisting">casper.test.begin('Test key inputs', 1, function(test) {
   casper.start('http://localhost:8000/example8.html', function() {
      this.sendKeys('input[name="firstname"]', 'Eric');
   });
   casper.then(function() {
      test.assertSelectorHasText('#message', "You have entered 4 characters.");
   });
   casper.run(function() {
        test.done();
    });
});</pre></div><p>When we run the code, we will see the following result. If you enter <code class="literal">Eric</code> in the text input, the message will display <span class="strong"><strong>You have entered 4 characters</strong></span>:</p><div class="mediaobject"><img src="graphics/9431OS_01_16.jpg" alt="Keyboard and mouse events"/></div><p>The <code class="literal">sendKeys()</code> method inserted the text into the text input and also triggered the <code class="literal">onkeyup</code> event.</p><p>The <code class="literal">sendKeys()</code> method can produce a key event on any element of the page (not necessarily inputs).</p><p>Let's change the page <code class="literal">example8.html</code> so that the header becomes editable:</p><div class="informalexample"><pre class="programlisting">&lt;h1 contenteditable="true"&gt;My example&lt;/h1&gt;</pre></div><p>Now if we click on the header, we can change its text content.</p><p>Let's modify our test script:</p><div class="informalexample"><pre class="programlisting">casper.test.begin('Test key inputs', 2, function(test) {
   casper.start('http://localhost:8000/example8.html', function() {
      this.sendKeys('input[name="firstname"]', 'Eric');
   });
   casper.then(function() {
      test.assertSelectorHasText('#message', "You have entered 4 characters.");
   });
   casper.then(function() {
      this.click('h1');
      this.sendKeys('h1', 'I have changed my header');
   });
   casper.then(function() {
      test.assertSelectorHasText('h1', "I have changed my header");
   });
   casper.run(function() {
        test.done();
    });
});</pre></div><p>Now, perform the following steps with this test:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Click on the header and enter a new text at its beginning</li><li class="listitem" style="list-style-type: disc">Assert the new header content</li></ul></div><p>The output will be as follows:</p><div class="mediaobject"><img src="graphics/9431OS_01_17.jpg" alt="Keyboard and mouse events"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note06"/>Note</h3><p>As we have an extra assertion in our test script now, we have changed the <code class="literal">begin()</code> method's second parameter from <code class="literal">1</code> to <code class="literal">2</code>.</p></div></div><p>Regarding mouse events, we have already used the <code class="literal">casper.click()</code> method. It takes a selector as a parameter and triggers a click event on the designated element.</p><p>We use it to click on links or buttons, for instance.</p><p>We can also trigger other mouse events using the <code class="literal">mouseEvent()</code> method; its first parameter is the event type and the second is the targeted element selector.</p><p>It can trigger the following events:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">mouseup</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">mousedown</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">click</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">mousemove</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">mouseover</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">mouseout</code></li></ul></div><p>Let's create the following web page (<code class="literal">example9.html</code>):</p><div class="informalexample"><pre class="programlisting">&lt;html&gt;&lt;body&gt;
   &lt;h1 id="chap1"&gt;Chapter 1&lt;/h1&gt;
   &lt;h1 id="chap2"&gt;Chapter 2&lt;/h1&gt;
   &lt;h1 id="chap3"&gt;Chapter 3&lt;/h1&gt;
   &lt;h1 id="chap4"&gt;Chapter 4&lt;/h1&gt;
   &lt;div&gt;Counter: &lt;span id="counter"&gt;&lt;/span&gt;&lt;/div&gt;
   &lt;script&gt;
var counter = 0;
function incrementCounter() {
   counter =  counter + 1;
   document.querySelector('#counter').textContent = counter;
}
for(i=0;i&lt;document.querySelectorAll("h1").length;i++) {
   document.querySelectorAll("h1")[i].onmouseover=incrementCounter;
}
   &lt;/script&gt;
&lt;/body&gt;&lt;/html&gt;</pre></div><p>It presents a list of headers and when the mouse goes over any of them, a counter is incremented.</p><p>We can test this page using <code class="literal">mouseEvent()</code>, as shown in the following test (<code class="literal">example9.js</code>):</p><div class="informalexample"><pre class="programlisting">casper.test.begin('Test mouse events', 1, function(test) {
   casper.start('http://localhost:8000/example9.html', function() {
      this.mouseEvent('mouseover', '#chap1');
      this.mouseEvent('mouseover', '#chap4');
      this.mouseEvent('mouseover', '#chap1');
      this.mouseEvent('mouseover', '#chap1');
   });
   casper.then(function() {
      test.assertSelectorHasText('#counter', "4");
   });

   casper.run(function() {
        test.done();
    });

});</pre></div><p>The outcome is as follows:</p><div class="mediaobject"><img src="graphics/9431OS_01_18.jpg" alt="Keyboard and mouse events"/></div><p>But CasperJS also provides a specific <code class="literal">'mouse'</code> module to control the mouse directly. It allows to move the mouse and to control the click (down, up, click, double-click).</p><p>It might be useful if we want to test complex mouse interaction such as drag-and-drop. The following is a web page that provides a draggable box (<code class="literal">example10.html</code>) using the jQueryUI <code class="literal">draggable()</code> method:</p><div class="informalexample"><pre class="programlisting">&lt;html&gt;
&lt;head&gt;
&lt;style&gt;
#box {color: white; background-color: blue; width: 100px; position: absolute; top: 0; left: 0;}
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
   &lt;script src="http://code.jquery.com/jquery-1.9.1.js"&gt;&lt;/script&gt;
   &lt;script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"&gt;&lt;/script&gt;
   &lt;script&gt;
$(document).ready(function() {
   $('#box').draggable();
});
   &lt;/script&gt;
   &lt;div id="box"&gt;My box&lt;/div&gt;
&lt;/body&gt;&lt;/html&gt;</pre></div><p>We can test this page using the CasperJS mouse module (<code class="literal">example10.js</code>):</p><div class="informalexample"><pre class="programlisting">casper.options.viewportSize = {width: 1024, height: 768};

casper.test.begin('Test drag&amp;drop', 2, function(test) {
    casper.start('http://localhost:8000/example10.html', function() {
        test.assertEval(function() {
            var pos = $('#box').position();
            return (pos.left == 0 &amp;&amp; pos.top == 0);
        }, "The box is at the top");
        this.mouse.down(5, 5);
        this.mouse.move(400, 200);
        this.mouse.up(400, 200);
    });
    casper.then(function() {
        test.assertEval(function() {
            var pos = $('#box').position();
            return (pos.left == 395 &amp;&amp; pos.top == 195);
        }, "The box has been moved");
    });
    casper.run(function() {
        test.done();
    });
});</pre></div><p>The output will be as follows:</p><div class="mediaobject"><img src="graphics/9431OS_01_19.jpg" alt="Keyboard and mouse events"/></div><p>We can see that there are a lot of interesting things in this test:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We set the viewport size (using the <code class="literal">viewportSize</code> option). In our case, it is useful because we need to make sure that we have enough room to move the box where we want.</li><li class="listitem" style="list-style-type: disc">We use jQuery to get the current position of the box! As jQuery is loaded in our tested page, we can use it through <code class="literal">assertEval()</code>, as <span class="emphasis"><em>it runs the code in the tested page</em></span>.</li><li class="listitem" style="list-style-type: disc">We use <code class="literal">down()</code>, then <code class="literal">move()</code>, and then <code class="literal">up()</code> to produce a drag-and-drop move from point (5,5) to point (400,200).</li></ul></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec16"/>How it works...</h2></div></div></div><p>Even if they might seem quite similar, there are differences between <code class="literal">casper.click()</code> and <code class="literal">casper.mouse.click()</code>.</p><p>First of all, <code class="literal">casper.click()</code> only accepts a selector as a parameter, while <code class="literal">casper.mouse.click()</code> accepts either a selector or a (x, y) position.</p><p>But more importantly, they do not work the same way; <code class="literal">casper.click()</code> creates an event and <span class="emphasis"><em>dispatches</em></span> it to the targeted event, but <code class="literal">casper.mouse.click()</code> does not deal with any element and just <span class="emphasis"><em>produces a mouse action</em></span> at the given position.</p><p>If <code class="literal">casper.click()</code> is not able to dispatch the event (because of a <code class="literal">preventDefault()</code> method hanging somewhere), it will default to the <code class="literal">casper.mouse.click()</code> method.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note07"/>Note</h3><p><code class="literal">casper.mouseEvent()</code> works exactly as <code class="literal">casper.click()</code>.</p></div></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec17"/>There's more...</h2></div></div></div><p>Let's explore a few more details about the different features we have just used in the previous section.</p><div class="section" title="Passing parameters to the download() method"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec15"/>Passing parameters to the download() method</h3></div></div></div><p>The <code class="literal">download()</code> method might also accept two extra parameters as follows:</p><div class="informalexample"><pre class="programlisting">download(String url, String target[, String method, Object data])</pre></div><p>So, we can produce an HTTP request using the method we want and pass the needed arguments in the data object.</p></div><div class="section" title="setHttpAuth might have surprising timing"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec16"/>setHttpAuth might have surprising timing</h3></div></div></div><p>Consider that we come back to our test (<code class="literal">example6.js</code>) about <code class="literal">setHttpAuth()</code> and try to chain the two versions as follows:</p><div class="informalexample"><pre class="programlisting">casper.test.begin('Log in', 2, function(test) {

    casper.start('http://www.plomino.net/zmiroot/testpage', function() {
        test.assertHttpStatus(401, 'We cannot see the page as we are not logged in.');
    });

    casper.setHttpAuth('demoaccount', 'demoaccount');

    casper.thenOpen('http://www.plomino.net/zmiroot/testpage', function() {
        test.assertTextExists('You are logged in.', 'Now we can see the page.');
    });
    casper.run(function() {
        test.done();
    });
});</pre></div><p>We would expect the tests to be successful due to the following conditions: we get a 401 error if we are anonymous and are able to view the page if we log in.</p><p>But, the following is what we obtain:</p><div class="mediaobject"><img src="graphics/9431OS_01_20.jpg" alt="setHttpAuth might have surprising timing"/></div><p>The first test fails; we do not get a 401 error, but we get a 200 status instead! This means we are actually logged in.</p><p>Why is that? It's because CasperJS chains the steps that are enclosed into <code class="literal">then()</code> blocks. If <code class="literal">setHttpAuth()</code> is not enclosed in a <code class="literal">then()</code> block, it will be effective right from the beginning (the <code class="literal">start()</code> call) to the end.</p><p>Let's enclose it in a <code class="literal">then()</code> block as follows:</p><div class="informalexample"><pre class="programlisting">casper.test.begin('Log in', 2, function(test) {

    casper.start('http://www.plomino.net/zmiroot/testpage', function() {
        test.assertHttpStatus(401, 'We cannot see the page as we are not logged in.');
    });

<span class="strong"><strong>    casper.then(function() {</strong></span>
<span class="strong"><strong>        this.setHttpAuth('demoaccount', 'demoaccount');</strong></span>
<span class="strong"><strong>    })</strong></span>

    casper.thenOpen('http://www.plomino.net/zmiroot/testpage', function() {
        test.assertTextExists('You are logged in.', 'Now we can see the page.');
    });
    casper.run(function() {
        test.done();
    });
});</pre></div><p>And now, the tests pass as follows:</p><div class="mediaobject"><img src="graphics/9431OS_01_example6-4.jpg" alt="setHttpAuth might have surprising timing"/></div></div></div></div>
<div class="section" title="Best practices (Intermediate)"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec11"/>Best practices (Intermediate)</h1></div></div></div><p>This section will discuss the essential best practices for web functional testing with CasperJS.</p><div class="section" title="Testing the real thing"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec18"/>Testing the real thing</h2></div></div></div><p>Our software quality depends on our tests' accuracy. Testing is always good, but if we don't test the software's behavior accurately, we might miss out on some potential problems. To create accurate tests, we must forget about the system and how it works, and we must focus on user interactions.</p><p>It might sound obvious but it is not, because most of the time we design and code the system and do not use it (as a standard user) a lot.</p><p>Let's consider a typical example of a basic web form. Here is an important thing to know about web forms: <span class="emphasis"><em>users never submit web forms</em></span>. They actually do the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Enter values into inputs</li><li class="listitem" style="list-style-type: disc">Click on the <span class="strong"><strong>Submit</strong></span> button</li></ul></div><p>These actions do produce a form submission, but the users don't actually submit the form by themselves; their web browsers do it for them. Or, let's say the system does it for them.</p><p>Obviously, if we want to test this system, we cannot rely on its supposed behavior.</p><p>That is why our tests must produce the real user interactions and then assert that the resulting behavior is correct.</p><p>Let's have a look at the following example (<code class="literal">example11.html</code>):</p><div class="informalexample"><pre class="programlisting">&lt;html&gt;&lt;body&gt;
  &lt;form id="form1"&gt;
    &lt;p&gt;Firstname: &lt;input type="text" name="firstname"/&gt;&lt;/p&gt;
    &lt;p&gt;Lastname: &lt;input type="text" name="lastname"/&gt;&lt;/p&gt;
    &lt;p&gt;Age: &lt;input type="text" name="age"/&gt;&lt;/p&gt;
    &lt;input type="submit" value="Save" name="save" /&gt;
  &lt;/form&gt;
  &lt;form id="form2"&gt;
    &lt;p&gt;Firstname: &lt;input type="text" name="firstname"/&gt;&lt;/p&gt;
    &lt;p&gt;Lastname: &lt;input type="text" name="lastname"/&gt;&lt;/p&gt;
     &lt;p&gt;Age: &lt;input type="text" name="age"/&gt;&lt;/p&gt;
  &lt;/form&gt;
  &lt;form id="form3"&gt;
    &lt;p&gt;Firstname: &lt;input type="text" name="firstname"/&gt;&lt;/p&gt;
    &lt;p&gt;Lastname: &lt;input type="text" name="lastname"/&gt;&lt;/p&gt;
    &lt;p&gt;Age: &lt;input style="display: none;" type="text" name="age"/&gt;&lt;/p&gt;
    &lt;input type="submit" value="Save" name="save" /&gt;
  &lt;/form&gt;
&lt;/body&gt;&lt;/html&gt;</pre></div><p>This page shows the following three forms:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The first one contains first name, last name, and age, and a <span class="strong"><strong>Save</strong></span> button</li><li class="listitem" style="list-style-type: disc">The second one has the same fields but no <span class="strong"><strong>Save</strong></span> button</li><li class="listitem" style="list-style-type: disc">The third one has all the fields and a <span class="strong"><strong>Save</strong></span> button, but the <code class="literal">age</code> field is hidden</li></ul></div><p>If we launch our simple HTTP server, the first one will work fine, but the other two will not be usable.</p><p>Now, let's test it as follows (<code class="literal">example11-1.js</code>):</p><div class="informalexample"><pre class="programlisting">var formid = casper.cli.options['formid'];

casper.test.begin('Test form submission', 3, function(test) {

    casper.start('http://localhost:8000/example11.html', function() {
        this.fill("#" + formid, {
            firstname: "Isaac",
            lastname: "Newton",
            age: "370",
        }, true);
    });
    casper.then(function() {
        test.assertUrlMatch(/firstname=Isaac/);
        test.assertUrlMatch(/lastname=Newton/);
        test.assertUrlMatch(/age=370/);
    });
    casper.run(function() {
        test.done();
    });
});</pre></div><p>This test uses <code class="literal">casper.fill()</code> to submit the form with a value for each field and then asserts so we obtain the three values in the resulting URL.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip04"/>Tip</h3><p>In this test, we use <code class="literal">casper.cli.options</code> to read options passed to the <code class="literal">casperjs</code> command; this way, we can use the same script to test the three different forms.</p></div></div><p>Let's run it. The following screenshot shows the output:</p><div class="mediaobject"><img src="graphics/9431OS_01_example11-1.jpg" alt="Testing the real thing"/></div><p>The tests pass with the first form as expected, but they also pass with the other two!</p><p>Why is that? It's because the <code class="literal">fill()</code> method is blind to the mistakes we have introduced in the forms; it just performs a submission without checking if a real user could actually do the same.</p><p>The following is a test that is closer to real user interaction (<code class="literal">example11-2.js</code>):</p><div class="informalexample"><pre class="programlisting">var formid = casper.cli.options['formid'];

casper.test.begin('Test form submission', 3, function(test) {
    casper.start('http://localhost:8000/example11.html', function() {
        this.sendKeys("form#"+formid+" input[name='firstname']", "Isaac");
        this.sendKeys("form#"+formid+" input[name='lastname']", "Newton");
        this.sendKeys("form#"+formid+" input[name='age']", "370");
        this.click("form#"+formid+" input[type=submit][value='Save']");
    });
    casper.then(function() {
        test.assertUrlMatch(/firstname=Isaac/);
        test.assertUrlMatch(/lastname=Newton/);
        test.assertUrlMatch(/age=370/);
    });

    casper.run(function() {
        test.done();
    });
});</pre></div><p>Here we use <code class="literal">sendKeys()</code> to enter the values in the inputs, and we use the <code class="literal">click()</code>method to click on the <span class="strong"><strong>Submit</strong></span> button. This is basically what the user would do with his or her keyboard and mouse.</p><p>Now let's run it. The following screenshot shows the output:</p><div class="mediaobject"><img src="graphics/9431OS_01_example11-2.jpg" alt="Testing the real thing"/></div><p>This is much better; now our tests fail at the second and third forms.</p><p>This does not mean that we must never use the <code class="literal">fill()</code> method. That was just an example. The main point here is that we must always be careful to keep as close as possible to the user interactions. But of course, we also need to create concise and maintainable tests.</p><p>So a good approach is to write several kinds of tests, such as the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Some precise tests focusing on the user interactions (where we will use <code class="literal">sendKeys()</code> and <code class="literal">click()</code> instead of <code class="literal">fill()</code>, for instance) to make sure each page is usable by itself</li><li class="listitem" style="list-style-type: disc">Some concise tests focusing on screen chaining and usage scenarios (where we can use <code class="literal">fill()</code>, for instance) to make sure the complete application is working fine</li></ul></div></div><div class="section" title="Surviving design changes"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec19"/>Surviving design changes</h2></div></div></div><p>Some people prefer to write tests at the end of their development, when they know everything is pretty much stable.</p><p>But the best time to write tests is from the beginning to the end of the development. This has already been demonstrated in a lot of books, but one of the most obvious reasons is that we usually produce the biggest part of our bugs during the development phase, and tests are a great help to fight bugs.</p><p>Unfortunately, people who write tests at the end are right: the website is (usually) more stable after development than during development.</p><p>One of the aspects that might change a lot is the design. Design changes should not impact application features. But sometimes they do, and there may be a lot of reasons for it, such as a CSS attribute can make a button invisible, modification in an element's ID can break a JavaScript call, and so on. But we do not mind this much, because if the design breaks any feature, our tests will warn us immediately.</p><p>The problem is that sometimes our tests fail even if the design changes haven't broken any features. This is very bad because it implies that we cannot trust our tests to know whether something is broken or not.</p><p>Why our tests would fail if all the features have been preserved? This is just because our tests are less design-proof than our web page features, and the writing of design-proof tests depends mainly on selectors.</p><p>Indeed, our test inner logic (for example, if we click <span class="emphasis"><em>here</em></span>, we should get <span class="emphasis"><em>that</em></span>) should not be impacted by design changes.</p><p>But what could easily break if we are not careful enough is the way we define <span class="emphasis"><em>here</em></span> and <span class="emphasis"><em>that</em></span>. They will be defined using selectors. We must choose selectors that focus on the logic and not on the layout.</p><p>The following are some examples:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Instead of</p>
</th><th style="text-align: left" valign="bottom">
<p>Prefer</p>
</th><th style="text-align: left" valign="bottom">
<p>Because</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><code class="literal">"div#form-container span input"</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">"form[name='registration'] input[name='firstname']"</code></p>
</td><td style="text-align: left" valign="top">
<p>We only depend on form elements and their names</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">"div ul li:first-child a"</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">"#results .result:first-child a"</code></p>
</td><td style="text-align: left" valign="top">
<p>We use IDs and classes instead of tag names</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><code class="literal">"a#reset-btn"</code></p>
</td><td style="text-align: left" valign="top">
<p><code class="literal">x("//a[normalize-space(text())='Reset']")</code></p>
</td><td style="text-align: left" valign="top">
<p>We use the link text instead of its ID (and to do this, we switch to the XPath selector)</p>
</td></tr></tbody></table></div><p>By doing this, we can change our design, switch from Bootstrap to Foundation, reorganize the layout, and so on, and be sure that if the tests fail, they do for a good reason: because we have actually broken the logic.</p></div><div class="section" title="Creating test suites"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec20"/>Creating test suites</h2></div></div></div><p>Until now, we have created single test scripts for our different example pages, but when we test our real applications, we will need to test a lot of different features and scenarios.</p><p>It will definitely work if we do it in a single long test script, but obviously, it will be more difficult to refactor it, maintain it, share it with a team, and so on.</p><p>So, quite a simple, good practice is to split our different feature tests and testing scenarios into separate scripts. And fortunately, CasperJS provides the <code class="literal">casperjs test</code> command so we can run all our tests at once.</p><p>Let's reuse our <code class="literal">example8.html</code> page from the previous chapter. This page proposes two features: an editable header and a simple form with text input.</p><p>Let's imagine that we want to create two different tests for these two features. So let's create a folder (named <code class="literal">suit</code>, for instance), and in this folder, create the files <code class="literal">test_editable_header.js</code> and <code class="literal">test_form.js</code>.</p><p>Create <code class="literal">test_editable_header.js</code> as follows:</p><div class="informalexample"><pre class="programlisting">casper.test.begin('Test editable header', 1, function(test) {
  casper.start('http://localhost:8000/example8.html', function() {
    this.click('h1');
    this.sendKeys('h1', 'I have changed ');
  });
  casper.then(function() {
    test.assertSelectorHasText('h1', "I have changed my header");
  });
  casper.run(function() {
    test.done();
  });
});</pre></div><p>Create <code class="literal">test_form.js js</code> as follows:</p><div class="informalexample"><pre class="programlisting">casper.test.begin('Test editable header', 1, function(test) {
  casper.start('http://localhost:8000/example8.html', function() {
    this.sendKeys('input[name="firstname"]', 'Eric');
  });
  casper.then(function() {
    test.assertSelectorHasText('#message', "You have entered 4 characters.");
  });

  casper.run(function() {
    test.done();
  });
});</pre></div><p>And now, let's launch our tests:</p><div class="mediaobject"><img src="graphics/9431OS_01_example12-1.jpg" alt="Creating test suites"/></div><p>As we can see in the preceding screenshot, we have passed our folder path to the <code class="literal">casperjs test</code> command, and it has run all the tests contained in this folder.</p><p>The <code class="literal">casperjs test</code> command offers interesting options, as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">--fail-fast</code>: This is used to stop the test suite at the <span class="emphasis"><em>first error</em></span></li><li class="listitem" style="list-style-type: disc"><code class="literal">--pre=pre-test.js</code>: This is used to run a test <span class="emphasis"><em>before</em></span> executing the test suite</li><li class="listitem" style="list-style-type: disc"><code class="literal">--post=post-test.js</code>: This is used to run a test <span class="emphasis"><em>after</em></span> executing the test suite</li><li class="listitem" style="list-style-type: disc"><code class="literal">--includes=file1.js,file2.js</code>: This is used to include some tests <span class="emphasis"><em>before</em></span> running <span class="emphasis"><em>each test</em></span> in the suite</li><li class="listitem" style="list-style-type: disc"><code class="literal">--direct</code>: This is used to output the log message in the console</li><li class="listitem" style="list-style-type: disc"><code class="literal">--log-level=&lt;level&gt;</code>: This is used to choose the log level (<code class="literal">DEBUG</code>, <code class="literal">INFO</code>, <code class="literal">WARNING</code>, or <code class="literal">ERROR</code>)</li><li class="listitem" style="list-style-type: disc"><code class="literal">--xunit=&lt;filename&gt;</code>: This is used to export the test results to the xUnit format</li></ul></div><p>The <code class="literal">--pre</code> and <code class="literal">--post</code> options are typically used to implement a pre-test setup and post-test tear down, respectively.</p><p>For instance, if our system allows users to modify their preferences and we want to test it, the pre-test setup will create a fake user profile so we can test profile preference change. The post-test tear down will remove this fake user profile, so the next time we run the test suite, it will not break because the profile already exists.</p></div><div class="section" title="Running CasperJS on Jenkins"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec21"/>Running CasperJS on Jenkins</h2></div></div></div><p>Writing tests is a good starting point, but then we have to make sure we run them often enough. One of the <span class="strong"><strong>Continuous Integration</strong></span> (<span class="strong"><strong>CI</strong></span>) principles is to run the tests each time we commit a change in the source repository. To do this, we need a CI tool, and Jenkins is one of the most widely used ones.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note08"/>Note</h3><p>We will not cover the detailed Jenkins installation and configuration here as it is not a desktop application but a service exposed by a server. We assume it is deployed on one of our servers.</p></div></div><p>To run our CasperJS tests on Jenkins, we need first to make sure that PhantomJS and CasperJS are installed on the machine where Jenkins is running (refer to the <span class="emphasis"><em>Installing CasperJS</em></span> section).</p><p>Then, we open the Jenkins web interface and click on <span class="strong"><strong>New Job</strong></span> as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/9431OS_01_jenkins1.jpg" alt="Running CasperJS on Jenkins"/></div><p>In the <span class="strong"><strong>Build</strong></span> section, we add a new <span class="strong"><strong>Execute shell</strong></span> step:</p><div class="mediaobject"><img src="graphics/9431OS_01_jenkins2.jpg" alt="Running CasperJS on Jenkins"/></div><p>Then we click on <span class="strong"><strong>Save</strong></span> and enter our test command in the <span class="strong"><strong>Build</strong></span> section.</p><p>Assuming our tests are in a folder named <code class="literal">tests</code> at the root of our repository, we would enter the following:</p><div class="informalexample"><pre class="programlisting">casperjs test ./tests</pre></div><p>The following screenshot shows the textbox in which we will add the preceding command:</p><div class="mediaobject"><img src="graphics/9431OS_01_jenkins3.jpg" alt="Running CasperJS on Jenkins"/></div><p>We can now launch a build manually or let Jenkins launch builds automatically (depending on the triggers we have chosen). Jenkins will directly interpret the CasperJS output, and we will get a build history showing failures and successes as follows:</p><div class="mediaobject"><img src="graphics/9431OS_01_jenkins4.jpg" alt="Running CasperJS on Jenkins"/></div><p>We can also see the details of a given build as in the following screenshot:</p><div class="mediaobject"><img src="graphics/9431OS_01_jenkins5.jpg" alt="Running CasperJS on Jenkins"/></div></div><div class="section" title="Running CasperJS on Travis-CI"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec22"/>Running CasperJS on Travis-CI</h2></div></div></div><p>Travis-CI is a Cloud service that can be hooked to our GitHub repositories. It is free for public repositories. Each time we push changes to GitHub, Travis-CI does the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creates a blank virtual machine</li><li class="listitem" style="list-style-type: disc">Checks the current sources from GitHub</li><li class="listitem" style="list-style-type: disc">Deploys our application</li><li class="listitem" style="list-style-type: disc">Runs the tests</li><li class="listitem" style="list-style-type: disc">Notifies the user (via e-mail, IRC, and so on)</li></ul></div><p>It also does the same when we receive a pull request on our GitHub repository so we know whether the submitted pull request breaks the tests or not before merging it. This information is displayed directly on GitHub.</p><p>To run CasperJS tests on Travis-CI, we need to do the following:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to <a class="ulink" href="http://travis-ci.org">travis-ci.org</a> and sign in with our GitHub account.</li><li class="listitem">Go to <span class="strong"><strong>Profile</strong></span> and copy the token.</li><li class="listitem">Go to the GitHub repository, click on <span class="strong"><strong>Settings / Service Hooks</strong></span>, choose <span class="strong"><strong>Travis-CI</strong></span>, enter our GitHub ID and the previously copied Travis token, check <span class="strong"><strong>Active</strong></span>, and click on <span class="strong"><strong>Update</strong></span>.</li><li class="listitem">Add a <code class="literal">.travis.yml</code> file in the root of our repository.</li></ol></div><p>This <code class="literal">.travis.yml</code> file is used to explain to Travis how to deploy the test environment and how to run the tests.</p><p>We just need to deploy CasperJS because PhantomJS is preinstalled on Travis.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip05"/>Tip</h3><p>Since PhantomJS is completely headless, there is no need run Xvfb.</p></div></div><p>The following is a typical <code class="literal">.travis.yml</code> file:</p><div class="informalexample"><pre class="programlisting">install:
  - git clone git://github.com/n1k0/casperjs.git
  - cd casperjs; git checkout tags/1.1; cd -
before_script:
  - "export PHANTOMJS_EXECUTABLE='phantomjs --local-to-remote-url-access=yes --ignore-ssl-errors=yes'"
script:
  - ./casperjs/bin/casperjs test ./tests</pre></div><p>In the <code class="literal">install</code> section, we download the CasperJS code and check the last stable version. In the <code class="literal">before_script</code> section, we set up PhantomJS to allow access to external URLs, and in the <code class="literal">script</code> section, we launch the tests.</p><p>Just like Jenkins, Travis-CI will interpret the CasperJS output result as a success or failure, and we will be notified accordingly. Our tests can target a local server, and if so, our <code class="literal">.travis.yml</code> file will need to deploy the needed HTTP server and its components.</p><p>But the tests can also target an external URL, and if so, we have to make sure the code is updated on the real server as soon as it is pushed to GitHub. This can be done conveniently using GitHub pages.</p></div></div>
<div class="section" title="Beyond testing (Advanced)"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec12"/>Beyond testing (Advanced)</h1></div></div></div><p>This section will present other CasperJS usages apart from testing.</p><div class="section" title="Web scripting"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec23"/>Web scripting</h2></div></div></div><p>Web scripting means to run a script that will use web pages as a backend service.</p><p>Of course, scripting a web page is quite a brutal way to obtain a service. Using a REST API (or any API) would be much more elegant. But in some cases there is no API. CasperJS is able to simulate user interaction on our web pages in order to test them.</p><p>But obviously, we can use its abilities to simulate user interaction on any web page in order to automate a process. That is why CasperJS is a very efficient web scripting tool.</p><p>Let's say we want a script to tell us how many unread messages we have in our Gmail inbox. We could use a script like the following (<code class="literal">example12.js</code>):</p><div class="informalexample"><pre class="programlisting">var casper = require('casper').create();

casper.userAgent('Mozilla/5.0 (Macintosh; Intel Mac OS X)');
casper.start("http://mail.google.com");

casper.waitForSelector("form#gaia_loginform", function() {
  this.sendKeys('form#gaia_loginform input[name="Email"]', "&lt;my_account&gt;@gmail.com");
  this.sendKeys('form#gaia_loginform input[name="Passwd"]', "&lt;password&gt;");
});

casper.then(function() {
    this.click("#signIn");
});

casper.then(function() {
    var inbox_link_text = this.fetchText('table.m a[accesskey="i"]');


<span class="strong"><strong>    var search_unread = /\((\d+)\)/.exec(inbox_link_text );</strong></span>
    if(!search_unread) {
         this.echo("No new emails.", 'INFO');
    } else {
         this.echo("You have " + search_unread[1] + " new emails.", 'INFO');
    }
});

casper.run();</pre></div><p>In this script, we log in and get the HTML code for the <span class="strong"><strong>Inbox</strong></span> link (in the left menu) as it contains the number of unread e-mails, like the following:</p><div class="informalexample"><pre class="programlisting">Inbox (53) </pre></div><p>To extract the number, we use a regular expression, <code class="literal">/\((\d+)\)/</code>, that will look for any number enclosed in brackets.</p><p>And the following is what we get:</p><div class="mediaobject"><img src="graphics/9431OS_01_example12-2.jpg" alt="Web scripting"/></div><p>Now let's try to get a local weather report (<code class="literal">example13.js</code>):</p><div class="informalexample"><pre class="programlisting">var casper = require('casper').create();

casper.start("http://weather.yahoo.com/");

casper.then(function() {
    var current_location = this.fetchText('#location-chooser .name');
    var current_temp = this.fetchText('.temp .f .num');
    this.echo("Current temperature in " + current_location + ": " + current_temp + "°F");
});
casper.run();</pre></div><p>Here, we just load the Yahoo! Weather home page and then extract the information we want (the current temperature, our location, and the immediate forecast). After we have done this, we get the following:</p><div class="mediaobject"><img src="graphics/9431OS_01_example13-1.jpg" alt="Web scripting"/></div><p>Nice!</p><p>But be careful; if Yahoo! decides to change its weather page's layout, the selectors we have used might become invalid and our service would be down. This is the main weakness of the web scripting approach. And, in this very use case (getting Yahoo! Weather reports), we will build a much safer service by using the excellent Yahoo! Query Language REST API.</p><p>Nevertheless, web scripting might sometimes be a light and convenient solution when we are facing complex cross-platform integration issues.</p></div><div class="section" title="Screenshot production"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec24"/>Screenshot production</h2></div></div></div><p>CasperJS is able to produce an image from the current page using the following two methods:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">this.capture(String filepath)</code>: This takes a screenshot of the entire page</li><li class="listitem" style="list-style-type: disc"><code class="literal">this.captureSelector(String filepath, String selector)</code>: This restricts the capture to a specific element</li></ul></div><p>A simple example (<code class="literal">example14.js</code>) is as follows:</p><div class="informalexample"><pre class="programlisting">var casper = require('casper').create();

casper.start('http://en.wikipedia.org/wiki/Solar_System');

casper.then(function() {
    this.capture("screenshot1.png");
});

casper.run();</pre></div><p>If we run it, it'll work just fine, but we will obtain a very large image because this Wikipedia page is very long and we have captured it entirely.</p><p>Being able to obtain a screenshot of a very long page is not always easy, so this feature can be helpful. If we want to reduce the captured area, we can set the viewport size and use <code class="literal">captureSelector</code> on the <code class="literal">html</code> element as follows:</p><div class="informalexample"><pre class="programlisting">var casper = require('casper').create();

<span class="strong"><strong>casper.options.viewportSize = {width: 1300, height: 700};</strong></span>
casper.start('http://en.wikipedia.org/wiki/Solar_System');

casper.then(function() {
<span class="strong"><strong>    this.captureSelector("screenshot1.png", "html");</strong></span>
});

casper.run();</pre></div><p>And now we get a smaller image.</p><p>A typical usage of the capture methods is obviously <span class="strong"><strong>debugging</strong></span>; when we do not know why our CasperJS is not working as expected, before spending time logging everything or inspecting all the elements, a simple screenshot might show us that we just forgot to perform a valid authentication due to which we are still blocked at the login page.</p><p>Another interesting usage is <span class="strong"><strong>documentation</strong></span>. Writing a good user manual often involves inserting a lot of screenshots. Producing these screenshots can be quite long and painful, and it will be even more painful when we have to update them because the design may have changed since the last time we published the user manual.</p><p>So, how about using CasperJS to generate all the screenshots we need automatically from the current version of our web application? The principle is simple: we write a CasperJS script that reproduces the usage scenarios described in our documentation, we obtain a set of images, and we fuse them with our documentation text. Markdown, reStructuredText4, Textile, or similar formats are good candidates.</p><p>Resurrectio (see the <span class="emphasis"><em>Getting started with CasperJS (Simple)</em></span> section) proposes to export any recorded sequence in two versions: a CasperJS version (which has our actual test scripts) and a reStructuredText version (which only contains comments and screenshots).</p><p>So we can run the test, obtain the screenshots, and compile our reStructuredText (with <code class="literal">rst2html</code>, <code class="literal">rst2doc</code>, <code class="literal">rst2pdf</code>, or so on) to get our document. Every time the design changes, we just re-run the test, recompile the text, and the document is updated automatically.</p><p>We can also use the capture methods from dynamically generated rendering to <span class="emphasis"><em>produce static contents</em></span>.</p><p>For instance, if we use <span class="strong"><strong>d3.js</strong></span> (<a class="ulink" href="http://d3js.org/">http://d3js.org/</a>) to draw gorgeous charts on our web page but would like to insert them in a newsletter or allow an old web browser to see them, we can turn them into images using CasperJS.</p><p>Let's take the following example from the <a class="ulink" href="http://d3js.org">d3js.org</a> tutorial (<code class="literal">example15.html</code>):</p><div class="informalexample"><pre class="programlisting">&lt;html&gt;
&lt;head&gt;
&lt;style&gt;
body {
  font: 10px sans-serif;
  color: white;
}
.arc path {
  stroke: #fff;
}
.arc text {
  fill: #fff;
}
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;script src="http://d3js.org/d3.v3.min.js"&gt;&lt;/script&gt;
&lt;script&gt;
var width = 400,
    height = 200,
    radius = Math.min(width, height) / 2;

var color = d3.scale.ordinal()
    .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

var arc = d3.svg.arc()
    .outerRadius(radius - 10)
    .innerRadius(radius - 70);

var pie = d3.layout.pie()
    .sort(null)
    .value(function(d) { return d.population; });

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

d3.csv("data.csv", function(error, data) {

  data.forEach(function(d) {
    d.population = +d.population;
  });

  var g = svg.selectAll(".arc")
      .data(pie(data))
    .enter().append("g")
      .attr("class", "arc");

  g.append("path")
      .attr("d", arc)
      .style("fill", function(d) { return color(d.data.age); });

  g.append("text")
      .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
      .attr("dy", ".35em")
      .style("text-anchor", "middle")
      .text(function(d) { return d.data.age; });
});
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div><p>It reads a CSV file that contains population by age group and draws a donut chart using SVG.</p><p>Let's provide the needed data (<code class="literal">data.csv</code>):</p><div class="informalexample"><pre class="programlisting">age,population
&lt;5,2704659
5-13,4499890
14-17,2159981
18-24,3853788
25-44,14106543
45-64,8819342
≥65,612463</pre></div><p>Now we can launch our simple HTTP server and have a look. It will work well if we are using Chrome, for instance, but won't work with Internet Explorer 8.</p><p>CasperJS can be used to capture this chart so we can serve an equivalent image to the web browser that is not able to render SVG (<code class="literal">example15.js</code>):</p><div class="informalexample"><pre class="programlisting">var casper = require('casper').create();

casper.start('http://localhost:8000/example15.html');

casper.then(function() {
    this.captureSelector("chart.png", 'svg');
});

casper.run();</pre></div><p>And the following is what we get:</p><div class="mediaobject"><img src="graphics/9431OS_01_example15-1.jpg" alt="Screenshot production"/></div><p>CasperJS can also be a smart way to provide a <span class="strong"><strong>server-side printing service</strong></span>.</p><p>When we want our users to print our web pages, the most common and simple approach for them to use would be the web browser <code class="literal">print</code> feature. If we need to customize the rendering for printing (hide the navigation bar, change some colors or fonts, and so on), we can easily do so using a specific CSS for print (by mentioning <code class="literal">media="print"</code> inside the <code class="literal">link</code> tag). However, sometimes this is not enough.</p><p>Background images are a typical instance of where standard printing can be annoying; background images are hidden during printing, and it makes sense as we prefer to print text on a white background. But if we use them for a specific goal, such as filling the different bars of a bar chart, the printed result will be disappointing. (In our case, all the bars will be white, so we will not be able to distinguish between them.)</p><p>We will also have problems when we want to change the displayed information between screen and print. For instance, our page might contain a map with few markers. On the screen, we display a label when the mouse goes over a marker, but on print, we would prefer that all the labels are displayed.</p><p>In these problematic cases, a good solution is to use CasperJS as a <span class="strong"><strong>backend printing service</strong></span>. The purpose is to highlight a service that takes as a parameter any URL, which returns an image capture of the corresponding page ready to be printed.</p><p>Our service will simply run a CasperJS script that will open the provided URL and then capture it:</p><div class="informalexample"><pre class="programlisting">var casper = require('casper').create();
var url = casper.cli.options['targeturl'];
var output = casper.cli.options['outputfile'];

casper.start(url);

casper.then(function() {
    this.capture(output);
});

casper.run();</pre></div><p>As we cannot use the <code class="literal">media="print"</code> attribute to apply some print-specific CSS (as CasperJS will open the page in the screen mode), we can dynamically add a specific class on the body element before capturing so we can easily style the rendering:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>casper.thenEvaluate(function () {</strong></span>
<span class="strong"><strong>  var bodyclass = document.querySelector('body').getAttribute('class');</strong></span>
<span class="strong"><strong>  bodyclass = bodyclass + " print-mode";</strong></span>
<span class="strong"><strong>  document.querySelector('body').setAttribute('class', bodyclass);</strong></span>
<span class="strong"><strong>});</strong></span>
</pre></div><p>And if we want to allow a specific process to be performed before capturing (such as displaying all the marker labels on a map as discussed before), we might wait for a specific selector to be available. The list of selectors is as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In our target page, we add a JavaScript in charge of setting up the page for printing and adding a marker class on the <code class="literal">body</code> element as desired:<div class="informalexample"><pre class="programlisting">if(location.search.indexOf("print") &gt; -1) {
  set_up_as_expected();
  document.querySelector('body').className += " ready-for-printing";
}</pre></div></li><li class="listitem" style="list-style-type: disc">In CasperJS, we wait for this marker class to appear before capturing the output:<div class="informalexample"><pre class="programlisting">casper.waitForSelector(".ready-for-printing", function() {
    capture(this, selector, output);
});</pre></div></li></ul></div><p>This service can be implemented with any web framework (we just need to be able to make a system call to run our CasperJS script).</p><p><span class="strong"><strong>Django Screamshot</strong></span> is a Django implementation and can be found at <a class="ulink" href="https://github.com/makinacorpus/django-screamshot">https://github.com/makinacorpus/django-screamshot</a>.</p></div></div></body></html>