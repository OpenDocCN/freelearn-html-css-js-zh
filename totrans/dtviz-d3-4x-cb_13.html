<html><head></head><body><div id="book-columns"><div id="book-inner"><div class="chapter" title="Chapter 13. Test Drive Your Visualization"><div class="titlepage"><div><div><h1 class="title"><a id="ch13"/><span class="koboSpan" id="kobo.1.1">Chapter 13. Test Drive Your Visualization</span></h1></div></div></div><p><span class="koboSpan" id="kobo.2.1">In this chapter we will cover:</span></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="koboSpan" id="kobo.3.1">Getting Jasmine and setting up the test environment</span></li><li class="listitem" style="list-style-type: disc"><span class="koboSpan" id="kobo.4.1">Test driving your visualization - chart creation</span></li><li class="listitem" style="list-style-type: disc"><span class="koboSpan" id="kobo.5.1">Test driving your visualization - SVG rendering</span></li><li class="listitem" style="list-style-type: disc"><span class="koboSpan" id="kobo.6.1">Test driving your visualization - pixel-perfect bar rendering</span></li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec86"/><span class="koboSpan" id="kobo.7.1">Introduction</span></h1></div></div></div><p><span class="koboSpan" id="kobo.8.1">Whenever we program as a professional programmer it is always important to test the program we write in order to make sure it functions as designed and produces the expected outcome. </span><span class="koboSpan" id="kobo.8.2">D3 data visualization mainly consists of JavaScript programs hence just like any other program we write, data visualization needs to be tested to make sure it represents the underlying data accurately. </span><span class="koboSpan" id="kobo.8.3">Obviously, we can perform our validation through visual examination and manual testing, which is always a critical part of the process of building data visualization since visual observation gives us a chance to verify not only the correctness, but also the aesthetics, usability, and many other useful aspects. </span><span class="koboSpan" id="kobo.8.4">However, manual visual inspection can be quite subjective, therefore, in this chapter we will focus our effort on automated unit testing. </span><span class="koboSpan" id="kobo.8.5">Visualization well covered by unit tests can free the creator from the manual labor of verifying correctness by hand, additionally allowing the creator to focus more on the aesthetics, usability, and other important aspects where it is hard to automate with machine.</span></p><div class="section" title="Introduction to unit testing"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec263"/><span class="koboSpan" id="kobo.9.1">Introduction to unit testing</span></h2></div></div></div><p><span class="koboSpan" id="kobo.10.1">Unit testing is a method in which a smallest unit of the program is tested and verified by another program called the test case. </span><span class="koboSpan" id="kobo.10.2">The logic behind unit testing is that at unit level the program is typically simpler and more testable. </span><span class="koboSpan" id="kobo.10.3">If we can verify that every unit in the program is correct then putting these correct units together will give us a higher confidence in which the integrated program is also correct. </span><span class="koboSpan" id="kobo.10.4">Furthermore, since unit tests are typically cheap and fast to execute, a group of unit test cases can be quickly and frequently executed to provide feedback whether our program is performing correctly or not.</span></p><p><span class="koboSpan" id="kobo.11.1">Software testing is a complex topic and so far we have only scratched the surface; however, due to limited scope in this chapter, we will have to stop our introduction now and dive into developing unit tests.</span></p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note84"/><span class="koboSpan" id="kobo.12.1">Note</span></h3><p><span class="koboSpan" id="kobo.13.1">For more information on some of the important concepts in software testing please check out the following links:
Unit test: </span><a class="ulink" href="https://en.wikipedia.org/wiki/Unit_testing"><span class="koboSpan" id="kobo.14.1">https://en.wikipedia.org/wiki/Unit_testing</span></a><span class="koboSpan" id="kobo.15.1">
Test driven development: </span><a class="ulink" href="https://en.wikipedia.org/wiki/Test-driven_development"><span class="koboSpan" id="kobo.16.1">https://en.wikipedia.org/wiki/Test-driven_development</span></a><span class="koboSpan" id="kobo.17.1">
Code coverage: </span><a class="ulink" href="https://en.wikipedia.org/wiki/Code_coverage"><span class="koboSpan" id="kobo.18.1">https://en.wikipedia.org/wiki/Code_coverage
</span></a>
</p></div></div></div></div></div></div></div>
<div id="book-columns"><div id="book-inner"><div class="section" title="Getting Jasmine and setting up the test environment"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec87"/><span class="koboSpan" id="kobo.1.1">Getting Jasmine and setting up the test environment</span></h1></div></div></div><p><span class="koboSpan" id="kobo.2.1">Before we start writing our unit test cases we need to set up an environment where our test cases can be executed to verify our implementation. </span><span class="koboSpan" id="kobo.2.2">In this recipe, we will show how this environment and necessary libraries can be set up for a visualization project.</span></p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec264"/><span class="koboSpan" id="kobo.3.1">Getting ready</span></h2></div></div></div><p><span class="koboSpan" id="kobo.4.1">Jasmine (</span><a class="ulink" href="https://jasmine.github.io/"><span class="koboSpan" id="kobo.5.1">https://jasmine.github.io/
</span></a><span class="koboSpan" id="kobo.6.1">) is a </span><span class="strong"><strong><span class="koboSpan" id="kobo.7.1">Behavior-Driven Development</span></strong></span><span class="koboSpan" id="kobo.8.1"> (</span><span class="strong"><strong><span class="koboSpan" id="kobo.9.1">BDD</span></strong></span><span class="koboSpan" id="kobo.10.1">) framework for testing JavaScript code.</span></p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note85"/><span class="koboSpan" id="kobo.11.1">Note</span></h3><p><span class="koboSpan" id="kobo.12.1">BDD is a software development technique that combines </span><span class="strong"><strong><span class="koboSpan" id="kobo.13.1">Test Driven Development</span></strong></span><span class="koboSpan" id="kobo.14.1"> (</span><span class="strong"><strong><span class="koboSpan" id="kobo.15.1">TDD</span></strong></span><span class="koboSpan" id="kobo.16.1">) with domain driven design.</span></p></div></div><p><span class="koboSpan" id="kobo.17.1">We chose Jasmine as our testing framework because of its popularity in JavaScript community as well as its nice BDD syntax. </span><span class="koboSpan" id="kobo.17.2">You can download the Jasmine library from, </span><a class="ulink" href="https://github.com/jasmine/jasmine/releases"><span class="koboSpan" id="kobo.18.1">https://github.com/jasmine/jasmine/releases</span></a><span class="koboSpan" id="kobo.19.1">.
</span></p><p><span class="koboSpan" id="kobo.20.1">Once downloaded you need to unzip it into the </span><code class="literal"><span class="koboSpan" id="kobo.21.1">lib</span></code><span class="koboSpan" id="kobo.22.1"> folder. </span><span class="koboSpan" id="kobo.22.2">Besides the </span><code class="literal"><span class="koboSpan" id="kobo.23.1">lib</span></code><span class="koboSpan" id="kobo.24.1"> folder we also need to create the </span><code class="literal"><span class="koboSpan" id="kobo.25.1">src</span></code><span class="koboSpan" id="kobo.26.1"> and </span><code class="literal"><span class="koboSpan" id="kobo.27.1">spec</span></code><span class="koboSpan" id="kobo.28.1"> folders for storing source files as well as test cases (in BDD terminology, test cases are called specification). </span><span class="koboSpan" id="kobo.28.2">See the following screenshot for the folder structure:</span></p><p>
</p><div class="mediaobject"><span class="koboSpan" id="kobo.29.1"><img src="graphics/image_13_001.jpg" alt="Getting ready"/></span></div><p>
</p><p><span class="koboSpan" id="kobo.30.1">Testing directory structure</span></p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec265"/><span class="koboSpan" id="kobo.31.1">How to do it...</span></h2></div></div></div><p><span class="koboSpan" id="kobo.32.1">Now, we have Jasmine in our environment, next thing to do is to set up an HTML page that will include Jasmine library as well as our source code plus test cases so they can be executed to verify our program. </span><span class="koboSpan" id="kobo.32.2">This file is called </span><code class="literal"><span class="koboSpan" id="kobo.33.1">SpecRunner.html</span></code><span class="koboSpan" id="kobo.34.1"> in our setup which includes the following code:</span></p><pre class="programlisting"><span class="koboSpan" id="kobo.35.1">&lt;!DOCTYPE html&gt; 
&lt;html&gt; 
&lt;head&gt; 
  &lt;meta charset="utf-8"&gt; 
  &lt;title&gt;Jasmine Spec Runner v2.5.2&lt;/title&gt; 
 
  &lt;link rel="shortcut icon" type="image/png"  
            href="lib/jasmine-2.5.2/jasmine_favicon.png"&gt; 
  &lt;link rel="stylesheet" href="lib/jasmine-2.5.2/jasmine.css"&gt; 
 
  &lt;script src="lib/jasmine-2.5.2/jasmine.js"&gt;&lt;/script&gt; 
  &lt;script src="lib/jasmine-2.5.2/jasmine-html.js"&gt;&lt;/script&gt; 
  &lt;script src="lib/jasmine-2.5.2/boot.js"&gt;&lt;/script&gt; 
 
  &lt;!-- include source files here... </span><span class="koboSpan" id="kobo.35.2">--&gt; 
  &lt;script src="src/bar_chart.js"&gt;&lt;/script&gt; 
 
  &lt;!-- include spec files here... </span><span class="koboSpan" id="kobo.35.3">--&gt; 
  &lt;script src="spec/spec_helper.js"&gt;&lt;/script&gt; 
  &lt;script src="spec/bar_chart_spec.js"&gt;&lt;/script&gt; 
 
&lt;/head&gt; 
 
&lt;body&gt; 
&lt;/body&gt; 
&lt;/html&gt; 
</span></pre></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec266"/><span class="koboSpan" id="kobo.36.1">How it works...</span></h2></div></div></div><p><span class="koboSpan" id="kobo.37.1">This code follows standard Jasmine spec runner structure and generates execution report directly into our HTML page. </span><span class="koboSpan" id="kobo.37.2">Now, you have a fully functional test environment set up for your visualization development. </span><span class="koboSpan" id="kobo.37.3">If you open the </span><code class="literal"><span class="koboSpan" id="kobo.38.1">SpecRunner.html</span></code><span class="koboSpan" id="kobo.39.1"> file with your browser you will see a blank page at this point; however, if you check out our code sample you will see the following report:</span></p><p>
</p><div class="mediaobject"><span class="koboSpan" id="kobo.40.1"><img src="graphics/image_13_002.jpg" alt="How it works..."/></span></div><p>
</p><p><span class="koboSpan" id="kobo.41.1">Jasmine report</span></p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec267"/><span class="koboSpan" id="kobo.42.1">See also</span></h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong><span class="koboSpan" id="kobo.43.1">Jasmine</span></strong></span><span class="koboSpan" id="kobo.44.1">:</span><span class="strong"><strong><span class="koboSpan" id="kobo.45.1"> </span></strong></span><a class="ulink" href="https://jasmine.github.io/"><span class="koboSpan" id="kobo.46.1">https://jasmine.github.io/
</span></a></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong><span class="koboSpan" id="kobo.47.1">Jasmine 2.5 Reference Document</span></strong></span><span class="koboSpan" id="kobo.48.1">: </span><a class="ulink" href="https://jasmine.github.io/2.5/introduction"><span class="koboSpan" id="kobo.49.1">https://jasmine.github.io/2.5/introduction
</span></a></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong><span class="koboSpan" id="kobo.50.1">Behavior Driven </span></strong></span><span class="strong"><strong><span class="koboSpan" id="kobo.51.1">Development</span></strong></span><span class="koboSpan" id="kobo.52.1">:</span><span class="strong"><strong><span class="koboSpan" id="kobo.53.1"> </span></strong></span><a class="ulink" href="https://en.wikipedia.org/wiki/Behavior-driven_development"><span class="koboSpan" id="kobo.54.1">https://en.wikipedia.org/wiki/Behavior-driven_development
</span></a></li></ul></div></div></div></div></div>
<div id="book-columns"><div id="book-inner"><div class="section" title="Test driving your visualization - chart creation"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec88"/><span class="koboSpan" id="kobo.1.1">Test driving your visualization - chart creation</span></h1></div></div></div><p><span class="koboSpan" id="kobo.2.1">With test environment ready, we can move on and develop a simple bar chart very similar to what we have done in the </span><span class="emphasis"><em><span class="koboSpan" id="kobo.3.1">Creating a bar chart</span></em></span><span class="koboSpan" id="kobo.4.1"> recipe in </span><a class="link" href="ch08.html" title="Chapter 8. Chart Them Up"><span class="koboSpan" id="kobo.5.1">Chapter 8</span></a><span class="koboSpan" id="kobo.6.1">, </span><span class="emphasis"><em><span class="koboSpan" id="kobo.7.1">Chart Them Up</span></em></span><span class="koboSpan" id="kobo.8.1">, though this time in a test-driven fashion. </span><span class="koboSpan" id="kobo.8.2">You can see how the bar chart looks if you open the </span><code class="literal"><span class="koboSpan" id="kobo.9.1">tdd-bar-chart.html</span></code><span class="koboSpan" id="kobo.10.1"> page:</span></p><p>
</p><div class="mediaobject"><span class="koboSpan" id="kobo.11.1"><img src="graphics/image_13_003_new.jpg" alt="Test driving your visualization - chart creation"/></span></div><p>
</p><p><span class="koboSpan" id="kobo.12.1">Test driven bar chart</span></p><p><span class="koboSpan" id="kobo.13.1">By now we all know very well how to implement a bar chart using D3; however, building a bar chart is not the focus of this recipe. </span><span class="koboSpan" id="kobo.13.2">Instead, we want to show how we can build test cases every step of the way and verify automatically that our bar chart implementation is doing what it is supposed to do. </span><span class="koboSpan" id="kobo.13.3">The source code of this recipe was built using test driven development method; however, we will not show you every step in the TDD process due to limited scope in this book. </span><span class="koboSpan" id="kobo.13.4">Instead, we have grouped multiple steps into three larger sections with different focuses in this chapter and this recipe is the first step we take.</span></p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec268"/><span class="koboSpan" id="kobo.14.1">Getting ready</span></h2></div></div></div><p><span class="koboSpan" id="kobo.15.1">Open your local copy of the following file in your text editor:</span></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter13/src/bar_chart.js"><span class="koboSpan" id="kobo.16.1">https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter13/src/bar_chart.js
</span></a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter13/spec/bar_chart_spec.js"><span class="koboSpan" id="kobo.17.1">https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter13/spec/bar_chart_spec.js
</span></a></li></ul></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec269"/><span class="koboSpan" id="kobo.18.1">How to do it...</span></h2></div></div></div><p><span class="koboSpan" id="kobo.19.1">First step we need to take is to make sure our bar chart implementation exists and can receive the data. </span><span class="koboSpan" id="kobo.19.2">The starting point of our development could be arbitrary and we decide to drive from this simplest function to set up the skeleton for our object. </span><span class="koboSpan" id="kobo.19.3">Here is what the test case looks like:</span></p><pre class="programlisting"><span class="koboSpan" id="kobo.20.1">describe('BarChart', function () { 
    var div, 
        chart, 
        data = [ 
            {x: 0, y: 0}, 
            {x: 1, y: 3}, 
            {x: 2, y: 6} 
        ]; 
 
    beforeEach(function () { 
        div = d3.select('body').append('div'); 
        chart = BarChart(div); 
    }); 
 
    afterEach(function () { 
        div.remove(); 
    }); 
 
    describe('.data', function () { 
        it('should allow setting and retrieve chart data',  
        function () { 
            expect(chart.data(data).data()).toBe(data); 
        }); 
    }); 
}); 
</span></pre></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec270"/><span class="koboSpan" id="kobo.21.1">How it works...</span></h2></div></div></div><p><span class="koboSpan" id="kobo.22.1">In this first test case we used a few Jasmine constructs:</span></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal"><span class="koboSpan" id="kobo.23.1">describe</span></code><span class="koboSpan" id="kobo.24.1">: This function defines a suite of test cases; within </span><code class="literal"><span class="koboSpan" id="kobo.25.1">describe</span></code><span class="koboSpan" id="kobo.26.1"> a sub-suite can be nested and test cases can be defined</span></li><li class="listitem" style="list-style-type: disc"><code class="literal"><span class="koboSpan" id="kobo.27.1">it</span></code><span class="koboSpan" id="kobo.28.1">: This function defines a test case</span></li><li class="listitem" style="list-style-type: disc"><code class="literal"><span class="koboSpan" id="kobo.29.1">beforeEach</span></code><span class="koboSpan" id="kobo.30.1">: This function defines a pre-execution hook which will execute the given function before the execution of each test case</span></li><li class="listitem" style="list-style-type: disc"><code class="literal"><span class="koboSpan" id="kobo.31.1">afterEach</span></code><span class="koboSpan" id="kobo.32.1">: This function defines a post-execution hook which will execute the given function after the execution of each test case</span></li><li class="listitem" style="list-style-type: disc"><code class="literal"><span class="koboSpan" id="kobo.33.1">expect</span></code><span class="koboSpan" id="kobo.34.1">: This function defines an expectation in your test case which can then be chained with matchers (for example, </span><code class="literal"><span class="koboSpan" id="kobo.35.1">toBe</span></code><span class="koboSpan" id="kobo.36.1"> and </span><code class="literal"><span class="koboSpan" id="kobo.37.1">toBeEmpty</span></code><span class="koboSpan" id="kobo.38.1">) to perform assertion in your test case</span></li></ul></div><p><span class="koboSpan" id="kobo.39.1">In our example we use the </span><code class="literal"><span class="koboSpan" id="kobo.40.1">beforeEach</span></code><span class="koboSpan" id="kobo.41.1"> hook to set up a </span><code class="literal"><span class="koboSpan" id="kobo.42.1">div</span></code><span class="koboSpan" id="kobo.43.1"> container for each test case and then remove </span><code class="literal"><span class="koboSpan" id="kobo.44.1">div</span></code><span class="koboSpan" id="kobo.45.1"> after execution in </span><code class="literal"><span class="koboSpan" id="kobo.46.1">afterEach</span></code><span class="koboSpan" id="kobo.47.1"> hook to improve the isolation between different test cases. </span><span class="koboSpan" id="kobo.47.2">The test case itself is almost trivial; it checks if the bar chart can take data and also return data attribute correctly. </span><span class="koboSpan" id="kobo.47.3">At this point if we run our </span><code class="literal"><span class="koboSpan" id="kobo.48.1">SpecRunner</span></code><span class="koboSpan" id="kobo.49.1">, it will display a red message complaining there is no </span><code class="literal"><span class="koboSpan" id="kobo.50.1">BarChart</span></code><span class="koboSpan" id="kobo.51.1"> object, so let's create our object and function:</span></p><pre class="programlisting"><span class="koboSpan" id="kobo.52.1">function BarChart(p) { 
    var that = {}; 
    var _parent = p, _data; 
    that.data = function (d) { 
        if (!arguments.length) return _data; 
        _data = d; 
        return that; 
    }; 
 
    return that; 
} 
</span></pre><p><span class="koboSpan" id="kobo.53.1">Now, if you run </span><code class="literal"><span class="koboSpan" id="kobo.54.1">SpecRunner.html</span></code><span class="koboSpan" id="kobo.55.1"> again it will give you a happy green message showing our only test case is passing.</span></p></div></div></div></div>
<div id="book-columns"><div id="book-inner"><div class="section" title="Test driving your visualization - SVG rendering"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec89"/><span class="koboSpan" id="kobo.1.1">Test driving your visualization - SVG rendering</span></h1></div></div></div><p><span class="koboSpan" id="kobo.2.1">Now we have the basic skeleton of our bar chart object created, and we feel that we are</span></p><p><span class="koboSpan" id="kobo.3.1">ready to try to render something, so in this second iteration we will try to generate the </span><code class="literal"><span class="koboSpan" id="kobo.4.1">svg:svg</span></code><span class="koboSpan" id="kobo.5.1"> element.</span></p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec271"/><span class="koboSpan" id="kobo.6.1">Getting ready</span></h2></div></div></div><p><span class="koboSpan" id="kobo.7.1">Open your local copy of the following file in your text editor:</span></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter13/src/bar_chart.js"><span class="koboSpan" id="kobo.8.1">https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter13/src/bar_chart.js
</span></a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter13/spec/bar_chart_spec.js"><span class="koboSpan" id="kobo.9.1">https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter13/spec/bar_chart_spec.js</span></a></li></ul></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec272"/><span class="koboSpan" id="kobo.10.1">How to do it...</span></h2></div></div></div><p><span class="koboSpan" id="kobo.11.1">Rendering the </span><code class="literal"><span class="koboSpan" id="kobo.12.1">svg:svg</span></code><span class="koboSpan" id="kobo.13.1"> element should not only simply add the </span><code class="literal"><span class="koboSpan" id="kobo.14.1">svg:svg</span></code><span class="koboSpan" id="kobo.15.1"> element to the HTML body, but also translate the width and height setting on our chart object to proper SVG attributes. </span><span class="koboSpan" id="kobo.15.2">Here is how we express our expectation in our test cases:</span></p><pre class="programlisting"><span class="koboSpan" id="kobo.16.1">describe('.render', function () { 
        describe('svg', function () { 
            it('should generate svg', function () { 
                chart.render(); 
                expect(svg()).not.toBeEmpty(); 
            }); 
 
            it('should set default svg height and width',  
              function () { 
                chart.render(); 
                expect(svg().attr('width')).toBe('500'); 
                expect(svg().attr('height')).toBe('350'); 
            }); 
 
            it('should allow changing svg height and width',  
              function () { 
                chart.width(200).height(150).render(); 
                expect(svg().attr('width')).toBe('200'); 
                expect(svg().attr('height')).toBe('150'); 
            }); 
        }); 
    }); 
 
    function svg() { 
        return div.select('svg'); 
    } 
</span></pre></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec273"/><span class="koboSpan" id="kobo.17.1">How it works...</span></h2></div></div></div><p><span class="koboSpan" id="kobo.18.1">At this point, all of these tests will fail since we don't even have the render function; however, it clearly articulates that we expect the render function to generate the </span><code class="literal"><span class="koboSpan" id="kobo.19.1">svg:svg</span></code><span class="koboSpan" id="kobo.20.1"> element and setting the </span><code class="literal"><span class="koboSpan" id="kobo.21.1">width</span></code><span class="koboSpan" id="kobo.22.1"> and </span><code class="literal"><span class="koboSpan" id="kobo.23.1">height</span></code><span class="koboSpan" id="kobo.24.1"> attributes correctly. </span><span class="koboSpan" id="kobo.24.2">The second test case also makes sure that if the user does not provide the </span><code class="literal"><span class="koboSpan" id="kobo.25.1">height</span></code><span class="koboSpan" id="kobo.26.1"> and </span><code class="literal"><span class="koboSpan" id="kobo.27.1">width</span></code><span class="koboSpan" id="kobo.28.1"> attributes we will supply a set of default values. </span><span class="koboSpan" id="kobo.28.2">Here is how we will implement the render method to satisfy these expectations:</span></p><pre class="programlisting"><span class="koboSpan" id="kobo.29.1">... 
</span><span class="koboSpan" id="kobo.29.2">var _parent = p, _width = 500, _height = 350 
        _data; 
 
    that.render = function () { 
        var svg = _parent 
            .append("svg") 
            .attr("height", _height) 
            .attr("width", _width); 
    }; 
 
    that.width = function (w) { 
        if (!arguments.length) return _width; 
        _width = w; 
        return that; 
    }; 
 
    that.height = function (h) { 
        if (!arguments.length) return _height; 
        _height = h; 
        return that; 
}; 
... 
</span></pre><p><span class="koboSpan" id="kobo.30.1">At this point our </span><code class="literal"><span class="koboSpan" id="kobo.31.1">SpecRunner.html</span></code><span class="koboSpan" id="kobo.32.1"> is once again all green and happy. </span><span class="koboSpan" id="kobo.32.2">However, it's still not doing much since all it does is generate an empty </span><code class="literal"><span class="koboSpan" id="kobo.33.1">svg:</span></code>
<code class="literal"><span class="koboSpan" id="kobo.34.1">svg </span></code><span class="koboSpan" id="kobo.35.1">element on the page and not even use the data at all.</span></p></div></div></div></div>
<div id="book-columns"><div id="book-inner"><div class="section" title="Test driving your visualization - pixel-perfect bar rendering"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec90"/><span class="koboSpan" id="kobo.1.1">Test driving your visualization - pixel-perfect bar rendering</span></h1></div></div></div><p><span class="koboSpan" id="kobo.2.1">In this iteration we will finally generate the bars using the data we have. </span><span class="koboSpan" id="kobo.2.2">Through our test cases we will make sure all bars are not only rendered but rendered with pixel-perfect precision.</span></p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec274"/><span class="koboSpan" id="kobo.3.1">Getting ready</span></h2></div></div></div><p><span class="koboSpan" id="kobo.4.1">Open your local copy of the following file in your text editor:</span></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter13/src/bar_chart.js"><span class="koboSpan" id="kobo.5.1">https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter13/src/bar_chart.js
</span></a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter13/spec/bar_chart_spec.js"><span class="koboSpan" id="kobo.6.1">https://github.com/NickQiZhu/d3-cookbook-v2/blob/master/src/chapter13/spec/bar_chart_spec.js
</span></a></li></ul></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec275"/><span class="koboSpan" id="kobo.7.1">How to do it...</span></h2></div></div></div><p><span class="koboSpan" id="kobo.8.1">Let's see how we test it:</span></p><pre class="programlisting"><span class="koboSpan" id="kobo.9.1">describe('chart body', function () { 
        it('should create body g', function () { 
            chart.render(); 
            expect(chartBody()).not.toBeEmpty(); 
        }); 
 
        it('should translate to (left, top)', function () { 
            chart.render(); 
             expect(chartBody().attr('transform')). 
             </span><span class="koboSpan" id="kobo.9.2">toBe('translate(30,10)') 
        }); 
}); 
 
describe('bars', function () { 
        beforeEach(function () { 
            chart.data(data).width(100).height(100) 
                .x(d3.scaleLinear().domain([0, 3])) 
                .y(d3.scaleLinear().domain([0, 6])) 
                .render(); 
        }); 
 
        it('should create 3 svg:rect elements', function () { 
            expect(bars().size()).toBe(3); 
        }); 
 
        it('should calculate bar width automatically',  
          function () { 
            bars().each(function () { 
              expect(d3.select(this).attr('width')). 
              </span><span class="koboSpan" id="kobo.9.3">toBe('18'); 
            }); 
        }); 
 
        it('should map bar x using x-scale', function () { 
            expect(bar(0).attr('x')).toBe('0'); 
            expect(bar(1).attr('x')).toBe('20'); 
            expect(bar(2).attr('x')).toBe('40'); 
         }); 
 
         it('should map bar y using y-scale', function () { 
             expect(bar(0).attr('y')).toBe('60'); 
             expect(bar(1).attr('y')).toBe('30'); 
             expect(bar(2).attr('y')).toBe('0'); 
          }); 
 
          it('should calculate bar height based on y', function () { 
              expect(bar(0).attr('height')).toBe('10'); 
              expect(bar(1).attr('height')).toBe('40'); 
              expect(bar(2).attr('height')).toBe('70'); 
           }); 
       }); 
    }); 
 
    function svg() { 
        return div.select('svg'); 
    } 
 
    function chartBody() { 
        return svg().select('g.body'); 
    } 
 
    function bars() { 
        return chartBody().selectAll('rect.bar'); 
    } 
 
    function bar(index) { 
        return d3.select(bars().nodes()[index]); 
    } 
}); 
</span></pre></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec276"/><span class="koboSpan" id="kobo.10.1">How it works...</span></h2></div></div></div><p><span class="koboSpan" id="kobo.11.1">In the preceding test suite we describe our expectations of having the chart body </span><code class="literal"><span class="koboSpan" id="kobo.12.1">svg:g</span></code><span class="koboSpan" id="kobo.13.1"> element correctly transform and correct number of bars with appropriate attributes (</span><code class="literal"><span class="koboSpan" id="kobo.14.1">width</span></code><span class="koboSpan" id="kobo.15.1">, </span><code class="literal"><span class="koboSpan" id="kobo.16.1">x</span></code><span class="koboSpan" id="kobo.17.1">, </span><code class="literal"><span class="koboSpan" id="kobo.18.1">y</span></code><span class="koboSpan" id="kobo.19.1">, </span><code class="literal"><span class="koboSpan" id="kobo.20.1">height</span></code><span class="koboSpan" id="kobo.21.1">) set. </span><span class="koboSpan" id="kobo.21.2">The implementation is actually going to be shorter than our test case which is quite common in well tested implementation:</span></p><pre class="programlisting"><span class="koboSpan" id="kobo.22.1">... 
</span><span class="koboSpan" id="kobo.22.2">var _parent = p, _width = 500, _height = 350, 
        _margins = {top: 10, left: 30, right: 10, bottom: 30}, 
        _data, 
        _x = d3.scaleLinear(), 
        _y = d3.scaleLinear(); 
 
that.render = function () { 
        var svg = _parent 
            .append("svg") 
            .attr("height", _height) 
            .attr("width", _width); 
 
        var body = svg.append("g") 
            .attr("class", 'body') 
            .attr("transform", "translate(" + _margins.left + ","  
             + _margins.top + ")") 
 
        if (_data) { 
            _x.range([0, quadrantWidth()]); 
            _y.range([quadrantHeight(), 0]); 
 
            body.selectAll('rect.bar') 
                .data(_data).enter() 
                .append('rect') 
                .attr("class", 'bar') 
                .attr("width", function () { 
                    return quadrantWidth() / _data.length -  
                    BAR_PADDING; 
                }) 
                .attr("x", function (d) {return _x(d.x); }) 
                .attr("y", function (d) {return _y(d.y); }) 
                .attr("height", function (d) { 
                    return _height - _margins.bottom - _y(d.y); 
                }); 
        } 
}; 
... 
</span></pre><p><span class="koboSpan" id="kobo.23.1">I think you are getting the picture and now you can repeat this cycle over and over to drive your implementation. </span><span class="koboSpan" id="kobo.23.2">D3 visualization is built on HTML with SVG and both are simple mark-up languages that can be verified easily. </span><span class="koboSpan" id="kobo.23.3">Well thought-out test suite can make sure your visualization is pixel-perfect even sub-pixel perfect.</span></p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec277"/><span class="koboSpan" id="kobo.24.1">See also</span></h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong><span class="koboSpan" id="kobo.25.1">Test driven development</span></strong></span><span class="koboSpan" id="kobo.26.1">:</span><a class="ulink" href="https://en.wikipedia.org/wiki/Test-driven_development"><span class="koboSpan" id="kobo.27.1">https://en.wikipedia.org/wiki/Test-driven_development
</span></a></li></ul></div></div></div></div></div></body></html>