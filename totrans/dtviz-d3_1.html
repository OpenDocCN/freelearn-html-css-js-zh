<html><head></head><body>
  <div id="sbo-rt-content"><div class="chapter" title="Chapter 1. Getting Started with d3.js"><div class="titlepage"><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Getting Started with d3.js</h1></div></div></div><p>In this chapter, I'll show you the basic tools for making simple visualizations in d3.js without going into too much depth so that you can get started immediately. We will go through the basic language of d3.js and also its rules.</p><p>We'll take a stab at creating axes and automatically scaling graphs to fit the viewport, and learn about using Chrome Developer Tools to model our code before going into a full-blown programming bonanza. Through this chapter, we're going to set up the environment used throughout the book and create an animated chart of a dataset I created from GitHub.</p><div class="section" title="What is d3.js?"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec08"/>What is d3.js?</h1></div></div></div><p>The <a id="id0" class="indexterm"/>name D3<a id="id1" class="indexterm"/> stands for Data-Driven Documents. <span class="emphasis"><em>Mike Bostock</em></span> has been openly developing this powerful data visualization library since 2011. It helps you draw beautiful graphics by manipulating data without worrying too much about pixel positions, calculating where things fit on a graph, and so on. If you've ever visualized data in Python or similar languages, you've probably used something similar to <span class="strong"><strong>gnuplot</strong></span>
<a id="id2" class="indexterm"/>. I assure you that d3.js offers a much more pleasurable experience.</p><p>The official <a id="id3" class="indexterm"/>website, <a class="ulink" href="http://d3js.org">d3js.org</a>, features many great examples that show off the power of d3.js, but understanding them is tricky at best. After finishing this book, you should be able to understand d3.js well enough to figure out the examples. If you want to follow the development of d3.js more closely, the source code is hosted on GitHub at <a class="ulink" href="https://github.com/mbostock/d3">https://github.com/mbostock/d3</a>.</p><p>The fine-grained control and its elegance make d3.js one of the most, if not the most, powerful open source visualization libraries out there. This also means that it's not very suitable for simple jobs such as drawing a chart or two—in that case you might want to use a library designed for charting. Many use d3.js internally anyway.</p><p>As a data manipulation library, d3.js is based on functional programming principles, which is probably where a lot of the confusion stems from. Unfortunately, functional programming goes beyond the scope of this book, but I'll explain all the relevant bits to make sure everyone's on the same page.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Setting up a play environment"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Setting up a play environment</h1></div></div></div><p>D3 combines<a id="id4" class="indexterm"/> HTML, CSS, and SVG to create graphics. That means we're <a id="id5" class="indexterm"/>going to need an HTML and a JavaScript file. We'll use Chrome Developer Tools to tweak our visualizations and test things out. Let's start with some HTML coding:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;title&gt;&lt;/title&gt;
&lt;link href="bootstrap/css/bootstrap.min.css" rel="stylesheet"&gt;

&lt;div id="graph"&gt;&lt;/div&gt;

&lt;script src="http://d3js.org/d3.v3.min.js"&gt;&lt;/script&gt;
&lt;script src="code.js"&gt;&lt;/script&gt;</pre></div><p>These six lines of HTML code are the basics we're going to use throughout this book.</p><p>The first two lines comprise a minimal HTML5 document. You no longer need to include the <code class="literal">&lt;html&gt;</code>, <code class="literal">&lt;head&gt;</code>, and <code class="literal">&lt;body&gt;</code> tags. Next is the <code class="literal">&lt;link&gt;</code> tag that pulls in Twitter Bootstrap's CSS rules—a good set of defaults to make things prettier. After that comes the <code class="literal">&lt;div&gt;</code> tag that will hold our visualization, and finally, there's the <code class="literal">&lt;script&gt;</code> tag that loads d3.js.</p><p>At the end, we include a <code class="literal">code.js</code> file, where we'll put most of our code. Twitter doesn't offer a hosted version of Bootstrap, so you have to download the whole package from <a class="ulink" href="http://twitter.github.com/bootstrap/">http://twitter.github.com/bootstrap/</a> and unpack it next to the other files you're working with. All we need now is a server to run everything. This is because we don't want to get into trouble with browser security models when making Ajax requests. Any server will do, but here's a quick way to get one up and running if you already have Python installed (by default on Mac and Linux).</p><p>Fire up a console, navigate to your working directory, and run the following command:</p><div class="informalexample"><pre class="programlisting">$ python -m SimpleHTTPServer</pre></div><p>Python<a id="id6" class="indexterm"/> will run the <code class="literal">SimpleHTTPServer</code> module<a id="id7" class="indexterm"/> as a standalone script and create a fully functional local server.</p><p>Now point Chrome to <code class="literal">localhost:8000</code> and fire up the developer console—<span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>Shift</em></span> + <span class="emphasis"><em>J</em></span> for Linux and Windows and <span class="emphasis"><em>Option </em></span>+ <span class="emphasis"><em>Command </em></span>+ <span class="emphasis"><em>J</em></span> for Mac. You should see a blank website and a blank JavaScript console with a command prompt waiting for some code:</p><div class="mediaobject"><img src="images/0007OS_01_01.jpg" alt="Setting up a play environment"/></div><div class="section" title="A quick Chrome Developer Tools primer"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec07"/>A quick Chrome Developer Tools primer</h2></div></div></div><p>Chrome <a id="id8" class="indexterm"/>Developer Tools<a id="id9" class="indexterm"/> are indispensable in web <a id="id10" class="indexterm"/>development. Most modern browsers have something similar, but I thought we'd stick to a single example to keep the book shorter. Feel free to use a different browser.</p><p>We are mostly going to use the <span class="strong"><strong>Elements</strong></span> and <span class="strong"><strong>Console</strong></span> tabs: <span class="strong"><strong>Elements</strong></span> to inspect the DOM, and <span class="strong"><strong>Console</strong></span> to play with JavaScript code and look for any problems.</p><p>The other six tabs come in handy for large projects. The <span class="strong"><strong>Network</strong></span> tab will let you know how long files are taking to load and helps you inspect the Ajax requests. The <span class="strong"><strong>Profiles</strong></span> tab will help you profile JavaScript for performance. The <span class="strong"><strong>Resources</strong></span> tab is good for inspecting client-side data. Honestly, I have never needed <span class="strong"><strong>Timeline</strong></span> and <span class="strong"><strong>Audits</strong></span> before. One of the favorites from Developer Tools is the CSS inspector at the right-hand side of the <span class="strong"><strong>Elements</strong></span> tab. </p><p>It can tell you what CSS rules are affecting the styling of an element, which is very good for hunting rogue rules that are messing things up. You can also edit the CSS and immediately see the results:</p><div class="mediaobject"><img src="images/0007OS_01_02.jpg" alt="A quick Chrome Developer Tools primer"/></div></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="A simple histogram"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec10"/>A simple histogram</h1></div></div></div><p>We'll go through the basics of d3.js by creating a <a id="id11" class="indexterm"/>histogram indicating when the GitHub users commit code. We're going to label axes, make sure things are scalable, and modify animations for that extra bit of flair.</p><p>The dataset contains 504,015 repositories and it took me a week to create it out of punchcard data for each repository. A punchcard<a id="id12" class="indexterm"/> is just a 7 x 24 grid of buckets, specifying how many commits happened within a specific day and hour. The dataset's histogram digest is hosted at <a class="ulink" href="http://nightowls.swizec.com/data/histogram-hours.json">http://nightowls.swizec.com/data/histogram-hours.json</a> and maps hours to the sum of commits occurring within that hour.</p><p>This is what we're aiming for:</p><div class="mediaobject"><img src="images/0007OS_01_03.jpg" alt="A simple histogram"/></div><p>We begin by taking the environment prepared in the previous section and adding a few lines around the central <code class="literal">&lt;div&gt;</code> tag:</p><div class="informalexample"><pre class="programlisting">&lt;div class="container"&gt;
  &lt;div class="row"&gt;
    &lt;div id="graph" class="span12"&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre></div><p>The extra <code class="literal">&lt;div&gt;</code> tags center the <a id="id13" class="indexterm"/>graph horizontally and ensure that we have 900 px of width to work with. Don't forget to add the <code class="literal">class="span12"</code> parameter into the <code class="literal">graph</code> div. It tells Bootstrap the div should go the whole width of the grid.</p><p>To avoid tripping your browser's security restrictions regarding cross-domain requests, you should now take a moment to download the dataset and save it next to the other files. Remember, it's at <a class="ulink" href="http://nightowls.swizec.com/data/histogram-hours.json">http://nightowls.swizec.com/data/histogram-hours.json</a>.</p><p>You can play around with the following code in Chrome Developer Tools to see what it does and then save it in <code class="literal">code.js</code>. Writing directly to the file also works, but just make sure you refresh frequently. Learning is if you know what each line does.</p><p>We begin with some variables as follows:</p><div class="informalexample"><pre class="programlisting">var width = 900, height = 300, pad = 20, left_pad = 100;</pre></div><p>We're going to use these to specify the dimensions of our drawing area. The <code class="literal">pad</code> variable will define the padding from the edge, with <code class="literal">left_pad</code> giving a bigger margin on the left to allow for labels.</p><p>Next, we define a horizontal scale, <code class="literal">x</code>:</p><div class="informalexample"><pre class="programlisting">var x = d3.scale.ordinal().rangeRoundBands([left_pad, width - pad], 0.1);</pre></div><p>The <code class="literal">x</code> scale is now a function that maps inputs from a yet unknown domain (we don't have the data yet) to a range of values between <code class="literal">left_pad</code> and <code class="literal">width - pad</code>, that is, between <code class="literal">100</code> and <code class="literal">880</code> with some spacing defined by the <code class="literal">0.1</code> value. Because it's an ordinal scale, the domain will have to be discrete rather than continuous. <code class="literal">rangeRoundBands</code> means the range will be split into bands that are guaranteed to be round numbers.</p><p>Then, we define another scale named <code class="literal">y</code>:</p><div class="informalexample"><pre class="programlisting">var y = d3.scale.linear().range([height-pad, pad]);</pre></div><p>Similarly, the <code class="literal">y</code> scale is going to map a yet unknown linear domain to a range between <code class="literal">height-pad</code> and <code class="literal">pad</code>, that is, <code class="literal">880</code> and <code class="literal">20</code>. Inverting the range is important because d3.js considers the top of a graph to be <code class="literal">y=0</code>.</p><p>Now, we define our axes as follows:</p><div class="informalexample"><pre class="programlisting">var xAxis = d3.svg.axis().scale(x).orient("bottom");
var yAxis = d3.svg.axis().scale(y).orient("left");</pre></div><p>We've told each axis what scale to use when placing ticks and which side of the axis to put the labels on. D3 will automatically decide how many ticks to display, where they go, and how to label them.</p><p>The last step before loading the data is defining an SVG element for the histogram:</p><div class="informalexample"><pre class="programlisting">var svg = d3.select("#graph").append("svg")
                .attr("width", width).attr("height", height);</pre></div><p>Switching quickly to the <span class="strong"><strong>Elements</strong></span> tab, you'll notice a new HTML element with a width of 900 and a height of 100.</p><p>Now the fun begins!</p><p>We're going to<a id="id14" class="indexterm"/> use d3.js itself to load data remotely and then draw the graph in the callback function. Remember to use <span class="emphasis"><em>Shift</em></span> + <span class="emphasis"><em>Enter</em></span> to input multiline code in the Chrome console. Now might be a good time to switch to coding in <code class="literal">code.js</code> directly and refreshing after every couple of steps:</p><div class="informalexample"><pre class="programlisting">d3.json('histogram-hours.json', function (data) {
});</pre></div><p>
<code class="literal">d3.json</code> will create an Ajax request to load a JSON file, then parse the received text into a JavaScript object. D3 understands CSV and some other data formats as well, which is kind of awesome if you ask me.</p><p>From here on, we put everything in that callback function (before the <code class="literal">});</code> bit). Our data will be in the <code class="literal">data</code> variable. D3 is a functional<a id="id15" class="indexterm"/> data-munging library, so we need to transform our dictionary data into a list of simple objects. We do this using the following code:</p><div class="informalexample"><pre class="programlisting">data = d3.keys(data).map(function (key) {
  return {bucket: Number(key),
    N: data[key]};
  });</pre></div><p>
<code class="literal">d3.keys</code> returns a list of keys in the data dictionary, which we then <code class="literal">map</code> over with an iterator function that returns a simple dictionary for every item. It tells us where an item fits in the histogram (<code class="literal">bucket</code>) and what value it holds (<code class="literal">N</code>).</p><p>We've turned our data into a list of two-value dictionaries.</p><p>Remember the <code class="literal">x</code> and <code class="literal">y</code> scales from before? We can finally give them a domain and make them useful:</p><div class="informalexample"><pre class="programlisting">    x.domain(data.map(function (d) { return d.bucket; }));
    y.domain([0, d3.max(data, function (d) { return d.N; })]);</pre></div><p>Since most d3.js elements are objects and functions at the same time, we can change the internal state of both scales without assigning the result to anything. The domain of <code class="literal">x</code> is a list of discrete values. The domain of <code class="literal">y</code> is a range from <code class="literal">0</code> to <code class="literal">d3.max</code> of our dataset—the largest value.</p><p>Now we're going to draw the axes on our graph:</p><div class="informalexample"><pre class="programlisting">svg.append("g")
  .attr("class", "axis")
  .attr("transform", "translate(0, "+(height-pad)+")")
  .call(xAxis);</pre></div><p>We've appended an element called <code class="literal">g</code> to the graph, given it the CSS class <code class="literal">"axis"</code>, and moved the element to a place at the bottom-left of the graph with the <code class="literal">transform</code> attribute.</p><p>Finally, we <a id="id16" class="indexterm"/>call the <code class="literal">xAxis</code> function and let d3.js handle the rest.</p><p>Drawing the other axis works exactly the same, but with different arguments:</p><div class="informalexample"><pre class="programlisting">svg.append("g")
  .attr("class", "axis")
  .attr("transform", "translate("+(left_pad-pad)+", 0)")
  .call(yAxis);</pre></div><p>Now that our graph is labeled, it's finally time to draw some data:</p><div class="informalexample"><pre class="programlisting">svg.selectAll('rect')
  .data(data)
  .enter()
  .append('rect')
  .attr('class', 'bar')
  .attr('x', function (d) { return x(d.bucket); })
  .attr('width', x.rangeBand())
  .attr('y', function (d) { return y(d.N); })
  .attr('height', function (d) { return height-pad - y(d.N); });</pre></div><p>Okay, there's plenty going on here, but this code is saying something very simple: for all rectangles (<code class="literal">rect</code>) in the graph, load our data, go through it, and for each item append a <code class="literal">rect</code> and then define some attributes.</p><p>The <code class="literal">x</code> scale helps us calculate the horizontal positions and <code class="literal">rangeBand</code> gives the width of the bar. The <code class="literal">y</code> scale calculates vertical positions and we manually get the height of each bar from <code class="literal">y</code> to the bottom. Note that whenever we needed a different value for every element, we defined an attribute as a function (<code class="literal">x</code>, <code class="literal">y</code>, and <code class="literal">height</code>); otherwise, we defined it as a value (<code class="literal">width</code>).</p><p>Keep this in mind when you're tinkering.</p><p>Let's add some flourish and make each bar grow out of the horizontal axis. Time to dip our toes into animations!</p><p>Add five lines to the preceding code:</p><div class="informalexample"><pre class="programlisting">svg.selectAll('rect')
  .data(data)
  .enter()
  .append('rect')
  .attr('class', 'bar')
  .attr('x', function (d) { return x(d.bucket); })
  .attr('width', x.rangeBand())
  .attr('y', height-pad)
  .transition()
  .delay(function (d) { return d.bucket*20; })
  .duration(800)
  .attr('y', function (d) { return y(d.N); })
  .attr('height', function (d) { return height-pad - y(d.N); });</pre></div><p>The <a id="id17" class="indexterm"/>difference is that we statically put all bars at the bottom (<code class="literal">height-pad</code>) and then entered a transition with <code class="literal">.transition()</code>. From here on, we define the transition we want.</p><p>First, we wanted each bar's transition delayed by 20 milliseconds using <code class="literal">d.bucket*20</code>. This gives the histogram a neat effect, gradually appearing from left to right instead of jumping up at once. Next, we said we wanted each animation to last just shy of a second with <code class="literal">.duration(800)</code>. In the end, we defined the final values for the animated attributes—<code class="literal">y</code> and <code class="literal">height</code> are the same as in previous code—and d3.js is going to take care of the rest.</p><p>Refresh the page and voila! A beautiful histogram appears as shown in the following screenshot:</p><div class="mediaobject"><img src="images/0007OS_01_04.jpg" alt="A simple histogram"/></div><p>Hmm, not really. We need some CSS to make everything look perfect.</p><p>Remember that you can look at the full code on GitHub at <a class="ulink" href="https://github.com/Swizec/d3.js-book-examples/tree/master/ch1">https://github.com/Swizec/d3.js-book-examples/tree/master/ch1</a> if you didn't get something similar to the preceding screenshot.</p><p>Let's go into our HTML file and add some CSS on line 4, right after including <code class="literal">bootstrap</code>:</p><div class="informalexample"><pre class="programlisting">&lt;style&gt;
  .axis path,
  .axis line {
    fill: none;
    stroke: #eee;
    shape-rendering: crispEdges;
  }

  .axis text {
    font-size: 11px;
  }

  .bar {
    fill: steelblue;
  }
&lt;/style&gt;</pre></div><p>This is why <a id="id18" class="indexterm"/>we added all those classes to shapes. We made the axes thin, gave them a light-gray color, and used a relatively small font for the labels. The bars should be steel blue. Refresh the page now and the histogram is beautiful:</p><div class="mediaobject"><img src="images/0007OS_01_05.jpg" alt="A simple histogram"/></div><p>I suggest playing around with the values for <code class="literal">width</code>, <code class="literal">height</code>, <code class="literal">left_pad</code>, and <code class="literal">pad</code> to get a feel of the power of <code class="literal">d3.js</code>. You'll notice everything scales and adjusts to any size without having to change the other code. Marvelous!</p></div></div>


  <div id="sbo-rt-content"><div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec11"/>Summary</h1></div></div></div><p>We've learned what d3.js is and took a glance at the core philosophy behind how it works. We've also set up a quick and easy environment for prototyping ideas and playing with visualizations. This environment will be assumed throughout the book.</p><p>We've also gone through a simple example and created an animated histogram using some of the basics of <code class="literal">d3.js</code>. We found out about scales and axes, that the vertical axis is inverted, that any property defined as a function is recalculated for every data point, and that we use a combination of CSS and SVG to make things beautiful.</p><p>Most of all, this chapter has given you the basic tools so that you can start playing with d3.js on your own. Tinkering is your friend.</p></div></div>
</body></html>