<html><head></head><body>
		<div><h1 id="_idParaDest-55" class="chapter-number"><a id="_idTextAnchor054"/>3</h1>
			<h1 id="_idParaDest-56"><a id="_idTextAnchor055"/>Starting Out with Functions – A Core Concept</h1>
			<p>In <a href="B19301_02.xhtml#_idTextAnchor037"><em class="italic">Chapter 2</em></a>, <em class="italic">Thinking Functionally</em>, we discussed an example of FP thinking, but now, let’s look at the basics and review functions.</p>
			<p>In this chapter, we’ll do the following:</p>
			<ul>
				<li>Discuss functions in JavaScript, including how to define them, with a particular focus on arrow functions</li>
				<li>Learn about currying and functions as first-class objects</li>
				<li>Explore several ways of using functions in an FP way</li>
			</ul>
			<p>After going through all this content, you’ll be up to date with the generic and specific concepts relating to functions, which are, after all, at the core of FP!</p>
			<h1 id="_idParaDest-57"><a id="_idTextAnchor056"/>All about functions</h1>
			<p>Let’s start with a short review of <a id="_idIndexMarker117"/>functions in JavaScript and their relationship to FP concepts. We will begin with something that we mainly mentioned in the <em class="italic">Functions as first-class objects</em> section of <a href="B19301_01.xhtml#_idTextAnchor015"><em class="italic">Chapter 1</em></a><em class="italic">, Becoming Functional,</em> and again in a couple of places in <a href="B19301_02.xhtml#_idTextAnchor037"><em class="italic">Chapter 2</em></a>, <em class="italic">Thinking Functionally</em>, and then go on to several considerations about their usage in actual coding. In particular, we’ll be looking at the following:</p>
			<ul>
				<li>Some basic concepts about lambda calculus, which is the theoretical basis for FP</li>
				<li>Arrow functions, which are the most direct translation of lambda calculus into JavaScript</li>
				<li>Using functions as first-class objects, a key concept in FP</li>
			</ul>
			<h2 id="_idParaDest-58"><a id="_idTextAnchor057"/>Of lambdas and functions</h2>
			<p>In lambda <a id="_idIndexMarker118"/>calculus terms, a function can look like λ<em class="italic">x</em>.2*<em class="italic">x</em>. The understanding<a id="_idIndexMarker119"/> is that the variable after the λ character (the Greek letter <em class="italic">lambda</em> in lowercase) is the parameter for the function, and the expression after the dot is where you would replace whatever value is passed as an argument. Later in this chapter, we will see that this particular example could be written as <code>(x) =&gt; 2*x</code> in JavaScript in arrow function form, which, as you can see, is very similar.</p>
			<p class="callout-heading">An alliterative aid</p>
			<p class="callout">If you sometimes wonder about the difference between arguments and parameters, a mnemonic with some alliteration may help: <em class="italic">Parameters are Potential, Arguments are Actual</em>. Parameters are<a id="_idIndexMarker120"/> placeholders for potential values that will be passed, and arguments are the actual values passed to the function. In other words, when you define the function, you list its parameters, and when you call it, you provide arguments.</p>
			<p>Applying a function means you provide an actual argument to it, which is written in the usual way, using parentheses. For example, (λ<em class="italic">x</em>.2*<em class="italic">x</em>)(3) would be calculated as 6. What’s the equivalent of these lambda functions in JavaScript? That’s an interesting question! There are several ways of defining functions, and not all have the same meaning.</p>
			<p>In how many ways can you <a id="_idIndexMarker121"/>define a function in JavaScript? The answer is probably in more ways than you thought! (A good article that shows the many ways of defining functions, methods, and more is <em class="italic">The Many Faces of Functions in JavaScript</em>, by Leo Balter and Rick Waldron, at <a href="http://bocoup.com/blog/the-many-faces-of-functions-in-javascript">bocoup.com/blog/the-many-faces-of-functions-in-javascript</a> – give it a look!) At the very least, you could write the following – and I’ll use vanilla JavaScript because here types aren’t a concern:</p>
			<ul>
				<li>A named function declaration: <code>function </code><code>first(...) {...};</code></li>
				<li>An anonymous function expression: <code>var second = </code><code>function(...) {...};</code></li>
				<li>A named function expression: <code>var third = function </code><code>someName(…) {...};</code></li>
				<li>An immediately-invoked expression: <code>var fourth = (function() { ...; return function(...) {...}; })();</code></li>
				<li>A function constructor: <code>var fifth = </code><code>new Function(...);</code></li>
				<li>An arrow function: <code>var sixth = (...) =&gt; {...};</code></li>
			</ul>
			<p>If you wanted, you <a id="_idIndexMarker122"/>could add object method declarations since they also imply functions, but the preceding list should be enough.</p>
			<p class="callout-heading">More function types</p>
			<p class="callout">JavaScript also allows us to<a id="_idIndexMarker123"/> define <code>function*(...) {...}</code>) that return a <code>Generator</code> object and <code>async</code> functions that are a mix of generators and <a id="_idIndexMarker124"/>promises. You can read more <a id="_idIndexMarker125"/>about them at <a href="http://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Statements/function">developer.mozilla.org/en/docs/Web/JavaScript/Reference/Statements/function</a> and <a href="http://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function</a>, respectively.</p>
			<p>What’s the difference between all these ways of defining functions, and why should we care? Let’s go over them one by one:</p>
			<ul>
				<li>The first definition, <code>function first(...) {...}</code>, a standalone declaration starting with the <code>function</code> keyword, is probably the most used in JavaScript and defines a function named <code>first</code> (that is, <code>first.name==="first"</code>). Because of <code>var</code> definition; with <code>let</code> or <code>const</code>, hoisting doesn’t apply. You can read more about <a id="_idIndexMarker127"/>hoisting at <a href="http://developer.mozilla.org/en-US/docs/Glossary/Hoisting">developer.mozilla.org/en-US/docs/Glossary/Hoisting</a>. Remember that it applies only to declarations,  not to initializations.)</li>
				<li>The <code>second = function(...) {...}</code> definition, which assigns a function to a variable, also produces a function, but an <em class="italic">anonymous</em> (that is, not named) one. However, many JavaScript engines can deduce what the name should be and will then set <code>second.name === "second"</code>. (Look at the following code, which shows a case where the anonymous function has no name assigned.) Since the assignment isn’t hoisted, the function will only be accessible after the assignment has been executed. Also, you’d probably prefer defining the variable with <code>const</code> rather than <code>var</code>, because you wouldn’t (shouldn’t) be changing the function – take a look at the ESLint <code>no-var</code> and <code>prefer-const</code> rules to enforce this:<pre class="source-code">
var second = function() {};
console.log(second.name);
// "second"
var myArray = new Array(3);
myArray[1] = function() {};
console.log(myArray[1].name);
// ""</pre></li>
				<li>The third <a id="_idIndexMarker128"/>definition, <code>third = function someName(…) {...}</code>, is the same as the second, except that the function now has its own name: <code>third.name === "someName"</code>. The name of a function is relevant when you want to call it and is needed for recursive calls; we’ll return to this in <a href="B19301_09.xhtml#_idTextAnchor172"><em class="italic">Chapter 9</em></a>, <em class="italic">Designing Functions</em>. If you just want a function for, say, a callback, you can use one without a name. However, note that named functions are more easily recognized in an error traceback, the kind of listing you use when trying to understand what happened, and which function called what.</li>
				<li>The fourth definition, <code>fourth = (function() { ...; return function(...) {...}; })()</code>, with an immediately-invoked expression, lets you use a closure. Going back to the counter-making function that we saw in the <em class="italic">Closures</em> section of <a href="B19301_01.xhtml#_idTextAnchor015"><em class="italic">Chapter 1</em></a>, <em class="italic">Becoming Functional</em>, we could write something like the following. An inner function can use variables or other functions, defined in its outer function, in a private, encapsulated way. The outer function receives an argument (<code>77</code>, in this case) that is used as the initial value of <code>count</code> (if no initial value is provided, we start at <code>0</code>). The inner function can access <code>count</code> (because of the closure), but the variable cannot be accessed anywhere else. In all aspects, the returned function is common – the only difference is its access to private elements. This is also the basis of<a id="_idIndexMarker129"/> the <strong class="bold">module</strong> pattern:<pre class="source-code">
const myCounter = <strong class="bold">(</strong>function myCounter(initialValue =
  0) {
  let count = initialValue;
  return function () {
    count++;
    return count;
  };
}<strong class="bold">)(77)</strong>;
console.log(myCounter()); // 78
console.log(myCounter()); // 79
console.log(myCounter()); // 80</pre></li>
				<li>The fifth <a id="_idIndexMarker130"/>definition, <code>fifth = new Function(...)</code>, isn’t safe and you shouldn’t use it! You pass the names of the arguments first, then the actual function body as a string, and the equivalent of <code>eval()</code> is used to create the function – this allows many dangerous hacks, so don’t do this! (Also, TypeScript cannot deduce the type of the produced function; it just assumes the generic <code>Function</code> type.) Just to whet your curiosity, let’s look at an example of rewriting the very simple <code>sum3()</code> function we saw back in the <em class="italic">Spread</em> section of <a href="B19301_01.xhtml#_idTextAnchor015"><em class="italic">Chapter 1</em></a><em class="italic">, </em><em class="italic">Becoming Functional</em>:<pre class="source-code">
const sum3 = new Function(
  "x",
  "y",
  "z",
  "const t = x+y+z; return t;"
);
sum3(4, 6, 7); // 17</pre></li>
			</ul>
			<p class="callout-heading">Quirks of eval()</p>
			<p class="callout">This definition is not only unsafe but has some other quirks – they don’t create closures with their creation contexts, so they are always global. See <a href="http://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function">developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function</a> for more on this, but remember that this way of creating functions isn’t a good idea!</p>
			<ul>
				<li>Finally, the last<a id="_idIndexMarker131"/> definition, <code>sixth = (...) =&gt; {...}</code>, which uses an arrow, <code>=&gt;</code>, is the most compact way to define a function and the one we’ll try to use whenever possible.</li>
			</ul>
			<p>At this point, we have seen several ways of defining a function, so let’s focus on arrow functions, a style we’ll favor in our coding for this book.</p>
			<h2 id="_idParaDest-59"><a id="_idTextAnchor058"/>Arrow functions – the modern way</h2>
			<p>Even if arrow functions<a id="_idIndexMarker132"/> work in pretty much the same way as the other functions, there are<a id="_idIndexMarker133"/> some <a id="_idIndexMarker134"/>crucial differences (see <a href="http://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions">developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions</a>) between them and the usual ones: arrow functions can implicitly return a value even with no return statement present; the value of <code>this</code> (the context for the function) is not bound; there is no <code>arguments</code> object; they cannot be used as constructors; they do not have a prototype property; and they cannot be used as generators because they don’t allow the <code>yield</code> keyword.</p>
			<p>In this section, we’ll go into several JavaScript function-related topics, including these:</p>
			<ul>
				<li>How to return different values</li>
				<li>How to handle problems with the value of <code>this</code></li>
				<li>How to work with varying numbers of arguments</li>
				<li>An important concept, currying, for which we’ll find many usages in the rest of this book</li>
			</ul>
			<h3>Returning values</h3>
			<p>In the<a id="_idIndexMarker135"/> lambda coding style, functions only consist of a result. For the sake of brevity, the new arrow functions provide a syntax for this. When you write something such as <code>(x,y,z) =&gt;</code> followed by an expression, a <code>return</code> is implied. For instance, the following two functions do the same as the <code>sum3()</code> function that we showed previously:</p>
			<pre class="source-code">
const f1 = (x: number, y: number, z: number): number <strong class="bold">=&gt;</strong>
<strong class="bold">  x + y + z;</strong>
const f2 = (x: number, y: number, z: number): number <strong class="bold">=&gt; {</strong>
<strong class="bold">  return x + y + z;</strong>
<strong class="bold">};</strong></pre>
			<p>If you want to return an object, you <a id="_idIndexMarker136"/>must use parentheses; otherwise, JavaScript will assume that code follows. Lest you think this is a wildly improbable case, check out <em class="italic">Question 3.1</em> in the <em class="italic">Questions</em> section later in this chapter for a very common scenario!</p>
			<p class="callout-heading">A matter of style</p>
			<p class="callout">When you define an arrow function with only one parameter, you can omit the parentheses around it. For consistency, I prefer to always include them. Prettier, the formatting tool I use (we mentioned it in <a href="B19301_01.xhtml#_idTextAnchor015"><em class="italic">Chapter 1</em></a>, <em class="italic">Becoming Functional</em>), originally didn’t approve, but in version 2.0, it changed the default of its <code>arrow-parens</code> configuration item from <code>avoid</code> (meaning, try to do without parentheses) to <code>always</code>.</p>
			<h3>Handling the <code>this</code> value</h3>
			<p>A classic problem with JavaScript <a id="_idIndexMarker137"/>is handling <code>this</code>, whose value isn’t always what you expect it to be. ES2015 solved this with arrow functions, which inherit the proper <code>this</code> value so that problems are avoided. Look at the following code for an example of the possible problems: by the time the timeout function is called, <code>this</code> will point to the global (<code>window</code>) variable instead of the new object, so you’ll get <code>undefined</code> in the console:</p>
			<pre class="source-code">
function ShowItself1(identity: string) {
  this.identity = identity;
  setTimeout(function () {
    console.log(this.identity);
  }, 1000);
}
var x = new ShowItself1("Functional");
// after one second, <strong class="bold">undefined</strong> is displayed, not <strong class="bold">Functional</strong></pre>
			<p>There are traditional ways of solving this with old-fashioned JavaScript:</p>
			<ul>
				<li>One solution uses a closure and defines a local variable (usually named <code>that</code> or sometimes <code>self</code>) that will get the original value of <code>this</code>, so it won’t be undefined</li>
				<li>The second way uses <code>bind()</code>, so the timeout function will be bound to the correct value of this (we used <code>bind()</code> for a similar purpose in the <em class="italic">Of lambdas and </em><em class="italic">functions</em> section)</li>
				<li>A third, more modern way just uses an arrow function, so <code>this</code> gets the correct value (pointing to the object) without further ado</li>
			</ul>
			<p>Let’s see the three solutions in<a id="_idIndexMarker138"/> actual code. We use a closure for the first timeout, binding for the second, and an arrow function for the third:</p>
			<pre class="source-code">
// continued...
function ShowItself2(identity: string) {
  this.identity = identity;
  <strong class="bold">const that = this</strong>;
  setTimeout(function () {
    console.log(<strong class="bold">that.identity</strong>);
  }, 1000);
  setTimeout(
    function () {
      console.log(this.identity);
    }<strong class="bold">.bind(this)</strong>,
    2000
  );
  setTimeout(<strong class="bold">() =&gt;</strong> {
    console.log(this.identity);
  }, 3000);
}
const x2 = new ShowItself2("JavaScript");
// after one second, "JavaScript"
// after another second, the same
// after yet another second, once again</pre>
			<p>If you <a id="_idIndexMarker139"/>run this code, you’ll get <code>JavaScript</code> after 1 second, then again after another second, and a third time after another second. All three methods worked correctly, so whichever you pick just depends on which you like better.</p>
			<h3>Working with arguments</h3>
			<p>In <a href="B19301_01.xhtml#_idTextAnchor015"><em class="italic">Chapter 1</em></a>, <em class="italic">Becoming Functional</em>, and <a href="B19301_02.xhtml#_idTextAnchor037"><em class="italic">Chapter 2</em></a>, <em class="italic">Thinking Functionally</em>, we saw some uses of the spread (<code>...</code>) operator. However, the most practical usage we’ll be making of it has to do with working with arguments; we’ll see some<a id="_idIndexMarker140"/> cases of this in <a href="B19301_06.xhtml#_idTextAnchor107"><em class="italic">Chapter 6</em></a>, <em class="italic">Producing Functions</em>. </p>
			<p>Let’s review our <code>once()</code> function from <a href="B19301_02.xhtml#_idTextAnchor037"><em class="italic">Chapter 2</em></a><em class="italic">, </em><em class="italic">Thinking Functionally</em>:</p>
			<pre class="source-code">
// once.ts
const once = &lt;FNType extends (...args: any[]) =&gt; any&gt;(
  fn: FNType
) =&gt; {
  let done = false;
  return ((<strong class="bold">...args</strong>: Parameters&lt;FNType&gt;) =&gt; {
    if (!done) {
      done = true;
      return fn(<strong class="bold">...args</strong>);
    }
  }) as FNType;
};</pre>
			<p>Why are we writing <code>return (...args) =&gt;</code> and then afterward <code>func(...args)</code>? The answer has to do with the more modern way of handling a variable number (possibly zero) of arguments. How did you manage such kinds of code in older versions of JavaScript? The answer is the <code>arguments</code> object (not an array; read <a href="http://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Functions/arguments">developer.mozilla.org/en/docs/Web/JavaScript/Reference/Functions/arguments</a>) that lets you access the actual arguments passed to the function.</p>
			<p>It <a id="_idIndexMarker141"/>happens that <code>arguments</code> is an <em class="italic">array-like</em> object, not really an array – the only array property it has is <code>length</code>. You cannot use methods such as <code>map()</code>, <code>forEach()</code>, and others on <code>arguments</code>. To convert <code>arguments</code> into a real array, you have to use <code>slice()</code>; you would also have to use <code>apply()</code> to call another function, like so:</p>
			<pre class="source-code">
function useArguments() {
  …
  var myArray = Array.prototype.slice.call(arguments);
  somethingElse.apply(null, myArray);
  …
}</pre>
			<p>In modern JavaScript, you don’t need to use arguments, slicing, or applying:</p>
			<pre class="source-code">
function useArguments2(...args) {
  …
  somethingElse(...args);
  …
}</pre>
			<p>You should bear in mind the following points when looking at this code:</p>
			<ul>
				<li>By writing <code>useArguments2(...args)</code>, we immediately and clearly express that our new function receives several (possibly zero) arguments</li>
				<li>You don’t need to do anything to get an array; <code>args</code> is a genuine array</li>
				<li>Writing <code>somethingElse(...args)</code> is much clearer than using <code>apply()</code></li>
			</ul>
			<p>By the way, the <code>arguments</code> object is still available in the current version of JavaScript. If you want to create an array from it, you have two alternative ways of doing so without having to resort to the <code>Array.prototype.slice.call</code> trick:</p>
			<ul>
				<li>Use the <code>from()</code> method and write <code>myArray=Array.from(arguments)</code></li>
				<li>Write <code>myArray=[...arguments]</code>, which shows yet another type of usage of the spread operator</li>
			</ul>
			<p>When we<a id="_idIndexMarker142"/> get to the topic of higher-order functions, writing functions that deal with other functions, with a possibly unknown number of parameters, will be commonplace.</p>
			<p>JavaScript provides a much shorter way of doing this, so you’ll have to get accustomed to this usage. It’s worth it!</p>
			<h3>One argument or many?</h3>
			<p>It’s also possible to write functions that return functions, and in <a href="B19301_06.xhtml#_idTextAnchor107"><em class="italic">Chapter 6</em></a>, <em class="italic">Producing Functions</em>, we will see more of this. For instance, in lambda calculus, you don’t write functions with several parameters, but only one; you do this using a technique <a id="_idIndexMarker143"/>called <strong class="bold">currying</strong>. (But why would you do this? Hold that thought; we’ll come to this later.)</p>
			<p class="callout-heading">Twice recognized</p>
			<p class="callout">Currying gets its name from Haskell Curry, who developed the concept. A functional language, <em class="italic">Haskell</em>, is also named after him – double recognition!</p>
			<p>For instance, the function that we saw previously that sums three numbers would be written as follows:</p>
			<pre class="source-code">
// sum3.ts
const altSum3 = (x: number) =&gt; (y: number) =&gt; (z: number)
  =&gt;
    x + y + z;</pre>
			<p>Why did I change the function’s name? Simply put, this is <em class="italic">not</em> the same function we saw previously. The type of <code>sum3()</code> is <code>(x: number, y: number, z: number) =&gt; number</code>, while that of <code>altSum3()</code> is <code>(x: number) =&gt; (y: number) =&gt; (z: number) =&gt; number</code>, which is different. (See <em class="italic">Question 3.3</em> for more on this.) As-is, though, it can be used to produce the very same results as our earlier function. Let’s look at how you would use it, say, to sum the numbers 1, 2, and 3:</p>
			<pre class="source-code">
altSum3(1)(2)(3); // 6</pre>
			<p>Test yourself before reading on, and think about this: what would have been returned if you had written <code>altSum3(1,2,3)</code> instead? Tip: it would not be a number! For the full answer, keep reading.</p>
			<p>How does this work? Separating it into many calls can help; this would be the way the previous expression is calculated by the JavaScript interpreter:</p>
			<pre class="source-code">
const fn1 = altSum3(1);
const fn2 = fn1(2);
const fn3 = fn2(3);</pre>
			<p>Think functionally! The result of calling <code>altSum3(1)</code> is, according to the definition, a function, which, in virtue of a closure, resolves to be equivalent to the following:</p>
			<pre class="source-code">
const fn1 = y =&gt; z =&gt; 1 + y + z;</pre>
			<p>Our <code>altSum3()</code> function is meant to receive a single argument, not three! The result of this call, <code>fn1</code>, is also a single-argument function. When you use <code>fn1(2)</code>, the result is again a function, also with a single parameter, which is equivalent to the following:</p>
			<pre class="source-code">
const fn2 = z =&gt; 1 + 2 + z;</pre>
			<p>And when you calculate <code>fn2(3)</code>, a value is finally returned – great! As we said, the function performs the same kind of calculations as we saw earlier, but in an intrinsically different way.</p>
			<p>You might think that <a id="_idIndexMarker144"/>currying is a peculiar trick: who would want to use only single-argument functions? You’ll see the reasons for this when we consider how to join functions together in <a href="B19301_08.xhtml#_idTextAnchor148"><em class="italic">Chapter 8</em></a>, <em class="italic">Connecting Functions</em>, and <a href="B19301_12.xhtml#_idTextAnchor221"><em class="italic">Chapter 12</em></a>, <em class="italic">Building Better Containers</em>, where it won’t be feasible to pass more than one parameter from one step to the next.</p>
			<h2 id="_idParaDest-60"><a id="_idTextAnchor059"/>Functions as objects</h2>
			<p>The concept of first-class objects<a id="_idIndexMarker145"/> means that functions can be created, assigned, changed, passed as parameters, and returned as a result of other functions in the same way you can with, say, numbers or strings. Let’s start with its definition. Let’s look at how you usually define a function – and do you recognize the function’s name? (Hint: google “Colossal Cave Adventure”!)</p>
			<pre class="source-code">
function xyzzy(...) { ... }</pre>
			<p>This is (almost) equivalent to writing the following:</p>
			<pre class="source-code">
var xyzzy = function(...) { ... }</pre>
			<p>However, this is not true for hoisting, as we explained in the <em class="italic">Of lambdas and functions</em> section. JavaScript moves all definitions to the top of the current scope but does <em class="italic">not</em> move the assignments. With the first definition, you can invoke <code>xyzzy(...)</code> from any place in your code, but with the second, you cannot invoke the function until the assignment has been executed.</p>
			<p>The point that we want to<a id="_idIndexMarker146"/> make is that a function can be assigned to a variable and can also be reassigned if desired. In a similar vein, we can define functions on the spot where they are needed. We can even do this without naming them: as with common expressions, if they are used only once, you don’t need to name them or store them in a variable.</p>
			<p class="callout-heading">A colossal parallel</p>
			<p class="callout">See the parallel with the <em class="italic">Colossal Cave Adventure</em> game from the 70s? Invoking <code>xyzzy()</code> anywhere won’t always work! If you have never played that famous interactive fiction game, try it online – for example, at <a href="http://www.web-adventures.org/cgi-bin/webfrotz?s=Adventure">www.web-adventures.org/cgi-bin/webfrotz?s=Adventure</a> or <a href="http://www.amc.com/blogs/play-the-colossal-cave-adventure-game-just-like-halt-and-catch-fires-cameron-howe--1009966">www.amc.com/blogs/play-the-colossal-cave-adventure-game-just-like-halt-and-catch-fires-cameron-howe--1009966</a>.</p>
			<p>Let’s see an actual code example that involves assigning functions.</p>
			<h3>A React-Redux reducer</h3>
			<p>As we mentioned in <a href="B19301_01.xhtml#_idTextAnchor015"><em class="italic">Chapter 1</em></a>, <em class="italic">Becoming Functional</em>, React-Redux<a id="_idIndexMarker147"/> works by dispatching actions <a id="_idIndexMarker148"/>that a <em class="italic">reducer</em> processes. (Read more about this at <a href="http://redux.js.org/tutorials/fundamentals/part-3-state-actions-reducers">redux.js.org/tutorials/fundamentals/part-3-state-actions-reducers</a>.) Usually, the reducer includes code with a switch. An example follows – and I’m using JavaScript (not TypeScript) to focus on logic aspects:</p>
			<pre class="source-code">
// reducer.ts
function doAction(
  state = initialState,
  action = emptyAction
) {
  const newState: State = {};
  switch (action?.type) {
    case "CREATE":
      // update state, generating newState,
      // depending on the action data
      // to create a new item
      return newState;
    case "DELETE":
      // update state, generating newState,
      // after deleting an item
      return newState;
    case "UPDATE":
      // update an item,
      // and generate an updated state
      return newState;
    default:
      return state;
  }
}</pre>
			<p class="callout-heading">Initial state</p>
			<p class="callout">Providing <code>initialState</code> as a default value for the state is a simple way of initializing the global state. Pay no attention to that <code>default</code>; it’s irrelevant to our example, and I included it just for completeness. I’m also assuming the existence of <code>State</code>,  <code>Action</code>, and others as types – see <em class="italic">Question 3.5</em>!</p>
			<p>By taking advantage of the <a id="_idIndexMarker149"/>possibility of storing functions, we can build a <strong class="bold">dispatch</strong> <strong class="bold">table</strong> and <a id="_idIndexMarker150"/>simplify the preceding code. First, we initialize an object with the code for the functions for each action type. We are just taking the preceding code and creating separate functions:</p>
			<pre class="source-code">
// continued...
const dispatchTable = {
  CREATE: (state, action) =&gt; {
    // update state, generating newState,
    // depending on the action data
    // to create a new item
    const NewState = {
      /* updated State */
    };
    return NewState;
  },
  DELETE: (state, action) =&gt; {
    // update state, generating newState,
    // after deleting an item
    const NewState = {
      /* updated State */
    };
    return NewState;
  },
  UPDATE: (state, action) =&gt; {
    // update an item,
    // and generate an updated state
    const NewState = {
      /* updated State */
    };
    return NewState;
  },
};</pre>
			<p>We store the different functions that process each type of action as attributes in an object that will work as <a id="_idIndexMarker151"/>a dispatcher table. This object is created only once and is constant during the execution of the application. With it, we can now rewrite the action-processing code in a single line of code:</p>
			<pre class="source-code">
// continued...
function doAction2(state, action) {
  return dispatchTable[action.type]
    ? <strong class="bold">dispatchTable[action.type](state, action)</strong>
    : state;
}</pre>
			<p>Let’s analyze it: given the action, if <code>action.type</code> matches an attribute in the dispatching object, we execute the corresponding function taken from the object where it was stored. If there isn’t a match, we just return the current state as Redux requires. This kind of code wouldn’t be possible if we couldn’t handle functions (storing and recalling them) as first-class objects.</p>
			<h3>An unnecessary mistake</h3>
			<p>There is, however, a common (though, in fact, harmless) mistake that is usually made. You often see code like this:</p>
			<pre class="source-code">
fetch("some/url").then(function(data) {
  processResult(data);
});
fetch("some/url").then(<strong class="bold">(data) =&gt; processResult(data)</strong>);</pre>
			<p>What does this code do? The idea is that a remote URL is fetched, and when the data arrives, a function is called – and this function calls <code>processResult</code> with <code>data</code> as an argument. That is to say, in the <code>then()</code> part, we want a function that, given data, calculates <code>processResult(data)</code>. But don’t we already have such a function?</p>
			<p>There is a rule that you can apply whenever you see something like the following:</p>
			<pre class="source-code">
function someFunction(someData) {
  return someOtherFunction(someData);
}</pre>
			<p>This rule states that you can replace code resembling the preceding code with just <code>someOtherFunction</code>. So, in our example, we can directly write what follows:</p>
			<pre class="source-code">
fetch("some/url").then(<strong class="bold">processResult</strong>);</pre>
			<p>This code is equivalent to the previous method that we looked at (although it is infinitesimally quicker since you avoid one function call), but is it simpler to understand?</p>
			<p class="callout-heading">Some terminology</p>
			<p class="callout">In lambda calculus<a id="_idIndexMarker152"/> terms, we are replacing λ<em class="italic">x</em>.<em class="italic">func</em> <em class="italic">x</em> with simply <em class="italic">func</em> – this is called an <strong class="bold">η (eta) conversion</strong>, or more<a id="_idIndexMarker153"/> specifically, an <strong class="bold">η</strong><strong class="bold"> reduction</strong>. (If you were to do it the other way round, it would be an <strong class="bold">η</strong><strong class="bold"> abstraction</strong>.) In our case, it could be<a id="_idIndexMarker154"/> considered a (very, very small!) optimization, but its main advantage is shorter, more compact code.</p>
			<p>This programming style is<a id="_idIndexMarker155"/> called <strong class="bold">pointfree</strong> (also <strong class="bold">point-free</strong>) or <strong class="bold">tacit</strong> style, and its <a id="_idIndexMarker156"/>defining characteristic is that you never specify the arguments for each function application. An advantage of this way of coding is that it helps the writer (and the future readers of the code) think about the functions and their meanings instead of working at a low level, passing data around, and working with it. In the shorter version of the code, there are no extraneous or irrelevant details: if you know what the called function does, you understand the meaning of the complete piece of code. We’ll often (but not necessarily always) work this way in our text.</p>
			<p class="callout-heading">Old Unix style</p>
			<p class="callout">Unix/Linux users are already accustomed to this style because they work in a similar way when they use pipes to pass the result of a command as input to another. When you write something as <code>ls|grep doc|sort</code>, the output of <code>ls</code> is the input to <code>grep</code>, and the latter’s output is the input to <code>sort</code> – but input arguments aren’t written out anywhere; they are implied. We’ll come back to this in the <em class="italic">Pointfree style</em> section of <a href="B19301_08.xhtml#_idTextAnchor148"><em class="italic">Chapter 8</em></a><em class="italic">, </em><em class="italic">Connecting Functions</em>.</p>
			<h3>Working with methods</h3>
			<p>However, there is a case that<a id="_idIndexMarker157"/> you should be aware of: what happens if you call an object’s method? Look at the following code:</p>
			<pre class="source-code">
fetch("some/remote/url").then(function (data) {
  myObject.store(data);
});</pre>
			<p>If your original code had been something along the lines of the preceding code, then the seemingly obvious transformed code would fail:</p>
			<pre class="source-code">
fetch("some/remote/url").then(<strong class="bold">myObject.store</strong>); // Fail!</pre>
			<p>Why? The reason is that in the original code, the called method is bound to an object (<code>myObject</code>), but in the modified code, it isn’t bound and is just a free function. We can fix it by using <code>bind()</code>:</p>
			<pre class="source-code">
fetch("some/remote/url").then(
  <strong class="bold">myObject.store.bind(myObject)</strong>
);</pre>
			<p>This is a general solution. When dealing with a method, you cannot just assign it; you must use <code>bind()</code> so that the correct context will be available. Look at the following code:</p>
			<pre class="source-code">
const doSomeMethod = (someData) =&gt; {
  return someObject.someMethod(someData);
}</pre>
			<p>Following this rule, such code should be converted into the following:</p>
			<pre class="source-code">
const doSomeMethod = someObject.someMethod.bind(someObject);</pre>
			<p class="callout-heading">Tip</p>
			<p class="callout">Read more<a id="_idIndexMarker158"/> on <code>bind()</code> at <a href="http://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_objects/Function/bind">developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_objects/Function/bind</a>.</p>
			<p>This looks rather <a id="_idIndexMarker159"/>awkward and not too elegant, but it’s required so that the method will be associated with the correct object. We will see one application of this when we <em class="italic">promisify</em> functions in <a href="B19301_06.xhtml#_idTextAnchor107"><em class="italic">Chapter 6</em></a>, <em class="italic">Producing Functions</em>. Even if this code isn’t so nice to look at, whenever you have to work with objects (and remember, we didn’t say that we would be trying to aim for fully FP code, and did say that we would accept other constructs if they made things easier), you’ll have to remember to bind methods before passing them as first-class objects in pointfree style.</p>
			<p>So far, we have been discussing many aspects of functions; now, let’s get more into functions in FP, and see how we’ll use them.</p>
			<h1 id="_idParaDest-61"><a id="_idTextAnchor060"/>Using functions in FP ways</h1>
			<p>Several common coding patterns take advantage of the FP style, even if you aren’t aware of it. In this section, we will go through them and look at the functional aspects of the code so that you can get more accustomed to this coding style.</p>
			<p>Then, we’ll look in detail at using functions in an FP way<a id="_idIndexMarker160"/> by considering several FP techniques, such as the following:</p>
			<ul>
				<li><strong class="bold">Injection</strong>, which is needed for sorting different strategies, as well as other uses</li>
				<li><strong class="bold">Callbacks</strong> and <strong class="bold">promises</strong>, introducing the <strong class="bold">continuation-passing</strong> style</li>
				<li><strong class="bold">Polyfilling</strong> and <strong class="bold">stubbing</strong></li>
				<li><strong class="bold">Immediate </strong><strong class="bold">invocation</strong> schemes</li>
			</ul>
			<h2 id="_idParaDest-62"><a id="_idTextAnchor061"/>Injection – sorting it out</h2>
			<p>The <code>Array.prototype.sort()</code> method <a id="_idIndexMarker161"/>provides the first example of passing functions as parameters. If you have an array of strings and you want to sort it, you can <a id="_idIndexMarker162"/>just use the <code>sort()</code> method. For example, to alphabetically sort an array with the colors of the rainbow, we would write something like the following:</p>
			<pre class="source-code">
// sort.ts
const colors = [
  "violet",
  "indigo",
  "blue",
  "green",
  "yellow",
  "orange",
  "red",
];
colors.sort();
console.log(colors);
// 'blue', 'green', 'indigo', 'orange', 'red',
// 'violet', 'yellow'</pre>
			<p>Note that we didn’t have to provide any parameters to the <code>sort()</code> call, but the array got sorted perfectly well. By default, this method sorts strings according to their ASCII internal representation. So, if you use this method to sort an array of numbers, it will fail because it will decide that 20 must be between 100 and 3, as 100 precedes 20 (taken as strings!) and the latter precedes 3, so this needs fixing! The following code shows the problem:</p>
			<pre class="source-code">
// continued...
const someNumbers = [3, 20, 100];
someNumbers.sort();
console.log(someNumbers);
// 100, 20, 3</pre>
			<p>But let’s forget <a id="_idIndexMarker163"/>numbers for a while and stick to sorting strings. What would happen if we <a id="_idIndexMarker164"/>wanted to sort some Spanish words (<em class="italic">palabras</em>) while following the appropriate locale rules? We would be sorting strings, but the results wouldn’t be correct:</p>
			<pre class="source-code">
// continued...
const palabras = [
  "ñandú",
  "oasis",
  "mano",
  "natural",
  "mítico",
  "musical",
];
palabras.sort();
console.log(palabras);
<strong class="bold">// "mano", "musical", "mítico",</strong>
<strong class="bold">// "natural", "oasis", "ñandú" -- wrong result!</strong></pre>
			<p class="callout-heading">What’s in a word?</p>
			<p class="callout">For language or biology buffs, <em class="italic">ñandú</em> in English is <em class="italic">rhea</em>, a running bird similar to an ostrich. There aren’t many Spanish words beginning with <em class="italic">ñ</em>, and we happen to have these birds in my country, Uruguay, so that’s the reason for the odd word!</p>
			<p>Oops! In Spanish, <em class="italic">ñ</em> comes <a id="_idIndexMarker165"/>between <em class="italic">n</em> and <em class="italic">o</em>, but <code>"ñandú"</code> got sorted at the end. Also, <code>"mítico"</code> (in English, mythical; note the accented <em class="italic">í</em>) should appear between <code>"mano"</code> and <code>"musical"</code> because the tilde should be ignored. The appropriate way of solving this is by providing a comparison function to <code>sort()</code>. In this case, we can use the <code>localeCompare()</code> method<a id="_idIndexMarker166"/> as follows:</p>
			<pre class="source-code">
// continued...
palabras.sort((a: string, b: string) =&gt;
  a.localeCompare(b, "es")
);
console.log(palabras);
<strong class="bold">// "mano", "mítico", "musical",</strong>
<strong class="bold">// "natural", "ñandú", "oasis" –- correct result!</strong></pre>
			<p>The <code>a.localeCompare(b,"es")</code> call compares the <code>a</code> and <code>b</code> strings and returns a negative value should <code>a</code> precede <code>b</code>, a positive value should <code>a</code> follow <code>b</code>, and 0 if <code>a</code> and <code>b</code> are the same – but according to Spanish (<code>"es"</code>) ordering rules.</p>
			<p>Now, things are right! And the code could be made clearer by introducing a new function, <code>spanishComparison()</code>, to perform the required strings comparison:</p>
			<pre class="source-code">
// continued...
const spanishComparison = (a: string, b: string) =&gt;
  a.localeCompare(b, "es");
palabras.sort(spanishComparison); // same correct result</pre>
			<p class="callout-heading">International sorting</p>
			<p class="callout">For more on<a id="_idIndexMarker167"/> the <code>localeCompare()</code> possibilities, see <a href="http://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/String/localeCompare">developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/String/localeCompare</a>. You can specify which locale rules to apply, in which order to place upper/lowercase letters, whether to ignore punctuation, and much more. But be careful: not all browsers may support the required extra parameters.</p>
			<p>In upcoming chapters, we will discuss how FP lets you write code in a more declarative fashion, producing more understandable code, and how this sort of minor change helps. When readers of the code get to the <code>sort</code> function, they will immediately deduce what is being done, even if the comment wasn’t present.</p>
			<p class="callout-heading">Of strategies and patterns</p>
			<p class="callout">This way of changing how the <code>sort()</code> function works by injecting different comparison functions is a case of the strategy <strong class="bold">design pattern</strong>. We’ll learn more about this in <a href="B19301_11.xhtml#_idTextAnchor204"><em class="italic">Chapter 11</em></a>, <em class="italic">Implementing </em><em class="italic">Design Patterns</em>.</p>
			<p>Providing a <code>sort</code> function as a parameter (in a very FP way!) can also help with several other problems, such as the following:</p>
			<ul>
				<li><code>sort()</code> only works with strings by default. If you want to sort numbers (as we tried to do previously), you <a id="_idIndexMarker168"/>have to provide a function that will compare numerically. For example, you would write something like <code>myNumbers.sort((a:number, b:number) =&gt; a – b)</code>. (Why? See <em class="italic">Question 3.7</em>.)</li>
				<li>If you want to sort objects<a id="_idIndexMarker169"/> by a given attribute, you will use a function that compares to it. For example, you could sort people by age with something like <code>myPeople.sort((a:Person, b:Person) =&gt; a.age - </code><code>b.age)</code>.</li>
			</ul>
			<p>This is a simple example you have probably used before, but it’s an FP pattern, after all. Let’s move on to even more common usage of functions as parameters when you perform Ajax calls.</p>
			<h2 id="_idParaDest-63"><a id="_idTextAnchor062"/>Callbacks and promises</h2>
			<p>Probably the most used <a id="_idIndexMarker170"/>example of functions passed as first-class objects has to do with callbacks<a id="_idIndexMarker171"/> and <a id="_idIndexMarker172"/>promises. In Node.js, reading a <a id="_idIndexMarker173"/>file is accomplished asynchronously with something like the following code:</p>
			<pre class="source-code">
const fs = require("fs");
fs.readFile("someFile.txt", (err, data) =&gt; {
  if (err) {
    // handle the error
  } else {
    // do something with the received data
  }
});</pre>
			<p>The <code>readFile()</code> function requires a callback – in this example, an anonymous function – that will get called when the file-reading operation is finished.</p>
			<p>A better, more modern way is using<a id="_idIndexMarker174"/> promises; read more at <a href="http://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise</a>. With this, when performing an Ajax web service call using the <code>fetch()</code> function, you could write something along the lines of the following code:</p>
			<pre class="source-code">
fetch("some/remote/url")
  .then((data) =&gt; {
    // do something with the received data
  })
  .catch((error) =&gt; {
    // handle the error
  });</pre>
			<p>Finally, you should also look into <a id="_idIndexMarker175"/>using <code>async</code>/<code>await</code>; read more about them at <a href="http://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function</a> and <a href="http://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await">developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await</a>, respectively.</p>
			<h2 id="_idParaDest-64"><a id="_idTextAnchor063"/>Continuation-passing style</h2>
			<p>The preceding <a id="_idIndexMarker176"/>code, in which you call a function but also pass another function to be executed when the input/output operation is<a id="_idIndexMarker177"/> finished, can be considered something called <strong class="bold">continuation-passing style</strong> (<strong class="bold">CPS</strong>). What is this technique of coding? One way of looking at it is by thinking about the question: <em class="italic">how would you program if using the return statement </em><em class="italic">was forbidden?</em></p>
			<p>At first glance, this may appear to be an impossible situation. However, we can get out of our fix by passing a callback to the called function so that when that procedure is ready to return to the caller, instead of returning, it invokes the given callback. By doing this, the callback provides the called function with the way to continue the process, hence the word <em class="italic">continuation</em>. We won’t get into this now, but in <a href="B19301_09.xhtml#_idTextAnchor172"><em class="italic">Chapter 9</em></a>, <em class="italic">Designing Functions</em>, we will study it in depth. In particular, CPS will help us to avoid an important recursion restriction, as we’ll see.</p>
			<p>Working out how to use continuations is sometimes challenging, but always possible. An exciting advantage of this way of coding is that by specifying how the process will continue, you can go beyond all the usual structures (<code>if</code>, <code>while</code>, <code>return</code>, and so on) and implement whatever mechanisms you want. This can be very useful in problems where the process isn’t necessarily linear. Of course, this can also lead to you inventing a kind of control structure far worse than the possible usage of GOTO statements that you might imagine! <em class="italic">Figure 3</em><em class="italic">.1</em> shows the dangers of that practice!</p>
			<div><div><img src="img/Figure_3.1_B19301.jpg" alt="Figure 3.1 – What’s the ﻿worst that could happen if you start messing with the program ﬂow? (This XKCD comic is available online at xkcd.com/292/)"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.1 – What’s the worst that could happen if you start messing with the program ﬂow? (This XKCD comic is available online at <a href="http://xkcd.com/292/">xkcd.com/292/</a>)</p>
			<p>You are not limited to passing a single continuation. As with promises, you can provide two or more alternative callbacks. And this, by the way, can provide a solution to the problem of how you would work with exceptions. If we simply allowed a function to throw an error, it would be an implied return to the caller, and we don’t want this. The way out of this is to provide an alternative callback (that is, a different continuation) to be used whenever an exception is thrown (in <a href="B19301_12.xhtml#_idTextAnchor221"><em class="italic">Chapter 12</em></a>, <em class="italic">Building Better Containers</em>, we’ll find another solution using monads):</p>
			<pre class="source-code">
function doSomething(a, b, c,
  normalContinuation, errorContinuation) {
  let r = 0;
  // ... do some calculations involving a, b, and c,
  // and store the result in r
  // if an error happens, invoke:
  // errorContinuation("description of the error")
  // otherwise, invoke:
  // normalContinuation(r)
}</pre>
			<p>Using CPS<a id="_idIndexMarker178"/> can even allow you to go beyond the<a id="_idIndexMarker179"/> control structures that JavaScript provides, but that would be beyond the objectives of this book, so I’ll let you research that on your own!</p>
			<h2 id="_idParaDest-65"><a id="_idTextAnchor064"/>Polyfills</h2>
			<p>Being able to assign<a id="_idIndexMarker180"/> functions<a id="_idIndexMarker181"/> dynamically (in the same way that you can assign different values to a variable) also allows you to work more efficiently when defining polyfills.</p>
			<h3>Detecting Ajax</h3>
			<p>Let’s go back a bit in time to when <a id="_idIndexMarker182"/>Ajax started to appear. Given that different browsers implemented Ajax calls in distinct fashions, you would always have to code around these differences. The following code shows how you would go about implementing an Ajax call by testing several different conditions:</p>
			<pre class="source-code">
// ajax.ts
function getAjax() {
  let ajax = null;
  if (window.XMLHttpRequest) {
    // modern browser? use XMLHttpRequest
    ajax = new XMLHttpRequest();
  } else if (window.ActiveXObject) {
    // otherwise, use ActiveX for IE5 and IE6
    ajax = new ActiveXObject("Microsoft.XMLHTTP");
  } else {
    throw new Error("No Ajax support!");
  }
  return ajax;
}</pre>
			<p>This worked but <a id="_idIndexMarker183"/>implied that you would redo the Ajax check for every call, even though the test results wouldn’t ever change. There’s a more efficient way to do this, and it has to do with using functions as first-class objects. We could define <em class="italic">two</em> different functions, test for the condition only once, and then assign the correct function to be used later; study the following code for such an alternative:</p>
			<pre class="source-code">
// continued...
(function initializeGetAjax() {
  let myAjax = null;
  if (window.XMLHttpRequest) {
    // modern browsers? use XMLHttpRequest
    myAjax = function () {
      return new XMLHttpRequest();
    };
  } else if (window.ActiveXObject) {
    // it's ActiveX for IE5 and IE6
    myAjax = function () {
      new ActiveXObject("Microsoft.XMLHTTP");
    };
  } else {
    myAjax = function () {
      throw new Error("No Ajax support!");
    };
  }
  window.getAjax = myAjax;
})();</pre>
			<p>This piece of code shows two important concepts. First, we can dynamically assign a function: when this code runs, <code>window.getAjax</code> (the global <code>getAjax</code> variable) will get one of three possible values according to the current browser. When you later call <code>getAjax()</code> in your code, the correct function will execute without you needing to do any further browser-detection tests.</p>
			<p>The second <a id="_idIndexMarker184"/>interesting idea is that we define the <code>initializeGetAjax()</code> function and immediately run it – this pattern is called the <strong class="bold">immediately invoked function expression</strong> (<strong class="bold">IIFE</strong>), and we<a id="_idIndexMarker185"/> already saw it in the <em class="italic">Solution 7 – using a local flag</em> section in <a href="B19301_02.xhtml#_idTextAnchor037"><em class="italic">Chapter 2</em></a><em class="italic">, Thinking Functionally</em>. The function runs but cleans up after itself because all its variables are local and won’t even exist after the function runs. We’ll learn more about this later in this chapter.</p>
			<p>Nowadays, you would use a module instead of an IIFE, as follows:</p>
			<pre class="source-code">
// ajax.module.ts
let getAjax = null;
if (window.XMLHttpRequest) {
  // modern browsers? use XMLHttpRequest
  getAjax = function () {
    return new XMLHttpRequest();
  };
} else if (window.ActiveXObject) {
  // it's ActiveX for IE5 and IE6
  getAjax = function () {
    new ActiveXObject("Microsoft.XMLHTTP");
  };
} else {
  getAjax = function () {
    throw new Error("No Ajax support!");
  };
}
export { getAjax };</pre>
			<p>The code in the<a id="_idIndexMarker186"/> module is guaranteed to run only once. Wherever you need to do an Ajax call, you would just <code>import { getAjax } from "/path/to/ajax.module"</code> and you could use <code>getAjax()</code> at will.</p>
			<h3>Adding missing functions</h3>
			<p>This idea of <a id="_idIndexMarker187"/>defining a function on the run also allows us to write polyfills that provide otherwise missing functions. For example, let’s say that we had some code such as the following:</p>
			<pre class="source-code">
if (currentName.indexOf("Mr.") !== -1) {
  // it's a man
  ...
}</pre>
			<p>Instead of this, you might very much prefer using the newer <code>includes()</code> method and just write this:</p>
			<pre class="source-code">
if (currentName.includes("Mr.")) {
  // it's a man
  ...
}</pre>
			<p>What happens if your browser doesn’t provide <code>includes()</code>? Once again, we can define the appropriate function on the fly, but only if needed. If <code>includes()</code> is available, you don’t need to do anything, but if it is missing, you need to define a polyfill that will provide the same workings. (You can find links to polyfills on Mozilla’s developer site.) The following code shows an example of such a polyfill:</p>
			<pre class="source-code">
if (!String.prototype.includes) {
  String.prototype.includes = function (search, start) {
    "use strict";
    if (typeof start !== "number") {
      start = 0;
    }
    if (start + search.length &gt; this.length) {
      return false;
    } else {
      return this.indexOf(search, start) !== -1;
    }
  };
}</pre>
			<p>When this code runs, it checks whether the <code>String</code> prototype already has the <code>includes()</code> method. If not, it assigns a function to it that does the same job, so from that point onward, you’ll be able to use <code>includes()</code> without further worries. By the way, there are other ways of defining a polyfill: check the answer to <em class="italic">Question 3.7</em> for an alternative. Yet another<a id="_idIndexMarker188"/> solution is the <code>core-js</code> package (<a href="http://github.com/zloirock/core-js">github.com/zloirock/core-js</a>), which provides polyfills for ECMAScript up to the latest version, and even some<a id="_idIndexMarker189"/> proposals that haven’t made it into the language yet.</p>
			<p class="callout-heading">Good or bad?</p>
			<p class="callout">Directly modifying a standard type’s prototype object is usually frowned upon because, in essence, it’s equivalent to using a global variable, and thus it’s prone to errors; however, in this case (writing a polyfill for a well-established, known function) is quite unlikely to provoke any conflicts.</p>
			<p>Finally, if you happened to think that the Ajax example shown previously was old hat, consider this: if you want to use the more modern <code>fetch()</code> way of calling services, you will also find that not all modern browsers support it (check <a href="http://caniuse.com/#search=fetch">caniuse.com/#search=fetch</a> to verify this), so you’d have to use a polyfill, such as the one at <a href="http://github.com/github/fetch">github.com/github/fetch</a>. Study the code, and you’ll see that it uses the same method described previously to see whether a polyfill is needed and create it.</p>
			<h2 id="_idParaDest-66"><a id="_idTextAnchor065"/>Stubbing</h2>
			<p>Here, we will look at a use case similar to using a polyfill: having a function do different work depending on the environment. The idea is to perform stubbing, an idea that comes from testing and involves replacing a function with another that does a simpler job instead of the actual work.</p>
			<p>Stubbing<a id="_idIndexMarker190"/> is commonly <a id="_idIndexMarker191"/>used with logging functions. You may want the application to perform detailed logging when in development but not to say a peep when in production. A common solution would be to write something along the lines of the following:</p>
			<pre class="source-code">
let myLog = (someText) =&gt; {
  if (DEVELOPMENT) {
    console.log(someText); // or some other way of logging
  } else {
    // do nothing
  }
};</pre>
			<p>This works, but as in the example of Ajax detection, it does more work than it needs to because it checks whether the application is in development every time.</p>
			<p>We could simplify the code (and get a really, really tiny performance gain!) if we stub out the logging function so that it won’t log anything; an easy implementation is as follows:</p>
			<pre class="source-code">
let myLog;
if (DEVELOPMENT) {
  myLog = (someText: string) =&gt; console.log(someText);
} else {
  myLog = (someText: string) =&gt; {};
}</pre>
			<p>We can do even better with the ternary operator:</p>
			<pre class="source-code">
const myLog = DEVELOPMENT
  ? (someText: string) =&gt; console.log(someText)
  : (someText: string) =&gt; {};</pre>
			<p>This is a bit <a id="_idIndexMarker192"/>more cryptic, but<a id="_idIndexMarker193"/> I prefer it because it uses <code>const</code>, which cannot be modified.</p>
			<p>There’s yet another possibility: you could modify the original method like this:</p>
			<pre class="source-code">
if (DEVELOPMENT) {
  // do nothing, let things be
} else {
  console.log = (someText: string) =&gt; {};
}</pre>
			<p>In this case, we are directly changing how <code>console.log()</code> works, so it won’t log anything.</p>
			<p class="callout-heading">Useless arguments – ignore or exclude?</p>
			<p class="callout">Given that JavaScript allows us to call functions with more arguments than parameters, and given that we aren’t doing anything in <code>myLog()</code> when we are not in development, we could also have written <code>() =&gt; {}</code> and it would have worked fine. However, I do prefer keeping the same signature, and that’s why I specified the <code>someText</code> argument, even if it wouldn’t be used. But, if you use ESLint’s <code>no-unused-vars</code> rule to detect unused variables, you may have to tweak its configuration to allow unused arguments.</p>
			<p>You’ll notice that we are using the concept of functions as first-class objects over and over again; look through all the code samples and you’ll see!</p>
			<h2 id="_idParaDest-67"><a id="_idTextAnchor066"/>Immediate invocation (IIFE)</h2>
			<p>There’s yet another common usage of functions, usually seen in popular libraries and frameworks, that lets you <a id="_idIndexMarker194"/>bring some modularity advantages from other<a id="_idIndexMarker195"/> languages into JavaScript (even the older versions!). The usual way of writing this is something like the following:</p>
			<pre class="source-code">
(function () {
  // do something...
})();</pre>
			<p>Alternatively, you may find <code>(function(){ ... }())</code> – note the different placement of the parentheses for the function call. Both styles have their fans; pick whichever suits you, and follow it consistently.</p>
			<p>You can also pass some arguments to the function that will be used as the initial values for its parameters:</p>
			<pre class="source-code">
(function (a, b) {
  // do something, using the
  // received arguments for a and b...
})(some, values);</pre>
			<p>Finally, you could also return something from the function – usually, an object (with several methods) or a function:</p>
			<pre class="source-code">
let x = (function (a, b) {
  // ...return an object or function
})(some, values);</pre>
			<p>Note the parentheses around the function. These help the parser understand that we are writing an expression. If you were to omit the first set of parentheses, JavaScript would think you were writing a function declaration instead of an invocation. The parentheses also serve as a visual note, so readers of your code will immediately recognize the IIFE.</p>
			<p>As previously mentioned, the pattern is called IIFE (pronounced <em class="italic">iffy</em>). The name is easy to understand: you define a function and call it right away so that it gets executed on the spot. Why would you do this, instead of simply writing the code inline? The reason has to do with scopes.</p>
			<p>If you define any variables or functions within IIFE, then because of how JavaScript defines the scope of functions, those definitions will be internal, and no other part of your code will be able to access them. Imagine that you wanted to write some complicated initialization, such as the following:</p>
			<pre class="source-code">
function ready() { ... }
function set() { ... }
function go() { ... }
// initialize things calling ready(),
// set(), and go() appropriately</pre>
			<p>What could go <a id="_idIndexMarker196"/>wrong? The problem hinges on the fact that you<a id="_idIndexMarker197"/> could (by accident) have a function with the same name as any of the three here, and hoisting would imply that the last function would be called:</p>
			<pre class="source-code">
function ready() {
  console.log("ready");
}
<strong class="bold">function set() {</strong>
<strong class="bold">  console.log("set");</strong>
<strong class="bold">}</strong>
function go() {
  console.log("go");
}
ready();
set();
go();
<strong class="bold">function set() {</strong>
<strong class="bold">  console.log("UNEXPECTED...");</strong>
<strong class="bold">}</strong>
// "ready"
// "UNEXPECTED"
// "go"</pre>
			<p>Oops! If you had used IIFE, the <a id="_idIndexMarker198"/>problem wouldn’t have happened. (Using ESLint’s <code>no-func-assign</code> rule would have prevented this, too.) Also, the three inner <a id="_idIndexMarker199"/>functions wouldn’t even be visible to the rest of the code, which helps to keep the global namespace less polluted. The following code shows a widespread pattern for this:</p>
			<pre class="source-code">
<strong class="bold">(function () {</strong>
  function ready() {
    console.log("ready");
  }
  function set() {
    console.log("set");
  }
  function go() {
    console.log("go");
  }
  ready();
  set();
  go();
<strong class="bold">})();</strong>
function set() {
  console.log("UNEXPECTED...");
}
// "ready"
// "set"
// "go"</pre>
			<p>To see an <a id="_idIndexMarker200"/>example involving returned values, we could revisit<a id="_idIndexMarker201"/> the example from <a href="B19301_01.xhtml#_idTextAnchor015"><em class="italic">Chapter 1</em></a>, <em class="italic">Becoming Functional</em>, and write the following, which would create a single counter:</p>
			<pre class="source-code">
const myCounter = <strong class="bold">(</strong>function () {
  let count = 0;
  return function () {
    count++;
    return count;
  };
}<strong class="bold">)();</strong></pre>
			<p>Then, every call to <code>myCounter()</code> would return an incremented count, but there is no chance that any other part of your code will overwrite the inner <code>count</code> variable because it’s only accessible within the returned function.</p>
			<h1 id="_idParaDest-68"><a id="_idTextAnchor067"/>Summary</h1>
			<p>In this chapter, we went over several ways of defining functions in JavaScript, focusing mainly on arrow functions, which have several advantages over standard functions, including being terser. We learned about the concept of currying (which we’ll be revisiting later), considered some aspects of functions as first-class objects, and reviewed several techniques that happen to be fully FP in concept. Rest assured that we’ll be using everything in this chapter as the building blocks for more advanced techniques in the rest of this book; just wait and see!</p>
			<p>In <a href="B19301_04.xhtml#_idTextAnchor069"><em class="italic">Chapter 4</em></a>, <em class="italic">Behaving Properly</em>, we will delve even more deeply into functions and learn about the concept of pure functions, leading us to an even better programming style.</p>
			<h1 id="_idParaDest-69"><a id="_idTextAnchor068"/>Questions</h1>
			<p>3.1 <code>type</code> attribute, used to determine what kind of action you are creating. The following code supposedly produces an action, but can you explain the unexpected results?</p>
			<pre class="source-code">
const simpleAction = (t:string) =&gt; {
  type: t;
};
console.log(simpleAction("INITIALIZE"));
// undefined</pre>
			<p>3.2 <code>useArguments()</code> and <code>useArguments2()</code> from the <em class="italic">Working with arguments</em> section by using arrow functions instead of the way we did, with the <code>function</code> keyword?</p>
			<p>3.3 <code>sum3()</code> and <code>altsum3()</code>, but we didn’t do that for <code>fn1</code>, <code>fn2</code>, and <code>fn3</code>. What are the types of those functions?</p>
			<p>3.4 <code>doAction2()</code> as a one-liner, even though you can’t tell this from the formatting! What do you think: is it correct or isn’t it?</p>
			<pre class="source-code">
const doAction3 = (state = initialState, action) =&gt;
  (dispatchTable[action.type] &amp;&amp;
    dispatchTable[action.type](state, action)) ||
  state;</pre>
			<p>3.5 <code>doAction()</code>, <code>dispatchTable</code>, and <code>doAction2()</code>? Be sure to describe all needed types, too.</p>
			<p>3.6 <code>set()</code> method. After creating the new store object, he wrote the following so that the arguments to <code>store.set()</code> would be logged before being processed. Unfortunately, the code didn’t work as expected. What’s the problem? Can you spot the mistake?</p>
			<pre class="source-code">
window.store = new Store();
const oldSet = window.store.set;
window.store.set = (...data) =&gt; (
  console.log(...data), oldSet(...data)
);</pre>
			<p>3.7 <code>bind()</code> was not available; how could you do a polyfill for it?</p>
			<p>3.8 <code>myNumbers.sort((a:number, b:number) =&gt; a-b)</code> – why/how does this work?</p>
			<p>3.9 <strong class="bold">Negative sort</strong>: Earlier, in the <em class="italic">Injection – sorting it out</em> section, we saw that sorting numbers as strings produces unexpected results. What would the result be if the array included both negative and positive numbers?</p>
			<p>3.10 <strong class="bold">Lexicographic sorting</strong>: When sorting, say, book titles or personal names, special collation rules are applied. For instance, “THE SHINING” would be sorted as “SHINING, THE,” and “Stephen King” would be sorted as “King, Stephen.” How could you (efficiently) implement such sorting?</p>
			<p>3.11 <code>console.log()</code> method doesn’t have the correct data type – for instance, our version just allows a single argument. Can you provide the right data type definition?</p>
		</div>
	</body></html>