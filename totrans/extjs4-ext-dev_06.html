<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Grid Search</h1></div></div></div><p>In this chapter we are going to develop an Ext JS plugin, which will provide a search facility within a grid. This plugin was originally developed by Ing. Jozef Sakáloš and it is really useful and <a id="id234" class="indexterm"/>popular plugin. We will rewrite this plugin for the Ext JS 4x Version.</p><p>In this chapter we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Functional requirements</li><li class="listitem" style="list-style-type: disc">Planning and coding the grid search</li></ul></div><div><div><div><div><h1 class="title"><a id="ch06lvl1sec40"/>Functional requirements</h1></div></div></div><p>We want to develop a<a id="id235" class="indexterm"/> plugin, which will help users to search within a grid panel through a text field. The plugin will also offer users the option to select or deselect the columns of the grid on which they want to apply the searching. There will be a clear button to clear the search text. There will be a configuration option where users can set the number of characters they want in order to trigger the search by typing within the search textbox.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec41"/>Planning and coding the grid search</h1></div></div></div><p>To develop the <a id="id236" class="indexterm"/>plugin, we will create a menu where the user can select and <a id="id237" class="indexterm"/>deselect the columns of the grid, a text field where the user can write their search query, and a clear button that will help to clear the search query. At first we will develop the required UI fields and then we will add the corresponding functionality to those fields. Now let us start coding:</p><div><pre class="programlisting">Ext.define("Examples.plugin.GridSearch", {

  extend : 'Ext.util.Observable',
  alias : 'plugin.gridsearch',

  config : {

    iconCls : 'icon-zoom',
    checkIndexes : "all",
    mode : 'local',
    minChars : 1,
    width : 100,
    searchText : 'Search',
    selectAllText : 'Select all',
    position: 'bottom' ,
    paramNames: {
      fields:'fields'
      ,query:'query'
    }

  },

  init : function(cmp) {

    this.grid = cmp.view.up('gridpanel');

    if (this.grid.rendered)
      this.onRender();
    else {
      this.grid.on('render', this.onRender, this);
    }

  },
…</pre></div><p>You can see <a id="id238" class="indexterm"/>that we have defined several configuration options and <a id="id239" class="indexterm"/>also the<a id="id240" class="indexterm"/> required <code class="literal">init</code> function <a id="id241" class="indexterm"/>for the plugin. Now <a id="id242" class="indexterm"/>let us define the <code class="literal">onRender</code> function:</p><div><pre class="programlisting">onRender : function() {

  var tb = this.getToolbar();
  this.menu = new Ext.menu.Menu();

  this.field = Ext.create("Ext.form.field.Trigger", {
    width : this.width,
    selectOnFocus : undefined === this.selectOnFocus ? 
             true : this.selectOnFocus,
       triggerCls : 'x-form-clear-trigger', 
        minLength : this.minLength
  });

  tb.add('-&gt;', {
    text : this.searchText,
    menu : this.menu,
    iconCls : this.iconCls
  }, this.field);

}</pre></div><p>In this function, first we are trying to get the toolbar by calling the <code class="literal">getToolbar</code> function as we need to render <a id="id243" class="indexterm"/>our plugin UI on the toolbar. Then we are creating the menu field, which will <a id="id244" class="indexterm"/>hold the column selections, and then the search field. After this, we will add the menu <a id="id245" class="indexterm"/>field and the search field to that toolbar. Now<a id="id246" class="indexterm"/> let us define the <code class="literal">getToolbar</code> function:</p><div><pre class="programlisting">getToolbar: function(){

  var me = this,
  dockedItems = this.grid.getDockedItems(),
  toolbar = null,
  hasToolbar = false;

  if(dockedItems.length&gt;0){
    Ext.each(dockedItems, function(item){
      if(item.xtype ==='toolbar' &amp;&amp; item.dock == me.position){
        hasToolbar = true;
        toolbar = item;
        return false;
      }
    });
  }

  if(!hasToolbar){
    toolbar = this.grid.addDocked({
      xtype: 'toolbar',
      dock: this.position
    })[0];
  }

  return toolbar;

}</pre></div><p>In this function we are looking for a toolbar item, which is docked at the location defined in the position configuration option. We will render our plugin UI on this returned toolbar.</p><p>Now let us use this <a id="id247" class="indexterm"/>plugin within a grid and the output of the plugin should look like the following screenshot:</p><div><img src="img/3725OS_06_01.jpg" alt="Planning and coding the grid search"/></div><p>So, now we have our plugin looking exactly the same as the requirement. Now let us start adding <a id="id248" class="indexterm"/>functionality. First let us modify the <code class="literal">onRender</code> function of <a id="id249" class="indexterm"/>our <a id="id250" class="indexterm"/>plugin code:</p><div><pre class="programlisting">this.field = Ext.create("Ext.form.field.Trigger", {
  width : this.width,
  selectOnFocus : undefined === this.selectOnFocus ?
           true : this.selectOnFocus,
     triggerCls : 'x-form-clear-trigger',
 onTriggerClick : Ext.bind(this.onTriggerClear, this),
      minLength : this.minLength
});</pre></div><p>You can see that we have provided the <a id="id251" class="indexterm"/>
<code class="literal">onTriggerClear</code> handler for the <a id="id252" class="indexterm"/>
<code class="literal">onTriggerClick</code> event to clear the search. We need to add and handle some keyboard events: pressing the <em>Enter</em> key will trigger searching and pressing the <em>Esc</em> key will trigger clearing the search. So, we need to add the following code after defining the trigger field:</p><div><pre class="programlisting">this.field.on('render', function() {

  if (this.minChars) {
    this.field.el.on({
      scope : this,
      buffer : 300,
      keyup : this.onKeyUp
    });
  }

  var map = new Ext.KeyMap(this.field.el, [{
    key : Ext.EventObject.ENTER,
    scope : this,
    fn : this.onTriggerSearch
  }, {
    key : Ext.EventObject.ESC,
    scope : this,
    fn : this.onTriggerClear
  }]);
  map.stopEvent = true;
}, this, {
  single : true
});</pre></div><p>Now, we need to <a id="id253" class="indexterm"/>prepare the menu to load the column names and <a id="id254" class="indexterm"/>we will call the <code class="literal">initMenu</code> function<a id="id255" class="indexterm"/> to do that. And<a id="id256" class="indexterm"/> that's all we needed to do within<a id="id257" class="indexterm"/> the <code class="literal">onRender</code> function.</p><p>Now let us<a id="id258" class="indexterm"/> define the <code class="literal">onKeyUp</code> handler:</p><div><pre class="programlisting">onKeyUp : function(e) {

  if (e.isNavKeyPress()) {
    return;
  }

  var length = this.field.getValue().toString().length;
  if (0 === length || this.minChars &lt;= length) {
    this.onTriggerSearch();
  }

}</pre></div><p>Let us go ahead with<a id="id259" class="indexterm"/> defining the <code class="literal">initMenu</code> function:</p><div><pre class="programlisting">initMenu : function() {

  var menu = this.menu;
  menu.removeAll();

  menu.add(new Ext.menu.CheckItem({
    text : this.selectAllText,
    checked : !(this.checkIndexes instanceof Array),
    hideOnClick : false,
    handler : function(item) {
      var checked = item.checked;
      menu.items.each(function(i) {
        if (item !== i &amp;&amp; i.setChecked &amp;&amp; !i.disabled) {
          i.setChecked(checked);
        }
      });
    }
  }), '-');

  var cm = this.grid.headerCt.items.items;

  var group = undefined;
  Ext.each(cm, function(item) {
    var config = item.initialConfig;
    var disable = false;

    if (config.header &amp;&amp; config.dataIndex) {
      Ext.each(this.disableIndexes, function(item) {
        disable = disable ? disable : 
          item === config.dataIndex;
      });
      if (!disable) {
        menu.add(new Ext.menu.CheckItem({
          text : config.header,
          hideOnClick : false,
          group : group,
          checked : 'all' === this.checkIndexes,
          dataIndex : config.dataIndex
        }));
      }
    }
  }, this);

  if (this.checkIndexes instanceof Array) {
    Ext.each(this.checkIndexes, function(di) {
      var item = menu.items.find(function(itm) {
        return itm.dataIndex === di;
      });
      if (item) {
        item.setChecked(true, true);
      }
    }, this);
  }

}</pre></div><p>You can see <a id="id260" class="indexterm"/>how we are preparing the menu for selecting and deselecting <a id="id261" class="indexterm"/>the columns in the preceding <code class="literal">initMenu</code> function. Now let us define the <a id="id262" class="indexterm"/>
<code class="literal">onTriggerClear</code> function, which<a id="id263" class="indexterm"/> is responsible for clearing the search query:</p><div><pre class="programlisting">onTriggerClear : function() {

  if (this.field.getValue()) {
    this.field.reset();
    this.field.focus();
    this.onTriggerSearch();
  }

}</pre></div><p>Next we <a id="id264" class="indexterm"/>define the <code class="literal">onTriggerSearch</code> function:</p><div><pre class="programlisting">onTriggerSearch : function() {

  if (!this.field.isValid()) {
    return;
  }
  var val = this.field.getValue(),
    store = this.grid.store,
    proxy = store.getProxy();
…</pre></div><p>We need to check <a id="id265" class="indexterm"/>against the value set for the <code class="literal">mode</code> configuration option and need to provide separate logic if the value is set to <code class="literal">'local'</code> or if the proxy of the store is a server proxy. Now we need to<a id="id266" class="indexterm"/> add the following code within the <code class="literal">onTriggerSearch</code> function when the mode is set with <code class="literal">'local'</code>:</p><div><pre class="programlisting">if ('local' === this.mode) {
  store.clearFilter();
  if (val) {
    store.filterBy(function(r) {
      var retval = false;
      this.menu.items.each(function(item) {
        if (!item.dataIndex || !item.checked || retval) {
          return;
        }

        var rv = r.get(item.dataIndex), rv = rv instanceof Date ?
        Ext.Date.format(rv, this.getDateFormat(item)) : rv;
        var re = new RegExp(Ext.String.escape(val), 'gi');
        retval = re.test(rv);
      }, this);
      if (retval) {
        return true;
      }
      return retval;
    }, this);
  }
}</pre></div><p>And if the value <a id="id267" class="indexterm"/>is not set to <code class="literal">local</code>, we need to check whether the proxy is a <a id="id268" class="indexterm"/>server proxy or not. And<a id="id269" class="indexterm"/> here is the code that we need to add within the <a id="id270" class="indexterm"/>
<code class="literal">onTriggerSearch</code> function after the <code class="literal">if ('local' === this.mode)</code> block:</p><div><pre class="programlisting">else if(proxy instanceof Ext.data.proxy.Server) {

  if(store.lastOptions &amp;&amp; store.lastOptions.params) {
    store.lastOptions.params[store.paramNames.start] = 0;
  } 

  var fields = [];
  this.menu.items.each(function(item) {
    if(item.checked &amp;&amp; item.dataIndex) {
      fields.push(item.dataIndex);
    }
  });

  delete(proxy.extraParams[this.paramNames.fields]);
  delete(proxy.extraParams[this.paramNames.query]);
  if (store.lastOptions &amp;&amp; store.lastOptions.params) {
    delete(proxy.lastOptions.params[this.paramNames.fields]);
    delete(proxy.lastOptions.params[this.paramNames.query]);
  }
  if(fields.length) {
    proxy.extraParams[this.paramNames.fields] = Ext.encode(fields);
    proxy.extraParams[this.paramNames.query] = val;
  }

  store.load();
}</pre></div><p>Now we define <a id="id271" class="indexterm"/>the <code class="literal">getDateFormat</code> function:</p><div><pre class="programlisting">getDateFormat : function(menuItem) {

  var columnNames = Ext.Array.pluck(this.grid.columns, 'dataIndex'),
  columnIndex = Ext.Array.indexOf(columnNames, menuItem.dataIndex),
  format = this.grid.columns[columnIndex].format;

  return this.dateFormat || format;
}</pre></div><a id="id272" class="indexterm"/><p>Following is<a id="id273" class="indexterm"/> the screenshot of our<a id="id274" class="indexterm"/> working plugin:</p><div><img src="img/3725OS_06_02.jpg" alt="Planning and coding the grid search"/></div><p>You can see that our plugin filters data according to the search query.</p></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec42"/>Summary</h1></div></div></div><p>In this chapter we've developed an Ext JS plugin to provide searching facility within a grid. Now we have a clear idea about how powerful the Ext JS plugins are. We can easily use this plugin within a grid and can provide this excellent searching feature whenever we need.</p><p>In the next chapter we will go through another useful plugin targeted for text components that show a clear button over the text field, and we will see how clicking on the button will clear the texts from the text field.</p></div></body></html>