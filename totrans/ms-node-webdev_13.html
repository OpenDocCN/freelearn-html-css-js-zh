<html><head></head><body>
<div class="calibre1" id="_idContainer174">
<h1 class="chapternumber"><span class="kobospan" id="kobo.1.1">12</span></h1>
<h1 class="chaptertitle" id="_idParaDest-204"><span class="kobospan" id="kobo.2.1">Using Databases</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.3.1">In this chapter, I will demonstrate how Node.js applications can use a relational database to store and query data. </span><span class="kobospan" id="kobo.3.2">This chapter explains how to work directly with a database by executing SQL queries, and how to take a more hands-off approach with an </span><strong class="screentext"><span class="kobospan" id="kobo.4.1">Object Relational Mapping</span></strong><span class="kobospan" id="kobo.5.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.6.1">ORM</span></strong><span class="kobospan" id="kobo.7.1">) package. </span><em class="italic"><span class="kobospan" id="kobo.8.1">Table 12.1</span></em><span class="kobospan" id="kobo.9.1"> puts this chapter into context.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.10.1">Table 12.1: Putting databases into context</span></p>
<table class="table-container" id="table001-9">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><strong class="keyword"><span class="kobospan2" id="kobo.11.1">Question</span></strong></p>
</td>
<td class="table-cell">
<p class="normal"><strong class="keyword"><span class="kobospan2" id="kobo.12.1">Answer</span></strong></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.13.1">What are they?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.14.1">Databases are the most common means of persistently storing data.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.15.1">Why are they useful?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.16.1">Databases can store large volumes of data and enforce a data structure that makes it possible to perform efficient queries. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.17.1">How are they used?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.18.1">Databases are managed by database engines, which can be installed as npm packages, run on dedicated servers, or consumed as cloud services. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.19.1">Are there any pitfalls or limitations?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.20.1">Databases can be complex and require additional knowledge, such as being able to formulate queries in SQL.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.21.1">Are there any alternatives?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.22.1">Databases are not the only way to store data, but they are the most common, and, generally, the most effective because they are robust and scale up easily.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.23.1">Table 12.2</span></em><span class="kobospan" id="kobo.24.1"> summarizes what we will do in the chapter.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.25.1">Table 12.2: Chapter summary</span></p>
<table class="table-container" id="table002-9">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.26.1">Problem</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.27.1">Solution</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.28.1">Listing</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.29.1">Store data persistently.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.30.1">Use a database.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.31.1">7, 8, 12, 13</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.32.1">Simplify the process of changing how data is stored.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.33.1">Use a repository layer.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.34.1">9–11</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.35.1">Display stored data.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.36.1">Include query results when rendering templates.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.37.1">14, 15</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.38.1">Prevent user-submitted values from being interpreted as SQL. </span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.39.1">Use query parameters.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.40.1">16, 17</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.41.1">Ensure that data is updated consistently.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.42.1">Use a transaction.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.43.1">18–21</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.44.1">Use a database without needing to write SQL queries.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.45.1">Use an ORM package and describe the data used by the application using JavaScript code.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.46.1">22–25, 27, 28</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.47.1">Perform operations that are too complex to describe using model classes.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.48.1">Use the ORM package facility for executing SQL.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.49.1">26</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.50.1">Query for and update data using an ORM.</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.51.1">Use the methods defined by the model classes, with constraints specified using JavaScript objects.</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.52.1">29–32</span></em></p>
</td>
</tr>
</tbody>
</table>
<h1 class="heading" id="_idParaDest-205"><span class="kobospan" id="kobo.53.1">Preparing for this chapter</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.54.1">This chapter uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.55.1">part2app</span></code><span class="kobospan" id="kobo.56.1"> project from </span><em class="italic"><span class="kobospan" id="kobo.57.1">Chapter 11</span></em><span class="kobospan" id="kobo.58.1">. </span><span class="kobospan" id="kobo.58.2">To prepare for this chapter, </span><em class="italic"><span class="kobospan" id="kobo.59.1">Listing 12.1</span></em><span class="kobospan" id="kobo.60.1"> removes the client-side validation code, which won’t be used in this chapter.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.61.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.62.1">You can download the example project for this chapter – and for all the other chapters in this book – from </span><a href="https://github.com/PacktPublishing/Mastering-Node.js-Web-Development" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.63.1">https://github.com/PacktPublishing/Mastering-Node.js-Web-Development</span></span></a><span class="kobospan" id="kobo.64.1">. </span><span class="kobospan" id="kobo.64.2">See </span><em class="italic"><span class="kobospan" id="kobo.65.1">Chapter 1</span></em><span class="kobospan" id="kobo.66.1"> for how to get help if you have problems running the examples.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.67.1">Listing 12.1: The contents of the client.js file in the src/client folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.68.1">document.addEventListener('DOMContentLoaded', () =&gt; {
    // do nothing
});
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.69.1">Listing 12.2</span></em><span class="kobospan" id="kobo.70.1"> updates the routing configuration for the example application.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.71.1">Listing 12.2: The contents of the server.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.72.1">import { createServer } from "http";
import express, {Express } from "express";
import httpProxy from "http-proxy";
import helmet from "helmet";
import { engine } from "express-handlebars";
import { registerFormMiddleware, registerFormRoutes } from "./forms";
const port = 5000;
const expressApp: Express = express();
const proxy = httpProxy.createProxyServer({
    target: "http://localhost:5100", ws: true
});
expressApp.set("views", "templates/server");
expressApp.engine("handlebars", engine());
expressApp.set("view engine", "handlebars");
expressApp.use(helmet());
expressApp.use(express.json());
registerFormMiddleware(expressApp);
registerFormRoutes(expressApp);
expressApp.use("^/$", (req, resp) =&gt; resp.redirect("/form"));
expressApp.use(express.static("static"));
expressApp.use(express.static("node_modules/bootstrap/dist"));
expressApp.use((req, resp) =&gt; proxy.web(req, resp));
const server = createServer(expressApp);
server.on('upgrade', (req, socket, head) =&gt; proxy.ws(req, socket, head));
server.listen(port,
    () =&gt; console.log(`HTTP Server listening on port ${port}`));
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.73.1">The new routing configuration removes entries that are no longer required. </span><span class="kobospan" id="kobo.73.2">All the examples in this chapter use templates, and the new route matches requests for the default path and responds with a redirection to the </span><code class="inlinecode"><span class="kobospan" id="kobo.74.1">/form</span></code><span class="kobospan" id="kobo.75.1"> URL. </span><span class="kobospan" id="kobo.75.2">The new route uses Express support for matching URL patterns, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.76.1">...
</span><span class="kobospan" id="kobo.76.2">expressApp.use(</span><strong class="screentext"><span class="kobospan" id="kobo.77.1">"^/$"</span></strong><span class="kobospan" id="kobo.78.1">, (req, resp) =&gt; resp.redirect("/form"));
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.79.1">The pattern is required to match requests for </span><code class="inlinecode"><span class="kobospan" id="kobo.80.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.81.1"> and not requests that are handled by other routes, such as </span><code class="inlinecode"><span class="kobospan" id="kobo.82.1">http://localhost:5000/css/bootstrap.min.css</span></code><span class="kobospan" id="kobo.83.1"> (which is handled by the static content middleware) or </span><code class="inlinecode"><span class="kobospan" id="kobo.84.1">http://localhost:5000/bundle.js</span></code><span class="kobospan" id="kobo.85.1"> (which is forwarded to the webpack development HTTP server).</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.86.1">Listing 12.3</span></em><span class="kobospan" id="kobo.87.1"> updates the </span><code class="inlinecode"><span class="kobospan" id="kobo.88.1">age</span></code><span class="kobospan" id="kobo.89.1"> template to add a field that allows the user to specify a number of years, just to allow more variations in the results data. </span><span class="kobospan" id="kobo.89.2">The structure of the HTML output has been changed to introduce a two-column layout and use a partial template named </span><code class="inlinecode"><span class="kobospan" id="kobo.90.1">history</span></code><span class="kobospan" id="kobo.91.1">. </span><span class="kobospan" id="kobo.91.2">This listing also removes the validation error elements, which is something that should not be done in a real project, but they are not needed in this chapter.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.92.1">Listing 12.3: The contents of the age.handlebars file in the templates/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span><span class="kobospan" id="kobo.93.1">&lt;</span></span><span class="kobospan" id="kobo.94.1">div class="container fluid"&gt;
    &lt;div class="row"&gt;
        &lt;div class="col-7"&gt;
            {{#if name}}
                &lt;div class="m-2"&gt;
                    &lt;h4&gt;Hello {{ name }}. </span><span class="kobospan" id="kobo.94.2">You will be {{ nextage }}
                        in {{ years }} years.&lt;/h4&gt;
                &lt;/div&gt;
            {{/if}}
            &lt;div&gt;
                &lt;form id="age_form" action="/form" method="post"&gt;
                    &lt;div class="m-2"&gt;
                        &lt;label class="form-label"&gt;Name&lt;/label&gt;
                        &lt;input name="name" class="form-control"
                            value="{{ name }}"/&gt;
                    &lt;/div&gt;
                    &lt;div class="m-2"&gt;
                        &lt;label class="form-label"&gt;Current Age&lt;/label&gt;
                        &lt;input name="age" class="form-control"
                            value="{{ age }}" /&gt;
                    &lt;/div&gt;                  
                    &lt;div class="m-2"&gt;
                        &lt;label class="form-label"&gt;Number of Years&lt;/label&gt;
                        &lt;input name="years" class="form-control"
                            value="{{ years }}" /&gt;         
                    &lt;/div&gt;                          
                    &lt;div class="m-2"&gt;
                        &lt;button class="btn btn-primary"&gt;Submit&lt;/button&gt;                               
                    &lt;/div&gt;
                &lt;/form&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="col-5"&gt;
            {{&gt; history }}
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.95.1">To create the partial view, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.96.1">history.handlebars</span></code><span class="kobospan" id="kobo.97.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.98.1">templates/server/partials</span></code><span class="kobospan" id="kobo.99.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.100.1">Listing 12.4</span></em><span class="kobospan" id="kobo.101.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.102.1">Listing 12.4: The contents of the history.handlebars folder in the templates/server/partials folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.103.1">&lt;h4&gt;Recent Queries&lt;/h4&gt;
&lt;table class="table table-sm table-striped my-2"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Age&lt;/th&gt;&lt;th&gt;Years&lt;/th&gt;&lt;th&gt;Result&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        {{#unless history }}
            &lt;tr&gt;&lt;td colspan="4"&gt;No data available&lt;/td&gt;&lt;/tr&gt;
        {{/unless }}
    &lt;/tbody&gt;
&lt;/table&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.104.1">The partial template displays data provided through a </span><code class="inlinecode"><span class="kobospan" id="kobo.105.1">history</span></code><span class="kobospan" id="kobo.106.1"> context property and displays a default message when no data is available. </span><em class="italic"><span class="kobospan" id="kobo.107.1">Listing 12.5</span></em><span class="kobospan" id="kobo.108.1"> revises the code that handles the </span><code class="inlinecode"><span class="kobospan" id="kobo.109.1">/form</span></code><span class="kobospan" id="kobo.110.1"> URL to remove the validation checks introduced in the previous chapter.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.111.1">Listing 12.5: The contents of the forms.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.112.1">import express, { Express } from "express";
export const registerFormMiddleware = (app: Express) =&gt; {
    app.use(express.urlencoded({extended: true}))
}
export const registerFormRoutes = (app: Express) =&gt; {
    app.get("/form", (req, resp) =&gt; {
        resp.render("age");
    });
    app.post("/form", (req, resp) =&gt; {
        const nextage = Number.parseInt(req.body.age)
            + Number.parseInt(req.body.years);
        const context = {
            ...req.body, nextage
        };
        resp.render("age", context);  
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.113.1">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.114.1">Listing 12.6</span></em><span class="kobospan" id="kobo.115.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.116.1">part2app</span></code><span class="kobospan" id="kobo.117.1"> folder to start the development tools.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.118.1">Listing 12.6: Starting the development tools</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.119.1">npm start
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.120.1">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.121.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.122.1">, fill out the form, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.123.1">Submit</span></strong><span class="kobospan" id="kobo.124.1"> button, as shown in </span><em class="italic"><span class="kobospan" id="kobo.125.1">Figure 12.1</span></em><span class="kobospan" id="kobo.126.1">. </span><span class="kobospan" id="kobo.126.2">No data will be displayed in the </span><strong class="screentext"><span class="kobospan" id="kobo.127.1">Recent Queries</span></strong><span class="kobospan" id="kobo.128.1"> section.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.129.1"><img alt="" src="../Images/B21959_12_01.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.130.1">Figure 12.1: Running the example application</span></p>
<h1 class="heading" id="_idParaDest-206"><span class="kobospan" id="kobo.131.1">Using a database</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.132.1">Databases </span><a id="_idIndexMarker566" class="calibre3"/><span class="kobospan" id="kobo.133.1">allow web applications to read and write data, which can be used to generate responses for HTTP requests. </span><span class="kobospan" id="kobo.133.2">There are many types of database, with choices about how data is stored and queried, how the database software is deployed, and how changes to data are handled. </span></p>
<p class="normal"><span class="kobospan" id="kobo.134.1">The database </span><a id="_idIndexMarker567" class="calibre3"/><span class="kobospan" id="kobo.135.1">market is competitive and innovative, and there are excellent commercial and open-source products, but my advice is that the best database is one that you already understand and have worked with before. </span><span class="kobospan" id="kobo.135.2">Most projects can use most databases, and the benefit that a particular database technology confers will be undermined by the time taken to learn and master that technology.</span></p>
<p class="normal"><span class="kobospan" id="kobo.136.1">If you don’t have a database, it is easy to get lost in the endless options, and my advice is to start with something as simple as possible. </span><span class="kobospan" id="kobo.136.2">For small applications, I recommend SQLite, which is the database I will use in this chapter. </span><span class="kobospan" id="kobo.136.3">For larger applications, especially where multiple instances of Node.js are used to handle HTTP requests, I </span><a id="_idIndexMarker568" class="calibre3"/><span class="kobospan" id="kobo.137.1">recommend one of the excellent open-source </span><a id="_idIndexMarker569" class="calibre3"/><span class="kobospan" id="kobo.138.1">relational databases, such as MySQL (</span><a href="https://www.mysql.com" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.139.1">https://www.mysql.com</span></span></a><span class="kobospan" id="kobo.140.1">) or PostgreSQL (</span><a href="https://www.postgresql.org" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.141.1">https://www.postgresql.org</span></span></a><span class="kobospan" id="kobo.142.1">). </span><span class="kobospan" id="kobo.142.2">You can see an example of one </span><a id="_idIndexMarker570" class="calibre3"/><span class="kobospan" id="kobo.143.1">such database in </span><em class="italic"><span class="kobospan" id="kobo.144.1">Part 3</span></em><span class="kobospan" id="kobo.145.1"> of this book. </span></p>
<p class="normal"><span class="kobospan" id="kobo.146.1">If you don’t like using the </span><strong class="screentext"><span class="kobospan" id="kobo.147.1">Structured Query Language</span></strong><span class="kobospan" id="kobo.148.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.149.1">SQL</span></strong><span class="kobospan" id="kobo.150.1">), then there are</span><a id="_idIndexMarker571" class="calibre3"/><span class="kobospan" id="kobo.151.1"> good NoSQL databases available and a good place to start is MongoDB (</span><a href="https://www.mongodb.com" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.152.1">https://www.mongodb.com</span></span></a><span class="kobospan" id="kobo.153.1">).</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.154.1">Database Complaints</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.155.1">I receive complaints whenever I write about choosing database products. </span><span class="kobospan" id="kobo.155.2">Many developers have strong views about the superiority of a particular database or style of database and are upset when I don’t recommend their preferred product.</span></p>
<p class="normal"><span class="kobospan" id="kobo.156.1">It isn’t that I think any particular database engine is bad. </span><span class="kobospan" id="kobo.156.2">In fact, the database market has never been so good, to the extent that just about any database product can be used in just about any project with little impact on productivity or scale.</span></p>
<p class="normal"><span class="kobospan" id="kobo.157.1">Database engines are like automobiles: modern cars are so good that most people can get along with just about any car. </span><span class="kobospan" id="kobo.157.2">If you already have a car, then the benefit of changing it is likely to be small when compared to the cost. </span><span class="kobospan" id="kobo.157.3">If you don’t have a car, then a good place to start is with the car that most of your neighbors have and the local mechanics often work on. </span><span class="kobospan" id="kobo.157.4">Some people get really into cars and have strong views about a particular make or model, and that’s fine, but it can be taken to excess, and most people don’t drive in a way where marginal improvements become significant.</span></p>
<p class="normal"><span class="kobospan" id="kobo.158.1">So, I absolutely understand why some developers become deeply invested in a particular database engine – and I respect that level of commitment and understanding – but most projects don’t have the kinds of data storage or processing requirements that make the differences between database products important.</span></p>
</div>
<h2 class="heading1" id="_idParaDest-207"><span class="kobospan" id="kobo.159.1">Installing the database package</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.160.1">The </span><a id="_idIndexMarker572" class="calibre3"/><span class="kobospan" id="kobo.161.1">database engine used in this chapter is SQLite. </span><span class="kobospan" id="kobo.161.2">It operates within the Node.js process and is a good choice for applications where data doesn’t need to be shared between multiple instances of Node.js, which SQLite doesn’t support because it doesn’t run as a separate server. </span><span class="kobospan" id="kobo.161.3">SQLite </span><a id="_idIndexMarker573" class="calibre3"/><span class="kobospan" id="kobo.162.1">is widely used and is, at least according to </span><a href="https://sqlite.org" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.163.1">https://sqlite.org</span></span></a><span class="kobospan" id="kobo.164.1">, the most popular database engine in the world.</span></p>
<p class="normal"><span class="kobospan" id="kobo.165.1">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.166.1">Listing 12.7</span></em><span class="kobospan" id="kobo.167.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.168.1">part2app</span></code><span class="kobospan" id="kobo.169.1"> folder to add SQLite to the project. </span><span class="kobospan" id="kobo.169.2">No additional TypeScript type packages are required. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.170.1">Listing 12.7: Adding the database package to the project</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.171.1">npm install sqlite3@5.1.6
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.172.1">This package includes the database engine, a Node.js API, and descriptions of those APIs for the TypeScript compiler. </span><span class="kobospan" id="kobo.172.2">To describe the database that will be used in this section, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.173.1">age.sql</span></code><span class="kobospan" id="kobo.174.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.175.1">part2app</span></code><span class="kobospan" id="kobo.176.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.177.1">Listing 12.8</span></em><span class="kobospan" id="kobo.178.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.179.1">Listing 12.8: The contents of the age.sql file in the part2app folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.180.1">DROP TABLE IF EXISTS Results;
DROP TABLE IF EXISTS Calculations;
DROP TABLE IF EXISTS People;
CREATE TABLE IF NOT EXISTS `Calculations` (
    id INTEGER PRIMARY KEY AUTOINCREMENT, `age` INTEGER,
    years INTEGER, `nextage` INTEGER);
CREATE TABLE IF NOT EXISTS `People` (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(255));
CREATE TABLE IF NOT EXISTS `Results` (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    calculationId INTEGER REFERENCES `Calculations` (`id`)
        ON DELETE CASCADE ON UPDATE CASCADE,
    personId INTEGER REFERENCES `People` (`id`)
        ON DELETE CASCADE ON UPDATE CASCADE);
INSERT INTO Calculations (id, age, years, nextage) VALUES
    (1, 35, 5, 40), (2, 35, 10, 45);
INSERT INTO People (id, name) VALUES
    (1, 'Alice'), (2, "Bob");
   
INSERT INTO Results (calculationId, personId) VALUES
    (1, 1), (2, 2), (2, 1);
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.181.1">The </span><a id="_idIndexMarker574" class="calibre3"/><span class="kobospan" id="kobo.182.1">SQL statements in </span><em class="italic"><span class="kobospan" id="kobo.183.1">Listing 12.8</span></em><span class="kobospan" id="kobo.184.1"> create three tables, which will record the age calculations performed by the application. </span><span class="kobospan" id="kobo.184.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.185.1">Calculations</span></code><span class="kobospan" id="kobo.186.1"> table keeps track of the age calculations that have been performed and has columns for the age and year values provided by the user and the future age that has been calculated. </span><span class="kobospan" id="kobo.186.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.187.1">People</span></code><span class="kobospan" id="kobo.188.1"> table keeps track of the names that users provide. </span><span class="kobospan" id="kobo.188.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.189.1">Results</span></code><span class="kobospan" id="kobo.190.1"> table keeps track of results by referencing a name and a calculation.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.191.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.192.1">The data the application works with doesn’t justify three tables, but simple data combined with multiple tables allows some common problems to be more easily demonstrated.</span></p>
</div>
<h2 class="heading1" id="_idParaDest-208"><span class="kobospan" id="kobo.193.1">Creating a repository layer</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.194.1">A repository is a</span><a id="_idIndexMarker575" class="calibre3"/><span class="kobospan" id="kobo.195.1"> layer of code that isolates the database from the rest of the application, which</span><a id="_idIndexMarker576" class="calibre3"/><span class="kobospan" id="kobo.196.1"> makes it easier to change the way that data is read and written without needing to change the code that uses that data. </span><span class="kobospan" id="kobo.196.2">Not everyone finds a repository layer useful, but my advice is to use one unless you are completely certain that your application’s use of data or database products won’t change. </span><span class="kobospan" id="kobo.196.3">Create the </span><code class="inlinecode"><span class="kobospan" id="kobo.197.1">src/server/data</span></code><span class="kobospan" id="kobo.198.1"> folder and add to it a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.199.1">repository.ts</span></code><span class="kobospan" id="kobo.200.1"> with the contents shown in </span><em class="italic"><span class="kobospan" id="kobo.201.1">Listing 12.9</span></em><span class="kobospan" id="kobo.202.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.203.1">Listing 12.9: The contents of the repository.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.204.1">export interface Result {
    id: number,
    name: string,
    age: number,
    years: number,
    nextage: number
}
export interface Repository {
    saveResult(r: Result):  Promise&lt;number&gt;;
    getAllResults(limit: number) : Promise&lt;Result[]&gt;;
    getResultsByName(name: string, limit: number): Promise&lt;Result[]&gt;;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.205.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.206.1">Repository</span></code><span class="kobospan" id="kobo.207.1"> interface defines methods for storing new </span><code class="inlinecode"><span class="kobospan" id="kobo.208.1">Result</span></code><span class="kobospan" id="kobo.209.1"> objects, querying for all results, and results that have a specific name. </span><span class="kobospan" id="kobo.209.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.210.1">Result</span></code><span class="kobospan" id="kobo.211.1"> type defines properties for all of the data columns in the database tables in a simple, flat structure.</span></p>
<p class="normal"><span class="kobospan" id="kobo.212.1">Projects can use data types that match the structure of the database, but that often means that the data that arrives from the user has to be assembled into a complex structure before being extracted and used to create an SQL statement, while the reverse process assembles data from the database into the same structure, only for it to be extracted for use in templates. </span><span class="kobospan" id="kobo.212.2">It isn’t always possible, but using simple, flat data structures often simplifies development.</span></p>
<h2 class="heading1" id="_idParaDest-209"><span class="kobospan" id="kobo.213.1">Implementing the repository</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.214.1">The</span><a id="_idIndexMarker577" class="calibre3"/><span class="kobospan" id="kobo.215.1"> next step is to implement the </span><code class="inlinecode"><span class="kobospan" id="kobo.216.1">Repository</span></code><span class="kobospan" id="kobo.217.1"> interface with a class that uses the SQLite database engine. </span><span class="kobospan" id="kobo.217.2">I am going to implement the repository in stages, which will make it easier to understand the relationship between the data in the database and the JavaScript objects in the application. </span><span class="kobospan" id="kobo.217.3">To start the implementation, create a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.218.1">sql_repository.ts</span></code><span class="kobospan" id="kobo.219.1"> file in the </span><code class="inlinecode"><span class="kobospan" id="kobo.220.1">src/server/data</span></code><span class="kobospan" id="kobo.221.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.222.1">Listing 12.10</span></em><span class="kobospan" id="kobo.223.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.224.1">Listing 12.10: The contents of the sql_repository.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.225.1">import { readFileSync } from "fs";
import { Database } from "sqlite3";
import { Repository, Result } from "./repository";
export class SqlRepository implements Repository {
    db: Database;
    constructor() {
        this.db = new Database("age.db");
        this.db.exec(readFileSync("age.sql").toString(), err =&gt; {
            if (err != undefined) throw err;
        });
    }
    saveResult(r: Result): Promise&lt;number&gt; {
        throw new Error("Method not implemented.");
    }
    getAllResults($limit: number): Promise&lt;Result[]&gt; {
        throw new Error("Method not implemented.");
    }
    
    getResultsByName($name: string, $limit: number): Promise&lt;Result[]&gt; {
        throw new Error("Method not implemented.");
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.226.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.227.1">SqlRepository</span></code><span class="kobospan" id="kobo.228.1"> class</span><a id="_idIndexMarker578" class="calibre3"/><span class="kobospan" id="kobo.229.1"> implements the </span><code class="inlinecode"><span class="kobospan" id="kobo.230.1">Repository</span></code><span class="kobospan" id="kobo.231.1"> interface, and its constructor prepares the database. </span><span class="kobospan" id="kobo.231.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.232.1">sqlite3</span></code><span class="kobospan" id="kobo.233.1"> module contains the database API and creates a new </span><code class="inlinecode"><span class="kobospan" id="kobo.234.1">Database</span></code><span class="kobospan" id="kobo.235.1"> object, specifying </span><code class="inlinecode"><span class="kobospan" id="kobo.236.1">age.db</span></code><span class="kobospan" id="kobo.237.1"> as the filename. </span><span class="kobospan" id="kobo.237.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.238.1">Database</span></code><span class="kobospan" id="kobo.239.1"> object provides methods for using the database and the </span><code class="inlinecode"><span class="kobospan" id="kobo.240.1">exec</span></code><span class="kobospan" id="kobo.241.1"> method is used to execute SQL statements – in this case, to execute the statements in the </span><code class="inlinecode"><span class="kobospan" id="kobo.242.1">age.sql</span></code><span class="kobospan" id="kobo.243.1"> file.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.244.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.245.1">Real projects don’t need to execute SQL to create the database every time, but doing so allows the example to be reset, and it is for this reason that the SQL in </span><em class="italic"><span class="kobospan" id="kobo.246.1">Listing 12.8</span></em><span class="kobospan" id="kobo.247.1"> will drop and recreate the database tables if they already exist. </span><span class="kobospan" id="kobo.247.2">Databases are usually initialized only when an application is deployed, and you can see an example of this in </span><em class="italic"><span class="kobospan" id="kobo.248.1">Part 3</span></em><span class="kobospan" id="kobo.249.1"> of this book.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.250.1">To make the repository available to the rest of the application, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.251.1">index.ts</span></code><span class="kobospan" id="kobo.252.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.253.1">src/server/data</span></code><span class="kobospan" id="kobo.254.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.255.1">Listing 12.11</span></em><span class="kobospan" id="kobo.256.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.257.1">Listing 12.11: The contents of the index.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.258.1">import { Repository } from "./repository";
import { SqlRepository } from "./sql_repository";
const repository: Repository = new SqlRepository();
export default repository;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.259.1">This file is responsible for instantiating the repository so that the rest of the application can access data through the </span><code class="inlinecode"><span class="kobospan" id="kobo.260.1">Repository</span></code><span class="kobospan" id="kobo.261.1"> interface without needing to know which implementation has been used.</span></p>
<h3 class="heading2" id="_idParaDest-210"><span class="kobospan" id="kobo.262.1">Querying the database</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.263.1">The next </span><a id="_idIndexMarker579" class="calibre3"/><span class="kobospan" id="kobo.264.1">step is to implement the methods that provide access to the database, starting with those that query for data. </span><span class="kobospan" id="kobo.264.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.265.1">sql_queries.ts</span></code><span class="kobospan" id="kobo.266.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.267.1">src/server/data</span></code><span class="kobospan" id="kobo.268.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.269.1">Listing 12.12</span></em><span class="kobospan" id="kobo.270.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.271.1">Listing 12.12: The contents of the sql_queries.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.272.1">const baseSql = `
    SELECT Results.*, name, age, years, nextage FROM Results
    INNER JOIN People ON personId = People.id
    INNER JOIN Calculations ON calculationId = Calculations.id`;
const endSql = `ORDER BY id DESC LIMIT $limit`;
export const queryAllSql = `${baseSql} ${endSql}`;
export const queryByNameSql = `${baseSql} WHERE name = $name ${endSql}`;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.273.1">SQL queries can be formulated like any other JavaScript string, and my preference is to avoid duplication by defining a base query and then building on it to create the variations needed. </span><span class="kobospan" id="kobo.273.2">In this case, I have defined </span><code class="inlinecode"><span class="kobospan" id="kobo.274.1">baseSql</span></code><span class="kobospan" id="kobo.275.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.276.1">endSql</span></code><span class="kobospan" id="kobo.277.1"> strings, which are combined to create queries, so that the query for data matching a name will be as follows:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.278.1">...
</span><span class="kobospan" id="kobo.278.2">SELECT Results.*, name, age, years, nextage FROM Results
    INNER JOIN People ON personId = People.id
    INNER JOIN Calculations ON calculationId = Calculations.id
    WHERE name = $name
    ORDER BY id DESC LIMIT $limit
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.279.1">These queries use named parameters, which are denoted by a </span><code class="inlinecode"><span class="kobospan" id="kobo.280.1">$</span></code><span class="kobospan" id="kobo.281.1"> sign and allow values to be provided when the query is executed. </span><span class="kobospan" id="kobo.281.2">As I explain in the </span><em class="italic"><span class="kobospan" id="kobo.282.1">Understanding SQL query parameters</span></em><span class="kobospan" id="kobo.283.1"> section, this is a feature that should always be used and is supported by every database package.</span></p>
<p class="normal"><span class="kobospan" id="kobo.284.1">I am not a professional database administrator, and there are more efficient ways to compose queries, but using a database is easier when the queries return data that can be easily parsed to create JavaScript objects. </span><span class="kobospan" id="kobo.284.2">In this case, the queries will return tables of data like this:</span></p>
<table class="table-container" id="table003-9">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.285.1">id</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.286.1">calculationId</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.287.1">personId</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.288.1">name</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.289.1">age</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.290.1">years</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.291.1">nextage</span></code></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.292.1">1</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.293.1">1</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.294.1">1</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.295.1">Alice</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.296.1">35</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.297.1">5</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.298.1">40</span></code></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.299.1">3</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.300.1">2</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.301.1">1</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.302.1">Alice</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.303.1">35</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.304.1">10</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlinecode3"><span class="kobospan2" id="kobo.305.1">45</span></code></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.306.1">The SQLite </span><a id="_idIndexMarker580" class="calibre3"/><span class="kobospan" id="kobo.307.1">package will convert the table of data into an array of JavaScript objects whose properties correspond to the table column names, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.308.1">...
</span><span class="kobospan" id="kobo.308.2">{
    id: 1,
    calculationId: 1,
    personId: 1,
    name: "Alice",
    age: 35,
    years: 5,
    nextage: 40
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.309.1">The structure of the data received from the database is a superset of the </span><code class="inlinecode"><span class="kobospan" id="kobo.310.1">Result</span></code><span class="kobospan" id="kobo.311.1"> interface defined in </span><em class="italic"><span class="kobospan" id="kobo.312.1">Listing 12.9</span></em><span class="kobospan" id="kobo.313.1">, which means that data received from the database can be used without needing further processing. </span><em class="italic"><span class="kobospan" id="kobo.314.1">Listing 12.13</span></em><span class="kobospan" id="kobo.315.1"> uses the SQL defined in </span><em class="italic"><span class="kobospan" id="kobo.316.1">Listing 12.12</span></em><span class="kobospan" id="kobo.317.1"> to query the database. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.318.1">Listing 12.13: Querying the database in the sql_repository.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.319.1">import { readFileSync } from "fs";
import { Database } from "sqlite3";
import { Repository, Result } from "./repository";
</span><strong class="screentext"><span class="kobospan" id="kobo.320.1">import { queryAllSql, queryByNameSql } from</span></strong><strong class="screentext"><span class="kobospan" id="kobo.321.1"> "./sql_queries";</span></strong><span class="kobospan" id="kobo.322.1">
export class SqlRepository implements Repository {
    db: Database;
    constructor() {
        this.db = new Database("age.db");
        this.db.exec(readFileSync("age.sql").toString(), err =&gt; {
            if (err != undefined) throw err;
        });
    }
    saveResult(r: Result): Promise&lt;number&gt; {
        throw new Error("Method not implemented.");
    }
    getAllResults($limit: number): Promise&lt;Result[]&gt; {
       </span><strong class="screentext"><span class="kobospan" id="kobo.323.1"> return this.executeQuery(queryAllSql, { $limit });</span></strong><span class="kobospan" id="kobo.324.1">
    }
    
    getResultsByName($name: string, $limit: number): Promise&lt;Result[]&gt; {
       </span><strong class="screentext"><span class="kobospan" id="kobo.325.1"> return this.executeQuery(queryByNameSql, { $name, $limit });</span></strong><span class="kobospan" id="kobo.326.1">
    }
   </span><strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.327.1">executeQuery(sql: string, params: any) : Promise&lt;Result[]&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.328.1">        return new Promise&lt;Result[]&gt;((resolve, reject</span></strong><strong class="screentext"><span class="kobospan" id="kobo.329.1">) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.330.1">            this.db.all&lt;Result&gt;(sql, params, (err, rows) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.331.1">                if (err == undefined) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.332.1">                    resolve(rows);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.333.1">                } </span></strong><strong class="screentext"><span class="kobospan" id="kobo.334.1">else {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.335.1">                    reject(err);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.336.1">                }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.337.1">            })</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.338.1">        });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.339.1">    }</span></strong><span class="kobospan" id="kobo.340.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.341.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.342.1">Database</span></code><span class="kobospan" id="kobo.343.1"> object </span><a id="_idIndexMarker581" class="calibre3"/><span class="kobospan" id="kobo.344.1">created in the constructor provides methods for querying the database. </span><span class="kobospan" id="kobo.344.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.345.1">executeQuery</span></code><span class="kobospan" id="kobo.346.1"> method uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.347.1">Database.all</span></code><span class="kobospan" id="kobo.348.1"> method, which executes a SQL query and returns all the rows that the database produces. </span><span class="kobospan" id="kobo.348.2">For quick reference, </span><em class="italic"><span class="kobospan" id="kobo.349.1">Table 12.3</span></em><span class="kobospan" id="kobo.350.1"> describes the most useful methods provided by the </span><code class="inlinecode"><span class="kobospan" id="kobo.351.1">Database</span></code><span class="kobospan" id="kobo.352.1"> class. </span><span class="kobospan" id="kobo.352.2">Most of these methods accept values for query parameters, which I explain in the </span><em class="italic"><span class="kobospan" id="kobo.353.1">Understanding SQL query parameters</span></em><span class="kobospan" id="kobo.354.1"> section. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.355.1">Table 12.3: Useful Database Methods </span></p>
<table class="table-container" id="table004-6">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.356.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.357.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.358.1">run(sql, params, cb)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.359.1">This method executes a SQL statement with an optional set of parameters. </span><span class="kobospan" id="kobo.359.2">No result data is returned. </span><span class="kobospan4" id="kobo.359.3">The optional callback function is invoked if there is an error or when execution is complete.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.360.1">get&lt;T&gt;(sql, params, cb)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.361.1">This method executes a SQL statement with an optional set of parameters and passes the first result row as an object to the callback function, with type </span><code class="inlinecode"><span class="kobospan2" id="kobo.362.1">T</span></code><span class="kobospan4" id="kobo.363.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.364.1">all&lt;T&gt;(sql, params, cb)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.365.1">This method executes a SQL statement with an optional set of parameters and passes all result rows to the callback function as an array of type </span><code class="inlinecode"><span class="kobospan2" id="kobo.366.1">T</span></code><span class="kobospan4" id="kobo.367.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.368.1">prepare(sql)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.369.1">This method creates a prepared statement, which is represented with a </span><code class="inlinecode"><span class="kobospan2" id="kobo.370.1">Statement</span></code><span class="kobospan" id="kobo.371.1"> object, and can improve performance because the database doesn’t have to process SQL every time the query is executed. </span><span class="kobospan4" id="kobo.371.2">This method does not accept query parameters.</span></p>
</td>
</tr>
</tbody>
</table>
<h3 class="heading2" id="_idParaDest-211"><span class="kobospan" id="kobo.372.1">Displaying data</span></h3>
<p class="normal1"><em class="italic"><span class="kobospan" id="kobo.373.1">Listing 12.14</span></em><span class="kobospan" id="kobo.374.1"> updates </span><a id="_idIndexMarker582" class="calibre3"/><span class="kobospan" id="kobo.375.1">the code that handles HTTP requests to create an instance of the SQL repository and uses the methods it provides to query the database and pass the results to the template.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.376.1">Listing 12.14: Using the repository in the forms.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.377.1">import express, { Express } from "express";
</span><strong class="screentext"><span class="kobospan" id="kobo.378.1">import repository  from "./data";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.379.1">const</span></strong><strong class="screentext"><span class="kobospan" id="kobo.380.1"> rowLimit = 10;</span></strong><span class="kobospan" id="kobo.381.1">
export const registerFormMiddleware = (app: Express) =&gt; {
    app.use(express.urlencoded({extended: true}))
}
export const registerFormRoutes = (app: Express) =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.382.1">app.get("/form", async (req, resp) =&gt; {</span></strong><span class="kobospan" id="kobo.383.1">
        resp.render("age", {
           </span><strong class="screentext"><span class="kobospan" id="kobo.384.1"> history: await repository.getAllResults(rowLimit)</span></strong><span class="kobospan" id="kobo.385.1">
        });
    });
    </span><strong class="screentext"><span class="kobospan" id="kobo.386.1">app.post("/form", async (req, resp) =&gt; {</span></strong><span class="kobospan" id="kobo.387.1">
        const nextage = Number.parseInt(req.body.age)
            + Number.parseInt(req.body.years);
        const context = {
            ...req.body, nextage,
         </span><strong class="screentext"><span class="kobospan" id="kobo.388.1">   history</span></strong><strong class="screentext"><span class="kobospan" id="kobo.389.1">: await repository.getResultsByName(</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.390.1">                req.body.name, rowLimit)</span></strong><span class="kobospan" id="kobo.391.1">
        };
        resp.render("age", context);  
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.392.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.393.1">async</span></code><span class="kobospan" id="kobo.394.1"> keyword</span><a id="_idIndexMarker583" class="calibre3"/><span class="kobospan" id="kobo.395.1"> is applied to the handler functions, which allows the use of the </span><code class="inlinecode"><span class="kobospan" id="kobo.396.1">await</span></code><span class="kobospan" id="kobo.397.1"> keyword when calling the repository methods. </span><span class="kobospan" id="kobo.397.2">The results are passed to the template using a property named </span><code class="inlinecode"><span class="kobospan" id="kobo.398.1">history</span></code><span class="kobospan" id="kobo.399.1">, which is used to populate the table in </span><em class="italic"><span class="kobospan" id="kobo.400.1">Listing 12.15</span></em><span class="kobospan" id="kobo.401.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.402.1">Listing 12.15: Populating the table in the history.handlebars file in the templates/server/partials folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.403.1">&lt;h4&gt;Recent Queries&lt;/h4&gt;
&lt;table class="table table-sm table-striped my-2"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Age&lt;/th&gt;&lt;th&gt;Years&lt;/th&gt;&lt;th&gt;Result&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        {{#unless history }}
            &lt;tr&gt;&lt;td colspan="4"&gt;No data available&lt;/td&gt;&lt;/tr&gt;
        {{/unless }}
        </span><strong class="screentext"><span class="kobospan" id="kobo.404.1">{{#each history }}</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.405.1">&lt;tr&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.406.1">                &lt;td&gt;{{ this.name }} &lt;/td&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.407.1">                &lt;td&gt;{{ this.age }} &lt;/td&gt;</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.408.1">&lt;td&gt;{{ this.years }} &lt;/td&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.409.1">                &lt;td&gt;{{ this.nextage }} &lt;/td&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.410.1">            &lt;/tr&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.411.1">        {{/each }}</span></strong><span class="kobospan" id="kobo.412.1">
    &lt;/tbody&gt;
&lt;/table&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.413.1">Use a browser to </span><a id="_idIndexMarker584" class="calibre3"/><span class="kobospan" id="kobo.414.1">request </span><code class="inlinecode"><span class="kobospan" id="kobo.415.1">http://localhost:5000/form</span></code><span class="kobospan" id="kobo.416.1"> and you will see that the right-hand side shows data from all users. </span><span class="kobospan" id="kobo.416.2">Fill out and submit the form and only queries from that user will be displayed, as shown in </span><em class="italic"><span class="kobospan" id="kobo.417.1">Figure 12.2</span></em><span class="kobospan" id="kobo.418.1">. </span><span class="kobospan" id="kobo.418.2">The queries in the database from other users are no longer shown.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.419.1"><img alt="" src="../Images/B21959_12_02.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.420.1">Figure 12.2: Querying the database</span></p>
<h2 class="heading1" id="_idParaDest-212"><span class="kobospan" id="kobo.421.1">Understanding SQL query parameters</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.422.1">Care must </span><a id="_idIndexMarker585" class="calibre3"/><span class="kobospan" id="kobo.423.1">be taken when including values </span><a id="_idIndexMarker586" class="calibre3"/><span class="kobospan" id="kobo.424.1">received from users in SQL queries. </span><span class="kobospan" id="kobo.424.2">As a demonstration, </span><em class="italic"><span class="kobospan" id="kobo.425.1">Listing 12.16</span></em><span class="kobospan" id="kobo.426.1"> alters the implementation of the </span><code class="inlinecode"><span class="kobospan" id="kobo.427.1">getResultsByName</span></code><span class="kobospan" id="kobo.428.1"> defined by the </span><code class="inlinecode"><span class="kobospan" id="kobo.429.1">SQLRepository</span></code><span class="kobospan" id="kobo.430.1"> class. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.431.1">Listing 12.16: Including user input in the sql_repository.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.432.1">...
</span><span class="kobospan" id="kobo.432.2">getResultsByName($name: string, $limit: number): Promise&lt;Result[]&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.433.1">return this.executeQuery</span></strong><strong class="screentext"><span class="kobospan" id="kobo.434.1">(`</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.435.1">        SELECT Results.*, name, age, years, nextage FROM Results</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.436.1">        INNER JOIN People ON personId = People.id</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.437.1">        INNER JOIN Calculations ON calculationId = Calculations.id</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.438.1">        WHERE name = "${$name}"`, {});</span></strong><span class="kobospan" id="kobo.439.1">
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.440.1">The mistake </span><a id="_idIndexMarker587" class="calibre3"/><span class="kobospan" id="kobo.441.1">being made in this example is to include the value received from the form directly in the query. </span><span class="kobospan" id="kobo.441.2">If the user enters </span><code class="inlinecode"><span class="kobospan" id="kobo.442.1">Alice</span></code><span class="kobospan" id="kobo.443.1"> into the form, then the query will look like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.444.1">...
</span><span class="kobospan" id="kobo.444.2">SELECT Results.*, name, age, years, nextage FROM Results
        INNER JOIN People ON personId = People.id
        INNER JOIN Calculations ON calculationId = Calculations.id
        WHERE name = "Alice"
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.445.1">This is the</span><a id="_idIndexMarker588" class="calibre3"/><span class="kobospan" id="kobo.446.1"> anticipated behavior, and it retrieves the queries made using that name. </span><span class="kobospan" id="kobo.446.2">But it is easy to craft strings that alter the query. </span><span class="kobospan" id="kobo.446.3">If the user enters </span><code class="inlinecode"><span class="kobospan" id="kobo.447.1">Alice" or name = "Bob</span></code><span class="kobospan" id="kobo.448.1">, for example, then the query will look like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.449.1">...
</span><span class="kobospan" id="kobo.449.2">SELECT Results.*, name, age, years, nextage FROM Results
        INNER JOIN People ON personId = People.id
        INNER JOIN Calculations ON calculationId = Calculations.id
        WHERE name = "Alice" OR name = "Bob"
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.450.1">This isn’t what the developer expects, and it means that queries made by two users are displayed, as shown in </span><em class="italic"><span class="kobospan" id="kobo.451.1">Figure 12.3</span></em><span class="kobospan" id="kobo.452.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.453.1"><img alt="" src="../Images/B21959_12_03.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.454.1">Figure 12.3: Executing a query with user input</span></p>
<p class="normal"><span class="kobospan" id="kobo.455.1">This is a </span><a id="_idIndexMarker589" class="calibre3"/><span class="kobospan" id="kobo.456.1">benign example, but it shows that including user-supplied values directly in queries </span><a id="_idIndexMarker590" class="calibre3"/><span class="kobospan" id="kobo.457.1">allows malicious users to change how queries are processed. </span><span class="kobospan" id="kobo.457.2">This problem isn’t addressed by the HTML sanitization described in </span><em class="italic"><span class="kobospan" id="kobo.458.1">Chapter 11</span></em><span class="kobospan" id="kobo.459.1"> because the values are not sanitized until they are included in a response. </span><span class="kobospan" id="kobo.459.2">Instead, databases provide support for </span><em class="italic"><span class="kobospan" id="kobo.460.1">query parameters</span></em><span class="kobospan" id="kobo.461.1">, which allow values to be inserted into queries safely.</span></p>
<p class="normal"><span class="kobospan" id="kobo.462.1">The parameter is defined in the SQL query and is denoted with an initial </span><code class="inlinecode"><span class="kobospan" id="kobo.463.1">$</span></code><span class="kobospan" id="kobo.464.1"> character, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.465.1">...
</span><span class="kobospan" id="kobo.465.2">export const queryByNameSql = `${baseSql} WHERE name = </span><strong class="screentext"><span class="kobospan" id="kobo.466.1">$name</span></strong><span class="kobospan" id="kobo.467.1"> ${endSql}`;
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.468.1">This statement is combined with the base query, which means that the overall SQL statement looks like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.469.1">...
</span><span class="kobospan" id="kobo.469.2">SELECT Results.*, name, age, years, nextage FROM Results
    INNER JOIN People ON personId = People.id
    INNER JOIN Calculations ON calculationId = Calculations.id
    WHERE name = </span><strong class="screentext"><span class="kobospan" id="kobo.470.1">$name</span></strong><span class="kobospan" id="kobo.471.1"> ORDER BY id DESC LIMIT </span><strong class="screentext"><span class="kobospan" id="kobo.472.1">$limit</span></strong><span class="kobospan" id="kobo.473.1">
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.474.1">The two query</span><a id="_idIndexMarker591" class="calibre3"/><span class="kobospan" id="kobo.475.1"> parameters are marked in bold, and</span><a id="_idIndexMarker592" class="calibre3"/><span class="kobospan" id="kobo.476.1"> they indicate values that will be supplied when the statement is executed by the </span><code class="inlinecode"><span class="kobospan" id="kobo.477.1">executeQuery</span></code><span class="kobospan" id="kobo.478.1"> method in the </span><code class="inlinecode"><span class="kobospan" id="kobo.479.1">SqlRepository</span></code><span class="kobospan" id="kobo.480.1"> class:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.481.1">...
</span><span class="kobospan" id="kobo.481.2">executeQuery(sql: string, </span><strong class="screentext"><span class="kobospan" id="kobo.482.1">params</span></strong><span class="kobospan" id="kobo.483.1">: any) : Promise&lt;Result[]&gt; {
    return new Promise&lt;Result[]&gt;((resolve, reject) =&gt; {
        this.db.all&lt;RowResult&gt;(sql, </span><strong class="screentext"><span class="kobospan" id="kobo.484.1">params</span></strong><span class="kobospan" id="kobo.485.1">, (err, rows) =&gt; {
            if (err == undefined) {
                resolve(rowsToObjects(rows));
            } else {
                reject(err);
            }
        })
    });
}
...
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.486.1">Listing 12.17</span></em><span class="kobospan" id="kobo.487.1"> reverts the changes to the </span><code class="inlinecode"><span class="kobospan" id="kobo.488.1">SqlRepository</span></code><span class="kobospan" id="kobo.489.1"> class so that the query performed by the </span><code class="inlinecode"><span class="kobospan" id="kobo.490.1">getResultsByName</span></code><span class="kobospan" id="kobo.491.1"> method uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.492.1">executeQuery</span></code><span class="kobospan" id="kobo.493.1"> method and provides query parameters.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.494.1">Listing 12.17: Using query parameters in the sql_repository.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.495.1">...
</span><span class="kobospan" id="kobo.495.2">getResultsByName($name: string, $limit: number): Promise&lt;Result[]&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.496.1">return this.executeQuery(queryByNameSql, { $name, $limit });</span></strong><span class="kobospan" id="kobo.497.1">
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.498.1">The object that contains the parameter values has property names that match the parameters in the SQL statement: </span><code class="inlinecode"><span class="kobospan" id="kobo.499.1">$name</span></code><span class="kobospan" id="kobo.500.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.501.1">$limit</span></code><span class="kobospan" id="kobo.502.1">. </span><span class="kobospan" id="kobo.502.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.503.1">$</span></code><span class="kobospan" id="kobo.504.1"> sign isn’t the only way to denote a</span><a id="_idIndexMarker593" class="calibre3"/><span class="kobospan" id="kobo.505.1"> query parameter in SQL, but it works well with</span><a id="_idIndexMarker594" class="calibre3"/><span class="kobospan" id="kobo.506.1"> JavaScript because the </span><code class="inlinecode"><span class="kobospan" id="kobo.507.1">$</span></code><span class="kobospan" id="kobo.508.1"> sign is allowed in variable names. </span><span class="kobospan" id="kobo.508.2">It is for this reason that the </span><code class="inlinecode"><span class="kobospan" id="kobo.509.1">getResultsByName</span></code><span class="kobospan" id="kobo.510.1"> method defines </span><code class="inlinecode"><span class="kobospan" id="kobo.511.1">$name</span></code><span class="kobospan" id="kobo.512.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.513.1">$limit</span></code><span class="kobospan" id="kobo.514.1"> parameters, allowing the values to be passed along without needing to alter the names.</span></p>
<p class="normal"><span class="kobospan" id="kobo.515.1">The last piece of the puzzle is provided by the code that handles the form data:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.516.1">...
</span><span class="kobospan" id="kobo.516.2">const context = {
    ...req.body, nextage,
    history: await repository.getResultsByName(</span><strong class="screentext"><span class="kobospan" id="kobo.517.1">req.body.name</span></strong><span class="kobospan" id="kobo.518.1">, rowLimit)
};
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.519.1">The value the user entered for the name field in the form is read from the body and used as the value for the </span><code class="inlinecode"><span class="kobospan" id="kobo.520.1">$name</span></code><span class="kobospan" id="kobo.521.1"> query parameter. </span><span class="kobospan" id="kobo.521.2">The methods described in </span><em class="italic"><span class="kobospan" id="kobo.522.1">Table 12.3</span></em><span class="kobospan" id="kobo.523.1"> automatically sanitize query parameters, so they do not alter the way the query is executed, as shown in </span><em class="italic"><span class="kobospan" id="kobo.524.1">Figure 12.4</span></em><span class="kobospan" id="kobo.525.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.526.1"><img alt="" src="../Images/B21959_12_04.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.527.1">Figure 12.4: The effect of a sanitized query parameter</span></p>
<h2 class="heading1" id="_idParaDest-213"><span class="kobospan" id="kobo.528.1">Writing to the database</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.529.1">The next step </span><a id="_idIndexMarker595" class="calibre3"/><span class="kobospan" id="kobo.530.1">is to write data so that the database contains more than just the seed data added when the database is created. </span><em class="italic"><span class="kobospan" id="kobo.531.1">Listing 12.18</span></em><span class="kobospan" id="kobo.532.1"> defines SQL statements that will insert rows into the database tables. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.533.1">Listing 12.18: Adding statements in the sql_queries.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.534.1">const baseSql = `
    SELECT Results.*, name, age, years, nextage FROM Results
    INNER JOIN People ON personId = People.id
    INNER JOIN Calculations ON calculationId = Calculations.id`;
const endSql = `ORDER BY id DESC LIMIT $limit`;
export const queryAllSql = `${baseSql} ${endSql}`;
export const queryByNameSql = `${baseSql} WHERE name = $name ${endSql}`;
</span><strong class="screentext"><span class="kobospan" id="kobo.535.1">export const insertPerson = `</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.536.1">    INSERT INTO People (name)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.537.1">    SELECT $name</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.538.1">    WHERE NOT EXISTS (SELECT name FROM People WHERE name = $name)`;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.539.1">export const insertCalculation = `</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.540.1">    INSERT INTO Calculations (age, years, nextage)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.541.1">    SELECT $age, $years, $nextage</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.542.1">    WHERE NOT EXISTS</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.543.1">	    (SELECT age, years, nextage FROM Calculations</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.544.1">            WHERE age = $age AND years = $years AND nextage = $nextage)`;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.545.1">export const</span></strong><strong class="screentext"><span class="kobospan" id="kobo.546.1"> insertResult = `</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.547.1">    INSERT INTO Results (personId, calculationId)</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.548.1">    SELECT People.id as personId, Calculations.id as calculationId from People</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.549.1">	CROSS JOIN Calculations</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.550.1">	    WHERE People.name = $name</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.551.1">		AND Calculations.age = $age</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.552.1">		AND Calculations.years = $years</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.553.1">		AND Calculations.nextage = $nextage`;</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.554.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.555.1">insertPerson</span></code><span class="kobospan" id="kobo.556.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.557.1">insertCalculation</span></code><span class="kobospan" id="kobo.558.1"> statements will insert new rows in the </span><code class="inlinecode"><span class="kobospan" id="kobo.559.1">People</span></code><span class="kobospan" id="kobo.560.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.561.1">Calculation</span></code><span class="kobospan" id="kobo.562.1"> tables only if there are no existing rows that have the same details. </span><span class="kobospan" id="kobo.562.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.563.1">insertResult</span></code><span class="kobospan" id="kobo.564.1"> statement creates a row in the </span><code class="inlinecode"><span class="kobospan" id="kobo.565.1">Results</span></code><span class="kobospan" id="kobo.566.1"> table, with references to the other tables.</span></p>
<p class="normal"><span class="kobospan" id="kobo.567.1">These statements</span><a id="_idIndexMarker596" class="calibre3"/><span class="kobospan" id="kobo.568.1"> need to be executed within a transaction to ensure consistency. </span><span class="kobospan" id="kobo.568.2">The SQLite database engine supports transactions, but these are not exposed conveniently to Node.js and additional work is required to run SQL statements in a transaction. </span><span class="kobospan" id="kobo.568.3">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.569.1">sql_helpers.ts</span></code><span class="kobospan" id="kobo.570.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.571.1">src/server/data</span></code><span class="kobospan" id="kobo.572.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.573.1">Listing 12.19</span></em><span class="kobospan" id="kobo.574.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.575.1">Listing 12.19: The contents of the sql_helpers.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.576.1">import { Database } from "sqlite3";
export class TransactionHelper {
    steps: [sql: string, params: any][] = [];
    add(sql: string, params: any): TransactionHelper {
        this.steps.push([sql, params]);
        return this;
    }
    run(db: Database): Promise&lt;number&gt; {
        return new Promise((resolve, reject) =&gt; {
            let index = 0;
            let lastRow: number = NaN;
            const cb = (err: any, rowID?: number) =&gt; {
                if (err) {
                    db.run("ROLLBACK", () =&gt; reject());
                } else {
                    lastRow = rowID ? </span><span class="kobospan" id="kobo.576.2">rowID : lastRow;
                    if (++index === this.steps.length) {
                        db.run("COMMIT", () =&gt; resolve(lastRow));
                    } else {
                        this.runStep(index, db, cb);
                    }
                }
            }
            db.run("BEGIN", () =&gt; this.runStep(0, db, cb));
        }); 
    }
    runStep(idx: number, db: Database, cb: (err: any, row: number) =&gt; void) {
        const [sql, params] = this.steps[idx];
        db.run(sql, params, function (err: any) {
            cb(err, this.lastID)
        });
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.577.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.578.1">TransactionHelper</span></code><span class="kobospan" id="kobo.579.1"> class defines an </span><code class="inlinecode"><span class="kobospan" id="kobo.580.1">add</span></code><span class="kobospan" id="kobo.581.1"> method that is used to build up a list of SQL statements and query parameters. </span><span class="kobospan" id="kobo.581.2">When the </span><code class="inlinecode"><span class="kobospan" id="kobo.582.1">run</span></code><span class="kobospan" id="kobo.583.1"> method is called, the </span><code class="inlinecode"><span class="kobospan" id="kobo.584.1">BEGIN</span></code><span class="kobospan" id="kobo.585.1"> command is sent to SQLite, and each of the SQL statements is run. </span><span class="kobospan" id="kobo.585.2">If all the statements execute successfully, the </span><code class="inlinecode"><span class="kobospan" id="kobo.586.1">COMMIT</span></code><span class="kobospan" id="kobo.587.1"> command is sent, and SQLite applies the changes </span><a id="_idIndexMarker597" class="calibre3"/><span class="kobospan" id="kobo.588.1">to the database. </span><span class="kobospan" id="kobo.588.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.589.1">ROLLBACK</span></code><span class="kobospan" id="kobo.590.1"> command is sent if any of the statements fail and SQLite abandons the changes made by earlier statements. </span><span class="kobospan" id="kobo.590.2">SQLite provides the ID of the row modified by </span><code class="inlinecode"><span class="kobospan" id="kobo.591.1">INSERT</span></code><span class="kobospan" id="kobo.592.1"> statements, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.593.1">run</span></code><span class="kobospan" id="kobo.594.1"> method returns the value produced by the most recent statement. </span><span class="kobospan" id="kobo.594.2">Knowing the ID of the most recently inserted row is generally a good idea because it makes it easy to query for new data, as </span><em class="italic"><span class="kobospan" id="kobo.595.1">Chapter 14</span></em><span class="kobospan" id="kobo.596.1"> will demonstrate.</span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.597.1">Listing 12.20</span></em><span class="kobospan" id="kobo.598.1"> uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.599.1">TransactionHelper</span></code><span class="kobospan" id="kobo.600.1"> class to perform an update by running the three statements from </span><em class="italic"><span class="kobospan" id="kobo.601.1">Listing 12.18</span></em><span class="kobospan" id="kobo.602.1"> within a SQL transaction.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.603.1">Listing 12.20: Inserting data in the sql_repository.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.604.1">import { readFileSync } from "fs";
import { Database } from "sqlite3";
import { Repository, Result } from "./repository";
</span><strong class="screentext"><span class="kobospan" id="kobo.605.1">import { queryAllSql, queryByNameSql,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.606.1">    insertPerson, insertCalculation, insertResult } from "./sql_queries";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.607.1">import { TransactionHelper } from "./sql_helpers";</span></strong><span class="kobospan" id="kobo.608.1">
export class SqlRepository implements Repository {
    db: Database;
    constructor() {
        this.db = new Database("age.db");
        this.db.exec(readFileSync("age.sql").toString(), err =&gt; {
            if (err != undefined) throw err;
        });
    }
    async saveResult(r: Result): Promise&lt;number&gt; {
       </span><strong class="screentext"><span class="kobospan" id="kobo.609.1"> return await new</span></strong><strong class="screentext"><span class="kobospan" id="kobo.610.1"> TransactionHelper()</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.611.1">            .add(insertPerson, { $name: r.name })</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.612.1">            .add(insertCalculation, {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.613.1">                    $age: r.age, $years: r.years, $nextage</span></strong><strong class="screentext"><span class="kobospan" id="kobo.614.1">: r.nextage</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.615.1">            })</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.616.1">            .add(insertResult, {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.617.1">                $name: r.name,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.618.1">                $age: r.age, $years: r.years, $nextage: r.nextage</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.619.1">            })</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.620.1">            .run(this.db);       </span></strong><span class="kobospan" id="kobo.621.1">
    }
    getAllResults($limit: number): Promise&lt;Result[]&gt; {
        return this.executeQuery(queryAllSql, { $limit });
    }
    
    getResultsByName($name: string, $limit: number): Promise&lt;Result[]&gt; {
        return this.executeQuery(queryByNameSql, { $name, $limit });
    }
    executeQuery(sql: string, params: any) : Promise&lt;Result[]&gt; {
        return new Promise&lt;Result[]&gt;((resolve, reject) =&gt; {
            this.db.all&lt;Result&gt;(sql, params, (err, rows) =&gt; {
                if (err == undefined) {
                    resolve(rows);
                } else {
                    reject(err);
                }
            })
        });
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.622.1">The </span><a id="_idIndexMarker598" class="calibre3"/><span class="kobospan" id="kobo.623.1">implementation of the </span><code class="inlinecode"><span class="kobospan" id="kobo.624.1">saveResult</span></code><span class="kobospan" id="kobo.625.1"> method executes the three SQL statements. </span><span class="kobospan" id="kobo.625.2">Each statement requires a separate object for its query parameters because SQLite produces an error if there are unused properties in the parameters object. </span><em class="italic"><span class="kobospan" id="kobo.626.1">Listing 12.21</span></em><span class="kobospan" id="kobo.627.1"> updates the handler for HTTP POST requests to write data to the database through the repository.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.628.1">Listing 12.21: Writing data in the forms.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.629.1">import express, { Express } from "express";
import repository  from "./data";
const rowLimit = 10;
export const registerFormMiddleware = (app: Express) =&gt; {
    app.use(express.urlencoded({extended: true}))
}
export const registerFormRoutes = (app: Express) =&gt; {
    app.get("/form", async (req, resp) =&gt; {
        resp.render("age", {
            history: await repository.getAllResults(rowLimit)
        });
    });
    app.post("/form", async (req, resp) =&gt; {
        const nextage = Number.parseInt(req.body.age)
            + Number.parseInt(req.body.years);
</span><strong class="screentext"><span class="kobospan" id="kobo.630.1">        await repository.saveResult({...req.body, nextage });</span></strong><span class="kobospan" id="kobo.631.1">
        const context = {
            ...req.body, nextage,
            history: await repository.getResultsByName(
                req.body.name, rowLimit)
        };
        resp.render("age", context);  
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.632.1">Using </span><a id="_idIndexMarker599" class="calibre3"/><span class="kobospan" id="kobo.633.1">consistent names for each part of the application means that the request body can be used as the basis for the </span><code class="inlinecode"><span class="kobospan" id="kobo.634.1">Result</span></code><span class="kobospan" id="kobo.635.1"> interface expected by the repository. </span><span class="kobospan" id="kobo.635.2">The effect is that each new request is stored in the database and reflected in the response presented to the user, as shown in </span><em class="italic"><span class="kobospan" id="kobo.636.1">Figure 12.5</span></em><span class="kobospan" id="kobo.637.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.638.1"><img alt="" src="../Images/B21959_12_05.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.639.1">Figure 12.5: Writing data to the database</span></p>
<h1 class="heading" id="_idParaDest-214"><span class="kobospan" id="kobo.640.1">Using an ORM package</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.641.1">The advantage </span><a id="_idIndexMarker600" class="calibre3"/><span class="kobospan" id="kobo.642.1">of working directly with the database is that you have control over how every statement is written and executed. </span><span class="kobospan" id="kobo.642.2">The drawback is that can be a complex and time-consuming process. </span></p>
<p class="normal"><span class="kobospan" id="kobo.643.1">An alternative is</span><a id="_idIndexMarker601" class="calibre3"/><span class="kobospan" id="kobo.644.1"> to use an ORM package that deals with the database on behalf of the developer, hiding some aspects of SQL and taking care of mapping between the database and JavaScript objects.</span></p>
<p class="normal"><span class="kobospan" id="kobo.645.1">The range of features provided by ORM packages varies widely. </span><span class="kobospan" id="kobo.645.2">Some take a light-touch approach and focus on transforming data, but most packages deal with most aspects of using a database, including defining the SQL schema, creating the database, and even generating queries.</span></p>
<p class="normal"><span class="kobospan" id="kobo.646.1">ORM packages can be great, but you still have to have a basic understanding of SQL, which is why I started this chapter with a direct-to-database example. </span><span class="kobospan" id="kobo.646.2">ORM packages expect the developer to understand how their features will be used to create and use databases, and you won’t be able to get useful results or diagnose problems without some SQL skills.</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.647.1">The Argument for Object Databases</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.648.1">An alternative to using SQL and an ORM package is to use a database that stores objects directly, such as MongoDB (</span><a href="https://www.mongodb.com" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.649.1">https://www.mongodb.com</span></span></a><span class="kobospan" id="kobo.650.1">). </span><span class="kobospan" id="kobo.650.2">The reason that I have not covered object databases in this book is that most projects use relational databases, and most companies standardize on a specific relational database engine. </span><span class="kobospan" id="kobo.650.3">Object databases can be a good choice, but they are not the technology that most developers end up using. </span><span class="kobospan" id="kobo.650.4">SQL databases remain dominant, even though there are some excellent alternatives available.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.651.1">The ORM package </span><a id="_idIndexMarker602" class="calibre3"/><span class="kobospan" id="kobo.652.1">that I use in this chapter is called Sequelize (</span><a href="https://www.npmjs.com/package/sequelize" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.653.1">https://www.npmjs.com/package/sequelize</span></span></a><span class="kobospan" id="kobo.654.1">), which is the most popular JavaScript </span><a id="_idIndexMarker603" class="calibre3"/><span class="kobospan" id="kobo.655.1">ORM package. </span><span class="kobospan" id="kobo.655.2">Sequelize has a comprehensive set of features and supports the most popular database engines, including SQLite.</span></p>
<p class="normal"><span class="kobospan" id="kobo.656.1">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.657.1">Listing 12.22</span></em><span class="kobospan" id="kobo.658.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.659.1">part2app</span></code><span class="kobospan" id="kobo.660.1"> folder to install the Sequelize package, which includes TypeScript type information.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.661.1">Listing 12.22: Installing the ORM packages</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.662.1">npm install sequelize@6.35.1
</span></code></pre>
<h2 class="heading1" id="_idParaDest-215"><span class="kobospan" id="kobo.663.1">Defining the database using JavaScript objects</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.664.1">When </span><a id="_idIndexMarker604" class="calibre3"/><span class="kobospan" id="kobo.665.1">working directly with a database, the first step is to write the SQL statements that create the tables and the relationships between them, which is how this chapter started. </span><span class="kobospan" id="kobo.665.2">When using an ORM, the database is described using JavaScript objects. </span><span class="kobospan" id="kobo.665.3">Each ORM package has its own process and, for Sequelize, three steps are required.</span></p>
<h3 class="heading2" id="_idParaDest-216"><span class="kobospan" id="kobo.666.1">Creating the model classes</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.667.1">The first</span><a id="_idIndexMarker605" class="calibre3"/><span class="kobospan" id="kobo.668.1"> step is to define the classes that will represent the data in the database. </span><span class="kobospan" id="kobo.668.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.669.1">orm_models.ts</span></code><span class="kobospan" id="kobo.670.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.671.1">src/server/data</span></code><span class="kobospan" id="kobo.672.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.673.1">Listing 12.23</span></em><span class="kobospan" id="kobo.674.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.675.1">Listing 12.23: The contents of the orm_models.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext"><span class="kobospan" id="kobo.676.1">import { Model, CreationOptional, ForeignKey, InferAttributes,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.677.1">    InferCreationAttributes  } </span></strong><strong class="screentext"><span class="kobospan" id="kobo.678.1">from "sequelize";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.679.1">export class Person extends Model&lt;InferAttributes&lt;Person&gt;,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.680.1">        InferCreationAttributes&lt;</span></strong><strong class="screentext"><span class="kobospan" id="kobo.681.1">Person&gt;&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.682.1">    declare id?: CreationOptional&lt;number&gt;;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.683.1">    declare name: string</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.684.1">}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.685.1">export class Calculation extends Model&lt;InferAttributes&lt;Calculation&gt;,</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.686.1">InferCreationAttributes&lt;Calculation&gt;&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.687.1">    declare id?: CreationOptional&lt;number&gt;;           </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.688.1">    declare age: number;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.689.1">    declare years: number;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.690.1">    declare nextage: number;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.691.1">}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.692.1">export class ResultModel extends </span></strong><strong class="screentext"><span class="kobospan" id="kobo.693.1">Model&lt;InferAttributes&lt;ResultModel&gt;,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.694.1">        InferCreationAttributes&lt;ResultModel&gt;&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.695.1">    declare id: CreationOptional&lt;number&gt;;          </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.696.1">    declare personId: ForeignKey&lt;Person["</span></strong><strong class="screentext"><span class="kobospan" id="kobo.697.1">id"]&gt;;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.698.1">    declare calculationId: ForeignKey&lt;Calculation["id"]&gt;;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.699.1">    declare Person?: InferAttributes&lt;Person&gt;;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.700.1">    declare Calculation?: InferAttributes&lt;</span></strong><strong class="screentext"><span class="kobospan" id="kobo.701.1">Calculation&gt;;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.702.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.703.1">Sequelize will use each class to create a database table and each property will be a column in that table. </span><span class="kobospan" id="kobo.703.2">These classes also describe the data in the database to the TypeScript compiler.</span></p>
<p class="normal"><span class="kobospan" id="kobo.704.1">All the </span><a id="_idIndexMarker606" class="calibre3"/><span class="kobospan" id="kobo.705.1">class properties in </span><em class="italic"><span class="kobospan" id="kobo.706.1">Listing 12.23</span></em><span class="kobospan" id="kobo.707.1"> are defined with the </span><code class="inlinecode"><span class="kobospan" id="kobo.708.1">declare</span></code><span class="kobospan" id="kobo.709.1"> keyword, which tells the TypeScript compiler to behave as though the properties have been defined but not to include those properties in the compiled JavaScript. </span><span class="kobospan" id="kobo.709.2">This is important because Sequelize will add getters and setters to objects to provide access to data, and defining properties conventionally will prevent that feature from working properly.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.710.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.711.1">The names of the model classes should be meaningful. </span><span class="kobospan" id="kobo.711.2">I have chosen </span><code class="inlinecode"><span class="kobospan" id="kobo.712.1">Person</span></code><span class="kobospan" id="kobo.713.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.714.1">Calculation</span></code><span class="kobospan" id="kobo.715.1">, which are obvious enough, but I have used </span><code class="inlinecode"><span class="kobospan" id="kobo.716.1">ResultModel</span></code><span class="kobospan" id="kobo.717.1"> to avoid conflicting with the name of the type used by the </span><code class="inlinecode"><span class="kobospan" id="kobo.718.1">Repository</span></code><span class="kobospan" id="kobo.719.1"> interface.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.720.1">Class properties whose type is a regular JavaScript type will be represented by regular columns in the database, such as the </span><code class="inlinecode"><span class="kobospan" id="kobo.721.1">name</span></code><span class="kobospan" id="kobo.722.1"> property defined by the </span><code class="inlinecode"><span class="kobospan" id="kobo.723.1">Person</span></code><span class="kobospan" id="kobo.724.1"> class:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.725.1">...
</span><span class="kobospan" id="kobo.725.2">export class Person extends Model&lt;InferAttributes&lt;Person&gt;,
        InferCreationAttributes&lt;Person&gt;&gt; {
    declare id?: CreationOptional&lt;number&gt;;
    </span><strong class="screentext"><span class="kobospan" id="kobo.726.1">declare name: string</span></strong><span class="kobospan" id="kobo.727.1">
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.728.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.729.1">CreationOptional&lt;T&gt;</span></code><span class="kobospan" id="kobo.730.1"> type is used to describe a property that doesn’t have to be supplied when a new instance of the model class is created, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.731.1">...
</span><strong class="screentext"><span class="kobospan" id="kobo.732.1">export class Person extends Model</span></strong><strong class="screentext"><span class="kobospan" id="kobo.733.1">&lt;InferAttributes&lt;Person&gt;,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.734.1">        InferCreationAttributes&lt;Person&gt;&gt; {</span></strong>
<strong class="screentext"> </strong><span class="kobospan" id="kobo.735.1">declare id?: CreationOptional&lt;number&gt;;
    declare name: string
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.736.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.737.1">id</span></code><span class="kobospan" id="kobo.738.1"> property represents the primary key for a </span><code class="inlinecode"><span class="kobospan" id="kobo.739.1">Person</span></code><span class="kobospan" id="kobo.740.1"> object when it is stored as a row in a database table. </span><span class="kobospan" id="kobo.740.2">The database will be configured to automatically assign a key when a new row is stored, and so using the </span><code class="inlinecode"><span class="kobospan" id="kobo.741.1">CreationOptional&lt;number&gt;</span></code><span class="kobospan" id="kobo.742.1"> type will prevent TypeScript from reporting an error when a </span><code class="inlinecode"><span class="kobospan" id="kobo.743.1">Person</span></code><span class="kobospan" id="kobo.744.1"> object is created without an </span><code class="inlinecode"><span class="kobospan" id="kobo.745.1">id</span></code><span class="kobospan" id="kobo.746.1"> value.</span></p>
<p class="normal"><span class="kobospan" id="kobo.747.1">The base </span><a id="_idIndexMarker607" class="calibre3"/><span class="kobospan" id="kobo.748.1">class is used to build a list of the properties defined by the class, which are used to enforce type safety when data is read or written:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.749.1">...
</span><strong class="screentext"><span class="kobospan" id="kobo.750.1">export class Person extends Model&lt;InferAttributes&lt;Person</span></strong><strong class="screentext"><span class="kobospan" id="kobo.751.1">&gt;,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.752.1">        InferCreationAttributes&lt;Person&gt;&gt; {</span></strong><span class="kobospan" id="kobo.753.1">
    declare id?: CreationOptional&lt;number&gt;;
    declare name: string
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.754.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.755.1">InferAttributes&lt;Person&gt;</span></code><span class="kobospan" id="kobo.756.1"> type selects all of the properties defined by the </span><code class="inlinecode"><span class="kobospan" id="kobo.757.1">Person</span></code><span class="kobospan" id="kobo.758.1"> class, while the </span><code class="inlinecode"><span class="kobospan" id="kobo.759.1">InferCreationAttributes&lt;Person&gt;</span></code><span class="kobospan" id="kobo.760.1"> type excludes the properties whose type is </span><code class="inlinecode"><span class="kobospan" id="kobo.761.1">CreationOptional&lt;T&gt;</span></code><span class="kobospan" id="kobo.762.1">. </span><span class="kobospan" id="kobo.762.2">The model classes also contain properties for representing relationships between tables in the database:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.763.1">...
</span><span class="kobospan" id="kobo.763.2">export class ResultModel extends Model&lt;InferAttributes&lt;ResultModel&gt;,
        InferCreationAttributes&lt;ResultModel&gt;&gt; {
    declare id: CreationOptional&lt;number&gt;;          
</span><strong class="screentext"><span class="kobospan" id="kobo.764.1">    declare personId: ForeignKey&lt;Person["id"]&gt;;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.765.1">    declare calculationId: ForeignKey&lt;Calculation["id"]&gt;;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.766.1">    declare Person?: InferAttributes&lt;Person&gt;;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.767.1">    declare Calculation?: InferAttributes&lt;Calculation&gt;;</span></strong><span class="kobospan" id="kobo.768.1">
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.769.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.770.1">personId</span></code><span class="kobospan" id="kobo.771.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.772.1">calculationId</span></code><span class="kobospan" id="kobo.773.1"> properties will store the primary keys of related data, while</span><a id="_idIndexMarker608" class="calibre3"/><span class="kobospan" id="kobo.774.1"> the </span><code class="inlinecode"><span class="kobospan" id="kobo.775.1">Person</span></code><span class="kobospan" id="kobo.776.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.777.1">Calculation</span></code><span class="kobospan" id="kobo.778.1"> properties will be populated with objects created by Sequelize, as part of the process of making data available as objects.</span></p>
<h3 class="heading2" id="_idParaDest-217"><span class="kobospan" id="kobo.779.1">Initializing the data model</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.780.1">The </span><a id="_idIndexMarker609" class="calibre3"/><span class="kobospan" id="kobo.781.1">next step is to tell Sequelize how each property defined by the model classes should be represented in the database. </span><span class="kobospan" id="kobo.781.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.782.1">orm_helpers.ts</span></code><span class="kobospan" id="kobo.783.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.784.1">src/server/data</span></code><span class="kobospan" id="kobo.785.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.786.1">Listing 12.24</span></em><span class="kobospan" id="kobo.787.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.788.1">Listing 12.24: The contents of the orm_helpers.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.789.1">import { DataTypes, Sequelize } from "sequelize";
import { Calculation, Person, ResultModel } from "./orm_models";
const primaryKey = {
    id: {
        type: DataTypes.INTEGER,
        autoIncrement: true,
        primaryKey: true
    }       
};
export const initializeModels = (sequelize: Sequelize) =&gt; {
    Person.init({
        ...primaryKey,
        name: { type: DataTypes.STRING }
    }, { sequelize });
    Calculation.init({
        ...primaryKey,
        age: { type: DataTypes.INTEGER},
        years: { type: DataTypes.INTEGER},
        nextage: { type: DataTypes.INTEGER},
    }, { sequelize });
    ResultModel.init({
        ...primaryKey,
    }, { sequelize });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.790.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.791.1">Model</span></code><span class="kobospan" id="kobo.792.1"> base class used in </span><em class="italic"><span class="kobospan" id="kobo.793.1">Listing 12.24</span></em><span class="kobospan" id="kobo.794.1"> defines the </span><code class="inlinecode"><span class="kobospan" id="kobo.795.1">init</span></code><span class="kobospan" id="kobo.796.1"> method, which accepts </span><a id="_idIndexMarker610" class="calibre3"/><span class="kobospan" id="kobo.797.1">an object whose properties correspond to those defined by the class. </span><span class="kobospan" id="kobo.797.2">Each property is assigned a configuration object that tells Sequelize how to represent the data in the database.</span></p>
<p class="normal"><span class="kobospan" id="kobo.798.1">All three model classes have an </span><code class="inlinecode"><span class="kobospan" id="kobo.799.1">id</span></code><span class="kobospan" id="kobo.800.1"> property that is configured as the primary key. </span><span class="kobospan" id="kobo.800.2">For the other properties, a value from the </span><code class="inlinecode"><span class="kobospan" id="kobo.801.1">DataTypes</span></code><span class="kobospan" id="kobo.802.1"> class is selected to specify the SQL data type that will be used when the database is created.</span></p>
<p class="normal"><span class="kobospan" id="kobo.803.1">The second argument accepted by the </span><code class="inlinecode"><span class="kobospan" id="kobo.804.1">init</span></code><span class="kobospan" id="kobo.805.1"> method is used to configure the overall data model. </span><span class="kobospan" id="kobo.805.2">Only the </span><code class="inlinecode"><span class="kobospan" id="kobo.806.1">sequelize</span></code><span class="kobospan" id="kobo.807.1"> property is specified in </span><em class="italic"><span class="kobospan" id="kobo.808.1">Listing 12.24</span></em><span class="kobospan" id="kobo.809.1">, which is a </span><code class="inlinecode"><span class="kobospan" id="kobo.810.1">Sequelize</span></code><span class="kobospan" id="kobo.811.1"> object that will be created to manage the database. </span><span class="kobospan" id="kobo.811.2">Other options are available, allowing the name of the database table to be changed, setting up database triggers, and configuring other database features.</span></p>
<h3 class="heading2" id="_idParaDest-218"><span class="kobospan" id="kobo.812.1">Configuring the model relationships</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.813.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.814.1">Model</span></code><span class="kobospan" id="kobo.815.1"> base </span><a id="_idIndexMarker611" class="calibre3"/><span class="kobospan" id="kobo.816.1">class provides methods to describe the relationships between model classes, as shown in </span><em class="italic"><span class="kobospan" id="kobo.817.1">Listing 12.25</span></em><span class="kobospan" id="kobo.818.1">.</span><span> </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.819.1">Listing 12.25: Defining model relationships in the orm_helpers.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.820.1">import { DataTypes, Sequelize } from "sequelize";
import { Calculation, Person, ResultModel } from "./orm_models";
const primaryKey = {
    id: {
        type: DataTypes.INTEGER,
        autoIncrement: true,
        primaryKey: true
    }       
};
export const initializeModels = (sequelize: Sequelize) =&gt; {
    // ...statements omitted for brevity...
</span><span class="kobospan" id="kobo.820.2">}
</span><strong class="screentext"><span class="kobospan" id="kobo.821.1">export const defineRelationships = () =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.822.1">    ResultModel.belongsTo(Person, { foreignKey: "personId" });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.823.1">    ResultModel.belongsTo</span></strong><strong class="screentext"><span class="kobospan" id="kobo.824.1">(Calculation, { foreignKey: "calculationId"});</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.825.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.826.1">Sequelize defines four kinds of </span><em class="italic"><span class="kobospan" id="kobo.827.1">association</span></em><span class="kobospan" id="kobo.828.1">, which are used to describe the relationship between data model classes, as described in </span><em class="italic"><span class="kobospan" id="kobo.829.1">Table 12.4</span></em><span class="kobospan" id="kobo.830.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.831.1">Table 12.4: The Sequelize association methods</span></p>
<table class="table-container" id="table005-5">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.832.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.833.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.834.1">hasOne(T, options)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.835.1">This method denotes a one-to-one relationship between the model class and </span><code class="inlinecode"><span class="kobospan2" id="kobo.836.1">T</span></code><span class="kobospan" id="kobo.837.1">, with the foreign key defined on </span><code class="inlinecode"><span class="kobospan2" id="kobo.838.1">T</span></code><span class="kobospan4" id="kobo.839.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.840.1">belongsTo(T, options)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.841.1">This method denotes a one-to-one relationship between the model class and </span><code class="inlinecode"><span class="kobospan2" id="kobo.842.1">T</span></code><span class="kobospan4" id="kobo.843.1">, with the foreign key defined by the model class.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.844.1">hasMany(T, options)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.845.1">This method denotes a one-to-many relationship, with the foreign key defined by </span><code class="inlinecode"><span class="kobospan2" id="kobo.846.1">T</span></code><span class="kobospan4" id="kobo.847.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.848.1">belongsToMany(T, options)</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.849.1">This method denotes a many-to-many relationship using a junction table. </span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.850.1">Each of the methods defined in </span><em class="italic"><span class="kobospan" id="kobo.851.1">Table 12.4</span></em><span class="kobospan" id="kobo.852.1"> accepts an options argument that is used to </span><a id="_idIndexMarker612" class="calibre3"/><span class="kobospan" id="kobo.853.1">configure the relationship. </span><span class="kobospan" id="kobo.853.2">In </span><em class="italic"><span class="kobospan" id="kobo.854.1">Listing 12.25</span></em><span class="kobospan" id="kobo.855.1">, the </span><code class="inlinecode"><span class="kobospan" id="kobo.856.1">foreignKey</span></code><span class="kobospan" id="kobo.857.1"> property is used to specify the foreign key on the </span><code class="inlinecode"><span class="kobospan" id="kobo.858.1">ResultModel</span></code><span class="kobospan" id="kobo.859.1"> class for the one-to-one relationships with the </span><code class="inlinecode"><span class="kobospan" id="kobo.860.1">Person</span></code><span class="kobospan" id="kobo.861.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.862.1">Calculation</span></code><span class="kobospan" id="kobo.863.1"> types. </span><span class="kobospan" id="kobo.863.2">(There are other options, described at </span><a href="https://sequelize.org/api/v6/identifiers.html#associations" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.864.1">https://sequelize.org/api/v6/identifiers.html#associations</span></span></a><span class="kobospan" id="kobo.865.1">, and you can see a more complex example in </span><em class="italic"><span class="kobospan" id="kobo.866.1">Chapter 15</span></em><span class="kobospan" id="kobo.867.1">, which uses a many-to-many relationship.)</span></p>
<h2 class="heading1" id="_idParaDest-219"><span class="kobospan" id="kobo.868.1">Defining the seed data</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.869.1">Although </span><a id="_idIndexMarker613" class="calibre3"/><span class="kobospan" id="kobo.870.1">ORM packages take care of a lot of the details, there can be tasks that are more easily performed simply by executing SQL expressions directly, rather than using JavaScript objects. </span><span class="kobospan" id="kobo.870.2">To demonstrate, </span><em class="italic"><span class="kobospan" id="kobo.871.1">Listing 12.26</span></em><span class="kobospan" id="kobo.872.1"> uses SQL to seed the database. </span><span class="kobospan" id="kobo.872.2">(Later chapters show seeding databases using JavaScript objects so you can compare techniques.)</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.873.1">Listing 12.26: Adding seed data in the orm_helpers.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.874.1">import { DataTypes, Sequelize } from "sequelize";
import { Calculation, Person, ResultModel } from "./orm_models";
import { Result } from "./repository";
const primaryKey = {
    id: {
        type: DataTypes.INTEGER,
        autoIncrement: true,
        primaryKey: true
    }       
};
// ...statements omitted for brevity...
</span><span class="kobospan" id="kobo.874.2">export const defineRelationships = () =&gt; {
    ResultModel.belongsTo(Person, { foreignKey: "personId" });
    ResultModel.belongsTo(Calculation, { foreignKey: "calculationId"});
}
</span><strong class="screentext"><span class="kobospan" id="kobo.875.1">export const addSeedData = async (sequelize: Sequelize</span></strong><strong class="screentext"><span class="kobospan" id="kobo.876.1">) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.877.1">    await sequelize.query(`</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.878.1">        INSERT INTO Calculations</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.879.1">            (id, age, years, nextage, createdAt, updatedAt) VALUES</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.880.1">                (1, 35, 5, 40, date(), date()),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.881.1">                (2, 35, 10, 45, date(), date())`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.882.1">    await sequelize.query(`</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.883.1">        INSERT INTO People (id, name, createdAt, updatedAt) VALUES</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.884.1">            (1, 'Alice', date(), date()), (2, "Bob", date(), date())`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.885.1">    await sequelize.query</span></strong><strong class="screentext"><span class="kobospan" id="kobo.886.1">(`</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.887.1">        INSERT INTO ResultModels</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.888.1">                (calculationId, personId, createdAt, updatedAt) VALUES</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.889.1">            (1, 1, date(), date()), (2, 2, date(), date()),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.890.1">            (2, 1, date(), date());`);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.891.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.892.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.893.1">Sequelize.query</span></code><span class="kobospan" id="kobo.894.1"> method accepts a string containing an SQL statement. </span><span class="kobospan" id="kobo.894.2">The statements in </span><em class="italic"><span class="kobospan" id="kobo.895.1">Listing 12.26</span></em><span class="kobospan" id="kobo.896.1"> create the same seed data used earlier in the chapter but with </span><a id="_idIndexMarker614" class="calibre3"/><span class="kobospan" id="kobo.897.1">the addition of values for </span><code class="inlinecode"><span class="kobospan" id="kobo.898.1">createdAt</span></code><span class="kobospan" id="kobo.899.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.900.1">updatedAt</span></code><span class="kobospan" id="kobo.901.1"> columns. </span><span class="kobospan" id="kobo.901.2">One consequence of using an ORM package to create a database is that additional features and constraints are often introduced and Sequelize adds these columns to keep track of when table rows are created and modified. </span><span class="kobospan" id="kobo.901.3">The queries that create the seed data use the </span><code class="inlinecode"><span class="kobospan" id="kobo.902.1">date()</span></code><span class="kobospan" id="kobo.903.1"> function, which returns the current date and time.</span></p>
<h2 class="heading1" id="_idParaDest-220"><span class="kobospan" id="kobo.904.1">Converting data models to flat objects</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.905.1">Using</span><a id="_idIndexMarker615" class="calibre3"/><span class="kobospan" id="kobo.906.1"> JavaScript objects to represent data can be a more natural development experience, but it can mean that the data model objects are not in the format expected elsewhere in the application. </span><span class="kobospan" id="kobo.906.2">In the case of the example application, the ORM data model objects do not conform to the requirements of the </span><code class="inlinecode"><span class="kobospan" id="kobo.907.1">Result</span></code><span class="kobospan" id="kobo.908.1"> type used by the </span><code class="inlinecode"><span class="kobospan" id="kobo.909.1">Repository</span></code><span class="kobospan" id="kobo.910.1"> interface. </span><span class="kobospan" id="kobo.910.2">One approach would be to modify the interface, but this would undermine the benefit of isolating the database from the rest of the application. </span><em class="italic"><span class="kobospan" id="kobo.911.1">Listing 12.27</span></em><span class="kobospan" id="kobo.912.1"> defines a function that transforms </span><code class="inlinecode"><span class="kobospan" id="kobo.913.1">ResultModel</span></code><span class="kobospan" id="kobo.914.1"> objects provided by the ORM package into </span><code class="inlinecode"><span class="kobospan" id="kobo.915.1">Result</span></code><span class="kobospan" id="kobo.916.1"> objects required by the </span><code class="inlinecode"><span class="kobospan" id="kobo.917.1">Repository</span></code><span class="kobospan" id="kobo.918.1"> interface. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.919.1">Listing 12.27: Transforming data in the orm_helpers.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.920.1">import { DataTypes, Sequelize } from "sequelize";
import { Calculation, Person, ResultModel } from "./orm_models";
</span><strong class="screentext"><span class="kobospan" id="kobo.921.1">import { Result } from "./repository";</span></strong><span class="kobospan" id="kobo.922.1">
const primaryKey = {
    id: {
        type: DataTypes.INTEGER,
        autoIncrement: true,
        primaryKey: true
    }       
};
// ...functions omitted for brevity...
</span><strong class="screentext"><span class="kobospan" id="kobo.923.1">export const fromOrmModel = (model: ResultModel | null) : Result =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.924.1">    return {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.925.1">        id: model?.id || 0</span></strong><strong class="screentext"><span class="kobospan" id="kobo.926.1">,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.927.1">        name: model?.Person?.name || "",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.928.1">        age: model?.Calculation?.age || 0,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.929.1">        years: model?.Calculation</span></strong><strong class="screentext"><span class="kobospan" id="kobo.930.1">?.years || 0,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.931.1">        nextage: model?.Calculation?.nextage || 0</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.932.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.933.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.934.1">This kind </span><a id="_idIndexMarker616" class="calibre3"/><span class="kobospan" id="kobo.935.1">of transformation can seem clunky, but JavaScript makes it easy to compose new objects in this way, and it is a useful technique that eases integration between modules and packages, which is something that most JavaScript projects have to deal with.</span></p>
<h2 class="heading1" id="_idParaDest-221"><span class="kobospan" id="kobo.936.1">Implementing the repository</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.937.1">The </span><a id="_idIndexMarker617" class="calibre3"/><span class="kobospan" id="kobo.938.1">plumbing is all in place and it is time to implement the </span><code class="inlinecode"><span class="kobospan" id="kobo.939.1">Repository</span></code><span class="kobospan" id="kobo.940.1"> interface. </span><span class="kobospan" id="kobo.940.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.941.1">orm_repository.ts</span></code><span class="kobospan" id="kobo.942.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.943.1">src/server/data</span></code><span class="kobospan" id="kobo.944.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.945.1">Listing 12.28</span></em><span class="kobospan" id="kobo.946.1">, which sets up the ORM but doesn’t yet implement queries or store data.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.947.1">Listing 12.28: The contents of the orm_repository.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext"><span class="kobospan" id="kobo.948.1">import { Sequelize } from "sequelize";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.949.1">import { Repository, Result } from</span></strong><strong class="screentext"><span class="kobospan" id="kobo.950.1"> "./repository";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.951.1">import { addSeedData, defineRelationships,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.952.1">    fromOrmModel, initializeModels } from "./orm_helpers";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.953.1">import { Calculation, Person, ResultModel } from "./orm_models"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.954.1">;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.955.1">export class OrmRepository implements Repository {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.956.1">    sequelize: Sequelize;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.957.1">    constructor() {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.958.1">        this.sequelize = new</span></strong><strong class="screentext"><span class="kobospan" id="kobo.959.1"> Sequelize({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.960.1">            dialect: "sqlite",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.961.1">            storage: "orm_age.db",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.962.1">            logging: console.log,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.963.1">            logQueryParameters: true</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.964.1">        });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.965.1">        this.initModelAndDatabase();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.966.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.967.1">    async initModelAndDatabase() : Promise&lt;void&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.968.1">        initializeModels(this.sequelize);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.969.1">        defineRelationships</span></strong><strong class="screentext"><span class="kobospan" id="kobo.970.1">();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.971.1">        await this.sequelize.drop();       </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.972.1">        await this.sequelize.sync();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.973.1">        await addSeedData</span></strong><strong class="screentext"><span class="kobospan" id="kobo.974.1">(this.sequelize);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.975.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.976.1">    async saveResult(r: Result): Promise&lt;number&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.977.1">        throw new Error</span></strong><strong class="screentext"><span class="kobospan" id="kobo.978.1">("Method not implemented.");</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.979.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.980.1">    async getAllResults(limit: number): Promise&lt;Result[]&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.981.1">        throw new Error("Method not implemented."</span></strong><strong class="screentext"><span class="kobospan" id="kobo.982.1">);      </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.983.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.984.1">    async getResultsByName(name: string, limit: number): Promise&lt;Result[]&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.985.1">        throw new Error("Method not implemented."</span></strong><strong class="screentext"><span class="kobospan" id="kobo.986.1">);      </span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.987.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.988.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.989.1">Sequelize supports a range of database engines, including SQLite, and so the first step is to create a </span><code class="inlinecode"><span class="kobospan" id="kobo.990.1">Sequelize</span></code><span class="kobospan" id="kobo.991.1"> object, providing a configuration object that specifies the database engine, and the options for its use. </span><span class="kobospan" id="kobo.991.2">In </span><em class="italic"><span class="kobospan" id="kobo.992.1">Listing 12.28</span></em><span class="kobospan" id="kobo.993.1">, the </span><code class="inlinecode"><span class="kobospan" id="kobo.994.1">dialect</span></code><span class="kobospan" id="kobo.995.1"> option specifies SQLite and the </span><code class="inlinecode"><span class="kobospan" id="kobo.996.1">storage</span></code><span class="kobospan" id="kobo.997.1"> option specifies the name of the file. </span><span class="kobospan" id="kobo.997.2">When using an ORM, it can be useful to see the SQL queries that are generated, which is why the </span><code class="inlinecode"><span class="kobospan" id="kobo.998.1">logging</span></code><span class="kobospan" id="kobo.999.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1000.1">logQueryParameters</span></code><span class="kobospan" id="kobo.1001.1"> options are set.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1002.1">Once a </span><code class="inlinecode"><span class="kobospan" id="kobo.1003.1">Sequelize</span></code><span class="kobospan" id="kobo.1004.1"> object has been created, it can be configured. </span><span class="kobospan" id="kobo.1004.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1005.1">initModelAndDatabase</span></code><span class="kobospan" id="kobo.1006.1"> method calls the </span><code class="inlinecode"><span class="kobospan" id="kobo.1007.1">initializeModels</span></code><span class="kobospan" id="kobo.1008.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1009.1">defineRelationships</span></code><span class="kobospan" id="kobo.1010.1"> functions to configure the data model objects, and then calls these methods:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1011.1">...
</span><span class="kobospan" id="kobo.1011.2">await this.sequelize.drop();       
await this.sequelize.sync();
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1012.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1013.1">drop</span></code><span class="kobospan" id="kobo.1014.1"> method tells Sequelize to drop the tables in the database. </span><span class="kobospan" id="kobo.1014.2">This isn’t something </span><a id="_idIndexMarker618" class="calibre3"/><span class="kobospan" id="kobo.1015.1">that should be done in a real project, but it recreates the earlier examples in this chapter. </span><span class="kobospan" id="kobo.1015.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1016.1">sync</span></code><span class="kobospan" id="kobo.1017.1"> method tells Sequelize to synchronize the database with the data model objects, which has the effect of creating tables for the </span><code class="inlinecode"><span class="kobospan" id="kobo.1018.1">ResultModel</span></code><span class="kobospan" id="kobo.1019.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.1020.1">Person</span></code><span class="kobospan" id="kobo.1021.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.1022.1">Calculation</span></code><span class="kobospan" id="kobo.1023.1"> data. </span><span class="kobospan" id="kobo.1023.2">Once the tables have been created, the </span><code class="inlinecode"><span class="kobospan" id="kobo.1024.1">addSeedData</span></code><span class="kobospan" id="kobo.1025.1"> function is called to add the initial data to the database. </span><span class="kobospan" id="kobo.1025.2">Some of these operations are asynchronous, which is why they are performed with the </span><code class="inlinecode"><span class="kobospan" id="kobo.1026.1">await</span></code><span class="kobospan" id="kobo.1027.1"> keyword inside an </span><code class="inlinecode"><span class="kobospan" id="kobo.1028.1">async</span></code><span class="kobospan" id="kobo.1029.1"> method.</span></p>
<h3 class="heading2" id="_idParaDest-222"><span class="kobospan" id="kobo.1030.1">Querying for data</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.1031.1">Queries in</span><a id="_idIndexMarker619" class="calibre3"/><span class="kobospan" id="kobo.1032.1"> an ORM are made using an API that returns objects, without any direct interaction with the SQL that is sent to the database. </span><span class="kobospan" id="kobo.1032.2">ORM packages have different philosophies about how queries are expressed. </span><span class="kobospan" id="kobo.1032.3">With Sequelize, queries are performed using the data model classes, with methods that are inherited from the </span><code class="inlinecode"><span class="kobospan" id="kobo.1033.1">Model</span></code><span class="kobospan" id="kobo.1034.1"> base class, the most useful of which are described in </span><em class="italic"><span class="kobospan" id="kobo.1035.1">Table 12.5</span></em><span class="kobospan" id="kobo.1036.1">. </span><span class="kobospan" id="kobo.1036.2">(The full set of </span><strong class="screentext"><span class="kobospan" id="kobo.1037.1">Model</span></strong><span class="kobospan" id="kobo.1038.1"> features can be found at </span><a href="https://sequelize.org/api/v6/class/src/model.js~model" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.1039.1">https://sequelize.org/api/v6/class/src/model.js~model</span></span></a><span class="kobospan" id="kobo.1040.1">.) </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1041.1">Table 12.5: Useful Model methods </span></p>
<table class="table-container" id="table006-4">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1042.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1043.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.1044.1">findAll</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1045.1">This method finds all matching records and presents them as model objects. </span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.1046.1">findOne</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1047.1">This method finds the first matching record and presents it as a model object.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.1048.1">findByPk</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1049.1">This method finds the record with a specified primary key.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.1050.1">findOrCreate</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1051.1">This method finds a matching record or creates one if there is no match.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.1052.1">create</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1053.1">This method creates a new record.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.1054.1">update</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1055.1">This method updates data in the database.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.1056.1">upsert</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1057.1">This method updates a single row of data or creates a row if there is no match.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.1058.1">The </span><a id="_idIndexMarker620" class="calibre3"/><span class="kobospan" id="kobo.1059.1">methods in </span><em class="italic"><span class="kobospan" id="kobo.1060.1">Table 12.5</span></em><span class="kobospan" id="kobo.1061.1"> are configured with a configuration object that changes the way the query or update is executed. </span><span class="kobospan" id="kobo.1061.2">The most useful configuration properties are described in </span><em class="italic"><span class="kobospan" id="kobo.1062.1">Table 12.6</span></em><span class="kobospan" id="kobo.1063.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1064.1">Table 12.6: Useful query configuration properties</span></p>
<table class="table-container" id="table007-2">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1065.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1066.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.1067.1">include</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1068.1">This property loads data from related tables by following foreign keys.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.1069.1">where</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.1070.1">This property is used to narrow a query, which is passed to the database using the SQL </span><code class="inlinecode"><span class="kobospan2" id="kobo.1071.1">WHERE</span></code><span class="kobospan4" id="kobo.1072.1"> keyword.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.1073.1">order</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.1074.1">This property configures the query order, which is passed to the database using the SQL </span><code class="inlinecode"><span class="kobospan2" id="kobo.1075.1">ORDER BY</span></code><span class="kobospan4" id="kobo.1076.1"> keywords.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.1077.1">group</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.1078.1">This property specifies query grouping, which is passed to the database using the SQL </span><code class="inlinecode"><span class="kobospan2" id="kobo.1079.1">GROUP BY</span></code><span class="kobospan4" id="kobo.1080.1"> keywords.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.1081.1">limit</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.1082.1">This property specifies the number of records required, which is passed to the database using the SQL </span><code class="inlinecode"><span class="kobospan2" id="kobo.1083.1">LIMIT</span></code><span class="kobospan4" id="kobo.1084.1"> keyword.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.1085.1">transaction</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.1086.1">This property performs the query within the specified transaction, as demonstrated in the </span><em class="italic"><span class="kobospan2" id="kobo.1087.1">Writing data</span></em><span class="kobospan4" id="kobo.1088.1"> section.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.1089.1">attributes</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.1090.1">This property restricts results, so they include only the specified attributes/columns.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.1091.1">Listing 12.29</span></em><span class="kobospan" id="kobo.1092.1"> shows a basic Sequelize query that implements the </span><code class="inlinecode"><span class="kobospan" id="kobo.1093.1">getAllResults</span></code><span class="kobospan" id="kobo.1094.1"> method.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1095.1">Listing 12.29: Performing a Query in the orm_repository.ts File in the src/server/data Folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1096.1">...
</span><span class="kobospan" id="kobo.1096.2">async getAllResults(limit: number): Promise&lt;Result[]&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.1097.1">return (await ResultModel</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1098.1">.findAll({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1099.1">        include: [Person, Calculation],</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1100.1">        limit,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1101.1">        order: [["id", "DESC"]]</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1102.1">    })).map(row =&gt; </span></strong><strong class="screentext"><span class="kobospan" id="kobo.1103.1">fromOrmModel(row));</span></strong><span class="kobospan" id="kobo.1104.1">
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1105.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1106.1">findAll</span></code><span class="kobospan" id="kobo.1107.1"> method</span><a id="_idIndexMarker621" class="calibre3"/><span class="kobospan" id="kobo.1108.1"> is called on the </span><code class="inlinecode"><span class="kobospan" id="kobo.1109.1">ResultModel</span></code><span class="kobospan" id="kobo.1110.1"> class and is configured with an object that has </span><code class="inlinecode"><span class="kobospan" id="kobo.1111.1">include</span></code><span class="kobospan" id="kobo.1112.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.1113.1">limit</span></code><span class="kobospan" id="kobo.1114.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.1115.1">order</span></code><span class="kobospan" id="kobo.1116.1"> properties. </span><span class="kobospan" id="kobo.1116.2">The most important property is </span><code class="inlinecode"><span class="kobospan" id="kobo.1117.1">include</span></code><span class="kobospan" id="kobo.1118.1">, which tells Sequelize to follow foreign key relationships to load related data and create objects from the results. </span><span class="kobospan" id="kobo.1118.2">In this case, the result will be a </span><code class="inlinecode"><span class="kobospan" id="kobo.1119.1">ResultModel</span></code><span class="kobospan" id="kobo.1120.1"> object whose </span><code class="inlinecode"><span class="kobospan" id="kobo.1121.1">Person</span></code><span class="kobospan" id="kobo.1122.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1123.1">Calculation</span></code><span class="kobospan" id="kobo.1124.1"> properties are populated. </span><span class="kobospan" id="kobo.1124.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1125.1">limit</span></code><span class="kobospan" id="kobo.1126.1"> property restricts the number of results, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.1127.1">order</span></code><span class="kobospan" id="kobo.1128.1"> property is used to specify how results are ordered.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1129.1">The query is performed asynchronously, and the result is a </span><code class="inlinecode"><span class="kobospan" id="kobo.1130.1">Promise</span></code><span class="kobospan" id="kobo.1131.1"> that yields an array of </span><code class="inlinecode"><span class="kobospan" id="kobo.1132.1">ResultModel</span></code><span class="kobospan" id="kobo.1133.1"> objects, which are mapped to the </span><code class="inlinecode"><span class="kobospan" id="kobo.1134.1">Result</span></code><span class="kobospan" id="kobo.1135.1"> objects required by the </span><code class="inlinecode"><span class="kobospan" id="kobo.1136.1">Repository</span></code><span class="kobospan" id="kobo.1137.1"> interface using the </span><code class="inlinecode"><span class="kobospan" id="kobo.1138.1">fromOrmModel</span></code><span class="kobospan" id="kobo.1139.1"> function defined in </span><em class="italic"><span class="kobospan" id="kobo.1140.1">Listing 12.27</span></em><span class="kobospan" id="kobo.1141.1">.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1142.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1143.1">where</span></code><span class="kobospan" id="kobo.1144.1"> configuration property can be used to select specific data, as demonstrated in </span><em class="italic"><span class="kobospan" id="kobo.1145.1">Listing 12.30</span></em><span class="kobospan" id="kobo.1146.1">, which implements the </span><code class="inlinecode"><span class="kobospan" id="kobo.1147.1">getResultsByName</span></code><span class="kobospan" id="kobo.1148.1"> method.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1149.1">Listing 12.30: Searching for data in the orm_repository.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1150.1">...
</span><span class="kobospan" id="kobo.1150.2">async getResultsByName(name: string, limit: number): Promise&lt;Result[]&gt; {
</span><strong class="screentext"><span class="kobospan" id="kobo.1151.1">    return</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1152.1"> (await ResultModel.findAll({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1153.1">        include: [Person, Calculation],</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1154.1">        where: {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1155.1">            "$Person.name$": name</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1156.1">        },</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1157.1">        limit, order: [["id"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1158.1">, "DESC"]]</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1159.1">    })).map(row =&gt; fromOrmModel(row));</span></strong><span class="kobospan" id="kobo.1160.1">
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1161.1">This is the </span><a id="_idIndexMarker622" class="calibre3"/><span class="kobospan" id="kobo.1162.1">same query used in </span><em class="italic"><span class="kobospan" id="kobo.1163.1">Listing 12.29</span></em><span class="kobospan" id="kobo.1164.1"> but with the addition of the </span><code class="inlinecode"><span class="kobospan" id="kobo.1165.1">where</span></code><span class="kobospan" id="kobo.1166.1"> property, which tells Sequelize to follow the foreign key relationship and match </span><code class="inlinecode"><span class="kobospan" id="kobo.1167.1">Person</span></code><span class="kobospan" id="kobo.1168.1"> objects using the </span><code class="inlinecode"><span class="kobospan" id="kobo.1169.1">name</span></code><span class="kobospan" id="kobo.1170.1"> property. </span><span class="kobospan" id="kobo.1170.2">The syntax for the </span><code class="inlinecode"><span class="kobospan" id="kobo.1171.1">where</span></code><span class="kobospan" id="kobo.1172.1"> property can take some getting used to, but you will see additional examples in later chapters.</span></p>
<h3 class="heading2" id="_idParaDest-223"><span class="kobospan" id="kobo.1173.1">Writing data</span></h3>
<p class="normal1"><em class="italic"><span class="kobospan" id="kobo.1174.1">Listing 12.31</span></em><span class="kobospan" id="kobo.1175.1"> completes </span><a id="_idIndexMarker623" class="calibre3"/><span class="kobospan" id="kobo.1176.1">the repository by implementing the </span><code class="inlinecode"><span class="kobospan" id="kobo.1177.1">saveResult</span></code><span class="kobospan" id="kobo.1178.1"> method, which only stores </span><code class="inlinecode"><span class="kobospan" id="kobo.1179.1">Person</span></code><span class="kobospan" id="kobo.1180.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1181.1">Calculation</span></code><span class="kobospan" id="kobo.1182.1"> objects if there isn’t already matching data in the database and performs all of its changes using a transaction. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1183.1">Listing 12.31: Writing data in the orm_repository.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1184.1">...
</span><span class="kobospan" id="kobo.1184.2">async saveResult(r: Result): Promise&lt;number&gt; {
   </span><strong class="screentext"><span class="kobospan" id="kobo.1185.1"> return await this.sequelize.transaction(async (tx) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1186.1">        const [person] = await Person.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1187.1">findOrCreate({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1188.1">            where: { name : r.name},</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1189.1">            transaction: tx</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1190.1">        });</span></strong>
<strong class="screentext"> </strong>
<strong class="screentext"><span class="kobospan" id="kobo.1191.1">        const [calculation] = await Calculation.findOrCreate({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1192.1">            where: {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1193.1">                age: r.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.1194.1">age, years: r.years, nextage: r.nextage</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1195.1">            },</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1196.1">            transaction: tx</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1197.1">        });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1198.1">        return (await ResultModel.create({</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.1199.1">personId: person.id, calculationId: calculation.id},</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1200.1">        {transaction: tx})).id;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1201.1">    });      </span></strong><span class="kobospan" id="kobo.1202.1"> 
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1203.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1204.1">transaction</span></code><span class="kobospan" id="kobo.1205.1"> is created with the </span><code class="inlinecode"><span class="kobospan" id="kobo.1206.1">Sequelize.transaction</span></code><span class="kobospan" id="kobo.1207.1"> method, which accepts a callback function that receives a </span><code class="inlinecode"><span class="kobospan" id="kobo.1208.1">Transaction</span></code><span class="kobospan" id="kobo.1209.1"> object. </span><span class="kobospan" id="kobo.1209.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1210.1">transaction</span></code><span class="kobospan" id="kobo.1211.1"> property is used to enroll each operation in the transaction, which will be committed or rolled back automatically.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1212.1">Within the</span><a id="_idIndexMarker624" class="calibre3"/><span class="kobospan" id="kobo.1213.1"> transaction, the </span><code class="inlinecode"><span class="kobospan" id="kobo.1214.1">findOrCreate</span></code><span class="kobospan" id="kobo.1215.1"> method is used to see if there are </span><code class="inlinecode"><span class="kobospan" id="kobo.1216.1">Person</span></code><span class="kobospan" id="kobo.1217.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1218.1">Calculation</span></code><span class="kobospan" id="kobo.1219.1"> objects in the database that match the data received by the </span><code class="inlinecode"><span class="kobospan" id="kobo.1220.1">saveResult</span></code><span class="kobospan" id="kobo.1221.1"> method. </span><span class="kobospan" id="kobo.1221.2">The result is the existing object, if there is one, or the newly created object if there is no match.</span></p>
<p class="normal"><span class="kobospan" id="kobo.1222.1">A new </span><code class="inlinecode"><span class="kobospan" id="kobo.1223.1">ResultModel</span></code><span class="kobospan" id="kobo.1224.1"> object must be stored for every request, and this is done using the </span><code class="inlinecode"><span class="kobospan" id="kobo.1225.1">create</span></code><span class="kobospan" id="kobo.1226.1"> method. </span><span class="kobospan" id="kobo.1226.2">The values for the </span><code class="inlinecode"><span class="kobospan" id="kobo.1227.1">personId</span></code><span class="kobospan" id="kobo.1228.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.1229.1">calculationId</span></code><span class="kobospan" id="kobo.1230.1"> properties are set using the results from the </span><code class="inlinecode"><span class="kobospan" id="kobo.1231.1">findOrCreate</span></code><span class="kobospan" id="kobo.1232.1"> method and the write operation is enrolled in the transaction. </span><span class="kobospan" id="kobo.1232.2">No value is required for the </span><code class="inlinecode"><span class="kobospan" id="kobo.1233.1">id</span></code><span class="kobospan" id="kobo.1234.1"> property, which will be assigned by the database when the new data is stored, and which is contained in the result of the </span><code class="inlinecode"><span class="kobospan" id="kobo.1235.1">create</span></code><span class="kobospan" id="kobo.1236.1"> method.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.1237.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.1238.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.1239.1">create</span></code><span class="kobospan" id="kobo.1240.1"> method allows objects to be created and stored in a single step. </span><span class="kobospan" id="kobo.1240.2">An alternative is to use the </span><code class="inlinecode"><span class="kobospan" id="kobo.1241.1">build</span></code><span class="kobospan" id="kobo.1242.1"> method, which creates a model object that isn’t stored until the </span><code class="inlinecode"><span class="kobospan" id="kobo.1243.1">save</span></code><span class="kobospan" id="kobo.1244.1"> method is called, which allows changes to be made before data is written to the database.</span></p>
</div>
<h3 class="heading2" id="_idParaDest-224"><span class="kobospan" id="kobo.1245.1">Applying the repository</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.1246.1">The benefit of </span><a id="_idIndexMarker625" class="calibre3"/><span class="kobospan" id="kobo.1247.1">using a repository is that the details of how data is stored can be changed without affecting the parts of the application that use that data. </span><span class="kobospan" id="kobo.1247.2">To complete the transition to the ORM package, </span><em class="italic"><span class="kobospan" id="kobo.1248.1">Listing 12.32</span></em><span class="kobospan" id="kobo.1249.1"> replaces the existing repository with the ORM.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.1250.1">Listing 12.32: Using the ORM repository in the index.ts file in the src/server/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.1251.1">import { Repository } from "./repository";
</span><strong class="screentext"><span class="kobospan" id="kobo.1252.1">//import { SqlRepository } from "./sql_repository";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1253.1">import { OrmRepository } from "./orm_repository";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.1254.1">const repository: Repository = </span></strong><strong class="screentext"><span class="kobospan" id="kobo.1255.1">new OrmRepository();</span></strong><span class="kobospan" id="kobo.1256.1">
export default repository;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.1257.1">No other changes are required because the repository isolates data management from the templates and request handling code. </span><span class="kobospan" id="kobo.1257.2">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.1258.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.1259.1"> and you will see the seed data. </span><span class="kobospan" id="kobo.1259.2">Fill out and submit the form and you will see the response shown in </span><em class="italic"><span class="kobospan" id="kobo.1260.1">Figure 12.6</span></em><span class="kobospan" id="kobo.1261.1">, showing that data has been stored in the database. </span><span class="kobospan" id="kobo.1261.2">If you examine the Node.js console output, you will see the SQL queries that </span><code class="inlinecode"><span class="kobospan" id="kobo.1262.1">Sequelize</span></code><span class="kobospan" id="kobo.1263.1"> is formulating from the operations performed on the data model objects.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.1264.1"><img alt="" src="../Images/B21959_12_06.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.1265.1">Figure 12.6: Using an ORM package</span></p>
<h1 class="heading" id="_idParaDest-225"><span class="kobospan" id="kobo.1266.1">Summary</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.1267.1">In this chapter, I explained how a JavaScript web application can use a database, both directly using SQL and indirectly using an ORM package.</span></p>
<ul class="calibre4">
<li class="bulletlist"><span class="kobospan" id="kobo.1268.1">Databases are the most common choice for persistent data storage.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1269.1">Node.js can be used with popular database engines, for which there is a wide range of open-source packages.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1270.1">Databases can be used directly or through packages that express data as objects and generate queries automatically.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.1271.1">A basic knowledge of how databases work and the ability to understand the core SQL syntax makes it easier to work with databases, even when an ORM package is used.</span></li>
</ul>
<p class="normal"><span class="kobospan" id="kobo.1272.1">In the next chapter, I will describe how related HTTP requests can be identified to create sessions.</span></p>
</div>
</body></html>