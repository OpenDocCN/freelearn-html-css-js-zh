<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;6.&#xA0;Deployment"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06" class="calibre1"/>Chapter 6. Deployment</h1></div></div></div><p class="calibre7">This chapter will cover the steps needed to make our web application live. Also, you will learn how to set up an SSL certificate and how to track errors occurring in production actively. This chapter will cover the following topics:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Setting up Modulus.io</li><li class="listitem">Setting up Compose.io</li><li class="listitem">Automatic error tracking</li><li class="listitem">Setting up an SSL certificate</li></ul></div></div>

<div class="book" title="Chapter&#xA0;6.&#xA0;Deployment">
<div class="book" title="Setting up Modulus"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch06lvl1sec36" class="calibre1"/>Setting up Modulus</h1></div></div></div><p class="calibre7">Modulus <a id="id393" class="calibre1"/>is currently the best place to host a Meteor project. Why? It is easy to set up and maintain. While there are several other services where we can obtain the same results, every single one of them requires more expertise with servers and a considerable amount of time on your end. We are not developing a server. We are developing an application.</p><p class="calibre7">Modulus.io provides <a id="id394" class="calibre1"/>support for sticky sessions, web sockets, and free SSL endpoints.</p><p class="calibre7">Keep in mind that Meteor's Galaxy hosting service is going to be released soon and will undoubtedly become the best place to host a Meteor web application. Until then, Modulus is the way to go.</p><p class="calibre7">Let's start by creating a free <a id="id395" class="calibre1"/>account at <a class="calibre1" href="http://modulus.io">http://modulus.io</a>:</p><div class="mediaobject"><img src="../images/00005.jpeg" alt="Setting up Modulus" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Next, you need to install <a id="id396" class="calibre1"/>the <code class="email">demeteorizer</code> tool and the <code class="email">modulus CLI</code> tool. Run the following commands in your terminal:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">npm install –g demeteorizer</strong></span>
<span class="strong"><strong class="calibre2">npm install –g modulus</strong></span>
</pre></div><p class="calibre7">This did not work! If your <code class="email">npm install</code> command fails, then you need to install <code class="email">node</code> and <code class="email">npm</code>.</p><p class="calibre7">To make sure that we install <code class="email">npm</code> properly, we need to add <code class="email">homebrew</code> first. Install this by running this command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"</strong></span>
</pre></div><p class="calibre7">Once this is done, run this command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">brew install node</strong></span>
</pre></div><p class="calibre7">When this command finishes installing everything, we will have both <code class="email">node</code> and <code class="email">npm</code> available globally from our command line.</p><p class="calibre7">Now we can install both <code class="email">demeteorizer</code> and <code class="email">modulus</code> easily:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">npm install –g demeteorizer</strong></span>
<span class="strong"><strong class="calibre2">npm install –g modulus</strong></span>
</pre></div><p class="calibre7">Excellent. Now we have<a id="id397" class="calibre1"/> all the tools that we need. Let's create a new project (if you want to feel like a pro, you can use the CLI too):</p><div class="mediaobject"><img src="../images/00006.jpeg" alt="Setting up Modulus" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Make sure to select <span class="strong"><strong class="calibre2">Node.JS</strong></span> as the runtime environment for the project and set the size of memory of the servo to <span class="strong"><strong class="calibre2">192MB</strong></span>. If you find there is a lot of traffic coming in, you can increase the memory of the server at any time to scale your application easily.</p><div class="mediaobject"><img src="../images/00007.jpeg" alt="Setting up Modulus" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Once you have created<a id="id398" class="calibre1"/> your servo, go to the <span class="strong"><strong class="calibre2">ADMINISTRATION</strong></span> tab:</p><div class="mediaobject"><img src="../images/00008.jpeg" alt="Setting up Modulus" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Now copy the URL that has been generated for the project found next to the <span class="strong"><strong class="calibre2">Your Project URL</strong></span> text:</p><div class="mediaobject"><img src="../images/00009.jpeg" alt="Setting up Modulus" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Scroll all the way to<a id="id399" class="calibre1"/> the end of the page to the <span class="strong"><strong class="calibre2">ENVIRONMENT VARIABLES</strong></span>. The first thing that we need to do is set the <code class="email">ROOT_URL</code> environment variable. Paste the project URL here. Make sure it has the <code class="email">https</code> protocol. Here, we are taking advantage of Modulus' secure SSL endpoint. The <code class="email">wizonesolutions:canonical</code> package will make sure that all routes will hit our <code class="email">ROOT_URL</code>:</p><div class="mediaobject"><img src="../images/00010.jpeg" alt="Setting up Modulus" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Next, we need to set up our database. We cannot deploy this yet because the application is not aware of <a id="id400" class="calibre1"/>where it is supposed to save information.</p></div></div>
<div class="book" title="Setting up Compose"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec37" class="calibre1"/>Setting up Compose</h1></div></div></div><p class="calibre7">Although Modulus.io offers<a id="id401" class="calibre1"/> MongoDB hosting, Modulus does not grant access to Meteor's <span class="strong"><strong class="calibre2">oplog tailing</strong></span> feature<a id="id402" class="calibre1"/> and does not have any support for multiple replica sets. Both these features are must-haves for production and this is why.</p><p class="calibre7">A MongoDB Replica Set<a id="id403" class="calibre1"/> is an exact copy of your database. When you first create a database in Compose, you are automatically given a primary Replica Set with a secondary Replica Set to support it. Since failures happen, the secondary Replica Set exists to replace the primary replica set immediately when the primary fails. In the database world, this is known as data redundancy.</p><p class="calibre7">This layer of security adds an interesting problem; how do the secondary databases know about the changes that are happening to the primary? The operations log, or oplog for short, is a special collection that Mongo uses to record all the changes that are being made to the database. These changes are read by the Replica Sets to reflect all necessary changes.</p><p class="calibre7">Great, now let's understand how Meteor uses the oplog. Meteor's default <code class="email">poll</code> and <code class="email">diff</code> method of watching changes in the database is slow. It works by comparing changes between the database and the client every 10 seconds. This creates multiple unnecessary hits on your database by default and is not fast (since a change can occur 9 seconds before Meteor looks for changes) as well. To make Meteor perform better, the Meteor team tapped into Mongo's oplog. By listening for changes in Mongo's oplog, Meteor knows exactly when and which changes to push to the client. This is called oplog tailing.</p><p class="calibre7">Oplog tailing drastically improves Meteor's reactivity performance by effectively tailing Mongo's operations log. It is guaranteed that a production app will not run smoothly without taking advantage of this feature.</p><p class="calibre7">Create your account with <code class="email">compose.io</code>:</p><div class="mediaobject"><img src="../images/00011.jpeg" alt="Setting up Compose" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Now create a new <a id="id404" class="calibre1"/>MongoDB:</p><div class="mediaobject"><img src="../images/00012.jpeg" alt="Setting up Compose" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Now click the <span class="strong"><strong class="calibre2">Users</strong></span> tab. Here, we need to add a user that will have access to the database and the oplog. This is the user that Modulus will use. In the following example, we are setting the user to <code class="email">root</code>, the password to <code class="email">root</code>, and <code class="email">oplog access</code> to <code class="email">true</code>:</p><div class="mediaobject"><img src="../images/00013.jpeg" alt="Setting up Compose" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Click on the <span class="strong"><strong class="calibre2">Admin</strong></span> tab. Copy the database URI that you see displayed under <span class="strong"><strong class="calibre2">Replica Set URI</strong></span>:</p><div class="mediaobject"><img src="../images/00014.jpeg" alt="Setting up Compose" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Notice the <code class="email">&lt;user&gt;</code> and <code class="email">&lt;password&gt;</code> sections of the string. We are going to replace these fields with the user<a id="id405" class="calibre1"/> credentials that we had defined previously.</p><p class="calibre7">Go back to Modulus.io and visit the project's <span class="strong"><strong class="calibre2">ADMINISTRATION</strong></span> page. Scroll to the <span class="strong"><strong class="calibre2">ENVIRONMENT VARIABLES</strong></span> section. Here, we need to add the URI that we had just copied in to two different variables: <code class="email">MONGO_URL</code> and <code class="email">MONGO_OPLOG_URL</code>.</p><p class="calibre7">The <code class="email">MONGO_URL</code> will look like this:</p><div class="informalexample"><pre class="programlisting">mongodb://root:root@candidate.1.mongolayer.com:10197,candidate.13.mongolayer.com:10810/online_shop</pre></div><p class="calibre7">Notice that you can remove the query parameters (anything after and including the question mark).</p><p class="calibre7">The <code class="email">MONGO_OPLOG_URL</code> will look like this:</p><div class="informalexample"><pre class="programlisting">mongodb://root:root@candidate.1.mongolayer.com:10197,candidate.13.mongolayer.com:10810/local?authSource=online_shop</pre></div><p class="calibre7">Notice that we have modified the information after the trailing slash to <code class="email">/local?authSource=online_shop</code> where <code class="email">online_shop</code> is the name of the database.</p><p class="calibre7">Excellent! This is the last time we will have to configure anything for our project's deployment. Now we can use the <code class="email">modulus</code> CLI to deploy.</p><p class="calibre7">Go to your terminal and run the following command to log in to your user:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">modulus login</strong></span>
</pre></div><p class="calibre7">If you use your GitHub account to create your Modulus account, then pass the <code class="email">github</code> flag:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">modulus login --github</strong></span>
</pre></div><p class="calibre7">Follow the<a id="id406" class="calibre1"/> instructions on the command line. Once you are logged in, you will need to make sure that you are in your Meteor project's <code class="email">root</code> directory (where you run the Meteor command). From here, run the following command to deploy to your new server:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">modulus deploy</strong></span>
</pre></div><p class="calibre7">Modulus will ask which project you want to deploy to and begin. What does Modulus do? It first identifies that the project is a Meteor project, then it runs <span class="strong"><strong class="calibre2">demeteorizer</strong></span>
<a id="id407" class="calibre1"/> to convert the project into a common Node.js app. This app is then deployed to the server and automatically initiated.</p></div>
<div class="book" title="Setting up Kadira"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec38" class="calibre1"/>Setting up Kadira</h1></div></div></div><p class="calibre7">Perfect! Now that we can deploy production quality web applications, we need to understand how to identify issues with them. This is where <code class="email">kadira.io</code> comes into the picture. Kadira<a id="id408" class="calibre1"/> is a Meteor-specific performance and error-monitoring tool. It will collect <code class="email">Meteor.Errors</code> triggered on both the client and the server. It will also show performance data for publishers and subscribers.</p><p class="calibre7">Kadira does this and more, and the starting plan is completely free. Let's begin by signing up. After you have signed up, you need to create a new app:</p><div class="mediaobject"><img src="../images/00015.jpeg" alt="Setting up Kadira" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Decide a name for the app, and enter the same in the field, and click on <span class="strong"><strong class="calibre2">Create App</strong></span>:</p><div class="mediaobject"><img src="../images/00016.jpeg" alt="Setting up Kadira" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Once created, you <a id="id409" class="calibre1"/>will see a view like this:</p><div class="mediaobject"><img src="../images/00017.jpeg" alt="Setting up Kadira" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">To finish, you <a id="id410" class="calibre1"/>will need to copy the code in step 2 and install the <code class="email">meteorhacks:kadira</code> and <code class="email">meteorhacks:zones</code> packages:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">meteor add meteorhacks:kadira</strong></span>
<span class="strong"><strong class="calibre2">meteor add meteorhacks:zones</strong></span>
</pre></div><p class="calibre7">The <code class="email">meteorhacks:zones</code> package improves the description of the errors from the client side. Kadira will take advantage of this package automatically. It is important to note that the <code class="email">meteorhacks:zones</code> package is optional because it is still in active development and can cause strange behavior in Meteor. Now, let's create a configuration file for Kadira:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2"># /_globals/server/kadira.coffee</strong></span>

if process.env.NODE_ENV is "production"
  Kadira.connect 'appId', 'secret'</pre></div><p class="calibre7">We are done! With this simple configuration, we can now easily track application errors and more on Kadira:</p><div class="mediaobject"><img src="../images/00018.jpeg" alt="Setting up Kadira" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">You will notice the <a id="id411" class="calibre1"/>
<span class="strong"><strong class="calibre2">Errors</strong></span> tab on the top-left side of the screen. This tab will show us a list of all the errors that will occur in our application. Have a look at <code class="email">meteorhacks</code> and their academy to learn more about optimizing your Meteor web application.</p></div>
<div class="book" title="Setting up an SSL certificate"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec39" class="calibre1"/>Setting up an SSL certificate</h1></div></div></div><p class="calibre7">
<span class="strong"><strong class="calibre2">SSL</strong></span>, or <span class="strong"><strong class="calibre2">Secure Sockets Layer</strong></span>, is a technology that creates<a id="id412" class="calibre1"/> an encrypted connection between clients and the server. This is necessary if we want to ensure that the data transferred to our server is <a id="id413" class="calibre1"/>encrypted; this includes data such as credit card information.</p><p class="calibre7">Setting up SSL can be painful because it requires some command-line knowledge. We like to buy our SSL certificates<a id="id414" class="calibre1"/> from <a class="calibre1" href="https://www.namecheap.com/">https://www.namecheap.com/</a> because they are cheap and they get the job done.</p><p class="calibre7">The cheapest SSL certificate that you can get is <a id="id415" class="calibre1"/>
<span class="strong"><strong class="calibre2">PositiveSSL</strong></span>; you can find the offering at<a id="id416" class="calibre1"/> this endpoint: <a class="calibre1" href="https://www.namecheap.com/security/ssl-certificates/single-domain.aspx">https://www.namecheap.com/security/ssl-certificates/single-domain.aspx</a>.</p><p class="calibre7">After buying the<a id="id417" class="calibre1"/> certificate, you will need to generate a <a id="id418" class="calibre1"/>
<span class="strong"><strong class="calibre2">Certificate Signing Request</strong></span> (<span class="strong"><strong class="calibre2">CSR</strong></span>). Let's do this. You will be first redirected to your <span class="strong"><strong class="calibre2">Purchase Summary</strong></span>. Click on <span class="strong"><strong class="calibre2">Manage</strong></span>:</p><div class="mediaobject"><img src="../images/00019.jpeg" alt="Setting up an SSL certificate" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Now click <span class="strong"><strong class="calibre2">Activate Now</strong></span> and leave the window open:</p><div class="mediaobject"><img src="../images/00020.jpeg" alt="Setting up an SSL certificate" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Next, open up a terminal at your project directory, and create a <code class="email">/.csr</code> directory by running:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">mkdir .csr</strong></span>
<span class="strong"><strong class="calibre2">cd .csr</strong></span>
</pre></div><p class="calibre7">Now, let's use <code class="email">openssl</code> to create our CSR. Run this command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">openssl req -nodes -newkey rsa:2048 -keyout private.key -out server.csr</strong></span>
</pre></div><p class="calibre7">This will give you a prompt for your site contact information; all the information fields must be filled out with your company or your information. The most important field is the <span class="strong"><strong class="calibre2">Common name</strong></span> field, which must be <code class="email">www.yourdomain.com</code>. Including the <code class="email">www</code> will secure both <code class="email">www.yourdomain.com</code> and <code class="email">yourdomain.com</code>.</p><p class="calibre7">The command has<a id="id419" class="calibre1"/> created a <code class="email">private.key</code> file and a <code class="email">server.csr</code> file; you can check this by running:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">ls</strong></span>
</pre></div><p class="calibre7">Keep <code class="email">private.key</code> somewhere safe! You will need this later. Now open the <code class="email">server.csr</code> file with any text editor such as Sublime, Atom, or, if you prefer something more basic, you can use nano or vim. You can view the contents of the current directory folder by running:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">open .</strong></span>
</pre></div><p class="calibre7">Copy all the text in this file. This should look like this:</p><div class="informalexample"><pre class="programlisting">-----BEGIN CERTIFICATE REQUEST-----
A bunch of letters and numbers
-----END CERTIFICATE REQUEST-----</pre></div><p class="calibre7">Go to namecheap, and change the select box to <span class="strong"><strong class="calibre2">Other</strong></span> and paste the CSR to namecheap's <span class="strong"><strong class="calibre2">Enter csr</strong></span> textarea field. This should look like this:</p><div class="mediaobject"><img src="../images/00021.jpeg" alt="Setting up an SSL certificate" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Now fill out the approver information:</p><div class="mediaobject"><img src="../images/00022.jpeg" alt="Setting up an SSL certificate" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Make sure that the<a id="id420" class="calibre1"/> e-mail you select is active and under your control! If you cannot receive e-mails from the e-mail that you have selected, you will not be able to apply the SSL certificate to your webapp! In the next screen, simply submit your order and wait for the <span class="strong"><strong class="calibre2">SSL Certificate Validation</strong></span> e-mail to arrive:</p><div class="mediaobject"><img src="../images/00023.jpeg" alt="Setting up an SSL certificate" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Copy your validation code, and click on the <span class="strong"><strong class="calibre2">here</strong></span> link in the e-mail. This will take you to another site where you need to paste the validation code you copied and click on <span class="strong"><strong class="calibre2">Next</strong></span>:</p><div class="mediaobject"><img src="../images/00024.jpeg" alt="Setting up an SSL certificate" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Close the window, and <a id="id421" class="calibre1"/>wait until you receive a new e-mail with a ZIP file. Download the ZIP file and unzip it. This will contain four files: <code class="email">AddTrustExternalCARoot.crt</code>, <code class="email">COMODORSAAddTrustCA.crt</code>, <code class="email">COMODORSADomainValidationSecureServerCA.crt</code>, and <code class="email">www_yourdomain_com.crt</code>.</p><p class="calibre7">Now, we need to use these files to create a Certificate Authority Bundle for Modulus. This is, basically, a concatenated version of all our certificates. Generate this by issuing this command in your command line where the certificates are located:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre2">cat www_yourdomain_com.crt COMODORSADomainValidationSecureServerCA.crt COMODORSAAddTrustCA.crt AddTrustExternalCARoot.crt &gt; certificate_bundle.crt</strong></span>
</pre></div><p class="calibre7">This command will produce a new <code class="email">certificate_bundle.crt</code> directory with all the certificates concatenated.</p><p class="calibre7">Now browse to the <a id="id422" class="calibre1"/>Modulus.io administration page; make sure that you have already pointed your custom URL to your instance of Modulus by adding your domain name to the custom domains list. Click on the plus icon:</p><div class="mediaobject"><img src="../images/00025.jpeg" alt="Setting up an SSL certificate" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Now open the <code class="email">private.key</code> file that was generated together with the CSR, and copy the entire text inside the file. Paste the information to the <span class="strong"><strong class="calibre2">Private Key</strong></span> textarea. Then open the <code class="email">certificate_bundle.crt</code> file, copy the information here, and paste it to the <span class="strong"><strong class="calibre2">Certificate</strong></span> textarea:</p><div class="mediaobject"><img src="../images/00026.jpeg" alt="Setting up an SSL certificate" class="calibre8"/></div><p class="calibre9"> </p><p class="calibre7">Make sure to<a id="id423" class="calibre1"/> point your certificate to the <code class="email">www</code> domain and the <code class="email">non-www</code> domain.</p><p class="calibre7">Now to complete the process, we need to make sure that the <code class="email">wizonesolutions:canonical</code> package routes traffic to the secured domain. Scroll to the <span class="strong"><strong class="calibre2">ENVIRONMENT VARIABLES</strong></span> section, and replace <code class="email">ROOT_URL</code> with your domain starting with the <code class="email">https</code> protocol. Your <code class="email">ROOT_URL</code> should look like this:<code class="email"> https://yourdomain.com</code>.</p><p class="calibre7">You might need to restart your server to make sure that all your settings take effect. Now go to your site, and you will see that you are automatically directed to a properly secured version of your site!</p></div>
<div class="book" title="Summary"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec40" class="calibre1"/>Summary</h1></div></div></div><p class="calibre7">This chapter is straightforward. We learned how to deploy our application to a production server hosted by modulus.io. Also, we learned how to set up our Modulus project to a production quality database server provided by Compose. We chose Compose over Modulus because we can set up oplog tailing for Meteor through it. To help us track application errors, we installed Kadira. Also, we learned how to set up an SSL certificate for our server to secure our site further. With this knowledge, we can build production quality web applications.</p></div></body></html>