<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Securing Your Application</h1></div></div></div><p>In this chapter, you will learn the following topics:</p><div><ul class="itemizedlist"><li class="listitem">Basic safety – turning off <code class="literal">autopublish</code></li><li class="listitem">Basic safety – removing <code class="literal">insecure</code></li><li class="listitem">Securing data transactions with <code class="literal">allow</code> and <code class="literal">deny</code></li><li class="listitem">Hiding data with façades</li><li class="listitem">Protecting the client with <code class="literal">browser-policy</code></li></ul></div><div><div><div><div><h1 class="title"><a id="ch09lvl1sec67"/>Introduction</h1></div></div></div><p>Meteor makes development and prototyping as fast and easy as possible. To accomplish this, there are some default packages installed that have no business in a production application. As you prepare your app for production, you will want to remove the packages that make prototyping easier, and replace them with some security best practices, to make your application more secure. In this chapter, we will go through the baseline security mechanisms needed to prepare an application for production.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec68"/>Basic safety – turning off autopublish</h1></div></div></div><p>Quickly and easily <a id="id483" class="indexterm"/>accessing your data saves you an enormous amount of time when you're prototyping! The <code class="literal">autopublish</code> package, which is installed by default in every newly-created Meteor app, enables you to quickly manage and access your data collections, so that you can churn out great code. When the time comes, however, broadcasting every field in every data collection is inefficient and unsecure. This recipe will show you the basics of removing the <code class="literal">autopublish</code> package, and implementing your own <code class="literal">publish</code>/<code class="literal">subscribe</code> code to keep your app working as intended.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec243"/>Getting ready</h2></div></div></div><p>We will create a very basic application, displaying simple text cards on the screen, and then show the effects of <a id="id484" class="indexterm"/>
<code class="literal">autopublish</code> and <code class="literal">subscribe</code>/<code class="literal">publish</code> on those cards. To do this, we need to create our folder structure, add some basic templates, and add a bit of styling.</p><div><div><div><div><h3 class="title"><a id="ch09lvl3sec19"/>Project setup</h3></div></div></div><p>In a terminal <a id="id485" class="indexterm"/>window, create your root project by entering the following commands:</p><div><pre class="programlisting">
<strong>$ meteor create secure-autopublish</strong>
<strong>$ cd secure-autopublish</strong>
<strong>$ rm secure-autopublish.*</strong>
<strong>$ mkdir {client,server,both}</strong>
<strong>$ meteor</strong>
</pre></div></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec20"/>Creating a basic template</h3></div></div></div><p>In a text editor, create <a id="id486" class="indexterm"/>a file named <code class="literal">collections.js</code> in your <code class="literal">[project root]/both/</code> folder, and add the following line:</p><div><pre class="programlisting">Cards_open = new Mongo.Collection('open');</pre></div><p>Next, create a file named <code class="literal">[project root]/client/main.html</code> and add the following <code class="literal">&lt;template&gt;</code> and <code class="literal">&lt;body&gt;</code> declarations:</p><div><pre class="programlisting">&lt;body&gt;
  &lt;div class="container"&gt;
    {{&gt; open}}
  &lt;/div&gt;
&lt;/body&gt;


&lt;template name="open"&gt;
  &lt;h3 id="new-open"&gt;open:&lt;/h3&gt;
  {{#each opens}}
  &lt;div class="card {{shared}}"&gt;
    &lt;div class="label id"&gt;id&lt;/div&gt;
    &lt;div class="id"&gt;{{_id}}&lt;/div&gt;
    &lt;div class="label text"&gt;text&lt;/div&gt;
    &lt;div class="text"&gt;{{text}}&lt;/div&gt;
    &lt;div class="label owner"&gt;owner&lt;/div&gt;
    &lt;div class="owner"&gt;{{owner}}&lt;/div&gt;
  &lt;/div&gt;
  {{/each}}
&lt;/template&gt;</pre></div><p>We need to add just a little bit of logic for display and creation, and we're ready to move on to styles. Create a new file named <code class="literal">[project root]/client/templatehelpers.js</code>, and add the following <code class="literal">Template.helpers</code> and <code class="literal">Template.events</code> <a id="id487" class="indexterm"/>functions:</p><div><pre class="programlisting">Template.open.helpers({
  opens: function(){
    return Cards_open.find({},{sort:{text:1}}).fetch();
  },
  shared: function(){
    return (this.shared? 'shared':null);
  }
});

Template.open.events({
  'dblclick #new-open' : function(e){
    e.preventDefault();
    var txt = 'open card# ' + Cards_open.find({}).count();
    Cards_open.insert({text:txt});
  },
  'click .text' : function(e){
    e.preventDefault();
    var shrd = (!this.shared);
    Cards_open.update({_id:this._id},{$set:{shared:shrd}});
  },
  'dblclick .id' : function(e){
    e.preventDefault();
    Cards_open.remove({_id:this._id});
  }
});</pre></div></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec21"/>Adding CSS styling</h3></div></div></div><p>We need just a <a id="id488" class="indexterm"/>touch of CSS to make things more visually <a id="id489" class="indexterm"/>appealing. Create a file named <code class="literal">[project root]/client/styles.css</code> and add the following CSS:</p><div><pre class="programlisting">body {
  font-family: 'helvetica neue';
}
.card {
  display: inline-block;
  min-width:10rem;
  height: 10rem;
  border: 2px dashed #ccc;
  border-radius: 0.21rem;
  margin: 0.25rem 0.25rem;
  padding: 0.5rem;
  vertical-align: top;
}

.container {
  width:90%;
  margin: auto;
}

.shared {
  background-color: rgba(25, 121, 36, 0.36);
}

.label {
  font-weight: bold;
  margin: 0.2rem 0;
  padding: 0.1rem;
  padding-left: 0.3rem;
}

.label:hover {
  background-color: rgba(7, 180, 21, 0.76);
  border-radius: 0.2rem;
}</pre></div><p>Your app should now be up and running. Navigate to <code class="literal">http://localhost:3000</code> in a browser, and double click on the <strong>open:</strong> label to create some new cards. Click on the <strong>text</strong> tag in a card to modify the <a id="id490" class="indexterm"/>sharing property (the card will turn green) and <a id="id491" class="indexterm"/>double click on the <strong>id</strong> tag to delete a card. Your screen, after playing with it a bit, will look simlar to the following screenshot:</p><div><img src="img/image00400.jpeg" alt="Adding CSS styling"/></div><p style="clear:both; height: 1em;"> </p><p>If everything is copacetic, we're ready to remove the <code class="literal">autopublish</code> package.</p></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec244"/>How to do it...</h2></div></div></div><p>Proceed with the <a id="id492" class="indexterm"/>following steps to turn off <code class="literal">autopublish</code>:</p><div><ol class="orderedlist arabic"><li class="listitem">In a new terminal window (keep Meteor running!), navigate to your <code class="literal">[project root]</code> and enter the following command:<div><pre class="programlisting">
<strong>$ meteor remove autopublish</strong>
</pre></div><p>The screen on your web page will now show no results, and if you do a count on the <code class="literal">Cards_open</code> collection, even if you have many records created, the count will come back as <strong>0</strong>:</p><div><img src="img/image00401.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">We will now add <code class="literal">publish</code> and <code class="literal">subscribe</code>. The <code class="literal">Cards_open</code> collection still exists. Because we removed the <code class="literal">autopublish</code> package, however, the communication between the client and the server has been severed. To restore it, we need to add a <code class="literal">publish</code> method on the server, and a <code class="literal">subscribe</code> method on the client. Create a file named <code class="literal">[project root]/server/collections-server.js</code> and add the following <code class="literal">publish</code> function call:<div><pre class="programlisting">Meteor.publish('open',function(){
  return Cards_open.find({});
});</pre></div></li><li class="listitem">Now, create a file named <code class="literal">[project root]/client/collections-client.js</code> and add the following <code class="literal">subscribe()</code> function call:<div><pre class="programlisting">Meteor.subscribe('open');</pre></div></li></ol><div></div><p>All done! You have successfully removed the <code class="literal">autopublish</code> package, and re-created the <code class="literal">publish</code>/<code class="literal">subscribe</code> calls necessary to allow the client to still see the <code class="literal">Cards_open</code> collection. Your browser should now display results properly when you create, modify, and delete using the clicks and double clicks mentioned previously.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec245"/>How it works...</h2></div></div></div><p>In a nutshell, <code class="literal">autopublish</code> checks to see what collections exist, and automatically writes your <code class="literal">publish</code> and <code class="literal">subscribe</code> function calls for you. It does this for every collection it can find, and is therefore neither performant nor secure.</p><p>By removing <code class="literal">autopublish</code>, we stopped the <code class="literal">publish</code> and <code class="literal">subscribe</code> functions from automatically being called. Because of this, we had to re-create those calls, creating a simple <code class="literal">publish()</code> call (on channel <code class="literal">'open'</code>) on the server, and a <code class="literal">subscribe()</code> call (on the same <code class="literal">'open'</code> channel) on the client.</p><p>Our <code class="literal">find()</code> statement in the <a id="id493" class="indexterm"/>
<code class="literal">publish</code> function retrieves everything, which is inherently not secure or performant, but we will be fixing that in other recipes. The focus of this recipe was on how to remove the <code class="literal">autopublish</code> package, without affecting the functionality of our application.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec246"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Removing Meteor packages</em> recipe in <a class="link" title="Chapter 2. Customizing with Packages" href="part0028.xhtml#aid-QMFO1">Chapter 2</a>, <em>Customizing with Packages</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec69"/>Basic safety – removing insecure</h1></div></div></div><p>Right after removing <a id="id494" class="indexterm"/>
<code class="literal">autopublish</code>, we will want to control how data is added, removed, and updated, and put in some security measures, as appropriate. To enable this level of control, we need to remove the appropriately-named <code class="literal">insecure</code> package. To restore functionality after removing the <code class="literal">insecure</code> package, we will need to utilize a basic <code class="literal">collection.allow</code> declaration. This recipe shows you how to do exactly that.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec247"/>Getting ready</h2></div></div></div><p>We will use the <em>Basic safety – turning off autopublish</em> recipe found in this chapter as our baseline. Once you have completed that recipe, make a copy of the <code class="literal">secure-autopublish</code> folder (note: you will need all subfolders, including the hidden <code class="literal">.meteor</code> folder), rename it to <code class="literal">secure-rm-insecure</code>, start your app using the <code class="literal">meteor</code> command in the terminal, and you will be ready to proceed.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec248"/>How to do it...</h2></div></div></div><p>Just like the previous recipe for <code class="literal">autopublish</code>, we simply need to remove the <code class="literal">insecure</code> package, and then restore functionality.</p><div><ol class="orderedlist arabic"><li class="listitem">In a new terminal window (keep Meteor running!), navigate to the root of your project and enter the following command:<div><pre class="programlisting">
<strong>$ meteor remove insecure</strong>
</pre></div><p>Your application now disallows any client changes to the <code class="literal">Cards_open</code> collection. Try to add a new card, share a card, or delete a card, and you will be unable to do so. Whether through the UI using clicks and double clicks, or <a id="id495" class="indexterm"/>even programmatically through the web console, you will be unable to make any changes, as shown in the following screenshot:</p><div><img src="img/image00402.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Okay, now we need to get our super powers back! Open the <code class="literal">[project root]/server/collections-server.js</code> file, and add the following code to the bottom of the file:<div><pre class="programlisting">Cards_open.allow({
  insert : function(userId,doc){
    return true;
  },
  update : function(userId,doc,fieldNames,modifier){
    return true;
  },
  remove : function(userId,doc){
    return true;
  }
});</pre></div><p>After saving these changes, our <code class="literal">insert</code>, <code class="literal">update</code>, and <code class="literal">remove</code> capabilities have been restored. You can now add, modify, and delete as many cards as you would like, either through the UI or programmatically through the web console.</p></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec249"/>How it works...</h2></div></div></div><p>The <code class="literal">insecure</code> package does almost exactly the same thing for data collection security that <code class="literal">autopublish</code> does for publish security – it finds every collection it can and automatically creates a <code class="literal">collection.allow</code> function for all functions (<code class="literal">insert</code>, <code class="literal">update</code>, and <code class="literal">remove</code>). By removing the <code class="literal">insecure</code> package, we prevented our <code class="literal">Cards_open</code> collection from allowing any client-side changes.</p><p>To remedy this, and to prepare for more granular security (see later recipes in this chapter for details), we called <code class="literal">Cards_open.allow()</code> and enabled all collection modifications by returning <code class="literal">true</code> for every <a id="id496" class="indexterm"/>checking function.</p><p>So, although the net security of our application hasn't changed, we are now prepared to modify our publishing and security settings to make our application production-ready.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec250"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Removing Meteor packages</em> recipe in <a class="link" title="Chapter 2. Customizing with Packages" href="part0028.xhtml#aid-QMFO1">Chapter 2</a>, <em>Customizing with Packages</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec70"/>Securing data transactions with allow and deny</h1></div></div></div><p>Properly <a id="id497" class="indexterm"/>configured, Meteor collections are quite secure. The granular control we have over what is allowed and what is not allowed enables <a id="id498" class="indexterm"/>us to secure our applications appropriately. In this recipe, you will learn how to use <code class="literal">allow</code> and <code class="literal">deny</code> to secure your collections and control access.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec251"/>Getting ready</h2></div></div></div><p>Using the <em>Basic safety – removing insecure</em> recipe found in this chapter, we already have an application with both the <code class="literal">autopublish</code> and <code class="literal">insecure</code> packages removed. Once we add and configure the appropriate user <code class="literal">accounts</code> packages, we will be ready to proceed.</p><p>Using a copy of the <em>Basic safety – removing insecure</em> recipe as a baseline, open a terminal window, navigate to your project root, and execute the following commands:</p><div><pre class="programlisting">
<strong>$ meteor add accounts-ui</strong>
<strong>$ meteor add accounts-password</strong>
</pre></div><p>If your app isn't already running, make sure to start it using the <code class="literal">meteor</code> command.</p><p>We now need to add the <code class="literal">loginButtons</code> template, and modify our <code class="literal">insert</code> statement, to add an <code class="literal">owner</code> property to each record.</p><p>Open your <code class="literal">[project root]/client/main.html</code> file and add the <code class="literal">loginButtons</code> template inclusion just below the <code class="literal">&lt;body&gt;</code> tag, as shown in the following example:</p><div><pre class="programlisting">&lt;body&gt;
<strong>  {{&gt; loginButtons}}</strong>
  &lt;div class="container"&gt;
    ...</pre></div><p>Next, open your <code class="literal">[project root]/client/templatehelpers.js</code> file and modify the <code class="literal">Template.open.events</code> insert logic to add <code class="literal">owner</code>, and only fire if there is a logged-in user. Your code changes should look as follows:</p><div><pre class="programlisting">Template.open.events({
  'dblclick #new-open' : function(e){
    e.preventDefault();
<strong>    if (!Meteor.userId()) return;</strong>
    var txt = 'open card# ' + Cards_open.find({}).count();
    Cards_open.insert({text:txt <strong>, owner: Meteor.userId()})</strong>;
  },</pre></div><p>Finally, in your browser, create a new user, and make sure you are logged in as that user (the name of the user doesn't matter – we suggest using a fake one such as <code class="literal">user1@test.com</code>).</p><p>Now, whenever you <a id="id499" class="indexterm"/>create new cards, the <strong>owner</strong> section will be filled in with the logged-in user's unique ID, as shown in the following screenshot:</p><div><img src="img/image00403.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec252"/>How to do it...</h2></div></div></div><p>The current state of the application is not secure. Anybody can <code class="literal">insert</code>, <code class="literal">remove</code> and <code class="literal">update</code> any of the <a id="id500" class="indexterm"/>cards, even if they belong to another <a id="id501" class="indexterm"/>user! We are going to fix this situation by using the <code class="literal">collection.allow()</code> and <code class="literal">collection.deny()</code> declarations.</p><div><ol class="orderedlist arabic"><li class="listitem">First, we will require a logged-in user for <code class="literal">insert</code>. Open your <code class="literal">[project root]/server/collections-server.js</code> file, locate the <code class="literal">Cards_open.allow()</code> function call, and make the following modification to the <code class="literal">insert</code> function declaration:<div><pre class="programlisting">Cards_open.allow({
  insert : function(userId,doc){
<strong>    return(userId!=null);</strong>
  },</pre></div><p>You will now no longer be able to create new cards while being logged out (you can test this if you would like).</p></li><li class="listitem">Next, we will allow only the owner of a record to <code class="literal">update</code> or <code class="literal">remove</code> cards. In the same <code class="literal">collections-server.js</code> file, modify the <code class="literal">update</code> and <code class="literal">remove</code> function declarations as follows:<div><pre class="programlisting">update : function(userId,doc,fieldNames,modifier){
<strong>    return (doc.owner==userId);</strong>
  },
  remove : function(userId,doc){
<strong>    return (doc.owner==userId);</strong>
  }</pre></div></li><li class="listitem">Save your changes, and test your new rules by logging in as a new user (create one if needed), trying to change results, trying to add new cards without being logged in, and so on. With these rules in place, only a logged-in user will be able to create new cards, and only the owner of a card can modify the card or delete it.</li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec253"/>How it works...</h2></div></div></div><p>All client-side attempts to alter collections in any way flow through two callbacks: <code class="literal">allow</code> and <code class="literal">deny</code>. In order for a collection change to be accepted by the server, the incoming change must receive one <code class="literal">true</code> response from one of the <code class="literal">allow</code> functions (for example, we return <code class="literal">true</code> on the <code class="literal">insert</code> function if the <code class="literal">userId!=null</code>), and must receive zero <code class="literal">true</code> responses from any of the <code class="literal">deny</code> functions.</p><p>In this particular case, we are doing a simple check on <code class="literal">insert</code>, under the <code class="literal">allow</code> callback, to make sure the user is <a id="id502" class="indexterm"/>logged in, which translates to <code class="literal">userId!=null</code>. For <code class="literal">update</code> and <code class="literal">remove</code>, the check is to see if the logged-in user is the owner/creator <a id="id503" class="indexterm"/>of the card, through <code class="literal">return</code> (<code class="literal">doc.owner==userId</code>).</p><p>There is no limit to the number of <code class="literal">allow</code> or <code class="literal">deny</code> callbacks you can declare, although it's usually best to consolidate them when possible, using a "pessimistic" security model (only allow what is needed, rather than allowing everything and only denying what is needed).</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec254"/>There's more…</h2></div></div></div><p>The preceding <code class="literal">allow</code> rules work just fine, if only the UI is being used. However, it's possible for someone to open the console window and make direct collection manipulation calls, which could cause some problems.</p><p>First, our check for <code class="literal">insert</code> is only <code class="literal">userId!=null</code>. Any additional fields, or even a malicious <code class="literal">insert</code>, can be added via the command line, for example, let's say that I am in possession of the <code class="literal">userId</code> for another user (not hard to get, it's found in the <code class="literal">owner</code> field of each card). I could easily <code class="literal">insert</code> a card with something nasty in the text, or <code class="literal">update</code> the text and owner of an existing cart, so as to make it appear that another user was the one that created the note.</p><p>For example, If I am logged in as <code class="literal">user2@test.com</code>, and I know that the <code class="literal">userId</code> value for <code class="literal">user1@test.com</code> is <code class="literal">'8v2GGh98RrYfso92c'</code>, I can run the following command in the browser console, and potentially get <code class="literal">user1</code> in trouble:</p><div><pre class="programlisting">
<strong>&gt; Cards_open.insert({text:'NSFW !@##%!!!',owner:'8v2GGh98RrYfso92c'})</strong>
</pre></div><p>We can handle this in several ways. We can either make our <code class="literal">allow</code> callback functions more complex, with multiple <code class="literal">if…else</code> statements, or we can use the <code class="literal">deny</code> callback to prohibit certain behavior. In <code class="literal">[project root]/server/collections-server.js</code>, create a new <code class="literal">deny</code> callback with the following code:</p><div><pre class="programlisting">Cards_open.deny({
  insert : function(userId,doc){
   return (doc.owner!=userId);
  },
  update : function(userId,doc,fieldNames,modifier){
    return (fieldNames.length!=1 || !(~fieldNames.indexOf('shared')));
  }
});</pre></div><p>For <code class="literal">insert</code>, if <code class="literal">doc.owner!=userId</code>, the <code class="literal">deny</code> callback will return <code class="literal">true</code>. For <code class="literal">update</code>, if an attempt is made to <a id="id504" class="indexterm"/>modify any field except shared, the <code class="literal">deny</code> <a id="id505" class="indexterm"/>callback will return <code class="literal">true</code> as well. Using these two callback functions, we have further tightened security, and taken away any console line shenanigans.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec255"/>See also</h2></div></div></div><p>For a breakdown of <a id="id506" class="indexterm"/>what's possible with <code class="literal">allow</code> and <code class="literal">deny</code>, consult the official Meteor documentation available at <a class="ulink" href="http://docs.meteor.com/#/full/allow">http://docs.meteor.com/#/full/allow</a>.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec71"/>Hiding data with façades</h1></div></div></div><p>Some of our <a id="id507" class="indexterm"/>security (and performance) problems can be resolved through limiting access to certain fields and records in our data collections, for example, if the <a id="id508" class="indexterm"/>
<code class="literal">owner</code> field of a record isn't sent to the client, a potential hacker will never be able to get the <code class="literal">userId</code> value of another user. Likewise, if only records belonging to a certain <code class="literal">userId</code>, or ones marked for sharing, are passed to the client, private records can stay private and visible only to the user that created them. This recipe will show you how to create a façade to limit fields and records being sent to the client.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec256"/>Getting ready</h2></div></div></div><p>Please complete the <em>Securing data transactions with allow and deny</em> recipe found in this chapter, including the additional <code class="literal">deny</code> callback functions found in the <em>There's more…</em> section. Once completed, and your Meteor app is running, you are ready to use this recipe.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec257"/>How to do it...</h2></div></div></div><p>We are going to modify the <code class="literal">publish</code> function on the server so that it only returns records that are owned by or shared with the logged-in user, and we will stop broadcasting the <code class="literal">owner</code> field.</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">[project root]/server/collections-server.js</code> file, locate the <code class="literal">Cards_open.publish</code> section, and make the following changes to the <code class="literal">Cards_open.find()</code> method:<div><pre class="programlisting">Meteor.publish('open',function(){
  return Cards_open.find<strong>({$or:</strong>
<strong>           [ {shared:true},</strong>
<strong>             {owner:this.userId}</strong>
<strong>           ]</strong>
<strong>         },</strong>
<strong>         {fields:{owner:0}});</strong>
});</pre></div></li><li class="listitem">Now that the <code class="literal">owner</code> field is no longer visible on the client, we can remove the following two lines from our open template in the <code class="literal">[project root]/client/main.html</code> file:<div><pre class="programlisting">&lt;div class="label owner"&gt;owner&lt;/div&gt;
&lt;div class="owner"&gt;{{owner}}&lt;/div&gt;</pre></div></li><li class="listitem">With those changes saved, any given logged-in user will only be able to see cards that have been created by that same user, or cards that have been shared. If you <a id="id509" class="indexterm"/>log in to two different browsers, with two <a id="id510" class="indexterm"/>different users, you will be able to see how sharing makes records visible to the other user, and vice versa. The following screenshot shows an example of two users sharing some records, and not sharing others:<div><img src="img/image00404.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec258"/>How it works...</h2></div></div></div><p>By modifying the selector and the <code class="literal">fields</code> option, we were able to limit the recordset being published to the client. The client, try as it might, will never be able to see any of the records excluded by the selector, nor any of the excluded <code class="literal">fields</code>, because the server simply isn't sending them when it is publishing.</p><p>Specifically, we used a <code class="literal">{$or: […]}</code> selector to limit which records are published, by including only records created by the current user (<code class="literal">owner:this.userId</code>), or records that have been shared (<code class="literal">shared:true</code>). We used the <code class="literal">{fields:{owner:0}}</code> option, to return all <code class="literal">fields</code> except <a id="id511" class="indexterm"/>
<code class="literal">owner</code>. This <em>blacklist</em> approach is less secure than a <em>whitelist</em> approach, but to keep this recipe simpler, we decided to tell the query what fields to exclude (optimistic) rather than what fields to include (pessimistic).</p><p>To whitelist, rather than blacklist, enumerate the fields you would like displayed, and pass a value of <code class="literal">1</code> with them (for example: <code class="literal">{text:1 , _id:1 , shared:1}</code>). All fields not specified will <a id="id512" class="indexterm"/>automatically not return with the query.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec259"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Filtering with MongoDB queries</em> recipe in <a class="link" title="Chapter 4. Creating Models" href="part0046.xhtml#aid-1BRPS1">Chapter 4</a>, <em>Creating Models</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec72"/>Protecting the client with browser-policy</h1></div></div></div><p>Securing your <a id="id513" class="indexterm"/>database is pretty straightforward in Meteor, but what about client-side security? Meteor has you covered there as well, using <a id="id514" class="indexterm"/>standard <code class="literal">Content-Security-Policy</code> and <code class="literal">X-Frame-Options</code> safeguards. This recipe will walk you through adding the <code class="literal">browser-policy</code> package, and configuring basic client-side security.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec260"/>Getting ready</h2></div></div></div><p>We will create a brand new project as usual, but we will be keeping the default files, creating some <em>unsafe</em> scripting functionality along the way.</p><div><div><div><div><h3 class="title"><a id="ch09lvl3sec22"/>Scaffolding setup</h3></div></div></div><p>In a terminal <a id="id515" class="indexterm"/>window, navigate to where your project root will be, and execute the following commands:</p><div><pre class="programlisting">
<strong>$ meteor create secure-client</strong>
<strong>$ cd secure-client</strong>
<strong>$ mkdir {client,server,both}</strong>
<strong>$ mv secure-client.* client/</strong>
<strong>$ meteor</strong>
</pre></div></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec23"/>Add CDN-hosted bootstrap</h3></div></div></div><p>Visit the <a id="id516" class="indexterm"/>official Bootstrap <code class="literal">Getting Started</code> page, located at <a class="ulink" href="http://getbootstrap.com/getting-started/">http://getbootstrap.com/getting-started/</a> and scroll to the section <a id="id517" class="indexterm"/>marked as <strong>Bootstrap CDN</strong>. Copy the contents from that <a id="id518" class="indexterm"/>section, and insert them into the <code class="literal">&lt;head&gt;</code> block of your <code class="literal">[project root]/client/secure-client.html</code> file. When finished, your changes should look similar to the following code:</p><div><pre class="programlisting">&lt;head&gt;
  &lt;title&gt;secure-client&lt;/title&gt;
<strong>  &lt;!-- Latest compiled and minified CSS --&gt;</strong>
<strong>  &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css"&gt;</strong>

<strong>  &lt;!-- Optional theme --&gt;</strong>
<strong>  &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css"&gt;</strong>

<strong>  &lt;!-- Latest compiled and minified JavaScript --&gt;</strong>
<strong>  &lt;script src="img/bootstrap.min.js"&gt;&lt;/script&gt;</strong>
&lt;/head&gt;</pre></div></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec24"/>Add inline and eval() scripts</h3></div></div></div><p>While we <a id="id519" class="indexterm"/>have <code class="literal">secure-client.html</code> open, let's modify the <a id="id520" class="indexterm"/>template, adding some indicators, an inline script in an <a id="id521" class="indexterm"/>
<code class="literal">href</code> attribute, and a new section for displaying <code class="literal">eval()</code> results. Modify <a id="id522" class="indexterm"/>your <code class="literal">hello</code> template so that it looks like the following code:</p><div><pre class="programlisting">&lt;template name="hello"&gt;
  &lt;button&gt;Click Me&lt;/button&gt;
  &lt;p&gt;You've pressed the button
<strong>    &lt;div class="badge"&gt;{{counter}}&lt;/div&gt;</strong>
  times.&lt;/p&gt;
<strong>  &lt;p&gt;Which is 1/2 of our eval value: {{dblCounter}}&lt;/p&gt;</strong>
<strong>  &lt;a href="javascript:alert('hax0rz!'); Meteor.call('dropTable');"&gt;</strong>
<strong>      &lt;div class="btn btn-info"&gt;Bootstrap!&lt;/div&gt;</strong>
<strong>  &lt;/a&gt;</strong>
&lt;/template&gt;</pre></div><p>We have a bit of logic to add, so that the template will be displayed properly. First, we will create a simple collection called <code class="literal">Test</code>. Create a file named <code class="literal">[project root]/both/model.js</code> and add the following line:</p><div><pre class="programlisting">Test = new Mongo.Collection('test');</pre></div><p>Now, configure the server method <code class="literal">dropTable</code> to simulate someone erasing the database. Create a file named <code class="literal">[project root]/server/methods.js</code> and add the following code:</p><div><pre class="programlisting">Meteor.methods({
  dropTable: function(){
   Test.remove({});
  }
});</pre></div><p>Next, we need to <a id="id523" class="indexterm"/>modify the <code class="literal">hello</code> template helpers and events to be<a id="id524" class="indexterm"/> "vulnerable" to our clever hacks! Open <code class="literal">[project root]/client/secure-client.js</code>, modify the <code class="literal">Template.hello.helpers</code> section to the following:</p><div><pre class="programlisting">Template.hello.helpers({
  counter: function () {
<strong>    try {</strong>
<strong>      var x = Test.find().count();</strong>
<strong>      Session.set('counter', eval("x*2"));</strong>
<strong>    } catch (err) {</strong>
<strong>      console.log('ERROR: ', err);</strong>
<strong>    }</strong>
<strong>    return x;</strong>
<strong>  },</strong>
<strong>  dblCounter: function () {</strong>
<strong>    return Session.get('counter');</strong>
<strong>  }</strong>
});</pre></div><p>Finally, modify <code class="literal">Template.hello.events</code> to add a record to the <code class="literal">Test</code> collection, rather than updating the <code class="literal">counter</code> variable. Your code should look similar to the following:</p><div><pre class="programlisting">Template.hello.events({
  'click button': function () {
    // increment the counter when button is clicked
<strong>    Test.insert({action:'click'});</strong>
  }
});</pre></div><p>Once all of these <a id="id525" class="indexterm"/>changes are saved, our application is thoroughly "hacked" <a id="id526" class="indexterm"/>with an <code class="literal">eval()</code> being used to double the normal click counter, an inline script that will remove all records from our <code class="literal">Test</code> collection, and with scripts and styles being used from an alternate site (the Bootstrap CDN).</p><p>Navigate to <code class="literal">http://localhost:3000/</code> and play around with the buttons for a bit. After a few clicks, your screen will look similar to the following screenshot:</p><div><img src="img/image00405.jpeg" alt="Add inline and eval() scripts"/></div><p style="clear:both; height: 1em;"> </p><p>To activate the inline "hack", click the button labelled <strong>Bootstrap!</strong> – a notice will come up that you've been <a id="id527" class="indexterm"/>hacked, and after you click on <strong>OK,</strong> the <code class="literal">Test</code> collection <a id="id528" class="indexterm"/>will be cleaned out. The notice will look something <a id="id529" class="indexterm"/>like the following screenshot:</p><div><img src="img/image00406.jpeg" alt="Add inline and eval() scripts"/></div><p style="clear:both; height: 1em;"> </p><p>You're now ready to <a id="id530" class="indexterm"/>shut down all these expert hacking techniques!</p></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec261"/>How to do it...</h2></div></div></div><p>To secure our application, we will add the <code class="literal">browser-policy</code> package, and then configure it appropriately for our environment.</p><div><ol class="orderedlist arabic"><li class="listitem">In a new terminal window, navigate to the root folder of your project (keep your app running!) and execute the following command:<div><pre class="programlisting">
<strong>$ meteor add browser-policy</strong>
</pre></div><p>Your application will now have lost all Bootstrap formatting, and the <code class="literal">eval()</code> function which was doubling your counter and the eval() function, which was doubling your counter, will no longer work. When you click the <strong>Click Me</strong> button, your counter will increment but the double counter will not. Your screen should look similar to the <a id="id531" class="indexterm"/>following screenshot, with a lot of errors in the <a id="id532" class="indexterm"/>web console explaining that the <a id="id533" class="indexterm"/>unsafe "hacks" from before are no longer allowed:</p><div><img src="img/image00407.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">We will now fine-tune our security settings with <code class="literal">BrowserPolicy.content</code>. The inline scripting vulnerability still exists (click on <strong>Bootstrap!</strong> if you would like to test it), and our formatting, which we don't consider a hack, is no longer working. So, we are currently not strict enough in one area (inline scripts) and too strict in <a id="id534" class="indexterm"/>another (refusing all content from the Bootstrap CDN, a trusted source). Let's rectify that. Create a new file named <code class="literal">policy.js</code> in the <code class="literal">[project root]/server/</code> folder. Add the following two lines, and save your changes:<div><pre class="programlisting">BrowserPolicy.content.allowStyleOrigin( 'https://maxcdn.bootstrapcdn.com/');
BrowserPolicy.content.allowScriptOrigin( 'https://maxcdn.bootstrapcdn.com/');</pre></div></li><li class="listitem">Our Bootstrap formatting has been restored! Now, let's disallow inline scripts, as well as prevent connections to any servers. Add the following two lines to the <code class="literal">policy.js</code> file and save your changes:<div><pre class="programlisting">BrowserPolicy.content.disallowInlineScripts();
BrowserPolicy.content.disallowConnect();</pre></div><p>The inline script that was erasing our <code class="literal">Test</code> collection will now no longer run. However, by disallowing all connections, we have inadvertently destroyed the <code class="literal">DDP</code> connection to our server. We need to rectify that by whitelisting our <code class="literal">//:localhost:3000</code> address for HTTP and for websockets (for <code class="literal">DDP</code>).</p></li><li class="listitem">Add the following <a id="id535" class="indexterm"/>three lines to the end of the <code class="literal">policy.js</code> file and save your changes:<div><pre class="programlisting">var rootUrl = __meteor_runtime_config__.ROOT_URL;
BrowserPolicy.content.allowConnectOrigin(rootUrl);
BrowserPolicy.content.allowConnectOrigin(rootUrl.replace('http', 'ws'));</pre></div><div><h3 class="title"><a id="tip39"/>Tip</h3><p>As we are dealing with your browser's security policy, a manual refresh is required each time you make a change to <code class="literal">policy.js</code>.</p></div><p>Refresh your <a id="id536" class="indexterm"/>browser one final time, and <a id="id537" class="indexterm"/>now everything that should be <a id="id538" class="indexterm"/>allowed is working, and everything that shouldn't (inline scripts, <code class="literal">eval()</code>, etc.) is prohibited. Your screen, after a few clicks, should look like the following screenshot:</p><div><img src="img/image00408.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec262"/>How it works...</h2></div></div></div><p>By default, installing the <code class="literal">browser-policy</code> package will disable the <code class="literal">eval()</code> scripts, and only allow resources (images, etc) from your site. This is why just adding <code class="literal">browser-policy</code> disabled the double counter <code class="literal">eval()</code> script, and stripped away all the Bootstrap files.</p><p>To allow Bootstrap resources, we whitelisted the styles and scripts of the Bootstrap CDN, using the two <code class="literal">BrowserPolicy.content</code> functions – <code class="literal">allowStyleOrigin()</code> and <code class="literal">.allowScriptOrigin()</code>.</p><p>Next, we shut off inline <a id="id539" class="indexterm"/>scripts with the <code class="literal">disallowInlineScripts()</code> function. We also prevented any and all AJAX / remote server calls, using the <code class="literal">disallowConnect()</code> function.</p><p>Being this strict also broke <a id="id540" class="indexterm"/>our server's DDP connection, which we <a id="id541" class="indexterm"/>restored using the <code class="literal">allowConnectOrigin()</code> function, for <a id="id542" class="indexterm"/>both HTTP and <code class="literal">ws</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec263"/>See also</h2></div></div></div><p>There are many other options available to us (this is just a primer), so if you would like to really fine-tune your security settings, we recommend the most excellent article from Arunoda <a id="id543" class="indexterm"/>Susiripala, located at <a class="ulink" href="https://meteorhacks.com/xss-and-meteor.html">https://meteorhacks.com/xss-and-meteor.html</a>, and the <code class="literal">browser-policy</code> documentation, found <a id="id544" class="indexterm"/>on Atmosphere: <a class="ulink" href="https://atmospherejs.com/meteor/browser-policy">https://atmospherejs.com/meteor/browser-policy</a>.</p></div></div></body></html>