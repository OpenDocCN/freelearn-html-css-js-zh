<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Click-Click Boom! </span><span class="koboSpan" id="kobo.1.2">Applying Interactivity to Your Map</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">In the previous chapter, you learned what is needed to build a basic map with D3.js. </span><span class="koboSpan" id="kobo.2.2">We also discussed the concepts of enter, update, and exit and how they apply to maps. </span><span class="koboSpan" id="kobo.2.3">You should also understand how D3 mixes and matches HTML with data. </span><span class="koboSpan" id="kobo.2.4">However, let's say you want to take it a step further and add more interactivity to your map. </span><span class="koboSpan" id="kobo.2.5">We covered only the tip of the iceberg regarding click events in the previous chapter. </span><span class="koboSpan" id="kobo.2.6">Now, it's time to dig deeper.</span></p>
<p><span class="koboSpan" id="kobo.3.1">In this chapter, we will expand our knowledge of events and event types. </span><span class="koboSpan" id="kobo.3.2">We will progress by experimenting and building upon what you've learned. </span><span class="koboSpan" id="kobo.3.3">The following topics are covered in this chapter:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.4.1">Events and how they occur</span></li>
<li><span class="koboSpan" id="kobo.5.1">Experiment 1 - hover events and tooltips</span></li>
<li><span class="koboSpan" id="kobo.6.1">Experiment 2 - tooltips with visualizations</span></li>
<li><span class="koboSpan" id="kobo.7.1">Experiment 3 - panning and zooming</span></li>
<li><span class="koboSpan" id="kobo.8.1">Experiment 4 - orthographic projections</span></li>
<li><span class="koboSpan" id="kobo.9.1">Experiment 5 - rotating orthographic projections</span></li>
<li><span class="koboSpan" id="kobo.10.1">Experiment 6 - dragging orthographic projections</span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Events and how they occur</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">The following is taken directly from the w3 specifications:</span></p>
<div class="packt_quote"><span class="koboSpan" id="kobo.3.1">"The Event interface is used to provide contextual information about an event to the handler processing the event. </span><span class="koboSpan" id="kobo.3.2">An object that implements the Event interface is generally passed as the first parameter to an event handler. </span><span class="koboSpan" id="kobo.3.3">More specific context information is passed to event handlers by deriving additional interfaces from Event which contain information directly relating to the type of event they accompany. </span><span class="koboSpan" id="kobo.3.4">These derived interfaces are also implemented by the object passed to the event listener."</span></div>
<p><span class="koboSpan" id="kobo.4.1">In other words, an event is a </span><span><span class="koboSpan" id="kobo.5.1">user input </span></span><span class="koboSpan" id="kobo.6.1">action that takes place in the browser. </span><span class="koboSpan" id="kobo.6.2">If your user clicks, touches, drags, or rotates, an event will fire. </span><span class="koboSpan" id="kobo.6.3">If you have event listeners registered to those particular events, the listeners will catch the event and determine the event type. </span><span class="koboSpan" id="kobo.6.4">The listeners will also expose properties associated with the event. </span><span class="koboSpan" id="kobo.6.5">For example, if we want to add an event listener in plain JavaScript, we would add the following lines of code:</span></p>
<pre><span class="koboSpan" id="kobo.7.1">&lt;body&gt; 
  &lt;button id="btn"&gt;Click me&lt;/button&gt; 
 
  &lt;script&gt; 
    varbtn = document.getElementById('btn'); 
    btn.addEventListener('click', function() { 
      console.log('Hello world'); }, false ); 
  &lt;/script&gt; 
&lt;/body&gt; </span></pre>
<p><span class="koboSpan" id="kobo.8.1">Note that you first need to have the button in the DOM in order to get its ID. </span><span class="koboSpan" id="kobo.8.2">Once you have it, you can simply add an event listener to listen to the element's click event. </span><span class="koboSpan" id="kobo.8.3">The event listener will catch the click event every time it fires and logs </span><kbd><span class="koboSpan" id="kobo.9.1">Hello world</span></kbd><span class="koboSpan" id="kobo.10.1"> to the console.</span></p>
<p><span class="koboSpan" id="kobo.11.1">Until jQuery, events were very tricky, and different browsers had different ways of catching these events. </span><span class="koboSpan" id="kobo.11.2">However, thankfully, this is all in the past. </span><span class="koboSpan" id="kobo.11.3">Now, we live in a world where modern browsers are more consistent with event handling.</span></p>
<p><span class="koboSpan" id="kobo.12.1">In the world of D3, you won't have to worry about this. </span><span class="koboSpan" id="kobo.12.2">Generating events, catching them, and reacting to them is baked into the library and works across all browsers. </span><span class="koboSpan" id="kobo.12.3">A good example of this is the hover event.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Experiment 1 – hover events and tooltips</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Building on our previous example, we can easily swap our </span><kbd><span class="koboSpan" id="kobo.3.1">click</span></kbd><span class="koboSpan" id="kobo.4.1"> method with a </span><kbd><span class="koboSpan" id="kobo.5.1">hover</span></kbd><span class="koboSpan" id="kobo.6.1"> method. </span><span class="koboSpan" id="kobo.6.2">Instead of having </span><kbd><span class="koboSpan" id="kobo.7.1">var click</span></kbd><span class="koboSpan" id="kobo.8.1">, we will now have </span><kbd><span class="koboSpan" id="kobo.9.1">var hover</span></kbd><span class="koboSpan" id="kobo.10.1"> with the corresponding function. </span><span class="koboSpan" id="kobo.10.2">Feel free to open </span><kbd><span class="koboSpan" id="kobo.11.1">example-1.html</span></kbd><span class="koboSpan" id="kobo.12.1"> of the </span><kbd><span class="koboSpan" id="kobo.13.1">chapter-5</span></kbd><span class="koboSpan" id="kobo.14.1"> code base to go over the complete example (</span><kbd><span class="koboSpan" id="kobo.15.1">http://localhost:8080/chapter-5/example-1.html</span></kbd><span class="koboSpan" id="kobo.16.1">). </span><span class="koboSpan" id="kobo.16.2">Let's review the necessary code to change our click event to a hover event. </span><span class="koboSpan" id="kobo.16.3">In this particular case, we will need a little more CSS and HTML. </span><span class="koboSpan" id="kobo.16.4">In our </span><kbd><span class="koboSpan" id="kobo.17.1">&lt;style&gt;</span></kbd><span class="koboSpan" id="kobo.18.1"> tag, add the following lines:</span></p>
<pre><span class="koboSpan" id="kobo.19.1">#tooltip{ 
position: absolute; 
z-index: 2; 
background: rgba(0,153,76,0.8); 
width:130px; 
height:20px; 
color:white; 
font-size: 14px; 
padding:5px; 
top:-150px; 
left:-150px; 
font-family: "HelveticaNeue-Light", "Helvetica Neue Light", </span><br/><span class="koboSpan" id="kobo.20.1"> "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif; 
} </span></pre>
<p><span class="koboSpan" id="kobo.21.1">This style is for a basic tooltip. </span><span class="koboSpan" id="kobo.21.2">It is positioned </span><strong><span class="koboSpan" id="kobo.22.1">absolutely</span></strong><span class="koboSpan" id="kobo.23.1"> so that it can take whatever </span><em><span class="koboSpan" id="kobo.24.1">x</span></em><span class="koboSpan" id="kobo.25.1"> and </span><em><span class="koboSpan" id="kobo.26.1">y</span></em><span class="koboSpan" id="kobo.27.1"> coordinates we give it (left and top). </span><span class="koboSpan" id="kobo.27.2">It also has some filler styles for the fonts and colors. </span><span class="koboSpan" id="kobo.27.3">The </span><kbd><span class="koboSpan" id="kobo.28.1">tooltip</span></kbd><span class="koboSpan" id="kobo.29.1"> is styled to the element in the DOM that has the ID of </span><kbd><span class="koboSpan" id="kobo.30.1">#tooltip</span></kbd><span class="koboSpan" id="kobo.31.1">:</span></p>
<pre><span class="koboSpan" id="kobo.32.1">&lt;div id="tooltip"&gt;&lt;/div&gt; </span></pre>
<p><span class="koboSpan" id="kobo.33.1">Next, we add the logic to handle a </span><kbd><span class="koboSpan" id="kobo.34.1">hover</span></kbd><span class="koboSpan" id="kobo.35.1"> event when it is fired:</span></p>
<pre><span class="koboSpan" id="kobo.36.1">var hover = function(d) { 
  var div = document.getElementById('tooltip'); 
  div.style.left = event.pageX +'px'; 
  div.style.top = event.pageY + 'px'; 
  div.innerHTML = d.properties.NAME_1; 
}; </span></pre>
<p><span class="koboSpan" id="kobo.37.1">This function, aside from logging the event, will find the DOM element with an ID of </span><kbd><span class="koboSpan" id="kobo.38.1">tooltip</span></kbd><span class="koboSpan" id="kobo.39.1"> and position it at the </span><em><span class="koboSpan" id="kobo.40.1">x</span></em><span class="koboSpan" id="kobo.41.1"> and </span><em><span class="koboSpan" id="kobo.42.1">y</span></em><span class="koboSpan" id="kobo.43.1"> coordinates of the event. </span><span class="koboSpan" id="kobo.43.2">These coordinates are a part of the properties of the event and are named </span><kbd><span class="koboSpan" id="kobo.44.1">pageX</span></kbd><span class="koboSpan" id="kobo.45.1"> and </span><kbd><span class="koboSpan" id="kobo.46.1">pageY</span></kbd><span class="koboSpan" id="kobo.47.1">, respectively. </span><span class="koboSpan" id="kobo.47.2">Next, we will insert text with the state name (</span><kbd><span class="koboSpan" id="kobo.48.1">d.properties.NAME_1</span></kbd><span class="koboSpan" id="kobo.49.1">) into the </span><kbd><span class="koboSpan" id="kobo.50.1">tooltip</span></kbd><span class="koboSpan" id="kobo.51.1">:</span></p>
<pre><span class="koboSpan" id="kobo.52.1">//Enter 
mexico.enter() 
  .append('path') 
  .attr('d', path) 
  .on("mouseover", hover); </span></pre>
<p><span class="koboSpan" id="kobo.53.1">Finally, we will change our binding from a click to a </span><kbd><span class="koboSpan" id="kobo.54.1">mouseover</span></kbd><span class="koboSpan" id="kobo.55.1"> event in the on section of the code. </span><span class="koboSpan" id="kobo.55.2">We will also change the event handler to the </span><kbd><span class="koboSpan" id="kobo.56.1">hover</span></kbd><span class="koboSpan" id="kobo.57.1"> function we created earlier.</span></p>
<p><span class="koboSpan" id="kobo.58.1">Once the changes have been saved and viewed, you should notice basic tooltips on your map:</span></p>
<div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.59.1"><img height="394" width="595" src="assets/e2101ebd-e276-43e9-848e-064c471387c3.png"/></span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Experiment 2 – tooltips with visualizations</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">In this next experiment, we will enhance our tooltips with additional visualizations. </span><span class="koboSpan" id="kobo.2.2">In a similar fashion, we will outline the additional code to provide this functionality (</span><kbd><span class="koboSpan" id="kobo.3.1">http://localhost:8080/chapter-5/example-2.html</span></kbd><span class="koboSpan" id="kobo.4.1">).</span></p>
<p><span class="koboSpan" id="kobo.5.1">To our CSS, we will need to add the following lines of code:</span></p>
<pre><span class="koboSpan" id="kobo.6.1">#tooltip svg{ 
border-top:0; 
margin-left:-5px; 
margin-top:7px; 
} </span></pre>
<p><span class="koboSpan" id="kobo.7.1">This will style our SVG container (inside our tooltip DOM element) to align it with the label of the state.</span></p>
<p><span class="koboSpan" id="kobo.8.1">Next, we'll include two new scripts to create visualizations:</span></p>
<pre><span class="koboSpan" id="kobo.9.1">&lt;script src="base.js"&gt;&lt;/script&gt; 
&lt;script src="sparkline.js"&gt;&lt;/script&gt; </span></pre>
<p><span class="koboSpan" id="kobo.10.1">The preceding JavaScript files contain the D3 code for creating a line chart visualization. </span><span class="koboSpan" id="kobo.10.2">The chart itself contains and leverages the </span><em><span class="koboSpan" id="kobo.11.1">Towards</span></em> <em><span class="koboSpan" id="kobo.12.1">Reusable Chart</span></em><span class="koboSpan" id="kobo.13.1"> described by Mike Bostock at: </span><a href="http://bost.ocks.org/mike/chart/"><span class="URLPACKT"><span class="koboSpan" id="kobo.14.1">http://bost.ocks.org/mike/chart/</span></span></a><span class="koboSpan" id="kobo.15.1">. </span><span class="koboSpan" id="kobo.15.2">Feel free to examine the code; it is a very simple visualization that follows the enter, update, and exit pattern. </span><span class="koboSpan" id="kobo.15.3">We will explore this chart further in </span><a href="ded15f0d-44ff-4b2d-a2ac-ecbba7d5dd63.xhtml"><span class="ChapterrefPACKT"><span class="koboSpan" id="kobo.16.1">Chapter 7</span></span></a><span class="koboSpan" id="kobo.17.1">, </span><em><span class="koboSpan" id="kobo.18.1">Testing</span></em><span class="koboSpan" id="kobo.19.1">:</span></p>
<pre><span class="koboSpan" id="kobo.20.1">var db = d3.map(); 
var sparkline = d3.charts.sparkline().height(50).width(138); </span></pre>
<p><span class="koboSpan" id="kobo.21.1">We will now declare two new variables. </span><span class="koboSpan" id="kobo.21.2">The </span><kbd><span class="koboSpan" id="kobo.22.1">db</span></kbd><span class="koboSpan" id="kobo.23.1"> variable will hold a hashmap to quickly lookup values by </span><kbd><span class="koboSpan" id="kobo.24.1">geoID</span></kbd><span class="koboSpan" id="kobo.25.1">. </span><span class="koboSpan" id="kobo.25.2">The </span><kbd><span class="koboSpan" id="kobo.26.1">sparkline</span></kbd><span class="koboSpan" id="kobo.27.1"> variable is the function that will draw our simple line chart:</span></p>
<pre><span class="koboSpan" id="kobo.28.1">var setDb = function(data) { 
  data.forEach(function(d) { 
    db.set(d.geoID, [ 
       {"x": 1, "y": +d.q1}, 
       {"x": 2, "y": +d.q2}, 
       {"x": 3, "y": +d.q3}, 
       {"x": 4, "y": +d.q4} 
    ]); 
  }); 
}; </span></pre>
<p><span class="koboSpan" id="kobo.29.1">This function parses data and formats it into a structure that the </span><kbd><span class="koboSpan" id="kobo.30.1">sparkline</span></kbd><span class="koboSpan" id="kobo.31.1"> function can use to create the line chart:</span></p>
<pre><span class="koboSpan" id="kobo.32.1">var geoID = function(d) { 
  return "c" + d.properties.ID_1; 
}; </span></pre>
<p><span class="koboSpan" id="kobo.33.1">We will bring back our </span><kbd><span class="koboSpan" id="kobo.34.1">geoID</span></kbd><span class="koboSpan" id="kobo.35.1"> function from </span><a href="c22382c6-84d9-411f-b795-681df2321005.xhtml"><span class="ChapterrefPACKT"><span class="koboSpan" id="kobo.36.1">Chapter 4</span></span></a><span class="koboSpan" id="kobo.37.1">, </span><em><span class="koboSpan" id="kobo.38.1">Creating a Map</span></em><span class="koboSpan" id="kobo.39.1">, in order to quickly create unique IDs for each state:</span></p>
<pre><span class="koboSpan" id="kobo.40.1">var hover = function(d) { 
  var div = document.getElementById('tooltip'); 
  div.style.left = event.pageX +'px'; 
  div.style.top = event.pageY + 'px'; 
  div.innerHTML = d.properties.NAME_1; 
 
  var id = geoID(d); 
  d3.select("#tooltip").datum(db.get(id)).call(sparkline.draw); 
}; </span></pre>
<p><span class="koboSpan" id="kobo.41.1">For our hover event handler, we need to add two new lines. </span><span class="koboSpan" id="kobo.41.2">First, we will declare an ID variable that holds the unique </span><kbd><span class="koboSpan" id="kobo.42.1">geoID</span></kbd><span class="koboSpan" id="kobo.43.1"> for the state we are hovering over. </span><span class="koboSpan" id="kobo.43.2">Then, we will call our </span><kbd><span class="koboSpan" id="kobo.44.1">sparkline</span></kbd><span class="koboSpan" id="kobo.45.1"> function to draw a line chart in the </span><kbd><span class="koboSpan" id="kobo.46.1">tooltip</span></kbd><span class="koboSpan" id="kobo.47.1"> selection. </span><span class="koboSpan" id="kobo.47.2">The data is retrieved from the preceding </span><kbd><span class="koboSpan" id="kobo.48.1">db</span></kbd><span class="koboSpan" id="kobo.49.1"> variable. </span><span class="koboSpan" id="kobo.49.2">For more information on how the call works, refer to: </span><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/call"><span class="URLPACKT"><span class="koboSpan" id="kobo.50.1">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/call</span></span></a><span class="koboSpan" id="kobo.51.1">:</span></p>
<pre><span class="koboSpan" id="kobo.52.1">d3.csv('states-data.csv', function(data) { 
  setDb(data); 
}); </span></pre>
<p><span class="koboSpan" id="kobo.53.1">We load our </span><kbd><span class="koboSpan" id="kobo.54.1">.csv</span></kbd><span class="koboSpan" id="kobo.55.1"> file via AJAX and invoke the </span><kbd><span class="koboSpan" id="kobo.56.1">setDb()</span></kbd><span class="koboSpan" id="kobo.57.1"> function (described earlier).</span></p>
<p><span class="koboSpan" id="kobo.58.1">You should now see a map that displays a </span><kbd><span class="koboSpan" id="kobo.59.1">tooltip</span></kbd><span class="koboSpan" id="kobo.60.1"> with a line chart for every state in Mexico. </span><span class="koboSpan" id="kobo.60.2">In summary:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.61.1">The map is drawn as usual.</span></li>
<li><span class="koboSpan" id="kobo.62.1">We will create a small lookup </span><kbd><span class="koboSpan" id="kobo.63.1">db</span></kbd><span class="koboSpan" id="kobo.64.1"> that contains additional data about each state.</span></li>
<li><span class="koboSpan" id="kobo.65.1">Then, we will register a hover event that fires whenever the user's mouse passes over a state.</span></li>
<li><span class="koboSpan" id="kobo.66.1">The hover event fires and retrieves data about the state.</span></li>
<li><span class="koboSpan" id="kobo.67.1">The hover event also places the name of the state in the DOM and calls a function that creates a line chart with the retrieved data:
</span><div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.68.1"><img height="314" width="472" src="assets/2f2788b5-1820-4e55-b32f-d3465e138d29.png"/></span></div>
</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Experiment 3 – panning and zooming</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">A very common request when working with maps is to provide the ability to pan and zoom around the visualization. </span><span class="koboSpan" id="kobo.2.2">This is especially useful when a large map contains abundant detail. </span><span class="koboSpan" id="kobo.2.3">Luckily, D3 provides an event listener to help with this feature. </span><span class="koboSpan" id="kobo.2.4">In this experiment, we will outline the principles to provide basic panning and zooming for your map. </span><span class="koboSpan" id="kobo.2.5">This experiment requires us to start with </span><kbd><span class="koboSpan" id="kobo.3.1">example-1.html</span></kbd><span class="koboSpan" id="kobo.4.1">; however, feel free to look at </span><kbd><span class="koboSpan" id="kobo.5.1">http://localhost:8080/chapter-5/example-3.html</span></kbd><span class="koboSpan" id="kobo.6.1"> for reference.</span></p>
<p><span class="koboSpan" id="kobo.7.1">First, we will add a simple CSS class in our </span><kbd><span class="koboSpan" id="kobo.8.1">&lt;style&gt;</span></kbd><span class="koboSpan" id="kobo.9.1"> section; this class will act as a rectangle over the entire map. </span><span class="koboSpan" id="kobo.9.2">This will be our zoomable area:</span></p>
<pre><span class="koboSpan" id="kobo.10.1">.overlay { 
fill: none; 
pointer-events: all; 
} </span></pre>
<p><span class="koboSpan" id="kobo.11.1">Next, we need to define a function to handle the event when the zoom listener is fired. </span><span class="koboSpan" id="kobo.11.2">The following function can be placed right below the map declaration:</span></p>
<pre><span class="koboSpan" id="kobo.12.1">var zoomed = function () { 
  map.attr("transform", "translate("+ d3.event.translate + ")</span><br/><span class="koboSpan" id="kobo.13.1">   scale(" + d3.event.scale + ")"); 
}; </span></pre>
<p><span class="koboSpan" id="kobo.14.1">This function takes advantage of two variables exposed while panning and zooming: </span><kbd><span class="koboSpan" id="kobo.15.1">d3.event.scale</span></kbd><span class="koboSpan" id="kobo.16.1"> and </span><kbd><span class="koboSpan" id="kobo.17.1">d3.event.translate</span></kbd><span class="koboSpan" id="kobo.18.1">. </span><span class="koboSpan" id="kobo.18.2">The variables are defined as follows:</span></p>
<ul>
<li><kbd><span class="koboSpan" id="kobo.19.1">d3.event.scale</span></kbd><span class="koboSpan" id="kobo.20.1">: This defines the zoom level in terms of an SVG scale.</span></li>
<li><kbd><span class="koboSpan" id="kobo.21.1">d3.event.translate</span></kbd><span class="koboSpan" id="kobo.22.1">: This defines the position of the map in relation to the mouse in terms of an SVG translate.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.23.1">With this information available, we can set the SVG attributes (scale and translate) of the map container to the event variables:</span></p>
<pre><span class="koboSpan" id="kobo.24.1">var zoom = d3.behavior.zoom() 
    .scaleExtent([1, 8]) 
    .on("zoom", zoomed); 
    .size([width, height]); </span></pre>
<p><span class="koboSpan" id="kobo.25.1">Similar to the hover event listener, we need to create a new zoom event listener. </span><span class="koboSpan" id="kobo.25.2">Create the preceding function after the </span><kbd><span class="koboSpan" id="kobo.26.1">zoom()</span></kbd><span class="koboSpan" id="kobo.27.1"> function. </span><span class="koboSpan" id="kobo.27.2">Note that there is one additional setting to understand, </span><kbd><span class="koboSpan" id="kobo.28.1">scaleExtent()</span></kbd><span class="koboSpan" id="kobo.29.1">.</span></p>
<p><span class="koboSpan" id="kobo.30.1">The </span><kbd><span class="koboSpan" id="kobo.31.1">scaleExtent()</span></kbd><span class="koboSpan" id="kobo.32.1"> setting provides a scale range of the zooming amount. </span><span class="koboSpan" id="kobo.32.2">The first element in the array is the maximum that the map can zoom out. </span><span class="koboSpan" id="kobo.32.3">The second element in the array is the maximum that the map can zoom in. </span><span class="koboSpan" id="kobo.32.4">Remember that </span><kbd><span class="koboSpan" id="kobo.33.1">1</span></kbd><span class="koboSpan" id="kobo.34.1"> is the original size of our map based on our bounding-box formula from </span><a href="c22382c6-84d9-411f-b795-681df2321005.xhtml"><span class="ChapterrefPACKT"><span class="koboSpan" id="kobo.35.1">Chapter 4</span></span></a><span class="koboSpan" id="kobo.36.1">, </span><em><span class="koboSpan" id="kobo.37.1">Creating a Map</span></em><span class="koboSpan" id="kobo.38.1">. </span><span class="koboSpan" id="kobo.38.2">The minimum value that </span><kbd><span class="koboSpan" id="kobo.39.1">scaleExtent()</span></kbd><span class="koboSpan" id="kobo.40.1"> can be set to is </span><kbd><span class="koboSpan" id="kobo.41.1">0</span></kbd><span class="koboSpan" id="kobo.42.1">, to zoom out. </span><span class="koboSpan" id="kobo.42.2">In </span><kbd><span class="koboSpan" id="kobo.43.1">example-3.html</span></kbd><span class="koboSpan" id="kobo.44.1">, alter these numbers to get a feel of how they work. </span><span class="koboSpan" id="kobo.44.2">For example, if you change </span><kbd><span class="koboSpan" id="kobo.45.1">1</span></kbd><span class="koboSpan" id="kobo.46.1"> to </span><kbd><span class="koboSpan" id="kobo.47.1">5</span></kbd><span class="koboSpan" id="kobo.48.1">, you will see that the map can zoom out to half its original size.</span></p>
<p><span class="koboSpan" id="kobo.49.1">There are additional settings to this event listener that can be reviewed at: </span><a href="https://github.com/mbostock/d3/wiki/Zoom-Behavior"><span class="URLPACKT"><span class="koboSpan" id="kobo.50.1">https://github.com/mbostock/d3/wiki/Zoom-Behavior</span></span></a><span class="koboSpan" id="kobo.51.1">:</span></p>
<pre><span class="koboSpan" id="kobo.52.1">svg.append("rect") 
      .attr("class", "overlay") 
      .attr("width", width) 
      .attr("height", height) 
      .call(zoom); </span></pre>
<p><span class="koboSpan" id="kobo.53.1">Finally, right after the </span><kbd><span class="koboSpan" id="kobo.54.1">mexico.exit</span></kbd><span class="koboSpan" id="kobo.55.1"> section, we will add a transparent rectangle to the entire visualization and bind the new listener. </span><span class="koboSpan" id="kobo.55.2">Remember that the rectangle is using the CSS class we defined at the beginning of the experiment.</span></p>
<p><span class="koboSpan" id="kobo.56.1">Now, you should have full zooming and panning capabilities on the Mexican map. </span><span class="koboSpan" id="kobo.56.2">You can either double-click to zoom in or use your scroll wheel. </span><span class="koboSpan" id="kobo.56.3">The interactions should also work for swipe and pinch gestures on a tablet:</span></p>
<div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.57.1"><img height="258" width="389" src="assets/644dc9cc-0d9f-452e-95b3-64cea8a3e087.png"/></span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Experiment 4 – orthographic projections</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">For the next set of experiments in this chapter, we will switch gears and look at interactivity with orthographic projections (representing a three-dimensional map on a two-dimensional screen). </span><span class="koboSpan" id="kobo.2.2">A better visualization to illustrate these concepts is the entire globe instead of a single country. </span><span class="koboSpan" id="kobo.2.3">This experiment will start with </span><kbd><span class="koboSpan" id="kobo.3.1">http://localhost:8080/chapter-5/example-4.html</span></kbd><span class="koboSpan" id="kobo.4.1"> and require a new datafile, which is provided for you. </span><span class="koboSpan" id="kobo.4.2">You will notice that the code base is almost identical, with the exception of three changes that we will outline here:</span></p>
<pre><span class="koboSpan" id="kobo.5.1">var height = 600; 
var width = 900; 
var projection = d3.geo.orthographic().clipAngle(90); 
var path = d3.geo.path().projection(projection); </span></pre>
<p><span class="koboSpan" id="kobo.6.1">First, we will change our </span><kbd><span class="koboSpan" id="kobo.7.1">d3.geo</span></kbd><span class="koboSpan" id="kobo.8.1"> projection from </span><kbd><span class="koboSpan" id="kobo.9.1">d3.geo.mercator</span></kbd><span class="koboSpan" id="kobo.10.1"> to </span><kbd><span class="koboSpan" id="kobo.11.1">d3.geo.orthographic</span></kbd><span class="koboSpan" id="kobo.12.1">. </span><span class="koboSpan" id="kobo.12.2">We also have an additional setting to configure: the </span><kbd><span class="koboSpan" id="kobo.13.1">clipAngle</span></kbd><span class="koboSpan" id="kobo.14.1"> at </span><kbd><span class="koboSpan" id="kobo.15.1">90</span></kbd><span class="koboSpan" id="kobo.16.1"> degrees. </span><span class="koboSpan" id="kobo.16.2">This places an imaginary plane through the globe and clips the back of the projection:</span></p>
<pre><span class="koboSpan" id="kobo.17.1">d3.json('world.json', function(data) { 
var countries = topojson.feature(data, data.objects.countries); 
var map = svg.append('g').attr('class', 'boundary'); 
var world = map.selectAll('path').data(countries.features); </span></pre>
<p><span class="koboSpan" id="kobo.18.1">Next, we will substitute the old </span><kbd><span class="koboSpan" id="kobo.19.1">geo-data.json</span></kbd><span class="koboSpan" id="kobo.20.1"> file for the new datafile, </span><kbd><span class="koboSpan" id="kobo.21.1">world.json</span></kbd><span class="koboSpan" id="kobo.22.1">. </span><span class="koboSpan" id="kobo.22.2">We will also set up new variables for our data joining in order to provide better readability in the code:</span></p>
<pre><span class="koboSpan" id="kobo.23.1">world.enter() 
      .append('path') 
      .attr('d', path); </span></pre>
<p><span class="koboSpan" id="kobo.24.1">As we have seen many times now, we will apply the standard </span><kbd><span class="koboSpan" id="kobo.25.1">enter()</span></kbd><span class="koboSpan" id="kobo.26.1"> pattern. </span><span class="koboSpan" id="kobo.26.2">You should now have a static map of the globe, as seen in the following screenshot. </span><span class="koboSpan" id="kobo.26.3">You can also work directly with </span><kbd><span class="koboSpan" id="kobo.27.1">example-4.html</span></kbd><span class="koboSpan" id="kobo.28.1">.</span></p>
<p><span class="koboSpan" id="kobo.29.1">In the last two sections, we will bring the globe to life!</span></p>
<div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.30.1"><img height="311" width="307" src="assets/36a69fdf-fade-4ec3-94f7-c3e6690a03e8.png"/></span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Experiment 5 – rotating orthographic projections</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Our previous example was very fascinating. </span><span class="koboSpan" id="kobo.2.2">We went from visualizing a map in two dimensions to three dimensions with just a few lines. </span><span class="koboSpan" id="kobo.2.3">The next step is to animate it. </span><span class="koboSpan" id="kobo.2.4">For this experiment, open </span><kbd><span class="koboSpan" id="kobo.3.1">http://localhost:8080/chapter-5/example-5.html</span></kbd><span class="koboSpan" id="kobo.4.1"> in the code samples. </span><span class="koboSpan" id="kobo.4.2">Let's now piece it together:</span></p>
<pre><span class="koboSpan" id="kobo.5.1">var i = 0; </span></pre>
<p><span class="koboSpan" id="kobo.6.1">We added an index variable that will hold the rotation rate. </span><span class="koboSpan" id="kobo.6.2">Don't worry; we'll explain how this is used here:</span></p>
<pre><span class="koboSpan" id="kobo.7.1">d3.json('world.json', function(data) { 
var countries = topojson.feature(data, data.objects.countries); 
var mexico = countries.features[102]; </span></pre>
<p><span class="koboSpan" id="kobo.8.1">As Mexico is the center of the universe and requires special attention, we isolated it into its own variable by taking the corresponding feature from the countries' feature array. </span><span class="koboSpan" id="kobo.8.2">This will allow us to manipulate it separately from the rest of the globe:</span></p>
<pre><span class="koboSpan" id="kobo.9.1">var map = svg.append('g').attr('class', 'boundary'); 
var world = map.selectAll('path').data(countries.features); 
var mexico = map.selectAll('.mexico').data([mexico]); </span></pre>
<p><span class="koboSpan" id="kobo.10.1">Next, we will data join the information we isolated earlier to its own variable. </span><span class="koboSpan" id="kobo.10.2">This way, we will have one map that represents the entire world and another one that represents just Mexico:</span></p>
<pre><span class="koboSpan" id="kobo.11.1">mexico.enter() 
  .append('path') 
  .attr('class', 'mexico') 
  .attr('d', path) 
  .style('fill', 'lightyellow').style('stroke', 'orange'); </span></pre>
<p><span class="koboSpan" id="kobo.12.1">We will inject the map of Mexico and apply the </span><kbd><span class="koboSpan" id="kobo.13.1">geo.path</span></kbd><span class="koboSpan" id="kobo.14.1"> that contains the same projection we used for the world map. </span><span class="koboSpan" id="kobo.14.2">We will also add a light yellow background to Mexico using the </span><kbd><span class="koboSpan" id="kobo.15.1">fill</span></kbd><span class="koboSpan" id="kobo.16.1"> CSS style and an orange border using the stroke:</span></p>
<pre><span class="koboSpan" id="kobo.17.1">setInterval(function() { 
i = i+0.2; 
      // move i around in the array to get a feel for yaw, pitch 
      // and roll 
      // see diagram 
projection.rotate([i,0,0]) 
world.attr('d', path); 
mexico.attr('d', path)</span><br/><span class="koboSpan" id="kobo.18.1">   .style('fill', 'lightyellow').style('stroke', 'orange'); 
    }, 20); </span></pre>
<p><span class="koboSpan" id="kobo.19.1">This is where the action starts, literally. </span><span class="koboSpan" id="kobo.19.2">We created an interval that executes every 20 milliseconds. </span><span class="koboSpan" id="kobo.19.3">This interval contains a function that utilizes our index variable and increments the value by </span><kbd><span class="koboSpan" id="kobo.20.1">0.2</span></kbd><span class="koboSpan" id="kobo.21.1">. </span><span class="koboSpan" id="kobo.21.2">This value is then applied to the </span><kbd><span class="koboSpan" id="kobo.22.1">rotate</span></kbd><span class="koboSpan" id="kobo.23.1"> function of our projection. </span><span class="koboSpan" id="kobo.23.2">Specifically, we will adjust the rotation every </span><kbd><span class="koboSpan" id="kobo.24.1">20</span></kbd><span class="koboSpan" id="kobo.25.1"> ms on this line of code:</span></p>
<pre><span class="koboSpan" id="kobo.26.1">projection.rotate([i,0,0]) </span></pre>
<p><span class="koboSpan" id="kobo.27.1">Yaw is represented by the first value of the array (in this case, </span><kbd><span class="koboSpan" id="kobo.28.1">i</span></kbd><span class="koboSpan" id="kobo.29.1">), pitch represented by the second value, and roll by the third value. </span><span class="koboSpan" id="kobo.29.2">Yaw, pitch, and roll are rotation angles and are applied in their respective vectors. </span><span class="koboSpan" id="kobo.29.3">The following image provides an illustration of how the angles rotate:</span></p>
<div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.30.1"><img src="assets/4e02e608-c616-4261-b527-1a2d6c55e0c2.png"/></span></div>
<p><span class="koboSpan" id="kobo.31.1">Here, we see that the yaw vector points in the </span><em><span class="koboSpan" id="kobo.32.1">z</span></em><span class="koboSpan" id="kobo.33.1"> direction and is around the center axis. </span><span class="koboSpan" id="kobo.33.2">The pitch goes along our </span><em><span class="koboSpan" id="kobo.34.1">x</span></em><span class="koboSpan" id="kobo.35.1"> axis, and the yaw goes around our </span><em><span class="koboSpan" id="kobo.36.1">y</span></em><span class="koboSpan" id="kobo.37.1"> axis. </span><span class="koboSpan" id="kobo.37.2">The Greek characters (in parentheses in the preceding image) are often used to depict yaw, pitch, and roll.</span></p>
<p><span class="koboSpan" id="kobo.38.1">In our case, the index variable, </span><kbd><span class="koboSpan" id="kobo.39.1">i</span></kbd><span class="koboSpan" id="kobo.40.1">, is increasing and is allocated to the yaw rotation. </span><span class="koboSpan" id="kobo.40.2">This means that our globe will spin from left to right around the center axis. </span><span class="koboSpan" id="kobo.40.3">If we were to swap the position of our index so that it is in the pitch location (the second array element), our globe would spin vertically:</span></p>
<pre><span class="koboSpan" id="kobo.41.1">project.rotate([0,i,0]); </span></pre>
<p><span class="koboSpan" id="kobo.42.1">Finally, we will use the same D3 update pattern and update all the paths with the new projection. </span><span class="koboSpan" id="kobo.42.2">Give it a shot, play around with the example, and see how the globe spins in different directions. </span><span class="koboSpan" id="kobo.42.3">When complete, you will see the rotating globe in your browser, as in the following screenshot:</span></p>
<div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.43.1"><img height="417" width="364" src="assets/a7deb056-1d3c-4323-87a0-c2731f5e91f5.png"/></span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Experiment 6 – dragging orthographic projections</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">For our last example, we will add the ability to drag our globe so that the user can spin it to the left or right. </span><span class="koboSpan" id="kobo.2.2">Open </span><kbd><span class="koboSpan" id="kobo.3.1">http://localhost:8080/chapter-5/example-6.html</span></kbd><span class="koboSpan" id="kobo.4.1"> from the code samples and let's get started:</span></p>
<pre><span class="koboSpan" id="kobo.5.1">var dragging = function(d) { 
var c = projection.rotate(); 
projection.rotate([c[0] + d3.event.dx/2, c[1], c[2]]) 
 
world.attr('d', path); 
mexico.attr('d', path) 
        .style('fill', 'lightyellow').style('stroke', 'orange'); 
}; </span></pre>
<p><span class="koboSpan" id="kobo.6.1">Our first piece of new code is our dragging event handler. </span><span class="koboSpan" id="kobo.6.2">This function will be executed every time the user drags the mouse on the screen. </span><span class="koboSpan" id="kobo.6.3">The algorithm executes the following steps:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.7.1">Stores the current rotation value.</span></li>
<li><span class="koboSpan" id="kobo.8.1">Updates the projection's rotation based on the distance it is dragged.</span></li>
<li><span class="koboSpan" id="kobo.9.1">Updates all the paths in the world map.</span></li>
<li><span class="koboSpan" id="kobo.10.1">Updates all the paths in the map of Mexico.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.11.1">The second step deserves a little more explanation. </span><span class="koboSpan" id="kobo.11.2">Just like the </span><kbd><span class="koboSpan" id="kobo.12.1">d3.behavior.zoom</span></kbd><span class="koboSpan" id="kobo.13.1"> event handler, </span><kbd><span class="koboSpan" id="kobo.14.1">d3.behavior.drag</span></kbd><span class="koboSpan" id="kobo.15.1"> exposes information about the performed action. </span><span class="koboSpan" id="kobo.15.2">In this case, </span><kbd><span class="koboSpan" id="kobo.16.1">d3.event.dx</span></kbd><span class="koboSpan" id="kobo.17.1"> and </span><kbd><span class="koboSpan" id="kobo.18.1">d3.event.dy</span></kbd><span class="koboSpan" id="kobo.19.1"> indicate the distance dragged from the previous location. </span><span class="koboSpan" id="kobo.19.2">The </span><kbd><span class="koboSpan" id="kobo.20.1">c[0] + d3.event.dx/2</span></kbd><span class="koboSpan" id="kobo.21.1"> code tells us that we need to take the previous yaw value and add the amount of drag the user is performing. </span><span class="koboSpan" id="kobo.21.2">We will divide the drag amount by two to slow down the rotation by half; otherwise, every pixel the user drags will correlate to </span><em><span class="koboSpan" id="kobo.22.1">1</span></em><span class="koboSpan" id="kobo.23.1"> degree of rotation:</span></p>
<pre><span class="koboSpan" id="kobo.24.1">var drag = d3.behavior.drag() 
    .on("drag", dragging); </span></pre>
<p><span class="koboSpan" id="kobo.25.1">Next, we will bind our </span><kbd><span class="koboSpan" id="kobo.26.1">dragging</span></kbd><span class="koboSpan" id="kobo.27.1"> method to our drag event, as we saw earlier, with click, hover, and zoom:</span></p>
<pre><span class="koboSpan" id="kobo.28.1">svg.append("rect") 
      .attr("class", "overlay") 
      .attr("width", width) 
      .attr("height", height) 
      .call(drag); </span></pre>
<p><span class="koboSpan" id="kobo.29.1">Finally, we need an area to bind our drag event. </span><span class="koboSpan" id="kobo.29.2">Using our previous technique, we will add a transparent rectangle on top of the visualization. </span><span class="koboSpan" id="kobo.29.3">This will allow us to very clearly detect the </span><em><span class="koboSpan" id="kobo.30.1">x</span></em><span class="koboSpan" id="kobo.31.1"> and </span><em><span class="koboSpan" id="kobo.32.1">y</span></em><span class="koboSpan" id="kobo.33.1"> positions on our SVG element.</span></p>
<p><span class="koboSpan" id="kobo.34.1">Give it a spin! </span><span class="koboSpan" id="kobo.34.2">You'll notice that if you click-and-drag the world, it will spin in the corresponding yaw direction:</span></p>
<div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.35.1"><img height="381" width="362" src="assets/3097f608-1f0f-412b-959b-d0159a2e35c5.png"/></span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Summary</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">We covered many examples to get you started with interactivity for your D3 map visualizations. </span><span class="koboSpan" id="kobo.2.2">We went over the basics of event handling, explored various methods to bind events to the map, outlined the two </span><kbd><span class="koboSpan" id="kobo.3.1">d3.behavior</span></kbd><span class="koboSpan" id="kobo.4.1"> APIs, and even dipped our toes into orthographic projections. </span><span class="koboSpan" id="kobo.4.2">If you wish to dig deeper into world rotations, and the math involved, check out the Jason Davies article at: </span><a href="http://www.jasondavies.com/maps/rotate/"><span class="URLPACKT"><span class="koboSpan" id="kobo.5.1">http://www.jasondavies.com/maps/rotate/</span></span></a><span class="koboSpan" id="kobo.6.1">.</span></p>
<p><span class="koboSpan" id="kobo.7.1">After two chapters of drawing and interacting with maps, the next chapter will explain how to obtain geo data in order to create any map you want. </span><span class="koboSpan" id="kobo.7.2">We'll also include some techniques to optimize the data files for viewing the web.</span></p>


            </article>

            
        </section>
    </body></html>