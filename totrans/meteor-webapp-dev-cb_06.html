<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Mastering Reactivity" id="aid-1NA0K1"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Mastering Reactivity</h1></div></div></div><p>In this chapter, you will learn the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Creating and consuming a reactive value</li><li class="listitem">Using Ajax query results in ReactiveVar</li><li class="listitem">Making a custom library reactive</li><li class="listitem">Updating Blaze templates without Mongo</li><li class="listitem">Using inline data to modify UI elements reactively</li><li class="listitem">Integrating the jQuery UI</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec52"/>Introduction</h1></div></div></div><p><span class="strong"><strong>Reactive programming</strong></span> is an emerging development methodology, where changes to data automatically trigger changes to the rest of the system. This allows you, the developer, to write code declaratively and let the reactive elements manage any changes. Meteor is, perhaps, the <a id="id268" class="indexterm"/>best and most fully developed implementation of reactive programming available today. By understanding the core concepts of reactive programming, you can use the <code class="literal">Tracker</code> (formerly <code class="literal">Deps</code>) library to create simple, declarative code while avoiding the usual pitfalls associated with reactive and asynchronous JavaScript programming. The recipes in this chapter will give you simple, clear examples of how the major components of Meteor's reactive model work.</p></div></div>
<div class="section" title="Creating and consuming a reactive value"><div class="titlepage" id="aid-1O8H62"><div><div><h1 class="title"><a id="ch06lvl1sec53"/>Creating and consuming a reactive value</h1></div></div></div><p><code class="literal">Tracker</code>, simply <a id="id269" class="indexterm"/>put, is Meteor's variable tracking system. It is used to <a id="id270" class="indexterm"/>manage reactive values, data structures, and computations (functions that consume reactive values). This recipe will show you how to create reactive values, and perform computations on those values, using <code class="literal">Tracker.autorun()</code>. In other words, it will teach you how reactive programming works inside Meteor. This recipe will come in handy as a foundation for more complex functionalities.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec187"/>Getting ready</h2></div></div></div><p>For the sake of simplicity, we will be using a default Meteor project, with the <code class="literal">reactive-var</code> package added to it. Open a terminal window, navigate to where you would like to create your root project, and execute the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ meteor create reactiverecipes</strong></span>
<span class="strong"><strong>$ cd reactiverecipes</strong></span>
<span class="strong"><strong>$ meteor add reactive-var</strong></span>
<span class="strong"><strong>$ meteor</strong></span>
</pre></div><p>You are now ready to start using reactive variables.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec188"/>How to do it...</h2></div></div></div><p>We are going to <a id="id271" class="indexterm"/>modify the text of a button, based on a reactive variable; so <a id="id272" class="indexterm"/>we will need to create the button and hook up the reactive context.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open your project in your favorite text editor and edit the <code class="literal">reactiverecipes.html</code> file, adding an ID to the <code class="literal">&lt;button&gt;</code> element, as shown in the following example:<div class="informalexample"><pre class="programlisting">&lt;button <span class="strong"><strong>id='btnReact'</strong></span>&gt;Click Me&lt;/button&gt;</pre></div></li><li class="listitem">Now, open <code class="literal">reactiverecipes.js</code> and add the following lines of code just below the <code class="literal">if (Meteor.isClient)</code> condition:<div class="informalexample"><pre class="programlisting"> if (Meteor.isClient) {
<span class="strong"><strong>    btnText = new ReactiveVar('Click Me');</strong></span>
<span class="strong"><strong>    Tracker.autorun(function () {</strong></span>
<span class="strong"><strong>        $('#btnReact').text(btnText.get());</strong></span>
<span class="strong"><strong>    });</strong></span>
</pre></div></li><li class="listitem">Finally, add the following line inside the <code class="literal">Template.hello.events</code> declaration, just below the <code class="literal">Session.set()</code> function in the <code class="literal">'click button'</code> function:<div class="informalexample"><pre class="programlisting">Session.set("counter"...);
<span class="strong"><strong>btnText.set('Again!');</strong></span>
</pre></div></li><li class="listitem">Save your changes and navigate to <code class="literal">http://localhost:3000</code> in a browser. Once there, click on the button labeled <span class="strong"><strong>Click Me</strong></span> and watch the text change to <span class="strong"><strong>Again!</strong></span>:<div class="mediaobject"><img src="../Images/image00374.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>You can manually change the value of the button text by opening a console window in your browser and using the <code class="literal">btnText.set()</code> command, as shown in the following example:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt; btnText.set('Pretty please...')</strong></span>
</pre></div><p>The button text will <a id="id273" class="indexterm"/>change to whatever value you set it to, instantly.</p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec189"/>How it works...</h2></div></div></div><p>The preceding example seems oversimplified, but we have two things to say about that.</p><p>First, it's simple because <a id="id274" class="indexterm"/>Meteor was built to make your code very simple and easy to follow. This makes your development and debug efforts significantly less time consuming.</p><p>Notice how the process of declaring a reactive variable is made up of one line of code. When we added the <code class="literal">btnText = new ReactiveVar('Click Me')</code> statement, we were simply declaring a variable (and initializing its value to <code class="literal">'Click Me'</code>), but we know by the declaration that it is a reactive variable.</p><p>Next, we <a id="id275" class="indexterm"/>encapsulated an extremely straightforward jQuery statement inside a <code class="literal">Tracker.autorun()</code> block. This block is called a <span class="strong"><strong>reactive computation</strong></span>. Reactive computations run once initially and then rerun (are recomputed) whenever a change is made to any reactive variables contained inside. So, in this example, we told <code class="literal">Tracker</code> to monitor the value of <code class="literal">btnText</code>(a reactive variable) and automatically run (hence the term <code class="literal">autorun</code>) the code block again when it would change.</p><p>Notice that we don't have to worry about any time conditions, such as "is this the first run?" or "okay, when there's a change…." We just simply declare the jQuery statement and let <code class="literal">Tracker</code> figure out the timing for us.</p><p>This is what the term <span class="strong"><strong>transparent reactive programming</strong></span> means. There is one set of code for the initialization and another set of code for changes. Besides the variable declarations, your entire code base can be written as normal, plain old JavaScript.</p><p>Second, what it's doing under the hood is anything but simple! To create this frontend simplicity for you, the programmer, Meteor implements reactive providers and reactive computations.</p><p>We'll sacrifice a bit of fidelity to make the concept simpler to understand. When <code class="literal">Tracker.autorun</code> is called, it does four things:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">It creates a computation</li><li class="listitem">It sets <code class="literal">Tracker.currentComputation</code> to that computation</li><li class="listitem">It calls the function that was passed to it</li><li class="listitem">It sets <code class="literal">Tracker.currentComputation</code> to <code class="literal">null</code></li></ul></div><p>A computation is essentially an event handler function and contains a reference to the function that was passed to <code class="literal">Tracker.autorun</code>. The event that the computation is waiting for is a call to the <code class="literal">computation.invalidate</code> method. When the <code class="literal">invalidate</code> method is called, the computation reruns the function it contains.</p><p>Now we come to the <a id="id276" class="indexterm"/>function. The function passed to <code class="literal">Tracker.autorun</code> is considered a reactive function if it contains <span class="strong"><strong>reactive providers</strong></span>. A reactive provider is an <a id="id277" class="indexterm"/>object that has functions to get and set some value, <a id="id278" class="indexterm"/>and keeps track of dependencies. When the <code class="literal">get</code> function is called, it does three things:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">It checks to see whether <code class="literal">Tracker.currentComputation</code> has a value.</li><li class="listitem">If it does, the computation is added to an internal list.</li><li class="listitem">It returns the value of the variable that the getter requested.</li></ol><div style="height:10px; width: 1px"/></div><p>Both steps 1 and 2 are performed by making a call to <code class="literal">depend()</code>, which is a method found on a dependency object. The <code class="literal">reactive-var</code> library automates this part, so you don't have to call the <code class="literal">depend()</code> method directly. All you have to do is use the reactive variable!</p><p>Likewise, when the <code class="literal">set</code> function is called, it does two things:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">It changes the value of the internal variable</li><li class="listitem">For every computation in the internal list, the <code class="literal">invalidate()</code> method is called</li></ul></div><p>The <code class="literal">invalidate()</code> methods are called in a loop by making a call to <code class="literal">changed()</code>, which is a <code class="literal">helper</code> method found on a dependency object. Again, <code class="literal">reactive-var</code> takes care of this for you. You're welcome!</p><p>When each computation is invalidated, it reruns the function that it contains. And the entire loop starts over with the newly rerun function calling the getters, which return their values (like the <code class="literal">text</code> value of our <code class="literal">btnReact</code> button) and add the computations to the provider's internal list, waiting once again for the setter to be called.</p><p>Even though they are extremely oversimplified (any core MDG members reading this are probably spitting coffee <a id="id279" class="indexterm"/>right now…), here is what the <code class="literal">ReactiveVar</code> <a id="id280" class="indexterm"/>and <code class="literal">autorun</code> objects do:</p><div class="informalexample"><pre class="programlisting">function ReactiveVar(value) {
<span class="strong"><strong>    // create the dependency object (a helper class)</strong></span>
    var _dependency = new Tracker.Dependency;
<span class="strong"><strong>    //set the default internal value</strong></span>
    var _internalVal = value;
    
    var getValue = function () {
<span class="strong"><strong>        // call depend(), which adds the computation</strong></span>
        _dependency.depend();
<span class="strong"><strong>        // return the internal value</strong></span>
        return _internalVal;
    };

    var setValue = function (newValue) {
<span class="strong"><strong>        // update the internal value</strong></span>
        _internalVal = newValue;
<span class="strong"><strong>        // loop through computations and call invalidate()</strong></span>
        _dependency.changed();
    };
    
    return this;
}


function autorun(func) {
<span class="strong"><strong>    // creates computation and assigns it to</strong></span>
<span class="strong"><strong>    // Tracker.currentComputation</strong></span>
    var computation = new Tracker.Computation(func, Tracker.currentComputation);
    
    // Calls the onInvalidate method the first time,
    // so that func function will run
    Tracker.onInvalidate({...});

    return computation;
}</pre></div><p>There are two things that we left out, for clarity, but are important in order to have a complete understanding. First, the <code class="literal">depend()</code> helper method also sets up an <code class="literal">onInvalidate()</code> listener, which removes the computation from the reactive provider's internal list. Second, computations are checked to see whether they already exist in an internal list before they are added.</p><p>Why are the computations removed when the computation is invalidated, you may ask? The answer, in short, is that it makes the entire computation <code class="literal">add-execute-remove</code> loop very elegant. It keeps all the computations up to date and the dependent functions only run once each, no matter how many times a getter is called inside the same function. If they weren't removed, the functions would be run multiple times, which is <span class="emphasis"><em>no bueno</em></span>.</p><p>So let's review what we did in this recipe:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <code class="literal">autorun</code> method creates a computation and passes your function to this computation</li><li class="listitem">The computation has an <code class="literal">onInvalidate</code> method that, among other things, runs your function</li><li class="listitem">After <code class="literal">autorun</code> has created a computation, it runs your function once, using the <code class="literal">onInvalidate</code> method</li><li class="listitem">Your function has reactive variables in it, which have to-do lists</li><li class="listitem">As your function runs, getters are called, which add the computations to the to-do lists</li><li class="listitem">Setters are also <a id="id281" class="indexterm"/>called, which execute the to-do lists and clear them</li><li class="listitem">Because your <a id="id282" class="indexterm"/>functions in the to-do lists have reactive variables, the process is repeated (the functions are rerun)</li><li class="listitem">Lather, rinse, and repeat</li></ul></div><p>Again, this explanation is drastically simplified, and therefore, pretty inaccurate; however, conceptually, it will hopefully give you a good understanding of what's happening under the hood.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec190"/>There's more…</h2></div></div></div><p>Meteor also provides the <code class="literal">ReactiveDict</code> object, which runs exactly like <code class="literal">ReactiveVar</code>, but can store collections of reactive variables in key-value pairs. The syntax is exactly the same as for <code class="literal">ReactiveVar</code>, but you will need to add a key to the <code class="literal">set</code> and <code class="literal">get</code> methods, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">    btnText.get(); // ReactiveVar
    txtFields.get(<span class="strong"><strong>'btnText'</strong></span>); // ReactiveDict
    ...
    btnText.set('Click Me'); // ReactiveVar
    txtFields.set(<span class="strong"><strong>'btnText'</strong></span>,'Click Me') // ReactiveDict</pre></div><p>To use <code class="literal">ReactiveDict</code>, simply add the <code class="literal">reactive-dict</code> package using the following terminal command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ meteor add reactive-dict</strong></span>
</pre></div><p>Lastly, you don't have to <a id="id283" class="indexterm"/>use <code class="literal">ReactiveVar</code>, or <code class="literal">ReactiveDict</code>, and <a id="id284" class="indexterm"/>can instead <span class="emphasis"><em>roll your own</em></span> reactive providers. Please see the <span class="emphasis"><em>Making a custom library reactive</em></span> recipe found in this chapter as an example.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec191"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="emphasis"><em>Creating dynamic lists</em></span> recipe in <a class="link" title="Chapter 3. Building Great User Interfaces" href="part0036.xhtml#aid-12AK81">Chapter 3</a>, <span class="emphasis"><em>Building Great User Interfaces</em></span></li><li class="listitem">The <span class="emphasis"><em>Making a custom library reactive</em></span> recipe in this chapter</li></ul></div></div></div>
<div class="section" title="Using Ajax query results in ReactiveVar"><div class="titlepage" id="aid-1P71O2"><div><div><h1 class="title"><a id="ch06lvl1sec54"/>Using Ajax query results in ReactiveVar</h1></div></div></div><p>Whenever we <a id="id285" class="indexterm"/>use Ajax, requesting (and even receiving) data is pretty easy. The complications come in when we have to update the UI with new <a id="id286" class="indexterm"/>or updated data. With Meteor's reactive programming capabilities, this is no longer an issue. In this recipe, you will see how to update your UI with Ajax results, using Meteor's <code class="literal">ReactiveVar</code> library.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec192"/>Getting ready</h2></div></div></div><p>To get up and run quickly, we will use a default Meteor project with a few packages added. Open a terminal window, navigate to where you would like to create your root project, and execute the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ meteor create ajaxreactive</strong></span>
<span class="strong"><strong>$ cd ajaxreactive</strong></span>
<span class="strong"><strong>$ meteor add reactive-var</strong></span>
<span class="strong"><strong>$ meteor add http</strong></span>
<span class="strong"><strong>$ meteor add twbs:bootstrap</strong></span>
<span class="strong"><strong>$ meteor</strong></span>
</pre></div><p>We are now ready to build a reactive Ajax query!</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec193"/>How to do it…</h2></div></div></div><p>We will be pulling the weather data from <code class="literal">openweathermap.org</code>, using their free (but for testing only) API. We will take the results from our <code class="literal">openweathermap.org</code> queries and put them into a <code class="literal">ReactiveVar</code> library so that they can then be consumed reactively by our Blaze templates.</p><p>Let's start by modifying the UI:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <a id="id287" class="indexterm"/><code class="literal">ajaxreactive.html</code> and add a call to our soon-to-be-created <code class="literal">weather</code> template, just <a id="id288" class="indexterm"/>under the call to the existing <code class="literal">hello</code> template, as shown in the following code:<div class="informalexample"><pre class="programlisting">{{&gt; hello}}
<span class="strong"><strong>{{&gt; weather}}</strong></span>
</pre></div></li><li class="listitem">We will also want to repurpose the counter in our <code class="literal">hello</code> template to tell us what the starting longitude will be. Change the description in the <code class="literal">&lt;p&gt;</code> element inside the <code class="literal">hello</code> template, as follows:<div class="informalexample"><pre class="programlisting">&lt;template name="hello"&gt;
    &lt;button&gt;Click Me&lt;/button&gt;
    &lt;p&gt;<span class="strong"><strong>You are starting at {{counter}} longitude.</strong></span>&lt;/p&gt;
&lt;/template&gt;</pre></div></li><li class="listitem">Next, add our <code class="literal">weather</code> template, which is just a simple table with a bit of prettiness added, thanks to bootstrap! At the bottom of <code class="literal">ajaxreactive.html</code>, add the following template:<div class="informalexample"><pre class="programlisting">&lt;template name="weather"&gt;
    {{#if reports}}
    &lt;table class="table"&gt;
        &lt;thead&gt;
            &lt;th&gt;name&lt;/th&gt;
            &lt;th&gt;weather&lt;/th&gt;
            &lt;th&gt;temp&lt;/th&gt;
            &lt;th&gt;humidity&lt;/th&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;
    {{#each reports}}
            &lt;tr class={{severity}}&gt;
                &lt;td&gt;{{name}}&lt;/td&gt;
                &lt;td&gt;{{description}}&lt;/td&gt;
                &lt;td&gt;{{temp}}&lt;/td&gt;
                &lt;td&gt;{{humidity}}&lt;/td&gt;
            &lt;/tr&gt;
    {{/each}}
        &lt;/tbody&gt;
    &lt;/table&gt;
    {{/if}}
&lt;/template&gt;</pre></div></li><li class="listitem">Save your changes and navigate to <code class="literal">http://localhost:3000</code>. While nothing (except the description of the counter) will change, we will very soon want to view our weather data.</li><li class="listitem">Let's open <code class="literal">ajaxreactive.js</code> and declare our <code class="literal">ReactiveVar</code> libraries. Just below <code class="literal">Session.setDefault()</code>, add the following code:<div class="informalexample"><pre class="programlisting">Session.setDefault("counter", 0);
<span class="strong"><strong>weatherlist = new ReactiveVar;</strong></span>
</pre></div></li><li class="listitem">We will now modify the <code class="literal">'click button'</code> function to increment the counter and make our Ajax call. Locate the function inside the <code class="literal">Template.hello.events</code> section and modify the code as follows:<div class="informalexample"><pre class="programlisting">// increment the counter when button is clicked
<span class="strong"><strong>if (Session.get("counter") &lt;= 60)</strong></span>
    Session.set("counter", Session.get("counter") + 4);
<span class="strong"><strong>else</strong></span>
<span class="strong"><strong>    Session.set("counter", 0)</strong></span>
<span class="strong"><strong>    </strong></span>
<span class="strong"><strong>getWeather();</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title"><a id="note06"/>Note</h3><p>Don't forget to update the counter increment to <code class="literal">4</code>; otherwise, your <code class="literal">weather</code> data won't change much as you click.</p></div></li><li class="listitem">Next, we need to add <code class="literal">Template.weather.helpers</code> so that our UI will populate <a id="id289" class="indexterm"/>properly. Just after the <a id="id290" class="indexterm"/><code class="literal">Template.hello.events</code> section, add the following:<div class="informalexample"><pre class="programlisting">Template.weather.helpers({
    reports: function () {
        if (!weatherlist) return false;
        return weatherlist.get();
    },
    severity: function () {
        if (this.weather &amp;&amp; this.weather[0].main == "Clear")
            return "success";
        else
            return "warning";
    },
    description: function () {
        if (this.weather &amp;&amp; this.weather[0])
            return this.weather[0].description;
        else
            return "";
    },
    temp: function () {
        if (this.main)
            return this.main.temp;
        else
            return "";
    },
    humidity: function () {
        if (this.main)
            return this.main.humidity;
        else
            return "";
    }
});</pre></div></li><li class="listitem">Finally, we need to add our Ajax call and the asynchronous callback function once the result <a id="id291" class="indexterm"/>comes in. Just after the <a id="id292" class="indexterm"/><code class="literal">Template.weather.helpers</code> section, add the following two functions:<div class="informalexample"><pre class="programlisting">function getWeather() {
    var long1 = +Session.get("counter"),
        long2 = long1+5;
    HTTP.get("http://api.openweathermap.org/data/2.5/
  box/city?bbox=12,"+long1+",15,"+long2+",10&amp;cluster=yes", 
  harvestWeather);
}
function harvestWeather(error, data) {
    if (data &amp;&amp; data.content) {
        var weather = EJSON.parse(data.content);
        weatherlist.set(weather.list);
    }
}</pre></div></li><li class="listitem">Save all your changes and click on the button on the project page in your browser. You should see something similar to the following screenshot:<div class="mediaobject"><img src="../Images/image00375.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><p>As you click, the weather results for a given area, moving towards north, will be displayed.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec194"/>How it works…</h2></div></div></div><p>In this instance, we didn't use a Mongo collection, which is automatically reactive. Instead, we made <a id="id293" class="indexterm"/>calls to <code class="literal">openweather.org api</code> and updated a <code class="literal">ReactiveVar</code> library (in this case, the <code class="literal">weatherList</code> <a id="id294" class="indexterm"/>variable) using the <code class="literal">set</code> method. Because the template helpers rely on a call to the <code class="literal">get</code> method of that same <code class="literal">ReactiveVar</code>, they are automatically rerun when the <code class="literal">ReactiveVar</code> is updated. Let's break it down.</p><p>We first created the <code class="literal">weather</code> template in our HTML:</p><div class="informalexample"><pre class="programlisting">&lt;template name="weather"&gt;
  {{#if reports}}
  ...
  {{/if}}
&lt;/template&gt;</pre></div><p>The template iterates over the <code class="literal">reports</code> helper object using an <code class="literal">{{#each...}}</code> block, populating an HTML table with the results.</p><p>Next, inside our client-side JavaScript, we declared our reactive variable, <code class="literal">weatherlist</code>, using a new <code class="literal">ReactiveVar</code> library:</p><div class="informalexample"><pre class="programlisting">weatherlist = new ReactiveVar;</pre></div><p>We then used <code class="literal">weatherlist.get()</code> in our <code class="literal">reports</code> helper object, which is in <code class="literal">Template.weather.helpers</code>:</p><div class="informalexample"><pre class="programlisting">reports: function () {
  ...
  return weatherlist.get();
}</pre></div><p>By using it here, we set up a dependency so that anytime <code class="literal">weatherlist.set()</code> is called, the data for the template is refreshed and the template is updated/rerun.</p><p>Finally, we hooked up our button to an Ajax call using <code class="literal">HTTP.get()</code>, and we passed the <code class="literal">harvestWeather</code> function as a callback (<code class="literal">HTTP.get(url,arg,callback)</code>):</p><div class="informalexample"><pre class="programlisting">function getWeather() {
  var long1 = ...
  HTTP.get("...", harvestWeather);
}</pre></div><p>Once the callback is triggered, it massages the data from the Ajax call and repopulates our reactive variable using <code class="literal">weatherlist.set()</code>:</p><div class="informalexample"><pre class="programlisting">function harvestWeather(error, data) {
  ...
    weatherlist.set(weather.list);
}</pre></div><p>As mentioned in the preceding section, when this <code class="literal">set</code> function is called, it invalidates the template functions and reactively updates our UI.</p><p>You can see very <a id="id295" class="indexterm"/>clearly in the callback function (<code class="literal">harvestWeather</code>), and in the weather template helper function (<code class="literal">reports</code>), that the calls are regular, plain JavaScript. We're literally just calling a <code class="literal">get</code> or <code class="literal">set</code> function. Because the object we're <a id="id296" class="indexterm"/>calling those functions on is a <code class="literal">ReactiveVar</code>, all the reactive dependencies and UI updates are handled for us.</p><p>You can begin to quickly see how powerful Meteor's reactive programming model is. Instead of messing around with events and handlers or worrying about callback hell, we used a simple, clean <code class="literal">set</code> command and let Meteor handle all the details for us.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec195"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="emphasis"><em>Creating dynamic lists</em></span> recipe in <a class="link" title="Chapter 3. Building Great User Interfaces" href="part0036.xhtml#aid-12AK81">Chapter 3</a>, <span class="emphasis"><em>Building Great User Interfaces</em></span></li><li class="listitem">The <span class="emphasis"><em>Creating and consuming a reactive value</em></span> recipe in this chapter</li></ul></div></div></div>
<div class="section" title="Making a custom library reactive"><div class="titlepage" id="aid-1Q5IA2"><div><div><h1 class="title"><a id="ch06lvl1sec55"/>Making a custom library reactive</h1></div></div></div><p>Because we so <a id="id297" class="indexterm"/>often deal with variables and data, it can go unnoticed that Meteor's reactivity doesn't only work with reactive values. Any function from any JavaScript library can be turned into a reactive provider. This recipe will show you how to create your own reactive providers using the <code class="literal">Tracker.depend()</code> and <code class="literal">Tracker.changed()</code> commands.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec196"/>Getting ready</h2></div></div></div><p>To keep the example simple, we will use a default Meteor project, with a <code class="literal">bootstrap</code> package, and a random color generator. Open a terminal window, navigate to where you would like to create your root project, and execute the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ meteor create customreactive</strong></span>
<span class="strong"><strong>$ cd customreactive</strong></span>
<span class="strong"><strong>$ meteor add twbs:bootstrap</strong></span>
<span class="strong"><strong>$ meteor add rzymek:randomcolor</strong></span>
<span class="strong"><strong>$ meteor</strong></span>
</pre></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec197"/>How to do it…</h2></div></div></div><p>Let's pretend you have a (pretty awesome) library called <code class="literal">colorsaurus</code>. Your <code class="literal">colorsaurus</code> object likes to roar. A lot. Mostly because "rawr" means "I love you" in dinosaur, but also because the colorsaurus wants to share as many random colors as possible with all his friends. Whenever you ask this motley beast for a color, he instantly gives you a random color. This is obviously the most useful library ever written, so let's get to work building it!</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">customreactive.js</code> and add the following <code class="literal">colorsaurus</code> object just below the <code class="literal">Template</code> declarations, inside the <code class="literal">Meteor.isClient</code> conditional:<div class="informalexample"><pre class="programlisting">colorsaurus = {
    color: function(){
        return randomColor();
    },
    rainbowRoar: function (){
        console.log('rawr');
    }
};</pre></div></li><li class="listitem">While we're in <code class="literal">customreactive.js</code>, let's add the <code class="literal">numcolor</code> helper function. Locate the <code class="literal">Template.hello.helpers</code> method and add the following to the top of the method:<div class="informalexample"><pre class="programlisting">Template.hello.helpers({
<span class="strong"><strong>  numcolor: function(){</strong></span>
<span class="strong"><strong>    return colorsaurus.color();</strong></span>
<span class="strong"><strong>  },</strong></span>
  counter: ...
});</pre></div></li><li class="listitem">Save your changes, navigate to <code class="literal">http://localhost:3000</code>, and in the console window, type the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt; </strong></span>
<span class="strong"><strong>colorsaurus.color()</strong></span>
<span class="strong"><strong>&gt; colorsaurus.rainbowRoar()</strong></span>
</pre></div></li><li class="listitem">You should get a random color and a nice, short <span class="emphasis"><em>I love you</em></span> from our friend, the <code class="literal">colorsaurus</code> function:<div class="mediaobject"><img src="../Images/image00376.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">It's not reactive yet, but we need to prepare our UI first, for all the awesomeness <a id="id298" class="indexterm"/>that a reactive <code class="literal">colorsaurus</code> function can unleash. Open <code class="literal">customreactive.html</code> and make the following modifications to the <code class="literal">hello</code> template:<div class="informalexample"><pre class="programlisting">&lt;button <span class="strong"><strong>id='btnColor'</strong></span>&gt;Click Me&lt;/button&gt;
&lt;p <span class="strong"><strong>style="color:{{numcolor}}</strong></span>"&gt;You've pressed the button {{counter}} times.&lt;/p&gt;</pre></div></li><li class="listitem">We now need to change our <code class="literal">click</code> event to make <code class="literal">colorsaurus</code> roar. In <code class="literal">customreactive.js</code>, modify the <code class="literal">Template.hello.events</code> section as follows:<div class="informalexample"><pre class="programlisting">Template.hello.events({
    'click button': function () {
      // increment the counter when button is clicked
      Session.set("counter", Session.get("counter") + 1);
<span class="strong"><strong>      colorsaurus.rainbowRoar();</strong></span>
    }
  });</pre></div></li><li class="listitem">All that's left to do is make <code class="literal">colorsaurus</code> reactive and set up an <code class="literal">autorun</code> function. Open <code class="literal">customreactive.js</code> again and add the following reactive statements, including adding the <code class="literal">Tracker.Depenency</code> object:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>var colorDep = new Tracker.Dependency;</strong></span>

colorsaurus = {
    color: function(){
<span class="strong"><strong>        colorDep.depend();</strong></span>
        return randomColor();
    },
    rainbowRoar: function (){
        console.log('rawr');
<span class="strong"><strong>        colorDep.changed();</strong></span>
    }
};</pre></div></li><li class="listitem">Now, add a <code class="literal">Tracker.autorun</code> function, immediately after the <code class="literal">colorsaurus</code> code block, as shown in the following code:<div class="informalexample"><pre class="programlisting">Tracker.autorun(function(){
    $('#btnColor').css('background-color' , colorsaurus.color());
    $('body').css('background-color', colorsaurus.color());
 });</pre></div></li><li class="listitem">Save your <a id="id299" class="indexterm"/>changes, go to your browser, and click on the button as many times as your little 'colorsaurus-lovin' heart wishes. You'll get some really great color combinations, as shown in the following screenshot:<div class="mediaobject"><img src="../Images/image00377.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec198"/>How it works…</h2></div></div></div><p>Notice how the button, text, and the page background change, and they all change to random, separate colors. That's because we used a reactive library function that returns a random color each time it is called instead of returning a set variable.</p><p>By having our <code class="literal">color()</code> function return the result of <code class="literal">randomColor()</code>, we are ensuring that every time <code class="literal">colorsaurus.color()</code> is called, we get a different result.</p><p>We added <code class="literal">colorDep.depend()</code> to the returning function, which logs the computations that are created by either <code class="literal">Tracker.autorun</code> or by a reactive template (see the <span class="emphasis"><em>Creating and consuming a reactive value</em></span> recipe found in this chapter for a full explanation).</p><p>Finally, we called <code class="literal">colorDep.changed()</code>, which runs the logged computations.</p><p>Every part of the code <a id="id300" class="indexterm"/>is separate from—and therefore not dependent on—the other code parts or libraries. Through the <code class="literal">Tracker.Dependency</code> object, Meteor keeps track of everything for us so we can add or remove reactive dependencies at will. Try, for example, running the following line in your browser console:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt; Tracker.autorun(function(){console.log(colorsaurus.color());});</strong></span>
</pre></div><p>Now, every time you click the button on the page, you get yet another random color from the <code class="literal">colorsaurus</code>, printed to your console:</p><div class="mediaobject"><img src="../Images/image00378.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p><p>This is reactive programming at its very best. Rawr!</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec199"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="emphasis"><em>Using reactivity with HTML attributes</em></span> recipe in <a class="link" title="Chapter 3. Building Great User Interfaces" href="part0036.xhtml#aid-12AK81">Chapter 3</a>, <span class="emphasis"><em>Building Great User Interfaces</em></span></li><li class="listitem">The <span class="emphasis"><em>Creating and consuming a reactive value</em></span> recipe in this chapter</li></ul></div></div></div>
<div class="section" title="Updating Blaze templates without Mongo" id="aid-1R42S1"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec56"/>Updating Blaze templates without Mongo</h1></div></div></div><p>Not everything <a id="id301" class="indexterm"/>in our UI has to be dependent on <a id="id302" class="indexterm"/>Mongo collections. We can, in fact, use pretty much any reactive object inside our templates, and changes will appear instantly. This recipe will quickly show you how to use custom collections to populate and update UI templates.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec200"/>Getting ready</h2></div></div></div><p>Let's start with a base Meteor project and add the <code class="literal">bootstrap</code> and <code class="literal">reactive-var</code> packages. In a terminal window, navigate to where you would like your project to reside and enter the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ meteor create mongoless</strong></span>
<span class="strong"><strong>$ cd mongoless</strong></span>
<span class="strong"><strong>$ meteor add twbs:bootstrap</strong></span>
<span class="strong"><strong>$ meteor add reactive-var</strong></span>
<span class="strong"><strong>$ meteor</strong></span>
</pre></div><p>Finally, open a browser and navigate to <code class="literal">http://localhost:3000</code> so that you can see updates in real time.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec201"/>How to do it…</h2></div></div></div><p>We will create a simple array of button press snapshots, with a new element being added to the array every time the button on the page is clicked. Subsequently, these buttons will be added to the UI using a <code class="literal">{{#each}}</code> template block.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, open <code class="literal">mongoless.html</code> and add the following block to the <code class="literal">hello</code> template, just after the <code class="literal">&lt;p&gt;</code> element and just before the closing <code class="literal">&lt;/template&gt;</code> tag, as shown in the following example:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>{{#each buttonPresses}}</strong></span>
<span class="strong"><strong>    &lt;div class="btn btn-info pressed"&gt;#{{btnRank}}&lt;/div&gt;</strong></span>
<span class="strong"><strong>{{/each}}</strong></span>
&lt;/template&gt;</pre></div></li><li class="listitem">We now need to add a reactive variable and append some helpers to the <code class="literal">Template.hello.helpers</code> object. Open <code class="literal">mongoless.js</code> and add the following highlighted code:<div class="informalexample"><pre class="programlisting">if (Meteor.isClient) {
<span class="strong"><strong>  presses = new ReactiveVar;</strong></span>
  // counter starts at 0
  Session.setDefault("counter", 0);

  Template.hello.helpers({
    counter: function () {
      return Session.get("counter");
    },
<span class="strong"><strong>    buttonPresses: function(){</strong></span>
<span class="strong"><strong>        return presses.get();</strong></span>
<span class="strong"><strong>    },</strong></span>
<span class="strong"><strong>    btnRank: function(){</strong></span>
<span class="strong"><strong>        return this.rank;</strong></span>
<span class="strong"><strong>    }</strong></span>
  });</pre></div></li><li class="listitem">All that's left to do is to update the <code class="literal">presses</code> variable each time the button is pressed. Inside <code class="literal">Template.hello.events</code>, in the <code class="literal">'click button'</code> event handler, add the following lines of code immediately after the <code class="literal">Session.set()</code> call:<div class="informalexample"><pre class="programlisting">Session.set("counter", Session.get("counter") + 1);
<span class="strong"><strong>var _presses = presses.get() || [];</strong></span>
<span class="strong"><strong>_presses.push({rank:Session.get("counter")});</strong></span>
<span class="strong"><strong>presses.set(_presses);</strong></span>
</pre></div></li><li class="listitem">Save all of <a id="id303" class="indexterm"/>your changes, go to your <a id="id304" class="indexterm"/>browser, and start clicking on the button labeled <span class="strong"><strong>Click Me</strong></span>. You should see a new button created each time you click on the button, similar to the following:<div class="mediaobject"><img src="../Images/image00379.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec202"/>How it works…</h2></div></div></div><p>When we added the <code class="literal">buttonPresses</code> helper function to the <code class="literal">Template.hello.helpers</code> object, we simply replaced what we would usually use a Mongo collection for with a simple array stored inside a <code class="literal">ReactiveVar</code> element:</p><div class="informalexample"><pre class="programlisting">presses = new ReactiveVar;</pre></div><p>Collections are reactive providers, which means they track and rerun computations as appropriate. The <code class="literal">presses</code> object is also a reactive provider, and therefore, does the exact same thing. It reruns any stored computations / reactive functions whenever the value is updated. In this case, it reruns computations when the array is modified, and <code class="literal">presses.set()</code> is called as a result.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec203"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <a id="id305" class="indexterm"/><span class="emphasis"><em>Creating dynamic lists</em></span> recipe in <a class="link" title="Chapter 3. Building Great User Interfaces" href="part0036.xhtml#aid-12AK81">Chapter 3</a>, <span class="emphasis"><em>Building Great User Interfaces</em></span></li><li class="listitem">The <a id="id306" class="indexterm"/><span class="emphasis"><em>Creating and consuming a reactive value</em></span> recipe in this chapter</li></ul></div></div></div>
<div class="section" title="Using inline data to modify UI elements reactively"><div class="titlepage" id="aid-1S2JE2"><div><div><h1 class="title"><a id="ch06lvl1sec57"/>Using inline data to modify UI elements reactively</h1></div></div></div><p>Typically, when elements in an HTML page are rendered, then that rendering isn't directly <a id="id307" class="indexterm"/>linked to any of the data <a id="id308" class="indexterm"/>used to create them, for example, if we have an array of objects, we may generate some HTML by iterating over the array and adding <code class="literal">&lt;div&gt;</code> elements for each object in the array. Unless we do something to manually link them to the array of objects, these newly created elements aren't associated with the data that created them in any way. This leads to all kinds of development shenanigans, as developers try to shoehorn in associative data, which is used in events and other downstream functions. Long story short, using only existing web technologies, it's difficult to keep all of the data exactly in sync with your HTML DOM elements. Meteor has been designed to help solve this problem gracefully, keeping track of the context of each DOM element and therefore allowing instant access to the data used to create the element in the first place. This recipe will walk you through how to retrieve and use the data associated with individual DOM elements.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec204"/>Getting ready</h2></div></div></div><p>We will use the code base from the <span class="emphasis"><em>Updating Blaze templates without Mongo</em></span> recipe, found in this chapter. Please complete that recipe and then add the <code class="literal">randomcolor</code> package by running the following terminal command in the root folder of your project:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt; meteor add rzymek:randomcolor</strong></span>
</pre></div><p>Have your browser open to <code class="literal">http://localhost:3000</code> as well so we can see the changes in real time.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec205"/>How to do it...</h2></div></div></div><p>We are going to add some functionality to the existing button creation. First, we'll add a random color to each new button; second, we'll remove this color when the buttons are clicked; and third, we'll restore the color based on the associative inline data.</p><p>So let's get started. We need to update the <code class="literal">hello</code> template, setting the initial background colors for new buttons. We also need a way to remove those colors at random. We'll do this by adding a new control button.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open your <code class="literal">.html</code> file (probably <code class="literal">mongoless.html</code>) and modify the <code class="literal">hello</code> template to look like the following:<div class="informalexample"><pre class="programlisting">&lt;template name="hello"&gt;
  &lt;button <span class="strong"><strong>id="addBtn"</strong></span>&gt;Click Me&lt;/button&gt;
<span class="strong"><strong>  &lt;button id="chgColor"&gt;Or Me!&lt;/button&gt;</strong></span>
  &lt;p&gt;You've pressed the button {{counter}} times.&lt;/p&gt;
  {{#each buttonPresses}}
    &lt;div class="btn btn-info pressed"
<span class="strong"><strong>         style="background-color:{{btnColor}}"&gt;</strong></span>
    #{{btnRank}}&lt;/div&gt;
  {{/each}}
&lt;/template&gt;</pre></div></li><li class="listitem">We <a id="id309" class="indexterm"/>now need to add <a id="id310" class="indexterm"/>the <code class="literal">btnColor</code> helper to <code class="literal">Template.hello.helpers</code> and modify the data object being stored to make room for the new color. We also need to refine the <code class="literal">click</code> events on the buttons to differentiate between adding a new button and removing a button's color. Open your <code class="literal">.js</code> file (probably called <code class="literal">mongoless.js</code>) and make the following changes to the variable declarations and the helpers:<div class="informalexample"><pre class="programlisting">if (Meteor.isClient) {
  presses = new ReactiveVar;
<span class="strong"><strong>  counter = new ReactiveVar(0);</strong></span>


  Template.hello.helpers({
    counter: function () {
<span class="strong"><strong>      return counter.get();</strong></span>
    },
    buttonPresses: function () {
      return presses.get();
    },
    btnRank: function () {
      return this.rank;
    },
<span class="strong"><strong>    btnColor: function () {</strong></span>
<span class="strong"><strong>      return this.color;</strong></span>
    }
  });
  ...</pre></div></li><li class="listitem">Now, we need to modify the existing <code class="literal">click</code> event, add a new event to remove color, and add one final handler to set up all the new buttons to regain <a id="id311" class="indexterm"/>their color <a id="id312" class="indexterm"/>when clicked. Make the following changes to the <code class="literal">Template.hello.events</code> section:<div class="informalexample"><pre class="programlisting">Template.hello.events({
    'click <span class="strong"><strong>#addBtn</strong></span>': function () {
      // increment the counter when button is clicked
      counter.set(counter.get() + 1);
      var _presses = presses.get() || [];
<span class="strong"><strong>      var newBtn = {</strong></span>
<span class="strong"><strong>        color: randomColor(),</strong></span>
<span class="strong"><strong>        rank: counter.get()</strong></span>
<span class="strong"><strong>      };</strong></span>
<span class="strong"><strong>      _presses.push(newBtn);</strong></span>
      presses.set(_presses);
    },
<span class="strong"><strong>    'click #chgColor': function () {</strong></span>
<span class="strong"><strong>      var rndBtn = ~~(Math.random() * counter.get());</strong></span>
<span class="strong"><strong>      $('.pressed')[rndBtn].style.backgroundColor = '';</strong></span>

<span class="strong"><strong>    },</strong></span>
<span class="strong"><strong>    'click .pressed': function (e, n) {</strong></span>
<span class="strong"><strong>      e.currentTarget.style.backgroundColor = this.color;</strong></span>
<span class="strong"><strong>    }</strong></span>
  });</pre></div></li><li class="listitem">Save all your changes and click on the <span class="strong"><strong>Click Me</strong></span> Button on your screen 5-10 times. You'll notice that all the new buttons being added have a random color assigned to them, as shown in the following screenshot:<div class="mediaobject"><img src="../Images/image00380.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Now, click on the <span class="strong"><strong>Or Me!</strong></span> button multiple times. At random, the buttons will lose their <a id="id313" class="indexterm"/>random color and change to the default <code class="literal">btn-info</code> blue color provided by <code class="literal">bootstrap</code>, as shown in the following screenshot:<div class="mediaobject"><img src="../Images/image00381.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><p>Any of the buttons that have lost their color can regain the color by clicking directly on the button.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec206"/>How it works...</h2></div></div></div><p>The crux of this recipe is found inside the <code class="literal">'click .pressed'</code> event handler. There, we assign the <code class="literal">backgroundColor</code> attribute of the clicked button to <code class="literal">this.color</code>:</p><div class="informalexample"><pre class="programlisting">'click .pressed': function (e, n) {
  e.currentTarget.style.backgroundColor = <span class="strong"><strong>this.color</strong></span>;
}</pre></div><p>In this case, there is a reference to the associated data object for that DOM element. Meteor <a id="id314" class="indexterm"/>keeps track of how each element is created. So when an event is fired inside the template, Meteor provides the data object as the <span class="emphasis"><em>context</em></span> (the <code class="literal">this</code>) in the event handler. In this way, Meteor can provide instant access to the inline data for each rendered element.</p><p>Notice that even after we manually changed the <code class="literal">backgroundColor</code> using the <code class="literal">'click #chgColor'</code> event, Meteor still has a reference to the data object used to render the element. This becomes important because we now no longer need to store data as an attribute of the DOM element—no more <code class="literal">data-color</code> or <code class="literal">data-whatever</code> attributes that clutter up the UI and potentially expose data. The data objects, though hidden from the UI, are available instantly and inline. So no fancy calculations or DOM manipulation needs to be done in order to access the necessary contextual data.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec207"/>There's more…</h2></div></div></div><p>The preceding example uses the default Meteor <code class="literal">Template</code> event handlers, so of course, the data is available. But, even if you bypass Meteor's <code class="literal">Template</code> event handlers and use, say, jQuery events <a id="id315" class="indexterm"/>instead, the associated data will be available by calling the <code class="literal">Blaze.getData()</code> function of the element.</p><p>Setting up the event handler is a little bit tricky in this case. We have to first move the population of each button to a new template because the jQuery <code class="literal">click</code> event handler must be run inside of a <code class="literal">rendered()</code> function callback. To accomplish this, make the following changes to your <code class="literal">.html</code> file (probably <code class="literal">mongoless.html</code>):</p><div class="informalexample"><pre class="programlisting">&lt;template name="hello"&gt;
  &lt;button id="addBtn"&gt;Click Me&lt;/button&gt;
  &lt;button id="chgColor"&gt;Or Me!&lt;/button&gt;
  &lt;p&gt;You've pressed the button {{counter}} times.&lt;/p&gt;
  {{#each buttonPresses}}
<span class="strong"><strong>    {{&gt; helloBtn}}</strong></span>
  {{/each}}
&lt;/template&gt;
<span class="strong"><strong>&lt;template name="helloBtn"&gt;</strong></span>
<span class="strong"><strong>  &lt;div class="btn btn-info pressed"</strong></span>
<span class="strong"><strong>    style="background-color:{{btnColor}}"&gt;</strong></span>
<span class="strong"><strong>    #{{btnRank}}&lt;/div&gt;</strong></span>
<span class="strong"><strong>&lt;/template&gt;</strong></span>
</pre></div><p>You will <a id="id316" class="indexterm"/>also need to remove the <code class="literal">'click .pressed'</code> event handler from <code class="literal">Template.hello.events</code>. Once you've removed the event handler, add the <code class="literal">jQuery.click()</code> event handler inside a <code class="literal">Template.btnRank.rendered</code> code block, to be run immediately upon the rendering of a new button, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">Template.helloBtn.rendered = function () {
    this.$('.pressed').click(function (e) {
      e.currentTarget.style.backgroundColor = Blaze.getData(this).color;
    });
  };</pre></div><p>Lastly, because we moved the <code class="literal">div</code> rendering to the new <code class="literal">helloBtn</code> template, we need to move the <code class="literal">btnRank</code> and <code class="literal">btnColor</code> helpers from <code class="literal">Template.hello.helpers</code> to a newly created <code class="literal">Template.helloBtn.helpers</code> block, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">Template.helloBtn.helpers({
  btnRank: function () {
    return this.rank;
  },
  btnColor: function () {
    return this.color;
  }
});</pre></div><p>That's a lot of work for the same result, but it helps to illustrate the flexibility of the Blaze/Meteor associative data capabilities. We only had to slightly modify the event helper to point to <code class="literal">Blaze.getData(this).color</code> rather than <code class="literal">this.color</code>. Although the same keyword exists in each event handler, the <code class="literal">this</code> inside the jQuery event handler refers to the DOM element, rather than the associated data object inside the original Meteor event handler. <code class="literal">Blaze.getData(element)</code> takes a DOM element as an argument and retrieves the associated inline data for that element.</p><p>In either <a id="id317" class="indexterm"/>case, getting to the associated <a id="id318" class="indexterm"/>data is very straightforward and allows you to do anything to your UI programmatically, without having to worry about destroying/altering the data associated with each rendered element.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec208"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="emphasis"><em>Inserting templates with Spacebars</em></span> and <span class="emphasis"><em>Creating dynamic lists</em></span> recipes in <a class="link" title="Chapter 3. Building Great User Interfaces" href="part0036.xhtml#aid-12AK81">Chapter 3</a>, <span class="emphasis"><em>Building Great User Interfaces</em></span></li></ul></div></div></div>
<div class="section" title="Integrating a jQuery UI"><div class="titlepage" id="aid-1T1402"><div><div><h1 class="title"><a id="ch06lvl1sec58"/>Integrating a jQuery UI</h1></div></div></div><p>The jQuery <a id="id319" class="indexterm"/>library is crazily popular, and for good reason. When used properly, it can speed up the development process and give us reliable ways of doing things that would otherwise take a lot of coding effort.</p><p>A complement to jQuery is jQuery UI, which is a set of widgets, themes, and animation effects. With jQuery UI, you can quickly create drag and drop components, sortable lists, and lots of other useful UI niceties.</p><p>This recipe will walk you through creating a jQuery UI-sortable widget inside a Meteor template.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec209"/>Getting ready</h2></div></div></div><p>For this recipe, we will definitely want client and server folders to keep the code clean and readable. To accomplish this, we will rely on our default template scaffolding. Please create a new project called <code class="literal">swatches</code> using the <span class="emphasis"><em>Setting up your project file structure</em></span> recipe in <a class="link" title="Chapter 1. Optimizing Your Workflow" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <span class="emphasis"><em>Optimizing Your Workflow</em></span>, as your starting file structure.</p><p>Once you've completed the scaffolding, we will need to add the <code class="literal">randomcolor</code> package to our project. In a terminal window, navigate to the root folder of your project and run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt; meteor add rzymek:randomcolor</strong></span>
</pre></div><p>We will also want a nice theme, so let's use the adapted version of Google's Material Design theme, for funzies. Enter the following command in the same terminal window:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt; meteor add html5cat:bootstrap-material-design</strong></span>
</pre></div><p>Next, we <a id="id320" class="indexterm"/>want to get a customized version of jQuery UI directly from <code class="literal">jqueryui.com</code>. Navigate to <a class="ulink" href="http://jqueryui.com/">http://jqueryui.com/</a> in a browser and click on <span class="strong"><strong>Custom Download</strong></span>, placed <a id="id321" class="indexterm"/>toward the right:</p><div class="mediaobject"><img src="../Images/image00382.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>In the download builder, make the following selections:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Select the latest stable version</li><li class="listitem">Uncheck the <span class="strong"><strong>Toggle</strong></span> <span class="strong"><strong>All</strong></span> checkbox under <span class="strong"><strong>Components</strong></span></li><li class="listitem">Check the <span class="strong"><strong>Toggle</strong></span> <span class="strong"><strong>All</strong></span> checkbox under <span class="strong"><strong>UI</strong></span> <span class="strong"><strong>Core</strong></span></li><li class="listitem">Check the <span class="strong"><strong>Sortable</strong></span> checkbox under <span class="strong"><strong>Interactions</strong></span></li><li class="listitem">At the bottom, select <span class="strong"><strong>No</strong></span> <span class="strong"><strong>Theme</strong></span> from the <span class="strong"><strong>Theme</strong></span> dropdown</li></ul></div><p>Your selections will look similar to the following screenshot:</p><div class="mediaobject"><img src="../Images/image00383.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>All we need is the sortable interaction and the UI core. Everything else just adds to our file size, so we'll leave it out. Click on <span class="strong"><strong>Download</strong></span>, unzip the downloaded file once complete, locate the <code class="literal">jquery-ui.min.js</code> file, and copy it to your <code class="literal">[project root]/client/lib/scripts</code> folder.</p><p>We could simply pull in jQuery UI using a community package, but it's a bit bulkier and it doesn't help us see how non-packaged third-party libraries can be used inside Meteor. So, we'll go with this manual installation.</p><p>Open a browser to <a id="id322" class="indexterm"/>
<code class="literal">http://localhost:3000</code> so we can see the changes in real time. We are now ready to add the jQuery UI-sortable widget to our project.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec210"/>How to do it...</h2></div></div></div><p>We will create color swatches, which will display the hexadecimal code they represent, and they will be sortable, which means we can move them around via drag and drop.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To accomplish this, we first need to create a <code class="literal">Swatches</code> collection, accessible on both the client and the server. In your <code class="literal">[project root]/both/</code> folder, create/edit a file named <code class="literal">model.js</code> and add the following collection declaration:<div class="informalexample"><pre class="programlisting">Swatches = new Mongo.Collection('swatches');</pre></div></li><li class="listitem">Next, let's create our UI using a template named <code class="literal">swatches</code>. Open/create the <code class="literal">[project root]/client/main.html</code> file, remove all the contents, and add the following code:<div class="informalexample"><pre class="programlisting">&lt;head&gt;
  &lt;title&gt;Swatches&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
  {{&gt; colors}}
&lt;/body&gt;

&lt;template name="colors"&gt;
  &lt;h1&gt;Yay Colors!&lt;/h1&gt;
  &lt;div id="cList"&gt;
      {{#each swatches}}
          &lt;div class="swatch"
 style="background-color:{{color}}"&gt;
{{color}}&lt;/div&gt;{{color}}&lt;/div&gt;
      {{/each}}
  &lt;/div&gt;
  &lt;input id="btnNew" type="button" class="btn btn-primary" value="New Color" /&gt;
&lt;/template&gt;</pre></div></li><li class="listitem">We will want <a id="id323" class="indexterm"/>to style it just a little bit to make the swatches consistently sized. Open/create a file named <code class="literal">[project root]/client/lib/styles/style.css</code> and add the following CSS declarations:<div class="informalexample"><pre class="programlisting">.swatch {
    min-height: 100px;
    min-width: 100px;
    display:inline-block;
    color:white;
    text-align: center;
}
#cList {
    width: 520px;
}</pre></div></li><li class="listitem">Finally, we will create the logic needed to add swatches and be able to drag them around the screen. Open/create the <code class="literal">[project root]/client/scripts/main.js</code> file, delete anything inside the file, and add the following <code class="literal">Template.helpers</code> and <code class="literal">Rankings</code> declarations:<div class="informalexample"><pre class="programlisting">Template.colors.helpers({
    swatches: function(){
        return Swatches.find({},{ sort: { rank:1}});
    }
})

Rankings = {
    beforeFirst: function(first) { return first - 1;},
    middle: function(before,after){ return (before+after)/2;},
    afterLast: function(last){ return last + 1; }
};</pre></div></li><li class="listitem">Now, the fun part! We will create the <code class="literal">jQuery.sortable</code> object with its <code class="literal">stop()</code> function and hook up our <code class="literal">button.click</code> event handler using regular jQuery. In order for the <code class="literal">sortable</code> and <code class="literal">click</code> event handlers to be added properly, we need to declare them inside a <code class="literal">Template.rendered()</code> function. In the <a id="id324" class="indexterm"/>same <code class="literal">main.js</code> file, just below the <code class="literal">Rankings</code> declaration, enter the following code:<div class="informalexample"><pre class="programlisting">Template.colors.rendered = function(){
    this.$('#cList').sortable({
        stop: function (e,ui){
            var el = ui.item.get(0);
            var before = ui.item.prev().get(0);
            var after = ui.item.next().get(0);
            var newRank = null;
            if (!before){
                newRank = Rankings.beforeFirst(Blaze.getData(after).rank);
            } else if (!after) {
                newRank = Rankings.afterLast(Blaze.getData(before).rank);
            } else {
                newRank = Rankings.middle(Blaze.getData(before).rank,Blaze.getData(after).rank);
            }
            Swatches.update(Blaze.getData(el)._id,
                            {$set: {rank:newRank}});
        }
    });
    
    this.$('#btnNew').click(function(e){
        var newColor = randomColor({luminosity:'random',
hue:'random'});
       Swatches.insert({color:newColor, rank: Swatches.find().count()+1});
    });
};</pre></div></li></ol><div style="height:10px; width: 1px"/></div><p>Save all of your changes and hop over to your browser. The page should have a nice, stylish blue button labeled <span class="strong"><strong>NEW</strong></span> <span class="strong"><strong>COLOR</strong></span>. Every time you click on this button, a new swatch will be added with a random color. If you drag and drop any of the swatches from one position to another, the swatches will be reordered appropriately. This reordering is not temporary. If you refresh the page or open another browser window, the reordering you did via drag and drop will remain.</p><p>So, for example, let's say you move a swatch from the last element to the first. The change will stick and any other clients/browsers that open to the same page will instantly reflect the change.</p><p>When the following <a id="id325" class="indexterm"/>purple swatch is dragged and dropped, the changes will be as shown, as displayed on the right-hand side of the following screenshot:</p><div class="mediaobject"><img src="../Images/image00384.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>It is instantly updated in every UI, as shown in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00385.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec211"/>How it works...</h2></div></div></div><p>Thanks to our <code class="literal">click</code> event handler, whenever a swatch is added using <code class="literal">Swatches.insert()</code>, a rank is assigned to that swatch:</p><div class="informalexample"><pre class="programlisting">this.$('#btnNew').click(function(e){
  ...
  Swatches.insert({..., rank: Swatches.find().count()+1});
});</pre></div><p>If we look at the <code class="literal">swatches</code> helper inside <code class="literal">Template.colors.helpers</code>, we can see that the Mongo <code class="literal">Collection.find()</code> query is sorted by <code class="literal">rank</code>:</p><div class="informalexample"><pre class="programlisting">swatches: function(){
  return Swatches.find({},{ sort: { rank:1 }});
}</pre></div><p>This preserves the order of the swatches in the UI and allows us to manipulate their order as a result of drag and drop.</p><p>Inside of our <code class="literal">sortable.stop()</code> function, we were identifying where in the list the swatch had been dragged and dropped to. Once we determine where the swatch is located, we calculate a new rank for that swatch using the <code class="literal">Rankings</code> helper functions. We then immediately update the <code class="literal">swatches</code> collection with the new rank, which propagates and makes the position of the UI change permanent.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec212"/>There's more…</h2></div></div></div><p>The key takeaway <a id="id326" class="indexterm"/>here is that while jQuery (or any other third-party library) may be used to make direct DOM manipulations, these manipulations won't persist beyond a single user's session, or even beyond the next DDP change from the server.</p><p>To make the manipulations permanent and to fully utilize the Blaze rendering engine's fantastic reactive programming model, we need to modify the datasource (in this case, the <code class="literal">swatches</code> collection). The modification is handled immediately, and with no effort on our part, through reactivity.</p><p>So, to review, third-party libraries can go right ahead and manipulate DOM elements in a Meteor application, with the third-party code being executed inside a <code class="literal">Template.rendered()</code> function block.</p><p>To make the changes "stick", we simply update the corresponding Mongo collection as well. Using this technique, we can integrate nearly every JavaScript library out there (if someone hasn't already done it for us on <a class="ulink" href="https://atmospherejs.com/">https://atmospherejs.com/</a>).</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec213"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="emphasis"><em>Setting up your project file structure</em></span> recipe in <a class="link" title="Chapter 1. Optimizing Your Workflow" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <span class="emphasis"><em>Optimizing Your Workflow</em></span></li><li class="listitem">The <span class="emphasis"><em>Using inline data to modify UI elements reactively</em></span> recipe in this chapter</li></ul></div></div></div></body></html>