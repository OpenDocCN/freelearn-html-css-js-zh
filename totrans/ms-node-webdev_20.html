<html><head></head><body>
<div class="calibre1" id="_idContainer247">
<h1 class="chapternumber"><span class="kobospan" id="kobo.1.1">18</span></h1>
<h1 class="chaptertitle" id="_idParaDest-312"><span class="kobospan" id="kobo.2.1">SportsStore: Orders and Validation</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.3.1">In this chapter, we continue to build the SportsStore application by adding support for placing orders, which includes validating the form data provided by the user.</span></p>
<h1 class="heading" id="_idParaDest-313"><span class="kobospan" id="kobo.4.1">Preparing for this chapter</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.5.1">This chapter uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.6.1">sportsstore</span></code><span class="kobospan" id="kobo.7.1"> project from </span><em class="italic"><span class="kobospan" id="kobo.8.1">Chapter 17</span></em><span class="kobospan" id="kobo.9.1">. </span><span class="kobospan" id="kobo.9.2">No changes are required for this chapter. </span><span class="kobospan" id="kobo.9.3">Open a new command prompt, navigate to the </span><code class="inlinecode"><span class="kobospan" id="kobo.10.1">sportsstore</span></code><span class="kobospan" id="kobo.11.1"> folder, and run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.12.1">Listing 18.1</span></em><span class="kobospan" id="kobo.13.1"> to start the development tools.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.14.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.15.1">You can download the example project for this chapter – and for all the other chapters in this book – from </span><a href="https://github.com/PacktPublishing/Mastering-Node.js-Web-Development" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.16.1">https://github.com/PacktPublishing/Mastering-Node.js-Web-Development</span></span></a><span class="kobospan" id="kobo.17.1">. </span><span class="kobospan" id="kobo.17.2">See </span><em class="italic"><span class="kobospan" id="kobo.18.1">Chapter 1</span></em><span class="kobospan" id="kobo.19.1"> to get help if you have problems running the examples.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.20.1">Listing 18.1: Starting the development tools</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.21.1">npm start
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.22.1">Open a new browser window, navigate to </span><code class="inlinecode"><span class="kobospan" id="kobo.23.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.24.1">, and you will see the product catalog, as shown in </span><em class="italic"><span class="kobospan" id="kobo.25.1">Figure 18.1</span></em><span class="kobospan" id="kobo.26.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.27.1"><img alt="" src="../Images/B21959_18_01.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.28.1">Figure 18.1: Running the application</span></p>
<h1 class="heading" id="_idParaDest-314"><span class="kobospan" id="kobo.29.1">Handling orders</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.30.1">The </span><a id="_idIndexMarker968" class="calibre3"/><span class="kobospan" id="kobo.31.1">data model for handling orders comes in two parts: the </span><a id="_idIndexMarker969" class="calibre3"/><span class="kobospan" id="kobo.32.1">order and the user profile. </span><span class="kobospan" id="kobo.32.2">The order describes the products that have been selected and provides the shipment status of the order. </span><span class="kobospan" id="kobo.32.3">As noted in </span><em class="italic"><span class="kobospan" id="kobo.33.1">Chapter 16</span></em><span class="kobospan" id="kobo.34.1">, the SportsStore application doesn’t extend to implementing the payment and fulfillment processes, which are typically handled by integration with separate platforms. </span></p>
<h2 class="heading1" id="_idParaDest-315"><span class="kobospan" id="kobo.35.1">Creating the data model</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.36.1">To get </span><a id="_idIndexMarker970" class="calibre3"/><span class="kobospan" id="kobo.37.1">started, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.38.1">customer_models.ts</span></code><span class="kobospan" id="kobo.39.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.40.1">src/data</span></code><span class="kobospan" id="kobo.41.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.42.1">Listing 18.2</span></em><span class="kobospan" id="kobo.43.1">. </span><span class="kobospan" id="kobo.43.2">This is a placeholder to represent customers with just enough functionality to start working on orders. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.44.1">Listing 18.2: The contents of the customer_models.ts file in the src/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.45.1">export interface Customer {
    id?: number;
    name: string;
    email: string;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.46.1">To describe orders, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.47.1">order_models.ts</span></code><span class="kobospan" id="kobo.48.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.49.1">src/data</span></code><span class="kobospan" id="kobo.50.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.51.1">Listing 18.3</span></em><span class="kobospan" id="kobo.52.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.53.1">Listing 18.3: The contents of the order_models.ts file in the src/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.54.1">import { Product } from "./catalog_models";
import { Customer } from "./customer_models";
export interface Order {
    id?: number;
    customer?: Customer;
    selections?: ProductSelection[];
    address?: Address;
    shipped: boolean;
}
export interface ProductSelection {
    id?: number;
    productId?: number;
    quantity: number;
    price: number;
}
export interface Address {
    id?: number;
    street: string;
    city: string;
    state: string;
    zip: string;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.55.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.56.1">Order</span></code><span class="kobospan" id="kobo.57.1"> interface describes a single order, with </span><code class="inlinecode"><span class="kobospan" id="kobo.58.1">ProductSelection</span></code><span class="kobospan" id="kobo.59.1"> objects that represent the </span><a id="_idIndexMarker971" class="calibre3"/><span class="kobospan" id="kobo.60.1">products the user has purchased, including the price at the time of purchase. </span><span class="kobospan" id="kobo.60.2">The customer is represented by a </span><code class="inlinecode"><span class="kobospan" id="kobo.61.1">Customer</span></code><span class="kobospan" id="kobo.62.1"> object and the addresses for shipping and billing are represented by </span><code class="inlinecode"><span class="kobospan" id="kobo.63.1">Address</span></code><span class="kobospan" id="kobo.64.1"> objects. </span><span class="kobospan" id="kobo.64.2">The details required for real online stores vary based on local laws and customs and the type of products being sold, but these interfaces are a reasonable approximation of the basic order characteristics that can be adapted as needed.</span></p>
<p class="normal"><span class="kobospan" id="kobo.65.1">To describe the access to order data, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.66.1">order_repository.ts</span></code><span class="kobospan" id="kobo.67.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.68.1">src/data</span></code><span class="kobospan" id="kobo.69.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.70.1">Listing 18.4</span></em><span class="kobospan" id="kobo.71.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.72.1">Listing 18.4: The contents of the order_repository.ts file in the src/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.73.1">import { Order } from "./order_models";
export interface OrderRepository {
    getOrder(id: number): Promise&lt;Order| null&gt;;
    getOrders(excludeShipped: boolean): Promise&lt;Order[]&gt;;
    storeOrder(order: Order): Promise&lt;Order&gt;;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.74.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.75.1">getOrder</span></code><span class="kobospan" id="kobo.76.1"> method returns a single order, identified by its </span><code class="inlinecode"><span class="kobospan" id="kobo.77.1">id</span></code><span class="kobospan" id="kobo.78.1"> value. </span><span class="kobospan" id="kobo.78.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.79.1">getOrders</span></code><span class="kobospan" id="kobo.80.1"> method retrieves all orders, with a parameter that allows shipped orders to be excluded from the results. </span><span class="kobospan" id="kobo.80.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.81.1">storeOrder</span></code><span class="kobospan" id="kobo.82.1"> method stores or updates an order.</span></p>
<h2 class="heading1" id="_idParaDest-316"><span class="kobospan" id="kobo.83.1">Implementing the model classes</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.84.1">I am</span><a id="_idIndexMarker972" class="calibre3"/><span class="kobospan" id="kobo.85.1"> going to extend the existing Sequelize implementation of the </span><code class="inlinecode"><span class="kobospan" id="kobo.86.1">CatalogRepository</span></code><span class="kobospan" id="kobo.87.1"> interface to implement the methods defined by the </span><code class="inlinecode"><span class="kobospan" id="kobo.88.1">OrderRepository</span></code><span class="kobospan" id="kobo.89.1"> interface, which will allow a single database to store both catalog and order data. </span><span class="kobospan" id="kobo.89.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.90.1">customer_models.ts</span></code><span class="kobospan" id="kobo.91.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.92.1">src/data/orm/models</span></code><span class="kobospan" id="kobo.93.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.94.1">Listing 18.5</span></em><span class="kobospan" id="kobo.95.1">.</span></p>
<div class="packt_tip">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.96.1">One versus Many Databases</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.97.1">It can be appealing from a design perspective to keep each category of data in its own database, so that catalog data, for example, is stored separately from order or user data. </span><span class="kobospan" id="kobo.97.2">In practice, separate databases are difficult to manage, especially since most categories of data used by an application have some kind of relationship: orders need to refer to products, user accounts need to be associated with orders, and so on. </span><span class="kobospan" id="kobo.97.3">Putting an application’s data in a single database makes it easier to use database features like transactions to ensure data integrity and simplifies correlating data in queries.</span></p>
<p class="normal"><span class="kobospan" id="kobo.98.1">If you decide to use multiple databases, then you assume responsibility for managing transactions across databases, and ensuring that data remains consistent so that relationships between databases are consistent. </span><span class="kobospan" id="kobo.98.2">There are tools available to help, such as distributed transaction managers, for example, but they can be complex and difficult to use.</span></p>
</div>
<div class="packt_tip">
<p class="normal"><span class="kobospan" id="kobo.99.1">My advice, from a purely practical perspective, is to use a single database for all an application’s data whenever possible. </span><span class="kobospan" id="kobo.99.2">When a single database isn’t possible, such as when employee data is stored in a central HR database to which your application has read-only access, then you should pay close attention to how the relationships between data are managed.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.100.1">Listing 18.5: The contents of the customer_models.ts file in the src/data/orm/models folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.101.1">import { Model, CreationOptional, InferAttributes, InferCreationAttributes }
    from "sequelize";
import { Customer } from "../../customer_models";
export class CustomerModel extends Model&lt;InferAttributes&lt;CustomerModel&gt;,
        InferCreationAttributes&lt;CustomerModel&gt;&gt; implements Customer {
    declare id?: CreationOptional&lt;number&gt;;
    declare name: string;
    declare email: string;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.102.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.103.1">CustomerModel</span></code><span class="kobospan" id="kobo.104.1"> class implements the </span><code class="inlinecode"><span class="kobospan" id="kobo.105.1">Customer</span></code><span class="kobospan" id="kobo.106.1"> interface to allow customer data to </span><a id="_idIndexMarker973" class="calibre3"/><span class="kobospan" id="kobo.107.1">be stored by Sequelize. </span><span class="kobospan" id="kobo.107.2">To tell Sequelize how to initialize the model class, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.108.1">customer_helpers.ts</span></code><span class="kobospan" id="kobo.109.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.110.1">src/data/orm/models</span></code><span class="kobospan" id="kobo.111.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.112.1">Listing 18.6</span></em><span class="kobospan" id="kobo.113.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.114.1">Listing 18.6: The contents of the customer_helpers.ts file in the src/data/orm/models folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.115.1">import { DataTypes, Sequelize } from "sequelize";
import { CustomerModel } from "./customer_models";
export const initializeCustomerModels = (sequelize: Sequelize) =&gt; {
    CustomerModel.init({
        id: { type: DataTypes.INTEGER, autoIncrement: true, primaryKey: true},
        name: { type: DataTypes.STRING},       
        email: { type: DataTypes.STRING }
    }, { sequelize})
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.116.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.117.1">initializeCustomerModels</span></code><span class="kobospan" id="kobo.118.1"> function initializes the </span><code class="inlinecode"><span class="kobospan" id="kobo.119.1">CustomerModel</span></code><span class="kobospan" id="kobo.120.1"> class and specifies the SQL datatype and configuration for each model property.</span></p>
<h3 class="heading2" id="_idParaDest-317"><span class="kobospan" id="kobo.121.1">Creating the order models</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.122.1">To </span><a id="_idIndexMarker974" class="calibre3"/><span class="kobospan" id="kobo.123.1">create the implementations of the interfaces that describe an order, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.124.1">order_models.ts</span></code><span class="kobospan" id="kobo.125.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.126.1">server/data/orm/models</span></code><span class="kobospan" id="kobo.127.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.128.1">Listing 18.7</span></em><span class="kobospan" id="kobo.129.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.130.1">Listing 18.7: The contents of the order_models.ts file in the src/data/orm/models folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.131.1">import { Model, CreationOptional, ForeignKey, InferAttributes,
    InferCreationAttributes, 
    HasManySetAssociationsMixin} from "sequelize";
import { ProductModel } from "./catalog_models";
import { CustomerModel } from "./customer_models";
import { Address, Order, ProductSelection } from "../../order_models";
export class OrderModel extends Model&lt;InferAttributes&lt;OrderModel&gt;,
        InferCreationAttributes&lt;OrderModel&gt;&gt; implements Order {
    declare id?: CreationOptional&lt;number&gt;;
    declare shipped: boolean;
    declare customerId: ForeignKey&lt;CustomerModel["id"]&gt;;
    declare customer?: InferAttributes&lt;CustomerModel&gt;
    declare addressId: ForeignKey&lt;AddressModel["id"]&gt;;
    declare address?: InferAttributes&lt;AddressModel&gt;;
   
    declare selections?:  InferAttributes&lt;ProductSelectionModel&gt;[];
    declare setSelections:
        HasManySetAssociationsMixin&lt;ProductSelectionModel, number&gt;;
}
export class ProductSelectionModel extends
        Model&lt;InferAttributes&lt;ProductSelectionModel&gt;,
            InferCreationAttributes&lt;ProductSelectionModel&gt;&gt;
        implements ProductSelection {
    declare id?: CreationOptional&lt;number&gt;;
   
    declare productId: ForeignKey&lt;ProductModel["id"]&gt;;
    declare product?: InferAttributes&lt;ProductModel&gt;
    declare quantity: number;
    declare price: number;
    declare orderId: ForeignKey&lt;OrderModel["id"]&gt;;
    declare order?: InferAttributes&lt;OrderModel&gt;;
}
export class AddressModel extends Model&lt;InferAttributes&lt;AddressModel&gt;,
    InferCreationAttributes&lt;AddressModel&gt;&gt; implements Address {
    declare id?: CreationOptional&lt;number&gt;;
    declare street: string;
    declare city: string;
    declare state: string;
    declare zip: string;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.132.1">The model</span><a id="_idIndexMarker975" class="calibre3"/><span class="kobospan" id="kobo.133.1"> classes use Sequelize features described in earlier examples and implement the </span><code class="inlinecode"><span class="kobospan" id="kobo.134.1">Order</span></code><span class="kobospan" id="kobo.135.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.136.1">ProductSelection</span></code><span class="kobospan" id="kobo.137.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.138.1">Address</span></code><span class="kobospan" id="kobo.139.1"> interfaces. </span><span class="kobospan" id="kobo.139.2">As noted in earlier chapters, it can be a fiddly process to get the data model just right, and I find it easier to define the model classes and the helper code that initializes them at the same time. </span><span class="kobospan" id="kobo.139.3">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.140.1">order_helpers.ts</span></code><span class="kobospan" id="kobo.141.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.142.1">server/data/orm/models</span></code><span class="kobospan" id="kobo.143.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.144.1">Listing 18.8</span></em><span class="kobospan" id="kobo.145.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.146.1">Listing 18.8: The contents of the order_helpers.ts file in the server/data/orm/models folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.147.1">import { DataTypes, Sequelize } from "sequelize";
import { OrderModel, ProductSelectionModel, AddressModel }
    from "./order_models";
import { CustomerModel } from "./customer_models";
import { ProductModel } from ".";
const primaryKey = {
    id: { type: DataTypes.INTEGER, autoIncrement: true, primaryKey: true }
};
   
export const initializeOrderModels = (sequelize: Sequelize) =&gt; {
    OrderModel.init({
        ...primaryKey, shipped: DataTypes.BOOLEAN
    }, {sequelize});
    ProductSelectionModel.init({
        ...primaryKey,
        quantity: DataTypes.INTEGER, price: DataTypes.DECIMAL(10, 2)
    }, {sequelize});
    AddressModel.init({
        ...primaryKey,
        street: DataTypes.STRING, city: DataTypes.STRING,
        state: DataTypes.STRING, zip: DataTypes.STRING,
    }, {sequelize});
    OrderModel.belongsTo(CustomerModel, { as: "customer"});
    OrderModel.belongsTo(AddressModel,
        {foreignKey: "addressId", as: "address"});
    OrderModel.belongsToMany(ProductSelectionModel,
        { through: "OrderProductJunction",
            foreignKey: "orderId", as: "selections" });
    ProductSelectionModel.belongsTo(ProductModel, { as: "product"});
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.148.1">In addition </span><a id="_idIndexMarker976" class="calibre3"/><span class="kobospan" id="kobo.149.1">to initializing the model classes, the </span><code class="inlinecode"><span class="kobospan" id="kobo.150.1">initializeOrderModels</span></code><span class="kobospan" id="kobo.151.1"> function describes the relationship between them, which shapes the structure of the database tables that will be created to store the data.</span></p>
<p class="normal"><span class="kobospan" id="kobo.152.1">As noted in </span><em class="italic"><span class="kobospan" id="kobo.153.1">Chapter 15</span></em><span class="kobospan" id="kobo.154.1">, Sequelize adds methods to model classes that allow related data to be managed. </span><span class="kobospan" id="kobo.154.2">This is done using the same mixin technique I used to build up the repository in </span><em class="italic"><span class="kobospan" id="kobo.155.1">Chapter 16</span></em><span class="kobospan" id="kobo.156.1">. </span><span class="kobospan" id="kobo.156.2">One of the methods that will be created as a consequence of the one-to-many relationship between the </span><code class="inlinecode"><span class="kobospan" id="kobo.157.1">ProductSelectionModel</span></code><span class="kobospan" id="kobo.158.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.159.1">OrderModel</span></code><span class="kobospan" id="kobo.160.1"> classes will be named </span><code class="inlinecode"><span class="kobospan" id="kobo.161.1">setSelections</span></code><span class="kobospan" id="kobo.162.1">, which is why I added this </span><code class="inlinecode"><span class="kobospan" id="kobo.163.1">declare</span></code><span class="kobospan" id="kobo.164.1"> statement to the </span><code class="inlinecode"><span class="kobospan" id="kobo.165.1">OrderModel</span></code><span class="kobospan" id="kobo.166.1"> class:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.167.1">...
</span><span class="kobospan" id="kobo.167.2">declare </span><strong class="screentext"><span class="kobospan" id="kobo.168.1">setSelections</span></strong><span class="kobospan" id="kobo.169.1">: HasManySetAssociationsMixin&lt;ProductSelectionModel, number&gt;;
...
</span></code></pre>
<p class="normal"><code class="inlinecode"><span class="kobospan" id="kobo.170.1">Sequelize</span></code><span class="kobospan" id="kobo.171.1"> adds methods for all of the model properties, but this is the only one that I need for the SportsStore application. </span><span class="kobospan" id="kobo.171.2">Therefore, it is the only one for which I added a </span><code class="inlinecode"><span class="kobospan" id="kobo.172.1">declare</span></code><span class="kobospan" id="kobo.173.1"> statement. </span><em class="italic"><span class="kobospan" id="kobo.174.1">Listing 18.9</span></em><span class="kobospan" id="kobo.175.1"> invokes the </span><code class="inlinecode"><span class="kobospan" id="kobo.176.1">initializeCustomerModels</span></code><span class="kobospan" id="kobo.177.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.178.1">initializeOrderModels</span></code><span class="kobospan" id="kobo.179.1"> functions so that the model classes are initialized alongside </span><a id="_idIndexMarker977" class="calibre3"/><span class="kobospan" id="kobo.180.1">those used by the product catalog.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.181.1">Listing 18.9: Initializing models in the index.ts file in the src/data/orm/models folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.182.1">import { Sequelize } from "sequelize";
import { initializeCatalogModels } from "./catalog_helpers";
</span><strong class="screentext"><span class="kobospan" id="kobo.183.1">import { initializeCustomerModels } from "./customer_helpers";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.184.1">import { initializeOrderModels } from "./order_helpers";</span></strong><span class="kobospan" id="kobo.185.1">
export { ProductModel, CategoryModel, SupplierModel } from "./catalog_models";
export const initializeModels = (sequelize: Sequelize) =&gt; {
    initializeCatalogModels(sequelize);
   </span><strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.186.1">initializeCustomerModels(sequelize);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.187.1">    initializeOrderModels(sequelize);</span></strong><span class="kobospan" id="kobo.188.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.189.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.190.1">initializeModels</span></code><span class="kobospan" id="kobo.191.1"> function now initializes all three categories of model classes used by the application.</span></p>
<h2 class="heading1" id="_idParaDest-318"><span class="kobospan" id="kobo.192.1">Implementing the repository</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.193.1">The</span><a id="_idIndexMarker978" class="calibre3"/><span class="kobospan" id="kobo.194.1"> next step is to create implementations of the methods defined by the </span><code class="inlinecode"><span class="kobospan" id="kobo.195.1">OrderRepository</span></code><span class="kobospan" id="kobo.196.1"> interface. </span><span class="kobospan" id="kobo.196.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.197.1">order_queries.ts</span></code><span class="kobospan" id="kobo.198.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.199.1">src/data/orm</span></code><span class="kobospan" id="kobo.200.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.201.1">Listing 18.10</span></em><span class="kobospan" id="kobo.202.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.203.1">Listing 18.10: The contents of the order_queries.ts file in the src/data/orm folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.204.1">import { Attributes, FindOptions } from "sequelize";
import { Order } from "../order_models"
import { BaseRepo, Constructor } from "./core"
import { AddressModel, OrderModel } from "./models/order_models";
import { CustomerModel } from "./models/customer_models";
const queryConfig: FindOptions&lt;Attributes&lt;OrderModel&gt;&gt; = {
    include: [
        { model: AddressModel, as: "address"},
        { model: CustomerModel, as: "customer" }
    ],
    raw: true, nest: true
}
export function AddOrderQueries&lt;TBase
        extends Constructor&lt;BaseRepo&gt;&gt;(Base: TBase)  {
    return class extends Base {
        getOrder(id: number) : Promise&lt;Order | null&gt; {
            return OrderModel.findByPk(id, queryConfig);
        }
        getOrders(excludeShipped: boolean): Promise&lt;Order[]&gt; {
            return OrderModel.findAll(
                excludeShipped ?
                    </span><span class="kobospan" id="kobo.204.2">{ ...queryConfig, where: { shipped: false}} : queryConfig
            )           
        }
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.205.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.206.1">AddOrderQueries</span></code><span class="kobospan" id="kobo.207.1"> function </span><a id="_idIndexMarker979" class="calibre3"/><span class="kobospan" id="kobo.208.1">returns a class that implements the </span><code class="inlinecode"><span class="kobospan" id="kobo.209.1">getOrder</span></code><span class="kobospan" id="kobo.210.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.211.1">getOrders</span></code><span class="kobospan" id="kobo.212.1"> methods required by the </span><code class="inlinecode"><span class="kobospan" id="kobo.213.1">OrderRepository</span></code><span class="kobospan" id="kobo.214.1"> interface. </span><span class="kobospan" id="kobo.214.2">To keep queries consistent, I have used the types provided by Sequelize to describe the options used to query the database. </span><span class="kobospan" id="kobo.214.3">Query options for </span><code class="inlinecode"><span class="kobospan" id="kobo.215.1">OrderModel</span></code><span class="kobospan" id="kobo.216.1"> data are described using the </span><code class="inlinecode"><span class="kobospan" id="kobo.217.1">FindOptions&lt;Attributes&lt;OrderModel&gt;&gt;</span></code><span class="kobospan" id="kobo.218.1"> type. </span><span class="kobospan" id="kobo.218.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.219.1">queryConfig</span></code><span class="kobospan" id="kobo.220.1"> object uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.221.1">include</span></code><span class="kobospan" id="kobo.222.1"> property to incorporate related </span><code class="inlinecode"><span class="kobospan" id="kobo.223.1">AddressModel</span></code><span class="kobospan" id="kobo.224.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.225.1">CustomerModel</span></code><span class="kobospan" id="kobo.226.1"> data in the results and sets the </span><code class="inlinecode"><span class="kobospan" id="kobo.227.1">raw</span></code><span class="kobospan" id="kobo.228.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.229.1">nest</span></code><span class="kobospan" id="kobo.230.1"> properties to specify the format of the results. </span><span class="kobospan" id="kobo.230.2">To implement the remaining interface method, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.231.1">order_storage.ts</span></code><span class="kobospan" id="kobo.232.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.233.1">src/data/orm</span></code><span class="kobospan" id="kobo.234.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.235.1">Listing 18.11</span></em><span class="kobospan" id="kobo.236.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.237.1">Listing 18.11: The contents of the order_storage.ts file in the src/data/orm folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.238.1">import { Order } from "../order_models"
import { BaseRepo, Constructor } from "./core"
import { AddressModel, OrderModel, ProductSelectionModel }
    from "./models/order_models";
import { CustomerModel } from "./models/customer_models";
export function AddOrderStorage&lt;TBase extends
        Constructor&lt;BaseRepo&gt;&gt;(Base: TBase)  {
    return class extends Base {
        storeOrder(order: Order): Promise&lt;Order&gt; {
            return  this.sequelize.transaction(async (transaction) =&gt; {
                const { id, shipped } = order;
                const [stored] =
                    await OrderModel.upsert({ id, shipped }, {transaction});
               
                if (order.customer) {
                    const [{id}] = await CustomerModel.findOrCreate({
                        where: { email: order.customer.email},
                        defaults: order.customer,
                        transaction
                    });
                    stored.customerId = id;
                }
                if (order.address) {
                   
                    const [{id}] = await AddressModel.findOrCreate({
                        where: { ...order.address },
                        defaults: order.address,
                        transaction
                    });
                    stored.addressId = id;
                }
                await stored.save({transaction});
                if (order.selections) {
                    const sels = await ProductSelectionModel.bulkCreate(
                        order.selections, { transaction});
                    await stored.setSelections(
                        sels, { transaction });
                }
                return stored;
            });
        }
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.239.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.240.1">Sequelize</span></code> <code class="inlinecode"><span class="kobospan" id="kobo.241.1">upsert</span></code><span class="kobospan" id="kobo.242.1"> method</span><a id="_idIndexMarker980" class="calibre3"/><span class="kobospan" id="kobo.243.1"> is used to update or create the order, customer, and address data. </span><span class="kobospan" id="kobo.243.2">The product selections are stored using the </span><code class="inlinecode"><span class="kobospan" id="kobo.244.1">bulkCreate</span></code><span class="kobospan" id="kobo.245.1"> method, which allows multiple rows to be stored in a single operation, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.246.1">mixin</span></code> <code class="inlinecode"><span class="kobospan" id="kobo.247.1">setSelections</span></code><span class="kobospan" id="kobo.248.1"> method is used to associate the stored product selections with the order. </span><span class="kobospan" id="kobo.248.2">These operations are all performed within the same transaction to ensure data consistency. </span><em class="italic"><span class="kobospan" id="kobo.249.1">Listing 18.12</span></em><span class="kobospan" id="kobo.250.1"> uses the JavaScript </span><code class="inlinecode"><span class="kobospan" id="kobo.251.1">mixin</span></code><span class="kobospan" id="kobo.252.1"> feature to incorporate the order functionality into the combined repository class.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.253.1">Listing 18.12: Adding orders to the index.ts file in the src/data/orm folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.254.1">import { BaseRepo } from "./core";
import { AddQueries } from "./queries";
import { AddStorage } from "./storage";
</span><strong class="screentext"><span class="kobospan" id="kobo.255.1">import { AddOrderQueries</span></strong><strong class="screentext"><span class="kobospan" id="kobo.256.1"> } from "./order_queries";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.257.1">import { AddOrderStorage } from "./order_storage";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.258.1">const CatalogRepo = AddStorage(</span></strong><strong class="screentext"><span class="kobospan" id="kobo.259.1">AddQueries(BaseRepo));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.260.1">const RepoWithOrders = AddOrderStorage(AddOrderQueries(CatalogRepo));</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.261.1">export const CatalogRepoImpl</span></strong><strong class="screentext"><span class="kobospan" id="kobo.262.1"> = RepoWithOrders;</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.263.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.264.1">CatalogRepoImpl</span></code><span class="kobospan" id="kobo.265.1"> class exported from this module implements the methods required by the </span><code class="inlinecode"><span class="kobospan" id="kobo.266.1">CatalogRepository</span></code><span class="kobospan" id="kobo.267.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.268.1">OrderRepository</span></code><span class="kobospan" id="kobo.269.1"> interfaces. </span><span class="kobospan" id="kobo.269.2">Even though a single class implements all repository methods, I prefer to present the functionality separately to the rest of the application, as shown in </span><em class="italic"><span class="kobospan" id="kobo.270.1">Listing 18.13</span></em><span class="kobospan" id="kobo.271.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.272.1">Listing 18.13: Creating the repository in the index.ts file in the src/data folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.273.1">import { CatalogRepository } from "./catalog_repository";
import { CatalogRepoImpl} from "./orm";
</span><strong class="screentext"><span class="kobospan" id="kobo.274.1">import { OrderRepository } from "./order_repository";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.275.1">const repo = </span></strong><strong class="screentext"><span class="kobospan" id="kobo.276.1">new CatalogRepoImpl();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.277.1">export const catalog_repository: CatalogRepository = repo;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.278.1">export const order_repository: OrderRepository</span></strong><strong class="screentext"><span class="kobospan" id="kobo.279.1"> = repo;</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.280.1">The</span><a id="_idIndexMarker981" class="calibre3"/><span class="kobospan" id="kobo.281.1"> TypeScript type annotations will ensure that each of the constants exported by this module will present only the methods defined by one of the repository interfaces.</span></p>
<h1 class="heading" id="_idParaDest-319"><span class="kobospan" id="kobo.282.1">Implementing the order flow</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.283.1">Now that </span><a id="_idIndexMarker982" class="calibre3"/><span class="kobospan" id="kobo.284.1">the data model</span><a id="_idIndexMarker983" class="calibre3"/><span class="kobospan" id="kobo.285.1"> extends to describe and store order data, the next step is to create the workflow that allows orders to be created and stored.</span></p>
<h2 class="heading1" id="_idParaDest-320"><span class="kobospan" id="kobo.286.1">Validating data</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.287.1">The </span><a id="_idIndexMarker984" class="calibre3"/><span class="kobospan" id="kobo.288.1">process of creating an order requires data from the user, which will be validated before it is used and stored. </span><span class="kobospan" id="kobo.288.2">To install the validation package and its TypeScript descriptions, use a command prompt to run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.289.1">Listing 18.14</span></em><span class="kobospan" id="kobo.290.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.291.1">sportsstore</span></code><span class="kobospan" id="kobo.292.1"> folder. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.293.1">Listing 18.14: Installing the validation packages</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.294.1">npm install validator@13.11.0
npm install --save-dev @types/validator@13.11.5
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.295.1">These packages are described in </span><em class="italic"><span class="kobospan" id="kobo.296.1">Table 18.1</span></em><span class="kobospan" id="kobo.297.1"> for quick reference.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.298.1">Table 18.1: The validation packages</span></p>
<table class="table-container" id="table001-15">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.299.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.300.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.301.1">validator</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.302.1">This package contains validators for common data types.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.303.1">@types/validator</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.304.1">This package contains TypeScript descriptions of the validator API.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.305.1">To start the</span><a id="_idIndexMarker985" class="calibre3"/><span class="kobospan" id="kobo.306.1"> validation functionality, create the </span><code class="inlinecode"><span class="kobospan" id="kobo.307.1">src/data/validation</span></code><span class="kobospan" id="kobo.308.1"> folder and add to it a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.309.1">validation_types.ts</span></code><span class="kobospan" id="kobo.310.1"> with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.311.1">Listing 18.15</span></em><span class="kobospan" id="kobo.312.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.313.1">Listing 18.15: The contents of the validation_types.ts file in the src/data/validation folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.314.1">export class ValidationStatus {
    private invalid: boolean = false;
    constructor(public readonly value: any) {}
    get isInvalid() : boolean  {
        return this.invalid
    }
    setInvalid(newValue: boolean) {
        this.invalid = newValue || this.invalid;
    }
   
    messages: string[] = [];
}
export type ValidationRule = (status: ValidationStatus)
    =&gt; void | Promise&lt;void&gt;;
export type ValidationRuleSet&lt;T&gt; = {
    [key in keyof Omit&lt;Required&lt;T&gt;, "id"&gt;]: ValidationRule | ValidationRule[];
}
export type ValidationResults&lt;T&gt; = {
    [key in keyof Omit&lt;Required&lt;T&gt;, "id"&gt;]: ValidationStatus;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.315.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.316.1">ValidationStatus</span></code><span class="kobospan" id="kobo.317.1"> class represents the validation status of a single model property, which will allow rules to validate the data. </span><span class="kobospan" id="kobo.317.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.318.1">ValidationRule</span></code><span class="kobospan" id="kobo.319.1"> type describes a rule that receives a </span><code class="inlinecode"><span class="kobospan" id="kobo.320.1">ValidationStatus</span></code><span class="kobospan" id="kobo.321.1"> object and validates the data value it defines. </span><span class="kobospan" id="kobo.321.2">The validity of a value can be set using the </span><code class="inlinecode"><span class="kobospan" id="kobo.322.1">setInvalid</span></code><span class="kobospan" id="kobo.323.1"> method defined by the </span><code class="inlinecode"><span class="kobospan" id="kobo.324.1">ValidationStatus</span></code><span class="kobospan" id="kobo.325.1"> class, which latches so that once a value has been </span><a id="_idIndexMarker986" class="calibre3"/><span class="kobospan" id="kobo.326.1">marked as </span><code class="inlinecode"><span class="kobospan" id="kobo.327.1">invalid</span></code><span class="kobospan" id="kobo.328.1">, it cannot be returned to the </span><code class="inlinecode"><span class="kobospan" id="kobo.329.1">valid</span></code><span class="kobospan" id="kobo.330.1"> state by another rule. </span></p>
<p class="normal"><span class="kobospan" id="kobo.331.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.332.1">ValidationRuleSet&lt;T&gt;</span></code><span class="kobospan" id="kobo.333.1"> type describes the set of rules that are applied to a model class, </span><code class="inlinecode"><span class="kobospan" id="kobo.334.1">T</span></code><span class="kobospan" id="kobo.335.1">. </span><span class="kobospan" id="kobo.335.2">Each property defined by the model class must have at least one validation rule. </span></p>
<p class="normal"><span class="kobospan" id="kobo.336.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.337.1">ValidationResults&lt;T&gt;</span></code><span class="kobospan" id="kobo.338.1"> type describes the validation results for a model object, with a </span><code class="inlinecode"><span class="kobospan" id="kobo.339.1">ValidationStatus</span></code><span class="kobospan" id="kobo.340.1"> object defined for each model property.</span></p>
<p class="normal"><span class="kobospan" id="kobo.341.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.342.1">ValidationRuleSet&lt;T&gt;</span></code><span class="kobospan" id="kobo.343.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.344.1">ValidationResults&lt;T&gt;</span></code><span class="kobospan" id="kobo.345.1"> types use the TypeScript utility types to describe how validation requirements and results are expressed for models:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.346.1">...
 </span><span class="kobospan" id="kobo.346.2">[key in keyof </span><strong class="screentext"><span class="kobospan" id="kobo.347.1">Omit&lt;Required&lt;T&gt;, "id"&gt;</span></strong><span class="kobospan" id="kobo.348.1">]: ValidationRule | ValidationRule[];
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.349.1">This incantation tells the TypeScript compiler that properties are required for each property defined by the type </span><code class="inlinecode"><span class="kobospan" id="kobo.350.1">T</span></code><span class="kobospan" id="kobo.351.1">, including optional properties, except for the property named </span><code class="inlinecode"><span class="kobospan" id="kobo.352.1">id</span></code><span class="kobospan" id="kobo.353.1">. </span><span class="kobospan" id="kobo.353.2">TypeScript provides a range of useful utility types (described at </span><a href="https://www.typescriptlang.org/docs/handbook/utility-types.html" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.354.1">https://www.typescriptlang.org/docs/handbook/utility-types.html</span></span></a><span class="kobospan" id="kobo.355.1">) that can be used to describe how one type relates to another and, in this case, the effect is that validation requirements and results are comprehensive.</span></p>
<p class="normal"><span class="kobospan" id="kobo.356.1">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.357.1">validator.ts</span></code><span class="kobospan" id="kobo.358.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.359.1">src/data/validation</span></code><span class="kobospan" id="kobo.360.1"> folder with the contents shown in </span><em class="italic"><span class="kobospan" id="kobo.361.1">Listing 18.16</span></em><span class="kobospan" id="kobo.362.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.363.1">Listing 18.16: The contents of the validator.ts file in the src/data/validation folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.364.1">import { ValidationResults, ValidationRule, ValidationRuleSet,
    ValidationStatus } from "./validation_types";
export class Validator&lt;T&gt;{
    constructor(public rules: ValidationRuleSet&lt;T&gt;,
        public breakOnInvalid = true) {}
        async validate(data: any): Promise&lt;ValidationResults&lt;T&gt;&gt; {
            const vdata = Object.entries(this.rules).map(async ([key, rules]) =&gt; {
                const status = new ValidationStatus(data?.[key] ?? </span><span class="kobospan" id="kobo.364.2">"");
                const rs = (Array.isArray(rules) ? </span><span class="kobospan" id="kobo.364.3">rules: [rules]);
                for (const r of rs) {
                    if (!status.isInvalid || !this.breakOnInvalid) {
                        await r(status);
                    }
                }
                return [key, status];
            });
            const done = await Promise.all(vdata);
            return Object.fromEntries(done);
        }
    validateOriginal(data: any): ValidationResults&lt;T&gt; {
        const vdata = Object.entries(this.rules).map(([key, rules]) =&gt; {
            const status = new ValidationStatus(data?.[key] ?? </span><span class="kobospan" id="kobo.364.4">"");
            (Array.isArray(rules) ? </span><span class="kobospan" id="kobo.364.5">rules: [rules])
                .forEach(async (rule: ValidationRule) =&gt; {
                    if (!status.isInvalid || !this.breakOnInvalid) {
                        await rule(status);
                    }
            });
            return [key, status];
        });
        return Object.fromEntries(vdata);
    }
}
export function isValid&lt;T&gt;(result: ValidationResults&lt;T&gt;) {
    return Object.values&lt;ValidationStatus&gt;(result)
        .every(r =&gt; r.isInvalid === false);
}
export function getData&lt;T&gt;(result: ValidationResults&lt;T&gt;): T {
    return Object.fromEntries (Object.entries&lt;ValidationStatus&gt;(result)
        .map(([key, status]) =&gt; [key, status.value])) as T;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.365.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.366.1">Validator&lt;T&gt;</span></code><span class="kobospan" id="kobo.367.1"> class</span><a id="_idIndexMarker987" class="calibre3"/><span class="kobospan" id="kobo.368.1"> provides validation for the model type </span><code class="inlinecode"><span class="kobospan" id="kobo.369.1">T</span></code><span class="kobospan" id="kobo.370.1">. </span><span class="kobospan" id="kobo.370.2">The constructor parameters are a </span><code class="inlinecode"><span class="kobospan" id="kobo.371.1">ValidationRuleSet&lt;T&gt;</span></code><span class="kobospan" id="kobo.372.1"> value that provides the rules to apply and a </span><code class="inlinecode"><span class="kobospan" id="kobo.373.1">boolean</span></code><span class="kobospan" id="kobo.374.1"> argument that specifies whether validation for a property will stop after the rule reports whether a value is invalid, or whether validation will continue to apply all of the rules.</span></p>
<p class="normal"><span class="kobospan" id="kobo.375.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.376.1">validate</span></code><span class="kobospan" id="kobo.377.1"> method accepts a value to validate, applies the rules, and builds a </span><code class="inlinecode"><span class="kobospan" id="kobo.378.1">ValidationResult&lt;T&gt;</span></code><span class="kobospan" id="kobo.379.1"> object that describes the outcome. </span><em class="italic"><span class="kobospan" id="kobo.380.1">Listing 18.16</span></em><span class="kobospan" id="kobo.381.1"> includes a utility function named </span><code class="inlinecode"><span class="kobospan" id="kobo.382.1">isValid</span></code><span class="kobospan" id="kobo.383.1"> that checks the validation results produced for a value and determines whether all of the properties are valid. </span><span class="kobospan" id="kobo.383.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.384.1">getData</span></code><span class="kobospan" id="kobo.385.1"> method extracts the data from the validation results, which will be used to ensure that the application only uses properties for which validation rules have been defined and values that have passed validation.</span></p>
<h3 class="heading2" id="_idParaDest-321"><span class="kobospan" id="kobo.386.1">Defining validation rules</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.387.1">To</span><a id="_idIndexMarker988" class="calibre3"/><span class="kobospan" id="kobo.388.1"> create the basic validation rules for properties, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.389.1">basic_rules.ts</span></code><span class="kobospan" id="kobo.390.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.391.1">src/data/validation</span></code><span class="kobospan" id="kobo.392.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.393.1">Listing 18.17</span></em><span class="kobospan" id="kobo.394.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.395.1">Listing 18.17: The contents of the basic_rules.ts file in the src/data/validation folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.396.1">import validator from "validator";
import { ValidationStatus } from "./validation_types";
export const minLength = (min: number) =&gt; (status: ValidationStatus) =&gt; {
    if (!validator.isLength(status.value, { min })) {
        status.setInvalid(true);
        status.messages.push(`Enter at least ${min} characters`);
    }
};
export const email = (status: ValidationStatus) =&gt; {
    if (!validator.isEmail(status.value)) {
        status.setInvalid(true);
        status.messages.push("Enter an email address");
    }
};
export const required = (status: ValidationStatus) =&gt; {
    if (validator.isEmpty(status.value.toString(), { ignore_whitespace: true})) {
        status.setInvalid(true);
        status.messages.push("A value is required");
    }
};
export const no_op = (status: ValidationStatus) =&gt; { /* do nothing */ }
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.397.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.398.1">minLength</span></code><span class="kobospan" id="kobo.399.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.400.1">email</span></code><span class="kobospan" id="kobo.401.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.402.1">required</span></code><span class="kobospan" id="kobo.403.1"> functions ensure that a value has a minimum length, is a </span><a id="_idIndexMarker989" class="calibre3"/><span class="kobospan" id="kobo.404.1">correctly formatted email address, and that a value isn’t undefined or an empty string. </span><span class="kobospan" id="kobo.404.2">All three functions use the features provided by the </span><code class="inlinecode"><span class="kobospan" id="kobo.405.1">validator</span></code><span class="kobospan" id="kobo.406.1"> package. </span><span class="kobospan" id="kobo.406.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.407.1">no_op</span></code><span class="kobospan" id="kobo.408.1"> function doesn’t perform any validation and is a consequence of requiring validation rules for every property defined by a model class except the </span><code class="inlinecode"><span class="kobospan" id="kobo.409.1">id</span></code><span class="kobospan" id="kobo.410.1"> property: some properties won’t require validation but must be included in the validation configuration, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.411.1">no_op</span></code><span class="kobospan" id="kobo.412.1"> (short for </span><em class="italic"><span class="kobospan" id="kobo.413.1">no operation</span></em><span class="kobospan" id="kobo.414.1">) function can be used.</span></p>
<p class="normal"><span class="kobospan" id="kobo.415.1">To describe the validation requirements for the data the user will provide for orders, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.416.1">order_rules.ts</span></code><span class="kobospan" id="kobo.417.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.418.1">src/data/validation</span></code><span class="kobospan" id="kobo.419.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.420.1">Listing 18.18</span></em><span class="kobospan" id="kobo.421.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.422.1">Listing 18.18: The contents of the order_rules.ts file in the src/data/validation folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.423.1">import { Validator } from "./validator";
import { required, minLength, email, no_op } from "./basic_rules";
import { Address } from "../order_models";
import { Customer } from "../customer_models";
export const CustomerValidator = new Validator&lt;Customer&gt;({
    name: [required, minLength(6)],
    email: email
});
export const AddressValidator = new Validator&lt;Address&gt;({
    street: required,
    city: required,
    state: required,
    zip: no_op
});
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.424.1">Listing 18.18</span></em><span class="kobospan" id="kobo.425.1"> defines the validation rules for the </span><code class="inlinecode"><span class="kobospan" id="kobo.426.1">Customer</span></code><span class="kobospan" id="kobo.427.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.428.1">Address</span></code><span class="kobospan" id="kobo.429.1"> model types, which </span><a id="_idIndexMarker990" class="calibre3"/><span class="kobospan" id="kobo.430.1">will be combined with the contents of the user’s cart to create an order. </span><span class="kobospan" id="kobo.430.2">Notice that the </span><code class="inlinecode"><span class="kobospan" id="kobo.431.1">zip</span></code><span class="kobospan" id="kobo.432.1"> property for addresses uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.433.1">no_op</span></code><span class="kobospan" id="kobo.434.1"> rule, which tells the validator that this property is optional and has no specific validation requirements.</span></p>
<p class="normal"><span class="kobospan" id="kobo.435.1">This is a more comprehensive way to define validation than the approach I used in </span><em class="italic"><span class="kobospan" id="kobo.436.1">Part 2</span></em><span class="kobospan" id="kobo.437.1"> of this book because it uses TypeScript to ensure that validation requirements are specified for every property defined by a type, except for the </span><code class="inlinecode"><span class="kobospan" id="kobo.438.1">id</span></code><span class="kobospan" id="kobo.439.1"> property, which I have omitted because I generally want to let the database figure out what IDs are required for objects. </span></p>
<p class="normal"><span class="kobospan" id="kobo.440.1">When an id value is provided by the client, I will validate it separately from the rest of the data. </span><span class="kobospan" id="kobo.440.2">To complete the validation feature, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.441.1">index.ts</span></code><span class="kobospan" id="kobo.442.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.443.1">src/data/validation</span></code><span class="kobospan" id="kobo.444.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.445.1">Listing 18.19</span></em><span class="kobospan" id="kobo.446.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.447.1">Listing 18.19: The contents of the index.ts file in the src/data/validation folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.448.1">export * from "./validation_types";
export * from "./validator";
export * from "./basic_rules";
export * from "./order_rules";
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.449.1">This file simply exports the contents of the other files in the validation folder so the contents can be consumed more easily by the rest of the application.</span></p>
<h2 class="heading1" id="_idParaDest-322"><span class="kobospan" id="kobo.450.1">Creating the HTTP handlers</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.451.1">The </span><a id="_idIndexMarker991" class="calibre3"/><span class="kobospan" id="kobo.452.1">next step is to define the three HTTP handlers that will be used to complete the order process: a </span><code class="inlinecode"><span class="kobospan" id="kobo.453.1">GET</span></code><span class="kobospan" id="kobo.454.1"> handler that renders an HTML form for collecting the user’s details, a </span><code class="inlinecode"><span class="kobospan" id="kobo.455.1">POST</span></code><span class="kobospan" id="kobo.456.1"> handler that receives and validates the user’s details, and a </span><code class="inlinecode"><span class="kobospan" id="kobo.457.1">GET</span></code><span class="kobospan" id="kobo.458.1"> handler that displays a summary message once the order has been completed. </span><span class="kobospan" id="kobo.458.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.459.1">orders.ts</span></code><span class="kobospan" id="kobo.460.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.461.1">src/routes </span></code><span class="kobospan" id="kobo.462.1">folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.463.1">Listing 18.20</span></em><span class="kobospan" id="kobo.464.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.465.1">Listing 18.20: The contents of the orders.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.466.1">import { Express } from "express";
import { Address } from "../data/order_models";
import { AddressValidator, CustomerValidator, ValidationResults, getData, isValid }
    from "../data/validation";
import { Customer } from "../data/customer_models";
import { createAndStoreOrder } from "./order_helpers";
declare module "express-session" {
    interface SessionData {
       orderData?: {
            customer?: ValidationResults&lt;Customer&gt;,
            address?: ValidationResults&lt;Address&gt;
       }
    }
}
export const createOrderRoutes = (app: Express) =&gt; {
    app.get("/checkout", (req, resp) =&gt; {
        resp.render("order_details", {
            order: req.session.orderData,
        });
    });
    app.post("/checkout", async (req, resp) =&gt; {
        const { customer, address } = req.body;
        const data = req.session.orderData = {
            customer: await CustomerValidator.validate(customer),
            address: await AddressValidator.validate(address)
        };
        if (isValid(data.customer) &amp;&amp; isValid(data.address)
                &amp;&amp; req.session.cart) {
            const order = await createAndStoreOrder(
                getData(data.customer), getData(data.address), req.session.cart
            )
            resp.redirect(`/checkout/${order.id}`);
            req.session.cart = undefined;
            req.session.orderData = undefined;
        } else {
            resp.redirect("/checkout");
        }
    });
    app.get("/checkout/:id", (req, resp) =&gt; {
        resp.render("order_complete", {id: req.params.id});
    })
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.467.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.468.1">declare</span></code><span class="kobospan" id="kobo.469.1"> statement tells TypeScript that the session will be used to store an object using the name </span><code class="inlinecode"><span class="kobospan" id="kobo.470.1">orderData</span></code><span class="kobospan" id="kobo.471.1">, with </span><code class="inlinecode"><span class="kobospan" id="kobo.472.1">customer</span></code><span class="kobospan" id="kobo.473.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.474.1">address</span></code><span class="kobospan" id="kobo.475.1"> properties whose values are validation results.</span></p>
<p class="normal"><span class="kobospan" id="kobo.476.1">The</span><a id="_idIndexMarker992" class="calibre3"/><span class="kobospan" id="kobo.477.1"> first handler accepts </span><code class="inlinecode"><span class="kobospan" id="kobo.478.1">GET</span></code><span class="kobospan" id="kobo.479.1"> requests sent to the </span><code class="inlinecode"><span class="kobospan" id="kobo.480.1">/checkout</span></code><span class="kobospan" id="kobo.481.1"> URL and responds by rendering a template named </span><code class="inlinecode"><span class="kobospan" id="kobo.482.1">order_details</span></code><span class="kobospan" id="kobo.483.1">, passing the </span><code class="inlinecode"><span class="kobospan" id="kobo.484.1">customer</span></code><span class="kobospan" id="kobo.485.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.486.1">address</span></code><span class="kobospan" id="kobo.487.1"> data stored in the session as context data. </span></p>
<p class="normal"><span class="kobospan" id="kobo.488.1">This template renders the HTML form, which will be empty the first time the user sends a </span><code class="inlinecode"><span class="kobospan" id="kobo.489.1">GET</span></code><span class="kobospan" id="kobo.490.1"> request because no customer or address data has been stored in the session.</span></p>
<p class="normal"><span class="kobospan" id="kobo.491.1">The second handler accepts </span><code class="inlinecode"><span class="kobospan" id="kobo.492.1">POST</span></code><span class="kobospan" id="kobo.493.1"> requests to the </span><code class="inlinecode"><span class="kobospan" id="kobo.494.1">/checkout</span></code><span class="kobospan" id="kobo.495.1"> URL, where the customer and address data is read from the request and validated, like this:</span></p>
<pre class="programlisting2"><code class="hljs-code"><span class="kobospan" id="kobo.496.1">...
</span></code></pre>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.497.1">const data = req.session.orderData = {
    customer: await CustomerValidator.</span><strong class="screentext"><span class="kobospan" id="kobo.498.1">validate</span></strong><span class="kobospan" id="kobo.499.1">(customer),
    address: await AddressValidator.</span><strong class="screentext"><span class="kobospan" id="kobo.500.1">validate</span></strong><span class="kobospan" id="kobo.501.1">(address)
};
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.502.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.503.1">through</span></code><span class="kobospan" id="kobo.504.1"> assignment used in this statement ensures that the validation results are stored in the session and stored in a local constant named </span><code class="inlinecode"><span class="kobospan" id="kobo.505.1">data</span></code><span class="kobospan" id="kobo.506.1">, just for ease of use.</span></p>
<p class="normal"><span class="kobospan" id="kobo.507.1">If the</span><a id="_idIndexMarker993" class="calibre3"/><span class="kobospan" id="kobo.508.1"> data is invalid, a redirection to the </span><code class="inlinecode"><span class="kobospan" id="kobo.509.1">/checkout</span></code><span class="kobospan" id="kobo.510.1"> URL renders the form but, this time, there will be validation data for the template to display to give the user feedback.</span></p>
<p class="normal"><span class="kobospan" id="kobo.511.1">If the data is valid, then an order is created by calling a function called </span><code class="inlinecode"><span class="kobospan" id="kobo.512.1">createAndStoreOrder</span></code><span class="kobospan" id="kobo.513.1">, which is defined in </span><em class="italic"><span class="kobospan" id="kobo.514.1">Listing 18.21</span></em><span class="kobospan" id="kobo.515.1">, and combines the customer and address data with the contents of the user’s cart to create and store an order. </span><span class="kobospan" id="kobo.515.2">The data passed to the </span><code class="inlinecode"><span class="kobospan" id="kobo.516.1">createAndStoreOrder</span></code><span class="kobospan" id="kobo.517.1"> function is extracted from the validation results, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.518.1">...
</span><span class="kobospan" id="kobo.518.2">const order = await createAndStoreOrder(
    </span><strong class="screentext"><span class="kobospan" id="kobo.519.1">getData</span></strong><span class="kobospan" id="kobo.520.1">(data.customer), </span><strong class="screentext"><span class="kobospan" id="kobo.521.1">getData</span></strong><span class="kobospan" id="kobo.522.1">(data.address), req.session.cart
)
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.523.1">This ensures that only the properties defined by the model types are used, which is one of the reasons why the validation types defined earlier in the chapter require validation information for every model property. </span><span class="kobospan" id="kobo.523.2">Once the order is stored, a redirection to the third handler is performed, which includes the ID of the order in the URL, and which can be used to display a confirmation message to the user. </span><span class="kobospan" id="kobo.523.3">The </span><code class="inlinecode"><span class="kobospan" id="kobo.524.1">cart</span></code><span class="kobospan" id="kobo.525.1">, customer, and address data are removed from the session so that the user can start shopping afresh.</span></p>
<p class="normal"><span class="kobospan" id="kobo.526.1">To define the function that combines the customer, address, and cart data and stores the order, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.527.1">order_helpers.ts</span></code><span class="kobospan" id="kobo.528.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.529.1">src/routes</span></code><span class="kobospan" id="kobo.530.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.531.1">Listing 18.21</span></em><span class="kobospan" id="kobo.532.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.533.1">Listing 18.21: The contents of the order_helpers.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.534.1">import { catalog_repository, order_repository } from "../data";
import { Cart } from "../data/cart_models"
import { Customer } from "../data/customer_models"
import { Address, Order } from "../data/order_models"
export const createAndStoreOrder = async (customer: Customer,
        address: Address, cart: Cart): Promise&lt;Order&gt; =&gt; {
    const product_ids = cart.lines.map(l =&gt; l.productId) ?? </span><span class="kobospan" id="kobo.534.2">[];
    const product_details = Object.fromEntries((await
        catalog_repository.getProductDetails(product_ids))
            .map(p =&gt; [p.id ?? </span><span class="kobospan" id="kobo.534.3">0, p.price ?? </span><span class="kobospan" id="kobo.534.4">0]));
    const selections = cart.lines.map(l =&gt; ({
        productId: l.productId, quantity: l.quantity,
        price: product_details[l.productId]}));
    return order_repository.storeOrder({   
        customer,address,
        selections, shipped: false
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.535.1">Example</span><a id="_idIndexMarker994" class="calibre3"/><span class="kobospan" id="kobo.536.1"> applications usually contrive to avoid the messy reality of merging and formatting data, but it is something that should be expected in every project. </span><span class="kobospan" id="kobo.536.2">In this case, the cart data has to be matched up with product prices, which is an awkward process that requires awkward code.</span></p>
<p class="normal"><span class="kobospan" id="kobo.537.1">There is often an “Oh, no!” </span><span class="kobospan" id="kobo.537.2">moment when reaching the point where you realize that the data you have isn’t the data you need, and that additional queries and transforms are required. </span><span class="kobospan" id="kobo.537.3">It can be tempting to go back and smooth out the rough edges in the data model, but my advice is not to do that because it just breaks up the problem so that none of the data models exactly suit their purpose, which leaves little bits of awkwardness all over the place. </span><span class="kobospan" id="kobo.537.4">Instead, my preference is to define each model so that it suits the part of the application that it serves and accept that there will be crunch points where data from one part of the application is bent into the shape required by another part. </span><em class="italic"><span class="kobospan" id="kobo.538.1">Listing 18.22</span></em><span class="kobospan" id="kobo.539.1"> enables the routes required for orders.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.540.1">Listing 18.22: Enabling routes in the index.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.541.1">import { Express } from "express";
import { createCatalogRoutes } from "./catalog";
import { createCartMiddleware, createCartRoutes } from "./cart";
</span><strong class="screentext"><span class="kobospan" id="kobo.542.1">import { createOrderRoutes } from "./orders";</span></strong><span class="kobospan" id="kobo.543.1">
export const createRoutes = (app: Express) =&gt; {
    createCartMiddleware(app);
    createCatalogRoutes(app);
    createCartRoutes(app);
   </span><strong class="screentext"><span class="kobospan" id="kobo.544.1"> createOrderRoutes(app);</span></strong><span class="kobospan" id="kobo.545.1">
}
</span></code></pre>
<h2 class="heading1" id="_idParaDest-323"><span class="kobospan" id="kobo.546.1">Creating the templates and helpers</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.547.1">New</span><a id="_idIndexMarker995" class="calibre3"/><span class="kobospan" id="kobo.548.1"> template helpers are required to render the order form. </span><span class="kobospan" id="kobo.548.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.549.1">order_helpers.ts</span></code><span class="kobospan" id="kobo.550.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.551.1">src/helpers</span></code><span class="kobospan" id="kobo.552.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.553.1">Listing 18.23</span></em><span class="kobospan" id="kobo.554.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.555.1">Listing 18.23: The contents of the order_helpers.ts file in the src/helpers folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.556.1">export const toArray = (...args: any[]) =&gt; args.slice(0, -1);
export const lower = (val: string) =&gt; val.toLowerCase();
export const getValue = (val: any, prop: string) =&gt;
    val?.[prop.toLowerCase()] ?? </span><span class="kobospan" id="kobo.556.2">{};
export const get = (val: any) =&gt; val ?? </span><span class="kobospan" id="kobo.556.3">{};
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.557.1">The purpose of each helper will be explained as they are used, but they all manipulate data values so they can be included in the template output. </span><em class="italic"><span class="kobospan" id="kobo.558.1">Listing 18.24</span></em><span class="kobospan" id="kobo.559.1"> enables the new helpers.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.560.1">Listing 18.24: Adding helpers to the index.ts file in the src/helpers folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.561.1">import { Express } from "express";
import { getConfig } from "../config";
import { engine } from "express-handlebars";
import * as env_helpers from "./env";
import * as catalog_helpers from "./catalog_helpers";
import * as cart_helpers from "./cart_helpers";
</span><strong class="screentext"><span class="kobospan" id="kobo.562.1">import * as order_helpers from "./order_helpers";</span></strong><span class="kobospan" id="kobo.563.1">
const location = getConfig("templates:location");
const config = getConfig("templates:config");
export const createTemplates = (app: Express) =&gt; {
    app.set("views", location);
    app.engine("handlebars", engine({
        ...config,
       </span><strong class="screentext"><span class="kobospan" id="kobo.564.1"> helpers: {...env_helpers, ...catalog_helpers, ...cart_helpers,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.565.1">                    ...order_helpers}</span></strong><span class="kobospan" id="kobo.566.1">
    }));
    app.set("view engine", "handlebars");
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.567.1">Starting </span><a id="_idIndexMarker996" class="calibre3"/><span class="kobospan" id="kobo.568.1">with the simplest templates, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.569.1">order_complete.handlebars</span></code><span class="kobospan" id="kobo.570.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.571.1">templates</span></code><span class="kobospan" id="kobo.572.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.573.1">Listing 18.25</span></em><span class="kobospan" id="kobo.574.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.575.1">Listing 18.25: The contents of the order_complete.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.576.1">&lt;div class="text-center m-2"&gt;
    &lt;h2&gt;Thanks!&lt;/h2&gt;
    &lt;p&gt;Thanks for placing order #{{ id }}&lt;/p&gt;
    &lt;p&gt;We'll ship your goods as soon as possible.&lt;/p&gt;
    &lt;a class="btn btn-primary" href="/"&gt;Return to Store&lt;/a&gt;
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.577.1">This template displays a simple confirmation message once an order has been placed, which includes the order ID value. </span><span class="kobospan" id="kobo.577.2">The remaining templates relate to the form used to collect the customer and address data and present validation feedback. </span><span class="kobospan" id="kobo.577.3">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.578.1">validation_messages.handlebars</span></code><span class="kobospan" id="kobo.579.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.580.1">templates</span></code><span class="kobospan" id="kobo.581.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.582.1">Listing 18.26</span></em><span class="kobospan" id="kobo.583.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.584.1">Listing 18.26: The contents of the validation_messages.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.585.1">{{#each this }}
    &lt;div class="text-danger"&gt;{{ this }}&lt;/div&gt;
{{/each }}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.586.1">The</span><a id="_idIndexMarker997" class="calibre3"/><span class="kobospan" id="kobo.587.1"> template will receive an array of strings that are displayed using the </span><code class="inlinecode"><span class="kobospan" id="kobo.588.1">each</span></code><span class="kobospan" id="kobo.589.1"> expression, referring to the current string value with </span><code class="inlinecode"><span class="kobospan" id="kobo.590.1">this</span></code><span class="kobospan" id="kobo.591.1">. </span><span class="kobospan" id="kobo.591.2">To create the form elements for the user’s name and email address, which are required for the </span><code class="inlinecode"><span class="kobospan" id="kobo.592.1">Customer</span></code><span class="kobospan" id="kobo.593.1"> data, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.594.1">order_details_customer.handlebars</span></code><span class="kobospan" id="kobo.595.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.596.1">templates</span></code><span class="kobospan" id="kobo.597.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.598.1">Listing 18.27</span></em><span class="kobospan" id="kobo.599.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.600.1">Listing 18.27: The contents of the order_details_customer.handlebars in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.601.1">&lt;div class="m-2"&gt;
    &lt;h3&gt;Your details:&lt;/h3&gt;
    &lt;div class="form-group"&gt;
        &lt;label&gt;Name:&lt;/label&gt;
        {{#with (get order.customer.name) }}
            &lt;input name="customer[name]" class="form-control"
                value="{{ value }}"&gt;
            {{#if invalid}}
                {{&gt; validation_messages messages }}
            {{/if }}
        {{/with }}
    &lt;/div&gt;
        &lt;div class="form-group"&gt;
        &lt;label&gt;Email:&lt;/label&gt;
        {{#with (get order.customer.email)}}
            &lt;input name="customer[email]" class="form-control"
                value="{{ value }}"&gt;
            {{#if invalid }}
                {{&gt; validation_messages messages }}
            {{/if }}
        {{/with}}
    &lt;/div&gt;
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.602.1">The template duplicates the same set of elements for each value and relies on a combination of template engine features and helpers that require explanation.</span></p>
<p class="normal"><span class="kobospan" id="kobo.603.1">The built-in </span><code class="inlinecode"><span class="kobospan" id="kobo.604.1">with</span></code><span class="kobospan" id="kobo.605.1"> helper is used to change the context, which can simplify nested expressions, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.606.1">...
</span><span class="kobospan" id="kobo.606.2">{{#with </span><strong class="screentext"><span class="kobospan" id="kobo.607.1">order.customer.name</span></strong><span class="kobospan" id="kobo.608.1"> }}
    &lt;input name="customer[name]" class="form-control" value="{{ </span><strong class="screentext"><span class="kobospan" id="kobo.609.1">value</span></strong><span class="kobospan" id="kobo.610.1"> }}"&gt;
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.611.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.612.1">with</span></code><span class="kobospan" id="kobo.613.1"> helper is</span><a id="_idIndexMarker998" class="calibre3"/><span class="kobospan" id="kobo.614.1"> used to change the context to the </span><code class="inlinecode"><span class="kobospan" id="kobo.615.1">order.customer.name</span></code><span class="kobospan" id="kobo.616.1"> value, so that the </span><code class="inlinecode"><span class="kobospan" id="kobo.617.1">value</span></code><span class="kobospan" id="kobo.618.1"> expression is evaluated as </span><code class="inlinecode"><span class="kobospan" id="kobo.619.1">order.customer.name.value</span></code><span class="kobospan" id="kobo.620.1">. </span><span class="kobospan" id="kobo.620.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.621.1">with</span></code><span class="kobospan" id="kobo.622.1"> helper won’t render content if its expression is undefined, which presents a problem the first time that the template is rendered because the user’s session doesn’t contain this value until after the first time the form is evaluated. </span><span class="kobospan" id="kobo.622.2">To solve this, the </span><code class="inlinecode"><span class="kobospan" id="kobo.623.1">get</span></code><span class="kobospan" id="kobo.624.1"> helper defined in </span><em class="italic"><span class="kobospan" id="kobo.625.1">Listing 18.23</span></em><span class="kobospan" id="kobo.626.1"> is used, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.627.1">...
</span><span class="kobospan" id="kobo.627.2">{{#with (</span><strong class="screentext"><span class="kobospan" id="kobo.628.1">get order.customer.name</span></strong><span class="kobospan" id="kobo.629.1">) }}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.630.1">The parentheses denote a subexpression, which the template engine evaluates to obtain the argument for the </span><code class="inlinecode"><span class="kobospan" id="kobo.631.1">with</span></code><span class="kobospan" id="kobo.632.1"> helper. </span><span class="kobospan" id="kobo.632.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.633.1">get</span></code><span class="kobospan" id="kobo.634.1"> helper returns an empty object if a value is not defined, which ensures the content contained by the </span><code class="inlinecode"><span class="kobospan" id="kobo.635.1">with</span></code><span class="kobospan" id="kobo.636.1"> helper is always rendered.</span></p>
<p class="normal"><span class="kobospan" id="kobo.637.1">To create the form elements for the user’s address, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.638.1">order_details_address.handlebars</span></code><span class="kobospan" id="kobo.639.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.640.1">templates</span></code><span class="kobospan" id="kobo.641.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.642.1">Listing 18.28</span></em><span class="kobospan" id="kobo.643.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.644.1">Listing 18.28: The contents of order_details_address.handlebars in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.645.1">&lt;div class="m-2"&gt;
    &lt;h3&gt;Ship to:&lt;/h3&gt;       
    {{#each (toArray "Street" "City" "State" "Zip") }}
        {{#with (getValue ../order.address this) }}
            &lt;div class="form-group"&gt;
                &lt;label&gt;{{ ../this }}:&lt;/label&gt;
                &lt;input name="address[{{lower ../this}}]" class="form-control"
                    value="{{value}}"&gt;
            &lt;/div&gt;
            {{#unless valid}}
                {{&gt; validation_messages messages }}
            {{/unless}}
        {{/with}}
    {{/each}}
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.646.1">Unlike the </span><a id="_idIndexMarker999" class="calibre3"/><span class="kobospan" id="kobo.647.1">previous template, which repeated the same content for each data property, this template generates elements programmatically, using the values in an array:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.648.1">...
</span><span class="kobospan" id="kobo.648.2">{{#each (toArray "Street" "City" "State" "Zip") }}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.649.1">The built-in </span><code class="inlinecode"><span class="kobospan" id="kobo.650.1">each</span></code><span class="kobospan" id="kobo.651.1"> helper repeats sections of content but doesn’t have support for literal arrays. </span><span class="kobospan" id="kobo.651.2">This shortcoming is addressed by the </span><code class="inlinecode"><span class="kobospan" id="kobo.652.1">toArray</span></code><span class="kobospan" id="kobo.653.1"> helper, which accepts a series of arguments and combines them into an array that can be processed by the </span><code class="inlinecode"><span class="kobospan" id="kobo.654.1">each</span></code><span class="kobospan" id="kobo.655.1"> helper.</span></p>
<p class="normal"><span class="kobospan" id="kobo.656.1">The built-in </span><code class="inlinecode"><span class="kobospan" id="kobo.657.1">with</span></code><span class="kobospan" id="kobo.658.1"> helper is used to change the context to the data values required for each of the form fields. </span><span class="kobospan" id="kobo.658.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.659.1">getValue</span></code><span class="kobospan" id="kobo.660.1"> helper is used to produce the value for the </span><code class="inlinecode"><span class="kobospan" id="kobo.661.1">with</span></code><span class="kobospan" id="kobo.662.1"> helper, which is done by looking up a property on a source object. </span><span class="kobospan" id="kobo.662.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.663.1">with</span></code><span class="kobospan" id="kobo.664.1"> helper changes the context, but it is still possible to get values from the original data by using a navigation expression, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.665.1">...
</span><span class="kobospan" id="kobo.665.2">&lt;input name="address[{{lower ..</span><strong class="screentext"><span class="kobospan" id="kobo.666.1">/this</span></strong><span class="kobospan" id="kobo.667.1">}}]" class="form-control" value="{{value}}"&gt;
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.668.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.669.1">lower</span></code><span class="kobospan" id="kobo.670.1"> helper is used to set the name of the </span><code class="inlinecode"><span class="kobospan" id="kobo.671.1">input</span></code><span class="kobospan" id="kobo.672.1"> element, which is structured using square brackets so that related values are grouped when read by the server from the HTTP request. </span><span class="kobospan" id="kobo.672.2">The overall effect is to create elements whose names are </span><code class="inlinecode"><span class="kobospan" id="kobo.673.1">address[street]</span></code><span class="kobospan" id="kobo.674.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.675.1">address[city]</span></code><span class="kobospan" id="kobo.676.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.677.1">address[state]</span></code><span class="kobospan" id="kobo.678.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.679.1">address[zip]</span></code><span class="kobospan" id="kobo.680.1">, which will be passed into a JavaScript object named </span><code class="inlinecode"><span class="kobospan" id="kobo.681.1">address</span></code><span class="kobospan" id="kobo.682.1"> with </span><code class="inlinecode"><span class="kobospan" id="kobo.683.1">street</span></code><span class="kobospan" id="kobo.684.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.685.1">city</span></code><span class="kobospan" id="kobo.686.1">, </span><code class="inlinecode"><span class="kobospan" id="kobo.687.1">state</span></code><span class="kobospan" id="kobo.688.1">, and </span><code class="inlinecode"><span class="kobospan" id="kobo.689.1">zip</span></code><span class="kobospan" id="kobo.690.1"> properties.</span></p>
<p class="normal"><span class="kobospan" id="kobo.691.1">To combine</span><a id="_idIndexMarker1000" class="calibre3"/><span class="kobospan" id="kobo.692.1"> the customer and address templates, create a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.693.1">order_details.handlebars</span></code><span class="kobospan" id="kobo.694.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.695.1">templates</span></code><span class="kobospan" id="kobo.696.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.697.1">Listing 18.29</span></em><span class="kobospan" id="kobo.698.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.699.1">Listing 18.29: The contents of the order_details.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.700.1">&lt;form method="post" action="/checkout"&gt;
    {{&gt; order_details_customer }}
    {{&gt; order_details_address }}
   
    &lt;div class="m-2"&gt;
        &lt;button type="submit" class="btn btn-primary"&gt;Place Order&lt;/button&gt;
        &lt;a href="/cart" class="btn btn-primary"&gt;Back&lt;/a&gt;
    &lt;/div&gt;
&lt;/form&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.701.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.702.1">form</span></code><span class="kobospan" id="kobo.703.1"> element sends a </span><code class="inlinecode"><span class="kobospan" id="kobo.704.1">POST</span></code><span class="kobospan" id="kobo.705.1"> request to the </span><code class="inlinecode"><span class="kobospan" id="kobo.706.1">/checkout</span></code><span class="kobospan" id="kobo.707.1"> URL when the user clicks the </span><strong class="screentext"><span class="kobospan" id="kobo.708.1">Place Order</span></strong><span class="kobospan" id="kobo.709.1"> button. </span><span class="kobospan" id="kobo.709.2">There is also a link styled to appear as a button that directs the user back to the shopping cart.</span></p>
<p class="normal"><span class="kobospan" id="kobo.710.1">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.711.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.712.1">, add an item to the cart, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.713.1">Checkout</span></strong><span class="kobospan" id="kobo.714.1"> button, which will lead the application to present the order details form. </span><span class="kobospan" id="kobo.714.2">Click the </span><strong class="screentext"><span class="kobospan" id="kobo.715.1">Place Order</span></strong><span class="kobospan" id="kobo.716.1"> button to see the validation errors. </span><span class="kobospan" id="kobo.716.2">To complete the order, fill out the form and click the </span><strong class="screentext"><span class="kobospan" id="kobo.717.1">Place Order</span></strong><span class="kobospan" id="kobo.718.1"> button. </span><span class="kobospan" id="kobo.718.2">The sequence is shown in </span><em class="italic"><span class="kobospan" id="kobo.719.1">Figure 18.2</span></em><span class="kobospan" id="kobo.720.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.721.1"><img alt="" src="../Images/B21959_18_02.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.722.1">Figure 18.2: Creating an order</span></p>
<h1 class="heading" id="_idParaDest-324"><span class="kobospan" id="kobo.723.1">Fixing the return URL</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.724.1">In the catalog, the</span><a id="_idIndexMarker1001" class="calibre3"/><span class="kobospan" id="kobo.725.1"> user’s preferences for category, page, and page size are preserved using a query string, but these are lost when checking out when data is preserved in the session instead. </span><span class="kobospan" id="kobo.725.2">I don’t care too much about preserving the category and page, because they are temporary choices, but I would like to preserve the page size so that it is used when the user completes an order or cancels the order process.</span></p>
<p class="normal"><span class="kobospan" id="kobo.726.1">I could store all of the user’s choices in a session or use the query string throughout the order process, but I want to preserve these separate approaches because they demonstrate different ways of solving similar problems. </span><span class="kobospan" id="kobo.726.2">With this in mind, I am going to store the user’s preferred page size in the session at the start of the </span><a id="_idIndexMarker1002" class="calibre3"/><span class="kobospan" id="kobo.727.1">order process and use the value when generating the URLs that will return the user to the catalog.</span></p>
<p class="normal"><span class="kobospan" id="kobo.728.1">The first step is to store the page size as session data when the user transitions from the cart to the ordering process, as shown in </span><em class="italic"><span class="kobospan" id="kobo.729.1">Listing 18.30</span></em><span class="kobospan" id="kobo.730.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.731.1">Listing 18.30: Storing page size in the orders.ts file in the src/routes folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.732.1">import { Express } from "express";
import { Address } from "../data/order_models";
import { AddressValidator, CustomerValidator, ValidationResults, getData, isValid }
    from "../data/validation";
import { Customer } from "../data/customer_models";
import { createAndStoreOrder } from "./order_helpers";
declare module "express-session" {
    interface SessionData {
       orderData?: {
            customer?: ValidationResults&lt;Customer&gt;,
            address?: ValidationResults&lt;Address&gt;
       },
      </span><strong class="screentext"><span class="kobospan" id="kobo.733.1"> pageSize?: string;</span></strong><span class="kobospan" id="kobo.734.1">
    }
}
export const createOrderRoutes = (app: Express) =&gt; {
    app.get("/checkout", (req, resp) =&gt; {
        </span><strong class="screentext"><span class="kobospan" id="kobo.735.1">req.session.pageSize</span></strong><strong class="screentext"><span class="kobospan" id="kobo.736.1"> =</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.737.1">            req.session.pageSize ?? </span><span class="kobospan" id="kobo.737.2">req.query.pageSize?.toString() ?? </span><span class="kobospan" id="kobo.737.3">"3";</span></strong><span class="kobospan" id="kobo.738.1">
        resp.render("order_details", {
            order: req.session.orderData,
            </span><strong class="screentext"><span class="kobospan" id="kobo.739.1">page: 1,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.740.1">            pageSize: req.session.pageSize</span></strong><span class="kobospan" id="kobo.741.1">
        });
    });
    app.post("/checkout", async (req, resp) =&gt; {
        const { customer, address } = req.body;
        const data = req.session.orderData = {
            customer: await CustomerValidator.validate(customer),
            address: await AddressValidator.validate(address)
        };
        if (isValid(data.customer) &amp;&amp; isValid(data.address)
                &amp;&amp; req.session.cart) {
            const order = await createAndStoreOrder(
                getData(data.customer), getData(data.address),
                    req.session.cart
            )
            resp.redirect(`/checkout/${order.id}`);
            req.session.cart = undefined;
            req.session.orderData = undefined;
        } else {
            resp.redirect("/checkout");
        }
    });
    app.get("/checkout/:id", (req, resp) =&gt; {
        resp.render("order_complete", {
            id: req.params.id,
            </span><strong class="screentext"><span class="kobospan" id="kobo.742.1">pageSize</span></strong><strong class="screentext"><span class="kobospan" id="kobo.743.1">: req.session.pageSize ?? </span><span class="kobospan" id="kobo.743.2">3</span></strong><span class="kobospan" id="kobo.744.1">
        });
    })
}
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.745.1">Listing 18.31</span></em><span class="kobospan" id="kobo.746.1"> adds the </span><a id="_idIndexMarker1003" class="calibre3"/><span class="kobospan" id="kobo.747.1">return URL to the target of the anchor element that the user clicks to leave the cart summary.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.748.1">Listing 18.31: Adding the URL to the cart.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.749.1">&lt;h2&gt;Your cart&lt;/h2&gt;
&lt;table class="table table-bordered table-striped"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th class="text-end"&gt;Quantity&lt;/th&gt;&lt;th&gt;Item&lt;/th&gt;
            &lt;th class="text-end"&gt;Price&lt;/th&gt;&lt;th class="text-end"&gt;Subtotal&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        {{#unless cart.lines}}
            &lt;tr&gt;&lt;td colspan="5" class="text-center"&gt;Cart is empty&lt;/td&gt;&lt;/tr&gt;
        {{/unless}}
        {{#each cart.lines}}
            {{&gt; cart_line returnUrl=../returnUrl }}       
        {{/each }}
    &lt;/tbody&gt;
    &lt;tfoot&gt;
        &lt;tr&gt;
            &lt;td colspan="3" class="text-end"&gt;Total:&lt;/td&gt;
            &lt;td class="text-end"&gt;{{ currency cart.total }}&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/tfoot&gt;
&lt;/table&gt;
&lt;div class="text-center"&gt;
    &lt;a class="btn btn-primary" href="{{ returnUrl }}"&gt;Continue Shopping&lt;/a&gt;
    {{#if cart.lines}}
        </span><strong class="screentext"><span class="kobospan" id="kobo.750.1">&lt;a class="btn btn-primary" href="/checkout{{returnUrl}}"&gt;Checkout&lt;/a&gt;</span></strong><span class="kobospan" id="kobo.751.1">
    {{else}}
        &lt;button class="btn btn-primary" disabled&gt;Checkout&lt;/button&gt;
    {{/if}}
&lt;/div&gt;
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.752.1">Listing 18.32</span></em><span class="kobospan" id="kobo.753.1"> adds the</span><a id="_idIndexMarker1004" class="calibre3"/><span class="kobospan" id="kobo.754.1"> return URL to the </span><strong class="screentext"><span class="kobospan" id="kobo.755.1">Back</span></strong><span class="kobospan" id="kobo.756.1"> button on the </span><strong class="screentext"><span class="kobospan" id="kobo.757.1">Order Details</span></strong><span class="kobospan" id="kobo.758.1"> page.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.759.1">Listing 18.32: Adding the URL in the order_details.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.760.1">&lt;form method="post" action="/checkout"&gt;
    {{&gt; order_details_customer }}
    {{&gt; order_details_address }}
   
    &lt;div class="m-2"&gt;
        &lt;button type="submit" class="btn btn-primary"&gt;Place Order&lt;/button&gt;
        </span><strong class="screentext"><span class="kobospan" id="kobo.761.1">&lt;a </span></strong><strong class="screentext"><span class="kobospan" id="kobo.762.1">href="/cart?returnUrl={{ escapeUrl (navigationUrl )}}"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.763.1">            class="btn btn-primary"&gt;Back&lt;/a&gt;</span></strong><span class="kobospan" id="kobo.764.1">
    &lt;/div&gt;
&lt;/form&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.765.1">The </span><a id="_idIndexMarker1005" class="calibre3"/><span class="kobospan" id="kobo.766.1">final step is to add the URL to the button the user clicks to return to the catalog once an order has been placed, as shown in </span><em class="italic"><span class="kobospan" id="kobo.767.1">Listing 18.33</span></em><span class="kobospan" id="kobo.768.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.769.1">Listing 18.33: Adding the URL to the order_complete.handlebars file in the templates folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.770.1">&lt;div class="text-center m-2"&gt;
    &lt;h2&gt;Thanks!&lt;/h2&gt;
    &lt;p&gt;Thanks for placing order #{{ id }}&lt;/p&gt;
    &lt;p&gt;We'll ship your goods as soon as possible.&lt;/p&gt;
   </span><strong class="screentext"><span class="kobospan" id="kobo.771.1"> &lt;a class="btn btn-primary"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.772.1"> href="/?page=1&amp;pageSize={{pageSize}}"&gt;</span></strong><span class="kobospan" id="kobo.773.1">
        Return to Store
    &lt;/a&gt;
&lt;/div&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.774.1">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.775.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.776.1"> and change the page size to </span><strong class="screentext"><span class="kobospan" id="kobo.777.1">6 </span></strong><span class="kobospan" id="kobo.778.1">items. </span><span class="kobospan" id="kobo.778.2">Add items to the cart and complete the order. </span><span class="kobospan" id="kobo.778.3">Click the </span><strong class="screentext"><span class="kobospan" id="kobo.779.1">Return</span></strong> <strong class="screentext"><span class="kobospan" id="kobo.780.1">to Store</span></strong><span class="kobospan" id="kobo.781.1"> button displayed with the order summary and the page size will be preserved when the catalog is displayed, as shown in </span><em class="italic"><span class="kobospan" id="kobo.782.1">Figure 18.3</span></em><span class="kobospan" id="kobo.783.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.784.1"><img alt="" src="../Images/B21959_18_03.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.785.1">Figure 18.3: Fixing the return URL</span></p>
<h1 class="heading" id="_idParaDest-325"><span class="kobospan" id="kobo.786.1">Summary</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.787.1">In this chapter, I continued developing the SportsStore application by adding support for placing orders.</span></p>
<ul class="calibre4">
<li class="bulletlist"><span class="kobospan" id="kobo.788.1">The data model for orders is presented through a separate repository interface but is implemented using the </span><code class="inlinecode"><span class="kobospan" id="kobo.789.1">ORM mixin</span></code><span class="kobospan" id="kobo.790.1"> class.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.791.1">The order data is stored in the same database as the catalog, which simplifies data consistency and makes it easier to use transactions for updates.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.792.1">The data provided by the user is validated before it is stored.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.793.1">The validation system relies on TypeScript to ensure that rules are defined for all data model properties.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.794.1">The session feature is used to store the user’s pagination preferences during the checkout process.</span></li>
</ul>
<p class="normal"><span class="kobospan" id="kobo.795.1">In the next chapter, I will add support for letting users identify themselves using their Google accounts, which is done using the </span><code class="inlinecode"><span class="kobospan" id="kobo.796.1">OAuth</span></code><span class="kobospan" id="kobo.797.1"> protocol.</span></p>
</div>
</body></html>