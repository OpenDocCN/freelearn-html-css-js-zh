<html><head></head><body><div class="chapter" title="Chapter&#xA0;11.&#xA0;Quick Tricks and Advanced Knowledge" id="aid-2C9D01"><div class="titlepage"><div><div><h1 class="title"><a id="ch11"/>Chapter 11. Quick Tricks and Advanced Knowledge</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The language properties hook</li><li class="listitem">Setting up the portal session time and session policy</li><li class="listitem">Configuring Liferay with the SMTP server</li><li class="listitem">Intranet protection by the antisamy-hook plugin</li><li class="listitem">Migrating content from one database to another database</li><li class="listitem">Using the Liferay Service Bus for communication between portlets</li><li class="listitem">Clustering Liferay Portal</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec74"/>Introduction</h1></div></div></div><p>This chapter covers various topics that are not connected to each other. Recipes cover some standard scenarios that a Liferay administrator will face and provide solutions. It will help you perform those specific tasks for your intranet sites. Almost everyone should know how to configure SMTP in order to send e-mails and receive notifications. The next important aspect is security. Administrators and developers should know how to install the antisamy-hook plugin or how to set session time and session policy. This is extremely important regardless of what type of portal Liferay will be used for. Also, this chapter will introduce important knowledge about advanced tricks in Liferay. It will describe the Liferay Service Bus and show how a user can use it. Furthermore, it will provide a detailed description of how clustering works in Liferay and how to migrate content from one database to another.</p></div></div>
<div class="section" title="The language properties hook"><div class="titlepage" id="aid-2D7TI2"><div><div><h1 class="title"><a id="ch11lvl1sec75"/>The language properties hook</h1></div></div></div><p>Liferay has a multilanguage architecture and enables users to add content with many translations. Moreover, it gives users out-of-the-box functionality to change languages. Apart <a id="id603" class="indexterm"/>from this, the content portal also contains many labels that also have their own translation. It means that the Liferay design has a functionality in which it is possible to translate labels or fields. If we look into the sources (<code class="literal">portal-impl/src/content</code>), there are a lot of files with the following names: <code class="literal">Language_en.properties</code>, <code class="literal">Language_de.properties</code>, <code class="literal">Language_pl.properties</code>, and so on. The ISO 639-1 standard defines a set of possible codes for every language, such as <span class="strong"><strong>en</strong></span> for English, <span class="strong"><strong>de</strong></span> for German, and so on. The Liferay Portal supports up to 47 languages, which are defined in the <code class="literal">portal-impl/src/portal.properties</code> file <a id="id604" class="indexterm"/>called <span class="strong"><strong>locales</strong></span>. Default translations do not always meet our expectations. Thus, in this recipe, we will show you how to change the existing labels using the hook plugin.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec199"/>How to do it…</h2></div></div></div><p>One of the<a id="id605" class="indexterm"/> functionalities of the hook plugin is to override messages in existing translations. Our goal is to change the <span class="strong"><strong>Sign in</strong></span> label to <span class="strong"><strong>Intranet login</strong></span>. The first step is generating a new hook called <code class="literal">language-hook</code>. To achieve it, use the Liferay Plugins SDK (<code class="literal">${SDK_HOME}/hook/create.sh language "Language hook"</code>) or Maven archetype generator (<code class="literal">mvn archetype:generate -Dfilter=liferay-hook</code>). If you encounter a problem with generating the language hook, go back and study the <span class="emphasis"><em>Creating a custom portlet</em></span> recipe from <a class="link" title="Chapter 1. Installation and Basic Configuration" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <span class="emphasis"><em>Installation and Basic Configuration</em></span>. We assume that the user generates this plugin as a Maven project. Next, import the project to your favorite IDE, such as Eclipse, IntelliJ IDEA, or NetBeans, and follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">src/main/webapp/WEB-INF/liferay-hook.xml</code> file.</li><li class="listitem">Define a new language property file:<div class="informalexample"><pre class="programlisting">&lt;language-properties&gt;
  i18n/Language_en.properties
&lt;/language-properties&gt;</pre></div></li><li class="listitem">Create the <code class="literal">i18n</code> folder in <code class="literal">src/main/resources</code> and create the <code class="literal">Language_en.properties</code> file.</li><li class="listitem">In <code class="literal">Language_en.properties</code>, add the following line:<div class="informalexample"><pre class="programlisting">sign-in=Intranet login</pre></div></li><li class="listitem">Compile the plugin and deploy it by invoking the <code class="literal">mvn clean install liferay:deploy</code> command.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec200"/>How it works…</h2></div></div></div><p>As we said at the beginning, Liferay supports many languages and translations. Every translation is kept in the <code class="literal">Language.properties</code> file with a specific suffix, such as <code class="literal">_pl</code>, <code class="literal">_en</code>, <code class="literal">_de</code>, and so <a id="id606" class="indexterm"/>on. All the available locales are defined in the portal properties as follows:</p><div class="informalexample"><pre class="programlisting">locales=ar_SA,eu_ES,bg_BG,ca_AD,ca_ES,zh_CN,zh_TW,hr_HR,cs_CZ,da_DK,nl_NL,nl_BE,en_US,en_GB,en_AU,et_EE,fi_FI,fr_FR,fr_CA,gl_ES,de_DE,el_GR,iw_IL,hi_IN,hu_HU,in_ID,it_IT,ja_JP,ko_KR,lo_LA,lt_LT,nb_NO,fa_IR,pl_PL,pt_BR,pt_PT,ro_RO,ru_RU,sr_RS,sr_RS_latin,sl_SI,sk_SK,es_ES,sv_SE,tr_TR,uk_UA,vi_VN

locales.beta=ar_SA,eu_ES,bg_BG,ca_AD,zh_TW,hr_HR,cs_CZ,da_DK,nl_NL,nl_BE,en_GB,en_AU,et_EE,gl_ES,el_GR,hi_IN,in_ID,it_IT,ko_KR,lo_LA,lt_LT,nb_NO,fa_IR,pl_PL,pt_PT,ro_RO,ru_RU,sr_RS,sr_RS_latin,sl_SI,sk_SK,sv_SE,tr_TR,uk_UA,vi_VN

locales.enabled=ca_ES,zh_CN,en_US,fi_FI,fr_FR,de_DE,iw_IL,hu_HU,ja_JP,pt_BR,es_ES</pre></div><p>The first property specifies all the available locales in the Liferay Portal. The second one lists languages that are in beta. A set of beta properties means that the translation is not finished, and Liferay can contain some errors or mistakes.</p><div class="note" title="Note"><h3 class="title"><a id="note37"/>Note</h3><p>It is possible to join the community that works with translations and participate with them. All<a id="id607" class="indexterm"/> the necessary information is available at <a class="ulink" href="http://translate.liferay.com">http://translate.liferay.com</a>.</p></div><p>The last property lists languages that Liferay supports by default. It is necessary to change it if we create a new project and fit it to our requirements. It can be changed later. This operation is available in the Control Panel section.</p><p>In this recipe, we showed you how to override the existing property. Overriding works for every single property defined in <code class="literal">portal-impl/src/content/Language.properties</code>. Additionally, in our <code class="literal">i18n/Language_en.properties</code>, it is possible to add a new property that can be used in our new functionalities.</p><p>In the Liferay language properties, there is a <code class="literal">portal-impl/src/content/Language.properties </code>file (without a language suffix). This set of properties is used when the system cannot find a property for the specific country/language.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec201"/>There's more…</h2></div></div></div><p>Apart from customizing language properties, Liferay lets you choose how your internationalization works. To understand this feature, you should know how to change the Liferay language first. By default, Liferay provides a unique URL for a specific language. The<a id="id608" class="indexterm"/> following are some of the examples:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">http://localhost:8080/pl/web/guest/home</code></li><li class="listitem"><code class="literal">http://localhost:8080/en_US/web/guest/home</code></li></ul></div><p>This context (<code class="literal">/pl</code>, <code class="literal">/en_US</code>) is handled by <code class="literal">I18nServlet</code>, which is defined in the <code class="literal">web.xml</code> file. This servlet changes the language and renders a page with dedicated translation.</p><p>In detail, there is a property called <code class="literal">locale.prepend.friendly.url.style</code> located in <code class="literal">portal-impl/src/portal.properties</code>. It has four possible values that are defined in the following table:</p><div class="informaltable"><table border="1"><colgroup><col/><col/></colgroup><thead><tr><th valign="bottom">
<p>Value</p>
</th><th valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td valign="top">
<p>
<code class="literal">0</code>
</p>
</td><td valign="top">
<p>The locale is not automatically prepended to a URL. This means that each URL could potentially <a id="id609" class="indexterm"/>point to many different languages. For example, if a user sets the German language in their account settings, the Portal displays sites in English by default.</p>
<p>If this property is set as 0, page <code class="literal">http://localhost:8080/web/guest</code> is displayed in English. However, when users log in, it is automatically translated to German. URI has the same value, <code class="literal">/web/guest</code>, without language context.</p>
</td></tr><tr><td valign="top">
<p>
<code class="literal">1</code>
</p>
</td><td valign="top">
<p>The locale is automatically prepended to a URL when the requested locale is not the default locale. This means that each URL points to just one language. Let's analyze the situation from the first example where a user sets a language different from the default one. The first visit to the <code class="literal">http://localhost:8080</code> portal displays content in the default language (English). After the login action, the user is redirected to the <code class="literal">http://localhost:8080/de</code> URL. On every page, there is the <code class="literal">/de/web/guest/{PAGE}</code> URI. After logout, the portal remembers the language and displays German translations.</p>
</td></tr><tr><td valign="top">
<p>
<code class="literal">2</code>
</p>
</td><td valign="top">
<p>The locale is automatically prepended to every URL. This means that each URL points to just one language.</p>
</td></tr><tr><td valign="top">
<p>
<code class="literal">3</code>
</p>
</td><td valign="top">
<p>The locale is automatically prepended to a URL when the requested locale is not the default user locale. In the case of guest users, the behavior is the same as having a value of 1. However, in the our case (the user has a different locale than the portal), there is the following situation:</p>
<p>By default, the portal displays content in English, and there is no language context. The URL looks like <code class="literal">http://localhost:8080/</code>.</p>
<p>When a user logs in, the language is German, but the URL is the same, <code class="literal">http://localhost:8080</code> (without language context).</p>
<p>After the<a id="id610" class="indexterm"/> logout action, the URL is the same, but the language is still German. To change the language, it is necessary to invoke the <code class="literal">http://localhost:8080/en</code> URL.</p>
</td></tr></tbody></table></div><p>The last thing connected with language settings, is the default language definition. It is<a id="id611" class="indexterm"/> placed in <code class="literal">portal-impl/src/system.properties</code> and can be overridden by <code class="literal">system-ext.properties</code>. To set the default language, override the following properties:</p><div class="informalexample"><pre class="programlisting">user.country=PL
user.language=pl</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec202"/>See also</h2></div></div></div><p>In order to learn about creating plugins (especially portlets), refer to the <span class="emphasis"><em>Creating a custom portlet</em></span> recipe in <a class="link" title="Chapter 1. Installation and Basic Configuration" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <span class="emphasis"><em>Installation and Basic Configuration</em></span>
</p></div></div>
<div class="section" title="Setting up the portal session time and session policy" id="aid-2E6E41"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec76"/>Setting up the portal session time and session policy</h1></div></div></div><p>In every project, especially the intranet one, the main functionality is authentication and authorization in<a id="id612" class="indexterm"/> order to provide correct permissions and serve dedicated content for an authenticated user. Every logged-in user has their own session; the expiry time <a id="id613" class="indexterm"/>can be set specifically. You can also set the session using any other settings, such as auto-extend session or redirection when a session expires. All the settings concerning the session can be found in <code class="literal">portal.properties</code>.</p><p>Let's assume that our goal is to configure the following session policy:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The session expires after 10 minutes</li><li class="listitem">The system redirects the user to the default page after session expiration (if all pages don't have guest permission to display for unauthenticated users, the system should display the login page)</li><li class="listitem">Two minutes before session ending, the system should display a warning with a counter</li><li class="listitem">The session identifier shouldn't be visible in the URL</li></ul></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec203"/>How to do it…</h2></div></div></div><p>As we said at the beginning, Liferay overrides session-specific properties via <code class="literal">portal-ext.properties</code>. To achieve our goal, open <code class="literal">portal-impl/src/portal-ext.properties</code> and set the following definitions:</p><div class="informalexample"><pre class="programlisting">session.timeout=10
session.timeout.redirect.on.expire=true
session.timeout.auto.extend=false
session.timeout.warning=2
session.enable.url.with.session.id=false</pre></div><p>Except for the <code class="literal">session.timeout</code> setting, it is required that you set the same value in <code class="literal">web.xml</code>. To complete this task, open the main <code class="literal">web.xml</code> file, which is located in the <code class="literal">{$TOMCAT_HOME}/webapps/ROOT/WEB-INF</code> folder. Find an XML tag called <code class="literal">session-config</code> and change it as follows:</p><div class="informalexample"><pre class="programlisting">&lt;session-config&gt;
  <span class="strong"><strong>&lt;session-timeout&gt;10&lt;/session-timeout&gt;</strong></span>
&lt;/session-config&gt;</pre></div><p>Finally, save this file and restart your application server.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec204"/>How it works…</h2></div></div></div><p>Our first goal<a id="id614" class="indexterm"/> was to change a default session timeout, which was 30 minutes. We decreased it to 10 minutes. It is important to know that changing<a id="id615" class="indexterm"/> the <code class="literal">session.timeout</code> property is not sufficient because the <code class="literal">web.xml</code> configuration overrides this setting. To finish our configuration, we also had to change this value into the <code class="literal">web.xml</code> descriptor.</p><p>Next, the assumption was connected with user redirection after timeout. In order to achieve our goal, we needed to change two properties:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">session.timeout.redirect.on.expire</code>: This is set to <code class="literal">true</code> and redirects the user to the default page when the session expires</li><li class="listitem"><code class="literal">session.timeout.auto.extend</code>: This is set to <code class="literal">false</code> to deny the autoextend session</li></ul></div><p>The <code class="literal">session.timeout.warning</code> property specifies the number of minutes before a warning, informing the user of the session expiration. We set this value to 2 minutes.</p><p>The last assumption was connected with security requirements. Of course, it is disabled by default, but we decided to show how it can be configured. Thus, the last property called <code class="literal">session.enable.url.with.session.id</code> was set to <code class="literal">false</code>.</p></div></div>
<div class="section" title="Configuring Liferay with the SMTP server" id="aid-2F4UM1"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec77"/>Configuring Liferay with the SMTP server</h1></div></div></div><p>Liferay sends<a id="id616" class="indexterm"/> e-mails in many cases, such as when<a id="id617" class="indexterm"/> adding calendar events and posts on the message board or when a user creates an account. In order to enable this function, it is required that you correctly configure the SMTP server and set the appropriate properties. In this recipe, we will explain how to configure the SMTP server in the easiest way.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec205"/>How to do it…</h2></div></div></div><p>There are three <a id="id618" class="indexterm"/>ways to configure the SMTP server<a id="id619" class="indexterm"/> correctly. The easiest way is to use Liferay's Control Panel and configure the SMTP settings using the GUI interface. To achieve it, go to <span class="strong"><strong>Admin</strong></span> | <span class="strong"><strong>Control Panel</strong></span> | <span class="strong"><strong>Server Administration</strong></span> and choose the <span class="strong"><strong>Mail</strong></span> tab. After that, enter your settings for your mail session under the <span class="strong"><strong>Outgoing SMTP Server</strong></span> section and click on the <span class="strong"><strong>Save</strong></span> button. This type of setting is a great choice when there is only one instance of the SMTP server or the SMTP is a third-party external server. In many cases this setting is insufficient. The best example is an application running in a clustered environment where each node (Liferay instance) has its own SMTP local server.</p><p>In many cases, for instance, in the clustered environment, it is a very common practice to install the SMTP server on the same node where the Liferay instance is. In this case, it is not possible to configure the SMTP server using the GUI interface, but this setting can be done in <code class="literal">portal-ext.properties</code>. In this file, we can put our settings that display the following listing:</p><div class="informalexample"><pre class="programlisting">mail.session.mail.pop3.host=localhost
mail.session.mail.pop3.password=
mail.session.mail.pop3.port=110
mail.session.mail.pop3.user=
mail.session.mail.smtp.auth=false
mail.session.mail.smtp.host=localhost
mail.session.mail.smtp.password=
mail.session.mail.smtp.port=25
mail.session.mail.smtp.user=
mail.session.mail.store.protocol=pop3
mail.session.mail.transport.protocol=smtp</pre></div><p>The last possibility is to use the application server's mail session via <span class="strong"><strong>Java Naming and Directory Interface</strong></span> (<span class="strong"><strong>JNDI</strong></span>), which looks up the Java mail session. In order to enable the JNDI name, put <a id="id620" class="indexterm"/>the following configuration in the <code class="literal">portal-ext.properties</code> file:</p><div class="informalexample"><pre class="programlisting">mail.session.jndi.name=mail/MailSession</pre></div><p>Make sure that, in your <code class="literal">{$TOMCAT_HOME}/conf/Catalina/localhost/ROOT.xml</code> file, there is defined a resource similar to the following tag:</p><div class="informalexample"><pre class="programlisting">&lt;Resource name="mail/MailSession" auth="Container" type="javax.mail.Session" mail.imap.host="localhost" mail.pop3.host="localhost" mail.smtp.host="localhost" mail.store.protocol="imap" mail.transport.protocol="smtp" /&gt;</pre></div><p>The Liferay Portal recommends SMTP configuration over the GUI or by setting the properties as a unified configuration of Java mail, which doesn't depend on the application server.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec206"/>How it works…</h2></div></div></div><p>Liferay has its<a id="id621" class="indexterm"/> own message bus implementation. It is a service-level API used to exchange messages within Liferay. In this specific<a id="id622" class="indexterm"/> case, an e-mail sending mechanism uses <span class="emphasis"><em>Liferay Message Bus</em></span>. As in every message bus implementation, there is a sender, that sends messages to the destination. This functionality is implemented in the <code class="literal">com.liferay.mail.service.impl.MailServiceImpl</code> class in the <code class="literal">sendEmail</code> method:</p><div class="informalexample"><pre class="programlisting">public void sendEmail(MailMessage mailMessage) {
  MessageBusUtil.sendMessage(DestinationNames.MAIL, mailMessage);
}</pre></div><p>As we see in the preceding method, the sending action has quite a simple implementation that invokes only the <code class="literal">com.liferay.portal.kernel.messaging.MessageBusUtil.sendMessage</code> method, which gives with the type of destination and mail message arguments. <code class="literal">MailMessageListener</code> is responsible for sending e-mails to the specific address correctly.</p><p>At the opposite site, there is a listener that can recognize the message and consume it. For instance, it sends an e-mail message. This is the <code class="literal">com.liferay.mail.messaging.MailMessageListener</code> class, which receives the event (in this case, the mail event) and invokes an appropriate action to send the e-mail.</p></div></div>
<div class="section" title="Intranet protection by the antisamy-hook plugin" id="aid-2G3F81"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec78"/>Intranet protection by the antisamy-hook plugin</h1></div></div></div><p>Liferay 6.x exposes a new functionality called sanitizers. This is an implementation that protects content (HTML and JavasScript) against malicious code that users may pass to the journal <a id="id623" class="indexterm"/>article, wiki, message<a id="id624" class="indexterm"/> board, and so on. This can happen if a user copies and pastes the content from any Internet resources. In the Liferay core implementation, there are no sanitizers. One of the reasons is that Liferay allows users to implement their own policy and install it as a hook plugin. Fortunately, Liferay has a<a id="id625" class="indexterm"/> plugin called <code class="literal">antisamy-hook</code> in the official GitHub repository at <a class="ulink" href="https://github.com/liferay/liferay-plugins/tree/master/hooks/antisamy-hook">https://github.com/liferay/liferay-plugins/tree/master/hooks/antisamy-hook</a>.</p><p>In this recipe, we will show you how to install this plugin and also give you an idea about how it works.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec207"/>How to do it…</h2></div></div></div><p>The antisamy-hook plugin, like other plugins, is available on the official Liferay marketplace. Therefore, the installation process is really simple and unified. In order to achieve your goal, log in as an administrator, go to <span class="strong"><strong>Admin</strong></span> | <span class="strong"><strong>Control Panel</strong></span> | <span class="strong"><strong>Store</strong></span>, find the <span class="strong"><strong>Antisamy CE</strong></span> plugin, and purchase it by clicking on the <span class="strong"><strong>Free</strong></span> button. This plugin is free if you <a id="id626" class="indexterm"/>have a valid marketplace<a id="id627" class="indexterm"/> account. After that, go to the <span class="strong"><strong>Purchased</strong></span> tab and click on the <span class="strong"><strong>Install</strong></span> button.</p><p>In the log file, you should find the following message:</p><div class="informalexample"><pre class="programlisting">INFO  [localhost-startStop-2][HookHotDeployListener:687] Registering hook for antisamy-hook
Loading file:/home/piotr/clients/packt/project/tomcat-7.0.42/temp/6-antisamy-hook/WEB-INF/classes/portal.properties
INFO  [localhost-startStop-2][HookHotDeployListener:814] Hook for antisamy-hook is available for use</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec208"/>How it works…</h2></div></div></div><p>The <code class="literal">antisamy-hook</code> plugin adds an <span class="emphasis"><em>OWASP AntiSamy</em></span> implementation, which means that the plugin includes the OWASP <code class="literal">antisamy.jar</code> library, which is located in the <code class="literal">org.owasp.validator.html.AntiSamy</code> package. The OWASP AntiSamy project is an API that protects the content against malicious code.</p><div class="note" title="Note"><h3 class="title"><a id="note38"/>Note</h3><p>More details <a id="id628" class="indexterm"/>are available on the official OWASP site at <a class="ulink" href="https://www.owasp.org/index.php/Category:OWASP_AntiSamy_Project">https://www.owasp.org/index.php/Category:OWASP_AntiSamy_Project</a>.</p></div><p>From a technical point of view, the <code class="literal">antisamy-hook</code> plugin is a very simple but powerful tool. It is simple, because it just overrides the <code class="literal">sanitizer.impl</code> property as follows:</p><div class="informalexample"><pre class="programlisting">sanitizer.impl=com.liferay.antisamy.hook.sanitizer.AntiSamySanitizerImpl </pre></div><p>It is powerful, because it uses an open source OWASP Antisamy project that filters our content.</p><p>The main implementation is in the <code class="literal">AntiSamySanitizerImpl</code> class (actually, there is only one class in this plugin) in the sanitize method:</p><div class="informalexample"><pre class="programlisting">public String sanitize([arguments])
  throws SanitizerException {

  if (Validator.isNull(contentType) ||
    !contentType.equals(ContentTypes.TEXT_HTML)) {
    return s;
  }
  try {
    AntiSamy antiSamy = new AntiSamy();
    CleanResults cleanResults = antiSamy.scan(s, _policy);
    return cleanResults.getCleanHTML();
  }
  catch (Exception e) {
    _log.error("Unable to sanitize input", e);
    throw new SanitizerException(e);
  }
}</pre></div><p>This <a id="id629" class="indexterm"/>implementation checks whether <code class="literal">contentType</code> is HTML and the <code class="literal">AntiSamy</code> implementation filters the content and returns <a id="id630" class="indexterm"/>the clean results. The OWASP library is responsible for correctly filtering content.</p></div></div>
<div class="section" title="Migrating content from one database to another database" id="aid-2H1VQ1"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec79"/>Migrating content from one database to another database</h1></div></div></div><p>The content migration tool is an interesting feature that Liferay provides as an out-of the-box core<a id="id631" class="indexterm"/> implementation. As<a id="id632" class="indexterm"/> you know, Liferay gives administrators a choice to select one of the database engines, such as MySQL, PostgreSQL, Oracle, and so on. It allows users to change the database engine without losing data.</p><p>Let's assume that our Liferay instance uses the PostgreSQL database, and we want to change it to MySQL engine.</p><div class="section" title="Getting ready…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec209"/>Getting ready…</h2></div></div></div><p>In order to migrate our content, we need to create a new MySQL database. To achieve it log in to your database:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mysql -u {USER} -p</strong></span>
</pre></div><p>Then, create a new database using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>CREATE DATABASE lportal</strong></span>
<span class="strong"><strong>DEFAULT CHARACTER SET utf8</strong></span>
<span class="strong"><strong>DEFAULT COLLATE utf8_general_ci;</strong></span>
</pre></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec210"/>How to do it…</h2></div></div></div><p>This functionality is available out-of-the-box. Moreover, it doesn't require developer support. All <a id="id633" class="indexterm"/>migration processes<a id="id634" class="indexterm"/> can be done with the help of the GUI. To migrate data, follows these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in as an administrator.</li><li class="listitem">Go to <span class="strong"><strong>Admin</strong></span> | <span class="strong"><strong>Control Panel</strong></span> | <span class="strong"><strong>Server Administration</strong></span> and choose the <span class="strong"><strong>Data Migration</strong></span> tab.</li><li class="listitem">Fill in the form as follows:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">In <span class="strong"><strong>JDBC Driver Class Name</strong></span>, enter <code class="literal">com.mysql.jdbc.Driver</code></li><li class="listitem">In <span class="strong"><strong>JDBC URL</strong></span>, enter <code class="literal">jdbc:mysql://localhost/lportal?useUnicode=true&amp;characterEncoding=UTF-8&amp;useFastDateParsing=false</code></li><li class="listitem">In <span class="strong"><strong>JDBC User Name</strong></span>, enter the database's user</li><li class="listitem">In <span class="strong"><strong>JDBC Password</strong></span>, enter the database user's password</li></ul></div><div class="mediaobject"><img src="../Images/image00376.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on<a id="id635" class="indexterm"/> the <span class="strong"><strong>Execute</strong></span> button. All <a id="id636" class="indexterm"/>information about operation details will be available on the logfile. The following message will progressively appear on the screen:<div class="mediaobject"><img src="../Images/image00377.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Make <a id="id637" class="indexterm"/>sure that the process<a id="id638" class="indexterm"/> is successfully finished. Inside the <code class="literal">catalina.out</code> logfile, you will find the following message:<div class="informalexample"><pre class="programlisting">Finished conversion for com.liferay.portal.convert.ConvertDatabase in 18652 ms.</pre></div></li><li class="listitem">Next, shut down your application server, change the database properties to indicate a new database, and start an application server with a new configuration.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec211"/>How it works…</h2></div></div></div><p>The database migration process is supported by Liferay in order to retain compatibility with databases. This process uses Liferay Message Bus, which exposes listener to data migration. In this case, an event prepares and invokes the <code class="literal">com.liferay.portlet.admin.action.EditServerAction</code> class. The following listing shows how it was implemented:</p><div class="informalexample"><pre class="programlisting">protected String convertProcess([Arguments]) throws Exception {
  [..]
  MaintenanceUtil.maintain(portletSession.getId(), className);
  MessageBusUtil.sendMessage(DestinationNames.CONVERT_PROCESS, className);
}</pre></div><p>This method is responsible for preparing specific data, showing a maintenance window, and sending an event to the message bus.</p><p>Listener is represented by <code class="literal">com.liferay.portal.convert.ConvertDatabase</code> with the <code class="literal">doConvert()</code> method. This method is responsible for preparing all database data and putting it into the new database. All details in this method are complex, but the main idea is to take every table, its data, and indexes and migrate them to the new database schema.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec212"/>See also</h2></div></div></div><p>If you <a id="id639" class="indexterm"/>want to migrate a storage<a id="id640" class="indexterm"/> data, refer to:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="emphasis"><em>Integration with the Amazon S3 cloud</em></span> recipe from <a class="link" title="Chapter 6. Documents and Media in Liferay" href="part0050.xhtml#aid-1FLS41">Chapter 6</a>, <span class="emphasis"><em>Documents and Media in Liferay</em></span></li><li class="listitem">The <span class="emphasis"><em>Data migration between storage hooks</em></span> recipe from <a class="link" title="Chapter 6. Documents and Media in Liferay" href="part0050.xhtml#aid-1FLS41">Chapter 6</a>, <span class="emphasis"><em>Documents and Media in Liferay</em></span></li></ul></div></div></div>
<div class="section" title="Using Liferay Service Bus for communication between portlets"><div class="titlepage" id="aid-2I0GC2"><div><div><h1 class="title"><a id="ch11lvl1sec80"/>Using Liferay Service Bus for communication between portlets</h1></div></div></div><p>The message bus is a mechanism for sending messages to different components in Liferay. This approach is very common, because it prevents class-loading issues. It is very important, because Liferay is a portlet container, and each portlet doesn't have information about the others. For that reason, Liferay provides a message bus that allows <a id="id641" class="indexterm"/>communication between portlets. An application that sends an event/message is called a producer, and an application that receives messages is called a consumer.</p><p>The <a id="id642" class="indexterm"/>message bus architecture supports asynchronous and synchronous messaging. Synchronous messages wait for a response, and asynchronous messages send a message, forget it, or receive a callback. The main difference between synchronous and asynchronous messages is the fact that the first one block threads and wait for the response.</p><p>In this recipe, we will show you how to use a message bus in a real example. Let's assume that our goal is to write a search portlet with one input with the autocomplete feature. This will be a simple form with only one input that can autocomplete our query. After submitting the form, the search criteria should be sent to the existing out-of-the-box search portlet. The Liferay message bus will be used to communicate with the Lucene indexer.</p><p>It is not possible to show and explain all the implementations, so we will explain a piece of code with the message bus. In the following <span class="emphasis"><em>How to do it…</em></span> section, we will show you the steps to compile, deploy, and install our portlet. In the <span class="emphasis"><em>How it works…</em></span> section of this recipe, we will explain a message bus implementation.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec213"/>How to do it…</h2></div></div></div><p>In order to correctly compile, deploy, and install the portlet, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Download <code class="literal">quicksearch-portlet</code> from <a class="ulink" href="http://www.liferay-guru.com/code/ch11/quicksearch-portlet.zip">http://www.liferay-guru.com/code/ch11/quicksearch-portlet.zip</a>.</li><li class="listitem">Copy the portlet to the <code class="literal">workspace</code> folder.</li><li class="listitem">Open <code class="literal">quicksearch-portlet/pom.xml</code> and set the appropriate paths in the <code class="literal">&lt;properties&gt;</code> section.</li><li class="listitem">Invoke the <code class="literal">mvn clean install liferay:deploy</code> command.</li><li class="listitem">Run your Liferay instance and check whether, in the logfile, there is a message to successfully deploy:<div class="informalexample"><pre class="programlisting">INFO  [DispatcherPortlet:282] FrameworkPortlet 'quicksearchportlet': initialization completed in 81 ms
INFO  [DispatcherPortlet:119] Portlet 'quicksearchportlet' configured successfully
INFO  [localhost-startStop-3][PortletHotDeployListener:490] 1 portlet for quicksearch-portlet is available for use</pre></div></li><li class="listitem">Log<a id="id643" class="indexterm"/> in <a id="id644" class="indexterm"/>as an administrator, create a page called <span class="strong"><strong>Search</strong></span>, and put the <span class="strong"><strong>Search</strong></span> portlet, which is available under the <span class="strong"><strong>Tools</strong></span> category in the left menu called <span class="strong"><strong>Add</strong></span>.</li><li class="listitem">Create the second page, for example, <code class="literal">Quick Search</code>, and add the <span class="strong"><strong>QuickSearch</strong></span> portlet.</li><li class="listitem">Open a search portlet configuration window and set the layout to the Search portlet (in our case, it will be the <span class="strong"><strong>Search</strong></span> page).</li><li class="listitem">Click on the <span class="strong"><strong>Save</strong></span> button and close the pop-up configuration window via the <span class="strong"><strong>X</strong></span> button.</li><li class="listitem">Try to write a word (with at least three letters) in the <span class="strong"><strong>QuickSearch</strong></span> portlet and enjoy the autocomplete feature.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec214"/>How it works…</h2></div></div></div><p>In this portlet, Liferay Message Bus is used to ask the search engine about the autocomplete results. In our case, the producer is a class called <code class="literal">com.liferay.guru.portlet.quicksearch.util.QSMessageBusUtil</code>. Its code looks like this:</p><div class="informalexample"><pre class="programlisting">public class QSMessageBusUtil {

  public static JSONArray sendSynchronousMessage(SearchContext searchContext)
  throws MessageBusException {
    Message message = new Message();
    message.setDestinationName(QSDestinationNames.SEARCH_AUTOCOMPLETE);
    message.setPayload(searchContext);
    message.setResponseDestinationName(DestinationNames.MESSAGE_BUS_DEFAULT_RESPONSE);

    Object response = MessageBusUtil.sendSynchronousMessage(message.getDestinationName(), message,
      SearchConstants.AUTOCOMPLETE_TIMEOUT);


    if (response instanceof JSONArray) {
      return (JSONArray) response;
    } else {
      throw new MessageBusException("Invalid message response");
    }
  }
}</pre></div><p>This <a id="id645" class="indexterm"/>class has only <a id="id646" class="indexterm"/>one method that returns a JSON array with search results. The first three lines are responsible for creating the <code class="literal">Message</code> object, which will be sent to the message bus. The <code class="literal">Message</code> object is an instance of the <code class="literal">com.liferay.portal.kernel.messaging.Message</code> class with the following fields:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">String _destinationName</code>: This is the name of our destination. It is the place to which we address our message</li><li class="listitem"><code class="literal">Object _payload</code>: This field represents an object (payload) that will be sent to the consumer</li><li class="listitem"><code class="literal">Object _response</code>: This field contains an object that represents the response message</li><li class="listitem"><code class="literal">String _responseDestinationName</code>: The place where the consumer (listener) sends back the response. In our example, this is <code class="literal">DestinationNames.MESSAGE_BUS_DEFAULT_RESPONSE</code>, which defines the response back to the destination, the producer</li><li class="listitem"><code class="literal">String _responseId</code>: This value represents the response identifier</li><li class="listitem"><code class="literal">Map&lt;String, Object&gt; _values</code>: Additional maps of objects that will be sent to the consumer or producer</li></ul></div><p>In our implementation, we set the payload as <code class="literal">SearchContext</code> (our Lucene query) and set <code class="literal">responseDestinationName</code> as a default response.</p><p>To send our message to the message bus, we invoked the following method:</p><div class="informalexample"><pre class="programlisting">Object response = MessageBusUtil.sendSynchronousMessage(
  message.getDestinationName(), message,
  SearchConstants.AUTOCOMPLETE_TIMEOUT);</pre></div><p>There is a question: which class should receive our message? The answer and all of the configuration<a id="id647" class="indexterm"/> are in<a id="id648" class="indexterm"/> the <code class="literal">applicationContext-messaging.xml</code> file, which looks like this:</p><div class="informalexample"><pre class="programlisting">&lt;util:constant id="destination.name.search.autocomplete"
  static-field="com.liferay.guru.portlet.quicksearch.util.
  QSDestinationNames.SEARCH_AUTOCOMPLETE" /&gt;
&lt;bean id="messageListener.autocomplete.lucene" 
  class="com.liferay.guru.search.lucene.AutocompleteListener" /&gt;
&lt;bean id="destination.search.autocomplete"
  class="com.liferay.portal.kernel.messaging.
  SynchronousDestination"&gt;
  &lt;property name="name" ref="destination.name.
    search.autocomplete" /&gt;
&lt;/bean&gt;
&lt;!-- Configurator --&gt;
&lt;bean id="messagingConfigurator"
  class="com.liferay.portal.kernel.messaging.config.
  PluginMessagingConfigurator"&gt;
  &lt;property name="messageListeners"&gt;
    &lt;map key-type="java.lang.String" value-
      type="java.util.List"&gt;
      &lt;entry key-ref="destination.name.search.autocomplete"&gt;
        &lt;list&gt;
          &lt;ref bean="messageListener.autocomplete.lucene" /&gt;
        &lt;/list&gt;
      &lt;/entry&gt;
    &lt;/map&gt;
  &lt;/property&gt;
  &lt;property name="destinations"&gt;
    &lt;list&gt;
      &lt;ref bean="destination.search.autocomplete" /&gt;
    &lt;/list&gt;
  &lt;/property&gt;
&lt;/bean&gt;</pre></div><p>The preceding configuration specifies the following beans:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <code class="literal">listener</code> bean with the <code class="literal">messageListener.autocomplete.lucene</code> ID.</li><li class="listitem">The <code class="literal">destination</code> bean with the <code class="literal">destination.search.autocomplete</code> ID.</li><li class="listitem">The <code class="literal">configurator</code> bean that maps listeners to their destinations. In our case, it maps our <code class="literal">destination.search.autocomplete</code> destination to the <code class="literal">messageListener.autocomplete.lucene</code> bean. In other words, it links the destination with the listener.</li></ul></div><p>Let's look <a id="id649" class="indexterm"/>at our listener <a id="id650" class="indexterm"/>implementation:</p><div class="informalexample"><pre class="programlisting">public class AutocompleteListener extends BaseMessageListener {
  @Override
  protected void doReceive(Message message) throws Exception {

    Message response = MessageBusUtil.createResponseMessage( message );

    Object payload = message.getPayload();
    if ( payload instanceof SearchContext ) {
      response.setPayload( getSuggestions( (SearchContext) payload ) );
    }
    else {
      _log.error( "Message payload is invalid: " + Objects.toString( payload ) );
      response.setPayload( JSONFactoryUtil.createJSONArray() );
    }

    MessageBusUtil.sendMessage( response.getDestinationName(), response );
  }
[...]
}</pre></div><p>
<code class="literal">AutocompleteListener</code> extends <code class="literal">BaseMessageListener</code> and overrides the <code class="literal">doReceive</code> method.</p><p>The body of this method is responsible for creating a new response and sending it back to our producer. An object that was received and that will be sent is put to the payload field. Therefore, our implementation gets an object from payload, checks whether it is <code class="literal">SearchContext</code>, looks for new suggestions, and sets suggestions as a new payload.</p><p>Summarizing this recipe, remember the following things:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Liferay Message Bus implements a communication between producer and consumer</li><li class="listitem">The <code class="literal">Message</code> object is sent between the producer and consumer</li><li class="listitem">The producer creates a <code class="literal">Message</code> object with the following attributes:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">payload</code>: This field represents the object (payload) that will be sent to the consumer</li><li class="listitem"><code class="literal">responseDestinationName</code>: This is the name that is provided for listeners to use in replying</li><li class="listitem">Optionally, <code class="literal">responseId</code> (the <code class="literal">setResponseId</code> method) and other objects that should be sent to the consumer as a key/value pair (put method)</li></ul></div></li><li class="listitem">To send a synchronous message, you should use the <code class="literal">MessageBusUtil.sendSynchronousMessage</code> method</li><li class="listitem">The listener (consumer) must be registered in the XML definition</li><li class="listitem">The listener has a <code class="literal">doReceive</code> method that sends back a message</li><li class="listitem">The consumer extracts values from the message and prepares a response message</li><li class="listitem"><code class="literal">MessageBusUtil.createResponseMessage</code> should be used to create a response message</li><li class="listitem">Consumers send back a message to the producer via the <code class="literal">MessageBusUtil.sendMessage</code> method</li></ul></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec215"/>There's more...</h2></div></div></div><p>In this<a id="id651" class="indexterm"/> recipe, we discussed <a id="id652" class="indexterm"/>only synchronous communication that is a basic example of using a message bus. As a matter of fact, using synchronous messaging is not a good idea in many cases. Why? The answer is simple: this type of communication blocks waiting for a response from a recipient. Communication via messages was basically designed for asynchronous communication. There are two types of asynchronous messaging:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>send and forget</strong></span>: This means <span class="emphasis"><em>push an event and forget about it</em></span>. This type of communication <a id="id653" class="indexterm"/>is useful in notification cases, for example, if a producer wants to notify listeners about some action.</li><li class="listitem"><span class="strong"><strong>call-back</strong></span>: The producer defines a call back destination in <code class="literal">responseDestinationName</code> for the message. The listener can send the message<a id="id654" class="indexterm"/> back to the specific <code class="literal">responseDestinationName</code>. The important information is that the producer is free for further processing.</li></ul></div><p>From a technical point of view, an asynchronous implementation is very similar to our example. The main difference is that it invokes a different method from <code class="literal">MessageBusUtil</code>. To send an asynchronous message, the following invocation should be used, as you can see in the listener code when you send the response:</p><div class="informalexample"><pre class="programlisting">MessageBusUtil.sendMessage(message.getDestinationName(), message);</pre></div><p>The<a id="id655" class="indexterm"/> important information<a id="id656" class="indexterm"/> is that the <code class="literal">sendMessage</code> method does not return any values, because it is an asynchronous message, and we don't know whether there is call-back information or not. All of the configurations where call back should be sent are placed in the <code class="literal">messaging.xml</code> file. Here is an example:</p><div class="informalexample"><pre class="programlisting">&lt;entry key="YOUR_RESPONSE_DESTINATION_NAME"&gt;
  &lt;list value-type="com.liferay.portal.kernel.messaging.MessageListener"&gt;
    &lt;ref bean="messageListener.listener1" /&gt;
    &lt;ref bean="messageListener.listener2" /&gt;
    &lt;ref bean="messageListener.listenerN" /&gt;
  &lt;/list&gt;
&lt;/entry&gt;</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec216"/>See also</h2></div></div></div><p>In order to learn about creating plugins (especially portlets), refer to the <span class="emphasis"><em>Creating a custom portlet</em></span> recipe from <a class="link" title="Chapter 1. Installation and Basic Configuration" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <span class="emphasis"><em>Installation and Basic Configuration.</em></span>
</p></div></div>
<div class="section" title="Clustering Liferay Portal"><div class="titlepage" id="aid-2IV0U2"><div><div><h1 class="title"><a id="ch11lvl1sec81"/>Clustering Liferay Portal</h1></div></div></div><p>Liferay supports clustering <a id="id657" class="indexterm"/>out-of-the-box in the <span class="strong"><strong>Community Edition</strong></span> (<span class="strong"><strong>CE</strong></span>) version as well as the <span class="strong"><strong>Enterprise Edition</strong></span> (<span class="strong"><strong>EE</strong></span>) version. It is designed to <a id="id658" class="indexterm"/>build <a id="id659" class="indexterm"/>scalable systems that can be used by large <a id="id660" class="indexterm"/>companies with a huge amount of data, so it allows us to run several portal instances on parallel servers. In order to build Liferay clusters, you need to know which components are sensitive to clustering. The clustering process has a huge impact on the following components:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Databases, where Liferay instances keep their data</li><li class="listitem">Documents and media as a folder on the hard drive</li><li class="listitem">Lucene search engine files</li><li class="listitem">Liferay caches</li></ul></div><p>This recipe will go through each point and show you how to cluster Liferay correctly.</p><div class="section" title="Getting ready…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec217"/>Getting ready…</h2></div></div></div><p>This recipe is not a tutorial on how to correctly run clustered environments, such as Apache server, load balancers, and so on. Instead, our goal is to show you how to correctly configure Liferay so that it works with a parallel environment. Let's assume that you have properly <a id="id661" class="indexterm"/>configured all the components. The last step is configuring <a id="id662" class="indexterm"/>Liferay to work in a cluster properly.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec218"/>How to do it…</h2></div></div></div><p>As we said at the beginning, there are several points that should be checked before running Liferay on a cluster.</p><div class="section" title="Check database configuration"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec74"/>Check database configuration</h3></div></div></div><p>The first thing, which is really simple, is checking database configuration. There should be one<a id="id663" class="indexterm"/> database instance <a id="id664" class="indexterm"/>shared between all Liferay nodes. To check configuration correctness, open the property file where database access configuration is present. Usually, it is <code class="literal">portal-ext.properties</code>. Make sure that, in every node, the configuration is the same. Here is an example:</p><div class="informalexample"><pre class="programlisting">jdbc.default.driverClassName=com.mysql.jdbc.Driver
jdbc.default.url=jdbc:mysql://localhost/lportal?useUnicode=true&amp;characterEncoding=UTF-8&amp;useFastDateParsing=false
jdbc.default.username=&lt;USERNAME&gt;
jdbc.default.password=&lt;PASSWORD&gt;</pre></div></div><div class="section" title="Documents and media clustering"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec75"/>Documents and media clustering</h3></div></div></div><p>In <a class="link" title="Chapter 6. Documents and Media in Liferay" href="part0050.xhtml#aid-1FLS41">Chapter 6</a>, <span class="emphasis"><em>Documents and Media in Liferay</em></span>, we explained how the Documents and Media portlet<a id="id665" class="indexterm"/> works. It is also important to<a id="id666" class="indexterm"/> know that file metadata is <a id="id667" class="indexterm"/>stored in a database, but binary data (files) are stored on the hard<a id="id668" class="indexterm"/> drive. As you can guess, it will be a problem when Liferay works as a clustered environment, because each node can have its own repository and files are not shared between nodes. In order to resolve this problem, there are three ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Sharing<a id="id669" class="indexterm"/> the repository between nodes via <span class="strong"><strong>Storage Area Network</strong></span> (<span class="strong"><strong>SAN</strong></span>), <span class="strong"><strong>Network Attached Storage</strong></span> (<span class="strong"><strong>NAS</strong></span>), GlusterFS <a id="id670" class="indexterm"/>and so on: Ask your system administrator which option is available on a specific machine and correctly install the clustered filesystem. In many solutions, we have seen a GlusterFS system, which shared a data folder between nodes. This solution guarantees that each node has the same repository of files. Make sure that the following property indicates a proper location for shared disk storage:<div class="informalexample"><pre class="programlisting">dl.store.file.system.root.dir=${liferay.home}/data/document_library</pre></div></li><li class="listitem">Using <a id="id671" class="indexterm"/>database storage: All data, including binary files, is stored in a database table. To enable this configuration, set <a id="id672" class="indexterm"/>the following property:<div class="informalexample"><pre class="programlisting">dl.store.impl=com.liferay.portlet.documentlibrary.store.DBStore</pre></div><p>This setting automatically uses the database instead of filesystem. The database should support the BLOB's field.</p></li><li class="listitem">Using <a id="id673" class="indexterm"/>external storage systems, such as the following<a id="id674" class="indexterm"/> ones:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>Amazon Cloud</strong></span>: We <a id="id675" class="indexterm"/>showed you how to configure this storage in the <span class="emphasis"><em>Integration with the Amazon S3 cloud</em></span> recipe in <a class="link" title="Chapter 6. Documents and Media in Liferay" href="part0050.xhtml#aid-1FLS41">Chapter 6</a>, <span class="emphasis"><em>Documents and Media in Liferay</em></span></li><li class="listitem"><span class="strong"><strong>Content Management Interoperability Services</strong></span> (<span class="strong"><strong>CMIS</strong></span>) Store such <a id="id676" class="indexterm"/>as Alfresco: After<a id="id677" class="indexterm"/> successful installation of Alfresco (or other CMIS Store system), set the following properties:<div class="informalexample"><pre class="programlisting">dl.store.impl=com.liferay.portlet.documentlibrary.store.CMISStore
dl.store.cmis.credentials.username=none
dl.store.cmis.credentials.password=none
dl.store.cmis.repository.url=http://localhost:8080/alfresco/service/api/cmis
dl.store.cmis.system.root.dir=Liferay Home</pre></div></li><li class="listitem"><span class="strong"><strong>A Java Content Repository</strong></span> (<span class="strong"><strong>JCR</strong></span>) store<a id="id678" class="indexterm"/> such as Jackrabbit: This<a id="id679" class="indexterm"/> is an Apache project implemented as a JSR-170 specification. Liferay supports it, but this configuration is deprecated because of performance issues and concurrency conflicts. In this solution, the Jackrabbit repository must be placed on the SAN shared storage (mounted on every node).</li></ul></div></li></ul></div></div><div class="section" title="Search engine"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec76"/>Search engine</h3></div></div></div><p>We already mentioned the <a id="id680" class="indexterm"/>search engine topic <a id="id681" class="indexterm"/>in <a class="link" title="Chapter 8. Search and Content Presentation Tools" href="part0059.xhtml#aid-1O8H61">Chapter 8</a>, <span class="emphasis"><em>Search and Content Presentation Tools</em></span>. We showed two search engines: Apache Lucene and Apache Solr. If you use Solr or Solr Cloud as a search engine, everything will work perfectly because Solr is an external application with which Liferay establishes a connection. In the clustered environment, this is the best option because of performance and the quality of the search results.</p><p>As you know, Lucene<a id="id682" class="indexterm"/> keeps its data in a local storage filesystem. It is a problem to keep an up-to-date index on every Liferay node in the clustered environment. We cannot replicate the index file by GlusterFS, because Lucene sometimes locks data when it writes to an index or optimizes it. In order to resolve this conflict, Liferay <a id="id683" class="indexterm"/>gives a functionality that provides a replication mechanism between all Liferay's nodes. To enable this functionality, set the following properties:</p><div class="informalexample"><pre class="programlisting">cluster.link.enabled=true
lucene.replicate.write=true</pre></div><p>These properties need to be set for all of Liferay's nodes. The <code class="literal">cluster.link.enabled</code> property turns on the whole mechanism of cache replication, which we will describe in the following section.</p></div><div class="section" title="Cache replication"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec77"/>Cache replication</h3></div></div></div><p>Liferay <a id="id684" class="indexterm"/>uses EhCache to cache some content, such as the result of SQL queries. In a clustered environment, cache distribution is a very important issue. Each node should know about the changes on the database and cache invalidations. Phil Karlton once quoted:</p><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>"There are only two hard things in Computer Science: cache invalidation and naming things."</em></span></p></blockquote></div><p>I completely agree with him.</p><div class="section" title="Multicast"><div class="titlepage"><div><div><h4 class="title"><a id="ch11lvl4sec05"/>Multicast</h4></div></div></div><p>Cache distribution between nodes works perfectly with multicasting. Make sure that your servers support <a id="id685" class="indexterm"/>multicasting. Next, set the following property to enable replication:</p><div class="informalexample"><pre class="programlisting">cluster.link.enabled=true</pre></div><p>This property turns on the clustered mode.</p><p>The following properties define five channels for distributing messages between nodes:</p><div class="informalexample"><pre class="programlisting">    multicast.group.address["cluster-link-control"]=239.255.0.1
    multicast.group.port["cluster-link-control"]=23301

    multicast.group.address["cluster-link-udp"]=239.255.0.2
    multicast.group.port["cluster-link-udp"]=23302

    multicast.group.address["cluster-link-mping"]=239.255.0.3
    multicast.group.port["cluster-link-mping"]=23303

    multicast.group.address["hibernate"]=239.255.0.4
    multicast.group.port["hibernate"]=23304

    multicast.group.address["multi-vm"]=239.255.0.5
    multicast.group.port["multi-vm"]=23305</pre></div><p>Set a <a id="id686" class="indexterm"/>proper IP addresses and port number for the preceding properties (settings). In many environments, it works out of the box.</p></div><div class="section" title="Unicast"><div class="titlepage"><div><div><h4 class="title"><a id="ch11lvl4sec06"/>Unicast</h4></div></div></div><p>In some servers, it might not be possible to send messages by multicasting. Fortunately, it is possible to<a id="id687" class="indexterm"/> force Liferay to use unicast protocols instead of multicast. Configuration is not very difficult, but it is hard to discover it. To reduce the time spent on Google, follow this part of the recipe and correctly set this type of communication.</p><p>First, turn on the clustering mode by setting the <code class="literal">cluster.link.enabled</code> property with the <code class="literal">true</code> value.</p><p>Next, you have to use the <code class="literal">JGroups</code> library to establish communication via TCP. To achieve this, set the following properties:</p><div class="informalexample"><pre class="programlisting">ehcache.bootstrap.cache.loader.factory=com.liferay.portal.cache.ehcache.JGroupsBootstrapCacheLoaderFactory
ehcache.cache.event.listener.factory=net.sf.ehcache.distribution.jgroups.JGroupsCacheReplicatorFactory
ehcache.cache.manager.peer.provider.factory=net.sf.ehcache.distribution.jgroups.JGroupsCacheManagerPeerProviderFactory

<span class="strong"><strong>ehcache.multi.vm.config.location.peerProviderProperties=file=unicast-ehcache.xml</strong></span>
<span class="strong"><strong>net.sf.ehcache.configurationResourceName.peerProviderProperties=file=unicast-ehcache.xml</strong></span>

<span class="strong"><strong>cluster.link.channel.properties.control=unicast-ehcache.xml</strong></span>
<span class="strong"><strong>cluster.link.channel.properties.transport.0=unicast-ehcache.xml</strong></span>
</pre></div><p>Analyze the highlighted part in the preceding section. All channels have references to the <code class="literal">unicast-ehcache.xml</code> file. Thus, create the <code class="literal">unicast-ehcache.xml</code> file on a classpath (<code class="literal">${TOMCAT_HOME}webapps/ROOT/WEB-INF/classes</code>). It is also possible to create it in the <code class="literal">ext</code> plugin at <code class="literal">ext-impl/src/main/resources/unicast-ehcache.xml</code>. The content of the file is as follows:</p><div class="informalexample"><pre class="programlisting">&lt;config 
   
   
  xsi:schemaLocation="urn:org:jgroups http://www.jgroups.org/schema/JGroups-2.8.xsd"
&gt; 
      &lt;TCP singleton_name="liferay" 
           bind_port="7800" 
           loopback="true" 
           recv_buf_size="${tcp.recv_buf_size:20M}" 
           send_buf_size="${tcp.send_buf_size:640K}" 
           discard_incompatible_packets="true" 
           max_bundle_size="64K"
           max_bundle_timeout="30" 
           enable_bundling="true" 
           use_send_queues="true" 
           sock_conn_timeout="300" 
           timer.num_threads="4" 
           thread_pool.enabled="true" 
           thread_pool.min_threads="1" 
           thread_pool.max_threads="10" 
           thread_pool.keep_alive_time="5000" 
           thread_pool.queue_enabled="false" 
           thread_pool.queue_max_size="100" 
           thread_pool.rejection_policy="discard" 
           oob_thread_pool.enabled="true" 
           oob_thread_pool.min_threads="1" 
           oob_thread_pool.max_threads="8" 
           oob_thread_pool.keep_alive_time="5000" 
           oob_thread_pool.queue_enabled="false" 
           oob_thread_pool.queue_max_size="100" 
           oob_thread_pool.rejection_policy="discard"/&gt; 
     
    &lt;TCPPING timeout="3000" 
             initial_hosts="${jgroups.tcpping.initial_hosts:localhost[7800],localhost[7801]}" 
             port_range="1" 
             num_initial_members="3"/&gt; 
           
    &lt;MERGE2 min_interval="10000" max_interval="30000"/&gt; 
    &lt;FD_SOCK/&gt; 
    &lt;FD timeout="3000" max_tries="3" /&gt; 
    &lt;VERIFY_SUSPECT timeout="1500" /&gt; 
    &lt;BARRIER /&gt; 
    &lt;pbcast.NAKACK use_mcast_xmit="false" gc_lag="0" retransmit_timeout="300,600,1200,2400,4800" discard_delivered_msgs="true"/&gt; 
    &lt;UNICAST timeout="300,600,1200" /&gt; 
    &lt;pbcast.STABLE stability_delay="1000" desired_avg_gossip="50000" max_bytes="400K"/&gt; 
    &lt;pbcast.GMS print_local_addr="true" join_timeout="3000" view_bundling="true"/&gt; 
    &lt;FC max_credits="2M" min_threshold="0.10"/&gt; 
    &lt;FRAG2 frag_size="60K" /&gt; 
    &lt;pbcast.STREAMING_STATE_TRANSFER/&gt; 
    &lt;!-- &lt;pbcast.STATE_TRANSFER/&gt; --&gt; 
&lt;/config&gt;</pre></div><p>The last thing to<a id="id688" class="indexterm"/> enable communication is to tell <code class="literal">JGroups</code> about the available nodes (Liferay instances). Let's assume there are two nodes of Liferay with the following IP addresses:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>node1</strong></span> with 192.168.0.10 address</li><li class="listitem"><span class="strong"><strong>node2</strong></span> with 192.168.0.11 address</li></ul></div><p>In order to configure it, set the following <code class="literal">JAVA_OPTS</code> variable in your application server (for instance, at <code class="literal">${TOMCAT_HOME}/bin/setenv.sh</code>):</p><p>
<span class="strong"><strong>node1</strong></span>:</p><div class="informalexample"><pre class="programlisting">JAVA_OPTS="${JAVA_OPTS} -Djgroups.bind_addr=192.168.0.10" JAVA_OPTS="${JAVA_OPTS} -Djgroups.tcpping.initial_hosts=192.168.0.10[7800],192.168.0.11[7800] "</pre></div><p>
<span class="strong"><strong>node2</strong></span>:</p><div class="informalexample"><pre class="programlisting">JAVA_OPTS="${JAVA_OPTS} -Djgroups.bind_addr=192.168.0.11" JAVA_OPTS="${JAVA_OPTS} -Djgroups.tcpping.initial_hosts=192.168.0.10[7800],192.168.0.11[7800] "</pre></div></div></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec219"/>How it works…</h2></div></div></div><p>In this recipe, we touched upon several subjects from database configuration to Ehcache replication. All of these steps are necessary to correctly run Liferay in a clustered environment. Liferay is a huge system with many dependencies, so it is quite difficult to install it in many server instances. We believe that our advice will help you configure and run Liferay CMS. Our intention was to introduce the possible ways of configuration. Every company has its own ideas and solutions to install Liferay. In our experience, here are <a id="id689" class="indexterm"/>some of the best configurations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Apache with the <code class="literal">mod_jk</code> module and load balancer as a reverse proxy</li><li class="listitem">Squid as a caching proxy</li><li class="listitem">GlusterFS as a shared filesystem where documents and media portlets keep their data</li><li class="listitem">The Solr <a id="id690" class="indexterm"/>server and Zookeeper as a search engine cloud</li><li class="listitem">The MySQL database with a master/slave configuration</li><li class="listitem">The EhCache replication via multicast (or unicast)<div class="note" title="Note"><h3 class="title"><a id="note39"/>Note</h3><p>If you need more<a id="id691" class="indexterm"/> detailed information, go to Liferay's official documentation at <a class="ulink" href="https://dev.liferay.com/discover/deployment/-/knowledge_base/6-2/liferay-clustering">https://dev.liferay.com/discover/deployment/-/knowledge_base/6-2/liferay-clustering</a>.</p></div></li></ul></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec220"/>See also</h2></div></div></div><p>In order to learn more about scalable infrastructure, refer to the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="emphasis"><em>Scalable infrastructure</em></span> recipe from <a class="link" title="Chapter 12. Basic Performance Tuning" href="part0088.xhtml#aid-2JTHG1">Chapter 12</a>, <span class="emphasis"><em>Basic Performance Tuning</em></span></li><li class="listitem">The <span class="emphasis"><em>Integration with the Amazon S3 cloud</em></span> and the <span class="emphasis"><em>Data migration between storage hooks</em></span> recipes from <a class="link" title="Chapter 6. Documents and Media in Liferay" href="part0050.xhtml#aid-1FLS41">Chapter 6</a>, <span class="emphasis"><em>Documents and Media in Liferay</em></span></li></ul></div></div></div></body></html>