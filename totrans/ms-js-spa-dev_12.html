<html><head></head><body><div class="chapter" title="Chapter&#xA0;12.&#xA0;Connecting the App to Social Media"><div class="titlepage"><div><div><h1 class="title"><a id="ch12"/>Chapter 12. Connecting the App to Social Media</h1></div></div></div><p>Many web applications use third-party authentication for registering and logging in. In particular, using popular social media sites such as Facebook and Twitter to authenticate users has become very popular. Since these sites have already done some work to validate users, sites using them to authenticate users save a some time.</p><p>In this chapter, we are going to set up Passport strategies to sign up and authenticate users using their Facebook and Twitter accounts. We're going to be using a popular protocol called OAuth 2.</p><p>Additionally, we're going to finish building out the functionality for users to create and share gift lists. In this chapter, we will cover the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Authenticating users with Facebook</li><li class="listitem" style="list-style-type: disc">Authenticating users with Twitter</li><li class="listitem" style="list-style-type: disc">Handling gift list creation in the dashboard</li><li class="listitem" style="list-style-type: disc">Adding share buttons</li></ul></div><div class="section" title="Connecting to Facebook"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec65"/>Connecting to Facebook</h1></div></div></div><p>We are going to begin integration with social media by allowing users to create accounts and log in using their Facebook accounts. The first things we need to do are to set up a Facebook developer account and build a Facebook app.</p><div class="section" title="Setting up your Facebook developer account and app"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec137"/>Setting up your Facebook developer account and app</h2></div></div></div><p>In order to authenticate users using Facebook, you have to have a Facebook app. Fortunately, Facebook makes setting this up really easy.</p><p>If you do not have a Facebook developer account, head over to <a class="ulink" href="https://developers.facebook.com/">https://developers.facebook.com/</a> right now and sign up for a developer account. Just follow the instructions and agree to the terms of service. Next, we need to set up an app. From the developers' dashboard, select <span class="strong"><strong>Add </strong></span>
<span class="strong"><strong>New App</strong></span> from the <span class="strong"><strong>My Apps</strong></span> dropdown. You'll get a modal window that looks like the following screenshot:</p><p>
</p><div class="mediaobject"><img src="graphics/image_12_001.jpg" alt="Setting up your Facebook developer account and app"/></div><p>
</p><p>Select <span class="strong"><strong>Website</strong></span>:</p><p>
</p><div class="mediaobject"><img src="graphics/image_12_002.jpg" alt="Setting up your Facebook developer account and app"/></div><p>
</p><p>Give your new app a name and select <span class="strong"><strong>Create New Facebook App ID</strong></span>:</p><p>
</p><div class="mediaobject"><img src="graphics/image_12_003.jpg" alt="Setting up your Facebook developer account and app"/></div><p>
</p><p>Choose a category for your new app (any one will do, really). Make sure to leave off the selection for <span class="strong"><strong>Is this a test version of another app?</strong></span> Then click <span class="strong"><strong>Create App ID</strong></span>:</p><p>
</p><div class="mediaobject"><img src="graphics/image_12_004.jpg" alt="Setting up your Facebook developer account and app"/></div><p>
</p><p>From here, I suggest you select <span class="strong"><strong>Skip Quick Start</strong></span> and we'll set up your application manually. On the next screen, select <span class="strong"><strong>Settings</strong></span>:</p><p>
</p><div class="mediaobject"><img src="graphics/image_12_005.jpg" alt="Setting up your Facebook developer account and app"/></div><p>
</p><p>You'll need to enter your e-mail address here and click <span class="strong"><strong>Save Changes</strong></span>. Next, click on <span class="strong"><strong>App Review</strong></span>:</p><p>
</p><div class="mediaobject"><img src="graphics/image_12_006.jpg" alt="Setting up your Facebook developer account and app"/></div><p>
</p><p>Select <span class="strong"><strong>Yes</strong></span> for <span class="strong"><strong>Do you want to make this app and all its live features available to the general public?</strong></span> Next, go back to your dashboard:</p><p>
</p><div class="mediaobject"><img src="graphics/image_12_007.jpg" alt="Setting up your Facebook developer account and app"/></div><p>
</p><p>You're going to need your App ID and App Secret values. Facebook will force you to enter your password to show your App Secret.</p><p>
<span class="strong"><strong>App Secret</strong></span> is exactly that - secret. You should protect it and not do anything like check it into public source control.</p></div><div class="section" title="Setting up the Passport strategy"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec138"/>Setting up the Passport strategy</h2></div></div></div><p>The next thing we need to do is to set up the strategy in Passport. Open up your terminal and navigate to your <code class="literal">giftapp</code> root directory:</p><pre class="programlisting">
<span class="strong"><strong>$ npm install passport-facebook --save</strong></span>
<span class="strong"><strong>passport-facebook@2.1.0 node_modules/passport-facebook</strong></span>&#13;
    |__<span class="strong"><strong> passport-oauth2@1.1.2 (uid2@0.0.3, passport-strategy@1.0.0, oauth@0.9.14)</strong></span>
</pre><p>Here, we've installed the Passport Facebook module, which allows us to log in with Facebook using OAuth 2.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note15"/>Note</h3><p>OAuth is an open protocol to allow secure authorization in a simple and standard method from web, mobile and desktop applications. You can find more information about OAuth 2, the latest version of the protocol, at <a class="ulink" href="http://oauth.net/2/">http://oauth.net/2/</a>.</p></div></div><div class="section" title="Configuring for Facebook"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec153"/>Configuring for Facebook</h3></div></div></div><p>Now we need to set up our strategy. Inside your giftapp directory, make a new directory called <code class="literal">config</code>, and add a new file called <code class="literal">authorization.js</code>:</p><pre class="programlisting">module.exports = { &#13;
    facebookAuth : { &#13;
        clientID: '695605423876152', // App ID &#13;
        clientSecret: 'd8591aa38e06a07b040f20569a', // App secret &#13;
        callbackURL: 'http://localhost:3000/login/FBcallback' &#13;
    } &#13;
} &#13;
</pre><p>We just stash an object with a few values we're going to need later. The <code class="literal">clientID</code> is our App ID. The <code class="literal">clientSecret</code> is our App Secret (no, that isn't my real secret). The last value is our <code class="literal">callBackURL</code>. This is a URL that Facebook will redirect to on authorization.</p><p>If you are using a Git repository to store your source code, it would be a good idea to add this <code class="literal">config</code> file to your <code class="literal">.gitignore</code> file.</p></div><div class="section" title="Setting up the routes for Facebook authentication"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec154"/>Setting up the routes for Facebook authentication</h3></div></div></div><p>The next thing we need to do is to set up a couple of routes. In your <code class="literal">routes</code> directory, open up your routes file, <code class="literal">login.js</code>:</p><pre class="programlisting">var express = require('express');s &#13;
var router = express.Router(); &#13;
 &#13;
 &#13;
module.exports = function(passport){ &#13;
 &#13;
 &#13;
    router.get('/', function(req, res) { &#13;
        res.render('login/login', { message: req.flash('message'), csrfToken:&#13;
        req.csrfToken() }); &#13;
    }); &#13;
 &#13;
 &#13;
    router.post('/', passport.authenticate('login', { &#13;
        successRedirect: '/dash', &#13;
        failureRedirect: '/login', &#13;
        failureFlash : true &#13;
    })); &#13;
 &#13;
 &#13;
    router.get('/signup', function(req, res){ &#13;
        console.log('signing up'); &#13;
        res.render('login/signup',{message: req.flash('message'), csrfToken: &#13;
        req.csrfToken()}); &#13;
    }); &#13;
 &#13;
 &#13;
    router.post('/register', passport.authenticate('signup', { &#13;
        successRedirect: '/dash', &#13;
        failureRedirect: '/login/signup', &#13;
        failureFlash : true &#13;
    })); &#13;
 &#13;
    router.get('/signout', function(req, res) { &#13;
        req.logout(); &#13;
        res.redirect('/login'); &#13;
    }); &#13;
 &#13;
<span class="strong"><strong>    router.get('/facebook', passport.authenticate('facebook', scope:['emails']));&#13;
</strong></span>
<span class="strong"><strong>    router.get('/FBcallback',</strong></span>
<span class="strong"><strong>        passport.authenticate('facebook',&#13;
 { &#13;
successRedirect: '/dash',</strong></span>
<span class="strong"><strong>            failureRedirect: '/login' }));</strong></span> &#13;
 &#13;
    return router; &#13;
} &#13;
</pre><p>The first new route is going to be used to log in using Facebook. The callback URL is used after authentication. On failure, the user is redirected to login. On success, the user is sent to the dashboard.</p><p>Note that the second argument to the call to <code class="literal">passport.authenticate</code> on the <code class="literal">facebook</code> route. This object contains a scope property, which takes an array. That array consists of strings for data fields for which Facebook requires extra permissions to access. Facebook requires extra permissions to access a user's e-mail address.</p></div><div class="section" title="Finishing setting up the Passport strategy"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec155"/>Finishing setting up the Passport strategy</h3></div></div></div><p>Now we have a few more steps to set up the strategy. In your Passport directory, create a new file called <code class="literal">facebook.js:</code>
</p><pre class="programlisting">var FacebookStrategy = require('passport-facebook').Strategy; &#13;
var User = require('../models/user'); &#13;
var auth = require('../config/authorization'); &#13;
 &#13;
module.exports = function(passport){ &#13;
 &#13;
    passport.use('facebook', new FacebookStrategy({ &#13;
            clientID: auth.facebookAuth.clientID, &#13;
            clientSecret: auth.facebookAuth.clientSecret, &#13;
            callbackURL: auth.facebookAuth.callbackURL, &#13;
            profileFields: ['id', 'displayName', 'email'] &#13;
        }, &#13;
        function(accessToken, refreshToken, profile, cb) { &#13;
            User.findOne({ 'facebook.id': profile.id }, function (err, user) { &#13;
                if(err){ &#13;
                    return cb(err) &#13;
                } else if (user) { &#13;
                    return cb(null, user); &#13;
                } else { &#13;
                    var newUser = new User(); &#13;
                    newUser.facebook.id = profile.id; &#13;
                    newUser.facebook.token = accessToken; &#13;
                    newUser.facebook.name = profile.displayName; &#13;
                    if(profile.emails){ &#13;
                        newUser.email = profile.emails[0].value; &#13;
                    } &#13;
 &#13;
                    newUser.save(function(err){ &#13;
                        if(err){ &#13;
                            throw err; &#13;
                        }else{ &#13;
                            return cb(null, newUser); &#13;
                        } &#13;
                    }); &#13;
                } &#13;
            }); &#13;
        } &#13;
    )); &#13;
} &#13;
</pre><p>We begin by requiring our dependencies, including the Strategy object provided by the <code class="literal">passport-facebook</code> module, our User model, and our authorization configuration file containing our Facebook credentials.</p><p>We then create a module that defines our Facebook authentication strategy. It receives a configuration object as its first argument, which we define using the <code class="literal">facebook</code> authorization values from our configuration file. The final property, <code class="literal">profileFields</code>, sets the fields we're expecting to receive in the profile object we get back from Facebook.</p><p>The second argument is a function that gets called when the authorization strategy is used. It receives an <code class="literal">accessToken</code>, <code class="literal">refreshToken</code>, <code class="literal">profile</code>, and <code class="literal">callback</code> as arguments from Facebook.</p><p>We use the User's <code class="literal">findOne</code> function to see if the user already exists based on the <code class="literal">profile.id</code> returned from Facebook. We first check to see if there's an error. If there is, we return it to the callback. If there's no error and the user exists, the user object is passed back to the callback with a null in the error field. Finally, if the user doesn't already exist, we create a new user, save that user to the database, then pass the new user object back to the callback.</p><p>Note that we will not always get e-mails back from Facebook, so we need to test to see if we get that property back on profile before we try to access it.</p><p>Remember that if you want to delete your <code class="literal">users</code> collection you can use the Mongo console. Enter <code class="literal">use giftapp</code> to select the database, then <code class="literal">db.users.drop()</code> to drop the collection.</p></div></div><div class="section" title="Altering the User model for Facebook data"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec139"/>Altering the User model for Facebook data</h2></div></div></div><p>Let's make some changes to our <code class="literal">User</code> model. Our Facebook authorization will give us some data that we weren't getting before, and there's some stuff we need to store. Open up your <code class="literal">user.js</code> file in your models directory and edit the following:</p><pre class="programlisting">var mongoose = require('mongoose'); &#13;
 &#13;
var userSchema = mongoose.Schema({ &#13;
    id: String, &#13;
    email: String, &#13;
    username: String, &#13;
    password: String, &#13;
    firstName: String, &#13;
    lastName: String, &#13;
 &#13;
    facebook: { &#13;
 &#13;
        id: String, &#13;
        token: String &#13;
    } &#13;
 &#13;
}); &#13;
module.exports = mongoose.model('User',userSchema); &#13;
</pre><p>Here, we're going to use the <code class="literal">mongoose.Schema</code> function to start to build out our schema. We've added a <code class="literal">Facebook</code> object to the user which stores an ID, and a token. Note that this new ID is provided by Facebook and is different from the ID at the top level of the <code class="literal">User</code> object.</p><p>The token is a unique <code class="literal">id</code> that Facebook provides on an application-by-application basis. We need to store this for authentication to work correctly.</p></div><div class="section" title="Finishing the connection to Facebook"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec140"/>Finishing the connection to Facebook</h2></div></div></div><p>We are almost good to go. We have just a couple more steps to do to complete the work for authenticating and signing up with Facebook.</p><div class="section" title="Recreating our home page"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec156"/>Recreating our home page</h3></div></div></div><p>Let's make life a little easier on ourselves and rewrite our <code class="literal">index.ejs</code> file inside our views directory:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html&gt; &#13;
  &lt;head&gt; &#13;
    &lt;title&gt;&lt;%= title %&gt;&lt;/title&gt; &#13;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt; &#13;
 &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"&gt; &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"&gt; &#13;
 &#13;
  &lt;/head&gt; &#13;
  &lt;body&gt; &#13;
    &lt;div class="container"&gt; &#13;
      &lt;div class="jumbotron"&gt; &#13;
        &lt;h1 class="text-center"&gt;Welcome to Giftapp&lt;/h1&gt; &#13;
        &lt;hr&gt; &#13;
        &lt;p class="text-center"&gt; &#13;
          &lt;a class="btn btn-default btn-lg" href="/login/" role="button"&gt;Log in&lt;/a&gt; &#13;
          &lt;a class="btn btn-default btn-lg" href="/login/signup" role="button"&gt;Sign Up&lt;/a&gt; &#13;
          &lt;a class="btn btn-primary btn-lg" href="/login/facebook" role="button"&gt;Log in or sign up with Facebook&lt;/a&gt; &#13;
        &lt;/p&gt; &#13;
      &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
  &lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>Here, we've created a simple welcome page using the Bootstrap <code class="literal">jumbotron</code>. We have three buttons, which are actually links styled as buttons: one for login, one for signup, and one for Facebook signup/login.</p><p>The page, at <code class="literal">http://localhost:3000</code>, will look like the following:</p><p>
</p><div class="mediaobject"><img src="graphics/image_12_008.jpg" alt="Recreating our home page"/></div><p>
</p><p>You can test out the buttons. Unfortunately, clicking on our Facebook button gets you an error:</p><p>
</p><div class="mediaobject"><img src="graphics/image_12_009.jpg" alt="Recreating our home page"/></div><p>
</p><p>This is because we have to specifically enable URLs inside our Facebook app. Facebook enforces this security measure. Not a problem for us. Go back to <span class="strong"><strong>Settings</strong></span> on your Facebook app dashboard:</p><p>
</p><div class="mediaobject"><img src="graphics/image_12_010.jpg" alt="Recreating our home page"/></div><p>
</p><p>Once in here, click on <span class="strong"><strong>+ Add Platform</strong></span> and select <span class="strong"><strong>Website</strong></span>. Enter <code class="literal">http://localhost</code> in the URL field. Now you should be able to register and authenticate with Facebook.</p><p>One thing you may want to implement on your own is checking to see if a user already exists in the database by checking any e-mail address returned by Facebook against user e-mails already in the database. This will help to avoid duplicate accounts.</p></div></div></div></div>
<div class="section" title="Connecting to Twitter"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec66"/>Connecting to Twitter</h1></div></div></div><p>One of the great things about Passport, and OAuth 2, is that there are a ton of different strategies we can use to authenticate with third parties. Let's set up Twitter authentication.</p><div class="section" title="Adding a Twitter app"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec141"/>Adding a Twitter app</h2></div></div></div><p>Similar to Facebook, we need to set up an app on Twitter for our application to communicate with. Head on over to <a class="ulink" href="https://apps.twitter.com">https://apps.twitter.com</a> and create a new app:</p><p>
</p><div class="mediaobject"><img src="graphics/image_12_011.jpg" alt="Adding a Twitter app"/></div><p>
</p><p>Fill in a name, description, and the two URLs. At the time of writing, Twitter does not allow <code class="literal">http://localhost</code> as a URL, so you have to use <code class="literal">http://127.0.0.1</code>.</p><p>Now click over to <span class="strong"><strong>Keys and Access Tokens </strong></span>and grab your Consumer Key and Consumer Secret. We're going to add these to our <code class="literal">authorization.js</code> configuration file:</p><pre class="programlisting">module.exports = { &#13;
    facebookAuth : { &#13;
        clientID: '695605423876152', // App ID &#13;
        clientSecret: 'd85fR1nkOz2056801c8f9a', // App secret &#13;
        callbackURL: 'http://localhost:3000/login/FBcallback' &#13;
    }, &#13;
 &#13;
    twitterAuth : { &#13;
        'consumerKey'       : 'JksPJ0z46tf10/15/16asUdgxW1lJp', &#13;
        'consumerSecret'    : 'IV095CmDyUsSOZo21GnejiShTXWzzxxybalubae82P4hfLa', &#13;
        'callbackURL'       : 'http://127.0.0.1:3000/login/twitterCallback' &#13;
    } &#13;
} &#13;
</pre><p>We add a <code class="literal">twitterAuth</code> section to our authorization <code class="literal">config</code> file that contains the keys we need as well as the callback. This all is very similar to Facebook.</p></div><div class="section" title="Setting up our Twitter strategy"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec142"/>Setting up our Twitter strategy</h2></div></div></div><p>Now we need to take the steps to build our Twitter strategy.</p><p>First things first, we need to install the Passport Twitter strategy module:</p><pre class="programlisting">
<span class="strong"><strong>$ npm install passport-twitter --save</strong></span>
<span class="strong"><strong>passport-twitter@1.0.4 node_modules/passport-twitter</strong></span>
<span class="strong"><strong>|--- passport-oauth1@1.0.1 (passport-strategy@1.0.0, utils-merge@1.0.0, &#13;
        oauth@0.9.14)</strong></span>
<span class="strong"><strong>|__ xtraverse@0.1.0 (xmldom@0.1.22)</strong></span>
</pre><p>Now create a <code class="literal">twitter.js</code> file inside your Passport directory:</p><pre class="programlisting">var TwitterStrategy = require('passport-twitter').Strategy; &#13;
var User = require('../models/user'); &#13;
var auth = require('../config/authorization'); &#13;
 &#13;
module.exports = function(passport){ &#13;
 &#13;
    passport.use('twitter', new TwitterStrategy({ &#13;
            consumerKey     : auth.twitterAuth.consumerKey, &#13;
            consumerSecret  : auth.twitterAuth.consumerSecret, &#13;
            callbackURL     : auth.twitterAuth.callbackURL &#13;
        }, &#13;
        function(token, tokenSecret, profile, cb) { &#13;
            User.findOne({ 'twitter.id': profile.id }, function (err, user) { &#13;
                if(err){ &#13;
                    return cb(err) &#13;
                } else if (user) { &#13;
                    return cb(null, user); &#13;
                } else { &#13;
                    // if there is no user, create them &#13;
                    var newUser                 = new User(); &#13;
 &#13;
                    // set all of the user data that we need &#13;
                    newUser.twitter.id          = profile.id; &#13;
                    newUser.twitter.token       = token; &#13;
                    newUser.twitter.username    = profile.username; &#13;
                    newUser.twitter.displayName =              &#13;
                                                profile.displayName; &#13;
 &#13;
                    newUser.save(function(err){ &#13;
                        if(err){ &#13;
                            throw err; &#13;
                        }else{ &#13;
                            return cb(null, newUser); &#13;
                        } &#13;
                    }); &#13;
                } &#13;
            }); &#13;
        } &#13;
    )); &#13;
} &#13;
</pre><p>This strategy is very similar to our Facebook strategy. We set up our keys and callback using our authorization config. We then check if a user with the same Twitter ID is already in the database. If not, we create a new user with the data Twitter sends us and save the record to the database.</p><p>Speaking of databases, we now need to make a change to our <code class="literal">User</code> model to handle our Twitter data:</p><pre class="programlisting">var mongoose = require('mongoose'); &#13;
 &#13;
var userSchema = mongoose.Schema({ &#13;
    id: String, &#13;
    email: String, &#13;
    username: String, &#13;
    password: String, &#13;
    firstName: String, &#13;
    lastName: String, &#13;
 &#13;
    facebook: { &#13;
        name: String, &#13;
        id: String, &#13;
        token: String &#13;
    }, &#13;
 &#13;
<span class="strong"><strong>    twitter: {</strong></span>
<span class="strong"><strong>        id: String,</strong></span>
<span class="strong"><strong>        token: String,</strong></span>
<span class="strong"><strong>        username: String,</strong></span>
<span class="strong"><strong>        displayName: String</strong></span>
<span class="strong"><strong>    }</strong></span> &#13;
 &#13;
}); &#13;
module.exports = mongoose.model('User',userSchema); &#13;
</pre><p>Just like with the Facebook section, we add a Twitter property to store the data that we get back from Twitter separately.</p><p>Next, we need to add the routes for Twitter authentication to our <code class="literal">routes/login.js</code> file:</p><pre class="programlisting">var express = require('express'); &#13;
var router = express.Router(); &#13;
 &#13;
 &#13;
module.exports = function(passport){ &#13;
 &#13;
 &#13;
    router.get('/', function(req, res) { &#13;
        res.render('login/login', { message: req.flash('message'), csrfToken: &#13;
        req.csrfToken() }); &#13;
    }); &#13;
 &#13;
 &#13;
    router.post('/', passport.authenticate('login', { &#13;
        successRedirect: '/dash', &#13;
        failureRedirect: '/login', &#13;
        failureFlash : true &#13;
    })); &#13;
 &#13;
 &#13;
    router.get('/signup', function(req, res){ &#13;
        console.log('signing up'); &#13;
        res.render('login/signup',{message: req.flash('message'), csrfToken:&#13;
        req.csrfToken()}); &#13;
    }); &#13;
 &#13;
 &#13;
    router.post('/register', passport.authenticate('signup', { &#13;
        successRedirect: '/dash', &#13;
        failureRedirect: '/login/signup', &#13;
        failureFlash : true &#13;
    })); &#13;
 &#13;
    router.get('/signout', function(req, res) { &#13;
        req.logout(); &#13;
        res.redirect('/login'); &#13;
    }); &#13;
 &#13;
    router.get('/facebook', passport.authenticate('facebook', {scope:&#13;
    ['email']})); &#13;
 &#13;
    router.get('/FBcallback', &#13;
        passport.authenticate('facebook', { successRedirect: '/dash', &#13;
            failureRedirect: '/login' })); &#13;
 &#13;
<span class="strong"><strong>    router.get('/twitter', passport.authenticate('twitter'));&#13;
</strong></span>
<span class="strong"><strong>    // handle the callback after twitter has authenticated the user&#13;
</strong></span>
<span class="strong"><strong>       router.get('/twitterCallback',&#13;
</strong></span>
<span class="strong"><strong>        passport.authenticate('twitter',&#13;
 {&#13;
</strong></span>
<span class="strong"><strong>            successRedirect : '/dash',&#13;
</strong></span>
<span class="strong"><strong>            failureRedirect : '/login'&#13;
</strong></span>
<span class="strong"><strong>        }));</strong></span> &#13;
 &#13;
    return router; &#13;
} &#13;
</pre><p>Again, the Twitter routes are very similar to the routes we use for Facebook authentication. We have the main authorization route and the route we use for callback.</p><p>Now we just need to make a couple of edits to our <code class="literal">passport/init.js </code>file to include the Twitter strategy:</p><pre class="programlisting">var signup = require('./signup'); &#13;
var login = require('./login'); &#13;
var facebook = require('./facebook'); &#13;
<span class="strong"><strong>var twitter = require('./twitter');</strong></span> &#13;
var User = require('../models/user'); &#13;
 &#13;
 &#13;
module.exports = function(passport){ &#13;
 &#13;
 &#13;
    passport.serializeUser(function(user, done) { &#13;
 &#13;
        done(null, user._id); &#13;
    }); &#13;
 &#13;
    passport.deserializeUser(function(id, done) { &#13;
        User.findById(id, function(err, user) { &#13;
 &#13;
            done(err, user); &#13;
        }); &#13;
    }); &#13;
 &#13;
    signup(passport); &#13;
    login(passport); &#13;
    facebook(passport); &#13;
<span class="strong"><strong>    twitter(passport);</strong></span> &#13;
 &#13;
} &#13;
</pre><p>The only changes we need here are to import the Twitter strategy and initialize it. At this point, our Twitter strategy should work. Let's just make it a little easier for our users.</p></div><div class="section" title="Adding Twitter authorization to our home page"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec143"/>Adding Twitter authorization to our home page</h2></div></div></div><p>As with our Facebook strategy, let's add a Twitter login button to our <code class="literal">index.ejs</code> file:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html&gt; &#13;
  &lt;head&gt; &#13;
    &lt;title&gt;&lt;%= title %&gt;&lt;/title&gt; &#13;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt; &#13;
 &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"&gt; &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"&gt; &#13;
 &#13;
  &lt;/head&gt; &#13;
  &lt;body&gt; &#13;
    &lt;div class="container"&gt; &#13;
      &lt;div class="jumbotron"&gt; &#13;
        &lt;h1 class="text-center"&gt;Welcome to Giftapp&lt;/h1&gt; &#13;
        &lt;hr&gt; &#13;
        &lt;p class="text-center"&gt; &#13;
          &lt;a class="btn btn-default btn-lg" href="/login/" role="button"&gt;Log in&lt;/a&gt; &#13;
          &lt;a class="btn btn-default btn-lg" href="/login/signup" role="button"&gt;Sign Up&lt;/a&gt; &#13;
          &lt;a class="btn btn-primary btn-lg" href="/login/facebook" role="button"&gt;Log in or sign up with Facebook&lt;/a&gt; &#13;
<span class="strong"><strong>          &lt;a class="btn btn-primary btn-lg" href="/login/twitter" role="button"&gt;Log in or sign up with Twitter&lt;/a&gt;</strong></span> &#13;
        &lt;/p&gt; &#13;
      &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
  &lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>We've added a Twitter login button.</p><p>Note that to test this, start at <code class="literal">http://127.0.0.1:3000/</code> and not <code class="literal">http://localhost:3000</code>. The reason for this is that you need the domain for the session cookies to match in the callback URL. When you do, you'll see the following:</p><p>
</p><div class="mediaobject"><img src="graphics/image_12_012.jpg" alt="Adding Twitter authorization to our home page"/></div><p>
</p><p>Clicking on the Twitter login button will redirect you to Twitter, which will ask you to log in or authorize for your app:</p><p>
</p><div class="mediaobject"><img src="graphics/image_12_013.jpg" alt="Adding Twitter authorization to our home page"/></div><p>
</p><p>Clicking on <span class="strong"><strong>Sign in</strong></span> should bring you to your dashboard.</p><p>Now that we have logged in with both Facebook and Twitter, let's look at our <code class="literal">users</code> collection on our <code class="literal">giftapp</code> database. Fire up your MongoDB client by typing mongo on your command line:</p><pre class="programlisting">
<span class="strong"><strong>&gt; use giftapp</strong></span>
<span class="strong"><strong>switched to db giftapp</strong></span>
<span class="strong"><strong>&gt; db.users.find({}).pretty()</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  "_id" : ObjectId("56bbdc4308ca9a596f0006d8"),</strong></span>
<span class="strong"><strong>  "email" : "john@thisisafakeemail.com",</strong></span>
<span class="strong"><strong>  "facebook" : {</strong></span>
<span class="strong"><strong>    "name" : "John Moore",</strong></span>
<span class="strong"><strong>    "token" : "CAAJ4pkIxqDgBABrsfsds345435ZAZAE73UZCjehrtjWQ8YhGWVxdoa6VA0OuydPPuQO8wJWBDO4ZCylNX7dMPOJL4VW7WX3nZCLt1b16Mghgdfdg34543543",</strong></span>
<span class="strong"><strong>    "id" : "101539512345670"</strong></span>
<span class="strong"><strong>  },</strong></span>
<span class="strong"><strong>  "__v" : 0</strong></span>
<span class="strong"><strong>}</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  "_id" : ObjectId("56bd252d32d162207ab35be4"),</strong></span>
<span class="strong"><strong>  "twitter" : {</strong></span>
<span class="strong"><strong>    "displayName" : "John Moore",</strong></span>
<span class="strong"><strong>    "username" : "JohnMooreNinja",</strong></span>
<span class="strong"><strong>    "token" : "4867525577-dvlIz4uEZMgMZHFd6tRjhgjhgjgf8WrGv",</strong></span>
<span class="strong"><strong>    "id" : "486633445565657"</strong></span>
<span class="strong"><strong>  },</strong></span>
<span class="strong"><strong>  "__v" : 0</strong></span>
<span class="strong"><strong>}</strong></span>
</pre><p>So, we have two users in our <code class="literal">users</code> collection, one with a set of Facebook credentials, and one with Twitter credentials. You'll notice that the Twitter profile does not include e-mail.</p></div></div>
<div class="section" title="Sharing giftlists"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec67"/>Sharing giftlists</h1></div></div></div><p>Currently, our giftlist functionality doesn't really work. We want users to be able to create giftlists which they can then share.</p><div class="section" title="Fleshing out the giftlist model"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec144"/>Fleshing out the giftlist model</h2></div></div></div><p>Since we're using Mongoose to model data for our users, let's also put it to use to model our <code class="literal">giftlists</code>. Inside your <code class="literal">models</code> folder, create a new file called <code class="literal">giftlist.js</code>:</p><pre class="programlisting">var mongoose = require('mongoose'); &#13;
 &#13;
var giftlistSchema = mongoose.Schema({ &#13;
    id: String, &#13;
    user_id: String, &#13;
    name: String, &#13;
    gifts: [{name: String}] &#13;
    sharedWith [{user_id: String}] &#13;
 &#13;
}); &#13;
module.exports = mongoose.model('Giftlist',giftlistSchema); &#13;
</pre><p>This model is pretty straightforward. A giftlist has an ID, a name, a list of <code class="literal">gift</code> objects, and a <code class="literal">user_id</code> field. We will populate the <code class="literal">user_id</code> with the ID of the user who owns the giftlist. In a relational database, this would be a foreign key, defining a one-to-many relationship between users and giftlists.</p><p>The gifts field is an array of objects expecting only a name property. We also have a list of users with whom we have shared the giftlist. We will leave the sharing functionality for later.</p></div><div class="section" title="Connecting the UI"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec145"/>Connecting the UI</h2></div></div></div><p>The next thing we want to do is to allow users to create new giftlists from our SPA dashboard.</p><p>Since we're going to be POSTing data back via Ajax, we need to do a little work to make the CSRF token available to our Angular application. There are two steps to do this; first, we want to pass the token in our <code class="literal">dashboard.js</code> route:</p><pre class="programlisting">var express = require('express'); &#13;
var router = express.Router(); &#13;
var isAuthenticated = require('../utils/authenticated'); &#13;
 &#13;
router.get('/', isAuthenticated, function(req, res, next) { &#13;
 &#13;
 &#13;
    var db = req.db; &#13;
    var collection = db.get('giftlist'); &#13;
        console.log("routing dash for " + req.user._id); &#13;
    collection.find({'owner_id':req.user._id}, {}, function(err,giftlists){ &#13;
        if(err){ &#13;
            res.send(err); &#13;
        }else { &#13;
            giftlists = giftlists || []; &#13;
<span class="strong"><strong>            res.render('dash/dashboard', {user: req.user, giftlists: giftlists, csrfToken: req.csrfToken()});</strong></span> &#13;
        } &#13;
    }); &#13;
}); &#13;
 &#13;
module.exports = router; &#13;
</pre><p>We pass the token to the render function.</p><p>Next, we will add something to our <code class="literal">dashboard.ejs</code> template:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html ng-app="giftapp"&gt; &#13;
&lt;head &gt; &#13;
    &lt;title&gt;Dashboard for &lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; &lt;/title&gt; &#13;
 &#13;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt; &#13;
 &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"&gt; &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"&gt; &#13;
    &lt;script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"&gt;&lt;/script&gt; &#13;
    &lt;script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.15/angular-ui-router.min.js"&gt;&lt;/script&gt; &#13;
    &lt;script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-resource.js"&gt;&lt;/script&gt; &#13;
 &#13;
 &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
&lt;nav class="nav navbar-default"&gt; &#13;
    &lt;div class="container-fluid"&gt; &#13;
        &lt;div class="navbar-header"&gt; &#13;
            &lt;a class="navbar-brand" href="#"&gt;&lt;%= user.firstName %&gt; &lt;%= user.lastName %&gt; Dashboard&lt;/a&gt; &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/nav&gt; &#13;
 &#13;
 &#13;
&lt;div class="container"&gt; &#13;
 &#13;
    &lt;div ui-view&gt;&lt;/div&gt; &#13;
&lt;/div&gt; &#13;
&lt;script src="/javascripts/controllers/dashMainController.js"&gt;&lt;/script&gt; &#13;
<span class="strong"><strong>&lt;script src="/javascripts/controllers/giftappFormController.js"&gt;&lt;/script&gt;</strong></span> &#13;
&lt;script src="/javascripts/services/giftlistFactory.js"&gt;&lt;/script&gt; &#13;
<span class="strong"><strong>&lt;script&gt;</strong></span>
<span class="strong"><strong>    angular.module("csrfValue", [])&#13;
</strong></span>
<span class="strong"><strong>            .value("csrfToken","&lt;%= csrfToken %&gt;");</strong></span>
<span class="strong"><strong>&lt;/script&gt;</strong></span> &#13;
&lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>We create a new Angular module inside our page and add a value to it. A value is basically an injectable name value pair we can use in our application. We do this in the dashboard template, because we need the server to provide the <code class="literal">csrfToken</code> to the UI.</p><p>We've also added a script tag to load a new controller script file that we will use to handle processing and submitting the form.</p></div><div class="section" title="Connecting the form"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec146"/>Connecting the form</h2></div></div></div><p>Next, we need to connect the giftlist form to the controller and have the controller talk to the backend.</p><div class="section" title="Creating the controller"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec157"/>Creating the controller</h3></div></div></div><p>Create a new file in your <code class="literal">javascripts/controllers</code> directory called <code class="literal">giftappFormController.js</code>:</p><pre class="programlisting">angular.module('giftappControllers') &#13;
    .controller('GiftappFormController', ['$scope','List','csrfToken', '$state', function($scope, List, csrfToken, $state) { &#13;
        $scope.formData = {}; &#13;
        $scope.formData.items = []; &#13;
        $scope.formData._csrf = csrfToken; &#13;
 &#13;
 &#13;
        $scope.create = function() { &#13;
            console.log("create"); &#13;
            var myList = new List($scope.formData); &#13;
            myList.$save(function(giftList){ &#13;
                console.log(giftList); &#13;
                $state.go('dash'); &#13;
            }); &#13;
 &#13;
        } &#13;
    }]); &#13;
</pre><p>We add a new controller into our <code class="literal">giftappControllers</code> module. We inject a number of things into the controller, including our List resource, and $state. We're also injecting <code class="literal">csrfToken</code>. We don't have access to that quite yet, but we'll inject its module into our module in a bit.</p><p>Inside the controller, we set up an object on <code class="literal">$scope</code> called <code class="literal">formData</code>. This will hold the data entered by a user on our form. We also add a function to scope, called <code class="literal">create</code>, which will be invoked when a user submits the form. We create a new instance of our List resource, add our data to it, and save it to the backend. After saving, we trigger a state change to return to the dashboard.</p><p>Since our module is actually defined <code class="literal">insidedashMainController</code>.<code class="literal">js</code>, this is where we want to inject the module containing our <code class="literal">csrfToken</code> value:</p><pre class="programlisting">
<span class="strong"><strong>angular.module('giftappControllers',['giftlistServices','csrfValue'])</strong></span> &#13;
    .controller('DashMainController', ['$scope','List', function($scope,List) { &#13;
        $scope.lists = List.query(); &#13;
 &#13;
    }]); &#13;
</pre><p>Simply by adding the name of the module to our module's dependencies, we get access to the value service inside our module.</p></div><div class="section" title="Angularizing the form"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec158"/>Angularizing the form</h3></div></div></div><p>The next thing we need to do is to add some AngularJS directives to our template at <code class="literal">public/templates/dash-add.tpl.html</code>:</p><pre class="programlisting">&lt;div class="row"&gt; &#13;
    &lt;div class="col-md-12"&gt; &#13;
        &lt;h2&gt;Add a new list&lt;/h2&gt; &#13;
<span class="strong"><strong>        &lt;form class="form-horizontal" ng-submit="create()"&gt;</strong></span> &#13;
            &lt;div class="form-group"&gt; &#13;
                &lt;label for="listname" class="col-sm-2 control-label"&gt;List &#13;
                 Name&lt;/label&gt; &#13;
                &lt;div class="col-sm-10"&gt; &#13;
<span class="strong"><strong>                    &lt;input type="text" class="form-control" id="listname"&#13;
                     placeholder="Name" ng-model="formData.name"&gt;</strong></span> &#13;
                &lt;/div&gt; &#13;
            &lt;/div&gt; &#13;
            &lt;div class="form-group"&gt; &#13;
                &lt;label class="col-sm-2 control-label"&gt;Item 1&lt;/label&gt; &#13;
                &lt;div class="col-sm-10"&gt; &#13;
<span class="strong"><strong>                    &lt;input type="text" class="form-control" ng-&#13;
                     model="formData.items[0]"&gt;</strong></span> &#13;
                &lt;/div&gt; &#13;
            &lt;/div&gt; &#13;
            &lt;div class="form-group"&gt; &#13;
                &lt;label class="col-sm-2 control-label"&gt;Item 2&lt;/label&gt; &#13;
                &lt;div class="col-sm-10"&gt; &#13;
<span class="strong"><strong>                    &lt;input type="text" class="form-control" ng-&#13;
                     model="formData.items[1]"&gt;</strong></span> &#13;
                &lt;/div&gt; &#13;
            &lt;/div&gt; &#13;
            &lt;div class="form-group"&gt; &#13;
                &lt;label class="col-sm-2 control-label"&gt;Item 3&lt;/label&gt; &#13;
                &lt;div class="col-sm-10"&gt; &#13;
<span class="strong"><strong>                    &lt;input type="text" class="form-control" ng-&#13;
                     model="formData.items[2]"&gt;</strong></span> &#13;
                &lt;/div&gt; &#13;
            &lt;/div&gt; &#13;
            &lt;div class="form-group"&gt; &#13;
                &lt;div class="col-sm-offset-2 col-sm-10"&gt; &#13;
                    &lt;button type="submit" class="btn btn-default btn-lg btn-&#13;
                     block"&gt; &#13;
                        &lt;span class="glyphicon glyphicon-flash"&gt;&lt;/span&gt; Create&#13;
                          List &#13;
                    &lt;/button&gt; &#13;
                &lt;/div&gt; &#13;
            &lt;/div&gt; &#13;
        &lt;/form&gt; &#13;
<span class="strong"><strong>        {{formData}}</strong></span> &#13;
    &lt;/div&gt; &#13;
 &#13;
&lt;/div&gt; &#13;
</pre><p>The first change is adding the <code class="literal">ng-submit</code> directive to the form. On submitting the form, the controller's <code class="literal">$scope.create()</code> function will be invoked.</p><p>We then connect the inputs to the <code class="literal">$scope.formdata</code> using <code class="literal">ng-model</code> directives. This creates two-way data binding. To demonstrate this, we add <code class="literal">{{formData}}</code> into the template. This will show you all the data held by <code class="literal">$scope.formdata</code> and is a great way to troubleshoot your form. Obviously it's not something you'd leave in the template in production.</p></div><div class="section" title="Connecting to the backend controller"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec159"/>Connecting to the backend controller</h3></div></div></div><p>Now that our form is connected to our controller, we need to connect our controller to our backend to store and retrieve our data from the database. Open your <code class="literal">controllers/giftlist_controller.js</code> file:</p><pre class="programlisting">var Giftlist = require('../models/giftlist'); &#13;
 &#13;
exports.index = function(req, res){ &#13;
 &#13;
        Giftlist.find({'user_id':req.user._id}, {}, function(err,giftlists){ &#13;
            if(err){ &#13;
                res.send(err); &#13;
            }else if(giftlists){ &#13;
                res.json(giftlists); &#13;
 &#13;
            }; &#13;
        }); &#13;
 &#13;
 &#13;
}; &#13;
 &#13;
 &#13;
 &#13;
exports.create = function(req, res){ &#13;
    var newGiftlist = new Giftlist(); &#13;
    newGiftlist.name = req.body.name; &#13;
    newGiftlist.user_id = req.user._id; &#13;
 &#13;
    var gifts = []; &#13;
    req.body.items.forEach(function(item){ &#13;
        gifts.push({name:item}); &#13;
    }); &#13;
    newGiftlist.gifts = gifts; &#13;
 &#13;
    newGiftlist.save(function(err){ &#13;
        if(err){ &#13;
            throw err &#13;
        } else { &#13;
            res.json(newGiftlist); &#13;
        } &#13;
    }); &#13;
 &#13;
}; &#13;
 &#13;
exports.show = function(req, res){ &#13;
    Giftlist.findOne({_id:req.params.id}, function(err, list){ &#13;
        if(req.params.format == "json" || req.isJSON){ &#13;
            res.json(list); &#13;
        }else{ &#13;
            res.render('giftlist/show',{giftlist:list}); &#13;
        } &#13;
    }); &#13;
 &#13;
}; &#13;
</pre><p>We require in our <code class="literal">giftlist</code> model, and we've edited the index, show, and create routes to take advantage of the Mongoose database functions. Because we want to be able to share lists easily with people who aren't logged into our dashboard, non-JSON requests to show are going to render in a separate page.</p><p>Inside your views directory, create a new <code class="literal">giftlist</code> directory and create a template called <code class="literal">show.ejs</code>:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html&gt; &#13;
&lt;head&gt; &#13;
    &lt;title&gt;Show Users&lt;/title&gt; &#13;
    &lt;link rel='stylesheet' href='/stylesheets/style.css' /&gt; &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
&lt;h1&gt;User List: &lt;%= appName %&gt;&lt;/h1&gt; &#13;
 &#13;
&lt;table&gt; &#13;
    &lt;thead&gt; &#13;
        &lt;tr&gt; &#13;
 &#13;
            &lt;th&gt;First Name&lt;/th&gt; &#13;
            &lt;th&gt;Last Name&lt;/th&gt; &#13;
            &lt;th&gt;Email Address&lt;/th&gt; &#13;
            &lt;th&gt;Dashboard&lt;/th&gt; &#13;
        &lt;/tr&gt; &#13;
    &lt;/thead&gt; &#13;
    &lt;tbody&gt; &#13;
    &lt;% users.forEach(function(user, index){ -%&gt; &#13;
        &lt;tr&gt; &#13;
            &lt;td&gt;&lt;a href="show/&lt;%= user._id%&gt; "&gt;&lt;%= user.firstName %&gt;&lt;/a&gt;&lt;/td&gt; &#13;
            &lt;td&gt;&lt;%= user.lastName %&gt;&lt;/td&gt; &#13;
            &lt;td&gt;&lt;%= user.email %&gt;&lt;/td&gt; &#13;
            &lt;td&gt;&lt;a href="/dash/&lt;%= user._id %&gt;"&gt;View&lt;/a&gt;&lt;/td&gt; &#13;
        &lt;/tr&gt; &#13;
    &lt;% }); %&gt; &#13;
    &lt;/tbody&gt; &#13;
&lt;/table&gt; &#13;
 &#13;
 &#13;
&lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>This is a pretty straightforward template that renders the list name and the gifts on the list.</p></div></div><div class="section" title="Adding the ability to share lists on social media"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec147"/>Adding the ability to share lists on social media</h2></div></div></div><p>Next, we want to allow users to easily share their lists. We need to make a minor adjustment to the <code class="literal">dash-main</code> template:</p><pre class="programlisting">&lt;div class="row"&gt; &#13;
    &lt;div class="col-xs-12 col-md-6"&gt; &#13;
        &lt;h2&gt;My Lists&lt;/h2&gt; &#13;
 &#13;
        &lt;a class="btn btn-primary" role="button" ui-sref="add" href="#/add"&gt; &#13;
            &lt;span class="glyphicon glyphicon-plus" aria-hidden="true"&gt;&lt;/span&gt; &#13;
            Add List&lt;/a&gt; &#13;
        &lt;ul class="list-unstyled"&gt; &#13;
<span class="strong"><strong>            &lt;li ng-repeat="list in lists"&gt;&lt;a class="btn btn-link" &#13;
             href="/giftlist/{{list._id}}" role="button"&gt;{{ list.name }}&lt;/a&gt;&lt;/li&gt;</strong></span> &#13;
 &#13;
 &#13;
        &lt;/ul&gt; &#13;
    &lt;/div&gt; &#13;
 &#13;
    &lt;div class="col-xs-12 col-md-6"&gt; &#13;
        &lt;h2&gt;Lists Shared With Me&lt;/h2&gt; &#13;
    &lt;/div&gt; &#13;
&lt;/div&gt; &#13;
</pre><p>The URL we've added to the link will trigger the show route in our controller, passing it the ID of the list we want to show.</p><p>Next, we'll add sharing buttons to our <code class="literal">giftlist/show.ejs</code> template:</p><pre class="programlisting">&lt;!DOCTYPE html&gt; &#13;
&lt;html&gt; &#13;
&lt;head &gt; &#13;
    &lt;title&gt;Giftlist: &lt;%= giftlist.name %&gt;&lt;/title&gt; &#13;
 &#13;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt; &#13;
 &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"&gt; &#13;
    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"&gt; &#13;
 &#13;
<span class="strong"><strong>    &lt;!-- You can use open graph tags to customize link previews.&#13;
</strong></span>
<span class="strong"><strong>    Learn more: https://developers.facebook.com/docs/sharing/webmasters --&gt;&#13;
</strong></span>
<span class="strong"><strong>    &lt;meta property="og:url"&#13;
           content="http://localhost:3000/giftlist/&lt;%= giftlist._id %&gt;" /&gt;&#13;
</strong></span>
<span class="strong"><strong>    &lt;meta property="og:type"&#13;
          content="website" /&gt;&#13;
</strong></span>
<span class="strong"><strong>    &lt;meta property="og:title"&#13;
          content="Giftlist App" /&gt;&#13;
</strong></span>
<span class="strong"><strong>    &lt;meta property="og:description"&#13;
         content="&lt;%= giftlist.name %&gt;" /&gt;</strong></span> &#13;
  &#13;
 &#13;
&lt;/head&gt; &#13;
&lt;body&gt; &#13;
<span class="strong"><strong>&lt;div id="fb-root"&gt;&lt;/div&gt;</strong></span>
<span class="strong"><strong>&lt;script&gt;(function(d, s, id)&#13;
 {&#13;
</strong></span>
<span class="strong"><strong>        var js, fjs = d.getElementsByTagName(s)[0];&#13;
</strong></span>
<span class="strong"><strong>        if (d.getElementById(id)) return;&#13;
</strong></span>
<span class="strong"><strong>        js = d.createElement(s); js.id = id;&#13;
</strong></span>
<span class="strong"><strong>        js.src =&#13;
 "//connect.facebook.net/en_US/sdk.js#xfbml=1&amp;version=v2.5&amp;appId=228887303845448";&#13;
</strong></span>
<span class="strong"><strong>        fjs.parentNode.insertBefore(js, fjs);&#13;
</strong></span>
<span class="strong"><strong>    }&#13;
(document, 'script', 'facebook-jssdk'));&#13;
&lt;/script&gt;</strong></span>
<span class="strong"><strong>&lt;nav class="nav navbar-default"&gt;&#13;
</strong></span>
<span class="strong"><strong>    &lt;div class="container-fluid"&gt;&#13;
</strong></span>
<span class="strong"><strong>        &lt;div class="navbar-header"&gt;&#13;
</strong></span>
<span class="strong"><strong>            &lt;a class="navbar-brand" href="#"&gt;Giftlist&lt;/a&gt;&#13;
</strong></span>
<span class="strong"><strong>        &lt;/div&gt;&#13;
</strong></span>
<span class="strong"><strong>    &lt;/div&gt;&#13;
</strong></span>
<span class="strong"><strong>&lt;/nav&gt;</strong></span> &#13;
 &#13;
 &#13;
&lt;div class="container"&gt; &#13;
    &lt;h1&gt;&lt;%= giftlist.name %&gt;&lt;/h1&gt; &#13;
 &#13;
    &lt;div class="row"&gt; &#13;
        &lt;div class="col-md-12"&gt; &#13;
            &lt;ul&gt; &#13;
                &lt;% giftlist.gifts.forEach(function(gift, index){ -%&gt; &#13;
                &lt;li&gt;&lt;%= gift.name %&gt;&lt;/li&gt; &#13;
                &lt;% }); -%&gt; &#13;
            &lt;/ul&gt; &#13;
<span class="strong"><strong>            &lt;a href="https://twitter.com/share" class="twitter-share-button" data-via="JohnMooreNinja" data-size="large" data-hashtags="giftapp"&gt;Tweet&lt;/a&gt;</strong></span>
<span class="strong"><strong>            &lt;script&gt;!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');&#13;
&lt;/script&gt;&#13;
</strong></span>
<span class="strong"><strong>            &lt;div class="fb-like"&gt;&lt;/div&gt;</strong></span> &#13;
 &#13;
        &lt;/div&gt; &#13;
    &lt;/div&gt; &#13;
 &#13;
 &#13;
&lt;/div&gt; &#13;
 &#13;
 &#13;
&lt;/body&gt; &#13;
&lt;/html&gt; &#13;
</pre><p>We add some open graph tags, and some code to enable Twitter and Facebook sharing.</p><p>Twitter has a neat form-based wizard to set up Twitter sharing buttons. You can find it at
<a class="ulink" href="https://about.twitter.com/resources/buttons#tweet">https://about.twitter.com/resources/buttons#tweet</a>.
You'll want to configure the Facebook button specifically for your app ID. Facebook also has a form-based configuration tool, at
<a class="ulink" href="https://developers.facebook.com/docs/plugins/like-button">https://developers.facebook.com/docs/plugins/like-button</a>.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec68"/>Summary</h1></div></div></div><p>We began this chapter by setting up Passport strategies for authenticating with Facebook and Twitter. Setting up developer accounts with each social media site is a straightforward, but necessary, step.</p><p>We then utilized our <code class="literal">Mongoose Giftlist</code> model, as well as our resourceful controller, to enable creating gift lists from within the SPA. We enabled the frontend code and AJAX functionality by building a new AngularJS controller. To be able to post data to the backend, we added an injectable value service to carry the CSRF token.</p><p>There are a few things we leave to you to round out the application. This includes a way to add more gift inputs dynamically, and share lists with other registered users.</p></div></body></html>