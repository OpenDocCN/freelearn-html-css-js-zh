<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Adding Sound Effects to Your Games</h1></div></div></div><p>
<em>In the earlier chapters, we discussed several techniques to draw game objects visually. In this chapter, we will focus on using the <code class="literal">audio</code> tag that is introduced in the HTML5 specification. We can add sound effects, background music, and control the audio through the JavaScript API. In addition, we will build a music game in this chapter. It is a game that requires players to hit the correct string at the right time to produce the music.</em>
</p><p>In this chapter, you will learn the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Adding a sound effect to the <strong>Play</strong> button</li><li class="listitem" style="list-style-type: disc">Building a mini piano musical game</li><li class="listitem" style="list-style-type: disc">Linking the music game and the <strong>Play</strong> button</li><li class="listitem" style="list-style-type: disc">Adding keyboard and touch inputs to the game</li><li class="listitem" style="list-style-type: disc">Creating a keyboard-driven music game</li><li class="listitem" style="list-style-type: disc">Completing the musical game with a level data recording and the game over event</li></ul></div><p>You can play the game<a id="id503" class="indexterm"/> example at: <a class="ulink" href="http://makzan.net/html5-games/audiogame/">http://makzan.net/html5-games/audiogame/</a>.</p><p>The following screenshot shows the final result we will create through this chapter:</p><div><img src="img/B04290_06_01.jpg" alt="Adding Sound Effects to Your Games"/></div><p>So, let's get on with it.</p><div><div><div><div><h1 class="title"><a id="ch06lvl1sec69"/>Adding a sound effect to the Play button</h1></div></div></div><p>We had several mouse<a id="id504" class="indexterm"/> interactions in the Untangle game examples in<a id="id505" class="indexterm"/> previous chapters. Now imagine that we want to have sound effects with the mouse interaction. This requires us to instruct the game about the audio file to be used. We will use the <code class="literal">audio</code> tag to create a sound effect when a button is clicked.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec70"/>Time for action – adding sound effects to the Play button</h1></div></div></div><p>We will start with the code example available in the code bundle. We will have a folder structure similar to the one shown in the following screenshot:</p><div><img src="img/B04290_06_02.jpg" alt="Time for action – adding sound effects to the Play button"/></div><p>Perform the following set of<a id="id506" class="indexterm"/> steps to add sound effects to the <strong>Play</strong> <a id="id507" class="indexterm"/>button:</p><div><ol class="orderedlist arabic"><li class="listitem">The <code class="literal">index.html</code> file contains the basic structure of the HTML. Now let's add the following code to the body section of the <code class="literal">index.html</code> file:<div><pre class="programlisting">   &lt;div id="game"&gt;
     &lt;section id="menu-scene" class="scene"&gt;
       &lt;a href="#game"&gt;&lt;span&gt;Play&lt;/span&gt;&lt;/a&gt;
     &lt;/section&gt;
   &lt;/div&gt;
   &lt;audio id="buttonover"&gt;
     &lt;source src="img/button_over.aac" /&gt;
     &lt;source src="img/button_over.ogg" /&gt;
   &lt;/audio&gt;
   &lt;audio id="buttonactive"&gt;
     &lt;source src="img/button_active.aac" /&gt;
     &lt;source src="img/button_active.ogg" /&gt;
   &lt;/audio&gt;</pre></div></li><li class="listitem">The HTML file runs successfully with a stylesheet. The file can be found in the code bundle named <code class="literal">audiogame.css</code>.</li><li class="listitem">Next, we create the basic code structure in the JavaScript file. Add the following JavaScript in the <code class="literal">audiogame.js</code> file:<div><pre class="programlisting">(function($){
  var audiogame = {
    // game init method
    initGame: function() {
      this.initMedia();
      this.handlePlayButton();
    },
    // init medias
    initMedia: function() {
       // TODO: init media related logic
    },

    handlePlayButton: function() {
      // TODO: logic for the play button
    }

  };

  // init function when the DOM is ready
  $(function(){
    audiogame.initGame();
  });
})(jQuery);</pre></div></li><li class="listitem">Then we store the <a id="id508" class="indexterm"/>references of the audio tags. Add <a id="id509" class="indexterm"/>the following code inside the <code class="literal">initMedia</code> function:<div><pre class="programlisting">initMedia: function() {
  // get the references of the audio element.
  this.buttonOverSound = document.getElementById("buttonover");
  this.buttonOverSound.volume = 0.3;
  this.buttonActiveSound = document.getElementById("buttonactive");
  this.buttonActiveSound.volume = 0.3;
},</pre></div></li><li class="listitem">We add a sound effect to the button in the JavaScript file. Add the following JavaScript inside the <code class="literal">handlePlayButton</code> function:<div><pre class="programlisting">handlePlayButton: function() {
  var game = this;

  // listen the button event that links to #game
  $("a[href='#game']")
  .hover(function(){
    game.buttonOverSound.currentTime = 0;
    game.buttonOverSound.play();
  },function(){
    game.buttonOverSound.pause();
  })
  .click(function(){
    game.buttonActiveSound.currentTime = 0;
    game.buttonActiveSound.play();

    return false;
  });
}</pre></div></li><li class="listitem">Open the <code class="literal">index.html</code> file in a browser. There, you should see a <strong>PLAY</strong> button on a yellow <a id="id510" class="indexterm"/>background, as shown in the following <a id="id511" class="indexterm"/>screenshot. Try to move the mouse on the button and click on it. You should be able to hear a sound when you hover over the button and another sound when you click on it:<div><img src="img/B04290_06_03.jpg" alt="Time for action – adding sound effects to the Play button"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec143"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just created a basic HTML5 game layout with a play button placed in the middle of the page. The JavaScript file handles the mouse hover and clicks of the button and plays corresponding sound effects.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec144"/>Defining an audio element</h2></div></div></div><p>The easiest way to <a id="id512" class="indexterm"/>use the <code class="literal">audio</code> tag is by providing a source file. The following code snippet shows how we can define an audio element:</p><div><pre class="programlisting">&lt;audio&gt;
  &lt;source src="img/button_active.aac" &gt;
  &lt;source src="img/button_active.ogg" &gt;
  &lt;!-- Any code for browser that does not support audio tag --&gt;
&lt;/audio&gt;</pre></div><p>Besides setting the <a id="id513" class="indexterm"/>source file of the <code class="literal">audio</code> tag, we can have additional controls by using several attributes. The following table shows the attributes we can set for <a id="id514" class="indexterm"/>the audio element:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Arguments</p>
</th><th style="text-align: left" valign="bottom">
<p>Definition</p>
</th><th style="text-align: left" valign="bottom">
<p>Explanation</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">src</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Defines the source file of the audio element</p>
</td><td style="text-align: left" valign="top">
<p>When<a id="id515" class="indexterm"/> we use the <code class="literal">src</code> attribute in the <code class="literal">audio</code> tag, it specifies one source file for the audio file. For example, we load a sound effect Ogg file in the following code:</p>
<p>
</p><div><pre class="programlisting">&lt;audio src='sound.ogg'&gt;</pre></div><p>
</p>
<p>If we want to specify multiple files with different formats, then we use the <code class="literal">source</code> tag inside the audio element. The following code specifies the <code class="literal">audio</code> tag with different formats to support different web browsers:</p>
<p>
</p><div><pre class="programlisting">&lt;audio&gt;
   &lt;source src='sound.ogg'&gt;
   &lt;source src='sound.aac'&gt;
   &lt;source src='sound.wav'&gt;
&lt;/audio&gt;</pre></div><p>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">autoplay</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies that the audio plays automatically once it is loaded</p>
</td><td style="text-align: left" valign="top">
<p>Autoplay<a id="id516" class="indexterm"/> is used as a standalone attribute. This means that there is no difference in the following two lines of code:</p>
<p>
</p><div><pre class="programlisting">&lt;audio src='file.ogg' autoplay&gt;
&lt;audio src='file.ogg autoplay="autoplay"&gt;</pre></div><p>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">loop</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies that the audio plays from the beginning again after playback finishes</p>
</td><td style="text-align: left" valign="top">
<p>This is<a id="id517" class="indexterm"/> also used as a standalone attribute.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">preload</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies that the audio source is loaded once the page is loaded</p>
</td><td style="text-align: left" valign="top">
<p>The<a id="id518" class="indexterm"/> <code class="literal">preload</code> attribute takes either of the following values:</p>
<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">preload="auto"</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">preload="metadata</code>"</li><li class="listitem" style="list-style-type: disc"><code class="literal">preload="none"</code></li></ul></div>
<p>When <code class="literal">preload</code> is used as a standalone attribute and set to <code class="literal">auto</code>, the browser will preload the audio.</p>
<p>When <code class="literal">preload</code> is set as <code class="literal">metadata</code>, the browser will not preload the content of the audio. However, it will load the metadata of the audio, such as the duration and size.</p>
<p>When <code class="literal">preload</code> is set to <code class="literal">none</code>, the browser will not<a id="id519" class="indexterm"/> preload the audio at all. The content and metadata is loaded once it is played.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">controls</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Shows the playback control of the audio</p>
</td><td style="text-align: left" valign="top">
<p>The<a id="id520" class="indexterm"/> <code class="literal">controls</code> attribute is a standalone attribute. It instructs the browser to show a playback control in the audio position.</p>
</td></tr></tbody></table></div><p>The following screenshot shows the<a id="id521" class="indexterm"/> Chrome display controls:</p><div><img src="img/B04290_06_04.jpg" alt="Defining an audio element"/></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec145"/>Playing a sound</h2></div></div></div><p>We can get the reference of the <a id="id522" class="indexterm"/>audio element by calling the <code class="literal">getElementById</code> function. Then, we play it by calling the <code class="literal">play</code> function. The following code plays the <code class="literal">buttonactive</code> audio:</p><div><pre class="programlisting">&lt;audio id="buttonactive"&gt;
  &lt;source src="img/button_active.aac" /&gt;
  &lt;source src="img/button_active.ogg" /&gt;
&lt;/audio&gt;
&lt;script&gt;
  document.getElementById("buttonactive").play();
&lt;/script&gt;</pre></div><p>The <code class="literal">play</code> function plays the audio from the elapsed time, which is stored in the <code class="literal">currentTime</code> property. The default value of <code class="literal">currentTime</code> is zero. The following code plays the audio from 3.5 seconds:</p><div><pre class="programlisting">document.getElementById("buttonactive").currentTime = 3.5;
document.getElementById("buttonactive").play();</pre></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec146"/>jQuery's selector versus browser selector</h2></div></div></div><p>We were using jQuery's <a id="id523" class="indexterm"/>query selector <code class="literal">$("#buttonactive")</code> to select <a id="id524" class="indexterm"/>an element. We were applying DOM manipulation to those selected elements, such as toggling classes, or getting text content. In this example, we use <code class="literal">document.getElementById("buttonactive")</code> to get the reference of the element. That's because we are using the browser's Web Audio API on the element. We don't want the jQuery object, we want the browser DOM element.</p><p>An alternative way is to select the element via jQuery and use its <code class="literal">.get()</code> method to retrieve the DOM elements of the jQuery object.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec147"/>Pausing a sound</h2></div></div></div><p>Similar to the play<a id="id525" class="indexterm"/> button, we can also pause the playback of an audio element by using the <code class="literal">pause</code> function. The following code pauses the <code class="literal">buttonactive</code> audio element:</p><div><pre class="programlisting">&lt;script&gt;
  document.getElementById("buttonactive").pause();
&lt;/script&gt;</pre></div><div><div><h3 class="title"><a id="note20"/>Note</h3><p>There is no <code class="literal">stop</code> function to stop the audio element. Instead, we can pause the audio and <a id="id526" class="indexterm"/>reset the <code class="literal">currentTime</code> property of the element to zero. The following code shows how we can stop an audio element:</p><div><pre class="programlisting">function stopAudio(){
  document.getElementById("buttonactive").pause();
  document.getElementById("buttonactive").currentTime = 0;
}</pre></div></div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec148"/>Adjusting the sound volume</h2></div></div></div><p>We can also set the <a id="id527" class="indexterm"/>volume of the audio element. The volume<a id="id528" class="indexterm"/> must range between 0 and 1. We can set the volume to 0 to mute it, and set it to 1 for the maximum volume. The following code snippet sets the volume of the <code class="literal">buttonactive</code> audio to 30%:</p><div><pre class="programlisting">document.getElementById("buttonactive").volume = 0.3;</pre></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec149"/>Using the jQuery hover event</h2></div></div></div><p>jQuery provides a <code class="literal">hover</code> function<a id="id529" class="indexterm"/> to define the behavior when we mouse over and mouse out a DOM element. Here is how we use the <code class="literal">hover</code> function:</p><div><pre class="programlisting">.hover(handlerIn, handlerOut);</pre></div><p>The arguments of the <code class="literal">hover</code> function<a id="id530" class="indexterm"/> are explained as follows:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Arguments</p>
</th><th style="text-align: left" valign="bottom">
<p>Discussion</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">handlerIn</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The<a id="id531" class="indexterm"/> function is executed when the mouse moves in.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">handlerOut</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is <a id="id532" class="indexterm"/>optional. The function is executed when the mouse moves out. When this function is not provided, the move out behavior is the same as the first function.</p>
</td></tr></tbody></table></div><p>In the following code, we'll play the mouse over sound effect when moving the mouse in and will pause the sound during mouse out:</p><div><pre class="programlisting">$("a[href='#game']").hover(function(){
   audiogame.buttonOverSound.currentTime = 0;
   audiogame.buttonOverSound.play();
},function(){
   audiogame.buttonOverSound.pause();
});</pre></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec150"/>File format for WebAudio</h2></div></div></div><p>We use an <strong>AAC</strong>
<a id="id533" class="indexterm"/> format<a id="id534" class="indexterm"/> and the <strong>Ogg</strong> format<a id="id535" class="indexterm"/> file when we define the source of the audio element. Ogg is a free and open source media container format that is supported in Mozilla Firefox. There are <a id="id536" class="indexterm"/>applications that convert audio files into Ogg<a id="id537" class="indexterm"/> files. Audacity is one of these. Also, there are online tools that are convenient to use. Online-Convert<a id="id538" class="indexterm"/> (<a class="ulink" href="http://audio.online-convert.com">http://audio.online-convert.com</a>) is<a id="id539" class="indexterm"/> one of them.</p><div><div><h3 class="title"><a id="note21"/>Note</h3><p>We didn't use the MP3 format because of the license costs. The royalty rates to use an MP3 in a distributed game is $2500 per game once there are more than 5,000 distributed copies, according to the MP3 license<a id="id540" class="indexterm"/> website (<a class="ulink" href="http://www.mp3licensing.com/royalty/games.html">http://www.mp3licensing.com/royalty/games.html</a>).</p></div></div><p>The following table shows the audio <a id="id541" class="indexterm"/>formats supported by the latest popular web browsers at the time of writing this book:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Browser</p>
</th><th style="text-align: left" valign="bottom">
<p>Ogg</p>
</th><th style="text-align: left" valign="bottom">
<p>AAC</p>
</th><th style="text-align: left" valign="bottom">
<p>WAV</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Firefox</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Safari</p>
</td><td style="text-align: left" valign="top">
<p>-</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Chrome</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Opera</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Internet Explorer</p>
</td><td style="text-align: left" valign="top">
<p>-</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>-</p>
</td></tr></tbody></table></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec151"/>Pop quiz – using the audio tag</h2></div></div></div><p>Q1. How can we stop an <code class="literal">audio</code> element playing?</p><div><ol class="orderedlist arabic"><li class="listitem">Use the <code class="literal">stop</code> function.</li><li class="listitem">Use the <code class="literal">pause</code> function and reset the value of <code class="literal">currentTime</code> to <code class="literal">0</code>.</li><li class="listitem">Reset the value of <code class="literal">currentTime</code> to <code class="literal">0</code>.</li></ol></div><p>Q2. How can we put fallback content to display in browsers that do not support <code class="literal">audio</code> tags?</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec71"/>Building a mini piano musical game</h1></div></div></div><p>Imagine now that we are not <a id="id542" class="indexterm"/>only playing a sound effect, but also playing a full song with the <code class="literal">audio</code> tag. Along with the song playing, there are some music dots moving downwards as a visualization of the music.</p></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec72"/>Time for action – creating a basic background for the music game</h1></div></div></div><p>First, we will draw a <a id="id543" class="indexterm"/>few paths in the Canvas as the<a id="id544" class="indexterm"/> background of the music playback.</p><div><ol class="orderedlist arabic"><li class="listitem">We will continue working with our example and draw the background. Open the <code class="literal">index.html</code> file in a text editor and add the following highlighted code that defines the game scene with two Canvases set up:<div><pre class="programlisting">&lt;div id="game"&gt;
  &lt;div id="menu-scene" class="scene"&gt;
    &lt;a href="#game"&gt;&lt;span&gt;Play&lt;/span&gt;&lt;/a&gt;
  &lt;/div&gt;

  &lt;div id="game-scene" class="scene"&gt;
    &lt;canvas id="game-canvas" width="320" height="440"&gt;
      This is an interactive audio game with some music notes moving from top to bottom.
    &lt;/canvas&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">We added a game scene in the HTML file. We want to put it on top of the menu scene, so we style the game scene to have an <code class="literal">absolute</code> position by adding the following to <code class="literal">audiogame.css</code>:<div><pre class="programlisting">#game {
  position: relative;
  width: 320px;
  height: 440px;
  overflow: hidden;
}
.scene {
  position: absolute;
  width: 100%;
  height: 100%;
}

#menu-scene {
  background: url(../images/menu_bg.png);
  display: flex;
  justify-content: center;
  align-items: center;
}

#game-scene {
  background: url(../images/game_bg.png);
  top: -440px;
}

#game-scene.show-scene {
  top: 0;
  transition: top 0.3s ease-out;
}</pre></div></li><li class="listitem">Now, we will <a id="id545" class="indexterm"/>move on to the <a id="id546" class="indexterm"/>JavaScript part. Open the <code class="literal">html5games.audio.js</code> JavaScript file.</li><li class="listitem">In the <strong>Play</strong> button click handler, we add the following highlighted code:<div><pre class="programlisting">$("a[href='#game']").click(function(){
   // existing code here.

   $("#game-scene").addClass('show-scene');
   return false;
});</pre></div></li></ol></div><p>Save all files and open the <code class="literal">index.html</code> in a browser. There should be a slide-in animation to show the music playback scene when we click on the <strong>Play</strong> button. The following screenshot sequence shows the slide-in animation:</p><div><img src="img/B04290_06_05.jpg" alt="Time for action – creating a basic background for the music game"/></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec152"/>
<em>What just happened?</em>
</h2></div></div></div><p>We created a<a id="id547" class="indexterm"/> game scene with Canvas. In<a id="id548" class="indexterm"/> this music game example, we introduced basic scene management in HTML5 games. We created a transition that links between the menu scene and the game scene.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec153"/>Creating scenes in games</h2></div></div></div><p>Creating <strong>scenes</strong> in a game is <a id="id549" class="indexterm"/>similar to creating <strong>layers</strong>, <a id="id550" class="indexterm"/>like we did in <a id="id551" class="indexterm"/>the last chapter. A scene is a DOM element that contains several children. All the children elements are positioned in absolute positions. We have two scenes in our example now. The following code snippet shows a possible scene structure in an entire game with a game over scene, credit scene, and leaderboard scene included:</p><div><pre class="programlisting">&lt;div id="game"&gt;
  &lt;div id="menu-scene" class="scene"&gt;&lt;/div&gt;
  &lt;div id="game-scene" class="scene"&gt;&lt;/div&gt;
  &lt;div id="gameover-scene" class="scene"&gt;&lt;/div&gt;
  &lt;div id="credit-scene" class="scene"&gt;&lt;/div&gt;
  &lt;div id="leaderboard-scene" class="scene"&gt;&lt;/div&gt;
&lt;/div&gt;</pre></div><p>The following screenshot shows that the scenes are placed in the same place on a web page. It is very similar to the layers structure. The difference is that we will control the scene by showing and hiding each scene:</p><div><img src="img/B04290_06_06.jpg" alt="Creating scenes in games"/></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec154"/>Creating a slide-in effect in CSS3</h2></div></div></div><p>The game scene slides in <a id="id552" class="indexterm"/>from the top when the play button is clicked. This scene transition effect is done by moving the game scene using a CSS3 transition. The game scene position is initially placed with a negative top value. We then change the top position from negative value to zero with a transition, so it animates from the top to the correct position.</p><p>Another important thing to make the sliding effect work is to set the overflow of the parent DIV of the scenes to <code class="literal">hidden</code>. Without the hidden overflow, the game scene is visible even with a negative top position. Therefore, it is important to set the parent DIV of the scenes to the hidden overflow.</p><p>The following screenshot illustrates the slide-in transition of the game scene. The <code class="literal">#game</code> DIV is the parent of both the menu scene and the game scene. The game scene moves from the top when we add the <code class="literal">.show-scene</code> class, which sets the top value to 0 with a transition:</p><div><img src="img/B04290_06_07.jpg" alt="Creating a slide-in effect in CSS3"/></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec155"/>Have a go hero – creating different scene transition effects</h2></div></div></div><p>We made a slide-in effect for <a id="id553" class="indexterm"/>the scene transition when showing the game. By using JavaScript and CSS3, we can make many different scene transition effects creatively. Try adding your own transition effect to the game, such as fading in, pushing in from the right, or even flipping with a 3D rotation.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec156"/>Visualizing the music playback</h2></div></div></div><p>If you have ever played the <a id="id554" class="indexterm"/>Dance Dance Revolution, Guitar Hero, or the Tap Tap Revenge games, then you may be familiar with the music dots moving downwards or upwards and the player hitting the music dots when they move to the right place. The following screenshot demonstrates the Tap Tap Revenge game:</p><div><img src="img/B04290_06_08.jpg" alt="Visualizing the music playback"/></div><p>We will play a song in the <code class="literal">audio</code> tag with similar music visualization in the canvas.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec73"/>Time for action – creating the playback visualization in the music game</h1></div></div></div><p>In order to create the <a id="id555" class="indexterm"/>playback visualization in the music game, you'll need to carry out the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">We need a song with both a melody part and a base part. Copy the <code class="literal">minuet_in_g.ogg</code>, <code class="literal">minuet_in_g.aac</code>, <code class="literal">minuet_in_g_melody.ogg</code>, and <code class="literal">minuet_in_g_melody.aac</code> files from the downloaded files or from the code bundle in the <code class="literal">media</code> folder.</li><li class="listitem">Then, add the <code class="literal">audio</code> tag with the song as a source file. Open the <code class="literal">index.html</code> file and add the following code:<div><pre class="programlisting">&lt;audio id="melody"&gt;
  &lt;source src="img/minuet_in_g_melody.aac" /&gt;
  &lt;source src="img/minuet_in_g_melody.ogg" /&gt;
&lt;/audio&gt;

&lt;audio id="base"&gt;
  &lt;source src="img/minuet_in_g.aac" /&gt;
  &lt;source src="img/minuet_in_g.ogg" /&gt;
&lt;/audio&gt;</pre></div></li><li class="listitem">The music visualization is mainly done in JavaScript. Open the <code class="literal">audiogame.js</code> JavaScript file in a text editor.</li><li class="listitem">Add a <code class="literal">MusicNote</code> object type to represent the music data and a <code class="literal">Dot</code> object type to represent the visual dot of the music note in the canvas as follows:<div><pre class="programlisting">function MusicNote(time,line){
   this.time = time;
   this.line = line;
}
function Dot(distance, line) {
   this.distance = distance;
   this.line = line;
   this.missed = false;
}</pre></div></li><li class="listitem">Then, we need<a id="id556" class="indexterm"/> several game variables to store the <code class="literal">MusicNote</code> instances, the <code class="literal">Dot</code> instance, and other information. The level data is a sequence of time and the appearing line that is separated by a semicolon. We will record and create our own data in a later section. The level data represents the time and line at which the music note should appear:<div><pre class="programlisting">var audiogame = {
  // an array to store all music notes data.
  musicNotes: [],
  leveldata: "1.592,3;1.984,2;2.466,1;2.949,2;4.022,3;",
  // the visual dots drawn on the canvas.
  dots: [],
  // for storing the starting time
  startingTime: 0,
  // reference of the dot image
  dotImage: new Image(),

  // existing code inside audiogame object.
}</pre></div></li><li class="listitem">The level data is serialized and stored in a string format. We have the following function to extract the string in the <code class="literal">MusicNote</code> object instances and store in an array:<div><pre class="programlisting">var audiogame = {
  // existing code inside audiogame object.

  setupLevelData: function() {
    var notes = this.leveldata.split(";");

    // store the total number of dots
    this.totalDotsCount = notes.length;

    for(var i=0, len=notes.length; i&lt;len; i++) {
      var note = notes[i].split(",");
      var time = parseFloat(note[0]);
      var line = parseInt(note[1]);
      var musicNote = new MusicNote(time,line);
      this.musicNotes.push(musicNote);
    }
  },
}</pre></div></li><li class="listitem">Add the <a id="id557" class="indexterm"/>following code inside the <code class="literal">initMedia</code> function. It references the <code class="literal">melody</code> and <code class="literal">base</code> audio tags and loads the dot image for later use:<div><pre class="programlisting">initMedia: function() {
  // existing code goes here.

  // melody and base
  this.melody = document.getElementById("melody");
  this.base = document.getElementById("base");

  // load the dot image
  this.dotImage.src = "images/dot.png";
}</pre></div></li><li class="listitem">Add the following code inside the <code class="literal">initGame</code> function. It references the canvas and <code class="literal">canvasContext</code> variables for later use:<div><pre class="programlisting">initGame: function() {
  // existing code goes here.
  this.canvas = document.getElementById("game-canvas");
  this.canvasContext = this.canvas.getContext('2d');
}</pre></div></li><li class="listitem">Add the following two functions in the JavaScript file. The <code class="literal">startGame</code> function sets the starting time and executes the <code class="literal">playMusic</code> function with a delay. The latter function plays both the melody and base audios:<div><pre class="programlisting">var audiogame = {
  // existing code goes here.
  startGame: function() {
    var date = new Date();
    this.startingTime = date.getTime();

    this.registerMusicPlayback();
  },

  registerMusicPlayback: function() {
     // play both the melody and base
    this.melody.play();
    this.base.play();

    // pause for 3550ms to sync with the music dots movement.
    this.melody.pause();
    this.base.pause();
    setTimeout(this.playMusic.bind(this), 3550);
  },

  playMusic: function() {
    this.melody.play();
    this.base.play();
  },
};</pre></div></li><li class="listitem">Add the<a id="id558" class="indexterm"/> following <code class="literal">gameloop</code> function to JavaScript. The <code class="literal">gameloop</code> function creates new dots at the top of the game and moves the existing notes down:<div><pre class="programlisting">var audiogame = {
  // existing code goes here.

  gameloop: function() {
    var canvas = this.canvas;
    var ctx = this.canvasContext;

    // show new dots
    // if the game is started
    if (this.startingTime !== 0)  {
      for(var i=0, len=this.musicNotes.length; i&lt;len; i++) {
        var date = new Date();
        var elapsedTime = (date.getTime() - this.startingTime)/1000;
        var note = this.musicNotes[i];

        var timeDiff = note.time - elapsedTime;

        // When time difference is short enough.
        if (timeDiff &gt;= 0 &amp;&amp; timeDiff &lt;= 0.03)  {
          var dot = new Dot(ctx.canvas.height-150, note.line);
          this.dots.push(dot);
        }
      }
    }

    // loop again to remove dots that are out of the screen.
    for(var i=this.dots.length-1; i&gt;=0; i--) {
      // remove missed dots after moved to the bottom
      if (this.dots[i].distance &lt; -100)  {
        this.dots.splice(i, 1);
      }
    }

    // move the dots
    for(var i=0, len=this.dots.length; i&lt;len; i++) {
      this.dots[i].distance -= 2.5;
    }

    // only clear the dirty area, that is the middle area
    ctx.clearRect(ctx.canvas.width/2-200, 0, 400, ctx.canvas.height);

    // draw the music note dots
    for(var i=0, len=this.dots.length; i&lt;len; i++) {
      // draw the music dot.
      ctx.save();
      var center = canvas.width/2;
      var dot = this.dots[i];
      var x = center-100
      if (dot.line === 2) {
        x = center;
      } else if (dot.line === 3) {
        x = center+100;
      }
      ctx.translate(x, ctx.canvas.height-80-this.dots[i].distance);
      ctx.drawImage(this.dotImage, -this.dotImage.width/2, -this.dotImage.height/2);
      ctx.restore();
    }
  }
};</pre></div></li><li class="listitem">Now, add <a id="id559" class="indexterm"/>the following code at the end of the jQuery ready function:<div><pre class="programlisting">audiogame.setupLevelData();
setInterval(audiogame.gameloop.bind(audiogame), 30);</pre></div></li><li class="listitem">Finally, we call the <code class="literal">startGame</code> function in the click event handler of the <strong>Play</strong> button:<div><pre class="programlisting">game.startGame();</pre></div></li><li class="listitem">Save all files and open the <code class="literal">index.html</code> file in a web browser. The following screenshot shows the music playing with the music dots appearing on the top and moving downwards:<div><img src="img/B04290_06_01.jpg" alt="Time for action – creating the playback visualization in the music game"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec157"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just built a<a id="id560" class="indexterm"/> fully functional music game. This is the basic playback function. It plays the song with both the melody and the base part with some music dots moving downwards.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec158"/>Choosing the right song for the music game</h2></div></div></div><p>We have to be careful of <a id="id561" class="indexterm"/>copyright issues when choosing a song for the music game, as this usually requires you to pay a usage fee or make an agreement with the song copyright owner. This is fine if you are building a commercial music game that is going to be a hit in the game industry and the earnings can outweigh the copyright usage expense. As a book example here, however, we are going to use a copyright-free song. That is why we use the classical song <em>Minute in G</em>, which is in the public domain and free, and is also generated by computer software without a copyrighted performance.</p><div><div><h3 class="title"><a id="note22"/>Note</h3><p>The performance of music can be copyrighted even if the song itself is free.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec159"/>Playing audio on mobile devices</h2></div></div></div><p>There are restrictions<a id="id562" class="indexterm"/> on playing audio on mobile devices, specifically iOS and Android. The latest Android with Chrome browser can only play audio that's triggered by the user. That's why we cannot play the audio plainly after a timeout. We need to play the audio right after the click handler, and then we pause the audio for a suitable time delay to sync the audio with our music dots. In iOS, there are similar user-triggering restrictions. We cannot control audio volume programmatically in mobile Safari. We may not be able to dim the melody in mobile Safari. Apart from this, the game is still playable.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec160"/>Storing and extracting the song-level data</h2></div></div></div><p>The level data shown in the <em>Time</em> <em>for</em> <em>action—creating the playback visualization in the music game</em> section is just <a id="id563" class="indexterm"/>a portion of the entire level data. It<a id="id564" class="indexterm"/> is a very long string storing music note information, including the time and the line. It is stored in the following format, which I came up with:</p><div><pre class="programlisting">music_current_time, line; music_current_time, line; …</pre></div><p>Each music dot data contains two pieces of information: the time to show up, and the line that is shown. This data is separated by a comma. Every piece of music dot data is separated by a semicolon. You can choose any characters to separate the data as long as the splitter doesn't conflict with the data content. For example, choosing a number or full stop would be a bad choice here. The following code extracts the level string into a <code class="literal">MusicNote</code> object by splitting the semicolon and the comma:</p><div><pre class="programlisting">musicNotes = [];
leveldata = "1.592,3;1.984,2;2.466,1;2.949,2;4.022,3;";
function setupLevelData() {
   var notes = audiogame.leveldata.split(";");
   for(var i=0, len=notes.length; i&lt;len; i++) {
      var note = notes[i].split(",");
      var time = parseFloat(note[0]);
      var line = parseInt(note[1]);
      var musicNote = new MusicNote(time,line);
      musicNotes.push(musicNote);
   }
}</pre></div><p>The level data string is recorded by the keyboard and we are going to discuss the recording later in this chapter.</p><div><div><h3 class="title"><a id="tip08"/>Tip</h3><p>The level data contains only a few music notes here. In the code bundle, there is the entire level data of the complete song.</p></div></div><p>There is an optional <a id="id565" class="indexterm"/>second parameter for the <a id="id566" class="indexterm"/>JavaScript <code class="literal">parseInt</code> function. It defines the radix of the number to parse. By default, it uses a decimal but <code class="literal">parseInt</code> will parse the string as an octal when the string begins with zero. For example, <code class="literal">parseInt("010")</code> returns result 8 instead of 10. If we want the decimal number, then we can use <code class="literal">parseInt("010",10)</code> to specify the radix.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec161"/>Getting the elapsed time of the game</h2></div></div></div><p>Although we know the <a id="id567" class="indexterm"/>elapsed time of an audio element by accessing the <code class="literal">currentTime</code> property, we want to get the time from the start of the game.</p><p>We can get the elapsed time by storing the current computer time when starting the game and subtracting the current time value to get the elapsed time.</p><p>We get the current computer time by using the <code class="literal">Date</code> object. The following code snippet shows how we use <code class="literal">startingTime</code> to get the elapsed time, which is in milliseconds:</p><div><pre class="programlisting">// starting game
var date = new Date();
audiogame.startingTime = date.getTime();

// some time later
var date = new Date();
var elapsedTime = (date.getTime() - audiogame.startingTime)/1000;</pre></div><p>The following screenshot shows the preceding code snippet running in the console:</p><div><img src="img/B04290_06_13.jpg" alt="Getting the elapsed time of the game"/></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec162"/>Creating music dots</h2></div></div></div><p>In the <code class="literal">gameloop</code> function, we <a id="id568" class="indexterm"/>check all the <code class="literal">MusicNote</code> instances and see whether it is time to create the visual dot of that music note. The following code shows the logic we used to create the visual music dot:</p><div><pre class="programlisting">if (audiogame.startingTime !== 0) {
  for(var i in audiogame.musicNotes) {
    // get the elapsed time from beginning of the melody
    var date = new Date();
    var elapsedTime = (date.getTime() - audiogame.startingTime)/1000;
    var note = audiogame.musicNotes[i];

    // check whether the dot appear time is as same as the elapsed time
    var timeDiff = note.time - elapsedTime;
    if (timeDiff &gt;= 0 &amp;&amp; timeDiff &lt;= 0.03) {
      // create the dot when the appear time is within one frame of the elapsed time
      var dot = new Dot(ctx.canvas.height-150, note.line);
      audiogame.dots.push(dot);
    }
  }
}</pre></div><p>Basically, we get the elapsed time of the game and compare it with the current time of each music note. If the time difference between the note's current time and elapsed time is within 30 milliseconds, then we create the visual dot instance and let the <code class="literal">gameloop</code> function draw it.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec163"/>Moving the music dots</h2></div></div></div><p>There is a time<a id="id569" class="indexterm"/> difference between the game start and music start. The game starts several seconds before the song starts playing. This is because we need to show the music dots and move them down before the music starts.</p><p>The music dots should match the song when the dots are on the grey line. The music dots appear from the top of the game and move down towards the grey line. We delay the music play to wait as the dots move from top to bottom. This is around 3.55 seconds in this example, so we delay the music playing by 3.55 seconds. This delay may vary when playing different songs. So we may store this information later if we extend the game to support multiple songs playback.</p><p>When the dot is <a id="id570" class="indexterm"/>created, it is placed at a given distance. We decrease all the dots' distances by 2.5 every time the <code class="literal">gameloop</code> function is executed. The distance is stored in each <code class="literal">dot</code> object, representing how far away it is from the grey line:</p><div><pre class="programlisting">for(var i=0, len=this.dots.length; i&lt;len; i++) {
   audiogame.dots[i].distance -= 2.5;
}</pre></div><p>The <em>y</em> position of the dot is calculated by the grey line, subtracting the distance as follows:</p><div><pre class="programlisting">// draw the dot
ctx.save();
var x = ctx.canvas.width/2-100
if (audiogame.dots[i].line === 2) {
   x = ctx.canvas.width/2;
}
else if (audiogame.dots[i].line === 3) {
   x = ctx.canvas.width/2+100;
}
ctx.translate(x, ctx.canvas.height-80-audiogame.dots[i].distance);
ctx.drawImage(audiogame.dotImage, -audiogame.dotImage.width/2, -audiogame.dotImage.height/2);</pre></div><p>The following screenshot shows the distance between the grey line and each dot. When the distance is zero, it is exactly on the grey line:</p><div><img src="img/B04290_06_09.jpg" alt="Moving the music dots"/></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec74"/>Creating a keyboard-driven mini piano musical game</h1></div></div></div><p>Now we can click on the<a id="id571" class="indexterm"/> <strong>Play</strong> button. The music game slides in and plays the song with music notes dropping down. Our next step is adding interaction to the music notes. Therefore, we will add keyboard events to control the three lines to hit the music notes.</p></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec75"/>Time for action – creating a mini piano musical game</h1></div></div></div><p>Carry out the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">We want to show an indication when pressing the keyboard. Open the <code class="literal">index.html</code> file and add the following highlighted HTML:<div><pre class="programlisting">&lt;div id="game-scene" class="scene"&gt;
   &lt;!-- existing code goes here --&gt;
   &lt;div id="hit-line-1" class="hit-line hide"&gt;&lt;/div&gt;
   &lt;div id="hit-line-2" class="hit-line hide"&gt;&lt;/div&gt;
   &lt;div id="hit-line-3" class="hit-line hide"&gt;&lt;/div&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Then, we may want to inform visitors that they can play the game by pressing the <em>J</em>, <em>K</em>, and <em>L</em> keys. Modify the footer content as follows:<div><pre class="programlisting">&lt;footer&gt;
   &lt;p&gt;This is an example of making audio game in HTML5. Press J, K, L to play.
   &lt;/p&gt;
&lt;/footer&gt;</pre></div></li><li class="listitem">Now, we will move on to the stylesheet. Open the <code class="literal">css/audiogame.css</code> file and put the following code at the end of the file:<div><pre class="programlisting">#hit-line-1 {
  left: 35px;
  top: 335px;
}

#hit-line-2 {
  left: 135px; /* 320/2-50/2 */
  top:  335px;
}

#hit-line-3 {
  left: 235px;
  top: 335px;
}</pre></div></li><li class="listitem">Next, we will add<a id="id572" class="indexterm"/> the keyboard event in the JavaScript part. Open the<code class="literal"> audiogame.js</code> JavaScript file and add the following code inside the audiogame object:<div><pre class="programlisting">initKeyboardListener: function() {
  var game = this;

  // keydown
  $(document).keydown(function(e){
    // our target is J(74), K(75), L(76)
    var line = e.which-73;

    game.hitOnLine(line);

  });
  $(document).keyup(function(e){
    var line = e.which-73;
    $('#hit-line-'+line).removeClass('show');
    $('#hit-line-'+line).addClass('hide');
  });
},

hitOnLine: function (lineNo) {
  $('#hit-line-'+lineNo).removeClass('hide');
  $('#hit-line-'+lineNo).addClass('show');

  // check if hit a music note dot
  for(var i=this.dots.length-1; i&gt;=0; i--) {
    if (lineNo === this.dots[i].line &amp;&amp; Math.abs(this.dots[i].distance) &lt; 20) {
      // remove the hit dot from the dots array
      this.dots.splice(i, 1);
    }
  }
},</pre></div></li><li class="listitem">Finally, we call the <code class="literal">initKeyboardListener</code> function in the <code class="literal">initGame</code> function:<div><pre class="programlisting">initGame: function() {
  // existing code goes here.
  this.initKeyboardListener();
},</pre></div></li><li class="listitem">Now save all the files and open the game in a browser. Try pressing the <em>J</em>, <em>K</em>, and <em>L</em> keys. The three hit line indicator should appear and fade out when the key is pressed. If the music dot passes by the horizontal line when hitting the right key, then it <a id="id573" class="indexterm"/>disappears:<div><img src="img/B04290_06_10.jpg" alt="Time for action – creating a mini piano musical game"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec164"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just added keyboard interaction to our music game. There is a glow animation when hitting the keys. The music dot will disappear when the right key is pressed at the right moment. You can take a look at the following URL for an example of the current progress: <a class="ulink" href="http://makzan.net/html5-games/audiogame-wip-keyboard/">http://makzan.net/html5-games/audiogame-wip-keyboard/</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec165"/>Hitting the three music lines by key down</h2></div></div></div><p>We use the <em>J</em>, <em>K</em>, and <em>L</em> <a id="id574" class="indexterm"/>keys to hit the three music lines in the game. The <em>J</em> key controls the left line, the <em>K</em> key controls the middle line, and the <em>L</em> key controls the right one.</p><p>There is also an indication showing that we just hit the music line. This is done by placing the following image at the intersection of the horizontal line and the vertical lines:</p><div><img src="img/B04290_06_11.jpg" alt="Hitting the three music lines by key down"/></div><p>Next, we can control the showing and hiding of the hit indication graphics with the following jQuery code:</p><div><pre class="programlisting">$(document).keydown(function(e){
   var line = e.which-73;
   $('#hit-line-'+line).removeClass('hide');
   $('#hit-line-'+line).addClass('show');
});
$(document).keyup(function(e){
   var line = e.which-73;
   $('#hit-line-'+line).removeClass('show');
   $('#hit-line-'+line).addClass('hide');
});</pre></div><p>The<em> J</em>, <em>K</em>, and <em>L</em> keys control the music lines 1 to 3. As J, K, and L have the key code 74, 75, and 76 respectively, we know which line number it is by subtracting 73 from the key code.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec166"/>Determining music dot hits on key down</h2></div></div></div><p>The distance is close to<a id="id575" class="indexterm"/> zero if the dot is almost on the grey horizontal line. This helps us to determine whether the dots hit the grey line. By checking both the key down event and the dot distance, we can determine whether we successfully hit a music dot. The following code snippet shows that we consider the dot is hit when the distance is close enough; in this case it's within 20 pixels:</p><div><pre class="programlisting">// check whether we hit a music note dot
  for(var i=this.dots.length-1; i&gt;=0; i--)  {
    if (lineNo === this.dots[i].line &amp;&amp; Math.abs(this.dots[i].distance) &lt; 20)    {
      // remove the hit dot from the dots array
      this.dots.splice(i, 1);
    }
  }</pre></div><p>With determination, we remove the music dots when we hit them. The missed dots will still pass through the grey line and move toward the bottom. This creates basic game play where the player has to eliminate all the music dots by hitting them correctly at the right moment when the song is playing.</p><div><div><h3 class="title"><a id="note23"/>Note</h3><p>When we remove elements in array inside an iteration, we usually iterate it backwards to avoid an error of null reference after elements are deleted in the array.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec167"/>Removing an element in an array with the given index</h2></div></div></div><p>We remove the music<a id="id576" class="indexterm"/> dot data from an array when it is hit (and thus it will not be drawn anymore). To remove an element in an array, we use the <code class="literal">splice</code> function. The following line of code removes one element from an array at the given index:</p><div><pre class="programlisting">array.splice(index, 1);</pre></div><p>The <code class="literal">splice</code> function is a little tricky to use. This is because it allows us to add or remove elements in an array. Then, it returns removed elements as another array.</p><p>This is how we use the <code class="literal">splice</code> function:</p><div><pre class="programlisting">array.splice(index, length, element1, element2, …, elementN);</pre></div><p>The following table <a id="id577" class="indexterm"/>shows how we use the arguments:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Argument</p>
</th><th style="text-align: left" valign="bottom">
<p>Definition</p>
</th><th style="text-align: left" valign="bottom">
<p>Discussion</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">index</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies<a id="id578" class="indexterm"/> the index of an element to be added or removed in the array</p>
</td><td style="text-align: left" valign="top">
<p>The index starts from 0. 0 means the first element, 1 means the second one, and so on. We can also use negative indexes, such as -1, which means the last element, -2, which means the second last element, and so on.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">length</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies<a id="id579" class="indexterm"/> how many elements we want to remove</p>
</td><td style="text-align: left" valign="top">
<p>Putting 0 means we do not remove any element.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">element1</code>, <code class="literal">element2</code>, … <code class="literal">elementN</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The new<a id="id580" class="indexterm"/> elements to be added into the array</p>
</td><td style="text-align: left" valign="top">
<p>This is optional. Putting a list of elements here means we add the elements at the given index.</p>
</td></tr></tbody></table></div><div><div><h3 class="title"><a id="note24"/>Note</h3><p>The Mozilla Developer Network link discusses <a id="id581" class="indexterm"/>different usages of the <code class="literal">splice</code> function<a id="id582" class="indexterm"/> at: <a class="ulink" href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/splice">https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/splice</a>.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec168"/>Have a go hero</h2></div></div></div><p>In similar commercial music games, there are some words showing when the player hits or misses a music dot. How can we add this feature to our game?</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec76"/>Adding additional features to the mini piano game</h1></div></div></div><p>We have created basic<a id="id583" class="indexterm"/> interaction in the game. We can go further to make the game better by adding melody volume feedback. This will make the performance playing realistic and count the success rate of the performance.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec169"/>Adjusting the music volume according to the player</h2></div></div></div><p>Imagine that now we <a id="id584" class="indexterm"/>are in a performance playing the music. We hit the music dots to play the melody. If we miss any of them, then we fail to perform it well and the melody disappears.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec77"/>Time for action – removing missed melody notes</h1></div></div></div><p>We will store some game play statistics<a id="id585" class="indexterm"/> and use them to adjust the melody volume. We will continue with our JavaScript file:</p><div><ol class="orderedlist arabic"><li class="listitem">First, add the following variables in the variable declaration region:<div><pre class="programlisting">var audiogame = {
  totalSuccessCount: 0,

  // storing the success count of last 5 results.
  successCount: 5,

  // existing code goes here.

};</pre></div></li><li class="listitem">We want to not only remove a dot but also keep track of the result when we hit it by using a keyboard. Add the following code inside the <code class="literal">hitOnLine</code> function:<div><pre class="programlisting">// check if hit a music note dot
for(var i in audiogame.dots) {
   if (lineNo === audiogame.dots[i].line &amp;&amp; Math.abs(audiogame.dots[i].distance) &lt; 20) {
      // remove the hit dot from the dots array
      audiogame.dots.splice(i, 1);

      // increase the success count
      audiogame.successCount+=1;

      // keep only 5 success count max.
      audiogame.successCount = Math.min(5, audiogame.successCount);

      // increase the total success count
      audiogame.totalSuccessCount +=1;
   }
}</pre></div></li><li class="listitem">In the <code class="literal">gameloop</code> function, we calculate all missed dots and store the result. Then, we can use these statistics to get the successful rate of the game. Add the following code to the <code class="literal">gameloop</code> function:<div><pre class="programlisting">// loop again to remove dots that's out or the screen.
// existing code goes here.

// check missed dots
for(var i=this.dots.length-1; i&gt;=0; i--) {
   if (!audiogame.dots[i].missed &amp;&amp; audiogame.dots[i].distance &lt; -10) {
      // mark the dot as missed if it's not marked before
      audiogame.dots[i].missed = true;

      // reduce the success count
      audiogame.successCount -= 1;

      // reset the success count to 0 if it is lower than 0.
      audiogame.successCount = Math.max(0, audiogame.successCount);
   }

   // remove missed dots after moved to the bottom
   if (audiogame.dots[i].distance &lt; -100) {
      audiogame.dots.splice(i, 1);
   }
}

// calculate the percentage of the success in last 5 music dots
var successPercent = audiogame.successCount / 5;

// prevent the successPercent to exceed range(fail safe)
successPercent = Math.max(0, Math.min(1, successPercent));

// move the dots
// existing code goes here.</pre></div></li><li class="listitem">Lastly, we <a id="id586" class="indexterm"/>adjust the melody volume by using the successful rate. Put the following code after the code we just added in the <code class="literal">gameloop</code> function:<div><pre class="programlisting">audiogame.melody.volume = successPercent;</pre></div></li><li class="listitem">Save all files and test our game in a browser. When the player continues to play the game well, the melody keeps playing. When the player misses several music dots, the melody disappears and only the base plays.</li></ol></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec170"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just used the player's <a id="id587" class="indexterm"/>performance as feedback on the melody volume. This gives the player the feeling that we are really performing the music. When we perform poorly, the melody volume is low and the song sounds poor too. You may try the working example at the following URL: <a class="ulink" href="http://makzan.net/html5-games/audiogame-wip-volume/">http://makzan.net/html5-games/audiogame-wip-volume/</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec171"/>Removing dots from the game</h2></div></div></div><p>We want to remove the dots <a id="id588" class="indexterm"/>either after they drop under the bottom bound or when they are being hit by the player. The game loop displays all the dots in the dot list on the game canvas. We can remove the dot graphic by removing its data from the array of dots. We'll use the following <code class="literal">splice</code> function to remove an entry in the array of the target index:</p><div><pre class="programlisting">audiogame.dots.splice(index, 1);</pre></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec172"/>Storing the success count in the last five results</h2></div></div></div><p>In our game, we need to store the <a id="id589" class="indexterm"/>success count in the last five results to calculate the success rate. We can do this by using a counter representing this. When a dot is successfully hit, the counter increases by one, but when the player fails to hit a dot, the counter decreases by 1.</p><p>The counter then represents the successful counts within the last few results if we limit the counter to have a range,  0 to 5 in our example.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec173"/>Have a go hero</h2></div></div></div><p>We discussed how to display the game progress in the Untangle game in the last chapter. Can we apply a similar technique in the music game? We have the player's success percentage during game play. How about displaying it as a percentage bar at the top of the game?</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec174"/>Recording music notes as level data</h2></div></div></div><p>The game relies on the <a id="id590" class="indexterm"/>level data to play. The playback visualization will not work if there is no level data. We also cannot play it if the playback visualization is not working. So how can we record that level data?</p><p>Imagine that now the music is playing without any music dots appearing in the game. We listen to the music carefully and press the <em>J</em>, <em>K</em>, <em>L</em> keys when the music plays. After the music ends, we print out all the keys and time we pressed. This data will then be used in the playback visualization of the music.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec78"/>Time for action – adding functionalities to record the music level data</h1></div></div></div><p>Carry out the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">First, we create a variable to toggle between the recording mode and normal playing mode. Open the <code class="literal">html5games.audio.js</code> file and add the code as follows:<div><pre class="programlisting">  var audiogame = {
    isRecordMode : true,
    //existing code here</pre></div></li><li class="listitem">Next, we add the following highlighted code in the <code class="literal">keydown</code> event handler. This code stores all our pressed keys in an array and prints them out to the console when the semicolon key is pressed:<div><pre class="programlisting">if (game.isRecordMode) {
  // print the stored music notes data when press ";" (186)
  if (e.which === 186) {
    var musicNotesString = "";
    for(var i=0, len=game.musicNotes.length; i&lt;len; i++)     {
      musicNotesString += game.musicNotes[i].time + "," + game.musicNotes[i].line+";";
    }
    console.log(musicNotesString);
  }

  var currentTime = game.melody.currentTime.toFixed(3);
  var note = new MusicNote(currentTime, e.which-73);
  game.musicNotes.push(note);
}</pre></div></li><li class="listitem">Finally, we want <a id="id591" class="indexterm"/>to make sure that the <code class="literal">setupLevelData</code> and <code class="literal">gameloop</code> functions are not executed during the recording mode. These functions are for the playing mode only:<div><pre class="programlisting">if (!audiogame.isRecordMode) {
  audiogame.setupLevelData();
  setInterval(audiogame.gameloop.bind(audiogame), 30);
}</pre></div></li><li class="listitem">Now open the <code class="literal">index.html</code> file in a browser. After clicking on the <strong>Play</strong> button, the game starts and the music plays without the music notes. Try pressing the <em>J</em>, <em>K</em>, and <em>L</em> keys following the music beat. After finishing the music, press the semicolon to print the level data in the console. The following screenshot shows the console displaying the level data string:<div><img src="img/B04290_06_12.jpg" alt="Time for action – adding functionalities to record the music level data"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec175"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just added a <a id="id592" class="indexterm"/>recording feature to our game. We can now record our music notes. We can toggle the record mode and playing mode by setting the <code class="literal">audiogame.isRecordMode</code> variable to <code class="literal">true</code> and <code class="literal">false</code>.</p><p>On every key press, we get the elapsed time of the melody and create a <code class="literal">MusicNote</code> instance with the time and line number. The following code shows how we record the pressed keys. The <code class="literal">currentTime</code> is cut to two decimal digits before saving:</p><div><pre class="programlisting">var currentTime = audiogame.melody.currentTime.toFixed(3);
var note = new MusicNote(currentTime, e.which-73);
audiogame.musicNotes.push(note);</pre></div><p>We also capture the semicolon key to print out all the recorded <code class="literal">MusicNote</code> data into a string. The string follows the <code class="literal">time,line;time,line;</code> format, so we can directly copy the printed string and paste it as level data to play.</p><div><div><h3 class="title"><a id="note25"/>Note</h3><p>The <code class="literal">toFixed</code> function formats the number with the given number of trailing decimals. In our example, we used it to get the current time with <code class="literal">3</code> trailing decimals.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec79"/>Adding touch support</h1></div></div></div><p>Now the game works <a id="id593" class="indexterm"/>well on a desktop browser. But we want to make the game playable on mobile devices too.</p></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec80"/>Time for action – indicating a game over event in the console</h1></div></div></div><p>We target the 3-intersection point <a id="id594" class="indexterm"/>between the horizontal line and the vertical line.</p><div><ol class="orderedlist arabic"><li class="listitem">We have defined three DIV elements there to display the graphics when hitting the <em>J</em>, <em>K</em>, and <em>L</em> keys. We modify the HTML to add a data-line-no attribute to these elements:<div><pre class="programlisting">&lt;div id="hit-line-1" data-line-no="1" class="hit-line hide"&gt;&lt;/div&gt;
&lt;div id="hit-line-2" data-line-no="2" class="hit-line hide"&gt;&lt;/div&gt;
&lt;div id="hit-line-3" data-line-no="3" class="hit-line hide"&gt;&lt;/div&gt;</pre></div></li><li class="listitem">We move to JavaScript. We define a new function inside the <code class="literal">audiogame</code> object:<div><pre class="programlisting">initTouchAndClick: function() {
  var game = this;
  $('.hit-line').bind('mousedown touchstart', function() {
    var line = $(this).data('lineNo') * 1; // parse in int
    game.hitOnLine(line);
    return false;
  });

  $('.hit-line').bind('mouseup touchend', function(){
    var line = $(this).data('lineNo') * 1; // parse in int
    $('#hit-line-'+line).removeClass('show');
    $('#hit-line-'+line).addClass('hide');
  });
},</pre></div></li><li class="listitem">We call our newly created <code class="literal">initTouchAndClick</code> function in the <code class="literal">initGame</code> function:<div><pre class="programlisting">initGame: function() {
  // existing code goes here.

  this.initTouchAndClick();
},</pre></div></li><li class="listitem">We can now open the game in a mobile browser and play it with our fingers.</li></ol></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec176"/>
<em>What just happened?</em>
</h2></div></div></div><p>We have added a<a id="id595" class="indexterm"/> touch event to the game. The data-line-no attribute in the HTML elements lets us know which line the player is touching. Then we call the same <code class="literal">hitOnLine</code> function that the <code class="literal">keydown</code> event calls, which shares the some code that handles the hit-or-miss determination.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec81"/>Handling the audio event in playback complete events</h1></div></div></div><p>We can play the game <a id="id596" class="indexterm"/>now, but there is no indication<a id="id597" class="indexterm"/> when the game is over. Imagine that now we want to know how well we played when the game is completed. We will capture the melody-ending signal and display the success rate of the game.</p></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec82"/>Time for action – indicating a game over event in the console</h1></div></div></div><p>Carry out the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the<code class="literal"> audiogame.js</code> JavaScript file.</li><li class="listitem">Add the following code in the jQuery ready function:<div><pre class="programlisting">$(audiogame.melody).bind('ended', onMelodyEnded);</pre></div></li><li class="listitem">Add the following event handler function at the end of the file:<div><pre class="programlisting">  // show game over scene on melody ended.
  function onMelodyEnded() {
    console.log('song ended');
    alert ('success percent: ' + audiogame.totalSuccessCount / audiogame.totalDotsCount * 100 + '%');
  }
})(jQuery);</pre></div></li><li class="listitem">It is time to save all files and play the game in a web browser. When the game is over, we should see a pop-up alert with the successful rate.</li></ol></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec177"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just listened to<a id="id598" class="indexterm"/> the <code class="literal">ended</code> event of the audio<a id="id599" class="indexterm"/> element and handled it with a handler function.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec178"/>Handling audio events</h2></div></div></div><p>There are many <a id="id600" class="indexterm"/>other events in the audio element. The following table lists a few commonly used audio events:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Event</p>
</th><th style="text-align: left" valign="bottom">
<p>Discussion</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">ended</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Sent <a id="id601" class="indexterm"/>when the audio element finishes a playback</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">play</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Sent <a id="id602" class="indexterm"/>when the audio element plays or resumes</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">pause</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Sent <a id="id603" class="indexterm"/>when the audio element pauses</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">progress</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Sent <a id="id604" class="indexterm"/>periodically when the audio element is downloading</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">timeupdate</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Sent <a id="id605" class="indexterm"/>when the <code class="literal">currentTime</code> property changes</p>
</td></tr></tbody></table></div><p>Here we just listed a few commonly used events; you can refer to the complete audio event list in the<a id="id606" class="indexterm"/> Mozilla Developer Center at: <a class="ulink" href="https://developer.mozilla.org/En/Using_audio_and_video_in_Firefox#Media_events">https://developer.mozilla.org/En/Using_audio_and_video_in_Firefox#Media_events</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec179"/>Have a go hero</h2></div></div></div><p>In our music game, we print out the success rate in the console when the game is over. How about adding a game over scene to our game and showing it at the end of the game? It would be good to use animation transition when showing a game over scene too.</p><div><div><h3 class="title"><a id="note26"/>Note</h3><p>We have managed the sound assets and played the audio with the native JavaScript API. Sometimes it will get troublesome to manage a large amount of audio loading and playing. There are some JS libraries to help you manage HTML5 audio easier. Here are few of them:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">SoundJS<a id="id607" class="indexterm"/> (<a class="ulink" href="http://www.createjs.com/SoundJS">http://www.createjs.com/SoundJS</a>)</li><li class="listitem" style="list-style-type: disc">Buzz <a id="id608" class="indexterm"/> (<a class="ulink" href="http://buzz.jaysalvat.com">http://buzz.jaysalvat.com</a>)</li><li class="listitem" style="list-style-type: disc">AudioJS<a id="id609" class="indexterm"/> (<a class="ulink" href="http://kolber.github.io/audiojs/">http://kolber.github.io/audiojs/</a>)</li></ul></div></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec83"/>Summary</h1></div></div></div><p>You learned a lot in this chapter about using the HTML5 audio element and built a music game. Specifically, we managed and controlled audio playback by using the HTML audio tag and related JavaScript API. You learned different attributes that change the audio tag's behavior. We made use of the audio tag to create a keyboard-based canvas game. We also made the game work on touch devices by sharing the common logic between keyboard input and touch input. We created the game with a special mode that helps the game level designer to create the level data.</p><p>You learned about adding music and sound effects in our HTML5 games. Now we are ready to build a more complete game by adding a leaderboard to store game scores in the next chapter.</p></div></body></html>