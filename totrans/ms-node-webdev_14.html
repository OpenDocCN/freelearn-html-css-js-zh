<html><head></head><body>
<div class="calibre1" id="_idContainer186">
<h1 class="chapternumber"><span class="kobospan" id="kobo.1.1">13</span></h1>
<h1 class="chaptertitle" id="_idParaDest-226"><span class="kobospan" id="kobo.2.1">Using Sessions</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.3.1">In this chapter, I explain how Node.js applications can correlate HTTP requests to create </span><em class="italic"><span class="kobospan" id="kobo.4.1">sessions</span></em><span class="kobospan" id="kobo.5.1">, which allow the results of one request to affect the outcome of future requests. </span><em class="italic"><span class="kobospan" id="kobo.6.1">Table 13.1</span></em><span class="kobospan" id="kobo.7.1"> puts this chapter in context.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.8.1">Table 13.1: Putting sessions in context</span></p>
<table class="table-container" id="table001-10">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.9.1">Question</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.10.1">Answer</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.11.1">What are they?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.12.1">Sessions correlate the requests made by a user, allowing requests to be associated with one another.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.13.1">Why are they useful?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.14.1">Sessions allow stateful application features to be implemented using stateless HTTP requests.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.15.1">How are they used?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.16.1">Cookies are used to transmit small amounts of data or a session ID that is associated with data stored by the server, which identifies related requests.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.17.1">Are there any pitfalls or limitations?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.18.1">Browsers sometimes use cookies in ways that are unhelpful for managing sessions, but with care, sessions have few pitfalls.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.19.1">Are there any alternatives?</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.20.1">Cookie-based sessions are the only reliable way to correlate HTTP requests, but not all applications require request correlation.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.21.1">Table 13.2</span></em><span class="kobospan" id="kobo.22.1"> summarizes the chapter.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.23.1">Table 13.2: Chapter summary</span></p>
<table class="table-container" id="table002-10">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.24.1">Problem</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.25.1">Solution</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.26.1">Listing</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.27.1">Correlate related HTTP requests</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.28.1">Set and read cookies</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.29.1">2-5, 8-10</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.30.1">Prevent the data stored in cookies from being altered</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.31.1">Sign and verify cookies</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.32.1">6, 7</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.33.1">Store larger amounts of data</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.34.1">Use sessions where the data is stored by the application and accessed using a key stored in a cookie</span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.35.1">11-15, 19-21</span></em></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.36.1">Persistently store session data</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.37.1">Use a database </span></p>
</td>
<td class="table-cell">
<p class="normal"><em class="italic1"><span class="kobospan2" id="kobo.38.1">16-18</span></em></p>
</td>
</tr>
</tbody>
</table>
<h1 class="heading" id="_idParaDest-227"><span class="kobospan" id="kobo.39.1">Preparing for this chapter</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.40.1">This chapter uses the </span><code class="inlinecode"><span class="kobospan" id="kobo.41.1">part2app</span></code><span class="kobospan" id="kobo.42.1"> project from </span><em class="italic"><span class="kobospan" id="kobo.43.1">Chapter 12</span></em><span class="kobospan" id="kobo.44.1">. </span><span class="kobospan" id="kobo.44.2">No changes are required for this chapter. </span><span class="kobospan" id="kobo.44.3">Run the command shown in </span><em class="italic"><span class="kobospan" id="kobo.45.1">Listing 13.1</span></em><span class="kobospan" id="kobo.46.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.47.1">part2app</span></code><span class="kobospan" id="kobo.48.1"> folder to start the development tools.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.49.1">Listing 13.1: Starting the development tools</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.50.1">npm start
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.51.1">Use a browser to request </span><code class="inlinecode"><span class="kobospan" id="kobo.52.1">http://localhost:5000,</span></code><span class="kobospan" id="kobo.53.1"> fill out the form, and click the </span><strong class="screentext"><span class="kobospan" id="kobo.54.1">Submit</span></strong><span class="kobospan" id="kobo.55.1"> button, as shown in </span><em class="italic"><span class="kobospan" id="kobo.56.1">Figure 13.1</span></em><span class="kobospan" id="kobo.57.1">.</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.58.1">Tip</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.59.1">You can download the example project for this chapter – and for all the other chapters in this book – from </span><a href="https://github.com/PacktPublishing/Mastering-Node.js-Web-Development" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.60.1">https://github.com/PacktPublishing/Mastering-Node.js-Web-Development</span></span></a><span class="kobospan" id="kobo.61.1">. </span><span class="kobospan" id="kobo.61.2">See </span><em class="italic"><span class="kobospan" id="kobo.62.1">Chapter 1</span></em><span class="kobospan" id="kobo.63.1"> for how to get help if you have problems running the examples.</span></p>
</div>
<figure class="mediaobject"><span class="kobospan" id="kobo.64.1"><img alt="" src="../Images/B21959_13_01.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.65.1">Figure 13.1: Running the example application</span></p>
<h1 class="heading" id="_idParaDest-228"><span class="kobospan" id="kobo.66.1">Correlating stateless HTTP requests</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.67.1">HTTP requests are </span><em class="italic"><span class="kobospan" id="kobo.68.1">stateless</span></em><span class="kobospan" id="kobo.69.1">, meaning that each request is self-contained and contains no information that associates it with any other request, even when made by the </span><a id="_idIndexMarker626" class="calibre3"/><span class="kobospan" id="kobo.70.1">same browser. </span><span class="kobospan" id="kobo.70.2">You can see the problem this creates by opening two browser windows and filling out the form with the same name but different ages and number of years, simulating two users with the same name.</span></p>
<p class="normal"><span class="kobospan" id="kobo.71.1"> The only information the server has to work with is the data in the form and it has no way to figure out that these are requests from different users, so the users see each other’s data, and any other data created by users with the same name, as shown in </span><em class="italic"><span class="kobospan" id="kobo.72.1">Figure 13.2</span></em><span class="kobospan" id="kobo.73.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.74.1"><img alt="" src="../Images/B21959_13_02.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.75.1">Figure 13.2: The effect of stateless requests</span></p>
<p class="normal"><span class="kobospan" id="kobo.76.1">Most applications are </span><em class="italic"><span class="kobospan" id="kobo.77.1">stateful</span></em><span class="kobospan" id="kobo.78.1">, and that means the server has to be able to </span><em class="italic"><span class="kobospan" id="kobo.79.1">correlate</span></em><span class="kobospan" id="kobo.80.1"> requests so that the application can reflect past actions in future responses. </span><span class="kobospan" id="kobo.80.2">In </span><a id="_idIndexMarker627" class="calibre3"/><span class="kobospan" id="kobo.81.1">the case of the example, this would allow the application to show just the requests made by one user and not just all requests made by anyone who happens to have the same name. </span></p>
<h2 class="heading1" id="_idParaDest-229"><span class="kobospan" id="kobo.82.1">Using cookies to correlate requests</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.83.1">The </span><a id="_idIndexMarker628" class="calibre3"/><span class="kobospan" id="kobo.84.1">most common way to correlate requests is with a </span><em class="italic"><span class="kobospan" id="kobo.85.1">cookie</span></em><span class="kobospan" id="kobo.86.1">. </span><span class="kobospan" id="kobo.86.2">Cookies are small fragments of text that a server includes in an HTTP response header. </span><span class="kobospan" id="kobo.86.3">The browser includes the cookies in subsequent requests, which means that if the server creates cookies with unique IDs, those requests can be identified as related. </span><span class="kobospan" id="kobo.86.4">(There are other ways to correlate requests, such as including unique IDs in URLs, but cookies are the most robust and reliable approach.)</span></p>
<p class="normal"><span class="kobospan" id="kobo.87.1">Cookies can be set just like any response header. </span><span class="kobospan" id="kobo.87.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.88.1">cookies.ts</span></code><span class="kobospan" id="kobo.89.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.90.1">src/server</span></code><span class="kobospan" id="kobo.91.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.92.1">Listing 13.2</span></em><span class="kobospan" id="kobo.93.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.94.1">Listing 13.2: The contents of the cookies.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.95.1">import { ServerResponse } from "http";
const setheaderName = "Set-Cookie";
export const setCookie = (resp: ServerResponse, name: string, 
        val: string) =&gt; {
    let cookieVal: any[] = [`${name}=${val}; Max-Age=300; SameSite=Strict }`];   
    if (resp.hasHeader(setheaderName)) {
        cookieVal.push(resp.getHeader(setheaderName));
    }
    resp.setHeader("Set-Cookie", cookieVal);   
}
export const setJsonCookie = (resp: ServerResponse, name: string,
        val: any) =&gt; {
    setCookie(resp, name, JSON.stringify(val));
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.96.1">Cookies </span><a id="_idIndexMarker629" class="calibre3"/><span class="kobospan" id="kobo.97.1">are sent to the browser using the </span><code class="inlinecode"><span class="kobospan" id="kobo.98.1">Set-Cookie</span></code><span class="kobospan" id="kobo.99.1"> header, and the header value is a cookie name, a value, and one or more attributes that tell the browser how to manage the cookie. </span><span class="kobospan" id="kobo.99.2">A response can set multiple cookies by including multiple </span><code class="inlinecode"><span class="kobospan" id="kobo.100.1">Set-Cookie</span></code><span class="kobospan" id="kobo.101.1"> headers. </span><span class="kobospan" id="kobo.101.2">For this reason, the code in </span><em class="italic"><span class="kobospan" id="kobo.102.1">Listing 13.2</span></em><span class="kobospan" id="kobo.103.1"> checks to see whether there is an existing </span><code class="inlinecode"><span class="kobospan" id="kobo.104.1">Set-Cookie</span></code><span class="kobospan" id="kobo.105.1"> header and adds its value to the array of values passed to the </span><code class="inlinecode"><span class="kobospan" id="kobo.106.1">setHeader</span></code><span class="kobospan" id="kobo.107.1"> method. </span><span class="kobospan" id="kobo.107.2">When the response is written, Node.js will add a </span><code class="inlinecode"><span class="kobospan" id="kobo.108.1">Set-Cookie</span></code><span class="kobospan" id="kobo.109.1"> header for each element in the array.</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.110.1">User caution</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.111.1">Consent is required for cookies in some parts of the world, most notably within the EU with the </span><strong class="screentext"><span class="kobospan" id="kobo.112.1">General Data Protection Regulation</span></strong><span class="kobospan" id="kobo.113.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.114.1">GDPR</span></strong><span class="kobospan" id="kobo.115.1">). </span><span class="kobospan" id="kobo.115.2">I am not a lawyer, and I am in no way qualified to provide legal advice, but you should make sure you understand the laws in each region where your application has users and make sure you comply with the rules.</span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.116.1">A header produced by the </span><code class="inlinecode"><span class="kobospan" id="kobo.117.1">setCookie</span></code><span class="kobospan" id="kobo.118.1"> function in </span><em class="italic"><span class="kobospan" id="kobo.119.1">Listing 13.2</span></em><span class="kobospan" id="kobo.120.1"> will look like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.121.1">...
</span><span class="kobospan" id="kobo.121.2">Set-Cookie: user=Alice; Max-Age=300; SameSite=Strict
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.122.1">The cookie name is </span><code class="inlinecode"><span class="kobospan" id="kobo.123.1">user</span></code><span class="kobospan" id="kobo.124.1">, its value is </span><code class="inlinecode"><span class="kobospan" id="kobo.125.1">Alice</span></code><span class="kobospan" id="kobo.126.1">, and the cookie has been configured with the </span><code class="inlinecode"><span class="kobospan" id="kobo.127.1">Max-Age</span></code><span class="kobospan" id="kobo.128.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.129.1">SameSite</span></code><span class="kobospan" id="kobo.130.1"> attributes, which tell the browser how long</span><a id="_idIndexMarker630" class="calibre3"/><span class="kobospan" id="kobo.131.1"> the cookie is valued for and when to send the cookie. </span><span class="kobospan" id="kobo.131.2">The cookie attributes are described in </span><em class="italic"><span class="kobospan" id="kobo.132.1">Table 13.3</span></em><span class="kobospan" id="kobo.133.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.134.1">Table 13.3: Cookie attributes</span></p>
<table class="table-container" id="table003-10">
<tbody class="calibre8">
<tr class="calibre9">
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.135.1">Name</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.136.1">Description</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.137.1">Domain=value</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.138.1">This attribute specifies the cookie’s domain, as described after this table.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.139.1">Expires=date</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.140.1">This attribute specifies the time and date when the cookie expires. </span><span class="kobospan" id="kobo.140.2">The data format is described at </span><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Date" class="calibre3"><span class="url"><span class="kobospan2" id="kobo.141.1">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Date</span></span></a><span class="kobospan" id="kobo.142.1">. </span><span class="kobospan" id="kobo.142.2">For most projects, the </span><code class="inlinecode"><span class="kobospan2" id="kobo.143.1">Max-Age</span></code><span class="kobospan4" id="kobo.144.1"> attribute is easier to use.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.145.1">HttpOnly</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.146.1">This attribute tells the browser to prevent JavaScript code from reading the cookie. </span><span class="kobospan4" id="kobo.146.2">This is rarely set for web applications that have client-side JavaScript code.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.147.1">Max-Age=second</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.148.1">This attribute specifies the number of seconds until the cookie expires. </span><span class="kobospan" id="kobo.148.2">This attribute takes precedence over </span><code class="inlinecode"><span class="kobospan2" id="kobo.149.1">Expires</span></code><span class="kobospan4" id="kobo.150.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.151.1">Path=path</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.152.1">This attribute specifies a path that must be in the URL for the browser to include the cookie.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.153.1">SameSite=policy</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan3" id="kobo.154.1">This attribute tells the browser whether the cookie should be included in cross-site requests, as described later. </span><span class="kobospan" id="kobo.154.2">The policy options are </span><code class="inlinecode"><span class="kobospan2" id="kobo.155.1">Strict</span></code><span class="kobospan" id="kobo.156.1">, </span><code class="inlinecode"><span class="kobospan2" id="kobo.157.1">Lax</span></code><span class="kobospan" id="kobo.158.1">, and </span><code class="inlinecode"><span class="kobospan2" id="kobo.159.1">None</span></code><span class="kobospan4" id="kobo.160.1">.</span></p>
</td>
</tr>
<tr class="calibre9">
<td class="table-cell">
<pre class="programlisting2"><code class="hljs"><code class="inlinecode1"><span class="kobospan2" id="kobo.161.1">Secure</span></code>
</code></pre>
</td>
<td class="table-cell">
<p class="normal"><span class="kobospan2" id="kobo.162.1">When this option is set, the browser will only include the cookie in HTTPS requests and not plain HTTP requests.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="kobospan" id="kobo.163.1">Two of the cookie attributes require additional explanation. </span><span class="kobospan" id="kobo.163.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.164.1">Domain</span></code><span class="kobospan" id="kobo.165.1"> attribute is used to widen the range of requests for which the browser will include a cookie. </span><span class="kobospan" id="kobo.165.2">If a request is sent to </span><a href="https://users.acme.com" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.166.1">https://users.acme.com</span></span></a><span class="kobospan" id="kobo.167.1">, for example, any cookies that are returned won’t be included in requests to </span><a href="https://products.acme.com" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.168.1">https://products.acme.com</span></span></a><span class="kobospan" id="kobo.169.1">, which can be a problem for some projects. </span><span class="kobospan" id="kobo.169.2">This can be resolved with the </span><code class="inlinecode"><span class="kobospan" id="kobo.170.1">Domain</span></code><span class="kobospan" id="kobo.171.1"> attribute, which can be set to </span><code class="inlinecode"><span class="kobospan" id="kobo.172.1">acme.com</span></code><span class="kobospan" id="kobo.173.1">, and telling the browser to include the cookie more broadly. </span></p>
<p class="normal"><span class="kobospan" id="kobo.174.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.175.1">SameSite</span></code><span class="kobospan" id="kobo.176.1"> attribute is used to control whether the cookie will be included in requests that originate from outside the site that created the cookie, known as the </span><em class="italic"><span class="kobospan" id="kobo.177.1">first-party</span></em><span class="kobospan" id="kobo.178.1"> or same-site </span><em class="italic"><span class="kobospan" id="kobo.179.1">context.</span></em><span class="kobospan" id="kobo.180.1"> The options for the </span><code class="inlinecode"><span class="kobospan" id="kobo.181.1">SameSite</span></code><span class="kobospan" id="kobo.182.1"> attribute are: </span><code class="inlinecode"><span class="kobospan" id="kobo.183.1">Strict</span></code><span class="kobospan" id="kobo.184.1">, meaning that cookies are only included for requests made </span><a id="_idIndexMarker631" class="calibre3"/><span class="kobospan" id="kobo.185.1">from the same website that created the cookie, </span><code class="inlinecode"><span class="kobospan" id="kobo.186.1">Lax</span></code><span class="kobospan" id="kobo.187.1">, which tells the browser to include the cookie when following a link but not for cross-site requests, such as the email, and </span><code class="inlinecode"><span class="kobospan" id="kobo.188.1">None</span></code><span class="kobospan" id="kobo.189.1">, which means that the cookie is always included.</span></p>
<p class="normal"><span class="kobospan" id="kobo.190.1">Imagine that a user has previously visited </span><a href="https://www.acme.com" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.191.1">https://www.acme.com</span></span></a><span class="kobospan" id="kobo.192.1"> and has received a cookie, after which the user navigates to </span><code class="inlinecode"><span class="kobospan" id="kobo.193.1">www.example.com</span></code><span class="kobospan" id="kobo.194.1">. </span><span class="kobospan" id="kobo.194.2">The response from </span><code class="inlinecode"><span class="kobospan" id="kobo.195.1">www.example.com</span></code><span class="kobospan" id="kobo.196.1"> contains a link back to </span><code class="inlinecode"><span class="kobospan" id="kobo.197.1">www.acme.com</span></code><span class="kobospan" id="kobo.198.1">. </span><span class="kobospan" id="kobo.198.2">If the cookie was created with the </span><code class="inlinecode"><span class="kobospan" id="kobo.199.1">Strict</span></code><span class="kobospan" id="kobo.200.1"> option, the browser won’t send the cookie in the request, but it will be included with the </span><code class="inlinecode"><span class="kobospan" id="kobo.201.1">Lax</span></code><span class="kobospan" id="kobo.202.1"> option. </span><span class="kobospan" id="kobo.202.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.203.1">None</span></code><span class="kobospan" id="kobo.204.1"> option will also cause the browser to include the cookie and will also allow it to be included in requests that are made within frames or that are for images.</span></p>
<p class="normal"><span class="kobospan" id="kobo.205.1">Revisiting the cookies created by the code in </span><em class="italic"><span class="kobospan" id="kobo.206.1">Listing 13.2</span></em><span class="kobospan" id="kobo.207.1">, you can see that the </span><code class="inlinecode"><span class="kobospan" id="kobo.208.1">Max-Age</span></code><span class="kobospan" id="kobo.209.1"> attribute has been used to give the cookie a 300-second (5-minute) life and that the </span><code class="inlinecode"><span class="kobospan" id="kobo.210.1">SameSite</span></code><span class="kobospan" id="kobo.211.1"> policy is set to </span><code class="inlinecode"><span class="kobospan" id="kobo.212.1">Strict</span></code><span class="kobospan" id="kobo.213.1">, which means cookies will not be included in requests from outside the cookie’s domain:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.214.1">...
</span><span class="kobospan" id="kobo.214.2">Set-Cookie: user=Alice; </span><strong class="screentext"><span class="kobospan" id="kobo.215.1">Max-Age=300; SameSite=Strict</span></strong><span class="kobospan" id="kobo.216.1">
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.217.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.218.1">setJsonCookie</span></code><span class="kobospan" id="kobo.219.1"> function produces cookies with the same configuration but accepts arbitrary objects that are serialized into the JSON format before being used as the cookie value. </span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.220.1">Avoiding cookies without expires and Max-Age attributes</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.221.1">A cookie that is created without either the </span><code class="inlinecode"><span class="kobospan" id="kobo.222.1">Expires</span></code><span class="kobospan" id="kobo.223.1"> or </span><code class="inlinecode"><span class="kobospan" id="kobo.224.1">Max-Age</span></code><span class="kobospan" id="kobo.225.1"> attributes is a </span><em class="italic"><span class="kobospan" id="kobo.226.1">session cookie</span></em><span class="kobospan" id="kobo.227.1">, which is a confusing term because this type of cookie isn’t especially useful for creating user sessions, a process I demonstrate later in this chapter. </span><span class="kobospan" id="kobo.227.2">The name “session cookies” means that a cookie is valid for a browsing session, which means they are invalidated when the user closes the browser window, for example.</span></p>
<p class="normal"><span class="kobospan" id="kobo.228.1">Browsers have changed since this type of cookie was created, and session cookies should be avoided because leaving the browser to decide when to invalidate a cookie can produce unexpected results, and cookies can have long and unpredictable lives, especially now that browsers allow users to resurrect browser tabs long after they are closed. </span><span class="kobospan" id="kobo.228.2">Cookies should always be given a fixed life with the </span><code class="inlinecode"><span class="kobospan" id="kobo.229.1">Expires</span></code><span class="kobospan" id="kobo.230.1"> or </span><code class="inlinecode"><span class="kobospan" id="kobo.231.1">Max-Age</span></code><span class="kobospan" id="kobo.232.1"> attributes. </span></p>
</div>
<h3 class="heading2" id="_idParaDest-230"><span class="kobospan" id="kobo.233.1">Receiving cookies</span></h3>
<p class="normal1"><span class="kobospan" id="kobo.234.1">The </span><a id="_idIndexMarker632" class="calibre3"/><span class="kobospan" id="kobo.235.1">browser includes cookies in requests using the </span><code class="inlinecode"><span class="kobospan" id="kobo.236.1">Cookie</span></code><span class="kobospan" id="kobo.237.1"> header, which contains one or more </span><code class="inlinecode"><span class="kobospan" id="kobo.238.1">name=value</span></code><span class="kobospan" id="kobo.239.1"> pairs, separated by semicolons (the </span><code class="inlinecode"><span class="kobospan" id="kobo.240.1">;</span></code><span class="kobospan" id="kobo.241.1"> character). </span><span class="kobospan" id="kobo.241.2">The attributes used with the </span><code class="inlinecode"><span class="kobospan" id="kobo.242.1">Set-Cookie</span></code><span class="kobospan" id="kobo.243.1"> header are not included, so the header looks like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.244.1">...
</span><span class="kobospan" id="kobo.244.2">Cookie: user=Alice; otherCookie=othervalue
...
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.245.1">Listing 13.3</span></em><span class="kobospan" id="kobo.246.1"> defines a function to parse the header and extract the individual cookies. </span><span class="kobospan" id="kobo.246.2">There is also a method for parsing JSON cookie values. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.247.1">Listing 13.3: Parsing cookies in the cookies.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext"><span class="kobospan" id="kobo.248.1">import { IncomingMessage, ServerResponse } from "http";</span></strong><span class="kobospan" id="kobo.249.1">
const setheaderName = "Set-Cookie";
export const setCookie = (resp: ServerResponse, name: string, 
        val: string) =&gt; {
    let cookieVal: any[] = [`${name}=${val}; Max-Age=300; SameSite=Strict }`];   
    if (resp.hasHeader(setheaderName)) {
        cookieVal.push(resp.getHeader(setheaderName));
    }
    resp.setHeader("Set-Cookie", cookieVal);   
}
export const setJsonCookie = (resp: ServerResponse, name: string,
        val: any) =&gt; {
    setCookie(resp, name, JSON.stringify(val));
}
</span><strong class="screentext"><span class="kobospan" id="kobo.250.1">export const getCookie = (req: IncomingMessage,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.251.1">        key: string): string | undefined</span></strong><strong class="screentext"><span class="kobospan" id="kobo.252.1"> =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.253.1">    let result: string | undefined = undefined;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.254.1">    req.headersDistinct["cookie"]?.forEach(header =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.255.1">        header.split</span></strong><strong class="screentext"><span class="kobospan" id="kobo.256.1">(";").forEach(cookie =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.257.1">            const { name, val }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.258.1">                = /^(?&lt;name&gt;.*)=(?&lt;val&gt;.*)$/.exec(cookie)?.groups as any;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.259.1">            if (name.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.260.1">trim() === key) {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.261.1">                result = val;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.262.1">            }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.263.1">        })</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.264.1">    });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.265.1">    return result;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.266.1">}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.267.1">export const getJsonCookie = (req: IncomingMessage, key: string) : any =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.268.1">    const cookie = getCookie</span></strong><strong class="screentext"><span class="kobospan" id="kobo.269.1">(req, key);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.270.1">    return cookie ? </span><span class="kobospan" id="kobo.270.2">JSON.parse(cookie) : undefined;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.271.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.272.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.273.1">getCookie</span></code><span class="kobospan" id="kobo.274.1"> function</span><a id="_idIndexMarker633" class="calibre3"/><span class="kobospan" id="kobo.275.1"> uses JavaScript string processing and regular expression features to split up the cookie string and get the name and value to locate a specific cookie. </span><span class="kobospan" id="kobo.275.2">This is not an efficient approach because the cookie header is processed each time a cookie is requested, but it does show how the header can be handled and will be improved upon later in this chapter.</span></p>
<h3 class="heading2" id="_idParaDest-231"><span class="kobospan" id="kobo.276.1">Setting and reading cookies</span></h3>
<p class="normal1"><em class="italic"><span class="kobospan" id="kobo.277.1">Listing 13.4</span></em><span class="kobospan" id="kobo.278.1"> updates </span><a id="_idIndexMarker634" class="calibre3"/><span class="kobospan" id="kobo.279.1">the code that handles the </span><code class="inlinecode"><span class="kobospan" id="kobo.280.1">/form</span></code><span class="kobospan" id="kobo.281.1"> requests to set a cookie that keeps track of the user’s requests. </span><span class="kobospan" id="kobo.281.2">The cookie’s contents are updated each time a new request is received, and the cookie’s value is read from every request and added to the </span><a id="_idIndexMarker635" class="calibre3"/><span class="kobospan" id="kobo.282.1">context data passed to the template used to generate a response.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.283.1">Listing 13.4: Using cookies in the forms.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.284.1">import express, { Express } from "express";
import repository  from "./data";
</span><strong class="screentext"><span class="kobospan" id="kobo.285.1">import { getJsonCookie, setJsonCookie } from "./cookies";</span></strong><span class="kobospan" id="kobo.286.1">
const rowLimit = 10;
export const registerFormMiddleware = (app: Express) =&gt; {
    app.use(express.urlencoded({extended: true}))
}
export const registerFormRoutes = (app: Express) =&gt; {
    app.get("/form", async (req, resp) =&gt; {
        resp.render("age", {
            history: await repository.getAllResults(rowLimit),
           </span><strong class="screentext"><span class="kobospan" id="kobo.287.1"> personalHistory: getJsonCookie(req, "personalHistory")</span></strong><span class="kobospan" id="kobo.288.1">
        });
    });
    app.post("/form", async (req, resp) =&gt; {
        const nextage = Number.parseInt(req.body.age)
            + Number.parseInt(req.body.years);
        await repository.saveResult({...req.body, nextage });
        </span><strong class="screentext"><span class="kobospan" id="kobo.289.1">let pHistory = [{</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.290.1">            name: req.body.name, age: req.body.age,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.291.1">            years: req.body.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.292.1">years, nextage},</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.293.1">            ...(getJsonCookie(req, "personalHistory") || [])].splice(0, 5);</span></strong>
<strong class="screentext"> </strong>
<strong class="screentext"><span class="kobospan" id="kobo.294.1">        setJsonCookie(resp, "personalHistory", pHistory);</span></strong>
<strong class="screentext"> </strong>
<strong class="screentext"><span class="kobospan" id="kobo.295.1">        const context = {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.296.1">            ...req.body, nextage,</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.297.1">history: await repository.getAllResults(rowLimit),</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.298.1">            personalHistory: pHistory</span></strong><span class="kobospan" id="kobo.299.1">
        };
        resp.render("age", context);  
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.300.1">A cookie</span><a id="_idIndexMarker636" class="calibre3"/><span class="kobospan" id="kobo.301.1"> is </span><a id="_idIndexMarker637" class="calibre3"/><span class="kobospan" id="kobo.302.1">used to store the last five results created for the user. </span><span class="kobospan" id="kobo.302.2">Each new </span><code class="inlinecode"><span class="kobospan" id="kobo.303.1">POST</span></code><span class="kobospan" id="kobo.304.1"> request creates a new </span><code class="inlinecode"><span class="kobospan" id="kobo.305.1">Set-Cookie</span></code><span class="kobospan" id="kobo.306.1"> header in the response, with a new five-minute expiry time. </span><span class="kobospan" id="kobo.306.2">If the user keeps submitting requests, new cookies will be created, effectively extending the user’s session. </span><span class="kobospan" id="kobo.306.3">If no request is made before the cookie expires, then the browser </span><a id="_idIndexMarker638" class="calibre3"/><span class="kobospan" id="kobo.307.1">will </span><a id="_idIndexMarker639" class="calibre3"/><span class="kobospan" id="kobo.308.1">discard the cookie and won’t include it in future requests. </span></p>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.309.1">Listing 13.5</span></em><span class="kobospan" id="kobo.310.1"> updates the partial view that displays recent queries to display the personal history when it is available.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.311.1">Listing 13.5: Displaying data in the history.handlebars file in the templates/serve/partials folder</span></p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext"><span class="kobospan" id="kobo.312.1">{{#if personalHistory }}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.313.1">    &lt;h4&gt;Your History&lt;/h4&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.314.1">    &lt;table class="table table-sm table-striped my-2"&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.315.1">        {{#each personalHistory }}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.316.1">            &lt;tr&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.317.1">                &lt;td&gt;{{ this.name }} &lt;/td&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.318.1">                &lt;td&gt;{{ this.age }} &lt;/td&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.319.1">                &lt;td</span></strong><strong class="screentext"><span class="kobospan" id="kobo.320.1">&gt;{{ this.years }} &lt;/td&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.321.1">                &lt;td&gt;{{ this.nextage }} &lt;/td&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.322.1">            &lt;/tr&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.323.1">        {{/each }}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.324.1">    &lt;/table&gt;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.325.1">{{/if }}</span></strong><span class="kobospan" id="kobo.326.1">
&lt;h4&gt;Recent Queries&lt;/h4&gt;
&lt;table class="table table-sm table-striped my-2"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Age&lt;/th&gt;&lt;th&gt;Years&lt;/th&gt;&lt;th&gt;Result&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        {{#unless history }}
            &lt;tr&gt;&lt;td colspan="4"&gt;No data available&lt;/td&gt;&lt;/tr&gt;
        {{/unless }}
        {{#each history }}
            &lt;tr&gt;
                &lt;td&gt;{{ this.name }} &lt;/td&gt;
                &lt;td&gt;{{ this.age }} &lt;/td&gt;
                &lt;td&gt;{{ this.years }} &lt;/td&gt;
                &lt;td&gt;{{ this.nextage }} &lt;/td&gt;
            &lt;/tr&gt;
        {{/each }}
    &lt;/tbody&gt;
&lt;/table&gt;
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.327.1">Browsers share cookies between tabs so the most reliable way to test the changes to </span><a id="_idIndexMarker640" class="calibre3"/><span class="kobospan" id="kobo.328.1">the example is to open one regular browser tab and one private or incognito </span><a id="_idIndexMarker641" class="calibre3"/><span class="kobospan" id="kobo.329.1">browsing tab. </span><span class="kobospan" id="kobo.329.2">Navigate to </span><code class="inlinecode"><span class="kobospan" id="kobo.330.1">http://localhost:5000</span></code><span class="kobospan" id="kobo.331.1"> with both tabs and fill out the form using the same name but different ages and years. </span><span class="kobospan" id="kobo.331.2">Submit the forms and you will see that each browser tab has its own history, as shown in </span><em class="italic"><span class="kobospan" id="kobo.332.1">Figure 13.3</span></em><span class="kobospan" id="kobo.333.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.334.1"><img alt="" src="../Images/B21959_13_03.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.335.1">Figure 13.3: Using cookies to correlate requests</span></p>
<h2 class="heading1" id="_idParaDest-232"><span class="kobospan" id="kobo.336.1">Signing cookies</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.337.1">Users</span><a id="_idIndexMarker642" class="calibre3"/><span class="kobospan" id="kobo.338.1"> can change the contents of cookies, and browsers make it easy to add, delete, and alter cookies. </span><span class="kobospan" id="kobo.338.2">The Chrome F12 developer tools, for example, allow cookies to be edited in the </span><strong class="screentext"><span class="kobospan" id="kobo.339.1">Application/Cookies</span></strong><span class="kobospan" id="kobo.340.1"> pane. </span></p>
<p class="normal"><span class="kobospan" id="kobo.341.1">This means that cookies cannot be trusted unless their contents can be verified to ensure they have not been tampered with. </span><span class="kobospan" id="kobo.341.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.342.1">cookies_signed.ts</span></code><span class="kobospan" id="kobo.343.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.344.1">src/server</span></code><span class="kobospan" id="kobo.345.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.346.1">Listing 13.6</span></em><span class="kobospan" id="kobo.347.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.348.1">Listing 13.6: The contents of the cookies_signed.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.349.1">import { createHmac, timingSafeEqual } from "crypto";
export const signCookie = (value: string, secret: string) =&gt; {
    return value + "." </span><span class="kobospan" id="kobo.349.2">+ createHmac("sha512", secret)
        .update(value).digest("base64url");
}
export const validateCookie = (value: string, secret: string) =&gt; {
    const cookieValue = value.split(".")[0];
    const compareBuf = Buffer.from(signCookie(cookieValue, secret));
    const candidateBuf = Buffer.from(value);
    if (compareBuf.length == candidateBuf.length &amp;&amp;
        timingSafeEqual(compareBuf, candidateBuf)) {
            return cookieValue;
    }
    return undefined;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.350.1">Node.js </span><a id="_idIndexMarker643" class="calibre3"/><span class="kobospan" id="kobo.351.1">provides a comprehensive cryptography API in the </span><code class="inlinecode"><span class="kobospan" id="kobo.352.1">crypto</span></code><span class="kobospan" id="kobo.353.1"> module, which includes support for </span><strong class="screentext"><span class="kobospan" id="kobo.354.1">hash-based message authentication codes</span></strong><span class="kobospan" id="kobo.355.1"> (</span><strong class="screentext"><span class="kobospan" id="kobo.356.1">HMACs</span></strong><span class="kobospan" id="kobo.357.1">), which are hash codes created using a secret key that can be used to verify data. </span><span class="kobospan" id="kobo.357.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.358.1">signCookie</span></code><span class="kobospan" id="kobo.359.1"> function in </span><em class="italic"><span class="kobospan" id="kobo.360.1">Listing 13.6</span></em><span class="kobospan" id="kobo.361.1"> uses the Node.js API to create a hash code that can be used as a cookie value.</span></p>
<p class="normal"><span class="kobospan" id="kobo.362.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.363.1">createHmac</span></code><span class="kobospan" id="kobo.364.1"> function is used to create the hash code generator, using the </span><strong class="screentext"><span class="kobospan" id="kobo.365.1">SHA-512</span></strong><span class="kobospan" id="kobo.366.1"> algorithm and the secret key:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.367.1">...
</span><strong class="screentext"><span class="kobospan" id="kobo.368.1">createHmac("</span></strong><strong class="screentext"><span class="kobospan" id="kobo.369.1">sha512", secret)</span></strong><span class="kobospan" id="kobo.370.1">.update(value).digest("base64url");
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.371.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.372.1">update</span></code><span class="kobospan" id="kobo.373.1"> method is used to apply the hashing algorithm to the cookie value, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.374.1">digest</span></code><span class="kobospan" id="kobo.375.1"> method returns the hash code in the </span><code class="inlinecode"><span class="kobospan" id="kobo.376.1">Base64</span></code><span class="kobospan" id="kobo.377.1"> URL encoding, which allows the hash code to be safely included in the cookie. </span><span class="kobospan" id="kobo.377.2">The result is the data value, followed by a period, followed by the hash code, which will look like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.378.1">...
</span><span class="kobospan" id="kobo.378.2">myCookieData.hn5jneGWS_oBL7ww5IHZm9KuzfUwWnnDz01vhNc5xNMwb-kQnxb357Tp
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.379.1">Real hash codes are longer, but what’s important is that the cookie value isn’t encrypted and can still be seen by the user. </span><span class="kobospan" id="kobo.379.2">The user can still edit the cookie, but the hash code allows those changes to be detected.</span></p>
<p class="normal"><span class="kobospan" id="kobo.380.1">When the</span><a id="_idIndexMarker644" class="calibre3"/><span class="kobospan" id="kobo.381.1"> cookie is submitted, the </span><code class="inlinecode"><span class="kobospan" id="kobo.382.1">validateCookie</span></code><span class="kobospan" id="kobo.383.1"> method generates a new hash code for the cookie value and compares it to the one received in the cookie. </span><span class="kobospan" id="kobo.383.2">Hash codes are </span><em class="italic"><span class="kobospan" id="kobo.384.1">one way</span></em><span class="kobospan" id="kobo.385.1">, which means they are validated by generating a new hash code for the cookie value included in the HTTP request and comparing it with the previous hash code. </span></p>
<p class="normal"><span class="kobospan" id="kobo.386.1">The Node.js </span><code class="inlinecode"><span class="kobospan" id="kobo.387.1">crypto</span></code><span class="kobospan" id="kobo.388.1"> module provides the </span><code class="inlinecode"><span class="kobospan" id="kobo.389.1">timingSafeEqual</span></code><span class="kobospan" id="kobo.390.1"> function, which performs a byte-by-byte comparison of two </span><code class="inlinecode"><span class="kobospan" id="kobo.391.1">Buffer</span></code><span class="kobospan" id="kobo.392.1"> objects, which are created from the two hash codes to compare.</span></p>
<p class="normal"><span class="kobospan" id="kobo.393.1">The user may be able to alter the cookie value but doesn’t have the secret key required to generate a valid hash code for the altered value. </span><span class="kobospan" id="kobo.393.2">If the hash code received from the request doesn’t match, the cookie data is discarded. </span><em class="italic"><span class="kobospan" id="kobo.394.1">Listing 13.7</span></em><span class="kobospan" id="kobo.395.1"> updates the </span><code class="inlinecode"><span class="kobospan" id="kobo.396.1">setCookie</span></code><span class="kobospan" id="kobo.397.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.398.1">getCookie</span></code><span class="kobospan" id="kobo.399.1"> functions so that all the cookies created by the application are signed. </span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.400.1">Caution</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.401.1">Be careful not to commit secret keys to public source code repositories, such as GitHub. </span><span class="kobospan" id="kobo.401.2">One approach is to define sensitive data in </span><code class="inlinecode"><span class="kobospan" id="kobo.402.1">.env</span></code><span class="kobospan" id="kobo.403.1"> files, which can be excluded from code commits. </span><span class="kobospan" id="kobo.403.2">See </span><em class="italic"><span class="kobospan" id="kobo.404.1">Part 3</span></em><span class="kobospan" id="kobo.405.1"> of this book for an example of using this type of configuration file.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.406.1">Listing 13.7: Signing cookies in the cookies.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.407.1">import { IncomingMessage, ServerResponse } from "http";
</span><strong class="screentext"><span class="kobospan" id="kobo.408.1">import { signCookie, validateCookie } from "./cookies_signed";</span></strong><span class="kobospan" id="kobo.409.1">
const setheaderName = "Set-Cookie";
</span><strong class="screentext"><span class="kobospan" id="kobo.410.1">const cookieSecret = "mysecret";</span></strong><span class="kobospan" id="kobo.411.1">
export const setCookie = (resp: ServerResponse, name: string, 
        val: string) =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.412.1">const signedCookieVal = signCookie(val, cookieSecret);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.413.1">    let </span></strong><strong class="screentext"><span class="kobospan" id="kobo.414.1">cookieVal: any[] =</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.415.1"> [`${name}=${signedCookieVal}; Max-Age=300; SameSite=Strict`];  </span></strong><span class="kobospan" id="kobo.416.1">         
    if (resp.hasHeader(setheaderName)) {
        cookieVal.push(resp.getHeader(setheaderName));
    }
    resp.setHeader("Set-Cookie", cookieVal);   
}
export const setJsonCookie = (resp: ServerResponse, name: string,
        val: any) =&gt; {
    setCookie(resp, name, JSON.stringify(val));
}
export const getCookie = (req: IncomingMessage,
        key: string): string | undefined =&gt; {
    let result: string | undefined = undefined;
    req.headersDistinct["cookie"]?.forEach(header =&gt; {
        header.split(";").forEach(cookie =&gt; {
            const { name, val }
                = /^(?&lt;name&gt;.*)=(?&lt;val&gt;.*)$/.exec(cookie)?.groups as any;
            if (name.trim() === key) {
                </span><strong class="screentext"><span class="kobospan" id="kobo.417.1">result = validateCookie(val, cookieSecret);</span></strong><span class="kobospan" id="kobo.418.1">
            }
        })
    });
    return result;
}
export const getJsonCookie = (req: IncomingMessage, key: string) : any =&gt; {
    const cookie = getCookie(req, key);
    return cookie ? </span><span class="kobospan" id="kobo.418.2">JSON.parse(cookie) : undefined;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.419.1">There is no</span><a id="_idIndexMarker645" class="calibre3"/><span class="kobospan" id="kobo.420.1"> change in the behavior of the application, but if you use your browser’s developer tools to alter a cookie, you will find that it is ignored when the browser sends a request.</span></p>
<h2 class="heading1" id="_idParaDest-233"><span class="kobospan" id="kobo.421.1">Using a package to manage cookies</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.422.1">The </span><a id="_idIndexMarker646" class="calibre3"/><span class="kobospan" id="kobo.423.1">previous examples not only demonstrated how the </span><code class="inlinecode"><span class="kobospan" id="kobo.424.1">Set-Cookie</span></code><span class="kobospan" id="kobo.425.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.426.1">Cookie</span></code><span class="kobospan" id="kobo.427.1"> headers can be used but also showed that working directly with cookies can be awkward. </span><span class="kobospan" id="kobo.427.2">Express includes support for parsing cookies, as well as generating JSON and signed cookies, without the need to manually format or parse headers. </span></p>
<p class="normal"><span class="kobospan" id="kobo.428.1">Parsing </span><code class="inlinecode"><span class="kobospan" id="kobo.429.1">cookies</span></code><code class="inlinecode"><a id="_idIndexMarker647" class="calibre3"/></code><code class="inlinecode"><span class="kobospan" id="kobo.430.1">.cpp</span></code><span class="kobospan" id="kobo.431.1"> is done using a middleware component, which isn’t included in the main Express package. </span><span class="kobospan" id="kobo.431.2">Run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.432.1">Listing 13.8</span></em><span class="kobospan" id="kobo.433.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.434.1">part2app</span></code><span class="kobospan" id="kobo.435.1"> folder to install the parsing package and the TypeScript description of its API.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.436.1">Listing 13.8: Installing the cookie middleware package</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.437.1">npm install cookie-parser@1.4.6
npm install --save-dev @types/cookie-parser@1.4.6
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.438.1">Listing 13.9</span></em><span class="kobospan" id="kobo.439.1"> enables the cookie parsing middleware and specifies the secret key that will be used for signed cookies.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.440.1">Listing 13.9: Applying middleware in the forms.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.441.1">import express, { Express } from "express";
import repository  from "./data";
import { getJsonCookie, setJsonCookie } from "./cookies";
</span><strong class="screentext"><span class="kobospan" id="kobo.442.1">import cookieMiddleware from "cookie-parser"</span></strong><strong class="screentext"><span class="kobospan" id="kobo.443.1">;</span></strong><span class="kobospan" id="kobo.444.1">
const rowLimit = 10;
export const registerFormMiddleware = (app: Express) =&gt; {
    app.use(express.urlencoded({extended: true}));
    </span><strong class="screentext"><span class="kobospan" id="kobo.445.1">app.use(cookieMiddleware("mysecret"));</span></strong><span class="kobospan" id="kobo.446.1">
}
export const registerFormRoutes = (app: Express) =&gt; {
    // ...statements omitted for brevity...
</span><span class="kobospan" id="kobo.446.2">}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.447.1">The middleware populates the </span><code class="inlinecode"><span class="kobospan" id="kobo.448.1">Request</span></code><span class="kobospan" id="kobo.449.1"> object’s </span><code class="inlinecode"><span class="kobospan" id="kobo.450.1">cookies</span></code><span class="kobospan" id="kobo.451.1"> property for regular cookies and the </span><code class="inlinecode"><span class="kobospan" id="kobo.452.1">signedCookies</span></code><span class="kobospan" id="kobo.453.1"> property for signed cookies. </span><span class="kobospan" id="kobo.453.2">Cookies are set using a </span><code class="inlinecode"><span class="kobospan" id="kobo.454.1">cookie</span></code><span class="kobospan" id="kobo.455.1"> property defined by the </span><code class="inlinecode"><span class="kobospan" id="kobo.456.1">Response</span></code><span class="kobospan" id="kobo.457.1"> object. </span><em class="italic"><span class="kobospan" id="kobo.458.1">Listing 13.10</span></em><span class="kobospan" id="kobo.459.1"> uses these features to generate the cookies the application requires and adds a parameter to the </span><code class="inlinecode"><span class="kobospan" id="kobo.460.1">setCookie</span></code><span class="kobospan" id="kobo.461.1"> method to allow the default cookie options to be overridden.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.462.1">Listing 13.10: Using the Express cookie features in the cookies.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><strong class="screentext"><span class="kobospan" id="kobo.463.1">//import { IncomingMessage, ServerResponse } from "http";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.464.1">//import { signCookie, validateCookie } from "./cookies_signed";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.465.1">import { CookieOptions</span></strong><strong class="screentext"><span class="kobospan" id="kobo.466.1">, Request, Response } from "express";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.467.1">// const setheaderName = "Set-Cookie";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.468.1">// const cookieSecret = "mysecret";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.469.1">export const setCookie = (resp: Response, name: string,  val: string,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.470.1">        opts?: CookieOptions) =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.471.1">    resp.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.472.1">cookie(name, val, {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.473.1">        maxAge: 300 * 1000,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.474.1">        sameSite: "strict",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.475.1">        signed: true,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.476.1">        ...opts</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.477.1">    });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.478.1">}</span></strong><span class="kobospan" id="kobo.479.1">
export const setJsonCookie = (resp: Response, name: string, val: any) =&gt; {;
    </span><strong class="screentext"><span class="kobospan" id="kobo.480.1">setCookie(resp, name, JSON.stringify(val));</span></strong><span class="kobospan" id="kobo.481.1">
}
export const getCookie = (req: Request, key: string): string | undefined =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.482.1">return req.signedCookies[key];</span></strong><span class="kobospan" id="kobo.483.1">
}
export const getJsonCookie = (req: Request, key: string) : any =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.484.1">const cookie = getCookie(req, key);</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.485.1">    return cookie ? </span><span class="kobospan" id="kobo.485.2">JSON.parse(cookie) : undefined;</span></strong><span class="kobospan" id="kobo.486.1">
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.487.1">Express and</span><a id="_idIndexMarker648" class="calibre3"/><span class="kobospan" id="kobo.488.1">.the cookie middleware take responsibility for creating the </span><code class="inlinecode"><span class="kobospan" id="kobo.489.1">Set-Cookie</span></code><span class="kobospan" id="kobo.490.1"> header in responses and parsing </span><code class="inlinecode"><span class="kobospan" id="kobo.491.1">Cookie</span></code><span class="kobospan" id="kobo.492.1"> headers in requests. </span><span class="kobospan" id="kobo.492.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.493.1">Response.cookie</span></code><span class="kobospan" id="kobo.494.1"> method is used to create cookies and it accepts a name, a value, and a configuration object. </span><span class="kobospan" id="kobo.494.2">The configuration object has properties that correspond to the cookie attributes described in </span><em class="italic"><span class="kobospan" id="kobo.495.1">Table 13.3</span></em><span class="kobospan" id="kobo.496.1">, although there are some oddities. </span><span class="kobospan" id="kobo.496.2">For example, the </span><code class="inlinecode"><span class="kobospan" id="kobo.497.1">maxAge</span></code><span class="kobospan" id="kobo.498.1"> configuration is specified in milliseconds, rather than the seconds used by the </span><code class="inlinecode"><span class="kobospan" id="kobo.499.1">Max-Age</span></code><span class="kobospan" id="kobo.500.1"> attribute (which is why the value in </span><em class="italic"><span class="kobospan" id="kobo.501.1">Listing 13.10</span></em><span class="kobospan" id="kobo.502.1"> is multiplied by 1,000).</span></p>
<p class="normal"><span class="kobospan" id="kobo.503.1">The configuration object accepted by the </span><code class="inlinecode"><span class="kobospan" id="kobo.504.1">cookie</span></code><span class="kobospan" id="kobo.505.1"> method supports a </span><code class="inlinecode"><span class="kobospan" id="kobo.506.1">signed</span></code><span class="kobospan" id="kobo.507.1"> property, which enables cookie signing. </span><span class="kobospan" id="kobo.507.2">The key is obtained from the configuration used to set up the cookie middleware, which is another oddity but works, nonetheless. </span><span class="kobospan" id="kobo.507.3">Cookies are signed using an HMAC, in a similar way to the custom code.</span></p>
<p class="normal"><span class="kobospan" id="kobo.508.1">Cookies</span><a id="_idIndexMarker649" class="calibre3"/><span class="kobospan" id="kobo.509.1"> received in requests are available through the </span><code class="inlinecode"><span class="kobospan" id="kobo.510.1">Request.cookies</span></code><span class="kobospan" id="kobo.511.1"> and </span><code class="inlinecode"><span class="kobospan" id="kobo.512.1">Request.signedCookies</span></code><span class="kobospan" id="kobo.513.1"> properties, which return objects whose properties correspond to the names of the cookies in the request. </span><span class="kobospan" id="kobo.513.2">Signed cookies are easily detected because the </span><code class="inlinecode"><span class="kobospan" id="kobo.514.1">Response.cookie</span></code><span class="kobospan" id="kobo.515.1"> method creates signed cookie values with the prefix </span><code class="inlinecode"><span class="kobospan" id="kobo.516.1">s.</span></code><span class="kobospan" id="kobo.517.1">, and the values are automatically verified using the secret key with which the middleware was configured.</span></p>
<p class="normal"><span class="kobospan" id="kobo.518.1">The changes in </span><em class="italic"><span class="kobospan" id="kobo.519.1">Listing 13.10</span></em><span class="kobospan" id="kobo.520.1"> don’t change the behavior of the application, but the cookies have a different format, and cookies created using the custom code won’t pass verification.</span></p>
<h1 class="heading" id="_idParaDest-234"><span class="kobospan" id="kobo.521.1">Using sessions</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.522.1">Cookies </span><a id="_idIndexMarker650" class="calibre3"/><span class="kobospan" id="kobo.523.1">are suited to storing small amounts of data, but that data has to be sent to the application with every request, and any changes to that data have to be signed and sent in the response. </span></p>
<p class="normal"><span class="kobospan" id="kobo.524.1">An alternative is to have the application store the data and include just a reference to that data in the cookie. </span><span class="kobospan" id="kobo.524.2">This allows larger amounts of data to be stored without that data being included in every request and response.</span></p>
<p class="normal"><span class="kobospan" id="kobo.525.1">Session data can be stored as a set of key/value pairs, which makes it easy to use JavaScript objects to represent data. </span><span class="kobospan" id="kobo.525.2">I am going to start by creating a memory-based session system and then introduce persistent storage with a database, using a repository layer to make the transition easier. </span><span class="kobospan" id="kobo.525.3">Create the </span><code class="inlinecode"><span class="kobospan" id="kobo.526.1">src/server/sessions</span></code><span class="kobospan" id="kobo.527.1"> folder and add to it a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.528.1">repository.ts</span></code><span class="kobospan" id="kobo.529.1"> with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.530.1">Listing 13.11</span></em><span class="kobospan" id="kobo.531.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.532.1">Listing 13.11: The contents of the repository.ts file in the src/server/sessions folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.533.1">export type Session = {
    id: string,
    data: { [key: string]: any }
}
export interface SessionRepository {
    createSession() : Promise&lt;Session&gt;;
    getSession(id: string): Promise&lt;Session | undefined&gt;;
    saveSession(session: Session, expires: Date): Promise&lt;void&gt;;
    touchSession(session: Session, expires: Date) : Promise&lt;void&gt;
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.534.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.535.1">SessionRepository</span></code><span class="kobospan" id="kobo.536.1"> interface defines methods for creating a session, retrieving </span><a id="_idIndexMarker651" class="calibre3"/><span class="kobospan" id="kobo.537.1">a previously stored session, and saving or updating a session. </span><span class="kobospan" id="kobo.537.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.538.1">Session</span></code><span class="kobospan" id="kobo.539.1"> type defines the minimum requirements for a </span><code class="inlinecode"><span class="kobospan" id="kobo.540.1">Session</span></code><span class="kobospan" id="kobo.541.1">, which entails an ID and a </span><code class="inlinecode"><span class="kobospan" id="kobo.542.1">data</span></code><span class="kobospan" id="kobo.543.1"> property that can be assigned arbitrary data indexed by string values.</span></p>
<p class="normal"><span class="kobospan" id="kobo.544.1">To create a memory-based implementation of the interface, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.545.1">memory_repository.ts</span></code><span class="kobospan" id="kobo.546.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.547.1">src/server/sessions</span></code><span class="kobospan" id="kobo.548.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.549.1">Listing 13.12</span></em><span class="kobospan" id="kobo.550.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.551.1">Listing 13.12: The contents of the memory_repository.ts file in the src/server/sessions folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.552.1">import { Session, SessionRepository } from "./repository";
import { randomUUID } from "crypto";
type SessionWrapper = {
    session: Session,
    expires: Date
}
export class MemoryRepository implements SessionRepository {
    store = new Map&lt;string, SessionWrapper&gt;();
   
    async createSession(): Promise&lt;Session&gt; {
        return { id: randomUUID(), data: {} };
    }
    async getSession(id: string): Promise&lt;Session | undefined&gt; {
        const wrapper = this.store.get(id);
        if (wrapper &amp;&amp; wrapper.expires &gt; new Date(Date.now())) {
            return structuredClone(wrapper.session)
        }
    }
    async saveSession(session: Session, expires: Date): Promise&lt;void&gt; {
        this.store.set(session.id, { session, expires });
    }
    async touchSession(session: Session, expires: Date): Promise&lt;void&gt; {
        const wrapper = this.store.get(session.id);
        if (wrapper) {
            wrapper.expires = expires;
        }
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.553.1">The Node.js </span><code class="inlinecode"><span class="kobospan" id="kobo.554.1">crypto</span></code><span class="kobospan" id="kobo.555.1"> package defines the </span><code class="inlinecode"><span class="kobospan" id="kobo.556.1">randomUUID</span></code><span class="kobospan" id="kobo.557.1"> function, which generates unique IDs that </span><a id="_idIndexMarker652" class="calibre3"/><span class="kobospan" id="kobo.558.1">are suitable for use as session IDs. </span><span class="kobospan" id="kobo.558.2">The rest of the implementation uses a </span><code class="inlinecode"><span class="kobospan" id="kobo.559.1">Map</span></code><span class="kobospan" id="kobo.560.1"> to store </span><code class="inlinecode"><span class="kobospan" id="kobo.561.1">Session</span></code><span class="kobospan" id="kobo.562.1"> objects, which are checked for expiration when they are read.</span></p>
<p class="normal"><span class="kobospan" id="kobo.563.1">One point of note is that the </span><code class="inlinecode"><span class="kobospan" id="kobo.564.1">getSession</span></code><span class="kobospan" id="kobo.565.1"> method doesn’t return the </span><code class="inlinecode"><span class="kobospan" id="kobo.566.1">Session</span></code><span class="kobospan" id="kobo.567.1"> from the store, but instead creates a new object, like this: </span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.568.1">...
</span><span class="kobospan" id="kobo.568.2">if (wrapper &amp;&amp; wrapper.expires &gt; new Date(Date.now())) {
    return </span><strong class="screentext"><span class="kobospan" id="kobo.569.1">structuredClone</span></strong><span class="kobospan" id="kobo.570.1">(wrapper.session)
}
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.571.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.572.1">structuredClone</span></code><span class="kobospan" id="kobo.573.1"> function is part of the standard JavaScript API and it creates a deep copy of an object. </span><span class="kobospan" id="kobo.573.2">Session data should only be modified for </span><code class="inlinecode"><span class="kobospan" id="kobo.574.1">POST</span></code><span class="kobospan" id="kobo.575.1"> requests because the other HTTP methods are idempotent and creating new objects makes it easy to discard changes that are accidentally made for other HTTP methods, which you will see in the next section. </span><span class="kobospan" id="kobo.575.2">This is an issue only when storing states as JavaScript objects, where the </span><code class="inlinecode"><span class="kobospan" id="kobo.576.1">Session</span></code><span class="kobospan" id="kobo.577.1"> object associated with the request is the same as the one in the store. </span><span class="kobospan" id="kobo.577.2">It doesn’t arise when session data is stored in a database.</span></p>
<h2 class="heading1" id="_idParaDest-235"><span class="kobospan" id="kobo.578.1">Creating the session middleware</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.579.1">Sessions </span><a id="_idIndexMarker653" class="calibre3"/><span class="kobospan" id="kobo.580.1">need to be stored after the response has been generated so that any changes made to the session data are not lost, and that can most easily be done by creating an Express middleware component. </span><span class="kobospan" id="kobo.580.2">Add a file </span><code class="inlinecode"><span class="kobospan" id="kobo.581.1">middleware.ts</span></code><span class="kobospan" id="kobo.582.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.583.1">src/server/sessions</span></code><span class="kobospan" id="kobo.584.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.585.1">Listing 13.13</span></em><span class="kobospan" id="kobo.586.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.587.1">Listing 13.13: The contents of the middleware.ts file in the src/server/sessions folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.588.1">import { Request, Response, NextFunction } from "express";
import { SessionRepository, Session } from "./repository";
import { MemoryRepository } from "./memory_repository";
import { setCookie, getCookie } from "../cookies";
const session_cookie_name = "custom_session";
const expiry_seconds = 300;
const getExpiryDate = () =&gt; new Date(Date.now() + (expiry_seconds * 1_000));
export const customSessionMiddleware = () =&gt; {
    const repo: SessionRepository = new MemoryRepository();
    return async (req: Request, resp: Response, next: NextFunction) =&gt; {
       
        const id = getCookie(req, session_cookie_name);
   
        const session = (id ? </span><span class="kobospan" id="kobo.588.2">await repo.getSession(id) : undefined)
                            ?? </span><span class="kobospan" id="kobo.588.3">await repo.createSession();
       
        (req as any).session = session;
        setCookie(resp, session_cookie_name, session.id, {
            maxAge: expiry_seconds * 1000
        })
        resp.once("finish", async () =&gt; {
            if ( Object.keys(session.data).length &gt; 0) {
                if (req.method == "POST") {
                    await repo.saveSession(session, getExpiryDate());
                } else {
                    await repo.touchSession(session, getExpiryDate());
                }
            }
        })
       
        next();
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.589.1">This middleware component reads a cookie that contains a session ID and uses it to get the session from the repository and associate it with the </span><code class="inlinecode"><span class="kobospan" id="kobo.590.1">Request</span></code><span class="kobospan" id="kobo.591.1"> object by adding a property named </span><code class="inlinecode"><span class="kobospan" id="kobo.592.1">session</span></code><span class="kobospan" id="kobo.593.1">. </span><span class="kobospan" id="kobo.593.2">If there is no cookie, or no session can be found with the ID, then a new session is started.</span></p>
<p class="normal"><span class="kobospan" id="kobo.594.1">The session</span><a id="_idIndexMarker654" class="calibre3"/><span class="kobospan" id="kobo.595.1"> can only be safely stored once the response has been generated and when it is certain that no further changes will be made. </span><span class="kobospan" id="kobo.595.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.596.1">finish</span></code><span class="kobospan" id="kobo.597.1"> event is triggered once a response is complete, and the </span><code class="inlinecode"><span class="kobospan" id="kobo.598.1">once</span></code><span class="kobospan" id="kobo.599.1"> method is used to handle the event and store the session.</span></p>
<p class="normal"><span class="kobospan" id="kobo.600.1">Sessions are only stored for HTTP </span><code class="inlinecode"><span class="kobospan" id="kobo.601.1">POST</span></code><span class="kobospan" id="kobo.602.1"> requests and when properties have been assigned to the </span><code class="inlinecode"><span class="kobospan" id="kobo.603.1">data</span></code><span class="kobospan" id="kobo.604.1"> object. </span><span class="kobospan" id="kobo.604.2">For other HTTP methods, the </span><code class="inlinecode"><span class="kobospan" id="kobo.605.1">touchSession</span></code><span class="kobospan" id="kobo.606.1"> method is used to extend the session expiry time but the session data isn’t stored.</span></p>
<p class="normal"><span class="kobospan" id="kobo.607.1">Updating the session expiry after every request creates a </span><em class="italic"><span class="kobospan" id="kobo.608.1">sliding expiry</span></em><span class="kobospan" id="kobo.609.1">, which means that the session can remain valid indefinitely. </span><span class="kobospan" id="kobo.609.2">This is the most common approach because it means sessions are valid for as long as the user is active and will time out after a period of inactivity.</span></p>
<h2 class="heading1" id="_idParaDest-236"><span class="kobospan" id="kobo.610.1">Using the session feature</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.611.1">The </span><a id="_idIndexMarker655" class="calibre3"/><span class="kobospan" id="kobo.612.1">middleware component adds a </span><code class="inlinecode"><span class="kobospan" id="kobo.613.1">session</span></code><span class="kobospan" id="kobo.614.1"> property to requests, but this isn’t a part of the standard Express </span><code class="inlinecode"><span class="kobospan" id="kobo.615.1">Request</span></code><span class="kobospan" id="kobo.616.1"> type and isn’t known by the TypeScript compiler. </span><span class="kobospan" id="kobo.616.2">There are two good ways to solve this problem: a helper function that reads the </span><code class="inlinecode"><span class="kobospan" id="kobo.617.1">session</span></code><span class="kobospan" id="kobo.618.1"> property or a new type that extends the one provided by Express. </span><span class="kobospan" id="kobo.618.2">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.619.1">session_helpers.ts</span></code><span class="kobospan" id="kobo.620.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.621.1">src/server/sessions</span></code><span class="kobospan" id="kobo.622.1"> folder with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.623.1">Listing 13.14</span></em><span class="kobospan" id="kobo.624.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.625.1">Listing 13.14: The contents of the session_helpers.ts file in the src/server/sessions folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.626.1">import { Request } from "express";
import { Session } from "./repository";
export const getSession = (req: Request): Session =&gt; (req as any).session;
declare global {
    module Express {
        interface Request {
            session: Session
        }
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.627.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.628.1">getSession</span></code><span class="kobospan" id="kobo.629.1"> function receives a </span><code class="inlinecode"><span class="kobospan" id="kobo.630.1">Request</span></code><span class="kobospan" id="kobo.631.1"> object and returns the </span><code class="inlinecode"><span class="kobospan" id="kobo.632.1">session</span></code><span class="kobospan" id="kobo.633.1"> property by </span><a id="_idIndexMarker656" class="calibre3"/><span class="kobospan" id="kobo.634.1">using </span><code class="inlinecode"><span class="kobospan" id="kobo.635.1">as any</span></code><span class="kobospan" id="kobo.636.1"> to work around the TypeScript type checks. </span><span class="kobospan" id="kobo.636.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.637.1">declare</span></code><span class="kobospan" id="kobo.638.1"> keyword is used to tell TypeScript that the </span><code class="inlinecode"><span class="kobospan" id="kobo.639.1">Request</span></code><span class="kobospan" id="kobo.640.1"> interface has an additional property.</span></p>
<p class="normal"><span class="kobospan" id="kobo.641.1">Of the two approaches, my preference is the helper function, which isn’t as elegant, but which is more easily understood and makes it obvious how the </span><code class="inlinecode"><span class="kobospan" id="kobo.642.1">Session</span></code><span class="kobospan" id="kobo.643.1"> object is being obtained. </span><em class="italic"><span class="kobospan" id="kobo.644.1">Listing 13.15</span></em><span class="kobospan" id="kobo.645.1"> applies both approaches to switch from storing session data in the cookie to using the session repository.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.646.1">Listing 13.15: Using the session repository in the forms.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.647.1">import express, { Express } from "express";
import repository  from "./data";
import { getJsonCookie, setJsonCookie } from "./cookies";
import cookieMiddleware from "cookie-parser";
</span><strong class="screentext"><span class="kobospan" id="kobo.648.1">import { customSessionMiddleware } from "./sessions/middleware";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.649.1">import { getSession } from "./sessions/session_helpers";</span></strong><span class="kobospan" id="kobo.650.1">
const rowLimit = 10;
export const registerFormMiddleware = (app: Express) =&gt; {
    app.use(express.urlencoded({extended: true}))
    app.use(cookieMiddleware("mysecret"));
    </span><strong class="screentext"><span class="kobospan" id="kobo.651.1">app.use(customSessionMiddleware());</span></strong><span class="kobospan" id="kobo.652.1">
}
export const registerFormRoutes = (app: Express) =&gt; {
    app.get("/form", async (req, resp) =&gt; {
        resp.render("age", {
            history: await repository.getAllResults(rowLimit),
            </span><strong class="screentext"><span class="kobospan" id="kobo.653.1">personalHistory: getSession(req).data.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.654.1">personalHistory</span></strong><span class="kobospan" id="kobo.655.1">
        });
    });
    app.post("/form", async (req, resp) =&gt; {
        const nextage = Number.parseInt(req.body.age)
            + Number.parseInt(req.body.years);
        await repository.saveResult({...req.body, nextage });
        </span><strong class="screentext"><span class="kobospan" id="kobo.656.1">req.session.data.personalHistory = [{</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.657.1">            name: req.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.658.1">body.name, age: req.body.age,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.659.1">            years: req.body.years, nextage},</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.660.1">            ...(req.session.data.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.661.1">personalHistory || [])].splice(0, 5);</span></strong><span class="kobospan" id="kobo.662.1">
       
        const context = {
            ...req.body, nextage,
            history: await repository.getAllResults(rowLimit),
           </span><strong class="screentext"><span class="kobospan" id="kobo.663.1"> personalHistory: req.</span></strong><strong class="screentext"><span class="kobospan" id="kobo.664.1">session.data.personalHistory</span></strong><span class="kobospan" id="kobo.665.1">
        };
        resp.render("age", context);  
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.666.1">The </span><a id="_idIndexMarker657" class="calibre3"/><span class="kobospan" id="kobo.667.1">changes enable the session middleware and store the user’s history using the new session feature. </span><span class="kobospan" id="kobo.667.2">Once again, there is no change in the way the application behaves, because the changes are invisible to the user. </span><span class="kobospan" id="kobo.667.3">As the form is submitted, the cookie sent by the browser is used to load the session data from the repository, which is used in the response, as shown in </span><em class="italic"><span class="kobospan" id="kobo.668.1">Figure 13.4</span></em><span class="kobospan" id="kobo.669.1">.</span></p>
<figure class="mediaobject"><span class="kobospan" id="kobo.670.1"><img alt="" src="../Images/B21959_13_04.png" class="calibre7"/></span></figure>
<p class="packt_figref"><span class="kobospan" id="kobo.671.1">Figure 13.4: Using session data</span></p>
<h2 class="heading1" id="_idParaDest-237"><span class="kobospan" id="kobo.672.1">Storing session data in a database</span></h2>
<p class="normal1"><span class="kobospan" id="kobo.673.1">Storing session </span><a id="_idIndexMarker658" class="calibre3"/><span class="kobospan" id="kobo.674.1">data in memory is a good way to understand how the pieces fit together but isn’t ideal for real projects where more persistent storage is usually required. </span><span class="kobospan" id="kobo.674.2">The conventional approach is to store session data in a database, which ensures that sessions are persistent, and allows for large numbers of sessions without exhausting system memory.</span></p>
<p class="normal"><span class="kobospan" id="kobo.675.1">Add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.676.1">orm_models.ts</span></code><span class="kobospan" id="kobo.677.1"> to the </span><code class="inlinecode"><span class="kobospan" id="kobo.678.1">src/server/sessions</span></code><span class="kobospan" id="kobo.679.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.680.1">Listing 13.16</span></em><span class="kobospan" id="kobo.681.1">. </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.682.1">Listing 13.16: The contents of the orm_models.ts file in the src/server/sessions folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.683.1">import { DataTypes, InferAttributes, InferCreationAttributes, Model,
    Sequelize } from "sequelize";
export class SessionModel extends Model&lt;InferAttributes&lt;SessionModel&gt;,
        InferCreationAttributes&lt;SessionModel&gt;&gt; {
    declare id: string
    declare data: any;
    declare expires: Date
}
export const initializeModel = (sequelize: Sequelize) =&gt; {
    SessionModel.init({
        id: { type: DataTypes.STRING, primaryKey: true },
        data: { type: DataTypes.JSON },
        expires: { type: DataTypes.DATE }
    }, { sequelize });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.684.1">A single </span><a id="_idIndexMarker659" class="calibre3"/><span class="kobospan" id="kobo.685.1">model class can represent a session and the IDs generated by the </span><code class="inlinecode"><span class="kobospan" id="kobo.686.1">crypto.randomUUID</span></code><span class="kobospan" id="kobo.687.1"> function can be used as primary keys. </span><span class="kobospan" id="kobo.687.2">Sequelize has good support for working with JavaScript dates and will automatically serialize and deserialize objects when the type of a column is </span><code class="inlinecode"><span class="kobospan" id="kobo.688.1">DataTypes.JSON</span></code><span class="kobospan" id="kobo.689.1">. </span><span class="kobospan" id="kobo.689.2">To create a session repository, add a file named </span><code class="inlinecode"><span class="kobospan" id="kobo.690.1">orm_repository.ts</span></code><span class="kobospan" id="kobo.691.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.692.1">src/server/sessions</span></code><span class="kobospan" id="kobo.693.1"> folder, with the content shown in </span><em class="italic"><span class="kobospan" id="kobo.694.1">Listing 13.17</span></em><span class="kobospan" id="kobo.695.1">. </span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.696.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.697.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.698.1">initModelAndDatabase</span></code><span class="kobospan" id="kobo.699.1"> method in </span><em class="italic"><span class="kobospan" id="kobo.700.1">Listing 13.17</span></em><span class="kobospan" id="kobo.701.1"> calls the </span><code class="inlinecode"><span class="kobospan" id="kobo.702.1">drop</span></code><span class="kobospan" id="kobo.703.1"> method, which will reset the database every time the application is started or restarted. </span><span class="kobospan" id="kobo.703.2">This should not be done in a real project, but it is helpful for an example and ensures that any changes in the code files will be reflected in the database.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.704.1">Listing 13.17: The contents of the orm_repository.ts file in the src/server/sessions folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.705.1">import { Op, Sequelize } from "sequelize";
import { Session, SessionRepository } from "./repository";
import { SessionModel, initializeModel } from "./orm_models";
import { randomUUID } from "crypto";
export class OrmRepository implements SessionRepository {
    sequelize: Sequelize;
    constructor() {
        this.sequelize = new Sequelize({
            dialect: "sqlite",
            storage: "orm_sessions.db",
            logging: console.log,
            logQueryParameters: true
        });
        this.initModelAndDatabase();
    }
   
    async initModelAndDatabase() : Promise&lt;void&gt; {
        initializeModel(this.sequelize);
        await this.sequelize.drop();       
        await this.sequelize.sync();
    }
    async createSession(): Promise&lt;Session&gt; {
        return { id: randomUUID(), data: {} };
    }
    async getSession(id: string): Promise&lt;Session | undefined&gt; {
        const dbsession = await SessionModel.findOne({
            where: { id, expires: { [Op.gt] : new Date(Date.now()) }}
        });
        if (dbsession) {
            return { id, data: dbsession.data };
        }
    }
    async saveSession(session: Session, expires: Date): Promise&lt;void&gt; {
        await SessionModel.upsert({
            id: session.id,
            data: session.data,
            expires
        });
    }
    async touchSession(session: Session, expires: Date): Promise&lt;void&gt; {
        await SessionModel.update({ expires }, { where: { id: session.id } });
    }
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.706.1">The repository is similar to the one created for application data, but there are a couple of points that show how an ORM (Object Relational Mapping) like Sequelize can</span><a id="_idIndexMarker660" class="calibre3"/><span class="kobospan" id="kobo.707.1"> simplify dealing with a database, albeit with awkward JavaScript code. </span><span class="kobospan" id="kobo.707.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.708.1">getSession</span></code><span class="kobospan" id="kobo.709.1"> method queries the database to find a row with a given primary key and an expiry date in the future, which is done using the </span><code class="inlinecode"><span class="kobospan" id="kobo.710.1">findOne</span></code><span class="kobospan" id="kobo.711.1"> method and a </span><code class="inlinecode"><span class="kobospan" id="kobo.712.1">where</span></code><span class="kobospan" id="kobo.713.1"> expression, like this:</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.714.1">...
</span><span class="kobospan" id="kobo.714.2">const dbsession = await SessionModel.findOne({
    </span><strong class="screentext"><span class="kobospan" id="kobo.715.1">where: { id, expires: { [Op.gt] : new </span></strong><strong class="screentext"><span class="kobospan" id="kobo.716.1">Date(Date.now()) }}</span></strong><span class="kobospan" id="kobo.717.1">
});
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.718.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.719.1">Op.gt</span></code><span class="kobospan" id="kobo.720.1"> value represents a greater comparison and allows the search to match rows where the date stored in the </span><code class="inlinecode"><span class="kobospan" id="kobo.721.1">expires</span></code><span class="kobospan" id="kobo.722.1"> column is greater than the current date. </span><span class="kobospan" id="kobo.722.2">This isn’t the most natural way to express queries, but it works and allows queries to be expressed without needing to write SQL.</span></p>
<p class="normal"><span class="kobospan" id="kobo.723.1">The Sequelize </span><code class="inlinecode"><span class="kobospan" id="kobo.724.1">upsert</span></code><span class="kobospan" id="kobo.725.1"> method is used to update a data row if it exists and insert one if not, which makes it easy to implement the </span><code class="inlinecode"><span class="kobospan" id="kobo.726.1">saveSession</span></code><span class="kobospan" id="kobo.727.1"> method. </span><span class="kobospan" id="kobo.727.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.728.1">touchSession</span></code><span class="kobospan" id="kobo.729.1"> method is implemented with the </span><code class="inlinecode"><span class="kobospan" id="kobo.730.1">update</span></code><span class="kobospan" id="kobo.731.1"> method, which allows specific columns to be updated.</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.732.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.733.1">I have not added any support for deleting expired sessions in this chapter. </span><span class="kobospan" id="kobo.733.2">As a rule, I avoid deleting any data automatically because it is easy for things to go wrong. </span><span class="kobospan" id="kobo.733.3">Storage space is relatively affordable but if you need to actively manage the size of the session database, then backing up before a manual cleanup is a safer option. </span></p>
</div>
<p class="normal"><span class="kobospan" id="kobo.734.1">The final step is to update the session middleware to use the new repository, as shown in </span><em class="italic"><span class="kobospan" id="kobo.735.1">Listing 13.18</span></em><span class="kobospan" id="kobo.736.1">.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.737.1">Listing 13.18: Changing repository in the middleware.ts file in the src/server/sessions folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.738.1">import { Request, Response, NextFunction } from "express";
import { SessionRepository, Session } from "./repository";
</span><strong class="screentext"><span class="kobospan" id="kobo.739.1">//import { MemoryRepository } from "./memory_repository";</span></strong><span class="kobospan" id="kobo.740.1">
import { setCookie, getCookie } from "../cookies";
i</span><strong class="screentext"><span class="kobospan" id="kobo.741.1">mport { OrmRepository } from "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.742.1">./orm_repository";</span></strong><span class="kobospan" id="kobo.743.1">
const session_cookie_name = "custom_session";
const expiry_seconds = 300;
const getExpiryDate = () =&gt; new Date(Date.now() + (expiry_seconds * 1_000));
export const customSessionMiddleware = () =&gt; {
    </span><strong class="screentext"><span class="kobospan" id="kobo.744.1">//const repo: SessionRepository = new MemoryRepository();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.745.1">    const repo: SessionRepository = </span></strong><strong class="screentext"><span class="kobospan" id="kobo.746.1">new OrmRepository();</span></strong><span class="kobospan" id="kobo.747.1">
    return async (req: Request, resp: Response, next: NextFunction) =&gt; {
       
        // ...statements omitted for brevity...
    </span><span class="kobospan" id="kobo.747.2">}
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.748.1">No other</span><a id="_idIndexMarker661" class="calibre3"/><span class="kobospan" id="kobo.749.1"> change is required to use the database because the new repository implements the same interface as the old one. </span></p>
<p class="normal"><span class="kobospan" id="kobo.750.1">The key difference is that you will see the database queries being logged by the Node.js console as the application is running, starting with the statement that creates the database table:</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.751.1">...
</span><span class="kobospan" id="kobo.751.2">Executing (default): CREATE TABLE IF NOT EXISTS `SessionModels` (`id` VARCHAR(255)
    PRIMARY KEY, `data` JSON, `expires` DATETIME, `createdAt` DATETIME NOT NULL,
    `updatedAt` DATETIME NOT NULL);
...
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.752.1">No SQL was required to prepare or query the database and the process of creating and parsing JSON is handled automatically.</span></p>
<h1 class="heading" id="_idParaDest-238"><span class="kobospan" id="kobo.753.1">Using a package for sessions</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.754.1">Now that</span><a id="_idIndexMarker662" class="calibre3"/><span class="kobospan" id="kobo.755.1"> you understand how sessions work, it is time to replace the custom code with an off-the-shelf sessions package, such as the one provided by Express. </span><span class="kobospan" id="kobo.755.2">Run the commands shown in </span><em class="italic"><span class="kobospan" id="kobo.756.1">Listing 13.19</span></em><span class="kobospan" id="kobo.757.1"> in the </span><code class="inlinecode"><span class="kobospan" id="kobo.758.1">part2app</span></code><span class="kobospan" id="kobo.759.1"> folder to install the sessions package, the type description package for its API, and a package that stores sessions in a database </span><a id="_idIndexMarker663" class="calibre3"/><span class="kobospan" id="kobo.760.1">using Sequelize. </span><span class="kobospan" id="kobo.760.2">(There is a wide range of database options for the express-sessions package, described at </span><a href="https://github.com/expressjs/session" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.761.1">https://github.com/expressjs/session</span></span></a><span class="kobospan" id="kobo.762.1">). </span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.763.1">Listing 13.19: Installing packages</span></p>
<pre class="programlisting1"><code class="hljs-con"><span class="kobospan" id="kobo.764.1">npm install express-session@1.17.3
npm install connect-session-sequelize@7.1.7
npm install --save-dev @types/express-session@1.17.10
</span></code></pre>
<p class="normal"><em class="italic"><span class="kobospan" id="kobo.765.1">Listing 13.20</span></em><span class="kobospan" id="kobo.766.1"> prepares </span><a id="_idIndexMarker664" class="calibre3"/><span class="kobospan" id="kobo.767.1">the application to use the session package and the storage package.</span></p>
<p class="packt_figref"><span class="kobospan" id="kobo.768.1">Listing 13.20: Using the session package in the session_helpers.ts file in the src/server/sessions folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.769.1">import { Request } from "express";
</span><strong class="screentext"><span class="kobospan" id="kobo.770.1">//import { Session } from "./repository";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.771.1">import session, { SessionData } from "express-session";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.772.1">import sessionStore from "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.773.1">connect-session-sequelize";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.774.1">import { Sequelize } from "sequelize";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.775.1">import { Result } from "../data/repository";</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.776.1">export</span></strong><strong class="screentext"><span class="kobospan" id="kobo.777.1"> const getSession = (req: Request): SessionData =&gt; (req as any).session;</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.778.1">// declare global {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.779.1">//     module Express {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.780.1">//         interface Request {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.781.1">//             session: Session</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.782.1">//         }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.783.1">//     }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.784.1">// }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.785.1">declare module "express-session" {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.786.1">    interface </span></strong><strong class="screentext"><span class="kobospan" id="kobo.787.1">SessionData {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.788.1">       personalHistory: Result[];</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.789.1">    }</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.790.1">}</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.791.1">export const sessionMiddleware = () =&gt; {</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.792.1">    const sequelize = new Sequelize({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.793.1">        dialect: "</span></strong><strong class="screentext"><span class="kobospan" id="kobo.794.1">sqlite",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.795.1">        storage: "pkg_sessions.db"</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.796.1">    });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.797.1">    const store = new (sessionStore(session.Store))({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.798.1">        db: sequelize</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.799.1">    });</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.800.1">    store.sync();</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.801.1">    return </span></strong><strong class="screentext"><span class="kobospan" id="kobo.802.1">session({</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.803.1">        secret: "mysecret",</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.804.1">        store: store,</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.805.1">        cookie: { maxAge: 300 * 1000, sameSite: "strict" },</span></strong>
<strong class="screentext"> </strong><strong class="screentext"><span class="kobospan" id="kobo.806.1">resave: false, saveUninitialized: false</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.807.1">    })</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.808.1">}</span></strong>
</code></pre>
<p class="normal"><span class="kobospan" id="kobo.809.1">Adjustments </span><a id="_idIndexMarker665" class="calibre3"/><span class="kobospan" id="kobo.810.1">are required to use the package, including </span><em class="italic"><span class="kobospan" id="kobo.811.1">commenting out</span></em><span class="kobospan" id="kobo.812.1"> the </span><code class="inlinecode"><span class="kobospan" id="kobo.813.1">declare</span></code><span class="kobospan" id="kobo.814.1"> statement that adds the </span><code class="inlinecode"><span class="kobospan" id="kobo.815.1">Request.session</span></code><span class="kobospan" id="kobo.816.1"> property because there is a similar statement defined by the </span><code class="inlinecode"><span class="kobospan" id="kobo.817.1">express-session</span></code><span class="kobospan" id="kobo.818.1"> package.</span></p>
<p class="normal"><span class="kobospan" id="kobo.819.1">A new </span><code class="inlinecode"><span class="kobospan" id="kobo.820.1">declare</span></code><span class="kobospan" id="kobo.821.1"> statement is required to add custom properties to the </span><code class="inlinecode"><span class="kobospan" id="kobo.822.1">SessionData</span></code><span class="kobospan" id="kobo.823.1"> object, which is the type used to represent session data by the package. </span><span class="kobospan" id="kobo.823.2">There is a </span><code class="inlinecode"><span class="kobospan" id="kobo.824.1">Session</span></code><span class="kobospan" id="kobo.825.1"> type, but it serves a purpose similar to the wrapper type employed by the custom code. </span><span class="kobospan" id="kobo.825.2">In this case, a </span><code class="inlinecode"><span class="kobospan" id="kobo.826.1">personHistory</span></code><span class="kobospan" id="kobo.827.1"> property has been added to minimize the changes required to use the package.</span></p>
<p class="normal"><span class="kobospan" id="kobo.828.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.829.1">sessionMiddleware</span></code><span class="kobospan" id="kobo.830.1"> function creates a </span><code class="inlinecode"><span class="kobospan" id="kobo.831.1">Sequelize</span></code><span class="kobospan" id="kobo.832.1"> object that uses SQLite and uses it to create a store for session data using the </span><code class="inlinecode"><span class="kobospan" id="kobo.833.1">connect-session-sequelize</span></code><span class="kobospan" id="kobo.834.1"> package. </span><span class="kobospan" id="kobo.834.2">The </span><code class="inlinecode"><span class="kobospan" id="kobo.835.1">sync</span></code><span class="kobospan" id="kobo.836.1"> method is called to initialize the database, and the default export from the </span><code class="inlinecode"><span class="kobospan" id="kobo.837.1">express-session</span></code><span class="kobospan" id="kobo.838.1"> package is used to create a middleware component. </span><span class="kobospan" id="kobo.838.2">The configuration options for the session store are described at </span><a href="https://github.com/expressjs/session" class="calibre3"><span class="calibre3"><span class="kobospan" id="kobo.839.1">https://github.com/expressjs/session</span></span></a><span class="kobospan" id="kobo.840.1">, but the configuration in </span><em class="italic"><span class="kobospan" id="kobo.841.1">Listing 13.20</span></em><span class="kobospan" id="kobo.842.1"> specifies the secret key for signing cookies, the Sequelize store, and the cookie settings so that the package behaves in the same way as the custom code. </span><span class="kobospan" id="kobo.842.2">Small changes are required to use the session package, as shown in </span><em class="italic"><span class="kobospan" id="kobo.843.1">Listing 13.21</span></em><span class="kobospan" id="kobo.844.1">.</span></p>
<div class="note">
<p class="normal"><strong class="screentext"><span class="kobospan" id="kobo.845.1">Note</span></strong></p>
<p class="normal"><span class="kobospan" id="kobo.846.1">The </span><code class="inlinecode"><span class="kobospan" id="kobo.847.1">cookie-parser</span></code><span class="kobospan" id="kobo.848.1"> package can be used in the same application as the </span><code class="inlinecode"><span class="kobospan" id="kobo.849.1">express-session</span></code><span class="kobospan" id="kobo.850.1"> package, but you must ensure that both are configured with the same secret key.</span></p>
</div>
<p class="packt_figref"><span class="kobospan" id="kobo.851.1">Listing 13.21: Using the session package in the forms.ts file in the src/server folder</span></p>
<pre class="programlisting"><code class="hljs-code"><span class="kobospan" id="kobo.852.1">import express, { Express } from "express";
import repository  from "./data";
import { getJsonCookie, setJsonCookie } from "./cookies";
import cookieMiddleware from "cookie-parser";
import { customSessionMiddleware } from "./sessions/middleware";
</span><strong class="screentext"><span class="kobospan" id="kobo.853.1">import { getSession, sessionMiddleware } from "./sessions/session_helpers";</span></strong><span class="kobospan" id="kobo.854.1">
const rowLimit = 10;
export const registerFormMiddleware = (app: Express) =&gt; {
    app.use(express.urlencoded({extended: true}))
    app.use(cookieMiddleware("mysecret"));
    </span><strong class="screentext"><span class="kobospan" id="kobo.855.1">//app.use(customSessionMiddleware());</span></strong>
<strong class="screentext"><span class="kobospan" id="kobo.856.1">    app.use(sessionMiddleware());</span></strong><span class="kobospan" id="kobo.857.1">
}
export const registerFormRoutes = (app: Express) =&gt; {
    app.get("/form", async (req, resp) =&gt; {
        resp.render("age", {
            history: await repository.getAllResults(rowLimit),
            </span><strong class="screentext"><span class="kobospan" id="kobo.858.1">personalHistory: getSession(req).personalHistory</span></strong><span class="kobospan" id="kobo.859.1">
        });
    });
    app.post("/form", async (req, resp) =&gt; {
        const nextage = Number.parseInt(req.body.age)
            + Number.parseInt(req.body.years);
        await repository.saveResult({...req.body, nextage });
        </span><strong class="screentext"><span class="kobospan" id="kobo.860.1">req.session.personalHistory = [{</span></strong><span class="kobospan" id="kobo.861.1">
            id: 0, name: req.body.name, age: req.body.age,
            years: req.body.years, nextage},
            ..</span><strong class="screentext"><span class="kobospan" id="kobo.862.1">.(req.session.personalHistory || [])].splice(0, 5);</span></strong><span class="kobospan" id="kobo.863.1">
       
        const context = {
            ...req.body, nextage,
            history: await repository.getAllResults(rowLimit),
            </span><strong class="screentext"><span class="kobospan" id="kobo.864.1">personalHistory: req.session.personalHistory</span></strong><span class="kobospan" id="kobo.865.1">
        };
        resp.render("age", context);  
    });
}
</span></code></pre>
<p class="normal"><span class="kobospan" id="kobo.866.1">The changes replace</span><a id="_idIndexMarker666" class="calibre3"/><span class="kobospan" id="kobo.867.1"> the custom middleware and read the </span><code class="inlinecode"><span class="kobospan" id="kobo.868.1">personalHistory</span></code><span class="kobospan" id="kobo.869.1"> property directly on the object returned by the </span><code class="inlinecode"><span class="kobospan" id="kobo.870.1">session</span></code><span class="kobospan" id="kobo.871.1"> property. </span><span class="kobospan" id="kobo.871.2">The schema of the database used to store sessions is different, which you can see in the SQL statements that are written out by the Node.js console, but otherwise, the behavior of the application is unchanged.</span></p>
<h1 class="heading" id="_idParaDest-239"><span class="kobospan" id="kobo.872.1">Summary</span></h1>
<p class="normal1"><span class="kobospan" id="kobo.873.1">In this chapter, I explained how an application can use cookies to correlate HTTP requests to create a stateful user experience over a stateless protocol:</span></p>
<ul class="calibre4">
<li class="bulletlist"><span class="kobospan" id="kobo.874.1">Cookies are created by adding the </span><code class="inlinecode"><span class="kobospan" id="kobo.875.1">Set-Cookie</span></code><span class="kobospan" id="kobo.876.1"> header to responses.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.877.1">Browers include cookies in requests with the </span><code class="inlinecode"><span class="kobospan" id="kobo.878.1">Cookie</span></code><span class="kobospan" id="kobo.879.1"> header.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.880.1">Cookies are configured using cookie attributes, including setting an expiration time, after which the browser will no longer include the cookie in requests.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.881.1">Cookies can be signed, which reveals when they have been altered.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.882.1">Cookies can be used to store small amounts of data, but this data must then be repeatedly transferred between the browser and the server.</span></li>
<li class="bulletlist1"><span class="kobospan" id="kobo.883.1">Cookies can also be used to store session IDs, which are used to load data stored by the server. </span><span class="kobospan" id="kobo.883.2">This makes the server more complicated but means that only the ID is transferred between the browser and the server.</span></li>
</ul>
<p class="normal"><span class="kobospan" id="kobo.884.1">In the next chapter, I will describe how RESTful web services can be used to provide data to clients without including HTML.</span></p>
</div>
</body></html>