<html><head></head><body>
  <div id="_idContainer028">
   <h1 class="chapter-number" id="_idParaDest-171">
    <a id="_idTextAnchor178">
    </a>
    <span class="koboSpan" id="kobo.1.1">
     6
    </span>
   </h1>
   <h1 id="_idParaDest-172">
    <a id="_idTextAnchor179">
    </a>
    <span class="koboSpan" id="kobo.2.1">
     Working with Fastify – The Web Framework
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.3.1">
     In
    </span>
    <a href="B19212_04.xhtml#_idTextAnchor100">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.4.1">
        Chapter 4
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.5.1">
     , we learned about the low-level APIs provided by Node.js core for building web applications.
    </span>
    <span class="koboSpan" id="kobo.5.2">
     However, using those APIs can be challenging sometimes, demanding substantial effort to translate conceptual ideas into functional software.
    </span>
    <span class="koboSpan" id="kobo.5.3">
     For this reason, web frameworks are pivotal for quickly developing robust HTTP servers within the Node.js ecosystem.
    </span>
    <span class="koboSpan" id="kobo.5.4">
     A web framework abstracts web protocols into higher-level APIs, allowing you to implement your business logic without the need to address everyday tasks, such as parsing the body of an HTTP request or reinventing an
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.6.1">
      internal router.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.7.1">
     This chapter introduces Fastify, the fastest web framework with the lowest overhead available for Node.js.
    </span>
    <span class="koboSpan" id="kobo.7.2">
     Fastify places a high emphasis on enhancing the developer’s experience, powering you to build APIs while ensuring outstanding application performance.
    </span>
    <span class="koboSpan" id="kobo.7.3">
     It closely adheres to web standards, ensuring compatibility and reliability.
    </span>
    <span class="koboSpan" id="kobo.7.4">
     Moreover, it boasts an impressive degree of extensibility, enabling you to customize your server to align precisely with your
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.8.1">
      unique requirements.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.9.1">
     We will explore Fastify through the following
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.10.1">
      learning path:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.11.1">
      Creating an API starter
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.12.1">
       using Fastify
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.13.1">
      Splitting the code into
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.14.1">
       small plugins
      </span>
     </span>
    </li>
    <li>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.15.1">
       Adding routes
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.16.1">
      Implementing authentication
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.17.1">
       with hooks
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.18.1">
      Breaking the encapsulation
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.19.1">
       using hooks
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.20.1">
      Implementing the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.21.1">
       business logic
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.22.1">
      Validating the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.23.1">
       input data
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.24.1">
      Enhancing application performance
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.25.1">
       with serialization
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.26.1">
      Configuring and testing a
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.27.1">
       Fastify application
      </span>
     </span>
    </li>
   </ul>
   <h1 id="_idParaDest-173">
    <a id="_idTextAnchor180">
    </a>
    <span class="koboSpan" id="kobo.28.1">
     Technical requirements
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.29.1">
     To complete this chapter successfully, you will need
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.30.1">
      the following:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.31.1">
      A Node.js
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.32.1">
       v22 installation
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.33.1">
      An IDE such as VS Code
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.34.1">
       from
      </span>
     </span>
     <a href="https://code.visualstudio.com/">
      <span class="No-Break">
       <span class="koboSpan" id="kobo.35.1">
        https://code.visualstudio.com/
       </span>
      </span>
     </a>
    </li>
    <li>
     <span class="koboSpan" id="kobo.36.1">
      A working command shell with
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.37.1">
       curl
      </span>
     </strong>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.38.1">
       from
      </span>
     </span>
     <a href="https://curl.se/download.html">
      <span class="No-Break">
       <span class="koboSpan" id="kobo.39.1">
        https://curl.se/download.html
       </span>
      </span>
     </a>
    </li>
    <li>
     <span class="koboSpan" id="kobo.40.1">
      A MongoDB installation
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.41.1">
       from
      </span>
     </span>
     <a href="https://www.mongodb.com/">
      <span class="No-Break">
       <span class="koboSpan" id="kobo.42.1">
        https://www.mongodb.com/
       </span>
      </span>
     </a>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.43.1">
     All the snippets in this chapter are on GitHub
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.44.1">
      at
     </span>
    </span>
    <a href="https://github.com/PacktPublishing/Node.js-Cookbook-Fifth-Edition/tree/main/Chapter06">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.45.1">
       https://github.com/PacktPublishing/Node.js-Cookbook-Fifth-Edition/tree/main/Chapter06
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.46.1">
      .
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-174">
    <a id="_idTextAnchor181">
    </a>
    <span class="koboSpan" id="kobo.47.1">
     Creating an API starter using Fastify
    </span>
   </h1>
   <p>
    <strong class="bold">
     <span class="koboSpan" id="kobo.48.1">
      Fastify
     </span>
    </strong>
    <span class="koboSpan" id="kobo.49.1">
     (
    </span>
    <a href="https://fastify.dev/">
     <span class="koboSpan" id="kobo.50.1">
      https://fastify.dev/
     </span>
    </a>
    <span class="koboSpan" id="kobo.51.1">
     ) is
    </span>
    <a id="_idIndexMarker354">
    </a>
    <span class="koboSpan" id="kobo.52.1">
     a Node.js
    </span>
    <a id="_idIndexMarker355">
    </a>
    <span class="koboSpan" id="kobo.53.1">
     web framework for constructing
    </span>
    <a id="_idIndexMarker356">
    </a>
    <span class="koboSpan" id="kobo.54.1">
     web applications.
    </span>
    <span class="koboSpan" id="kobo.54.2">
     It facilitates the development of an HTTP server and the creation of your API in a straightforward, efficient, scalable, and secure manner.
    </span>
    <span class="koboSpan" id="kobo.54.3">
     The first Fastify’s stable release dates back to 2018.
    </span>
    <span class="koboSpan" id="kobo.54.4">
     Since then, it has garnered a substantial community, boasting over 7 million monthly downloads.
    </span>
    <span class="koboSpan" id="kobo.54.5">
     Moreover, it maintains a consistent release schedule, with a major version update approximately every
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.55.1">
      two years.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.56.1">
     Because practical experience is often the most effective way to learn, in this chapter, we will undertake the implementation of an API server for our brand-new fantasy restaurant!
    </span>
    <span class="koboSpan" id="kobo.56.2">
     Our objectives encompass displaying the menu, allowing the chef to add or remove recipes, and enabling guests to place orders that the chef will receive
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.57.1">
      and cook!
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.58.1">
     So, let’s start our hands-on session with Fastify, and at the end of this chapter, you will evaluate whether Fastify is simple to use
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.59.1">
      or not!
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-175">
    <a id="_idTextAnchor182">
    </a>
    <span class="koboSpan" id="kobo.60.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.61.1">
     First, we need to set up the developer environment.
    </span>
    <span class="koboSpan" id="kobo.61.2">
     To do this, you can create a new Node.js project by running the following commands in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.62.1">
      your terminal:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.63.1">
$ mkdir fastify-restaurant
$ cd fastify-restaurant
$ npm init –yes
$ npm pkg set type=module</span></pre>
   <p>
    <span class="koboSpan" id="kobo.64.1">
     We have initiated the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.65.1">
      fastify-restaurant
     </span>
    </strong>
    <span class="koboSpan" id="kobo.66.1">
     folder with the installed
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.67.1">
      fastify
     </span>
    </strong>
    <span class="koboSpan" id="kobo.68.1">
     module at
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.69.1">
      this stage.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-176">
    <a id="_idTextAnchor183">
    </a>
    <span class="koboSpan" id="kobo.70.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.71.1">
     To build a Fastify
    </span>
    <a id="_idIndexMarker357">
    </a>
    <span class="koboSpan" id="kobo.72.1">
     server, we
    </span>
    <a id="_idIndexMarker358">
    </a>
    <span class="koboSpan" id="kobo.73.1">
     need to follow
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.74.1">
      these steps:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.75.1">
      Install the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.76.1">
       fastify
      </span>
     </strong>
     <span class="koboSpan" id="kobo.77.1">
      version
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.78.1">
       5 module:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.79.1">$ npm install fastify@5</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.80.1">
      Create a new
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.81.1">
       index.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.82.1">
      file with the following content to import
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.83.1">
       the dependency:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.84.1">
import { fastify } from 'fastify';</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.85.1">
      Thanks to the imported dependency, we can instantiate a Fastify instance by executing the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.86.1">
       fastify
      </span>
     </strong>
     <span class="koboSpan" id="kobo.87.1">
      factory function.
     </span>
     <span class="koboSpan" id="kobo.87.2">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.88.1">
       app
      </span>
     </strong>
     <span class="koboSpan" id="kobo.89.1">
      constant will be our
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.90.1">
       root application instance
      </span>
     </strong>
     <span class="koboSpan" id="kobo.91.1">
      that
     </span>
     <a id="_idIndexMarker359">
     </a>
     <span class="koboSpan" id="kobo.92.1">
      identifies the Fastify API at
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.93.1">
       your disposal:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.94.1">
const serverOptions = {
  logger: true
};
const app = fastify(serverOptions);</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.95.1">
       Note that we are passing the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.96.1">
        serverOptions
       </span>
      </strong>
      <span class="koboSpan" id="kobo.97.1">
       object as an argument.
      </span>
      <span class="koboSpan" id="kobo.97.2">
       It contains the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.98.1">
        logger: true
       </span>
      </strong>
      <span class="koboSpan" id="kobo.99.1">
       property to turn on the application logger!
      </span>
      <span class="koboSpan" id="kobo.99.2">
       The
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.100.1">
        fastify
       </span>
      </strong>
      <span class="koboSpan" id="kobo.101.1">
       factory accepts many options, which we will see later in
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.102.1">
        this chapter.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.103.1">
      With the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.104.1">
       app
      </span>
     </strong>
     <span class="koboSpan" id="kobo.105.1">
      instance, we can add routes to the server using the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.106.1">
       get()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.107.1">
      method.
     </span>
     <span class="koboSpan" id="kobo.107.2">
      The handler returns the payload that we would like to return as a response.
     </span>
     <span class="koboSpan" id="kobo.107.3">
      In this case, we add an HTTP
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.108.1">
       GET
      </span>
     </strong>
     <span class="koboSpan" id="kobo.109.1">
      handler to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.110.1">
       /
      </span>
     </strong>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.111.1">
       endpoint:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.112.1">
app.get('/', async function homeHandler () {
  return {
    api: 'fastify-restaurant-api',
    version: 1
  };
});</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.113.1">
      We create a
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.114.1">
       port
      </span>
     </strong>
     <span class="koboSpan" id="kobo.115.1">
      variable in order to select where the server listens for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.116.1">
       HTTP requests:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.117.1">
const port = process.env.PORT || 3000;</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.118.1">
       We read the variable
      </span>
      <a id="_idIndexMarker360">
      </a>
      <span class="koboSpan" id="kobo.119.1">
       from
      </span>
      <a id="_idIndexMarker361">
      </a>
      <span class="koboSpan" id="kobo.120.1">
       the environment settings or set a default value.
      </span>
      <span class="koboSpan" id="kobo.120.2">
       This is useful because, usually, on the server where we install the application, the PORT setting is already set (for
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.121.1">
        example, Heroku).
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.122.1">
      Finally, we can start our server by calling the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.123.1">
       listen
      </span>
     </strong>
     <span class="koboSpan" id="kobo.124.1">
      method.
     </span>
     <span class="koboSpan" id="kobo.124.2">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.125.1">
       host
      </span>
     </strong>
     <span class="koboSpan" id="kobo.126.1">
      parameter with the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.127.1">
       0.0.0.0
      </span>
     </strong>
     <span class="koboSpan" id="kobo.128.1">
      value will configure your server to accept connections from any
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.129.1">
       IPv4 address:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.130.1">
await app.listen({ host: '0.0.0.0', port });</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.131.1">
       This setup is essential for applications running in Docker containers or any application directly accessible on the internet.
      </span>
      <span class="koboSpan" id="kobo.131.2">
       Without this configuration, external clients won’t be able to access your
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.132.1">
        HTTP server.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.133.1">
      We are now ready to start the server with the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.134.1">
       following command:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.135.1">$ node index.js</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.136.1">{"level":30,"time":1693925618687,"pid":123,"hostname":"MyPc","msg":"Server listening at http://127.0.0.1:3000"}</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.137.1">{"level":30,"time":1693925618687,"pid":123,"hostname":"MyPc","msg":"Server listening at http://192.168.1.174:3000"}</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.138.1">
       As you may have noticed, we can see multiple IP addresses where the HTTP server is listening.
      </span>
      <span class="koboSpan" id="kobo.138.2">
       This is due to the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.139.1">
        0.0.0.0
       </span>
      </strong>
      <span class="koboSpan" id="kobo.140.1">
       host configuration, which listens for both the localhost name and the local IP address to handle external calls.
      </span>
      <span class="koboSpan" id="kobo.140.2">
       If we change
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.141.1">
        0.0.0.0
       </span>
      </strong>
      <span class="koboSpan" id="kobo.142.1">
       to
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.143.1">
        localhost
       </span>
      </strong>
      <span class="koboSpan" id="kobo.144.1">
       , our HTTP server will be available only from the local PC, printing a single
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.145.1">
        log message.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.146.1">
      The console log tells us that the server has started successfully; therefore, if you open a new terminal and run a
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.147.1">
       curl
      </span>
     </strong>
     <span class="koboSpan" id="kobo.148.1">
      command, you will get
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.149.1">
       the following:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.150.1">$ curl http://localhost:3000</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.151.1">{"api":"fastify-restaurant-api","version":1}</span></strong></pre>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.152.1">
     In a few lines of code, you have created a Fastify server with a logger that is ready to use and responds with a JSON payload on the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.153.1">
      /
     </span>
    </strong>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.154.1">
      route!
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.155.1">
     As we saw, Fastify comes equipped with numerous built-in features, such as the application logger, by using
    </span>
    <a id="_idIndexMarker362">
    </a>
    <span class="koboSpan" id="kobo.156.1">
     the
    </span>
    <a id="_idIndexMarker363">
    </a>
    <span class="koboSpan" id="kobo.157.1">
     popular Node.js
    </span>
    <a id="_idIndexMarker364">
    </a>
    <span class="koboSpan" id="kobo.158.1">
     logger
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.159.1">
      pino
     </span>
    </strong>
    <span class="koboSpan" id="kobo.160.1">
     (
    </span>
    <a href="https://getpino.io/">
     <span class="koboSpan" id="kobo.161.1">
      https://getpino.io/
     </span>
    </a>
    <span class="koboSpan" id="kobo.162.1">
     ) and an automatic handling JSON format without
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.163.1">
      additional dependencies.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.164.1">
     In the next recipe, we will refactor the code to start giving shape to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.165.1">
      our project.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-177">
    <a id="_idTextAnchor184">
    </a>
    <span class="koboSpan" id="kobo.166.1">
     Splitting the code into small plugins
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.167.1">
     We implemented
    </span>
    <a id="_idIndexMarker365">
    </a>
    <span class="koboSpan" id="kobo.168.1">
     the API root endpoint in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.169.1">
      Creating an API starter using Fastify
     </span>
    </em>
    <span class="koboSpan" id="kobo.170.1">
     recipe, which is often used as a health check to verify whether the server started successfully.
    </span>
    <span class="koboSpan" id="kobo.170.2">
     However, we can’t keep adding all the application’s routes to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.171.1">
      index.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.172.1">
     file; otherwise, it would become unreadable in no time.
    </span>
    <span class="koboSpan" id="kobo.172.2">
     So, let’s split our
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.173.1">
       index.js
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.174.1">
      file.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-178">
    <a id="_idTextAnchor185">
    </a>
    <span class="koboSpan" id="kobo.175.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.176.1">
     To split our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.177.1">
      index.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.178.1">
     file, follow
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.179.1">
      these steps:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.180.1">
      Create an
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.181.1">
       app.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.182.1">
      file and move the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.183.1">
       serverOptions
      </span>
     </strong>
     <span class="koboSpan" id="kobo.184.1">
      constant with the following
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.185.1">
       server configuration:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.186.1">
const serverOptions = {
  logger: true
};</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.187.1">
      We define our first
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.188.1">
       plugin interface:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.189.1">
async function appPlugin (app, opts) {
  app.get('/', async function homeHandler () {
    return {
      api: 'fastify-restaurant-api',
      version: 1
    };
  });
}</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.190.1">
       A plugin is an
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.191.1">
        async
       </span>
      </strong>
      <span class="koboSpan" id="kobo.192.1">
       function that accepts two arguments: the first is a Fastify server instance, and the second is an
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.193.1">
        options
       </span>
      </strong>
      <span class="koboSpan" id="kobo.194.1">
       object, which is empty for now.
      </span>
      <span class="koboSpan" id="kobo.194.2">
       We will use it later in the
      </span>
      <em class="italic">
       <span class="koboSpan" id="kobo.195.1">
        Implementing authentication with hooks
       </span>
      </em>
      <span class="koboSpan" id="kobo.196.1">
       recipe.
      </span>
      <span class="koboSpan" id="kobo.196.2">
       This function may
      </span>
      <a id="_idIndexMarker366">
      </a>
      <span class="koboSpan" id="kobo.197.1">
       assume a different declaration if it is not an
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.198.1">
        async
       </span>
      </strong>
      <span class="koboSpan" id="kobo.199.1">
       function.
      </span>
      <span class="koboSpan" id="kobo.199.2">
       In this case, there would be a third argument:
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.200.1">
        function syncAppPlugin(app, opts, next){}
       </span>
      </strong>
      <span class="koboSpan" id="kobo.201.1">
       ; it is a function that we must call to tell the Fastify framework when the plugin
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.202.1">
        is loaded.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.203.1">
      Finally, we need to export the plugin function as a default and the server configuration as named
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.204.1">
       export options:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.205.1">
export default appPlugin;
export { serverOptions as options };</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.206.1">
      Now, we need to create the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.207.1">
       server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.208.1">
      file
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.209.1">
       as follows:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.210.1">
import { fastify } from 'fastify';
import appPlugin, { options } from './app.js';
const app = fastify(options);
app.register(appPlugin);
const port = process.env.PORT || 3000;
await app.listen({ host: '0.0.0.0', port });</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.211.1">
      Now, we need to try out that we have completed the refactoring correctly; you can execute the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.212.1">
       node server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.213.1">
      command, and it should initiate the server, as it did in the previous
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.214.1">
       Creating an API starter using
      </span>
     </em>
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.215.1">
        Fastify
       </span>
      </em>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.216.1">
       recipe.
      </span>
     </span>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.217.1">
     We’ve created our initial Fastify plugin
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.218.1">
      in
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.219.1">
       app.js
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.220.1">
      .
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-179">
    <a id="_idTextAnchor186">
    </a>
    <span class="koboSpan" id="kobo.221.1">
     How it works…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.222.1">
     It’s important to note that the intention of this section is not to delve deeply into Fastify’s powerful plugin system, which we will explore comprehensively in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.223.1">
      Implementing authentication with hooks
     </span>
    </em>
    <span class="koboSpan" id="kobo.224.1">
     recipe.
    </span>
    <span class="koboSpan" id="kobo.224.2">
     At this juncture, we are primarily utilizing it as a tool
    </span>
    <a id="_idIndexMarker367">
    </a>
    <span class="koboSpan" id="kobo.225.1">
     to organize our code into
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.226.1">
      manageable components.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.227.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.228.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.229.1">
      app.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.230.1">
     file serves as the entry point for our application.
    </span>
    <span class="koboSpan" id="kobo.230.2">
     We have chosen to export the recipe’s code in a format that is compatible with
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.231.1">
      fastify-cli
     </span>
    </strong>
    <span class="koboSpan" id="kobo.232.1">
     (
    </span>
    <a href="https://github.com/fastify/fastify-cli">
     <span class="koboSpan" id="kobo.233.1">
      https://github.com/fastify/fastify-cli
     </span>
    </a>
    <span class="koboSpan" id="kobo.234.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.234.2">
     This
    </span>
    <a id="_idIndexMarker368">
    </a>
    <span class="koboSpan" id="kobo.235.1">
     tool is designed to facilitate application startup and enhance our developer experience.
    </span>
    <span class="koboSpan" id="kobo.235.2">
     While we won’t delve into its details in this book, it’s worth noting that the code we write here will provide you with the flexibility to transition to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.236.1">
      fastify-cli
     </span>
    </strong>
    <span class="koboSpan" id="kobo.237.1">
     seamlessly, should you choose to do so in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.238.1">
      the future.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.239.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.240.1">
      server.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.241.1">
     file has a singular purpose; it imports the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.242.1">
      app.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.243.1">
     file and uses the options object to instantiate the root application instance, as we’ve done before in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.244.1">
      Creating an API starter using
     </span>
    </em>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.245.1">
       Fastify
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.246.1">
      recipe.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.247.1">
     The noteworthy addition here is the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.248.1">
      register()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.249.1">
     method.
    </span>
    <span class="koboSpan" id="kobo.249.2">
     This Fastify function attaches plugins to the Fastify server, ensuring that they are loaded sequentially according to the order in which they are registered.
    </span>
    <span class="koboSpan" id="kobo.249.3">
     After registering a function plugin, it is not executed until we execute the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.250.1">
      listen()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.251.1">
     ,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.252.1">
      ready()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.253.1">
     , or
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.254.1">
      inject()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.255.1">
     methods.
    </span>
    <span class="koboSpan" id="kobo.255.2">
     We will explore the latter two methods in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.256.1">
      Configuring and testing a Fastify
     </span>
    </em>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.257.1">
       Application
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.258.1">
      recipe.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.259.1">
     This minor refactoring represents a significant step forward, as it bolsters our confidence in understanding the Fastify plugin interface.
    </span>
    <span class="koboSpan" id="kobo.259.2">
     Moreover, it neatly separates the business logic from the technical task of launching the web server.
    </span>
    <span class="koboSpan" id="kobo.259.3">
     As a result, the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.260.1">
      server.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.261.1">
     file will never change, allowing
    </span>
    <a id="_idIndexMarker369">
    </a>
    <span class="koboSpan" id="kobo.262.1">
     us to focus on the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.263.1">
      app.js
     </span>
    </strong>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.264.1">
      file exclusively.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.265.1">
     We will add our initial business logic routes in the forthcoming recipe, so
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.266.1">
      stay tuned!
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-180">
    <a id="_idTextAnchor187">
    </a>
    <span class="koboSpan" id="kobo.267.1">
     Adding routes
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.268.1">
     To specify how the
    </span>
    <a id="_idIndexMarker370">
    </a>
    <span class="koboSpan" id="kobo.269.1">
     application responds to client requests, routes must be defined.
    </span>
    <span class="koboSpan" id="kobo.269.2">
     Each route is identified mainly by an HTTP method and a URL pattern, which must align with the incoming request to execute the associated handler function.
    </span>
    <span class="koboSpan" id="kobo.269.3">
     We are currently exposing only one single route:
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.270.1">
      GET /
     </span>
    </strong>
    <span class="koboSpan" id="kobo.271.1">
     .
    </span>
    <span class="koboSpan" id="kobo.271.2">
     If you try to hit a different endpoint, you will receive a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.272.1">
      404 Not
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.273.1">
       Found
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.274.1">
      response:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.275.1">
$ curl http://localhost:3000/example
{"message":"Route GET:/example not found","error":"Not Found","statusCode":404}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.276.1">
     Fastify automatically handles 404 responses.
    </span>
    <span class="koboSpan" id="kobo.276.2">
     When a client attempts to access a non-existent route, Fastify will generate and send a 404 response
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.277.1">
      by default.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.278.1">
     As we’re developing a web server to provide APIs for our fantasy restaurant, it’s essential to outline the routes we need to implement in order to fulfill our objectives.
    </span>
    <span class="koboSpan" id="kobo.278.2">
     Some of the necessary routes may include
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.279.1">
      the following:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.280.1">
       GET /menu
      </span>
     </strong>
     <span class="koboSpan" id="kobo.281.1">
      : Retrieves the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.282.1">
       restaurant’s menu
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.283.1">
       GET /recipes
      </span>
     </strong>
     <span class="koboSpan" id="kobo.284.1">
      : This replies with the same logic as the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.285.1">
       GET /
      </span>
     </strong>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.286.1">
        menu
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.287.1">
       handler
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.288.1">
       POST /recipes
      </span>
     </strong>
     <span class="koboSpan" id="kobo.289.1">
      : Enables the chef to add a new dish to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.290.1">
       the menu
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.291.1">
       DELETE /recipes/:id
      </span>
     </strong>
     <span class="koboSpan" id="kobo.292.1">
      : Allows the chef to remove a recipe from
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.293.1">
       the menu
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.294.1">
       POST /orders
      </span>
     </strong>
     <span class="koboSpan" id="kobo.295.1">
      : Allows guests to place orders
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.296.1">
       for dishes
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.297.1">
       GET /orders
      </span>
     </strong>
     <span class="koboSpan" id="kobo.298.1">
      : Returns a list of the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.299.1">
       pending orders
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.300.1">
       PATCH /orders/:orderId
      </span>
     </strong>
     <span class="koboSpan" id="kobo.301.1">
      : Enables the chef to update the status of
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.302.1">
       an order
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.303.1">
     To implement all these routes effectively, we should follow an iterative approach, continuously enhancing our code with each iteration.
    </span>
    <span class="koboSpan" id="kobo.303.2">
     The steps for our development process will be
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.304.1">
      as follows:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.305.1">
       Define the route handlers
      </span>
     </strong>
     <span class="koboSpan" id="kobo.306.1">
      : Begin by defining the route with an empty handler.
     </span>
     <span class="koboSpan" id="kobo.306.2">
      We will cover it in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.307.1">
       this recipe.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.308.1">
       Implement route logic
      </span>
     </strong>
     <span class="koboSpan" id="kobo.309.1">
      : Incorporate the necessary logic within your route handlers to handle tasks, such as retrieving the menu, adding new menu items, processing orders, and updating order statuses.
     </span>
     <span class="koboSpan" id="kobo.309.2">
      We will do this in the
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.310.1">
       Implementing authentication with
      </span>
     </em>
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.311.1">
        hooks
       </span>
      </em>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.312.1">
       recipe.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.313.1">
       Validation and error handling
      </span>
     </strong>
     <span class="koboSpan" id="kobo.314.1">
      : Implement validation checks to ensure that incoming data are accurate and handle errors gracefully by providing informative error messages and appropriate HTTP
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.315.1">
       status codes.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.316.1">
       Testing
      </span>
     </strong>
     <span class="koboSpan" id="kobo.317.1">
      : Thoroughly test each route to confirm that it functions as expected.
     </span>
     <span class="koboSpan" id="kobo.317.2">
      Consider various scenarios, including valid and invalid input.
     </span>
     <span class="koboSpan" id="kobo.317.3">
      We will cover this in the
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.318.1">
       Configuring and testing a Fastify
      </span>
     </em>
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.319.1">
        application
       </span>
      </em>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.320.1">
       recipe.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.321.1">
       Documentation
      </span>
     </strong>
     <span class="koboSpan" id="kobo.322.1">
      : We must not forget to write up a comprehensive
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.323.1">
       README.md
      </span>
     </strong>
     <span class="koboSpan" id="kobo.324.1">
      file within our source code to ease our
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.325.1">
       team’s work.
      </span>
     </span>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.326.1">
     So, let’s begin with the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.327.1">
      first step.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-181">
    <a id="_idTextAnchor188">
    </a>
    <span class="koboSpan" id="kobo.328.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.329.1">
     We can discern two
    </span>
    <a id="_idIndexMarker371">
    </a>
    <span class="koboSpan" id="kobo.330.1">
     primary entities within our set of endpoints:
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.331.1">
      recipes
     </span>
    </strong>
    <span class="koboSpan" id="kobo.332.1">
     and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.333.1">
      orders
     </span>
    </strong>
    <span class="koboSpan" id="kobo.334.1">
     .
    </span>
    <span class="koboSpan" id="kobo.334.2">
     For defining route handlers, follow
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.335.1">
      these steps:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.336.1">
      To enhance code organization, we’ll create two distinct files, with one for each entity.
     </span>
     <span class="koboSpan" id="kobo.336.2">
      Additionally, to maintain a structured approach, we’ll establish a
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.337.1">
       routes/
      </span>
     </strong>
     <span class="koboSpan" id="kobo.338.1">
      folder and create the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.339.1">
       routes/recipes.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.340.1">
      file
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.341.1">
       within it.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.342.1">
      The initial route we need to define is
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.343.1">
       GET /menu
      </span>
     </strong>
     <span class="koboSpan" id="kobo.344.1">
      .
     </span>
     <span class="koboSpan" id="kobo.344.2">
      In this scenario, we employ the versatile
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.345.1">
       route()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.346.1">
      method to construct it.
     </span>
     <span class="koboSpan" id="kobo.346.2">
      This method requires an input object containing three obligatory parameters:
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.347.1">
       method
      </span>
     </strong>
     <span class="koboSpan" id="kobo.348.1">
      ,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.349.1">
       url
      </span>
     </strong>
     <span class="koboSpan" id="kobo.350.1">
      , and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.351.1">
       handler
      </span>
     </strong>
     <span class="koboSpan" id="kobo.352.1">
      , as illustrated in the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.353.1">
       following example:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.354.1">
function recipesPlugin (app, opts, next) {
  app.route({
    method: 'GET',
    url: '/menu',
    handler: menuHandler
  });
  next();
}</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.355.1">
       For a comprehensive list of the acceptable parameters, please consult the documentation at https://fastify.dev/docs/latest/Reference/Routes/#routes-options.
      </span>
      <span class="koboSpan" id="kobo.355.2">
       Note that we must execute the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.356.1">
        next
       </span>
      </strong>
      <span class="koboSpan" id="kobo.357.1">
       argument, as discussed in the
      </span>
      <em class="italic">
       <span class="koboSpan" id="kobo.358.1">
        Splitting the code into small plugins
       </span>
      </em>
      <span class="koboSpan" id="kobo.359.1">
       recipe.
      </span>
      <span class="koboSpan" id="kobo.359.2">
       This is only another style with which to define plugins, and it is the most performant choice when we don’t need async operations during plugin loading.
      </span>
      <span class="koboSpan" id="kobo.359.3">
       Moreover, it is important to remember that it must be the last operation to execute, and after calling it, it is not possible to
      </span>
      <a id="_idIndexMarker372">
      </a>
      <span class="koboSpan" id="kobo.360.1">
       add
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.361.1">
        more routes.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.362.1">
      Define a new
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.363.1">
       menuHandler
      </span>
     </strong>
     <span class="koboSpan" id="kobo.364.1">
      function alongside the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.365.1">
       plugin
      </span>
     </strong>
     <span class="koboSpan" id="kobo.366.1">
      function, which may prompt the question, How can we access the server’s resources?
     </span>
     <span class="koboSpan" id="kobo.366.2">
      Fastify simplifies
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.367.1">
       this process:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.368.1">
async function menuHandler (request, reply) {
  this.log.info('Logging GET /menu from this');
  request.log.info('Logging GET /menu from request');
  throw new Error('Not implemented');
}
export default recipesPlugin;</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.369.1">
       When you define a named function, as demonstrated in the preceding code example, you can utilize the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.370.1">
        this
       </span>
      </strong>
      <span class="koboSpan" id="kobo.371.1">
       keyword within its context.
      </span>
      <span class="koboSpan" id="kobo.371.2">
       In this context,
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.372.1">
        this
       </span>
      </strong>
      <span class="koboSpan" id="kobo.373.1">
       is equivalent to the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.374.1">
        app
       </span>
      </strong>
      <span class="koboSpan" id="kobo.375.1">
       variable, granting you access to all of the server’s resources, such as the database or the configuration settings, as we’ll explore in the
      </span>
      <em class="italic">
       <span class="koboSpan" id="kobo.376.1">
        Adding routes
       </span>
      </em>
      <span class="koboSpan" id="kobo.377.1">
       recipe.
      </span>
      <span class="koboSpan" id="kobo.377.2">
       However, as shown in this particular example, we’re introducing
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.378.1">
        this.log
       </span>
      </strong>
      <span class="koboSpan" id="kobo.379.1">
       and the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.380.1">
        request.log
       </span>
      </strong>
      <span class="koboSpan" id="kobo.381.1">
       property, which provide access to the logger object, enabling us to integrate logging into our
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.382.1">
        application seamlessly.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.383.1">
      Before continuing, we must not forget to update the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.384.1">
       app.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.385.1">
      file when registering the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.386.1">
       new plugin:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.387.1">import recipesPlugin from './routes/recipes.js';</span></strong><span class="koboSpan" id="kobo.388.1">
async function appPlugin (app, opts) {
  // ...
</span><span class="koboSpan" id="kobo.388.2">  </span><strong class="bold"><span class="koboSpan" id="kobo.389.1">app.register(recipesPlugin);</span></strong><span class="koboSpan" id="kobo.390.1">
}</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.391.1">
      Now, we can
     </span>
     <a id="_idIndexMarker373">
     </a>
     <span class="koboSpan" id="kobo.392.1">
      start the server with the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.393.1">
       node server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.394.1">
      command and execute a call
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.395.1">
       against it:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.396.1">$ curl http://localhost:3000/menu</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.397.1">{"statusCode":500,"error":"Internal Server Error","message":"Not implemented"}%</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.398.1">
       We will discuss the source code for
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.399.1">
        routes/recipes.js
       </span>
      </strong>
      <span class="koboSpan" id="kobo.400.1">
       in detail in the
      </span>
      <em class="italic">
       <span class="koboSpan" id="kobo.401.1">
        How it works…
       </span>
      </em>
      <span class="koboSpan" id="kobo.402.1">
       section of this recipe.
      </span>
      <span class="koboSpan" id="kobo.402.2">
       Now, we can define the remaining routes within the body of the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.403.1">
        recipesPlugin
       </span>
      </strong>
      <span class="koboSpan" id="kobo.404.1">
       function.
      </span>
      <span class="koboSpan" id="kobo.404.2">
       So, we can delve deeper into Fastify’s syntax by adding the
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.405.1">
        new routes.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.406.1">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.407.1">
       GET /recipes
      </span>
     </strong>
     <span class="koboSpan" id="kobo.408.1">
      endpoint combines elements from both the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.409.1">
       get()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.410.1">
      method that we saw previously in
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.411.1">
       Step 4
      </span>
     </em>
     <span class="koboSpan" id="kobo.412.1">
      of the
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.413.1">
       Creating an API starter using Fastify
      </span>
     </em>
     <span class="koboSpan" id="kobo.414.1">
      recipe and the generic
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.415.1">
       route()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.416.1">
      method.
     </span>
     <span class="koboSpan" id="kobo.416.2">
      You can designate the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.417.1">
       url
      </span>
     </strong>
     <span class="koboSpan" id="kobo.418.1">
      as the first parameter and the route’s options as the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.419.1">
       second one:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.420.1">
  app.get('/recipes', { handler: menuHandler });</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.421.1">
       The coolest thing here is that we’re utilizing the same
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.422.1">
        menuHandler
       </span>
      </strong>
      <span class="koboSpan" id="kobo.423.1">
       function for both the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.424.1">
        /menu
       </span>
      </strong>
      <span class="koboSpan" id="kobo.425.1">
       and
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.426.1">
        /recipes
       </span>
      </strong>
      <span class="koboSpan" id="kobo.427.1">
       endpoints, aligning with the requirements we established earlier in the introduction of
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.428.1">
        this recipe.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.429.1">
      Now, defining a
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.430.1">
       POST /recipes
      </span>
     </strong>
     <span class="koboSpan" id="kobo.431.1">
      route appears to be a straightforward task in light of our
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.432.1">
       previous work:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.433.1">
  app.post('/recipes', async function addToMenu
    (request, reply) {
      throw new Error('Not implemented');
    });</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.434.1">
      Lastly, let’s discuss further the definition of the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.435.1">
       DELETE /recipes/:id
      </span>
     </strong>
     <span class="koboSpan" id="kobo.436.1">
      route.
     </span>
     <span class="koboSpan" id="kobo.436.2">
      Firstly, the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.437.1">
       :id
      </span>
     </strong>
     <span class="koboSpan" id="kobo.438.1">
      pattern within the URL strin
     </span>
     <a id="_idIndexMarker374">
     </a>
     <span class="koboSpan" id="kobo.439.1">
      g serves as a
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.440.1">
       path parameter
      </span>
     </strong>
     <span class="koboSpan" id="kobo.441.1">
      .
     </span>
     <span class="koboSpan" id="kobo.441.2">
      A path parameter is a positional variable segment of the URL.
     </span>
     <span class="koboSpan" id="kobo.441.3">
      When a client makes a
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.442.1">
       DELETE
      </span>
     </strong>
     <span class="koboSpan" id="kobo.443.1">
      request to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.444.1">
       /recipes/something
      </span>
     </strong>
     <span class="koboSpan" id="kobo.445.1">
      , the value of
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.446.1">
       something
      </span>
     </strong>
     <span class="koboSpan" id="kobo.447.1">
      will be assigned to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.448.1">
       request.params.id
      </span>
     </strong>
     <span class="koboSpan" id="kobo.449.1">
      property.
     </span>
     <span class="koboSpan" id="kobo.449.2">
      It’s worth noting that
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.450.1">
       request.params
      </span>
     </strong>
     <span class="koboSpan" id="kobo.451.1">
      is a JSON object that contains all the path parameters you may define within the URL.
     </span>
     <span class="koboSpan" id="kobo.451.2">
      Secondly, we’ve defined the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.452.1">
       removeFromMenu
      </span>
     </strong>
     <span class="koboSpan" id="kobo.453.1">
      function
     </span>
     <a id="_idIndexMarker375">
     </a>
     <span class="koboSpan" id="kobo.454.1">
      as a synchronous function, meaning it is not
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.455.1">
       async
      </span>
     </strong>
     <span class="koboSpan" id="kobo.456.1">
      .
     </span>
     <span class="koboSpan" id="kobo.456.2">
      In such cases, we cannot directly return or throw the desired response body.
     </span>
     <span class="koboSpan" id="kobo.456.3">
      Instead, we must call the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.457.1">
       reply.send()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.458.1">
      method, which is responsible for transmitting the response payload to the client.
     </span>
     <span class="koboSpan" id="kobo.458.2">
      This payload can be a string, a JSON object, a buffer, a stream, or an
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.459.1">
       error object:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.460.1">
  app.delete('/recipes/:id', function removeFromMenu
    (request, reply) {
      reply.send(new Error('Not implemented'));
    });</span></pre>
    </li>
   </ol>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.461.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.462.1">
     Don’t mix async with sync: It’s crucial to emphasize that you cannot mix the async and sync handler styles; otherwise, unexpected errors will appear on the console.
    </span>
    <span class="koboSpan" id="kobo.462.2">
     As a key takeaway, remember the following guidelines: if the handler is asynchronous, return the desired payload; otherwise, if the handler is synchronous, you must use the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.463.1">
      reply.send()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.464.1">
     function to send the response.
    </span>
    <span class="koboSpan" id="kobo.464.2">
     In my experience, it is more effective to stick to the async style in a project to avoid confusion across the team and with different backgrounds.
    </span>
    <span class="koboSpan" id="kobo.464.3">
     Furthermore, the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.465.1">
      reply
     </span>
    </strong>
    <span class="koboSpan" id="kobo.466.1">
     object is a fundamental component of Fastify that provides additional utilities, enabling you to customize the response code or append new response headers as needed.
    </span>
    <span class="koboSpan" id="kobo.466.2">
     We will show an example in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.467.1">
      Implementing authentication with
     </span>
    </em>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.468.1">
       hooks
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.469.1">
      recipe.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-182">
    <a id="_idTextAnchor189">
    </a>
    <span class="koboSpan" id="kobo.470.1">
     How it works…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.471.1">
     In the preceding code snippet, we find ourselves re-iterating a procedure similar to what we’ve previously executed for the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.472.1">
      GET /
     </span>
    </strong>
    <span class="koboSpan" id="kobo.473.1">
     route in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.474.1">
      Creating an API starter using Fastify
     </span>
    </em>
    <span class="koboSpan" id="kobo.475.1">
     recipe.
    </span>
    <span class="koboSpan" id="kobo.475.2">
     However, in this instance, we’re employing an alternative syntax provided by Fastify.
    </span>
    <span class="koboSpan" id="kobo.475.3">
     In this new plugin, for the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.476.1">
      ./routes/recipes.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.477.1">
     declaration, we use the callback style.
    </span>
    <span class="koboSpan" id="kobo.477.2">
     It is
    </span>
    <a id="_idIndexMarker376">
    </a>
    <span class="koboSpan" id="kobo.478.1">
     crucial to note that we are calling the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.479.1">
      next()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.480.1">
     function at the end of the plugin.
    </span>
    <span class="koboSpan" id="kobo.480.2">
     If you omit it, Fastify will fail its startup and will trigger an
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.481.1">
      FST_ERR_PLUGIN_TIMEOUT - Plugin did not start in time: 'recipesPlugin'.
     </span>
     <span class="koboSpan" id="kobo.481.2">
      You may have forgotten to call 'done' function or to resolve a
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.482.1">
       Promise
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.483.1">
      error.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.484.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.485.1">
      curl
     </span>
    </strong>
    <span class="koboSpan" id="kobo.486.1">
     request illustrates how Fastify employs a default error handler; it captures any thrown errors and responds with a 500 HTTP status code along with the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.487.1">
      error message.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.488.1">
     In moving to the server’s log output instead, we should see the following alongside the logged error
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.489.1">
      stack trace:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.490.1">
{"level":30,"time":1694013232783,"pid":1,"hostname":"MyPC","msg":"Logging GET /menu from this"}
{"level":30,"time":1694013232783,"pid":1,"hostname":" MyPC ",</span><strong class="bold"><span class="koboSpan" id="kobo.491.1">"reqId":"req-2"</span></strong><span class="koboSpan" id="kobo.492.1">,"msg":"Logging GET /menu from request"}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.493.1">
     You can observe the difference highlighted in the preceding code block.
    </span>
    <span class="koboSpan" id="kobo.493.2">
     When you utilize the request’s
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.494.1">
      log
     </span>
    </strong>
    <span class="koboSpan" id="kobo.495.1">
     , the log entry will incorporate a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.496.1">
      reqId
     </span>
    </strong>
    <span class="koboSpan" id="kobo.497.1">
     field.
    </span>
    <span class="koboSpan" id="kobo.497.2">
     This feature proves quite useful in discerning which logs relate to a specific request, facilitating the reconstruction of the entire sequence of actions an HTTP request has undertaken within the application.
    </span>
    <span class="koboSpan" id="kobo.497.3">
     Fastify assigns a unique identifier to each request by default, starting with
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.498.1">
      req-1
     </span>
    </strong>
    <span class="koboSpan" id="kobo.499.1">
     and incrementing the number.
    </span>
    <span class="koboSpan" id="kobo.499.2">
     Additionally, this counter resets to its initial state with every
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.500.1">
      server restart.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.501.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.502.1">
     If you want to customize the request id, you have two options.
    </span>
    <span class="koboSpan" id="kobo.502.2">
     You can configure the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.503.1">
      requestIdHeader
     </span>
    </strong>
    <span class="koboSpan" id="kobo.504.1">
     server option, instructing Fastify to extract the id from a specific HTTP header.
    </span>
    <span class="koboSpan" id="kobo.504.2">
     Alternatively, you can supply a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.505.1">
      genReqId
     </span>
    </strong>
    <span class="koboSpan" id="kobo.506.1">
     function, granting you full control over the id generation process.
    </span>
    <span class="koboSpan" id="kobo.506.2">
     For further information, please refer to the official documentation
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.507.1">
      at
     </span>
    </span>
    <a href="https://fastify.dev/docs/latest/Reference/Server">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.508.1">
       https://fastify.dev/docs/latest/Reference/Server
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.509.1">
      .
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-183">
    <a id="_idTextAnchor190">
    </a>
    <span class="koboSpan" id="kobo.510.1">
     There’s more...
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.511.1">
     Up to this point, we
    </span>
    <a id="_idIndexMarker377">
    </a>
    <span class="koboSpan" id="kobo.512.1">
     have established the scaffolding for the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.513.1">
      recipes.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.514.1">
     file.
    </span>
    <span class="koboSpan" id="kobo.514.2">
     It’s
    </span>
    <a id="_idIndexMarker378">
    </a>
    <span class="koboSpan" id="kobo.515.1">
     time to create a new
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.516.1">
      routes/orders.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.517.1">
     file and define the final three routes required to accomplish our objective.
    </span>
    <span class="koboSpan" id="kobo.517.2">
     I encourage you to take on this task as an exercise.
    </span>
    <span class="koboSpan" id="kobo.517.3">
     If you encounter any issues, you can check the following code to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.518.1">
      be inspired:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.519.1">
async function ordersPlugin (app, opts) {
  async function notImplemented (request, reply) {
    throw new Error('Not implemented');
  }
  app.post('/orders', { handler: notImplemented });
  app.get('/orders', { handler: notImplemented });
  app.patch('/orders/:orderId', { handler: notImplemented
    });
}
export default ordersPlugin;</span></pre>
   <p>
    <span class="koboSpan" id="kobo.520.1">
     Don’t forget to update the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.521.1">
      app.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.522.1">
     file to expose the new
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.523.1">
      empty routes.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.524.1">
     Following this recipe, you should be well equipped to declare various routes and return plain data, such as strings or JSON objects.
    </span>
    <span class="koboSpan" id="kobo.524.2">
     In the upcoming recipe, we will delve into implementing the fundamental business logic of our APIs by exploring the Fastify plugin system and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.525.1">
      its
     </span>
    </span>
    <span class="No-Break">
     <a id="_idIndexMarker379">
     </a>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.526.1">
      components.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-184">
    <a id="_idTextAnchor191">
    </a>
    <span class="koboSpan" id="kobo.527.1">
     Implementing authentication with hooks
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.528.1">
     We’ve already utilized Fastify
    </span>
    <a id="_idIndexMarker380">
    </a>
    <span class="koboSpan" id="kobo.529.1">
     plugins to organize routes and
    </span>
    <a id="_idIndexMarker381">
    </a>
    <span class="koboSpan" id="kobo.530.1">
     enhance the maintainability of our project, but these are just some of the advantages that the Fastify
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.531.1">
      plugin system
     </span>
    </strong>
    <span class="koboSpan" id="kobo.532.1">
     provides.
    </span>
    <span class="koboSpan" id="kobo.532.2">
     The key features of the plugin system are
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.533.1">
      as follows:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.534.1">
       Encapsulation
      </span>
     </strong>
     <span class="koboSpan" id="kobo.535.1">
      : All the hooks, plugins, and
     </span>
     <a id="_idIndexMarker382">
     </a>
     <span class="koboSpan" id="kobo.536.1">
      decorators added to a plugin are bound to the plugin context, ensuring they remain encapsulated within the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.537.1">
       plugin’s scope.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.538.1">
       Isolation
      </span>
     </strong>
     <span class="koboSpan" id="kobo.539.1">
      : Each plugin instance is self-contained and operates independently, avoiding any modifications to sibling plugins.
     </span>
     <span class="koboSpan" id="kobo.539.2">
      This isolation ensures that changes or issues in one plugin do not
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.540.1">
       affect others.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.541.1">
       Inheritance
      </span>
     </strong>
     <span class="koboSpan" id="kobo.542.1">
      : A plugin inherits the configuration of its parent plugin, allowing for a hierarchical and modular organization of plugins, making it easier to manage complex
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.543.1">
       application structures.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.544.1">
     These concepts might appear complex at first, but in this recipe, we will put them into practical use.
    </span>
    <span class="koboSpan" id="kobo.544.2">
     Specifically, we will implement protection mechanisms for routes that only a chef should be able to access.
    </span>
    <span class="koboSpan" id="kobo.544.3">
     This is a crucial step to prevent misuse by unauthorized users who might attempt to make destructive changes to the fantasy
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.545.1">
      restaurant’s menu.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.546.1">
     The authentication must grant access to a chef user to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.547.1">
      these endpoints:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.548.1">
        POST /recipes
       </span>
      </strong>
     </span>
    </li>
    <li>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.549.1">
        DELETE /recipes/:id
       </span>
      </strong>
     </span>
    </li>
    <li>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.550.1">
        PATCH /orders/:orderId
       </span>
      </strong>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.551.1">
     To streamline the logic, we define a chef as any HTTP request that includes the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.552.1">
      x-api-key
     </span>
    </strong>
    <span class="koboSpan" id="kobo.553.1">
     header with a valid secret value.
    </span>
    <span class="koboSpan" id="kobo.553.2">
     The server must return a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.554.1">
      401 – Unauthorized
     </span>
    </strong>
    <span class="koboSpan" id="kobo.555.1">
     HTTP response if the authentication fails.
    </span>
    <span class="koboSpan" id="kobo.555.2">
     This approach simplifies the verification process for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.556.1">
      chef access.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-185">
    <a id="_idTextAnchor192">
    </a>
    <span class="koboSpan" id="kobo.557.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.558.1">
     Before getting into the code, I recommend testing all the listed endpoints to confirm that you can access them and receive the expected
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.559.1">
      Not implemented
     </span>
    </strong>
    <span class="koboSpan" id="kobo.560.1">
     error message.
    </span>
    <span class="koboSpan" id="kobo.560.2">
     By the end of this recipe, we anticipate that executing the following
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.561.1">
      curl
     </span>
    </strong>
    <span class="koboSpan" id="kobo.562.1">
     commands will result in an
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.563.1">
       Unauthorized
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.564.1">
      error:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.565.1">
$ curl -X POST http://localhost:3000/recipes
$ curl -X DELETE http://localhost:3000/recipes/fake-id
$ curl -X PATCH http://localhost:3000/orders/fake-id</span></pre>
   <p>
    <span class="koboSpan" id="kobo.566.1">
     We are going to explore all the plugin system features right now with a trial-and-error example.
    </span>
    <span class="koboSpan" id="kobo.566.2">
     So, be
    </span>
    <a id="_idIndexMarker383">
    </a>
    <span class="koboSpan" id="kobo.567.1">
     ready
    </span>
    <a id="_idIndexMarker384">
    </a>
    <span class="koboSpan" id="kobo.568.1">
     to restart the server and execute the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.569.1">
       curl
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.570.1">
      commands.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.571.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.572.1">
     Restarting the Fastify server by manually killing the Node.js process can be cumbersome.
    </span>
    <span class="koboSpan" id="kobo.572.2">
     To streamline this process, you can run the application using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.573.1">
      node --watch server.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.574.1">
     argument.
    </span>
    <span class="koboSpan" id="kobo.574.2">
     Node.js 20 introduces the watch mode feature, which automatically restarts the process whenever a file changes, making development
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.575.1">
      more efficient.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-186">
    <a id="_idTextAnchor193">
    </a>
    <span class="koboSpan" id="kobo.576.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.577.1">
     To implement the authentication, we need to follow
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.578.1">
      these steps:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.579.1">
      Edit the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.580.1">
       routes/recipes.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.581.1">
      file
     </span>
     <a id="_idIndexMarker385">
     </a>
     <span class="koboSpan" id="kobo.582.1">
      by adding an
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.583.1">
        onRequest
       </span>
      </strong>
     </span>
     <span class="No-Break">
     </span>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.584.1">
        hook
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.585.1">
       :
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.586.1">
function recipesPlugin (app, opts, next) {
  app.addHook('</span><strong class="bold"><span class="koboSpan" id="kobo.587.1">onRequest</span></strong><span class="koboSpan" id="kobo.588.1">', async function isChef
    (request, reply) {
      if (request.headers['x-api-key'] !== 'fastify-
        rocks') {
          reply.code(401)
          throw new Error('Invalid API key');
      }
    });
  // ...
</span><span class="koboSpan" id="kobo.588.2">  next();
}</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.589.1">
       A hook is a function that executes, as required, throughout the lifecycle of the application or during a single request and response cycle.
      </span>
      <span class="koboSpan" id="kobo.589.2">
       It provides the capability to inject custom logic into the framework itself, enhancing reusability and allowing
      </span>
      <a id="_idIndexMarker386">
      </a>
      <span class="koboSpan" id="kobo.590.1">
       for tailored
      </span>
      <strong class="bold">
       <span class="koboSpan" id="kobo.591.1">
        behavior
       </span>
      </strong>
      <span class="koboSpan" id="kobo.592.1">
       at
      </span>
      <a id="_idIndexMarker387">
      </a>
      <span class="koboSpan" id="kobo.593.1">
       specific points in the
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.594.1">
        application’s execution.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.595.1">
      Let’s see it in action by running these
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.596.1">
        curl
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.597.1">
       commands:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.598.1">$ curl -X POST http://localhost:3000/recipes</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.599.1">{"statusCode":401,"error":"Unauthorized","message":"Invalid API key"}</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.600.1">$ curl -X PATCH http://localhost:3000/orders/fake-id</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.601.1">{"statusCode":500,"error":"Internal Server Error","message":"Not implemented"}</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.602.1">$ curl -X GET http://localhost:3000/recipes/fake-id</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.603.1">{"statusCode":401,"error":"Unauthorized","message":"Invalid API key"}</span></strong></pre>
    </li>
   </ol>
   <h2 id="_idParaDest-187">
    <a id="_idTextAnchor194">
    </a>
    <span class="koboSpan" id="kobo.604.1">
     How it works…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.605.1">
     We have introduced the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.606.1">
      onRequest
     </span>
    </strong>
    <span class="koboSpan" id="kobo.607.1">
     hook.
    </span>
    <span class="koboSpan" id="kobo.607.2">
     This means the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.608.1">
      isChef
     </span>
    </strong>
    <span class="koboSpan" id="kobo.609.1">
     function will run whenever a new HTTP request comes into the server.
    </span>
    <span class="koboSpan" id="kobo.609.2">
     The logic of this hook is to verify the property of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.610.1">
      request.headers
     </span>
    </strong>
    <span class="koboSpan" id="kobo.611.1">
     to check whether the expected header has the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.612.1">
      fastify-rocks
     </span>
    </strong>
    <span class="koboSpan" id="kobo.613.1">
     value.
    </span>
    <span class="koboSpan" id="kobo.613.2">
     If the check is unsuccessful, the hook throws an error after setting the HTTP response status code using the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.614.1">
       reply.code()
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.615.1">
      method.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.616.1">
     If we analyze the console output, we can see the plugin system
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.617.1">
      in action:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.618.1">
       Encapsulation
      </span>
     </strong>
     <span class="koboSpan" id="kobo.619.1">
      : We have incorporated a hook within the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.620.1">
       recipesPlugin
      </span>
     </strong>
     <span class="koboSpan" id="kobo.621.1">
      function, and this hook’s function is executed for every route defined within the same plugin scope.
     </span>
     <span class="koboSpan" id="kobo.621.2">
      As a result, the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.622.1">
       GET /recipes
      </span>
     </strong>
     <span class="koboSpan" id="kobo.623.1">
      route returns a 401 error, demonstrating how hooks can encapsulate and apply logic consistently within a
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.624.1">
       plugin’s context.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.625.1">
       Isolation
      </span>
     </strong>
     <span class="koboSpan" id="kobo.626.1">
      : Whenever Fastify executes the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.627.1">
       register()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.628.1">
      method, it generates a new
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.629.1">
       plugin instance
      </span>
     </strong>
     <span class="koboSpan" id="kobo.630.1">
      , analogous
     </span>
     <a id="_idIndexMarker388">
     </a>
     <span class="koboSpan" id="kobo.631.1">
      to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.632.1">
       app
      </span>
     </strong>
     <span class="koboSpan" id="kobo.633.1">
      argument in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.634.1">
       plugin
      </span>
     </strong>
     <span class="koboSpan" id="kobo.635.1">
      function declaration.
     </span>
     <span class="koboSpan" id="kobo.635.2">
      This instance acts as a child object of the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.636.1">
       root application
      </span>
     </strong>
     <span class="koboSpan" id="kobo.637.1">
      instance, ensuring isolation from sibling plugins and enabling the construction of independent components.
     </span>
     <span class="koboSpan" id="kobo.637.2">
      This isolation is why the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.638.1">
       PATCH /orders/fake-id
      </span>
     </strong>
     <span class="koboSpan" id="kobo.639.1">
      request remains unaffected and continues to return the old
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.640.1">
       Not implemented
      </span>
     </strong>
     <span class="koboSpan" id="kobo.641.1">
      error.
     </span>
     <span class="koboSpan" id="kobo.641.2">
      It highlights that the scope of
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.642.1">
       ordersPlugin
      </span>
     </strong>
     <span class="koboSpan" id="kobo.643.1">
      remains isolated from that of
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.644.1">
       the
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.645.1">
        recipesPlugin
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.646.1">
       .
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.647.1">
     To evaluate
    </span>
    <a id="_idIndexMarker389">
    </a>
    <span class="koboSpan" id="kobo.648.1">
     the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.649.1">
      Inheritance
     </span>
    </strong>
    <span class="koboSpan" id="kobo.650.1">
     feature, you
    </span>
    <a id="_idIndexMarker390">
    </a>
    <span class="koboSpan" id="kobo.651.1">
     must move the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.652.1">
      onRequest
     </span>
    </strong>
    <span class="koboSpan" id="kobo.653.1">
     hook from the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.654.1">
      routes/recipes.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.655.1">
     file to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.656.1">
      app.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.657.1">
     file.
    </span>
    <span class="koboSpan" id="kobo.657.2">
     After this modification, executing the previous curl commands will indeed result in an
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.658.1">
      Unauthorized
     </span>
    </strong>
    <span class="koboSpan" id="kobo.659.1">
     error.
    </span>
    <span class="koboSpan" id="kobo.659.2">
     This outcome occurs because both
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.660.1">
      ordersPlugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.661.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.662.1">
      recipesPlugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.663.1">
     are children of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.664.1">
      appPlugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.665.1">
     plugin
    </span>
    <a id="_idIndexMarker391">
    </a>
    <span class="koboSpan" id="kobo.666.1">
     instance and inherit all of its
    </span>
    <a id="_idIndexMarker392">
    </a>
    <span class="koboSpan" id="kobo.667.1">
     hooks, including the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.668.1">
       onRequest
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.669.1">
      hook.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-188">
    <a id="_idTextAnchor195">
    </a>
    <span class="koboSpan" id="kobo.670.1">
     There’s more...
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.671.1">
     How can we resolve the
    </span>
    <a id="_idIndexMarker393">
    </a>
    <span class="koboSpan" id="kobo.672.1">
     current scenario where all our routes are protected?
    </span>
    <span class="koboSpan" id="kobo.672.2">
     Exploring the plugin system offers a multitude of approaches to achieve this objective, as it heavily relies on your project’s structure and the contexts you need to consider.
    </span>
    <span class="koboSpan" id="kobo.672.3">
     Let’s see two approaches for each plugin in the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.673.1">
       routes/
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.674.1">
      folder.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.675.1">
     The initial step involves centralizing the authentication logic; to facilitate this, we introduce
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.676.1">
      Decorators
     </span>
    </strong>
    <span class="koboSpan" id="kobo.677.1">
     .
    </span>
    <span class="koboSpan" id="kobo.677.2">
     Decorators
    </span>
    <a id="_idIndexMarker394">
    </a>
    <span class="koboSpan" id="kobo.678.1">
     empower you to enhance the default functionalities of Fastify components, minimizing code duplication and providing rapid access to the application’s resources, such as a database connection.
    </span>
    <span class="koboSpan" id="kobo.678.2">
     A decorator can be attached to the server instance, the request, or the reply object; this depends on the context it belongs to.
    </span>
    <span class="koboSpan" id="kobo.678.3">
     Let’s add this to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.679.1">
      app.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.680.1">
     after removing the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.681.1">
       onRequest
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.682.1">
      hook:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.683.1">
async function appPlugin (app, opts) {
  </span><strong class="bold"><span class="koboSpan" id="kobo.684.1">app.decorateRequest</span></strong><span class="koboSpan" id="kobo.685.1">('isChef', function isChef () {
    return this.headers['x-api-key'] === 'fastify-rocks';
  });
  app.decorate('authOnlyChef', async function (request,
    reply) {
      if (!</span><strong class="bold"><span class="koboSpan" id="kobo.686.1">request.isChef()</span></strong><span class="koboSpan" id="kobo.687.1">) {
        reply.code(401);
        throw new Error('Invalid API key');
      }
  });
  // ...
</span><span class="koboSpan" id="kobo.687.2">}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.688.1">
     We’ve defined an
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.689.1">
      isChef
     </span>
    </strong>
    <span class="koboSpan" id="kobo.690.1">
     request
    </span>
    <a id="_idIndexMarker395">
    </a>
    <span class="koboSpan" id="kobo.691.1">
     decorator, enabling the execution of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.692.1">
      request.isChef()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.693.1">
     function within the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.694.1">
      appPlugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.695.1">
     context and its child plugin instances.
    </span>
    <span class="koboSpan" id="kobo.695.2">
     The logic within the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.696.1">
      isChef
     </span>
    </strong>
    <span class="koboSpan" id="kobo.697.1">
     function is straightforward, returning a Boolean value of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.698.1">
      true
     </span>
    </strong>
    <span class="koboSpan" id="kobo.699.1">
     only when a valid header is detected.
    </span>
    <span class="koboSpan" id="kobo.699.2">
     It’s important to note that when we define a request or reply decorator, the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.700.1">
      this
     </span>
    </strong>
    <span class="koboSpan" id="kobo.701.1">
     context refers to the request or reply object, respectively.
    </span>
    <span class="koboSpan" id="kobo.701.2">
     This context is crucial for accessing these objects within the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.702.1">
      decorator function.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.703.1">
     Next, we introduced
    </span>
    <a id="_idIndexMarker396">
    </a>
    <span class="koboSpan" id="kobo.704.1">
     an instance decorator named
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.705.1">
      authOnlyChef
     </span>
    </strong>
    <span class="koboSpan" id="kobo.706.1">
     .
    </span>
    <span class="koboSpan" id="kobo.706.2">
     This decorator exposes a function with an identical API to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.707.1">
      onRequest
     </span>
    </strong>
    <span class="koboSpan" id="kobo.708.1">
     hook we previously defined.
    </span>
    <span class="koboSpan" id="kobo.708.2">
     It can be accessed through the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.709.1">
      app.authOnlyChef
     </span>
    </strong>
    <span class="koboSpan" id="kobo.710.1">
     property, offering a convenient way to apply authentication logic specific to chefs across various routes and plugins only
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.711.1">
      when needed.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.712.1">
     Defining decorators doesn’t execute any logic; for them to execute on their own, we need to utilize them within our routes.
    </span>
    <span class="koboSpan" id="kobo.712.2">
     Let’s proceed to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.713.1">
      routes/orders.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.714.1">
     file and modify the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.715.1">
      /orders/:orderId
     </span>
    </strong>
    <span class="koboSpan" id="kobo.716.1">
     route to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.717.1">
      implement protection:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.718.1">
  app.patch('/orders/:orderId', {
    onRequest: app.authOnlyChef,
    handler: notImplemented
  });</span></pre>
   <p>
    <span class="koboSpan" id="kobo.719.1">
     We’ve configured the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.720.1">
      onRequest
     </span>
    </strong>
    <span class="koboSpan" id="kobo.721.1">
     route’s option property to define a hook specific to this route.
    </span>
    <span class="koboSpan" id="kobo.721.2">
     Fastify provides you with granularity in hook attachment; you can assign a hook function to an entire server instance or to an individual route.
    </span>
    <span class="koboSpan" id="kobo.721.3">
     Additionally, you have the flexibility to set the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.722.1">
      onRequest
     </span>
    </strong>
    <span class="koboSpan" id="kobo.723.1">
     field as an array of hook functions, which will be executed in the order they are added.
    </span>
    <span class="koboSpan" id="kobo.723.2">
     This allows for precise control over the request
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.724.1">
      processing flow.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.725.1">
     This syntax is perfect when you have a few routes to set up, but what if we have a lot of routes to
    </span>
    <a id="_idIndexMarker397">
    </a>
    <span class="koboSpan" id="kobo.726.1">
     protect?
    </span>
    <span class="koboSpan" id="kobo.726.2">
     Let’s
    </span>
    <a id="_idIndexMarker398">
    </a>
    <span class="koboSpan" id="kobo.727.1">
     see what we can do in the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.728.1">
       routes/recipes.js
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.729.1">
      file:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.730.1">
function recipesPlugin (app, opts, next) {
  app.get('/menu', { handler: menuHandler });
  app.get('/recipes', { handler: menuHandler });
  </span><strong class="bold"><span class="koboSpan" id="kobo.731.1">app.register</span></strong><span class="koboSpan" id="kobo.732.1">(async function protectRoutesPlugin (plugin,
    opts) {
      </span><strong class="bold"><span class="koboSpan" id="kobo.733.1">plugin.addHook('onRequest', plugin.authOnlyChef);</span></strong><span class="koboSpan" id="kobo.734.1">
      plugin.post('/recipes', async function addToMenu
        (request, reply) {
          throw new Error('Not implemented');
        });
      plugin.delete('/recipes/:id', function removeFromMenu
        (request, reply) {
          reply.send(new Error('Not implemented'));
        });
    });
  next();
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.735.1">
     To streamline the protection of the recipes routes, which consists of both protected and public routes, you can create a new
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.736.1">
      protectRoutesPlugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.737.1">
     plugin instance in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.738.1">
      recipesPlugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.739.1">
     .
    </span>
    <span class="koboSpan" id="kobo.739.2">
     Within this context, you can add the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.740.1">
      onRequest
     </span>
    </strong>
    <span class="koboSpan" id="kobo.741.1">
     hook to all the routes defined in that context.
    </span>
    <span class="koboSpan" id="kobo.741.2">
     In this case, I’ve named the first argument
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.742.1">
      plugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.743.1">
     to distinguish it from the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.744.1">
      app
     </span>
    </strong>
    <span class="koboSpan" id="kobo.745.1">
     context.
    </span>
    <span class="koboSpan" id="kobo.745.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.746.1">
      plugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.747.1">
     parameter serves as a child context of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.748.1">
      app
     </span>
    </strong>
    <span class="koboSpan" id="kobo.749.1">
     , inheriting all the hooks and decorators up to the root application instance.
    </span>
    <span class="koboSpan" id="kobo.749.2">
     This allows it to access the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.750.1">
      authOnlyChef
     </span>
    </strong>
    <span class="koboSpan" id="kobo.751.1">
     function.
    </span>
    <span class="koboSpan" id="kobo.751.2">
     Furthermore, we’ve moved only the routes that require protection into this new
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.752.1">
      plugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.753.1">
     function, effectively isolating them from the parent’s scope.
    </span>
    <span class="koboSpan" id="kobo.753.2">
     Keep in mind that inheritance flows from parent to child contexts, not the other way around.
    </span>
    <span class="koboSpan" id="kobo.753.3">
     This approach enhances code organization and maintains the benefits of encapsulation, isolation, and inheritance within the Fastify
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.754.1">
      plugin system.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.755.1">
     With the changes we’ve made, you can now execute the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.756.1">
      curl
     </span>
    </strong>
    <span class="koboSpan" id="kobo.757.1">
     commands that were initially tested in this recipe.
    </span>
    <span class="koboSpan" id="kobo.757.2">
     You should expect to receive an
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.758.1">
      Unauthorized
     </span>
    </strong>
    <span class="koboSpan" id="kobo.759.1">
     error only for the routes that require protection, while the other routes should remain freely accessible.
    </span>
    <span class="koboSpan" id="kobo.759.2">
     This demonstrates the successful implementation of authentication logic for selective
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.760.1">
      route protection.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.761.1">
     Fastify has two distinct systems that govern its internal workflow: the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.762.1">
      application lifecycle
     </span>
    </strong>
    <span class="koboSpan" id="kobo.763.1">
     and
    </span>
    <a id="_idIndexMarker399">
    </a>
    <span class="koboSpan" id="kobo.764.1">
     the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.765.1">
      request lifecycle
     </span>
    </strong>
    <span class="koboSpan" id="kobo.766.1">
     .
    </span>
    <span class="koboSpan" id="kobo.766.2">
     While Fastify manages these
    </span>
    <a id="_idIndexMarker400">
    </a>
    <span class="koboSpan" id="kobo.767.1">
     two lifecycles internally, it provides the flexibility for you to inject your custom logic by listening to and responding to the events associated with these lifecycles.
    </span>
    <span class="koboSpan" id="kobo.767.2">
     This capability enables you to tailor the data
    </span>
    <a id="_idIndexMarker401">
    </a>
    <span class="koboSpan" id="kobo.768.1">
     flow
    </span>
    <a id="_idIndexMarker402">
    </a>
    <span class="koboSpan" id="kobo.769.1">
     around the endpoints according to your specific application requirements and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.770.1">
      use cases.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.771.1">
     When you are listening for events triggered by the application lifecycle, you should refer to
    </span>
    <a id="_idIndexMarker403">
    </a>
    <span class="koboSpan" id="kobo.772.1">
     the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.773.1">
      application hooks
     </span>
    </strong>
    <span class="koboSpan" id="kobo.774.1">
     (https://fastify.dev/docs/latest/Reference/Hooks#application-hooks).
    </span>
    <span class="koboSpan" id="kobo.774.2">
     These hooks allow you to intervene during server startup and shutdown.
    </span>
    <span class="koboSpan" id="kobo.774.3">
     Here is a quick list of these hooks and when they
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.775.1">
      are emitted:
     </span>
    </span>
   </p>
   <table class="No-Table-Style _idGenTablePara-1" id="table001-4">
    <colgroup>
     <col/>
     <col/>
     <col/>
    </colgroup>
    <tbody>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="bold">
          <span class="koboSpan" id="kobo.776.1">
           Hook name
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="bold">
          <span class="koboSpan" id="kobo.777.1">
           Emitted when…
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="bold">
          <span class="koboSpan" id="kobo.778.1">
           Interface
          </span>
         </strong>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.779.1">
           onRoute
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.780.1">
         a new endpoint is added to the
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.781.1">
          server instance
         </span>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.782.1">
         It must be a
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.783.1">
          sync function
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.784.1">
           onRegister
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.785.1">
         a new encapsulated context
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.786.1">
          is created
         </span>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.787.1">
         It must be a
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.788.1">
          sync function
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.789.1">
           onReady
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.790.1">
         the application loaded by the HTTP server is not yet listening for
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.791.1">
          incoming requests
         </span>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.792.1">
         It can be a sync or an
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.793.1">
          async function
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.794.1">
           onListen
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.795.1">
         the application is loaded, and the HTTP server is listening for
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.796.1">
          incoming requests
         </span>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.797.1">
         It can be a sync or an async function.
        </span>
        <span class="koboSpan" id="kobo.797.2">
         It does not block the application startup if it throws
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.798.1">
          an error
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.799.1">
           preClose
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.800.1">
         the server starts the close phase and is still listening for
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.801.1">
          incoming requests
         </span>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.802.1">
         It can be a sync or an
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.803.1">
          async function
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="source-inline">
          <span class="koboSpan" id="kobo.804.1">
           onClose
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.805.1">
         the server has stopped listening for new HTTP requests and is in the process of stopping, allowing you to perform cleanup or finalization tasks, such as closing a
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.806.1">
          database connection
         </span>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.807.1">
         It can be a sync or an async function.
        </span>
        <span class="koboSpan" id="kobo.807.2">
         This hook is executed in
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.808.1">
          reverse order
         </span>
        </span>
       </p>
      </td>
     </tr>
    </tbody>
   </table>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.809.1">
     Table 6.1 – Application hooks overview
    </span>
   </p>
   <p>
    <em class="italic">
     <span class="koboSpan" id="kobo.810.1">
      Table 6.1
     </span>
    </em>
    <span class="koboSpan" id="kobo.811.1">
     provides a comprehensive overview of all the application hooks.
    </span>
    <span class="koboSpan" id="kobo.811.2">
     It’s important to note that these hooks are executed in the order of their registration, except for the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.812.1">
      onClose
     </span>
    </strong>
    <span class="koboSpan" id="kobo.813.1">
     hook, which follows a reverse order of execution because it ensures that the resources created last are the first to be closed, similar to how a
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.814.1">
      last-in-first-out
     </span>
    </strong>
    <span class="koboSpan" id="kobo.815.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.816.1">
      LIFO
     </span>
    </strong>
    <span class="koboSpan" id="kobo.817.1">
     ) queue
    </span>
    <a id="_idIndexMarker404">
    </a>
    <span class="koboSpan" id="kobo.818.1">
     operates.
    </span>
    <span class="koboSpan" id="kobo.818.2">
     This sequencing is essential for proper resource cleanup during server shutdown.
    </span>
    <span class="koboSpan" id="kobo.818.3">
     Another important aspect that Fastify ensures is that if any of these hooks fail to execute successfully, the server will not start.
    </span>
    <span class="koboSpan" id="kobo.818.4">
     This feature is valuable, as these hooks can be used to verify the readiness of essential external resources before they are
    </span>
    <a id="_idIndexMarker405">
    </a>
    <span class="koboSpan" id="kobo.819.1">
     consumed by
    </span>
    <a id="_idIndexMarker406">
    </a>
    <span class="koboSpan" id="kobo.820.1">
     the application’s handlers.
    </span>
    <span class="koboSpan" id="kobo.820.2">
     It ensures that your application starts in a reliable state, enhancing robustness and stability.
    </span>
    <span class="koboSpan" id="kobo.820.3">
     It’s important to note that the rule of preventing server startup upon hook failure does not apply to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.821.1">
      onListen
     </span>
    </strong>
    <span class="koboSpan" id="kobo.822.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.823.1">
      onClose
     </span>
    </strong>
    <span class="koboSpan" id="kobo.824.1">
     hooks.
    </span>
    <span class="koboSpan" id="kobo.824.2">
     In these particular cases, Fastify guarantees that all registered hook functions will be executed, regardless of whether one of them encounters an error.
    </span>
    <span class="koboSpan" id="kobo.824.3">
     This behavior ensures that necessary cleanup and finalization tasks are carried out during server startup and shutdown, even in the presence of errors in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.825.1">
      some hooks.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.826.1">
     The application hooks serve various purposes, but the main ones include
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.827.1">
      the following:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.828.1">
       Cache warm-up
      </span>
     </strong>
     <span class="koboSpan" id="kobo.829.1">
      : You can use the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.830.1">
       onReady
      </span>
     </strong>
     <span class="koboSpan" id="kobo.831.1">
      hook to prepare and preload a cache when the server is about to start, which can significantly enhance the performance of
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.832.1">
       your handlers.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.833.1">
       Resource Check
      </span>
     </strong>
     <span class="koboSpan" id="kobo.834.1">
      : If your handlers rely on a third-party server or external resource, you can use these hooks to verify that the resource is up and running during server startup, ensuring that your application’s dependencies
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.835.1">
       are available.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.836.1">
       Monitoring
      </span>
     </strong>
     <span class="koboSpan" id="kobo.837.1">
      : These hooks are valuable for logging and monitoring server startup information, such as configuration details or reasons for server shutdown, aiding in debugging
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.838.1">
       and observability.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.839.1">
       Aspect-oriented programming
      </span>
     </strong>
     <span class="koboSpan" id="kobo.840.1">
      : By leveraging the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.841.1">
       onRegister
      </span>
     </strong>
     <span class="koboSpan" id="kobo.842.1">
      and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.843.1">
       onRoute
      </span>
     </strong>
     <span class="koboSpan" id="kobo.844.1">
      hooks, you can apply aspect-oriented programming techniques to manipulate route options and inject additional properties or behavior into your routes.
     </span>
     <span class="koboSpan" id="kobo.844.2">
      This
     </span>
     <a id="_idIndexMarker407">
     </a>
     <span class="koboSpan" id="kobo.845.1">
      allows for
     </span>
     <a id="_idIndexMarker408">
     </a>
     <span class="koboSpan" id="kobo.846.1">
      the powerful customization and modularization of your
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.847.1">
       application logic.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.848.1">
     As an exercise, try to add these hooks into every
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.849.1">
      application’s files:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.850.1">
app.addHook('onReady', async function hook () {
  this.log.info(`onReady runs from file
    ${import.meta.url}`);
});
app.addHook('onClose', function hook (app, done) {
  app.log.info(`onClose runs from file
    ${import.meta.url}`);
  done()
});</span></pre>
   <p>
    <span class="koboSpan" id="kobo.851.1">
     Indeed, the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.852.1">
      this
     </span>
    </strong>
    <span class="koboSpan" id="kobo.853.1">
     keyword in the context of these hooks represents the Fastify instance, granting you access to all of the server’s decorators and resources.
    </span>
    <span class="koboSpan" id="kobo.853.2">
     This includes the application logger, which can be accessed in the common and well-established Fastify style.
    </span>
    <span class="koboSpan" id="kobo.853.3">
     It’s worth noting that, similar to plugin declarations, the hooks in Fastify support both asynchronous and synchronous interfaces.
    </span>
    <span class="koboSpan" id="kobo.853.4">
     In the case of asynchronous hooks, you don’t need to take any specific actions.
    </span>
    <span class="koboSpan" id="kobo.853.5">
     However, in the case of synchronous hooks, you have access to a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.854.1">
      done
     </span>
    </strong>
    <span class="koboSpan" id="kobo.855.1">
     argument, as shown in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.856.1">
      onClose
     </span>
    </strong>
    <span class="koboSpan" id="kobo.857.1">
     hook in the previous code snippet.
    </span>
    <span class="koboSpan" id="kobo.857.2">
     It’s essential to call this function within the synchronous hook to indicate successful execution; otherwise, the hook pipeline will be blocked, and it will not complete until a timeout occurs, potentially leading to the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.858.1">
      server’s shutdown.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.859.1">
     After this comprehensive
    </span>
    <a id="_idIndexMarker409">
    </a>
    <span class="koboSpan" id="kobo.860.1">
     overview of the application hooks, let’s now shift our focus to the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.861.1">
      request hooks
     </span>
    </strong>
    <span class="koboSpan" id="kobo.862.1">
     (
    </span>
    <a href="https://fastify.dev/docs/latest/Reference/Hooks#requestreply-hooks">
     <span class="koboSpan" id="kobo.863.1">
      https://fastify.dev/docs/latest/Reference/Hooks#requestreply-hooks
     </span>
    </a>
    <span class="koboSpan" id="kobo.864.1">
     ), which are associated with the request lifecycle.
    </span>
    <span class="koboSpan" id="kobo.864.2">
     This lifecycle delineates the various steps that
    </span>
    <a id="_idIndexMarker410">
    </a>
    <span class="koboSpan" id="kobo.865.1">
     an
    </span>
    <a id="_idIndexMarker411">
    </a>
    <span class="koboSpan" id="kobo.866.1">
     HTTP request undergoes when it enters the server.
    </span>
    <span class="koboSpan" id="kobo.866.2">
     You can visualize this process in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.867.1">
      following diagram:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer026">
     <span class="koboSpan" id="kobo.868.1">
      <img alt="Figure 6.1 – The request lifecycle" src="image/B19212_06_01.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.869.1">
     Figure 6.1 – The request lifecycle
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.870.1">
     In
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.871.1">
       Figure 6
      </span>
     </em>
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.872.1">
      .1
     </span>
    </em>
    <span class="koboSpan" id="kobo.873.1">
     , the request lifecycle steps are represented with dashed boxes containing the hook names triggered during that specific phase.
    </span>
    <span class="koboSpan" id="kobo.873.2">
     Let’s follow the path of an incoming HTTP request and
    </span>
    <a id="_idIndexMarker412">
    </a>
    <span class="koboSpan" id="kobo.874.1">
     describe what happens inside Fastify in the order
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.875.1">
      of occurrence:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.876.1">
       Route selection
      </span>
     </strong>
     <span class="koboSpan" id="kobo.877.1">
      : When an HTTP request is received, Fastify routes it to a specific handler based on the requested URL and HTTP method.
     </span>
     <span class="koboSpan" id="kobo.877.2">
      If no matching route is found, Fastify’s default 404 handler
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.878.1">
       is executed.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.879.1">
       Request initiation
      </span>
     </strong>
     <span class="koboSpan" id="kobo.880.1">
      : After the route handler is determined, the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.881.1">
       onRequest
      </span>
     </strong>
     <span class="koboSpan" id="kobo.882.1">
      hook is executed.
     </span>
     <span class="koboSpan" id="kobo.882.2">
      During this phase, the request’s body has not been parsed yet.
     </span>
     <span class="koboSpan" id="kobo.882.3">
      The request object does not contain the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.883.1">
       body
      </span>
     </strong>
     <span class="koboSpan" id="kobo.884.1">
      property.
     </span>
     <span class="koboSpan" id="kobo.884.2">
      This is an appropriate point to discard any requests that should not be processed, such as unauthorized ones.
     </span>
     <span class="koboSpan" id="kobo.884.3">
      Since the request payload has yet to be read, server resources are not wasted on
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.885.1">
       unnecessary processing.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.886.1">
       Request payload manipulation
      </span>
     </strong>
     <span class="koboSpan" id="kobo.887.1">
      : If the HTTP request is deemed processable, the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.888.1">
       preParsing
      </span>
     </strong>
     <span class="koboSpan" id="kobo.889.1">
      hook provides access to the request’s payload stream, which can be manipulated.
     </span>
     <span class="koboSpan" id="kobo.889.2">
      Common use cases include decrypting an encrypted request payload or decompressing
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.890.1">
       user input.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.891.1">
       Payload validation
      </span>
     </strong>
     <span class="koboSpan" id="kobo.892.1">
      : Fastify includes a built-in validation system, which we will explore further in the
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.893.1">
       Validating the input data
      </span>
     </em>
     <span class="koboSpan" id="kobo.894.1">
      recipe of this chapter.
     </span>
     <span class="koboSpan" id="kobo.894.2">
      You can modify the parsed payload before
     </span>
     <a id="_idIndexMarker413">
     </a>
     <span class="koboSpan" id="kobo.895.1">
      it undergoes validation by listening to the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.896.1">
        preValidation
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.897.1">
       hook.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.898.1">
       Full request parsing
      </span>
     </strong>
     <span class="koboSpan" id="kobo.899.1">
      : Just before executing the route handler, which contains the business logic, the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.900.1">
       preHandler
      </span>
     </strong>
     <span class="koboSpan" id="kobo.901.1">
      hook is executed.
     </span>
     <span class="koboSpan" id="kobo.901.2">
      During this phase, the request is fully parsed, and you can access its content via the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.902.1">
        request.body
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.903.1">
       field.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.904.1">
       Route handler execution
      </span>
     </strong>
     <span class="koboSpan" id="kobo.905.1">
      : The request enters the main route handler to execute the function
     </span>
     <a id="_idIndexMarker414">
     </a>
     <span class="koboSpan" id="kobo.906.1">
      associated with the route definition.
     </span>
     <span class="koboSpan" id="kobo.906.2">
      When you use
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.907.1">
       reply.send()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.908.1">
      or return a payload as the response, the last phase begins to send the response payload to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.909.1">
       the client.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.910.1">
       Payload serialization
      </span>
     </strong>
     <span class="koboSpan" id="kobo.911.1">
      : Before the serialization process occurs, the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.912.1">
       preSerialization
      </span>
     </strong>
     <span class="koboSpan" id="kobo.913.1">
      hook is triggered.
     </span>
     <span class="koboSpan" id="kobo.913.2">
      Here, you can manipulate the payload, adapt it to a specific format, or convert non-serializable objects into plain
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.914.1">
       JSON objects.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.915.1">
       Response preparation
      </span>
     </strong>
     <span class="koboSpan" id="kobo.916.1">
      : The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.917.1">
       onSend
      </span>
     </strong>
     <span class="koboSpan" id="kobo.918.1">
      hook is called just before sending the response payload to the client.
     </span>
     <span class="koboSpan" id="kobo.918.2">
      It can access the serialized payload content and apply additional manipulations, such as encryption
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.919.1">
       or compression.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.920.1">
       Request completion
      </span>
     </strong>
     <span class="koboSpan" id="kobo.921.1">
      : Finally, the last step in the request lifecycle is the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.922.1">
       onResponse
      </span>
     </strong>
     <span class="koboSpan" id="kobo.923.1">
      hook.
     </span>
     <span class="koboSpan" id="kobo.923.2">
      This hook is executed after the payload has been successfully sent to the client, marking the completion of the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.924.1">
       HTTP request.
      </span>
     </span>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.925.1">
     Indeed, many things are involved when a simple HTTP request enters the Fastify server, as highlighted in the request lifecycle.
    </span>
    <span class="koboSpan" id="kobo.925.2">
     Moreover,
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.926.1">
       Figure 6
      </span>
     </em>
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.927.1">
      .1
     </span>
    </em>
    <span class="koboSpan" id="kobo.928.1">
     illustrates three additional hooks dedicated to managing errors that may occur throughout the entire request lifecycle.
    </span>
    <span class="koboSpan" id="kobo.928.2">
     These error-specific hooks provide the means to handle errors gracefully and effectively, ensuring the
    </span>
    <a id="_idIndexMarker415">
    </a>
    <span class="koboSpan" id="kobo.929.1">
     reliability and robustness of your Fastify
    </span>
    <a id="_idIndexMarker416">
    </a>
    <span class="koboSpan" id="kobo.930.1">
     application.
    </span>
    <span class="koboSpan" id="kobo.930.2">
     These three error-specific hooks in Fastify provide ways to manage different
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.931.1">
      error scenarios:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.932.1">
       onTimeout
      </span>
     </strong>
     <span class="koboSpan" id="kobo.933.1">
      : This hook is triggered when a connection socket is in an idle state.
     </span>
     <span class="koboSpan" id="kobo.933.2">
      To enable this hook, you must set the server’s
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.934.1">
       connectionTimeout
      </span>
     </strong>
     <span class="koboSpan" id="kobo.935.1">
      option (the default value is
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.936.1">
       0
      </span>
     </strong>
     <span class="koboSpan" id="kobo.937.1">
      , which means disabled).
     </span>
     <span class="koboSpan" id="kobo.937.2">
      The value you specify in milliseconds determines the maximum time the application has to complete the request lifecycle.
     </span>
     <span class="koboSpan" id="kobo.937.3">
      If this time limit is exceeded, the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.938.1">
       onTimeout
      </span>
     </strong>
     <span class="koboSpan" id="kobo.939.1">
      hook kicks in and closes
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.940.1">
       the connection.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.941.1">
       onError
      </span>
     </strong>
     <span class="koboSpan" id="kobo.942.1">
      : The hook is triggered when the server sends an error as the response payload to the client.
     </span>
     <span class="koboSpan" id="kobo.942.2">
      It allows you to perform custom actions when errors occur during
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.943.1">
       request processing.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.944.1">
       onRequestAbort
      </span>
     </strong>
     <span class="koboSpan" id="kobo.945.1">
      : This hook is executed when a client prematurely closes the connection before the request is fully processed.
     </span>
     <span class="koboSpan" id="kobo.945.2">
      In such cases, you won’t be able to send data to the client since the connection has already been closed.
     </span>
     <span class="koboSpan" id="kobo.945.3">
      This hook is useful for cleaning up any resources associated with the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.946.1">
       aborted request.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.947.1">
     You’ve now gained a comprehensive understanding of Fastify’s hooks, which will be invaluable as you dive deeper into using the plugin system.
    </span>
    <span class="koboSpan" id="kobo.947.2">
     So, let’s start to use all of Fastify’s powerful
    </span>
    <a id="_idIndexMarker417">
    </a>
    <span class="koboSpan" id="kobo.948.1">
     features, including hooks, decorators, and
    </span>
    <a id="_idIndexMarker418">
    </a>
    <span class="koboSpan" id="kobo.949.1">
     plugins, to implement the fantasy restaurant
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.950.1">
      business logic.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-189">
    <a id="_idTextAnchor196">
    </a>
    <span class="koboSpan" id="kobo.951.1">
     Breaking the encapsulation
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.952.1">
     In this new recipe, we’ll
    </span>
    <a id="_idIndexMarker419">
    </a>
    <span class="koboSpan" id="kobo.953.1">
     delve deeper into the
    </span>
    <a id="_idIndexMarker420">
    </a>
    <span class="koboSpan" id="kobo.954.1">
     world of the Fastify plugin system, expanding our understanding beyond what we’ve explored so far.
    </span>
    <span class="koboSpan" id="kobo.954.2">
     Fastify offers a wide array of tools, each serving specific purposes, and gaining familiarity with them will greatly enhance your ability to customize and control various aspects of your application’s lifecycle
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.955.1">
      and behavior.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-190">
    <a id="_idTextAnchor197">
    </a>
    <span class="koboSpan" id="kobo.956.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.957.1">
     In the previous
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.958.1">
      Implementing authentication with hooks
     </span>
    </em>
    <span class="koboSpan" id="kobo.959.1">
     recipe, we learned about various hooks, but we didn’t see their practical application.
    </span>
    <span class="koboSpan" id="kobo.959.2">
     Now, let’s apply our knowledge by developing a custom authentication plugin.
    </span>
    <span class="koboSpan" id="kobo.959.3">
     Currently, our authentication logic is dispersed across the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.960.1">
      app.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.961.1">
     file, which is then utilized by both
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.962.1">
      orders.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.963.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.964.1">
      recipes.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.965.1">
     .
    </span>
    <span class="koboSpan" id="kobo.965.2">
     While it works, it lacks centralization.
    </span>
    <span class="koboSpan" id="kobo.965.3">
     To address this, we aim to create a company-wide plugin that can be easily integrated into all our projects, providing standardized authentication logic right out of the box when registering
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.966.1">
      the plugin.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-191">
    <a id="_idTextAnchor198">
    </a>
    <span class="koboSpan" id="kobo.967.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.968.1">
     To create a common
    </span>
    <a id="_idIndexMarker421">
    </a>
    <span class="koboSpan" id="kobo.969.1">
     plugin
    </span>
    <a id="_idIndexMarker422">
    </a>
    <span class="koboSpan" id="kobo.970.1">
     by breaking the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.971.1">
      encapsulation
     </span>
    </strong>
    <span class="koboSpan" id="kobo.972.1">
     , we need to follow
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.973.1">
      these steps:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.974.1">
      Create a new
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.975.1">
       plugins/auth.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.976.1">
      instance in a new folder and then move the decorators from
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.977.1">
       app.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.978.1">
      to this
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.979.1">
       new file:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.980.1">
async function authPlugin (app, opts) {
  app.decorateRequest('isChef', function () {
    return this.headers['x-api-key'] === 'fastify-
      rocks';
  });
  app.decorate('authOnlyChef', async function(request,
    reply){
      if (!request.isChef()) {
        reply.code(401);
        throw new Error('Invalid API key');
      }
    });
}
export default authPlugin;</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.981.1">
      As usual, register the plugin in the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.982.1">
        app.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.983.1">
       file:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.984.1">
import authPlugin from './plugins/auth.js';
async function appPlugin (app, opts) {
  </span><strong class="bold"><span class="koboSpan" id="kobo.985.1">app.register(authPlugin);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.986.1">  app.register(recipesPlugin);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.987.1">  app.register(ordersPlugin);</span></strong><span class="koboSpan" id="kobo.988.1">
}</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.989.1">
       This is nothing
      </span>
      <a id="_idIndexMarker423">
      </a>
      <span class="koboSpan" id="kobo.990.1">
       new
      </span>
      <a id="_idIndexMarker424">
      </a>
      <span class="koboSpan" id="kobo.991.1">
       so far, but if you try to start the server, it won’t work.
      </span>
      <span class="koboSpan" id="kobo.991.2">
       Let me show you why by drawing the Fastify
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.992.1">
        contexts structure:
       </span>
      </span>
     </p>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer027">
     <span class="koboSpan" id="kobo.993.1">
      <img alt="Figure 6.2 – Fastify tree structure" src="image/B19212_06_02.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.994.1">
     Figure 6.2 – Fastify tree structure
    </span>
   </p>
   <p class="list-inset">
    <span class="koboSpan" id="kobo.995.1">
     In
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.996.1">
       Figure 6
      </span>
     </em>
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.997.1">
      .2
     </span>
    </em>
    <span class="koboSpan" id="kobo.998.1">
     , every node represents a self-contained context.
    </span>
    <span class="koboSpan" id="kobo.998.2">
     Thanks to the plugin system, each of these contexts can possess its own hooks, decorators, and plugins.
    </span>
    <span class="koboSpan" id="kobo.998.3">
     On the left side of the figure, you can observe the current structure of our application.
    </span>
    <span class="koboSpan" id="kobo.998.4">
     Notably, the decorators defined within the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.999.1">
      authPlugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1000.1">
     function are not accessible to either the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1001.1">
      recipesPlugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1002.1">
     or
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1003.1">
      ordersPlugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1004.1">
     functions due to isolation.
    </span>
    <span class="koboSpan" id="kobo.1004.2">
     To rectify this, we should consider relocating the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1005.1">
      authPlugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1006.1">
     node higher up in the tree structure.
    </span>
    <span class="koboSpan" id="kobo.1006.2">
     By doing so, the recipes and orders plugins would inherit the decorators, allowing for seamless integration and functionality.
    </span>
    <span class="koboSpan" id="kobo.1006.3">
     Implementing this action would entail having
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1007.1">
      server.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1008.1">
     register
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1009.1">
      authPlugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1010.1">
     and, subsequently,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1011.1">
      authPlugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1012.1">
     register
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1013.1">
      appPlugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1014.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1014.2">
     While this approach would work, it leads to a source code that is challenging to comprehend due to its complexity and nested dependencies.
    </span>
    <span class="koboSpan" id="kobo.1014.3">
     For this reason, in this case, we want to
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1015.1">
      break the encapsulation
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1016.1">
     , as
    </span>
    <a id="_idIndexMarker425">
    </a>
    <span class="koboSpan" id="kobo.1017.1">
     shown
    </span>
    <a id="_idIndexMarker426">
    </a>
    <span class="koboSpan" id="kobo.1018.1">
     on the right side of
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.1019.1">
       Figure
      </span>
     </em>
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.1020.1">
       6
      </span>
     </em>
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.1021.1">
       .2
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1022.1">
      .
     </span>
    </span>
   </p>
   <ol>
    <li value="3">
     <span class="koboSpan" id="kobo.1023.1">
      Install a new module by running
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1024.1">
       npm
      </span>
     </strong>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1025.1">
        install fastify-plugin@5
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1026.1">
       .
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1027.1">
      Wrap the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1028.1">
       authPlugin
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1029.1">
      function with the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1030.1">
       fastify-plugin
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1031.1">
      , as shown in the following
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1032.1">
       code snippet:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1033.1">import fp from 'fastify-plugin';</span></strong><span class="koboSpan" id="kobo.1034.1">
async function authPlugin (app, opts) {
  // ...
</span><span class="koboSpan" id="kobo.1034.2">}
export default </span><strong class="bold"><span class="koboSpan" id="kobo.1035.1">fp(</span></strong><span class="koboSpan" id="kobo.1036.1">authPlugin</span><strong class="bold"><span class="koboSpan" id="kobo.1037.1">)</span></strong><span class="koboSpan" id="kobo.1038.1">;</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1039.1">
       Upon restarting the server, everything should function as it did previously.
      </span>
      <span class="koboSpan" id="kobo.1039.2">
       This is because breaking the encapsulation context is like using the parent Fastify instance.
      </span>
      <span class="koboSpan" id="kobo.1039.3">
       If we were to apply
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1040.1">
        fastify-plugin
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1041.1">
       to every file we’ve implemented thus far, we would essentially consolidate everything into a single context, equivalent to the root application context.
      </span>
      <span class="koboSpan" id="kobo.1041.2">
       Unfortunately, this would result in the loss of all the capabilities provided by the plugin system.
      </span>
      <span class="koboSpan" id="kobo.1041.3">
       As a general rule of thumb, you may use
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1042.1">
        fastify-plugin
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1043.1">
       exclusively for those plugins that you intend to reuse across
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1044.1">
        your organization.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1045.1">
      Our work is not yet complete, as we have only moved the decorators.
     </span>
     <span class="koboSpan" id="kobo.1045.2">
      Now, our objective is to centralize how the routes apply the authentication logic.
     </span>
     <span class="koboSpan" id="kobo.1045.3">
      To achieve this, we will utilize the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1046.1">
       onRoute
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1047.1">
      hook.
     </span>
     <span class="koboSpan" id="kobo.1047.2">
      Add this code to the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1048.1">
        auth.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1049.1">
       file:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1050.1">
async function authPlugin (app, opts) {
  // ...
</span><span class="koboSpan" id="kobo.1050.2">  app.addHook('onRoute', </span><strong class="bold"><span class="koboSpan" id="kobo.1051.1">function hook (routeOptions)</span></strong><span class="koboSpan" id="kobo.1052.1"> {
    if (routeOptions.config?.auth === true) {
      routeOptions.onRequest =
      [app.authOnlyChef].concat(routeOptions.onRequest
        || []);
    }
  });
}</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1053.1">
       As mentioned in the
      </span>
      <em class="italic">
       <span class="koboSpan" id="kobo.1054.1">
        There’s more...
       </span>
      </em>
      <span class="koboSpan" id="kobo.1055.1">
       section of the
      </span>
      <em class="italic">
       <span class="koboSpan" id="kobo.1056.1">
        Implement authentication with hooks
       </span>
      </em>
      <span class="koboSpan" id="kobo.1057.1">
       recipe, the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1058.1">
        onRoute
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1059.1">
       hook must be a synchronous function.
      </span>
      <span class="koboSpan" id="kobo.1059.2">
       It receives the route’s
      </span>
      <a id="_idIndexMarker427">
      </a>
      <span class="koboSpan" id="kobo.1060.1">
       options
      </span>
      <a id="_idIndexMarker428">
      </a>
      <span class="koboSpan" id="kobo.1061.1">
       as its first argument.
      </span>
      <span class="koboSpan" id="kobo.1061.2">
       The purpose of this function is to check whether
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1062.1">
        routeOptions
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1063.1">
       includes an
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1064.1">
        auth
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1065.1">
       flag set to true.
      </span>
      <span class="koboSpan" id="kobo.1065.2">
       If this condition is met, we inject the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1066.1">
        authOnlyChef
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1067.1">
       decorator function
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1068.1">
        into
       </span>
      </span>
      <span class="No-Break">
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1069.1">
         routeOptions.onRequest
        </span>
       </strong>
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1070.1">
        .
       </span>
      </span>
     </p>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1071.1">
       It’s worth emphasizing that the code ensures
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1072.1">
        authOnlyChef
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1073.1">
       is the first function in the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1074.1">
        onRequest
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1075.1">
       chain.
      </span>
      <span class="koboSpan" id="kobo.1075.2">
       This is significant because Fastify executes these functions in the order they appear.
      </span>
      <span class="koboSpan" id="kobo.1075.3">
       Additionally, it’s worth mentioning that the input
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1076.1">
        routeOption.onRequest
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1077.1">
       can either be an array of hooks or a single function.
      </span>
      <span class="koboSpan" id="kobo.1077.2">
       The code example handles both scenarios seamlessly using the
      </span>
      <span class="No-Break">
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1078.1">
         Array.concat()
        </span>
       </strong>
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1079.1">
        function.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1080.1">
      Now, we can go back to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1081.1">
       orders.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1082.1">
      file and update the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1083.1">
       PATCH /orders/:orderId
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1084.1">
      handler
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1085.1">
       as follows:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1086.1">
  app.patch('/orders/:orderId', {
    </span><strong class="bold"><span class="koboSpan" id="kobo.1087.1">config: { auth: true },</span></strong><span class="koboSpan" id="kobo.1088.1">
    handler: notImplemented
  });</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1089.1">
       We have replaced the previous
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1090.1">
        onRequest
       </span>
      </strong>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1091.1">
        [app.authOnlyChef]
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1092.1">
       configuration with the
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1093.1">
        new approach.
       </span>
      </span>
     </p>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1094.1">
     By utilizing the route’s
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1095.1">
      config
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1096.1">
     property, we isolate your application’s properties from Fastify’s fields to prevent conflicts.
    </span>
    <span class="koboSpan" id="kobo.1096.2">
     This updated setup offers several advantages, including the ability of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1097.1">
      authPlugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1098.1">
     to evolve over time without necessitating changes to your routes’ configurations with every update.
    </span>
    <span class="koboSpan" id="kobo.1098.2">
     This pattern aligns with
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1099.1">
      aspect-oriented programming
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1100.1">
     , as it
    </span>
    <a id="_idIndexMarker429">
    </a>
    <span class="koboSpan" id="kobo.1101.1">
     dynamically introduces a feature through a straightforward
    </span>
    <a id="_idIndexMarker430">
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1102.1">
      Boolean
     </span>
    </span>
    <span class="No-Break">
     <a id="_idIndexMarker431">
     </a>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1103.1">
      configuration.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-192">
    <a id="_idTextAnchor199">
    </a>
    <span class="koboSpan" id="kobo.1104.1">
     There’s more...
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1105.1">
     As an exercise, try to update the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1106.1">
      recipes.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1107.1">
     file by yourself now, and then compare your code with the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1108.1">
      following solution:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.1109.1">
function recipesPlugin (app, opts, next) {
  // ...
</span><span class="koboSpan" id="kobo.1109.2">  app.post('/recipes', {
    </span><strong class="bold"><span class="koboSpan" id="kobo.1110.1">config: { auth: true },</span></strong><span class="koboSpan" id="kobo.1111.1">
    handler: async function addToMenu (request, reply) {
      throw new Error('Not implemented');
    }
  });
  app.delete('/recipes/:id', {
    </span><strong class="bold"><span class="koboSpan" id="kobo.1112.1">config: { auth: true },</span></strong><span class="koboSpan" id="kobo.1113.1">
    handler: function removeFromMenu (request, reply) {
      reply.send(new Error('Not implemented'));
    }
  });
  next();
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1114.1">
     As was previously carried out, we have set the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1115.1">
      config.auth
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1116.1">
     option, and we deleted the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1117.1">
      protectRoutesPlugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1118.1">
     code because creating an encapsulated context is no
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1119.1">
      longer necessary.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1120.1">
     Well done!
    </span>
    <span class="koboSpan" id="kobo.1120.2">
     In this recipe, we’ve covered a lot, beginning with hooks, moving on to decorators, and learning how
    </span>
    <a id="_idIndexMarker432">
    </a>
    <span class="koboSpan" id="kobo.1121.1">
     to
    </span>
    <a id="_idIndexMarker433">
    </a>
    <span class="koboSpan" id="kobo.1122.1">
     manage encapsulated contexts and break them when necessary.
    </span>
    <span class="koboSpan" id="kobo.1122.2">
     In the next recipe, we’ll dive into implementing the business logic for our routes, which we’ve only declared up to this point.
    </span>
    <span class="koboSpan" id="kobo.1122.3">
     So, let’s gear up and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1123.1">
      get started!
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-193">
    <a id="_idTextAnchor200">
    </a>
    <span class="koboSpan" id="kobo.1124.1">
     Implementing business logic using hooks
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.1125.1">
     The APIs for the
    </span>
    <a id="_idIndexMarker434">
    </a>
    <span class="koboSpan" id="kobo.1126.1">
     fantasy restaurant have a specific goal: to
    </span>
    <a id="_idIndexMarker435">
    </a>
    <span class="koboSpan" id="kobo.1127.1">
     serve our restaurant’s needs.
    </span>
    <span class="koboSpan" id="kobo.1127.2">
     In the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1128.1">
      Adding
     </span>
    </em>
    <em class="italic">
     <span class="koboSpan" id="kobo.1129.1">
      routes
     </span>
    </em>
    <span class="koboSpan" id="kobo.1130.1">
     recipe, we examined the general flow but didn’t delve into details, such as
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1131.1">
      the following:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.1132.1">
      What constitutes the input for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1133.1">
       each endpoint?
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1134.1">
      What should be the expected output of
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1135.1">
       each service?
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1136.1">
      Where should we store
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1137.1">
       the data?
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.1138.1">
     In this recipe, we will explore these crucial aspects in greater detail.
    </span>
    <span class="koboSpan" id="kobo.1138.2">
     So, let’s start with the data and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1139.1">
      its storage!
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-194">
    <a id="_idTextAnchor201">
    </a>
    <span class="koboSpan" id="kobo.1140.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1141.1">
     We require a database to store and retrieve application data.
    </span>
    <span class="koboSpan" id="kobo.1141.2">
     For this purpose, we will employ the well-known NoSQL
    </span>
    <a id="_idIndexMarker436">
    </a>
    <span class="koboSpan" id="kobo.1142.1">
     database
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1143.1">
      MongoDB
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1144.1">
     (
    </span>
    <a href="https://www.mongodb.com/">
     <span class="koboSpan" id="kobo.1145.1">
      https://www.mongodb.com/
     </span>
    </a>
    <span class="koboSpan" id="kobo.1146.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.1146.2">
     MongoDB is a popular NoSQL database that stores data in flexible, JSON-like documents, providing scalability and high performance for various applications.
    </span>
    <span class="koboSpan" id="kobo.1146.3">
     It’s important to note that the details of MongoDB are not the primary focus of this chapter, so I won’t delve into extensive descriptions of its
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1147.1">
      inner workings.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.1148.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1149.1">
     If you have a Docker installation, you can run a MongoDB server by running this command line:
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1150.1">
      docker run -d -p 27017:27017 --name fastify-mongo mongo:5
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1151.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1151.2">
     It will start a container using the official MongoDB image, and it will be ready to use.
    </span>
    <span class="koboSpan" id="kobo.1151.3">
     Finally, to stop it, you can run this command instead:
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1152.1">
      docker container
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1153.1">
       stop fastify-mongo
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1154.1">
      .
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-195">
    <a id="_idTextAnchor202">
    </a>
    <span class="koboSpan" id="kobo.1155.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1156.1">
     To connect our
    </span>
    <a id="_idIndexMarker437">
    </a>
    <span class="koboSpan" id="kobo.1157.1">
     application
    </span>
    <a id="_idIndexMarker438">
    </a>
    <span class="koboSpan" id="kobo.1158.1">
     to MongoDB, we need to follow
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1159.1">
      these steps:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1160.1">
      Install the official
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1161.1">
       Fastify module:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1162.1">$ npm i @fastify/mongodb@9</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1163.1">
      Then, we can create a new plugin in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1164.1">
       plugins/datasource.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1165.1">
      file, where we will connect to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1166.1">
       the database:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1167.1">
import fp from 'fastify-plugin';
import fastifyMongo from '@fastify/mongodb';
async function datasourcePlugin (app, opts) {
  app.log.info('Connecting to MongoDB')
  app.register(fastifyMongo, {
    url: 'mongodb://localhost:27017/restaurant'
  });
}
export default fp(datasourcePlugin);</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1168.1">
      Update
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1169.1">
       app.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1170.1">
      , adding the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1171.1">
       app.register(datasourcePlugin)
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1172.1">
      code, as was carried out in
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1173.1">
       Step 2
      </span>
     </em>
     <span class="koboSpan" id="kobo.1174.1">
      of the
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1175.1">
       Breaking the
      </span>
     </em>
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.1176.1">
        encapsulation
       </span>
      </em>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1177.1">
       recipe.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1178.1">
      If you launch the application with a properly initialized database, it should start as usual, and you should observe the new log line we added to confirm that our plugin is
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1179.1">
       being loaded.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1180.1">
      Next, we must establish a data layer between the MongoDB data source and our business logic.
     </span>
     <span class="koboSpan" id="kobo.1180.2">
      This allows us to identify the essential actions our routes must execute and extract a subset of these actions to be defined
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1181.1">
       as decorators:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1182.1">
async function datasourcePlugin (app, opts) {
  app.register(fastifyMongo, { ... </span><span class="koboSpan" id="kobo.1182.2">});
  app.decorate('</span><strong class="bold"><span class="koboSpan" id="kobo.1183.1">source</span></strong><span class="koboSpan" id="kobo.1184.1">', {
    async </span><strong class="bold"><span class="koboSpan" id="kobo.1185.1">insertRecipe</span></strong><span class="koboSpan" id="kobo.1186.1"> (recipe) { /* todo */ },
    async </span><strong class="bold"><span class="koboSpan" id="kobo.1187.1">readRecipes</span></strong><span class="koboSpan" id="kobo.1188.1"> (filters, sort) { /* todo */ },
    async </span><strong class="bold"><span class="koboSpan" id="kobo.1189.1">deleteRecipe</span></strong><span class="koboSpan" id="kobo.1190.1"> (recipeId) { /* todo */ },
    async </span><strong class="bold"><span class="koboSpan" id="kobo.1191.1">insertOrder</span></strong><span class="koboSpan" id="kobo.1192.1"> (order) { /* todo */ },
    async </span><strong class="bold"><span class="koboSpan" id="kobo.1193.1">readOrders</span></strong><span class="koboSpan" id="kobo.1194.1"> (filters, sort) { /* todo */ },
    async </span><strong class="bold"><span class="koboSpan" id="kobo.1195.1">markOrderAsDone</span></strong><span class="koboSpan" id="kobo.1196.1"> (orderId) { /* todo */ }
  });
}</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1197.1">
      In the previous
     </span>
     <a id="_idIndexMarker439">
     </a>
     <span class="koboSpan" id="kobo.1198.1">
      code
     </span>
     <a id="_idIndexMarker440">
     </a>
     <span class="koboSpan" id="kobo.1199.1">
      snippet, we added a new
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1200.1">
       source
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1201.1">
      object decorator.
     </span>
     <span class="koboSpan" id="kobo.1201.2">
      Each object’s field references an
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1202.1">
       async
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1203.1">
      function that will perform only what the name says.
     </span>
     <span class="koboSpan" id="kobo.1203.2">
      So, let’s start to implement the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1204.1">
       first function:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1205.1">
    async insertRecipe (recipe) {
      const { db } = app.mongo;
      const _id = new app.mongo.ObjectId();
      recipe._id = _id;
      recipe.id = _id.toString();
      const collection = db.collection('menu');
      const result = await
        collection.insertOne(recipe);
      return result.insertedId;
    }</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1206.1">
       This function inserts the input JSON object
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1207.1">
        recipe
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1208.1">
       into the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1209.1">
        menu
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1210.1">
       collection and returns the generated id.
      </span>
      <span class="koboSpan" id="kobo.1210.2">
       As said, this data layer should not perform any business logic.
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1211.1">
        app.mongo
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1212.1">
       is a decorator created by the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1213.1">
        @fastify/mongodb
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1214.1">
       module, as documented here:
      </span>
      <a href="https://github.com/fastify/fastify-mongodb">
       <span class="koboSpan" id="kobo.1215.1">
        https://github.com/fastify/fastify-mongodb
       </span>
      </a>
      <span class="koboSpan" id="kobo.1216.1">
       , and this refers to the MongoDB Client, so you have total control
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1217.1">
        over it.
       </span>
      </span>
     </p>
    </li>
   </ol>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.1218.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1219.1">
     In the preceding code block, the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1220.1">
      _id
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1221.1">
     property in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1222.1">
      recipe._id = _id;
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1223.1">
     and the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1224.1">
      id
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1225.1">
     property in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1226.1">
      recipe.id = _id.toString()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1227.1">
     have the same value.
    </span>
    <span class="koboSpan" id="kobo.1227.2">
     We introduce the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1228.1">
      id
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1229.1">
     property to prevent the exposure of any information related to our database.
    </span>
    <span class="koboSpan" id="kobo.1229.2">
     While we utilize the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1230.1">
      _id
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1231.1">
     property, it is primarily defined and employed by MongoDB servers for internal purposes, and we opt to use
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1232.1">
      id
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1233.1">
     to maintain a level of abstraction and security in our
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1234.1">
      application’s data.
     </span>
    </span>
   </p>
   <ol>
    <li value="7">
     <span class="koboSpan" id="kobo.1235.1">
      To use the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1236.1">
       insertRecipe
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1237.1">
      function, we
     </span>
     <a id="_idIndexMarker441">
     </a>
     <span class="koboSpan" id="kobo.1238.1">
      need to
     </span>
     <a id="_idIndexMarker442">
     </a>
     <span class="koboSpan" id="kobo.1239.1">
      implement the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1240.1">
       POST /recipes
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1241.1">
      endpoint
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1242.1">
       as follows:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1243.1">
  app.post('/recipes', {
    config: { auth: true },
    handler: async function addToMenu (request, reply)
    {
      const { name, country, description, order, price
        } = </span><strong class="bold"><span class="koboSpan" id="kobo.1244.1">request.body</span></strong><span class="koboSpan" id="kobo.1245.1">;
      const newPlateId = await
        </span><strong class="bold"><span class="koboSpan" id="kobo.1246.1">app.source.insertRecipe</span></strong><span class="koboSpan" id="kobo.1247.1">({
          name,
          country,
          description,
          order,
          price,
          createdAt: new Date()
        });
      reply.code(201);
      </span><strong class="bold"><span class="koboSpan" id="kobo.1248.1">return { id: newPlateId };</span></strong><span class="koboSpan" id="kobo.1249.1">
    }
  });</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1250.1">
       When the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1251.1">
        addToMenu
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1252.1">
       function handler runs, we are 100% sure that the authentication hook is successful and only a valid chef is executing it.
      </span>
      <span class="koboSpan" id="kobo.1252.2">
       So, the function logic reads from the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1253.1">
        request.body
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1254.1">
       input data to compose a new JSON object.
      </span>
      <span class="koboSpan" id="kobo.1254.2">
       This
      </span>
      <a id="_idIndexMarker443">
      </a>
      <span class="koboSpan" id="kobo.1255.1">
       step is required to
      </span>
      <a id="_idIndexMarker444">
      </a>
      <span class="koboSpan" id="kobo.1256.1">
       avoid inserting unexpected fields (into the database) that a client may submit to our endpoint.
      </span>
      <span class="koboSpan" id="kobo.1256.2">
       Then, the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1257.1">
        app.source.insertRecipe
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1258.1">
       decorator is called to save the data.
      </span>
      <span class="koboSpan" id="kobo.1258.2">
       As the last operations, we set the HTTP response status to
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1259.1">
        201 – Created
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1260.1">
       (for a complete list of the standard HTTP status codes, refer to the list
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1261.1">
        here:
       </span>
      </span>
      <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1262.1">
         https://developer.mozilla.org/en-US/docs/Web/HTTP/Status
        </span>
       </span>
      </a>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1263.1">
        ).
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1264.1">
      We can try it now by running this
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1265.1">
        curl
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1266.1">
       command:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1267.1">$ curl -X POST http://localhost:3000/recipes -H "Content-Type: application/json" -H "x-api-key: fastify-rocks" -d '{"name":"Lasagna","country":"Italy","price":12}'</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1268.1">{"id":"64f9f3eaee2d03172a8c5efe"}</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1269.1">
       Our test is not over yet.
      </span>
      <span class="koboSpan" id="kobo.1269.2">
       You must try to run the same
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1270.1">
        curl
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1271.1">
       command, but you need to remove the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1272.1">
        x-api-key
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1273.1">
       header or change its value.
      </span>
      <span class="koboSpan" id="kobo.1273.2">
       We expect a
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1274.1">
        401 – Unauthorize
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1275.1">
       error in
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1276.1">
        these cases.
       </span>
      </span>
     </p>
    </li>
   </ol>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.1277.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1278.1">
     Instead of using
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1279.1">
      curl
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1280.1">
     to run HTTP requests against the application server, adopting an HTTP Client
    </span>
    <a id="_idIndexMarker445">
    </a>
    <span class="koboSpan" id="kobo.1281.1">
     with a
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1282.1">
      graphic user interface
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1283.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1284.1">
      GUI
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1285.1">
     ) may be easier.
    </span>
    <span class="koboSpan" id="kobo.1285.2">
     Here is a complete list where you may choose your favorite
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1286.1">
      one:
     </span>
    </span>
    <a href="https://github.com/mrmykey/awesome-http-clients/blob/main/Readme.md#gui">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1287.1">
       https://github.com/mrmykey/awesome-http-clients/blob/main/Readme.md#gui
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1288.1">
      .
     </span>
    </span>
   </p>
   <ol>
    <li value="9">
     <span class="koboSpan" id="kobo.1289.1">
      Before considering
     </span>
     <a id="_idIndexMarker446">
     </a>
     <span class="koboSpan" id="kobo.1290.1">
      this
     </span>
     <a id="_idIndexMarker447">
     </a>
     <span class="koboSpan" id="kobo.1291.1">
      section completed, we need to read from the database, so let’s implement the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1292.1">
       readRecipes
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1293.1">
      function in the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1294.1">
        plugins/datasource.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1295.1">
       file:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1296.1">
    async readRecipes (filters, sort = { order: 1 }) {
      const collection =
        app.mongo.db.collection('menu');
      const result = await
        collection.find(filters).sort(sort).toArray();
      return result;
    }</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1297.1">
       In this search function, we are using the standard MongoDB APIs (
      </span>
      <a href="https://www.mongodb.com/docs/drivers/node/current/fundamentals/crud/read-operations/retrieve/">
       <span class="koboSpan" id="kobo.1298.1">
        https://www.mongodb.com/docs/drivers/node/current/fundamentals/crud/read-operations/retrieve/
       </span>
      </a>
      <span class="koboSpan" id="kobo.1299.1">
       ).
      </span>
      <span class="koboSpan" id="kobo.1299.2">
       We may want to filter the data, so we expect a
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1300.1">
        filters
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1301.1">
       parameter.
      </span>
      <span class="koboSpan" id="kobo.1301.2">
       The
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1302.1">
        sort
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1303.1">
       argument, instead, is needed to return the dishes array in the right order, whereby, e.g., the appetizer will have
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1304.1">
        order=0
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1305.1">
       , the first course will have
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1306.1">
        order=1
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1307.1">
       , and
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1308.1">
        so on.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1309.1">
      Finally, we can update the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1310.1">
       routes/recipes.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1311.1">
      file with the new
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1312.1">
        menuHandler
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1313.1">
       code:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1314.1">
async function menuHandler (request, reply) {
  const recipes = await this.source.readRecipes();
  return recipes;
}</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1315.1">
      As usual, we can try to see if this code is working as expected by calling the server to see
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1316.1">
       the result:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1317.1">$ curl http://localhost:3000/menu</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1318.1">
       The
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1319.1">
        /menu
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1320.1">
       endpoint should answer with an array of all the dishes we stored in the menu collection during our
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1321.1">
        testing phase!
       </span>
      </span>
     </p>
    </li>
   </ol>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.1322.1">
     Important note
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1323.1">
     Should we implement pagination?
    </span>
    <span class="koboSpan" id="kobo.1323.2">
     Our
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1324.1">
      GET /menu
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1325.1">
     endpoint provides a list of data, and it’s considered a best practice to assess whether the list might be excessively large to return in a single HTTP call.
    </span>
    <span class="koboSpan" id="kobo.1325.2">
     In this specific case, it’s deemed acceptable to return the entire menu.
    </span>
    <span class="koboSpan" id="kobo.1325.3">
     However, if the menu were to contain hundreds of recipes, you might want to consider implementing pagination logic to break the data into manageable chunks.
    </span>
    <span class="koboSpan" id="kobo.1325.4">
     You can find guidance on how to implement two different pagination patterns in this article:
    </span>
    <a href="https://backend.cafe/streaming-postgresql-data-with-fastify">
     <span class="koboSpan" id="kobo.1326.1">
      https://backend.cafe/streaming-postgresql-data-with-fastify
     </span>
    </a>
    <span class="koboSpan" id="kobo.1327.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1327.2">
     Although the article discusses PostgreSQL, these pagination patterns can also be adapted for use
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1328.1">
      with MongoDB.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1329.1">
     In this recipe, we’ve
    </span>
    <a id="_idIndexMarker448">
    </a>
    <span class="koboSpan" id="kobo.1330.1">
     learned
    </span>
    <a id="_idIndexMarker449">
    </a>
    <span class="koboSpan" id="kobo.1331.1">
     how to establish a connection to a database.
    </span>
    <span class="koboSpan" id="kobo.1331.2">
     It’s worth noting that Fastify contributors provide support for various popular databases, including
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1332.1">
      PostgreSQL
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1333.1">
     ,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1334.1">
      MySQL
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1335.1">
     , and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1336.1">
      Redis
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1337.1">
     , among
    </span>
    <a id="_idIndexMarker450">
    </a>
    <span class="koboSpan" id="kobo.1338.1">
     others.
    </span>
    <span class="koboSpan" id="kobo.1338.2">
     You can find a comprehensive
    </span>
    <a id="_idIndexMarker451">
    </a>
    <span class="koboSpan" id="kobo.1339.1">
     list of
    </span>
    <a id="_idIndexMarker452">
    </a>
    <span class="koboSpan" id="kobo.1340.1">
     supported databases at
    </span>
    <a href="https://fastify.dev/ecosystem">
     <span class="koboSpan" id="kobo.1341.1">
      https://fastify.dev/ecosystem
     </span>
    </a>
    <span class="koboSpan" id="kobo.1342.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1342.2">
     In the upcoming recipe, we will discuss the data validation used to protect our endpoints from malicious users, and we will keep on implementing the missing
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1343.1">
      routes’ handlers.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-196">
    <a id="_idTextAnchor203">
    </a>
    <span class="koboSpan" id="kobo.1344.1">
     Validating the input data
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.1345.1">
     In the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1346.1">
      Implementing the business logic
     </span>
    </em>
    <span class="koboSpan" id="kobo.1347.1">
     recipe, we
    </span>
    <a id="_idIndexMarker453">
    </a>
    <span class="koboSpan" id="kobo.1348.1">
     stored input data from the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1349.1">
      POST /recipes
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1350.1">
     endpoint in the database.
    </span>
    <span class="koboSpan" id="kobo.1350.2">
     However, we did not implement any validation logic, which means we could potentially insert a string into the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1351.1">
      price
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1352.1">
     field or a recipe without
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1353.1">
      name
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1354.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1354.2">
     Furthermore, it’s important to consider security concerns, as a malicious user could potentially insert a recipe with a description that’s excessively large, posing a risk to your application’s performance
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1355.1">
      and storage.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1356.1">
     In the backend world, there is a rule: never trust the user’s input.
    </span>
    <span class="koboSpan" id="kobo.1356.2">
     Fastify knows it well, so it integrates a powerful and feature-complete validation process.
    </span>
    <span class="koboSpan" id="kobo.1356.3">
     Let’s see it
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1357.1">
      in action.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-197">
    <a id="_idTextAnchor204">
    </a>
    <span class="koboSpan" id="kobo.1358.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1359.1">
     Follow these steps to integrate the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1360.1">
      validation process:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1361.1">
      Add the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1362.1">
       schema
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1363.1">
      property to the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1364.1">
       POST /recipes
      </span>
     </strong>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1365.1">
       route option:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1366.1">
  const </span><strong class="bold"><span class="koboSpan" id="kobo.1367.1">jsonSchemaBody</span></strong><span class="koboSpan" id="kobo.1368.1"> = {
    type: 'object',
    required: ['name', 'country', 'order', 'price'],
    properties: {
      name: { type: 'string', minLength: 3, maxLength:
        50 },
      country: { type: 'string', enum: ['ITA', 'IND']
        },
      description: { type: 'string' },
      order: { type: 'number', minimum: 0, maximum:
        100 },
      price: { type: 'number', minimum: 0, maximum: 50
        }
    }
  };
  app.post('/recipes', {
    config: { auth: true },
    </span><strong class="bold"><span class="koboSpan" id="kobo.1369.1">schema</span></strong><span class="koboSpan" id="kobo.1370.1">: {
      </span><strong class="bold"><span class="koboSpan" id="kobo.1371.1">body: jsonSchemaBody</span></strong><span class="koboSpan" id="kobo.1372.1">
    },
    handler: async function addToMenu (request, reply)
    {
      // ...
</span><span class="koboSpan" id="kobo.1372.2">    }
  });</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1373.1">
       The
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1374.1">
        jsonSchemaBody
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1375.1">
       constant is an object defined in
      </span>
      <a id="_idIndexMarker454">
      </a>
      <span class="koboSpan" id="kobo.1376.1">
       the
      </span>
      <strong class="bold">
       <span class="koboSpan" id="kobo.1377.1">
        JSON schema
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1378.1">
       format.
      </span>
      <span class="koboSpan" id="kobo.1378.2">
       This format adheres to the specifications outlined in the JSON schema standard, which provides a framework for describing the structure and constraints of JSON documents, including those in request bodies.
      </span>
      <span class="koboSpan" id="kobo.1378.3">
       By employing a JSON schema interpreter, you can assess whether a given JSON object conforms to a
      </span>
      <a id="_idIndexMarker455">
      </a>
      <span class="koboSpan" id="kobo.1379.1">
       predefined structure and constraints, enhancing the validation process for your API requests.
      </span>
      <span class="koboSpan" id="kobo.1379.2">
       Fastify includes the
      </span>
      <a id="_idIndexMarker456">
      </a>
      <span class="koboSpan" id="kobo.1380.1">
       AJV (
      </span>
      <a href="https://ajv.js.org/">
       <span class="koboSpan" id="kobo.1381.1">
        https://ajv.js.org/
       </span>
      </a>
      <span class="koboSpan" id="kobo.1382.1">
       ) module to process the JSON schemas and validate the
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1383.1">
        request’s components.
       </span>
      </span>
     </p>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1384.1">
       The route option
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1385.1">
        schema
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1386.1">
       property accepts
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1387.1">
        these fields:
       </span>
      </span>
     </p>
     <ul>
      <li>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1388.1">
         body
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1389.1">
        : This schema is used to validate the
       </span>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1390.1">
         request.body
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1391.1">
        during the request evaluation, as we saw in
       </span>
       <span class="No-Break">
        <em class="italic">
         <span class="koboSpan" id="kobo.1392.1">
          Figure 6.2
         </span>
        </em>
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1393.1">
         .
        </span>
       </span>
      </li>
      <li>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1394.1">
         params
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1395.1">
        : This schema validates
       </span>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1396.1">
         request.params
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1397.1">
        , which contains the path parameters of the
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1398.1">
         request URL.
        </span>
       </span>
      </li>
      <li>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1399.1">
         headers
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1400.1">
        : It is possible to validate
       </span>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1401.1">
         request.headers
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1402.1">
        ; therefore, we may improve the routes protected by the authentication by adding a JSON schema that requires the
       </span>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1403.1">
         x-api-key
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1404.1">
        header to
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1405.1">
         be set.
        </span>
       </span>
      </li>
      <li>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1406.1">
         query
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1407.1">
        : We can validate the
       </span>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1408.1">
         request.query
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1409.1">
        object that contains all the query string parameters by
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1410.1">
         using this.
        </span>
       </span>
      </li>
      <li>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1411.1">
         response
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1412.1">
        : This field is a special one, and it does not accept a JSON schema out of the box.
       </span>
       <span class="koboSpan" id="kobo.1412.2">
        We will see it in action in the next
       </span>
       <em class="italic">
        <span class="koboSpan" id="kobo.1413.1">
         Enhancing application performance with
        </span>
       </em>
       <span class="No-Break">
        <em class="italic">
         <span class="koboSpan" id="kobo.1414.1">
          serialization
         </span>
        </em>
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1415.1">
         recipe.
        </span>
       </span>
      </li>
     </ul>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1416.1">
      Now, if we restart the server with the new route’s configuration, we will hit our first
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1417.1">
       400 –
      </span>
     </strong>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1418.1">
       Bad Request
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1419.1">
      response by running the same command as in
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1420.1">
       Step 8
      </span>
     </em>
     <span class="koboSpan" id="kobo.1421.1">
      of the
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1422.1">
       Implementing the business
      </span>
     </em>
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.1423.1">
        logic
       </span>
      </em>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1424.1">
       recipe:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1425.1">$ curl -X POST http://localhost:3000/recipes -H "Content-Type: application/json" -H "x-api-key: fastify-rocks" -d '{"name":"Lasagna","country":"Italy","price":12}'</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1426.1">{"statusCode":400,"code":"FST_ERR_VALIDATION","error":"Bad Request","message":"body must have required property 'order'"}%</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1427.1">
       It’s worth noting
      </span>
      <a id="_idIndexMarker457">
      </a>
      <span class="koboSpan" id="kobo.1428.1">
       that, in your scenario, you received only a single error message when you expected two errors to
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1429.1">
        be reported:
       </span>
      </span>
     </p>
     <ol>
      <li class="upper-roman">
       <span class="koboSpan" id="kobo.1430.1">
        The first error should relate to the incorrect
       </span>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1431.1">
         country
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1432.1">
        value.
       </span>
       <span class="koboSpan" id="kobo.1432.2">
        The JSON schema specifies an enumeration of just two ISO codes, and the provided value doesn’t match either
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1433.1">
         of them.
        </span>
       </span>
      </li>
      <li class="upper-roman">
       <span class="koboSpan" id="kobo.1434.1">
        The second error pertains to the missing
       </span>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1435.1">
         order
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1436.1">
        property, but it seems that only this error is being displayed in the
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1437.1">
         output message.
        </span>
       </span>
      </li>
     </ol>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1438.1">
       This situation occurs due to the default AJV configuration that Fastify uses.
      </span>
      <span class="koboSpan" id="kobo.1438.2">
       You can check the default setup
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1439.1">
        at
       </span>
      </span>
      <a href="https://github.com/fastify/ajv-compiler#ajv-configuration">
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1440.1">
         https://github.com/fastify/ajv-compiler#ajv-configuration
        </span>
       </span>
      </a>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1441.1">
        :
       </span>
      </span>
     </p>
     <pre class="source-code"><span class="koboSpan" id="kobo.1442.1">{
  coerceTypes: 'array',
  useDefaults: true,
  removeAdditional: true,
  uriResolver: require('fast-uri'),
  addUsedSchema: false,
  </span><strong class="bold"><span class="koboSpan" id="kobo.1443.1">allErrors: false</span></strong><span class="koboSpan" id="kobo.1444.1">
}</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1445.1">
      To resolve the issue and enable the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1446.1">
       allErrors
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1447.1">
      option, you should configure the server’s option object that is exported in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1448.1">
       app.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1449.1">
      file.
     </span>
     <span class="koboSpan" id="kobo.1449.2">
      Here’s how you can modify
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1450.1">
       the configuration:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1451.1">
const options = {
  logger: true,
  ajv: {
    customOptions: {
      allErrors: true
    }
  }
};</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1452.1">
      By restarting the
     </span>
     <a id="_idIndexMarker458">
     </a>
     <span class="koboSpan" id="kobo.1453.1">
      application and re-running the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1454.1">
       curl
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1455.1">
      command, we should get this
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1456.1">
       new output:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1457.1">{"statusCode":400,"code":"FST_ERR_VALIDATION","error":"Bad Request","message":"body must have required property 'order', body/country must be equal to one of the allowed values"}</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1458.1">
      Note that the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1459.1">
       ajv.customOptions
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1460.1">
      field will be merged with the default configuration, so verify each option and set it as it best fits your needs.
     </span>
     <span class="koboSpan" id="kobo.1460.2">
      The validation step is one of the most important and requires additional care to secure your APIs.
     </span>
     <span class="koboSpan" id="kobo.1460.3">
      Let me suggest my
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1461.1">
       preferred configuration:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1462.1">
customOptions: {
  </span><strong class="bold"><span class="koboSpan" id="kobo.1463.1">removeAdditional: 'all'</span></strong><span class="koboSpan" id="kobo.1464.1">
}</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1465.1">
       The
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1466.1">
        removeAdditional
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1467.1">
       option will enforce the removal of all input fields that are not explicitly listed in the route’s JSON schemas.
      </span>
      <span class="koboSpan" id="kobo.1467.2">
       This feature is a valuable addition to enhance security.
      </span>
      <span class="koboSpan" id="kobo.1467.3">
       It’s important to note that if you do not specify a JSON schema for a particular route, the removal logic will not be applied, and all input fields will be
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1468.1">
        retained as-is.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1469.1">
      We must implement the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1470.1">
       deleteRecipe
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1471.1">
      function first; therefore, we go into the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1472.1">
       plugins/datasource.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1473.1">
      file and write the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1474.1">
       following code:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1475.1">
    async deleteRecipe (recipeId) {
      const collection =
        app.mongo.db.collection('menu');
      const result = await collection.deleteOne({ _id:
        new app.mongo.ObjectId(recipeId) });
      return result.deletedCount;
    }</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1476.1">
       To delete the item
      </span>
      <a id="_idIndexMarker459">
      </a>
      <span class="koboSpan" id="kobo.1477.1">
       from MongoDB, we encapsulate the input for
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1478.1">
        id
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1479.1">
       within
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1480.1">
        ObjectId
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1481.1">
       .
      </span>
      <span class="koboSpan" id="kobo.1481.2">
       This is necessary because MongoDB expects the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1482.1">
        _id
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1483.1">
       field to be an
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1484.1">
        ObjectId
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1485.1">
       when performing
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1486.1">
        document deletions.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1487.1">
      We can proceed to implement the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1488.1">
       DELETE /recipes/:id
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1489.1">
      handler using all the new things we
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1490.1">
       have learned:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1491.1">
  app.delete('/recipes/:id', {
    config: { auth: true },
    schema: {
      </span><strong class="bold"><span class="koboSpan" id="kobo.1492.1">params</span></strong><span class="koboSpan" id="kobo.1493.1">: {
        type: 'object',
        properties: {
          id: { type: 'string', minLength: 24,
            maxLength: 24 }
        }
      }
    },
    handler: async function removeFromMenu (request,
      reply) {
      const { id } = request.params;
      const [recipe] = await </span><strong class="bold"><span class="koboSpan" id="kobo.1494.1">app.source.readRecipes</span></strong><span class="koboSpan" id="kobo.1495.1">({
        id });
      if (!recipe) {
        reply.code(404);
        throw new Error('Not found');
      }
      await </span><strong class="bold"><span class="koboSpan" id="kobo.1496.1">app.source.deleteRecipe</span></strong><span class="koboSpan" id="kobo.1497.1">(id);
      reply.code(204);
    }
  });</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1498.1">
       The route’s definition
      </span>
      <a id="_idIndexMarker460">
      </a>
      <span class="koboSpan" id="kobo.1499.1">
       incorporates a JSON schema in the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1500.1">
        schema.params
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1501.1">
       property to validate the input
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1502.1">
        id
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1503.1">
       .
      </span>
      <span class="koboSpan" id="kobo.1503.2">
       We perform a strict check to ensure that
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1504.1">
        id
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1505.1">
       is exactly 24 characters in length, which is a security measure to prevent potential long code injection attacks.
      </span>
      <span class="koboSpan" id="kobo.1505.2">
       Note that this validation is strictly related to MongoDB, and it demonstrates how you can protect your routes from bad actors.
      </span>
      <span class="koboSpan" id="kobo.1505.3">
       So, tweak this configuration based on
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1506.1">
        your needs.
       </span>
      </span>
     </p>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1507.1">
       Meanwhile, in the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1508.1">
        removeFromMenu
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1509.1">
       function implementation, we retrieve the recipe from the database by first reading it.
      </span>
      <span class="koboSpan" id="kobo.1509.2">
       Note the use of array destructuring because the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1510.1">
        readRecipes
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1511.1">
       function returns an array.
      </span>
      <span class="koboSpan" id="kobo.1511.2">
       If the item is missing in the database, we will return a
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1512.1">
        404 - Not Found
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1513.1">
       error.
      </span>
      <span class="koboSpan" id="kobo.1513.2">
       Otherwise, we delete the record and return a
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1514.1">
        204
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1515.1">
       response status code, indicating a
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1516.1">
        successful deletion.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1517.1">
      It is time to test our code.
     </span>
     <span class="koboSpan" id="kobo.1517.2">
      Therefore, we can try the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1518.1">
       curl
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1519.1">
      commands
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1520.1">
       as usual:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1521.1">$ curl -X POST http://localhost:3000/recipes -H "Content-Type: application/json" -H "x-api-key: fastify-rocks" -d '{"name":"Lasagna","country":"ITA","price":12,"order":1}'</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1522.1">{"id":"64fad8e761d11acc30098d0c"}</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1523.1">$ curl -X DELETE http://localhost:3000/recipes/111111111111111111111111 -H "x-api-key: fastify-rocks"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1524.1">{"statusCode":404,"error":"Not Found","message":"Not found"}</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1525.1">$ curl -X DELETE http://localhost:3000/recipes/64fad8e761d11acc30098d0c -H "x-api-key: fastify-rocks"</span></strong></pre>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1526.1">
     In this recipe, we’ve successfully
    </span>
    <a id="_idIndexMarker461">
    </a>
    <span class="koboSpan" id="kobo.1527.1">
     implemented all the routes defined in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1528.1">
      routes/recipes.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1529.1">
     file.
    </span>
    <span class="koboSpan" id="kobo.1529.2">
     In the upcoming recipe, we will continue by implementing the routes defined in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1530.1">
      routes/orders.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1531.1">
     while also introducing another exciting Fastify
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1532.1">
      feature: serialization!
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-198">
    <a id="_idTextAnchor205">
    </a>
    <span class="koboSpan" id="kobo.1533.1">
     Enhancing application performance with serialization
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.1534.1">
     The serialization step
    </span>
    <a id="_idIndexMarker462">
    </a>
    <span class="koboSpan" id="kobo.1535.1">
     converts the
    </span>
    <a id="_idIndexMarker463">
    </a>
    <span class="koboSpan" id="kobo.1536.1">
     high-level data generated by business logic, including JSON objects or errors, into low-level data, such as strings or buffers, which are then sent as responses to the client’s requests.
    </span>
    <span class="koboSpan" id="kobo.1536.2">
     It involves the transformation of intricate objects into an appropriate data type that can be effectively transmitted to the client.
    </span>
    <span class="koboSpan" id="kobo.1536.3">
     In fact, as mentioned in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1537.1">
      Implementing authentication with hooks
     </span>
    </em>
    <span class="koboSpan" id="kobo.1538.1">
     recipe, the serialization process is initiated only if the route handler doesn’t return a string, stream, or buffer, as these objects are already serialized and prepared for transmission as HTTP responses to the client.
    </span>
    <span class="koboSpan" id="kobo.1538.2">
     Nevertheless, this process can’t be avoided when you work with
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1539.1">
      JSON objects.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1540.1">
     Fastify incorporates a serialization module that facilitates the conversion of an object into a JSON string, leveraging a JSON schema definition.
    </span>
    <span class="koboSpan" id="kobo.1540.2">
     This module, known as
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1541.1">
      fast-json-stringify
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1542.1">
     , offers a notable performance boost when compared to the standard
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1543.1">
      JSON.stringify()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1544.1">
     function.
    </span>
    <span class="koboSpan" id="kobo.1544.2">
     In fact, it accelerates the serialization process by a factor of two for small payloads.
    </span>
    <span class="koboSpan" id="kobo.1544.3">
     Its performance advantage shrinks as payload grows, as demonstrated in their benchmark, which is available
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1545.1">
      at
     </span>
    </span>
    <a href="https://github.com/fastify/fast-json-stringify/">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1546.1">
       https://github.com/fastify/fast-json-stringify/
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1547.1">
      .
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-199">
    <a id="_idTextAnchor206">
    </a>
    <span class="koboSpan" id="kobo.1548.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1549.1">
     We will apply
    </span>
    <a id="_idIndexMarker464">
    </a>
    <span class="koboSpan" id="kobo.1550.1">
     the
    </span>
    <a id="_idIndexMarker465">
    </a>
    <span class="koboSpan" id="kobo.1551.1">
     serialization to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1552.1">
      /orders
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1553.1">
     endpoints, but first, we must create an order.
    </span>
    <span class="koboSpan" id="kobo.1553.2">
     For this recipe, follow
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1554.1">
      these steps:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1555.1">
      Let’s implement the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1556.1">
        insertOrder
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1557.1">
       function:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1558.1">
    async insertOrder (order) {
      const _id = new app.mongo.ObjectId();
      order._id = _id;
      order.id = _id.toString();
      const collection =
        app.mongo.db.collection('orders');
      const result = await
        collection.insertOne(order);
      return result.insertedId;
    }</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1559.1">
       The code snippet should be familiar to you.
      </span>
      <span class="koboSpan" id="kobo.1559.2">
       We insert the input object into the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1560.1">
        orders
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1561.1">
       collection straight away.
      </span>
      <span class="koboSpan" id="kobo.1561.2">
       Then, we can implement the route handler
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1562.1">
        in
       </span>
      </span>
      <span class="No-Break">
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1563.1">
         routes/orders.js
        </span>
       </strong>
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1564.1">
        .
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1565.1">
      Since we need to deal with user input, we can define this
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1566.1">
       JSON schema:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1567.1">
  const orderJsonSchema = {
    type: 'object',
    required: ['table', 'dishes'],
    properties: {
      table: { type: 'number', minimum: 1 },
      dishes: {
        type: 'array',
        minItems: 1,
        items: {
          type: 'object',
          required: ['id', 'quantity'],
          properties: {
            id: { type: 'string', minLength: 24,
              maxLength: 24 },
            quantity: { type: 'number', minimum: 1 }
          }
        }
      }
    }
  };</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1568.1">
       It defines
      </span>
      <a id="_idIndexMarker466">
      </a>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1569.1">
        two
       </span>
      </span>
      <span class="No-Break">
       <a id="_idIndexMarker467">
       </a>
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1570.1">
        properties:
       </span>
      </span>
     </p>
     <ul>
      <li>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1571.1">
         table
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1572.1">
        : This helps us understand which
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1573.1">
         customer ordered.
        </span>
       </span>
      </li>
      <li>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1574.1">
         dishes
        </span>
       </strong>
       <span class="koboSpan" id="kobo.1575.1">
        : This is a JSON object array that must have at least one item.
       </span>
       <span class="koboSpan" id="kobo.1575.2">
        Every item must contain the recipe
       </span>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1576.1">
         id
        </span>
       </strong>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1577.1">
         and
        </span>
       </span>
       <span class="No-Break">
        <strong class="source-inline">
         <span class="koboSpan" id="kobo.1578.1">
          quantity
         </span>
        </strong>
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1579.1">
         .
        </span>
       </span>
      </li>
     </ul>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1580.1">
       Thanks to the JSON schema, we can avoid a lot of boring
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1581.1">
        if
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1582.1">
       statements and checks such as checking if the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1583.1">
        quantity
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1584.1">
       input field is a
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1585.1">
        negative value!
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1586.1">
      Finally, we can move on to the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1587.1">
       route implementation:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1588.1">
  app.post('/orders', {
    schema: {
      body: orderJsonSchema
    },
    handler: async function createOrder (request,
      reply) {
        const order = {
          status: 'pending',
          createdAt: new Date(),
          items: request.body.dishes
        };
      const orderId = await
        this.source.insertOrder(order);
      reply.code(201);
      return { id: orderId };
    }
  });</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1589.1">
       You’re likely
      </span>
      <a id="_idIndexMarker468">
      </a>
      <span class="koboSpan" id="kobo.1590.1">
       familiar
      </span>
      <a id="_idIndexMarker469">
      </a>
      <span class="koboSpan" id="kobo.1591.1">
       with the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1592.1">
        createOrder
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1593.1">
       function by now.
      </span>
      <span class="koboSpan" id="kobo.1593.2">
       For the sake of simplicity, we’ll store the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1594.1">
        request.body.dishes
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1595.1">
       array as-is without validating the IDs.
      </span>
      <span class="koboSpan" id="kobo.1595.2">
       However, I recommend implementing a
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1596.1">
        preHandler
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1597.1">
       hook to handle this validation step, which the JSON schema can’t perform, and I encourage you to consider it as
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1598.1">
        an exercise.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1599.1">
      We are ready to try the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1600.1">
       route out:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1601.1">$ curl -X POST http://localhost:3000/orders -H "Content-Type: application/json" -d '{"table":42,"dishes":[{"id":"64fad8e761d11acc30098d0c","quantity":2},{"id":"64fad8e761d11acc30098d0z","quantity":1}]}'</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1602.1">{"id":"64faeccfac24fcc42c6ffda8"}</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1603.1">
       Well done!
      </span>
      <span class="koboSpan" id="kobo.1603.2">
       We have consolidated what we have learned in the
      </span>
      <em class="italic">
       <span class="koboSpan" id="kobo.1604.1">
        Implementing the business logic
       </span>
      </em>
      <span class="koboSpan" id="kobo.1605.1">
       recipe.
      </span>
      <span class="koboSpan" id="kobo.1605.2">
       We are now ready to move on to the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1606.1">
        GET /orders
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1607.1">
       route to see the serialization process
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1608.1">
        in action.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1609.1">
      As usual, we should implement the database access first; therefore, in
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1610.1">
       plugins/datasource.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1611.1">
      , we can write
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1612.1">
       the following:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1613.1">
async readOrders (filters, sort = </span><strong class="bold"><span class="koboSpan" id="kobo.1614.1">{ createdAt: -1 }</span></strong><span class="koboSpan" id="kobo.1615.1">) {
      const collection =
        app.mongo.db.collection('orders');
      const result = await
        collection.find(filters).sort(sort).toArray();
      return result;
    }</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1616.1">
       In the provided
      </span>
      <a id="_idIndexMarker470">
      </a>
      <span class="koboSpan" id="kobo.1617.1">
       code
      </span>
      <a id="_idIndexMarker471">
      </a>
      <span class="koboSpan" id="kobo.1618.1">
       snippet, there isn’t anything substantially new, except that we’re configuring a default sorting by using
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1619.1">
        createdAt
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1620.1">
       in reverse order.
      </span>
      <span class="koboSpan" id="kobo.1620.2">
       This arrangement prioritizes older orders, ensuring they are
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1621.1">
        fulfilled first.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1622.1">
      Then, we can move to the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1623.1">
       endpoint handler:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1624.1">
app.get('/orders', {
  handler: async function readOrders (request, reply)
  {
    const orders = await </span><strong class="bold"><span class="koboSpan" id="kobo.1625.1">this.source.readOrders</span></strong><span class="koboSpan" id="kobo.1626.1">({
      status: 'pending' });
    const recipesIds = orders.flatMap(order =&gt;
      order.items.map(item =&gt; item.id));
    const recipes = await </span><strong class="bold"><span class="koboSpan" id="kobo.1627.1">this.source.readRecipes</span></strong><span class="koboSpan" id="kobo.1628.1">({
      id: { $in: recipesIds } });
    return </span><strong class="bold"><span class="koboSpan" id="kobo.1629.1">orders.map</span></strong><span class="koboSpan" id="kobo.1630.1">(order =&gt; {
      order.items = order.items
        .map(item =&gt; {
          const recipe = recipes.find(recipe =&gt;
            recipe.id === item.id)
          return recipe ? </span><span class="koboSpan" id="kobo.1630.2">{ ...recipe, quantity:
            item.quantity } : undefined;
          })
          .filter(recipe =&gt; recipe !== undefined);
        return order;
      });
    }
  });</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1631.1">
       The
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1632.1">
        readOrders
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1633.1">
       function
      </span>
      <a id="_idIndexMarker472">
      </a>
      <span class="koboSpan" id="kobo.1634.1">
       introduces a
      </span>
      <a id="_idIndexMarker473">
      </a>
      <span class="koboSpan" id="kobo.1635.1">
       more comprehensive logic compared to what we saw earlier in
      </span>
      <em class="italic">
       <span class="koboSpan" id="kobo.1636.1">
        Step 5
       </span>
      </em>
      <span class="koboSpan" id="kobo.1637.1">
       .
      </span>
      <span class="koboSpan" id="kobo.1637.2">
       Here’s an overview of the steps
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1638.1">
        it takes:
       </span>
      </span>
     </p>
     <ol>
      <li class="upper-roman">
       <span class="koboSpan" id="kobo.1639.1">
        Initially, it reads all the
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1640.1">
         pending orders.
        </span>
       </span>
      </li>
      <li class="upper-roman">
       <span class="koboSpan" id="kobo.1641.1">
        Then, it collects all the recipe IDs used across all the orders to optimize performance by running a single query to select only those recipes that are
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1642.1">
         actually used.
        </span>
       </span>
      </li>
      <li class="upper-roman">
       <span class="koboSpan" id="kobo.1643.1">
        Finally, it iterates through the orders array to replace the items array, which was initially read from the database, with the corresponding recipe items from
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1644.1">
         the database.
        </span>
       </span>
      </li>
     </ol>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1645.1">
       It’s worth mentioning that we have seen how to use multiple datasource methods in one handler.
      </span>
      <span class="koboSpan" id="kobo.1645.2">
       If we would like to optimize the code even further, we could use a MongoDB
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1646.1">
        $lookup
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1647.1">
       to run a single query to the database instead of two, as
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1648.1">
        we did.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1649.1">
      One notable detail is the use of a filter to skip recipes that were not found in the system.
     </span>
     <span class="koboSpan" id="kobo.1649.2">
      This is an edge case consideration because an order may include a recipe that was deleted after it was created, and in such cases, we want to ensure that these
     </span>
     <a id="_idIndexMarker474">
     </a>
     <span class="koboSpan" id="kobo.1650.1">
      deleted
     </span>
     <a id="_idIndexMarker475">
     </a>
     <span class="koboSpan" id="kobo.1651.1">
      recipes are not displayed in the output.
     </span>
     <span class="koboSpan" id="kobo.1651.2">
      We are ready to test this implementation by executing a command in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1652.1">
       the shell:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1653.1">$ curl http://localhost:3000/orders</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1654.1">
       We expect a big output displaying the orders in our system.
      </span>
      <span class="koboSpan" id="kobo.1654.2">
       Here is an example of one
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1655.1">
        order output:
       </span>
      </span>
     </p>
     <pre class="source-code"><span class="koboSpan" id="kobo.1656.1">[
  {
    "status": "pending",
    "createdAt": "2023-09-08T09:56:49.750Z",
    "items": [
      {
        "name": "Lasagna",
        "country": "ITA",
        "description": "Lasagna is a traditional Italian dish made with alternating layers of pasta, cheese, and sauce.",
        "order": 1,
        "price": 12,
        "quantity": 1,
        "createdAt": "2023-09-08T09:54:28.904Z",
        "id": "64faefcc9094146c83d2ffd7"
      }
    ],
    "id": "64faefe19094146c83d2ffd8"
  }
]</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1657.1">
       As you can see, the provided information contains more details than the target user requires.
      </span>
      <span class="koboSpan" id="kobo.1657.2">
       It’s time
      </span>
      <a id="_idIndexMarker476">
      </a>
      <span class="koboSpan" id="kobo.1658.1">
       to
      </span>
      <a id="_idIndexMarker477">
      </a>
      <span class="koboSpan" id="kobo.1659.1">
       configure the serialization process to ensure that the data presented to the user is concise and relevant to
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1660.1">
        their needs.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1661.1">
      In the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1662.1">
       routes/orders.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1663.1">
      file, add this
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1664.1">
       JSON schema:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1665.1">
  const orderListSchema = {
    type: 'array',
    items: {
      type: 'object',
      properties: {
        id: { type: 'string' },
        createdAt: { type: 'string', </span><strong class="bold"><span class="koboSpan" id="kobo.1666.1">format</span></strong><span class="koboSpan" id="kobo.1667.1">: 'date-
          time' },
        items: {
          type: 'array',
          items: {
            type: 'object',
            properties: {
              name: { type: 'string' },
              order: { type: 'number' },
              quantity: { type: 'number' }
            }
          }
        }
      }
    }
  };</span></pre>
     <p class="list-inset">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1668.1">
        orderListSchema
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1669.1">
       specifically outlines the fields we desire in the response payload, mapping only the properties’ types without specifying attributes to define the maximum string length or valid number ranges.
      </span>
      <span class="koboSpan" id="kobo.1669.2">
       It’s worth noting the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1670.1">
        format
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1671.1">
       attribute, which allows for the customization of the output for a date field.
      </span>
      <span class="koboSpan" id="kobo.1671.2">
       However, it’s important to clarify that this concept can sometimes be misunderstood: the
      </span>
      <a id="_idIndexMarker478">
      </a>
      <span class="koboSpan" id="kobo.1672.1">
       JSON
      </span>
      <a id="_idIndexMarker479">
      </a>
      <span class="koboSpan" id="kobo.1673.1">
       schema used for serialization does not apply any validation but solely filters the data.
      </span>
      <span class="koboSpan" id="kobo.1673.2">
       Therefore, any additional validation rules added to the JSON schema will be ignored during the
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1674.1">
        serialization process.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1675.1">
      To apply the JSON schema to the endpoint, we must edit the route’s option
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1676.1">
       as follows:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1677.1">
  app.get('/orders', {
    schema: {
      </span><strong class="bold"><span class="koboSpan" id="kobo.1678.1">response</span></strong><span class="koboSpan" id="kobo.1679.1">: {
        </span><strong class="bold"><span class="koboSpan" id="kobo.1680.1">200</span></strong><span class="koboSpan" id="kobo.1681.1">: orderListSchema
      }
    },
    handler: async function readOrders (request,
      reply) {}
  };</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1682.1">
       To use a JSON schema during serialization, it’s essential to configure the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1683.1">
        schema.response
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1684.1">
       object.
      </span>
      <span class="koboSpan" id="kobo.1684.2">
       Notably, you can specify the HTTP status codes to which the particular schema should be applied.
      </span>
      <span class="koboSpan" id="kobo.1684.3">
       You have the flexibility to define different schemas for various status codes.
      </span>
      <span class="koboSpan" id="kobo.1684.4">
       Additionally, there’s another convenient Fastify pattern that you can utilize.
      </span>
      <span class="koboSpan" id="kobo.1684.5">
       By setting the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1685.1">
        "2xx"
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1686.1">
       property within the schema, it will be used for all HTTP status codes ranging from 200 to 299, simplifying
      </span>
      <a id="_idIndexMarker480">
      </a>
      <span class="koboSpan" id="kobo.1687.1">
       the
      </span>
      <a id="_idIndexMarker481">
      </a>
      <span class="koboSpan" id="kobo.1688.1">
       schema configuration for a range of
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1689.1">
        successful responses.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1690.1">
      If we run the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1691.1">
       curl
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1692.1">
      command from
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.1693.1">
       Step 7
      </span>
     </em>
     <span class="koboSpan" id="kobo.1694.1">
      , we will get even
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1695.1">
       better output:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1696.1">
[
  {
    "id": "64faefe19094146c83d2ffd8",
    "createdAt": "2023-09-08T09:56:49.750Z",
    "items": [
      {
        "name": "Lasagna",
        "order": 1,
        "quantity": 1
      }
    ]
  }
]</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1697.1">
       By successfully implementing a JSON schema for serializing the output of the order endpoint, you’ve enhanced both the speed and security of your application.
      </span>
      <span class="koboSpan" id="kobo.1697.2">
       This approach ensures that only the designated fields are returned, safeguarding against the inadvertent exposure of sensitive data as the database evolves over time.
      </span>
      <span class="koboSpan" id="kobo.1697.3">
       Specifying a JSON schema as part of your response is consistently considered good practice for maintaining control over the data exposed to clients and enhancing
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1698.1">
        overall security.
       </span>
      </span>
     </p>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1699.1">
     With the knowledge and tools we’ve covered thus far, you should be well equipped to complete the implementation of the final
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1700.1">
      PATH /orders/:orderId
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1701.1">
     route.
    </span>
    <span class="koboSpan" id="kobo.1701.2">
     If you encounter any doubts or need further guidance, you can refer to the complete source code available in the book’s repository
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1702.1">
      at
     </span>
    </span>
    <a href="https://github.com/PacktPublishing/Node.js-Cookbook-Fifth-Edition/tree/main/Chapter06">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1703.1">
       https://github.com/PacktPublishing/Node.js-Cookbook-Fifth-Edition/tree/main/Chapter06
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1704.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1705.1">
     Once you’ve finished this route, you can consider the overall application complete.
    </span>
    <span class="koboSpan" id="kobo.1705.2">
     While there is room for further improvements, such as adding a JSON schema to all the routes, it might be considered optional to delve into this in detail since we’ve already covered the
    </span>
    <a id="_idIndexMarker482">
    </a>
    <span class="koboSpan" id="kobo.1706.1">
     fundamental
    </span>
    <a id="_idIndexMarker483">
    </a>
    <span class="koboSpan" id="kobo.1707.1">
     concepts behind it.
    </span>
    <span class="koboSpan" id="kobo.1707.2">
     Now, you are ready to move on to the next section, where you’ll learn how to write tests for your
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1708.1">
      Fastify application.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-200">
    <a id="_idTextAnchor207">
    </a>
    <span class="koboSpan" id="kobo.1709.1">
     Configuring and testing a Fastify application
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.1710.1">
     In the previous recipe, I mentioned
    </span>
    <a id="_idIndexMarker484">
    </a>
    <span class="koboSpan" id="kobo.1711.1">
     that the application could
    </span>
    <a id="_idIndexMarker485">
    </a>
    <span class="koboSpan" id="kobo.1712.1">
     be considered complete.
    </span>
    <span class="koboSpan" id="kobo.1712.2">
     However, as an application truly achieves completeness only when it has a comprehensive test suite, in this recipe, our focus shifts to testing our endpoints to assert their functionality and correctness.
    </span>
    <span class="koboSpan" id="kobo.1712.3">
     This testing ensures that as we make changes to the code in the future, we can reliably verify that we have not introduced any new bugs
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1713.1">
      or regressions.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1714.1">
     We will use the new Node.js test runner in this recipe, providing a sneak peek into
    </span>
    <a href="B19212_08.xhtml#_idTextAnchor243">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.1715.1">
        Chapter 8
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.1716.1">
     , where we will delve deeper into this subject and do so in a more focused manner.
    </span>
    <span class="koboSpan" id="kobo.1716.2">
     For now, we will cover the basics to get you started with testing.
    </span>
    <span class="koboSpan" id="kobo.1716.3">
     So, let’s start this
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1717.1">
      new goal!
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-201">
    <a id="_idTextAnchor208">
    </a>
    <span class="koboSpan" id="kobo.1718.1">
     Getting ready
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1719.1">
     We will begin this recipe by reading the application’s configuration, followed by writing
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1720.1">
      application tests.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1721.1">
     Up until now, we’ve hardcoded certain elements in our code, including
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1722.1">
      the following:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.1723.1">
      The database
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1724.1">
       connection URL
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1725.1">
      The API key
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1726.1">
       for authentication
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.1727.1">
     However, this approach isn’t ideal for our application because we should have the flexibility to change these values as needed, especially in different environments.
    </span>
    <span class="koboSpan" id="kobo.1727.2">
     The best practice in such cases is to access the environment variables provided by the system.
    </span>
    <span class="koboSpan" id="kobo.1727.3">
     Additionally, this is a requirement for writing tests, allowing us to inject different configurations as
    </span>
    <a id="_idIndexMarker486">
    </a>
    <span class="koboSpan" id="kobo.1728.1">
     necessary
    </span>
    <a id="_idIndexMarker487">
    </a>
    <span class="koboSpan" id="kobo.1729.1">
     for testing various scenarios
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1730.1">
      and environments.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-202">
    <a id="_idTextAnchor209">
    </a>
    <span class="koboSpan" id="kobo.1731.1">
     How to do it…
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1732.1">
     To achieve this task, we need to follow
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1733.1">
      these steps:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1734.1">
      Install a new
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1735.1">
       Fastify module:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1736.1">$ npm install @fastify/env@5</span></strong></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1737.1">
      Then, we need to create a new file,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1738.1">
       plugins/config.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1739.1">
      , with the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1740.1">
       following content:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1741.1">
import fp from 'fastify-plugin';
import fastifyEnv from '@fastify/env';
async function configPlugin (app, opts) {
  const </span><strong class="bold"><span class="koboSpan" id="kobo.1742.1">envSchema</span></strong><span class="koboSpan" id="kobo.1743.1"> = {
    type: 'object',
    required: ['API_KEY', 'DATABASE_URL'],
    properties: {
      NODE_ENV: { type: 'string', default:
        'development' },
      PORT: { type: 'integer', default: 3000 },
      API_KEY: { type: 'string' },
      DATABASE_URL: { type: 'string' }
    }
  };
  app.register(fastifyEnv, {
    confKey: </span><strong class="bold"><span class="koboSpan" id="kobo.1744.1">'appConfig'</span></strong><span class="koboSpan" id="kobo.1745.1">,
    schema: envSchema,
    data: </span><strong class="bold"><span class="koboSpan" id="kobo.1746.1">opts.applicationEnv</span></strong><span class="koboSpan" id="kobo.1747.1">
  });
}
export default fp(configPlugin);</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1748.1">
       The plugin code should
      </span>
      <a id="_idIndexMarker488">
      </a>
      <span class="koboSpan" id="kobo.1749.1">
       be
      </span>
      <a id="_idIndexMarker489">
      </a>
      <span class="koboSpan" id="kobo.1750.1">
       fairly understandable, even if you’re encountering it for the first time.
      </span>
      <span class="koboSpan" id="kobo.1750.2">
       This plugin defines an
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1751.1">
        envSchema
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1752.1">
       constant with a JSON schema.
      </span>
      <span class="koboSpan" id="kobo.1752.2">
       This schema is subsequently used as a configuration for the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1753.1">
        @fastify/env
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1754.1">
       module.
      </span>
      <span class="koboSpan" id="kobo.1754.2">
       This module validates the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1755.1">
        process.env
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1756.1">
       object against the provided input schema.
      </span>
      <span class="koboSpan" id="kobo.1756.2">
       Consequently, if the required configuration is missing or incorrect, the application will not start successfully.
      </span>
      <span class="koboSpan" id="kobo.1756.3">
       Moreover, the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1757.1">
        confKey
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1758.1">
       option lets you set a custom name for the server decorator that this module is going
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1759.1">
        to add.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1760.1">
      If you register this plugin in the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1761.1">
       app.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1762.1">
      file and attempt to restart the server, you will encounter an error during the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1763.1">
       startup process:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1764.1">Error: env must have required property 'API_KEY', env must have required property 'DATABASE_URL'</span></strong></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1765.1">
       To fix this configuration issue, we need to begin passing the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1766.1">
        opts
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1767.1">
       argument in our plugin declarations.
      </span>
      <span class="koboSpan" id="kobo.1767.2">
       Let’s address this problem using a
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1768.1">
        top-down approach.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1769.1">
      Start by opening the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1770.1">
       server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1771.1">
      file and making the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1772.1">
       following updates:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1773.1">
const app = fastify(options);
app.register(appPlugin, {
  </span><strong class="bold"><span class="koboSpan" id="kobo.1774.1">applicationEnv</span></strong><span class="koboSpan" id="kobo.1775.1">: {
    </span><strong class="bold"><span class="koboSpan" id="kobo.1776.1">API_KEY</span></strong><span class="koboSpan" id="kobo.1777.1">: 'fastify-rocks',
    </span><strong class="bold"><span class="koboSpan" id="kobo.1778.1">DATABASE_URL</span></strong><span class="koboSpan" id="kobo.1779.1">:
</span><strong class="bold"><span class="koboSpan" id="kobo.1780.1">      </span></strong><span class="koboSpan" id="kobo.1781.1">'mongodb://localhost:27017/restaurant',
    </span><strong class="bold"><span class="koboSpan" id="kobo.1782.1">...process.env</span></strong><span class="koboSpan" id="kobo.1783.1">
  }
});</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1784.1">
       We introduced
      </span>
      <a id="_idIndexMarker490">
      </a>
      <span class="koboSpan" id="kobo.1785.1">
       a
      </span>
      <a id="_idIndexMarker491">
      </a>
      <span class="koboSpan" id="kobo.1786.1">
       configuration object during the registration of
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1787.1">
        appPlugin
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1788.1">
       .
      </span>
      <span class="koboSpan" id="kobo.1788.2">
       The
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1789.1">
        applicationEnv
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1790.1">
       property is derived from merging
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1791.1">
        process.env
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1792.1">
       with the default values specified in the code.
      </span>
      <span class="koboSpan" id="kobo.1792.2">
       In cases where
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1793.1">
        process.env
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1794.1">
       contains values for
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1795.1">
        API_KEY
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1796.1">
       or
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1797.1">
        DATABASE_URL
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1798.1">
       , these environment-specific values take precedence over the defaults defined in
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1799.1">
        the code.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1800.1">
      Now, we need to go back to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1801.1">
       app.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1802.1">
      and update
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1803.1">
       it accordingly:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1804.1">
import configPlugin from './plugins/config.js';
// ...
</span><span class="koboSpan" id="kobo.1804.2">async function appPlugin (app, </span><strong class="bold"><span class="koboSpan" id="kobo.1805.1">opts</span></strong><span class="koboSpan" id="kobo.1806.1">) {
  // ...
</span><span class="koboSpan" id="kobo.1806.2">  app.register(configPlugin, </span><strong class="bold"><span class="koboSpan" id="kobo.1807.1">opts</span></strong><span class="koboSpan" id="kobo.1808.1">);
  // ...
</span><span class="koboSpan" id="kobo.1808.2">}</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1809.1">
       In this context, the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1810.1">
        opts
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1811.1">
       argument corresponds to the second object parameter we recently added in the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1812.1">
        server.js
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1813.1">
       file.
      </span>
      <span class="koboSpan" id="kobo.1813.2">
       Consequently,
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1814.1">
        configPlugin
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1815.1">
       also receives the same object because we added it during the registration.
      </span>
      <span class="koboSpan" id="kobo.1815.2">
       If we refer back to the initial code snippet in this recipe, which showcases the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1816.1">
        configPlugin
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1817.1">
       implementation, you’ll observe that we’ve already supplied the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1818.1">
        opts.applicationEnv
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1819.1">
       option to
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1820.1">
        @fastify/env
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1821.1">
       .
      </span>
      <span class="koboSpan" id="kobo.1821.2">
       This indicates that it’s now reading the
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1822.1">
        correct configuration.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1823.1">
      With these adjustments, we should be able to restart the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1824.1">
       server successfully.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1825.1">
      We have changed a lot of code but still need to remove the hardcoded configuration from
     </span>
     <a id="_idIndexMarker492">
     </a>
     <span class="koboSpan" id="kobo.1826.1">
      the
     </span>
     <a id="_idIndexMarker493">
     </a>
     <span class="koboSpan" id="kobo.1827.1">
      plugins.
     </span>
     <span class="koboSpan" id="kobo.1827.2">
      Let’s do it now, starting with the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1828.1">
        app.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1829.1">
       file:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1830.1">
async function appPlugin (app, opts) {
  // ...
</span><span class="koboSpan" id="kobo.1830.2">  </span><strong class="bold"><span class="koboSpan" id="kobo.1831.1">await</span></strong><span class="koboSpan" id="kobo.1832.1"> app.register(configPlugin, opts);
  app.register(datasourcePlugin, { databaseUrl:
    </span><strong class="bold"><span class="koboSpan" id="kobo.1833.1">app.appConfig</span></strong><span class="koboSpan" id="kobo.1834.1">.DATABASE_URL });
  app.register(authPlugin, { tokenValue:
    </span><strong class="bold"><span class="koboSpan" id="kobo.1835.1">app.appConfig</span></strong><span class="koboSpan" id="kobo.1836.1">.API_KEY });
  // ...
</span><span class="koboSpan" id="kobo.1836.2">}</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1837.1">
       In this code snippet, you’ll notice a new syntax:
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1838.1">
        await app.register()
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1839.1">
       .
      </span>
      <span class="koboSpan" id="kobo.1839.2">
       Now,
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1840.1">
        await
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1841.1">
       is crucial because, without it, your server won’t start.
      </span>
      <span class="koboSpan" id="kobo.1841.2">
       As a reminder, in the
      </span>
      <em class="italic">
       <span class="koboSpan" id="kobo.1842.1">
        Splitting the code into small plugins
       </span>
      </em>
      <span class="koboSpan" id="kobo.1843.1">
       recipe, we discussed that plugin functions are not executed until one of the following methods is called:
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1844.1">
        app.listen()
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1845.1">
       ,
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1846.1">
        app.ready()
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1847.1">
       , or
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1848.1">
        app.inject()
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1849.1">
       .
      </span>
      <span class="koboSpan" id="kobo.1849.2">
       While this principle remains accurate, using
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1850.1">
        await app.register()
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1851.1">
       effectively triggers Fastify to initiate the loading process up to the awaited line, ensuring the necessary setup occurs before further execution.
      </span>
      <span class="koboSpan" id="kobo.1851.2">
       In fact, we use the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1852.1">
        app.appConfig
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1853.1">
       decorator in the following line, and this field will remain undefined if we don’t wait for (
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1854.1">
        await)
       </span>
      </span>
      <span class="No-Break">
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1855.1">
         configPlugin
        </span>
       </strong>
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1856.1">
        .
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1857.1">
      In the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1858.1">
       plugins/datasource.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1859.1">
      file, we can update the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1860.1">
       MongoDB setup:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1861.1">
  app.register(fastifyMongo, {
    </span><strong class="bold"><span class="koboSpan" id="kobo.1862.1">url: opts.databaseUrl</span></strong><span class="koboSpan" id="kobo.1863.1">
  });</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1864.1">
      In
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1865.1">
       plugins/auth.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1866.1">
      , we can remove the hardcoded API key
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1867.1">
       as follows:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1868.1">
  app.decorateRequest('isChef', function () {
    return this.headers['x-api-key'] ===
      </span><strong class="bold"><span class="koboSpan" id="kobo.1869.1">opts.tokenValue</span></strong><span class="koboSpan" id="kobo.1870.1">;
  });</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1871.1">
       Great job!
      </span>
      <span class="koboSpan" id="kobo.1871.2">
       You’ve now achieved a dynamic application that adapts its configuration based on the environment, validates prerequisites before starting, and leverages
      </span>
      <a id="_idIndexMarker494">
      </a>
      <span class="koboSpan" id="kobo.1872.1">
       another
      </span>
      <a id="_idIndexMarker495">
      </a>
      <span class="koboSpan" id="kobo.1873.1">
       feature of Fastify’s plugin system by utilizing the ability to await a plugin.
      </span>
      <span class="koboSpan" id="kobo.1873.2">
       Additionally, you’ve improved the authentication and data source plugins, making them more configurable and suitable for use across your organization’s projects.
      </span>
      <span class="koboSpan" id="kobo.1873.3">
       By configuring the plugins via the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1874.1">
        register
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1875.1">
       method, we can create plugins that are decoupled from the rest of the application and do not require the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1876.1">
        app.appConfig
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1877.1">
       decorator
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1878.1">
        to work.
       </span>
      </span>
     </p>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1879.1">
       With all these pieces in place, you’re well prepared to begin writing your test suite.
      </span>
      <span class="koboSpan" id="kobo.1879.2">
       The dynamic configuration you’ve created will prove invaluable as you embark on the testing phase of
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1880.1">
        your project.
       </span>
      </span>
     </p>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1881.1">
       Your Fastify application can be effectively represented by the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1882.1">
        appPlugin
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1883.1">
       instance and the server’s configuration exported by the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1884.1">
        app.js
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1885.1">
       file.
      </span>
      <span class="koboSpan" id="kobo.1885.2">
       In fact, there is minimal value in testing the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1886.1">
        server.js
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1887.1">
       file, as it primarily serves as a straightforward runner that can be readily replaced by the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1888.1">
        fastify-cli
       </span>
      </strong>
      <span class="koboSpan" id="kobo.1889.1">
       module
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1890.1">
        when necessary.
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1891.1">
      The initial step of writing tests for a Fastify application is to enable the creation of a
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1892.1">
        test/helper.js
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1893.1">
       file:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1894.1">
import { fastify } from 'fastify';
import appPlugin, { options } from '../app.js';
const defaultTestEnv = {
  NODE_ENV: 'test',
  API_KEY: 'test-suite',
  DATABASE_URL: 'mongodb://localhost:27017/restaurant-
    test-run'
};
async function buildApplication (env, serverOptions =
  { logger: false }) {
    const testServerOptions = Object.assign({},
      options, serverOptions);
    const testEnv = Object.assign({}, defaultTestEnv,
      env);
    const app = fastify(testServerOptions);
    app.register(appPlugin, { applicationEnv: testEnv
    });
  return app;
}
export { buildApplication };</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1895.1">
       We are ready to
      </span>
      <a id="_idIndexMarker496">
      </a>
      <span class="koboSpan" id="kobo.1896.1">
       write
      </span>
      <a id="_idIndexMarker497">
      </a>
      <span class="koboSpan" id="kobo.1897.1">
       our first test
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1898.1">
        file:
       </span>
      </span>
      <span class="No-Break">
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.1899.1">
         test/app.test.js
        </span>
       </strong>
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1900.1">
        .
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1901.1">
      We must import
     </span>
     <a id="_idIndexMarker498">
     </a>
     <span class="koboSpan" id="kobo.1902.1">
      the new
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1903.1">
       Node.js test
      </span>
     </strong>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.1904.1">
        runner
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1905.1">
       modules:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1906.1">
import { test } from 'node:test';
import { strictEqual, deepStrictEqual, ok } from
  'node:assert';</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.1907.1">
       A complete list of its APIs can be found in the official documentation
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1908.1">
        at
       </span>
      </span>
      <a href="https://nodejs.org/api/test.html">
       <span class="No-Break">
        <span class="koboSpan" id="kobo.1909.1">
         https://nodejs.org/api/test.html
        </span>
       </span>
      </a>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.1910.1">
        .
       </span>
      </span>
     </p>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1911.1">
      We need to import the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.1912.1">
        buildApplication
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1913.1">
       utility:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1914.1">
import { buildApplication } from './helper.js';</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1915.1">
      We need to define a test case using the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1916.1">
       test
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1917.1">
      function.
     </span>
     <span class="koboSpan" id="kobo.1917.2">
      The first parameter is a descriptive string that helps identify which test is currently executing.
     </span>
     <span class="koboSpan" id="kobo.1917.3">
      The second argument is
     </span>
     <a id="_idIndexMarker499">
     </a>
     <span class="koboSpan" id="kobo.1918.1">
      an
     </span>
     <a id="_idIndexMarker500">
     </a>
     <span class="koboSpan" id="kobo.1919.1">
      asynchronous function that takes a test
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1920.1">
       context parameter:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.1921.1">
test('GET /', async function (t) {
  const app = await buildApplication();
  t.after(async function () {
    await app.close();
  });
  const response = await app.inject({
    method: 'GET',
    url: '/'
  });
  strictEqual(response.statusCode, 200);
  deepStrictEqual(response.json(), {
    api: 'fastify-restaurant-api',
    version: 1
  });
});</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1922.1">
      To run the test file, we need to execute
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1923.1">
       this command:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1924.1">$ node --test test/app.test.js</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1925.1">✔</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1926.1"> GET / (56.81025ms)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1927.1">ℹ tests 1</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1928.1">ℹ suites 0</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1929.1">ℹ</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1930.1"> pass 1</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1931.1">ℹ fail 0</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1932.1">ℹ cancelled 0</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1933.1">ℹ skipped 0</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1934.1">ℹ todo 0</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1935.1">ℹ duration_ms 341.573042</span></strong></pre>
    </li>
   </ol>
   <h2 id="_idParaDest-203">
    <a id="_idTextAnchor210">
    </a>
    <span class="koboSpan" id="kobo.1936.1">
     How it works…
    </span>
   </h2>
   <p>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1937.1">
      test/helper.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1938.1">
     exports a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1939.1">
      buildApplication
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1940.1">
     function that instantiates the Fastify root server
    </span>
    <a id="_idIndexMarker501">
    </a>
    <span class="koboSpan" id="kobo.1941.1">
     instance
    </span>
    <a id="_idIndexMarker502">
    </a>
    <span class="koboSpan" id="kobo.1942.1">
     and registers
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1943.1">
      appPlugin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1944.1">
     , as carried out by the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1945.1">
      server.js
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1946.1">
     file.
    </span>
    <span class="koboSpan" id="kobo.1946.2">
     The differences are
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1947.1">
      the following:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.1948.1">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1949.1">
       app
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1950.1">
      constant is just returned, and we do not call the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1951.1">
       listen()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1952.1">
      method.
     </span>
     <span class="koboSpan" id="kobo.1952.2">
      In this way, we are not blocking a
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1953.1">
       host’s port.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1954.1">
      The default server’s options are the same as
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1955.1">
       server.js
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1956.1">
      with the logger turned off.
     </span>
     <span class="koboSpan" id="kobo.1956.2">
      Anyway, we can customize them by providing a second argument to the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1957.1">
       factory function.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1958.1">
      The default environment setup does not read the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1959.1">
       process.env
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1960.1">
      object, but it defines good defaults with which to run the application in every local
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1961.1">
       development environment.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.1962.1">
     As we are running the application, a connection to the database will be established.
    </span>
    <span class="koboSpan" id="kobo.1962.2">
     To ensure the test completes successfully, it’s essential to close the server and database connection after the test has executed all the assertions.
    </span>
    <span class="koboSpan" id="kobo.1962.3">
     This cleanup step is crucial for the proper functioning of subsequent tests and to avoid
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1963.1">
      resource leaks.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1964.1">
     Lastly, we can use Fastify’s
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1965.1">
      app.inject()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1966.1">
     method.
    </span>
    <span class="koboSpan" id="kobo.1966.2">
     Unlike calling the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1967.1">
      listen
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1968.1">
     method, this approach starts the server without actively listening for incoming HTTP requests, enabling faster execution.
    </span>
    <span class="koboSpan" id="kobo.1968.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1969.1">
      inject
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1970.1">
     method then generates a simulated HTTP request and sends it to the server, which processes it in the same way it would a genuine request, producing an HTTP response.
    </span>
    <span class="koboSpan" id="kobo.1970.2">
     This method returns the HTTP response, allowing us to verify its content to validate our expectations.
    </span>
    <span class="koboSpan" id="kobo.1970.3">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1971.1">
      inject
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1972.1">
     method accepts an object parameter for specifying various HTTP request components.
    </span>
    <span class="koboSpan" id="kobo.1972.2">
     We’ll explore more examples in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1973.1">
      There’s more...
     </span>
    </em>
    <span class="koboSpan" id="kobo.1974.1">
     section of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1975.1">
      this recipe.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1976.1">
     At the end of the test case, we assert that the response has the correct status code
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1977.1">
      and payload.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1978.1">
     The test output provides a summary of the entire execution process.
    </span>
    <span class="koboSpan" id="kobo.1978.2">
     In the event of an error, it displays a detailed message indicating the failed assertion.
    </span>
    <span class="koboSpan" id="kobo.1978.3">
     For experimental purposes, you can
    </span>
    <a id="_idIndexMarker503">
    </a>
    <span class="koboSpan" id="kobo.1979.1">
     attempt
    </span>
    <a id="_idIndexMarker504">
    </a>
    <span class="koboSpan" id="kobo.1980.1">
     to break the test by modifying the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1981.1">
      deepStrictEqual
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1982.1">
     check, for instance, by editing the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1983.1">
      version
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1984.1">
     property.
    </span>
    <span class="koboSpan" id="kobo.1984.2">
     This will help you observe how tests respond to changes and failures, allowing you to refine and improve them
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1985.1">
      as needed.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-204">
    <a id="_idTextAnchor211">
    </a>
    <span class="koboSpan" id="kobo.1986.1">
     There’s more...
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1987.1">
     Before wrapping up this recipe, it would be useful to check a more complex test case, so let’s quickly analyze
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1988.1">
      this code:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.1989.1">
test('An unknown user cannot create a recipe', async function (t) {
  const testApiKey = 'test-suite-api-key';
  const app = await buildApplication({
    API_KEY: testApiKey
  });
  t.after(async function () {
    await app.close();
  });
  const pizzaRecipe = { name: 'Pizza', country: 'ITA',
    price: 8, order: 2 };
  const notChefResponse = await app.inject({
    method: 'POST',
    url: '/recipes',
    payload: pizzaRecipe,
    headers: {
      'x-api-key': 'invalid-key'
    }
  });
  strictEqual(notChefResponse.statusCode, 401);
});</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1990.1">
     This new test case examines the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1991.1">
      A unknown user cannot create a recipe
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1992.1">
     condition.
    </span>
    <span class="koboSpan" id="kobo.1992.2">
     In this scenario, we inject a custom API key within the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1993.1">
      buildApplication
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1994.1">
     function and subsequently confirm that if the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1995.1">
      POST /recipes
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1996.1">
     request lacks the valid header, it will be rejected.
    </span>
    <span class="koboSpan" id="kobo.1996.2">
     We saw also that the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1997.1">
      inject
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1998.1">
     method accepts the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1999.1">
      payload
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2000.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.2001.1">
      headers
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2002.1">
     fields to control every
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2003.1">
      request’s aspect.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.2004.1">
     Furthermore, we can
    </span>
    <a id="_idIndexMarker505">
    </a>
    <span class="koboSpan" id="kobo.2005.1">
     enhance
    </span>
    <a id="_idIndexMarker506">
    </a>
    <span class="koboSpan" id="kobo.2006.1">
     the code by introducing an additional test case to ensure that a valid chef can, indeed, create a recipe and that the newly created recipes appear on the menu.
    </span>
    <span class="koboSpan" id="kobo.2006.2">
     This additional test will further validate the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2007.1">
      application’s functionality:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.2008.1">
test('Only a Chef can create a recipe', async function (t) {
  const testApiKey = 'test-suite-api-key';
  const app = await buildApplication({
    API_KEY: testApiKey
  });
  t.after(async function () {
    await app.close();
  });
  const pizzaRecipe = { name: 'Pizza', country: 'ITA',
    price: 8, order: 2 };
  const response = await app.inject({
    method: 'POST',
    url: '/recipes',
    payload: pizzaRecipe,
    headers: {
      'x-api-key': testApiKey
    }
  });
  strictEqual(response.statusCode, 201);
  const recipeId = response.json().id;
  const menu = await app.inject('/menu');
  strictEqual(menu.statusCode, 200);
  const recipes = menu.json();
  const expectedPizza = recipes.find(r =&gt; r.id ===
    recipeId);
  ok(expectedPizza, 'Pizza recipe must be found');
});</span></pre>
   <p>
    <span class="koboSpan" id="kobo.2009.1">
     Note that the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.2010.1">
      app.inject()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2011.1">
     method has a shortcut to run simple
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.2012.1">
      GET
     </span>
    </strong>
    <span class="koboSpan" id="kobo.2013.1">
     requests also.
    </span>
    <span class="koboSpan" id="kobo.2013.2">
     It requires the URL
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2014.1">
      string only.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.2015.1">
     Implementing tests for the application’s routes to cover all use cases is a valuable exercise for becoming proficient with the APIs and the test suite.
    </span>
    <span class="koboSpan" id="kobo.2015.2">
     You now have the fundamental knowledge needed to tackle this task by drawing upon what you’ve learned.
    </span>
    <span class="koboSpan" id="kobo.2015.3">
     Refer to the book’s source code repository for additional code examples and guidance.
    </span>
    <span class="koboSpan" id="kobo.2015.4">
     Good luck, and well done on
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2016.1">
      your progress!
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.2017.1">
     Throughout this chapter, you’ve delved into some of Fastify’s most crucial features, including the plugin system and the wide number of hooks.
    </span>
    <span class="koboSpan" id="kobo.2017.2">
     You’ve also gained insights into the essential aspects of a Fastify application, such as configuration and code reusability.
    </span>
    <span class="koboSpan" id="kobo.2017.3">
     Moreover, your
    </span>
    <a id="_idIndexMarker507">
    </a>
    <span class="koboSpan" id="kobo.2018.1">
     proficiency in working with MongoDB has
    </span>
    <a id="_idIndexMarker508">
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2019.1">
      undoubtedly improved.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.2020.1">
     If you’re enthusiastic about Fastify and eager to explore more, you might find the book
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.2021.1">
      Accelerating Server-Side Development with Fastify
     </span>
    </em>
    <span class="koboSpan" id="kobo.2022.1">
     by
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.2023.1">
      Packt Publishing
     </span>
    </em>
    <span class="koboSpan" id="kobo.2024.1">
     at
    </span>
    <a href="https://www.packtpub.com/product/accelerating-server-side-development-with-fastify/9781800563582">
     <span class="koboSpan" id="kobo.2025.1">
      https://www.packtpub.com/product/accelerating-server-side-development-with-fastify/9781800563582
     </span>
    </a>
    <span class="koboSpan" id="kobo.2026.1">
     to be an invaluable resource for furthering your knowledge and skills in this powerful framework.
    </span>
    <span class="koboSpan" id="kobo.2026.2">
     Keep up the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.2027.1">
      great work!
     </span>
    </span>
   </p>
  </div>
 </body></html>