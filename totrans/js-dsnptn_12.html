<html><head></head><body>
<div id="_idContainer115" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-141"><a id="_idTextAnchor261" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.1.1">9</span></h1>
<h1 id="_idParaDest-142" class="calibre5"><a id="_idTextAnchor262" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.2.1">Maximizing Performance – Lazy Loading and Code Splitting</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.3.1">In order to maximize the performance of a JavaScript application, reducing the amount of unused JavaScript being loaded and interpreted is key. </span><span class="kobospan" id="kobo.3.2">The techniques that can be brought </span><a id="_idIndexMarker507" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.4.1">to bear on this problem are called </span><strong class="bold"><span class="kobospan" id="kobo.5.1">lazy loading</span></strong><span class="kobospan" id="kobo.6.1"> and </span><strong class="bold"><span class="kobospan" id="kobo.7.1">code splitting</span></strong><span class="kobospan" id="kobo.8.1">. </span><span class="kobospan" id="kobo.8.2">Lazy loading and code splitting allows parts of the JavaScript to </span><a id="_idIndexMarker508" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.9.1">be loaded on demand as required. </span><span class="kobospan" id="kobo.9.2">This is in contrast to being downloaded on page load and can greatly reduce the amount of unused JavaScript being loaded </span><span><span class="kobospan" id="kobo.10.1">and interpreted.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.11.1">We’ll cover the following topics in </span><span><span class="kobospan" id="kobo.12.1">this chapter:</span></span></p>
<ul class="calibre10">
<li class="calibre11"><span class="kobospan" id="kobo.13.1">The dynamic import syntax and how Vite can automatically code-split based on </span><span><span class="kobospan" id="kobo.14.1">the syntax</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.15.1">Route-based code splitting with Next.js and how to read the Bundle </span><span><span class="kobospan" id="kobo.16.1">Analyzer reports</span></span></li>
<li class="calibre11"><span class="kobospan" id="kobo.17.1">How to use </span><strong class="source-inline1"><span class="kobospan" id="kobo.18.1">next/dynamic</span></strong><span class="kobospan" id="kobo.19.1"> and </span><strong class="source-inline1"><span class="kobospan" id="kobo.20.1">react-intersection-observer</span></strong><span class="kobospan" id="kobo.21.1"> to load JavaScript and React components on different </span><span><span class="kobospan" id="kobo.22.1">user interactions</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.23.1">By the end of this chapter, you’ll be able to identify and leverage lazy loading and code splitting in a variety of scenarios </span><span><span class="kobospan" id="kobo.24.1">and applications.</span></span></p>
<h1 id="_idParaDest-143" class="calibre5"><a id="_idTextAnchor263" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.25.1">Technical requirements</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.26.1">You can find the code files for this chapter on GitHub </span><span><span class="kobospan" id="kobo.27.1">at </span></span><a href="https://github.com/PacktPublishing/Javascript-Design-Patterns" class="pcalibre1 calibre6 pcalibre"><span><span class="kobospan" id="kobo.28.1">https://github.com/PacktPublishing/Javascript-Design-Patterns</span></span><span id="_idTextAnchor264"/></a></p>
<h1 id="_idParaDest-144" class="calibre5"><a id="_idTextAnchor265" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.29.1">Dynamic imports and code splitting with Vite</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.30.1">Dynamic imports in </span><a id="_idIndexMarker509" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.31.1">JavaScript refer to the usage of the </span><strong class="source-inline"><span class="kobospan" id="kobo.32.1">import()</span></strong><span class="kobospan" id="kobo.33.1"> syntax to import a module. </span><span class="kobospan" id="kobo.33.2">Unlike the </span><strong class="source-inline"><span class="kobospan" id="kobo.34.1">import Something from './my-module.js'</span></strong><span class="kobospan" id="kobo.35.1"> declarative syntax, </span><strong class="source-inline"><span class="kobospan" id="kobo.36.1">import()</span></strong><span class="kobospan" id="kobo.37.1"> is more akin to a function that returns a promise. </span><span class="kobospan" id="kobo.37.2">For example, we could rewrite the original import as </span><strong class="source-inline"><span class="kobospan" id="kobo.38.1">const Something = </span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.39.1">await import('./my-module.js')</span></strong></span><span><span class="kobospan" id="kobo.40.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.41.1">The “dynamic” part of the </span><a id="_idIndexMarker510" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.42.1">import is that it doesn’t have to be </span><a id="_idIndexMarker511" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.43.1">done at module evaluation time; it’s done as part </span><a id="_idIndexMarker512" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.44.1">of the execution of the code. </span><span class="kobospan" id="kobo.44.2">This is useful when </span><a id="_idIndexMarker513" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.45.1">paired with code splitting – which we’ll define now – since it means that we can avoid loading and evaluating some JavaScript code until </span><span><span class="kobospan" id="kobo.46.1">it’s needed.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.47.1">Code splitting is a </span><a id="_idIndexMarker514" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.48.1">technique whereby code is built into multiple files (also known as “chunks” or “bundles”) instead of a single file. </span><span class="kobospan" id="kobo.48.2">Code splitting is useful to avoid loading all the code up front. </span><span class="kobospan" id="kobo.48.3">Instead, when paired with dynamic imports, code is split into multiple files such that different parts of it are loaded only when necessary. </span><span class="kobospan" id="kobo.48.4">This means that there’s a lower up-front cost to the JavaScript load, parse, and </span><span><span class="kobospan" id="kobo.49.1">compile cycle.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.50.1">The Vite build tool supports code splitting at dynamic </span><span><span class="kobospan" id="kobo.51.1">import boundaries.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.52.1">Given a simple document as follows, which has an </span><strong class="source-inline"><span class="kobospan" id="kobo.53.1">id="app"</span></strong> <strong class="source-inline"><span class="kobospan" id="kobo.54.1">div</span></strong><span class="kobospan" id="kobo.55.1"> and references a </span><strong class="source-inline"><span class="kobospan" id="kobo.56.1">main.js</span></strong><span class="kobospan" id="kobo.57.1"> file, Vite can run a build as long as </span><span><strong class="source-inline"><span class="kobospan" id="kobo.58.1">main.js</span></strong></span><span><span class="kobospan" id="kobo.59.1"> exists:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.60.1">
&lt;div id="app"&gt;&lt;/div&gt;
&lt;script src="./main.js" type="module"&gt;&lt;/script&gt;</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.61.1">We’ll have two modules now: </span><strong class="source-inline"><span class="kobospan" id="kobo.62.1">main.js</span></strong><span class="kobospan" id="kobo.63.1">, which is the entry point that Vite will reference, and our code will import the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.64.1">dynamic.js</span></strong></span><span><span class="kobospan" id="kobo.65.1"> module.</span></span></p>
<p class="calibre3"><strong class="source-inline"><span class="kobospan" id="kobo.66.1">main.js</span></strong><span class="kobospan" id="kobo.67.1"> will inject </span><strong class="source-inline"><span class="kobospan" id="kobo.68.1">'Hello from main.js'</span></strong><span class="kobospan" id="kobo.69.1">into our </span><strong class="source-inline"><span class="kobospan" id="kobo.70.1">app</span></strong><span class="kobospan" id="kobo.71.1"> div. </span><span class="kobospan" id="kobo.71.2">It will then proceed to dynamically load the </span><strong class="source-inline"><span class="kobospan" id="kobo.72.1">dynamic.js</span></strong><span class="kobospan" id="kobo.73.1"> module and set the contents of the </span><strong class="source-inline"><span class="kobospan" id="kobo.74.1">app</span></strong><span class="kobospan" id="kobo.75.1"> div to the output of the </span><strong class="source-inline"><span class="kobospan" id="kobo.76.1">hello</span></strong><span class="kobospan" id="kobo.77.1"> function as exported </span><span><span class="kobospan" id="kobo.78.1">by </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.79.1">dynamic.js</span></strong></span><span><span class="kobospan" id="kobo.80.1">:</span></span></p>
<pre class="source-code">
<strong class="source-inline2"><span class="kobospan1" id="kobo.81.1">document.querySelector('#app').textContent = 'Hello from main.js';</span></strong>
<strong class="source-inline2"><span class="kobospan1" id="kobo.82.1">const { hello } = await import('./dynamic.js');</span></strong>
<strong class="source-inline2"><span class="kobospan1" id="kobo.83.1">document.querySelector('#app').textContent = hello();</span></strong></pre> <p class="calibre3"><span class="kobospan" id="kobo.84.1">Here is a simpler </span><strong class="source-inline"><span class="kobospan" id="kobo.85.1">dynamic.js</span></strong><span class="kobospan" id="kobo.86.1"> implementation of the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.87.1">hello</span></strong></span><span><span class="kobospan" id="kobo.88.1"> function:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.89.1">
export function hello() {
  return 'Hello from dynamic.js';
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.90.1">When </span><a id="_idIndexMarker515" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.91.1">running the Vite dev server using </span><strong class="source-inline"><span class="kobospan" id="kobo.92.1">npx vite</span></strong><span class="kobospan" id="kobo.93.1">, we can </span><a id="_idIndexMarker516" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.94.1">see that the dynamically imported </span><strong class="source-inline"><span class="kobospan" id="kobo.95.1">hello</span></strong><span class="kobospan" id="kobo.96.1"> function contents </span><a id="_idIndexMarker517" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.97.1">are displayed on the page. </span><span class="kobospan" id="kobo.97.2">Notice </span><a id="_idIndexMarker518" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.98.1">that </span><strong class="source-inline"><span class="kobospan" id="kobo.99.1">dynamic.js</span></strong><span class="kobospan" id="kobo.100.1"> is loaded as a separate request to </span><strong class="source-inline"><span class="kobospan" id="kobo.101.1">main.js</span></strong><span class="kobospan" id="kobo.102.1">; that is code splitting </span><span><span class="kobospan" id="kobo.103.1">at play.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer100">
<span class="kobospan" id="kobo.104.1"><img alt="Figure 9.1: “Hello from dynamic.js” on the page with network requests, including a request specifically for dynamic.js" src="image/B19109_09_1.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.105.1">Figure 9.1: “Hello from dynamic.js” on the page with network requests, including a request specifically for dynamic.js</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.106.1">This pattern can be useful to defer loading JavaScript until it’s required – for example, if we want to add client-side tracking of button clicks using </span><span><strong class="source-inline"><span class="kobospan" id="kobo.107.1">fetch</span></strong></span><span><span class="kobospan" id="kobo.108.1"> requests.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.109.1">We have the following HTML, with two buttons that have a </span><span><strong class="source-inline"><span class="kobospan" id="kobo.110.1">data-track</span></strong></span><span><span class="kobospan" id="kobo.111.1"> property:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.112.1">
&lt;!-- no change to app div --&gt;
&lt;div&gt;
  &lt;button data-track="button-click"&gt;With tracked click
  &lt;/button&gt;
  &lt;button data-track="alt-button-click"&gt;Other tracked click
  &lt;/button&gt;
&lt;/div&gt;
&lt;!-- to change to script --&gt;</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.113.1">We’ll </span><a id="_idIndexMarker519" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.114.1">add a </span><strong class="source-inline"><span class="kobospan" id="kobo.115.1">trackInteraction.js</span></strong><span class="kobospan" id="kobo.116.1"> module </span><a id="_idIndexMarker520" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.117.1">with a </span><strong class="source-inline"><span class="kobospan" id="kobo.118.1">trackInteraction</span></strong><span class="kobospan" id="kobo.119.1"> function, which </span><a id="_idIndexMarker521" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.120.1">will use </span><strong class="source-inline"><span class="kobospan" id="kobo.121.1">fetch</span></strong><span class="kobospan" id="kobo.122.1"> and the </span><strong class="source-inline"><span class="kobospan" id="kobo.123.1">POST</span></strong><span class="kobospan" id="kobo.124.1"> HTTP method to send </span><a id="_idIndexMarker522" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.125.1">interaction data to </span><strong class="source-inline"><span class="kobospan" id="kobo.126.1">jsonplaceholder</span></strong><span class="kobospan" id="kobo.127.1">. </span><span class="kobospan" id="kobo.127.2">If this were a live implementation, we could realistically replace </span><strong class="source-inline"><span class="kobospan" id="kobo.128.1">jsonplaceholder</span></strong><span class="kobospan" id="kobo.129.1"> with Google Analytics or another equivalent service that exposes a client-side JavaScript </span><span><span class="kobospan" id="kobo.130.1">accessible endpoint:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.131.1">
export function trackInteraction(page, type = 'click') {
  return fetch
    ('https://jsonplaceholder.typicode.com/posts', {
    method: 'POST',
    body: JSON.stringify({
      type,
      page,
    }),
    headers: {
      'Content-type': 'application/json; charset=UTF-8',
    },
  }).then((response) =&gt; response.json());
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.132.1">Now, the </span><strong class="source-inline"><span class="kobospan" id="kobo.133.1">trackInteraction</span></strong><span class="kobospan" id="kobo.134.1"> module has nothing to do with the page functionality so we want to avoid loading it until </span><span><span class="kobospan" id="kobo.135.1">it’s needed.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.136.1">In this case, we’ll attach a click event listener to each element that has a </span><strong class="source-inline"><span class="kobospan" id="kobo.137.1">data-track</span></strong><span class="kobospan" id="kobo.138.1"> attribute. </span><span class="kobospan" id="kobo.138.2">Only when the listener is triggered does the </span><strong class="source-inline"><span class="kobospan" id="kobo.139.1">import('./trackInteraction.js')</span></strong> <span><span class="kobospan" id="kobo.140.1">statement run:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.141.1">
// no change to rest of main.js
document.querySelectorAll('[data-track]').forEach((el) =&gt; {
  el.addEventListener('click', async (event) =&gt; {
    const page = window.location.pathname;
    const type = event.target.dataset?.track;
    const { trackInteraction } = await import
      ('./trackInteraction.js');
    const interactionResponse = await trackInteraction
      (page, type);
    console.assert(
      interactionResponse.type === type &amp;&amp;
        interactionResponse.page === page,
      'interaction response does not match sent data',
    );
  });
});</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.142.1">If we </span><a id="_idIndexMarker523" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.143.1">load the Vite dev server and click the </span><strong class="bold"><span class="kobospan" id="kobo.144.1">With tracked click</span></strong><span class="kobospan" id="kobo.145.1"> button </span><a id="_idIndexMarker524" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.146.1">and the </span><strong class="bold"><span class="kobospan" id="kobo.147.1">Other tracked click</span></strong><span class="kobospan" id="kobo.148.1"> button </span><a id="_idIndexMarker525" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.149.1">once and then the </span><strong class="bold"><span class="kobospan" id="kobo.150.1">With tracked click</span></strong><span class="kobospan" id="kobo.151.1"> button </span><a id="_idIndexMarker526" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.152.1">once again, we’ll get the following </span><span><span class="kobospan" id="kobo.153.1">network requests:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer101">
<span class="kobospan" id="kobo.154.1"><img alt="Figure 9.2: Network requests after clicking the “With tracked click,” “Other tracked click,” and “With tracked click” buttons in sequence" src="image/B19109_09_2.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.155.1">Figure 9.2: Network requests after clicking the “With tracked click,” “Other tracked click,” and “With tracked click” buttons in sequence</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.156.1">On the </span><a id="_idIndexMarker527" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.157.1">first click of either button, the </span><strong class="source-inline"><span class="kobospan" id="kobo.158.1">trackInteraction.js</span></strong><span class="kobospan" id="kobo.159.1"> file is loaded and then a </span><strong class="source-inline"><span class="kobospan" id="kobo.160.1">fetch</span></strong><span class="kobospan" id="kobo.161.1"> request is triggered. </span><span class="kobospan" id="kobo.161.2">On subsequent clicks, </span><strong class="source-inline"><span class="kobospan" id="kobo.162.1">trackInteraction.js</span></strong><span class="kobospan" id="kobo.163.1"> is already loaded so the </span><strong class="source-inline"><span class="kobospan" id="kobo.164.1">fetch</span></strong><span class="kobospan" id="kobo.165.1"> requests to </span><strong class="source-inline"><span class="kobospan" id="kobo.166.1">jsonplaceholder</span></strong><span class="kobospan" id="kobo.167.1"> are the only network requests </span><span><span class="kobospan" id="kobo.168.1">we see.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.169.1">Note </span><a id="_idIndexMarker528" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.170.1">that each </span><strong class="source-inline"><span class="kobospan" id="kobo.171.1">POST</span></strong><span class="kobospan" id="kobo.172.1"> request to </span><strong class="source-inline"><span class="kobospan" id="kobo.173.1">jsonplaceholder</span></strong><span class="kobospan" id="kobo.174.1"> is preceded by an </span><strong class="source-inline"><span class="kobospan" id="kobo.175.1">OPTIONS</span></strong><span class="kobospan" id="kobo.176.1"> request due to browser </span><strong class="bold"><span class="kobospan" id="kobo.177.1">cross-origin resource sharing</span></strong><span class="kobospan" id="kobo.178.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.179.1">CORS</span></strong><span class="kobospan" id="kobo.180.1">). </span><span class="kobospan" id="kobo.180.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.181.1">OPTIONS</span></strong><span class="kobospan" id="kobo.182.1"> response includes </span><strong class="source-inline"><span class="kobospan" id="kobo.183.1">Access-Control-Allow-…</span></strong><span class="kobospan" id="kobo.184.1"> headers that allow our origin </span><span><span class="kobospan" id="kobo.185.1">and method.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.186.1">We’ve now </span><a id="_idIndexMarker529" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.187.1">seen what dynamic imports in JavaScript look like and how Vite automatically code splits dynamic imports, which </span><a id="_idIndexMarker530" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.188.1">allows us to only load modules that are required “just in time,” thereby </span><a id="_idIndexMarker531" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.189.1">allowing us to reduce the upfront JavaScript </span><span><span class="kobospan" id="kobo.190.1">load/parse/evaluation cost.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.191.1">Next, we’ll cover route-based code splitting in Next.js and how to inspect generated chunks with the Next.js B</span><a id="_idTextAnchor266" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.192.1">undle </span><span><span class="kobospan" id="kobo.193.1">Analyzer plugin.</span></span></p>
<h1 id="_idParaDest-145" class="calibre5"><a id="_idTextAnchor267" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.194.1">Route-based code splitting and bundling</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.195.1">Let’s </span><a id="_idIndexMarker532" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.196.1">begin by defining a </span><strong class="bold"><span class="kobospan" id="kobo.197.1">route</span></strong><span class="kobospan" id="kobo.198.1"> in a general web application </span><a id="_idIndexMarker533" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.199.1">context and then in a </span><span><span class="kobospan" id="kobo.200.1">Next.js context.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.201.1">In a web application, a route comes from the </span><strong class="bold"><span class="kobospan" id="kobo.202.1">router</span></strong><span class="kobospan" id="kobo.203.1"> concept; in simple terms, it’s an entry in the router. </span><span class="kobospan" id="kobo.203.2">An entry in the router mechanism can take multiple shapes – for example, in an nginx/Apache/Caddy web server setup, we can have a path to file forwarding or a wildcard forwarding approach. </span><span class="kobospan" id="kobo.203.3">In backend MVC frameworks such as Ruby on Rails, Laravel (PHP), and Django (Python), a route associates a request path to the specific code to be run. </span><span class="kobospan" id="kobo.203.4">The </span><em class="italic"><span class="kobospan" id="kobo.204.1">request path to code to be run</span></em><span class="kobospan" id="kobo.205.1"> concept also applies to Node.js backend applications using libraries such as Express, Koa, Fastify, </span><span><span class="kobospan" id="kobo.206.1">and Adonis.js.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.207.1">Let’s now </span><a id="_idIndexMarker534" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.208.1">see how the </span><em class="italic"><span class="kobospan" id="kobo.209.1">route</span></em><span class="kobospan" id="kobo.210.1"> concept is used in the Next.js </span><span><span class="kobospan" id="kobo.211.1">filesystem router.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.212.1">A minimal </span><a id="_idIndexMarker535" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.213.1">Next.js project as initialized with </span><strong class="source-inline"><span class="kobospan" id="kobo.214.1">create-next-app</span></strong><span class="kobospan" id="kobo.215.1"> is laid out as follows. </span><span class="kobospan" id="kobo.215.2">Each file in the </span><strong class="source-inline"><span class="kobospan" id="kobo.216.1">pages</span></strong><span class="kobospan" id="kobo.217.1"> directory corresponds </span><a id="_idIndexMarker536" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.218.1">to a route. </span><span class="kobospan" id="kobo.218.2">For example, </span><strong class="source-inline"><span class="kobospan" id="kobo.219.1">index.js</span></strong><span class="kobospan" id="kobo.220.1"> is used to render the </span><strong class="source-inline"><span class="kobospan" id="kobo.221.1">/</span></strong><span class="kobospan" id="kobo.222.1"> path of the application. </span><span class="kobospan" id="kobo.222.2">If we had an </span><strong class="source-inline"><span class="kobospan" id="kobo.223.1">about.js</span></strong><span class="kobospan" id="kobo.224.1"> or </span><strong class="source-inline"><span class="kobospan" id="kobo.225.1">about/index.js</span></strong><span class="kobospan" id="kobo.226.1"> file, that would be used to render the </span><strong class="source-inline"><span class="kobospan" id="kobo.227.1">/about</span></strong><span class="kobospan" id="kobo.228.1"> path of </span><span><span class="kobospan" id="kobo.229.1">the application:</span></span></p>
<pre class="console"><span class="kobospan1" id="kobo.230.1">
.
</span><span class="kobospan1" id="kobo.230.2">├── components
├── next.config.js
├── package.json
├── pages
│   └── index.js
└── public</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.231.1">We defined code splitting in the previous section, </span><em class="italic"><span class="kobospan" id="kobo.232.1">Dynamic imports and code splitting with Vite</span></em><span class="kobospan" id="kobo.233.1">. </span><span class="kobospan" id="kobo.233.2">Since a core Next.js feature is the router, it can do what’s called </span><strong class="bold"><span class="kobospan" id="kobo.234.1">route-based code splitting</span></strong><span class="kobospan" id="kobo.235.1">, which is automatic code splitting based on a route or </span><span><span class="kobospan" id="kobo.236.1">page contents.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.237.1">A naive route-based code-splitting approach would be to create completely separate sets of bundles for each route. </span><span class="kobospan" id="kobo.237.2">In the context of a React or Next.js application, this is inefficient since we would end up with shared libraries (for example, React and Next.js) in each of the </span><span><span class="kobospan" id="kobo.238.1">per-page bundles.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.239.1">What Next.js can do in this case is identify shared code and classify it as </span><strong class="source-inline"><span class="kobospan" id="kobo.240.1">First Load JS shared </span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.241.1">by all</span></strong></span><span><span class="kobospan" id="kobo.242.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.243.1">This is the sample </span><span><span class="kobospan" id="kobo.244.1">build output:</span></span></p>
<pre class="console"><span class="kobospan1" id="kobo.245.1">
+ First Load JS shared by all              79.9 kB
  ├ chunks/framework-cc1b0d6c55d15cb9.js   45.3 kB
  ├ chunks/main-7c6ad51e94ec3ff5.js        32.8 kB
  ├ chunks/pages/_app-db3a4be757903450.js  205 B
  └ chunks/webpack-8850afd7843acaaa.js     1.55 kB</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.246.1">We can </span><a id="_idIndexMarker537" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.247.1">add the Next.js Bundle Analyzer to check the contents of </span><span><span class="kobospan" id="kobo.248.1">each chunk:</span></span></p>
<pre class="console"><span class="kobospan1" id="kobo.249.1">
npm install --save @next/bundle-analyzer</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.250.1">Then, we can </span><a id="_idIndexMarker538" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.251.1">configure </span><strong class="source-inline"><span class="kobospan" id="kobo.252.1">next.config.js</span></strong><span class="kobospan" id="kobo.253.1"> to use it. </span><span class="kobospan" id="kobo.253.2">In our case, it looks </span><span><span class="kobospan" id="kobo.254.1">as follows:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.255.1">
const nextConfig = {
  // no changes to this config
};
const withBundleAnalyzer = require('@next/bundle-analyzer')({
  enabled: process.env.ANALYZE === 'true',
});
module.exports = withBundleAnalyzer(nextConfig);</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.256.1">To use the bundle analyzer, we can add an </span><strong class="source-inline"><span class="kobospan" id="kobo.257.1">analyze</span></strong><span class="kobospan" id="kobo.258.1"> script to our </span><span><strong class="source-inline"><span class="kobospan" id="kobo.259.1">package.json file</span></strong></span><span><span class="kobospan" id="kobo.260.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.261.1">
{
  "//": "// no change to other properties",
  "scripts": {
    "//": "// no change to other scripts",
    "analyze": "cross-env ANALYZE=true next build"
  }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.262.1">This can </span><a id="_idIndexMarker539" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.263.1">be run with </span><strong class="source-inline"><span class="kobospan" id="kobo.264.1">npm run analyze</span></strong><span class="kobospan" id="kobo.265.1">. </span><span class="kobospan" id="kobo.265.2">Its shell </span><a id="_idIndexMarker540" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.266.1">output is the same as </span><strong class="source-inline"><span class="kobospan" id="kobo.267.1">npm run build</span></strong><span class="kobospan" id="kobo.268.1"> but it opens a browser window with the bundle analysis file – for </span><span><span class="kobospan" id="kobo.269.1">example, </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.270.1">.next/analyze/client.html</span></strong></span><span><span class="kobospan" id="kobo.271.1">:</span></span></p>
<pre class="console"><span class="kobospan1" id="kobo.272.1">
npm run analyze
&gt; next-route-based-splitting@0.1.0 analyze
&gt; cross-env ANALYZE=true next build
 ✓ Linting and checking validity of types
Webpack Bundle Analyzer saved report to /next-route-based-splitting/.next/analyze/nodejs.html
No bundles were parsed. </span><span class="kobospan1" id="kobo.272.2">Analyzer will show only original module sizes from stats file.
</span><span class="kobospan1" id="kobo.272.3">Webpack Bundle Analyzer saved report to /next-route-based-splitting/.next/analyze/edge.html
Webpack Bundle Analyzer saved report to /next-route-based-splitting/.next/analyze/client.html
 ✓ Creating an optimized production build
 ✓ Compiled successfully
 ✓ Collecting page data
 ✓ Generating static pages (3/3)
 ✓ Collecting build traces
 ✓ Finalizing page optimization</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.273.1">We can </span><a id="_idIndexMarker541" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.274.1">use this to inspect the contents of the </span><strong class="source-inline"><span class="kobospan" id="kobo.275.1">shared</span></strong><span class="kobospan" id="kobo.276.1"> JavaScript </span><a id="_idIndexMarker542" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.277.1">in the </span><strong class="source-inline"><span class="kobospan" id="kobo.278.1">framework</span></strong><span class="kobospan" id="kobo.279.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.280.1">main</span></strong><span class="kobospan" id="kobo.281.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.282.1">pages/_app</span></strong><span class="kobospan" id="kobo.283.1">, and </span><strong class="source-inline"><span class="kobospan" id="kobo.284.1">webpack</span></strong><span class="kobospan" id="kobo.285.1"> chunks as well as </span><span><span class="kobospan" id="kobo.286.1">page-specific chunks:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer102">
<span class="kobospan" id="kobo.287.1"><img alt="Figure 9.3: The client.html Bundle Analyzer output in the browser" src="image/B19109_09_3.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.288.1">Figure 9.3: The client.html Bundle Analyzer output in the browser</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.289.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.290.1">framework</span></strong><span class="kobospan" id="kobo.291.1"> bundle includes the following packages from </span><strong class="source-inline"><span class="kobospan" id="kobo.292.1">node_modules</span></strong><span class="kobospan" id="kobo.293.1">: </span><strong class="source-inline"><span class="kobospan" id="kobo.294.1">react</span></strong><span class="kobospan" id="kobo.295.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.296.1">react-dom</span></strong><span class="kobospan" id="kobo.297.1">, and </span><strong class="source-inline"><span class="kobospan" id="kobo.298.1">scheduler</span></strong><span class="kobospan" id="kobo.299.1">. </span><span class="kobospan" id="kobo.299.2">Meanwhile, the </span><strong class="source-inline"><span class="kobospan" id="kobo.300.1">main</span></strong><span class="kobospan" id="kobo.301.1"> bundle includes </span><strong class="source-inline"><span class="kobospan" id="kobo.302.1">next</span></strong><span class="kobospan" id="kobo.303.1"> and its submodules such as </span><strong class="source-inline"><span class="kobospan" id="kobo.304.1">shared/lib</span></strong><span class="kobospan" id="kobo.305.1">, which includes a large </span><strong class="source-inline"><span class="kobospan" id="kobo.306.1">router</span></strong><span class="kobospan" id="kobo.307.1"> chunk, or </span><strong class="source-inline"><span class="kobospan" id="kobo.308.1">next/client</span></strong><span class="kobospan" id="kobo.309.1">, which is the client-side section of Next.js. </span><span class="kobospan" id="kobo.309.2">Also, it is harder to see in the preceding screenshot, but </span><strong class="source-inline"><span class="kobospan" id="kobo.310.1">main</span></strong><span class="kobospan" id="kobo.311.1"> includes </span><strong class="source-inline"><span class="kobospan" id="kobo.312.1">@swc/helpers/esm</span></strong><span class="kobospan" id="kobo.313.1">, which is probably an artifact of the Next.js build using the </span><span><span class="kobospan" id="kobo.314.1">SWC compiler.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.315.1">We’ve now </span><a id="_idIndexMarker543" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.316.1">seen how Next.js supports route-based </span><a id="_idIndexMarker544" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.317.1">code splitting and how to inspect the contents of the Next.js-generated bundles using the Next.js Bundle Analyzer report. </span><span class="kobospan" id="kobo.317.2">Next, we’ll see dynamic import patterns to load additional JavaScript under different element visi</span><a id="_idTextAnchor268" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.318.1">bility and </span><span><span class="kobospan" id="kobo.319.1">interaction conditions.</span></span></p>
<h1 id="_idParaDest-146" class="calibre5"><a id="_idTextAnchor269" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.320.1">Loading JavaScript on element visibility and interaction</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.321.1">In this section, we’ll look at four different scenarios where dynamic or lazy loading of React </span><a id="_idIndexMarker545" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.322.1">components and JavaScript modules can be applied in the context of a </span><span><span class="kobospan" id="kobo.323.1">Next.js application.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.324.1">The first </span><a id="_idIndexMarker546" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.325.1">instance will be whether the component is in the component tree or not – in other words, whether it’s considered to be rendered or not. </span><span class="kobospan" id="kobo.325.2">Next, we’ll look at dynamic imports based on user interaction. </span><span class="kobospan" id="kobo.325.3">We’ll also cover how to handle an interaction that potentially requires a dynamic import of a JavaScript resource. </span><span class="kobospan" id="kobo.325.4">Finally, we’ll show how to dynamically load a React component when an element is visible in </span><span><span class="kobospan" id="kobo.326.1">the viewport.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.327.1">Next.js provides a </span><strong class="source-inline"><span class="kobospan" id="kobo.328.1">dynamic</span></strong><span class="kobospan" id="kobo.329.1"> utility (see the documentation at </span><a href="https://nextjs.org/docs/pages/building-your-application/optimizing/lazy-loading" class="pcalibre1 calibre6 pcalibre"><span class="kobospan" id="kobo.330.1">https://nextjs.org/docs/pages/building-your-application/optimizing/lazy-loading</span></a><span class="kobospan" id="kobo.331.1">) that allows us to lazily and dynamically load a </span><span><span class="kobospan" id="kobo.332.1">React component.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.333.1">In our case, we have a </span><strong class="source-inline"><span class="kobospan" id="kobo.334.1">components/Hello.jsx</span></strong><span class="kobospan" id="kobo.335.1"> component with a </span><strong class="source-inline"><span class="kobospan" id="kobo.336.1">Hello</span></strong><span class="kobospan" id="kobo.337.1"> component that is a </span><span><span class="kobospan" id="kobo.338.1">named export:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.339.1">
import React from 'react';
export function Hello() {
  return &lt;&gt;Hello&lt;/&gt;;
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.340.1">We can dynamically load it using </span><strong class="source-inline"><span class="kobospan" id="kobo.341.1">dynamic()</span></strong><span class="kobospan" id="kobo.342.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.343.1">import()</span></strong><span class="kobospan" id="kobo.344.1">. </span><span class="kobospan" id="kobo.344.2">Due to </span><strong class="source-inline"><span class="kobospan" id="kobo.345.1">Hello</span></strong><span class="kobospan" id="kobo.346.1"> being a named export, we need to extract the </span><strong class="source-inline"><span class="kobospan" id="kobo.347.1">Hello</span></strong><span class="kobospan" id="kobo.348.1"> property of the </span><strong class="source-inline"><span class="kobospan" id="kobo.349.1">import()</span></strong><span class="kobospan" id="kobo.350.1"> promise using </span><strong class="source-inline"><span class="kobospan" id="kobo.351.1">.then()</span></strong><span class="kobospan" id="kobo.352.1">. </span><span class="kobospan" id="kobo.352.2">We set </span><strong class="source-inline"><span class="kobospan" id="kobo.353.1">ssr: false</span></strong><span class="kobospan" id="kobo.354.1"> to showcase how </span><strong class="source-inline"><span class="kobospan" id="kobo.355.1">next/dynamic</span></strong><span class="kobospan" id="kobo.356.1"> allows us to control </span><a id="_idIndexMarker547" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.357.1">whether a dynamically loaded </span><a id="_idIndexMarker548" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.358.1">component is included in the server-rendered output </span><span><span class="kobospan" id="kobo.359.1">or not:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.360.1">
import React from 'react';
import dynamic from 'next/dynamic';
const DynamicClientSideHello = dynamic(
  () =&gt; import('../components/Hello.jsx').then(({ Hello })
    =&gt; Hello),
  { ssr: false },
);
export default function Index() {
  return (
    &lt;&gt;
      &lt;h1&gt;Next.js route-based splitting and component lazy
        loading&lt;/h1&gt;
      &lt;DynamicClientSideHello /&gt;
    &lt;/&gt;
  );
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.361.1">By using </span><strong class="source-inline"><span class="kobospan" id="kobo.362.1">npm run analyze</span></strong><span class="kobospan" id="kobo.363.1"> as configured in the </span><em class="italic"><span class="kobospan" id="kobo.364.1">Route-based code splitting and bundling</span></em><span class="kobospan" id="kobo.365.1"> section (using the </span><strong class="source-inline"><span class="kobospan" id="kobo.366.1">@next/bundle-analyzer</span></strong><span class="kobospan" id="kobo.367.1"> module), we can inspect the contents of the </span><strong class="source-inline"><span class="kobospan" id="kobo.368.1">chunks/pages/index</span></strong><span class="kobospan" id="kobo.369.1"> chunk; you’ll note that </span><strong class="source-inline"><span class="kobospan" id="kobo.370.1">Hello.jsx</span></strong><span class="kobospan" id="kobo.371.1"> is in a </span><span><span class="kobospan" id="kobo.372.1">different chunk.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer103">
<span class="kobospan" id="kobo.373.1"><img alt="Figure 9.4: Bundle analyzer filtered to “chunks/pages/index” and the chunk containing Hello.jsx" src="image/B19109_09_4.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.374.1">Figure 9.4: Bundle analyzer filtered to “chunks/pages/index” and the chunk containing Hello.jsx</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.375.1">When we </span><a id="_idIndexMarker549" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.376.1">run the Next.js dev server using </span><strong class="source-inline"><span class="kobospan" id="kobo.377.1">next dev</span></strong><span class="kobospan" id="kobo.378.1"> and load </span><a id="_idIndexMarker550" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.379.1">up the </span><strong class="source-inline"><span class="kobospan" id="kobo.380.1">/</span></strong><span class="kobospan" id="kobo.381.1"> path, we see the following page and network requests. </span><strong class="source-inline"><span class="kobospan" id="kobo.382.1">_next/static/chunks/components_Hello_jsx.js</span></strong><span class="kobospan" id="kobo.383.1"> is loaded last and separately to </span><strong class="source-inline"><span class="kobospan" id="kobo.384.1">_next/static/chunks/pages/index.js</span></strong><span class="kobospan" id="kobo.385.1">, which means that we are in fact doing a dynamic load of the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.386.1">Hello.jsx</span></strong></span><span><span class="kobospan" id="kobo.387.1"> component.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer104">
<span class="kobospan" id="kobo.388.1"><img alt="Figure 9.5: Dynamic loading of the Hello.jsx page contents and Network tab" src="image/B19109_09_5.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.389.1">Figure 9.5: Dynamic loading of the Hello.jsx page contents and Network tab</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.390.1">We’ll now </span><a id="_idIndexMarker551" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.391.1">showcase using </span><strong class="source-inline"><span class="kobospan" id="kobo.392.1">next/dynamic</span></strong><span class="kobospan" id="kobo.393.1"> inside of the </span><strong class="source-inline"><span class="kobospan" id="kobo.394.1">Index</span></strong><span class="kobospan" id="kobo.395.1"> component based on the </span><span><span class="kobospan" id="kobo.396.1">component state.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.397.1">Our example is a </span><em class="italic"><span class="kobospan" id="kobo.398.1">Terms and Conditions</span></em><span class="kobospan" id="kobo.399.1"> selector that allows the user to select between </span><a id="_idIndexMarker552" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.400.1">three options: </span><strong class="bold"><span class="kobospan" id="kobo.401.1">None</span></strong><span class="kobospan" id="kobo.402.1">, </span><strong class="bold"><span class="kobospan" id="kobo.403.1">Short</span></strong><span class="kobospan" id="kobo.404.1">, and </span><strong class="bold"><span class="kobospan" id="kobo.405.1">Long</span></strong><span class="kobospan" id="kobo.406.1">. </span><strong class="bold"><span class="kobospan" id="kobo.407.1">None</span></strong><span class="kobospan" id="kobo.408.1"> will be handled by a </span><strong class="source-inline"><span class="kobospan" id="kobo.409.1">NoRender</span></strong><span class="kobospan" id="kobo.410.1"> component (which simply returns </span><strong class="source-inline"><span class="kobospan" id="kobo.411.1">null</span></strong><span class="kobospan" id="kobo.412.1">), and </span><strong class="bold"><span class="kobospan" id="kobo.413.1">Short</span></strong><span class="kobospan" id="kobo.414.1"> and </span><strong class="bold"><span class="kobospan" id="kobo.415.1">Long</span></strong><span class="kobospan" id="kobo.416.1"> will dynamically load a component </span><span><span class="kobospan" id="kobo.417.1">to display.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.418.1">We’ll start by adding a </span><strong class="source-inline"><span class="kobospan" id="kobo.419.1">components/TermsAndConditionsShort.jsx</span></strong><span class="kobospan" id="kobo.420.1"> component, which contains an </span><strong class="source-inline"><span class="kobospan" id="kobo.421.1">h3</span></strong><span class="kobospan" id="kobo.422.1"> element and a single paragraph </span><span><span class="kobospan" id="kobo.423.1">of content:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.424.1">
import React from 'react';
export function TermsAndConditions() {
  return (
    &lt;&gt;
      &lt;h3&gt;Terms and Conditions Short&lt;/h3&gt;
      &lt;p&gt;{/* Terms and Conditions Content */}&lt;/p&gt;
    &lt;/&gt;
  );
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.425.1">We’ll </span><a id="_idIndexMarker553" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.426.1">also add a </span><strong class="source-inline"><span class="kobospan" id="kobo.427.1">components/TermsAndConditionsLong.jsx</span></strong><span class="kobospan" id="kobo.428.1"> component, which contains the same </span><strong class="source-inline"><span class="kobospan" id="kobo.429.1">h3</span></strong><span class="kobospan" id="kobo.430.1"> and content </span><a id="_idIndexMarker554" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.431.1">but has five paragraphs of content instead </span><span><span class="kobospan" id="kobo.432.1">of one:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.433.1">
import React from 'react';
export function TermsAndConditions() {
  return (
    &lt;&gt;
      &lt;h3&gt;Terms and Conditions Long&lt;/h3&gt;
      &lt;p&gt;{/* Terms and Conditions Content */}&lt;/p&gt;
      &lt;p&gt;{/* Terms and Conditions Content */}&lt;/p&gt;
      &lt;p&gt;{/* Terms and Conditions Content */}&lt;/p&gt;
      &lt;p&gt;{/* Terms and Conditions Content */}&lt;/p&gt;
      &lt;p&gt;{/* Terms and Conditions Content */}&lt;/p&gt;
    &lt;/&gt;
  );
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.434.1">Finally, we’ll add a </span><strong class="source-inline"><span class="kobospan" id="kobo.435.1">select</span></strong><span class="kobospan" id="kobo.436.1"> field with relevant </span><strong class="source-inline"><span class="kobospan" id="kobo.437.1">option</span></strong><span class="kobospan" id="kobo.438.1"> values (</span><strong class="source-inline"><span class="kobospan" id="kobo.439.1">None</span></strong><span class="kobospan" id="kobo.440.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.441.1">Short</span></strong><span class="kobospan" id="kobo.442.1">, and </span><strong class="source-inline"><span class="kobospan" id="kobo.443.1">Long</span></strong><span class="kobospan" id="kobo.444.1">) to </span><strong class="source-inline"><span class="kobospan" id="kobo.445.1">pages/index.js</span></strong><span class="kobospan" id="kobo.446.1">. </span><span class="kobospan" id="kobo.446.2">We’ll use </span><strong class="source-inline"><span class="kobospan" id="kobo.447.1">useState</span></strong><span class="kobospan" id="kobo.448.1"> to keep track of the currently </span><span><span class="kobospan" id="kobo.449.1">selected option:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.450.1">
import React, { useState } from 'react';
export default function Index() {
  const [selectedTermsAndConditions,
    setSelectedTermsAndConditions] =
    useState('None');
  return (
    &lt;&gt;
      {/* no changes to rest of the returned JSX */}
      &lt;div&gt;
        &lt;label htmlFor="termsAndConditionsType"&gt;
          Terms and Conditions selector:
        &lt;/label&gt;
        &lt;select
          id="termsAndConditionsType"
          onChange={(e) =&gt; setSelectedTermsAndConditions
            (e.target.value)}
        &gt;
          &lt;option value="None"&gt;None&lt;/option&gt;
          &lt;option value="Short"&gt;Short&lt;/option&gt;
          &lt;option value="Long"&gt;Long&lt;/option&gt;
        &lt;/select&gt;
      &lt;/div&gt;
    &lt;/&gt;
  );
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.451.1">Finally, we’ll </span><a id="_idIndexMarker555" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.452.1">add a </span><strong class="source-inline"><span class="kobospan" id="kobo.453.1">NoRender</span></strong><span class="kobospan" id="kobo.454.1"> component and, based </span><a id="_idIndexMarker556" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.455.1">on </span><strong class="source-inline"><span class="kobospan" id="kobo.456.1">selectedTermsAndConditions</span></strong><span class="kobospan" id="kobo.457.1">, either render </span><strong class="source-inline"><span class="kobospan" id="kobo.458.1">NoRender</span></strong><span class="kobospan" id="kobo.459.1"> or the dynamically loaded </span><span><strong class="source-inline"><span class="kobospan" id="kobo.460.1">TermsAndConditions</span></strong></span><span><span class="kobospan" id="kobo.461.1"> component:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.462.1">
import React, { useState } from 'react';
const NoRender = () =&gt; null;
export default function Index() {
  // no change to useState
  const TermsAndConditions = ['Short', 'Long'].includes(
    selectedTermsAndConditions,
  )
    ? </span><span class="kobospan1" id="kobo.462.2">dynamic(() =&gt;
        import(
          `../components/TermsAndConditions$
            {selectedTermsAndConditions}.jsx`
        ).then(({ TermsAndConditions }) =&gt;
          TermsAndConditions),
      )
    : NoRender;
  return (
    &lt;&gt;
      {/* no changes to rest of the returned JSX */}
      &lt;div&gt;
        {/* no change to label or select */}
        &lt;hr /&gt;
        &lt;TermsAndConditions /&gt;
      &lt;/div&gt;
    &lt;/&gt;
  );
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.463.1">When we </span><a id="_idIndexMarker557" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.464.1">run the next dev server and load </span><a id="_idIndexMarker558" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.465.1">the index page, we initially see the </span><strong class="bold"><span class="kobospan" id="kobo.466.1">None</span></strong><span class="kobospan" id="kobo.467.1"> state selected and no dynamic imports, apart from the existing </span><strong class="source-inline"><span class="kobospan" id="kobo.468.1">Hello.jsx</span></strong><span class="kobospan" id="kobo.469.1"> one from the </span><span><span class="kobospan" id="kobo.470.1">previous example.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer105">
<span class="kobospan" id="kobo.471.1"><img alt="Figure 9.6: Terms and conditions selector initial state with None selected; therefore, no dynamic imports apart from the existing Hello.jsx one" src="image/B19109_09_6.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.472.1">Figure 9.6: Terms and conditions selector initial state with None selected; therefore, no dynamic imports apart from the existing Hello.jsx one</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.473.1">On selection of </span><strong class="bold"><span class="kobospan" id="kobo.474.1">Short</span></strong><span class="kobospan" id="kobo.475.1">, we note that the relevant heading and paragraph are displayed and we have an additional request that </span><span><span class="kobospan" id="kobo.476.1">loaded </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.477.1">_next/static/chunks/components_TermsAndConditionsShort_jsx.js</span></strong></span><span><span class="kobospan" id="kobo.478.1">.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer106">
<span class="kobospan" id="kobo.479.1"><img alt="Figure 9.7: Terms and conditions selector when Short is selected; TermsAndConditionsShort.jsx has been dynamically loaded and is displayed" src="image/B19109_09_7.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.480.1">Figure 9.7: Terms and conditions selector when Short is selected; TermsAndConditionsShort.jsx has been dynamically loaded and is displayed</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.481.1">When we </span><a id="_idIndexMarker559" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.482.1">select </span><strong class="bold"><span class="kobospan" id="kobo.483.1">Long</span></strong><span class="kobospan" id="kobo.484.1">, we note that the </span><a id="_idIndexMarker560" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.485.1">relevant heading and paragraph are displayed and we have an additional request that </span><span><span class="kobospan" id="kobo.486.1">loaded </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.487.1">/_next/static/chunks/components_TermsAndConditionsLong_jsx.js</span></strong></span><span><span class="kobospan" id="kobo.488.1">.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer107">
<span class="kobospan" id="kobo.489.1"><img alt="Figure 9.8: Terms and conditions selector when Long is selected; TermsAndConditionsLong.jsx has been dynamically loaded and is displayed" src="image/B19109_09_8.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.490.1">Figure 9.8: Terms and conditions selector when Long is selected; TermsAndConditionsLong.jsx has been dynamically loaded and is displayed</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.491.1">We can </span><a id="_idIndexMarker561" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.492.1">also look at the Bundle Analyzer’s </span><strong class="source-inline"><span class="kobospan" id="kobo.493.1">client.html</span></strong><span class="kobospan" id="kobo.494.1"> output using </span><strong class="source-inline"><span class="kobospan" id="kobo.495.1">npm run analyze</span></strong><span class="kobospan" id="kobo.496.1">; the following has been filtered </span><a id="_idIndexMarker562" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.497.1">to the relevant chunks to illustrate how </span><strong class="source-inline"><span class="kobospan" id="kobo.498.1">TermsAndConditionsShort</span></strong><span class="kobospan" id="kobo.499.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.500.1">TermsAndConditionsLong</span></strong><span class="kobospan" id="kobo.501.1"> are not included in </span><strong class="source-inline"><span class="kobospan" id="kobo.502.1">chunks/pages/index.js</span></strong><span class="kobospan" id="kobo.503.1">. </span><span class="kobospan" id="kobo.503.2">There are three “dynamic” chunks (which correlates with our findings from the network requests we observe in the browser): one for </span><strong class="source-inline"><span class="kobospan" id="kobo.504.1">components/Hello.jsx</span></strong><span class="kobospan" id="kobo.505.1">, one for </span><strong class="source-inline"><span class="kobospan" id="kobo.506.1">components/TermsAndConditionsShort.jsx</span></strong><span class="kobospan" id="kobo.507.1">, and one </span><span><span class="kobospan" id="kobo.508.1">for </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.509.1">components/TermsAndConditionsLong.jsx</span></strong></span><span><span class="kobospan" id="kobo.510.1">.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer108">
<span class="kobospan" id="kobo.511.1"><img alt="Figure 9.9: Bundle Analyzer output for the page chunk as well as the dynamic chunks (which include the TermsAndConditionsShort and TermsAndConditionsLong components)" src="image/B19109_09_9.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.512.1">Figure 9.9: Bundle Analyzer output for the page chunk as well as the dynamic chunks (which include the TermsAndConditionsShort and TermsAndConditionsLong components)</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.513.1">We’ve now </span><a id="_idIndexMarker563" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.514.1">seen how </span><strong class="source-inline"><span class="kobospan" id="kobo.515.1">dynamic</span></strong><span class="kobospan" id="kobo.516.1"> can be used </span><a id="_idIndexMarker564" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.517.1">in response to a user action to dynamically load content based on user-provided data. </span><span class="kobospan" id="kobo.517.2">Next, we’ll revisit dynamic imports of a JavaScript resource (as opposed to React components) while handling a user action in the context of a </span><span><span class="kobospan" id="kobo.518.1">Next.js application.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.519.1">We’ll start with a new component, </span><strong class="source-inline"><span class="kobospan" id="kobo.520.1">TermsAndConditionsLongScroll.jsx</span></strong><span class="kobospan" id="kobo.521.1">, which is functionally the same as </span><strong class="source-inline"><span class="kobospan" id="kobo.522.1">TermsAndCondtionsShort.jsx</span></strong><span class="kobospan" id="kobo.523.1"> or </span><strong class="source-inline"><span class="kobospan" id="kobo.524.1">TermsAndCondtionsLong.jsx</span></strong><span class="kobospan" id="kobo.525.1"> but with </span><span><span class="kobospan" id="kobo.526.1">10 paragraphs:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.527.1">
import React from 'react';
export function TermsAndConditions() {
  return (
    &lt;&gt;
      &lt;h3&gt;Terms and Conditions Long Scroll&lt;/h3&gt;
      &lt;p&gt;{/* Terms and Conditions Content */}&lt;/p&gt;
      &lt;p&gt;{/* Terms and Conditions Content */}&lt;/p&gt;
      &lt;p&gt;{/* Terms and Conditions Content */}&lt;/p&gt;
      &lt;p&gt;{/* Terms and Conditions Content */}&lt;/p&gt;
      &lt;p&gt;{/* Terms and Conditions Content */}&lt;/p&gt;
      &lt;p&gt;{/* Terms and Conditions Content */}&lt;/p&gt;
      &lt;p&gt;{/* Terms and Conditions Content */}&lt;/p&gt;
      &lt;p&gt;{/* Terms and Conditions Content */}&lt;/p&gt;
      &lt;p&gt;{/* Terms and Conditions Content */}&lt;/p&gt;
      &lt;p&gt;{/* Terms and Conditions Content */}&lt;/p&gt;
    &lt;/&gt;
  );
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.528.1">We’ll now </span><a id="_idIndexMarker565" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.529.1">add a form at the bottom of the </span><a id="_idIndexMarker566" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.530.1">page to accept the terms and conditions. </span><span class="kobospan" id="kobo.530.2">We have a long form so it’s nice to be able to go directly to the bottom. </span><span class="kobospan" id="kobo.530.3">To this end, we add a button that, on click, scrolls us to the input checkbox element using </span><span><span class="kobospan" id="kobo.531.1">a ref.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.532.1">In our </span><em class="italic"><span class="kobospan" id="kobo.533.1">scroll-to-bottom</span></em><span class="kobospan" id="kobo.534.1"> handler, we ensure that smooth scrolling is available (some older Safari versions don’t natively support it) by conditionally importing the </span><strong class="source-inline"><span class="kobospan" id="kobo.535.1">scroll-behavior-polyfill</span></strong><span class="kobospan" id="kobo.536.1"> package if </span><strong class="source-inline"><span class="kobospan" id="kobo.537.1">scrollBehavior</span></strong><span class="kobospan" id="kobo.538.1"> is </span><span><span class="kobospan" id="kobo.539.1">not detected.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.540.1">Finally, we scroll using the </span><strong class="source-inline"><span class="kobospan" id="kobo.541.1">scrollTargetRef.current.scrollIntoView()</span></strong><span class="kobospan" id="kobo.542.1"> function. </span><strong class="source-inline"><span class="kobospan" id="kobo.543.1">scrollTargetRef</span></strong><span class="kobospan" id="kobo.544.1"> is attached to the </span><a id="_idIndexMarker567" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.545.1">checkbox input using </span><a id="_idIndexMarker568" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.546.1">the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.547.1">ref</span></strong></span><span><span class="kobospan" id="kobo.548.1"> property:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.549.1">
import React, { useRef } from 'react';
export function TermsAndConditions() {
  const scrollTargetRef = useRef();
  async function handleScroll() {
    if (!('scrollBehavior' in document.
</span><span class="kobospan1" id="kobo.549.2">      documentElement.style)) {
      await import('scroll-behavior-polyfill');
    }
    if (scrollTargetRef.current) {
      scrollTargetRef.current.scrollIntoView({
        behavior: 'smooth',
        block: 'end',
      });
    }
  }
  return (
    &lt;&gt;
      {/* no change to heading */}
      &lt;button onClick={handleScroll}&gt;Scroll to button
        &lt;/button&gt;
      {/* no changes to paragraphs */}
      &lt;hr /&gt;
      &lt;label htmlFor="accept"&gt;
        &lt;input
          id="accept"
          name="acceptTerms"
          type="checkbox"
          ref={scrollTargetRef}
        /&gt;
        Accept Terms and Conditions
      &lt;/label&gt;
    &lt;/&gt;
  );
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.550.1">Back in </span><strong class="source-inline"><span class="kobospan" id="kobo.551.1">pages/index.js</span></strong><span class="kobospan" id="kobo.552.1">, we’ll </span><a id="_idIndexMarker569" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.553.1">allow </span><strong class="bold"><span class="kobospan" id="kobo.554.1">LongScroll</span></strong><span class="kobospan" id="kobo.555.1"> to be </span><a id="_idIndexMarker570" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.556.1">selected (as a new </span><strong class="source-inline"><span class="kobospan" id="kobo.557.1">option</span></strong><span class="kobospan" id="kobo.558.1">) and to be </span><span><span class="kobospan" id="kobo.559.1">dynamically imported:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.560.1">
// no changes to imports and definitions outside of Index
export default function Index() {
  // no changes to useState to maintain select state
  const TermsAndConditions = ['Short', 'Long',
    'LongScroll'].includes(
    selectedTermsAndConditions,
  )
    ? </span><span class="kobospan1" id="kobo.560.2">dynamic(() =&gt;
        import(
          `../components/TermsAndConditions$
            {selectedTermsAndConditions}.jsx`
        ).then(({ TermsAndConditions }) =&gt;
          TermsAndConditions),
      )
    : NoRender;
  return (
    &lt;&gt;
      {/* no change to content outside of select */}
      &lt;div&gt;
        {/* no change to label */}
        &lt;select
          id="termsAndConditionsType"
          onChange={(e) =&gt; setSelectedTermsAndConditions
            (e.target.value)}
        &gt;
          {/* no change to existing options */}
          &lt;option value="LongScroll"&gt;LongScroll&lt;/option&gt;
        &lt;/select&gt;
        &lt;hr /&gt;
        &lt;TermsAndConditions /&gt;
      &lt;/div&gt;
    &lt;/&gt;
  );
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.561.1">When we </span><a id="_idIndexMarker571" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.562.1">run the next dev server, load the index page, and select </span><strong class="bold"><span class="kobospan" id="kobo.563.1">LongScroll</span></strong><span class="kobospan" id="kobo.564.1">, we see the following with a </span><strong class="bold"><span class="kobospan" id="kobo.565.1">Scroll to bottom</span></strong><span class="kobospan" id="kobo.566.1"> button and </span><a id="_idIndexMarker572" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.567.1">a large amount of paragraph content. </span><span class="kobospan" id="kobo.567.2">Note that there is only one network request </span><span><span class="kobospan" id="kobo.568.1">for </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.569.1">TermsAndConditionsLongScroll.jsx</span></strong></span><span><span class="kobospan" id="kobo.570.1">.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer109">
<span class="kobospan" id="kobo.571.1"><img alt="Figure 9.10: TermsAndConditionsLongScroll.jsx selection with dynamic import" src="image/B19109_09_10.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.572.1">Figure 9.10: TermsAndConditionsLongScroll.jsx selection with dynamic import</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.573.1">In browsers where </span><strong class="source-inline"><span class="kobospan" id="kobo.574.1">behavior: 'smooth'</span></strong><span class="kobospan" id="kobo.575.1"> is supported, when the </span><strong class="bold"><span class="kobospan" id="kobo.576.1">Scroll to bottom</span></strong><span class="kobospan" id="kobo.577.1"> button is clicked, no additional JavaScript chunks are loaded and we’re scrolled to the checkbox input after the </span><span><span class="kobospan" id="kobo.578.1">multiple paragraphs.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer110">
<span class="kobospan" id="kobo.579.1"><img alt="Figure 9.11: TermsAndConditionsLongScroll.jsx selection with dynamic import" src="image/B19109_09_11.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.580.1">Figure 9.11: TermsAndConditionsLongScroll.jsx selection with dynamic import</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.581.1">On browsers </span><a id="_idIndexMarker573" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.582.1">that don’t support </span><strong class="source-inline"><span class="kobospan" id="kobo.583.1">behavior: 'smooth'</span></strong><span class="kobospan" id="kobo.584.1"> for </span><a id="_idIndexMarker574" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.585.1">scrolling, </span><strong class="source-inline"><span class="kobospan" id="kobo.586.1">scroll-behavior-polyfill</span></strong><span class="kobospan" id="kobo.587.1"> will be loaded allowing for smooth scrolling to </span><span><span class="kobospan" id="kobo.588.1">the checkbox.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer111">
<span class="kobospan" id="kobo.589.1"><img alt="Figure 9.12: TermsAndConditionsLongScroll.jsx selection with dynamic import of the component and of the scroll-behavior-polyfill module" src="image/B19109_09_12.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.590.1">Figure 9.12: TermsAndConditionsLongScroll.jsx selection with dynamic import of the component and of the scroll-behavior-polyfill module</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.591.1">Based </span><a id="_idIndexMarker575" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.592.1">on the Bundle Analyzer output (using </span><strong class="source-inline"><span class="kobospan" id="kobo.593.1">npm run analyze</span></strong><span class="kobospan" id="kobo.594.1"> and the </span><strong class="source-inline"><span class="kobospan" id="kobo.595.1">@next/bundle-analyzer</span></strong><span class="kobospan" id="kobo.596.1"> plugin), we can see that </span><a id="_idIndexMarker576" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.597.1">there is a chunk that contains </span><strong class="source-inline"><span class="kobospan" id="kobo.598.1">scroll-behavior-polyfill</span></strong><span class="kobospan" id="kobo.599.1">, along with chunks for </span><strong class="source-inline"><span class="kobospan" id="kobo.600.1">pages/index.js</span></strong><span class="kobospan" id="kobo.601.1"> and one each for </span><strong class="source-inline"><span class="kobospan" id="kobo.602.1">TermsAndConditionsShort.jsx</span></strong><span class="kobospan" id="kobo.603.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.604.1">TermsAndConditionsLong.jsx</span></strong><span class="kobospan" id="kobo.605.1">, </span><span><span class="kobospan" id="kobo.606.1">and </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.607.1">TermsAndConditionsLongScroll.jsx</span></strong></span><span><span class="kobospan" id="kobo.608.1">.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer112">
<span class="kobospan" id="kobo.609.1"><img alt="Figure 9.13: Bundle Analyzer output for the pages/index.js chunk as well as relevant dynamic chunks (TermsAndConditionsShort, TermsAndConditionsLong, TermsAndConditionsLongScroll, and scroll-behavior-polyfill)" src="image/B19109_09_13.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.610.1">Figure 9.13: Bundle Analyzer output for the pages/index.js chunk as well as relevant dynamic chunks (TermsAndConditionsShort, TermsAndConditionsLong, TermsAndConditionsLongScroll, and scroll-behavior-polyfill)</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.611.1">We’ve now </span><a id="_idIndexMarker577" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.612.1">seen that Next.js code splits effectively </span><a id="_idIndexMarker578" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.613.1">on native </span><strong class="source-inline"><span class="kobospan" id="kobo.614.1">import()</span></strong><span class="kobospan" id="kobo.615.1"> as well as the provided </span><span><strong class="source-inline"><span class="kobospan" id="kobo.616.1">dynamic()</span></strong></span><span><span class="kobospan" id="kobo.617.1"> utility.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.618.1">Finally, we’ll see how to use </span><strong class="source-inline"><span class="kobospan" id="kobo.619.1">dynamic()</span></strong><span class="kobospan" id="kobo.620.1"> and the </span><strong class="source-inline"><span class="kobospan" id="kobo.621.1">react-intersection-observer</span></strong><span class="kobospan" id="kobo.622.1"> package to dynamically load content when it </span><span><span class="kobospan" id="kobo.623.1">is visible.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.624.1">One other variant of a Terms and Conditions form or similar would be to include additional fields that should be captured when the customer accepts </span><span><span class="kobospan" id="kobo.625.1">the terms.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.626.1">In this example, we’ll add a </span><strong class="source-inline"><span class="kobospan" id="kobo.627.1">components/TermsForm.jsx</span></strong><span class="kobospan" id="kobo.628.1"> component with an input for the user’s name and a label </span><span><span class="kobospan" id="kobo.629.1">for it:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.630.1">
import React from 'react';
export default function TermsForm() {
  return (
    &lt;form&gt;
      &lt;label htmlFor="name"&gt;Type your name as signature
      &lt;/label&gt;
      &lt;input id="name" type="text" /&gt;
    &lt;/form&gt;
  );
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.631.1">Next, we’ll want to include it in </span><strong class="source-inline"><span class="kobospan" id="kobo.632.1">components/TermsAndConditionsLongScrollAcceptForm.jsx</span></strong><span class="kobospan" id="kobo.633.1">. </span><span class="kobospan" id="kobo.633.2">We’ll use </span><strong class="source-inline"><span class="kobospan" id="kobo.634.1">dynamic()</span></strong><span class="kobospan" id="kobo.635.1"> to load the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.636.1">TermsForm</span></strong></span><span><span class="kobospan" id="kobo.637.1"> component.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.638.1">The rest </span><a id="_idIndexMarker579" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.639.1">of our code is similar to the end state of the </span><strong class="source-inline"><span class="kobospan" id="kobo.640.1">TermsAndConditionsLongScroll</span></strong><span class="kobospan" id="kobo.641.1"> components, with a heading, 10 paragraphs, and an </span><span><strong class="source-inline"><span class="kobospan" id="kobo.642.1">accept</span></strong></span><span><span class="kobospan" id="kobo.643.1"> input.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.644.1">The key </span><a id="_idIndexMarker580" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.645.1">exception is the import and usage of the </span><strong class="source-inline"><span class="kobospan" id="kobo.646.1">InView</span></strong><span class="kobospan" id="kobo.647.1"> component </span><span><span class="kobospan" id="kobo.648.1">from </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.649.1">react-intersection-observer</span></strong></span><span><span class="kobospan" id="kobo.650.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.651.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.652.1">InView</span></strong><span class="kobospan" id="kobo.653.1"> component has a children render property that receives, among other properties, the </span><strong class="source-inline"><span class="kobospan" id="kobo.654.1">ref</span></strong><span class="kobospan" id="kobo.655.1"> property, which we can attach to elements whose visibility we’re interested in. </span><span class="kobospan" id="kobo.655.2">Another property of interest to us is the </span><strong class="source-inline"><span class="kobospan" id="kobo.656.1">inView</span></strong><span class="kobospan" id="kobo.657.1"> Boolean, which tells us whether the element on which we put the </span><strong class="source-inline"><span class="kobospan" id="kobo.658.1">ref</span></strong><span class="kobospan" id="kobo.659.1"> prop is in </span><span><span class="kobospan" id="kobo.660.1">the viewport.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.661.1">As the rendered output of the </span><strong class="source-inline"><span class="kobospan" id="kobo.662.1">InView</span></strong><span class="kobospan" id="kobo.663.1"> children function, we return a </span><strong class="source-inline"><span class="kobospan" id="kobo.664.1">div</span></strong><span class="kobospan" id="kobo.665.1"> element to which we attach the </span><strong class="source-inline"><span class="kobospan" id="kobo.666.1">ref</span></strong><span class="kobospan" id="kobo.667.1"> property. </span><span class="kobospan" id="kobo.667.2">Inside of the </span><strong class="source-inline"><span class="kobospan" id="kobo.668.1">div</span></strong><span class="kobospan" id="kobo.669.1">, we render </span><strong class="source-inline"><span class="kobospan" id="kobo.670.1">TermsForm</span></strong><span class="kobospan" id="kobo.671.1"> but only if </span><strong class="source-inline"><span class="kobospan" id="kobo.672.1">inView</span></strong> <span><span class="kobospan" id="kobo.673.1">is </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.674.1">true</span></strong></span><span><span class="kobospan" id="kobo.675.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.676.1">
import React from 'react';
import dynamic from 'next/dynamic';
import { InView } from 'react-intersection-observer';
const TermsForm = dynamic(() =&gt; import('./TermsForm.jsx'));
export function TermsAndConditions() {
  return (
    &lt;&gt;
      &lt;h3&gt;Terms and Conditions Long Scroll Accept Form&lt;/h3&gt;
      {/* 10 paragraphs of content */}
      &lt;hr /&gt;
      &lt;InView&gt;
        {({ inView, ref }) =&gt; &lt;div ref={ref}&gt;{inView &amp;&amp;
          &lt;TermsForm /&gt;}&lt;/div&gt;}
      &lt;/InView&gt;
      &lt;label htmlFor="accept"&gt;
        &lt;input id="accept" name="acceptTerms"
          type="checkbox" /&gt;
        Accept Terms and Conditions
      &lt;/label&gt;
    &lt;/&gt;
  );
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.677.1">Finally, we need </span><a id="_idIndexMarker581" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.678.1">to add </span><strong class="source-inline"><span class="kobospan" id="kobo.679.1">TermsAndConditionsLongScrollAcceptForm</span></strong><span class="kobospan" id="kobo.680.1"> as a selectable option and a dynamically </span><a id="_idIndexMarker582" class="pcalibre1 calibre6 pcalibre"/><span><span class="kobospan" id="kobo.681.1">loaded component:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.682.1">
// no changes to imports and definitions outside of Index
export default function Index() {
  // no changes to useState to maintain select state
  const TermsAndConditions = [
    'Short',
    'Long',
    'LongScroll',
    'LongScrollAcceptForm',
  ].includes(selectedTermsAndConditions)
    ? </span><span class="kobospan1" id="kobo.682.2">dynamic(() =&gt;
        import(
          `../components/TermsAndConditions$
             {selectedTermsAndConditions}.jsx`
        ).then(({ TermsAndConditions }) =&gt;
          TermsAndConditions),
      )
    : NoRender;
  return (
    &lt;&gt;
      {/* no change to content outside of select */}
      &lt;div&gt;
        {/* no change to label */}
        &lt;select
          id="termsAndConditionsType"
          onChange={(e) =&gt; setSelectedTermsAndConditions
            (e.target.value)}
        &gt;
          {/* no change to existing options */}
          &lt;option value="LongScrollAcceptForm"&gt;
             LongScrollAcceptForm&lt;/option&gt;
        &lt;/select&gt;
        &lt;hr /&gt;
        &lt;TermsAndConditions /&gt;
      &lt;/div&gt;
    &lt;/&gt;
  );
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.683.1">Now, when we </span><a id="_idIndexMarker583" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.684.1">run the next dev server and load the </span><a id="_idIndexMarker584" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.685.1">index page, </span><strong class="source-inline"><span class="kobospan" id="kobo.686.1">LongScrollAcceptForm</span></strong><span class="kobospan" id="kobo.687.1"> is available. </span><span class="kobospan" id="kobo.687.2">When we select it, the </span><strong class="source-inline"><span class="kobospan" id="kobo.688.1">TermsAndConditionsLongScrollAcceptForm.jsx</span></strong><span class="kobospan" id="kobo.689.1"> component </span><span><span class="kobospan" id="kobo.690.1">is loaded.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer113">
<span class="kobospan" id="kobo.691.1"><img alt="Figure 9.14: LongScrollAcceptForm selected and TermsAndConditionsLongScrollAcceptForm.jsx dynamically loaded" src="image/B19109_09_14.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.692.1">Figure 9.14: LongScrollAcceptForm selected and TermsAndConditionsLongScrollAcceptForm.jsx dynamically loaded</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.693.1">When </span><strong class="source-inline"><span class="kobospan" id="kobo.694.1">TermsAndConditionsLongScrollAcceptForm</span></strong><span class="kobospan" id="kobo.695.1"> is scrolled to the bottom (to the </span><a id="_idIndexMarker585" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.696.1">point where the checkbox is visible), the </span><strong class="source-inline"><span class="kobospan" id="kobo.697.1">TermsForm.jsx</span></strong><span class="kobospan" id="kobo.698.1"> component </span><a id="_idIndexMarker586" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.699.1">is dynamically loaded and is shown on </span><span><span class="kobospan" id="kobo.700.1">the page.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer114">
<span class="kobospan" id="kobo.701.1"><img alt="Figure 9.15: TermsAndConditionsLongScrollAcceptForm scrolled to the bottom and TermsForm.jsx dynamically loaded" src="image/B19109_09_14.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.702.1">Figure 9.15: TermsAndConditionsLongScrollAcceptForm scrolled to the bottom and TermsForm.jsx dynamically loaded</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.703.1">We’ve now </span><a id="_idIndexMarker587" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.704.1">seen how to load JavaScript and React</span><a id="_idTextAnchor270" class="pcalibre1 calibre6 pcalibre"/> <a id="_idIndexMarker588" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.705.1">components on component visibility and interaction </span><span><span class="kobospan" id="kobo.706.1">with Next.js.</span></span></p>
<h1 id="_idParaDest-147" class="calibre5"><a id="_idTextAnchor271" class="pcalibre1 calibre6 pcalibre"/><span class="kobospan" id="kobo.707.1">Summary</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.708.1">In this chapter, we’ve covered various approaches for maximizing the performance of your JavaScript, React, and Next.js applications with lazy loading approaches and </span><span><span class="kobospan" id="kobo.709.1">code splitting.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.710.1">First, we showcased how to use the dynamic import syntax in a Vite-powered setup to cause code splitting and illustrated it by importing additional code only when it’s required (during an </span><span><span class="kobospan" id="kobo.711.1">interaction handler).</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.712.1">Next, we saw how Next.js provides out-of-the-box route-based code splitting while also ensuring modules shared across pages don’t get loaded or output more than once. </span><span class="kobospan" id="kobo.712.2">We also delved into how to validate this using the Next.js Bundle </span><span><span class="kobospan" id="kobo.713.1">Analyzer plugin.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.714.1">Finally, we covered how to implement different lazy loading scenarios in Next.js: on presence in the component tree, on change caused by user interaction, importing a JavaScript module during an event handler, and lazy loading on an element entering </span><span><span class="kobospan" id="kobo.715.1">the viewport.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.716.1">We now know how to leverage lazy loading and code splitting to maximize application load performance. </span><span class="kobospan" id="kobo.716.2">In the next chapter, we’ll cover asset-loading strategies and how to execute code off the </span><span><span class="kobospan" id="kobo.717.1">main thread.</span></span></p>
</div>
</body></html>