<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Special Techniques</h1></div></div></div><p>In this chapter, we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using mixins with Backbone objects</li><li class="listitem" style="list-style-type: disc">Creating a <code class="literal">Backbone.js</code> extension with Grunt</li><li class="listitem" style="list-style-type: disc">Wiring tests for a Backbone extension with QUnit</li><li class="listitem" style="list-style-type: disc">Mocking up a RESTful service with jQuery Mockjax in asynchronous tests</li><li class="listitem" style="list-style-type: disc">Developing a mobile application with jQuery Mobile</li><li class="listitem" style="list-style-type: disc">Building an iOS/Android app with PhoneGap</li><li class="listitem" style="list-style-type: disc">Organizing a project structure with <code class="literal">Require.js</code></li><li class="listitem" style="list-style-type: disc">Ensuring compatibility with search engines</li><li class="listitem" style="list-style-type: disc">Avoiding memory leaks in a Backbone application</li></ul></div><div><div><div><div><h1 class="title"><a id="ch08lvl1sec79"/>Introduction</h1></div></div></div><p>This chapter is aimed at showing how to solve the most challenging problems that can occur during Backbone development.</p><p>We are going to learn how to mix the existing Backbone objects to add any additional functionality. We will create a Backbone extension using Grunt.</p><p>We will also create tests for our extension, which will help us to ensure it works as expected when any new functionality is added to the extension.</p><p>Then, we will integrate <strong>jQuery Mobile</strong><a class="indexterm" id="id623"/> and <code class="literal">Backbone.js</code> and will use <strong>PhoneGap</strong> to build native applications for mobile platforms such as iOS and Android.</p><p>We will learn how to deal with <code class="literal">Require.js</code>, how to use it to organize project structure, and how to use it in our mobile applications.</p><p>And finally, we will understand how to make the search engine index the AJAX application created with <code class="literal">Backbone.js</code>.</p><p>This chapter assumes that you are using a Unix like shell and have <code class="literal">Node.js</code> and npm (Node Package Modules) installed in your system.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec80"/>Using mixins with Backbone objects</h1></div></div></div><p>Though there are <a class="indexterm" id="id624"/>hundreds of Backbone extensions that<a class="indexterm" id="id625"/> provide additional functionality, a project may need to extend Backbone objects with some custom functionality.</p><p>There are several ways to do this. Typically, you can extend a Backbone object with the following code:</p><div><pre class="programlisting">  Backbone.ExtraModel = Backbone.Model.extend({
    // Add new method.
    hello: function() {

    },

    // Override existing method.
    toJSON: function() {

    }
  });</pre></div><p>It works great unless you face one of following scenarios:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You want to modify the <code class="literal">Backbone.Model</code> object and all its children objects at once</li><li class="listitem" style="list-style-type: disc">You have different extensions which together modify the same object, and thus you will need to avoid conflicts</li></ul></div><p>The solution is to use mixins, which we are going to deal with within the scope of this recipe.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec226"/>How to do it...</h2></div></div></div><p>Perform the following steps to define <code class="literal">mixin</code> and add it to <code class="literal">Backbone.Model</code>:</p><div><ol class="orderedlist arabic"><li class="listitem">Define the <code class="literal">mixin</code> object in the following way:<div><pre class="programlisting">  var mixin = {
    // Add new method.
    hello: function() {

    },

    // Override existing method.
    toJSON: function() {

    }
  }</pre></div></li><li class="listitem">Add <code class="literal">mixin</code> to the existing object as described in the following code:<div><pre class="programlisting">  Backbone.NewModel = Backbone.Model.extend(mixin);</pre></div></li><li class="listitem">Save <code class="literal">mixin</code> so <a class="indexterm" id="id626"/>that it can be mixed to the other model objects, if required.<div><pre class="programlisting">  Backbone.NewModel.mixin = mixin;</pre></div></li><li class="listitem">Another way is to apply mixin to <code class="literal">Backbone.Model.prototype</code>. This will make all <code class="literal">Backbone.Model</code> children to have such mixin.<div><pre class="programlisting">  _.extend(Backbone.Model.prototype, mixin);</pre></div></li><li class="listitem">If there<a class="indexterm" id="id627"/> are more functionalities you need to define them in different mixins, you can extend the Backbone object in a similar way:<div><pre class="programlisting">  _.extend(Backbone.Model.prototype, mixin2);</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec227"/>How it works...</h2></div></div></div><p>To create a new model object, we used the <code class="literal">extend()</code> method<a class="indexterm" id="id628"/> provided by the ancestor model. To extend all Backbone models at once, we perform the mixing operation on the prototype of <code class="literal">Backbone.Model</code> using the <code class="literal">extend()</code> method of <code class="literal">Undercore.js</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec228"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To understand prototype inheritance, please navigate to <a class="ulink" href="http://en.wikipedia.org/wiki/Prototype-based_programming">http://en.wikipedia.org/wiki/Prototype-based_programming</a></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec81"/>Creating a Backbone.js extension with Grunt</h1></div></div></div><p>It could be <a class="indexterm" id="id629"/>very important for the developer to create a<a class="indexterm" id="id630"/> Backbone extension that will be shared with the rest of the world or even re-used in future projects. In this recipe, we are going to learn how to create our own extension using Grunt, and we will upload it on <a class="indexterm" id="id631"/>
<strong>GitHub</strong>.</p><p>Grunt is the JavaScript task runner that allows automating different tasks such as minification, compilation, unit testing, and linting. These repetitive tasks are defined in the <code class="literal">Gruntfile.js</code> file and are triggered from a console. There are many different packages for Grunt <a class="indexterm" id="id632"/>that are available as npm extensions. We are going to use one of them, named grunt-init, for scaffolding the Backbone extension from a template.</p><p>Our extension <a class="indexterm" id="id633"/>is going to provide a compatibility with MongoDB. In the previous chapter, we used MongoLab (<a class="ulink" href="https://mongolab.com">https://mongolab.com</a>), which is a MongoDB with a RESTful interface. <strong>MongoLab</strong> provides <a class="indexterm" id="id634"/>the data in the <strong>MongoDB Extended JSON</strong>, <a class="indexterm" id="id635"/>which is not supported by Backbone by default. The following code is an example of how a resource ID is presented in the MongoDB Extended JSON:</p><div><pre class="programlisting">{
  "$oid": "&lt;id&gt;"
}</pre></div><p>By default, the <code class="literal">Backbone.js</code> file does not deal with such IDs, but our extension will allow us to do this.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec229"/>Getting ready...</h2></div></div></div><p>Perform the following steps to get prepared for this recipe:</p><div><ol class="orderedlist arabic"><li class="listitem">Make sure that <code class="literal">Node.js</code> and npm are installed.</li><li class="listitem">Install <code class="literal">grunt-init</code>, which allows generating a project from a template.<div><pre class="programlisting">npm install -g grunt-init</pre></div></li><li class="listitem">Install <code class="literal">grunt-cli</code>, which allows running grunt commands from a command line.<div><pre class="programlisting">grunt-init-backbone-plugin npm install -g grunt-cli</pre></div></li><li class="listitem">Download <code class="literal">grunt-init-backbone-plugin</code> and place it in your local <code class="literal">grunt-init</code> directory.<div><pre class="programlisting">git clone --recursive https://github.com/dealancer/grunt-init-backbone-plugin.git ~/.grunt-init/backbone-plugin</pre></div></li><li class="listitem">Create the public repository on <a class="ulink" href="http://github.com">http://github.com</a> where we will upload our extension.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec230"/>How to do it...</h2></div></div></div><p>Perform the following steps to create a Backbone extension with Grunt:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a directory that will contain the source code of our extension. This directory should be named <code class="literal">backbone-mongodb</code>.<div><pre class="programlisting">
<strong>  $ mkdir backbone-mongodb</strong>
<strong>  $ cd backbone-mongodb</strong>
</pre></div></li><li class="listitem">Build an<a class="indexterm" id="id636"/> extension project from the Grunt template. Run the next command and follow the steps asked by Grunt.<div><pre class="programlisting">
<strong>  $ grunt-init backbone-plugin</strong>
</pre></div></li><li class="listitem">Update<a class="indexterm" id="id637"/> the <code class="literal">backbone-mongodb.js</code> file with the following extension code:<div><pre class="programlisting">// backbone-mongodb 0.1.0
//
// (c) 2013 Vadim Mirgorod
// Licensed under the MIT license.

(function(Backbone) {

  // Define mixing that we will use in our extension.
  var mixin = {

    // Convert MongoDB Extended JSON into regular one.
    parse: function(resp, options) {
      if (_.isObject(resp._id))  {
        resp[this.idAttribute] = resp._id.$oid;
        delete resp._id;
      }

      return resp;
    },

    // Convert regular JSON into MongoDB extended one.
    toExtendedJSON: function() {
      var attrs = this.attributes;

      var attrs = _.omit(attrs, this.idAttribute);
      if (!_.isUndefined(this[this.idAttribute]))  {
        attrs._id = { $oid: this[this.idAttribute] };
      }

      return attrs;
    },

    // Substitute toJSON method when performing synchronization.
    sync: function() {
      var toJSON = this.toJSON;
      this.toJSON = this.toExtendedJSON;

      var ret = Backbone.sync.apply(this, arguments);

      this.toJSON = toJSON;

      return ret;
    }
  }

  // Create new MongoModel object.
  Backbone.MongoModel = Backbone.Model.extend(mixin);

  // Provide mixin to extend Backbone.Model.
  Backbone.MongoModel.mixin = mixin;

  // Another way to perform mixin.
  //_.extend(Backbone.Model.prototype, mixin);

}).call(this, Backbone);</pre></div></li><li class="listitem">Create <a class="indexterm" id="id638"/>the<a class="indexterm" id="id639"/> GitHub project by accessing the <a class="ulink" href="https://github.com/new">https://github.com/new</a> link and fill the form that appears.<div><img alt="How to do it..." src="img/2728OS_08_01.jpg"/></div></li><li class="listitem">Initialize the repository and push the code to the GitHub project.<div><pre class="programlisting">
<strong>  $ git init</strong>
<strong>  $ git remote add origin https://github.com/dealancer/backbone-mongo.git </strong>
<strong>  $ git add *</strong>
<strong>  $ git add .gitignore</strong>
<strong>  $ git commit -m "initial commit"</strong>
<strong>  $ git push -u origin master</strong>
</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec231"/>How it works...</h2></div></div></div><p>When <a class="indexterm" id="id640"/>we<a class="indexterm" id="id641"/> run the <code class="literal">grunt-init</code> command with the <code class="literal">backbone-plugin</code> parameter, it builds a new project from the <code class="literal">backbone-plugin</code> template, which we downloaded and saved in the <code class="literal">~/.grunt-init/backbone-plugin</code> directory.</p><p>The newly generated project structure is as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">node_modules/</code>: This option provides Node.js modules for our application<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">grunt/</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">grint-contrib-qunit/</code></li></ul></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">test/</code>: This option performs tests for our application<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">index.html</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">mongodb.js</code></li></ul></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">vendor/</code>: This option lists the libraries used in the application<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">backbone/</code></li></ul></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">backbone-mongodb.js</code>: This is the main file of our application</li><li class="listitem" style="list-style-type: disc"><code class="literal">Gruntfile.js</code>: This is the Grunt file</li><li class="listitem" style="list-style-type: disc"><code class="literal">LICENSE-MIT</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">README.md</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">package.json</code>: This is the Node.js module file</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec232"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The source code of the extension is available at <a class="ulink" href="https://github.com/dealancer/backbone-mongo">https://github.com/dealancer/backbone-mongo</a></li><li class="listitem" style="list-style-type: disc">Grunt documentation is available at <a class="ulink" href="http://gruntjs.com/getting-started">http://gruntjs.com/getting-started</a></li><li class="listitem" style="list-style-type: disc">For more info about the <code class="literal">grunt-init</code> backbone plugin, please navigate to <a class="ulink" href="https://github.com/gsamokovarov/grunt-init-backbone-plugin">https://github.com/gsamokovarov/grunt-init-backbone-plugin</a></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec82"/>Writing tests for a Backbone extension with QUnit</h1></div></div></div><p>If you are working <a class="indexterm" id="id642"/>on a complex project <a class="indexterm" id="id643"/>or a Backbone extension, you need to make sure that the new commits do not break any existing functionality. This<a class="indexterm" id="id644"/> is why many developers choose to create tests prior to or after writing new code.</p><p>For JavaScript applications, there are a good number of different testing tools that perfectly integrate with Backbone. In this recipe, we are going to learn one of the tools named <a class="indexterm" id="id645"/>QUnit.</p><p>When we were building our project from a template using Grunt, QUnit was included in the project, and the <code class="literal">test/mongodb.js</code> file was created. Let's add a simple test to the extension we did in the previous recipe.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec233"/>How to do it...</h2></div></div></div><p>Perform the following steps to test an application:</p><div><ol class="orderedlist arabic"><li class="listitem">Edit the <code class="literal">test/mongodb.js</code> file and add some basic models and collections to the extension, as described in the following code:<div><pre class="programlisting">  var Book = Backbone.MongoModel.extend({
    urlRoot: '/books'
  });

  var Library = Backbone.Collection.extend({
    url: '/books',
    model: Book
  });</pre></div></li><li class="listitem">Add some variables that we will use, as shown in the following code:<div><pre class="programlisting">  var library;

  var attrs = {
    id: 5,
    title: "The Tempest",
    author: "Bill Shakespeare",
  };</pre></div></li><li class="listitem">Add the <a class="indexterm" id="id646"/><code class="literal">setup()</code> and <code class="literal">teardown()</code> methods<a class="indexterm" id="id647"/>, which will run before and after each test, <a class="indexterm" id="id648"/>as shown in the following code:<div><pre class="programlisting">  module('Backbone.Mongodb', _.extend(new Environment, {

    setup : function() {

      // Create new library.
      library = new Library();

      // Set init values.
      library.create(attrs, {wait: false});
    },

    teardown: function() {

    },
  }));</pre></div></li><li class="listitem">Define as<a class="indexterm" id="id649"/> many tests as you need by calling the <code class="literal">test()</code> function as follows:<div><pre class="programlisting">  test("Export to MongoDB Extended JSON", 2, function() {
    var book = library.get(5);
    ok(book);

    var json = book.toJSON();
    equal(json._id.$oid, 5);
  });</pre></div></li><li class="listitem">Run the tests by opening the <code class="literal">test/index.html</code> file in the browser, as shown in the following screenshot:<div><img alt="How to do it..." src="img/2728OS_08_02.jpg"/></div></li><li class="listitem">You <a class="indexterm" id="id650"/>can<a class="indexterm" id="id651"/> also run tests in a console with the following command, as shown in the following screenshot:<div><pre class="programlisting">
<strong>$ grunt</strong>
</pre></div><div><img alt="How to do it..." src="img/2728OS_08_03.jpg"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec234"/>How it works...</h2></div></div></div><p>QUnit runs<a class="indexterm" id="id652"/> all<a class="indexterm" id="id653"/> tests defined by the <code class="literal">test()</code> function<a class="indexterm" id="id654"/>, which takes the following parameters: <code class="literal">name</code>, <code class="literal">amount of asserts</code>, and <code class="literal">callback function</code>. Inside a testing callback, we can use the following asserts:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">ok()</code>: This is a<a class="indexterm" id="id655"/> Boolean assertion that is equivalent to <code class="literal">CommonJS's assert.ok()</code> and <code class="literal">JUnit's assertTrue()</code>. It passes if the first argument is true.</li><li class="listitem" style="list-style-type: disc"><code class="literal">equal()</code>: This<a class="indexterm" id="id656"/> is a non-strict comparison assertion that is roughly equivalent to <code class="literal">JUnit assertEquals</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">notEqual()</code>: This<a class="indexterm" id="id657"/> is a non-strict comparison assertion that checks for inequality.</li><li class="listitem" style="list-style-type: disc"><code class="literal">strictEqual()</code>: This<a class="indexterm" id="id658"/><a class="indexterm" id="id659"/> is a strict type and value comparison assertion.</li><li class="listitem" style="list-style-type: disc"><code class="literal">throws()</code>: This<a class="indexterm" id="id660"/> is an assertion that tests if a callback throws an exception when run.</li><li class="listitem" style="list-style-type: disc"><code class="literal">notStrictEqual()</code>: This<a class="indexterm" id="id661"/> is a non-strict comparison assertion that checks for inequality.</li><li class="listitem" style="list-style-type: disc"><code class="literal">deepEqual()</code>: This is <a class="indexterm" id="id662"/>a deep, recursive comparison assertion that works on primitive types, arrays, objects, regular expressions, dates, and functions.</li><li class="listitem" style="list-style-type: disc"><code class="literal">notDeepEqual()</code>: This <a class="indexterm" id="id663"/>is an inverted deep, recursive comparison assertion that works on primitive types, arrays, objects, regular expressions, dates, and functions.</li></ul></div><p>If the required amount of asserts are achieved, the test is considered as successful.</p><p>Before running <a class="indexterm" id="id664"/>each test, QUnit runs the <code class="literal">setup()</code> function<a class="indexterm" id="id665"/>, and afterwards the <code class="literal">teardown()</code> function. This can be useful in case we need to change some global settings and then revert to the changes.</p><p>The Source code of the <code class="literal">index.html</code> file, which was generated by Grunt, looks like the following code:</p><div><pre class="programlisting">&lt;!doctype html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset='utf8'&gt;
  &lt;title&gt;Backbone Test Suite&lt;/title&gt;
  &lt;link rel="stylesheet"
    href="../vendor/backbone/test/vendor/qunit.css"
    type="text/css" media="screen"&gt;
  &lt;script src="img/json2.js"&gt;
  &lt;/script&gt;
  &lt;script src="img/jquery.js"&gt;
  &lt;/script&gt;
  &lt;script src="img/qunit.js"&gt;
  &lt;/script&gt;
  &lt;script src="img/underscore.js"&gt;
  &lt;/script&gt;
  &lt;script src="img/backbone.js"&gt;&lt;/script&gt;
  &lt;script src="img/backbone-mongodb.js"&gt;&lt;/script&gt;
  &lt;script src="img/environment.js"&gt;
  &lt;/script&gt;
  &lt;script src="img/noconflict.js"&gt;
  &lt;/script&gt;
  &lt;script src="img/events.js"&gt;&lt;/script&gt;
  &lt;script src="img/model.js"&gt;&lt;/script&gt;
  &lt;script src="img/collection.js"&gt;
  &lt;/script&gt;
  &lt;script src="img/router.js"&gt;&lt;/script&gt;
  &lt;script src="img/view.js"&gt;&lt;/script&gt;
  &lt;script src="img/sync.js"&gt;&lt;/script&gt;

  &lt;script src="img/mongodb.js"&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div id="qunit"&gt;&lt;/div&gt;
  &lt;div id="qunit-fixture"&gt;
    &lt;div id="testElement"&gt;
      &lt;h1&gt;Test&lt;/h1&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;br&gt;
  &lt;br&gt;
  &lt;h1 id="qunit-header"&gt;
    &lt;a href="#"&gt;Backbone Speed Suite&lt;/a&gt;
  &lt;/h1&gt;
  &lt;div id="jslitmus_container" style="margin: 20px 10px;"&gt;
  &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div><p>Also, the <a class="indexterm" id="id666"/>source code of the <code class="literal">Gruntfile.js</code> file, which describes the commands for Grunt, looks like the following code:</p><div><pre class="programlisting">module.exports = function(grunt) {
  grunt.initConfig({
    qunit: {
      all: ['test/index.html']
    }
  });

  grunt.loadNpmTasks('grunt-contrib-qunit');

  grunt.registerTask('default', ['qunit']);
};</pre></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec235"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Please refer to the official QUnit documentation in order to get more familiar with it, at <a class="ulink" href="http://api.qunitjs.com/">http://api.qunitjs.com/</a>.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec83"/>Mocking up a RESTful service with jQuery Mockjax in asynchronous tests</h1></div></div></div><p>In the previous recipe,<a class="indexterm" id="id667"/> we got familiar with QUnit and tested the <code class="literal">toJSON()</code> method<a class="indexterm" id="id668"/>, which is used for pushing data to a RESTful service. In this recipe, we are going to test the <code class="literal">fetch()</code> method<a class="indexterm" id="id669"/>, which works asynchronously. Fortunately, QUnit allows us to create asynchronous tests. We also going to emulate a RESTful service using jQuery Mockjax.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec236"/>Getting ready...</h2></div></div></div><p>Download the jQuery Mockjax extension<a class="indexterm" id="id670"/> from its GitHub page, <a class="ulink" href="https://github.com/appendto/jquery-mockjax">https://github.com/appendto/jquery-mockjax</a>, and place it in the vendor directory of the extension. Then, include its main JS file in the <code class="literal">test/index.html</code> file.</p><div><pre class="programlisting">  &lt;script src="img/jquery.mockjax.js"&gt;&lt;/script&gt;</pre></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec237"/>How to do it...</h2></div></div></div><p>Perform the <a class="indexterm" id="id671"/>following steps to mock up a RESTful service for an asynchronous testing:</p><div><ol class="orderedlist arabic"><li class="listitem">Define the mocked URLs and its output in the JSON format in the <code class="literal">setup()</code> method.<div><pre class="programlisting">      $.mockjax({
        url: '/books',
        responseTime: 10,
        responseText: [
          {_id: { "$oid": "10" }, one: 1},
          {id: "20", one: 1}
        ]
      });

      $.mockjax({
        url: '/books/10',
        responseTime: 10,
        responseText: {_id: { "$oid": "10" }, one: 1}
      });

      $.mockjax({
        url: '/books/20',
        responseTime: 10,
        responseText: {id: "20", one: 1}
      });</pre></div></li><li class="listitem">Cancel mocking in the <a class="indexterm" id="id672"/><code class="literal">teardown()</code> method.<div><pre class="programlisting">      $.mockjaxClear();</pre></div></li><li class="listitem">Add asynchronous tests that sync data from the mocked up RESTful service.<div><pre class="programlisting">  asyncTest("Read MongoDB Extended JSON", 1, function() {
    library.fetch();

    setTimeout(function() {
      ok(library.get('10'));
      start();
    }, 50);
  });

  asyncTest("Read regular JSON", 1, function() {
    library.fetch();

    setTimeout(function() {
      ok(library.get('20'));
      start();
    }, 50);
  });</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec238"/>How it works...</h2></div></div></div><p>In the previous <a class="indexterm" id="id673"/>code, we defined our test in the <code class="literal">asyncTest()</code> function<a class="indexterm" id="id674"/>, which works almost the same as the <code class="literal">test()</code> function, except that it does not proceed to the next test unless the <code class="literal">start()</code> function<a class="indexterm" id="id675"/> is called.</p><p>There is also a way to define asynchronous tests using the <code class="literal">test()</code> and <code class="literal">stop()</code> functions.</p><div><pre class="programlisting">test("Read MongoDB Extended JSON", 1, function() {
  // do not proceed on the next stop unless start() is called 
  stop();
    
  library.fetch();

  setTimeout(function() {
    ok(library.get('10'));
    start();
  }, 50);
});</pre></div><p>From the previous code, we have seen that the <code class="literal">asyncTest()</code> function is an equivalent of the <code class="literal">test()</code> function, which calls the <code class="literal">stop()</code> function right away.</p><p>It is interesting to know what is happening in the mocked up service. jQuery Mockjax replaces the <code class="literal">jQuery.ajax()</code> method<a class="indexterm" id="id676"/> with its own method, which emulates AJAX calls to the server.</p><p>Mocked URLs are defined using <code class="literal">$.mockjax()</code> and canceled with some help from <code class="literal">$.mockjaxClear()</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec239"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Please refer to the jQuery Mockjax documentation at <a class="ulink" href="https://github.com/appendto/jquery-mockjax">https://github.com/appendto/jquery-mockjax</a></li><li class="listitem" style="list-style-type: disc">Docs about asynchronous testing with QUnit are available at <a class="ulink" href="http://api.qunitjs.com/category/async-control/">http://api.qunitjs.com/category/async-control/</a></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec84"/>Developing a mobile application with jQuery Mobile</h1></div></div></div><p>jQuery Mobile<a class="indexterm" id="id677"/> is a <a class="indexterm" id="id678"/>useful HTML5/JavaScript framework for building mobile applications. It provides mobiles with look-and-feel components such as lists, buttons, toolbars, and dialogs. It is quite easy to create our own theme by customizing jQuery Mobile.</p><p>By default, all mobile pages can be stored in a single HTML file in different divs or are rendered on a fly. jQuery Mobile also allows us to use transition effects to switch between pages.</p><p>In this recipe, we are going to create a simple iOS-looking application with jQuery Mobile and <code class="literal">Backbone.js</code>, which allows users to view and create posts. Data is stored on <a class="ulink" href="https://mongolab.com/welcome/">https://mongolab.com/welcome/</a> and accessed via REST.</p><p>Our application will look like the following screenshot:</p><div><img alt="Developing a mobile application with jQuery Mobile" src="img/2728OS_08_04.jpg"/></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec240"/>Getting ready...</h2></div></div></div><p>Perform the <a class="indexterm" id="id679"/>following steps to get prepared for this recipe:</p><div><ol class="orderedlist arabic"><li class="listitem">Download the <a class="indexterm" id="id680"/>backbone-mongodb extension from its GitHub page, <a class="ulink" href="http://github.com/dealancer/backbone-mongodb/">http://github.com/dealancer/backbone-mongodb/</a>, and save it in <code class="literal">lib/backbone-mongodb.js</code>. We are going to use backbone-mongodb to connect to <a class="ulink" href="https://mongolab.com/welcome/">https://mongolab.com/welcome/</a>, the RESTful MongoDB service.</li><li class="listitem">Download the jQuery Mobile library<a class="indexterm" id="id681"/> from <a class="ulink" href="http://jquerymobile.com/">http://jquerymobile.com/</a> and extract it in the <code class="literal">lib/jquery.mobile/</code> folder.</li><li class="listitem">Download the iOS-inspired theme<a class="indexterm" id="id682"/><a class="indexterm" id="id683"/> for jQuery Mobile from its GitHub page, <a class="ulink" href="https://github.com/taitems/iOS-Inspired-jQuery-Mobile-Theme">https://github.com/taitems/iOS-Inspired-jQuery-Mobile-Theme</a>, and extract it in the <code class="literal">lib/ios_inspired/</code> folder.</li><li class="listitem">Download the icons that we are going to use in our mobile app from <a class="ulink" href="http://www.glyphish.com/">http://www.glyphish.com/</a>, and extract them into the <code class="literal">lib/glyphish/</code> folder.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec241"/>How to do it...</h2></div></div></div><p>Perform the<a class="indexterm" id="id684"/> following steps to create a mobile application:</p><div><ol class="orderedlist arabic"><li class="listitem">Render a page in the mobile browser using the default browser width, otherwise the page could be rendered for 980 pixels screen width and then scaled down. Include the following line into the header of <code class="literal">index.html</code>:<div><pre class="programlisting">&lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;</pre></div></li><li class="listitem">Include the CSS files into the header of <code class="literal">index.html</code>.<div><pre class="programlisting">&lt;link rel="stylesheet" href="lib/jquery.mobile/jquery.mobile-1.1.0.min.css"/&gt;
&lt;link rel="stylesheet" href="lib/ios_inspired/styles.css"/&gt;
&lt;link rel="stylesheet" href="css/styles.css"/&gt;</pre></div></li><li class="listitem">Create the <code class="literal">js/jqm-config.js</code> file that will retain the jQuery Mobile configuration and include this file it in <code class="literal">index.html</code>. Make sure it is included after jQuery and before jQuery Mobile.</li><li class="listitem">Bind the callback to the <code class="literal">mobileinit</code> event in <code class="literal">js/jqm-config.js</code>.<div><pre class="programlisting">$(document).bind("mobileinit", function () {

});</pre></div></li><li class="listitem">Disable the jQuery Mobile routing by adding the following code in the <code class="literal">mobileinit</code> event callback that we defined in the previous step:<div><pre class="programlisting">  $.mobile.ajaxEnabled = false;
  $.mobile.linkBindingEnabled = false;
  $.mobile.hashListeningEnabled = false;
  $.mobile.pushStateEnabled = false;</pre></div></li><li class="listitem">Set up transitions and effects by adding the following code in the mobileinit event callback:<div><pre class="programlisting">  $.extend($.mobile, {
    slideText: "slide",
    slideUpText: "slideup",
    defaultPageTransition: "slideup",
    defaultDialogTransition: "slideup"
  });</pre></div></li><li class="listitem">Remove<a class="indexterm" id="id685"/> the page from the <strong>Document Object Model</strong> (<strong>DOM</strong>)<a class="indexterm" id="id686"/> when it's being replaced. Add the following code into the mobileinit event callback:<div><pre class="programlisting">  $('div[data-role="page"]')
    .live('pagehide', function (event, ui) {
      $(event.currentTarget).remove();
    }
  );</pre></div></li><li class="listitem">Include the Backbone-mongodb extension in <code class="literal">index.html</code>.<div><pre class="programlisting">  &lt;script src="img/backbone-mongodb.js"&gt;&lt;/script&gt;</pre></div></li><li class="listitem">Enable <strong>Cross-site scripting</strong><a class="indexterm" id="id687"/> and disable the AJAX cache by adding the following code in <code class="literal">js/app-config.js</code>. Also, include this file in <code class="literal">index.html</code>. Make sure it is included before the main file of the application.<div><pre class="programlisting">jQuery.support.cors = true;
jQuery.ajaxSetup({ cache: false });</pre></div></li><li class="listitem">Mix <code class="literal">Backbone.MongoModel</code> in <code class="literal">Backbone.Model</code> to support the MongoDB Extended JSON by adding the following command line in <code class="literal">js/app-config.js</code>:<div><pre class="programlisting">_.extend(Backbone.Model.prototype, Backbone.MongoModel.mixin);</pre></div></li><li class="listitem">Add the RESTful service URL in <code class="literal">js/app-config.js</code>.<div><pre class="programlisting">var appConfig = {
  baseURL: 'https://api.mongolab.com/api/1/databases/social-mobile-app/collections/',
  addURL: '?apiKey=yGobEjzhT76Pjo9RaOLGfA89xCJXegpl'
}</pre></div></li><li class="listitem">Add the template loader in <code class="literal">js/template-loader.js</code> and include this file in <code class="literal">index.html</code> before the main application file.<div><pre class="programlisting">$(document).ready(function () {

    // Create global variable within jQuery object.
    $.tpl = {}

    $('script.template').each(function(index) {

      // Load template from DOM.
      $.tpl[$(this).attr('id')] = _.template($(this).html());

      // Remove template from DOM.
      $(this).remove();
    });

});</pre></div></li><li class="listitem">Define the<a class="indexterm" id="id688"/> router object with routes and callbacks in <code class="literal">js/main.js</code>, which is our main application file. It should be included after all other files.<div><pre class="programlisting">var Workspace = Backbone.Router.extend({
  routes: {
    "": "main",
    "post/list": "postList",
    "post/add": "postAdd",
    "post/details/:id": "postDetails",
    "post/delete/:id": "postDelete",
    "settings": "settings",
    "about": "about",
  },

  main: function() {
    this.changePage(new MainPageView());
  },

  postList: function() {
    var postList = new PostList();
    this.changePage(
      new PostListPageView({collection: postList})
    );
    postList.fetch();
  },

  postAdd: function() {
    this.changePage(new PostAddPageView());
  },

  postDetails: function(id) {
    var post = new Post({id: id});
    this.changePage(new PostDetailsPageView({model: post}));
    post.fetch();
  },

  postDelete: function(id) {
    var post = new Post({id: id});
    this.showDialog(new PostDeleteDialogView({model: post}));
    post.fetch();
  },

  settings: function() {
    this.changePage(new SettingsPageView());
  },

  about: function() {
    this.changePage(new AboutPageView());
  }
}</pre></div></li><li class="listitem">Add<a class="indexterm" id="id689"/> the <code class="literal">changePage()</code> method<a class="indexterm" id="id690"/> to the router object to switch to the current view page.<div><pre class="programlisting">  changePage: function (page) {
    $(page.el).attr('data-role', 'page');

    page.render();

    $('body').append($(page.el));

    $.mobile.changePage($(page.el), {
      changeHash: false,
      transition: this.historyCount++ ?
        $.mobile.defaultPageTransition : 'none',
    });
  }</pre></div></li><li class="listitem">Add the <code class="literal">showDialog()</code> method<a class="indexterm" id="id691"/> to show dialogs in the router object.<div><pre class="programlisting">  showDialog: function(page) {
    $(page.el).attr('data-role', 'dialog');

    page.render();

    $('body').append($(page.el));

    $.mobile.changePage($(page.el), {
      allowSamePageTransition: true,
      reverse: false,
      changeHash: false,
      role: 'dialog',
      transition: this.historyCount++ ? 
        $.mobile.defaultDialogTransition : 'none',
    });
  },</pre></div></li><li class="listitem">Define the model <a class="indexterm" id="id692"/>and collection in <code class="literal">js/models/post.js</code> and include this file in <code class="literal">index.html</code>.<div><pre class="programlisting">var Post = Backbone.Model.extend({
  defaults: {
    title: "",
    body: "",
    created: new Date().toString(),
  },

  url: function() {
    if (_.isUndefined(this.attributes.id)) {
      return appConfig.baseURL + 'posts' + appConfig.addURL;
    }
    else {
      return appConfig.baseURL + 'posts/' + 
        encodeURIComponent(this.attributes.id) + 
        appConfig.addURL;
    }
  },
});

var PostList = Backbone.Collection.extend({
  model: Post,
  url: function() {
    return appConfig.baseURL + 'posts' + appConfig.addURL;
  }
});</pre></div></li><li class="listitem">Define <code class="literal">PostDetailsView</code> and <code class="literal">PostDetailsPageView</code> in <code class="literal">js/views/post-details-page.js</code> and include this file in <code class="literal">index.html</code>.<div><pre class="programlisting">var PostDetailsView = Backbone.View.extend({
  initialize: function() {
    this.model.bind('change', this.render, this);
    this.template = $.tpl['post-details'];
  },

  render: function() {
    $(this.el).html(this.template(this.model.toJSON())).
      trigger('create');
    return this;
  },
});


var PostDetailsPageView = Backbone.View.extend({
  initialize: function () {
    this.template = $.tpl['post-details-page'];
  },

  render: function (eventName) {
    $(this.el).html(this.template(this.model.toJSON()));
    this.postDetailsView = new PostDetailsView({
      el: $('.post-details', this.el), model: this.model
    });

    return this;
  }
});</pre></div></li><li class="listitem">Add<a class="indexterm" id="id693"/> templates for all your views in <code class="literal">index.html</code>. This will make them load faster. The following code is a template for the view we defined previously:<div><pre class="programlisting">  &lt;script type="text/html" class="template"
          id="post-details-page"&gt;
    &lt;div data-role="header"&gt;
      &lt;h1&gt;Post Details&lt;/h1&gt;
      &lt;a href="#post/list" data-rel="back" data-theme="a"&gt;
        Back
      &lt;/a&gt;
      &lt;a href="#about" data-theme="a"&gt;About&lt;/a&gt;
    &lt;/div&gt;

    &lt;div data-role="content" class="post-details"&gt;&lt;/div&gt;

    &lt;div data-role="footer" data-position="fixed"&gt;
      &lt;div data-role="navbar" data-theme="a"&gt;
        &lt;ul&gt;
          &lt;li&gt;&lt;a href="#post/list" id="list-button"
                 data-icon="custom"&gt;
              View Posts
          &lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href="#post/add" id="add-button" 
                 data-icon="custom"&gt;
            Add Post&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href="#settings" id="settings-button" 
                 data-icon="custom"&gt;
            Settings
          &lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/script&gt;

  &lt;script type="text/html" class="template" id="post-details"&gt;
    &lt;h1&gt;&lt;%= title %&gt;&lt;/h1&gt;
    &lt;small&gt;Posted on &lt;%= created %&gt;.&lt;/small&gt;
    &lt;p&gt;&lt;%= body %&gt;&lt;/p&gt;

    &lt;a href="#post/delete/&lt;%= id %&gt;" name="delete-post"
      id="delete-post" data-role="button"&gt;Delete Post
    &lt;/a&gt;
  &lt;/script&gt;

  &lt;script type="text/html" class="template"
          id="post-list-item"&gt;
    &lt;div class="ui-btn-inner ui-li"&gt;
      &lt;div class="ui-btn-text"&gt;
        &lt;a class="ui-link-inherit"
           href="#post/details/&lt;%= id %&gt;"&gt;
          &lt;%= title %&gt;
          &lt;br&gt;&lt;small&gt;&lt;%= created %&gt;&lt;/small&gt;
        &lt;/a&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/script&gt;</pre></div></li><li class="listitem">Add<a class="indexterm" id="id694"/> views and templates to show other pages.</li><li class="listitem">Add styles in <code class="literal">index.html</code> to show the Glyphish icons at the bottom of the toolbar.<div><pre class="programlisting">#list-button span.ui-icon-custom {
  background:
    url(../lib/glyphish/152-rolodex.png) 0 0 no-repeat;
}

#add-button span.ui-icon-custom {
  background:
    url(../lib/glyphish/187-pencil.png) 0 0 no-repeat;
}

#settings-button span.ui-icon-custom {
  background: url(../lib/glyphish/20-gear2.png) 0 0 no-repeat;
}</pre></div></li><li class="listitem">Check<a class="indexterm" id="id695"/> the order of CSS and JS inclusions in <code class="literal">index.html</code>. It should look like the following code:<div><pre class="programlisting">  &lt;!-- CSS --&gt;
  &lt;link rel="stylesheet"
    href="lib/jquery.mobile/jquery.mobile-1.1.0.min.css"/&gt;
  &lt;link rel="stylesheet" href="lib/ios_inspired/styles.css"/&gt;
  &lt;link rel="stylesheet" href="css/styles.css"/&gt;

  &lt;!-- Libraries --&gt;
  &lt;script src="img/jquery.min.js"&gt;&lt;/script&gt;
  &lt;script src="img/jqm-config.js"&gt;&lt;/script&gt;
  &lt;script src="img/jquery.mobile-1.1.0.min.js"&gt;
  &lt;/script&gt;
  &lt;script src="img/underscore-min.js"&gt;&lt;/script&gt;
  &lt;script src="img/backbone-min.js"&gt;&lt;/script&gt;
  &lt;script src="img/backbone-mongodb.js"&gt;&lt;/script&gt;

  &lt;!-- Config --&gt;
  &lt;script src="img/app-config.js"&gt;&lt;/script&gt;

  &lt;!-- Template loader --&gt;
  &lt;script src="img/template-loader.js"&gt;&lt;/script&gt;

  &lt;!-- SMA models and views --&gt;
  &lt;script src="img/post.js"&gt;&lt;/script&gt;
  &lt;script src="img/post-list-page.js"&gt;&lt;/script&gt;
  &lt;script src="img/post-add-page.js"&gt;&lt;/script&gt;
  &lt;script src="img/post-details-page.js"&gt;&lt;/script&gt;
  &lt;script src="img/post-delete-dialog.js"&gt;&lt;/script&gt;
  &lt;script src="img/main-page.js"&gt;&lt;/script&gt;
  &lt;script src="img/settings-page.js"&gt;&lt;/script&gt;
  &lt;script src="img/about-page.js"&gt;&lt;/script&gt;

  &lt;!-- SMA main file and router --&gt;
  &lt;script src="img/main.js"&gt;&lt;/script&gt;</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec242"/>How it works...</h2></div></div></div><p>The main challenge of this recipe is to integrate jQuery Mobile with <code class="literal">Backbone.js</code>. Basically, there shouldn't be any problem unless you are trying to use the Backbone router. Both <code class="literal">Backbone.js</code> and jQuery Mobile provide their own routing mechanisms, which conflict with each other when used together.</p><p>The jQuery Mobile routing is enabled by default. You need to disable it manually if you want to use <code class="literal">Backbone.Router</code>. This is what we did in <code class="literal">js/jqm-comfig.js</code> in the previous section.</p><p>However, we still use jQuery Mobile to switch pages. To do this, we dynamically create a new page in the div and then call <code class="literal">$.mobile.changePage</code>, passing the new page element and other parameters. If transition effects are configured, animation is performed.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec243"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Please refer to the official jQuery Mobile resources:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://view.jquerymobile.com/1.3.1/dist/demos/">http://view.jquerymobile.com/1.3.1/dist/demos/</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://api.jquerymobile.com/">http://api.jquerymobile.com/</a></li></ul></div></li><li class="listitem" style="list-style-type: disc">A live demo of the preceding application is available online at <a class="ulink" href="http://dealancer.github.io/sma">http://dealancer.github.io/sma</a>. You can try it from your mobile device.</li><li class="listitem" style="list-style-type: disc">The source code of this application is available in the GitHub repository: <a class="ulink" href="https://github.com/dealancer/sma/">https://github.com/dealancer/sma/</a></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec85"/>Building an iOS/Android app with PhoneGap</h1></div></div></div><p>PhoneGap is a free <a class="indexterm" id="id696"/>and open source framework that allows building mobile applications from HTML/CSS/JavaScript. It supports iOS, Android, Windows Phone, Blackberry, and some other mobile platforms. Also, developers can get access to the mobile device features, such as camera, contacts, geolocation, and storage.</p><p>To build a mobile application, you need to download a specific version of PhoneGap for the mobile platform with you are working. Also, there is a premium online service named <strong>PhoneGap Build</strong><a class="indexterm" id="id697"/> that allows building mobile apps online. It integrates with GitHub and can extract recent version of the code.</p><p>In this recipe, we are going to build a mobile application with PhoneGap Build. It will be easy and cool.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec244"/>Getting ready...</h2></div></div></div><p>Please make sure you have created an account on the website <a class="ulink" href="https://build.phonegap.com/apps">https://build.phonegap.com/apps</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec245"/>How to do it...</h2></div></div></div><p>Perform the <a class="indexterm" id="id698"/>following steps to build an iOS/Android application with PhoneGap:</p><div><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">config.xml</code> file in the same directory where the <code class="literal">index.html</code> file is located.</li><li class="listitem">Save the following PhoneGap configuration in the XML format in <code class="literal">config.xml</code>.<div><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
    &lt;widget xmlns = "http://www.w3.org/ns/widgets"
        xmlns:gap = "http://phonegap.com/ns/1.0"
        id = "com.phonegap.example"
        versionCode ="1"
        version = "0.0.2"&gt;
    &lt;!-- versionCode is optional and Android only --&gt;

    &lt;preference name="phonegap-version" value="2.7.0" /&gt;

    &lt;name&gt;Social Mobile App&lt;/name&gt;

    &lt;description&gt;
      An example application to demonstrate Backbone.js and 
      jQueryMobile capabilities.
    &lt;/description&gt;

    &lt;author href="http://vmirgorod.name"
        email="dealancer@gmail.com"&gt;
        Vadim Mirgorod
    &lt;/author&gt;

    &lt;icon src="img/icon.png" gap:role="default" /&gt;

    &lt;preference name="orientation" value="portrait" /&gt;
&lt;/widget&gt;</pre></div></li><li class="listitem">Place the <code class="literal">icon.png</code> file with the application icon in the root directory.</li><li class="listitem">Go to <a class="ulink" href="https://build.phonegap.com/apps/">https://build.phonegap.com/apps/</a> and click on the <strong>+ new app</strong> button.<div><img alt="How to do it..." src="img/2728OS_08_05.jpg"/></div></li><li class="listitem">Enter the repository URL git://github.com/dealancer/sma.git in the form.<div><img alt="How to do it..." src="img/2728OS_08_06.jpg"/></div></li><li class="listitem">If you want to enter a non-GitHub account or upload an application from your machine, <a class="indexterm" id="id699"/>click on the <strong>Private</strong> tab. PhoneGap allows you to create one private application for free.</li><li class="listitem">After the project is pulled out from the GitHub repository, click on the <strong>Ready to Build</strong> button, which launches the building process for multiple platforms. To build an application for iOS or Blackberry, you are required to enter a developer's key.<div><img alt="How to do it..." src="img/2728OS_08_07.jpg"/></div></li><li class="listitem">Now, the project is ready to be downloaded. You can do it by scanning the QR code on <a class="indexterm" id="id700"/>a mobile device. The QR code contains a link to your application. However, for many platforms, you need to place the built app on a special application market<div><img alt="How to do it..." src="img/2728OS_08_08.jpg"/></div></li><li class="listitem">When you are ready to build a new version of the application, click on the <strong>Update Code</strong> button, and then click on the <strong>Rebuild All</strong> button.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec246"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Please refer to official PhoneGap docs at <a class="ulink" href="http://docs.phonegap.com/en/edge/index.html">http://docs.phonegap.com/en/edge/index.html</a></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec86"/>Organizing a project structure with Require.js</h1></div></div></div><p>In this recipe, <a class="indexterm" id="id701"/>we are going to use the <strong>Asynchronous Module Definition</strong> (<strong>AMD</strong>) technique<a class="indexterm" id="id702"/> that is implemented in <code class="literal">Require.js</code>, the JavaScript library, which helps to bring more order into your project. It allows you to define and load JavaScript modules dynamically from other parts of your code in a way similar to that in PHP using the <code class="literal">include</code> command. It can also optimize and uglify the JavaScript files so that they are loaded and executed faster.</p><p>We will take the <strong>Social Mobile Application</strong><a class="indexterm" id="id703"/> example from the previous recipe and will refactor it using the <code class="literal">Require.js</code> library.</p><p>The directory structure of our app will look like the following structure:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">css/</code><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">main.css</code></li></ul></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">js/</code><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">collection/</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">post.js</code></li></ul></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">model/</code><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">post.js</code></li></ul></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">view/</code><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">about-page.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">main-page.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">post-add-page.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">post-delete-dialog.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">post-details-page.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">post-list-page.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">settings-page.js</code></li></ul></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">app-config.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">app.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">jqm-config.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">router.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">template-loader.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">lib/</code><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">glyphish</code>/</li><li class="listitem" style="list-style-type: disc"><code class="literal">ios_inspired/</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">jquery</code>.<code class="literal">mobile/</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">backbone-mongodb.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">backbone.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">jquery.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">require.js</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">underscore.js</code></li></ul></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">config.xml</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">icon.png</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">index.html</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">README.md</code></li></ul></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec247"/>Getting ready...</h2></div></div></div><p>Download the<a class="indexterm" id="id704"/> <code class="literal">Require.js</code> file from <a class="ulink" href="http://www.requirejs.org/docs/download.html">http://www.requirejs.org/docs/download.html</a>, and place it in the <code class="literal">lib</code> directory.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec248"/>How to do it...</h2></div></div></div><p>Perform the <a class="indexterm" id="id705"/>following steps to organize the mobile application with <code class="literal">Require.js</code>:</p><div><ol class="orderedlist arabic"><li class="listitem">Extract the collection definition from <code class="literal">js/model/post.js</code> and place it in a separate file under the path <code class="literal">js/collection/post.js</code>.</li><li class="listitem">Remove all CSS inclusions from the <code class="literal">index.html</code> file, and keep only a single one that should contain links to others.<div><pre class="programlisting">@import url("../lib/jquery.mobile/jquery.mobile-1.1.0.min.css");
@import url("../lib/ios_inspired/styles.css");

// Custom styles
// ...</pre></div></li><li class="listitem">Remove all script inclusions from the <code class="literal">index.html</code> file and keep only the one that will load <code class="literal">Require.js</code>. Make sure to define the <code class="literal">data-main</code> attribute with a relative path to the main application file. No <code class="literal">.js</code> extension is required.<div><pre class="programlisting">&lt;script data-main="js/app"  src="img/require.js"&gt;&lt;/script&gt;</pre></div></li><li class="listitem">In the <code class="literal">js/app.js</code> file, add the <code class="literal">Require</code> configuration, which defines aliases to the libraries. <a class="indexterm" id="id706"/>We will use the other aliases later.<div><pre class="programlisting">require.config({

  paths: {
    jquery            : '../lib/jquery',
    'jquery.mobile':
     '../lib/jquery.mobile/jquery.mobile-1.1.0',
    underscore: '../lib/underscore',
    backbone: '../lib/backbone',
    'backbone-mongodb': '../lib/backbone-mongodb',
  }

});</pre></div></li><li class="listitem">Define module dependencies by adding the shim property into the <code class="literal">Require</code> configuration.<div><pre class="programlisting">  shim: {
    'backbone-mongodb': {
      deps: ['backbone'],
      exports: 'Backbone'
    },
    'backbone': {
      deps: ['underscore', 'jquery'],
      exports: 'Backbone'
    },
    'underscore': {
      exports: '_'
    },
    'jquery.mobile': ['jquery','jqm-config'],
    'jqm-config': ['jquery'],
    'jquery': {
      exports: '$',
    }
  }</pre></div><p>Here we make Require know about third-party library dependencies; for example, <code class="literal">jquery.mobile</code> requires <code class="literal">jquery</code> and <code class="literal">jqm-config</code>, and should have been loaded earlier. If you use standard JS libraries with no AMD support, you should define objects that are provided by those libraries (for example,. <code class="literal">$</code> in jQuery). This can be done by defining the object name in the <code class="literal">export</code> property.</p></li><li class="listitem">Add mapping<a class="indexterm" id="id707"/> settings into the <code class="literal">Require</code> configuration to load the <code class="literal">backbone-mongodb</code> object instead of the <code class="literal">backbone</code> object in all the JS files of your app; however, to load <code class="literal">backbone-mongodb</code>, we still need to load <code class="literal">backbone</code>.<div><pre class="programlisting">  map: {
    '*': {
      'backbone': 'backbone-mongodb',
    },
    'backbone-mongodb': {
      'backbone': 'backbone'
    }
  }</pre></div></li><li class="listitem">Add the <code class="literal">requirejs()</code> function<a class="indexterm" id="id708"/> call to <code class="literal">js/app.js</code> to start an application. The first parameter contains an array of modules that should be loaded, while the second parameter provides the callback function, which is executed. Parameters of such callback functions are objects returned by the modules defined in the first parameter of the <code class="literal">requirejs()</code> function.<div><pre class="programlisting">requirejs([ 'app-config', 'router' ],
function (appConfig, Router) {

  $(document).ready(function () {

    window.router = new Router();
    Backbone.history.start({ pushState : false });

  });

});</pre></div><p>The preceding code means that the <code class="literal">app-config.js</code> and <code class="literal">router.js</code> files will be included and implemented before executing the code in the callback function.</p></li><li class="listitem">Refactor all your custom JS files to be AMD compatible. Add the <code class="literal">define()</code> function call, which has a similar syntax as the <code class="literal">requirejs()</code> function. If the module provides an object (or value) to be used by other modules, such an object should be returned by the module. The <code class="literal">app-config.js</code> file will look like the following code:<div><pre class="programlisting">// Filename: app-config.js

define(['jquery', 'backbone'],
  function($, Backbone) {

    // Enable cross site scripting.
    $.support.cors = true;

    // Disable ajax cache.
    $.ajaxSetup({ cache: false });

    // Add support of MongoDB Extended JSON.
    _.extend(Backbone.Model.prototype,     
      Backbone.MongoModel.mixin);

    // Return app configuration.
    return {
      baseURL: 'https://api.mongolab.com/api/1/databases/
        social-mobile-app/collections/',
      addURL: '?apiKey=yGobEjzhT76Pjo9RaOLGfA89xCJXegpl'
    }
  }
);</pre></div></li><li class="listitem">Though the <code class="literal">Require.js</code> file can load templates from the text files, let's deal with the<a class="indexterm" id="id709"/> template loader we used before. It also needs to be AMD compatible.<div><pre class="programlisting">// Filename: template-loader.js

define(['jquery', 'underscore'],
  function($, _) {

    // Create global variable within jQuery object.
    var tpl = {};

    $('script.template').each(function(index) {

      // Load template from DOM.
      tpl[$(this).attr('id')] = _.template($(this).html());

      // Remove template from DOM.
      $(this).remove();
    });

    return tpl;
  }
);</pre></div></li><li class="listitem">Make<a class="indexterm" id="id710"/> sure all view files are refactored as well. They may look like the following code:<div><pre class="programlisting">// Filename: about-page.js

define(['jquery', 'backbone', 'template-loader'],
  function($, Backbone, tpl) {
    return Backbone.View.extend({
      initialize: function () {
        this.template = tpl['about-page'];
      },

      render: function (eventName) {
        $(this.el).html(this.template());
        return this;
      },
    });
  }
);</pre></div></li><li class="listitem">Make sure all the required module dependencies are included in the <code class="literal">router.js</code> file.<div><pre class="programlisting">// Filename: router.js

define([
  'jquery',
  'jquery.mobile',
  'backbone',
  'model/post',
  'collection/post',
  'view/about-page',
  'view/main-page',
  'view/post-add-page',
  'view/post-delete-dialog',
  'view/post-details-page',
  'view/post-list-page',
  'view/settings-page',
], function($, mobile, Backbone, PostModel, PostCollection,
      AboutPageView, MainPageView, PostAddPageView,
      PostDeleteDialogView, PostDetailsPageView,
      PostListPageView, SettingsPageView) {

  return Backbone.Router.extend({
    // Router code
  });
});</pre></div></li><li class="listitem">Remove the <code class="literal">main.js</code> file, because we have moved all functionality from it into the <code class="literal">app.js</code> and <code class="literal">router.js</code> files.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec249"/>How it works...</h2></div></div></div><p>The <code class="literal">Require.js</code> library provides two main functions, <code class="literal">define()</code> and <code class="literal">requirejs()</code>, to load other modules. The <a class="indexterm" id="id711"/>
<code class="literal">requirejs()</code> function is used to start an application. Both the functions have similar syntax. The first parameter is used to list all the libraries required by the current module, and the second parameter contains the callback function that is executed.</p><div><pre class="programlisting">define(['jquery', 'backbone', 'template-loader'],
  function($, Backbone, tpl) {

    return Backbone.View.extend({
      initialize: function () {
        this.template = tpl['about-page'];
      },

      render: function (eventName) {
        $(this.el).html(this.template());
        return this;
      },
    });
});</pre></div><p>Parameters of the callback function are objects/values returned by the libraries required by the module. They are listed in the same order as the modules required.</p><p>If the module defines an object that is required by other modules, it should return such an object.</p><p>If you are dealing with no AMD library, but it provides an object to be used by other modules of your app, you should define such objects in the<a class="indexterm" id="id712"/> <code class="literal">require.config()</code> function.</p><div><pre class="programlisting">require.config({
  shim: {
    'jquery': {
      exports: '$',
    }
  }
});</pre></div><p>If you need to make sure that the modules are always loaded in a specific order, you should define the dependencies in the<a class="indexterm" id="id713"/> <code class="literal">require.config()</code> function.</p><div><pre class="programlisting">require.config({
  shim: {
    'jquery.mobile': ['jquery','jqm-config'],
    'jqm-config': ['jquery'],
    'jquery': {
      exports: '$',
    }
  }
});</pre></div><p>By default, the <code class="literal">Require.js</code> file loads a library using the path relative to the main project directory. The <code class="literal">.js</code> extension is used when referencing of such libraries is skipped. There is also a way to define path aliases in the <code class="literal">require.config()</code> function.</p><div><pre class="programlisting">require.config({

  paths: {
    jquery            : '../lib/jquery',
    'jquery.mobile':
      '../lib/jquery.mobile/jquery.mobile-1.1.0',
  }

});</pre></div><p>When the application is started, the main application file runs and all the required modules and libraries are loaded in the correct order and according to the definition and configuration.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec250"/>There's more...</h2></div></div></div><div><div><div><div><h3 class="title"><a id="ch08lvl3sec64"/>Optimizing JS files with r.js</h3></div></div></div><p><code class="literal">R.js</code> is<a class="indexterm" id="id714"/> a submodule of <code class="literal">Require.js</code> that <a class="indexterm" id="id715"/>can optimize JavaScript or CSS files by combining them into a single file and minimizing it so that it is loaded and executed much faster.</p><p>To load our Social Mobile Application from the localhost, it takes the browser to perform 27 requests, <a class="indexterm" id="id716"/>which is about 308 milliseconds.</p><div><img alt="Optimizing JS files with r.js" src="img/2728OS_08_09.jpg"/></div><p>The same application, now optimized, is loaded with just 4 requests in 53 milliseconds.</p><div><img alt="Optimizing JS files with r.js" src="img/2728OS_08_10.jpg"/></div><p>Here, we see a six times boost in performance, which is a good result. Actually, that boost could be even <a class="indexterm" id="id717"/>bigger for larger projects, which are loaded over slow Internet connection.</p><p>To optimize your app, please perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Make sure you have <code class="literal">Node.js</code> and <code class="literal">npm</code> installed.</li><li class="listitem">Install <code class="literal">Require.js</code> as the Node module.<div><pre class="programlisting">
<strong>$ npm install -g requirejs</strong>
</pre></div></li><li class="listitem">Create a new subdirectory named src and move all project files there.</li><li class="listitem">Download <code class="literal">r.js</code> from <a class="ulink" href="http://www.requirejs.org/docs/download.html">http://www.requirejs.org/docs/download.html</a> and save it into the root project directory.</li><li class="listitem">Create the <code class="literal">app.build.js</code> file in the project root. This file should contain an <code class="literal">R.js</code> build configuration.<div><pre class="programlisting">({ 
    appDir: "./src", 
    baseUrl: "js", 
    dir: "build", 
    mainConfigFile: "src/js/app.js", 
    modules: [ 
        { 
            name: "app" 
        }, 
    ] 
}) </pre></div></li><li class="listitem">Execute the following command to build the project:<div><pre class="programlisting">
<strong>$ node r.js -o app.built.js</strong>
</pre></div><p>You can find the built application in the <code class="literal">build</code> directory.</p></li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec251"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Check out the official <code class="literal">Require.js</code> documentation at <a class="ulink" href="http://www.requirejs.org/">http://www.requirejs.org/</a></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec87"/>Ensuring compatibility with search engines</h1></div></div></div><p>When a <a class="indexterm" id="id718"/>search engine finds an AJAX-powered web application, it can't index such an app, because the search engine does not <a class="indexterm" id="id719"/>execute the complex JavaScript code. What the search engine wants is a static HTML.</p><p>In this recipe, we are going to learn how to make the search engine index the AJAX web application. We are going to deal mostly with Google, but we will also consider how to work with others.</p><p>The idea behind this recipe is that we can render the AJAX app into a static HTML page on the server and deliver it to a search engine spider via a proxy redirect.</p><p>To render JavaScript on the server, we are going to use the <code class="literal">Node.js</code> and <code class="literal">Phantom.js</code> files, which is a headless WebKit browser available as a Node module. We will also use a Node module named Seoserver<a class="indexterm" id="id720"/> that helps us to run <code class="literal">Phantom.js</code> and output the result.</p><p>To distinguish<a class="indexterm" id="id721"/> the search engine spider from a regular client and use a proxy redirect to the Seoserver, we will use Apache's <code class="literal">mod_rewrite</code><a class="indexterm" id="id722"/>, <code class="literal">mod_proxy</code><a class="indexterm" id="id723"/>, and <a class="indexterm" id="id724"/>
<code class="literal">mod_proxy_http</code> modules.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec252"/>Getting ready...</h2></div></div></div><p>Perform the <a class="indexterm" id="id725"/>following steps to get prepared for this recipe:</p><div><ol class="orderedlist arabic"><li class="listitem">Make sure you have <code class="literal">Node.js</code> and npm installed.</li><li class="listitem">Install <code class="literal">Phantom.js</code> as a Node module.<div><pre class="programlisting">
<strong>$ sudo npm install -g phantomjs</strong>
</pre></div></li><li class="listitem">Install Seoserver, which is also a Node module.<div><pre class="programlisting">
<strong>$ sudo npm install -g seoserver </strong>
</pre></div></li><li class="listitem">Make sure you have Apache installed.</li><li class="listitem">Make sure you have the following Apache extensions installed and configured: <code class="literal">mod_rewrite</code>, <code class="literal">mod_proxy</code>, and <code class="literal">mod_proxy_http</code>.</li><li class="listitem">Make sure you have permissions to override a configuration in the <code class="literal">.htaccess</code> files.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec253"/>How to do it...</h2></div></div></div><p>Perform the following steps to ensure compatibility with search engines:</p><div><ol class="orderedlist arabic"><li class="listitem">Tell <strong>Google</strong> bot<a class="indexterm" id="id726"/> to use <code class="literal">_escaped_fragement_</code> instead of <code class="literal">#!</code> by adding the following line into the header section of <code class="literal">index.html</code>.<div><pre class="programlisting">&lt;meta name="fragment" content="!"&gt; </pre></div><p>We will learn what it means later.</p></li><li class="listitem">Create the <code class="literal">.htaccess</code> file and place the following lines to perform the redirect operation via proxy to the Seoserver running on the 3000 port.<div><pre class="programlisting">&lt;IfModule mod_rewrite.c&gt;
 RewriteEngine on

 RewriteCond %{QUERY_STRING} ^_escaped_fragment_=(.*)$
 RewriteRule (.*) http://&lt;host&gt;:3000/&lt;path&gt;/index.html#%1? [P]
&lt;/IfModule&gt;</pre></div></li><li class="listitem">To redirect other search engines (for example, Yandex) to the Seoserver via proxy, add the following lines into the <code class="literal">.htaccess</code> file.<div><pre class="programlisting">RewriteCond %{HTTP_USER_AGENT} ^YandexBot
RewriteRule (.*) http://&lt;host&gt;:3000/&lt;path/&gt;index.html#%1?</pre></div></li><li class="listitem">Start <a class="indexterm" id="id727"/>the Seoserver by running the following command.<div><pre class="programlisting">
<strong>$ seoserver -p 3000 start &gt; seoserver.log</strong>
</pre></div></li><li class="listitem">Optionally, create a site map with URLs in the following format: <code class="literal">http://&lt;host&gt;/&lt;path&gt;index.html#!route</code></li><li class="listitem">You can check a result and see what the Google bot sees using the following link: <a class="ulink" href="http://support.google.com/webmasters/bin/answer.py?hl=en&amp;answer=158587">http://support.google.com/webmasters/bin/answer.py?hl=en&amp;answer=158587</a><div><div><h3 class="title"><a id="tip15"/>Tip</h3><p>You can also check the result manually by accessing <code class="literal">http://&lt;host&gt;/&lt;path&gt;index.html?_escaped_fragement_=route</code>. In this case, make sure you have disabled JavaScript in your browser to avoid any conflicts.</p></div></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec254"/>How it works...</h2></div></div></div><p>There is a <a class="indexterm" id="id728"/>way how <strong>Googlebot</strong><a class="indexterm" id="id729"/> understands that the site supports the AJAX crawling scheme. It simply tries to access the website using URL like <code class="literal">http://&lt;host&gt;/&lt;/path&gt;index.html#!route</code> and checks for any significant result. <code class="literal">#!</code> is used instead of <code class="literal">#</code> to indicate to the webmaster that it is exactly what Googlebot wants while trying to access the resource. Googlebot also scans the sitemap and tries to find URLs with the same URL scheme.</p><p>Webmaster should implement handling of such URLs and output the HTML snapshots that can be easily indexed by a search engine. In case if a URL with <code class="literal">#!</code> could not be processed by the server, it is allowed to use the following URL scheme: <code class="literal">http://&lt;host&gt;/&lt;/path&gt;index.html?_escaped_fragement_=route</code>. This should be indicated by adding a special meta tag in the HTML output.</p><div><pre class="programlisting">&lt;meta name="fragment" content="!"&gt;</pre></div><p>Such a URL scheme that is easily handled by Apache and Googlebot is redirected via the proxy to the server that outputs the HTML snapshot.</p><p>We will pass all parameters to the Seoserver, which is running on port 3000, and calls <code class="literal">phantom</code> to get the HTML snapshot of the requested resource.</p><p>Seoserver is written on <code class="literal">Node.js</code>. Let's see its sources in <code class="literal">seoserver.js</code>.</p><div><pre class="programlisting">var express = require('express');
var app = express();
var arguments = process.argv.splice(2);
var port = arguments[0] !== 'undefined' ? arguments[0] : 3000;
var getContent = function(url, callback) {
  var content = '';

  var phantom = require('child_process').spawn(
    'phantomjs', [__dirname + '/phantom-server.js', url]
  );

  phantom.stdout.setEncoding('utf8');
  phantom.stdout.on('data', function(data) {
    content += data.toString();
  });

  phantom.stderr.on('data', function (data) {
    console.log('stderr: ' + data);
  });

  phantom.on('exit', function(code) {
    if (code !== 0) {
      console.log('We have an error');
    } else {
      callback(content);
    }
  });
};

var respond = function (req, res) {
  res.eader("Access-Control-Allow-Origin", "*");
  res.eader(
    "Access-Control-Allow-Headers", "X-Requested-With"
  );

  var url;
  if(req.headers.referer) {
    url = req.headers.referer;

  }
  if(req.headers['x-forwarded-host']) {
    url = 'http://' + req.headers['x-forwarded-host'] + 
      req.params[0];

  };

  console.log('url:', url);

  getContent(url, function (content) {
    res.send(content);
  });
}

app.get(/(.*)/, respond);
app.listen(port);</pre></div><p>Seoserver also includes the <code class="literal">phantom-server.js</code> file with the following code:</p><div><pre class="programlisting">var page = require('webpage').create();
var system = require('system');
var lastReceived = new Date().getTime();
var requestCount = 0;
var responseCount = 0;
var requestIds = [];

page.viewportSize = { width: 1024, height: 768 };


page.onResourceReceived = function (response) {
    if(requestIds.indexOf(response.id) !== -1) {
        lastReceived = new Date().getTime();
        responseCount++;
        requestIds[requestIds.indexOf(response.id)] = null;
    }
};

page.onResourceRequested = function (request) {
    if(requestIds.indexOf(request.id) === -1) {
        requestIds.push(request.id);
        requestCount++;
    }
};

page.open(system.args[1], function () {


});


var checkComplete = function () {
  if(new Date().getTime() - lastReceived &gt; 300 &amp;&amp; requestCount 
      === responseCount)  {
    clearInterval(checkCompleteInterval);
    console.log(page.content);
    phantom.exit();
  } else {

  }
}
var checkCompleteInterval = setInterval(checkComplete, 1);</pre></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec255"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Check out the <a class="indexterm" id="id730"/>Seoserver source repository at <a class="ulink" href="https://github.com/apiengine/seoserver">https://github.com/apiengine/seoserver</a></li><li class="listitem" style="list-style-type: disc">To learn more about URL rewriting, please visit <a class="ulink" href="http://publib.boulder.ibm.com/httpserv/manual60/misc/rewriteguide.html">http://publib.boulder.ibm.com/httpserv/manual60/misc/rewriteguide.html</a></li><li class="listitem" style="list-style-type: disc">The<code class="literal"> Phantom.js</code> docs<a class="indexterm" id="id731"/> are available at <a class="ulink" href="https://github.com/ariya/phantomjs/wiki">https://github.com/ariya/phantomjs/wiki</a></li><li class="listitem" style="list-style-type: disc">Please refer to the Google Developers docs to learn more about AJAX app crawling at <a class="ulink" href="https://developers.google.com/webmasters/ajax-crawling/">https://developers.google.com/webmasters/ajax-crawling/</a></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec88"/>Avoiding memory leaks in a Backbone application</h1></div></div></div><p>A memory leak is a problem that <a class="indexterm" id="id732"/>can occur in a computer program due to incorrect memory allocation. In high-level object-oriented languages such as JavaScript, memory leak is often related to an object that is stored in the memory but isn't used by an application code. <a class="indexterm" id="id733"/>A memory leak can lead to a more serious problem such as exhausting the available system memory.</p><p>The following example demonstrates <a class="indexterm" id="id734"/>memory leak caused by a closure (anonymous function):</p><div><pre class="programlisting">var div = document.createElement("div");
div.onclick = function () {  }</pre></div><p>In the preceding code, a new HTML element is created and the <a class="indexterm" id="id735"/>
<code class="literal">onclick</code> callback is assigned to an anonymous function. Such a code produces a memory leak because <code class="literal">div</code> references to a closure, while closure references to a div since the div variable can be accessed in a closure scope. Such cyclic referencing can produce a memory leak because neither div nor closure is utilized by a garbage collector.</p><p>In this recipe, we will learn how to detect memory leaks in a Backbone application and how to fix them. We will use Google Chrome Heap Profiler, which is a part of the Google Chrome browser.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec256"/>Getting ready...</h2></div></div></div><p>In this recipe, we are going to take an example application from the recipe binding a collection to a view of <a class="link" href="ch05.html" title="Chapter 5. Events and Bindings">Chapter 5</a>, <em>Events and Binding</em> and modify it. Such modifications are not required in the production application <a class="indexterm" id="id736"/>but will help us to detect memory leaks using Google Chrome Heap Profiler.</p><div><ol class="orderedlist arabic"><li class="listitem">Add a named constructor to the <a class="indexterm" id="id737"/>each object in your program, which is extended from a standard Backbone object, such as Model or View. Inside this constructor, call a parent constructor.<div><ol class="orderedlist arabic"><li class="listitem">It could be much easier to detect memory leaks in Google Chrome Heap Profiler by finding object instances using their class names, which would only be possible if we defined such classes using named constructors.</li><li class="listitem">Following code shows the <a class="indexterm" id="id738"/><code class="literal">InvoiceItemModel</code> object with the named constructor defined.<div><pre class="programlisting">  var InvoiceItemModel = Backbone.Model.extend({
    calculateAmount: function() {
      return this.get('price') * this.get('quantity');
    },

    constructor: function InvoiceItemModel() {
      InvoiceItemModel.__super__.constructor.apply(
        this, arguments
      );
    }
  });</pre></div></li></ol></div></li><li class="listitem">Make sure your application code is performed in a global scope. This will make it easier to find Backbone objects in Google Chrome Heap Profiler. Contents of your <code class="literal">main.js</code> file shouldn't be enclosed by any function. The next few lines of code should be <a class="indexterm" id="id739"/>removed from your <code class="literal">main.js</code> file.<div><pre class="programlisting">(function($){
  $(document).ready(function () {

  });
})(jQuery);</pre></div><p>Inclusion of <code class="literal">main.js</code> into <code class="literal">index.html</code> should be performed in the <code class="literal">body</code> section as follows:</p><div><pre class="programlisting">&lt;body&gt;&lt;script src="img/main.js"&gt;&lt;/script&gt;&lt;/body&gt;</pre></div></li><li class="listitem">Modify <code class="literal">ControlsView</code> by adding a <a class="indexterm" id="id740"/>button which deletes <code class="literal">InvoiceItemsTableView</code> to demonstrate a memory leak. The following code explains how it works:<div><pre class="programlisting">  var ControlsView = Backbone.View.extend({
    render: function() {
      var html = '&lt;br&gt;&lt;input id="addModel" type="button" ' +
        'value="Add model" id&gt;&lt;input id="removeModel" ' +
        'type="button" value="Remove model"&gt;&lt;input ' +
        'id="removeTableView" type="button" ' +
        'value="Remove table view"&gt;';
      $(this.el).html(html);	

      return this;
    },

    // Handle HTML events.
    events: {
      'click #addModel': 'addNewInvoiceItemModel',
      'click #removeModel': 'removeInvoiceItemModel',
      'click #removeTableView': 'removeInvoiceItemTableView',
    },
//...

    // Remove a view button handler.
    removeInvoiceItemTableView: function() {
      this.options.invoiceItemTableView.remove(); 
    },
  });

  //...

  invoiceItemTableView = new InvoiceItemTableView({
    collection: invoiceItemCollection
  });

  $('body').append(invoiceItemTableView.render().el);

  $('body').append(new ControlsView({
    collection: invoiceItemCollection,
    invoiceItemTableView: invoiceItemTableView
  }).render().el);</pre></div></li></ol></div><p>Our prepared application <a class="indexterm" id="id741"/>should <a class="indexterm" id="id742"/>look like the following image:</p><div><img alt="Getting ready..." src="img/2728OS_08_11.jpg"/></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec257"/>How to do it…</h2></div></div></div><p>Perform the following steps to <a class="indexterm" id="id743"/>detect and to fix <a class="indexterm" id="id744"/>memory leaks in this application:</p><div><ol class="orderedlist arabic"><li class="listitem">Open a web application in the <strong>Chrome</strong> browser.</li><li class="listitem">Press the <em>F12</em> key to open <strong>Chrome DevTool</strong>.</li><li class="listitem">Click on the <strong>Profiles</strong> tab and select the <strong>Take Heap Snapshot</strong> item.<div><img alt="How to do it…" src="img/2728OS_08_12.jpg"/></div></li><li class="listitem">Click on the <strong>Take Snapshot</strong> button.</li><li class="listitem">Enter <code class="literal">Invoice</code> in the <strong>Class Filter</strong> field.</li><li class="listitem">You will see all the classes <a class="indexterm" id="id745"/>starting <a class="indexterm" id="id746"/>with an <code class="literal">Invoice</code> and an amount of their instances under the <strong>Objects Count</strong> column.<div><img alt="How to do it…" src="img/2728OS_08_13.jpg"/></div></li><li class="listitem">Click on the <strong>Remove table view</strong> button and <a class="indexterm" id="id747"/>take the heap snapshot once again to see a memory leak.</li><li class="listitem">You will see that <strong>Objects Count</strong> <a class="indexterm" id="id748"/>was not decreased for any class but should have been.<div><img alt="How to do it…" src="img/2728OS_08_14.jpg"/></div></li><li class="listitem">Delete any references to objects <a class="indexterm" id="id749"/>from <a class="indexterm" id="id750"/>other objects when those references aren't required.</li><li class="listitem">Delete references to the <a class="indexterm" id="id751"/><code class="literal">InvoiceItemsTableView</code> <a class="indexterm" id="id752"/>instance after we called the <code class="literal">remove()</code> method.<div><pre class="programlisting">  var ControlsView = Backbone.View.extend({

    // ...

    removeInvoiceItemTableView: function() {
      this.options.invoiceItemTableView.remove(); 
      delete this.options.invoiceItemTableView;
    },
  });</pre></div></li><li class="listitem">Delete all the child subviews when the parent view is removed.</li><li class="listitem">In the following code, when the new sub-view is created, we assign its remove method as a handler to the clear event of the parent view. In the <code class="literal">remove()</code> method of the <a class="indexterm" id="id753"/>parent view, we trigger the clear event.<div><pre class="programlisting">  var InvoiceItemTableView = Backbone.View.extend({
    
    // ...

    append: function(model) {
      var view = new InvoiceItemView({ model: model });

      $(this.el).append(
        view.render().el
      );

<strong>      view.listenTo(this, 'clear', this.remove);</strong>
    },

<strong>    remove: function() {</strong>
<strong>      this.trigger('clear'); </strong>

<strong>      return InvoiceItemTableView.__super__.remove.</strong>
<strong>     apply(</strong>
<strong>          this, arguments</strong>
<strong>        );</strong>
<strong>    }</strong>
  });</pre></div></li><li class="listitem">Use <code class="literal">listenTo()</code> <a class="indexterm" id="id754"/>method instead of <code class="literal">on()</code> to bind callbacks to the events.</li><li class="listitem">The <code class="literal">listenTo()</code> method keeps <a class="indexterm" id="id755"/>track of the bound events that unbinds them when the object is removed to make <a class="indexterm" id="id756"/>sure there is no any cyclic reference.<div><pre class="programlisting">  var InvoiceItemView = Backbone.View.extend({

    // ...

    initialize: function() {
      // Bind callback to destroy event of the model.
<strong>      this.listenTo(</strong>
<strong>        this.model, 'destroy', this.destroy, this</strong>
<strong>      );</strong>
    }
  });
  var InvoiceItemTableView = Backbone.View.extend({

    // ...

    initialize: function() {
      // Bind callback to add event of the collection.
      this.listenTo(
        this.collection, 'add', this.append, this
      );
    }
  });</pre></div></li><li class="listitem">Reload the page, remove the table view, and then create a new heap snapshot to make sure no invoice views are <a class="indexterm" id="id757"/>leaked. We can still see some models are kept in the memory, but it happens because they are used by <code class="literal">ControlsView</code>.<div><img alt="How to do it…" src="img/2728OS_08_15.jpg"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec258"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The JavaScript Garbage Collector <a class="indexterm" id="id758"/>is described at the following location: <a class="ulink" href="http://blogs.msdn.com/b/ericlippert/archive/2003/09/17/53038.aspx">http://blogs.msdn.com/b/ericlippert/archive/2003/09/17/53038.aspx</a></li><li class="listitem" style="list-style-type: disc">Memory leaks' patterns in JavaScript are <a class="indexterm" id="id759"/>described at the following location: <a class="ulink" href="http://www.ibm.com/developerworks/web/library/wa-memleak/">http://www.ibm.com/developerworks/web/library/wa-memleak/</a></li></ul></div></div></div></body></html>