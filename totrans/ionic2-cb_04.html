<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Validating Forms and Making HTTP Requests" id="aid-VF2I1"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Validating Forms and Making HTTP Requests</h1></div></div></div><p>In this chapter, we will cover the following tasks related to creating form input validation, mocked API calls, and payment pages using Stripe:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Creating a complex form with input validation</li><li class="listitem">Retrieving data via a mocked API using a static JSON file</li><li class="listitem">Integrating with Stripe for online payment</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec27"/>Introduction</h1></div></div></div><p>All mobile apps require taking user input and sending it to a backend server. A simple example is filling out a form, such as a user registration or contact form. The information is validated against a set of rules before being sent to the backend. Also, there are many other scenarios where the information is captured based on user behavior from the app, such as where they touch or how much time they spend on a certain page. Regardless, you will run into many send and retrieve data scenarios.</p><p>This chapter will cover the following three basic examples:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">How to validate user inputs, such as text, number, and required versus not required, and communicate the data to another page</li><li class="listitem">How to render data without having an actual backend</li><li class="listitem">How to process payments using Stripe</li></ul></div><p>All of these are actually available natively in Angular 2. However, since Angular 2 has a lot of changes compared to Angular 1 in terms of processing data and working with the backend server, it's worth covering these topics in detail.</p></div></div>
<div class="section" title="Creating a complex form with input validation"><div class="titlepage" id="aid-10DJ42"><div><div><h1 class="title"><a id="ch04lvl1sec28"/>Creating a complex form with input validation</h1></div></div></div><p>In this section, you <a id="id226" class="indexterm"/>will build an app to <a id="id227" class="indexterm"/>demonstrate form validation using <code class="literal">ngForm</code> and <code class="literal">ngControl</code>. Here is a screenshot of the form:</p><div class="mediaobject"><img src="../Images/image00248.jpeg" alt="Creating a complex form with input validation"/></div><p style="clear:both; height: 1em;"> </p><p>If the user tries to submit without providing valid information, the form will show the following error:</p><div class="mediaobject"><img src="../Images/image00249.jpeg" alt="Creating a complex form with input validation"/></div><p style="clear:both; height: 1em;"> </p><p>Basically, the <span class="strong"><strong>Name</strong></span> field is required. The <span class="strong"><strong>Phone</strong></span> field is the number type, but is optional. The <span class="strong"><strong>Comment</strong></span> field is required<a id="id228" class="indexterm"/> and the user must enter <a id="id229" class="indexterm"/>at least four characters. Of course, this is just for demonstration of the input length. The user, finally, must agree to the terms and conditions via the toggle input.</p><p>After a successful validation, the user will be taken to the second screen with a summary of the previous screen, as illustrated in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00250.jpeg" alt="Creating a complex form with input validation"/></div><p style="clear:both; height: 1em;"> </p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec58"/>Getting ready</h2></div></div></div><p>This app example could work either in a browser or on a physical device. However, you can optionally <a id="id230" class="indexterm"/>connect your physical device to verify the <span class="strong"><strong>Phone</strong></span> field for number keypad.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec59"/>How to do it…</h2></div></div></div><p>Observe the<a id="id231" class="indexterm"/> following the instructions:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new <code class="literal">MyFormValidation</code> app using the <code class="literal">blank</code> template, as shown, and go to the <code class="literal">MyFormValidation</code> folder:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  $ ionic start MyFormValidation blank --v2</strong></span>
<span class="strong"><strong>  $ cd MyFormValidation</strong></span>
</pre></div></li><li class="listitem">Open the <code class="literal">./src/app/app.module.ts</code> file and replace the content with the following code:<div class="informalexample"><pre class="programlisting">import { NgModule } from '@angular/core';
import { IonicApp, IonicModule } from 'ionic-angular';
import { MyApp } from './app.component';
import { HomePage } from '../pages/home/home';
import { ThankyouPage } from '../pages/thankyou/thankyou';
import { MyFormService } from '../services/myform';

@NgModule({
  declarations: [
    MyApp,
    HomePage,
    ThankyouPage
  ],
  imports: [
    IonicModule.forRoot(MyApp)
  ],
  bootstrap: [IonicApp],
  entryComponents: [
    MyApp,
    HomePage,
    ThankyouPage
  ],
  providers: [MyFormService]
})
export class AppModule {}</pre></div><p>You may realize that there is a common service to be used across the app, called <code class="literal">MyFormService</code> here. This example also has a second page, called <code class="literal">ThankyouPage</code>.</p></li><li class="listitem">Now, let's create the service by<a id="id232" class="indexterm"/> first creating a<a id="id233" class="indexterm"/> directory, as shown:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  $ mkdir ./src/services</strong></span>
</pre></div></li><li class="listitem">Create the <code class="literal">myform.js</code> file in the component's directory that you just created, as follows:<div class="informalexample"><pre class="programlisting">import {Injectable} from '@angular/core';

@Injectable()
export class MyFormService {
  public name: string = '';
  public phone: number;
  public comment: string = '';
  
  constructor() {
  }
}</pre></div><p>This example will keep the service component simple for demonstration purposes.</p></li><li class="listitem">Open and edit the <code class="literal">./src/pages/home/home.html</code> template, as shown:<div class="informalexample"><pre class="programlisting">&lt;ion-header&gt;
  &lt;ion-navbar color="primary"&gt;
    &lt;ion-title&gt;
      Contact Form
    &lt;/ion-title&gt;
  &lt;/ion-navbar&gt;
&lt;/ion-header&gt;

&lt;ion-content&gt;
  &lt;p class="center"&gt;
    &lt;ion-icon class="large lighter" primary name="contact"&gt;&lt;/ion-icon&gt;
  &lt;/p&gt;
  &lt;form #f="ngForm" novalidate (ngSubmit)="onSubmit(f)"&gt;
    &lt;ion-list&gt;

      &lt;ion-item&gt;
        &lt;ion-label floating&gt;Name&lt;/ion-label&gt;
        &lt;ion-input type="text" name="name" required [(ngModel)]="data.name"&gt;&lt;/ion-input&gt;
      &lt;/ion-item&gt;
      &lt;div [hidden]="f.controls.name &amp;&amp; (f.controls.name.valid || (f.controls.name.pristine &amp;&amp; !isSubmitted))" class="note danger"&gt;
        Name is required
      &lt;/div&gt;

      &lt;ion-item&gt;
        &lt;ion-label floating&gt;Phone&lt;/ion-label&gt;
        &lt;ion-input type="tel" name="phone" [(ngModel)]="data.phone"&gt;&lt;/ion-input&gt;
      &lt;/ion-item&gt;  
      
      &lt;ion-item&gt;
        &lt;ion-label floating&gt;Comment&lt;/ion-label&gt;
        &lt;ion-input type="text" required minlength=4 name="comment" [(ngModel)]="data.comment"&gt;&lt;/ion-input&gt;
      &lt;/ion-item&gt;
      &lt;div *ngIf="(isSubmitted &amp;&amp; f.controls.comment &amp;&amp; f.controls.comment.pristine) || ((f.controls.comment) &amp;&amp; (f.controls.comment.dirty &amp;&amp; f.controls.comment.errors))" class="note danger"&gt;
        Please enter {{ 4 - (f.controls.comment.errors.minlength ? f.controls.comment.errors.minlength.actualLength : 0) }} more characters
      &lt;/div&gt;
            
      &lt;ion-item class="tos"&gt;
        &lt;ion-toggle item-left [(ngModel)]="data.tos" name="tos" type="button" (click)="noSubmit($event)"&gt;&lt;/ion-toggle&gt;
        &lt;ion-label item-right&gt;Agree to terms and conditions&lt;/ion-label&gt;
      &lt;/ion-item&gt;
      
      &lt;div [hidden]="(!isSubmitted) || (f.controls.tos &amp;&amp; data.tos)" class="note danger"&gt;
        Please check Agree!
      &lt;/div&gt;

    &lt;/ion-list&gt;
    
    &lt;div class="center"&gt;
      &lt;button ion-button type="submit" round outline&gt;Submit&lt;/button&gt;
    &lt;/div&gt;
  &lt;/form&gt;

&lt;/ion-content&gt;</pre></div><p>This is probably<a id="id234" class="indexterm"/> the most complicated part of the form validation process because there are many places where you have to embed validation logic for the input.</p></li><li class="listitem">Open and replace<a id="id235" class="indexterm"/> the content of the <code class="literal">./src/pages/home/home.scss</code> file with the following code:<div class="informalexample"><pre class="programlisting">.center {
  text-align: center;
}

ion-icon.large {
  font-size: 7em;
}

ion-icon.lighter {
  opacity: 0.5;
}

ion-list &gt; .item:first-child {
  border-top: 0;
}

ion-list &gt; .item:last-child, ion-list &gt; ion-item-sliding:last-child .item {
  border-bottom: 0;
}

.tos {
  padding-top: 10px;
  
  ion-toggle {
    padding-left: 0px;  
  }
  .item-inner {
    border-bottom: 0;
  }
}

.item ion-toggle {
  padding-left: 0;
}

.note.danger {
  padding-left: 16px;
  color: #d14;
}</pre></div></li><li class="listitem">Open <code class="literal">./src/pages/home/home.ts</code> for editing <a id="id236" class="indexterm"/>with the following<a id="id237" class="indexterm"/> code:<div class="informalexample"><pre class="programlisting">import { Component } from '@angular/core';
import { NavController } from 'ionic-angular';
import { ThankyouPage } from '../thankyou/thankyou';
import { MyFormService } from '../../services/myform';

@Component({
  selector: 'page-home',
  templateUrl: 'home.html'
})
export class HomePage {
  private data: any;
  private isSubmitted: Boolean = false;
  
  constructor(public nav: NavController, private formData: MyFormService) {
    this.nav = nav;
    this.formData = formData;
    this.data = {
      name: '',
      phone: '',
      comment: '',
      tos: false
    }
  }
  
  onSubmit(myForm) {
    this.isSubmitted = true;
    console.log('onSubmit');
    console.log(myForm);
    
    if ((myForm.valid) &amp;&amp; (myForm.value.tos)) {
      this.formData.name = this.data.name;
      this.formData.phone = this.data.phone;
      this.formData.comment = this.data.comment; 
      this.nav.push(ThankyouPage);
    }
  }
  
  noSubmit(e) {
    e.preventDefault();
  }
}</pre></div><p>You may note that there isn't much validation code in the JavaScript part. This<a id="id238" class="indexterm"/> means that the<a id="id239" class="indexterm"/> template takes care of a lot of the validations. There is also an <code class="literal">import</code> command for a <code class="literal">thankyou</code> page, which you will have to create next.</p></li><li class="listitem">Now, let's create the <code class="literal">thankyou</code> folder, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  $ mkdir ./src/pages/thankyou</strong></span>
</pre></div></li><li class="listitem">Create a <code class="literal">thankyou.js</code> file in the component's directory that you just created, as shown:<div class="informalexample"><pre class="programlisting">import { Component } from '@angular/core';
import { MyFormService } from '../../services/myform'

@Component({
  templateUrl: 'thankyou.html'
})
export class ThankyouPage {
  
  constructor(private formData: MyFormService) {
    this.formData = formData;
  }

}</pre></div><p>This page just renders the data from the <code class="literal">MyFormService</code> service. So, you can keep it very simple.</p></li><li class="listitem">Create <code class="literal">thankyou.html</code> in<a id="id240" class="indexterm"/> the <code class="literal">./src/pages/thankyou</code>, folder, as illustrated:<div class="informalexample"><pre class="programlisting">&lt;ion-header&gt;
  &lt;ion-navbar color="secondary"&gt;
    &lt;ion-title&gt;
      Thank You
    &lt;/ion-title&gt;
  &lt;/ion-navbar&gt;
&lt;/ion-header&gt;

&lt;ion-content&gt;
  &lt;h6 class="padding"&gt;
    You submitted the following information
  &lt;/h6&gt;
  
  &lt;div class="my-table"&gt;
    &lt;ion-row&gt;
      &lt;ion-col width-25 class="my-label"&gt;Name&lt;/ion-col&gt;
      &lt;ion-col width-75&gt;{{ formData.name }}&lt;/ion-col&gt;
    &lt;/ion-row&gt;
    &lt;ion-row&gt;
      &lt;ion-col width-25 class="my-label"&gt;Phone&lt;/ion-col&gt;
      &lt;ion-col width-75&gt;{{ formData.phone }}&lt;/ion-col&gt;
    &lt;/ion-row&gt;
    &lt;ion-row&gt;
      &lt;ion-col width-25 class="my-label"&gt;Comment&lt;/ion-col&gt;
      &lt;ion-col width-75&gt;{{ formData.comment }}&lt;/ion-col&gt;
    &lt;/ion-row&gt;
  &lt;/div&gt;  
&lt;/ion-content&gt;</pre></div></li><li class="listitem">Create <code class="literal">thankyou.scss</code> in the <code class="literal">./src/pages/thankyou</code> folder, as<a id="id241" class="indexterm"/> shown:<div class="informalexample"><pre class="programlisting">h6.padding {
  color: #4C555A;
  padding: 10px;
}

.my-label {
  text-align: right;
  font-weight: bold;
}

.my-table {
  ion-row {
    color: #4C555A;
    padding: 0;
    height: 30px;
  }
  
  ion-row + ion-row {
    margin-top: 0;
  }
  
  ion-row:nth-child(odd) ion-col {
    background: #F9FAFB;
  }
}</pre></div></li><li class="listitem">Edit the <code class="literal">./app/app.scss</code> file to ensure that you include both the <code class="literal">.scss</code> files in the two pages, as<a id="id242" class="indexterm"/> follows:<div class="informalexample"><pre class="programlisting">@import '../pages/home/home';
@import '../pages/thankyou/thankyou';</pre></div></li><li class="listitem">Go to your Terminal and run the app with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  $ ionic serve</strong></span>
</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec60"/>How it works…</h2></div></div></div><p>Let's start<a id="id243" class="indexterm"/> with the <code class="literal">home.html</code> file, where most of the validation code is located. If you look at the structure of this page, it's very typical. You have <code class="literal">&lt;ion-navbar&gt;</code> with <code class="literal">&lt;ion-title&gt;</code>. The <code class="literal">&lt;form&gt;</code> element must be inside the <code class="literal">&lt;ion-content&gt; </code>area.</p><div class="note" title="Note"><h3 class="title"><a id="tip12"/>Tip</h3><p>It's a requirement to use the <code class="literal">&lt;form&gt;</code> element for Angular 2 validation to work. Otherwise, there will be no <code class="literal">submit</code> event and you cannot catch errors for each input.</p></div><p>
<code class="literal">form</code> has the following attributes:</p><div class="informalexample"><pre class="programlisting">&lt;form #f="ngForm" novalidate (ngSubmit)="onSubmit(f)"&gt;</pre></div><p>To assign a local variable <span class="emphasis"><em>on the fly</em></span>, you use the <code class="literal">#</code> sign. This means that you want the <code class="literal">f</code> variable to refer to <code class="literal">ngForm</code>, which is automatically created from Angular 2. This is a special object that contains everything related to the current form. You are advised to use <code class="literal">novalidate</code> to bypass the default HTML5 validation because you are using Angular 2 for validation instead. Otherwise, the <code class="literal">form</code> will acquire conflicts. The <code class="literal">(ngSubmit)</code> is pretty much an event to trigger the <code class="literal">onSubmit(f)</code> function whenever the <code class="literal">button</code> with <code class="literal">type=submit</code> is touched or clicked. When you submit the form, it will pass the <code class="literal">f</code> variable along so that you can process the object inside the <code class="literal">onSubmit</code> method.</p><p>The <code class="literal">form</code> template <a id="id244" class="indexterm"/>consists of just <code class="literal">&lt;ion-list&gt;</code> and <code class="literal">&lt;ion-item&gt;</code>. You just need to know how to validate each input and display the error. Let's use<a id="id245" class="indexterm"/> the <code class="literal">Name</code> field as the first example. This is the <code class="literal">&lt;ion-input&gt;</code> for <code class="literal">Name</code>:</p><div class="informalexample"><pre class="programlisting">&lt;ion-input type="text" name="name" required [(ngModel)]="data.name"&gt;&lt;/ion-input&gt;</pre></div><p>The following is the error displayed:</p><div class="informalexample"><pre class="programlisting">&lt;div [hidden]="f.controls.name &amp;&amp; (f.controls.name.valid || (f.controls.name.pristine &amp;&amp; !isSubmitted))" class="note danger"&gt;
  Name is required
&lt;/div&gt;</pre></div><p>To validate, you must assign <code class="literal">name</code> a local variable name. This is to refer to that input using <code class="literal">f.controls.name</code> in other areas. Recall that the <code class="literal">f</code> variable has been declared previously as the <code class="literal">ngForm</code> object. Here is a view of how the <code class="literal">ngForm</code> is structured:</p><div class="mediaobject"><img src="../Images/image00251.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p><p>You can view this using the Chrome Developer console because the code actually gives this output when <a id="id246" class="indexterm"/>you submit the form.</p><p>The error message <code class="literal">Name is required</code> will be hidden when either of the following conditions takes place:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The form has <a id="id247" class="indexterm"/>not been submitted yet. Otherwise, people will see the error message right away before they even type in something. This is not a good user experience. To check for this, you have to use a temporary Boolean, called <code class="literal">isSubmitted</code>. The <code class="literal">f.controls.name.pristine</code> variable means that the input has not been modified. The opposite of this would be <code class="literal">f.controls.name.dirty</code>.</li><li class="listitem">The <code class="literal">f.controls.name.valid</code> variable is <code class="literal">true</code>. However, you cannot check this right away because, if the input is empty, the <code class="literal">name</code> object does not exist yet. That's why you need to check for the existence of <code class="literal">f.controls.name</code> before checking for the <code class="literal">valid</code> Boolean.</li></ul></div><p>There is no need to check the phone requirement; so, you just need to assign <code class="literal">name</code> and a model, as shown:</p><div class="informalexample"><pre class="programlisting">&lt;ion-input type="tel" name="phone" [(ngModel)]="data.phone"&gt;&lt;/ion-input&gt;</pre></div><p>For the <code class="literal">Comment</code> field, there is a need to validate using both <code class="literal">required</code> and <code class="literal">minlength=4</code>, as follows:</p><div class="informalexample"><pre class="programlisting">&lt;ion-input type="text" required minlength=4 name="comment" [(ngModel)]="data.comment"&gt;&lt;/ion-input&gt;</pre></div><p>You may think <code class="literal">required</code> is unnecessary because, if the length is zero, Angular 2 will trigger an error flag. However, that is not true. When the user doesn't enter anything in the input, the input will have no length because the variable doesn't exist. That's why you need to check for both scenarios.</p><p>The error message for the <code class="literal">Comment</code> field is quite interesting because it shows the number of characters the user needs to enter, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">&lt;div *ngIf="(isSubmitted &amp;&amp; f.controls.comment &amp;&amp; f.controls.comment.pristine) || ((f.controls.comment) &amp;&amp; (f.controls.comment.dirty &amp;&amp; f.controls.comment.errors))" class="note danger"&gt;
  Please enter {{ 4 - (f.controls.comment.errors.minlength ? f.controls.comment.errors.minlength.actualLength : 0) }} more characters
&lt;/div&gt;</pre></div><p>The main idea<a id="id248" class="indexterm"/> here is that you only want to show this <code class="literal">div</code> when the form is submitted and it's pristine via <code class="literal">f.controls.comment.pristine</code>. This means that the user has not entered anything in the form. You also want to show the message when the form is dirty and has errors via <code class="literal">f.controls.comment.errors</code>. If you inspect the console, you can see a list of many detailed errors under the <code class="literal">f.controls.comment.errors</code> object. In order to tell the user how many characters they have left to enter, you have to first check <code class="literal">f.controls.comment.errors.minlength</code> because, if that variable doesn't exist, there is no error or the <code class="literal">comment</code> input is empty. If you do not check for this, you will get a parse error later on.</p><p>In your <code class="literal">home.ts</code> file, the <code class="literal">onSubmit</code> method must toggle the <code class="literal">isSubmitted</code> Boolean to <code class="literal">true</code>, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">onSubmit(myForm) {
  this.isSubmitted = true;
  console.log('onSubmit');
  console.log(myForm);
  
  if ((myForm.valid) &amp;&amp; (myForm.value.tos)) {
    this.formData.name = this.data.name;
    this.formData.phone = this.data.phone;
    this.formData.comment = this.data.comment;
    this.nav.push(ThankyouPage);
  }
}</pre></div><p>Then, you have to<a id="id249" class="indexterm"/> do a general check for <code class="literal">myForm.valid</code> and <code class="literal">myForm.value.tos</code>. You may wonder why we are checking for <code class="literal">tos</code> here instead of validating it inside the template. The reason is that there is no way to validate a toggle button in Angular 2 since it doesn't make sense to do so as it cannot be <code class="literal">required</code>. Therefore, you have to do a custom validation here to make sure it's <code class="literal">true</code> in the form. This means that the user has checked the <span class="strong"><strong>Agree to terms and conditions</strong></span> toggle.</p><p>This is a minor detail that <a id="id250" class="indexterm"/>could be a bug in Ionic 2 (currently Beta 21):</p><div class="informalexample"><pre class="programlisting">noSubmit(e) {
  e.preventDefault();
}</pre></div><p>For each toggle button, it acts as a <code class="literal">type=submit</code> button by default since there is no <code class="literal">type</code> attribute assigned. That's why you need to cancel the <code class="literal">submit</code> event by calling <code class="literal">preventDefault()</code>.</p><div class="note" title="Note"><h3 class="title"><a id="tip13"/>Tip</h3><p>Refer to the <a id="id251" class="indexterm"/>W3 website, at <a class="ulink" href="https://www.w3.org/TR/html-markup/button.html">https://www.w3.org/TR/html-markup/button.html</a>, for information about the default behavior of the <code class="literal">button</code> element.</p></div><p>The <code class="literal">thankyou</code> page is very self-explanatory because you just parse the <code class="literal">formData</code> object in the template by getting the data from the <code class="literal">MyFormService</code> service.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec61"/>See also</h2></div></div></div><p>Check out the<a id="id252" class="indexterm"/> following links for more information:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">For more<a id="id253" class="indexterm"/> information about <code class="literal">form</code> from the Angular 2 documentation, you can visit <a class="ulink" href="https://angular.io/docs/ts/latest/guide/forms.html%20">https://angular.io/docs/ts/latest/guide/forms.html </a>and <a class="ulink" href="https://angular.io/docs/ts/latest/api/forms/index/NgForm-directive.html">https://angular.io/docs/ts/latest/api/forms/index/NgForm-directive.html</a></li><li class="listitem">The Ionic <a id="id254" class="indexterm"/>documentation has its own page specifically for Ionic input components, which is <a class="ulink" href="https://ionicframework.com/docs/v2/resources/forms/">https://ionicframework.com/docs/v2/resources/forms/</a></li><li class="listitem">It also has a <a id="id255" class="indexterm"/>good list of HTML5 input types that you can use for validation or keyboard enforcement, which you can find at <a class="ulink" href="http://ionicframework.com/html5-input-types/">http://ionicframework.com/html5-input-types/</a></li></ul></div></div></div>
<div class="section" title="Retrieving data via a mocked API using a static JSON file"><div class="titlepage" id="aid-11C3M2"><div><div><h1 class="title"><a id="ch04lvl1sec29"/>Retrieving data via a mocked API using a static JSON file</h1></div></div></div><p>As a frontend and<a id="id256" class="indexterm"/> app developer, you are often working with a team where someone else is responsible for the backend APIs. However, it's not always possible to have the backend available when you are developing the frontend. You have to <span class="emphasis"><em>simulate</em></span> the backend in scenarios where the final backend APIs are not ready.</p><p>In this recipe, you will learn<a id="id257" class="indexterm"/> how to call a REST API using the <code class="literal">http</code> service. The API endpoint will be just a static JSON located on your local machine. You will also learn how to leverage placeholder images to meet design requirements. The app will show a list of image feeds and a description, as shown in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00252.jpeg" alt="Retrieving data via a mocked API using a static JSON file"/></div><p style="clear:both; height: 1em;"> </p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec62"/>Getting ready</h2></div></div></div><p>This app example<a id="id258" class="indexterm"/> would work either in a<a id="id259" class="indexterm"/> browser or on a physical device. However, the <span class="emphasis"><em>fake</em></span> backend server must be running on your local computer.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec63"/>How to do it...</h2></div></div></div><p>Here are the instructions to be followed:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, let's quickly create the <span class="emphasis"><em>fake</em></span> backend server. You must install <code class="literal">http-server</code> for this:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  $ sudo npm install -g http-server</strong></span>
</pre></div></li><li class="listitem">Create a folder to store your <code class="literal">.json</code> file. Let's call it <code class="literal">MockRest</code>, as shown:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  $ mkdir MockRest</strong></span>
<span class="strong"><strong>  $ cd MockRest</strong></span>
</pre></div></li><li class="listitem">Create<a id="id260" class="indexterm"/> the <code class="literal">test.json</code> file and fill in the following content for the REST response:<div class="informalexample"><pre class="programlisting">[
  {
    "title": "What a beautiful song",
    "category": "objects",
    "description": "Music is a moral law. It gives soul to the universe, wings to the mind, flight to the imagination, and charm and gaiety to life and to everything."
  },
  {
    "title": "The world we live in",
    "category": "nature",
    "description": "Look deep into nature, and then you will understand everything better."
  },
  {
    "title": "Life experiences",
    "category": "people",
    "description": "People who know little are usually great talkers, while men who know much say little."
  }
]</pre></div><p>Basically, whenever <a id="id261" class="indexterm"/>you send a REST request, you should receive the preceding content as the response. As your backend developer updates the REST response, you can always change the content of the <code class="literal">test.json</code> file accordingly.</p></li><li class="listitem">Start your backend server by calling <code class="literal">http-server</code> from the Terminal in the <code class="literal">MockRest</code> folder, as shown:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  $ http-server --cors=Access-Control-Allow-</strong></span>
</pre></div></li><li class="listitem">isit <code class="literal">http://localhost:8080/test.json</code> to verify that you can<a id="id262" class="indexterm"/> see the JSON content. If not, you probably have a port conflict with another web server. You need to ensure that there is no other application using port <code class="literal">8080</code>.</li><li class="listitem">After completing your backend, open another Terminal window, create a new <code class="literal">MyRestBackend</code> app using the <code class="literal">blank</code> template, and go to the <code class="literal">MyRestBackend</code> folder, as shown:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  $ ionic start MyRestbackend blank --v2</strong></span>
<span class="strong"><strong>  $ cd MyRestbackend</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title"><a id="tip14"/>Tip</h3><p>You must not <a id="id263" class="indexterm"/>stop the backend server or create an Ionic project inside the <code class="literal">MockRest</code> folder. They are two independent project folders.</p></div></li><li class="listitem">Open the <code class="literal">html.html</code> file and replace the<a id="id264" class="indexterm"/> content with the following code:<div class="informalexample"><pre class="programlisting">&lt;ion-header&gt;
  &lt;ion-navbar&gt;
    &lt;ion-title&gt;
      Home
    &lt;/ion-title&gt;
  &lt;/ion-navbar&gt;
&lt;/ion-header&gt;

&lt;ion-content padding&gt;
  &lt;ion-card #myCard *ngFor="let item of quotes.data"&gt;
    &lt;img [src]='"https://source.unsplash.com/category/" + item.category + "/600x390"' [height]="myCard.clientWidth * 390 / 600"/&gt;
    &lt;ion-card-content&gt;
      &lt;ion-card-title&gt;
        {{ item.title }}
      &lt;/ion-card-title&gt;
      &lt;p&gt;
        {{ item.description }}
      &lt;/p&gt;
    &lt;/ion-card-content&gt;
  &lt;/ion-card&gt;
&lt;/ion-content&gt;</pre></div><p>This app example uses free photos from <a class="ulink" href="https://source.unsplash.com/">https://source.unsplash.com/</a> because you can easily query to get random photos that meet your need.</p></li><li class="listitem">Open <code class="literal">home.ts</code> and edit it<a id="id265" class="indexterm"/> with the following code:<div class="informalexample"><pre class="programlisting">import { Component } from '@angular/core';
import { NavController } from 'ionic-angular';
import { QuoteService } from '../../services/quote'

@Component({
  selector: 'page-home',
  templateUrl: 'home.html'
})
export class HomePage {

  constructor(public navCtrl: NavController, public quotes: QuoteService) {
    this.quotes = quotes;
    this.quotes.getQuotes();    
  }

}</pre></div><p>You have not created the <code class="literal">QuoteService</code> service yet. However, you probably know that this service will call the <span class="emphasis"><em>fake</em></span> backend server to get the JSON content using the <code class="literal">getQuotes()</code> method.</p></li><li class="listitem">Do a small<a id="id266" class="indexterm"/> modification of the stylesheet <code class="literal">home.scss</code>, as follows:<div class="informalexample"><pre class="programlisting">ion-card {
  img {
    background-color: #f4f4f4;
  }
}</pre></div></li><li class="listitem">Create the <code class="literal">./src/services</code> folder with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  $ mkdir ./src/services</strong></span>
</pre></div></li><li class="listitem">Create the <code class="literal">quote.ts</code> file in the <code class="literal">services</code> folder and copy the following code:<div class="informalexample"><pre class="programlisting">import { Injectable } from '@angular/core';
import { Http } from '@angular/http';

@Injectable()
export class QuoteService {
  private http: any;
  public data: any;
  
  constructor(http: Http) {
    this.http = http;
  }
  
  getQuotes() {
    this.http.get("http://localhost:8080/test.json")
      .subscribe(res =&gt; {
        this.data = res.json();
        console.log(this.data);
      }, error =&gt; {
        console.log(error);
      });
  }
  
}</pre></div></li><li class="listitem">Open<a id="id267" class="indexterm"/> and edit <code class="literal">./src/app/app.module.ts</code> to declare <code class="literal">QuoteService</code>, as <a id="id268" class="indexterm"/>shown:<div class="informalexample"><pre class="programlisting">import { NgModule } from '@angular/core';
import { IonicApp, IonicModule } from 'ionic-angular';
import { MyApp } from './app.component';
import { HomePage } from '../pages/home/home';
import { QuoteService } from '../services/quote'

@NgModule({
  declarations: [
    MyApp,
    HomePage
  ],
  imports: [
    IonicModule.forRoot(MyApp)
  ],
  bootstrap: [IonicApp],
  entryComponents: [
    MyApp,
    HomePage
  ],
  providers: [QuoteService]
})
export class AppModule {}</pre></div></li><li class="listitem">Go to your Terminal and run the app, as illustrated:<div class="informalexample"><pre class="programlisting">$ ionic serve</pre></div></li><li class="listitem">You will note that the page is empty and the <span class="strong"><strong>Console</strong></span> shows the following error:<div class="mediaobject"><img src="../Images/image00253.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>This<a id="id269" class="indexterm"/> means that your<a id="id270" class="indexterm"/> browser (in this case, Chrome) does not allow calling REST API from <code class="literal">http://localhost:8100</code> to <code class="literal">http://localhost:8080</code>. You need to<a id="id271" class="indexterm"/> install the <span class="strong"><strong>Allow-Control-Allow-Origin</strong></span> (<span class="strong"><strong>CORS</strong></span>) plugin, such as <a class="ulink" href="https://chrome.google.com/webstore/detail/allow-control-allow-origi/nlfbmbojpeacfghkpbjhddihlkkiljbi?hl=en">https://chrome.google.com/webstore/detail/allow-control-allow-origi/nlfbmbojpeacfghkpbjhddihlkkiljbi?hl=en</a>, for Chrome. After that, turn on CORS, as shown in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00254.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Refresh your browser to see the updated app.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec64"/>How it works…</h2></div></div></div><p>Your <span class="emphasis"><em>fake</em></span> backend simply<a id="id272" class="indexterm"/> returns any file in the current <code class="literal">MockRest</code> folder. As you get more <span class="emphasis"><em>sample</em></span> responses from the backend <a id="id273" class="indexterm"/>developer, you can copy them into this folder to provide additional backend endpoints.</p><div class="note" title="Note"><h3 class="title"><a id="note07"/>Note</h3><p>This section does not provide examples of how to handle POST and complex scenarios where the responses depend on request parameters. You may want to keep the code to handle temporary cases as simple as possible since they are not production code. The recommendation is to return the same content for each POST request as well.</p></div><p>Let's take a look at <code class="literal">quote.ts</code>, because it's the main place where the <code class="literal">Http</code> request is made. First, you need to import <code class="literal">Injectable</code> and <code class="literal">Http</code>, which you can do as follows:</p><div class="informalexample"><pre class="programlisting">import {Injectable} from '@angular/core';
import {Http} from '@angular/http';</pre></div><p>The <code class="literal">@Injectable</code> decorator is used to allow other pages and components to use <code class="literal">QuoteService</code> as a dependency. The <code class="literal">Http</code> service (or class) is provided by Angular 2 (not Ionic 2) and this<a id="id274" class="indexterm"/> is similar to the <code class="literal">$http</code> provider in Angular 1. However, instead of returning a promise, <code class="literal">Http</code> will return an <a id="id275" class="indexterm"/>
<span class="strong"><strong>observable</strong></span> object so that you can <span class="emphasis"><em>subscribe</em></span> to it. The <code class="literal">getQuotes()</code> method, shown as follows, is the most important part of this file:</p><div class="informalexample"><pre class="programlisting">  getQuotes() {
    this.http.get("http://localhost:8080/test.json")
      .subscribe(res =&gt; {
        this.data = res.json();
        console.log(this.data);
      }, error =&gt; {
        console.log(error);
      });
  }</pre></div><p>The <code class="literal">this.http</code> object must<a id="id276" class="indexterm"/> be injected from the constructor. Then, it will trigger GET via <code class="literal">this.http.get()</code>, just like the <code class="literal">$http</code> provider. However, there is no <code class="literal">.then()</code> function but in Angular 2; you have to <code class="literal">subscribe</code> to the object. A new feature of ES6 is the <span class="emphasis"><em>arrow</em></span> function, as you see via <code class="literal">res =&gt; {}</code>. This is similar to the lambda function in other languages (for example, Python). There is no need to declare the name of the function and you don't have to type <span class="emphasis"><em>function</em></span> each time. In addition, it automatically passes the parameter (<code class="literal">res</code> in this case) and the <code class="literal">this</code> context inside the function.</p><div class="note" title="Note"><h3 class="title"><a id="note08"/>Note</h3><p>You can read more<a id="id277" class="indexterm"/> about the arrow function from TypeScript documentation at <a class="ulink" href="https://www.typescriptlang.org/docs/handbook/functions.html">https://www.typescriptlang.org/docs/handbook/functions.html</a>.</p></div><p>The REST response from your <span class="emphasis"><em>fake</em></span> backend will be assigned to <code class="literal">this.data</code> of the <code class="literal">QuoteService</code> service, as shown:</p><div class="informalexample"><pre class="programlisting">this.data = JSON.parse(res._body);</pre></div><p>If you see the browser console, it will look similar to the following screenshot:</p><div class="mediaobject"><img src="../Images/image00255.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p><p>Another nice<a id="id278" class="indexterm"/> trick in the <code class="literal">home.html</code> template is to display a gray placeholder for the photos instead of pushing down the content when<a id="id279" class="indexterm"/> the photos are downloaded and rendered, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">&lt;ion-card #myCard *ngFor="let item of quotes.data"&gt;
    &lt;img [src]='"https://source.unsplash.com/category/" + item.category + "/600x390"' [height]="myCard.clientWidth * 390 / 600"/&gt;</pre></div><p>The following screenshot shows a quick example before the photos are loaded:</p><div class="mediaobject"><img src="../Images/image00256.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p><p>In order to<a id="id280" class="indexterm"/> tell the <code class="literal">&lt;img&gt;</code> tag to have an exact size, you have to do a height calculation using <code class="literal">[height]="myCard.clientWidth * 390 / 600"</code>. This is because the photo is 600 x 390. The <code class="literal">myCard</code> object is a local object created from <code class="literal">ion-card</code>. This <code class="literal">myCard</code> object will have access to all <a id="id281" class="indexterm"/>properties of the <code class="literal">ion-card</code> DOM, including the width via <code class="literal">clientWidth</code>. You have probably noted that this is just pure JavaScript and has nothing to do with Ionic or Angular itself.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec65"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">For more<a id="id282" class="indexterm"/> information <a id="id283" class="indexterm"/>about the<a id="id284" class="indexterm"/> Angular 2 <code class="literal">Http</code> provider, you can visit the official documentation at <a class="ulink" href="https://angular.io/docs/ts/latest/api/http/index/HttpModule-class.html">https://angular.io/docs/ts/latest/api/http/index/HttpModule-class.html</a></li></ul></div></div></div>
<div class="section" title="Integrating with Stripe for online payment"><div class="titlepage" id="aid-12AK82"><div><div><h1 class="title"><a id="ch04lvl1sec30"/>Integrating with Stripe for online payment</h1></div></div></div><p>In this section, you <a id="id285" class="indexterm"/>will learn how to integrate with a real backend service for the payment process. Earning revenue is an important aspect of <a id="id286" class="indexterm"/>creating an app. While there are many other methods of collecting payment, Stripe is a common payment system and can integrate very well with Ionic. In addition, there is no need to provide a high level of security and compliance (that is, PCI) since you will not be <span class="emphasis"><em>storing</em></span> the credit card information.</p><p>Your app will not process via a real payment method because you can use a public test key from Stripe. The app will ask for a few fields to create a token. Observe the following screenshot of the app:</p><div class="mediaobject"><img src="../Images/image00257.jpeg" alt="Integrating with Stripe for online payment"/></div><p style="clear:both; height: 1em;"> </p><p>If you<a id="id287" class="indexterm"/> touch the <span class="strong"><strong>Pay $20</strong></span> button, it will take you to the next<a id="id288" class="indexterm"/> screen where you will get the payment token, as shown in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00258.jpeg" alt="Integrating with Stripe for online payment"/></div><p style="clear:both; height: 1em;"> </p><div class="note" title="Note"><h3 class="title"><a id="tip15"/>Tip</h3><p>Actually, there are additional steps for your backend to call Stripe to authorize and process the transaction. However, it's not within the scope of this section. The Stripe<a id="id289" class="indexterm"/> document has a good tutorial page on Node.js at <a class="ulink" href="https://stripe.com/docs/api/node#authentication">https://stripe.com/docs/api/node#authentication</a>.</p></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec66"/>Getting ready</h2></div></div></div><p>There is no need to test in a physical<a id="id290" class="indexterm"/> device because Ionic 2 and Stripe will work just fine in the web browser.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec67"/>How to do it...</h2></div></div></div><p>Observe the following<a id="id291" class="indexterm"/> instructions:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">If you<a id="id292" class="indexterm"/> don't have a Stripe account, you need to register on <a class="ulink" href="https://stripe.com">https://stripe.com</a>.</li><li class="listitem">Log in and go to <a class="ulink" href="https://dashboard.stripe.com/test/dashboard">https://dashboard.stripe.com/test/dashboard</a>.</li><li class="listitem">Click on your username on the top right and select <span class="strong"><strong>Account S</strong></span><span class="strong"><strong>ettings</strong></span>, as illustrated in the following screenshot:<div class="mediaobject"><img src="../Images/image00259.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Select the <span class="strong"><strong>API Keys</strong></span> tab.</li><li class="listitem">Copy your <span class="strong"><strong>Test Publishable Key</strong></span>, shown as follows, somewhere because you need to use it for your JavaScript code later:<div class="mediaobject"><img src="../Images/image00260.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>Now, go back to the Terminal.</p></li><li class="listitem">Create a new <code class="literal">StripePayment</code> app using the <code class="literal">blank</code> template, as follows, and go into the <code class="literal">StripePayment</code> folder:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  $ ionic start StripePayment blank --v2</strong></span>
<span class="strong"><strong>  $ cd StripePayment</strong></span>
</pre></div></li><li class="listitem">Open the <code class="literal">./src/index.html</code> file and insert the line shown somewhere in the <code class="literal">&lt;body&gt;</code> tab as follows:<div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript" src="https://js.stripe.com/v2/"&gt;&lt;/script&gt;</pre></div><div class="note" title="Note"><h3 class="title"><a id="note09"/>Note</h3><p>This is to<a id="id293" class="indexterm"/> load the <code class="literal">Stripe</code> object globally in your app. This is not the recommended method with Angular 2 because<a id="id294" class="indexterm"/> anything that is used within a component must be imported via the <code class="literal">import</code> instruction. However, at the time of writing this book, angular-stripe is unavailable for Angular 2. So, there is no way to do this properly. The preceding method will work just fine.</p></div></li><li class="listitem">Open the <code class="literal">./src/pages/home/home.html</code> file and modify the content with the following code:<div class="informalexample"><pre class="programlisting">&lt;ion-content class="gray-bg"&gt;
  &lt;p class="center"&gt;
    &lt;ion-icon class="icon-large" name="card"&gt;&lt;/ion-icon&gt;
  &lt;/p&gt;

  &lt;ion-card&gt;
    &lt;ion-card-content&gt;
      &lt;ion-list&gt;

        &lt;ion-item&gt;
          &lt;ion-input type="number" name="cc" [(ngModel)]="ngForm.cc" placeholder="Number"&gt;&lt;/ion-input&gt;
        &lt;/ion-item&gt;

        &lt;ion-item&gt;
          &lt;ion-input type="number" name="cvc" [(ngModel)]="ngForm.cvc" placeholder="CVC"&gt;&lt;/ion-input&gt;
        &lt;/ion-item&gt;
        
        &lt;ion-item&gt;
          &lt;ion-input item-left type="number" name="month" [(ngModel)]="ngForm.month" placeholder="Month"&gt;&lt;/ion-input&gt;
          &lt;ion-input item-right type="number" name="year" [(ngModel)]="ngForm.year" placeholder="Year"&gt;&lt;/ion-input&gt;
        &lt;/ion-item&gt;
        
        &lt;button type="button" ion-button bottom block (click)="onSubmit()"&gt;Pay $20&lt;/button&gt;

      &lt;/ion-list&gt;
    &lt;/ion-card-content&gt;
  &lt;/ion-card&gt;
    
&lt;/ion-content&gt;</pre></div><p>Stripe<a id="id295" class="indexterm"/> only needs the credit card number, CVC, and expiration to create a token for charging. The customer name<a id="id296" class="indexterm"/> and address are optional; so, you don't need to include them here.</p></li><li class="listitem">Then, replace<a id="id297" class="indexterm"/> the content of <code class="literal">./src/pages/home/home.ts</code> with the following <a id="id298" class="indexterm"/>code:<div class="informalexample"><pre class="programlisting">import { Component } from '@angular/core';
import { NavController } from 'ionic-angular';
import { ThankyouPage } from '../thankyou/thankyou'
declare var Stripe: any;

@Component({
  selector: 'page-home',
  templateUrl: 'home.html'
})
export class HomePage {
  private token: string = '';
  private ngForm: any = {
      cc: '',
      cvc: '',
      month: '',
      year: '',
      amount: 2000    
  };
  
  constructor(public nav: NavController) {
    this.nav = nav;
    console.log(Stripe);
    Stripe.setPublishableKey('YOUR STRIPE PUBLIC KEY HERE');
  }
  
  onSubmit() {
    console.log(this.ngForm);
    Stripe.card.createToken({
      number: this.ngForm.cc, //'4242424242424242',
      cvc: this.ngForm.cvc, //'123',
      exp_month: this.ngForm.month, //12,
      exp_year: this.ngForm.year, //2017,
      amount: 2000
    }, (status, response) =&gt; this.stripeResponseHandler(status, response));
  }
  
  stripeResponseHandler(status, response) {

    if (response.error) {
      // Show the errors on the form
      console.log('error');
      console.log(response.error.message);
    } else {
      // response contains id and card, which contains additional card details
      this.token = response.id;
      // Insert the token into the form so it gets submitted to the server
      console.log('success');
      console.log('Sending token param:');
      console.log(this.token);
      this.nav.push(ThankyouPage, {token: this.token});
    }
  }

}</pre></div><p>You need<a id="id299" class="indexterm"/> to change your <span class="strong"><strong>Test Publishable Key</strong></span> here by replacing <span class="strong"><strong>YOUR STRIPE PUBLIC KEY HERE</strong></span> with <a id="id300" class="indexterm"/>your own key that you copied earlier.</p></li><li class="listitem">Edit <code class="literal">./src/pages/home/home.scss</code> with the following code:<div class="informalexample"><pre class="programlisting">.center {
  text-align: center;
}

.gray-bg {
  background-color: #f4f4f7;
}

.icon-large {
  font-size: 150px;
  color: #387ef5;
  opacity: 0.5;
}

.list-ios &gt; .item-block:first-child {
  border-top: 0;  
}

ion-card ion-list .item {
  border-bottom: 1px solid #c8c7cc;
}

ion-list .item-inner {
  border-bottom: 0;
}

ion-card-content .button-block {
  margin-top: 16px;
   }</pre></div></li><li class="listitem">Create<a id="id301" class="indexterm"/> the <code class="literal">thankyou</code> page that shows the token ID by making a new folder, called <code class="literal">./src/pages/thankyou</code>, as shown:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ mkdir ./src/pages/thankyou</strong></span>
</pre></div></li><li class="listitem">Create the <code class="literal">thankyou.html</code> file in the <code class="literal">thankyou</code> folder and copy the following<a id="id302" class="indexterm"/> code:<div class="informalexample"><pre class="programlisting">&lt;ion-content class="green-bg"&gt;
  &lt;h4 class="center"&gt;
    Your token is
  &lt;/h4&gt;
  &lt;p class="center"&gt;
    &lt;code&gt;
      {{ token }}
    &lt;/code&gt;
  &lt;/p&gt;
&lt;/ion-content&gt;</pre></div><p>In reality, there is no need to show the token ID to the user. This is just an example to get the token ID to charge.</p></li><li class="listitem">Create the <code class="literal">thankyou.ts</code> file in the <code class="literal">thankyou</code> folder and copy the following code:<div class="informalexample"><pre class="programlisting">import { Component } from '@angular/core';
import { NavController, NavParams } from 'ionic-angular';

@Component({
  selector: 'thank-you',
  templateUrl: 'thankyou.html'
})
export class ThankyouPage {
  private token: string = '';
  
  constructor(public nav: NavController, public params: NavParams) {
    this.token = this.params.get('token');
    console.log('Getting token param:');
    console.log(this.token);
  }

}</pre></div></li><li class="listitem">Create<a id="id303" class="indexterm"/> the <code class="literal">thankyou.scss</code> file to modify the theme using the following code:<div class="informalexample"><pre class="programlisting">.green-bg {
  color: black;
  background-color: #32db64;
}

h4.center {
  padding-top: 150px;
}

.center {
  text-align: center;
}</pre></div></li><li class="listitem">Since the <code class="literal">thankyou.scss</code> file is <a id="id304" class="indexterm"/>new in the project, you need to include it in <code class="literal">./src/app/app.scss</code>. Insert this line at the bottom of the code:<div class="informalexample"><pre class="programlisting">@import '../pages/thankyou/thankyou';</pre></div></li><li class="listitem">Open and edit <code class="literal">./src/app/app.module.ts</code> to declare <code class="literal">ThankyouPage</code> as follows:<div class="informalexample"><pre class="programlisting">import { NgModule } from '@angular/core';
import { IonicApp, IonicModule } from 'ionic-angular';
import { MyApp } from './app.component';
import { HomePage } from '../pages/home/home';
import { ThankyouPage } from '../pages/thankyou/thankyou'

@NgModule({
  declarations: [
    MyApp,
    HomePage,
    ThankyouPage
  ],
  imports: [
    IonicModule.forRoot(MyApp)
  ],
  bootstrap: [IonicApp],
  entryComponents: [
    MyApp,
    HomePage,
    ThankyouPage
  ],
  providers: []
})
export class AppModule {}</pre></div></li><li class="listitem">Go to your Terminal and run the app:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ionic serve</strong></span>
</pre></div></li><li class="listitem">For the purpose of testing, you can use <code class="literal">4242424242424242</code> as the credit card number, <code class="literal">123</code> as <code class="literal">cvc</code>, and <code class="literal">12/2017</code> as the expiration.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec68"/>How it works…</h2></div></div></div><p>This is the Stripe <a id="id305" class="indexterm"/>charging process:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The user fills in the payment form and clicks on the <span class="strong"><strong>Submit</strong></span> button.</li><li class="listitem">The frontend (your Ionic app) will call API to Stripe using the <code class="literal">Stripe</code> object and send along <a id="id306" class="indexterm"/>all the payment information.</li><li class="listitem">Stripe will return a token ID, which is basically a way to confirm that everything is correct and you can charge the card now.</li><li class="listitem">The frontend will use the token ID to send to its backend (without the credit card information) to authorize the charge.</li><li class="listitem">The backend will call another Stripe API to say <span class="emphasis"><em>I'm going to charge now</em></span>. Stripe will return the <code class="literal">success</code> event to the backend at this point.</li><li class="listitem">The backend will then return the <code class="literal">success</code> event to the frontend.</li><li class="listitem">The frontend should render a new page, such as the <code class="literal">thankyou</code> page.</li></ol><div style="height:10px; width: 1px"/></div><p>As discussed previously, this chapter will not cover the backend portion of this app because it doesn't focus on Ionic. You can build the backend using any language, such as Node.js, PHP, or Python.</p><p>Let's take a look at <code class="literal">home.ts</code> because the majority of Stripe API processing is located there. First, you need to do a <code class="literal">declare</code>, as illustrated, because <code class="literal">Stripe</code> is a global object that was included in the <code class="literal">index.html</code>:</p><div class="informalexample"><pre class="programlisting">declare var Stripe: any;</pre></div><p>If you don't do a <code class="literal">declare</code>, the app will still run but you will get an error from TypeScript.</p><p>When the user submits the form, it will trigger the following method:</p><div class="informalexample"><pre class="programlisting">  onSubmit() {
    console.log(this.ngForm);
    Stripe.card.createToken({
      number: this.ngForm.cc, //'4242424242424242',
      cvc: this.ngForm.cvc, //'123',
      exp_month: this.ngForm.month, //12,
      exp_year: this.ngForm.year, //2017,
      amount: 2000
    }, (status, response) =&gt; this.stripeResponseHandler(status, response));
  }</pre></div><p>When you call <code class="literal">Stripe.card.createToken</code>, the Stripe object will trigger an API call in the background to <a class="ulink" href="https://stripe.com/">https://stripe.com/</a> with the<a id="id307" class="indexterm"/> JSON submitted. You may realize that this example<a id="id308" class="indexterm"/> does not use <code class="literal">ngModel</code> at all, but you can get the form values directly from within <code class="literal">ngForm</code>. This functionality is accomplished by the following code in your <code class="literal">home.html</code>:</p><div class="informalexample"><pre class="programlisting">&lt;button type="button" ion-button bottom block (click)="onSubmit()"&gt;Pay $20&lt;/button&gt;</pre></div><p>Once Stripe returns your token ID, it will call the following arrow function:</p><div class="informalexample"><pre class="programlisting">(status, response) =&gt; this.stripeResponseHandler(status, response)</pre></div><p>The reason for using the arrow<a id="id309" class="indexterm"/> function here is because your code within the <code class="literal">stripeResponseHandler</code> method needs the <code class="literal">this</code> context of the <code class="literal">HomePage</code> class. This is a nice way to access the token variable. Observe the following code:</p><div class="informalexample"><pre class="programlisting">  stripeResponseHandler(status, response) {

    if (response.error) {
      // Show the errors on the form
      console.log('error');
      console.log(response.error.message);
    } else {
      // response contains id and card, which contains additional card details
      this.token = response.id;
      // Insert the token into the form so it gets submitted to the server
      console.log('success');
      console.log('Sending token param:');
      console.log(this.token);
      this.nav.push(ThankyouPage, {token: this.token});
    }
  }</pre></div><p>The <code class="literal">response.id</code> will have your token ID from Stripe. Otherwise, you can handle the error using <code class="literal">response.error.message</code>. In this example, since it only passes the token ID to the next<a id="id310" class="indexterm"/> page, you can simply send it as a parameter <code class="literal">{token: this.token}</code>:</p><div class="informalexample"><pre class="programlisting">this.nav.push(ThankyouPage, {token: this.token});</pre></div><p>In your <code class="literal">thankyou.ts</code>, you can access the parameter <code class="literal">token</code> using the following code:</p><div class="informalexample"><pre class="programlisting">this.params.get('token');</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec69"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">To understand <a id="id311" class="indexterm"/>more about Stripe API, you can check out the <a id="id312" class="indexterm"/>official documentation at <a class="ulink" href="https://stripe.com/docs/stripe.js">https://stripe.com/docs/stripe.js</a></li><li class="listitem">There are more examples from other languages that you can experiment with at <a class="ulink" href="https://stripe.com/docs/examples">https://stripe.com/docs/examples</a></li></ul></div></div></div></body></html>