<html><head></head><body>
<div><h1 class="chapter-number" id="_idParaDest-137"><a id="_idTextAnchor137"/>11</h1>
<h1 id="_idParaDest-138"><a id="_idTextAnchor138"/>Modules and Secrets</h1>
<p>While routing is certainly important to SvelteKit, there is far more to it than just that. Throughout this book, we’ve utilized multiple different SvelteKit modules. For instance, we’ve imported bindings from <code>$app/forms</code>, <code>$app/environment</code>, and <code>$app/stores</code>, to name a few. But we have yet to explore what these modules are or how they work. In this chapter, we’ll give a brief overview of some of the modules we’ve seen previously as well as some we have not yet seen. We’ll also cover some of the modules used for managing secrets and when to use which ones.</p>
<p>In this chapter, we’ll examine the following:</p>
<ul>
<li>SvelteKit Module Summaries</li>
<li>Keeping Secrets Safe</li>
</ul>
<p>Having covered various modules, as well as examining our previous example of storing GitHub API secrets, we’ll have a clear understanding of when best to harness the power of each individual module.</p>
<h1 id="_idParaDest-139"><a id="_idTextAnchor139"/>Technical requirements</h1>
<p>The complete code for this chapter is available on GitHub at: <a href="https://github.com/PacktPublishing/SvelteKit-Up-and-Running/tree/main/chapters/chapter11">https://github.com/PacktPublishing/SvelteKit-Up-and-Running/tree/main/chapters/chapter11</a>.</p>
<h1 id="_idParaDest-140"><a id="_idTextAnchor140"/>SvelteKit Module Summaries</h1>
<p>In previous chapters, we’ve used several different modules but only provided short explanations. While the analysis in this section will also be brief, it should provide a broad enough insight that prospective SvelteKit developers feel familiar with the workings of available modules. We have encountered a few listed here but there are some that we are yet to cover. For more in-depth explanations, see the resources at the end of this chapter.</p>
<h2 id="_idParaDest-141"><a id="_idTextAnchor141"/>$app/environment</h2>
<p>To begin<a id="_idIndexMarker249"/> our analysis of modules, let’s start with one that we have used relatively recently. In <a href="B19024_09_Final_AM.xhtml#_idTextAnchor116"><em class="italic">Chapter 9</em></a>, while attempting to throw an error in the client, we used the <code>$app/environment</code> module and imported <code>browser</code>. As we’ve come to expect with SvelteKit naming conventions, all of the bindings exported from this module pertain to the application environment. This makes it trivial to identify the purpose of each of the bindings by their names. For instance, we saw that <code>browser</code> returns a Boolean value based on whether or not the environment it is being run in is the client. Likewise, <code>building</code> and <code>dev</code> will return Boolean values based on whether or not the code is being run during the build process or in our development environment, respectively. The final export from <code>$app/environment</code> is <code>version</code>. While <code>version</code> is still appropriately named, it’s important to note that it doesn’t refer to the version of SvelteKit. Rather, it refers to the version of the application build. The value of <code>version</code> is determined by the Unix timestamp at the time of building. SvelteKit uses this string value to check for a new version when client-side navigation encounters an error and defaults to standard navigation practices by making a full-page load.</p>
<h2 id="_idParaDest-142"><a id="_idTextAnchor142"/>$app/forms</h2>
<p>When we<a id="_idIndexMarker250"/> utilized <code>enhance</code> from <code>$app/forms</code> in <a href="B19024_04_Final_AM.xhtml#_idTextAnchor060"><em class="italic">Chapter 4</em></a>, we saw how it could <em class="italic">progressively enhance</em> our form submissions by sending data in the background instead of requiring our entire page to be reloaded when submitting the form. If the default behavior of <code>enhance</code> has not quite satisfied our needs, it can be customized. If we decide to change its default behavior and provide it with a custom callback function, <code>applyAction</code> can be used to update the data within the <code>form</code> property of our components. The final binding we can import from <code>$app/forms</code> is <code>deserialize</code>, which is a helpful function when deserializing response data from a form submission.</p>
<h2 id="_idParaDest-143"><a id="_idTextAnchor143"/>$app/navigation</h2>
<p>As<a id="_idIndexMarker251"/> expected, <code>$app/navigation</code> provides tools pertaining to navigation. We previously used <code>invalidateAll</code> in <a href="B19024_05_Final_AM.xhtml#_idTextAnchor072"><em class="italic">Chapter 5</em></a> and <code>invalidate</code> in <a href="B19024_09_Final_AM.xhtml#_idTextAnchor116"><em class="italic">Chapter 9</em></a> from this module. In both of those instances, we did so to force <code>load()</code> to run again. Some other helpful bindings from this module are <code>afterNavigate</code> and <code>beforeNavigate</code>. Both of these bindings run callback functions at specific timings within the SvelteKit life cycle. With <code>afterNavigate</code>, the provided callback is executed once the current component has mounted and after the user has navigated to a new URL. The callback function for <code>beforeNavigate</code> is run just before navigating to a new URL.</p>
<p>Some<a id="_idIndexMarker252"/> other bindings available from this particular module include <code>disableScrollHandling</code>, <code>goto</code>, <code>preloadCode</code>, and <code>preloadData</code>. If we wanted to change how SvelteKit manages the browser window scrolling position, we could disable it entirely by calling <code>disableScrollHandling()</code>. The <code>goto()</code> function provides developers with the ability to navigate to another URL while also including options that allow for the management browser history, keeping focus applied to a particular element, and even triggering the rerun of <code>load()</code> functions. The <code>preloadCode()</code> function allows developers to import the code for a particular route before that route has been navigated to, while <code>preloadData()</code> will do the same as well as calling the route’s <code>load()</code> function. The same behavior of <code>preloadData()</code> is found when <code>&lt;a&gt;</code> elements are given the <code>data-sveltekit-preload-data</code> attribute.</p>
<h2 id="_idParaDest-144"><a id="_idTextAnchor144"/>$app/paths</h2>
<p>When<a id="_idIndexMarker253"/> we need to manipulate file paths or create links to routes for our application that reside in a sub-directory, we can rely on <code>$app/paths</code>. Both <code>assets</code> and <code>base</code> will return a string value that can be customized in <code>svelte.config.js</code> under <code>config.kit.paths</code>. If the application is being served from a subdirectory, we can prepend manually written routes with the <code>{base}</code> text to ensure our application serves the route from the correct directory and does not attempt to serve the route from the domain root directory. The value provided by <code>base</code> must always be a root-relative path that begins with a <code>/</code> but never ends with one. Conversely, <code>assets</code> will always be an absolute path to the application files.</p>
<h2 id="_idParaDest-145"><a id="_idTextAnchor145"/>$app/stores</h2>
<p>The<a id="_idIndexMarker254"/> SvelteKit developers were kind enough to provide developers with a few readable stores that can supply us with helpful information. When importing from <code>$app/stores</code>, we’ll have access to <code>navigating</code>, <code>page</code>, <code>updated</code>, and <code>getStores</code>. During navigation, <code>navigating</code> will be populated with an object consisting of metadata such as where the navigation event started, where it is going, and the type of navigation. The type can range from a form submission to a link click, or even a browser back-and-forward event. Once navigation has been completed, the value of this store will return to <code>null</code>. Meanwhile, <code>page</code> serves as a store that<a id="_idIndexMarker255"/> contains information related to the currently viewed page. We used it back in <a href="B19024_04_Final_AM.xhtml#_idTextAnchor060"><em class="italic">Chapter 4</em></a> to display the current page’s error message. The <code>updated</code> store will return a Boolean value after SvelteKit has checked whether or not a new version of the application has been detected. All of these stores can be retrieved by calling <code>getStores()</code>but doing so is not recommended and should only be done when the store subscription needs to be paused until after a component has mounted. Otherwise, all store values can be accessed by prefixing the store name with the <code>$</code> symbol, which will automatically handle the subscription process.</p>
<h2 id="_idParaDest-146"><a id="_idTextAnchor146"/>$service-worker</h2>
<p>When<a id="_idIndexMarker256"/> building a <code>$service-worker</code> module, which can only be used within a service worker. When importing bindings, we’ll have access to <code>base</code>, <code>build</code>, <code>files</code>, <code>prerendered</code>, and <code>version</code>. Again, sane naming conventions come to our rescue and mostly explain the type of data returned from each of these bindings. We can receive a string value from <code>base</code>, which works similarly to the <code>base</code> from <code>$app/paths</code>. It will provide us with the base path to the application even if the application exists in a subdirectory. The array of strings from <code>build</code> will consist of URLs generated by Vite during the build process. Another array of strings, <code>files</code>, will provide details on static files or those included in <code>config.kit.files.assets</code>. For prerendered path names, we can retrieve the strings from the <code>prerendered</code> array. And finally, we can use <code>version</code> to determine the application version within our service worker code.</p>
<p>This list of modules is by no means comprehensive. Before leaning on them too heavily, it’s recommended to read the official SvelteKit documentation listed at the end of this chapter. Now that we’ve examined some of these modules, let’s move on to the modules that help us keep sensitive information safe.</p>
<h1 id="_idParaDest-147"><a id="_idTextAnchor147"/>Keeping secrets safe</h1>
<p>When it comes to keeping secrets <a id="_idIndexMarker257"/>such as API keys or database credentials safe, SvelteKit has us covered. As we saw in <a href="B19024_09_Final_AM.xhtml#_idTextAnchor116"><em class="italic">Chapter 9</em></a>, we can import <code>.env</code> secrets from <code>$env/static/private</code>. But this is not the only module that allows us to import environment variables. In this section, we’ll examine more modules and how they all can help us import environment variables as well as secrets.</p>
<h2 id="_idParaDest-148"><a id="_idTextAnchor148"/>$env/static/private</h2>
<p>Beginning<a id="_idIndexMarker258"/> with the module we’ve already used, <code>$env/static/private</code> is great for importing environment variables like those specified in <code>.env</code> files or those set when starting the runtime. For instance, if we were to start our application with the <code>API_KEY="" node index.js</code> command, the <code>API_KEY</code> variable would be available, just as <code>GITHUB</code> was available after we imported <code>$env/static/private</code> in <a href="B19024_09_Final_AM.xhtml#_idTextAnchor116"><em class="italic">Chapter 9</em></a>. Any environment variables provided when starting the application will override the value of those provided in a <code>.env</code> file. The variables from this module are statically bundled within the application code at build time by Vite. This means less bundled code but also means that secrets will be included in the application build. We can confirm this by building the following commands:</p>
<pre class="source-code">
npm run build
grep -r 'YOUR_API_KEY' .svelte-kit/</pre>
<p>Substituting <code>YOUR_API_KEY</code> with your personal access token provided by GitHub will show the text and the file in our build where our API key has been injected. As such, we should be cautious not to commit builds to version control as doing so could then expose secrets. Fortunately for us, this module will only work with server-side code and will cause a build to fail if we attempt to import it into client-side code.</p>
<h2 id="_idParaDest-149"><a id="_idTextAnchor149"/>$env/static/public</h2>
<p>We<a id="_idIndexMarker259"/> can consider <code>$env/static/public</code> a sibling to <code>$env/static/private</code>. The major difference is that this module will only import variables that begin with the value set in <code>config.kit.env.publicPrefix</code>. By default, this value is <code>PUBLIC_</code>. This allows us to keep our secrets all in the same <code>.env</code> file while allowing us to specify which are safe to expose to clients and which are not. For example, the following <code>.env</code> file would allow for <code>PUBLIC_GITHUB_USER</code> to be imported into client-side code but not <code>GITHUB_TOKEN</code>. Even though both values exist in the same file, we can rest assured knowing that <a id="_idIndexMarker260"/>SvelteKit won’t tell our secrets to anyone other than the server we know we can trust:</p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US">.env</p>
<pre class="source-code">
GITHUB_TOKEN=YOUR_GITHUB_PERSONAL_ACCESS_TOKEN
PUBLIC_GITHUB_USER=YOUR_USERNAME_HERE</pre>
<h2 id="_idParaDest-150"><a id="_idTextAnchor150"/>$env/dynamic/private</h2>
<p>Just <a id="_idIndexMarker261"/>as we cannot import <code>$env/static/private</code> into client-side code, we cannot import <code>$env/dynamic/private</code> into client-side code either. The difference between these two modules is that while the <code>$env/static</code> modules have access to <code>.env</code> files, <code>$env/dynamic</code> has access to the environment variables specified by the adapter. Think back to <a href="B19024_08_Final_AM.xhtml#_idTextAnchor106"><em class="italic">Chapter 8</em></a> when we deployed our application to Cloudflare. When we did that, we specified the environment variable <code>NODE_VERSION</code>. Obtaining the Node version likely isn’t very useful to us but using <code>$env/dynamic/private</code> allows us to access other secrets set in our Cloudflare Pages project settings. This can be helpful when working in a team as sharing secrets can be done on the platform rather than passing around <code>.env</code> files. When the platform the project will be deployed to has its own means of setting environment variables, it’s very likely you’ll be relying on <code>$env/dynamic</code> to access them.</p>
<h2 id="_idParaDest-151"><a id="_idTextAnchor151"/>$env/dynamic/public</h2>
<p>By following <a id="_idIndexMarker262"/>the established pattern, this module should need little explanation. With <code>$env/dynamic/public</code>, we will only be able to import environment variables that begin with <code>PUBLIC_</code> or whatever value has been specified in <code>config.kit.env.publicPrefix</code>. This works in the same way as <code>$env/static/public</code>. Of course, it differs from <code>$env/static/public</code> because this is another dynamic module, which means it is specific to the configured environment adapter. For instance, if we were to add <code>PUBLIC_GITHUB_USER</code> to our Cloudflare Pages environment variables, we would then be able to access the value of that environment variable using this module.</p>
<h1 id="_idParaDest-152"><a id="_idTextAnchor152"/>Summary</h1>
<p>There are a great many modules available within SvelteKit. Hopefully, this brief overview has given enough insight so that we know where to start with each of them. In the next chapter, we’ll examine some best practices for enhancing accessibility, which can come with the added benefit of improving <strong class="bold">Search Engine </strong><strong class="bold">Optimization</strong> (<strong class="bold">SEO</strong>).</p>
<h1 id="_idParaDest-153"><a id="_idTextAnchor153"/>Resources</h1>
<ul>
<li>SvelteKit Module Documentation – <a href="https://kit.svelte.dev/docs/modules">https://kit.svelte.dev/docs/modules</a></li>
</ul>
</div>
</body></html>