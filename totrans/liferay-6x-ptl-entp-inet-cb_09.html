<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;Liferay Workflow Capability" id="aid-1TVKI1"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Liferay Workflow Capability</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The Kaleo Web installation</li><li class="listitem">The Single Approver workflow for the user creation process</li><li class="listitem">The web content creation and the fork-join workflow</li><li class="listitem">Kaleo conditions in a message board example</li><li class="listitem">Kaleo timers</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec59"/>Introduction</h1></div></div></div><p>A workflow is <a id="id515" class="indexterm"/>a series of activities necessary to complete a task. In other words, a workflow consists of a sequence of states connected by transition. Each state has a specific step before it and a specific step after it. In general, it's a linear-defined process, which describes the flow between states. The term workflow indicates how people do their work and how they handle information. To understand workflow definitions, let's define its specific vocabulary:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>State</strong></span>: This term <a id="id516" class="indexterm"/>describes a unique state that will execute a specific action (or many actions) on a work item. For instance, new, approved, commit, done, remove, and so on.</li><li class="listitem"><span class="strong"><strong>Task</strong></span>: This defines <a id="id517" class="indexterm"/>an activity to be done on a work item between states.</li><li class="listitem"><span class="strong"><strong>Transition</strong></span>: This defines how a transition rules from one state to another. It means that transition <a id="id518" class="indexterm"/>describes a list of tasks, which have to be done to transform items from one state to another.</li></ul></div><p>Liferay Portal includes a workflow engine called Kaleo. This engine provides functionalities to define and deploy <a id="id519" class="indexterm"/>workflow definitions. Kaleo is an external web plugin, which needs to be deployed like other plugins. The current version of Kaleo is available on the Liferay marketplace.</p></div></div>
<div class="section" title="The Kaleo Web Installation" id="aid-1UU541"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec60"/>The Kaleo Web Installation</h1></div></div></div><p>The workflow engine called Kaleo is defined as a web plugin. Briefly, a web plugin is a normal web application, which <a id="id520" class="indexterm"/>also provides the ability to use the Liferay service layer that is built on Service Builder and other Liferay plugins, such as hooks, portlets, and so on. In general, it's a hybrid between a typical servlet application and Liferay-specific plugins.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec163"/>Getting ready</h2></div></div></div><p>To correctly install Liferay plugins, it's required to create an account on the official Liferay site. This account allows you to download plugins on the marketplace, discuss on a message board, creates blogs, and so on.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec164"/>How to do it...</h2></div></div></div><p>In the Liferay 6.1.1 GA2 version, Liferay provides a marketplace portlet to install all its available plugins. In Liferay 6.2 marketplace portlet is already installed, so the installation of the Kaleo plugin is really <a id="id521" class="indexterm"/>simple. In order to install the Kaleo workflow, go through the following set of steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in as an administrator on the intranet.</li><li class="listitem">Navigate to <span class="strong"><strong>Admin</strong></span> | <span class="strong"><strong>Control Panel</strong></span>.</li><li class="listitem">Select the <span class="strong"><strong>Store</strong></span> option in the <span class="strong"><strong>Apps</strong></span> section.</li><li class="listitem">Authenticate yourself by entering the Liferay login and password.<div class="note" title="Note"><h3 class="title"><a id="note33"/>Note</h3><p>If Liferay provides a new marketplace portlet, there will be a wizard that updates a portlet and downloads the newest one.</p></div></li><li class="listitem">On the marketplace search form, type <code class="literal">Kaleo Workflow CE</code> and select the proper result.</li><li class="listitem">Click on the <span class="strong"><strong>Free</strong></span> button.</li><li class="listitem">Select or create a new project for the purchase; read and accept the terms of use. Fill <span class="strong"><strong>Legal Entity Name</strong></span> and click on the <span class="strong"><strong>Purchase</strong></span> button.</li><li class="listitem">The system should display the following message:<p>
<span class="strong"><strong>Thank You!</strong></span>
</p><p>
<span class="strong"><strong>Your receipt ID number is &lt;RECEIPT_ID&gt;</strong></span>
</p><p>
<span class="strong"><strong>A confirmation email for this order was sent to your inbox.</strong></span>
</p><p>
<span class="strong"><strong>Click on "See Purchased" to view and manage your purchases online, or you may go to the Marketplace through your Liferay Portal instance and manage your purchases from there.</strong></span>
</p></li><li class="listitem">Navigate to <span class="strong"><strong>See Purchased Apps</strong></span> and click on the <span class="strong"><strong>Install</strong></span> button.</li><li class="listitem">Verify that a <span class="strong"><strong>Workflow</strong></span> tab is in the <span class="strong"><strong>Control Panel</strong></span> | <span class="strong"><strong>Configuration</strong></span> section.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec165"/>How it works…</h2></div></div></div><p>Liferay uses its <a id="id522" class="indexterm"/>own product for the workflow implementation. All Kaleo entities are generated by the service-builder mechanism.</p><p>It means that <code class="literal">service.xml</code> defines a set of entities: Kaleo Action, Kaleo Condition, Kaleo Definition, Kaleo Instance, Kaleo Instance Token, Kaleo Log, Kaleo Node, Kaleo Notification, Kaleo Notification Recipient, Kaleo Task, Kaleo Task Assignment, KaleoTask Assignment Instance, Kaleo Task Instance Token, Kaleo Timer, Kaleo Timer Instance Token, and Kaleo Transition. It's not necessary to know the meaning of all these entities and their relations.</p><p>After successful installation, there are a couple of new options in the Liferay environment:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><strong>Workflow</strong></span> option in the <span class="strong"><strong>Control Panel</strong></span> | <span class="strong"><strong>Configuration</strong></span> section: This is a global workflow configuration, which allows you to define newer workflow definitions and manage default workflows between assets (for instance, web content articles, users, blogs, and so on)</li><li class="listitem"><span class="strong"><strong>Workflow configuration</strong></span> in the <span class="strong"><strong>Admin</strong></span> | <span class="strong"><strong>Site Administration</strong></span> | <span class="strong"><strong>Configuration</strong></span>: This defines workflows for the current site</li><li class="listitem">The <span class="strong"><strong>My Workflow tasks</strong></span> tab in the <span class="strong"><strong>{USERNAME}</strong></span> | <span class="strong"><strong>My account</strong></span> section: This functionality lists all pending and complete workflows tasks assigned to a specific user</li><li class="listitem"><span class="strong"><strong>My Submission</strong></span> in the <span class="strong"><strong>{USERNAME}</strong></span> | <span class="strong"><strong>My account</strong></span> section: This provides the list of assets submitted for the review process</li></ul></div><p>Furthermore, Kaleo added specific roles, which can be used in workflow definitions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The organization content reviewer</li><li class="listitem">The portal content reviewer</li><li class="listitem">The site content reviewer</li></ul></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec166"/>See also</h2></div></div></div><p>For more information <a id="id523" class="indexterm"/>on how to manage files or web contents, refer to</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="emphasis"><em>Managing files in Liferay using Documents and Media portlet</em></span> recipe in <a class="link" title="Chapter 6. Documents and Media in Liferay" href="part0050.xhtml#aid-1FLS41">Chapter 6</a>, <span class="emphasis"><em>Documents and Media in Liferay</em></span></li><li class="listitem">The <span class="emphasis"><em>Managing and displaying web contents</em></span> recipe in <a class="link" title="Chapter 7. Working with Content" href="part0055.xhtml#aid-1KEEU1">Chapter 7</a>, <span class="emphasis"><em>Working with Content</em></span></li></ul></div></div></div>
<div class="section" title="The Single Approver workflow for the user creation process" id="aid-1VSLM1"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec61"/>The Single Approver workflow for the user creation process</h1></div></div></div><p>By default, Kaleo <a id="id524" class="indexterm"/>Workflow provides a Single Approver definition. This workflow requires one approval state before any asset is published.</p><p>We will show you <a id="id525" class="indexterm"/>how to use this workflow for the user creation process.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec167"/>How to do it…</h2></div></div></div><p>Enabling the Single Approver definition is an easy process. To activate workflow for the user creation, perform these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <span class="strong"><strong>Admin</strong></span> | <span class="strong"><strong>Control Panel</strong></span> | <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Workflow</strong></span> tab.</li><li class="listitem">Select the <span class="strong"><strong>Default Configuration</strong></span> tab</li><li class="listitem">Find the <span class="strong"><strong>User</strong></span> resource and select the <span class="strong"><strong>Single Approver (version 1)</strong></span> definition.</li><li class="listitem">Click on the <span class="strong"><strong>Save</strong></span> button.<div class="note" title="Note"><h3 class="title"><a id="tip18"/>Tip</h3><p>To check how Single Approver works, try to create a new account in the Sign In portlet.</p></div></li><li class="listitem">Open the Sign In portlet page. By default, it is on the main page.</li><li class="listitem">Select the <span class="strong"><strong>Create Account</strong></span> option and fill in the form.</li><li class="listitem">After submitting the form, the system should display the following message:<p>
<span class="strong"><strong>Thank you for creating an account. You will be notified via email at your-mail@example.com when your account has been approved.</strong></span>
</p></li></ol><div style="height:10px; width: 1px"/></div><p>The last thing in this process is to approve a new user. In order to achieve this, run through the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in as <a id="id526" class="indexterm"/>an administrator.</li><li class="listitem">Navigate to <span class="strong"><strong>My Account</strong></span> | <span class="strong"><strong>My Workflow</strong></span> tasks.</li><li class="listitem">Find a pending task with the review status and edit it by clicking on the hyperlink in the table.</li><li class="listitem">Select the <span class="strong"><strong>Assigned to Me</strong></span> option next to <span class="strong"><strong>Assign to</strong></span> field.</li><li class="listitem"><span class="strong"><strong>Approve</strong></span> the user (in the dialog box, it's possible to write a comment).<div class="mediaobject"><img src="../Images/image00362.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Go to the <span class="strong"><strong>Completed</strong></span> tab and check the result. The approved user should be on the list.<div class="note" title="Note"><h3 class="title"><a id="note34"/>Note</h3><p>Only a user with an assigned task can transfer it to the next task or state.</p></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec168"/>How it works…</h2></div></div></div><p>To understand this process, let's examine the Single Approver definition (<code class="literal">single-approver-definition.xml</code> located in <code class="literal">webapps/kaleo-web/WEB-INF/classes/META-INF/definitions</code>). This<a id="id527" class="indexterm"/> definition can be drawn as follows:</p><div class="mediaobject"><img src="../Images/image00363.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p><div class="section" title="State"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec64"/>State</h3></div></div></div><p>The starting point <a id="id528" class="indexterm"/>of this flow is a state called created. The definition of this state is present at the beginning of the <code class="literal">single-approver-definition.xml</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;state&gt;
  &lt;name&gt;created&lt;/name&gt;
  [..]
  &lt;initial&gt;true&lt;/initial&gt;
  &lt;transitions&gt;
    &lt;transition&gt;
      &lt;name&gt;review&lt;/name&gt;
      &lt;target&gt;review&lt;/target&gt;
    &lt;/transition&gt;
  &lt;/transitions&gt;
&lt;/state&gt;</pre></div><p>The state node contains:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">name</code>: This is the name of a state</li><li class="listitem"><code class="literal">initial</code>: This flag represents the initial state</li><li class="listitem">List of <code class="literal">transitions</code>: In this example, there is only one transition called review</li></ul></div><p>The transition node can define:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">name</code>: This is the name of a transition</li><li class="listitem"><code class="literal">target</code>: This is the name of the target state or task</li><li class="listitem"><code class="literal">default</code>: This is a flag which marks transition as default</li></ul></div></div><div class="section" title="Task"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec65"/>Task</h3></div></div></div><p>The next step of our<a id="id529" class="indexterm"/> flow is a <code class="literal">review</code> task, which is defined by a transition called <code class="literal">review</code>. Tasks are the most complex structures in a flow definition. The task review is the place where users can decide whether to approve an asset or reject it. The definition of this task is as follows:</p><div class="informalexample"><pre class="programlisting">&lt;task&gt;
  &lt;name&gt;review&lt;/name&gt;
  &lt;actions&gt;
    &lt;notification&gt;
      &lt;name&gt;Review Notification&lt;/name&gt;
      &lt;template&gt;${userName} sent you a ${entryType} for review in the workflow.&lt;/template&gt;
      &lt;template-language&gt;freemarker&lt;/template-language&gt;
      &lt;notification-type&gt;email&lt;/notification-type&gt;
      &lt;notification-type&gt;user-notification&lt;/notification-type&gt;
      &lt;execution-type&gt;onAssignment&lt;/execution-type&gt;
    &lt;/notification&gt;
     [...]
  &lt;/actions&gt;
  &lt;assignments&gt;
    &lt;roles&gt;
      [...]
    &lt;/roles&gt;
  &lt;/assignments&gt;
  &lt;transitions&gt;
     [...]
  &lt;/transitions&gt;
&lt;/task&gt;</pre></div><p>The main attributes of task are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">name</code>: This is the name of the task, for instance, review.</li><li class="listitem"><code class="literal">actions</code>: This specifies the list of action elements or notification elements. In this example, actions contain only e-mail notifications.</li><li class="listitem"><code class="literal">assignments</code>: This specifies the list of roles or users to whom the specific task is assigned.</li><li class="listitem"><code class="literal">transitions</code>: This specifies the list of transition elements, which describe all possible ways to change the state or task. In this example, it's approved or rejected.</li></ul></div></div><div class="section" title="Notification"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec66"/>Notification</h3></div></div></div><p>Let's look deeper <a id="id530" class="indexterm"/>into the actions definition. As we mentioned earlier, actions can contain notification elements and/or action elements:</p><div class="informalexample"><pre class="programlisting">&lt;notification&gt;
  &lt;name&gt;Review Notification&lt;/name&gt;
  &lt;template&gt;${userName} sent you a ${entryType} for review in the workflow.&lt;/template&gt;
  &lt;template-language&gt;freemarker&lt;/template-language&gt;
  &lt;notification-type&gt;email&lt;/notification-type&gt;
  &lt;notification-type&gt;user-notification&lt;/notification-type&gt;
  &lt;execution-type&gt;onAssignment&lt;/execution-type&gt;
&lt;/notification&gt;</pre></div><p>The notification node has the following options:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">name</code>: This is the name of the notification</li><li class="listitem"><code class="literal">template</code>: This defines the notification's message</li><li class="listitem"><code class="literal">template-language</code>: This is one of the three options: freemarker, velocity, and text</li><li class="listitem"><code class="literal">notification-type</code>: This specifies the e-mail, IM, private-message, or user-notification</li><li class="listitem"><code class="literal">execution-type</code>: This specifies one of the three options: <code class="literal">onAssignment</code> (a notification is sent when a specific user is assigned to a specific asset), <code class="literal">onExit</code> (a notification is sent when a specific asset leaves a state or task), and <code class="literal">onEntry</code> (a notification is sent when a specific asset enters the state)<div class="note" title="Note"><h3 class="title"><a id="note35"/>Note</h3><p>The IM type and the private-message type are placeholders for now. This means that the Kaleo Web doesn't support these types.</p></div></li></ul></div></div><div class="section" title="Action"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec67"/>Action</h3></div></div></div><p>The second possibility is to define <a id="id531" class="indexterm"/>an action, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">&lt;action&gt;
  &lt;name&gt;approve&lt;/name&gt;
  &lt;script&gt;
    &lt;![CDATA[ {script here} ]]&gt;
  &lt;/script&gt;
  &lt;script-language&gt;groovy&lt;/script-language&gt;
  &lt;execution-type&gt;onEntry&lt;/execution-type&gt;
&lt;/action&gt;</pre></div><p>An action element has a simple structure, but it's a powerful tool to invoke every piece of code from Liferay. Action contains:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">name</code>: This specifies the<a id="id532" class="indexterm"/> name of the action.</li><li class="listitem"><code class="literal">script</code>: This specifies the script definition. In this section, it's possible to write a code, which will be invoked on defining the execution type.</li><li class="listitem"><code class="literal">script-language</code>: This defines the language which will be used in the script, for instance, Groovy, BeanShell, DRL, JavaScript, Python, Ruby. The most commonly used is the BeanShell one.</li><li class="listitem"><code class="literal">execution-type</code>: This specifies one of the three options: <code class="literal">onAssignment</code> (a notification is sent when a specific user is assigned to a specific asset), <code class="literal">onExit</code> (a notification is sent when a specific asset leaves a state or task), and <code class="literal">onEntry</code> (a notification is sent when a specific asset enters some state).</li></ul></div></div></div></div>
<div class="section" title="The web content creation and the fork-join workflow"><div class="titlepage" id="aid-20R682"><div><div><h1 class="title"><a id="ch09lvl1sec62"/>The web content creation and the fork-join workflow</h1></div></div></div><p>Let's assume that our goal is to create a Kaleo definition in order to publish articles with the following<a id="id533" class="indexterm"/> requirements. Everyone can write an article and submit it to reviewers. The review stage has two independent (parallel) steps:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">UI quality reviewing</li><li class="listitem">Content quality reviewing</li></ul></div><p>Only after these steps, it's possible to publish an article. In this recipe, we will show how to use the fork and join functionality in order to create the Kaleo definition. Forks and joins are used for parallel processing purposes. Thus, they will be a good solution to our problem.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec169"/>How to do it…</h2></div></div></div><p>First of all, let's visualize workflow and define states, tasks, and transitions. This diagram will help us understand the whole process:</p><div class="mediaobject"><img src="../Images/image00364.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p><p>As shown in the preceding diagram, in our workflow there are following components:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><strong>created</strong></span> and <span class="strong"><strong>approved</strong></span> state</li><li class="listitem">The <span class="strong"><strong>UI quality review</strong></span> and <span class="strong"><strong>content quality review</strong></span> tasks</li><li class="listitem">The fork and join functionality.</li></ul></div><p>The second step is to<a id="id534" class="indexterm"/> write a prototype, which defines states, tasks, and transitions listed previously:</p><div class="note" title="Note"><h3 class="title"><a id="note36"/>Note</h3><p>This is only a draft of the real definition. You will find the working definition in the code files for this chapter along with this book.</p></div><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0"?&gt;
&lt;workflow-definition&gt;
  &lt;name&gt;Fork-Join Example&lt;/name&gt;
  &lt;state&gt;
    &lt;name&gt;created&lt;/name&gt;
    &lt;transitions&gt;
      &lt;transition&gt;
        &lt;name&gt;review-process&lt;/name&gt;
        <span class="strong"><strong>&lt;target&gt;review-process&lt;/target&gt;</strong></span>
      &lt;/transition&gt;
    &lt;/transitions&gt;
  &lt;/state&gt;
  &lt;fork&gt;
    <span class="strong"><strong>&lt;name&gt;review-process&lt;/name&gt;</strong></span>
    &lt;transitions&gt;
      &lt;transition&gt;
        &lt;name&gt;UI Quality Review&lt;/name&gt;
      &lt;/transition&gt;
      &lt;transition&gt;
        &lt;name&gt;Content Quality Review&lt;/name&gt;
      &lt;/transition&gt;
    &lt;/transitions&gt;
  &lt;/fork&gt;
  &lt;task&gt;
    &lt;name&gt;UI Quality Review&lt;/name&gt;
    &lt;transitions&gt;
      &lt;transition&gt;
        &lt;name&gt;Submit&lt;/name&gt;
        <span class="strong"><strong>&lt;target&gt;join-tasks&lt;/target&gt;</strong></span>
      &lt;/transition&gt;
    &lt;/transitions&gt;
  &lt;/task&gt;
  &lt;task&gt;
    &lt;name&gt;Content Quality Review&lt;/name&gt;
    &lt;transitions&gt;
      &lt;transition&gt;
        &lt;name&gt;Submit&lt;/name&gt;
        &lt;target&gt;join-tasks&lt;/target&gt;
      &lt;/transition&gt;
    &lt;/transitions&gt;
  &lt;/task&gt;
  &lt;join&gt;
    <span class="strong"><strong>&lt;name&gt;join-tasks&lt;/name&gt;</strong></span>
    &lt;transitions&gt;
      &lt;transition&gt;&lt;name&gt;approved&lt;/name&gt;&lt;/transition&gt;
    &lt;/transitions&gt;
&lt;/join&gt;
  &lt;state&gt;&lt;name&gt;approved&lt;/name&gt;&lt;/state&gt;
&lt;/workflow-definition&gt;</pre></div><p>The third step is to <a id="id535" class="indexterm"/>complete the preceding definition by specifying each node. It can be done by copying parts from the Single Approver definition.</p><p>The next step is to upload this definition in the Kaleo workflow configuration, which is placed in the <span class="strong"><strong>Admin</strong></span> | <span class="strong"><strong>Control Panel</strong></span> | <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Workflow</strong></span> section. After uploading the Kaleo definition, there should be a successful message. Now, the new definition will be visible in the <span class="strong"><strong>Definitions</strong></span> tab.</p><p>The final step is to enable a new workflow definition for the web content article. This step was described in the previous recipe.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec170"/>How it works…</h2></div></div></div><p>This definition uses the fork and join functionality for web content articles. In general, when the author adds a new web content and submits it for publication, Kaleo workflow creates two tasks: UI Quality Review and Content Quality Review. Only after acceptance of these two tasks, the article status changes to approved. When the reviewing process is in progress, an article has a pending status.</p><p>Let's look deeply into fork and join definitions.</p><div class="section" title="The fork element"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec68"/>The fork element</h3></div></div></div><p>Fork has a similar <a id="id536" class="indexterm"/>structure as a state element. The main function of fork is to create a list of tasks in a parallel way. The main elements are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">name</code>: This specifies the name of the fork used in a transition definition</li><li class="listitem"><code class="literal">transitions</code>: This specifies the list of transitions (tasks or states)to be created</li></ul></div><p>The fork element has many other functionalities and elements, such as scripts, timers, actions, and so on. It can have a really complex structure with a huge number of functionalities. In this recipe, we described only the basic function of this element.</p></div><div class="section" title="The join element"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec69"/>The join element</h3></div></div></div><p>Join is an eternal partner of fork. This pair is always together. The main responsibility of this element is waiting unless all parallel tasks are performed and accepted. The join element has the following<a id="id537" class="indexterm"/> structure:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">name</code>: This specifies the name of the join, which is used in a transition definition</li><li class="listitem"><code class="literal">transitions</code>: This specifies the list of transitions. It's usually one transition, which describes a state or task after the joining process.</li></ul></div><p>Join has exactly the same structure as fork. It can have a very complex structure with a whole bunch of functionalities.</p></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec171"/>There's more…</h2></div></div></div><p>Instead of the <code class="literal">join</code> element, it's possible to use the <code class="literal">join-xor</code> element. The main difference between join and <code class="literal">join-xor</code> is<a id="id538" class="indexterm"/> that join waits for the completion of all parallel tasks, but <code class="literal">join-xor</code> waits only for the first complete task.</p><div class="section" title="Join-xor element"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec70"/>Join-xor element</h3></div></div></div><p>The <code class="literal">join-xor</code> element has the <a id="id539" class="indexterm"/>same definition as join:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">name</code>: This specifies the name of the join used in a transition definition.</li><li class="listitem"><code class="literal">transitions</code>: This specifies the list of transitions. It's usually one transition, which describes a state or task after the joining process.</li></ul></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec172"/>See also</h2></div></div></div><p>For more information on managing the web content, refer to <span class="emphasis"><em>Managing and displaying web contents</em></span> recipe in <a class="link" title="Chapter 7. Working with Content" href="part0055.xhtml#aid-1KEEU1">Chapter 7</a>, <span class="emphasis"><em>Working with Content</em></span>.</p></div></div>
<div class="section" title="Kaleo conditions in a message board example" id="aid-21PMQ1"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec63"/>Kaleo conditions in a message board example</h1></div></div></div><p>Kaleo workflow contains conditions. It's possible to use conditions to branch workflows and execute <a id="id540" class="indexterm"/>different tasks. Let's assume that we are message board moderators. In our company, there is a user<a id="id541" class="indexterm"/> who must accept new threads and many users who accept replies in threads. It's possible to achieve this functionality that allows message boards to work this way using Kaleo workflow conditions.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec173"/>How to do it…</h2></div></div></div><p>This definition is similar to the fork and join workflow, but there is a great difference. There is no parallel workflow task. Instead, there is a condition, which moves an entity to a different state. Obviously, workflow is the same: the user creates a new entity and the moderator accepts it. There is little difference seen between roles, which are defined for a particular task.</p><p>As shown in the previous example, let's visualize workflow and define states, tasks, and transitions. The following diagram will help you understand the whole process in a better way:</p><div class="mediaobject"><img src="../Images/image00365.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p><p>The preceding diagram contains following components:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <span class="strong"><strong>created</strong></span> and <span class="strong"><strong>approved</strong></span> state</li><li class="listitem"><span class="strong"><strong>Normal Review</strong></span> and <span class="strong"><strong>Main Thread Review</strong></span> tasks</li><li class="listitem">The condition statement.</li></ul></div><p>Let's define these definitions:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0"?&gt;
&lt;workflow-definition&gt;
  &lt;name&gt;Condition Example&lt;/name&gt;
  &lt;state&gt;
    &lt;name&gt;created&lt;/name&gt;
    &lt;transitions&gt;
      &lt;transition&gt;
        &lt;name&gt;determine-branch&lt;/name&gt;
        <span class="strong"><strong>&lt;target&gt;determine-branch&lt;/target&gt;</strong></span>
      &lt;/transition&gt;
    &lt;/transitions&gt;
  &lt;/state&gt;
  &lt;condition&gt;
    <span class="strong"><strong>&lt;name&gt;determine-branch&lt;/name&gt;</strong></span>
    &lt;script&gt;
      &lt;![CDATA[<span class="strong"><strong>SCRIPT DEFINITION</strong></span>]]&gt;
    &lt;/script&gt;
    &lt;script-language&gt;groovy&lt;/script-language&gt;
    &lt;transitions&gt;
      &lt;transition&gt;
        &lt;name&gt;Normal Review&lt;/name&gt;
        <span class="strong"><strong>&lt;target&gt;Normal Review&lt;/target&gt;</strong></span>
        &lt;default&gt;false&lt;/default&gt;
      &lt;/transition&gt;
      &lt;transition&gt;
        &lt;name&gt;Main Thread Review&lt;/name&gt;
        <span class="strong"><strong>&lt;target&gt;Main Thread Review&lt;/target&gt;</strong></span>
        &lt;default&gt;false&lt;/default&gt;
      &lt;/transition&gt;
    &lt;/transitions&gt;
  &lt;/condition&gt;

  &lt;task&gt;
    <span class="strong"><strong>&lt;name&gt;Normal Review&lt;/name&gt;</strong></span>
    &lt;transitions&gt;
      &lt;transition&gt;
        &lt;name&gt;Submit&lt;/name&gt;
        &lt;target&gt;approved&lt;/target&gt;
      &lt;/transition&gt;
    &lt;/transitions&gt;
  &lt;/task&gt;
  &lt;task&gt;
    <span class="strong"><strong>&lt;name&gt;Main Thread Review&lt;/name&gt;</strong></span>
    &lt;transitions&gt;
      &lt;transition&gt;
        &lt;name&gt;Submit&lt;/name&gt;
        &lt;target&gt;approved&lt;/target&gt;
      &lt;/transition&gt;
    &lt;/transitions&gt;
  &lt;/task&gt;

  &lt;state&gt;&lt;name&gt;approved&lt;/name&gt;&lt;/state&gt;
&lt;/workflow-definition&gt;</pre></div><p>After defining Kaleo<a id="id542" class="indexterm"/>, let's write a conditional script which represents our Kaleo condition. In this example, we will use the Groovy script, which will be placed in the <code class="literal">&lt;script&gt;</code> tag in the <code class="literal">&lt;condition&gt;</code> definition. So, let's define it:</p><div class="informalexample"><pre class="programlisting">import com.liferay.portal.kernel.util.GetterUtil;
import com.liferay.portal.kernel.workflow.WorkflowConstants;
import com.liferay.portlet.messageboards.service.MBMessageLocalServiceUtil;
import com.liferay.portlet.messageboards.model.MBMessage;

String className = (String)workflowContext.get(
WorkflowConstants.CONTEXT_ENTRY_CLASS_NAME);
boolean isMBMessage = false;
if (className.equals(MBMessage.class.getName())) {
  isMBMessage = true;
}
<span class="strong"><strong>returnValue = "Answers Review";</strong></span>
long classPK = GetterUtil.getLong(
(String)workflowContext.get(WorkflowConstants.CONTEXT_ENTRY_CLASS_PK));
if (isMBMessage) {
  MBMessage mbMessage = MBMessageLocalServiceUtil.getMBMessage(classPK);
  if (mbMessage.isRoot()) {
<span class="strong"><strong>    returnValue = "Main Thread Review";</strong></span>
  }
}</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec174"/>How it works…</h2></div></div></div><p>In the preceding example, we explained the workflow definition, which can be applied for all types of asset (for instance, user, web content article, message board, and so on). In every type, there is a typical flow: <span class="strong"><strong>Created</strong></span> | <span class="strong"><strong>Normal Review Task</strong></span> | <span class="strong"><strong>Approved</strong></span>. However, if we apply this workflow for a message board entity, it will have a different flow: <span class="strong"><strong>Created</strong></span> | <span class="strong"><strong>Main Thread Review</strong></span> | <span class="strong"><strong>Approved</strong></span>.</p><p>Why does this happen? Groovy script defines a condition and determines the complete flow.</p><p>The first line gets a <code class="literal">className</code> definition. Next, the if statement checks whether this is a <code class="literal">MBMessage</code> entity.</p><p>The next couple <a id="id543" class="indexterm"/>of lines get the specific <code class="literal">mbMessage</code> object and check whether this object is a root of <code class="literal">MBMessage</code>. It's worth noting that there are predefined values:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">returnValue</code>: This contains the transition's target</li><li class="listitem"><code class="literal">workflowContext</code>: This object implements the <code class="literal">WorflowContext</code> interface</li></ul></div><div class="section" title="Condition statement"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec71"/>Condition statement</h3></div></div></div><p>The <code class="literal">&lt;condition&gt;</code> tag has <a id="id544" class="indexterm"/>the following structure:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">name</code>: This is the name of the condition.</li><li class="listitem"><code class="literal">script</code>: This defines a condition.</li><li class="listitem"><code class="literal">script-language</code>: This defines the language which will be used in the script, for instance: Groovy, BeanShell, DRL, JavaScript, Python, Ruby. The most common use is the BeanShell one.</li><li class="listitem"><code class="literal">transitions</code>: This specifies the list of transitions.</li></ul></div></div></div></div>
<div class="section" title="Kaleo timers" id="aid-22O7C1"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec64"/>Kaleo timers</h1></div></div></div><p>This last recipe concerns timers. This functionality allows users to define specific actions, which should be <a id="id545" class="indexterm"/>performed<a id="id546" class="indexterm"/> after a certain period of time. Let's modify our previous recipe a little with the condition example and add a timer definition. Our assumption is that the task called Main Thread Review <a id="id547" class="indexterm"/>shouldn't wait more than one hour for assignment to any user. After one hour, this task should be assigned to a user with the <code class="literal">test@liferay.com</code> e-mail.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec175"/>How to do it…</h2></div></div></div><p>First of all, open the previous definition and find the Main Thread Review task. Between the assignments tag and the transitions tag, enter the following code:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;task-timers&gt;
  &lt;task-timer&gt;
    &lt;name&gt;default-assignment&lt;/name&gt;
    &lt;delay&gt;
      &lt;duration&gt;1&lt;/duration&gt;
      &lt;scale&gt;hour&lt;/scale&gt;
    &lt;/delay&gt;
    &lt;blocking&gt;true&lt;/blocking&gt;
    &lt;timer-actions&gt;
      &lt;timer-notification&gt;
        &lt;name /&gt;
        &lt;template /&gt;
        &lt;template-language&gt;text&lt;/template-language&gt;
        &lt;notification-type&gt;im&lt;/notification-type&gt;
      &lt;/timer-notification&gt;
      <span class="strong"><strong>&lt;reassignments&gt;</strong></span>
        <span class="strong"><strong>&lt;user&gt;</strong></span>
          <span class="strong"><strong>&lt;email-address&gt;test@liferay.com&lt;/email-address&gt;</strong></span>
        <span class="strong"><strong>&lt;/user&gt;</strong></span>
      <span class="strong"><strong>&lt;/reassignments&gt;</strong></span>
    &lt;/timer-actions&gt;
  &lt;/task-timer&gt;
&lt;/task-timers&gt;</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec176"/>How it works…</h2></div></div></div><p>The Kaleo web plugin<a id="id548" class="indexterm"/> gives users the possibility to react to the user's action after a specific time period. It allows you to assign tasks to specific users, send notifications, and so on.</p><p>The <code class="literal">&lt;task-timers&gt;</code> tag has <a id="id549" class="indexterm"/>the following structure:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">task-timer</code>: This<a id="id550" class="indexterm"/> specifies complex type with the timer's definition.</li><li class="listitem"><code class="literal">name</code>: This <a id="id551" class="indexterm"/>specifies the timer's name.</li><li class="listitem"><code class="literal">delay</code>: This specifies<a id="id552" class="indexterm"/> the delay definition and defines how much time the timer will wait until its actions are executed. For instance 1 hour, 5 minutes, and so on.</li><li class="listitem"><code class="literal">recurrence</code> (not used in this example): This triggers the action several times depending on the <a id="id553" class="indexterm"/>argument specified. For instance, for every 1 hour, definition invokes a specific action.</li><li class="listitem"><code class="literal">blocking</code>: If this is true, stop <a id="id554" class="indexterm"/>the workflow engine execution until the timer is executed.</li><li class="listitem"><code class="literal">timer actions</code>: This<a id="id555" class="indexterm"/> specifies the list of actions to be done after the delay definition.</li></ul></div></div></div></body></html>