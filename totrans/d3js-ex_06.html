<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Creating Scatter and Bubble Plots</h1></div></div></div><p>In this chapter, we extend our examples of using D3.js for plotting data to explain how to create scatter and bubble plots. Scatter and bubble plots visualize multivariate data, as compared to univariate data that is visualized by bar charts. Multivariate data consists of two or more variables, and scatter plots allow us to visualize two variable, and bubble plots extend this to three or four variables.</p><p>We will begin by first creating a simple scatter plot with fixed symbols, based upon stock correlation data. We start with using solid circles for symbols, and will progress through several enhancements including the use of color, outlines, and opacity. We will wrap up scatter plots with an example of multiple, overlying sets of data, each using different symbols and colors.</p><p>When we've finished examining the of creation of a bubble plot, we will extend that example to change the size of the points based upon the data, and then to color the points based upon categorical information. This last example will demonstrate how we can visualize four different variables within a single visualization, and how the use of visuals can help us derive meaning from the underlying information.</p><p>Specifically, in this chapter we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating a basic scatter plot using fixed-sized and solid points</li><li class="listitem" style="list-style-type: disc">Using outlines instead of solid fills to make the plot more legible</li><li class="listitem" style="list-style-type: disc">Adding gridlines to help determine the location of points</li><li class="listitem" style="list-style-type: disc">Extending the scatter plot code to create bubble plots</li></ul></div><div><div><div><div><h1 class="title"><a id="ch06lvl1sec32"/>Creating scatter plots</h1></div></div></div><p>Scatter plots consist<a id="id271" class="indexterm"/> of two axes, one for each variable. Each axis can be based on continuous or categorical variables. For each measurement (a <strong>measurement</strong> being the paired <a id="id272" class="indexterm"/>combination of <em>X</em> and <em>Y</em> values), a symbol is placed on the plot at the specified location. The end result is a plot that allows the person viewing it to determine how much one variable is affected by the other.</p><p>Underpinning our first few examples will be a data set that represents the correlation between the AAPL and MSFT stocks on a daily basis for the year 2014. For purposes of creating a scatter plot, the meaning of this data is not important—it is just that it represents two <a id="id273" class="indexterm"/>dimensional data, where the value for each stock represents a location on the respective axis.</p><p>The data for this <a id="id274" class="indexterm"/>example is available at <a class="ulink" href="https://goo.gl/BZkC8B">https://goo.gl/BZkC8B</a>.</p><p>Opening this link in the browser, you will see the following as the first few lines of the data:</p><div><pre class="programlisting">Date,AAPL,MSFT
2014-01-02,-0.01406,-0.00668
2014-01-03,-0.02197,-0.00673
2014-01-06,0.00545,-0.02113
2014-01-07,-0.00715,0.00775
2014-01-08,0.00633,-0.01785
2014-01-09,-0.01277,-0.00643
2014-01-10,-0.00667,0.01435
2014-01-13,0.00524,-0.02941
2014-01-14,0.0199,0.02287
2014-01-15,0.02008,0.02739</pre></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec38"/>Plotting points</h2></div></div></div><p>Our first example will<a id="id275" class="indexterm"/> demonstrate the process of drawing points in a scatter plot. To keep it simple, it forgoes the axes and other stylistic elements (these <a id="id276" class="indexterm"/>will be added in the next example).</p><p>The example is available<a id="id277" class="indexterm"/> at the following location:</p><div><div><h3 class="title"><a id="note82"/>Note</h3><p>bl.ock (6.1): <a class="ulink" href="http://goo.gl/Uv6aSj">http://goo.gl/Uv6aSj</a>
</p></div></div><p>The resulting plot is seen in the following image:</p><div><img src="img/B04320_06_01.jpg" alt="Plotting points"/></div><p>Now let's examine how this is created. The example starts by loading the data:</p><div><pre class="programlisting">var url = "https://gist.githubusercontent.com/d3byex/520e6dcb30e673c149cc/raw/432623f00f6740021bdc13141612ac0b6196b022/corr_aapl_msft.csv";
d3.csv(url, function (error, rawData) {</pre></div><div><div><h3 class="title"><a id="note83"/>Note</h3><p>The entire URL has to be specified, as apparently, the data load functions do not follow redirects.</p></div></div><p>We need to convert<a id="id278" class="indexterm"/> the properties AAPL and MSFT from strings to numbers. We do this by creating a new array of objects with <code class="literal">X</code> and <code class="literal">Y</code> properties, with<a id="id279" class="indexterm"/> AAPL mapped into <code class="literal">X</code> and MSFT into <code class="literal">Y</code>, which also converts the data type:</p><div><pre class="programlisting">    var data = rawData.map(function(d) {
        return { X: +d.AAPL, Y: +d.MSFT }
    });</pre></div><p>To effectively scale a scatter plot, we need to know the extents of the data in both the <code class="literal">X</code> and <code class="literal">Y</code> series:</p><div><pre class="programlisting">    var xExtents = d3.extent(data, function(d) { return d.X; });
    var yExtents = d3.extent(data, function(d) { return d.Y; });</pre></div><p>These values will help us create the scales that are required for both dimensions of the graph. This plot will actually use the maximum absolute value of these four extents. We can determine this value with the following:</p><div><pre class="programlisting">var maxExtent = d3.max(
    xExtents.concat(yExtents), 
    function(d) { return Math.abs(d); 
});</pre></div><p>We are now ready to create the properties of the graph, including its width, height, and the size of the radius for the circles that will represent the points:</p><div><pre class="programlisting">    var graphWidth = 400, graphHeight = 400;
    var radius = 5;</pre></div><p>Now we have all of the information required to create the scale needed to map the data into the locations in the rendering:</p><div><pre class="programlisting">    var scale = d3.scale.linear()
        .domain([-maxExtent, maxExtent])
        .range([0, graphWidth]);</pre></div><div><div><h3 class="title"><a id="note84"/>Note</h3><p>This example (and those in the remainder of this chapter) scale the data such that the domain is the negative and positive of the absolute values of the extents. In simple terms, this<a id="id280" class="indexterm"/> scale ensures that when rendering into a square canvas, all points are visible and any specific distance along the <em>X</em> dimension represents an identical change in the value of the data as the distance along the <em>Y</em> dimension.</p></div></div><p>The rendering begins <a id="id281" class="indexterm"/>with the creation of the main SVG element:</p><div><pre class="programlisting">    var svg = d3.select('body')
        .append('svg')
        .attr('width', graphWidth)
        .attr('height', graphHeight);</pre></div><p>Finally, we create a circle of the specified radius to represent each point:</p><div><pre class="programlisting">    svg.selectAll('circle')
        .data(data)
        .enter()
        .append('circle')
        .attr({
            cx: function(d) { return xScale(d.AAPL); },
            cy: function(d) { return yScale(d.MSFT); },
            r: radius,
            fill: 'steelblue'
        });
}); // closing the call to d3.csv</pre></div><p>Congratulations, you have created your first scatter plot!</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec39"/>Sprucing up the scatter plot</h2></div></div></div><p>There are several<a id="id282" class="indexterm"/> issues with the plot in the previous example. First, notice that there is a circle that is clipped towards the right boundary. With the code as it is, one point, the one at the maximum extent, will have half of its area clipped. This can easily be resolved by including margins that are at least half of the radius of the circles.</p><p>Another issue is that there are a lot of circles that overlap, confusing the visual understanding of the data. A common means of addressing this issue in scatter plots is not to use a solid fill in the circles, and simply use an outline instead.</p><p>A final issue, which is really just a decision made to keep the previous example simple, is not to have any axes. The<a id="id283" class="indexterm"/> example at the following link addresses each of these concerns:</p><div><div><h3 class="title"><a id="note85"/>Note</h3><p>bl.ock (6.2): <a class="ulink" href="http://goo.gl/4T1aGZ">http://goo.gl/4T1aGZ</a>
</p></div></div><p>The preceding<a id="id284" class="indexterm"/> example has the following output:</p><div><img src="img/B04320_06_02.jpg" alt="Sprucing up the scatter plot"/></div><p>This result is a much more effective scatter plot. We can make sense of the previously obscured points, and the axes give us a sense of the values at each point.</p><p>The changes to the code are relatively minor. Besides adding axes by using the code that we have seen in other examples (including grouping groups for the various main elements), and sizing the main SVG element to account for those axes, the only change is in the way the circles are created:</p><div><pre class="programlisting">graphGroup.selectAll('circle')
    .data(data)
    .enter()
    .append('circle')
    .attr({
        cx: function(d) { return scale(d.X); },
        cy: function(d) { return scale(d.Y); },
        r: radius,
        fill: 'none',
        stroke: 'steelblue'
    });</pre></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec12"/>Adding gridlines</h3></div></div></div><p>Our scatter plot<a id="id285" class="indexterm"/> would be more effective if it had gridlines. The way in which we add gridlines to a chart in D3.js is actually a little trick: gridlines are actually the ticks of an axis, the ticks being the width or height of the graphic with both the labels and main line of the axis hidden.</p><p>To add<a id="id286" class="indexterm"/> gridlines to our plot, we will create two additional axes. The horizontal gridlines will be rendered by creating a left-oriented axis positioned in the right margin. We will set the labels on this axis to be empty and the line of the axis to be hidden. The ticks are then sized to extend all the way back to the other axis in the left margin. We will perform a similar process to create the vertical gridlines except with a bottom axis<a id="id287" class="indexterm"/> placed in the top margin.</p><div><div><h3 class="title"><a id="note86"/>Note</h3><p>bl.ock (6.3): <a class="ulink" href="http://goo.gl/ZmrY4H">http://goo.gl/ZmrY4H</a>
</p></div></div><p>And the resulting graph is shown in the following image:</p><div><img src="img/B04320_06_03.jpg" alt="Adding gridlines"/></div><p>The only difference<a id="id288" class="indexterm"/> from the previous examples are the several lines for creating these new axes and a function to style them:</p><div><pre class="programlisting">var yGridlinesAxis = d3.svg.axis().scale(scale).orient("left");
var yGridlineNodes = svg.append('g')
    .attr('transform', 'translate(' + (margins.left + graphWidth)
                       + ',' + margins.top + ')')
    .call(yGridlinesAxis
          .tickSize(graphWidth + axisPadding, 0, 0)
          .tickFormat(""));
styleGridlineNodes(yGridlineNodes);</pre></div><p>The code begins with creating a left-oriented axis, and then renders it in a group which is translated to the right margin.</p><p>Instead of <a id="id289" class="indexterm"/>simply passing the axis object to <code class="literal">.call()</code>, we first call two of its functions. The first, <code class="literal">.tickSize()</code>, sets the size of the ticks to stretch across the entire area where the points will be rendered. Calling <code class="literal">.tickFormat("")</code> informs the axis that the labels should be empty.</p><p>Now we just need to perform a little styling on the axis. This is performed by the <code class="literal">styleGridLineNodes()</code> function:</p><div><pre class="programlisting">function styleGridlineNodes(axisNodes) {
    axisNodes.selectAll('.domain')
        .attr({
            fill: 'none',
            stroke: 'none'
        });
    axisNodes.selectAll('.tick line')
        .attr({
            fill: 'none',
            'stroke-width': 1,
            stroke: 'lightgray'
        });
}</pre></div><p>This sets the fill and stroke of the main line of the axis so that it is not visible. It then makes the actual<a id="id290" class="indexterm"/> ticks light gray.</p><p>The vertical gridlines are then created by a similar process:</p><div><pre class="programlisting">var xGridlinesAxis = d3.svg.axis().scale(scale).orient("bottom");
var xGridlineNodes = svg.append('g')
    .attr('transform', 'translate(' + margins.left + ',' + 
            (totalHeight - margins.bottom + axisPadding) + ')')
    .call(xGridlinesAxis
          .tickSize(-graphWidth - axisPadding, 0, 0)
          .tickFormat(""));
styleGridlineNodes(xGridlineNodes);</pre></div><p>A final point about this process is the sequence of the renderings: gridlines, then axes, then the <a id="id291" class="indexterm"/>points. This ensures that each of these appear on top of the others. It is most important for the points to be on top of the gridlines and axes, but the gridlines also being behind the visible axes is good practice. It gives you a little wiggle room to be a few pixels long on the gridlines.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec33"/>Creating a bubble plot</h1></div></div></div><p>Bubble plots help<a id="id292" class="indexterm"/> us to visualize three or four dimensions of data. Each datum in a bubble plot consists not only of two values used to plot against the <em>X</em> and <em>Y</em> axes, but also one or two additional values which are commonly represented by different size symbols and/or colors.</p><p>To demonstrate a bubble plot, the following image shows the result of our example:</p><div><img src="img/B04320_06_04.jpg" alt="Creating a bubble plot"/></div><p>The data behind this chart is a data set that was pulled together from three different datasets from the World Bank. This data correlates life expectancy at birth relative to the fertility rate for all the countries in the World Bank data for the year 2013.</p><p>This chart plots<a id="id293" class="indexterm"/> age along the <em>X</em> axis and the birth rate along the <em>Y</em> axis. The relative population of a country is represented by the size of the circle, and the color of the circle represents the economic region of the country as categorized by the World Bank.</p><p>We won't dive deeply<a id="id294" class="indexterm"/> into this data. It is available at <a class="ulink" href="https://goo.gl/K3yuuy">https://goo.gl/K3yuuy</a>.</p><p>The first few lines of the data are the following:</p><div><pre class="programlisting">CountryCode,CountryName,LifeExp,FertRate,Population,Region
ABW,Aruba,75.33217073,1.673,102911,Latin America &amp; Caribbean
AFG,Afghanistan,60.93141463,4.9,30551674,South Asia</pre></div><div><div><h3 class="title"><a id="note87"/>Note</h3><p>If you want to check<a id="id295" class="indexterm"/> out the original data, you can use the following links:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Life expectancy (in years) at birth: <a class="ulink" href="http://data.worldbank.org/indicator/SP.DYN.LE00.IN">http://data.worldbank.org/indicator/SP.DYN.LE00.IN</a></li><li class="listitem" style="list-style-type: disc">Fertility rate: <a class="ulink" href="http://data.worldbank.org/indicator/SP.DYN.TFRT.IN">http://data.worldbank.org/indicator/SP.DYN.TFRT.IN</a></li><li class="listitem" style="list-style-type: disc">Total population: <a class="ulink" href="http://data.worldbank.org/indicator/SP.POP.TOTL">http://data.worldbank.org/indicator/SP.POP.TOTL</a></li></ul></div></div></div><p>The code<a id="id296" class="indexterm"/> for the example is<a id="id297" class="indexterm"/> available at the following link:</p><div><div><h3 class="title"><a id="note88"/>Note</h3><p>bl.ock (6.4): <a class="ulink" href="http://goo.gl/KQJceE">http://goo.gl/KQJceE</a>
</p></div></div><p>The example starts <a id="id298" class="indexterm"/>with the loading of data and converting the data types:</p><div><pre class="programlisting">var url = "https://gist.githubusercontent.com/d3byex/30231953acaa9433a46f/raw/6c7eb1c562de92bdf8d0cd99c6912048161c187e/fert_pop_exp.csv";
    var data = rawData.map(function(d) {
        return {
            CountryCode: d.CountryCode,
            CountryName: d.CountryName,
            LifeExp: +d.LifeExp,
            FertRate: +d.FertRate,
            Population: +d.Population,
            Region: d.Region
        }
    });</pre></div><p>Now we define several variables for defining the minimum and maximum bubble size and the margins, which we will set to be half of the radius of the largest bubble:</p><div><pre class="programlisting">var minBubbleSize = 5, maxBubbleSize = 50;
var margin = { left: maxBubbleSize/2, top: maxBubbleSize/2,
               bottom: maxBubbleSize/2, right: maxBubbleSize/2
};</pre></div><p>This particular plot requires three linear scales and one ordinal scale based upon the following four series of data:</p><div><pre class="programlisting">var lifeExpectancy = data.map(function(d) { return d.LifeExp; });
var fertilityRate = data.map(function(d) { return d.FertRate; });
var population = data.map(function(d) { return d.Population; });
var regions = data.map(function(d) { return d.Region; });</pre></div><p>The scale for the <em>X</em> axis will vary from the minimum to the maximum life expectancy:</p><div><pre class="programlisting">var xScale = d3.scale.linear()
    .domain([d3.min(lifeExpectancy), d3.max(lifeExpectancy)])
    .range([0, graphWidth]);</pre></div><p>The <em>Y</em> axis will range from the maximum fertility rate at the top to <code class="literal">0</code> at the bottom:</p><div><pre class="programlisting">var yScale = d3.scale.linear()
    .domain([d3.max(fertilityRate), 0])
    .range([0, graphHeight]);</pre></div><p>The size of each bubble represents the population, and will range in radius from the minimum to the maximum values configured earlier:</p><div><pre class="programlisting">var popScale = d3.scale.linear()
    .domain(d3.extent(population))
    .range([minBubbleSize, maxBubbleSize]);</pre></div><p>Each bubble will be colored based upon the value of the region. To do this, we set up a mapping between <a id="id299" class="indexterm"/>each of the unique names of the regions and a 10-color categorical scale:</p><div><pre class="programlisting">var uniqueRegions = d3.set(regions).values();
var regionColorMap = d3.scale.ordinal()
    .domain(uniqueRegions)
    .range(d3.scale.category10().range());</pre></div><p>Now we can start rendering the visuals, starting with the axes:</p><div><pre class="programlisting">var yAxis = d3.svg.axis().scale(yScale).orient('left');
var yAxisNodes = svg.append('g')
    .attr('transform', 'translate(' + 
          (margin.left - axisPadding) + ',' + margin.top + ')')
    .call(yAxis);
styleAxisNodes(yAxisNodes);

var xAxis = d3.svg.axis().scale(xScale).orient('bottom');
var xAxisNodes = svg.append('g')
    .attr('transform', 'translate(' + margin.left + ',' +
          (totalHeight - margin.bottom + axisPadding) + ')')
    .call(xAxis);
styleAxisNodes(xAxisNodes);</pre></div><p>The final task is to render the bubbles:</p><div><pre class="programlisting">svg.append('g')
    .attr('transform', 'translate(' + margin.left + ',' +
                                      margin.top + ')')
    .selectAll('circle')
    .data(data)
    .enter()
    .append('circle')
    .each(function(d) {
        d3.select(this).attr({
            cx: xScale(d.LifeExp),
            cy: yScale(d.FertRate),
            r: popScale(d.Population),
            fill: regionColorMap(d.Region),
            stroke: regionColorMap(d.Region),
            'fill-opacity': 0.5
        });
    });</pre></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec34"/>Summary</h1></div></div></div><p>In this chapter, we put together several examples of creating scatter and bubble plots. You learned a number of techniques for organizing data that represents between two and four distinct dimensions, using axes for two of the dimensions, and then using color and size-of-points as two more.</p><p>In the next chapter, we will begin with animation. We will start with the fundamentals of animation, and by the end of the chapter, we will extend this chapter's final example and use animation to represent an extra dimension, a fifth dimension—time.</p></div></body></html>