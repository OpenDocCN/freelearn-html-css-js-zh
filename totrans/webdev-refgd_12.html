<html><head></head><body><div class="chapter" title="Chapter&#xA0;12.&#xA0;Server-side JavaScript &#x2013; NodeJS"><div class="titlepage"><div><div><h1 class="title"><a id="ch12"/>Chapter 12. Server-side JavaScript – NodeJS</h1></div></div></div><p>Node.js is a relatively new server platform that is built on JavaScript. One of the main features of Node is that it is a non-blocking server. This means that resource-intensive tasks will not tie up the server. Node.js can then handle many concurrent connections. It can also handle real-time communications more easily than a blocking server.</p><p>One of the main uses of Node.js is as a web server. This is a perfect task as serving web pages usually involves reading files and connecting to a database. It is able to serve more clients while either of these two actions are executing. This is very different compared to a blocking server. A blocking server would have to wait for all the resources to return before it could respond to more requests.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note58"/>Note</h3><p>Note that this reference will only be Node.js specific; we will not cover any frameworks or libraries in this chapter.</p></div></div><p>The most popular frameworks are useful and should be utilized whenever possible, but our focus will only be on functions and modules that are included with Node.js. There will be no coverage of <a class="indexterm" id="id2553"/>
<span class="strong"><strong>Express</strong></span> (arguably, the most used Node.js framework). Most importantly, we will cover the building blocks of Node.js that Express and its dependencies are built on.</p><p>A great book that covers frameworks and more is <span class="emphasis"><em>Building Scalable Apps with Redis and Node.js</em></span> by Packt Publishing.</p><p>In this chapter, the following groups of references will be described, accompanied with examples:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">File and process management:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Modules</li><li class="listitem" style="list-style-type: disc">OS (operating system)</li><li class="listitem" style="list-style-type: disc">Process</li><li class="listitem" style="list-style-type: disc">File</li><li class="listitem" style="list-style-type: disc">Path</li><li class="listitem" style="list-style-type: disc">REPL (Read Eval Print Loop)</li><li class="listitem" style="list-style-type: disc">Errors</li></ul></div></li><li class="listitem" style="list-style-type: disc">Utilities:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Events</li><li class="listitem" style="list-style-type: disc">Crypto</li><li class="listitem" style="list-style-type: disc">Buffer</li><li class="listitem" style="list-style-type: disc">Console</li><li class="listitem" style="list-style-type: disc">Npm (Node Package Manager)</li><li class="listitem" style="list-style-type: disc">Stream</li></ul></div></li><li class="listitem" style="list-style-type: disc">Net modules:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">createServer</li><li class="listitem" style="list-style-type: disc">net.Server</li></ul></div></li><li class="listitem" style="list-style-type: disc">HTTP:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Server</li><li class="listitem" style="list-style-type: disc">IncomingMessage</li><li class="listitem" style="list-style-type: disc">ServerResponse</li><li class="listitem" style="list-style-type: disc">clientRequest</li></ul></div></li></ul></div><div class="section" title="File and process management"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec81"/>File and process management</h1></div></div></div><p>We will start our <a class="indexterm" id="id2554"/>overview of Node.js with the basics. This will include loading modules, managing processes, handling files and paths, and <a class="indexterm" id="id2555"/>
<span class="strong"><strong>REPL</strong></span> (<span class="strong"><strong>Read Eval Print Loop</strong></span>). These are things that virtually any Node.js project will need.</p><div class="section" title="Modules"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec508"/>Modules</h2></div></div></div><p>Node.js is a <a class="indexterm" id="id2556"/>modular system. Much of the functionality of <a class="indexterm" id="id2557"/>Node.js is contained in modules that must be loaded at runtime. This makes the knowledge of loading and building modules a core requirement to using Node. Here are the references you can use for your Node modules:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">require()</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">modules.export</code></li></ul></div><div class="section" title="require()"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec741"/>require()</h3></div></div></div><p>This loads the <a class="indexterm" id="id2558"/>module at the given path:</p><div class="informalexample"><pre class="programlisting">require(path)</pre></div><div class="section" title="Return value"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec607"/>Return value</h4></div></div></div><p>The return value <a class="indexterm" id="id2559"/>will be an object. The properties of this object will vary, depending on what is loaded. We will cover <code class="literal">module.exports</code> next, which is what module designers and even you can use to set the value of this return value.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec608"/>Description</h4></div></div></div><p>The <code class="literal">require()</code> function is <a class="indexterm" id="id2560"/>used to load the module at a path, where the path can be a core module (a module packaged with Node.js), directory, file, or module (a project that you or someone else has built). As a result, it is very versatile. The <code class="literal">require()</code> function will try to resolve the passed-in path in this order: the core module, the directory or file if the path begins with "./", "/", "../", and then the module, take a look at the following description for more information. You then need to check the require function in different locations for all of this to work:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You will first look for a core module. The core modules can be viewed in the source of Node.js under the lib directory. We will cover the most prolifically used modules in this chapter.</li><li class="listitem" style="list-style-type: disc">Next, require would load the path as a file if the string begins with "./" ,"/", or "../". These are current directory, root directory, and parent directory, respectively.</li><li class="listitem" style="list-style-type: disc">If the filename is not found, require will then try appending <code class="literal">.js</code>, <code class="literal">.json</code>, or <code class="literal">.node</code>. This means that the <code class="literal">require (./data/models)</code> function and <code class="literal">require (./data/models,js)</code> will load the same file. If require does not find a file, then it will try to load the path as a directory. This means it will look for either an <code class="literal">index.js</code> file or the main property inside <code class="literal">package.json</code>. Require will then either use <code class="literal">index.js</code> or <code class="literal">package.json</code> to load as a file.</li><li class="listitem" style="list-style-type: disc">Finally, if the path does not start with "./", "/", or "../" and it is not a core module, require will search for a <code class="literal">node_modules</code> folder. The first directory will be the <code class="literal">current</code> directory. After that, each directory will be a parent directory, all the way up to the <code class="literal">root</code> directory. In addition to this, require will also search the paths in the <code class="literal">NODE_PATH</code> environment variable.</li></ul></div><p>As a quick summary, here is the order that require will use:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Core module (no relative path)</li><li class="listitem" style="list-style-type: disc">File module (relative path)</li><li class="listitem" style="list-style-type: disc">Folder module (relative path)</li><li class="listitem" style="list-style-type: disc">The <code class="literal">node_modules</code> module (no relative path)</li></ul></div><p>Here are some examples <a class="indexterm" id="id2561"/>of how the require function is used to load core modules, files, or modules:</p><div class="informalexample"><pre class="programlisting">var http = require('http'); //loads a core module</pre></div><p>As you can see from the comment, this example will load the HTTP core module:</p><div class="informalexample"><pre class="programlisting">var data = require('./data'); //loads a directory</pre></div><p>This example shows you how to load a directory:</p><div class="informalexample"><pre class="programlisting">var dataModels = require('./data/models'); //loads the file models.js</pre></div><p>This one will load a file:</p><div class="informalexample"><pre class="programlisting">var redis = require('redis'); //loads a module</pre></div><p>Finally, this one will load a module.</p><p>Every Node.js project will use require many times, so knowing how and where it will load is important.</p><p>Here is a simple example that demonstrates require and how it works with <code class="literal">module.exports</code>.</p><p>Here is the file that will be loaded with require, <code class="literal">requireTest.js</code>, and it will be loaded from a relative path:</p><div class="informalexample"><pre class="programlisting">module.exports = 'This value is from requireTest';</pre></div><p>Here is how to load this value in a Node.js script:</p><div class="informalexample"><pre class="programlisting">var requireTest = require('./requireTest');
console.log(requireTest);</pre></div></div></div><div class="section" title="module.exports"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec742"/>module.exports</h3></div></div></div><p>The <a class="indexterm" id="id2562"/>
<code class="literal">module.exports</code> property is a convenience <a class="indexterm" id="id2563"/>property used in a module to expose the functionality of the module outside the scope of the current file.</p><div class="section" title="Return value"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec609"/>Return value</h4></div></div></div><p>The <code class="literal">module.exports</code> property is the return value from the module. This can seem misleading though. We <a class="indexterm" id="id2564"/>will not return <code class="literal">module.exports</code>. It is the object or properties set at <code class="literal">module.exports</code> that are available from this module.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec610"/>Description</h4></div></div></div><p>The <code class="literal">module.exports</code> <a class="indexterm" id="id2565"/>property is the link from the current file into the scope of the calling file. Any variables defined in the current file will not be in the scope of file that calls it. To make the variables available, you must either set them as the value of <code class="literal">module.exports</code> or as properties of <code class="literal">module.exports</code>. This functionality is the mechanism that Node.js uses with require. Exports can be set to any type: string, integer, function, object, and many others. Functions allow us to either pass in values or create a <code class="literal">constructor()</code> function. Objects can be created and then used to overwrite the exports object or can be added to the exports object as properties. We have all of JavaScript's function- and object-creation tricks at our disposal.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note59"/>Note</h3><p>A quick note is that require will cache output. This means consecutive calls to the same module will return the same instance of an object.</p></div></div><p>Examples of the <code class="literal">constructor()</code> function being used are shown here:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">This allows an object to be passed in:<div class="informalexample"><pre class="programlisting">module.exports = function Foo(bar) {do something with bar};</pre></div></li><li class="listitem" style="list-style-type: disc">This allows the export function to be executed:<div class="informalexample"><pre class="programlisting">module.exports = function FooConstructor() {};</pre></div></li><li class="listitem" style="list-style-type: disc">The <code class="literal">foo</code> property will be used in the following two examples:<div class="informalexample"><pre class="programlisting">module.exports = {foo: foo()};
module.exports.foo = foo();</pre></div></li></ul></div></div></div></div><div class="section" title="The OS module"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec509"/>The OS module</h2></div></div></div><p>Here are the <a class="indexterm" id="id2566"/>most important functions and properties of the <a class="indexterm" id="id2567"/>
<code class="literal">os</code> module. The <code class="literal">os</code> module allows you to get information from the operating system. This is important as we may need to know the hostname or how many CPUs are currently available.</p><p>All the functions that we will look at now assume that <code class="literal">var os = require('os')</code> is already in the file.</p><div class="section" title="hostname()"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec743"/>hostname()</h3></div></div></div><p>This will <a class="indexterm" id="id2568"/>return the hostname of the device:</p><div class="informalexample"><pre class="programlisting">.hostname()</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec611"/>Description</h4></div></div></div><p>An example of how the <code class="literal">os.hostname()</code> function <a class="indexterm" id="id2569"/>is used is shown here. In this case, it will return the hostname of the current computer used. It will not return the domain suffix of the computer:</p><div class="informalexample"><pre class="programlisting">os.hostname();</pre></div></div></div><div class="section" title="cpus()"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec744"/>cpus()</h3></div></div></div><p>This <a class="indexterm" id="id2570"/>will return the number of CPUs of the current device:</p><div class="informalexample"><pre class="programlisting">.cpus()</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec612"/>Description</h4></div></div></div><p>We will get an <a class="indexterm" id="id2571"/>array of objects that map to each CPU. The objects will have the model, speed, and times:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Model and speed are the processor model and speed of the CPU, respectively. Note that, most of the time, model and speed will not be relevant to our code.</li><li class="listitem" style="list-style-type: disc">Times has the breakdown of how many milliseconds the CPU has spent in <code class="literal">user</code>, <code class="literal">nice</code>, <code class="literal">sys</code>, <code class="literal">idle</code>, and <code class="literal">irq</code>.</li></ul></div><p>This information can be used, most of the time, to find out how many CPUs the machine has. It is good to know this information, as Node.js is single threaded and we can launch multiple processes in a cluster for each CPU.</p><p>Here is an example of getting the number of CPUs on a computer:</p><div class="informalexample"><pre class="programlisting">var cpus = os.cpus().length;</pre></div></div></div><div class="section" title="networkInterfaces()"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec745"/>networkInterfaces()</h3></div></div></div><p>This <a class="indexterm" id="id2572"/>gets a list of network interfaces:</p><div class="informalexample"><pre class="programlisting">.networkInterfaces()</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec613"/>Description</h4></div></div></div><p>This will be an <a class="indexterm" id="id2573"/>object that contains all the network interfaces. Each property maps to an interface and it will have an array of all the IP addresses (IPv4 and IPv6).</p><p>As an example, this is how you can get the object that has all the interfaces for a computer:</p><div class="informalexample"><pre class="programlisting">var network = os.networkInterfaces();</pre></div></div></div></div><div class="section" title="The process module"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec510"/>The process module</h2></div></div></div><p>Process is an <a class="indexterm" id="id2574"/>object that allows us to get access to events on the process. We can also get access to <code class="literal">stdin</code>, <code class="literal">stdout</code>, and <code class="literal">stderr</code>. These are global <a class="indexterm" id="id2575"/>objects that will be available in any file or context.</p><div class="section" title="stdout"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec746"/>stdout</h3></div></div></div><p>The <code class="literal">stdout</code> <a class="indexterm" id="id2576"/>object is a writable stream.</p><div class="informalexample"><pre class="programlisting">stdout</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec614"/>Description</h4></div></div></div><p>This is the stream that will <a class="indexterm" id="id2577"/>connect to <code class="literal">stdout</code>. Note that streams will be covered later in this chapter under Utilites. If we are running Node.js as a console application, this is where we could write to <code class="literal">stdout</code> if needed. Most streams in Node are non-blocking, but writes to stdout and stderr are blocking.</p><p>We also can use <code class="literal">stdout</code> to find out whether Node.js is running in TTY. We can access <code class="literal">process.stdout.isTTY</code>. This is a Boolean value.</p><p>The example here will show us how to write a message to the <code class="literal">stdout</code> stream. By default, this will be sent to the <code class="literal">process.stdout.write</code> console. This will write to <code class="literal">stdout</code>.</p></div></div><div class="section" title="stderr"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec747"/>stderr</h3></div></div></div><p>The <code class="literal">stderr</code> <a class="indexterm" id="id2578"/>object is a writable stream.</p><div class="informalexample"><pre class="programlisting">stderr</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec615"/>Description</h4></div></div></div><p>This is similar to <a class="indexterm" id="id2579"/>
<code class="literal">stdout</code>, with the key difference being it writes to <code class="literal">stderr</code>. This is very useful for console applications as we can write to the console what is happening.</p><p>As an example, this writes to the <code class="literal">stderr</code> stream. By default this will write to the console.</p><div class="informalexample"><pre class="programlisting">process.stderr.write("Something seems to have gone wrong.");</pre></div></div></div><div class="section" title="stdin"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec748"/>stdin</h3></div></div></div><p>This is a readable <a class="indexterm" id="id2580"/>stream that maps to <code class="literal">stdin</code>.</p><div class="informalexample"><pre class="programlisting">stdin</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec616"/>Description</h4></div></div></div><p>This maps to the standard <a class="indexterm" id="id2581"/>stream, <code class="literal">stdin</code>, in the same way <code class="literal">stdout</code> and <code class="literal">stderr</code> map to the <code class="literal">stderr</code> streams. The difference is that the <code class="literal">stdin</code> object is readable, while the others are writable. Anything that is piped into this process can be read out using <code class="literal">process.stdin</code>. To read from a readable stream, we will have to listen for two possible events that let us know how we can retrieve data. The first is readable, and the other is data. We will cover this more in depth when we get to the stream section.</p><p>For instance, this example <a class="indexterm" id="id2582"/>takes the data that is sent in through <code class="literal">stdin</code> and sends it to <code class="literal">stdout</code> using the readable event:</p><div class="informalexample"><pre class="programlisting">process.stdin.on('readable', function() {
  var data = process.stdin.read();
  if(data !== null) process.stdout.write(data);
});</pre></div></div></div><div class="section" title="argv"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec749"/>argv</h3></div></div></div><p>This is all the <a class="indexterm" id="id2583"/>command-line arguments passed in:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>argv</strong></span>
</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec617"/>Description</h4></div></div></div><p>The <code class="literal">argv</code> commands <a class="indexterm" id="id2584"/>will be an array of all the arguments passed into this script. Arguments are split by spaces. This means that <code class="literal">debug=true</code> (which has no spaces) will be one argument, and <code class="literal">debug = true</code> (a space between each word) will be three. This is an important distinction to keep in mind if you want to pass values in arguments. Arguments <code class="literal">0</code> and <code class="literal">1</code> will always be the node and the path and filename of the current script.</p><p>Here is an example:</p><div class="informalexample"><pre class="programlisting">process.argv.forEach(function(val){ if(val === 'debug'){ debug(); } });</pre></div></div></div><div class="section" title="Signal events"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec750"/>Signal events</h3></div></div></div><p>Signal events <a class="indexterm" id="id2585"/>allow you to listen for the standard POSIX signals:</p><div class="informalexample"><pre class="programlisting">process.on({signal, callback});</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec618"/>Description</h4></div></div></div><p>All of the <code class="literal">POSIX</code> <a class="indexterm" id="id2586"/>signals, except <code class="literal">SIGKILL</code> and <code class="literal">SIGSTOP</code>, can be listened for. In addition to these signals, you can also listen for some Windows signals. Here is the list of signals:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">SIGUSR1</code>: This is a user-defined signal. In Node.js, it is usually used to start the debugger.</li><li class="listitem" style="list-style-type: disc"><code class="literal">SIGTERM</code>: This is the signal to terminate.</li><li class="listitem" style="list-style-type: disc"><code class="literal">SIGINT</code>: This is the signal to interrupt. It is usually sent by pressing <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>C</em></span>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">SIGPIPE</code>: This lets a process know when it is trying to pipe to a nonexistent process.</li><li class="listitem" style="list-style-type: disc"><code class="literal">SIGHUP</code>: This is the <a class="indexterm" id="id2587"/>signal that tells a process that the terminal it was running in has hung up.</li><li class="listitem" style="list-style-type: disc"><code class="literal">SIGBREAK</code>: This is non-POSIX and is used by Windows. It should be used in a manner similar to <code class="literal">SIGINT</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">SIGWINCH</code>: This is the signal to tell the process that the window has changed size.</li></ul></div><p>Here is an example of listening for <code class="literal">SIGINT</code>, which recognizes that <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>C</em></span> was pressed:</p><div class="informalexample"><pre class="programlisting">process.on('SIGINT', function(){
  //ctrl+c was pressed
});</pre></div></div></div><div class="section" title="process.env"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec751"/>process.env</h3></div></div></div><p>This object <a class="indexterm" id="id2588"/>contains the environment variables:</p><div class="informalexample"><pre class="programlisting">process.env</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec619"/>Description</h4></div></div></div><p>The <code class="literal">process.env</code> <a class="indexterm" id="id2589"/>object is a simple JavaScript object that contains all the environment variables. Each property will be a string.</p><p>A great place to put configuration settings is in the environment when building an extensible application. The <code class="literal">process.env</code> object can then be used to check whether the current environment is in production or even to just store the configuration settings.</p><p>Here is an example of checking for environment and setting a value from the environment:</p><div class="informalexample"><pre class="programlisting">if(process.env.NODE_ENV !== 'production')
  //do test stuff
var redisHost = process.env.REDIS_HOST;</pre></div></div></div><div class="section" title="kill"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec752"/>kill</h3></div></div></div><p>This will <a class="indexterm" id="id2590"/>send a signal event to a process:</p><div class="informalexample"><pre class="programlisting">process.kill(pid, [signal])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec620"/>Description</h4></div></div></div><p>This will send <a class="indexterm" id="id2591"/>any of the signal events that are defined in the signal events section, which that we covered earlier. This is essentially running the <code class="literal">POSIX</code> kill command.</p><p>We can use this kill command to send the current process a signal, using <code class="literal">process.pid</code>, or to send another process that we have a reference to the kill signal.</p><p>Here is an example of killing the specific process ID <code class="literal">4634</code>:</p><div class="informalexample"><pre class="programlisting">process.kill(4634, 'SIGTERM');</pre></div></div></div><div class="section" title="pid"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec753"/>pid</h3></div></div></div><p>This <a class="indexterm" id="id2592"/>gets the current <code class="literal">pid</code>:</p><div class="informalexample"><pre class="programlisting">process.pid</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec621"/>Description</h4></div></div></div><p>It is the <code class="literal">pid</code> (process ID) of the process.</p><p>This is an <a class="indexterm" id="id2593"/>example of <code class="literal">process.kill</code> and <code class="literal">process.pid</code> used together:</p><div class="informalexample"><pre class="programlisting">process.kill(process.pid, 'SIGTERM');</pre></div></div></div><div class="section" title="cwd"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec754"/>cwd</h3></div></div></div><p>This gets <a class="indexterm" id="id2594"/>the current working directory:</p><div class="informalexample"><pre class="programlisting">process.cwd()</pre></div><p>Here is an example that set the <code class="literal">cwd</code> variable to the current working directory of the process:</p><div class="informalexample"><pre class="programlisting">var cwd = process.cwd();</pre></div></div></div><div class="section" title="File functions"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec511"/>File functions</h2></div></div></div><p>This section <a class="indexterm" id="id2595"/>is not a true module, like the previous section <a class="indexterm" id="id2596"/>on process. This section will focus on any of the functions or modules that allow us to read, write, or find files and directories.</p><div class="section" title="__filename"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec755"/>__filename</h3></div></div></div><p>This returns a <a class="indexterm" id="id2597"/>string of the current filename:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>__filename</strong></span>
</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec622"/>Description</h4></div></div></div><p>The <code class="literal">__filename</code> <a class="indexterm" id="id2598"/>command returns the current filename. This can be different, depending on which file is being executed. A module that is being executed will return its filename instead of the main entry point.</p><p>Here is an example of logging the current filename to the console:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>console.log(__filename);</strong></span>
</pre></div></div></div><div class="section" title="__dirname"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec756"/>__dirname</h3></div></div></div><p>This is a <a class="indexterm" id="id2599"/>string of the current directory:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>__dirname</strong></span>
</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec623"/>Description</h4></div></div></div><p>Much like <code class="literal">__filename</code>, this will return the currently executing file's directory. The <code class="literal">__dirname</code> command is <a class="indexterm" id="id2600"/>used many times when a relative path needs to be created.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note60"/>Note</h3><p>Both the <code class="literal">__filename</code> and <code class="literal">__dirname</code> variables are available in any file being executed by Node.js. They are determined per file, so they are correct for each file that gets executed.</p></div></div><p>This example assumes Express has been loaded as express:</p><div class="informalexample"><pre class="programlisting">//express is loaded
app.use(express.static(__dirname + '/static'));</pre></div></div></div><div class="section" title="The file module"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec757"/>The file module</h3></div></div></div><p>We will now look at a <a class="indexterm" id="id2601"/>list of key functions in the file module. All of these functions just run the underlying <code class="literal">POSIX</code> commands.</p><p>Each of the commands we cover will have an asynchronous and synchronous version of each function. The synchronous function will be the same name, with Sync appended, for example, <code class="literal">open</code> and <code class="literal">openSync</code>. In a way, the asynchronous versions are more like Node.js, in that, they let the event loop process without holding up execution.</p><p>Each asynchronous function will need a callback function defined as the last parameter. This function will be in the form of <code class="literal">function(err, result)</code>. We will cover this when we get to handling errors. The quick takeaway is that the first parameter, <code class="literal">err</code>, will be <code class="literal">null</code> if no error occurred, or it will have the error.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note61"/>Note</h3><p>In the current versions of Node.js, you need not use a callback function, but this will become an exception in v0.12.</p></div></div><p>The synchronous functions will not process anything in the event loop until the function returns. While this seems against the Node.js non-blocking paradigm, it makes sense in certain cases, for example, when a specific file must be opened before anything else can process. This means that the classic <code class="literal">try/catch</code> is needed to handle any exceptions or errors.</p><p>In almost every circumstance, the asynchronous version is the one that should be used.</p><p>Each example is <a class="indexterm" id="id2602"/>under the assumption that the <code class="literal">fs</code> variable already exists. Here is the code that sets the <code class="literal">fs</code> variable to the <code class="literal">fs</code> module:</p><div class="informalexample"><pre class="programlisting">var fs = require('fs');</pre></div></div><div class="section" title="stat"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec758"/>stat</h3></div></div></div><p>This returns <a class="indexterm" id="id2603"/>
<code class="literal">fs.Stats</code>, which is an object with information about the queried file or directory:</p><div class="informalexample"><pre class="programlisting">fs.statstat(path, callback)
fs.statSync(path)</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec624"/>Description</h4></div></div></div><p>The <code class="literal">stat</code> variable gets the the data that would be returned after running <code class="literal">stat()</code> on the operating system. The <a class="indexterm" id="id2604"/>
<code class="literal">stat</code> object is an instance of <code class="literal">fs.Stats</code>. This object gives us useful functions such as <code class="literal">isFile()</code> and <code class="literal">isDirectory()</code>. In addition to this, <code class="literal">fs.Stats</code> has many properties. We can see the modified time, access time, and file size.</p><p>There are more functions and properties, but these are the most likely used.</p><p>The <code class="literal">fs.lstat()</code> and <code class="literal">fs.fstat()</code> functions will both return an <code class="literal">fs.Stats</code> object when pointed to a file. The difference is that <code class="literal">lstat</code> will run against a link instead of following the link to the file or directory. The <code class="literal">fstat</code> runs against a file descriptor instead of a path.</p><p>Here is an example that loads a file named <code class="literal">test.txt</code> in the same directory as the code file and logs the <code class="literal">fs.Stats</code> object:</p><div class="informalexample"><pre class="programlisting">fs.stat(__dirname + '\test.txt', function(err, stats){
  console.log(stats);
});</pre></div></div></div><div class="section" title="open"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec759"/>open</h3></div></div></div><p>This returns a <a class="indexterm" id="id2605"/>file descriptor of the path passed in:</p><div class="informalexample"><pre class="programlisting">fs.open(path, flags, [mode], callback)
fs.openSync(path, flags, [mode])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec625"/>Description</h4></div></div></div><p>This will open a file in the <a class="indexterm" id="id2606"/>path passed in. There are many flags that can be passed. They are described here:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">r</code>: Read only, errors when file does not exist</li><li class="listitem" style="list-style-type: disc"><code class="literal">r+</code>: Read and write, errors when file does not exist</li><li class="listitem" style="list-style-type: disc"><code class="literal">rs</code>: Read synchronous, here, "synchronous" only refers to the filesystem caching data and not synchronous such as <code class="literal">openSync</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">rs+</code>: Read and write synchronous</li><li class="listitem" style="list-style-type: disc"><code class="literal">w</code>: Write</li><li class="listitem" style="list-style-type: disc"><code class="literal">wx</code>: Write, errors when file exists</li><li class="listitem" style="list-style-type: disc"><code class="literal">w+</code>: Read and write, file is created or truncated</li><li class="listitem" style="list-style-type: disc"><code class="literal">a</code>: Append, file is created</li><li class="listitem" style="list-style-type: disc"><code class="literal">ax</code>: Append, errors when file exists</li><li class="listitem" style="list-style-type: disc"><code class="literal">a+</code>: Read and append, file is created</li><li class="listitem" style="list-style-type: disc"><code class="literal">ax+</code>: Read and append, errors when file exists</li></ul></div><p>The flags allow you to open, read, and write a file, whether it exists or not. This means that most of the time, a call to <code class="literal">fs.exists</code> is not required as one of the flags will give you the answer you need.</p><p>The mode parameter is the <a class="indexterm" id="id2607"/>permissions that are used if a file is created. It defaults to <code class="literal">0666</code>.</p><p>Finally, the callback returns a file descriptor. With this, data can be read or written using <code class="literal">fs.read</code> or <code class="literal">fs.write</code>.</p><p>This is an example of opening the file <code class="literal">test.txt</code>:</p><div class="informalexample"><pre class="programlisting">fs.open(__dirname + '\file.txt', 'r', function(err, fd){
  //fd is available to be read from
});</pre></div></div></div><div class="section" title="read"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec760"/>read</h3></div></div></div><p>This reads from a <a class="indexterm" id="id2608"/>file descriptor:</p><div class="informalexample"><pre class="programlisting">fs.read(fd, buffer, offset, length, position, callback) 
fs.readSync(fd, buffer, offset, length, position)</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec626"/>Description</h4></div></div></div><p>The <code class="literal">read()</code> function takes a <a class="indexterm" id="id2609"/>lot of parameters to run. We need a file descriptor, which we get from open, a buffer, and the size of the file. In the example, we used <code class="literal">fs.stat</code> to get the file size.</p><p>Here is a full example of opening a file and reading from it:</p><div class="informalexample"><pre class="programlisting">fs.stat(__dirname + '/test.txt', function(error, stats) {
  fs.open(__dirname + '/test.txt', 'r', function(err, fd){
    var buffer = new Buffer(stats.size);
    fs.read(fd, buffer, 0, stats.size, null, function(err, bytesRead, buffer){
      console.log(buffer.toString('utf8'<code class="literal">));</code>
    });
  });
});</pre></div></div></div><div class="section" title="readFile"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec761"/>readFile</h3></div></div></div><p>This is a simplified <a class="indexterm" id="id2610"/>version for reading a file:</p><div class="informalexample"><pre class="programlisting">fs.readFile(filename, [options], callback)
fs.readFileSync(filename, [options])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec627"/>Description</h4></div></div></div><p>The <code class="literal">readFile()</code> function greatly <a class="indexterm" id="id2611"/>simplifies the process of reading a file in Node.js. In the previous function, <code class="literal">fs.read</code>, we needed to set everything up before we tried to read the file. The <code class="literal">readFile()</code> function allows us to just pass a filename and get a buffer back of what is in the file.</p><p>The <code class="literal">optional options</code> object takes a flag and an encoding property. The flag property is the same as the flag from <code class="literal">fs.open</code>, so any of them can be used. The encoding is used for the buffer that is returned in the callback.</p><p>Here is an example that demonstrates how much easier it is to load a file with <code class="literal">readFile</code>. The example is also using the <code class="literal">optional options</code> parameter:</p><div class="informalexample"><pre class="programlisting">var filename = __dirname + '/test.txt';

fs.readFile(filename, {flag: 'r', encoding: 'utf8'}, function(err, data){
  console.log(data.toString('utf8'));
});</pre></div></div></div><div class="section" title="close"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec762"/>close</h3></div></div></div><p>This will <a class="indexterm" id="id2612"/>close a file descriptor:</p><div class="informalexample"><pre class="programlisting">fs.close(fd, callback)
fs.closeSync(fd)</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec628"/>Description</h4></div></div></div><p>It is important to close <a class="indexterm" id="id2613"/>any files that we open in our scripts. If we get a file descriptor from <code class="literal">fs.open</code>, we will need to call <code class="literal">fs.close</code> on that file descriptor at some point.</p><p>This is an example of closing a file descriptor:</p><div class="informalexample"><pre class="programlisting">fs.close(fd, function(err){
  //handle err here
});</pre></div></div></div><div class="section" title="write"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec763"/>write</h3></div></div></div><p>This writes to a <a class="indexterm" id="id2614"/>file descriptor:</p><div class="informalexample"><pre class="programlisting">fs.write(fd, buffer, offset, length, position, callback)
fs.writeSync(fd, buffer, offset, length, position)</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec629"/>Description</h4></div></div></div><p>The <code class="literal">write()</code> function <a class="indexterm" id="id2615"/>takes a file descriptor and buffer to write to a file. Much like read, we have to pass in quite a few parameters to make this work.</p><p>In the following example, we are reading a file into a buffer and then writing that buffer back out to another file. The offset and length are both integers that we need to pass in. The position can be an integer, but it can also be <code class="literal">null</code>. <code class="literal">Null</code> will start writing at the current position in the file.</p><p>Just like read, write can be complex. Here is a full example of reading from one file and writing to another:</p><div class="informalexample"><pre class="programlisting">var fs = require('fs');
var filename = __dirname + '/test.txt';
var writeFile = __dirname + '/test2.txt';

fs.stat(filename, function(error, stats) {
  fs.open(filename, 'r', function(err, fd) {
    var buffer = new Buffer(stats.size);
    fs.read(fd, buffer, 0, stats.size, null, function(err, bytesRead, buffer) {
      fs.open(writeFile, 'w', function(err, writeFD) {
        //will create a file named test2.txt with the contents from test.txt
        fs.write(writeFD, buffer, 0, buffer.length, null, function(err, bytesWritten, writeBuffer) {
          console.log(writeBuffer.toString('utf8'));
        });
      });
    });
  });
});</pre></div></div></div><div class="section" title="writeFile"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec764"/>writeFile</h3></div></div></div><p>This is a <a class="indexterm" id="id2616"/>simplified function to write to a file:</p><div class="informalexample"><pre class="programlisting">fs.writeFile(filename, data, [options], callback)
fs.writeFileSync(filename, data, [options])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec630"/>Description</h4></div></div></div><p>Exactly like the difference between read and <code class="literal">readFile</code>, <code class="literal">writeFile</code> is a simplified version of write. We <a class="indexterm" id="id2617"/>just pass in a filename and a string or buffer, and it will write the file.</p><p>The callback only returns an error when it occurs.</p><p>
<code class="literal">readFile</code> and <code class="literal">writeFile</code> seem like the best choices in most cases, and in fact, this is most likely true. The main thing that you give up using these functions is control. You can only read an entire file or write an entire file.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note62"/>Note</h3><p>With read or write, you can read any portion and write any portion of a file. This is an important difference to keep in mind.</p></div></div><p>Here is an example of <code class="literal">writeFile</code>:</p><div class="informalexample"><pre class="programlisting">var filename = __dirname + '/write.txt';
var buffer = new Buffer('Write this to a file.', 'utf8');
fs.writeFile(filename, buffer, {encoding: 'utf8', flag: 'w'}, function(err){
  if(null !== null){
    //do something
  }
});</pre></div></div></div><div class="section" title="appendFile"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec765"/>appendFile</h3></div></div></div><p>This function <a class="indexterm" id="id2618"/>allows us to append a file:</p><div class="informalexample"><pre class="programlisting">fs.appendFile(filename, data, [options], callback) 
fs.appendFileSync(filename, data, [options])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec631"/>Description</h4></div></div></div><p>
<code class="literal">appendFile</code> exists because <code class="literal">writeFile</code> will only write an entire file. So, we need another function to add <a class="indexterm" id="id2619"/>to a file. This is where giving up some control for ease comes in. If we were using a file descriptor and write, then we could choose to start writing at the end of the file. This is effectively appending the file:</p><p>Here is an example of <code class="literal">appendFile</code>:</p><div class="informalexample"><pre class="programlisting">var filename = __dirname + '/write.txt';
var buffer = new Buffer('Append this to a file.', 'utf8');
fs.appendFile(filename, buffer, {encoding: 'utf8', flag: 'w'}, function(err){
  if(null !== null){
    //do something
  }
});</pre></div></div></div></div><div class="section" title="The path module"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec512"/>The path module</h2></div></div></div><p>The <code class="literal">path</code> module is <a class="indexterm" id="id2620"/>separate from the file module. Path is <a class="indexterm" id="id2621"/>concerned with fixing paths, whereas file is concerned with working with files and directories. Many times, these modules will be used together.</p><p>The functions covered are the most used and most useful. You will most likely need to locate paths relative to your current project, and this is what the path module is for:</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note63"/>Note</h3><p>Note that the <code class="literal">path</code> module does not check for the existence of path modifications. It essentially only makes changes to the string value of a path.</p></div></div><p>Just like the other modules, the example assumes that the path module has been loaded:</p><div class="informalexample"><pre class="programlisting">var path = require('path');</pre></div><div class="section" title="normalize"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec766"/>normalize</h3></div></div></div><p>This returns a <a class="indexterm" id="id2622"/>string of the path with any oddities fixed:</p><div class="informalexample"><pre class="programlisting">path.normalize(pathString)</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec632"/>Description</h4></div></div></div><p>Normalize will fix many <a class="indexterm" id="id2623"/>problems associated with reading paths. A great example of this is the difference between Windows and Unix paths. Unix uses forward slashes, and Windows uses backslashes. Normalize will return the correct slashes based on the system it is executed on.</p><p>In addition to this, normalize will also remove the current directory and parent directory shortcuts, (<code class="literal">.</code> and <code class="literal">..</code> respectively). It will also remove double slashes from a directory. It normalizes any paths passed in.</p><p>Here is an example of using Unix slashes on a Windows system. This example will change all the slashes to backslashes:</p><div class="informalexample"><pre class="programlisting">var pathString = "/unix/style/path/separators";
console.log(path.normalize(pathString));</pre></div></div></div><div class="section" title="join"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec767"/>join</h3></div></div></div><p>This returns a <a class="indexterm" id="id2624"/>string of all the paths joined together:</p><div class="informalexample"><pre class="programlisting">path.join([pathString1],[…])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec633"/>Description</h4></div></div></div><p>Join makes it easy to create a path from partial paths. This seems like something that can be done with concatenation, but it is easy to forget about path separators. Join will make sure that the path separators will all be in the correct spots.</p><p>Here is an example of <a class="indexterm" id="id2625"/>
<code class="literal">join</code>. The example will take all the parameters and join them together with the correct slash for your system:</p><div class="informalexample"><pre class="programlisting">console.log(path.join('path', 'separators', 'added'));</pre></div></div></div><div class="section" title="resolve"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec768"/>resolve</h3></div></div></div><p>This returns the string <a class="indexterm" id="id2626"/>of the path based on the parameters:</p><div class="informalexample"><pre class="programlisting">path.resolve([pathString], […])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec634"/>Description</h4></div></div></div><p>This can be viewed as the cd <a class="indexterm" id="id2627"/>command executed for each parameter. The paths passed in can be relative or full paths. A relative path will add to the returned path, and a full path will be used whole.</p><p>Here are two examples:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Relative paths, will return <code class="literal">/home/josh/test</code>:<div class="informalexample"><pre class="programlisting">console.log(path.resolve('/home/josh/node', '..', 'test'));</pre></div></li><li class="listitem" style="list-style-type: disc">A full path will return <code class="literal">/home/brian/node</code>:<div class="informalexample"><pre class="programlisting">console.log(path.resolve('/home/josh/node', '/home/brian/node'));</pre></div></li></ul></div></div></div><div class="section" title="relative"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec769"/>relative</h3></div></div></div><p>This returns the <a class="indexterm" id="id2628"/>difference between the <code class="literal">to</code> and <code class="literal">from</code> paths:</p><div class="informalexample"><pre class="programlisting">path.relative(from, to)</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec635"/>Description</h4></div></div></div><p>The path returned can be <a class="indexterm" id="id2629"/>used with <code class="literal">cd</code> to change to the new directory.</p><p>Here is an example that will return <code class="literal">../../brian/node</code>, because you must go up two parent folders and over to <code class="literal">brian/node</code> to get from one to the other:</p><div class="informalexample"><pre class="programlisting">var from = '/home/josh/node';
var to = '/home/brian/node';
console.log(path.relative(from, to));</pre></div></div></div><div class="section" title="dirname"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec770"/>dirname</h3></div></div></div><p>This <a class="indexterm" id="id2630"/>returns a string of the directory name:</p><div class="informalexample"><pre class="programlisting">path.dirname(pathString)</pre></div><p>This example <a class="indexterm" id="id2631"/>will return the directory that the current file is in. If the file was in the directory <code class="literal">/home/users/jjohanan/node</code>, then the example will return <code class="literal">/home/users/jjohanan/node</code>:</p><div class="informalexample"><pre class="programlisting">console.log(path.dirname(__filename));</pre></div></div><div class="section" title="basename"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec771"/>basename</h3></div></div></div><p>This <a class="indexterm" id="id2632"/>returns a string of the final part of a path:</p><div class="informalexample"><pre class="programlisting">path.basename(pathString, [ext])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec636"/>Description</h4></div></div></div><p>This will either <a class="indexterm" id="id2633"/>return the filename or directory depending on what path is passed in. The optional <code class="literal">ext</code> parameter will remove that portion from the return value if it exists.</p><p>Here are two examples, one involving a file and the other a directory:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">This will return <code class="literal">test</code>:<div class="informalexample"><pre class="programlisting">console.log(path.basename('/home/josh/test.js', '.js'));</pre></div></li><li class="listitem" style="list-style-type: disc">This will return <code class="literal">josh</code>:<div class="informalexample"><pre class="programlisting">console.log(path.basename('/home/josh'));</pre></div></li></ul></div></div></div><div class="section" title="extname"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec772"/>extname</h3></div></div></div><p>This returns a <a class="indexterm" id="id2634"/>string of the extension of the path. If there is no extension, a blank string is returned:</p><div class="informalexample"><pre class="programlisting">path.extname(pathString)</pre></div><p>Here are two <a class="indexterm" id="id2635"/>examples:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">This example will return <code class="literal">.js</code>:<div class="informalexample"><pre class="programlisting">console.log(path.extname('/home/josh/test.js'));</pre></div></li><li class="listitem" style="list-style-type: disc">This example will return a blank string:<div class="informalexample"><pre class="programlisting">console.log(path.extname('/home/josh'));</pre></div></li></ul></div></div></div><div class="section" title="REPL"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec513"/>REPL</h2></div></div></div><p>REPL <a class="indexterm" id="id2636"/>stands for <span class="strong"><strong>Read Eval Print Loop</strong></span>. What this means is that it is an interactive console. We can enter in a command (<span class="strong"><strong>Read</strong></span>). The <a class="indexterm" id="id2637"/>command will be executed (<span class="strong"><strong>Eval</strong></span>). The output of the command will will be printed to the console (<span class="strong"><strong>Print</strong></span>). Finally, we can do this as many times as we want (<span class="strong"><strong>Loop</strong></span>). REPL is great to run a few lines of code to see what they will do.</p><div class="section" title="node"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec773"/>node</h3></div></div></div><p>This starts <a class="indexterm" id="id2638"/>Node.js in the REPL mode:</p><div class="informalexample"><pre class="programlisting">node</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec637"/>Description</h4></div></div></div><p>The main way REPL will <a class="indexterm" id="id2639"/>be used is by calling it directly. This can be done by executing Node.js without a file to serve, by running just <code class="literal">node</code>. Once <code class="literal">node</code> has returned with a prompt, we can add commands and see what happens when we run them. This is perfect to test a few lines of code.</p><p>Here is a quick example of logging in to the console; first run <code class="literal">node</code> to get a prompt and then run the command:</p><div class="informalexample"><pre class="programlisting">node
//wait for &gt;
console.log('hey this REPL!');</pre></div></div></div></div><div class="section" title="Handling errors"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec514"/>Handling errors</h2></div></div></div><p>Errors <a class="indexterm" id="id2640"/>are a part of any development project. We must be able to handle errors in a graceful way. If we do not, then we are creating bad experiences for our users. Even worse, we could be opening up a vector for attack. A stack trace that gets sent to an end user can give out many details.</p><p>This will be a special <a class="indexterm" id="id2641"/>section that deals more with design patterns than with actual code reference. Node.js is an asynchronous event-driven platform. For the major part, most people have not worked on a platform like this and can make mistakes when handling errors. We feel that handling errors is very important.</p><p>The core of <a class="indexterm" id="id2642"/>this information comes from <a class="indexterm" id="id2643"/>Joyent, one the major forces behind <code class="literal">Node.js</code> today. You can find more information on Joyent at <a class="ulink" href="https://www.joyent.com/developers/node/design/errors">https://www.joyent.com/developers/node/design/errors</a>.</p><div class="section" title="Types of errors"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec774"/>Types of errors</h3></div></div></div><p>Errors can be split into <a class="indexterm" id="id2644"/>two types: <span class="strong"><strong>operational</strong></span> and <span class="strong"><strong>programmer</strong></span> errors. Operational <a class="indexterm" id="id2645"/>errors are errors that occur during the operation of an <a class="indexterm" id="id2646"/>application. A database server not being accessible is an example. These errors can be planned for and handled gracefully.</p><p>Next is programmer errors, which are errors in the literal sense. For example, a piece of code is malformed or an unexpected condition has come up. These are very hard to plan for (if we had planned for <a class="indexterm" id="id2647"/>them, then they wouldn't be errors!). These will almost always break the server, so we can come back through the logs to find what went wrong.</p></div><div class="section" title="Error design patterns"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec775"/>Error design patterns</h3></div></div></div><p>Now that we <a class="indexterm" id="id2648"/>know the two different types of errors, let's look at the three ways of alerting an application that has an error. The three ways are throwing the error, asynchronous callback, and emitting an error event:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The first pattern of throwing the error is built into JavaScript. This pattern is great for any synchronous code. If we are doing any synchronous operations and an error occurs, we should throw it. When handling a synchronous call, we should wrap the function call in a <code class="literal">try/catch</code> block. Here is an example with <code class="literal">JSON.parse</code>, which runs synchronously and throws an error when a non-JSON string is passed to it:<div class="informalexample"><pre class="programlisting">try{
    JSON.parse(jsonObject);
} catch (ex) {
    //do something with this error
}</pre></div></li><li class="listitem" style="list-style-type: disc">The next pattern is using an asynchronous callback. Many built-in Node functions do this already. The pattern is to use a callback that has the signature <code class="literal">function(error, result)</code>. The first parameter will either have an error or be null or undefined. We can implement this ourselves whenever we write an asynchronous function. If there is an error, return it in the callback as the first parameter.<div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note64"/>Note</h3><p>When handling errors like these, we must put an error check in every callback function. This is important, as not doing this can silently swallow errors.</p></div></div></li></ul></div><p>A good example of this is asynchronous and synchronous <code class="literal">filesystem</code> module calls. For example, read takes a callback, and <code class="literal">readSync</code> should be wrapped in a <code class="literal">try/catch</code> block.</p><p>Here is an example callback and check for error:</p><div class="informalexample"><pre class="programlisting">fs.read(path, function (err, data) {
    if(err !== null)
        //handle error
})</pre></div><p>Finally, we can emit an error event. This is used for asynchronous functions as well. Whether we implement a callback or event is a personal choice, but it should be clear which one is being used. It is also a best practice to just implement one. Many times, an event is used when there is a long running asynchronous process. Reading data from a network socket is an <a class="indexterm" id="id2649"/>example. A socket does not always give the data in one simple pass, so events are set up. One of those events is an error event. To handle this, we just need to listen for that event. Here is an example of listening for the error event of a socket:</p><div class="informalexample"><pre class="programlisting">socket.on('error', function(error){
   //handle error here
})</pre></div></div></div></div></div>
<div class="section" title="Utilities"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec82"/>Utilities</h1></div></div></div><p>In the next <a class="indexterm" id="id2650"/>group of modules, we will look at utilities. The functions chosen here are used across many different types of applications. We will cover everything from events and cryptology to buffers and npm.</p><div class="section" title="Events"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec515"/>Events</h2></div></div></div><p>Events are used in <a class="indexterm" id="id2651"/>many built-in Node objects. This is because emitting and listening for events is the perfect way to let another function know when to start executing. This is <a class="indexterm" id="id2652"/>especially true in the asynchronous world of Node.js. Anytime we use the <code class="literal">on</code> function of an object, it means that it has inherited from <code class="literal">EventEmitter</code>. All of the examples will assume that the events variable is already created as follows:</p><div class="informalexample"><pre class="programlisting">var events = require('events');</pre></div><div class="section" title="EventEmitter"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec776"/>EventEmitter</h3></div></div></div><p>This is the parent class <a class="indexterm" id="id2653"/>that can be inherited from to create a new <code class="literal">EventEmitter</code>:</p><div class="informalexample"><pre class="programlisting">events.EventEmitter</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec638"/>Description</h4></div></div></div><p>Node.js has a fully featured <a class="indexterm" id="id2654"/>event system that we can easily inherit from and implement. We do not need any extra frameworks or custom code. <code class="literal">EventEmitter</code> is the class to inherit from, and we will get every function in the rest of this section available.</p><p>Here is an example of setting up a custom the <code class="literal">EventEmitter</code> parameter:</p><div class="informalexample"><pre class="programlisting">var util = require('util');
var events = require('events');

function MyEventEmitter(){
    events.EventEmitter.call(this);
    this.test = function (emitThis) {
        this.emit('testEvent', emitThis);
    }
}

util.inherits(MyEventEmitter, events.EventEmitter);

var myEE = new MyEventEmitter();

myEE.on('testEvent', function (data) { console.log(data) });

myEE.test('test');</pre></div></div></div><div class="section" title="on"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec777"/>on</h3></div></div></div><p>This function <a class="indexterm" id="id2655"/>adds a listener for a specific event:</p><div class="informalexample"><pre class="programlisting">emitter.on(event, listenerFunction)
emitter.addListener(event, listenerFunction)</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec639"/>Description</h4></div></div></div><p>The <code class="literal">on</code> function has <a class="indexterm" id="id2656"/>become the preferred naming convention to add listeners to events. As an example, jQuery uses the exact same function name for their event listeners. The <code class="literal">event</code> handler is a string name of the event that will be emitted. The <code class="literal">listenerFunction</code> parameter is what will be executed when the event is emitted.</p><p>The <code class="literal">listenerFunction</code> parameter can be an anonymous function or a reference to a function. The preferred way of adding a listener is with a reference to a function. This will allow us to remove this specific listener at a later time.</p><p>Here is an example based on our new <code class="literal">MyEventEmitter</code> class:</p><div class="informalexample"><pre class="programlisting">var quickLog = function (data) {
    console.log('quickLog: ' + data);
}
myEE.on('testEvent', quickLog);</pre></div></div></div><div class="section" title="once"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec778"/>once</h3></div></div></div><p>This works just <a class="indexterm" id="id2657"/>like <code class="literal">on</code>, except it only executes once and then removes <a class="indexterm" id="id2658"/>itself as a listener:</p><div class="informalexample"><pre class="programlisting">emitter.once(event, listenerFunction)</pre></div></div><div class="section" title="removeListener"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec779"/>removeListener</h3></div></div></div><p>This is the <a class="indexterm" id="id2659"/>function that is used to remove a listener from an event:</p><div class="informalexample"><pre class="programlisting">emitter.removeListener(event, function)</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec640"/>Description</h4></div></div></div><p>When we are done <a class="indexterm" id="id2660"/>listening for this event, we will want to remove our listener. This will help prevent memory leaks. If we added an anonymous function as the listener, then we cannot remove it as we do not have a reference to it. Using our previous example from <code class="literal">on</code>, we will remove the listener:</p><div class="informalexample"><pre class="programlisting">myEE.removeListener('testEvent', quickLog);</pre></div></div></div><div class="section" title="removeAllListeners"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec780"/>removeAllListeners</h3></div></div></div><p>This function will <a class="indexterm" id="id2661"/>remove every listener for all events or a specific event:</p><div class="informalexample"><pre class="programlisting">emitter.removeAllListeners([event])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec641"/>Description</h4></div></div></div><p>This is essentially the <a class="indexterm" id="id2662"/>nuclear option to remove listeners. This is indiscriminate with listeners. The <code class="literal">removeAllListeners</code> parameter will even remove listeners we did not add. Use this as a last resort.</p><p>An example that removes all the listeners from this event is shown here. If the event was left blank, it would remove all listeners for all events:</p><div class="informalexample"><pre class="programlisting">myEE.removeAllListeners('testEvent');</pre></div></div></div><div class="section" title="setMaxListeners"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec781"/>setMaxListeners</h3></div></div></div><p>This <a class="indexterm" id="id2663"/>function sets the number of listeners before Node.js and <a class="indexterm" id="id2664"/>warns about a possible memory leak:</p><div class="informalexample"><pre class="programlisting">emitter.setMaxListeners(numberOfListeners)</pre></div><p>Node.js has a helpful warning when the number of listeners exceeds a threshold. The default value is <code class="literal">10</code>, so when you add the eleventh listener, Node.js will warn:</p><div class="informalexample"><pre class="programlisting">(node) warning: possible EventEmitter memory leak detected. 11 listeners added. Use emitter.setMaxListeners() to increase limit.</pre></div><p>As a general rule, this is true. If we keep adding listeners to an event, there is a great chance for a memory leak. However, there will be times when we will need more than <code class="literal">10</code> listeners on an event. This is where we use <code class="literal">setMaxListeners</code>. If we set the max listeners to zero, then we can add as many as we want.</p><p>Here is an example of setting the max listeners to <code class="literal">50</code>:</p><div class="informalexample"><pre class="programlisting">myEE.setMaxListeners(50);</pre></div></div><div class="section" title="emit"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec782"/>emit</h3></div></div></div><p>This is how <a class="indexterm" id="id2665"/>we fire off an event:</p><div class="informalexample"><pre class="programlisting">emitter.emit(eventName, [argument], […])</pre></div><p>If we have extended an <a class="indexterm" id="id2666"/>object to be an event emitter, then we will want to emit some events! This is the function to do that. It will execute all the event listeners that have attached themselves to this event based on <code class="literal">eventName</code>.</p><p>Here is an example that shows a listener being added and then emitting an event:</p><div class="informalexample"><pre class="programlisting">myEE.on('testEvent', function (data) { console.log(data) });
myEE.emit('testEvent', 'Emit This!', 'Another Argument!');</pre></div></div></div><div class="section" title="Crypto"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec516"/>Crypto</h2></div></div></div><p>Every modern <a class="indexterm" id="id2667"/>application needs cryptography. A great example of Node.js using cryptography is with HTTPS. We will not explore the inner workings of HTTPS as there is <a class="indexterm" id="id2668"/>a module (the https module) that does this for us. We will look at the cryptographic functions used to hash, store, and check passwords.</p><p>In the same way as the other modules, we will require the <code class="literal">crypto</code> module and have it available for use in our examples. Here is what we will need:</p><div class="informalexample"><pre class="programlisting">var crypto = require('crypto');</pre></div><div class="section" title="createHash"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec783"/>createHash</h3></div></div></div><p>This function <a class="indexterm" id="id2669"/>will return a <code class="literal">crypto.Hash</code> object:</p><div class="informalexample"><pre class="programlisting">crypto.createHash(algorithm)</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec642"/>Description</h4></div></div></div><p>The algorithms that <a class="indexterm" id="id2670"/>can be used will be different for each system as it relies on OpenSSL. We can find out the algorithms that crypto can use by calling <code class="literal">crypto.getHashes()</code>. This will return an array of strings that can then be passed into <code class="literal">createHash</code> as the algorithm.</p><p>The return object from this function is a <code class="literal">crypto.Hash</code> object, which is covered in the next section.</p><p>Here is an example that creates an MD5 hash:</p><div class="informalexample"><pre class="programlisting">var md5 = crypto.createHash('md5');</pre></div></div></div><div class="section" title="The hash object"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec784"/>The hash object</h3></div></div></div><p>This is the <a class="indexterm" id="id2671"/>object that is returned from <code class="literal">crypto.createHash</code>:</p><div class="informalexample"><pre class="programlisting">hash.update(data, [encoding])
hash.digest([encoding])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec643"/>Description</h4></div></div></div><p>Once we get a reference to the Hash object that has been returned, you will see that it has two functions. The <a class="indexterm" id="id2672"/>first is update, which allows us to add to the data that will be hashed. This can be called multiple times. This is important if we want to hash a stream input.</p><p>The next function is digest. This will return digest based on the algorithm the hash object was created with. The string encoding for this function can be hex, binary, or BASE64. </p><p>Here is a full example of reading data from a file and then calculating the MD5 hash of the file.</p><div class="informalexample"><pre class="programlisting">var f = file.readFileSync(__dirname + '/test.txt');

var md5 = crypto.createHash('md5');
md5.update(f);
console.log(md5.digest('base64'));</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip45"/>Tip</h3><p>Do not use hashing for passwords. The next function we will cover is much more secure than a simple hash. A digest hash is great for checking if some data has changed, as the hashes will be different if even one bit is different. In addition to this, it can be used as a key or identifier. A great example is using it for a memory cache and using the hash as the key. If the data is the same, the key will be the same.</p></div></div></div></div><div class="section" title="pbkdf2"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec785"/>pbkdf2</h3></div></div></div><p>This function <a class="indexterm" id="id2673"/>will use HMAC-SHA1 multiple times to create a derived key:</p><div class="informalexample"><pre class="programlisting">crypto.pbkdf2(password, salt, iterations, keyLength, callback)
crypto.pbkdf2Sync(password, salt, iterations, keyLength)</pre></div><div class="section" title="Return Type"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec644"/>Return Type</h4></div></div></div><p>Both <code class="literal">pbkdf2</code> and <code class="literal">pbkdf2Sync</code> will return a derived key as a buffer.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec645"/>Description</h4></div></div></div><p>
<span class="strong"><strong>Pbkdf2</strong></span> (<span class="strong"><strong>password-based key derivation function 2</strong></span>) is designed for password storage. It is better than <a class="indexterm" id="id2674"/>hashing because it is difficult. Hashing is designed to be a quick calculation. This is bad because modern CPUs can calculate thousands upon thousands of hashes a second. This makes cracking a hashed password easy.</p><p>Pbkdf2 fixes this using a work factor in iterations. The higher the iterations, the longer the calculation will take. Now, instead of calculating thousands a second, we can slow a CPU down to just a few a second. This is a significant decrease.</p><p>These are the <a class="indexterm" id="id2675"/>parameters used:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">password</code>: This is the string we want to create a derived key for.</li><li class="listitem" style="list-style-type: disc"><code class="literal">salt</code>: This is a string that is combined with the password. Doing this ensures that the same password will not have the same hash if <code class="literal">salt</code> is different.</li><li class="listitem" style="list-style-type: disc"><code class="literal">iterations</code>: This is the work factor that instructs the function how many times to repeat. This can be increased as CPUs become faster. Currently, at least 10,000 should create a reasonably secure derived key.</li><li class="listitem" style="list-style-type: disc"><code class="literal">keyLength</code>: This is the desired length of the returned derived key.</li></ul></div><p>Here is an example of creating a derived key for the string <code class="literal">password</code> and <code class="literal">salt</code>:</p><div class="informalexample"><pre class="programlisting">crypto.pbkdf2('password', 'salt', 10000, 32, function (err, key) {
    console.log(key.toString('base64'));
});</pre></div></div></div><div class="section" title="randomBytes"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec786"/>randomBytes</h3></div></div></div><p>This returns <a class="indexterm" id="id2676"/>cryptographically strong pseudo-random data:</p><div class="informalexample"><pre class="programlisting">crypto.randomBytes(length, [callback])</pre></div><div class="section" title="Return type"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec646"/>Return type</h4></div></div></div><p>A buffer is returned.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec647"/>Description</h4></div></div></div><p>Random data is <a class="indexterm" id="id2677"/>needed for various functions. While no data can truly be random, there are varying levels of randomness. The <code class="literal">randomBytes</code> parameter is random enough to use for cryptographic functions. A perfect use of <code class="literal">randomBytes</code> is for a <code class="literal">salt</code> to be used in <code class="literal">pbkdf2</code>. The <code class="literal">salt</code> variable is combined with the password to create a different hash even if the passwords are the same.</p><p>This function can be executed asynchronously or synchronously. It depends on whether there is a callback, which it would then execute asynchronously.</p><p>Here is a function to create a random <code class="literal">salt</code> for <code class="literal">pbkdf2</code>. If you compare this example to the previous one, you will see that this example outputs a unique string each time, while the previous one does not:</p><div class="informalexample"><pre class="programlisting">var random = crypto.randomBytes(256);

crypto.pbkdf2('password', random.toString('base64'), 10000, 32, function (err, key) {
    console.log(key.toString('base64'));
});</pre></div></div></div><div class="section" title="pseudoRandomBytes"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec787"/>pseudoRandomBytes</h3></div></div></div><p>This <a class="indexterm" id="id2678"/>returns pseudo-random data:</p><div class="informalexample"><pre class="programlisting">crypto.pseudoRandomBytes(length, [calback])
crypto.pseudoRandomBytes(length)</pre></div><div class="section" title="Return Type"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec648"/>Return Type</h4></div></div></div><p>A buffer is returned.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec649"/>Description</h4></div></div></div><p>This functions <a class="indexterm" id="id2679"/>exactly like <code class="literal">randomBytes</code>, except it is not cryptographically strong. This means that we should not use it with any cryptographic functions such as <code class="literal">pbkdf2</code>.</p><p>We can use it for anything else that requires randomness, a filename, or a cache key for example.</p><p>Here is a simple example of executing this function asynchronously:</p><div class="informalexample"><pre class="programlisting">crypto.pseudoRandomBytes(256, function (err, randomData) {
    console.log(randomData.toString('base64'));
});</pre></div></div></div></div><div class="section" title="Buffer"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec517"/>Buffer</h2></div></div></div><p>Node.js uses <a class="indexterm" id="id2680"/>buffers internally for many things. We have seen this as we have had buffers returned for many functions. This is because anytime raw data or binary data needs to be stored, it will be stored in a buffer.</p><p>Buffers have a few <a class="indexterm" id="id2681"/>quirks about them that we must keep in mind. First, buffers store data, but to utilize the data held inside them, we must encode it. We will cover the encodings and how to do this in this section. Second, buffers cannot be resized. When they are created, we must give a length, and that will always be the length of that buffer. We can, of course, create a new buffer that is larger and then copy over the data. Finally, a buffer is a global. We do not need to have <code class="literal">var buffer = require('buffer')</code>. Also, it can be utilized in any file at any time.</p><div class="section" title="Buffer creation"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec788"/>Buffer creation</h3></div></div></div><p>The initialization <a class="indexterm" id="id2682"/>function of a buffer is as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">new Buffer(size)
new Buffer(array)
new Buffer(str, [encoding])</pre></div><div class="section" title="Return value"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec650"/>Return value</h4></div></div></div><p>This returns a <a class="indexterm" id="id2683"/>buffer object.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec651"/>Description</h4></div></div></div><p>There are three different <a class="indexterm" id="id2684"/>ways to initialize a buffer. The first function uses an integer of the given size, the next one uses an array, and the final method can use just a string. The encoding is optional, as it defaults to UFT8.</p><p>This example demonstrates initializing using an array with the <code class="literal">hello</code> string in ASCII:</p><div class="informalexample"><pre class="programlisting">var hello = [72, 101, 108, 108, 111];
var buffer = new Buffer(hello);
console.log(buffer.toString('ascii'));</pre></div></div></div><div class="section" title="index"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec789"/>index</h3></div></div></div><p>This gets <a class="indexterm" id="id2685"/>the value at the specific index in the buffer:</p><div class="informalexample"><pre class="programlisting">buffer[index]</pre></div><div class="section" title="Return Value"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec652"/>Return Value</h4></div></div></div><p>This returns the <a class="indexterm" id="id2686"/>value at the index.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec653"/>Description</h4></div></div></div><p>This works much like <a class="indexterm" id="id2687"/>an array. Here is an example of getting the first index in the buffer:</p><div class="informalexample"><pre class="programlisting">var buffer = new Buffer('Hello!');
console.log(buffer[0]);</pre></div></div></div><div class="section" title="toString"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec790"/>toString</h3></div></div></div><p>This returns <a class="indexterm" id="id2688"/>the buffer as a string based on the encoding:</p><div class="informalexample"><pre class="programlisting">buffer.toString([encoding], [start], [end])</pre></div><div class="section" title="Return Value"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec654"/>Return Value</h4></div></div></div><p>This returns a string.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec655"/>Description</h4></div></div></div><p>This is most likely <a class="indexterm" id="id2689"/>the function that you will use to get the data out of a buffer. The first parameter is encoding, which is one of the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">ASCII</li><li class="listitem" style="list-style-type: disc">UTF8</li><li class="listitem" style="list-style-type: disc">UTF16LE</li><li class="listitem" style="list-style-type: disc">BASE64</li><li class="listitem" style="list-style-type: disc">Binary</li><li class="listitem" style="list-style-type: disc">Hex</li></ul></div><p>All the parameters are optional, so this means that they all have default values. Encoding is defaulted to UTF8, <code class="literal">start</code> is <code class="literal">0</code>, and <code class="literal">end</code> is the end of the buffer.</p><p>Here is an example of <a class="indexterm" id="id2690"/>creating a buffer and retrieving the data out of it. It explicitly defines each of the parameters:</p><div class="informalexample"><pre class="programlisting">var buffer = new Buffer('Hello this is a buffer');
console.log(buffer.toString('utf8', 0, buffer.length));</pre></div></div></div><div class="section" title="toJSON"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec791"/>toJSON</h3></div></div></div><p>This <a class="indexterm" id="id2691"/>returns the contents of the buffer as a JavaScript object:</p><div class="informalexample"><pre class="programlisting">buffer.toJSON()</pre></div><div class="section" title="Return Value"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec656"/>Return Value</h4></div></div></div><p>This returns an array with the contents of the buffer.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec657"/>Description</h4></div></div></div><p>This will return <a class="indexterm" id="id2692"/>contents of the buffer mapped to an array. This example is similar to the previous example, but with <code class="literal">toJSON</code>:</p><div class="informalexample"><pre class="programlisting">var buffer = new Buffer('Hello this is a buffer');
console.log(buffer.toJSON());</pre></div></div></div><div class="section" title="isBuffer"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec792"/>isBuffer</h3></div></div></div><p>This is a <a class="indexterm" id="id2693"/>class method that will determine whether an object is a buffer:</p><div class="informalexample"><pre class="programlisting">Buffer.isBuffer(objectToTest)</pre></div><div class="section" title="Return Value"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec658"/>Return Value</h4></div></div></div><p>This returns a Boolean value.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec659"/>Description</h4></div></div></div><p>Remember that this <a class="indexterm" id="id2694"/>is a class method, so it can be executed without a new instance of buffer. Here is an example of using the function:</p><div class="informalexample"><pre class="programlisting">var buffer = new Buffer('Hello this is a buffer');
console.log(Buffer.isBuffer(buffer));</pre></div></div></div><div class="section" title="write"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec793"/>write</h3></div></div></div><p>The following <a class="indexterm" id="id2695"/>code writes to the buffer.</p><div class="informalexample"><pre class="programlisting">buffer.write(stringToWrite, [offset], [length], [encoding])</pre></div><div class="section" title="Return value"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec660"/>Return value</h4></div></div></div><p>This returns an integer of the number of bytes written.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec661"/>Description</h4></div></div></div><p>This function will <a class="indexterm" id="id2696"/>write the string passed into the buffer. Much like the other buffer functions, there are many optional parameters that have defaults. The default offset is <code class="literal">0</code>, the length is <code class="literal">buffer.length – offset</code>, and the encoding is UTF8.</p><p>This example writes to a buffer twice using the return value from the first write to append the second string:</p><div class="informalexample"><pre class="programlisting">var buffer = new Buffer(12);
var written = buffer.write('Buffer ', 0, 7, 'utf8');
console.log(written);
buffer.write('time.', written);
console.log(buffer.toString());</pre></div></div></div><div class="section" title="byteLength"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec794"/>byteLength</h3></div></div></div><p>This function <a class="indexterm" id="id2697"/>will get the length of a string in bytes based on the encoding:</p><div class="informalexample"><pre class="programlisting">buffer.byteLength(string, [encoding])</pre></div><div class="section" title="Return value"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec662"/>Return value</h4></div></div></div><p>This returns an integer <a class="indexterm" id="id2698"/>of the number of bytes needed.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec663"/>Description</h4></div></div></div><p>Buffers cannot be resized after initializing, so we may need to know how big a string is beforehand. This is where <code class="literal">byteLength</code> comes in.</p><p>Here is an example that determines the size of a string and then writes it to the buffer:</p><div class="informalexample"><pre class="programlisting">var byteLength = Buffer.byteLength('Buffer time.', 'utf8');
var buffer = new Buffer(byteLength);
var written = buffer.write('Buffer time.', 0, buffer.length, 'utf8');
console.log(buffer.toString());</pre></div></div></div><div class="section" title="readUInt"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec795"/>readUInt </h3></div></div></div><p>This will get <a class="indexterm" id="id2699"/>an unsigned integer at a certain spot in the buffer:</p><div class="informalexample"><pre class="programlisting">buffer.readUInt8(offset, [noAssert])
buffer.readUInt16LE(offset, [noAssert])
buffer.readUInt16BE(offset, [noAssert])
buffer.readUInt32LE(offset, [noAssert])
buffer.readUInt32BE(offset, [noAssert])</pre></div><div class="section" title="Return Value"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec664"/>Return Value</h4></div></div></div><p>This returns an unsigned integer of the size used, <code class="literal">8</code> for <code class="literal">readUInt8</code>.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec665"/>Description</h4></div></div></div><p>Not all data stored in a <a class="indexterm" id="id2700"/>buffer is exactly a byte. Sometimes, data will need to be read in 16-bit or 32-bit chunks. In addition to this, you can also specify whether the data is little endian or big endian, denoted by <code class="literal">LE</code> or <code class="literal">BE</code> in the function name, respectively.</p><p>The offset is which spot in the buffer to start at. The <code class="literal">noAssert</code> parameter will run validation if the offset size is in the buffer. By default, it is <code class="literal">false</code>.</p><p>Here is an example of setting data and then reading the data out with <code class="literal">readUInt16</code>:</p><div class="informalexample"><pre class="programlisting">var buffer = new Buffer(2);
buffer[0] = 0x1;
buffer[1] = 0x2;
console.log(buffer.readUInt16LE(0));
console.log(buffer.readUInt16BE(0));</pre></div></div></div><div class="section" title="writeUInt"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec796"/>writeUInt</h3></div></div></div><p>This writes <a class="indexterm" id="id2701"/>an unsigned integer to a buffer:</p><div class="informalexample"><pre class="programlisting">buffer.writeUInt8(value, offset, [noAssert])
buffer.writeUInt16LE(value, offset, [noAssert])
buffer.writeUInt16BE(value, offset, [noAssert])
buffer.writeUInt32LE(value, offset, [noAssert])
buffer.writeUInt32BE(value, offset, [noAssert])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec666"/>Description</h4></div></div></div><p>This is the exact opposite of the <code class="literal">readUInt</code> function. Sometimes, we need <a class="indexterm" id="id2702"/>to write data that is larger than one byte in length. These functions make it simple.</p><p>The <code class="literal">noAssert</code> parameter is optional, and it defaults to <code class="literal">false</code>. This will not run any validation on the value or offset.</p><p>Here is an example of writing <code class="literal">UInt16</code> to the buffer:</p><div class="informalexample"><pre class="programlisting">var buffer = new Buffer(4);
buffer.writeUInt16LE(0x0001, 0);
buffer.writeUInt16LE(0x0002, 2);
console.log(buffer);</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip46"/>Tip</h3><p>Note that there are more read and write functions of this type for the buffer class. Instead of creating a very redundant section, I will list them. Remember that they work in the same fashion as the functions we have covered: <code class="literal">readInt8</code>, <code class="literal">readInt16LE</code>, <code class="literal">readInt16BE</code>, <code class="literal">readInt32LE</code>, <code class="literal">readInt32BE</code>, <code class="literal">readDoubleLE</code>, <code class="literal">readDoubleBE</code>, <code class="literal">readFloatLE</code>, and <code class="literal">readFloatBE</code>. There is a <code class="literal">write()</code> function <a class="indexterm" id="id2703"/>that maps to each one of these as well.</p></div></div></div></div></div><div class="section" title="Console"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec518"/>Console </h2></div></div></div><p>This is much <a class="indexterm" id="id2704"/>like the console that is present in most modern browsers. The <a class="indexterm" id="id2705"/>console essentially maps to <code class="literal">stdout</code> and <code class="literal">stderr</code>. This isn't a module, and each function is not very complex, so let's jump right in.</p><div class="section" title="log"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec797"/>log</h3></div></div></div><p>This <a class="indexterm" id="id2706"/>writes to <code class="literal">stdout</code>:</p><div class="informalexample"><pre class="programlisting">console.log(message, […])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec667"/>Description</h4></div></div></div><p>This is probably the most used console function. It is great for debugging, and the output can be combined with piping to <a class="indexterm" id="id2707"/>write to a file for a history. The multiple parameters create a string-like function.</p><p>Here is an example of using multiple parameters:</p><div class="informalexample"><pre class="programlisting">console.log('Multiple parameters in %s', 'console.log');</pre></div></div></div><div class="section" title="dir"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec798"/>dir</h3></div></div></div><p>This is an <a class="indexterm" id="id2708"/>alias for <code class="literal">util.inspect</code>:</p><div class="informalexample"><pre class="programlisting">console.dir(object)</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec668"/>Description</h4></div></div></div><p>Many times, the output <a class="indexterm" id="id2709"/>of <code class="literal">console.log</code> and <code class="literal">console.dir</code> will be similar. However, when trying to look at an object, <code class="literal">console.dir</code> should be preferred.</p></div></div><div class="section" title="time and timeEnd"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec799"/>time and timeEnd</h3></div></div></div><p>These two <a class="indexterm" id="id2710"/>functions are used together to mark the start and <a class="indexterm" id="id2711"/>end of a timer:</p><div class="informalexample"><pre class="programlisting">console.time(label)
console.timeEnd(label)</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec669"/>Description</h4></div></div></div><p>These two functions will always be used together. The <code class="literal">console.time</code> parameter will start a timer that can be stopped with <code class="literal">console.timeEnd</code> by passing the same label. When <code class="literal">timeEnd</code> is <a class="indexterm" id="id2712"/>called, it will log the elapsed time between start and end in milliseconds.</p><p>Here is an example that uses <code class="literal">setTimeout</code>:</p><div class="informalexample"><pre class="programlisting">console.time('simple-timer');
setTimeout(function () {
    console.timeEnd('simple-timer');
}, 500);</pre></div></div></div><div class="section" title="trace"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec800"/>trace</h3></div></div></div><p>This logs to the <a class="indexterm" id="id2713"/>console and includes a stack trace:</p><div class="informalexample"><pre class="programlisting">console.trace(message, […])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec670"/>Description</h4></div></div></div><p>This works much <a class="indexterm" id="id2714"/>like <code class="literal">console.log</code>. The first parameter can be treated like a formatted string, with the other parameters supplying the additional input. The main difference is that <code class="literal">console.trace</code> will include a stack trace when it logs to the console.</p><p>Here is a simple example:</p><div class="informalexample"><pre class="programlisting">console.trace('This should be the first line.');</pre></div></div></div></div><div class="section" title="npm (Node Package Manager)"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec519"/>npm (Node Package Manager)</h2></div></div></div><p>npm is <a class="indexterm" id="id2715"/>not a Node.js module like. We will look at <a class="indexterm" id="id2716"/>some of npm's features and uses, as almost every Node.js project will use npm.</p><p>Most modern platforms have a way of grouping together code that serves a function or purpose called packages. Node.js uses npm to track, update, pin, and install these packages.</p><div class="section" title="init"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec801"/>init</h3></div></div></div><p>This initializes <a class="indexterm" id="id2717"/>a node module by creating <code class="literal">package.json</code> <a class="indexterm" id="id2718"/>in the current directory:</p><div class="informalexample"><pre class="programlisting">npm init</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec671"/>Description</h4></div></div></div><p>An interactive console session will ask you quite a few questions and use the answers to build a <code class="literal">package.json</code> file <a class="indexterm" id="id2719"/>for you. This is a great way to kick off a new module. This will not delete your current the <code class="literal">package.json</code> file or any of the current properties if the <code class="literal">package.json</code> file exists.</p></div></div><div class="section" title="package.json"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec802"/>package.json</h3></div></div></div><p>This is the <a class="indexterm" id="id2720"/>file that has all the information about your project.</p><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec672"/>Description</h4></div></div></div><p>This is not a function <a class="indexterm" id="id2721"/>or command, but it is the most important file in your project. It is what determines all the information about your project. Although technically, the only properties needed are name and version, there are many properties that can be set. If this file was created using npm in it, you will have quite a few already filled out. It would be tedious to list out all the possibilities. Here are just a few of the most useful: name, version, scripts, dependencies, devDependencies, authors, and license.</p><p>The npm docs at <a class="ulink" href="https://www.npmjs.org/doc/files/package.json.html">https://www.npmjs.org/doc/files/package.json.html</a> go through all the <a class="indexterm" id="id2722"/>settings their uses.</p></div></div><div class="section" title="install"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec803"/>install</h3></div></div></div><p>This is the <a class="indexterm" id="id2723"/>command to install a package:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>npm install </strong></span>
<span class="strong"><strong>npm install [package] [@version] [--save | --save-dev]</strong></span>
</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec673"/>Description</h4></div></div></div><p>This is the main way <a class="indexterm" id="id2724"/>to install new packages and their dependencies. If <code class="literal">npm install</code> is called without any parameters, it will use <code class="literal">package.json</code> and install all the dependencies.</p><p>This command also allows you to install packages by executing it with the name of the package. This can be augmented by adding a version. If the version is omitted, it will install the newest version. In addition to this, you can use save flags that create a property in dependencies or devDependcies.</p><p>This is not the entire list of what <code class="literal">npm install</code> can do, but it is the most used list.</p></div></div><div class="section" title="update"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec804"/>update</h3></div></div></div><p>This will <a class="indexterm" id="id2725"/>update a package to the newest version:</p><div class="informalexample"><pre class="programlisting">npm update [package]</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec674"/>Description</h4></div></div></div><p>This command <a class="indexterm" id="id2726"/>will update all the packages or a specific package to the newest version.</p></div></div><div class="section" title="shrinkwrap"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec805"/>shrinkwrap</h3></div></div></div><p>This will <a class="indexterm" id="id2727"/>explicitly define all the dependencies for a project:</p><div class="informalexample"><pre class="programlisting">npm shrinkwrap</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec675"/>Description</h4></div></div></div><p>This is different <a class="indexterm" id="id2728"/>from the basic list of dependencies in <code class="literal">package.json</code>. Most packages have requirements of their own. When a package is installed, npm will go out and find the newest version that matches the dependency's specified version. This can lead to different versions of packages installed when run at different times. This is something that most developers want to avoid.</p><p>One way to combat this is to run <code class="literal">npm shrinkwrap</code>. It will create <code class="literal">npm-shrinkwrap.json</code>. This file will explicitly define the versions currently installed recursively for every package installed. This ensures that when you run <code class="literal">npm install</code> again, you will know what package versions will get installed.</p></div></div><div class="section" title="run"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec806"/>run</h3></div></div></div><p>This will run <a class="indexterm" id="id2729"/>an arbitrary command:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>npm run [script]</strong></span>
</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec676"/>Description</h4></div></div></div><p>The <code class="literal">package.json</code> file has a property named scripts. This is an object that can have a list of commands that can be run by npm. These scripts can be anything that runs from the command line.</p><p>There are three <a class="indexterm" id="id2730"/>commands on npm that use these scripts objects. These are <code class="literal">npm test</code>, <code class="literal">npm start</code>, and <code class="literal">npm stop</code>. These commands map to test, start, and stop the scripts object, respectively.</p><p>Here is an example for a scripts object from <code class="literal">package.json</code> and the way to call it from <code class="literal">npm</code>:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>package.json:</strong></span>
<span class="strong"><strong>  "scripts": {</strong></span>
<span class="strong"><strong>    "hey":  "echo hey"</strong></span>
<span class="strong"><strong>}</strong></span>
<span class="strong"><strong>npm run hey</strong></span>
</pre></div></div></div></div><div class="section" title="Stream"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec520"/>Stream</h2></div></div></div><p>Stream is an <a class="indexterm" id="id2731"/>interface that is used by many internal objects. Any time data needs to be <a class="indexterm" id="id2732"/>read or written, it is most likely done through a stream. This fits with the Node.js asynchronous paradigm. If we are reading a large file from the filesystem, we would create a listener to tell us when each chunk of data is ready to be read. This does not change if that file is coming from the network, an HTTP request, or <code class="literal">stdin</code>.</p><p>We are only going to cover using a stream, in this book. The stream interface can be implemented with your own objects as well.</p><p>Streams can be <a class="indexterm" id="id2733"/>readable, writable, or duplex (both). We will cover readable and writable streams separately.</p><div class="section" title="Readable"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec807"/>Readable</h3></div></div></div><p>This is, of course, a <a class="indexterm" id="id2734"/>stream that we can get data out of. A readable stream can be in one of the two different modes, flowing, or non-flowing. Which mode it is in depends on which events are listened for.</p><p>To put a stream in the <a class="indexterm" id="id2735"/>flowing mode, you will just have to listen for the data event. Conversely, to put a stream in the non-flowing mode, you will have to listen for the readable event and then call the <code class="literal">stream.read()</code> function to retrieve data. The easiest way to understand the modes is to think about the data as a lot of chunks. In the flowing mode, every time a chunk is ready, the data event will fire, and you can read that chunk in the callback of the data event. In the non-flowing mode, the chunk will fire a readable event, and then, you will have to call read to get the chunk.</p><p>Here is a list of events:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">readable</li><li class="listitem" style="list-style-type: disc">data</li><li class="listitem" style="list-style-type: disc">end</li><li class="listitem" style="list-style-type: disc">close</li><li class="listitem" style="list-style-type: disc">error</li></ul></div><p>Here are two examples, one that uses flowing and one that uses non-flowing:</p><div class="informalexample"><pre class="programlisting">var fs = require('fs');
var readable = fs.createReadStream('test.txt');

readable.on('data', function (chunk) {
    console.log(chunk.toString());
});
var fs = require('fs');
readable.on('readable', function () {
    var chunk;
   while (chunk = readable.read()) {
        console.log(chunk.toString());
    }
});</pre></div><div class="section" title="read"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec677"/>read</h4></div></div></div><p>Use with a <a class="indexterm" id="id2736"/>non-flowing readable stream:</p><div class="informalexample"><pre class="programlisting">readable.read([size])</pre></div><div class="section" title="Return value"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl5sec65"/>Return value</h5></div></div></div><p>This returns either a string, buffer, or null. A string is returned if the encoding is set. A buffer is returned if the encoding is not set. Finally, null is returned when there is no data in the stream.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl5sec66"/>Description</h5></div></div></div><p>This reads from a <a class="indexterm" id="id2737"/>stream. Most of the time, the optional parameter size is not needed and should be avoided. Only use this with a non-flowing stream.</p><p>Here is a simple example that reads a file:</p><div class="informalexample"><pre class="programlisting">readable.on('readable', function () {
    var chunk;
   while (chunk = readable.read()) {
        console.log(chunk.toString());
    }
});</pre></div></div></div><div class="section" title="setEncoding"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec678"/>setEncoding</h4></div></div></div><p>This <a class="indexterm" id="id2738"/>sets the encoding of the stream:</p><div class="informalexample"><pre class="programlisting">stream.setEncoding(encoding)</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl5sec67"/>Description</h5></div></div></div><p>By default, a <a class="indexterm" id="id2739"/>readable stream will output a buffer. This will set the encoding of the buffer, so a string is returned.</p><p>Here is the opening example with <code class="literal">setEncoding</code> used:</p><div class="informalexample"><pre class="programlisting">readable.setEncoding('utf8');
readable.on('readable', function () {
    var chunk;
   while (chunk = readable.read()) {
        console.log(chunk);
    }
});</pre></div></div></div><div class="section" title="resume and pause"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec679"/>resume and pause</h4></div></div></div><p>These <a class="indexterm" id="id2740"/>functions pause and resume a stream:</p><div class="informalexample"><pre class="programlisting">stream.pause()
stream.resume()</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl5sec68"/>Description</h5></div></div></div><p>Pause will stop a <a class="indexterm" id="id2741"/>stream from emitting data events. If this is called on a non-flowing stream, it will be changed into a flowing stream and be paused. Resume will cause the stream to start emitting data events again.</p><p>Here is an example that pauses the stream for a few seconds before reading it:</p><div class="informalexample"><pre class="programlisting">readable.pause();
readable.on('data', function (chunk) {
    console.log(chunk.toString());
});
setTimeout(function () { readable.resume();}, 3000);</pre></div></div></div><div class="section" title="pipe"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec680"/>pipe</h4></div></div></div><p>This allows <a class="indexterm" id="id2742"/>you to take the output of a readable stream and send it to the input of a writable stream:</p><div class="informalexample"><pre class="programlisting">readable.pipe(writable, [options])</pre></div><div class="section" title="Return Value"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl5sec69"/>Return Value</h5></div></div></div><p>This returns the <a class="indexterm" id="id2743"/>writable stream so that piping can be chained.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl5sec70"/>Description</h5></div></div></div><p>This is exactly the same as piping output in a shell.</p><p>A great design paradigm is to pipe from a stream to another stream that transforms the stream and then pipe that to the output. For example, you want to send a file over the network. You would open the file as a readable stream, pass it to a duplex stream that would compress it, and pipe the output of the compression to a socket.</p><p>Here is a simple example of piping output to <code class="literal">stdout</code>:</p><div class="informalexample"><pre class="programlisting">var readable = fs.createReadStream('test.txt');
readable.pipe(process.stdout);</pre></div></div></div></div><div class="section" title="writable"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec808"/>writable</h3></div></div></div><p>This is the <a class="indexterm" id="id2744"/>stream the data goes to. This is a little simpler as there are <a class="indexterm" id="id2745"/>really only two functions that matter: write and end.</p><p>Here are the events and details of when they fire:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">drain</code>: This fires when the internal buffer has written all the data</li><li class="listitem" style="list-style-type: disc"><code class="literal">finish</code>: This fires when the stream has been ended and all the data has been written</li><li class="listitem" style="list-style-type: disc"><code class="literal">error</code>: This fires <a class="indexterm" id="id2746"/>when an error occurs</li></ul></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note65"/>Note</h3><p>It is important to note that a stream can be given more data than it can write in a timely fashion. This is especially true when writing to a network stream. Because of this, the events <code class="literal">finish</code> and <code class="literal">drain</code> to let your program know that the data has been sent.</p></div></div><div class="section" title="write"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec681"/>write</h4></div></div></div><p>This function <a class="indexterm" id="id2747"/>writes to the stream:</p><div class="informalexample"><pre class="programlisting">writable.write(chunk, [encoding], [callback])</pre></div><div class="section" title="Return value"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl5sec71"/>Return value</h5></div></div></div><p>This returns a Boolean value if the stream has written completely.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl5sec72"/>Description</h5></div></div></div><p>This is the main <a class="indexterm" id="id2748"/>function of a writable stream. Data can be a buffer or string, encoding defaults to UTF8, and the callback is called when the current chunk of data has been written.</p><p>Here is a simple example:</p><div class="informalexample"><pre class="programlisting">var fs = require('fs');
var writable = fs.createWriteStream('WriteStream.txt');

var hasWritten = writable.write('Write this!', 'utf8', function () {
    console.log('The buffer has written');
});
end</pre></div><p>This will close the stream, and no more data can be written:</p><div class="informalexample"><pre class="programlisting">writable.end([chunk], [encoding], [callback])</pre></div></div><div class="section" title="Description"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl5sec73"/>Description</h5></div></div></div><p>When you are done writing to a stream, the end function should be called on it. All the parameters are optional, a chunk is data that you can write before the stream ends, encoding will default to UTF8, and the callback will be attached to the finish event.</p><p>Here is an example to end a writable stream:</p><div class="informalexample"><pre class="programlisting">var fs = require('fs');
var writable = fs.createWriteStream('WriteStream.txt');

writable.end('Last data written.', 'utf8', function () {
    //this runs when everything has been written.
});</pre></div></div></div></div></div></div>
<div class="section" title="The net module"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec83"/>The net module</h1></div></div></div><p>The <code class="literal">net</code> <a class="indexterm" id="id2749"/>module in Node.js allows us to create network connections. The connections that are created will be streams that we can write to and read from. This section will focus on just network connections and not HTTP. Node.js has a full HTTP module, and we will cover that in the next section.</p><p>All the functions <a class="indexterm" id="id2750"/>assume that the <code class="literal">net</code> module has been loaded like this:</p><div class="informalexample"><pre class="programlisting">var net = require('net');</pre></div><div class="section" title="createServer"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec521"/>createServer</h2></div></div></div><p>This <a class="indexterm" id="id2751"/>function <a class="indexterm" id="id2752"/>will create a TCP server:</p><div class="informalexample"><pre class="programlisting">net.createServer([options], [listener]) </pre></div><div class="section" title="Return value"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec809"/>Return value</h3></div></div></div><p>This <a class="indexterm" id="id2753"/>returns a <code class="literal">net.Server</code> object.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec810"/>Description</h3></div></div></div><p>This function <a class="indexterm" id="id2754"/>allows us to listen for connections. The returned object will be a <code class="literal">net.Server</code> object, and the connection listener will be passed to a <code class="literal">net.Socket</code> object. We will cover both of these objects shortly.</p><p>Here is a simple example that shows us how to listen and write to a socket. Each connection will have to be manually closed:</p><div class="informalexample"><pre class="programlisting">var net = require('net');
var server = net.createServer(function (connection) {
    connection.write('You connected!');
});
server.listen(5000, function () { 
    console.log('Listening on port 5000');
});</pre></div></div></div><div class="section" title="net.Server"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec522"/>net.Server</h2></div></div></div><p>We will now <a class="indexterm" id="id2755"/>look at the <code class="literal">net.Server</code> object. All of the functions in the next <a class="indexterm" id="id2756"/>section will need to a have a <code class="literal">Server</code> object created through <code class="literal">createServer</code>.</p><p>The <code class="literal">net.Server</code> parameter is an <code class="literal">EventEmitter</code> that will emit events. Here is a list of the events with the event argument if there is one:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Connection: <code class="literal">net.Socket</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">close</code></li><li class="listitem" style="list-style-type: disc">Error: <code class="literal">Error</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">listening</code></li></ul></div><p>Here is an <a class="indexterm" id="id2757"/>example that uses all of the events:</p><div class="informalexample"><pre class="programlisting">var net = require('net');
var server = net.createServer();
server.on('listening', function () {
    console.log('I am listening');
});
server.on('connection', function (socket) {
    console.log(socket);
    socket.end();
    server.close();
});
server.on('error', function (err) {
    console.log(err);
});
server.on('close', function () {
    console.log('The server has stopped listening');
});
server.listen(5000);</pre></div><div class="section" title="listen"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl4sec682"/>listen</h3></div></div></div><p>This starts <a class="indexterm" id="id2758"/>accepting connections:</p><div class="informalexample"><pre class="programlisting">server.listen(port, [host], [backlog], [callback])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl5sec74"/>Description</h4></div></div></div><p>Creating a server <a class="indexterm" id="id2759"/>does not get it to start listening to requests. We will have to give the listen function at least a port. The host is optional, as it will listen on all IPv4 addresses, and the backlog will be the queue of connections. Finally, the callback will be called when the server starts listening.</p><p>You may get <code class="literal">EADDRINUSE</code>. This just means that the port is already being used by another process.</p><p>Here is an example <a class="indexterm" id="id2760"/>that defines all the parameters:</p><div class="informalexample"><pre class="programlisting">server.listen(5000, '127.0.0.1', 500, function () { 
    console.log('Listening on port 5000');
});</pre></div></div></div><div class="section" title="close"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl4sec683"/>close</h3></div></div></div><p>This closes the <a class="indexterm" id="id2761"/>current server:</p><div class="informalexample"><pre class="programlisting">server.close([callback])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl5sec75"/>Description</h4></div></div></div><p>This will stop the <a class="indexterm" id="id2762"/>server from creating new connections. This is important to remember because it will not close the current connections.</p><p>The callback is called when there are no more connections.</p></div></div><div class="section" title="address"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl4sec684"/>address</h3></div></div></div><p>This gets the <a class="indexterm" id="id2763"/>port and address:</p><div class="informalexample"><pre class="programlisting">server.address()</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl5sec76"/>Description</h4></div></div></div><p>This will give you the <a class="indexterm" id="id2764"/>port and IP address where this server is listening.</p></div></div><div class="section" title="getConnections"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl4sec685"/>getConnections</h3></div></div></div><p>This <a class="indexterm" id="id2765"/>gets the number of connections:</p><div class="informalexample"><pre class="programlisting">server.getConnections(callback)</pre></div><div class="section" title="Return Value"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl5sec77"/>Return Value</h4></div></div></div><p>This returns an integer.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl5sec78"/>Description</h4></div></div></div><p>This does not give any <a class="indexterm" id="id2766"/>information on each connection. It only returns the number. This is a great way to see whether there are any connections. The callback function will need to be in the form of <span class="emphasis"><em>function(err, connections)</em></span>.</p></div></div><div class="section" title="connect"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec812"/>connect</h3></div></div></div><p>This easily <a class="indexterm" id="id2767"/>creates a connection to the specified address:</p><div class="informalexample"><pre class="programlisting">net.connect(port, [host], [connectListener])
net.createConnection(port, [host], [connectListener])</pre></div><div class="section" title="Return value"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec686"/>Return value</h4></div></div></div><p>This returns a <code class="literal">net.Socket</code> object.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec687"/>Description</h4></div></div></div><p>This function does not do <a class="indexterm" id="id2768"/>anything that you cannot do with a socket. It is a convenient function that returns a <code class="literal">net.Socket</code> object.</p><p>For the parameters, a port is required, the host will default to localhost, and <code class="literal">connectListener</code> will be added to the connect event of the newly formed <code class="literal">net.Socket</code> object.</p><p>Here is an example that will connect to a server we just created and send data every second:</p><div class="informalexample"><pre class="programlisting">var net = require('net');
var server = net.createServer();
server.on('listening', function () {
    console.log('I am listening');
});
server.on('connection', function (socket) {
    socket.on('data', function (d) {
        console.log('from client: ' + d);
    });
});

server.listen(5000);

var client = net.connect({ port: 5000, host: 'localhost' }, function () {
    setInterval(function () {
        client.write('hey!');
    }, 1000);
});</pre></div></div></div><div class="section" title="net.Socket"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec813"/>net.Socket</h3></div></div></div><p>This section will <a class="indexterm" id="id2769"/>be similar to the <code class="literal">net.Server</code> section. The <code class="literal">net.Socket</code> parameter is the object that is returned anytime a connection is made. It can also be used to create a new connection.</p><p>It is a readable and writable <a class="indexterm" id="id2770"/>stream. This is the only way to send and receive data from a <code class="literal">net.Socket</code>.</p><p>Here is the list of events along with details of when they fire:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">connect</code>: On connection.</li><li class="listitem" style="list-style-type: disc"><code class="literal">data</code>: When data is received.</li><li class="listitem" style="list-style-type: disc"><code class="literal">end</code>: When the socket has ended.</li><li class="listitem" style="list-style-type: disc"><code class="literal">timeout</code>: When the socket has timed out from inactivity. The socket is still open at this point.</li><li class="listitem" style="list-style-type: disc"><code class="literal">drain</code>: When all the data in the write buffer has been sent.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Error</code>: On error.</li><li class="listitem" style="list-style-type: disc"><code class="literal">close</code>: When the socket closes.</li></ul></div><p>As <code class="literal">net.Socket</code> is a readable stream, there is no read function. You will have to listen for the data event to the get the data.</p><p>Here is an example of <a class="indexterm" id="id2771"/>using a socket to connect to a local <a class="indexterm" id="id2772"/>server:</p><div class="informalexample"><pre class="programlisting">var server = net.createServer();
server.on('listening', function () {
    console.log('I am listening');
});
server.on('connection', function (socket) {
    socket.on('data', function (d) {
        console.log('from client: ' + d);
    });
});

server.listen(5000);

var client = new net.Socket();
client.on('connect', function () {
    setInterval(function () {
        client.write('Hey!');
    }, 1000);
});

client.connect(5000, 'localhost');</pre></div><div class="section" title="connect"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec688"/>connect</h4></div></div></div><p>This creates a <a class="indexterm" id="id2773"/>connection:</p><div class="informalexample"><pre class="programlisting">socket.connect(port, [host], [listener])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl5sec79"/>Description</h5></div></div></div><p>This is the function that actually <a class="indexterm" id="id2774"/>creates a connection. Much like <code class="literal">net.connection</code>, the port is required, the host will default to localhost, and the listener just maps the function to the connection event.</p><p>Here is an example that connects locally and writes to the connection:</p><div class="informalexample"><pre class="programlisting">var client = new net.Socket();
client.on('connect', function () {
    setInterval(function () {
        client.write('Hey!');
    }, 1000);
});

client.connect(5000, 'localhost');</pre></div></div></div><div class="section" title="write"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec689"/>write</h4></div></div></div><p>This sends <a class="indexterm" id="id2775"/>data out on the socket:</p><div class="informalexample"><pre class="programlisting">socket.write(data, [encoding], [callback])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl5sec80"/>Description</h5></div></div></div><p>The socket is buffered because it is very easy to queue up more data than can be sent over the network. This is done automatically by Node.js, but you should be aware of this, as buffering will use up memory as it is holding the data to be sent.</p><p>The encoding parameter will default to UTF8, but any of the encodings we have discussed can be used. The callback will be called once the data has been written over the socket.</p><p>Here is an example <a class="indexterm" id="id2776"/>with all of the parameters defined:</p><div class="informalexample"><pre class="programlisting">var client = new net.Socket();
client.on('connect', function () {
    client.write('This is the data', 'utf8', function(){
        console.log('Data has been sent');
    });
});

client.connect(5000, 'localhost');</pre></div></div></div><div class="section" title="end"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec690"/>end</h4></div></div></div><p>This starts the <a class="indexterm" id="id2777"/>closing process of the socket:</p><div class="informalexample"><pre class="programlisting">socket.end([data], [encoding])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl5sec81"/>Description</h5></div></div></div><p>This is effectively closing the <a class="indexterm" id="id2778"/>socket. We cannot say for sure, but the reason could be that the server could send some data back, although the socket will close shortly.</p><p>You can send some data before the socket closes, and this is what the optional parameters are for:</p><div class="informalexample"><pre class="programlisting">Here is an example that closes a socket.
var client = new net.Socket();
client.on('connect', function () {
    client.end('I am closing', 'utf8');
});

client.connect(5000, 'localhost');</pre></div></div></div></div></div></div>
<div class="section" title="The HTTP module"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec84"/>The HTTP module</h1></div></div></div><p>We will cover the <a class="indexterm" id="id2779"/>HTTP server module. Technically, you could write your HTTP server using the <code class="literal">net</code> module, but you do not have to.</p><p>Some of these functions are very similar to the <code class="literal">net</code> module functions. This should make sense as HTTP, at its core, is a network server.</p><p>All of these functions and objects are also used with the HTTPS module. The only difference is that for the options of <code class="literal">createServer</code> and <code class="literal">https.request</code>, you can pass certificates.</p><p>All of the following examples assume that the module has been loaded:</p><div class="informalexample"><pre class="programlisting">var http = require('http');</pre></div><div class="section" title="createServer"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec523"/>createServer</h2></div></div></div><p>This <a class="indexterm" id="id2780"/>creates <a class="indexterm" id="id2781"/>an HTTP server:</p><div class="informalexample"><pre class="programlisting">http.createServer([requestListener])</pre></div><div class="section" title="Return Value"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec814"/>Return Value</h3></div></div></div><p>This returns <a class="indexterm" id="id2782"/>an <code class="literal">http.Server</code> object.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec815"/>Description</h3></div></div></div><p>Much like <code class="literal">net.createServer</code>, this is required to serve anything. The <code class="literal">requestListener</code> parameter is attached to the request event.</p><p>Here is a simple <a class="indexterm" id="id2783"/>example that just logs to the console any time a request is made:</p><div class="informalexample"><pre class="programlisting">var server = http.createServer(function (req, res) {
    console.log('Someone made a request!');
    res.end();
});
server.listen(8080);</pre></div></div></div><div class="section" title="http.Server"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec524"/>http.Server</h2></div></div></div><p>This <a class="indexterm" id="id2784"/>is the server object that is returned from <code class="literal">http.createServer</code>. This is the object that will respond to all requests.</p><p>We will start with the <a class="indexterm" id="id2785"/>functions and look at each event separately as the events are important to handling requests.</p><div class="section" title="listen"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec816"/>listen</h3></div></div></div><p>This tells the <a class="indexterm" id="id2786"/>server to listen on the supplied port, path, or file descriptor:</p><div class="informalexample"><pre class="programlisting">server.listen(port, [host], [callback])
server.listen(path, [callback])
server.listen(fd, [callback])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec691"/>Description</h4></div></div></div><p>Although this <a class="indexterm" id="id2787"/>function has three different ways to execute, you will most likely only use the network listener. In fact, the other two listeners are difficult, if not impossible, to even execute on Windows. Let's cover the last two quickly.</p><p>The path listener will use a local socket server, and the file descriptor will need a handle. If this sounds foreign, it means you will use the other method.</p><p>The network listener requires that the port be used. The host will default to localhost if nothing is passed in. In all the functions, a callback will be attached to the listening event.</p><p>Here is an example of listening on a network port with all the parameters defined:</p><div class="informalexample"><pre class="programlisting">var server = http.createServer();
server.listen(8080, 'localhost', function(){
    console.log('The server is listening');
});</pre></div></div></div><div class="section" title="close"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec817"/>close</h3></div></div></div><p>This closes <a class="indexterm" id="id2788"/>the server:</p><div class="informalexample"><pre class="programlisting">server.close([callback])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec692"/>Description</h4></div></div></div><p>This will stop the server <a class="indexterm" id="id2789"/>from listening. The callback will be attached to the close event.</p><p>Here is a simple example:</p><div class="informalexample"><pre class="programlisting">var server = http.createServer();
server.listen(8080, 'localhost', function () {
    server.close(function () {
        console.log('Server has closed');
    });
});</pre></div></div></div><div class="section" title="Events"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec818"/>Events</h3></div></div></div><p>The <code class="literal">http.Server</code> <a class="indexterm" id="id2790"/>parameter is an <code class="literal">EventEmitter</code> object. The <a class="indexterm" id="id2791"/>events are also where the majority of work will be done.</p><div class="section" title="request"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec693"/>request</h4></div></div></div><p>This event fires <a class="indexterm" id="id2792"/>when a request comes in:</p><div class="informalexample"><pre class="programlisting">server.on('request', function (req, res) { });</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl5sec82"/>Description</h5></div></div></div><p>If you only listen to <a class="indexterm" id="id2793"/>one event, this is the event to listen for. It has the <code class="literal">request</code> and the server's response. The <code class="literal">req</code> attribute will be <code class="literal">http.IncomingMessage</code>, and the <code class="literal">res</code> attribute will be <code class="literal">http.ServerResponse</code>. We will look at both of these <a class="indexterm" id="id2794"/>objects in this section. In addition to this, <code class="literal">req</code> implements a readable stream interface, and <code class="literal">res</code> implements a writable stream interface.</p><p>Here is an example of listening for a request:</p><div class="informalexample"><pre class="programlisting">server.on('request', function (req, res) {
    res.end();
    console.log('A request was received');
});</pre></div></div></div><div class="section" title="close"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec694"/>close</h4></div></div></div><p>This event fires <a class="indexterm" id="id2795"/>when the server closes:</p><div class="informalexample"><pre class="programlisting">server.on('close', function () { });</pre></div></div><div class="section" title="upgrade"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec695"/>upgrade</h4></div></div></div><p>This event fires <a class="indexterm" id="id2796"/>when the client sends an HTTP upgrade:</p><div class="informalexample"><pre class="programlisting">server.on('upgrade', function (req, socket, buffer) { });</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h5 class="title"><a id="ch12lvl5sec83"/>Description</h5></div></div></div><p>An upgrade request <a class="indexterm" id="id2797"/>asks the web server to change protocols. If you are implementing another protocol other than HTTP you should listen and deal with this event. A great example of this is a <code class="literal">WebSocket</code> upgrade.</p><p>The <code class="literal">req</code> attribute is the request, the socket will be a <code class="literal">net.Socket</code>, and <code class="literal">buffer</code> is a Buffer.</p></div></div></div></div><div class="section" title="IncomingMessage"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec525"/>IncomingMessage</h2></div></div></div><p>This is <a class="indexterm" id="id2798"/>the request object when listening for the request <a class="indexterm" id="id2799"/>event or from <code class="literal">http.clientRequest</code>. This is a readable stream.</p><div class="section" title="headers"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec819"/>headers</h3></div></div></div><p>The HTTP headers <a class="indexterm" id="id2800"/>from the request:</p><div class="informalexample"><pre class="programlisting">message.headers</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec696"/>Description</h4></div></div></div><p>Sometimes, you will want to <a class="indexterm" id="id2801"/>make decisions based on the information in the headers. Here is an example using headers to check for basic authentication:</p><div class="informalexample"><pre class="programlisting">server.on('request', function (req, res) {
    if (req.headers.authorization !== undefined)
        //do a check here
    res.end();
});</pre></div></div></div><div class="section" title="method"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec820"/>method</h3></div></div></div><p>This gets the <a class="indexterm" id="id2802"/>HTTP method of the request:</p><div class="informalexample"><pre class="programlisting">message.method</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec697"/>Description</h4></div></div></div><p>This returns the <a class="indexterm" id="id2803"/>method as a string in uppercase. Here is an example for <code class="literal">GET</code>:</p><div class="informalexample"><pre class="programlisting">server.on('request', function (req, res) {
    if (req.method === 'GET')
        res.write(req.method);
    res.end();
});</pre></div></div></div><div class="section" title="url"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec821"/>url</h3></div></div></div><p>This is the <a class="indexterm" id="id2804"/>URL that was requested:</p><div class="informalexample"><pre class="programlisting">message.url</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec698"/>Description</h4></div></div></div><p>This will be a <a class="indexterm" id="id2805"/>string of the URL, including any query parameters. You can parse the string yourself or use Node's query string module and use the <code class="literal">parse</code> function.</p><p>Here is a simple example that will serve any files in the current directory. Remember that this is only an example and does no error checking:</p><div class="informalexample"><pre class="programlisting">server.on('request', function (req, res) {
        var file = fs.createReadStream('.' + req.url);
        file.pipe(res);
});</pre></div></div></div><div class="section" title="data"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec822"/>data</h3></div></div></div><p>This is the data <a class="indexterm" id="id2806"/>event from the readable stream interface.</p><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec699"/>Description</h4></div></div></div><p>If you have an incoming message, most likely, you would want to know what is in the message. As it is a <a class="indexterm" id="id2807"/>readable stream, we will need to listen for the data event to get all the data out. When the data is exhausted, the end event will fire.</p><p>Here is an example that creates listeners for the data and end event:</p><div class="informalexample"><pre class="programlisting">var data = '';
response.on('data', function (chunk) {
    console.log(chunk);
    data += chunk;
});

response.on('end', function () {
    console.log(data);
});</pre></div></div></div></div><div class="section" title="ServerResponse"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec526"/>ServerResponse</h2></div></div></div><p>This is the <a class="indexterm" id="id2808"/>response that the HTTP server creates for the event request. Each <a class="indexterm" id="id2809"/>request needs a response, and this is it. This implements a writable interface.</p><div class="section" title="writeHead"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec823"/>writeHead</h3></div></div></div><p>This will write the <a class="indexterm" id="id2810"/>HTTP response header:</p><div class="informalexample"><pre class="programlisting">response.WriteHead(statusCode, [headers])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec700"/>Description</h4></div></div></div><p>This writes the <a class="indexterm" id="id2811"/>header for the response. This needs to be called before <code class="literal">response.write</code>. If it is not, then the server will send it for you with the headers you have set.</p><p>
<code class="literal">statusCode</code> is the <a class="indexterm" id="id2812"/>HTTP status code of the response. A <code class="literal">header</code> is an object with the name of the header as a property and the value as the value.</p><p>Here is an example that writes the header:</p><div class="informalexample"><pre class="programlisting">server.on('request', function (req, res) {
    res.writeHead(200, { 'Content-Type': 'text/html' });
    res.end();
});</pre></div></div></div><div class="section" title="statusCode"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec824"/>statusCode</h3></div></div></div><p>This sets the <a class="indexterm" id="id2813"/>status code of the response:</p><div class="informalexample"><pre class="programlisting">response.statusCode</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec701"/>Description</h4></div></div></div><p>This is used instead of <code class="literal">response.writeHead</code>. If this is called after <code class="literal">writeHead</code> has been executed, then it will <a class="indexterm" id="id2814"/>not change the response header. It must be called instead of it.</p><p>Here is an example that uses <code class="literal">statusCode</code>:</p><div class="informalexample"><pre class="programlisting">server.on('request', function (req, res) {
    res.statusCode = 404;
    res.end();
});</pre></div></div></div><div class="section" title="setHeader"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec825"/>setHeader</h3></div></div></div><p>This writes <a class="indexterm" id="id2815"/>a specific header:</p><div class="informalexample"><pre class="programlisting">response.setHeader(name, value)</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec702"/>Description</h4></div></div></div><p>In the same way that <a class="indexterm" id="id2816"/>
<code class="literal">statusCode</code> must be called instead of <code class="literal">writeHead</code>, <code class="literal">setHeader</code> must be called instead of <code class="literal">writeHead</code>. This can be called multiple times to set multiple headers.</p><p>Here is an example of using <code class="literal">statusCode</code> and <code class="literal">setHeader</code> together:</p><div class="informalexample"><pre class="programlisting">server.on('request', function (req, res) {
    res.statusCode = 200;
    res.setHeader('Content-Type', 'text/html');
    res.setHeader('Custom-Header', 'Custom-Value');
    res.end();
});</pre></div></div></div><div class="section" title="write"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec826"/>write</h3></div></div></div><p>This is the function <a class="indexterm" id="id2817"/>that writes the response body:</p><div class="informalexample"><pre class="programlisting">response.write(chunk, [encoding])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec703"/>Description</h4></div></div></div><p>The <code class="literal">response.write</code> <a class="indexterm" id="id2818"/>parameter is a writable stream, so this interface can be used. A chunk can be a buffer or string. The encoding is optional as it will default to UTF8. Here is an example that writes a simple HTML page as the response:</p><div class="informalexample"><pre class="programlisting">server.on('request', function (req, res) {
    res.statusCode = 200;
    res.setHeader('Content-Type', 'text/html');
    res.write('&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;');
    res.end();
});</pre></div></div></div><div class="section" title="end"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec827"/>end</h3></div></div></div><p>This ends <a class="indexterm" id="id2819"/>the response:</p><div class="informalexample"><pre class="programlisting">response.end([data], [encoding])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec704"/>Description</h4></div></div></div><p>The <code class="literal">response</code> parameter is a <a class="indexterm" id="id2820"/>writable stream, so we must end the stream when we are done writing. Data is any optional data that needs to be written, and encoding will default to UTF8. All of the examples for response have used <code class="literal">res.end</code>. If you do not end the response, the browser will wait for a response from the server.</p></div></div></div><div class="section" title="http.request"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec527"/>http.request</h2></div></div></div><p>This <a class="indexterm" id="id2821"/>makes a request using HTTP:</p><div class="informalexample"><pre class="programlisting">http.request(options, [callback])</pre></div><div class="section" title="Return value"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl4sec705"/>Return value</h3></div></div></div><p>This returns <a class="indexterm" id="id2822"/>an <code class="literal">http.ClientRequest</code> object.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl4sec706"/>Description</h3></div></div></div><p>Node.js allows you to consume HTTP as well as serve it. The options object has many properties that can be set. Here is a list of them:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">host</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">hostname</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">port</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">localAddress</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">socketPath</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">method</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">path</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">headers</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">auth</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">agent</code></li></ul></div><p>Every option is not required for each request. Most of the time, only <code class="literal">hostname</code>, <code class="literal">port</code>, <code class="literal">path</code>, and <code class="literal">method</code> are <a class="indexterm" id="id2823"/>needed to make a request. The options parameter can also be a URL as a string.</p><p>The callback will be attached to the response event. The request object is a writable stream so that data can be sent to the server.  Here is an example that makes a request to Packt Publishing:</p><div class="informalexample"><pre class="programlisting">var request = http.request({
    host: 'www.packtpub.com',
    port: 80,
    path: '/',
    method: 'GET'
}, function (res) {
    console.log(res);
});

request.end();</pre></div></div></div><div class="section" title="http.get"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec528"/>http.get</h2></div></div></div><p>This is <a class="indexterm" id="id2824"/>the convenience method for a <code class="literal">GET</code> request:</p><div class="informalexample"><pre class="programlisting">http.get(options, [callback])</pre></div><div class="section" title="Return value"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec829"/>Return value</h3></div></div></div><p>This returns a <a class="indexterm" id="id2825"/>
<code class="literal">http.ClientRequest</code> object.</p></div><div class="section" title="Description"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec830"/>Description</h3></div></div></div><p>This works in a manner similar to <code class="literal">http.request</code>, except it automatically sends an empty request and calls the end function. If you are only making a <code class="literal">GET</code> request, this can save some boilerplate code.</p><p>Here is an example that <a class="indexterm" id="id2826"/>requests Packt Publishing:</p><div class="informalexample"><pre class="programlisting">http.get('http://www.packtpub.com', function (res) {
    console.log(res);
});</pre></div></div></div><div class="section" title="http.clientRequest"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec529"/>http.clientRequest</h2></div></div></div><p>This is <a class="indexterm" id="id2827"/>the <a class="indexterm" id="id2828"/>object that is returned from <code class="literal">http.request</code>.</p><div class="section" title="write"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec831"/>write</h3></div></div></div><p>This writes <a class="indexterm" id="id2829"/>to the server in the request:</p><div class="informalexample"><pre class="programlisting">request.write(data, [encoding])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec707"/>Description</h4></div></div></div><p>The <code class="literal">http.clientRequest</code> attribute is a writable stream. It is writable as you may need to send data to the remote server, for example, when making a <code class="literal">POST</code> request.</p><p>This works like all the other writable streams, so data can be a buffer or string, and encoding will default to UTF8.</p></div></div><div class="section" title="end"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec832"/>end</h3></div></div></div><p>This ends the <a class="indexterm" id="id2830"/>request:</p><div class="informalexample"><pre class="programlisting">request.end([data], [encoding])</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec708"/>Description</h4></div></div></div><p>When you are writing to a stream, you must end the stream with this function. Without doing this, the connection will stay and/or timeout. Data is optional and can be a buffer or string, while encoding will default to UTF8.</p></div></div><div class="section" title="response"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl3sec833"/>response</h3></div></div></div><p>This is the response <a class="indexterm" id="id2831"/>event. It lets you know that the remote server has responded:</p><div class="informalexample"><pre class="programlisting">request.on('response', function(response){})</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h4 class="title"><a id="ch12lvl4sec709"/>Description</h4></div></div></div><p>This event fires when the remote server responds. The response object in the callback will be <code class="literal">http.incomingMessage</code>.</p><p>If no response handler is added, the server response will be discarded. If there is a response handler, then Node.js will start to buffer the response to memory. If you do not read it back out, you can cause the server to crash.</p><p>Here is an example <a class="indexterm" id="id2832"/>listener that reads the data from the response:</p><div class="informalexample"><pre class="programlisting">var request = http.request({host: 'www.google.com', path: '/', port: 80, method: 'GET'});

request.on('response', function (response) {
    var data = '';
    response.on('data', function (chunk) {
        console.log(chunk);
        data += chunk;
    });

    response.on('end', function () {
        console.log(data);
    });
});</pre></div></div></div></div></div></body></html>