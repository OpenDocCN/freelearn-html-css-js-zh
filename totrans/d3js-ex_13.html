<html><head></head><body><div class="chapter" title="Chapter&#xA0;13.&#xA0;Combining D3.js and AngularJS"><div class="titlepage"><div><div><h1 class="title"><a id="ch13"/>Chapter 13. Combining D3.js and AngularJS</h1></div></div></div><p>The final topic in this book will demonstrate using multiple D3.js visuals on a single web page. These examples will also demonstrate constructing D3.js visuals in a modular manner, which allows their reuse through simple HTML tags, and at the same time abstracting the data from the code that renders the visual. This will enable the creation of more generic D3.js visuals, which can be placed on a page using a single HTML tag and are also loosely coupled with the source of the data.</p><p>To implement these features, we will utilize <span class="strong"><strong>AngularJS</strong></span>, a JavaScript framework used to create dynamic and modular web applications. The examples will demonstrate how to integrate both AngularJS (v1.4) and D3.js to make reusable and interoperable visualizations. An introductory knowledge of AngularJS is expected for this chapter, but the focus will be on how to use the features of AngularJS to create reusable and extensible D3.js controls; therefore, even someone new to AngularJS will be able to follow along.</p><p>In this chapter, we will accomplish this by going through the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">An overview of composite visualization</li><li class="listitem" style="list-style-type: disc">Creating a bar chart using an AngularJS application, controller, and directive</li><li class="listitem" style="list-style-type: disc">Adding a second directive to add a donut graph to the page</li><li class="listitem" style="list-style-type: disc">Adding a detail view and interactivity between the visuals</li><li class="listitem" style="list-style-type: disc">Updating the graphs upon modification of details in the data</li></ul></div><div class="section" title="An overview of composite visualization"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec64"/>An overview of composite visualization</h1></div></div></div><p>Before jumping into the examples, let's start by examining the end result to help conceptualize several of the goals that we will attempt to accomplish using AngularJS combined with D3.js. The following figure represents a static image of the resulting interactive and composite graphs:</p><div class="mediaobject"><img src="graphics/B04320_13_01.jpg" alt="An overview of composite visualization"/></div><p>Each component of the page—the bar graph, the donut graph, and the input form—will initially be built independently and will be able to function on its own. To do this, the examples will use features from AngularJS to facilitate the following features:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Each visual should be expressed in HTML as a simple HTML tag instead of copying the code for each onto the page. This is performed using AngularJS directives.</li><li class="listitem" style="list-style-type: disc">Instead of loading the data once within the code for each visual, we will leverage a common application-level data model shared across each element. In AngularJS, this is done by creating a JavaScript data model and injecting it into the controllers for each directive.</li><li class="listitem" style="list-style-type: disc">The bar graph will provide a means of exposing notifications of updates to a currently selected item, upon which the detail model can update its data. This will be implemented through a <code class="literal">selectedItem</code> property in the model that the details directive can monitor for updates using AngularJS template bindings.</li><li class="listitem" style="list-style-type: disc">Also, when the application model is updated in the details directive, the bar and donut graphs will be notified by AngularJS to be updated to represent the modifications.</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note160"/>Note</h3><p>A note of difference in this chapter from the previous is that the code is not available online on bl.ock.org or JSBIN.COM and must be retrieved from the Packt website. This is because the examples utilize AngularJS, which doesn't play as well with bl.ock.org and JSBIN.COM. The code must therefore be run locally from a web server. You can simply unzip the code and place it in the root of a web server or start a web server of your choice in the root folder of the content. Each example is implemented as a different HTML file in the root of the folder, and each of these refers to multiple other files in various subdirectories.</p></div></div></div></div>
<div class="section" title="Creating a bar graph using AngularJS"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec65"/>Creating a bar graph using AngularJS</h1></div></div></div><p>The first <a id="id602" class="indexterm"/>example will create a reusable <a id="id603" class="indexterm"/>bar chart component to demonstrate creating an AngularJS directive with an underlying controller. This is implemented within an HTML file, <code class="literal">01_just_bars.html</code>, which consists of the following components:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The AngularJS application object:</strong></span> This functions as an entry point for AngularJS code in the page (that is, in <code class="literal">app.js</code>)</li><li class="listitem" style="list-style-type: disc">An AngularJS controller (in <code class="literal">controllers/basic_dashboard.js</code>): This creates the data and sends it to the directive that renders the HTML code for the graph</li><li class="listitem" style="list-style-type: disc">The <a id="id604" class="indexterm"/>directive: This renders the D3.js <a id="id605" class="indexterm"/>bar chart in <code class="literal">directives/bars.js</code>.</li></ul></div><div class="section" title="The web page and application"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec84"/>The web page and application</h2></div></div></div><p>The AngularJS application <a id="id606" class="indexterm"/>is presented to the user via a web page, which begins by loading the AngularJS and D3.js libraries (this is common in all the examples in this chapter). Take a look at the following code:</p><div class="informalexample"><pre class="programlisting">&lt;script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.10/angular.min.js"&gt;&lt;/script&gt;
&lt;script src="http://d3js.org/d3.v3.min.js" charset="utf-8"&gt;&lt;/script&gt;</pre></div><p>The page then loads the implementations of the AngularJS application object, directive, and controller. Now, execute the following code:</p><div class="informalexample"><pre class="programlisting">&lt;script src="app.js"&gt;&lt;/script&gt;
&lt;script src="directives/bars.js"&gt;&lt;/script&gt;
&lt;script src="controllers/basic_dashboard.js"&gt;&lt;/script&gt;</pre></div><p>The details of these will be examined in a moment. Before we look at these, the remainder of the HTML code in this file creates the AngularJS application and the controller for our directive using a <code class="literal">&lt;div&gt;</code> tag with the <code class="literal">ng-app</code> and <code class="literal">ng-controller</code> properties. Add the following code:</p><div class="informalexample"><pre class="programlisting">&lt;div ng-app="dashboardApp" ng-controller="dashboardController"&gt;
    &lt;bars-view width="500" height="105"&gt;&lt;/bars-view&gt;
&lt;/div&gt;</pre></div><p>The use of the <code class="literal">ng-app</code> attribute tells AngularJS where to find the implementation, which is a module (that is, a piece of AngularJS JavaScript referable) named <code class="literal">dashboardApp</code>.</p><p>In this example, this module is declared in <code class="literal">app.js</code> (this is the same for each example):</p><div class="informalexample"><pre class="programlisting">angular.module('dashboardApp', []);</pre></div><p>This example does not actually declare any code for the application module and is simply a place for the HTML markup to reach into AngularJS and start locating various objects. In a more elaborate application, this would be a good place to inject other dependent modules and do some application-level initialization.</p><p>The tag within this <code class="literal">&lt;div&gt;</code> tag defines a construct known as an AngularJS directive. This renders the data represented in the controller. Before we get to the implementation of the directive, let's take a look at the controller that provides the data to the directive.</p></div><div class="section" title="The controller"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec85"/>The controller</h2></div></div></div><p>The <code class="literal">ng-controller</code> attribute on the <code class="literal">&lt;div&gt;</code> tag specifies a name of a controller that is used to provide data to the AngularJS directives that are specified as the child elements of this <code class="literal">&lt;div&gt;</code> tag. AngularJS searches for a controller with the specified name within one of the modules specified by <code class="literal">ng-app</code>. In this example, this controller is declared in <code class="literal">controllers/basic_dashboard.js</code>, as follows:</p><div class="informalexample"><pre class="programlisting">angular.module('dashboardApp')
    .controller('dashboardController', 
        ['$scope', function ($scope) {
            $scope.items = [
                { Name: 'Mike', Value: 49 },
                { Name: 'Marcia', Value: 52 },
                { Name: 'Mikael', Value: 18 }
        ];
    }]);</pre></div><p>This creates an AngularJS controller using <code class="literal">.controller()</code> with the name <code class="literal">dashboardController</code>, which is a part of the application's <code class="literal">dashboardApp</code> module. Take a look at the following script:</p><div class="informalexample"><pre class="programlisting">angular.module('dashboardApp')
       .controller('dashboardController', 
                   ['$scope', function ($scope) {</pre></div><p>The second parameter of<code class="literal"> .controller()</code> is an array that specifies the variables to be injected into the method implementing the controller and then the function that implements the controller.</p><p>Now, this informs AngularJS that we would like the AngularJS variable <code class="literal">$scope</code>, which represents the data of the controller and will be injected into the directives of the control to be passed into this function that is to be initialized.</p><p>The last statement in the following command declares the data that is to be provided to the view by adding an item's property to the scope:</p><div class="informalexample"><pre class="programlisting">$scope.items = [
    { Name: 'Mike', Value: 49 },
    { Name: 'Marcia', Value: 52 },
    { Name: 'Mikael', Value: 18 }
]; </pre></div></div><div class="section" title="The directive for a bar graph"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec86"/>The directive for a bar graph</h2></div></div></div><p>An angular directive is a custom HTML tag that instructs AngularJS on how to create HTML based on the data provided by the controller. In the HTML code of the example is a tag declared that is named <code class="literal">&lt;bars-view&gt;</code>. When loading the page, AngularJS examines all the tags in HTML, and if a tag is not recognized as a standard HTML tag, AngularJS searches for a directive that you declared as part of the application to provide an implementation for this tag.</p><p>In this case, it converts the hyphenated name of the tag, <code class="literal">&lt;bars-view&gt;</code>, to a camel case version, <code class="literal">barsView</code>, and looks for a directive within a module that was declared with this name. If found, AngularJS executes the code that is provided for the directive to generate the HTML code.</p><p>In this example, AngularJS finds the <code class="literal">&lt;bars-view&gt;</code> tag implemented in the <code class="literal">directives/bars.js</code> file. This file starts by informing AngularJS that we want to declare a directive named <code class="literal">barsView</code> in the <code class="literal">dashboardApp</code> module:</p><div class="informalexample"><pre class="programlisting">angular.module('dashboardApp')
    .directive('barsView', function () {
        return {
            restrict: 'E',
            scope: { data: '=' },
            link: renderView
        };</pre></div><p>The second parameter to <code class="literal">.directive()</code> is a function that informs AngularJS how to apply and construct the view. In this example, there are three instructions specified:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">restrict: 'E'</code>: This informs AngularJS that this directive applies to HTML elements only and not to their attributes or CSS class names.</li><li class="listitem" style="list-style-type: disc"><code class="literal">scope: { data: "="}</code>: This tells AngularJS that we want to have <span class="strong"><strong>two-way binding</strong></span> between the data in the scope and the elements in the view. If data changes in the controller, AngularJS will update the view and vice versa.</li><li class="listitem" style="list-style-type: disc"><code class="literal">link: renderView</code>: This property informs AngularJS which function will be called when the view is created. This function will then generate DOM constructs to represent the view. This is where we will put our D3.js code.</li></ul></div><p>The <code class="literal">renderView</code> function is declared as follows:</p><div class="informalexample"><pre class="programlisting">function renderView($scope, $elements, $attrs) {</pre></div><p>When AngularJS calls this function to render a tag for a directive, it passes the scope object represented by the related controller as the <code class="literal">$scope</code> parameter. The second parameter, <code class="literal">$elements</code>, is passed an AngularJS object that can be used to identify the top-level DOM element where the directive should append new elements. The last parameter, <code class="literal">$attrs</code>, is passed any custom attribute defined in the root DOM element in the prior parameter.</p><p>The code to implement the bar graph is not significantly different from our earlier bar graph examples. The first thing it does that is different because of AngularJS gets the data from the scope that was passed into the function, as follows:</p><div class="informalexample"><pre class="programlisting">var data = $scope.$parent.items;</pre></div><p>The <code class="literal">&lt;bars-view&gt;</code> directive is assigned a scope object by AngularJS. The data from the controller is actually a property of the <code class="literal">parent</code> scope property of this object. This object has the <code class="literal">items</code> property that we defined in the controller and its associated data as the <code class="literal">items</code> property.</p><p>The width and height of the element, as specified in the HTML code, can be retrieved using the <code class="literal">width</code> and <code class="literal">height</code> attributes of the <code class="literal">$attrs</code> parameter. Take a look at the following command:</p><div class="informalexample"><pre class="programlisting">var width = $attrs.width, height = $attrs.height;</pre></div><p>After obtaining the width and height, we can create the main SVG element of the graph. This will be appended to <code class="literal">$element[0]</code>, which represents the root DOM element for this directive (The <code class="literal">$element</code> object is actually an AngularJS one wrapping the root element, which is access using the <code class="literal">[0]</code> indexer), as follows:</p><div class="informalexample"><pre class="programlisting">var svg = d3.select($element[0])
    .append("svg");</pre></div><p>The remainder of the code is similar to the examples covered in previous chapters to create a bar graph with overlaid text. It begins by setting the size of the SVG element and setting up various variables required to calculate the size and positions of the bars, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">svg.attr({
    width: width,
    height: height
});

var max = d3.max(data, function(d) {
    return d.Value;
});

var colors = d3.scale.category20();

var barHeight = 30;
var leftMargin = 15;
var barTextOffsetY = 22;</pre></div><p>The bars are then created and set to animate to their maximum respective sizes. Take a look at the following:</p><div class="informalexample"><pre class="programlisting">svg.selectAll('rect')
    .data(data)
    .enter()
    .append('rect')
    .attr({
        height: barHeight,
        width: 0,
        x: 0,
        y: function(d, i) {
            return i * barHeight;
        },
        stroke: 'white'
    })
    .style('fill', function(d, i) {
        return colors(i);
    })
    .transition()
    .duration(1000)
    .attr('width', function(d) {
        return d.Value / (max / width);
    });</pre></div><p>Now, all the existing D3.js elements are selected in an update scenario, which <a id="id607" class="indexterm"/>transitions the size of any existing bar to the new size. Take a look at this code:</p><div class="informalexample"><pre class="programlisting">svg.selectAll("rect")
    .data(data)
    .transition()
    .duration(1000)
    .attr("width", function(d, i) {
        return d.Value / (max / width);
    });</pre></div><p>Then, the cases to create both the entering labels on the bars and change the text on the bars if the data values change are implemented, as follows:</p><div class="informalexample"><pre class="programlisting"> svg.selectAll('text')
    .data(data)
    .enter()
    .append('text')
    .attr({
        fill: '#fff',
        x: leftMargin,
        y: function(d, i) {
            return i * barHeight + barTextOffsetY;
        }
    })
    .text(function(d) { 
        return d.Name + ' (' + d.Value + ')'; 
    });

svg.selectAll('text')
    .data(data)
    .attr({
        fill: '#fff',
        x: leftMargin,
        y: function(d, i) {
            return i * barHeight + barTextOffsetY;
        }
    })
    .text(function(d) {
        return d.Name + ' (' + d.Value + ')';
    });
}</pre></div><p>When opening this page in the browser, the following graph is presented:</p><div class="mediaobject"><img src="graphics/B04320_13_02.jpg" alt="The directive for a bar graph"/></div></div></div>
<div class="section" title="Adding a second directive for a donut"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec66"/>Adding a second directive for a donut</h1></div></div></div><p>The next example adds a second D3.js visualization to represent a donut graph of the values in the data. This implementation requires creating a new directive and adding this directive to the web page. It reuses the implementation of the controller and also the data that it creates.</p><div class="section" title="The web page"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec87"/>The web page</h2></div></div></div><p>The web page for this example is availabl<a id="id608" class="indexterm"/>e in <code class="literal">02_bars_and_donut.html</code>. The web page is slightly different from the previous one in that it includes one additional view for the donut. Take a look at the following:</p><div class="informalexample"><pre class="programlisting">&lt;script src="app.js"&gt;&lt;/script&gt;
&lt;script src="views/bars.js"&gt;&lt;/script&gt;
&lt;script src="views/donut.js"&gt;&lt;/script&gt;
&lt;script src="controllers/basic_dashboard.js"&gt;&lt;/script&gt;</pre></div><p>The declaration of the content for the page now becomes the following:</p><div class="informalexample"><pre class="programlisting">&lt;div ng-app="dashboardApp" ng-controller="BasicBarsController"&gt;
    &lt;bars-view width="500" height="105" 
              style="display: table-cell; vertical-align: middle"&gt;
    &lt;/bars-view&gt;
    &lt;donut-view width="300" height="300" 
                style="display: table-cell"&gt;
    &lt;/donut-view&gt;
&lt;/div&gt;</pre></div><p>This adds an additional directive for <code class="literal">donut-view</code>. There is also a style added to the directives to make them <a id="id609" class="indexterm"/>float next to each other.</p></div><div class="section" title="The directive for the donut graph"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec88"/>The directive for the donut graph</h2></div></div></div><p>The implementation of the donut directive begins by declaring that that this directive will be added to the <code class="literal">dashboardApp</code> module and that its name will be <code class="literal">donutView</code> (hence we use &lt;<code class="literal">donut-view&gt;</code> in the HTML code). As with the bar graph directive, it also instructs AngularJS that this code should be applied only to DOM elements, have two-way data binding, and be implemented by a function named <code class="literal">renderView</code>; take a look at the following code:</p><div class="informalexample"><pre class="programlisting">angular.module('dashboardApp')
    .directive('donutView', function () {
        return {
            restrict: 'E',
            scope: { data: '=' },
            link: renderView
        };</pre></div><p>This version of <code class="literal">renderView</code> follows a similar pattern to the implementation for <code class="literal">bars-view</code>. It begins by getting the data from the scope, including the width and height of the visual, and also calculates the radius for the donut. The following code is executed:</p><div class="informalexample"><pre class="programlisting">function renderView($scope, $elements, $attrs) {
    var data = $scope.$parent.items;

    var width = $attrs.width,
        height = $attrs.height,
        radius = Math.min(width, height) / 2;</pre></div><p>The rendering of the donut is then started using a pie layout, as follows:</p><div class="informalexample"><pre class="programlisting">var pie = d3.layout.pie()
    .value(function (d) { return d.Value; })
    .sort(null);</pre></div><p>The arcs fill between <code class="literal">10</code> and <code class="literal">70</code> pixels from the outside of the boundary of the SVG element, which is based on the calculated radius. Take a look at the following code:</p><div class="informalexample"><pre class="programlisting">    var arc = d3.svg.arc()
        .innerRadius(radius - 70)
        .outerRadius(radius - 10);</pre></div><p>Then, the visual is started to be constructed by appending the main SVG element to <code class="literal">$elements[0]</code>, as follows:</p><div class="informalexample"><pre class="programlisting">    var svg = d3.select($elements[0])
        .append('svg')
        .attr({
            width: width,
            height: height
    });</pre></div><p>Finally, the visual elements for the donut graph are constructed using a color scale and path generator for each entering datum, as follows:</p><div class="informalexample"><pre class="programlisting">var colors = d3.scale.category20();
graphGroup
    .datum(data)
    .selectAll('path')
    .data(pie)
    .enter()
    .append('path')
    .attr('fill', function(d, i) {
        return colors(i);
    })
    .attr('d', arc)
    .each(function(d) {
        this._current = d;
    });</pre></div><p>Upon loading this page in the browser, it presents the following visual, which now has two D3.js visuals on a single web page:</p><div class="mediaobject"><img src="graphics/B04320_13_03.jpg" alt="The directive for the donut graph"/></div></div></div>
<div class="section" title="Adding a detail view and interactivity"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec67"/>Adding a detail view and interactivity</h1></div></div></div><p>The next example <a id="id610" class="indexterm"/>adds a details directive to the page and also interactivity such that when a bar is clicked, the details directive will display the appropriate data for the selected bar.</p><p>To achieve this interactivity, the bar graph directive is modified so that it produces an action that can be monitored by other parts of the AngularJS application. This action will be to set a <code class="literal">selectedItem</code> property on the model, which other controllers or directives can watch for changes and then take action.</p><div class="section" title="The web page"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec89"/>The web page</h2></div></div></div><p>The web page for <a id="id611" class="indexterm"/>this example is contained in <code class="literal">03_with_detail.html</code>. The content included differs slightly, in that we will include a new implementation of our <code class="literal">&lt;bars-view&gt;</code> directive in <code class="literal">directives/bars_with_click.js</code> and the controller in <code class="literal">controllers/enhanced_controller.js</code> and a reference to a new directive representing the detail view in <code class="literal">directives/detail.js</code>. Take a look at the following:</p><div class="informalexample"><pre class="programlisting">&lt;script src="app.js"&gt;&lt;/script&gt;
&lt;script src="directives/bars_with_click.js"&gt;&lt;/script&gt;
&lt;script src="directives/donut.js"&gt;&lt;/script&gt;
&lt;script src="directives/detail.js"&gt;&lt;/script&gt;
&lt;script src="controllers/enhanced_controller.js"&gt;
&lt;/script&gt;</pre></div><p>The declaration of the main <code class="literal">&lt;div&gt;</code> tag changes slightly to the following by adding a directive for <code class="literal">details-view</code>:</p><div class="informalexample"><pre class="programlisting">&lt;div ng-app="dashboardApp" ng-controller="dashboardController"&gt;
    &lt;bars-view width="500" height="105" 
        style="display: table-cell; vertical-align: middle"&gt;
    &lt;/bars-view&gt;
    &lt;donut-view width="300" height="300" 
        style="display: table-cell"&gt;&lt;/donut-view&gt;
    &lt;details-view data="selectedItem" width="300"&gt;
    &lt;/details-view&gt;
&lt;/div&gt;</pre></div><p>Note that this new directive uses an attribute named data and sets its value to <code class="literal">selectedItem</code>. This is a special AngularJS attribute/binding that specifies that the model data for this directive will be located in the <code class="literal">selectedItem</code> property of the nearest scope object upward in the DOM hierarchy. In this case, it is the scope defined on the div tag, and whenever this property on the scope is changed, this <a id="id612" class="indexterm"/>directive will update its data and visualization automatically.</p></div><div class="section" title="Specifying an initial selectedItem in the controller"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec90"/>Specifying an initial selectedItem in the controller</h2></div></div></div><p>The details view controller expects to have access to a <code class="literal">selectedItem</code> property of the model to use as its data, and it will, therefore, need to set an initial value to this property. The following adds a single line to accomplish this task:</p><div class="informalexample"><pre class="programlisting">angular.module('dashboardApp')
    .controller('dashboardController',
                ['$scope', function ($scope) {
        $scope.items = [
            { Name: 'Mike', Value: 49 },
            { Name: 'Marcia', Value: 52 },
            { Name: 'Mikael', Value: 18 }
        ];
        $scope.selectedItem = $scope.items[0];
    }]); </pre></div></div><div class="section" title="The modified bars view directive"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec91"/>The modified bars view directive</h2></div></div></div><p>The <code class="literal">&lt;bars-view&gt;</code> directive then adds a click handler to set the value of the selected item whenever a bar is clicked, as follows:</p><div class="informalexample"><pre class="programlisting">.on('click', function (d, i) {
    $timeout(function () {
        parent.selectedItem = d;
    };
}) </pre></div><p>This click handler performs one action: it updates the value of the selected item in the parent scope to the value of the data item underlying the clicked visual. It does not send messages to other components, nor should it. Other directives, if interested in this update, will be able to take this action by looking for changes in the model.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note161"/>Note</h3><p>This is wrapped in a call to the AngularJS <code class="literal">$timeout</code> function, which will have the browser update the UI, based on the change of this property. If this is not performed, any interested element will not by notified by AngularJS.</p></div></div></div><div class="section" title="Implementing the details view directive"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec92"/>Implementing the details view directive</h2></div></div></div><p>The details view is a fairly simple piece of code that starts with a directive declaration. Take a look at the following:</p><div class="informalexample"><pre class="programlisting">angular.module('dashboardApp')
    .directive('detailsView', function () {
        return {
            restrict: 'E',
            scope: { data: "=" },
            templateUrl: 'templates/static_item.html'
        };
    });</pre></div><p>A difference in this declaration from our other directives is that the code does not specify a <code class="literal">link</code> property but a <code class="literal">templateUrl</code> property and an associated value. This tells AngularJS that this directive will not be implemented by a call to a JavaScript function but should use content from the <code class="literal">templates/static_item.html</code> file. The contents of this file are the following:</p><div class="informalexample"><pre class="programlisting">Name: {{data.Name}}
&lt;br/&gt;
Value: {{data.Value}}</pre></div><p>This HTML code will be injected into DOM by AngularJS. The HTML contains embedded <span class="strong"><strong>handlebars</strong></span> syntax that AngularJS will notice and substitute the content of. In this case, the values of the <code class="literal">Name</code> and <code class="literal">Value</code> properties of the object specified by the data attribute of the directive will be used, where data is the bound value of <code class="literal">selectedItem</code> from the model, which is the currently selected bar. Whenever this property is updated, AngularJS will automatically update DOM correctly on our behalf without any additional coding.</p></div><div class="section" title="The resulting interactive page"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec93"/>The resulting interactive page</h2></div></div></div><p>The following <a id="id613" class="indexterm"/>image is an example of a possible display rendered by this page:</p><div class="mediaobject"><img src="graphics/B04320_13_04.jpg" alt="The resulting interactive page"/></div><p>In this image, the <a id="id614" class="indexterm"/>second bar was clicked on, and so the details view displays the data for this bar. As you click on the different bars, the values in the details change to match.</p></div></div>
<div class="section" title="Updating graphs upon the modification of details data"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec68"/>Updating graphs upon the modification of details data</h1></div></div></div><p>The final example will <a id="id615" class="indexterm"/>make the update of the data bidirectional between the details view and bar and donut graphs. The previous example only updates the detail view upon clicking on a bar. The content of the details view is static text, and hence, the user cannot modify the data. This is changed by modifying the template to utilize text input fields. There is no change to the controller, so it will not be discussed.</p><div class="section" title="The web page"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec94"/>The web page</h2></div></div></div><p>The web page for <a id="id616" class="indexterm"/>this example, <code class="literal">04_dynamic.html</code>, contains several small changes from the previous example to reference new implementations for the bars, donut, and details directives. The <code class="literal">&lt;div&gt;</code> tag remains the same. Take a look at the following code:</p><div class="informalexample"><pre class="programlisting">&lt;script src="app.js"&gt;&lt;/script&gt;
&lt;script src="directives/bars_with_click_and_updates.js"&gt;&lt;/script&gt;
&lt;script src="directives/donut_with_updates.js"&gt;&lt;/script&gt;
&lt;script src="directives/dynamic_detail.js"&gt;&lt;/script&gt;
&lt;script src="controllers/enhanced_controller.js"&gt;
&lt;/script&gt;</pre></div></div><div class="section" title="The revised bar-view directive"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec95"/>The revised bar-view directive</h2></div></div></div><p>The new &lt;<code class="literal">bar-view&gt;</code> <a id="id617" class="indexterm"/>directive has one behavioral change along with a small structural change. This behavioral change is to watch for changes to the <code class="literal">selectedItem</code> property of the scope that is supplied to it. To do this, the following statement is added near the top of the code for <code class="literal">renderView()</code>:</p><div class="informalexample"><pre class="programlisting">parent.$watch("selectedItem", render, true);</pre></div><p>This informs AngularJS that we want it to watch for changes in the bound scope object's <code class="literal">selectedItem</code> property. When this property or any property of this object changes (as specified by <code class="literal">true</code> as the third parameter), AngularJS will call the <code class="literal">render()</code> function.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note162"/>Note</h3><p>Note that this watch process does not have to be performed in the details view controller as the use of a template and handlebars sets this up automatically.</p></div></div><p>The structural change to the code is made after the call to select the <code class="literal">svg</code> element and the setting of its size. The code to create the visual is now wrapped in the new <code class="literal">render()</code> function, which is called the first time the directive is loaded and then each time the value of <code class="literal">selectedItem</code> is changed. When the latter happens, the bar graph is updated, it animates the bars to new sizes, and it also modifies the text labels.</p></div><div class="section" title="The revised donut-view directive"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec96"/>The revised donut-view directive</h2></div></div></div><p>Similarly to the updates to the <code class="literal">bar-view</code> directive, this directive is changed by adding a call to watch the <code class="literal">selectedItem</code> property of the scope as well as wrapping the rendering code in an <code class="literal">updatePath()</code> function, which can be called when the value of this property changes, as follows:</p><div class="informalexample"><pre class="programlisting">parent.$watch('selectedItem', updatePath, true);</pre></div><p>The <code class="literal">updatePath()</code> function only needs to regenerate the path for each of the arc segments, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">function updatePath() {
    path = path.data(pie);
    path.transition()
        .duration(750)
        .attrTween('d',
            function() {
                var i = d3.interpolate(this._current, a);
                this._current = i(0);
                return function(t) {
                    return arc(i(t));
                };
            });
}</pre></div></div><div class="section" title="The detail-view directive"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec97"/>The detail-view directive</h2></div></div></div><p>The new <code class="literal">&lt;detail-view&gt;</code> directive has one <a id="id618" class="indexterm"/>modification, which is to use a different template. Take a look at the following code:</p><div class="informalexample"><pre class="programlisting">angular.module('dashboardApp')
    .directive('detailsView', function () {
        return {
            restrict: 'E',
            scope: { data: "=" },
            templateUrl: 'templates/dynamic_item.html'
        };
    });</pre></div><p>The contents of this template specify input boxes instead of text fields, as follows:</p><div class="informalexample"><pre class="programlisting">Name: &lt;input type="text" ng-model="data.Name"/&gt;
&lt;br/&gt;
Value: &lt;input type="text" ng-model="data.Value"/&gt;</pre></div><p>Note that for input fields to update handlebars, notations cannot be utilized. For this to work, you need to use the AngularJS <code class="literal">ng-model</code> attribute and point it to the bound data object and respective property.</p></div><div class="section" title="The results"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec98"/>The results</h2></div></div></div><p>The following screenshot shows this example in action:</p><div class="mediaobject"><img src="graphics/B04320_13_05.jpg" alt="The results"/></div><p>In this demonstration, the third bar was clicked on, and <code class="literal">details-view</code> now provides edit controls to allow us to change the values. The value for <span class="strong"><strong>Mikael</strong></span> was then changed to <span class="strong"><strong>25</strong></span>, and the bar and donut graphs were animated to represent the change in values.</p><p>One of the really nice things <a id="id619" class="indexterm"/>going on here is that literally, key stroke by key stroke on both of these input fields, AngularJS will update these properties and both the bar and donut charts will be updated on each key stroke!</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec69"/>Summary</h1></div></div></div><p>The examples in this chapter demonstrated how to use AngularJS to make modular and composite D3.js visualizations. They started by showing how to place data within an AngularJS controller and share it with multiple D3.js visuals. Next, we demonstrated how to share data from a single controller to multiple directives. The final two examples demonstrated how to use a shared property for two-way communication and implement a details view to allow the editing of data.</p><p>This wraps up this book on using D3.js through examples. The book started with the basic concepts of D3.js and using its constructs to bind data and generate SVG from it. From this foundation, we progressed through adding features to the examples, each of which demonstrated progressive extensions of the previous examples within the same chapter as well as with incrementally complex constructs from chapter to chapter. In the end, the examples covered many of the concepts in D3.js that can take you from a novice to being able to construct rich, interactive, and composite visualizations, all through examples.</p></div></body></html>