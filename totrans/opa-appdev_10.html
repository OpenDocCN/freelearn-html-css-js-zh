<html><head></head><body><div class="chapter" title="Chapter&#xA0;10.&#xA0;Building a Game &#x2013; Pacman"><div class="titlepage"><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Building a Game – Pacman</h1></div></div></div><p>In this chapter, we will build the game called <span class="strong"><strong>Pacman</strong></span>. We will learn how to program with the help of HTML5 Canvas in Opa, <a id="id317" class="indexterm"/>including drawing shapes, texts, and images on the canvas. <a id="id318" class="indexterm"/>We will also discuss how to use an external JavaScript library. The complete source code<a id="id319" class="indexterm"/> can be found at <a class="ulink" href="https://github.com/winbomb/opapackt/tree/master/opacman">https://github.com/winbomb/opapackt/tree/master/opacman</a>. Following is a screenshot of our Pacman game:</p><div class="mediaobject"><img src="graphics/3749OS_10_01.jpg" alt="Building a Game – Pacman"/></div><div class="section" title="The project structure"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec48"/>The project structure</h1></div></div></div><p>Create an <a id="id320" class="indexterm"/>empty Opa project with the <code class="literal">opa create opacman</code> command<a id="id321" class="indexterm"/>. We need to modify the project structure. Let's first have a look at the modified project structure of our Pacman game:</p><div class="mediaobject"><img src="graphics/3749OS_10_02.jpg" alt="The project structure"/></div><p>The following is a <a id="id322" class="indexterm"/>brief description of the project files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">src</code>: The source code, <code class="literal">ghost.opa</code> and <code class="literal">pacman.opa</code> define the type of ghost and Pacman, <code class="literal">render.opa</code> takes charge of drawing on the canvas, and <code class="literal">game.opa</code> contains the game logic</li><li class="listitem" style="list-style-type: disc"><code class="literal">resources</code>: This folder contains the required resources, including images, sounds, and styles</li><li class="listitem" style="list-style-type: disc"><code class="literal">resources/js</code>: <code class="literal">Preloadjs.min.js</code> and <code class="literal">soundjs.min.js</code> are two open source <a id="id323" class="indexterm"/>JavaScript libraries and are used to preload game resources and to play sounds</li><li class="listitem" style="list-style-type: disc"><code class="literal">plugins</code>: <code class="literal">Preloader.js</code> is a plugin that we write to load game resources. </li><li class="listitem" style="list-style-type: disc">We need to rewrite the <code class="literal">opa.conf</code> file to include the source code in the <code class="literal">src</code> directory:<p>
<code class="literal">opacman.game</code> has the following files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">src/game.opa</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">src/ghost.opa</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">src/pacman.opa</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">src/render.opa</code></li></ul></div></li></ul></div><p>We need to<a id="id324" class="indexterm"/> modify <code class="literal">Makefile</code> to remove database support as we do not need the database in this application. We also need to tell the compiler to compile the plugins with source code. These two jobs can be done by changing <code class="literal">FLAG</code> with the following line:</p><div class="informalexample"><pre class="programlisting">FLAG = --opx-dir _build $(PCKDIR)Preloader.js</pre></div></div></div>
<div class="section" title="The HTML5 Canvas"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec49"/>The HTML5 Canvas</h1></div></div></div><p>First of all, <a id="id325" class="indexterm"/>we need a canvas element on which to draw our graphics. The<a id="id326" class="indexterm"/> HTML5 Canvas element is an HTML tag similar to the <code class="literal">&lt;div&gt;</code>, <code class="literal">&lt;a&gt;</code>, and <code class="literal">&lt;table&gt;</code> tags, with the exception that its contents are rendered with JavaScript. In Opa, we create a canvas element the exact same way in which we create other HTML elements:</p><div class="informalexample"><pre class="programlisting">function page(){
    &lt;canvas id=#gamecanvas width="520" height="620" 
onready={Game.gamestart}&gt;
&lt;/canvas&gt;
}</pre></div><p>This code <a id="id327" class="indexterm"/>creates a canvas with the <code class="literal">gamecanvas</code> ID. When the canvas element is ready, the <code class="literal">Game.gamestart</code> function<a id="id328" class="indexterm"/> will be invoked to start the game.</p><p>Next we must get the canvas context. It is important for us to understand the difference between the canvas element and the canvas context. The canvas element is a DOM node embedded in the HTML page, whereas the canvas context is an object with properties and methods that you can use to render graphics inside the canvas element. The context can be 2D or 3D (WebGL). In our Pacman game, we are using the 2D context. To get the canvas 2D context, we use the <code class="literal">Canvas.get_context_2d</code> function<a id="id329" class="indexterm"/>. The following code fragment demonstrates how to get the canvas context for a given ID:</p><div class="informalexample"><pre class="programlisting">ctx = match(Canvas.get(#gamecanvas)){
case  {none}: {none}
case ~{some}: Canvas.get_context_2d(some)
}</pre></div><p>Note that each canvas element can only have one context. If we use the <code class="literal">Canvas.get_context_2d</code> method<a id="id330" class="indexterm"/> multiple times for the same element, it will return the same context.</p></div>
<div class="section" title="Drawing a shape"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec50"/>Drawing a shape</h1></div></div></div><p>Now that <a id="id331" class="indexterm"/>we have the context of our canvas element, we can draw graphics on it. Opa and JavaScript use similar code to draw the <a id="id332" class="indexterm"/>graphics. The primary difference between them is that the drawing functions in Opa are static. All drawing methods can be found in the <code class="literal">Canvas</code> module.</p><div class="section" title="Using the fill and stroke properties"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec53"/>Using the fill and stroke properties</h2></div></div></div><p>Whenever we <a id="id333" class="indexterm"/>wish to draw shapes on a canvas, <a id="id334" class="indexterm"/>there are two properties that we need to set: <code class="literal">Stroke</code> and <code class="literal">Fill</code>. <code class="literal">Stroke</code> and <code class="literal">fill</code> determine how the shape is drawn. The <code class="literal">stroke</code> property<a id="id335" class="indexterm"/> is used for the outline of a shape; the<a id="id336" class="indexterm"/> <code class="literal">fill</code> property is used for the inside of a shape. In the following example, the first two lines fill a rectangle, whereas the last three lines stroke a rectangle:</p><div class="informalexample"><pre class="programlisting">Canvas.save(ctx)
Canvas.set_fill_style(ctx,{color: Color.red})
Canvas.fill_rect(ctx,10,10,100,50)
Canvas.set_stroke_style(ctx,{color: Color.black})
Canvas.set_line_width(ctx,5.0)
Canvas.stroke_rect(ctx,120,10,100,50)
Canvas.restore(ctx)</pre></div><p>Following is the result of the preceding code fragment:</p><div class="mediaobject"><img src="graphics/3749OS_10_03.jpg" alt="Using the fill and stroke properties"/></div><p>Note that we used <code class="literal">Canvas.save</code> and <code class="literal">Canvas.restore</code> in the preceding code. Each canvas context maintains a stack of drawing states such as <code class="literal">fillStyle</code> and <code class="literal">strokeStyel</code>. Since a canvas can only have one 2D context, <code class="literal">Canvas.save</code> and <code class="literal">Canvas.restore</code> are used to save and restore canvas states in short.</p></div><div class="section" title="Drawing a curve"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec54"/>Drawing a curve</h2></div></div></div><p>In our game, <a id="id337" class="indexterm"/>we create our Pacman by drawing an arc on the canvas. When the Pacman's mouth is open, we draw a pie, and when it's closed, we draw a circle.</p><p>We can draw the pie and the circle both with the <code class="literal">Canvas.arc</code> function<a id="id338" class="indexterm"/>. Arcs are defined by a center point, a radius, a starting angle, an ending angle, and the drawing direction (either clockwise or counterclockwise). The following diagram shows how we should draw the Pacman when he is facing left:</p><div class="mediaobject"><img src="graphics/3749OS_10_04.jpg" alt="Drawing a curve"/></div><p>First, we move to the center point and begin drawing from the starting angle <code class="literal">5*PI/4</code>. We then draw an arc to the ending angle <code class="literal">3*PI/4</code> moving clockwise. Finally, we fill and stroke the shape. Here is the code:</p><div class="informalexample"><pre class="programlisting">Canvas.set_stroke_style(ctx,{color:Color.black})
Canvas.set_fill_style(ctx,{color:Color.yellow})
Canvas.begin_path(ctx)
Canvas.move_to(ctx,100,100)
Canvas.arc(ctx,100,100,50,5.0*Math.PI/4.0,3.0*Math.PI/4.0,{false})
Canvas.close_path(ctx)
Canvas.fill(ctx)
Canvas.stroke(ctx)</pre></div></div></div>
<div class="section" title="Drawing an image"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec51"/>Drawing an image</h1></div></div></div><p>To display<a id="id339" class="indexterm"/> an image on HTML5 Canvas in Opa, we can use the <code class="literal">Canvas.draw_image</code> function<a id="id340" class="indexterm"/> that requires an image object and a<a id="id341" class="indexterm"/> destination point. Since the <code class="literal">draw_image</code> method<a id="id342" class="indexterm"/> requires an image object, we must first create an image and wait for it to load before we can draw it on the canvas. In our game, we will preload all images and sounds at the beginning of the game as you will see later. The <code class="literal">Canvas.draw_image</code> function is declared as follows:</p><div class="informalexample"><pre class="programlisting">void draw_image(Canvas.context ctx, Canvas.image img, int x, int y)</pre></div><p>The first argument that we pass to <code class="literal">draw_image</code> is the canvas context that we retrieved. The second argument is the image object of type <code class="literal">Canvas.image</code>. The <code class="literal">Canvas.image</code> type is declared as:</p><div class="informalexample"><pre class="programlisting">type Canvas.image = {Image.image   image} 
                 or {Canvas.canvas canvas} 
                 or {Video.video   video}</pre></div><p>
<code class="literal">Image.image</code> is an external type. It is identical to the image type that we created in JavaScript with the <code class="literal">new Image()</code> code.</p><p>We preload the images when the game starts. When needed, we will obtain an image object by <a id="id343" class="indexterm"/>calling the plugin function as follows:</p><div class="informalexample"><pre class="programlisting">function IMAGE(key){
    {image: %%Preloader.get%%(key)}
} </pre></div><p>In addition  to the draw_image function,  there are  two more functions that we can use to draw images on canvas: </p><div class="informalexample"><pre class="programlisting">Canvas.draw_image_with_dimensions(ctx, img, x, y, w, h)
Canvas.draw_image_full(ctx, img, sx, sy, sw, sh, dx, dy, dw, dh)</pre></div><p>To set the size of an image, we can use <code class="literal">draw_image_with_dimensions</code><a id="id344" class="indexterm"/>. This will scale the image to the target size. The <code class="literal">draw_image_full</code> function<a id="id345" class="indexterm"/> is even more powerful, as we can use it to crop the image.</p></div>
<div class="section" title="Drawing the text"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec52"/>Drawing the text</h1></div></div></div><p>To<a id="id346" class="indexterm"/> display texts on a canvas in Opa, we can <a id="id347" class="indexterm"/>use the <code class="literal">Canvas.fill_text</code> or <code class="literal">Canvas.stroke_text</code> method<a id="id348" class="indexterm"/>. We can change the fill style or stroke style by invoking <code class="literal">Canvas.set_fill_style</code> or <code class="literal">Canvas.set_stroke_style</code> respectively.</p><p>To set the font of the text, use the <code class="literal">Canvas.set_font</code> function<a id="id349" class="indexterm"/>. We should pass the font information to the method; the font information is a string matching the following pattern:</p><div class="informalexample"><pre class="programlisting">    [font-style] [font-weight] [font-size] [font-family]</pre></div><p>The following code draws the word "start" twice, one is filled and the other is stroked, both with font information <code class="literal">italic bold 40px verdana</code>:</p><div class="informalexample"><pre class="programlisting">Canvas.set_fill_style(ctx,{color:Color.red})
Canvas.set_font(ctx,"italic bold 40px verdana")
Canvas.fill_text(ctx,"Start",5,50)
Canvas.set_stroke_style(ctx,{color:Color.red})
Canvas.set_line_width(ctx,2.0)
Canvas.stroke_text(ctx,"Start",200,50)</pre></div><p>The<a id="id350" class="indexterm"/> result of the preceding code fragment is as follows:</p><div class="mediaobject"><img src="graphics/3749OS_10_05.jpg" alt="Drawing the text"/></div></div>
<div class="section" title="Binding the external JavaScript library"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec53"/>Binding the external JavaScript library</h1></div></div></div><p>In our Pacman game, <a id="id351" class="indexterm"/>we need to preload game resources such as images and sounds. We need to play sounds and music as well. Of course, <a id="id352" class="indexterm"/>we could write our own code to accomplish these tasks. However, why reinvent the wheel? There are numerous JavaScript libraries that make our job easier. The following section shows how to bind an existing JavaScript library into our game.</p><div class="section" title="Preloading the resources"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec55"/>Preloading the resources</h2></div></div></div><p>When a <a id="id353" class="indexterm"/>program requires multiple images and sounds, as is the case with our Pacman game, it's usually a good idea to load all of the resources before displaying or playing them. There are many excellent JavaScript libraries available. For our purposes, the Preload JS 0.3.0 (for resource) and SoundJS 0.4.0 (for sounds) libraries are a good fit. You can download Preload JS 0.3.0 from <a class="ulink" href="https://github.com/CreateJS/PreloadJS">https://github.com/CreateJS/PreloadJS</a> and the SoundJS 0.4.0 library is available at <a class="ulink" href="https://github.com/CreateJS/SoundJS">https://github.com/CreateJS/SoundJS</a>.</p><p>To bind the JavaScript library,<a id="id354" class="indexterm"/> we must register those functions that we plan to call from within our Opa code. We have discussed how to bind JavaScript in <a class="link" href="ch06.html" title="Chapter 6. Binding with Other Languages">Chapter 6</a>, <span class="emphasis"><em>Binding with Other Languages</em></span>. In our Pacman game, we register a <code class="literal">preload</code> function:</p><div class="informalexample"><pre class="programlisting">/** @register {( -&gt; void) -&gt; void} */
function preload(callback) {
    //use LoadQueue to preload resources, invoke callback when finish.
    queue = new createjs.LoadQueue();
    queue.installPlugin(createjs.Sound);
    queue.addEventListener("complete", callback);
    queue.loadManifest([ ... ])
}</pre></div><p>The <code class="literal">preload</code> function<a id="id355" class="indexterm"/> uses <code class="literal">PreloadJS</code> to preload resources, and will invoke a callback when it is finished. We can call the <code class="literal">preload</code> function in Opa in the following way:</p><div class="informalexample"><pre class="programlisting">%%Preloader.preload%%(function(){
    //start our game after resources have been loaded.
})</pre></div><p>The complete code can be found in <code class="literal">plugins/preloader.js</code> and <code class="literal">/src/game.opa</code>.</p></div><div class="section" title="Playing sounds"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec56"/>Playing sounds</h2></div></div></div><p>We bind the <code class="literal">SoundJS</code> library<a id="id356" class="indexterm"/>
<a id="id357" class="indexterm"/> and play sounds by registering a function in the <code class="literal">preloader.js</code> plugin file. The function invokes methods from SoundJS to build a sound instance and then play it. The <code class="literal">SoundJS</code> library is entirely out of the scope of this book. For more details regarding the use of this library visit the SoundJS homepage.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec54"/>Summary</h1></div></div></div><p>In this chapter, we built a game called <span class="strong"><strong>Pacman</strong></span>. First, we discussed how to declare an HTML5 Canvas element and how to get canvas context. Then, we reviewed how to draw shapes, images, and texts on a canvas. Finally, we showed how to write a plugin and embed external JavaScript libraries in the application.</p></div></body></html>