- en: '*Chapter 6:* Refactoring with PageObjects'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '*第 6 章：使用 PageObjects 重构*'
- en: The main learning goal here will be to get familiar with how to upgrade a set
    of end-to-end tests (test suite) with a TestCafe role and the `PageObject` pattern.
    We will use `Role` to speed up the tests and will utilize `PageObjects` to achieve
    reduced code duplication and enhanced maintainability. By the end of this chapter,
    we will have a structured and optimized set of tests and know how to apply roles
    and `PageObject` patterns to any future projects.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 这里的主要学习目标将是熟悉如何使用 TestCafe 角色和 `PageObject` 模式升级一组端到端测试（测试套件）。我们将使用 `Role` 来加速测试，并利用
    `PageObjects` 来减少代码重复并提高可维护性。到本章结束时，我们将拥有一组结构化和优化的测试，并了解如何将角色和 `PageObject` 模式应用于任何未来的项目。
- en: 'In this chapter, we''re going to cover the following main topics:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将涵盖以下主要主题：
- en: Adding a `Role` for logging in.
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 添加登录 `Role`。
- en: Refactoring tests with `PageObjects`.
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 `PageObjects` 重构测试。
- en: Improving `PageObjects` with functions.
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用函数改进 `PageObjects`。
- en: Technical requirements
  id: totrans-6
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 技术要求
- en: 'All the code examples for this chapter can be found on GitHub: [https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/tree/master/ch6](https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/tree/master/ch6).'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 本章的所有代码示例都可以在 GitHub 上找到：[https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/tree/master/ch6](https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/tree/master/ch6)。
- en: Adding a Role for logging in
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 添加登录 `Role`
- en: As we already learned from [*Chapter 2*](B16280_02_Final_JM_ePub.xhtml#_idTextAnchor027),
    *Exploring TestCafe under the Hood*, TestCafe has a built-in user role mechanism
    that emulates user actions for logging in to a website. The role mechanism saves
    the logged-in state of each user in a separate role that can then be reused in
    any part of your tests to switch between user accounts.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 如我们从 [*第 2 章*](B16280_02_Final_JM_ePub.xhtml#_idTextAnchor027) 中所学到的，*探索 TestCafe
    的内部机制*，TestCafe 具有内置的用户角色机制，该机制模拟用户动作以登录网站。角色机制将每个用户的登录状态保存在一个单独的角色中，然后可以在测试的任何部分重复使用该角色以在用户账户之间切换。
- en: 'So, let''s start by adding a `Role` to optimize and speed up the logging-in
    process that we perform in each test:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，让我们首先添加一个 `Role` 来优化和加速我们在每个测试中执行的登录过程：
- en: '[PRE0]'
  id: totrans-11
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'As you can see, we are using the login steps inside the `Role`. These steps
    will be executed when the `regularUser` role is called for the first time. Once
    the login steps are executed, the final (logged-in) state of the authentication
    cookie and browser storage will be saved and reused in each further call of the
    `regularUser` role (login steps will not be executed again, as a saved logged-in
    state will be applied). Now, let''s use the `regularUser` role in the `Log out`
    test:'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 如你所见，我们正在使用 `Role` 内部的登录步骤。这些步骤将在 `regularUser` 角色首次被调用时执行。一旦登录步骤执行完毕，认证cookie和浏览器存储的最终（登录）状态将被保存并用于
    `regularUser` 角色的后续调用（登录步骤将不再执行，因为已保存的登录状态将被应用）。现在，让我们在 `Log out` 测试中使用 `regularUser`
    角色吧：
- en: '[PRE1]'
  id: totrans-13
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Let''s also replace the login steps with the `regularUser` role in the `beforeEach`
    blocks of all other fixtures:'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们还在所有其他固定装置的 `beforeEach` 块中将登录步骤替换为 `regularUser` 角色吧：
- en: '[PRE2]'
  id: totrans-15
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Note
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: 'You can also review and download this file on GitHub: [https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests18.js](https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests18.js).'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 你也可以在 GitHub 上查看和下载此文件：[https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests18.js](https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests18.js)。
- en: Utilizing roles speeds up execution of the test and our test project becomes
    more structured and granular, which is a good approach to follow.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 利用角色可以加快测试的执行速度，并且我们的测试项目变得更加结构化和细化，这是一个很好的做法。
- en: As we have built our set of tests, improved them with setup, teardown, and roles,
    let's now make them even more effective and maintainable by refactoring with `PageObjects`.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们已经构建了一组测试，通过设置、拆解和角色进行了改进之后，现在让我们通过使用 `PageObjects` 进行重构，使它们更加有效和易于维护。
- en: Refactoring tests with PageObjects
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 PageObjects 重构测试
- en: '`PageObject` is a test automation pattern that gives you the option to create
    a separate file with selectors and functions that represent an abstraction of
    the tested page. This separate file can then be included and used in test code
    to refer to page elements.'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: '`PageObject` 是一种测试自动化模式，它允许你创建一个单独的文件，其中包含选择器和函数，这些选择器和函数代表了被测试页面的抽象。这个单独的文件可以随后被包含并用于测试代码中，以便引用页面元素。'
- en: Note that our tests contain excessive code. For example, the `#top-menu .projects`
    CSS selector (https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests18.js#L62)
    is used in 22 lines of code - basically each time the test clicks on the `PageObjects`
    allow you to keep all selectors in one place, so the next time the web page changes,
    you will only need to modify the `PageObject` file.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，我们的测试中包含过多的代码。例如，CSS选择器`#top-menu .projects`（https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests18.js#L62）在22行代码中使用
    - 也就是说，每次测试点击`PageObjects`时，你都可以将所有选择器放在一个地方，这样下次网页发生变化时，你只需修改`PageObject`文件即可。
- en: 'So, let''s create a simple `redmine-page.js` file inside our `tests` folder.
    Open any shell, go to the `test-project` folder, and execute the following command:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，让我们在`tests`文件夹内创建一个简单的`redmine-page.js`文件。打开任何shell，转到`test-project`文件夹，并执行以下命令：
- en: '[PRE3]'
  id: totrans-24
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Now, open the `redmine-page.js` file in a code editor of your choice, add the
    code to declare the `linkProjects` selector inside the `redminePage` object, and
    then export this object:'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，在您选择的代码编辑器中打开`redmine-page.js`文件，在`redminePage`对象内添加声明`linkProjects`选择器的代码，然后导出此对象：
- en: '[PRE4]'
  id: totrans-26
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Note
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: 'You can also review and download this file on GitHub: [https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/redmine-page1.js](https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/redmine-page1.js).'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 您也可以在GitHub上查看和下载此文件：[https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/redmine-page1.js](https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/redmine-page1.js)。
- en: 'So, we created a `redminePage` object with a `linkProjects` property containing
    a selector for this element. Now we need to include this object in our tests:'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，我们创建了一个包含`linkProjects`属性的对象，该属性包含此元素的选择器。现在我们需要将此对象包含在我们的测试中：
- en: '[PRE5]'
  id: totrans-30
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'In addition to that, we will need to replace all occurrences of `#top-menu
    .projects` with a corresponding `PageObject` element. So, here is how the updated
    `Create a new project` test will appear:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，我们还需要将所有`#top-menu .projects`的出现替换为相应的`PageObject`元素。因此，更新后的`创建新项目`测试将如下所示：
- en: '[PRE6]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Note
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: 'You can also review and download this file with all the tests updated to use
    `redminePage.linkProjects` on GitHub: [https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests19.js](https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests19.js).'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 您也可以在GitHub上查看和下载此文件，其中所有测试都已更新以使用`redminePage.linkProjects`：[https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests19.js](https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests19.js)。
- en: 'Let''s now move all constants with random digit generation to `redmine-page.js`,
    as all the strings that are using random digits will be moved to `redmine-page.js`
    too:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，将所有带有随机数字生成的常量移动到`redmine-page.js`中，因为所有使用随机数字的字符串也将移动到`redmine-page.js`中：
- en: '[PRE7]'
  id: totrans-36
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Now, let''s move all selectors to the `redminePage` object inside `redmine-page.js`.
    We will start from the login credentials:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们将所有选择器移动到`redmine-page.js`文件中的`redminePage`对象内。我们将从登录凭据开始：
- en: '[PRE8]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Now, let''s add selectors for the page elements:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们添加页面元素的选择器：
- en: '[PRE9]'
  id: totrans-40
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'And finally, let''s enhance the `redminePage` object with properties containing
    the text:'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，让我们增强`redminePage`对象，添加包含文本的属性：
- en: '[PRE10]'
  id: totrans-42
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Note
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: 'You can also review and download this file on GitHub: [https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/redmine-page2.js](https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/redmine-page2.js).'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 您也可以在GitHub上查看和下载此文件：[https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/redmine-page2.js](https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/redmine-page2.js)。
- en: As you can see, the URLs such as `http://demo.redmine.org/`, and the notification
    text strings such as `'Your account has been activated. You can now log in.'`
    can be easily refactored with `PageObjects` too.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 如您所见，URL如`http://demo.redmine.org/`和通知文本字符串如`'您的账户已激活。您现在可以登录。'`也可以通过`PageObjects`轻松重构。
- en: 'Now, let''s use `PageObject` elements in each of our tests. So, the updated
    `Redmine log in tests` fixture will look like this:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们在每个测试中使用`PageObject`元素。因此，更新的`Redmine 登录测试`固定装置将如下所示：
- en: '[PRE11]'
  id: totrans-47
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'The `Create a new user` test with `PageObject` elements will look like this:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 带有`PageObject`元素的`创建新用户`测试将如下所示：
- en: '[PRE12]'
  id: totrans-49
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'The `Log in` and `Log out` tests will look like this:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: '`登录`和`登出`测试将如下所示：'
- en: '[PRE13]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Here is what the updated `Redmine entities creation tests` fixture will look
    like:'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 更新后的`Redmine 实体创建测试`固定装置将看起来如下：
- en: '[PRE14]'
  id: totrans-53
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'The `Create a new project` and `Create a new issue` tests will look like this:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: '`创建新项目`和`创建新问题`测试将如下所示：'
- en: '[PRE15]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: Note
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: 'You can also review and download this file with all the tests updated to use
    `PageObjects` on GitHub: [https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests20.js](https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests20.js).'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 您还可以在GitHub上审查和下载所有测试更新为使用`PageObjects`的文件：[https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests20.js](https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests20.js)。
- en: In this section, we learned how to enhance tests with `PageObjects` and refactored
    our test project accordingly. Now, let's improve maintainability of the tests
    even further by adding functions to `PageObject`.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们学习了如何使用`PageObjects`增强测试，并相应地重构了我们的测试项目。现在，让我们通过向`PageObject`添加函数来进一步提高测试的可维护性。
- en: Improving PageObjects with functions
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 使用函数改进PageObjects
- en: 'As we can observe in `redmine-page.js`, some of the properties inside `PageObject`
    still contain some repetitive code. Let''s optimize our `PageObject` even more
    by moving such repetitive code into the separate functions:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 如我们在`redmine-page.js`中观察到的，`PageObject`内部的一些属性仍然包含一些重复的代码。让我们通过将此类重复代码移动到单独的函数中来进一步优化我们的`PageObject`：
- en: '[PRE16]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Note that the `buttonLogin` selector was updated. Previously, it was `[name="login"]`,
    but now, the `createButtonSelector` function will return it as `[value="Login
    »"]`. This was done to generalize our selector's generation, so now the `buttonLogin`
    selector is created with the same `createButtonSelector` function as all the other
    button elements.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，`buttonLogin`选择器已更新。之前它是`[name="login"]`，但现在`createButtonSelector`函数将返回它为`[value="Login
    »"]`。这样做是为了通用我们的选择器生成，因此现在`buttonLogin`选择器是用与所有其他按钮元素相同的`createButtonSelector`函数创建的。
- en: 'Let''s now generate a group of selectors for the test project links:'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们现在生成一组测试项目链接的选择器：
- en: '[PRE17]'
  id: totrans-64
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Now, let''s generate a group of texts for the test project name:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们生成一组测试项目名称的文本：
- en: '[PRE18]'
  id: totrans-66
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'Finally, let''s generate a group of object properties that will contain texts
    for the issue name (for example, `Test issue 1598717241841`) and issue description
    (for example, `Test issue description 1598717241841`):'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，让我们生成一组包含问题名称（例如，`Test issue 1598717241841`）和问题描述（例如，`Test issue description
    1598717241841`）文本的对象属性：
- en: '[PRE19]'
  id: totrans-68
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: Note
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: 'You can also review and download this file with `PageObject` functions: https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/redmine-page3.js,
    and the corresponding file with tests: https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests21.js.'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 您还可以使用`PageObject`函数审查和下载此文件：[https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/redmine-page3.js](https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/redmine-page3.js)，以及相应的测试文件：[https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests21.js](https://github.com/PacktPublishing/Modern-Web-Testing-with-TestCafe/blob/master/ch6/test-project/tests/basic-tests21.js)。
- en: So, now we have functions to create groups of similar selectors and texts. This
    technique is ultimately useful as a group of similar elements can be edited in
    one place by changing the corresponding function that creates them.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，现在我们有函数来创建类似选择器和文本的组。这种技术最终非常有用，因为可以通过更改创建它们的相应函数来在一个地方编辑一组类似元素。
- en: Summary
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 摘要
- en: In this chapter, we explored how to use `Role` when logging in to speed up test
    execution, refactored the tests with `PageObject`, and improved `PageObject` with
    functions. Now we have a fast set of tests that are easy to maintain and expand
    upon (should that be necessary in the future). This knowledge can be utilized
    to refactor the existing tests, or to build a new robust and easy-to-maintain
    set of automated tests.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们探讨了如何在登录时使用`Role`来加速测试执行，使用`PageObject`重构了测试，并通过函数改进了`PageObject`。现在我们有一组快速且易于维护和扩展的测试（如果将来有必要的话）。这些知识可以用来重构现有测试，或者构建一组新的健壮且易于维护的自动化测试集。
- en: In the next chapter, we will wrap up the test project and have a quick peek
    into the future of TestCafe.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将总结测试项目，并快速浏览TestCafe的未来。
