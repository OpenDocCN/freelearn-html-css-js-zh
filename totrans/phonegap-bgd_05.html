<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Using Device Storage and the Files API</h1></div></div></div><p>
<em>Your knowledge of PhoneGap is coming together well. It's time to add some interaction with external data sources and with the device itself. The main goal of this chapter is to guide you through the offline storage capabilities of PhoneGap and help you understand how to interact with the Files API.</em>
</p><p>In this chapter, you will:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Learn how to read and write data on the device using the <code class="literal">localStorage</code> object</li><li class="listitem" style="list-style-type: disc">Learn how to handle the storage on a local database considering the specific platform implementation</li><li class="listitem" style="list-style-type: disc">Understand database storage limitations and learn how to handle them</li><li class="listitem" style="list-style-type: disc">Learn about the Files API, how it works, and how to organize your code to keep it clear and maintainable</li><li class="listitem" style="list-style-type: disc">Use the Files API to explore the device filesystem</li><li class="listitem" style="list-style-type: disc">Learn how to read and render data inside a file</li><li class="listitem" style="list-style-type: disc">Learn how to load and save a file to a device's persistent storage</li></ul></div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec44"/>Application data storage</h1></div></div></div><p>Every application (desktop, web, or mobile) needs to store (and access) some data in order to work properly. How<a id="id279" class="indexterm"/> the data is stored depends on the kind of information the application will work with and on the environment in which the application will run. A web application, for instance, can rely mostly on server storage because it runs on the Internet. Most advanced web applications implement an offline strategy and store some data locally on the user machine.</p><p>Modern web development offers several tools in order to let users interact with an application even when they're not connected:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <a id="id280" class="indexterm"/><strong>LocalStorage</strong> API (<a class="ulink" href="http://www.w3.org/TR/webstorage/#the-localstorage-attribute">http://www.w3.org/TR/webstorage/#the-localstorage-attribute</a>)</li><li class="listitem" style="list-style-type: disc">The <a id="id281" class="indexterm"/><strong>SessionStorage</strong> API (<a class="ulink" href="http://www.w3.org/TR/webstorage/#the-sessionstorage-attribute">http://www.w3.org/TR/webstorage/#the-sessionstorage-attribute</a>)</li><li class="listitem" style="list-style-type: disc">The <a id="id282" class="indexterm"/><strong>ApplicationCache</strong> interface (<a class="ulink" href="http://www.w3.org/TR/2011/WD-html5-20110525/offline.html">http://www.w3.org/TR/2011/WD-html5-20110525/offline.html</a>)</li><li class="listitem" style="list-style-type: disc">The <a id="id283" class="indexterm"/><strong>IndexedDB</strong> API (<a class="ulink" href="http://www.w3.org/TR/IndexedDB/">http://www.w3.org/TR/IndexedDB/</a>)</li></ul></div><p>All the modern mobile browsers let developers handle the online and offline events through the<a id="id284" class="indexterm"/> navigator object (<a class="ulink" href="https://developer.mozilla.org/en/docs/Online_and_offline_events">https://developer.mozilla.org/en/docs/Online_and_offline_events</a>).</p><div><div><h3 class="title"><a id="note10"/>Note</h3><p>It's important to keep in mind that the specifications about the <code class="literal">OnLine</code> attribute report that this attribute is inherently unreliable because a computer can be connected to a network without having Internet access.</p></div></div><p>A complete overview of the previous API, events, and interface is beyond the scope of this book. In the following sections, I will discuss only those that are most relevant for building a PhoneGap app: LocalStorage and IndexedDB.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec41"/>Exploring the PhoneGap LocalStorage API</h2></div></div></div><p>There<a id="id285" class="indexterm"/> are two main web storage types: <strong>local storage</strong> <a id="id286" class="indexterm"/>and <a id="id287" class="indexterm"/>
<strong>session storage</strong>. The LocalStorage API is part of the <strong>WebStorage</strong> API <a id="id288" class="indexterm"/>defined by the W3C in order to provide a guideline for persistent data storage of key-value pair data in web clients. The LocalStorage API is designed to support data that needs to be available between sessions. In other words, the data your app saves when using the LocalStorage API will be available again the next time the app runs.</p><p>In order to access the LocalStorage API, you have to refer the <code class="literal">window</code> object to its <code class="literal">localStorage</code> property. If you type the following snippet in your browser console, you can take a look at the methods and properties of the <code class="literal">localStorage</code> object:</p><div><pre class="programlisting">console.log(window.localStorage);</pre></div><p>The following list summarizes the available methods and properties:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">key</code>: This<a id="id289" class="indexterm"/> returns the key name stored at a specific position; you can access the <code class="literal">localStorage</code> data either by key or by index</li><li class="listitem" style="list-style-type: disc"><code class="literal">getItem</code>: This<a id="id290" class="indexterm"/> returns the value identified by a key</li><li class="listitem" style="list-style-type: disc"><code class="literal">setItem</code>: This<a id="id291" class="indexterm"/> saves the value in a specific key (that is, a string) of the <code class="literal">localStorage</code> object; the method needs a string as a key and a value to store in the specific key</li><li class="listitem" style="list-style-type: disc"><code class="literal">removeItem</code>: This<a id="id292" class="indexterm"/> removes the item identified by a key from the <code class="literal">localStorage</code> object</li><li class="listitem" style="list-style-type: disc"><code class="literal">clear</code>: This<a id="id293" class="indexterm"/> removes all of the key-value pairs from the <code class="literal">localStorage</code> object</li><li class="listitem" style="list-style-type: disc"><code class="literal">length</code>: This<a id="id294" class="indexterm"/> returns the total number of items stored in the <code class="literal">localStorage</code> object</li></ul></div><p>The <a id="id295" class="indexterm"/>
<code class="literal">localStorage</code> object <a id="id296" class="indexterm"/>allows you to store only simple string data as key-value pairs. If you want to store more complex data, you have to use JSON or other string representations of the data you want to store. When you use a JSON formatted string to store the value, you will need to convert the string back to JSON when you want to use it. Each time the <code class="literal">localStorage</code> object is updated, <code class="literal">StorageEvent</code> is fired. This event cannot be cancelled and contains the following properties:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">key</code>: This is<a id="id297" class="indexterm"/> a string that represents the named key that was added, removed, or modified in the storage</li><li class="listitem" style="list-style-type: disc"><code class="literal">oldValue</code>: This<a id="id298" class="indexterm"/> is the previous value of the named key if it was updated or null if a new item was added to the <code class="literal">localStorage</code> object</li><li class="listitem" style="list-style-type: disc"><code class="literal">newValue</code>: This<a id="id299" class="indexterm"/> is the new value of the key or null if an item was removed</li><li class="listitem" style="list-style-type: disc"><code class="literal">url</code>: This<a id="id300" class="indexterm"/> is the address of the HTML page that called a method that triggered this data change</li></ul></div><div><div><h3 class="title"><a id="tip03"/>Tip</h3><p>A JavaScript event is cancelable if it is possible to prevent the event's default action.</p></div></div><p>Keep in mind that storage events don't work for the same window or tab; they are fired only for other windows or tabs that use the same <code class="literal">localStorage</code> object.</p><p>The <code class="literal">localStorage</code> capabilities of PhoneGap allow you as a developer to write code as in the browser; it's the framework that handles the different platforms (Android, BlackBerry WebWorks OS 6.0 and higher, iOS, Windows Phone 7 and 8, and Tizen) on your behalf.</p><p>There are some drawbacks <a id="id301" class="indexterm"/>when using the <code class="literal">localStorage</code> object. As the <code class="literal">localStorage</code> API is synchronous, the time required to access the <code class="literal">localStorage</code> object is greater than the time needed to access an object in memory. Due to this, the app might appear less responsive. Also, as already mentioned, complex data needs to be serialized and de-serialized. This process might further impact the responsiveness of the app. You can use JavaScript <strong>WebWorker</strong>
<a id="id302" class="indexterm"/> to avoid any performance degradation, but the support depends on the platform browser implementation and not on PhoneGap.</p><p>These <a id="id303" class="indexterm"/>drawbacks, however, should not prevent you from using the LocalStorage API because, as with most performance metrics, these performance hits really matter when you perform the same operation multiple times in a row. More specifically, the performance degradation due to the time needed to access the <code class="literal">localStorage</code> object happens when different tabs/windows access the same object.</p><p>When the mobile app built on top of PhoneGap is running, it's almost impossible that <code class="literal">localStorage</code> is accessed at the same time by other tabs/windows (you should have an issue only if your app starts to use several <code class="literal">InAppBrowser</code> instances in <code class="literal">UIWebView</code> of the app).</p><p>We will create a sample app now to get familiarized with using the <code class="literal">localStorage</code> object and all the methods supported by it.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec45"/>Time for action – reading and writing data on the LocalStorage</h1></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Open the <a id="id304" class="indexterm"/>command-line tool and create a new PhoneGap project using the PhoneGap CLI you installed before. This will create a new directory called <code class="literal">DeviceApi</code> in your current working directory; this can be done using the following command:<div><pre class="programlisting">
<strong>$ phonegap create DeviceApi</strong>
</pre></div></li><li class="listitem">Move to<a id="id305" class="indexterm"/> the directory you just created:<div><pre class="programlisting">
<strong>$ cd DeviceApi</strong>
</pre></div></li><li class="listitem">Add the platforms you want to test on the device API. For this example, we add the Android platform:<div><pre class="programlisting">
<strong>$ cordova platform add android</strong>
</pre></div></li><li class="listitem">Delete all the files and subdirectories except <code class="literal">index.html</code> inside the <code class="literal">www</code> directory. Open the <code class="literal">index.html</code> file you will find in the <code class="literal">www</code> root folder and add the following HTML code snippet:<div><pre class="programlisting">&lt;button type="button" onclick="addCountry()"&gt;Add Canada&lt;/button&gt; &lt;br/&gt;&lt;br/&gt;
&lt;button type="button" onclick="get1Data()"&gt;Get USA Data&lt;/button&gt; &lt;br/&gt;&lt;br/&gt;
&lt;button type="button" onclick="getAllData()"&gt;Get All Data&lt;/button&gt; &lt;br/&gt;&lt;br/&gt;
&lt;button type="button" onclick="removeAllData()"&gt;Remove All Countries&lt;/button&gt; &lt;br/&gt;&lt;br/&gt;</pre></div><p>This code will add four buttons, which will add new <code class="literal">localStorage</code> data, remove data, retrieve data, and clear all <code class="literal">localStorage</code> data. Note that each button has an <code class="literal">onclick</code> event referring to a function.</p></li><li class="listitem">Now let's <a id="id306" class="indexterm"/>add the required JavaScript to the page. First, we will bind the <code class="literal">onDeviceReady</code> function to the <code class="literal">deviceready</code> event. This function is going to add 3 <code class="literal">localStorage</code> data when the page loads. The <code class="literal">setItem</code> method of the <code class="literal">localStorage</code> object is used to add a new key-value pair. This is shown here:<div><pre class="programlisting">document.addEventListener("deviceready", onDeviceReady, false);

function onDeviceReady() {
          localStorage.setItem("IN", "India");
          localStorage.setItem("FR", "France");
          localStorage.setItem("USA", "U.S.A");
}</pre></div></li><li class="listitem">When<a id="id307" class="indexterm"/> the user clicks on the <strong>Add Canada</strong> button, we will need to add a new country to the <code class="literal">localStorage</code> object. We will use the <code class="literal">setItem</code> again to add the new item. Once done, we will display an alert. Note that you can't add the same key again to the storage, as shown here:<div><pre class="programlisting">function addCountry() {
   localStorage.setItem("CA", "Canada");
   alert("Canada added successfully");
}</pre></div></li><li class="listitem">Now, to get a particular object from the storage, we should use the <code class="literal">getItem</code> method. When there is a matching key, the value is returned. If not, null is returned. In this example, we will get the value for the <code class="literal">USA</code> key and display it in the alert:<div><pre class="programlisting">function get1Data() {
   var usa = localStorage.getItem("USA");
   alert("Country Name is " + usa);
}</pre></div></li><li class="listitem">To get all items from the storage, we should loop the <code class="literal">localStorage</code> object and get the keys one by one as shown in the following code:<div><pre class="programlisting">function getAllData() {

   for(var i in localStorage){
      alert(localStorage.getItem(i));
   }

}</pre></div></li><li class="listitem">The <code class="literal">clear</code> method is used to clear out all the values from <code class="literal">localStorage</code> of the app:<div><pre class="programlisting">function removeAllData() {
   window.localStorage.clear();
   alert("All Countries removed successfully");
}</pre></div></li></ol></div><p>As shown<a id="id308" class="indexterm"/> in the <code class="literal">removeAllData</code> function, we can use <code class="literal">window.localStorage</code> instead of <code class="literal">localStorage</code> to work with the <code class="literal">localStorage</code> object.</p><p>The complete<a id="id309" class="indexterm"/> code for this example is provided for your reference as follows:</p><div><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;!--Other section removed for sake of simplicity --&gt;
        &lt;title&gt;Hello World&lt;/title&gt;
    &lt;/head&gt;
&lt;body&gt;
&lt;button type="button" onclick="addCountry()"&gt;Add Canada&lt;/button&gt; &lt;br/&gt;&lt;br/&gt;
&lt;button type="button" onclick="get1Data()"&gt;Get USA Data&lt;/button&gt; &lt;br/&gt;&lt;br/&gt;
&lt;button type="button" onclick="getAllData()"&gt;Get All Data&lt;/button&gt; &lt;br/&gt;&lt;br/&gt;
&lt;button type="button" onclick="removeAllData()"&gt;Remove All Countries&lt;/button&gt; &lt;br/&gt;&lt;br/&gt;

&lt;script type="text/javascript" src="img/cordova.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript"&gt;
document.addEventListener("deviceready", onDeviceReady, false);

function onDeviceReady() {
     localStorage.setItem("IN", "India");
     localStorage.setItem("FR", "France");
     localStorage.setItem("USA", "U.S.A");
}

function addCountry() {
     localStorage.setItem("CA", "Canada");
     alert("Canada added successfully");
}

function get1Data() {
      var usa = localStorage.getItem("USA");
      alert("Country Name is " + usa);
}

function getAllData() {
   for(var i in localStorage){
      alert(localStorage.getItem(i));
   }
}

function removeAllData() {
      window.localStorage.clear();
      alert("All Countries removed successfully");
}

&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec42"/>
<em>What just happened?</em>
</h2></div></div></div><a id="id310" class="indexterm"/><p>You saved persistent data on the device using JavaScript that can also run in all major desktop browsers. Keep in mind that each platform stores this data in a different location and that this data may be cleared by the device. Depending on the platform, this data can be deleted when the app is closed or when the device is rebooted. For this reason, it's strongly encouraged not to use the <code class="literal">localStorage</code> object to store crucial information.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec43"/>Exploring the PhoneGap SQL storage</h2></div></div></div><p>The client-side storage<a id="id311" class="indexterm"/> implementation in different browsers on mobiles is pretty inconsistent right now. It's important to make an analysis of each browser implementation when working on a PhoneGap project because the app is rendered through WebView; on iOS, this is the Objective-C <code class="literal">UIWebView</code> class; on Android, it is <code class="literal">android.webkit.WebView</code>, and it differs on all other supported platforms. The web view simply exposes the underlying platform browser. For this reason, it's important to know which client-side storage option is supported by the mobile browsers of your target platform.</p><p>The following table summarizes the storage support for the mobile versions of the major browsers at the time of writing; the X sign indicates whether the feature is supported.</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom"> </th><th style="text-align: left" valign="bottom">
<p>Android browser</p>
</th><th style="text-align: left" valign="bottom">
<p>Firefox OS</p>
</th><th style="text-align: left" valign="bottom">
<p>iOS Safari</p>
</th><th style="text-align: left" valign="bottom">
<p>IE 11 Mobile</p>
</th><th style="text-align: left" valign="bottom">
<p>Chrome for Android</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>IndexedDB</p>
</td><td style="text-align: left" valign="top">
<p>X</p>
</td><td style="text-align: left" valign="top">
<p>X</p>
</td><td style="text-align: left" valign="top">
<p>X</p>
</td><td style="text-align: left" valign="top">
<p>X</p>
</td><td style="text-align: left" valign="top">
<p>X</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Web SQL </p>
</td><td style="text-align: left" valign="top">
<p>X</p>
</td><td style="text-align: left" valign="top">
<p>---</p>
</td><td style="text-align: left" valign="top">
<p>X</p>
</td><td style="text-align: left" valign="top">
<p>---</p>
</td><td style="text-align: left" valign="top">
<p>X</p>
</td></tr></tbody></table></div><p>IndexedDB is a simple flat-file database with hierarchical key-value persistence and basic indexing. <strong>Web SQL</strong> <a id="id312" class="indexterm"/>is basically <a id="id313" class="indexterm"/>
<strong>SQLite</strong> embedded in the browser. SQLite is a relational database <a id="id314" class="indexterm"/>contained in a small (approximately 350 KB) library written in C that is used by software such as <a id="id315" class="indexterm"/>
<strong>Skype</strong> or <a id="id316" class="indexterm"/>
<strong>Photoshop Lightroom</strong>. The main difference between these storage options is that IndexedDB is a NoSQL database that lets you work with your JavaScript objects and indexes based on your application needs, while Web SQL is a real, relational client-side database implementation. One of the advantages of using Web SQL is that you can share the same queries between the backend and frontend. When running some tests, you can see how much faster Web SQL can be.</p><div><div><h3 class="title"><a id="note11"/>Note</h3><p>In order to run the same test<a id="id317" class="indexterm"/> on your machine, you can clone the GitHub repository at <a class="ulink" href="https://github.com/scaljeri/indexeddb-vs-websql">https://github.com/scaljeri/indexeddb-vs-websql</a> and open the file <code class="literal">test.html</code> in your web browser.</p></div></div><p>The W3C dropped support for Web SQL on November 18, 2010, making IndexedDB the <em>de facto</em> standard. From a developer's point of view, IndexedDB <a id="id318" class="indexterm"/>may look like a huge step backward but it really isn't. For years, developers have stored data on the client side using key-value pairs, and most of the time they use JSON to query the objects <a id="id319" class="indexterm"/>using <strong>Unstructured Query Language</strong> (<strong>UQL</strong>) or NoSQL. For these reasons, IndexedDB should be seen as the natural evolution of client-side storage.</p><p>PhoneGap provides storage API based on the deprecated Web SQL database specification. When Web SQL is supported by the device, the app will use it. If not, the app will use the PhoneGap one. There will be no difference for the developer as we will not have to change any line of code.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec44"/>Working with database storage in PhoneGap</h2></div></div></div><p>To work <a id="id320" class="indexterm"/>with a <code class="literal">Database</code> object in PhoneGap, it's enough to use the <code class="literal">openDatabase</code> method shown as follows:</p><div><pre class="programlisting">var size = (1024 * 1024 * 2);
var db = window.<strong>openDatabase</strong>("name", "1.0", "Test DB", size);</pre></div><p>The <code class="literal">openDatabase</code> method<a id="id321" class="indexterm"/> accepts the following four (self-explanatory) arguments:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The database <strong>name</strong></li><li class="listitem" style="list-style-type: disc">The database <strong>version</strong></li><li class="listitem" style="list-style-type: disc">The <strong>display name</strong> of the database</li><li class="listitem" style="list-style-type: disc">Estimated <strong>size</strong> of the database</li></ul></div><p>Keep in mind that an application can query the version number of the database in order to understand whether an upgrade to the database schema is required. The <code class="literal">openDatabase</code> method returns a reference to the currently open database.</p><p>In the previous snippet, I allocated 2 MB of space in bytes. When allocating space, consider that mobile devices may have limitations on the size of the database they can support. For example, iOS only allows up to 5 MB for web-based applications; the same is true when using PhoneGap as a wrapper.</p><p>The returned database object between the others exposes two methods that take from one to three arguments: <code class="literal">transaction()</code>and <code class="literal">readTransaction()</code>. The main difference is that the <code class="literal">readTransaction()</code> method has to be used in read-only mode. The arguments that can be passed to these methods are:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A function to execute one or more SQL statements</li><li class="listitem" style="list-style-type: disc">A function to handle an exception raised by the app when opening the database</li><li class="listitem" style="list-style-type: disc">A function to handle the successful opening of the database</li></ul></div><p>Note that the <code class="literal">transaction()</code> and <code class="literal">readTransaction()</code> asynchronous methods are the only methods in the PhoneGap framework that want the failure handler function before the success one. Also, the success handler is the only one that doesn't receive any argument; the other handlers receive a <code class="literal">SQLTransaction</code> object.</p><p>The <code class="literal">SQLTransaction</code> object exposes the <code class="literal">executeSql</code> method. Using this method, it's possible to run several SQL statements and pass some parameters to the statements to handle successful SQL query execution and SQL errors.</p><div><div><h3 class="title"><a id="note12"/>Note</h3><p>You can use several tokens in order to pass parameters to a SQL statement. For a complete overview of the available tokens, refer to the online documentation at <a class="ulink" href="http://www.sqlite.org/lang_expr.html">http://www.sqlite.org/lang_expr.html</a>.</p></div></div><p>The success <a id="id322" class="indexterm"/>handler receives two arguments: the first one is a reference to the transaction itself and the second one is a <code class="literal">SQLResultSet</code> object that contains the information, and optionally the results, of the executed query.</p><div><div><h3 class="title"><a id="tip04"/>Tip</h3><p>The <code class="literal">insertId</code> property of the <code class="literal">SQLResultSet</code> object returns an <code class="literal">Exception: DOMException</code> value when performing a <code class="literal">SELECT</code> statement. You can safely ignore it because it doesn't affect the app.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec46"/>Time for action – populating a local database</h1></div></div></div><p>In order to reinforce<a id="id323" class="indexterm"/> what you just learned, you will create a new local database, add a table to it, and write and read some data.</p><div><ol class="orderedlist arabic"><li class="listitem">Return to the project you created for the previous example or create a new project. Clean out the content of the <code class="literal">index.html</code> file, and add the following button markup to it. This button will be used to query the data back from the database:<div><pre class="programlisting">&lt;button type="button" onclick="queryEmployees()"&gt;Fetch All Rows&lt;/button&gt;</pre></div></li><li class="listitem">Create a JavaScript tag and the <code class="literal">deviceready</code> event listener:<div><pre class="programlisting">document.addEventListener("deviceready", onDeviceReady, false);</pre></div></li><li class="listitem">In the body of the <code class="literal">onDeviceReady</code> function, we will create a new database called <code class="literal">EMP</code> with version number of <code class="literal">1.0</code>, named <code class="literal">Employee Details,</code> with an estimated size of 2 MB:<div><pre class="programlisting">var size = (1024 * 1024 * 2);

function onDeviceReady() {
   var database = window.openDatabase('employee', '1.0', 'Employee Details', size);
   database.transaction(populateDB, onError, onSuccess);
}</pre></div><p>Once the database is created using the <code class="literal">openDatabase</code> method, we populate the database. We have to create a transaction for every operation we need to perform <a id="id324" class="indexterm"/>and so we provide the <code class="literal">populateDB</code> method as an argument for the transaction:</p><div><pre class="programlisting">function populateDB(tx) {
   tx.executeSql('DROP TABLE IF EXISTS EMP');
   tx.executeSql('CREATE TABLE IF NOT EXISTS EMP (id unique, name)');
   tx.executeSql('INSERT INTO EMP (id, name) VALUES (1, "John Doe")');
   tx.executeSql('INSERT INTO EMP (id, name) VALUES (2, "Jane Doe")');
}

function onError(err) {
   alert("SQL Error: " + err.code);
}

function onSuccess() {
   alert("Success!");
}</pre></div><p>The <code class="literal">executeSql</code> method can take any standard SQL statement and execute it.</p></li><li class="listitem">We will now create the <code class="literal">queryEmployees</code> function, which is bound to the button <code class="literal">onclick</code> event. This function is going to open the database and create a transaction to query the database:<div><pre class="programlisting">function queryEmployees() {
   var database = window.openDatabase('employee', '1.0', 'Employee Details', size);
   database.transaction(queryData, onError);
}</pre></div></li><li class="listitem">The <code class="literal">queryData</code> function provided as an argument to the transaction executes the SQL query. This takes the transaction argument <code class="literal">tx</code> and the result set is passed to the <code class="literal">onSelectSuccess</code> function:<div><pre class="programlisting">function queryData(tx) {
   tx.executeSql('SELECT * FROM EMP', [], onSelectSuccess, onError);
}</pre></div></li><li class="listitem">The <code class="literal">onSelectSuccess</code> function has the transaction and result set as an argument and does the actual parsing job:<div><pre class="programlisting">function onSelectSuccess(tx, results) {

   var len = results.rows.length;
   alert("Total Employees : " + len);

   for (var i=0; i&lt;len; i++){
      alert(results.rows.item(i).id + " - "
            + results.rows.item(i).name);
   }
}</pre></div></li></ol></div><p>The complete <a id="id325" class="indexterm"/>code of this example is provided for your quick reference. You can also verify the database records in your browser developer tools:</p><div><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;!--Other section removed for sake of simplicity --&gt;
        &lt;title&gt;Database Example&lt;/title&gt;
    &lt;/head&gt;
&lt;body&gt;
   &lt;button type="button" onclick="queryEmployees()"&gt;Fetch All Rows&lt;/button&gt;
   &lt;script type="text/javascript" src="img/cordova.js"&gt;&lt;/script&gt;

   &lt;script type="text/javascript"&gt;
      var size = (1024 * 1024 * 2);

      document.addEventListener("deviceready", onDeviceReady, false);

      function onDeviceReady() {
        var database = window.openDatabase('employee', '1.0', 'Employee Details', size);
        database.transaction(populateDB, onError, onSuccess);
      }

      function populateDB(tx) {
        tx.executeSql('DROP TABLE IF EXISTS EMP');
        tx.executeSql('CREATE TABLE IF NOT EXISTS EMP (id unique, name)');
        tx.executeSql('INSERT INTO EMP (id, name) VALUES (1, "John Doe")');
        tx.executeSql('INSERT INTO EMP (id, name) VALUES (2, "Jane Doe")');
      }

      function onError(err) {
        alert("SQL Error: " + err.code);
      }

      function onSuccess() {
        alert("Success!");
      }

      function queryEmployees() {
        var database = window.openDatabase('employee', '1.0', 'Employee Details', size);
        database.transaction(queryData, onError);
      }

      function queryData(tx) {
        tx.executeSql('SELECT * FROM EMP', [], onSelectSuccess, onError);
      }

      function onSelectSuccess(tx, results) {

        var len = results.rows.length;
        alert("Total Employees : " + len);

        for (var i=0; i&lt;len; i++){
          alert(results.rows.item(i).id + " - " + results.rows.item(i).name);
        }
      }
   &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec45"/>
<em>What just happened?</em>
</h2></div></div></div><p>You created <a id="id326" class="indexterm"/>a local database in order to store and recover information relevant for your app and its users. The database will be automatically removed when the app is uninstalled.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec47"/>Database limitations</h1></div></div></div><p>There are <a id="id327" class="indexterm"/>some limitations to be aware of when using the WebSQL implementation of PhoneGap (refer to the SQLite documentation for a complete overview <a id="id328" class="indexterm"/>at <a class="ulink" href="http://www.sqlite.org/limits.html">http://www.sqlite.org/limits.html</a>). These limitations are not related to the framework itself but are due to the web view implementation of each target platform.</p><p>The limit you can easily hit when working on an app is the size limit of the database file. For example, on WebKit, it varies depending on the operating system from 5 MB to 25 MB. Another limitation you can find is that, since iOS 5.1, both <code class="literal">localStorage</code> and Web SQL databases have been moved to the <code class="literal">~/Library/Caches</code> folder from the <code class="literal">~/Library/WebKit</code> folder. Actually, this change means that the information stored is not backed up anymore and can be arbitrarily deleted by the operating system when more space is <a id="id329" class="indexterm"/>needed (for more information about <a id="id330" class="indexterm"/>iOS data management, refer to the Apple Developer guide at <a class="ulink" href="https://developer.apple.com/technologies/ios/data-management.html">https://developer.apple.com/technologies/ios/data-management.html</a>).</p><p>In order to avoid the issues described, you can use the Sqlite plugin available on GitHub for Android and iOS (<a class="ulink" href="https://github.com/litehelpers/Cordova-sqlite-storage">https://github.com/litehelpers/Cordova-sqlite-storage</a>).</p><div><div><h3 class="title"><a id="note13"/>Note</h3><p>You will learn more about PhoneGap plugins throughout this book; for now, it suffices to know that a plugin is typically a combination of HML/CSS/JavaScript and native code used in order to extend the PhoneGap capabilities.</p></div></div><p>The main advantages you get when using this plugin are that you can keep the SQLite database in a user data location that is known and can be reconfigured, there are no more size limits, and the database can be encrypted using <a id="id331" class="indexterm"/>
<strong>SQLcipher</strong> (for a complete reference, refer to the online documentation at <a class="ulink" href="http://sqlcipher.net/documentation/">http://sqlcipher.net/documentation/</a>).</p><p>From a developer's point of view, there is no change in the API except the prefix; it means that instead of opening a database accessing the <code class="literal">window</code> object like this:</p><div><pre class="programlisting">window.openDatabase();</pre></div><p>You have to refer to the plugin like this:</p><div><pre class="programlisting">
<strong>sqlitePlugin</strong>.openDatabase();</pre></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec48"/>Understanding the Files API</h1></div></div></div><p>The PhoneGap Files API<a id="id332" class="indexterm"/> is an implementation of two different W3C APIs, the<a id="id333" class="indexterm"/> Directories and System API and the File API (you can find the complete specifications on the W3C website at <a class="ulink" href="http://www.w3.org/TR/file-system-api/">http://www.w3.org/TR/file-system-api/</a> and <a class="ulink" href="http://www.w3.org/TR/file-upload">http://www.w3.org/TR/file-upload</a>.) The PhoneGap Files API is not a complete implementation of the W3C specification; the missing piece is the synchronous filesystem interface implementation. Asynchronous JavaScript APIs are a bit more complex to use because you have to work with multiple nested functions but this should not be a big issue; in fact, it's something web developers are all too familiar with.</p><div><div><h3 class="title"><a id="note14"/>Note</h3><p>The main difference between asynchronous and synchronous JavaScript execution is that in the first case, you can run several processes simultaneously and avoid "freezing" the user interface. With the introduction of web workers in JavaScript, it's possible to avoid this issue but this is totally beyond the scope for this book; you can find more <a id="id334" class="indexterm"/>information about web workers on the Mozilla website at <a class="ulink" href="https://developer.mozilla.org/en-US/docs/DOM/Using_web_workers">https://developer.mozilla.org/en-US/docs/DOM/Using_web_workers</a>.</p></div></div><p>In order to <a id="id335" class="indexterm"/>access the device filesystem, you can use the <code class="literal">requestFileSystem</code> method of the <code class="literal">LocalFileSystem</code> object; all the methods of this object are defined in the <code class="literal">window</code> object. The method accepts the following four arguments:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The type of storage (temporary or persistent)</li><li class="listitem" style="list-style-type: disc">The amount of space in bytes to be allocated on the device storage</li><li class="listitem" style="list-style-type: disc">The success handler</li><li class="listitem" style="list-style-type: disc">The error handler</li></ul></div><p>When you want to access the device filesystem, the resulting code looks as shown the following snippet:</p><div><pre class="programlisting">window.requestFileSystem(/*storage*/, /*size*/, onSuccess, onError);</pre></div><p>For the <code class="literal">storage</code> argument, you need to specify one of the following two pseudo constants defined in the <code class="literal">LocalFileSystem</code> object:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">LocalFileSystem.PERSISTENT</code>: This <a id="id336" class="indexterm"/>indicates that the storage cannot be removed by the user agent without the app's or user's permission.</li><li class="listitem" style="list-style-type: disc"><code class="literal">LocalFileSystem.TEMPORARY</code>: This<a id="id337" class="indexterm"/> indicates that the files stored in the requested space can be deleted by the user agent or by the system without the app's or user's permission</li></ul></div><p>The size of the requested sandbox storage is expressed in bytes; for example, in order to make the code more readable, you can use the syntax (4 x 1024 x 1024) to allocate 4 KB instead of the bytes number 4,194,304.</p><div><div><h3 class="title"><a id="note15"/>Note</h3><p>The device hard disk is not completely open to the app's view. A limited portion of the hard disk is dedicated to a single app alone; this is the <a id="id338" class="indexterm"/>app <strong>sandbox</strong>. The idea behind the app sandbox is that each app can only access its own sandbox and some higher-level directories owned by the operating system. The structure of the high-level directories varies depending on the operating system.</p></div></div><p>The <code class="literal">onSuccess</code> handler <a id="id339" class="indexterm"/>receives a <code class="literal">FileSystem</code> object as an argument. The two properties defined for this object are <code class="literal">name</code> and <code class="literal">root</code>. Accessing the <code class="literal">name</code> property of the object makes it possible to read the name of the filesystem; accessing the <code class="literal">root</code> property allows you to get a reference to the <code class="literal">root</code> directory of the app sandbox. This is shown here:</p><div><pre class="programlisting">function onSuccess(fileSystem){

    console.log(fileSystem.name);
    var currentRoot = fileSystem.root;

}</pre></div><p>The <code class="literal">onError</code> handler receives a <code class="literal">FileError</code> object as an argument; this object represents different errors using several pseudo constants defined in the object itself, as shown here:</p><div><pre class="programlisting">function onError(fileError){

    console.log(fileError.code);

}</pre></div><p>If the location of the file or directory is known, you can use the <code class="literal">resolveLocalFileSystemURI</code> method of the <code class="literal">LocalFileSystem</code> object to access it. This method accepts the following three arguments:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The URI of the file or directory</li><li class="listitem" style="list-style-type: disc">The success handler (<code class="literal">onSuccess</code>)</li><li class="listitem" style="list-style-type: disc">The error handler (<code class="literal">onError</code>)</li></ul></div><p>If you want to access, for instance, the external storage of an Android device, you can use the following syntax:</p><div><pre class="programlisting">window.resolveLocalFileSystemURI('file:///mnt/sdcard', onSuccess, onError);.</pre></div><p>The <code class="literal">onSuccess</code> function receives as argument a <code class="literal">DirectoryEntry</code> or <code class="literal">FileEntry</code> object depending on the kind of path entered (that is, a directory or file); the <code class="literal">onError</code> handler receives a <code class="literal">FileError</code> object as argument.</p><p>The values<a id="id340" class="indexterm"/> of the <code class="literal">code</code> property are summarized by the following pseudo constants:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">FileError.NOT_FOUND_ERR</code> (returned value <code class="literal">1</code>): This means the file or directory required by the app cannot be found</li><li class="listitem" style="list-style-type: disc"><code class="literal">FileError.SECURITY_ERR</code> (returned value <code class="literal">2</code>): This means the file or directory is outside the app sandbox or the app does not have the rights to access it</li><li class="listitem" style="list-style-type: disc"><code class="literal">FileError.ABORT_ERR</code> (returned value <code class="literal">3</code>): This is thrown when the <code class="literal">abort</code> method of the reader or writer is called</li><li class="listitem" style="list-style-type: disc"><code class="literal">FileError.NOT_READABLE_ERR</code> (returned value <code class="literal">4</code>): This means that the file or directory required by the app cannot be read</li><li class="listitem" style="list-style-type: disc"><code class="literal">FileError.ENCODING_ERR</code> (returned value <code class="literal">5</code>): This means a path or local URI used as an argument in the <code class="literal">resolveLocalFileSystemURI</code> method of the <code class="literal">LocalFileSystem</code> object is malformed</li><li class="listitem" style="list-style-type: disc"><code class="literal">FileError.NO_MODIFICATION_ALLOWED_ERR</code> (returned value <code class="literal">6</code>): This means the app attempted to write to a file or directory that cannot be modified due to the actual state of the filesystem</li><li class="listitem" style="list-style-type: disc"><code class="literal">FileError.INVALID_STATE_ERR</code> (returned value <code class="literal">7</code>): This means the app accesses<a id="id341" class="indexterm"/> a file that is used by another process</li><li class="listitem" style="list-style-type: disc"><code class="literal">FileError.SYNTAX_ERR</code> (returned value <code class="literal">8</code>): This is self-explanatory; this occurs due to the syntax error</li><li class="listitem" style="list-style-type: disc"><code class="literal">FileError.INVALID_MODIFICATION_ERR</code> (returned value <code class="literal">9</code>): This means the modification requested by the app is invalid; an example of such an error is moving a directory into its own child</li><li class="listitem" style="list-style-type: disc"><code class="literal">FileError.QUOTA_EXCEEDED_ERR</code> (returned value <code class="literal">10</code>): This means the app requested a storage amount greater than the allowed storage quota</li><li class="listitem" style="list-style-type: disc"><code class="literal">FileError.TYPE_MISMATCH_ERR</code> (returned value <code class="literal">11</code>): This means the app attempted to access a file or directory but the entry is not of the expected type (that is, a directory is returned instead of a file)</li><li class="listitem" style="list-style-type: disc"><code class="literal">FileError.PATH_EXISTS_ERR</code> (returned value <code class="literal">12</code>): This means the app failed to create a file or directory due to the existence of a file or directory with the same path</li></ul></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec46"/>Reading directories and files</h2></div></div></div><p>Only<a id="id342" class="indexterm"/> after getting access to the filesystem is it possible to read the device directories, subdirectories, and content. Again, the <code class="literal">onSuccess</code> handler<a id="id343" class="indexterm"/> used as an argument in the <code class="literal">requestFileSystem</code> method receives a <code class="literal">FileSystem</code> object. Through the <code class="literal">root</code> property of this object, it's possible to access a <code class="literal">DirectoryEntry</code> object and then create a <code class="literal">DirectoryReader</code> object able to read all the entries available in the current directory. This is shown here:</p><div><pre class="programlisting">function onSuccess(fileSystem){

   var currentRoot = fileSystem.root;
   var reader = currentRoot.createReader();

}</pre></div><p>The <code class="literal">DirectoryReader</code> object <a id="id344" class="indexterm"/>exposes one method named <code class="literal">readEntries</code>. It can be used in order to read the entries and, due to the asynchronous <a id="id345" class="indexterm"/>nature of the File API, it accepts a success and a failure handler. Similar to what's happening for the <code class="literal">resolveLocalFileSystemURI</code> method, the success handler receives an array of <code class="literal">DirectoryEntry</code> or <code class="literal">FileEntry</code> objects according to the kind of item that is listed (that is, a directory or a file).</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec49"/>Time for action – listing folders</h1></div></div></div><p>Get ready <a id="id346" class="indexterm"/>to explore the folders of the device's persistent storage. Use the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the command-line tool and create a new project using the Cordova CLI tool you installed before. This will create a new directory called <code class="literal">FileSystem</code> in your current working directory:<div><pre class="programlisting">
<strong>$ cordova create FileSystem</strong>
</pre></div></li><li class="listitem">Move to the directory you just created:<div><pre class="programlisting">
<strong>$ cd FileSystem</strong>
</pre></div></li><li class="listitem">Add the platforms you want to test on the device API. For this example, we add the Android platform:<div><pre class="programlisting">
<strong>$ cordova platform add android</strong>
</pre></div></li><li class="listitem">Add the File API plugin using the following command:<div><pre class="programlisting">
<strong>$ cordova plugin add cordova-plugin-file</strong>
</pre></div></li><li class="listitem">Go to the <code class="literal">www</code> folder, open the <code class="literal">index.html</code> file, and add a <code class="literal">div</code> element with the <code class="literal">id</code> value as <code class="literal">fileslist</code> inside the body of the app:<div><pre class="programlisting">&lt;div id="fileslist"&gt;&lt;/div&gt;</pre></div></li><li class="listitem">We will now add a <code class="literal">deviceready</code> event listener in the JavaScript section. The <code class="literal">onDeviceReady</code> function has to be called once the <code class="literal">deviceready</code> event is fired:<div><pre class="programlisting">document.addEventListener("deviceready", onDeviceReady, false);</pre></div></li><li class="listitem">In the body of the <code class="literal">onDeviceReady</code> function, request access to the device filesystem specifying the success and failure handlers you will define next and request a persistent storage of 0 KB; you need to specify a quota only when writing to the device filesystem:<div><pre class="programlisting">function onDeviceReady() {
   var size = 0;
   window.requestFileSystem(LocalFileSystem.PERSISTENT, size, onFileSystemSuccess, onFileSysError);
}</pre></div></li><li class="listitem">Define <a id="id347" class="indexterm"/>the error handler that will notify you when the code throws an error:<div><pre class="programlisting">function onFileSysError(error){
   alert("Error Code: " + error.code);
}</pre></div></li><li class="listitem">Define the success handler and inside its body, create a new <code class="literal">DirectoryReader</code> object and use this object to read all the directory contents. We need to pass a new function <code class="literal">parseDirectories</code>, which will actually iterate through the list of directories. The directory entries will be passed automatically as an argument to this function:<div><pre class="programlisting">function onFileSystemSuccess(fileSystem){
   var reader = fileSystem.root.createReader();
   reader.readEntries(parseDirectories,onFileSysError);
}</pre></div></li><li class="listitem">Define the <code class="literal">parseDirectories</code> function and add the following snippet to it:<div><pre class="programlisting">function parseDirectories(entries){
    var str = '&lt;ul&gt;';

    for (var i = 0, len = entries.length; i &lt; len; i++) {
        if (entries[i].isDirectory) {
             str += '&lt;li&gt;' + entries[i].fullPath + '&lt;/li&gt;';
        }
    }

    str += "&lt;/ul&gt;";

    document.getElementById("fileslist").innerHTML+= str;

}</pre></div><p>We read the entries and for each entry in the list, we check whether it's a directory or a file. If it's a directory, we append the directory name to the unordered list and ignore it if it's a file. At the end, we add the generated unordered list (<code class="literal">ul</code>) to the <code class="literal">div</code> named <code class="literal">fileslist</code> we previously created.</p><p>When this code runs in an actual device, it will list all the directories in the persistent storage.</p></li></ol></div><p>The entire source code of this example is provided as follows:</p><div><pre class="programlisting">&lt;!DOCTYPE html&gt;

&lt;html&gt;
    &lt;head&gt;
        &lt;!--Other section removed for sake of simplicity --&gt;
        &lt;title&gt;File Example&lt;/title&gt;
    &lt;/head&gt;

&lt;body&gt;

&lt;div id="fileslist"&gt;&lt;/div&gt;

&lt;script type="text/javascript" src="img/cordova.js"&gt;&lt;/script&gt;

&lt;script type="text/javascript"&gt;

document.addEventListener("deviceready", onDeviceReady, false);

function onDeviceReady() {
   var size = 0;
   window.requestFileSystem(LocalFileSystem.PERSISTENT, size, onFileSystemSuccess, onFileSysError);
}

function onFileSysError(error){
   alert("Error Code: " + error.code);
}

function onFileSystemSuccess(fileSystem){
   var reader = fileSystem.root.createReader();
   reader.readEntries(parseDirectories,onFileSysError);
}

function parseDirectories(entries){
   var str = '&lt;ul&gt;';

   for (var i = 0, len = entries.length; i &lt; len; i++) {
        if (entries[i].isDirectory) {
              str += '&lt;li&gt;' + entries[i].fullPath + '&lt;/li&gt;';
        }
   }

   str += "&lt;/ul&gt;";

   document.getElementById("fileslist").innerHTML+= str;

}

&lt;/script&gt;

&lt;/body&gt;
&lt;/html&gt;</pre></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec47"/>
<em>What just happened?</em>
</h2></div></div></div><p>The app can<a id="id348" class="indexterm"/> now read the list of directories from the device's persistent storage using the asynchronous Files API.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec48"/>Writing and reading a file's data</h2></div></div></div><p>To write<a id="id349" class="indexterm"/> data to a file, it suffices that the app gets access to the file using the <code class="literal">FileWriter</code> object. In order to get a <code class="literal">FileWriter</code> object, you first have to get access to a <code class="literal">DirectoryEntry</code> object or a <code class="literal">FileEntry</code> object using the <code class="literal">requestFileSystem</code> method of the <code class="literal">LocalFileSystem</code> object.</p><p>Once you <a id="id350" class="indexterm"/>successfully get access to the filesystem, you can request a file specifying that you want to create it using the <code class="literal">create</code> flag:</p><div><pre class="programlisting">Function onFileSystemSuccess(fileSystem){

    var root = fileSystem.root;
    root.getFile('data.txt', {create: true}, 
                  onGetFile, onGetFileError);

}</pre></div><div><div><h3 class="title"><a id="note16"/>Note</h3><p>There are two flags available within the Files API that can be used as arguments of the <code class="literal">getFile</code> and <code class="literal">getDirectory</code> methods: <code class="literal">create</code> and <code class="literal">exclusive</code>. The <code class="literal">create</code> flag is used to indicate that the file or directory should be created; the <code class="literal">exclusive</code> flag takes effect only when the <code class="literal">create</code> flag is set to <code class="literal">true</code> and it causes the file or directory creation to fail if it already exists.</p></div></div><p>As with the other Files API, the <code class="literal">getFile</code> method is asynchronous and requires a success and failure handler. Once in the success handler, it's possible to create a <code class="literal">FileWriter</code> object using the <code class="literal">createWriter</code> method of the <code class="literal">FileEntry</code> object received as an argument. The <code class="literal">createWriter</code> method also requires the success and failure handlers, as shown here:</p><div><pre class="programlisting">function onGetFile(file){

    file.createWriter(onGetWriter, onGetWriterError);

}</pre></div><p>Once again, you have two other handlers, which means only after three callback functions, can you write some content into the file you just created:</p><div><pre class="programlisting">function onGetWriter(writer){

    writer.write('Hello PhoneGap Files API!');

}</pre></div><div><div><h3 class="title"><a id="tip05"/>Tip</h3><p>You can't write binary data from JavaScript in PhoneGap using a <code class="literal">FileWriter</code> object; this is a limitation of the framework because it passes data between the native and JavaScript layers as a string. One possible solution is to write a plugin that translates a Base64 string into binary data.</p></div></div><p>When <a id="id351" class="indexterm"/>you perform the write operation, several events occur. For each such event, there<a id="id352" class="indexterm"/> is a corresponding property available on the <code class="literal">FileWriter</code> object:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">onwritestart</code> event<a id="id353" class="indexterm"/> is called when the <code class="literal">FileWriter</code> object starts to write the file; it receives as an argument a <code class="literal">ProgressEvent</code> object.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">onwrite</code> event<a id="id354" class="indexterm"/> gets called when the <code class="literal">FileWriter</code> object has successfully completed the write operation; it receives as an argument a <code class="literal">ProgressEvent</code> object.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">Onabort</code> event<a id="id355" class="indexterm"/> is called when the write operation has been interrupted by calling the <code class="literal">abort</code> method of <code class="literal">FileWriter</code>; it receives as an argument a <code class="literal">ProgressEvent</code> object.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">Onerror</code> event<a id="id356" class="indexterm"/> is called when the write operation fails; it receives as an argument the <code class="literal">ProgressEvent</code> object. In order to understand why the error occurs, you can access the <code class="literal">FileError</code> object stored in the <code class="literal">target.error</code> property of the <code class="literal">event</code> object.</li></ul></div><p>The <code class="literal">FileWriter</code> object<a id="id357" class="indexterm"/> contains other properties as well. For a complete overview, refer to<a id="id358" class="indexterm"/> the online guide available at <a class="ulink" href="http://docs.phonegap.com/en/edge/cordova_file_file.md.html#FileWriter">http://docs.phonegap.com/en/edge/cordova_file_file.md.html#FileWriter</a>.</p><p>Using the <code class="literal">ProgressEvent</code> object, you can access the bytes loaded, the total bytes, and the nature of the event (that is, <code class="literal">abort</code>, <code class="literal">writeend</code>, and so on) using the <code class="literal">loaded</code>, <code class="literal">total</code>, and <code class="literal">type</code> properties:</p><div><pre class="programlisting">function onGetWriter(writer){

    writer.onwrite = function(evt){

        console.log(evt.loaded, evt.total, evt.type);

    }

    writer.write('Hello PhoneGap Files API!');

}</pre></div><div><div><h3 class="title"><a id="tip06"/>Tip</h3><p>If you try to call sequentially the <code class="literal">write</code> method of the <code class="literal">FileWriter</code> object, only the first string will be added to the file. You have to wait until the <code class="literal">writeend</code> event is fired in order to write other data to the file.</p></div></div><p>When you <a id="id359" class="indexterm"/>want to read a file, you can use a <code class="literal">FileReader</code> object. This object works similarly to the <code class="literal">FileWriter</code> object. When using it, several events occur: the <code class="literal">onabort</code> and <code class="literal">onerror</code> properties of the <code class="literal">FileWriter</code> object act similarly to the <code class="literal">FileReader</code> ones. The <a id="id360" class="indexterm"/>properties related only to the <code class="literal">FileReader</code> object are as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">onloadstart</code>: The<a id="id361" class="indexterm"/> function stored in this property is called when the <code class="literal">FileReader</code> object starts to read a file; it receives a <code class="literal">ProgressEvent</code> object as an argument.</li><li class="listitem" style="list-style-type: disc"><code class="literal">onload</code>: The<a id="id362" class="indexterm"/> function stored in this property is called when the read operation has successfully completed; it receives a <code class="literal">ProgressEvent</code> object as an argument.</li><li class="listitem" style="list-style-type: disc"><code class="literal">onloadend</code>: The<a id="id363" class="indexterm"/> function stored in this property is called when the read operation is completed (regardless of whether it succeeded or failed); it receives a <code class="literal">ProgressEvent</code> object as argument.</li></ul></div><p>The <code class="literal">FileReader</code> object allows you to read the file data in the following four different ways:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">readAsDataURL</code>: This<a id="id364" class="indexterm"/> reads the file and returns the content of the specified file as a Base64-encoded data URL</li><li class="listitem" style="list-style-type: disc"><code class="literal">readAsText</code>: This <a id="id365" class="indexterm"/>reads a file and returns the data as a string encoded by default in UTF-8</li><li class="listitem" style="list-style-type: disc"><code class="literal">readAsBinaryString</code>: This <a id="id366" class="indexterm"/>reads the file as binary and returns the data as a binary string</li><li class="listitem" style="list-style-type: disc"><code class="literal">readAsArrayBuffer</code>: This<a id="id367" class="indexterm"/> reads the file and returns the data as <code class="literal">ArrayBuffer</code></li></ul></div><p>In order to put into practice what you just learned, you will now see how to parse the device's persistent storage, recover the first available image, and render it in the app's web view.</p><p>Here is the <a id="id368" class="indexterm"/>complete <a id="id369" class="indexterm"/>source code for writing a text file to the phone storage:</p><div><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;!--Other section removed for sake of simplicity --&gt;
        &lt;title&gt;File Example&lt;/title&gt;
    &lt;/head&gt;
&lt;body&gt;
&lt;script type="text/javascript" src="img/cordova.js"&gt;&lt;/script&gt;

&lt;script type="text/javascript"&gt;

document.addEventListener("deviceready", onDeviceReady, false);

function onDeviceReady() {
   var size = 0;
   window.requestFileSystem(LocalFileSystem.PERSISTENT, size, onFileSystemSuccess, onFileSysError);
}

function onFileSystemSuccess(fileSystem){
   var root = fileSystem.root;
   root.getFile('data.txt', {create: true}, onGetFile, onFileSysError);
}

function onGetFile(file){
   file.createWriter(onGetWriter, onFileSysError);
}

function onGetWriter(writer){

   writer.onwrite = function(evt){
      console.log(evt.loaded, evt.total, evt.type);
   }

   writer.write('Hello PhoneGap Files API!');
}

function onFileSysError(error){
   alert("Error Code: " + error.code);
}

&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec50"/>Time for action – reading and rendering an image</h1></div></div></div><p>Get ready <a id="id370" class="indexterm"/>to render the first available image in the device's storage into<a id="id371" class="indexterm"/> the PhoneGap default app template. Refer to the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the command-line tool and create a new PhoneGap project named <code class="literal">ReadingFile</code>.</li><li class="listitem">Add the File API plugin using the following command line:<div><pre class="programlisting">
<strong>$ cordova plugin add cordova-plugin-file</strong>
</pre></div></li><li class="listitem">Go to the <code class="literal">www</code> folder, open the <code class="literal">index.html</code> file, and add an <code class="literal">img</code> tag with the <code class="literal">id</code> value as <code class="literal">firstImage</code> inside the main <code class="literal">div</code> of the app following the <code class="literal">deviceready</code> one:<div><pre class="programlisting">&lt;img id='firstImage' /&gt;</pre></div></li><li class="listitem">Go to the <code class="literal">www/js</code> folder, open the <code class="literal">index.js</code> file, and define a new function named <code class="literal">requestFileSystem</code>:<div><pre class="programlisting">Function requestFileSystem() {
    // The request of access to the file system will go here

}</pre></div></li><li class="listitem">Define the error handler in order to get the code of every possible error:<div><pre class="programlisting">Function onError(error){

     alert(error.code);

}</pre></div></li><li class="listitem">In the body of the <code class="literal">requestFileSystem</code> function, access the device filesystem using the <code class="literal">requestFileSystem</code> function of the <code class="literal">LocalFileSystem</code> object, define the success and failure handlers, and inside the success handler, access the <code class="literal">root</code> filesystem:<div><pre class="programlisting">window.requestFileSystem(LocalFileSystem.PERSISTENT, <strong>0</strong>,

                   onFileSystemSuccess, onError);</pre></div><div><div><h3 class="title"><a id="tip07"/>Tip</h3><p>You are requesting a <code class="literal">0</code> bytes quota because you are just reading a file; you need to specify a quota only when writing to the device filesystem.</p></div></div></li><li class="listitem">Once you get access to the <code class="literal">root</code> filesystem, you can create a <code class="literal">DirectoryReader</code> object in the success handler and start to explore the root filesystem using the <code class="literal">readEntries</code> asynchronous method of the object:<div><pre class="programlisting">var root = fileSystem.root;
var reader = root.createReader();

reader.readEntries(function(entries){

    for (var i = 0, entry; entry = entries[i]; i++){

        // Here The logic to check if the file is an image

    }

}, onError);</pre></div></li><li class="listitem">In order <a id="id372" class="indexterm"/>to determine whether a file is an image in the <code class="literal">for</code> loop, you can first check the <code class="literal">isFile</code> property of the entry and then use a simple regular expression; when the condition is met, you access the file using the <code class="literal">getFile</code> method of the root <code class="literal">DirectoryEntry</code> object specifying the success and the failure handlers:<div><pre class="programlisting">if (entry.isFile &amp;&amp; (/\.(gif|jpg|jpeg|png)$/i).test(entry.name)){

    root.getFile(entry.name, {create: false}, 
                 onGetFile, onError);
    break;

}</pre></div></li><li class="listitem">In the <a id="id373" class="indexterm"/>JavaScript section, define the <code class="literal">onGetFile</code> function, and in its body, access the real file by using the <code class="literal">file</code> method of the <code class="literal">FileEntry</code> object. Once you get access to the file, specify the <code class="literal">onload</code> and <code class="literal">onerror</code> handlers and read the file using the <code class="literal">readAsDataURL</code> method in order to assign the result as the <code class="literal">src</code> attribute of the <code class="literal">img</code> tag, as shown here:<div><pre class="programlisting">function onGetFile(fileEntry){

    <strong>fileEntry.file</strong>(function(file){

        var reader = new FileReader();

        reader.onload = function(evt){

            var img = document.querySelector('#firstImage');
            <strong>img.src = evt.target.result;</strong>

        };

        reader.onerror = function(evt){

            alert(evt.target.error.code, null);

        };

        reader.readAsDataURL(file);

    }, onError);

}</pre></div></li></ol></div><p>Now test the project on a real device. Take a look at the <a id="id374" class="indexterm"/>following <a id="id375" class="indexterm"/>complete code provided for a quick review:</p><div><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;!--Other section removed for sake of simplicity --&gt;
        &lt;title&gt;File Example&lt;/title&gt;
    &lt;/head&gt;
&lt;body&gt;

&lt;img id="firstImage" /&gt;

&lt;script type="text/javascript" src="img/cordova.js"&gt;&lt;/script&gt;

&lt;script type="text/javascript"&gt;

document.addEventListener("deviceready", onDeviceReady, false);

function onDeviceReady() {
   var size = 0;
   window.requestFileSystem(LocalFileSystem.PERSISTENT, size, onFileSystemSuccess, onError);
}

function onFileSystemSuccess(fileSystem){
   var root = fileSystem.root;
   var reader = root.createReader();

   reader.readEntries(function(entries){
      for (var i = 0, entry; entry = entries[i]; i++){
        if (entry.isFile &amp;&amp;
        (/\.(gif|jpg|jpeg|png)$/i).test(entry.name)){
          root.getFile(entry.name, {create: false}, onGetFile, onError);
          break;
        }
      }
   }, onError);

}

function onGetFile(fileEntry){

   fileEntry.file(function(file){
      var freader = new FileReader();

      freader.onload = function(evt){
        var img = document.querySelector('#firstImage');
        img.src = evt.target.result;
      };

      freader.onerror = function(evt){
        alert(evt.target.error.code);
      };

      freader.readAsDataURL(file);
   }, onError);

}

function onError(error){
   alert("Error Code: " + error.code);
}
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec49"/>
<em>What just happened?</em>
</h2></div></div></div><p>You <a id="id376" class="indexterm"/>explored the <a id="id377" class="indexterm"/>filesystem of the device and rendered the first image found as a Base64 data stream in your app. Now that you are somewhat familiar with the File API, it's time to learn how to transfer files from and to a device.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec50"/>Transferring files</h2></div></div></div><p>The <a id="id378" class="indexterm"/>PhoneGap File API also includes the <code class="literal">FileTransfer</code> object. As the name suggests, this object allows you to develop apps to download and upload files over the Internet. The methods exposed by the <code class="literal">FileTransfer</code> object are self-explanatory: <code class="literal">upload</code>, <code class="literal">download</code>, and <code class="literal">abort</code>.</p><p>The <code class="literal">upload</code> method accepts several arguments: the path of the file on the device, a URL to receive the file, the success and failure handlers, an option object, and a Boolean to force the method to accept all the security certificates. (I omitted the Boolean in the next snippet<a id="id379" class="indexterm"/> because using it for production is not recommended; an app should accept only the protocols it was designed to deal with.)</p><div><pre class="programlisting">var fileTransfer = new FileTransfer();
fileTransfer.upload(fileURI, URL, onSuccess, onError, options);</pre></div><p>The <code class="literal">options</code> argument is a <code class="literal">FileUploadOptions</code> object. This object allows you to provide additional information using the following properties:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">chunkedMode</code>: This is a <a id="id380" class="indexterm"/>Boolean value that indicates whether the streaming of the HTPP request is performed without internal buffering. (For a more detailed description of the chunked transfer encoding, you can refer to <a class="ulink" href="http://en.wikipedia.org/wiki/Chunked_transfer_encoding">http://en.wikipedia.org/wiki/Chunked_transfer_encoding</a>).</li><li class="listitem" style="list-style-type: disc"><code class="literal">fileKey</code>: This<a id="id381" class="indexterm"/> is a string that indicates the name of the form element under which the file is uploaded to the server; the default value is <code class="literal">file</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">fileName</code>: This is a <a id="id382" class="indexterm"/>string that represents the name of the uploaded file; the default value is <code class="literal">image.jpg.</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">mimeType</code>: This is a<a id="id383" class="indexterm"/> string representing the MIME type of the file that will be uploaded; by default, the value is <code class="literal">image/jpg</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">params</code>: This is an <a id="id384" class="indexterm"/>object that represents key-value pairs to be included in the HTTP request header.</li></ul></div><p>The <code class="literal">onSuccess</code> handler receives a <code class="literal">FileEntry</code> object as an argument so that you can immediately access information, such as the filename and full path on the device. The <code class="literal">onError</code> handler receives a <code class="literal">FileTransferError</code> object; the properties of this object are as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">code</code>: This is a number that represents one of the four possible error codes stored in the <code class="literal">FileTransferError</code> pseudo constants (that is, <code class="literal">FILE_NOT_FOUND_ERR</code>, <code class="literal">INVALID_URL_ERR</code>, <code class="literal">CONNECTION_ERR</code>, and <code class="literal">ABORT_ERR</code>).</li><li class="listitem" style="list-style-type: disc"><code class="literal">source</code>: This is a string representing the URI to the source file.</li><li class="listitem" style="list-style-type: disc"><code class="literal">target</code>: This is a string representing the URI to the target file.</li><li class="listitem" style="list-style-type: disc"><code class="literal">http_status</code>: This is a number representing the HTTP status code.</li></ul></div><p>The <code class="literal">download</code> method works in a similar way; the only difference is that the first two arguments are switched and are: the URL to download the file and the system URI (that is, the path) in order to store it on the device, respectively; also, the <code class="literal">options</code> parameter accepts only HTTP headers. This is shown here:</p><div><pre class="programlisting">var fileTransfer = new FileTransfer();
fileTransfer.download(URL, filePath, onSuccess, onError, options);</pre></div><p>The <code class="literal">abort</code> method can be used to stop a download or an upload operation, once the <code class="literal">onError</code> handler is called, and the value of the <code class="literal">code</code> property of its argument is the pseudo constant, <code class="literal">FileTransferError.ABORT_ERR</code>.</p><div><div><h3 class="title"><a id="note17"/>Note</h3><p>Also, when you set up the wrong path of the file to download, the <code class="literal">code</code> property of the <code class="literal">FileTransferError</code> object is equal to <code class="literal">FileTransferError.FILE_NOT_FOUND_ERR</code> (that is, the value <code class="literal">1</code>).</p></div></div><p>Only the<a id="id385" class="indexterm"/> <code class="literal">onprogress</code> property is defined in the <code class="literal">FileTransfer</code> object. As the name suggests, this property is used to store a function that is called whenever a chunk of data is transferred from or to the device.</p><p>Next, in order to put into practice what you just learned, you will download a file, show the download progress, and add a link to the file once the download is completed.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec51"/>Time for action – downloading and saving a file</h1></div></div></div><p>Get ready<a id="id386" class="indexterm"/> to download a file and display in the PhoneGap default app<a id="id387" class="indexterm"/> template a progress bar and a link to the file. Refer to the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the command-line tool and create a new PhoneGap project named <code class="literal">DownloadFile</code>:<div><pre class="programlisting">
<strong>$ cordova create DownloadFile</strong>
</pre></div></li><li class="listitem">Change the directory to <code class="literal">DownloadFile</code>:<div><pre class="programlisting">
<strong>$ cd DownloadFile</strong>
</pre></div></li><li class="listitem">Add the File and FileTransfer API plugins using the following commands:<div><pre class="programlisting">
<strong>$ cordova plugin add cordova-plugin-file-transfer</strong>
<strong>$ cordova plugin add cordova-plugin-file</strong>
</pre></div></li><li class="listitem">Go to the <code class="literal">www</code> folder, open the <code class="literal">index.html</code> file, and add a <code class="literal">progress</code> tag with the <code class="literal">id</code> value as <code class="literal">progress</code> inside the main <code class="literal">div</code> element of the app below the <code class="literal">deviceready</code> tag; assign <code class="literal">1</code> to the <code class="literal">value</code> attribute and <code class="literal">100</code> to the <code class="literal">max</code> attribute:<div><pre class="programlisting">&lt;progress id='progress' value='1' max='100'&gt;&lt;/progress&gt;</pre></div></li><li class="listitem">Define a new JavaScript function named <code class="literal">onDeviceReady</code> and add it to the <code class="literal">deviceready</code> listener:<div><pre class="programlisting">document.addEventListener("deviceready", onDeviceReady, false);

   function onDeviceReady() {
      var size = 0;
      window.requestFileSystem(LocalFileSystem.PERSISTENT, size, onFileSystemSuccess, onError);
   }</pre></div></li><li class="listitem">For <a id="id388" class="indexterm"/>the <code class="literal">onFileSystemSuccess</code> method, once you get access <a id="id389" class="indexterm"/>to the filesystem, create a new <code class="literal">FileTransfer</code> object and call the <code class="literal">download</code> method specifying the remote URL, the system root URI, and the success and failure handlers:<div><pre class="programlisting">function onFileSystemSuccess(fileSystem){
   var fileTransfer = new FileTransfer();
   var url = 'http://s3.amazonaws.com/mislav/Dive+into+HTML5.pdf';

   fileTransfer.download(encodeURI(url),
           fileSystem.root.toURL() + '/' + 'html5.pdf',
           fileDownloaded,
           onError);

   fileTransfer.onprogress = function(evt){

      if (evt.lengthComputable){

        var tot = (evt.loaded / evt.total) * 100;

        var element = document.querySelector('#progress');
        element.value = Math.round(tot);
      }
   }
}</pre></div></li><li class="listitem">Define the success and failure event callback functions. For any error, we will alert the entire <code class="literal">error</code> object as a JSON string, as shown here:<div><pre class="programlisting">function fileDownloaded(entry){
   alert("Success");
}

function onError(error){
   alert(JSON.stringify(error));
}</pre></div></li><li class="listitem">Now run your project on a real device. The file will be downloaded and the progress will be shown in the progress bar. Once it's done, you can verify the downloaded file in your device.</li></ol></div><p>The complete source code of this example is provided as follows:</p><div><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;!--Other section removed for sake of simplicity --&gt;
        &lt;title&gt;File Example&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;

&lt;progress id='progress' value='1' max='100'&gt;&lt;/progress&gt;

&lt;script type="text/javascript" src="img/cordova.js"&gt;&lt;/script&gt;

&lt;script type="text/javascript"&gt;

   document.addEventListener("deviceready", onDeviceReady, false);

   function onDeviceReady() {
      var size = 0;
      window.requestFileSystem(LocalFileSystem.PERSISTENT, size, onFileSystemSuccess, onError);
}

      function onFileSystemSuccess(fileSystem){
         var fileTransfer = new FileTransfer();
         var url = 'http://s3.amazonaws.com/mislav/Dive+into+HTML5.pdf';

         fileTransfer.download(encodeURI(url),
               fileSystem.root.toURL() + '/' + 'html5.pdf',
                 fileDownloaded,
                 onError);

         fileTransfer.onprogress = function(evt){

            if (evt.lengthComputable){

            var tot = (evt.loaded / evt.total) * 100;

            var element = document.querySelector('#progress');
            element.value = Math.round(tot);
         }
      }
   }

   function fileDownloaded(entry){
      alert("Success");
   }

   function onError(error){
      alert(JSON.stringify(error));
   }

&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec51"/>
<em>What just happened?</em>
</h2></div></div></div><p>You<a id="id390" class="indexterm"/> initiated a <a id="id391" class="indexterm"/>file download, displayed a progress bar, and rendered a link to the file. You will notice a problem because most platforms don't provide a PDF reader inside the WebView. In short, the user will not be able to read the file, neither in the app nor in the external browser. In order to open a native app to read the file, you have to use an external plugin. You will discover in the next chapter how to integrate a plugin in your app and how to solve this problem.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec52"/>Summary</h1></div></div></div><p>In this chapter, you learned how to save data on the device and how to handle the most common limitations. You also learned how the Files API works and looked at its features.</p><p>In the next chapter, you will learn how to use the Contact API to work with contacts in the device and Camera API, in order to capture an image using the device camera.</p></div></body></html>